{
    "id": "33fee96f-f2dc-4edb-bb33-e009febc0837",
    "created_at": "2023-01-12T15:06:39.817279Z",
    "updated_at": "2025-03-27T02:05:26.032742Z",
    "deleted_at": null,
    "sha1_hash": "3507813a3951d6a6cee9b8be843de83c06de235c",
    "title": "2021-06-22 - NukeSped Copies Fileless Code From Bundlore, Leaves It Unused",
    "authors": "",
    "file_creation_date": "2022-05-28T15:27:08Z",
    "file_modification_date": "2022-05-28T15:27:08Z",
    "file_size": 845755,
    "plain_text": "# NukeSped Copies Fileless Code From Bundlore, Leaves It Unused\n\n**[trendmicro.com/en_hk/research/21/f/nukesped-copies-fileless-code-from-bundlore--leaves-it-unused.html](https://www.trendmicro.com/en_hk/research/21/f/nukesped-copies-fileless-code-from-bundlore--leaves-it-unused.html)**\n\nMalware\n\n\nJune 22, 2021\n\n\nWhile investigating samples of NukeSped, a remote access trojan (RAT), Trend Micro came across several Bundlore adware samples using\nthe same fileless routine that was spotted in NukeSped.\n\nBy: Luis Magisa, Ariel Neimond Lazaro June 22, 2021 Read time: ( words)\n\n[While investigating samples of NukeSped, a remote access trojan (RAT), Trend Micro came across several Bundlore adware samples](https://www.trendmicro.com/en_hk/research/19/k/mac-backdoor-linked-to-lazarus-targets-korean-users.html)\nusing the same fileless routine that was spotted in NukeSped. The backdoor has been attributed to the cybercriminal group Lazarus, which has\nbeen active since at least 2014. There are [multiple variants of NukeSped, which is designed to run on 32-bit systems and uses encrypted](https://www.trendmicro.com/vinfo/tmr/?/us/threat-encyclopedia/malware/trojan.macos.nukesped.yxbbs/)\nstrings to evade detection. Recently, [a more sophisticated form of this trojan called ThreatNeedle surfaced as part](https://threatpost.com/lazarus-targets-defense-threatneedle-malware/164321/)\nof a cyberespionage campaign by Lazarus.\n\nThe encrypted Mach-O file discovered in these samples has upgraded Bundlore — a malware family that installs adware in a target’s device\nunder the guise of downloading legitimate applications — to a stealthier and memory-resident threat. Bundlore has also been known to target\n[macOS devices and was linked to an attack on macOS Catalina users last year.](https://news.sophos.com/en-us/2020/06/18/new-bundlore-adware-targets-macos-with-updated-safari-extensions/)\n\nOur analysis of the file Ants2WhaleHelper used by Lazarus led us to detect it as NukeSped. Another file with NukeSped\n[detection, unioncryptoupdater, was also found in VirusTotal. Both contained a routine that looks to be based on a GitHub submission.](https://github.com/ytlvy/CTest/blob/9039ccf993c478a29d77018135d992d79c1b1a0a/C/RunLib/run_bin.c)\nCuriously, however, neither of these files seems to make use of this routine.\n\nUsing Interactive Disassembler Pro (IDA Pro) on the Ants2WhaleHelper file revealed its main payload as _mapBuffer (Figure 1), which\nappears to be a modified version of the _memory_exec function (Figure 2). This function looks like it was based on code from the GitHub\npost; however, there were no references that point to the _memory_exec function.\n\nFigure 1. The _mapBuffer function\n\n\n-----\n\nFigure 2. The _memory_exec function copied from the GitHub post\n\nMoreover, the payload has a _resolve_symbol function that does not seem to be used. It also does not appear to be necessary, as evidenced\nin Figure 3. NukeSped typically retrieves and launches its payload from a web server, so it does not need the\nsuperfulous _resolve_symbol function, which locates data internally. As Figure 4 shows, searching for the operation codes of this\nfunction on VirusTotal led to its detection in 201 files. The results yielded only two NukeSped samples while the rest were Bundlore samples.\n\nFigure 3. The _resolve_symbol functions of NukeSped (left) vs. Bundlore (right)\n\n\n-----\n\nFigure 4. The searched operation codes\n\nSimilarly, a search using VirusTotal's Retrohunt yielded 273 results; most of these were Bundlore files and only three were Nukesped files.\nHowever, one of these Nukesped samples was verified as the parent of a Nukesped file from the previous search. Among\nthe Bundlore samples discovered, the oldest one dates back to May of last year. Further investigation of these Bundlore samples from\nthe VirusTotal query revealed that these were indeed using fileless routines, enabling Bundlore to execute a payload directly from memory.\n\nBundlore’s fileless routine\n\nOur study of the Bundlore samples showed that these utilize the same functions that were found unused in the NukeSped samples. As seen in\nFigure 5, these were obfuscated, as they were under random names when disassembled in IDA Pro. While the functions have some\ndifferences, the routine for in-memory file execution remains the same (Figure 6 and 8).\n\nFigure 5. The obfuscated functions\n\n\n-----\n\nFigure 6. The disassembly of NukeSped (left column) vs. Bundlore (right column) samples\n\nThe main routines of one of the Bundlore samples (sha256:0a3a5854d1ae3f5712774a4eebd819f9e4e3946f36488b4e342f2dd32c8e5db2) are\nas follows:\n\n1. Decrypt the __DATA.__data section to reveal the embedded Mach-O file, as shown in Figure 7. The decryption uses an XOR key\n\nthat is incremented per cycle: for example, a 0xDD increment by 0x2A, 0xDD, 0x00, 0x2A, 0x54, 0x7E, 0xA8, 0xD2, 0xFC, 0x00, and so\non.\n\nFigure 7. The decryption routine of the __DATA.__data section\n\n2. Invoke a function called NSCreateObjectFileImageFromMemory to create an adware image from the Mach-O file in memory.\n\nAfterward, NSLinkModule is called to link the malicious image to the main executable's image library. The Mach-O file format is\nchanged from an executable (0x02) to a bundle (0x08) before it can call NSCreateObjectFileImageFromMemory, as was shown in Figure\n6.\n\n3. Parse the Mach-O file's header structure in memory for value(LC_MAIN), a load command that has the value 0x80000028. This\n\ncommand contains data such as the offset of the Mach-O file's entry point (Figure 8). Afterward, the adware retrieves the offset and\ngoes to the entry point.\n\n\n-----\n\nFigure 8. Finding the entry point of the malicious image in NukeSped (left column) vs. Bundlore (right column)\n\nBundlore’s Mach-O file runs in memory\n\nThe decryption keys and increment values differ across the Bundlore samples. To gain a better understanding of the embedded file, we\ncreated a Python script to decrypt and extract their embedded Mach-O files. By doing so, we were able to observe one such decrypted MachO file (sha256: a7b6639d9fcdb13ae5444818e1c35fba4ffed90d9f33849d3e6f9b3ba8443bea) with the routines shown in Figure 9. It\nconnects to a target URL (13636337101185210173363631[.]cloudfront[.]net/?cc-00&), but the address varies among the samples. An app\nbundle called Player.app, which poses as Flash Player, is then downloaded and extracted into a /tmp directory. The chmod 777 command is\nused on the extracted app bundle, after which the fake application is launched. While it performs these routines, Bundlore displays a fraudulent\nerror message (Figure 10). Upon completion, it goes dormant by calling the sleep function and looping it repeatedly.\n\nThere were no significant differences seen when running the Bundlore samples in macOS Big Sur and macOS Catalina. However, our\nresearchers found that with the default settings of macOS, in which the System Integrity Protection (SIP) and Gatekeeper security features are\nenabled, the Bundlore samples are blocked and are unable to run. This was observed in both macOS Catalina and macOS Big Sur\nenvironments; similarly, the Bundlore samples were also blocked and unable to run under the default settings of macOS Monterey, Apple's\nrecently released operating system.\n\n\n-----\n\nFigure 9. The decrypted Mach-O file’s main routines\n\nFigure 10. The fake error message displayed by Player.app\n\nTrend Micro Solutions\n\nContinuous vigilance against threat groups is an important aspect of keeping up with — if not staying one step ahead of — threats. To protect\n[systems from this type of threat, users can use multilayered security solutions like Trend Micro Antivirus for Mac and](https://www.trendmicro.com/en_us/forHome/products/antivirus-for-mac.html) Trend Micro Protection\nSuites that help detect and block attacks. [Trend Micro Vision One™ also provides visibility, correlated detection, and behavior monitoring](https://www.trendmicro.com/en_us/business/products/detection-response.html)\nacross multiple layers, such as emails, endpoints, servers, and cloud workloads. This ensures that no significant incidents go unnoticed and\nallows faster response to threats before they can do any real damage to the system.\n\nMITRE Tactics, Techniques, and Procedures (TTPs) of Bundlore\n\n**Initial Access** **Execution** **Privilege Escalation** **Defense Evasion** **Command and Control (C&C)**\n\nDrive-by compromise User execution Process injection Deobfuscate/Decode files or information Web service\n\nMasquerading\n\nProcess injection\n\nIndicators of Compromise (IOCs)\n\n**sha256** **File** **Detection**\n\nbb430087484c1f4587c54efc75681eb60cf70956ef2a999a75ce7b563b8bd694 Ants2WhaleHelper Trojan.MacOS.Agent.PFH\n\n631ac269925bb72b5ad8f469062309541e1edfec5610a21eecded75a35e65680 unioncryptoupdater Trojan.MacOS.LAZARUS.A\n\n0a3a5854d1ae3f5712774a4eebd819f9e4e3946f36488b4e342f2dd32c8e5db2 smokehouses Adware.MacOS.BUNDLORE.RSMSGGK2\n\n\na7b6639d9fcdb13ae5444818e1c35fba4ffed90d9f33849d3e6f9b3ba8443bea Embedded MachO\n\n\nAdware.MacOS.BUNDLORE.MANP\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-22 - NukeSped Copies Fileless Code From Bundlore, Leaves It Unused.pdf"
    ],
    "report_names": [
        "2021-06-22 - NukeSped Copies Fileless Code From Bundlore, Leaves It Unused.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535999,
    "ts_updated_at": 1743041126,
    "ts_creation_date": 1653751628,
    "ts_modification_date": 1653751628,
    "files": {
        "pdf": "https://archive.orkl.eu/3507813a3951d6a6cee9b8be843de83c06de235c.pdf",
        "text": "https://archive.orkl.eu/3507813a3951d6a6cee9b8be843de83c06de235c.txt",
        "img": "https://archive.orkl.eu/3507813a3951d6a6cee9b8be843de83c06de235c.jpg"
    }
}