{
    "id": "f21aa732-52cb-4e9e-b7a5-457848aba0ab",
    "created_at": "2023-11-14T02:05:48.413933Z",
    "updated_at": "2025-03-27T02:05:37.457381Z",
    "deleted_at": null,
    "sha1_hash": "c0c35a83662cc6f0aa9e1d5696e4574f8eafe682",
    "title": "",
    "authors": "",
    "file_creation_date": "2023-10-30T14:34:37Z",
    "file_modification_date": "2023-10-30T14:34:38Z",
    "file_size": 1257906,
    "plain_text": "# SOC8\n\n## NEW LAMPION BANKING 30 October 2023 TROJAN VARIANT IN THE WILD\n\n### SUMMARY\n\nIn a recent assessment we found what appears to be a new 2023 sample of the Lampion banking trojan.\n\n[The Lampion banking trojan was first seen in 2019 targeting Portuguese banks and since then has been sighted a few](https://seguranca-informatica.pt/targeting-portugal-a-new-trojan-lampion-has-spread-using-template-emails-from-the-portuguese-government-finance-tax/)\nmore times, the last one was last year, 2022.\n\n[Its objective, as identified in another analysis, is the theft of credentials by creating an overlay on the legitimate bank](https://securityaffairs.co/128975/malware/hidden-c2-lampion-trojan-release-212.html)\nwebsite when the user connects to it:\n\n**Figure 1. Image from https://securityaffairs.co/128975/malware/hidden-c2-lampion-trojan-release-212.html**\n\nIn this analysis, we are going to look at its new infection methodology and relevant IOCs.\n\nThis malware tries to avoid detection by using known providers to host malware files, scheduled tasks to execute\nvisual basic scripts, large files (dlls with more than 700MB and vbs scripts with more than 60MB) to avoid sandbox\nanalysis and use the Windows startup feature to extract and execute the trojan.\n\n\n-----\n\nThe methodology can be summarized in the next image:\n\n**Figure 2. Infection methodology**\n\n### IOCs\n```\n  # Email sender\n  From: xxx <xxx@example.com>\n  # Email subject\n  Subject: Envio os documentos e comprovativo de pagamento.\n  # URLs\n  # Email URL\n  hxxps://we.tl/t-n3xfGBxksT\n  # Email URL redirected\n  hxxps://wetransfer.com/downloads/b7bc0df27446f2631347b88afe­\n  fe0c1820231017205830/9b8ac1\n\n```\n# Encrypted zip file\n```\n  hxxps://justlookaround.s3.amazonaws.com/soprateste.zip\n  # dll de 790MB\n  hxxps://justlookaround.s3.amazonaws.com/poiiuyetr\n  # File Hashes\n  # MD5\n  9c771d15e7bc6a750c7355bc4cc9e403\n  c4a6694925248ddf75d2849f5460f320\n  c33204558390a8b5fa32a7fe15141014\n  38a996533697a5e17e1e7e9b32ec16e9\n  5feb6bde72978cadbf06659506a4ab8d\n  9c5b05e761e0d058f41afe733e1025f8\n\n```\n\n-----\n\n```\n  25ca63d94eb39299563fa51986c9a17b\n  # SHA1\n  ab51f4b7d7180d459a58a9d1e13b1140ba201873\n  7849a278fa962d6ea4aa51c0587494ad910c873a\n  7849a278fa962d6ea4aa51c0587494ad910c873a\n  fe13fb3abf5ee184d87d49f60bb9932ceca24782\n  3f13bc906d7d231720eac8b606515e09ae22e1d9\n  c9372d98f1146f7c42fbcf84fa1b8a2ce0201fd5\n  968419fdf5c8fda4d2ef5efd0fd7c8beb7a82d53\n  # Lampion DLL Strings\n  DoThisBicht\n\n### TECHNICAL ANALYSIS\n\n#### FIRST STAGE\n\n```\nThe attack starts with the reception of a phishing email linking to a wetransfer short link:\n\n**Figure 3. Phishing email**\n\nThis is a compressed zip file with two files contained within:\n\n**Figure 4. First stage files contained in the downloaded zip**\n\n\n-----\n\nThese are obfuscated vbs files with a lot of noise, presumably to increase its size and make it difficult to analyze with\nautomatic malware analyzers.\n\n**Figure 5. Obfuscated first stage script**\n\nAfter cleaning the junk lines, both files contain the same code.\n\nWhen executed, this script creates three other vbs scripts:\n\n**Figure 6. New files created by the first stage script**\n\nLet’s call them a.vbs, b.vbs and c.vbs in the order they have been generated.\n\nIt will also create two scheduled tasks to call these scripts.The first scheduled task will call script **a.vbs and the**\nsecond one will call c.vbs:\n\n**Figure 7. First scheduled task creation**\n\n\n-----\n\n**Figure 8. Second scheduled task creation**\n\nWith these files and scheduled tasks created we have the ending of the first stage.\n\n#### SECOND STAGE\n\na.vbs\n\nMD5: c33204558390a8b5fa32a7fe15141014 SHA1: fe13fb3abf5ee184d87d49f60bb9932ceca24782 size: ~1KB\n\nThis script will be called by one of the scheduled tasks and will sleep for 10 minutes and then execute a forced shut­\ndown:\n\n**Figure 9. Contents of a.vbs**\n\nVirusTotal identifies this script as belonging to a trojan called Valyria, known to be used to drop malware like Emotet,\nAgent Tesla, Lokibot, and Kriptik, among other :\n\n\n-----\n\n**Figure 10. a.vbs VirusTotal summary**\n\nc.vbs\n\nMD5: d9ffed9c1e7fa4102d3d23e2c52f3d52 SHA1: 1df5bc903cf9e9a5e04db7334f28a0477be0d0c0 size: ~1KB\n\nThis script will be called by the other scheduled task and will call the b.vbs script:\n\n**Figure 11. Contents of c.vbs**\n\nThis script’s hash is not relevant since the path to the script is a random string generated at runtime, but the variable\nnames are static.\n\n\n-----\n\nb.vbs\n\nMD5: 38a996533697a5e17e1e7e9b32ec16e9 SHA1: 3f13bc906d7d231720eac8b606515e09ae22e1d9 size: ~15MB\n\nThis script will be called by c.vbs script.\n\nThis script is also filled with junk lines, and after cleaning it, it contains ~20KB of data.\n\nIn VirusTotal it is also identified as belonging to Valyria:\n\n**Figure 12. b.vbs VirusTotal summary**\n\nHooking its function and adding a like debugging code, we can see what it is doing:\n```\n  random string: wmicppkygjf\n  random string: iphvvrhdyfjfjppqv\n  delete path: StartUp\\*.lnk\n  delete path: StartUp\\*.vbs\n  delete path: StartUp\\*.cmd\n  delete path: StartUp\\*.exe\n  delete path: StartUp\\*.bat\n  delete path: StartUp\\*.js\n  delete path: StartUp\\*.vbs\n  random string: oujryzxdpbrsbhsyvrh\n  random string: gijgktpbpnpkrcswgreeke\n  create folder: MyDocuments/oujryzxdpbrsbhsyvrh\n  create folder: MyDocuments/oujryzxdpbrsbhsyvrh/gijgktpbpnpkrcswgreeke\n  random string: rdkuoirzqqqukztwrpywosluqcnaqgziafygemfmogmafxbypouwpecqutk­\n  wvrwhklczetnyaoowno\n  random string: kqgecpngohp\n\n```\n\n-----\n\n```\n  SpecialFolders : C:\\Users\\User\\Documents\\oujryzxdpbrsbhsyvrh\\gijgktpbpnp­\n  krcswgreeke\\rdkuoirzqqqukztwrpywosluqcnaqgziafygemfmogmafxbypouwpecqutkwvr­\n  whklczetnyaoowno.dll\n  SpecialFolders : C:\\Users\\User\\AppData\\Roaming\\$kqgecpngohp#.zip\n  decrypted string: ?=\n\n```\nrandom string: mxnffbadjylwspwrydytdorvorukiclvzsbwrkdoysydsgu\n```\n  decrypted string: ?=\n  random string: ycvcjbhxsdekedelbvmreggrrmoecnouoryqhsjsjyowwujrygd\n  decrypted string: hxxps://justlookaround.s3.amazonaws.com/soprateste.zip\n  decrypted string: hxxps://justlookaround.s3.amazonaws.com/poiiuyetr\n  random string: wcwcwqxhyvb\n  CreateTextFile: C:\\Users\\User\\AppData\\Roaming/wcwcwqxhyvb.parvos\n  random string: dtncoxfwxcc\n  MoveFile: C:\\Users\\User\\AppData\\Roaming/wcwcwqxhyvb.parvos to StartUp/dtn­\n  coxfwxcc.cmd\n  random string: xtyovqshtvq\n  Called fun_use_xmlhttp with params: hxxps://justlookaround.s3.amazonaws.com/\n\n```\nsoprateste.zip?=mxnffbadjylwspwrydytdorvorukiclvzsbwrkdoysydsgu & C:\\Users\\\n```\n  User\\AppData\\Roaming\\$kqgecpngohp#.zip\n  Called fun_use_xmlhttp with params: hxxps://justlookaround.s3.amazonaws.com/\n\n```\npoiiuyetr?=ycvcjbhxsdekedelbvmreggrrmoecnouoryqhsjsjyowwujrygd & C:\\Users\\\n```\n  User\\Documents\\oujryzxdpbrsbhsyvrh\\gijgktpbpnpkrcswgreeke\\rdkuoirzqqqukzt­\n  wrpywosluqcnaqgziafygemfmogmafxbypouwpecqutkwvrwhklczetnyaoowno.dll\n  obj_mxsml_xmlhttp.setOption: 13056\n  GetFolder: MyDocuments\\oujryzxdpbrsbhsyvrh\n  Move: AppData\\oujryzxdpbrsbhsyvrh\n\n```\nAnalysing its output, we can see what it is doing: cleaning the Startup directory, then creating a .cmd file in the Start­\nup folder, downloading from two URLsa zip file and a dll file:\n\nhxxps://justlookaround.s3.amazonaws.com/soprateste.zip?=psjuckbzhacmcykmlufdqbedaxvxalyriyqgftcnmwhrfhf\n\nhxxps://justlookaround.s3.amazonaws.com/poiiuyetr?=ahzlznnvglmubebwpqwjqalphpkyzphrtmervggofiqxwjqyznz\n\nThe first, we will call it soprateste.zip is a password protected zip file and the second, let’s call it a.dll, is a library file.\n\n\n-----\n\nThe .cmd file, from now called a.cmd, executes the downloaded malware dll, calling the function “MfS3onjYAZRDZd­\nQy3v9”:\n\n**Figure 13. a.cmd file contents**\n\nHere we have a hint of it being the Lampion trojan, as the soprateste.zip file name has already showed up in other\nanalysis.\n\nWe can also infer its creators are Portuguese speaking, because like in previous analysis, there are some Portuguese\ncommon words in the code.In this case we have the name of the zip file, soprateste, meaning “only for testing” and\nalso the name of the .cmd file before being moved to the Startup folder, “C:\\Users\\User\\AppData\\Roaming/wcwcwqx­\nhyvb.parvos”, where .parvos roughly translates to “idiots/fools”.\n\nThis file is put under the Startup folder so that it is activated when the computer starts, this file pairs with the a.vbs\nscript which sleeps for 10min and then shuts down the computer.\n\nWith the call to the downloaded a.dll, we enter the third stage.\n\n#### THIRD STAGE\n\nThe third stage is where the Lampion trojan will be extracted and executed by the files used in the second stage.\n\nSo, let’s analyze the last two downloaded files, soprateste.zip and a.dll\n\na.dll\n\nmd5: 5feb6bde72978cadbf06659506a4ab8d sha1: c9372d98f1146f7c42fbcf84fa1b8a2ce0201fd5 size: 792 MB\n\nThis is a huge file, probably to avoid sandbox detection.\n\nAt the time of writing, there were no VirusTotal hits for this file as it is larger than the size permitted to upload.\n\nWe can see that in the exported functions of the dll, the “MfS3onjYAZRDZdQy3v9” function, called by the a.cmd script,\nis present:\n\n\n-----\n\n**Figure 14. a.dll exported functions**\n\nsoprateste.zip\n\nmd5: 9c5b05e761e0d058f41afe733e1025f8 sha1: c9c3daae6659c73729f321437a548bc39c897dcb size: ~12 MB\n\nThis is a password protected file containing a single file with ~12MB:\n\n**Figure 15. file contained in password protected zip file**\n\nThe filename is in chinese and translates to:\n\n**Figure 16. Translation to English of the contained file name**\n\n[But translating it to Portuguese, we can see that it is part of the lyrics to a song about the “wild life”, or Vida Louca,](https://www.letras.mus.br/mc-poze/vida-louca/)\npointing to the gangster culture in Brazil:\n\n\n-----\n\n**Figure 17. Translation to Portuguese of the contained file name**\n\nThus, making one more connection to the Lampion trojan and its Brazilian origin.\n\nIn VirusTotal this hash is known, but not identified as malicious:\n\n**Figure 18. VirusTotal summary of the password protected zip file**\n\nThis file contained in the soprateste.zip is the Lampion trojan and it is, probably, extracted by the a.dll file when\nexecuted.\n\nLampion trojan\n\nmd5: 25ca63d94eb39299563fa51986c9a17b sha1: 968419fdf5c8fda4d2ef5efd0fd7c8beb7a82d53 size: ~12MB\n\nAt the time of writing, there were no VirusTotal hits for this file.\n\nWhen analyzing this file, we encountered two string indicators of this being the **Lampion trojan, since it is using**\nVMProtect to prevent common reversing techniques and we found the uncommon exported function “DoThisBicht”:\n\n\n-----\n\n**Figure 19. VMProtect detection of the Lampion trojan**\n\n**Figure 20. Lampion trojan exported functions**\n\n\n-----\n\nContrary to previous analysis, strings matching bank names were not found, although they may have been encrypted.\n\n### CONCLUSIONS\n\nThrough our analysis, we were able to find many similarities with the indicators exposed in previous analysis of the\nLampion trojan.\n\nSo we believe this a new variant that is currently being distributed and we supply the IOCs and methodology used by\nthe malware so others can benefit from it.\n\n### REFERENCES\n\n- [https://malpedia.caad.fkie.fraunhofer.de/details/vbs.lampion](https://malpedia.caad.fkie.fraunhofer.de/details/vbs.lampion)\n\n- [https://seguranca-informatica.pt/targeting-portugal-a-new-trojan-lampion-has-spread-using-template-emails-](https://seguranca-informatica.pt/targeting-portugal-a-new-trojan-lampion-has-spread-using-template-emails-from-the-portuguese-government-finance-tax/)\n\n[from-the-portuguese-government-finance-tax/](https://seguranca-informatica.pt/targeting-portugal-a-new-trojan-lampion-has-spread-using-template-emails-from-the-portuguese-government-finance-tax/)\n\n- [https://cofense.com/blog/lampion-trojan-utilizes-new-delivery-through-cloud-based-sharing/](https://cofense.com/blog/lampion-trojan-utilizes-new-delivery-through-cloud-based-sharing/)\n\n- https://securityaffairs.co/128975/malware/hidden-c2-lampion-trojan-release-212.html\n\n- [https://blogs.infoblox.com/cyber-threat-intelligence/cyber-campaign-briefs/valyria-trojan-drops-emotet/](https://blogs.infoblox.com/cyber-threat-intelligence/cyber-campaign-briefs/valyria-trojan-drops-emotet/)\n\n\n**LISBOA**\nAv. D. João II, Lote 42\nEscritório 602\nEdifício Mythos\n1990-095 Lisboa\n\n**T ( 351) 218 248 480**\n\n\n**PORTO**\nRua Júlio Dinis, 247 - 4º Piso\nEscritório 1\nEdifício Mota Galiza\n4050-324 Porto\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.layer8.pt/PDFs/New%20Lampion%20banking%20Trojan%20variant%20in%20the%20wild.pdf"
    ],
    "report_names": [
        "New%20Lampion%20banking%20Trojan%20variant%20in%20the%20wild.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1699927548,
    "ts_updated_at": 1743041137,
    "ts_creation_date": 1698676477,
    "ts_modification_date": 1698676478,
    "files": {
        "pdf": "https://archive.orkl.eu/c0c35a83662cc6f0aa9e1d5696e4574f8eafe682.pdf",
        "text": "https://archive.orkl.eu/c0c35a83662cc6f0aa9e1d5696e4574f8eafe682.txt",
        "img": "https://archive.orkl.eu/c0c35a83662cc6f0aa9e1d5696e4574f8eafe682.jpg"
    }
}