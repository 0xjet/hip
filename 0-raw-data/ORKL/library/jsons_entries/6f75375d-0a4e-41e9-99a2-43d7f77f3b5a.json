{
    "id": "6f75375d-0a4e-41e9-99a2-43d7f77f3b5a",
    "created_at": "2023-01-12T15:09:42.642535Z",
    "updated_at": "2025-03-27T02:15:45.449626Z",
    "deleted_at": null,
    "sha1_hash": "78aebb86a5aeacd70d5c49ef7c4b915db651a44f",
    "title": "2018-09-10 - LuckyMouse signs malicious NDISProxy driver with certificate of Chinese IT company",
    "authors": "",
    "file_creation_date": "2022-05-28T02:03:26Z",
    "file_modification_date": "2022-05-28T02:03:26Z",
    "file_size": 430140,
    "plain_text": "# LuckyMouse signs malicious NDISProxy driver with certificate of Chinese IT company\n\n**securelist.com/luckymouse-ndisproxy-driver/87914/**\n\nAuthors\n\nGReAT\n\n## What happened?\n\nSince March 2018 we have discovered several infections where a previously unknown Trojan\nwas injected into the lsass.exe system process memory. These implants were injected by the\ndigitally signed 32- and 64-bit network filtering driver NDISProxy. Interestingly, this driver is\nsigned with a digital certificate that belongs to Chinese company LeagSoft, a developer of\ninformation security software based in Shenzhen, Guangdong. We informed the company\nabout the issue via CN-CERT.\n\nThe campaign described in this report was active immediately prior to Central Asian highlevel meeting and we suppose that actor behind still follows regional political agenda.\n\n\n-----\n\n## Which malicious modules are used?\n\nThe malware consists of three different modules:\n\nA custom C++ installer that decrypts and drops the driver file in the corresponding\nsystem directory, creates a Windows autorun service for driver persistence and adds\nthe encrypted in-memory Trojan to the system registry.\nA network filtering driver (NDISProxy) that decrypts and injects the Trojan into memory\nand filters port 3389 (Remote Desktop Protocol, RDP) traffic in order to insert the\nTrojan’s C2 communications into it.\nA last-stage C++ Trojan acting as HTTPS server that works together with the driver. It\nwaits passively for communications from its C2, with two possible communication\nchannels via ports 3389 and 443.\n\n_NDISProxy driver and RAT work together once the installer has set up all the modules_\n\nThese modules allow attackers to silently move laterally in the infected infrastructure, but\ndon’t allow them to communicate with an external C2 if the new infected host only has a LAN\nIP. Because of this, the operators used an Earthworm SOCKS tunneler in order to connect\n\n\n-----\n\nthe LAN of the infected host to the external C2. They also used the Scanline network\nscanner to find file shares (port 135, Server Message Block, SMB) which they use to spread\nmalware with administrative passwords, compromised with keyloggers.\n\nWe assess with high confidence that NDISProxy is a new tool used by LuckyMouse.\nKaspersky Lab products detect the described artefacts. For more information please contact:\n[intelreports@kaspersky.com](http://10.10.0.46/mailto:intelreports@kaspersky.com)\n\n## How does it spread?\n\nWe detected the distribution of the 32-bit dropper used for this campaign among different\ntargets by the end of March 2018. However, we didn’t observe any spear phishing or\nwatering hole activity. We believe the operators spread their infectors through networks that\nwere already compromised instead.\n\n## How does it work?\n\n**Custom installer**\n\n**Installer MD5 hash** **Timestamp (GMT)** **Size** **Bits**\n\ndacedff98035f80711c61bc47e83b61d 2018.03.29 07:35:55 572 244 32\n\n9dc209f66da77858e362e624d0be86b3 2018.03.26 04:16:00 572 244 32\n\n3cbeda2c5ac41cca0b0d60376a2b2511 2018.03.26 04:16:00 307 200 32\n\nThe initial infectors are 32-bit portable executable files capable of installing 32-bit or 64-bit\ndrivers depending on the target. The installer logs all the installation process steps in the\nload.log file within the same directory. It checks if the OS is Windows Vista or above (major\nversion equal to 6 or higher) and decrypts its initial configuration using the DES (Data\nEncryption Standard) algorithm.\n\nThe set of well-known port numbers (HTTP, HTTPS, SMB, POP3S, MSSQL, PPTP and\nRDP) in the configuration is not used, which along with the “[test]” strings in messages\nsuggests this malware is still under development.\n\nThe installer creates a semaphore (name depending on configuration) Global\\Doorndisproxy-mn and checks if the service (name also depends on configuration) ndisproxy-mn\nis already installed. If it is, the dropper writes “door detected” in load.log. The autorun\nWindows service running NDISProxy is the “door” in developer terms.\n\nThe installer also decrypts (using the same DES) the shellcode of the last stage Trojan and\nsaves it in three registry values named xxx0, xxx1, xxx2 in key\nHKLM\\SOFTWARE\\Classes\\32ndisproxy-mn (or 64ndisproxy-mn for 64-bit hosts) The\n\n\n-----\n\nencrypted configuration is saved as the value filterpd-ndisproxy-mn in the registry key\nHKCR\\ndisproxy-mn.\n\n_Initial installer saves XOR-encrypted Trojan’s shellcode and DES-encrypted configuration in system_\n\n_registry_\n\nThe installer creates the corresponding autostart service and registry keys. The “Altitude”\nregistry value (unique ID for the minifilter driver) is set to 321 000, which means “FSFilter\nAnti-Virus” in Windows terms:\n\n**NDISProxy network filtering driver**\n\n**Driver MD5 hash** **Timestamp** **Size** **Bits**\n\n8e6d87eadb27b74852bd5a19062e52ed 2018.03.29 07:33:58 40400 64\n\nd21de00f981bb6b5094f9c3dfa0be533 2018.03.29 07:33:52 33744 32\n\na2eb59414823ae00d53ca05272168006 2018.03.26 04:15:28 40400 64\n\n493167e85e45363d09495d0841c30648 2018.03.26 04:15:21 33744 32\n\nad07b44578fa47e7de0df42a8b7f8d2d 2017.11.08 08:04:50 241616 64\n\nThis digitally signed driver is the most interesting artefact used in this campaign. The network\nfiltering modules serve two purposes: first they decrypt and inject the RAT; second, they set\nits communication channel through RDP port 3389.\n\n[The drivers are signed with a digital certificate issued by VeriSign to LeagSoft, a company](https://www.leagsoft.com/)\ndeveloping information security software such as data loss prevention (DLP) solutions.\n\n\n-----\n\nThis driver makes extensive use of third-party publicly available C source code, including\nfrom the Blackbone repository available at GitHub.\n\n**Feature** **Public repository**\n\n\nDriver memory\ninjection\n\nNDIS network\nfiltering driver\n\nParse HTTP\npackets\n\n\nBlackbone https://github.com/DarthTon/Blackbone\n\nMicrosoft Windows Driver Kit (WDK) sample code “Windows Filtering\nPlatform Stream Edit Sample/C++/sys/stream_callout.c”\n\nHttp-parser https://github.com/nodejs/http-parser\n\n\nThe driver again checks if the Windows version is higher than Vista, then creates a device\nnamed \\\\Device\\\\ndisproxy-%s (where the word after “-” varies – see Appendix for all\nvariants) and its corresponding symbolic link \\\\DosDevices\\\\Global\\\\ndisproxy-%s.\n\nThe driver combines all the Trojan-related registry values from\nHKLM\\SOFTWARE\\Classes\\32ndisproxy-mn and de-XORs them with a six-byte hardcoded\nvalue. It then injects the resulting Trojan executable shellcode into lsass.exe memory using\nBlackbone library functions.\n\nNDISProxy works as a network traffic filter engine, filtering the traffic going through RDP port\n3389 (the port number is hardcoded) and injecting messages into it.\n\nThe communication between the user-mode in-memory Trojan and the driver goes through\nthe custom control codes used by the DeviceIoControl() Windows API function. Apart from\nthe auxiliary codes, there are two codes worth mentioning:\n\n\n**Driver control**\n**code**\n\n\n**Meaning**\n\n\n-----\n\n0x222400 Start traffic filtering at RDP port 3389\n\n0x22240C Inject given data into filtering TCP stream. Used for Trojan\ncommunication with C2\n\n**In-memory C++ Trojan**\n\n**SHA256** c69121a994ea8ff188510f41890208625710870af9a06b005db817934b517bc1\n\n**MD5** 6a352c3e55e8ae5ed39dc1be7fb964b1\n\n**Compiled** 2018.03.26 04:15:48 (GMT)\n\n**Type** I386 Windows GUI DLL\n\n**Size** 175 616\n\nPlease note this Trojan exists in memory only; the data above is for the decrypted Windows\nregistry content without the initial shellcode\n\nThis RAT is decrypted by the NDISProxy driver from the system registry and injected into the\nlsass.exe process memory. Code starts with a shellcode – instead of typical Windows\nportable executable files loader this malware implements memory mapping by itself.\n\nThis Trojan is a full-featured RAT capable of executing common tasks such as command\nexecution and downloading/uploading files. This is implemented through a couple dozen C++\nclasses such as CMFile, CMFile, CMProcess, TFileDownload, TDrive, TProcessInfo, TSock,\netc. The first stage custom installer utilizes the same classes. The Trojan uses HTTP Server\nAPI to filter HTTPS packets at port 443 and parse commands.\n\n\n-----\n\n_The Trojan is an HTTP server, allowing LAN connection. It uses a SOCKS tunneler to communicate_\n\n_with the C2_\n\nThis Trojan is used by attackers to gather a target’s data, make lateral movements and\ncreate SOCKS tunnels to their C2 using the Earthworm tunneler. This tool is publicly\navailable and popular among Chinese-speaking actors. Given that the Trojan is an HTTPS\nserver itself, we believe that the SOCKS tunnel is used for targets without an external IP, so\nthe C2 is able to send commands.\n\n## Who’s behind it and why?\n\nWe found that this campaign targeted Middle Asian governments’ entities. We believe the\nattack was highly targeted and was linked to a high-level meeting. We assess with high\nconfidence that the Chinese-speaking LuckyMouse actor is responsible for this new\ncampaign using the NDISProxy tool described in this report.\n\nIn particular, the choice of the Earthworm tunneler is typical for Chinese-speaking actors.\nAlso, one of the commands used by the attackers (“-s rssocks -d 103.75.190[.]28 -e 443”)\ncreates a tunnel to a previously known LuckyMouse C2. The choice of victims in this\ncampaign also aligns with the previous interests shown by this actor.\n\n## Consistent with current trends\n\n\n-----\n\nWe have observed a gradual shift in several Chinese-speaking campaigns towards a\ncombination of publicly available tools (such as Metasploit or CobaltStrike) and custom\nmalware (like the C++ last stage RAT described in this report). We have also observed how\ndifferent actors adopt code from GitHub repositories on a regular basis. All this combines to\nmake attribution more difficult.\n\nThis campaign appears to demonstrate once again LuckyMouse’s interest in Central Asia\nand the political agenda surrounding the Shanghai Cooperation Organization.\n\n## Indicators of Compromise\n\n**_Note: The indicators in this section are valid at the time of publication. Any future changes_**\n_will be updated directly in the corresponding .ioc file._\n\n**File Hashes**\n\n**Droppers-installers**\n\n9dc209f66da77858e362e624d0be86b3\n\ndacedff98035f80711c61bc47e83b61d\n\n**Drivers**\n\n8e6d87eadb27b74852bd5a19062e52ed\n\nd21de00f981bb6b5094f9c3dfa0be533\n\na2eb59414823ae00d53ca05272168006\n\n493167e85e45363d09495d0841c30648\n\nad07b44578fa47e7de0df42a8b7f8d2d\n\n**Auxiliary Earthworm SOCKS tunneler and Scanline network scanner**\n\n83c5ff660f2900677e537f9500579965\n\n3a97d9b6f17754dcd38ca7fc89caab04\n\n**Domains and IPs**\n\n103.75.190[.]28\n\n213.109.87[.]58\n\n**Semaphores**\n\nGlobal\\Door-ndisproxy-mn\n\nGlobal\\Door-ndisproxy-help\n\nGlobal\\Door-ndisproxy-notify\n\n**Services**\n\n\n-----\n\nndisproxy-mn\nndisproxy-help\nndisproxy-notify\n\n**Registry keys and values**\n\nHKLM\\SOFTWARE\\Classes\\32ndisproxy-mn\n\nHKLM\\SOFTWARE\\Classes\\64ndisproxy-mn\n\nHKCR\\ndisproxy-mn\\filterpd-ndisproxy-mn\n\nHKLM\\SOFTWARE\\Classes\\32ndisproxy-help\n\nHKLM\\SOFTWARE\\Classes\\64ndisproxy-help\n\nHKCR\\ndisproxy-mn\\filterpd-ndisproxy-help\n\nHKLM\\SOFTWARE\\Classes\\32ndisproxy-notify\n\nHKLM\\SOFTWARE\\Classes\\64ndisproxy-notify\n\nHKCR\\ndisproxy-mn\\filterpd-ndisproxy-notify\n\n**Driver certificate**\n\nA lot of legitimate LeagSoft products are signed with the following certificate. Please don’t\nconsider all signed files as malicious.\n\n**Subject** ShenZhen LeagSoft Technology Co.,Ltd.\n\n**Serial number** 78 62 07 2d dc 75 9e 5f 6a 61 4b e9 b9 3b d5 21\n\n**Issuer** VeriSign Class 3 Code Signing 2010 CA\n\n**Valid to** 2018-07-19\n\n[Code injection](https://securelist.com/tag/code-injection/)\n[Cyber espionage](https://securelist.com/tag/cyber-espionage/)\n[Drivers](https://securelist.com/tag/drivers/)\n[Keyloggers](https://securelist.com/tag/keyloggers/)\n[RAT Trojan](https://securelist.com/tag/rat-trojan/)\n[Targeted attacks](https://securelist.com/tag/targeted-attacks/)\n\nAuthors\n\nGReAT\n\nLuckyMouse signs malicious NDISProxy driver with certificate of Chinese IT company\n\n\n-----\n\nYour email address will not be published. Required fields are marked\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-09-10 - LuckyMouse signs malicious NDISProxy driver with certificate of Chinese IT company.pdf"
    ],
    "report_names": [
        "2018-09-10 - LuckyMouse signs malicious NDISProxy driver with certificate of Chinese IT company.pdf"
    ],
    "threat_actors": [
        {
            "id": "e3492534-85a6-4c87-a754-5ae4a56d7c8c",
            "created_at": "2022-10-25T15:50:23.819113Z",
            "updated_at": "2025-03-27T02:00:55.552554Z",
            "deleted_at": null,
            "main_name": "Threat Group-3390",
            "aliases": [
                "Threat Group-3390",
                "Earth Smilodon",
                "TG-3390",
                "Emissary Panda",
                "BRONZE UNION",
                "APT27",
                "Iron Tiger",
                "LuckyMouse"
            ],
            "source_name": "MITRE:Threat Group-3390",
            "tools": [
                "Systeminfo",
                "gsecdump",
                "PlugX",
                "ASPXSpy",
                "Cobalt Strike",
                "Mimikatz",
                "Impacket",
                "gh0st RAT",
                "certutil",
                "China Chopper",
                "HTTPBrowser",
                "Tasklist",
                "netstat",
                "SysUpdate",
                "HyperBro",
                "ZxShell",
                "RCSession",
                "ipconfig",
                "Clambling",
                "pwdump",
                "NBTscan",
                "Pandora",
                "Windows Credential Editor"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "c63ab035-f9f2-4723-959b-97a7b98b5942",
            "created_at": "2023-01-06T13:46:38.298354Z",
            "updated_at": "2025-03-27T02:00:02.798255Z",
            "deleted_at": null,
            "main_name": "APT27",
            "aliases": [
                "TG-3390",
                "EMISSARY PANDA",
                "TEMP.Hippo",
                "Budworm",
                "Group 35",
                "BRONZE UNION",
                "Lucky Mouse",
                "Iron Taurus",
                "GreedyTaotie",
                "Red Phoenix",
                "ZipToken",
                "Iron Tiger",
                "G0027",
                "Earth Smilodon"
            ],
            "source_name": "MISPGALAXY:APT27",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5c13338b-eaed-429a-9437-f5015aa98276",
            "created_at": "2022-10-25T16:07:23.582715Z",
            "updated_at": "2025-03-27T02:02:09.875151Z",
            "deleted_at": null,
            "main_name": "Emissary Panda",
            "aliases": [
                "APT 27",
                "ATK 15",
                "Bronze Union",
                "Budworm",
                "Earth Smilodon",
                "Emissary Panda",
                "Group 35",
                "Iron Taurus",
                "Iron Tiger",
                "LuckyMouse",
                "Operation DRBControl",
                "Operation Iron Tiger",
                "Operation PZChao",
                "Operation SpoiledLegacy",
                "Operation StealthyTrident",
                "Red Phoenix",
                "TEMP.Hippo",
                "TG-3390",
                "ZipToken"
            ],
            "source_name": "ETDA:Emissary Panda",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agent.dhwf",
                "AngryRebel",
                "Antak",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "FOCUSFJORD",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HTran",
                "HUC Packet Transmit Tool",
                "HighShell",
                "HttpBrowser RAT",
                "HttpDump",
                "HyperBro",
                "HyperSSL",
                "HyperShell",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "Nishang",
                "OwaAuth",
                "PCRat",
                "PlugX",
                "ProcDump",
                "PsExec",
                "RedDelta",
                "SEASHARPEE",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "SysUpdate",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Token Control",
                "TokenControl",
                "TwoFace",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "gsecdump",
                "luckyowa"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536182,
    "ts_updated_at": 1743041745,
    "ts_creation_date": 1653703406,
    "ts_modification_date": 1653703406,
    "files": {
        "pdf": "https://archive.orkl.eu/78aebb86a5aeacd70d5c49ef7c4b915db651a44f.pdf",
        "text": "https://archive.orkl.eu/78aebb86a5aeacd70d5c49ef7c4b915db651a44f.txt",
        "img": "https://archive.orkl.eu/78aebb86a5aeacd70d5c49ef7c4b915db651a44f.jpg"
    }
}