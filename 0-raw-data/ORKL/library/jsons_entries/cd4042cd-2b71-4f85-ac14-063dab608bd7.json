{
    "id": "cd4042cd-2b71-4f85-ac14-063dab608bd7",
    "created_at": "2023-01-12T15:05:33.353825Z",
    "updated_at": "2025-03-27T02:06:01.905367Z",
    "deleted_at": null,
    "sha1_hash": "5992e8e548e6d9fd854a0f5a55322abb6b064563",
    "title": "2022-05-08 - Ursnif Malware Banks on News Events for Phishing Attacks",
    "authors": "",
    "file_creation_date": "2022-05-28T01:21:43Z",
    "file_modification_date": "2022-05-28T01:21:43Z",
    "file_size": 1155550,
    "plain_text": "# Ursnif Malware Banks on News Events for Phishing Attacks\n\n**[blog.qualys.com/vulnerabilities-threat-research/2022/05/08/ursnif-malware-banks-on-news-events-for-phishing-attacks](https://blog.qualys.com/vulnerabilities-threat-research/2022/05/08/ursnif-malware-banks-on-news-events-for-phishing-attacks)**\n\nAmit Gadhave May 8, 2022\n\nUrsnif (aka Gozi, Dreambot, ISFB) is one of the most widespread banking trojans. It has been observed evolving over the past few years.\nUrsnif has shown incredible theft capabilities. In 2020 Ursnif rose to prominence becoming one of the top ten most prolific pieces of malware.\nAmong its core functionalities are stealing credentials, downloading other malware, working as a keylogger, among others.\n\nUrsnif is mostly spread through spear phishing emails. Its attacks are often targeted at banking, financial services, and government agencies.\nIn phishing emails, it tries to impersonate government authorities and leverage current events in the news to gain user trust, which leads to\ninitial access to the victim’s system. Once the user opens the malicious attachment, the trojan uses User Agents that imitated Zoom and\nWebex in a further effort to blend in and allow for exploitation. This behavior was observed during the peak of the pandemic.\n\n## Technical Analysis of Ursnif Malware\n\n**Infection Chain**\n\nIn our analysis, phishing emails with a macro embedded XLS attachment or a zip attachment containing an HTA file initiated the infection\nchain, as pictured below.\n\nFig. 1 Infection\n\nchain\n\n**Infection Scenario 1: XLS Document Analysis**\n\n\n-----\n\na c ous S docu e t ( g ) p ete ds to be a docu e t e ated to, t e s pp g co pa y t co ta s ac o code to do oad\na binary file from the URL embedded in the document. Once the User enables macro content, the macro gets executed which further\ndownloads the executable binary.\n\nFig. 2 Malicious XLS document\n\nAfter downloading the binary file, it retrieves the handle of `explorer.exe process and calls UpdateProcThreadAttribute to perform parent`\nPID spoofing (fig. 3).\n\nFig. 3 VBA macro code performing PPID spoofing\n\n\n-----\n\nt e pa e t p ocess o t e d opped e ecutab e, ( 0 e e) s spoo ed to e p o e `e e` to e ade detect o ( g )\n\nFig. 4 PPID spoofing\n\n**Infection Scenario 2: HTA Document Analysis**\n\nIn another infection scenario, we observed that the phishing email is sent with a zip attachment having an HTA file. After de-obfuscating\nseveral layers, PowerShell script downloads a DLL file from an embedded URL and executes it using rundll32.exe. The extension used for the\nremote DLL is .txt, a feasible way to evade the watchful eyes of most security products.\n\nBelow, figure 5 shows several obfuscation layers in the HTA sample:\n\nFig. 5 HTA document analysis\n\n## Technical Analysis of Ursnif Loader\n\nUrsnif loader contains several layers of in-memory unpacking routines which are observed in malware families like zloader, emotet, and others.\nIt rewrites an in-memory image with a new unpacked binary that uses the Thread APC injection technique to execute malicious code in\nanother thread of a current process. Once the control is passed to the final loader, it decrypts the BSS section.\n\nThe BSS section contains important configuration details in encrypted form, such as libraries and API names, string formats for sending data to\nCommand & Control (CnC), registry entries, bat commands format, PowerShell commands format, HTA application format, etc. These\nconfiguration details are required for performing further activities. Below, figures 7 and 8 reveal that the malware uses campaign date as a key\nto decrypt the BSS section.\n\n\n-----\n\nFig. 6 BSS section\n\n\ndecryption routine\n\nFig. 7 Decrypted BSS section content\n\nUrsnif parses the configuration details through the JJ structure present in the PE (Portable Executable) header (fig. 9). The JJ structure\ncontains the config blob address, config size, CRC Hash of decoded config and XOR key used to decode the config blob.\n\nFig. 8 JJ header of loader\n\nBelow, figure 10 reveals the configuration details present in the blob.\n\nFig. 9 Configuration blob of loader\n\nThe malware process iterates through CnC and uses these configuration details to generate a http GET request to CnC as shown in figure 10.\nIt collects some information from the host machine like computer name, username, uptime, and CRC.\n\n\n-----\n\nFig. 10 HTTP GET request\nBelow are parameters which are encrypted in the GET request:\n```\nsoft, version, user, server, id, crc, uptime, size, hash, dns, whoami\n\n```\nParameters like `soft and` `version are hardcoded in the binary. Here, the version might specify the malware binary version.`\n\nThe `user parameter is generated using username, computer name, and the result of _CPUID instruction. It may be used by the threat actor`\nto uniquely refer to execution instance.\n\nThe `server and` `id values are taken from the extracted config.`\n\nThe `uptime parameter is a result of the QueryPerformanceCounter API.`\n\nFurther, it encrypts a http request with (AES-CBC mode) using a 128-bit key present in the extracted config and performs BASE64 encoding. It\nperforms transformations like replacing `+,` `/ with` `_2B,` `_2F respectively and inserts` `/ at random locations.`\n\nFigure 11 shows a typical encrypted http GET request.\n\nFig. 11 Encrypted request\n\nIf CnC is active, it responds with encrypted data in BASE64 encoded form. In recent versions (2.60.xxx), we observed that sometimes data is\nnot base64 encoded. Below, figure 12 shows a typical response from the server:\n\nFig. 12\n\nEncrypted response\nUrsnif malware first decodes the base64 string and then decrypts the last 0x80 bytes using an RSA key embedded in the config. Below, figure\n13 reveals the RSA key present in the config.\n\nFig. 13 RSA key present in the sample\n\n\n-----\n\nFig. 14\n\nImplementation for RSA decryption logic\nThe last 0x80 bytes holds required information to decrypt the full response like a MD5 hash of the decrypted data, the key to decrypt data, and\nthe size of the data to decrypt (fig. 15).\n\nFig. 15 Last 0x80 bytes of response\n\nOnce the full response is decrypted (AES-CBC mode) using the key received, it will validate the decrypted data by checking the MD5 hash.\nUrsnif can take a different action based on the response received. In our analysis, we observed that the decrypted data is the final payload of\nUrsnif.\n\n## Technical Analysis of Ursnif Payload\n\nIn our analysis, we saw that the final payload is a keylogger. Once control is transferred to the payload, it will connect to the CnC address\nextracted from its config and download an RSA encrypted browser account grabber module.\n\nAfter decryption, it collects Chrome, Firefox, and Microsoft Edge browsers’ sensitive info like credentials, cookies, etc. via this grabber module,\ncompresses it, and AES (Advanced Encryption Standard) encrypts it using the key from config. Further, it sends this information to the\nattacker’s CnC via http post request (figs. 16, 17). While sending information, it uses the following different values for the post parameter\n```\ntype to differentiate the kind of information it is sending. Some values include:\n\n```\nType=6 – System info\n\nType=15 – Key logged data, clipboard etc.\n\nType=20 – Saved browser credentials\n\nType=22 – Cookies\n\n\n-----\n\nFig. 16 Sending credentials\n\nFig. 17 Sending cookies\nUrsnif malware also collects and sends the following sensitive system information:\n\n1. Output of `System Info command`\n2. List of processes – task list /svc\n3. List of installed drivers – driver query\n4. Registry query information (details of installed applications) –\n\nreg query HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\n5. Output of `Net config workstation`\n\nUrsnif then starts capturing keylogging and clipboard events in the system and sends it to the attacker’s CnC at regular intervals. All the data it\nsends is first compressed and then AES encrypted using the key present in the config.\n\nBased on Ursnif’s code, the malware also has the capability to download and execute binary and upload files and screenshots from the\nvictim’s system.\n\nBased on our analysis, one thing is clear: Ursnif is bad news.\n\nIOCs:\nDomains:\n\n\n-----\n\n```\nlinkspremium[.]ru\npremiumlists[.]ru\nVilogerta[.]top\ninterblog[.]top\ninterforum[.]top\npremiumlines[.]top\nlinespremium[.]ru\nlinespremium[.]pw\nblogerslives[.]com\nblogerslines[.]com\nblogspoints[.]com\nblogspoints[.]ru\nfilmspoints[.]com\n\n```\nHashes:\n```\nXLS document:\nD39AAA321588E8B1E8FE694732B533BE31C57B60A3C1B7CF73047974606C0C64\nEF2CD6B4FD4FBEEDC663F59C5196F63338B9F66242230D15F70CDAEBA3BFDE54\nHta document:\nDC21DB5D469BD554E41C8AEA35324E875475418AE23EB2378265636F0F781F85\nloader:\n42A1D2A7885898C85524A6B18550A9E01B86E5AD1C33AF845B6AE1450EF69BFE\nD61EE5E7B17684983EA9049F719BEB05978A813638F53F7625E970BAE1C2ABD7\n32C049803E5E151D305C79A1067920A7EAA2DABB92FA7F33EF950097BBA016F2\nPayload:\nCCB10C384D7A9C1D5C1C0383F97DF96B299D641FAECC7F3B4A5F31F2C0707C8A\n739E193792AA810BCB005DDF4606366D472FE41EC50C304384EBA212510CC239\nA204181541DC2772443BB00328D084EDC872CF61289862220F93994FE4E9ED21\n0F3AA6870B171BEA342D0CF7166332F047BA58CCDED701E0AAA2BE84194203B9\nBrowser account grabber\n91C4EDD3F6C51AFFD87434A3DB15B25408C26F7B77D94E568F91B9A5C4D63372\n44E35DB1C2BFEEEE33F0A74874BE2E0CC041A38E63E78DA425052B0DFEB5F93D\n\n```\nUrsnif Mitre Att&ck TTP Map:\n\n\n**Initial**\n**Access** **Execution** **Persistence**\n\n\n**Defense**\n**Evasion**\n\nParent PID\nSpoofing\n(T1134.004)\n\nObfuscated\nFiles or\nInformation\n(T1027)\n\nProcess\nInjection:\nAsynchronous\nProcedure\nCall\n(T1055.004)\n\n\n**Credential**\n**Access** **Discovery** **Collection**\n\n\nCredentials\nfrom\nPassword\nStores:\nCredentials\nfrom Web\nBrowsers\n(T1555.003)\n\nInput\nCapture:\nKeylogging\n(T1056.001)\n\nInput\nCapture:\nGUI\n(Graphical\nUser\nInterface)\nInput\nCapture\n(T1056.002)\n\n\n**Command**\n**and**\n**Control** **Exfilt**\n\n\nPhishing:\nSpear\nphishing\nAttachment\n(T1566.001)\n\n\nUser Execution\n(T1204 .002)\n\nCommand and\nScripting\nInterpreter:\nVisual Basic\n(T1059.005)\n\nCommand and\nScripting\nInterpreter:\nPowerShell\n(T1059.001)\n\n\nBoot or\nLogon\nAutostart\nExecution:\nRegistry\nRun Keys /\nStartup\nFolder\n(T1547.001)\n\nCreate or\nModify\nSystem\nProcess:\nWindows\nService\n(T1543.003)\n\n\n**privilege**\n**Escalation**\n\nProcess\nInjection:\nAsynchronous\nProcedure\nCall\n(T1055.004)\n\n\nApplication\nWindow\nDiscovery\n(T1010)\n\nProcess\nDiscovery\n(T1057)\n\nQuery\nRegistry\n(T1012)\n\n\nClipboard\nData (T1115)\n\nInput\nCapture:\nKeylogging\n(T1056.001)\n\nInput\nCapture: GUI\nInput\nCapture\n(T1056.002)\n\n\nApplication\nLayer\nProtocol:\nWeb\nProtocols\n(T1071.001)\n\nIngress Tool\nTransfer\n(T1105)\n\n\nExfilt\nOver\nChan\n(T104\n\n\n-----\n\n**Initial**\n**Access** **Execution** **Persistence**\n\nWindows\nManagement\nInstrumentation\n(T1047)\n\n\n**privilege**\n**Escalation**\n\nSystem\nBinary Proxy\nExecution –\nRundll32\n(T1218.011)\n\n\n**Defense**\n**Evasion**\n\nSystem\nBinary Proxy\nExecution –\nRegsvr32\n(T1218.010)\n\n\n**Credential**\n**Access** **Discovery** **Collection**\n\n\nSteal Web\nSession\nCookie\n(T1539)\n\nSystem\nService\nDiscovery\n(T1007)\n\n\n**Command**\n**and**\n**Control** **Exfilt**\n\n\nSystem\nInformation\nDiscovery\n(T1082)\n\n\nData from\nConfiguration\nRepository:\nNetwork\nDevice\nConfiguration\nDump\n(T1602.002)\n\n\n## Detection, Mitigation or Additional Important Safety Measures\n\nBeware of emails\n\nDon’t open attachments and links from unsolicited emails. Delete suspicious looking emails you receive from unknown sources,\nespecially if they contain links or attachments. Cybercriminals use ‘social engineering’ techniques to lure users into opening attachments\nor clicking on links that lead to infected websites.\n\nDisable macros for Microsoft Office\n\nDon’t enable macros in document attachments received via email. A lot of malware infections rely on your action to turn ON macros.\nConsider installing Microsoft Office Viewers. These viewer applications let you see what documents look like without even opening them\nin Word or Excel. More importantly, the viewer software doesn’t support macros at all, so this reduces the risk of enabling macros\nunintentionally.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-08 - Ursnif Malware Banks on News Events for Phishing Attacks.pdf"
    ],
    "report_names": [
        "2022-05-08 - Ursnif Malware Banks on News Events for Phishing Attacks.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535933,
    "ts_updated_at": 1743041161,
    "ts_creation_date": 1653700903,
    "ts_modification_date": 1653700903,
    "files": {
        "pdf": "https://archive.orkl.eu/5992e8e548e6d9fd854a0f5a55322abb6b064563.pdf",
        "text": "https://archive.orkl.eu/5992e8e548e6d9fd854a0f5a55322abb6b064563.txt",
        "img": "https://archive.orkl.eu/5992e8e548e6d9fd854a0f5a55322abb6b064563.jpg"
    }
}