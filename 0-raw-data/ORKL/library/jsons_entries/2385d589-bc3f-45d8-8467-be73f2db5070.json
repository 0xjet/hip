{
    "id": "2385d589-bc3f-45d8-8467-be73f2db5070",
    "created_at": "2023-01-12T15:10:33.421706Z",
    "updated_at": "2025-03-27T02:05:43.674057Z",
    "deleted_at": null,
    "sha1_hash": "7f564a66e2a91babf99d59aa764f1b36e69da9f8",
    "title": "2020-06-02 - Ursnif-Gozi Delivery - Excel Macro 4.0 Utilization Uptick & OCR Bypass",
    "authors": "",
    "file_creation_date": "2022-05-28T17:09:31Z",
    "file_modification_date": "2022-05-28T17:09:31Z",
    "file_size": 340531,
    "plain_text": "# Ursnif/Gozi Delivery - Excel Macro 4.0 Utilization Uptick & OCR Bypass\n\n**[blog.morphisec.com/ursnif/gozi-delivery-excel-macro-4.0-utilization-uptick-ocr-bypass](https://blog.morphisec.com/ursnif/gozi-delivery-excel-macro-4.0-utilization-uptick-ocr-bypass)**\n\n[Tweet](https://twitter.com/share)\n\n\n-----\n\n## Ursnif/Gozi Introduction:\n\nMorphisec has been tracking an uptick in the delivery of Ursnif/Gozi during the COVID-19\npandemic. Specifically, we have noticed a significant spike both in numbers and\nsophistication. The latest delivery methods will many times involve old-school Excel 4.0\nmacro functionality, which historically is a blind spot for AV detection as it has nothing to do\n[with the VBA macro engine and is integrated as part of the workbook. INQUEST reported the](https://inquest.net/blog/2020/05/06/ZLoader-4.0-Macrosheets-)\nuse of similar techniques as part of a Zloader delivery campaign. Interestingly, in the latest\ncampaign, it looks like the malware writers removed the image from the Excel document to\navoid OCR heuristic detection following the INQUEST article.\n\nExcel 4.0 was released in 1992, ready for use on Windows 3.0 and 3.1. At its release, Excel\n4.0 featured the ability to use macro worksheets as a way to deploy XLM macros for\nautomation. The feature worked well enough and enabled backwards compatibility up to\nExcel 4.0. The following year, Visual Basic for Applications (VBA) macros were released in\nExcel 5.0, and macro worksheets were phased out.\n\nAs with many other backward-compatible enabled features, these macro worksheets provide\nplenty of offensive opportunities, seeing as they still function within the current build of Excel.\nMost of the functionality you can do with VBA can also be achieved using XLM macros,\nincluding access to the Win32 API, integrated as part of .xlm, .xls, and .xlsm files. This\nmakes the functionality a viable attack vector for Excel worksheets delivered via social\nengineering emails.\n\n## Ursnif/Gozi Technical\n\nWe observed this specific campaign, starting at the beginning of January, that uses\nadvanced obfuscation techniques to evade detection. Many of the files have a .xlsm\nextension and have less than a 3 detection score. A score of less than 3 is not a high enough\nthreshold for a static heuristic-based approach to classify the file as suspicious (not even\ntalking about malicious). For this reason, many detection-based solutions miss this type of\nfile.\n\n_Figure 1 -- Low VirusTotal detection rate_\n\nThe file content asks the victim to enable editing and content in written text rather than an\nimage as mostly seen in these campaigns. Our assumption is that the attacker is trying to\nevade OCR heuristic detection methods.\n\n\n-----\n\n_Figure 2 -- Asks the victim to enable content by text_\n\nIn this campaign, the sheet hidden state is set to Hidden. The auto-open sheet can be found\nby looking at the Name Manager option under Formulas.\n\n_Figure 3 -- Auto-Open Cell_\n\nThe macro worksheet is heavily obfuscated and will start with a number of “RUN” commands\nthat eventually ends with several interesting commands such as “CALL” and “EXEC”.\n\n\n-----\n\n_Figure 4 -- The obfuscated CALL commands_\n\n[@DissectMalware wrote a tool that deobfuscates these Excel 4 macros. Looking at the](https://github.com/DissectMalware/XLMMacroDeobfuscator/)\noutput of the tool, we can see the pattern below.\n\n_Figure 5 -- Deobfuscated commands._\n\nThe macro utilizes the Win32 API function to download the next stage. In this case, it is Gozi.\n\n## Conclusion\n\n_Ursnif/Gozi continues to change and evolve, showing that threat actors are increasingly_\nlooking for any opportunity they might have to evade detection solutions. Morphisec’s\ncustomers can be confident that they are protected against the malicious Excel macros\ndelivered by Ursnif/Gozi and others.\n\nIOC’s (SHA-1):\n\n\n-----\n\nF0fa0bccb67b0c01f238a5eca9c46b9faa0bd6a7\n1d6f74390e8a00e28975ec5181fe18aab956e5b3\n4cca909d440e7ce3626922db54872fba43b51855\n3115d21f0bc774996e7eb925c8badfe8172ae781\n1669b5553ef576c558bc6a49482a9c32d218641c\nAa64141ae3d4706eddeccdacbbef413f173f26b6\n7b6cabda9cfb7b23af2211d2a11ef9a504479a16\n7ec3f150ca07ff1a67487eb7e74e17eaa15a1144\nF8aef0dac089067ca9024423eca9042f8b1ac845\n164dff79a7afe7a74d8ff06a564e81d36df29286\nFef9ab8c1df75fbcdb717d23a7f0f3a3a8512f16\n24c898ad6e3107474cb3bfbe606aa8f562a6f76a\nB0d168485f482d4685c3d9f034171be457fd7b31\nC33ee864fc398ee9ae1f7994f1aa84101cd6a421\n3479d044d78dc9a309e1b6ccd533e601235dbde5\nC33ee864fc398ee9ae1f7994f1aa84101cd6a421\n3479d044d78dc9a309e1b6ccd533e601235dbde5\n66b9c31b5ab8deccd4c3711515d8021232c1a9af\n7848de9c2e505e418ae0b0f7d7fc9fae9f371197\n6b0d60b336972892667e71e415e3c21407307dc1\nAfa0c9be4f05629e773c4304bbabeab2fd5befc8\nB0734e1b869db25b66c5f03ed50133519c222284\nA7b2badc79cc494eba7a0da8e13df49d226c4409\nC8c3be4745ad3b0d88c4a8566ac0c780c0ce17f6\n2404a7c358629dca3839cef3ea18c5b30c778adc\n\n[Contact SalesInquire via Azure](http://10.10.0.46/mailto:sales@morphisec.com)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-02 - Ursnif-Gozi Delivery - Excel Macro 4.0 Utilization Uptick & OCR Bypass.pdf"
    ],
    "report_names": [
        "2020-06-02 - Ursnif-Gozi Delivery - Excel Macro 4.0 Utilization Uptick & OCR Bypass.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536233,
    "ts_updated_at": 1743041143,
    "ts_creation_date": 1653757771,
    "ts_modification_date": 1653757771,
    "files": {
        "pdf": "https://archive.orkl.eu/7f564a66e2a91babf99d59aa764f1b36e69da9f8.pdf",
        "text": "https://archive.orkl.eu/7f564a66e2a91babf99d59aa764f1b36e69da9f8.txt",
        "img": "https://archive.orkl.eu/7f564a66e2a91babf99d59aa764f1b36e69da9f8.jpg"
    }
}