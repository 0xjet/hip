{
    "id": "c73d148d-59c4-49b6-8f99-c7633ce82fed",
    "created_at": "2023-01-12T15:04:00.962801Z",
    "updated_at": "2025-03-27T02:06:03.919028Z",
    "deleted_at": null,
    "sha1_hash": "938bf3b5410b3becba259b41023b39b7817adfec",
    "title": "2021-03-31 - Dissecting a RAT. Analysis of the AndroRAT",
    "authors": "",
    "file_creation_date": "2022-05-28T01:23:55Z",
    "file_modification_date": "2022-05-28T01:23:55Z",
    "file_size": 3050424,
    "plain_text": "# Dissecting a RAT. Analysis of the AndroRAT.\n\n**[stratosphereips.org/blog/2021/3/29/dissecting-a-rat-analysis-of-the-androrat](https://www.stratosphereips.org/blog/2021/3/29/dissecting-a-rat-analysis-of-the-androrat)**\n\nKamila Babayeva March 31, 2021\n\n**_This blog post was authored by Kamila Babayeva (@_kamifai_) and Sebastian Garcia_**\n**_(@eldracote)._**\n\n_The RAT analysis research is part of the Civilsphere Project_\n_[(https://www.civilsphereproject.org/), which aims to protect the civil society at risk by](https://www.civilsphereproject.org/)_\n_understanding how the attacks work and how we can stop them. Check the webpage for_\n_more information._\n\nThis is the fourth blog of a series analyzing the network traffic of Android RATs from our\n[Android Mischief Dataset [more information here], a dataset of network traffic from Android](https://www.stratosphereips.org/android-mischief-dataset)\nphones infected with Remote Access Trojans (RAT). In this blog post we provide the\n[analysis of the network traffic of the RAT05-AndroRAT [download here]. The previous blogs](https://mcfp.felk.cvut.cz/publicDatasets/Android-Mischief-Dataset/AndroidMischiefDataset_v1/AndroRat.zip)\n[analyzed Android Tester RAT,](https://www.stratosphereips.org/blog/2020/12/14/ngwqj0h060yv40w1afp51fg7wo9ijy-pzlhk) [DroidJack RAT, and](https://www.stratosphereips.org/blog/2021/1/22/analysis-of-droidjack-v44-rat-network-traffic) [SpyMax RAT.](https://www.stratosphereips.org/blog/2021/2/26/dissecting-a-rat-analysis-of-the-spymax)\n\n## RAT Details and Execution Setup\n\nThe goal of each of our RAT experiments is to configure and execute the RAT software and\nto do every possible action while capturing all traffic and storing all logs. These RAT\ncaptures are functional and used as in real attacks.\n\n\n-----\n\nThe AndroRAT RAT is a software package that contains the controller software and builder\nsoftware to create an APK. We executed the builder on a Windows 7 Virtualbox virtual\nmachine with Ubuntu 20.04 as a host. The Android Application Package (APK) built by the\nRAT builder was installed in an Android virtual emulator called Genymotion with Android\nversion 8.\n\nWhile performing different actions on the RAT controller (e.g. upload a file, get GPS\nlocation, monitor files, etc.), we captured the network traffic on the Android virtual\n[emulator. The network traffic from the phone was captured using Emergency VPN.](https://www.civilsphereproject.org/emergency-vpn)\n\nThe details about the network traffic capture are:\n\nThe controller IP address: 147.32.83.234\n\nThe phone IP address: 10.8.0.137\n\nUTC time of the infection in the capture: 2020-09-10 15:18:00 UTС\n\n## Initial Communication and Infection\n\nOnce the APK was installed on the phone, it directly tries to establish a TCP connection\nwith the command and control (C&C) server. To connect, the phone uses the IP address\nand the port of the controller specified in the APK. In our case, the IP address of the\ncontroller is 147.32.83.234 and the port is 1337/TCP. The controller IP 147.32.83.234 is the\nIP address of a Windows 7 virtual machine in our lab computer, meaning that the IP\naddress is not connected to any known indicator of compromise (IoC). Figure 1 shows the\ninitial communication from the phone to the C&C.\n\n**_Figure 1. A 3-way handshake to establish the first connection between the phone and the_**\nC&C.\n\nAfter establishing the first connection, the phone sends its first packet with some\nparameters, such as SIM card operator, phone number, SIM card serial number, IMEI, etc.\nFigure 2 displays the packet data in a structured way. It can be seen that the data is sent in\nplaintext and the character ‘t’ is used as the delimiters to separate parameters name and\nvalues. From the packet structure in Figure 2,it can also be defined that APK uses the Java\nHashtable class to store and send parameters.\n\nÿÿ¬ísrjava.util.Hashtable»%!Jä¸F\n\n**loadFactorI** **thresholdxp?@**\n\nw\n\n\n-----\n\nt Operator t Android\nt SimOperator t Android\nt SimSerial t 8931027000000000007\nt SimCountry t us\nt PhoneNumber t 15555218135\nt Country t us\nt IMEI t 000000000000000\n\nx\n**_Figure 2. The first data packet sent by the phone and an analysis of its structure. The data_**\nis sent in the plain text and the character ‘t’ is used as a field delimiter.\n\nAfter the initial connection by the phone, the command and control server shows the phone\nin its interface. Figure 3 displays the C&C interface with the initialization parameters that\nwere sent by the phone in the first packet.\n\n**_Figure 3. The C&C interface panel displays the parameters of the phone after the infection._**\n\n## C&C Command Packet Structure\n\n\n-----\n\nAfter the first connection the phone is waiting for the C&C command. To send the command\nfrom the C&C, a special panel on the C&C interface should be opened by double-clicking\non the infected device. Figure 4 shows the panel in the C&C interface. When the attacker\nusing the C&C interface enters this panel, the C&C server sends two commands to the\nphone, shown in Figure 5 and Figure 6.\n\n**_Figure 4. Panel in the C&C interface used to send commands to the phone._**\n\n**0000  00 00 00 06 00 00 00 06 01 00 00 00 00 00 00 00  ................**\n\n**0010  79 00 00 01 67                  y...g**\n\n**_Figure 5. Data of the first packet sent by the C&C when the attacker enters into the panel to_**\ncontrol the phone.\n\n**0000  00 00 00 06 00 00 00 06 01 00 00 00 00 00 00 00  ................**\n\n**0010  15 00 00 02 6e                  ....n**\n\n**_Figure 6. Data of the second packet sent by the C&C when the attacker enters into the_**\npanel to control the phone.\n\n\n-----\n\nSince the structure of these packets is not clear, we tried to understand what these\ncommands mean by reverse engineering the APK that was used to infect the victim’s\nphone. The analysis shows that each C&C command is mapped to a single character that\nrepresents this command. The mapping is shown in Figure 7.\n\n**_Figure 7. The mapping of each C&C commands (in capital letters) into a single character_**\ndefined by a number. Found by reverse engineering the APK used to infect the victim.\n\n\n-----\n\nEach C&C command packet has a 15 bytes long header. The header contains:\n\n**Name Length**\nbyteTotalLength 4 bytes\nbyteLocalLength 4 bytes\nbyteMoreF     1 byte\nbytePointeurData 2 bytes\nbyteChannel 4 bytes\n\nThe header structure was learned from the Java code of the APK for the function\n_dataHeaderGenerator, which creates a header for the packet data. This header is used for_\nthe packets sent from the C&C and the phone. Figure 8 shows this function.\n\n**_Figure 8. Java code from the APK for the function dataHeaderGenerator. This function_**\ngenerates the header for the C&C and phone packets.\n\nAfter the 15 byte long header, the C&C sends commands using the following data structure:\n\n**Name Length**\n\ncommand 2 bytes\n\ntargetChannel 4 bytes\n\nargument remaining data packet length\n\nThis data structure appears to be in the packets sent from the C&C and the packets from\nthe phone. Figure 9 shows the function parse that unwraps the packet data according to the\nstructure mentioned above.\n\n**_Figure 9. Java code from the malicious APK for the function parse. This function unwraps_**\nthe C&C command.\n\n\n-----\n\nConsidering the analysis above, we can explain the packets sent in Figure 5 and Figure 6.\nThe packet from Figure 5 has the following structure:\n\n**Header Value Hex Decimal representation**\nbyteTotalLength 00 00 00 06 6\nbyteLocalLength 00 00 00 06 6\nbyteMoreF 01 1\nbytePointeurData 00 00 0 0\nbyteChanel 00 00 00 00 0 0 0 0\nC&C Command 00 79 121\ntargetChannel 00 00 01 67 0 0 1 103\narguments - \n**Figure 10. Analysis of the packet structure of the C&C command ‘Advanced Information’**\nsent to the phone.\n\nFigure 10 shows an analysis diagram of the meaning of a packet sent to the phone with the\ncommand ‘Advanced Information’. This packet has a data length of 6, therefore everything\nafter the field byteChannel (00 79 00 00 01 67) has a length of 6 bytes. The bytes 00 79,\nwhich are used to represent C&C command, mean 121 in decimal representation.\nAccording to the mapping in Figure 7, the value 121 responds to the command ‘Advanced\nInformation’. Figure 11 shows how. The variable P_INST is 100, and the command\nGET_ADV_INFORMATIONS is P_INST + 21 = 100 + 21 = 121\n\n**_Figure 11. Mapping value of the C&C command ‘GET_ADV_INFORMATIONS’. The value_**\nof this command is 121 in decimal which is 00 79 in hexadecimal.\n\nRegarding the second packet shown in Figure 6, it has the following structure:\n\n**Header Value Hex Decimal representation**\n\nbyteTotalLength 00 00 00 06 6\n\nbyteLocalLength 00 00 00 06 6\n\n\n-----\n\nbyteMoreF 01 1\nbytePointeurData 00 00 0 0\nbyteChanel 00 00 00 00 0 0 0 0\nC&C Command 00 15 21\ntargetChannel 00 00 02 6e 0 0 1 103\narguments - \n**_Figure 12. Analysis of the packet structure of the C&C command ‘Preferences’ sent to the_**\nphone.\n\nFor this packet, the data length is 6, therefore everything after the field byteChannel (00 15\n00 00 02 6e) has a length of 6 bytes. The bytes 00 15, that are used for defining C&C\ncommand, mean 21 in decimal representation. According to the mapping in Figure 7, it is\nthe command ‘Preferences’. Figure 13 shows how this command is computed.\n\n**_Figure 13. Mapping of the C&C command GET_PREFERENCE from Figure 7._**\nGET_PREFERNCES is 21 in decimal, and 00 15 in hexadecimal.\n\nConsidering the analysis done on the packet and the APK, the packet structure of the C&C\ncommand can be summarized as:\n\n**_Figure 14. Summary of the packet structure of the C&C commands._**\n\n## Victim Phone Packet Structure\n\nThe phone answers to the C&C command ‘getPreferences’ and the command ‘Advanced\ninformations’ with its own packets. The structure of the packets sent from the phone is\ndifferent from the C&C command packet structure shown in Figure 14. Figure 15 shows the\n\n\n-----\n\nanalysis of APK function send that sends the packet from the phone with a specific\nstructure. The packet structure the function uses is the following:\n\n**Name Length**\nheader 15 bytes\ndata no more than 2033 bytes\n\nThe header in that structure uses a substructure:\n\n**Name Length**\nbyteTotalLength 4 bytes\nbyteLocalLength 4 bytes\nbyteMoreF 1 byte\nbytePointeurData 2 bytes\nbyteChannel 4 bytes\n\nAs for the data in the packet, if its length exceeds the limit of 2033 bytes, the data will be\nfragmented into more packets. Each packet will have a separate 15 bytes long header and\nwill be fragmented with a length of 2033 bytes or less.\n\n**_Figure 15. Java code from the APK for the command ‘send’. This function sends the packet_**\nfrom the phone according to the specific structure.\n\n\n-----\n\nUsing this structure we can now interpret the packets sent by the phone. Figure 16 shows\nthe phone answer to the C&C command ‘get Preferences’ and the structure of the packet.\nThe phone sends the 15 byte long header followed by the data. The data in Figure 16\nincludes the preferred parameters for phonNumberCall, phoneNumberSMS, keywordSMS.\n\n**_Figure 16. Packet sent from the phone as an answer to the C&C command ‘get_**\nPreferences’. The packet data and its structure is shown.\n\nThe phone sends data about the battery status, phone info, and wifi information to answer\nthe C&C command ‘Advanced Information’. The phone uses the same structure of 15 byte\nlong header and the data. Figure 17 shows a raw answer of the phone to the C&C\ncommand ‘Advanced Information’.\n```\nJJg¬ísr\nPacket.AdvancedInformationPacketqB®IandroidSdkIbatteryHealthIbatteryLevelIbatteryPlug\nsimSerialq~LsoftwareVersionq~LwifiExtraInfosq~LwifiReasonq~xp$d't000000000000000t7.0t\n AccelerometertGenymotion LighttGenymotion PressuretGenymotion ProximitytGenymotion\nHumiditytGenymotion\nTemperaturextust310270tAndroidt8931027000000000007t00t\"WiredSSID\"p\n\n```\n**_Figure 17. Raw answer as ASCII text sent from the phone to the C&C command ‘Advanced_**\nInformation’. The packet data and its structure is shown. It is not easy to find the field\nseparators.\n\nThe summary of the structure of the packets sent from the phone is:\n\n\n-----\n\n**_Figure 18. The structure of the packet sent from the phone._**\n\n## Example of C&C commands and Phone Answers\n\nThe first command sent by the C&C is ‘Toast hello’. Figure 19 shows the packet data of the\ncommand and its structure.\n\n**_Figure 19. Packet data and structure for the C&C command ‘Toast’ with the argument_**\n‘hello’.\n\nThe C&C command sent has the value 00 6d in hexadecimal or 109 in decimal\nrepresentation. We can confirm that this mapping responds to the command ‘Toast’ (Figure\n20). It is important to notice that the C&C command is mapped to the single character, but\nits argument ‘hello’ (68 65 6c 6c 6f) is not mapped to anything.\n\n**_Figure 20. The mapping of the C&C command ‘Toast’. The value of this command is 109_**\nwhich is 00 6d in hexadecimal.\n\n‘Toast hello’ was successfully performed on the phone. The phone in return did not send\nany confirmation of the successful operation. Only for the C&C commands that require the\nphone to send information (e.g. file, call, sms), the phone sends the packet with the\nconfirmation of receiving the command. Afterwards, it sends the required data.\n\nAs an example, we took the C&C command ‘Directory List’. The communication gos as\nfollows:\n\n1. The C&C sends the command ‘Directory List’ with the directory as an argument.\n\n(Figure 21)\n\n\n-----\n\n2. The phone sends the confirmation of the command being received. (Figure 22)\n\n3. The phone send the required data, i.e. file list in the directory. (Figure 23)\n\n**_Figure 21. The packet data and its structure of the C&C command ‘Directory List’. The_**\ncommand aims to get the list of files in the specified directory (in our case directory ‘/’).\n\n**_Figure 22. The phone sends the confirmation about the received command ‘Directory List’._**\nThe packet data and its structure is shown.\n```\n3ñ¬ísrjava.util.ArrayListxÒÇaIsizexpwsrutils.MyFileëÀÞ¹÷ÓZhiddenZisDirZisFileJ\nlastModifJlengthZrZwLlisttLjava/util/ArrayList;LnametLjava/lang/String;Lpathq~xptxyÈs\nRingtonest/storage/emulated/0/Ringtonessq~txrlØsq~wxtAlarmst/storage/emulated/0/Alarm\n sq~wsq~t/7/à?*ßsq~wxt$open_gapps-x86-7.0-pico20200606.ziptA/storage/emulated/0/Download/open_gapps-x86-7.0-pico20200606.zipsq~txx®hIsq~wxtopen_gapps_log.txtt//storage/emulated/0/Download/open_gapp\ný¨xKÎsq~w\n\n```\n**_Figure 23. The phones send the list of files in a specified directory from the C&C command_**\n‘Directory List’.\n\n## Long Connections\n\nIf we use the Wireshark tool to analyze all the traffic, we can open the menu\n“Conversations”, then “Statistics”, then “TCP”. There were several connections between\nthe C&C (147.32.83.234) and the phone (10.8.0.37) as shown in Figure 24. The longest\n\n\n-----\n\nconnection established between the C&C and the phone is 2611.3454 seconds long\n(approximately 44 minutes). This indicates that the connections between the phone and the\ncontroller are kept for a long period of time in order to answer fast.\n\n**_Figure 24. All the connections in the traffic between the phone and the C&C._**\n\nFigure 25 displays all the TCP connections in the phone sorted by the highest connection\nduration. It is important to notice that there are even longer normal connections with\ndurations of 3576.9112 seconds (approximately 57 minutes). This is the connection from\nthe phone during normal operation to the IP address 157.240.30.11 which belongs to\nFacebook services.\n\n**_Figure 25. Top connections from the phone from Wireshark -> Statistics -> Conversations -_**\n\n- TCP.\n\n## Conclusion\n\nIn this blog we have analyzed the network traffic from a phone infected with AndroRAT. We\nwere able to decode its connection. The androRAT does not seem to be complex in its\ncommunication protocol and it is not sophisticated in its work.\n\nTo summarize, the details found in the network traffic of this RAT are:\n\nThe phone connects directly to the IP address and ports specified in APK (default port\nand custom port).\n\n\n-----\n\nThere is only one long connection, i.e. more than 40 minutes, between the phone and\nthe controller over the port 1337/TCP.\n\nThere is no heartbeat between the controller and the phone.\n\nThe data is sent in the plain text.\n\nThe C&C uses mapping to present the C&C command as a single character.\n\nPackets sent from the phone have a structure of {byteTotalLength}\n**{byteLocalLength}{byteMoreF}{bytePointeurData}{byteChannel}{data}**\n\nPackets sent from the C&C have a structure of {byteTotalLength}{byteLocalLength}\n**{byteMoreF}{bytePointeurData}{byteChannel}{C&C command}{targetChannel}**\n**{arguments}.**\n\n## Biographies\n\nKAMILA BABAYEVA\n\nSebastian Garcia is a malware researcher and security teacher with experience in applied\nmachine learning on network traffic. He founded the Stratosphere Lab, aiming to do\nimpactful security research to help others using machine learning. He believes that free\nsoftware and machine learning tools can help better protect users from abuse of our digital\nrights. He researches on machine learning for security, honeypots, malware traffic\ndetection, social networks security detection, distributed scanning (dnmap), keystroke\ndynamics, fake news, Bluetooth analysis, privacy protection, intruder detection, and\nmicrophone detection with SDR (Salamandra). He co-founded the MatesLab hackspace in\nArgentina and co-founded the Independent Fund for Women in Tech. @eldracote.\nhttps://www.researchgate.net/profile/Sebastian_Garcia6\n\n\n-----\n\nKamila Babayeva is a 20 years old and third-year bachelor student in the Computer\nScience and Electrical Engineering program at the Czech Technical University in Prague.\nShe is a researcher in the Civilsphere project, a project dedicated to protecting civil\norganizations and individuals from targeted attacks. Her research focuses on helping\npeople and protecting their digital rights by developing free software based on machine\nlearning. Initially, she worked as a junior Malware Reverser. Currently, Kamila leads the\ndevelopment of the Stratosphere Linux Intrusion Prevent System (Slips), which is used to\nprotect the civil society in the Civilsphere lab.\n\nSEBASTIAN GARCIA\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-31 - Dissecting a RAT. Analysis of the AndroRAT.pdf"
    ],
    "report_names": [
        "2021-03-31 - Dissecting a RAT. Analysis of the AndroRAT.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535840,
    "ts_updated_at": 1743041163,
    "ts_creation_date": 1653701035,
    "ts_modification_date": 1653701035,
    "files": {
        "pdf": "https://archive.orkl.eu/938bf3b5410b3becba259b41023b39b7817adfec.pdf",
        "text": "https://archive.orkl.eu/938bf3b5410b3becba259b41023b39b7817adfec.txt",
        "img": "https://archive.orkl.eu/938bf3b5410b3becba259b41023b39b7817adfec.jpg"
    }
}