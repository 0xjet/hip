{
    "id": "88fbc98c-6adc-48b8-badd-1f09e9d6ecba",
    "created_at": "2023-01-12T15:10:29.875629Z",
    "updated_at": "2025-03-27T02:09:18.278438Z",
    "deleted_at": null,
    "sha1_hash": "62219e633f9ca1503be2c1a7b7c23a2bbd1eec25",
    "title": "2020-10-22 - An Inside Look at How Ryuk Evolved Its Encryption and Evasion Techniques",
    "authors": "",
    "file_creation_date": "2022-05-28T00:39:39Z",
    "file_modification_date": "2022-05-28T00:39:39Z",
    "file_size": 4165812,
    "plain_text": "# An Inside Look at How Ryuk Evolved Its Encryption and Evasion Techniques\n\n**[labs.sentinelone.com/an-inside-look-at-how-ryuk-evolved-its-encryption-and-evasion-techniques/](https://labs.sentinelone.com/an-inside-look-at-how-ryuk-evolved-its-encryption-and-evasion-techniques/)**\n\nMarco Figueroa\n\n## Introduction\n\n[In the last three months, there has been a 50% uptick in ransomware, with the Ryuk](https://blog.checkpoint.com/2020/10/06/study-global-rise-in-ransomware-attacks/)\nransomware garnering the most attention after a string of high profile attacks that have been\n[crippling companies. Last month it was reported that Ryuk hit UHS hospital networks with](https://www.bleepingcomputer.com/news/security/uhs-hospitals-hit-by-reported-country-wide-ryuk-ransomware-attack/)\nforce, spreading across UHS healthcare facilities in the US from coast to coast. This wellorchestrated attack left many hospital workers without access to labs, radiology, and patient\nrecords, which led to workers having to resort to pen and paper to triage patients. Ryuk is\ncurrently attacking approximately 20 organizations a week, and this number will only expand\ndue to its successes.\n\nThere are a number of factors that contribute to this success. These include its harnessing of\nother “toolkits” such as TrickBot and Emotet, and being quick to jump on newly-exposed\nvulnerabilities such as Zerologon. We also see that Ryuk has iterated since its earlier\nincarnations to evade detection and markedly improve the time it takes from execution to full\nencryption, making life increasingly difficult for organizations that cannot respond to threats\nat such speed.\n\n\n-----\n\nIn this post, we look at how Ryuk has evolved since 2018 and explore the improvements in\nencryption speed and evasion techniques that we see in Ryuk samples today. Along the way,\nwe detail a method analysts can use to extract the Ryuk executable from memory and dump\nit to file for further inspection.\n\n## Ryuk Overview\n\nWhen [Ryuk ransomware burst onto the scene, it was initially believed that it was developed](https://www.sentinelone.com/cybersecurity-101/ryuk-ransomware/)\nby the same threat actors who developed Hermes Ransomware. However, it was later\ndiscovered that Hermes was being sold on the black market, allowing cybercriminals to\npurchase the framework and convert it to what is known today as Ryuk.\n\n[The current waves of attacks have been known to use a combination of Emotet,](https://www.sentinelone.com/blog/inside-emotet-banking-trojan-malware-distributor/) [Trickbot,](https://www.sentinelone.com/wp-content/uploads/inside-a-trickbot-cobaltstrike-attack-server/)\nand Ryuk. In recent weeks, the actors behind Ryuk have even been observed using\n[ZeroLogon to extend their reach and broaden the delivery of their ransomware payloads.](https://www.sentinelone.com/blog/zerologon-cve-2020-1472-sentinelone-first-to-detect-on-the-endpoint/)\nWhile the Ryuk payloads do not specifically contain the ZeroLogon functionality, the flaw is\nbeing leveraged at earlier stages in the attack chain. Attackers are able to use existing\n[capabilities in Cobalt Strike and similar frameworks to achieve the privilege escalation. It is](https://www.sentinelone.com/wp-content/uploads/inside-a-trickbot-cobaltstrike-attack-server/)\nquickly becoming clear that ZeroLogon will become a staple in the attackers’ collective\n“toolbelt”.\n\n## Reversing and Comparing Ryuk 2018 and 2020\n\n[There are many tools in the reversing ecosystem for diffing binaries like Bindiff, but a fast tool](https://www.zynamics.com/bindiff.html)\nwhen comparing binaries I find most useful is Ghidra’s version tracking to check for\ncomparisons between binary files.\n\nIf we compare an earlier version of Ryuk with the latest version, we can note some\ninteresting changes. In the most recent version, Ryuk obfuscates its hardcoded strings to\nbecome more difficult for AV vendors to detect:\n\n\n-----\n\nFigure 1: Ryuk 2018 vs 2020\nRyuk 2020 also copies itself to increase the speed of encryption, which we discuss in detail\nbelow.\n\nThe ransomware uses RSA and AES to encrypt files with extension `.ryk, creating a new`\nthread for each file it encrypts. Ryuk also uses the `CryptGenRandom API, which fills the`\nbuffer with random bytes to generate a data encryption key.\n\n\n-----\n\nFigure 2: Random Generation of Bytes\nSince this API has been deprecated, I would expect the actors to change this in a future\nversion of the ransomware, perhaps to the newer Cryptography API: Next Generation\n(CNG), which provides a new API `BCryptGenRandom to achieve the same result.`\n\nA significant difference between the earlier Ryuk binary and our recent sample is the time it\ntakes to fully encrypt the local disk. The 2018 binary takes close to one hour to encrypt the\nlocal disk, while the 2020 version takes less than 10 minutes.\n\nFigure 3: 2018 Ryuk 2018 Slower Encryption\n\n\n-----\n\nThe increased encryption speed of the newer Ryuk variant places an extra burden on\nenterprise security efforts. The reaction time to detect, mitigate, and eradicate Ryuk before\nmajor damage is done is significantly limited, and many organizations have been unable to\n[contain the ransomware in time. This occurred in UHS networks and required hospital](https://www.forbes.com/sites/tommybeer/2020/09/28/report-big-us-hospital-system-struck-by-cyberattack-forcing-staff-to-resort-to-paper-and-pen/#7e38638456b6)\n[staffers to shut down computer systems immediately to prevent further machines becoming](https://www.forbes.com/sites/tommybeer/2020/09/28/report-big-us-hospital-system-struck-by-cyberattack-forcing-staff-to-resort-to-paper-and-pen/#75b0251656b6)\ninfected by Ryuk.\n\n## Diving Deeper into Ryuk 2020\n\nThis particular Ryuk sample\n(f8bc1638ec3b04412f708233e8586e1d91f18f6715d68cba1a491d4a7f457da0) has a signed\ndigital certificate which was explicitly revoked by its issuer.\n\nSerial Number: 0a 1d c9 9e 4d 52 64 c4 5a 50 90 f9 32 42 a3 0a\nSubject: CN = K & D KOMPANI d.o.o\n\n\n-----\n\nFigure\n\n4: 2020 Ryuk Revoked Certificate\nWhen Ryuk begins executing, it duplicates itself and dumps this copy into the same directory\nwith a randomly generated 8 character name. However, the file name always ends with “…\nlan.exe”. These duplicate files help to start multiple threads. Ryuk utilizes a list of hardcoded\nstrings to search for and stop specific running processes (Figure 1). It then tries to inject itself\ninto additional processes.\n\n\n-----\n\nFigure 5: Droppers\nRyuk next begins executing certain command line tools to achieve some of its devastating\neffects; in particular, it tries to prevent user recovery by attempting to delete the Volume\nShadow copies by leveraging `cmd.exe /c 'WMIC.exe shadowcopy delete' . This is`\nfollowed with a `cmd.exe /c 'vssadmin.exe Shadows /all /quiet” and` `cmd.exe /c`\n```\n'bcdedit /set {default} recoveryenabled No & bcdedit /set {default}' .\n\n```\nFigure 6:\n\nServices that are not stopped\nAn `icacls.exe is created in the Windows WoW directory, which gives the group Everyone`\nfull permissions to the drives on the system so that Ryuk has everything it needs to encrypt\nall drives.\n\nFigure 7a: grant permissions\n\nFigure 7b: icacls permissions granted\n\n## Extracting the Executable from Memory\n\n\n-----\n\nTo avoid detection, the malware uses various evasion techniques like self injection. Ryuk\nuses this technique by allocating memory in which it writes a PE file. After this, it calls\n```\nVirtualProtect to change the execution permissions on the section.\n\n```\nA fast way to extract the executable from memory is to run the binary in a debugger and set\na breakpoint at the location of the allocated memory. For this, I use x32dbg, and set a\nbreakpoint on `VirtualAlloc . A thing to note is that when setting a breakpoint for`\nVirtualAlloc you should follow the jmp routine into `Kernelbase to get the base address of`\nthe newly allocated region and set the breakpoint on the return. Once the debugger has run,\nthe breakpoint will hit. Follow the EAX register to the memory dump section to view if the\n```\nMZ magic is present.\n\n```\nFigure 8: Dumping the Binary\n\n\n-----\n\nWhen the process is run, it will hit the breakpoint `VirtualAlloc and in the EAX is the`\nnewly allocated virtual memory section to begin loading a copy of itself into this section.\nFollowing the EAX to the memory dump shows that the memory has been allocated for\nloading. When continuing the process, the dump window begins to populate with data as it\nhits the breakpoint that is set several times. Once it is confirmed that the binary has been\nfully loaded into this section, the binary data can be dumped for inspection.\n\n\n-----\n\nFigure 9: Dump Memory To File\n\n\n-----\n\nThe next step is to right-click on the memory dump and follow the dump in the memory map.\nThis brings you to where the dump has been allocated in memory, and from here you can\ndump the memory to file. However, as shown in Figure 9, notice that the dumped memory\ndoes not have a valid PE header; we have to modify the header so the PE (Figure 10) can\nwork in the tool of your choice.\n\nFigure 10: Fix the Headers\nThis particular binary is straightforward to modify. Open up your favorite Hex editor, load the\nfile, highlight everything before the `MZ and delete it. Sometimes, just deleting extra bytes`\nwill not work if a blob of memory has corrupted magic bytes. In that scenario, you can copy a\nknown good header and add it to the corrupted PE header to make a valid PE.\n\n\n-----\n\nFigure 11: Three Memory Dump Files\nIf you follow the process from the beginning, the breakpoint will hit `VirtualAlloc`\nadditional times. I’ve dumped the memory with the techniques shown above to show why\nRyuk’s encryption on a system is so fast:\n\n\n-----\n\nFigure 12:\n\nSpeed of Ryuk 2020\n\n## Conclusion\n\n[The FBI has stated that Ryuk Ransomware actors have been paid over 61 million dollars.](https://www.youtube.com/watch?v=LUxOcpIRxmg&feature=emb_title)\nWith Ryuk attacks crippling organizations, this number will soon surpass the 100 million mark\nif it hasn’t done so already.\n\nHowever, guarding against the ransomware menace in general and Ryuk in particular is not\n[complicated with the proper protection in place: The techniques used by these](https://www.sentinelone.com/platform/)\ncybercriminals are well-understood and relatively simple. The weaknesses they exploit are\n[organizations’ inability to detect and remediate at speed, but this is a problem that can be](https://www.sentinelone.com/blog/endpoint-security-winning-the-war-against-time/)\n[and has been solved.](https://www.sentinelone.com/blog/behavioral-ai-an-unbounded-approach-to-protecting-the-enterprise/)\n\n\n-----\n\nMeanwhile, as analysts, it s important that we keep up with the latest developments and\ntechniques deployed by adversaries. At SentinelOne, we track the ever-changing variants of\nRyuk to understand the latest capabilities added to this ransomware family. In this post, we\nhave detailed how Ryuk has evolved to increase its speed of encryption and the methods it\nuses for evasion. In a future post, we will cover Ryuk’s network layer and the many artifacts\ncollected during our analysis process.\n\n**Samples**\n\nSHA256: f8bc1638ec3b04412f708233e8586e1d91f18f6715d68cba1a491d4a7f457da0\n\nSHA1: c3fa91438850c88c81c0712204a273e382d8fa7b\n\nSHA256: 7e28426e89e79e20a6d9b1913ca323f112868e597fcaf6b9e073102e73407b47\n\nSHA1: 5767653494d05b3f3f38f1662a63335d09ae6489\n\n**MITRE ATT&CK**\n\n[Command and Scripting Interpreter T1059](https://attack.mitre.org/techniques/T1059/)\n\nNative API [T1106](https://attack.mitre.org/techniques/T1106/)\n\n[Application Shimming T1546.011](https://attack.mitre.org/techniques/T1546/011/)\n\n[Process Injection T1055](https://attack.mitre.org/techniques/T1055/)\n\n[Masquerading T1036](https://attack.mitre.org/techniques/T1036/)\n\n[Virtualization/Sandbox Evasion T1497.001](https://attack.mitre.org/techniques/T1497/001/)\n\n[Deobfuscate/ Decode Files T1140](https://attack.mitre.org/techniques/T1140/)\n\n[Obfuscated Files or Information T1027](https://attack.mitre.org/techniques/T1027/)\n\n[System Time Discovery T1124](https://attack.mitre.org/techniques/T1124/)\n\n[Security Software Discovery T1518.001](https://attack.mitre.org/techniques/T1518/001/)\n\n[Process Discovery T1057](https://attack.mitre.org/techniques/T1057/)\n\n[File and Directory Discovery T1083](https://attack.mitre.org/techniques/T1083/)\n\n[System Information Discovery T1082](https://attack.mitre.org/techniques/T1082/)\n\n[Archive Collected Data T1560](https://attack.mitre.org/techniques/T1560/)\n\n[Encrypted Channel T1573](https://attack.mitre.org/techniques/T1573/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-10-22 - An Inside Look at How Ryuk Evolved Its Encryption and Evasion Techniques.pdf"
    ],
    "report_names": [
        "2020-10-22 - An Inside Look at How Ryuk Evolved Its Encryption and Evasion Techniques.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536229,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653698379,
    "ts_modification_date": 1653698379,
    "files": {
        "pdf": "https://archive.orkl.eu/62219e633f9ca1503be2c1a7b7c23a2bbd1eec25.pdf",
        "text": "https://archive.orkl.eu/62219e633f9ca1503be2c1a7b7c23a2bbd1eec25.txt",
        "img": "https://archive.orkl.eu/62219e633f9ca1503be2c1a7b7c23a2bbd1eec25.jpg"
    }
}