{
    "id": "e783ff5e-5753-4def-8728-0e565a526858",
    "created_at": "2022-10-25T16:48:16.207049Z",
    "updated_at": "2025-03-27T02:09:29.31286Z",
    "deleted_at": null,
    "sha1_hash": "02c222792c65765833e9bb8d77453ba1912e416e",
    "title": "The State of SSL/TLS Certificate Usage in Malware C&C Communications",
    "authors": "",
    "file_creation_date": "2021-09-03T22:12:23Z",
    "file_modification_date": "2021-09-03T22:12:23Z",
    "file_size": 664782,
    "plain_text": "# The State of SSL/TLS Certificate Usage in Malware C&C Communications\n## Mohamad Mokbel\n\n\n-----\n\n**Introduction**\n\nThe nature of malware communications with its C&C server(s) has advanced over time, from using plain\nnon-encrypted channels to using custom and standard symmetric (such as Blowfish, TEA, RC4, AES,\nDES, 3DES, XOR, ChaCha20, Salsa20) and asymmetric (such as RSA, DSA, ECC, DH) encryption\nalgorithms and protocols (SSL/TLS) to hinder network inspection of such malicious traffic. Depending on\nthe specifics of how a malicious encrypted channel is constructed, the engineering of detection rules\nchanges accordingly, and requires different insight and capabilities.\n\nOf particular interest is malware’s increased adoption of secure HTTP (HTTPS) protocol comparted to\nunencrypted HTTP. This is no surprise as according to the [Google Transparency Report, HTTPS](https://transparencyreport.google.com/https/overview?hl=en)\nadoption increased dramatically between 2014 and 2021, reaching more than 90% in certain countries.\nAs more legacy systems and older services are phased out, newer systems and services will have the\nnecessary modern encryption and protocols to support the latest versions of SSL/TLS.\n\nOver the last six years there has been an increased shift by malware authors to secure their C&C\ncommunications using the SSL/TLS protocol to stymie detection and blend in with normal traffic. This shift\nis noticeable in commodity malware, as well as in APT type attacks. This is also seen in red teaming\ntabletop exercises to test the capabilities of different detection security layers, using frameworks such as\nCobalt Strike, Metasploit and Core Impact, among others.\n\nWhile a given malware variant uses HTTPS, other variants of the same family could be using HTTP,\ndepending on the malware’s configuration options. Therefore, detection rules must account for both\nscenarios whenever possible. Moreover, the adoption of SSL/TLS in malware is not restricted to the\nHTTPS protocol; other protocols, including SMTP and custom TCP protocols, were also found using\nSSL/TLS.\n\nWithout going into too much detail on how the SSL/TLS protocol works, it suffices for the purpose of this\narticle that during the SSL/TLS handshake process, the server sends the client a digital/identity certificate\n(with the public key) for the client to use for encrypting the pre-master key, which the server receives and\ndecrypts using its respective private key. It is the digital certificate that certifies and cryptographically\nauthenticates ownership of the public key by a given entity/server. For the certificate to be valid, it must\nbe issued and signed by a trusted third-party certificate authority (CA), as opposed to a self-signed\ncertificate (excluding trusted root certificates). Such certificate is of leaf/end-entity type, meaning, it\ncannot be used to sign other certificates.\n\nThe public key infrastructure [X.509](https://datatracker.ietf.org/doc/html/rfc5280) is the standard that defines the format of the public key certificates,\nwhich includes attributes such as:\n\n\n-----\n\n```\nCertificate:\n    signedCertificate\n      version:\n      serialNumber: \n      signature (sha256WithRSAEncryption)\n        Algorithm Id:\n      issuer: rdnSequence (0)\n      validity\n        notBefore: utcTime (0)\n        notAfter: utcTime (0)\n      subject: rdnSequence (0)\n      subjectPublicKeyInfo\n        algorithm (rsaEncryption)\n        subjectPublicKey:\n          modulus:\n          publicExponent:\n      extensions (optional):\n\n```\n\n\n### • version\n\n ▪ The certificate version number (v1(0x00), v2(0x01) or v3(0x02))\n • serialNumber\n\n ▪ A unique identifier for every certificate issued by the same CA. A non-negative integer\n • signature\n\n ▪ The algorithm used to sign the certificate (ex., sha256WithRSAEncryption)\n • issuer\n\n ▪ The name of the CA that issued the certificate using LDAP format\n • validity (notBefore/From)\n\n ▪ The certificate validation starting date and time\n • validity (notAfter/To)\n\n ▪ The certificate validation ending date and time\n • subject\n\n ▪ The name of the entity the CA issued it to using the LDAP format\n • subjectPublicKeyInfo\n\n ▪ RSA or ECC (different key sizes)\n ▪ Public key\n ▪ Exponent/parameters\n • extensions\n\n ▪ Depending on the version of the certificate, and in particular version 3(0x02), the certificate might include optional extensions such as CRL Distribution Points (CDP), Authority Information Access (AIA), Enhanced Key Usage (EKU) and Certificate Policies, among others\n\nThe certificate thumbprint, also known as fingerprint, is a cryptographic hash of the entire certificate,\nincluding the signature part. However, it is not part of the actual certificate attributes.\n\n\n-----\n\nIn this technical brief, we’ll feature various malware families that communicate with their C&C server(s)\nover SSL/TLS, from the standpoint of the various attributes in the certificate. Additionally, we’ll highlight\ncertain interesting observations in the metadata of those attributes, over the lifetime of a given malware\nfamily. Moreover, whenever possible, detection techniques will be presented to recognize some of those\n“malicious” certificates on the network. Detecting malware C&C communications at the certificate level is\na crucial step for stopping malware from communicating with its C&C server(s) at the earliest point. This\nis even more important in the absence of SSL/TLS man-in-the-middle proxy-based decryption, or if the\noriginal plain non- SSL/TLS encrypted traffic is not filterable.\n\nIt is important to note that in version 1.3 of the TLS protocol, all traffic after the server Hello message is\nencrypted, including the certificate. This poses a serious challenge for any inline fingerprinting of the\ncertificate; however, this could be solved by proactively querying the server for the certificate for further\ninspection.\n\nLike OpenSSL that could generate and parse certificates, Wireshark, the famous network protocol\nanalyzer, has a full-featured dissector for the certificate that could be exported from the packet capture to\na binary file, as DER encoded, under any of the file extensions, .der, .cer, and .crt.\n\nFigure 1 shows TLSv1 packet dissection by Wireshark. Note frame No. 17, which contains the actual\ncertificate received from the server, handshake type, certificate (0x11).\n\n### Figure 1. TLSv1 Handshake\n\nFigure 2 shows Wireshark’s dissection of the domain “example.com” trusted certificate. This makes it very\neasy to browse all the certificates’ items in a structured and hierarchical manner. Moreover, the hex dump\nwindow (not shown) alongside the TLS certificate protocol dissection window provides the perfect\ncombination for identifying key bytes from the certificate, for crafting a detection logic.\n\n\n-----\n\n```\nTLSv1 Record Layer: Handshake Protocol: Certificate\n Content Type: Handshake (22)\n Version: TLS 1.0 (0x0301)\n Length: 3978\n Handshake Protocol: Certificate\n  Handshake Type: Certificate (11)\n  Length: 3974\n  Certificates Length: 3971\n  Certificates (3971 bytes)\n   Certificate Length: 1753\n   [...]\n    signedCertificate\n     version: v3 (2)\n     serialNumber: 0x0fbe08b0854d05738ab0cce1c9afeec9\n     signature (sha256WithRSAEncryption)\n       Algorithm Id: 1.2.840.113549.1.1.11 (sha256WithRSAEncryption)\n     issuer: rdnSequence (0)\n         RDNSequence item: 1 item (id-at-countryName=US)\n         RDNSequence item: 1 item (id-at-organizationName=DigiCert Inc)\n         RDNSequence item: 1 item (id-at-commonName=DigiCert TLS RSA SHA256 2020 CA1)\n     validity\n       notBefore: utcTime (0)\n         utcTime: 2020-11-24 00:00:00 (UTC)\n       notAfter: utcTime (0)\n         utcTime: 2021-12-25 23:59:59 (UTC)\n     subject: rdnSequence (0)\n         RDNSequence item: 1 item (id-at-countryName=US)\n         RDNSequence item: 1 item (id-at-stateOrProvinceName=California)\n         RDNSequence item: 1 item (id-at-localityName=Los Angeles)\n         RDNSequence item: 1 item (id-at-organizationName=Internet Corporation for Assigned Names)\n         RDNSequence item: 1 item (id-at-commonName=www.example.org)\n     subjectPublicKeyInfo\n       algorithm (rsaEncryption)\n         Algorithm Id: 1.2.840.113549.1.1.1 (rsaEncryption)\n       subjectPublicKey: 3082010a0282010100bafceeccca0a08ff0e931db3be0b9c0396229eb14f10ae5140fd53…\n         modulus: 0x00bafceeccca0a08ff0e931db3be0b9c0396229eb14f10ae5140fd535fb3c461402804ee…\n         publicExponent: 65537\n     extensions: 10 items\n   algorithmIdentifier (sha256WithRSAEncryption)\n     Algorithm Id: 1.2.840.113549.1.1.11 (sha256WithRSAEncryption)\n   Padding: 0\n   encrypted: a72a10305cb86b7a1bf86638f6e9a00ad5138282f8658957a5b8eb13291d846cecfbe305…\n\n```\n\n_Figure 2. Wireshark Dissection of example.com certificate_\n\n\n-----\n\n**Analysis**\n\nIn this section, we’ll go through various malware families that use the SSL/TLS protocol with the goal of\nuncovering some interesting characteristics of different attributes in the certificates and self-signed\ncertificates.\n\nWe start off by presenting Table 1, which shows the percentage of different protocols used by malware\nthat communicate over SSL/TLS. These were found between May 2019 and June 2021, for a total of 264\nunique malware families (categories: backdoor, worm, Stealer, ransomware, and downloader). Each one\nof these malware families is fully reverse engineered, and an IPS/IDS signature/filter was written for\ndetecting the decrypted traffic. Moreover, this is only a subset of filters written for such malware.\n\nNote that this only accounts for malware with filterable traffic and does not imply that only 264 malware\nfamilies communicate over SSL/TLS were seen in-the-wild between those dates.\n\n**ip.tcp** **ip.tcp.http** **ip.tcp.smtp**\n**Total** 8 (3%) 177 (67%) 79 (~30%)\n\n### Table 1. A set of unique malware families that communicate over SSL/TLS\n across different underlying protocols\n\n • ip.tcp indicates a custom protocol on top of TCP\n • ip.tcp.http indicates malware communicating over the HTTP protocol to the attacker’s own HTTP server, or to other popular and legitimate services that use the HTTP protocol using their respective REST API, such as Discord, Telegram, Slack, Pastebin, and GitHub \n • ip.tcp.smtp indicates malware that exfiltrate data over the SMTP protocol to any of the email services, such as gmail.com, mail.ru, outlook.com, and yandex.com. Gmail is the most widely used for exfiltrating data\n\nIt is no surprise that most of the C&C communications use the HTTP protocol since it blends perfectly\nwith legitimate traffic.\n\nTable 2 breaks down the same list of malware, per the platform it targets and the type. Windows is the\ntargeted platform, with various programming languages.\n\n**Windows** **Linux** **Cross-platform** **Other**\nType Total Type Total Type Total JS (Browser\n\nMSIL (.NET) `191` ELF `5` Python `4` Skimmer): 1\nPowerShell `6` Shell `5`\nWin32\n`27` **Sum** 10\n(C/C++/Delphi)\n\nWin64\n```\n                   14\n```\n(C/C++/Delphi)\n\nVisual Basic for\n```\n                    1\n```\nApplications (VBA)\n\nVBScript (VBS) `2`\nJavaScript (JS) `4`\nPython `4`\n\n249\n**Sum**\n(94.3%)\n### Table 2. Target platforms of malware that use SSL/TLS\n\n|Windows|Col2|Linux|Col4|Cross-platform|Col6|Other|\n|---|---|---|---|---|---|---|\n|Type|Total|Type|Total|Type|Total|JS (Browser Skimmer): 1|\n|MSIL (.NET)|191|ELF|5|Python|4||\n|PowerShell|6|Shell|5||||\n|Win32 (C/C++/Delphi)|27|Sum|10||||\n|Win64 (C/C++/Delphi)|14||||||\n|Visual Basic for Applications (VBA)|1||||||\n|VBScript (VBS)|2||||||\n|JavaScript (JS)|4||||||\n|Python|4||||||\n|Sum|249 (94.3%)||||||\n\n\n-----\n\nFor a TLS certificate to be valid and trusted, it must be issued by a trusted CA, such as Sectigo SSL,\nDigiCert SSL, Symantec SSL, RapidSSL, GeoTrust SSL, Thawte SSL, ZeroSSL or Let’s Encrypt. While\nall recognized CAs charge a fee to acquire a legitimate certificate, Let’s Encrypt, a non-profit CA, and\nZeroSSL, do it for free, in an automated fashion, with no major oversight on the entity requesting it, with\nthe caveat that the certificate is only valid for 90 days. Therefore, the certificate needs to be renewed after\n90 days for it to be valid.\n\n[The SSL Blacklist](https://sslbl.abuse.ch/) (SSLBL) is a project of abuse.ch that aims to detect malicious TLS certificates used by\nbotnet C&C servers. It tracks close to 100 malware families, but it doesn’t provide the actual certificate\nnor enough metadata to uncover certain patterns that might emerge after juxtaposing it with different\nfields from different CAs. To get the actual certificate, we created a tool that queries [Censys](https://search.censys.io/) [and crt.sh](https://crt.sh/)\ncertificate search engines and aggregate all data in one CSV file. The results show some interesting\npatterns that are worthy of documentation.\n\nAs of June 29, 2021, only 1,767 out of 4,093 certificates are available on those search engines. Malware\nfamilies include BitRAT, ServHelper, Cobalt Strike, AsyncRAT, Gozi, BitRAT, AceRAT, Trickbot, IcedID,\nUpatre, Vawtrak, Zeus, OrcusRAT, Zeus and NanoCore, among others.\n\nThe following are some observations:\n\n### ▪ 1,067 (~60.4%) of 1,767 are self-signed certificates\n\n a. Only 96 (~5.4%) of 1,067 are based on version 1 of the x.509 certificate\n i. The majority of them having the Common Name (CN) set to “localhost”, and\n Organization set to either “MyCompany Ltd.” or “Internet Widgits Pty Ltd”. ii. Malware families that use this version include Zeus, Gootkit, Shifu, Quakbot,\n and others, dating back to 2015-2017. For 2020, only ZLoader and a variant of Dridex use this version.\n b. 982 (92%) of 1,067 are based on version 3 of the x.509 certificate.\n i. Some malware families that use this version include TorrentLocker, IcedID, Gozi,\n Dridex, PandaZeuS, TrickBot, AsyncRAT, Malware, Vawtrak, CobaltStrike, FindPOS, Gootkit, Qadars, BuerLoader, BitRAT, OrcusRAT, Chthonic, BazaLoader, ZLoader, Ostap, Quakbot, QuasarRAT, RockLoader, ZeuS, NanoCore, GuLoader and Adwind.\n\nWhat stands out from those self-signed certificates is the possibility to detect such malicious traffic due to\nthe use of unique identifying values in the Subject field. For example, in the case of AsyncRAT, and in\nmost of the variants, the Subject Common Name is set to “AsyncRAT Server” or “AsyncRAT Server CA”.\nIn the case of BitRAT, the Subject Common Name is set to “BitRAT”.\n\nTable 3 shows the certificate Subject Distinguished Name (DN) field values in LDAP format for different\nmalware families. Such field includes identifying Relative Distinguished Names (RDNs) of the owner of\nthe certificate, such as Country Name (C), certificate owner’s Common Name (CN), Organization (O),\nOrganization Unit (OU), Locality (L), and State/Province (ST), among others.\n\n\n-----\n\n            - CN=Anony96\nQuasarRAT\n\n            - CN=Quasar Server CA\nNanoCore    - CN=unk\nDcRAT    - CN=DcRat Server\n### Table 3. Certificate Subject RDNs for different malware families\n\nNote that for the Subject, the values \"C=AU, ST=Some-State, O=Internet Widgits Pty Ltd\" and \"C=XX,\nL=Default City, O=Default Company Ltd\" are the default values used when generating a self-signed\ncertificate with OpenSSL. As shown, it is unsurprising that multiple malware families share the same\nvalues, albeit with slight variations on the Country (C) field value.\n\nThe validity period of those certificates varies, from as little as one month up to a year (the most common,\nwhich is the default setting in OpenSSL), five years, 10 years, to as high as 99 years. Of interest is the\ncertificate (SHA256-fingerprint:\n76dae43fa4216639e9f5706affc255306528397b02f02915c6782902d1d34d40) used by FindPOS malware,\nwhich has the validity period in the negative, from “2015-11-19 14:51” to “1979-09-19 9:23”, which means\nit’s already expired. OpenSSL does not accept negative values when generating certificates (it is possible\n\n|Malware Family|Subject (DN)|\n|---|---|\n|TorrentLocker|• C=US, ST=Denial, L=Springfield, O=Dis|\n|IcedID|• CN=localhost, C=AU, ST=Some-State, O=Internet Widgits Pty Ltd • C=XX, L=Default City, O=Default Company Ltd|\n|Gozi|• C=XX, ST=1, L=1, O=1, OU=1, CN=* • CN=localhost, C=AU, ST=Some-State, O=Internet Widgits Pty Ltd • C=AU, ST=Some-State, O=Internet Widgits Pty Ltd • C=XX, L=Default City, O=Default Company Ltd|\n|PandaZeus|• C=XX, L=Default City, O=Default Company Ltd • domain.com/O=My Company Name LTD./C=US • C=IT, ST=Some-State, O=Internet Widgits Pty Ltd|\n|Trickbot|• C=GB, ST=London, L=London, O=Global Security, OU=IT Department, CN=example.com • C=AU, ST=Some-State, O=Internet Widgits Pty Ltd • C=XX, L=Default City, O=Default Company Ltd • CN=localhost.localdomain • C=AU, ST=3t2t3rgeg, L=2ehsdgsdfxjh, O=3wrwsts, OU=wefwstwe645gfhuy, CN=fg2eq34df|\n|AsyncRAT|• CN=AsyncRAT Server|\n|Vawtrak|• C=xx, L=Default City, O=Default Company Ltd • C=ff, L=Default City, O=Default Company Ltd • C=ss, L=Default City, O=Default Company Ltd • C=aa, L=Default City, O=Default Company Ltd • C=zz, L=Default City, O=Default Company Ltd|\n|FindPOS|• C=XX, L=Default City, O=Default Company Ltd|\n|BuerLoader|• C=aa, ST=aa, L=a, O=Internet Widgits Pty Ltd • C=AU, ST=Some-State, O=Internet Widgits Pty Ltd • C=XX, ST=1, L=1, O=1, OU=1, CN=* • C=XX, ST=, O= • C=XX, L=Default City, O=Default Company Ltd • C=XX, ST=C, L=W, O=Internet Widgits Pty Ltd|\n|BitRAT|• CN=BitRAT|\n|OrcusRAT|• CN=Orcus Server • CN=OrcusServerCertificate|\n|Chthonic|• C=AU, ST=Some-State, O=Internet Widgits Pty Ltd • C=AU, ST=Some-State, O=Internet Widgits Pty Ltd • C=aa, L=Default City, O=Default Company Ltd|\n|QuasarRAT|• CN=Anony96 • CN=Quasar Server CA|\n|NanoCore|• CN=unk|\n|DcRAT|• CN=DcRat Server|\n\n\n-----\n\nthat older versions of OpenSSL might allow it). This is likely to have been altered at the binary level. A\ncertificate with such anomaly should be flagged and investigated.\n\nThe lifetime of some of those certificates could span more than five years, or the lifetime of the malware\nfamily itself. For example, in the case of Gozi, the Subject “C=XX, ST=1, L=1, O=1, OU=1, CN=*” has\nbeen in use since 2018 till 2021, with 100s of variants that use it. Additionally, most of Gozi’s certificates\nserial number length is 8 bytes, and only very few have it at 20 bytes, which is the default length for\nOpenSSL. Moreover, in all the cases, Gozi’s validity period is set to 10 years.\n\nIn the cases of AsyncRAT, BitRAT, OrcusRAT, QuasarRAT, the serial number length is fixed to 15 bytes,\nfor all variants. Most of the malware families have their certificates serial number of length 8 or 15 bytes,\nexcept for few such as IcedID that has it set to 4 bytes, Vawtrak to either 4 or 8 bytes and Ostap to 2\nbytes. Table 4 shows variants of the malware families Quakbot and Gozi that have the serial number\nlength of 1 byte.\n\n**Malware** **Certificate SHA-1 Fingerprint** **Serial**\n**Number**\n\n                 - 562e7f2f7b3d5913a6ca64f25854d131e56c4ff7                 - 0x00\nQuakbot\n\n                 - 101b0f5b4f4e336a2e9cc82b8e00d397f4939e6b                 - 0x01\n\nGozi         - 1d1b4f67f070df5cae8f39553978f0adb3abd0c0         - 0x00\n### Table 4. Malware with 1-byte length Serial Number\n\nBy comparison, there is no trusted certificate out of the 90k top WordPress sites that has a serial number\nlength less than 8 bytes.\n\nThe following two certificates of Zeus (as shown in the graph below) stand out due to the x.509 certificate\nversion used. It is set to 4, however there is no version 4 of the x.509 certificate. As shown in the graph\nbelow, OpenSSL highlights the version number as unknown in both cases. Note that the certificate\nversion number starts at 0x00, with the following mapping: 0x00→1, 0x01→2, 0x02→3. It is very likely that\nthe threat actor had manipulated the version value surgically, but for reasons unknown. Moreover, the\nserial number for the first certificate is actually “0xb305962f”, but OpenSSL (version 1.1.1k, released on\nMarch 25, 2021) displays it as a negative number. This is because the leading byte 0xb3 is >= 0x80, and\n[should have been prefixed with a leading zero 0x00 in order to avoid incorrectly representing it as](https://docs.microsoft.com/en-us/windows/win32/seccertenroll/about-integer)\nnegative number. On Windows, the certificate viewer does not display it as a negative integer. Checking\nthe certificates of the top 90k WordPress sites and the top 317k Alexa sites on the web show no such\nanomalies. This nonetheless makes detecting this certificate easy, along with the check on the serial\nnumber.\n\n|Malware|Certificate SHA-1 Fingerprint|Serial Number|\n|---|---|---|\n|Quakbot|• 562e7f2f7b3d5913a6ca64f25854d131e56c4ff7 • 101b0f5b4f4e336a2e9cc82b8e00d397f4939e6b|• 0x00 • 0x01|\n|Gozi|• 1d1b4f67f070df5cae8f39553978f0adb3abd0c0|• 0x00|\n\n\n-----\n\n**Certificate (sha256 fingerprint:**\n**11f92d23039c199e82355b9a419fb88e40d8011e52902f1351303bd82d2c591b):**\nData:\n**Version: Unknown (3)**\nSerial Number: -1291479505 (-0x4cfa69d1) First 16-byte of the certificate\nSignature Algorithm: md5WithRSAEncryption\n\n0000h: 30 82 01 9F 30 82 01 08 A0 03\n\nIssuer: CN = Cyxuzoidv\n\n02 01 03 02 04 B3\n\nValidity\nNot Before: Nov 24 19:01:13 2015 GMT\nNot After : Nov 23 19:01:13 2016 GMT\nSubject: CN = Cyxuzoidv\nSubject Public Key Info:\nPublic Key Algorithm: rsaEncryption\nRSA Public-Key: (1024 bit)\n…\n\n**Certificate (sha256 fingerprint:**\n**d54b3bff7196c2201a3fe60fac8aa7601175db092268227b8b72c33910fc9dc5):**\nData:\n**Version: Unknown (3)**\n\nFirst 16-byte of the certificate\n\nSerial Number: 151965358 (0x090eceae)\nSignature Algorithm: sha1WithRSAEncryption 0000h: 30 82 01 A1 30 82 01 0A A0 03\nIssuer: CN = Wureuzisen 02 01 03 02 04 09\nValidity\nNot Before: Feb 3 18:37:43 2016 GMT\nNot After : Feb 2 18:37:43 2017 GMT\nSubject: CN = Wureuzisen\nSubject Public Key Info:\nPublic Key Algorithm: rsaEncryption\nRSA Public-Key: (1024 bit)\n…\n\n\nAs shown in Table 5, all the malware that use self-signed certificates were found to be using the RSA\npublic key type, with varying key sizes:\n\n**Key**\n**Total Malware**\n**Size**\n\n1024 183 (17%)\n2048 803 (75%)\n\n1 (0.09%) – only one malware\n\n            - Variant of Adwind\n\n3072\n\n            - Certificate sha-1 fingerprint: 51a405e1791e14af11208387348a1399e6e63195\n\n            - Serial number: 0x66548813\n4096 80 (7.5%)\n### Table 5. Malware self-signed certificate public key size and type\n\n696 of 1,067 self-signed certificates already expired as of August 6, 2021.\n\nMore than 50% of the malware SSL/TLS communications are carried over TLSv1.2, around 12% over\nSSLv3, 20% over TLSv1, and none over TLSv1.3, but that does not mean they do not exist. All the\nmalware surveyed in the SSL Blacklist (SSLBL) are Windows based, and the version is dependent on the\nOS version, network library used, and the server the malware is communicating with.\n\n|Key Size|Total Malware|\n|---|---|\n|1024|183 (17%)|\n|2048|803 (75%)|\n|3072|1 (0.09%) – only one malware • Variant of Adwind • Certificate sha-1 fingerprint: 51a405e1791e14af11208387348a1399e6e63195 • Serial number: 0x66548813|\n|4096|80 (7.5%)|\n\n\n-----\n\nWhen crafting detection logic for a certificate for an IPS/IDS system such as Snort or Suricata, it is\nimportant to keep in mind whether to use the system’s decoder primitive to account for different attributes\nin the certificate, or to use, plain _content match against a specific attribute. In most cases, Suricata’s_\nprotocol detection is port agnostic, and has decent support for detecting certain attributes in the certificate\nvia special keywords (ex., tls.cert_subject, tls.cert_issuer, tls.cert_serial, tls.sni and tls_cert_notbefore,\namong others), but not so for Snort, which is port dependent by default and does not provide special\nkeywords for detecting any attributes in the certificate. This is important because not all malware use the\ndefault SSL/TLS 443 port number when communicating with their C&C server(s) over SSL/TLS.\n\nNonetheless, each of the certificate attributes are binary encoded and has a defined ASN.1 notation that\nfollows the Type-Class Length Value (TLV) structure. For example, to detect the Organization Name\nattribute with the value “Microsoft” in the certificate Subject field, without enforcing the sequence of\nheaders, you take these bytes |06 03 55 04 0A 13 09 4D 69 63 72 6F 73 6F 66 74|, which translate to:\n```\nX509AttributeType Type: IdAtOrganizationName (2.5.4.10) -> Bytes |06 03 55 04 0A|\nX509AttributeValue Value: Microsoft -> Bytes |13 09 4D 69 63 72 6F 73 6F 66 74|\n    - X520OrganizationName IdAtOrganizationName: Microsoft\n    - AsnBerPrintableString PrintableString: Microsoft\n     - AsnBerOctetString String: Microsoft\n     - AsnBerInfo AsnOctetStringHeader: \n      + AsnBerIdentifier AsnId: PrintableString type (Universal 19)\n      + AsnBerLength AsnLen: Length = 9, LengthOfLength = 0\n      AsciiString OctetStream: Microsoft\n\n```\n**Certificate Pinning**\n\nRelying on a valid and trusted certificate from the server during TLS/SSL handshake is crucial and\nfunctions as a proof to the validity and identity of the server, for the client to trust it. However, such a\nsetup is not enough to guarantee the server’s authenticity, since the attacker could install a rogue root CA\ncertificate on the user device or perform a man-in-the-middle attack to get the traffic unencrypted. Thus,\nwhy SSL/TLS certificate pinning is important in the client side to avoid such attacks.\n\nOne approach for certificate pinning is by embedding a list of trusted certificates in the client application\nitself, and at runtime during handshake, compare them against the server certificates, such that if a\nmismatch happens, the connection is aborted. Other approaches include comparing only the public key\n(stored hashed), serial number, or any other items in the certificate. Depending on what is exactly being\npinned from the certificate in the client application, certificate pinning might sever the connection with the\nserver, if the server certificate has been updated in ways the pinned certificate/items cannot account for.\n\nIn the case of malware, only a handful use certificate pinning, including [IcedID,](https://research.checkpoint.com/2021/melting-ice-tracking-icedid-servers-with-a-few-simple-steps/) [AsyncRAT,](https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp) [DcRAT,](https://github.com/qwqdanchun/DcRat)\n[Vawtrak](https://fidelissecurity.com/threatgeek/archive/vawtrak-c2-pin-it/) and [PhantomNet. Since they all use self-signed certificates, with unique values in the Subject](https://www.welivesecurity.com/2020/12/17/operation-signsight-supply-chain-attack-southeast-asia/)\nfield, detection is still possible, while man-in-the-middle attack might not work.\n\n### • IcedID\n o Communicates over HTTPS o Uses a self-signed certificate\n\n\n-----\n\n### o In a nutshell, and as described by Checkpoint, the malware hashes the public key in the\n certificate and compares it against the serial number of the certificate. If it fails to match, the connection is terminated o The length of the serial number for all variants that use such type of certificate pinning\n is 4 bytes, and the Subject field contains the value “CN=localhost, C=AU, ST=Some-State, O=Internet Widgits Pty Ltd”. Since the Subject value might not be unique to IcedID, checking the length of the serial number such that it is only 4 bytes, along with the Subject field value, will reduce the likelihood of false positive hits on other malware families that use the same Subject field\n • AsyncRAT\n o Open source o Uses custom protocol over TCP. Latest versions encrypt traffic with SSL/TLS o Uses a self-signed certificate o Executing the builder for the first time, it asks for the “Certificate Name” to generate a\n new PKCS #12 type certificate under the filename “ServerCertificate.p12”, which contains the actual certificate and the private key.\n\n ▪ The default certificate name is set to “AsyncRAT Server”\n ▪ The certificate Subject uses only the Common Name (CN) field\n ▪ Certificate validity is always from the date the certificate was generated until December 31, 9999 7:59:59 PM\n ▪ Serial number is always 15 bytes in length, but value changes every time the certificate is generated\n ▪ Uses version 3 of the x.509 certificate\n ▪ Signature algorithm: sha512RSA\n ▪ Public Key: RSA (4096 Bits). Value changes every time the certificate is generated\n ▪ Public Key parameters: 05 00 o The self-signed certificate is stored AES encrypted and base64 encoded in the malware\n sample o Once the malware is executed, it starts by RSA verifying the digital signature of the\n embedded certificate’s public key against a precomputed sha-256 hash value. If verification fails, it terminates itself o Once communication with the server is established, and the certificate is received from\n the server, it compares it against the stored certificate, and in case they are not equal, the malware terminates itself\n\n • DcRAT\n o Open source. o This RAT is based on the source code of AsyncRAT and uses the same certificate\n validation techniques o The only difference is that the default certificate Subject Common Name (CN) is set to\n “DcRat Server”\n\n\n-----\n\n### • Vawtrak\n o First, it checks the certificate’s Common Name such that the sum of all the characters (in\n hex) except for the last character before the first occurrence of the ‘.’ character, modulo 0x1A + 0x61, is equal to the last character, as shown in the following decompiled output:\n\n```\nINTERNET_CERTIFICATE_INFO cert_info; // [esp+14h] [ebp-28h] BYREF\ndwBufferLength = 40;\nis_valid = 0;\nif ( InternetQueryOptionA(hInternet,\nINTERNET_OPTION_SECURITY_CERTIFICATE_STRUCT, &cert_info, &dwBufferLength) )\n{\n is_valid = verify_cn(cert_info.lpszSubjectInfo);\n LocalFree(cert_info.lpszSubjectInfo);\n LocalFree(cert_info.lpszIssuerInfo);\n LocalFree(cert_info.lpszProtocolName);\n LocalFree(cert_info.lpszSignatureAlgName);\n LocalFree(cert_info.lpszEncryptionAlgName);\n if ( !is_valid )\n  return 0;\n}\n…\nBOOL __fastcall verify_cn(LPTSTR *cert_cn)\n{\n unsigned __int8 sum;\n unsigned __int8 nchar;\n sum = 0; nchar = 0;\n while ( *cert_cn && *cert_cn != '.' )\n {\n  sum += nchar;\n  nchar = *cert_cn;\n  cert_cn = (cert_cn + 1);\n }\n return sum % 0x1A + 0x61 == nchar;\n}\n\n```\n\n### o Second, RSA verifies the signature hash of the certificate’s Subject Key Identifier\n attribute value using the certificate’s public key, as shown in the following decompiled output:\n\n\n-----\n\n```\ndwBufferLength = 4;\nif ( !InternetQueryOptionA(hInternet,\nINTERNET_OPTION_SERVER_CERT_CHAIN_CONTEXT, &pChainContext, &dwBufferLength)\n || !pChainContext )\n...\npCertContext = chain_element->pCertContext;\n if ( pCertContext )\n  is_skid_valid = verify_cert_skid(pCertContext);\n--->\nBOOL __thiscall verify_cert_skid(PCCERT_CONTEXT pCertContext)\n{\n PCERT_INFO pCertInfo;\n BOOL result;\n char pvStructInfo[20];\n char pdata[128];\n BYTE pvData[128];\n DWORD pcbStructInfo;\n pcbStructInfo = 148;\n result = pCertContext\n    && (pCertInfo = pCertContext->pCertInfo) != 0\n    && pCertInfo->SubjectPublicKeyInfo.PublicKey.pbData\n    && CryptDecodeObject(\n       X509_ASN_ENCODING__PKCS_7_ASN_ENCODING,\n       RSA_CSP_PUBLICKEYBLOB,\n       pCertInfo->SubjectPublicKeyInfo.PublicKey.pbData,\n       pCertInfo->SubjectPublicKeyInfo.PublicKey.cbData,\n       0, pvStructInfo, &pcbStructInfo) && pcbStructInfo == 148\n    && (pcbStructInfo = 128,\n      CertGetCertificateContextProperty(pCertContext, \n       CERT_KEY_IDENTIFIER_PROP_ID, pvData, &pcbStructInfo))\n    && pcbStructInfo == 128 && verify_sig(pdata, 128u, pvData);\n return result;\n}\n\n```\n\n**Trusted Certificates**\n\nAs shown in Table 6, Let’s Encrypt CA tops the list in terms of malware that use certificates generated by\nit, with Gozi alone claiming 150 of those certificates, followed by 61 for QNodeService, 29 for BazaLoader,\nand 28 for ZLoader. Note that we didn’t observe a given certificate to have been renewed after the threemonth validity period expiration date, for a given malicious domain. Instead, we found two different\ncertificates to have been generated for the same domain, in an overlapping validity period, for a few\nmalicious domains.\n\n\n-----\n\nThe data shows that multiple trusted CAs are vulnerable to issuing certificates to nonlegitimate entities.\n\n**_Certificate Authority_** **_Total_**\n_Let's Encrypt Authority X3_ 458\n_COMODO RSA Domain Validation Secure Server CA_ 41\n_RapidSSL CA_ 19\n_EssentialSSL CA_ 18\n_cPanel, Inc. Certification Authority_ 13\n_Others_ 26\n### Table 6. Trusted Certificate Authorities (CA) certificates used by different malware families\n\n[The topic of whether it is the CA’s responsibility to combat malware and phishing sites is debatable. Let’s](https://letsencrypt.org/2015/10/29/phishing-and-malware.html)\nEncrypt, notably, does not believe that certificate authorities should police the contents of domains. With\nTLS enabled by default across all domains, encryption would be an essential feature of all network traffic.\n\nTable 7 shows the percentage of the trusted certificates public key size and type for some of the surveyed\nmalware, with the RSA algorithm, size 2048 Bits, accounting for 462/542. ECC’s adoption rate is very low\n(only 5.9%) compared to RSA, and the reason could be due to minimum operating system version and\nbrowser version requirements. Since all the surveyed malware for this table are Windows based, the\nminimum Windows version required for ECC is Windows Vista and Explorer 7. It is very likely for ECC\nadoption rate to increase in the future.\n\n**Key Size** **Total Malware (542)**\nRSA - 2048 462 (85%)\nRSA - 4096 48 (8.9%)\n\n32 (5.9%)\n\nECC - 256        - Let's Encrypt Authority X3; CloudFlare Inc ECC CA-2\n\n                - [28/32 are QNodeService malware.](https://www.trendmicro.com/en_us/research/20/e/qnodeservice--node-js-trojan-spread-via-covid-19-lure.html)\n### Table 7. Trusted Certificates Public Key Size\n\nTable 8 shows two sets of certificates that share the same serial number. Moreover, validating top 90k\nWordPress sites certificates show three sets of self-signed certificates that share the same serial number;\nthey are: 0x00(7), 0x01(4), 0x02(3).\n\n|Let's Encrypt Authority X3 COMODO RSA Domain Validation Secure Server CA RapidSSL CA EssentialSSL CA cPanel, Inc. Certification Authority Others|458 41 19 18 13 26|\n|---|---|\n\n|Key Size|Total Malware (542)|\n|---|---|\n|RSA - 2048|462 (85%)|\n|RSA - 4096|48 (8.9%)|\n|ECC - 256|32 (5.9%) • Let's Encrypt Authority X3; CloudFlare Inc ECC CA-2 • 28/32 are QNodeService malware.|\n\n|Malware|Serial Number|Certificate|\n|---|---|---|\n|Malware C&C|0xEB|• SHA1 fingerprint: 56a9aa61d3667c96a3ffeb941cff22ee9ea8da10 • Issuer (DN): O=Agency of Protected Certification Services, L=Phoenix, ST=AZ, C=US, CN=Agency of Protected Certification Services • Subject (DN): C=US, ST=AZ, O=Agency of Protected Certification Services, CN=www.hot-sex-tube.com • Validity: 2010-02-20 18:41/2015-02-19 18:41|\n|Shifu C&C|0xEB|• SHA1 fingerprint: b821b99a945a8ab05a8518c4c1ec2f45f1ed6065 • Issuer (DN): O=Agency Protocols Management of Internet, E=info@apmi.com, L=Sacramento, ST=CA, C=US, CN=Agency Protocols Management of Internet SSL CA • Subject (DN): C=US, ST=CA, O=Agency Protocols Management of Internet, CN=bestylish.com, E=info@apmi.com • Validity: 2011-10-19 16:31/2016-10-17 16:31|\n|Downloder- Bot C&C|0xEB|• SHA1 fingerprint: 84c4d012ae29024ed37d4680fae29e1663b3abcf • Issuer (DN): O=Self Certification Services, E=certs_division@sslslf.info, L=Jacksonville, ST=FL, C=US, CN=Self Certification Services SSL CA • Subject (DN): C=US, ST=FL, O=Self Certification Services, CN=*.sify.com, E=certs_division@sslslf.info • Validity: 2011-10-19 16:31/2016-10-17 16:31|\n\n\n-----\n\n                - SHA1 fingerprint: 1d1b4f67f070df5cae8f39553978f0adb3abd0c0\n\n                - Issuer (DN): C=AU, ST=Some-State, O=Internet Widgits Pty Ltd\n\nGozi C&C 0x00\n\n                - Subject (DN): C=AU, ST=Some-State, O=Internet Widgits Pty Ltd\n\n                - Validity: 2016-12-22 16:01/2017-12-22 16:01\n### Table 8. Malware self-signed certificates with same serial number\n\n**Conclusion**\n\nAs malware adoption rate of the SSL/TLS protocol increases with time, so does the need for defenders to\ncome up with different detection rules. SSL/TLS encrypted traffic hinders detecting malware C&C\ncommunication traffic. However, a lot of malware use self-signed certificates with unique values for some\nof the attributes, which make detecting and blocking C&C traffic at the certificate level a viable option.\nMoreover, we’ve shown some interesting and exceptional anomalies in some of the fields in multiple\ncertificates used by different malware families, which help in identifying the malware C&C server. We also\nnoted the use of trusted and valid certificates issued by trusted CAs by several malware families, which\nshows that threat actors are actively searching for ways to avoid detection and blend more seamlessly\nwith normal network traffic. This also calls for the need for better vetting and screening processes by CAs\nwhen issuing such certificates.\n\nWe’ve also documented a couple malware families that use certificate pinning in their code to prevent\nman-in-the-middle type attacks, or for interacting with the C&C server without the proper certificate\nhandshake.\n\nThis work has resulted in the creation of multiple types (specific or generic) of IDS/IPS signatures/filters\nthat attempt to detect different malware families at the certificate handshake level.\n\nFor future work, and for a more generic detection approach, a supervised classifier could be developed to\ndetect malicious certificates in malware traffic, based on specific sets of features extracted from the\ncertificate’s attributes.\n\nWe hope that we have contributed tangibly to this topic and shed light on some corner cases of different\nmalware families’ usage of public certificates, helping defenders better secure their networks.\n\n**Acknowledgment**\n\nWe would like to thank Cory Ford from Trend Micro Threat Research for reviewing this technical brief and\nproviding valuable comments.\n\n|Quakbot C&C|0x00|• SHA1 fingerprint: 562e7f2f7b3d5913a6ca64f25854d131e56c4ff7 • Issuer (DN): C=IN, ST=Karnataka, L=Bangalore, O=Multitech, OU=ODC, CN=localhost.localdomain • Subject (DN): C=IN, ST=Karnataka, L=Bangalore, O=Multitech, OU=ODC, CN=localhost.localdomain • Validity: 2006-04-24 10:38/2007-04-24 10:38|\n|---|---|---|\n|Gozi C&C|0x00|• SHA1 fingerprint: 1d1b4f67f070df5cae8f39553978f0adb3abd0c0 • Issuer (DN): C=AU, ST=Some-State, O=Internet Widgits Pty Ltd • Subject (DN): C=AU, ST=Some-State, O=Internet Widgits Pty Ltd • Validity: 2016-12-22 16:01/2017-12-22 16:01|\n\n\n-----\n\n**TREND MICRO[TM] RESEARCH**\n\nTrend Micro, a global leader in cybersecurity, helps to make the world safe for exchanging digital information.\n\nTrend Micro Research is powered by experts who are passionate about discovering new threats, sharing key insights, and\nsupporting efforts to stop cybercriminals. Our global team helps identify millions of threats daily, leads the industry in\nvulnerability disclosures, and publishes innovative research on new threats techniques. We continually work to anticipate new\nthreats and deliver thought-provoking research.\n\n**www.trendmicro.com**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.trendmicro.com/content/dam/trendmicro/global/en/research/21/i/ssl-tls-technical-brief/ssl-tls-technical-brief.pdf"
    ],
    "report_names": [
        "ssl-tls-technical-brief.pdf"
    ],
    "threat_actors": [
        {
            "id": "bbdb2d7d-4bf4-4100-a108-f4742cfd69ff",
            "created_at": "2022-10-25T16:07:24.01101Z",
            "updated_at": "2025-03-27T02:02:10.074776Z",
            "deleted_at": null,
            "main_name": "Operation SignSight",
            "aliases": [],
            "source_name": "ETDA:Operation SignSight",
            "tools": [
                "Mimikatz",
                "PhantomNet",
                "SManager"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716496,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1630707143,
    "ts_modification_date": 1630707143,
    "files": {
        "pdf": "https://archive.orkl.eu/02c222792c65765833e9bb8d77453ba1912e416e.pdf",
        "text": "https://archive.orkl.eu/02c222792c65765833e9bb8d77453ba1912e416e.txt",
        "img": "https://archive.orkl.eu/02c222792c65765833e9bb8d77453ba1912e416e.jpg"
    }
}