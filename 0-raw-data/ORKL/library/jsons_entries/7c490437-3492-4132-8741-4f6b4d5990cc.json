{
    "id": "7c490437-3492-4132-8741-4f6b4d5990cc",
    "created_at": "2023-01-12T15:04:47.282269Z",
    "updated_at": "2025-03-27T02:17:00.193914Z",
    "deleted_at": null,
    "sha1_hash": "867d15e216f8cbe819cf683b4461363d5c8eb9a0",
    "title": "2022-12-05 - Threat Analysis- MSI - Masquerading as a Software Installer",
    "authors": "",
    "file_creation_date": "2022-12-29T00:24:01Z",
    "file_modification_date": "2022-12-29T00:24:01Z",
    "file_size": 2493323,
    "plain_text": "# Threat Analysis: MSI - Masquerading as a Software Installer\n\n**[cybereason.com/blog/threat-analysis-msi-masquerading-as-software-installer](https://www.cybereason.com/blog/threat-analysis-msi-masquerading-as-software-installer)**\n\nWritten By\nCybereason Global SOC Team\n\nDecember 5, 2022\n|\n16 minute read\n\nThe Cybereason Global Security Operations Center (GSOC) issues a Purple Team Series of\nits Threat Analysis reports to provide a technical overview of the technologies and techniques\nthreat actors use to compromise victims’ machines.\n\nIn this Threat Analysis report, the Cybereason GSOC team analyzes a technique that utilizes\nMicrosoft’s Windows Installation file (.msi) to compromise victims’ machines.\n\nThis report is divided into four sections:\n\n\n-----\n\n1.\n\n\n1.\n\n1.\n\n## KEY POINTS\n\n\n1. Introduction: An overview of the MSI file format.\n\n2. Red Team: Offensive approach leveraging MSI files for attacking\n\npurposes.\n\n3. Blue Team: Defenders' perspective, studying how MSI files are\n\nexploited by threat actors.\n\n4. Purple Team: Detection proposals for possible malicious MSI files and\n\nanalysis tools.\n\n\n**Masquerade as legitimate installer: Malicious MSI files are sometimes difficult to**\ndistinguish from legitimate installers. Threat actors will often masquerade as well-known\nsoftware updates and manipulate victims into “updating” the software on their\nmachines.\n\n**Execute with elevated privilege: MSI allows execution with a LocalSystem account**\n(NT Authority\\System). The unauthorized access via LocalSystem privilege can lead to\ncompromise of the system and to further network compromise.\n\nNumerous ways to exploit MSI: MSI is based on [COM Structure Storage, which allows](https://docs.microsoft.com/en-us/windows/win32/stg/about-structured-storage)\nthreat actors to store malicious files in a MSI file and to control stored files with custom\nactions. This technology gives threat actors a variety of options for execution patterns\nthey can use to infect victims’ machines.\n\n## INTRODUCTION\n\nThis chapter explains the fundamentals of Windows Installer packages (MSI).\n\n### Overview\n\nMSI, formerly known as [Microsoft Installer, is a Windows installer package format. MSI allows](https://web.archive.org/web/20090115213653/http://blogs.msdn.com/robmen/archive/2003/11/25/56510.aspx)\nfor the installation and deployment of necessary Windows applications or packages to endusers’ machines. MSI is a standardized installation method that simplifies the installation\nprocess for users. The installation process with MSI files is simple and often does not require\nmuch user interaction. Usually, the installation process with MSI is similar to running an\nexecutable.\n\n\n-----\n\nMSI utilizes Microsoft s technology COM Structured Storage, which allows an MSI file to have\na file system structure. This technology is also referred to as OLE documents, components\noften used by Microsoft Office. This technology is constructed with two types of objects called\nstorage and streams, which are conceptually similar to directories and files. This structure\nallows MSI components to store multiple files to allow for easy access.\n\nThe ability to store and deploy necessary files with minimal user action makes this technology\nsimilar to self-extracting zip files, which are often in the form of executables.\n\nThe installation procedure also allows execution with a LocalSystem account (NT\nAuthority\\System). The elevated privilege behavior as well as the COM Structure makes MSI\nan attractive malware deployment method for threat actors.\n\n### Structure\n\nMSI contains a main stream called a Database stream. This section provides an overview of\nthe Database stream and its relevant components.\n\n**Database**\n\nThe Database stream consists of tables that form a relational database. These tables are\nlinked with primary and foreign key values. This structure allows MSI to maintain relationships\nbetween the different tables and contain basic information required to perform the\ninstallation.\n\n_Database stream, representing primary/foreign key relationships_\n\n\n-----\n\nThe information within each table has important roles for the installation, such as tables\nstoring information on installing software applications.\n\n[File: Metadata of installing application files.](https://learn.microsoft.com/en-us/windows/win32/msi/file-table)\n\n[Registry: Registry key values of installing applications.](https://learn.microsoft.com/en-us/windows/win32/msi/registry-table)\n\n[Shortcut: Shortcuts of relevant installing applications.](https://learn.microsoft.com/en-us/windows/win32/msi/shortcut-table)\n\nOther tables include information about package executions of the installation and execution\nsequences. These tables are crucial for MSI to determine the execution flow, as well as the\nexact actions needed for the installation. The tables allow developers to manipulate the\ninstallation process and allow installation to have complex logic. The installation logic is often\nmanipulated with Actions and Sequences.\n\n**Actions**\n\nThe MSI contains a set of subroutines to execute the installation. These routines are divided\ninto two types:\n\n[Standard Actions: These are built-in actions that allow developers to perform the](https://learn.microsoft.com/en-us/windows/win32/msi/standard-actions)\ninstallation. Some notable actions include the following–\n\nInitialize installation directories\nDrop files to the installation directories\nAdd a registry value for the installing softwares\n\n[Custom Actions: Standard Actions may not be enough for developers to execute the](https://learn.microsoft.com/en-us/windows/win32/msi/custom-actions)\ninstallation logic. Custom actions allow developers to embed logic outside of Standard\nActions by executing specific binary or scripts during the installation. Some notable\ncustom actions include the following–\n\nExecute executables stored within the MSI file\nExecute specific exported functions from DLLs\n\nExecute JavaScript or Visual Basic scripts\n\n[The above actions can be manipulated by utilizing Properties, which are similar to](https://learn.microsoft.com/en-us/windows/win32/msi/properties)\nenvironment variables. Properties often contain various data and control parameters required\nto execute certain actions, including:\n\nA flag which identifies if reboot is needed\nInstallation directory\n\n\n-----\n\nSystem information\n\nControl information on installation\n\nThe Property table exists within the Database Stream. However, note that not all properties\nare stored in the Property table. Since some Properties are set during the installation in\nspecific actions, Properties that are set dynamically may not be in the Property table.\n\n**Sequences**\n\nDevelopers can set the order in which Standard Actions and Custom Actions are executed in\nthe [Sequence table. Within the Sequence table, they can assign conditions to control the](https://learn.microsoft.com/en-us/windows/win32/msi/using-a-sequence-table)\nactions’ behavior.\n\nThere are two main types of sequences:\n\nInstall UI Sequence - This refers to the sequence of actions for installation UI, which\nincludes user interactions with the dialog.\n\nInstall Execute Sequence - This refers to the sequence of actions for actual installation\nexecution, such as dropping files and creating registry entries. When conducting silent\ninstallation, the Install UI Sequence is ignored and only the Install Execute Sequence is\nused.\n\nFor this report, the focus will be on the Install Execute Sequence, since this table is most\nrelevant to the actual installation behavior.\n\n\n-----\n\n_Example MSI database tables layout and its relations_\n\n## Red Team\n\nThis section describes how to reproduce the staging of a malicious MSI file, in order to\nanalyze it and build detections for it. Similar to archived files, an MSI file can contain various\nmalicious binaries or scripts to conduct its malicious actions.\n\nIn this section, the MSI file will reference the MSFVenom template with minor updates.\nHowever the section will focus more on the inner workings of MSI file format.\n\n\n-----\n\n_Malicious MSI execution flow_\n\nMSI files can allow attackers to embed malicious binaries or scripts and take over the machine\nwith elevated privileges. To demonstrate this, a malicious stager binary is embedded into an\nMSI file, which later fetches and executes the payload from the C2 server.\n\nThe overall flow is as follows:\n\n1. Execute the MSI file.\n2. Execute the embedded binary.\n3. Execute the stager shellcode.\n4. Fetch and execute the payload from a C2 server.\n\n5. Terminate installation.\n\nThe main usage here is to execute any relevant binary within memory without dropping any\nfiles to the disk.\n\n### Preparation\n\n\n-----\n\nIn this section, we show how MSI files can be created using the Windows Installer XML(WiX)\ntoolset. This is free software for building Windows Installer packages from XML files.\n\n_WXS file content, showing Stager and ExitInstallation Custom Actions_\n\n[The executable needs to be stored in a table where it can be accessed by the CustomAction](https://wixtoolset.org/documentation/manual/v3/xsd/wix/customaction.html)\n[element prior to its execution. The Binary table is often used to place animations, bitmaps,](https://wixtoolset.org/documentation/manual/v3/xsd/wix/binary.html)\nand icons; however it also allows the MSI to store relevant binary data needed for\nCustomAction, even malicious PE files and scripts.\n\n_Id assigns unique identifiers to the elements, which developers can call and utilize for specific_\nactions. The MyStager id is assigned to the malicious executable stager.exe. This executable\nwill allocate and execute stager shellcode.\n\n_Binary and CustomAction_ _elements_\n\nThe MyStager binary element is followed by a CustomAction element with Id Stager. This is\nthe key element that will decide the behavior of the MyStager.\n\nEach attribute from the configuration of CustomAction is described below:\n\nBinaryKey: Attribute which specifies Binary element ID.\nImpersonate: Attribute which specifies if the installer impersonates the installing user’s\ncontext. If attribute is no, then the installer will be executed with elevated privileges\n(LocalSystem).\nExecute: Attribute which specifies the scheduling of the CustomAction. The parameter\n[“deferred” will delay the execution and allow the developer to control the specific](https://docs.microsoft.com/en-us/windows/win32/msi/deferred-execution-custom-actions)\nCustomAction. This is the only value that allows the execution to run in elevated\nprivileges.\nReturn: Attribute which specifies the return behavior of CustomAction. asyncNoWait\nvalue allows the CustomAction to be executed asynchronously from the installer.\nExeCommand: Attribute which specifies arguments for the executable.\n\nThe CustomAction Stager is set up to execute the malicious executable stored in the Binary\ntable with elevated privileges and to continue executing even after installation is terminated.\n\n\n-----\n\n_CustomAction ExitInstallation_\n\nAfter the MyStager setup, another CustomAction ExitInstallation is set to attempt executing\nVBScript. However, this execution will purposely fail and exit since this installation will not\ncontain relevant VBScript. This CustomAction has another purpose which will be explained in\nthe next paragraph.\n\nOnce the CustomActions are set, the element InstallExecuteSequence, an Install Execute\nSequence table, is set. For its first action, ResolveSource sets the source location and\nsourcedir property. This is needed to initialize the installation process. Once initialization is\ncomplete, the relevant CustomActions Stager and ExitInstallation will be set for the execution\nin this order respectively.\n\nExitInstallation plays an important role in this execution, which will force the installation to\npurposely fail and exit. This then forces the MSI to exit with a failure. However, the malicious\nbinary will continue executing since it is set up to run asynchronously. The victim may\ndisregard this error and may not take into account that malicious activities are running in the\nbackground.\n\n### Execution\n\nThe execution in this section assumes the victim retrieves the MSI file via phishing email.\nOnce the file is deployed onto the victim’s machine, the victim executes the MSI file by simply\ndouble-clicking. The execution prompts with a UAC warning, as execution is performed by a\nhigh-privilege user. Once the UAC warning is accepted by the user, the execution will proceed\nwith the usual installation process.\n\n_MSI process tree_\n\nAfter MSI execution, the installation fails and exits with the following message:\n\n\n-----\n\n_Error message due to_ _CustomAction ExitInstallation_\n\nThe MSI terminates itself; however, since the Stager is set to execute asynchronously, the\nmalicious binary will continue executing.\n\n_Attack Tree of MSI execution_\n\nAs soon as MSI starts executing itself, the execution flow enters the malicious executable in\nthe Custom Action, which is msia8a.tmp.\n\nMsia8a.tmp (the name will vary) proceeds to retrieve the payload from the C2 server and\ndeploy it onto the victim's machine. Once the payload is successfully deployed, the stager\ncontinues executing the payload. Successful payload execution leads to successful\n\n\n-----\n\nconnection to the C2 server, and it is also evident that the payload is being executed with an\nelevated privilege account. At this point, the attacker has remote control over the machine.\n\n_Attacker’s terminal, which is a Metasploit listener_\n\n\n-----\n\n_Execution Flow Chart_\n\n## Blue Team\n\nThis section focuses on an analysis of malware that abused MSI files in the past. Technical\nAnalysis dives into MSI file usage by three different malware families seen in the wild. The\nsection ends with Comparative Charts for each sample's MSI file execution.\n\n### Technical Analysis\n\nThis section analyzes three different malware families. The analysis focuses on the following\nSecure Hash Algorithm (SHA)-256 samples.\n\n\n-----\n\nMalware\nFamily\n\nMagniber\nRansomware\n\nMatanBuchus\nLoader\n\nQbot /\nQakbot\n\n\nSHA-256\n\n0e65657740d7f06acda53b7d3190f9728801b984d5bd6ccb0b865d218ae71f66\n\nface46e6593206867da39e47001f134a00385898a36b8142a21ad54954682666\n\nc0beb47f629a5debe0e99790d16a4d04afe786d6fb42c5ab6dfcaed84d86e7ad\n\n\n**Magniber Ransomware**\n\nMagniber Ransomware is known to utilize infection methods such as exploiting vulnerabilities\nand masquerading as a legitimate software update to infect a victim’s machine. The following\nare known infection methods seen in the past:\n\n[Exploiting the PrintNightmare vulnerability.](https://www.cybereason.com/blog/threat-analysis-report-printnightmare-and-magniber-ransomware)\n[Masquerading as a legitimate Google Chrome or Microsoft Edge update by abusing](https://www.bleepingcomputer.com/news/security/magniber-ransomware-using-signed-appx-files-to-infect-systems/)\nWindows Application Package (.appx) files.\n[Masquerading as legitimate Windows 10 upgrades by abusing MSI.](https://asec.ahnlab.com/en/32226/)\n\nMSI Analysis\n\nAccording to file metadata, the MSI file is built with the WiX toolset.\n\n_MSI file metadata_\n\nThe presence of CustomAction in the table below provides a better idea of potentially\nmalicious behavior:\n\n\n-----\n\n_Sample’s CustomAction table, as seen from the Orca tool_\n\nThe CustomAction table has two actions configured:\n\n1.\n\n1.\n\n1. SetProgramFilesFolder: Set Program Files folder to local appdata folder\n\n(C:\\Users\\UserName\\AppData\\Local).\n\n2. h54pstl1: Fetch binary m21iivix0ds.\n\nSetProgramFilesFolder has Custom Action type 51, which indicates the action will configure\nthe property's value. The Custom Action SetProgramFilesFolder configures the source\n[ProgramFilesFolder property, which is a placeholder for the Program Files folder.](https://learn.microsoft.com/en-us/windows/win32/msi/programfilesfolder)\n[ProgramFilesFolder is set to a value specified by the target LocalAppDataFolder property,](https://learn.microsoft.com/en-us/windows/win32/msi/localappdatafolder)\nwhich is a local appdata folder (e.g. C:\\Users\\UserName\\AppData\\Local).\n\n\n-----\n\n_Sample’s Directory table, as seen from the_ _Orca tool_\n\nThe Directory table includes information on the installation’s directory location. As shown in\n[the image, ProgramFilesFolder is seen to have Directory_Parent as the TARGETDIR property,](https://learn.microsoft.com/en-us/windows/win32/msi/targetdir)\nwhich is the root installation directory. Based on the Directory and CustomAction tables, the\ninstallation directory will be placed under the local appdata directory.\n\nThe Custom Action h54pstl1 has Type 65, which indicates combinations of the type and\nrelevant options.\n\n[Type 1: Indicates the DLL file is stored within the Binary Table.](https://learn.microsoft.com/en-us/windows/win32/msi/custom-action-type-1)\n\n[Optional Constant +64: Indicates that the execution will continue regardless of](https://docs.microsoft.com/en-us/windows/win32/msi/custom-action-return-processing-options)\nCustomAction failure.\n\nAccording to the Custom Action Type, m21iivix0ds is a DLL file stored in the Binary Table and\nis expected to execute the exported function t5thamku.\n\n\n-----\n\n_Sample’s Binary Table, as seen from the_ _Orca tool_\n\nIn order to identify at which point in the installation process the Custom Actions are executed,\nthe InstallExecuteSequence table must be analyzed.\n\n_Sample’s InstallExecuteSequence table, as seen from the Orca tool_\n\n\n-----\n\n[The actions with sequence number 800 to 1000 are related to costing of the installation, which](https://learn.microsoft.com/en-us/windows/win32/msi/c-gly)\nis an action to calculate the amount of disk space in which relevant files are to be installed or\nremoved. Since the cost of installation files are also related to the installation directory, the\nrelevant directory needs to be configured. As a result, the SetProgramFilesFolder (Sequence\nnumber 999) action is within the costing process and the directory resolution configured in the\nDirectory table is configured in the CostFinalize action.\n\nCustom Action h54pstl1 is executed right after InstallInitialize, which is a sequence for actual\ninstallation execution. Anything between InstallInitialize and InstallFinalize is part of the\ninstallation activities that will update and change the target system. At this point, the Custom\nAction h54pstl1 executes the exported function t5thamku with elevated privileges.\n\n[InstallFiles is an action that places the relevant files in the destination location, which in this](https://docs.microsoft.com/en-us/windows/win32/msi/file-installation)\ncase is the destination set up by Custom Action SetProgramFilesFolder. This file information\nis often stored in the Media table, the File table, and the Component table.\n\n_Sample’s File table, as seen from the Orca tool_\n\n[Reviewing the Media table, the MSI includes the cabinet file Product.cab. However, in the File](https://learn.microsoft.com/en-us/windows/win32/msi/cabinet-files)\nTable, the file v514749 has a file size of 0. This indicates a cabinet file exists, but it does not\ndrop any files during the installation. Even though the directory was configured via\nCustomAction and Directory tables, since no files will be dropped, the installation directory\nbecomes irrelevant.\n\n\n-----\n\n_Magniber MSI execution snippet, as seen from the Cybereason platform_\n\n_Magniber MSI infection flow_\n\n**MatanBuchus Loader**\n\nMSI Analysis\n\n[MatanBuchus is a Malware-as-a-Service (MaaS) platform developed by the threat actor](https://unit42.paloaltonetworks.com/matanbuchus-malware-as-a-service/)\nBelialDemon and identified on Russian cybercrime forums in early 2021. Operating as a\nsecond-stage malware loader, MatanBuchus contains functionality to download and execute\nmalicious payloads, run arbitrary PowerShell commands, and conduct stealthy C2 server\ncommunications.\n\nThe malware itself has been observed being spread as a ZIP file in phishing emails. This file\ncontains an HTML file which drops another ZIP file when accessed. This second ZIP file\ncontains the MSI file that loads the MatanBuchus payload and initiates downloads from its C2\nserver.\n\nThe loader for MatanBuchus payload is confirmed as an MSI file created using WiX through\nfile metadata analysis. The file itself appears with the subject “Adobe Font Pack 3.0.12.9” and\nis signed by “Westeast Tech Consulting, Corp.” in an attempt to masquerade as a legitimate\nAdobe file. However, it is notable that the certificate has been invalidated.\n\n_MatanBuchus MSI File Metadata, through the file Unix utility_\n\n\n-----\n\n_MatanBuchus MSI file digital signature information_\n\nAs with Magniber, investigating the file's CustomAction values can give a better understanding\nof how the file executes. The CustomAction table below contains two actions with the value\n226, which is of type [34 with option](https://learn.microsoft.com/en-us/windows/win32/msi/custom-action-type-34) [192. Custom Action Type 34 executes executables with](https://learn.microsoft.com/en-us/windows/win32/msi/custom-action-return-processing-options)\nthe command line, and option 192 allows this execution to run asynchronously. These values\nindicate that the files can be executed even if MSI Installer itself fails. Regardless of whether\nMSI Installer fails or runs, the following Custom Actions will occur:\n\nregsvr32.exe will install main_dll.\nwscript.exe will execute notify_vbs.\n\n_MatanBuchus MSI file digital signature information, as seen from the Orca tool_\n\n\n-----\n\nThe source is defined as INSTALLLOCATION, which is confirmed through investigation into\nthe Directory to be the LocalAppDataFolder.\n\n_Directory Information, as seen from the Orca tool_\n\nAccording to the File table below, two files main.dll and notify.vbs will be dropped into the\n_INSTALLLOCATION directory. As shown in CustomAction table, the command line will_\n[execute each of these files, which replace formatted data types [#main_dll] and [#notify_vbs]](https://learn.microsoft.com/en-us/windows/win32/msi/formatted)\nwith the actual file path.\n\n_File metadata Information, as seen from the Orca tool_\n\nThe [#main_dll] and [#notify_vbs] will not be replaced with an actual file path unless the\nCustom Actions are sequenced after CostInitialize, FileCost, and CostFinalize. The files also\nneed to be dumped to the directory before executing via Custom Actions. Thus, the actions\nneed to be executed after InstallInitialize, InstallFiles, and InstallFinalize actions.\nConsequently, both RunApplicationQQQ and RunApplicationNotifyVBS are sequenced at the\nvery end of InstallExecuteSequence.\n\n\n-----\n\n_Custom Actions placed in the very end of InstallExecuteSequence, as seen from the_ _Orca tool_\n\nSince MSI files are COM Structured Storage constructs, it is possible to dump the file’s data\nstreams via OLE in order to investigate the file further. While the output for initial analysis is\nunreadable, several data streams containing significant amounts of data can be observed.\n\n\n-----\n\n_Matanbuchus MSI file OLE streams_\n\nInvestigating the fourth data stream reveals that it begins with the ASCII characters (MSCF),\nindicating that this stream is a Cabinet Archive (CAB) file.\n\n_Fourth OLE stream data_\n\nBy dumping this stream and opening the archive, the files (in this case, main.dll and notify.vbs)\nare dropped. The file notify.vbs is notable because it contains an error message that appears\nrelated to Adobe Acrobat; this is an attempt to fool the user into believing that a legitimate\nAdobe Acrobat file did not run.\n\nIn reality, while this message is displayed to the user once the MSI file is run, MatanBuchus\nexecutes the main.dll file via regsvr32.exe in the background.\n\n\n-----\n\n_Contents of notify.vbs_\n\n_Fake error message displayed by notify.vbs_\n\nThe file main.dll is used by MatanBuchus to load the payload, create C2 connections, and\nestablish persistence in the exploited system.\n\n_Matanbuchus Attack Tree, as seen from the Cybereason platform_\n\n\n-----\n\n_MatanBuchus MSI infection flow_\n\n**Qbot / Qakbot**\n\n[Qbot (also known as Qakbot, Quakbot, and Pinkslipbot) is a modular Trojan that has been in](https://www.cisa.gov/stopransomware/qbotqakbot-malware-report)\ncirculation for over a decade. Its most prevalent campaigns consist of phishing attacks that\nattach malicious macros in Office documents, in particular Excel 4.0 macros, to evade\ndetection.\n\n[The MSI variants of Qbot started circulating in late April 2022, which coincidentally occurred](https://www.bleepingcomputer.com/news/security/qbot-malware-switches-to-new-windows-installer-infection-vector/)\n[around the time Microsoft implemented the VBA macro auto block feature, which made it](https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked)\nharder for threat actors to launch successful attacks via macro-enabled malicious documents.\n\nMSI Analysis\n\nAccording to the file metadata, the file is signed and verified by P.REGO, s.r.o.\n\n\n-----\n\n_File Signature_\n\nWithin the Property Table, there were multiple references to VSDNET* properties, which are\n.NET components utilized by Visual Studio.\n\n[MSI is known to organize an installation around the concepts of components, which is](https://learn.microsoft.com/en-us/windows/win32/msi/windows-installer-components)\nessentially an installing application or software. The malware is seen to have two\ncomponents.\n\n_Component Table, as seen from the_ _Orca tool_\n\nC__FEAF4022223844D1906F79DF588CDB8A: This component has a value\n_FEAF4022223844D1906F79DF588CDB8A in KeyPath, which is a primary key into the\nRegistry, ODBCDataSource or File Table. The KeyPath\n_FEAF4022223844D1906F79DF588CDB8A appears to be a primary key of File (1.dll);\nthis indicates the malware is going to drop a module 1.dll during installation.\n\nFile Table, as seen from the Orca tool\n\n\n-----\n\nC__653B5566E1394F029FA3A18ACFFE5CC8: Unlike the\nC__FEAF4022223844D1906F79DF588CDB8A, this component does not have a\nKeyPath value. When the KeyPath value is NULL, then by default the Directory_ value\nwill be utilized as the KeyPath value, which in this case is TARGETDIR. This component\nis for CreateFolder, and it contains references to a directory that needs to be created\nexplicitly for a particular component. Once emptied during the installation, any\ndirectories created during the installation are removed. This component ensures that the\ndirectory set in TARGETDIR exists during and after the installation.\n\n_CreateFolder Table, as seen from the_ _Orca tool_\n\nTo understand the behavior of this MSI, inspecting Custom Action is necessary. The\nCustomAction table contains four actions; however, the main actions of this malware are\n_9BED75AC_30E3_4BB1_9F26_1A4F247F32EF and DIRCA_TARGETDIR.\n\n1. _9BED75AC_30E3_4BB1_9F26_1A4F247F32EF: Fetch and execute binary\n\n_C212458FE5F810E2D8287472A14C2665\n[2. DIRCA_TARGETDIR: Sets a target directory (TARGETDIR) to a local appdata directory](https://learn.microsoft.com/en-us/windows/win32/msi/targetdir)\n\n[(LocalAppDataFolder\\ProductName)](https://learn.microsoft.com/en-us/windows/win32/msi/localappdatafolder)\n\nCustom Action Table\n\nThe first action (_9BED75AC_30E3_4BB1_9F26_1A4F247F32EF) refers to the source\n(_C212458FE5F810E2D8287472A14C2665), which is found under the Binary table.\n\n_Binary Table, as seen from the Orca tool_\n\nThe Custom Action _9BED75AC_30E3_4BB1_9F26_1A4F247F32EF has Type 3590, which\nindicates combinations of the type and relevant option.\n\n\n-----\n\n[Type 6: Indicates VBScript stored within the Binary Table.](https://learn.microsoft.com/en-us/windows/win32/msi/custom-action-type-6)\n\n[Optional Term +3584: Indicates a scheduled execution after the successful completion of](https://learn.microsoft.com/en-us/windows/win32/msi/custom-action-in-script-execution-options)\nInstallFinalize action.\n\nWith further investigation on Custom Action _C212458FE5F810E2D8287472A14C2665, the\nVBScript appears to execute dropped module (1.dll) from Component\nC__FEAF4022223844D1906F79DF588CDB8A via regsvr32.exe.\n\n_VBScript_ __C212458FE5F810E2D8287472A14C2665_\n\nThe second Custom Action DIRCA_TARGETDIR configures the installation directory in the\ndesignated subdirectory (ProductName) of the local AppData directory (LocalAppDataFolder).\nThe Product Name in this case has been named (SetupTest) as designated in the Property\nTable. As a result, DIRCA_TARGETDIR action configures the installation directory as\n(C:\\Users\\<UserName>\\AppData\\Local\\SetupTest).\n\n_Output folder path for installed file(s)_\n\nFrom inspecting the MSI, it is evident that the malware drops a module (1.dll) onto the\nsubdirectory (SetupTest) of the local appdata directory, which executes it by calling the\nVBScript embedded in the Binary table.\n\n\n-----\n\n_QBot Attack Tree, as seen from the Cybereason platform_\n\n_Qbot MSI infection flow_\n\n### Comparative Chart\n\nThe following chart identifies key points seen in each malware’s MSI behavior introduced in\nthis chapter.\n\n\nTechniques in-use Magniber\nRansomware\n\n\nMatanBuchus\nLoader\n\n\nQbot\n\n\nSet installation directory to\nLocalAppDataFolder\n\n\n✔️ ✔️ ✔️\n\n\nDump files to installation directory\n✔️\n\n\n✔️\n\n\nCustom Action: Execute executable via\nspecified command line\n\n\n✔️\n\n\n-----\n\nCustom Action: Execute PE/script stored in\nBinary Table\n\nExecute dumped file in the installation\ndirectory\n\n\n✔️ ✔️\n\n✔️ ✔️\n\n\nFake error message ✔️\n\n\nContinuous malicious execution regardless of\nMSI failure.\n\n_Comparative Chart_\n\n## Purple Team\n\n\n✔️ ✔️\n\n\nThis chapter focuses on key points for possibly identifying a malicious MSI, as well as a tool\nwhich can assist defenders to analyze the MSI files, which has already been leveraged in the\nBlue Team section.\n\n### Suspicious Indicators\n\nThere are three malicious indicators that can identify suspicious MSI files:\n\n1. Mismatch between file detail and digital signature\n2. Misleading errors\n\n3. Suspicious installation path\n\n\n-----\n\n_Checkpoints_\n\n**Mismatch in File Detail and Digital Signature**\n\nMSI files often masquerade as legitimate installation software of well known applications.\nHowever, the digital signature for the MSI file does not match with the issuing author, as\nshown in the images below. Mismatches between the description or origin of an MSI file and\nthe digital signature can indicate the file is actually malicious, especially when it purports to be\nfrom a well-known software vendor.\n\nMagniber Ransomware\n\n_Mismatch between the file information and the digital signature_\n\nMatanBuchus Loader\n\n_Mismatch between the file information and the digital signature_\n\n**Misleading Errors**\n\nMany different types of malware are known to trick victims in various ways. For malware that\nutilizes MSI, it is seen to output false error messages either by embedding a script or crashing\nthe installation. The error message is designed to trick victims into thinking the software\n\n\n-----\n\ninstallation was not successful because the installer or their environment was not configured\nproperly. The false error outputs can indicate malicious activity.\n\n_Possible error messages_\n\n**Suspicious Installation Path**\n\nOften, the purpose of an MSI is to install software and drop relevant applications onto a disk.\nHowever, when the root destination directory for the installation is set to the local AppData\nfolder, this can indicate malicious behavior. Legitimate installations usually drop necessary\nfiles under C:\\Program Files or C:\\Program Files (x86).\n\n_Installation directory configuration_\n\n[In the above image, the malware drops “installation” files into the subfolder (ProductName) of](https://learn.microsoft.com/en-us/windows/win32/msi/productname)\n[the local AppData folder (LocalAppDataFolder).](https://learn.microsoft.com/en-us/windows/win32/msi/localappdatafolder)\n\n### Tools\n\nThere are tools defenders can use to analyze MSI files. This section introduces some of the\ntools and demonstrates their usage.\n\n**Msitools**\n\nMsitools are a set of tools that allow developers to create and inspect MSI files. However, the\ntools can be also used by defenders to analyze malicious MSI files. There are three main\nMsitools that defenders can use: msiinfo, msidump, and msidiff. These tools are commandline-based, which makes them easier to automate and include in a malware analysis pipeline.\n\n**Msiinfo**\n\nMsiinfo is a command-line tool that allows users to list and extract streams or tables stored in\nthe MSI file.\n\n\n-----\n\nAs an example, an analyst investigates the relevant MSI file 15f4cfd.msi (Qbot) by executing\nthe streams command-line option and identifies a binary stored in the Binary Table. In order to\ninvestigate Binary._C212458FE5F810E2D8287472A14C2665, the analyst can dump this\nbinary stream by utilizing the extract command-line option.\n\n_Output streams with msiinfo_\n\n**Msidump**\n\nMsidump is also another command-line tool that dumps relevant tables as idt text and streams\nstored in an MSI file. The investigative method and use is similar to msiinfo.\n\nOutput streams with msidump\n\n**Msidiff**\n\nMsidiff is a command-line tool that compares two MSI files by diffing each sample. For\nexample, an analyst may compare two different installers for its validity using msidiff. To verify\nif the two installers are installing and dumping the same files, the analyst can use commandline option -l to list and compare the files likely to be dumped.\n\n\n-----\n\n_List of files from msidiff, from the QBot example_\n\n**Oledump.py**\n\n[Oledump.py is a python script created by Didier Stevens that’s mainly utilized to analyze OLE](https://blog.didierstevens.com/programs/oledump-py/)\ndocuments. Since OLE documents are COM Structured Storage, this Python script allows\ndefenders to analyze the MSI file as well.\n\n_Oledump.py showing streams from 15f4cfd.msi_\n\nEach row consists of the following three columns:\n\n1. Stream Number\n2. Stream Size\n\n3. Stream Name\n\nIn most cases, when utilizing MSI file with oledump.py, the stream name is usually\nincomprehensible, as shown in the image above.\n\n\n-----\n\n_Oledump.py showing stream 4 detail_\n\nBy specifying the stream number with “-s” option, the oledump.py dumps the content of the\nstream. In the image above, the stream 4 has file header MSCF, which is a header for a CAB\nfile.\n\n**ORCA**\n\nORCA is a GUI-based Windows SDK component that allows users to edit and view MSI\ndatabase tables. An analyst can open the MSI file in question and navigate to each table to\ninvestigate. The GUI makes the process of investigation simpler since it is visually easier to\nfollow.\n\n_Orca showing CustomAction table_\n\n## Recommendations\n\nThe Cybereason GSOC recommends the following actions to detect and respond to malicious\nMSI attacks:\n\n\n-----\n\nIn the Cybereason platform, enable both the Signature and Artificial Intelligence modes\non the Cybereason NGAV, and enable the Detect and Prevent modes of these features.\nHandle files originating from external sources (email, web browsing) with caution.\n[Contact a Cybereason Defender. The Cybereason MDR team provides custom hunting](https://www.cybereason.com/company/contact-us)\nqueries for detecting specific threats. To find out more about threat hunting and\n[managed detection and response with the Cybereason Defense Platform, see](https://www.cybereason.com/platform) Managed\nDetection and Response.\nIf you are a Cybereason customer, see the NEST for more information, including custom\nhunting queries for detecting this threat.\n\nCybereason is dedicated to teaming with Defenders to end cyber attacks from endpoints to\n[the enterprise to everywhere. Learn more about Cybereason XDR, check out our](https://www.cybereason.com/platform/xdr) Extended\nDetection and Response (XDR) Toolkit, or [schedule a demo today to learn how your](https://www.cybereason.com/request-a-demo)\n[organization can benefit from an operation-centric approach to security.](https://www.cybereason.com/blog/the-cybereason-malop-achieving-operation-centric-security)\n\n### About The Researchers\n\nKotaro Ogino, Principal Security Analyst, Cybereason Global SOC\n\nKotaro Ogino is a Principal Security Analyst with the Cybereason Global SOC team. He is\ninvolved in threat hunting, administration of Security Orchestration, Automation, and\nResponse (SOAR) systems, and Extended Detection and Response (XDR). Kotaro holds a\nbachelor of science degree in information and computer science.\n\nRalph Villanueva, Senior Security Analyst, Cybereason Global SOC\n\nRalph Villanueva is a Senior Security Analyst with the Cybereason Global SOC team. He\nworks hunting and combating emerging threats in the cybersecurity space. His interests\ninclude malware reverse engineering, digital forensics, and studying APTs. He earned his\nMaster’s Degree in Network Security from Florida International University\n\n\n-----\n\nRobin Plumer, Security Analyst, Cybereason Global SOC\n\nRobin Plumer is a Security Analyst with the Cybereason Global SOC team. He analyzes and\ntriages malware operations and researches new and emerging threats. He earned his\nBachelor’s degree in cybersecurity management from Bournemouth University, UK.\n\nAbout the Author\n\n**Cybereason Global SOC Team**\n\nThe Cybereason Global SOC Team delivers 24/7 Managed Detection and Response services\nto customers on every continent. Led by cybersecurity experts with experience working for\ngovernment, the military and multiple industry verticals, the Cybereason Global SOC Team\ncontinuously hunts for the most sophisticated and pervasive threats to support our mission to\nend cyberattacks on the endpoint, across the enterprise, and everywhere the battle moves.\n\n\n-----\n\n[All Posts by Cybereason Global SOC Team](https://www.cybereason.com/blog/authors/cybereason-global-soc-team)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-12-05 - Threat Analysis- MSI - Masquerading as a Software Installer.pdf"
    ],
    "report_names": [
        "2022-12-05 - Threat Analysis- MSI - Masquerading as a Software Installer.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d9b39228-0d9d-4c1e-8e39-2de986120060",
            "created_at": "2023-01-06T13:46:39.293127Z",
            "updated_at": "2025-03-27T02:00:03.042341Z",
            "deleted_at": null,
            "main_name": "BelialDemon",
            "aliases": [
                "Matanbuchus"
            ],
            "source_name": "MISPGALAXY:BelialDemon",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535887,
    "ts_updated_at": 1743041820,
    "ts_creation_date": 1672273441,
    "ts_modification_date": 1672273441,
    "files": {
        "pdf": "https://archive.orkl.eu/867d15e216f8cbe819cf683b4461363d5c8eb9a0.pdf",
        "text": "https://archive.orkl.eu/867d15e216f8cbe819cf683b4461363d5c8eb9a0.txt",
        "img": "https://archive.orkl.eu/867d15e216f8cbe819cf683b4461363d5c8eb9a0.jpg"
    }
}