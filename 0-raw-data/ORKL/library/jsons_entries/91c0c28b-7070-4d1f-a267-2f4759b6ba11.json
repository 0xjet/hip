{
    "id": "91c0c28b-7070-4d1f-a267-2f4759b6ba11",
    "created_at": "2023-01-12T15:00:35.040219Z",
    "updated_at": "2025-03-27T02:10:49.391277Z",
    "deleted_at": null,
    "sha1_hash": "4fa957acf3fec9afb669d6c117ffa7c2e1a783c6",
    "title": "2020-11-02 - CSS-JS Steganography in Fake Flash Player Update Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T19:33:17Z",
    "file_modification_date": "2022-05-28T19:33:17Z",
    "file_size": 2646622,
    "plain_text": "# Sucuri Blog\n\n**[blog.sucuri.net/2020/11/css-js-steganography-in-fake-flash-player-update-malware.html](https://blog.sucuri.net/2020/11/css-js-steganography-in-fake-flash-player-update-malware.html)**\n\nDenis Sinegubko November 2, 2020\n\nThis summer, MalwareBytes researcher Jérôme Segura wrote an article about how criminals\nuse image files (.ico) to hide JavaScript credit card stealers on compromised e-commerce\nsites.\n\nIn a tweet, Affable Kraut also reported another similar obfuscation technique using .ico files\nto conceal JavaScript skimmers.\n\n[Just something I’ve noticed more recently with digital skimmers/#magecart.](https://twitter.com/hashtag/magecart?src=hash&ref_src=twsrc%5Etfw)\nObfuscated code that has a weird google-analytics[.]com URL in it, which is the proper\nGoogle controlled domain. But there’s some extra characters, which are strange, so\n[let’s see what’s actually going on pic.twitter.com/fk0dCh1dET](https://t.co/fk0dCh1dET)\n\n— Affable Kraut (@AffableKraut) [May 15, 2020](https://twitter.com/AffableKraut/status/1261157021027622912?ref_src=twsrc%5Etfw)\n\nFrom the sample in his tweet, the “www.google-analytics.com URL is clearly visible within\nthe malicious script. However, this script was only used as a dictionary of characters to build\na URL for the real payload (priangan[.]com/wp-content/languages/blogid/favicon.ico and\n**lebs[.]site/favicon.ico in other variations).**\n\n## Steganography in CSS\n\nBoth of these two cases conceal malware within real, benign files — a technique referred to\nas steganography.\n\n\n-----\n\nDuring a recent investigation this October, we came across another interesting variant\nleveraging the same technique. Instead of loading .ico files and extracting JavaScript from\nthe EXIF data, however, the malware was found nestled within a .css file.\n\nThe script, which was almost identical to the one found in Affable Kraut’s tweet, had been\ninjected at the bottom of the .js files wp-includes/js/wp-emoji-release.min.js, wpincludes/js/jquery/jquery.js, and at the top of index.php as seen below.\n\nInfected index.php\nThis time, the //static.xx.fbcdn.net[.]com/plrhg URL was easily seen in plain text.\n\nThe string visually resembles a real URL used by Facebook: //static.xx.fbcdn.net. However,\nin reality the static.xx.fbcdn.net[.]com (with extra .com) does not even exist. It’s presence\nserves as a red herring: it’s real purpose is to provide a character dictionary to build the real\nmalicious URL, which this script tries to load via XMLHttpRequest:\n“//polobear[.]shop/fonts.css\n\nSince .css is just a text file, how can someone conceal malicious code in it? This part of the\ninjected script explains it:\n\n\n-----\n\nCSS to JavaScript algorithm\nThe algorithm takes the part after the last “}” in the requested .css, splits it into pieces\nseparated by spaces, and then uses those pieces to construct binary representation of\ncharacter codes, converting them to real characters using the fromCharCode function.\n\nThis method essentially constructs the JavaScript function character by character, which is\nthen executed once the whole file is processed.\n\n## Demonstration of How It Works\n\nTo further illustrate this example, let’s review the fonts.css file containing the malicious\npayload:\n\n\n-----\n\nContents of polobear[.]shop/fonts.cssAt first glance, there really doesn’t appear to be\nanything suspicious here. Just some benign CSS rules.\nThere are, however, many empty lines at the bottom of the file. Very many. 56,964 empty\nlines! And the size of this small fonts.css file is about 150 Kilobytes!\n\nEmpty lines are normally ignored by browsers and CSS parsers. While strange, this is still\nabsolutely benign in normal circumstances. However we know that this malware uses the file\nnot as CSS but as a source of a JavaScript code — and its binary representation is\nconcealed by sequences of tab and non-tab characters.\n\n## Revealing the Code\n\n\n-----\n\nIf we select the empty lines after the last **} character in a text editor, another story is**\nrevealed:\n\nSelecting invisible contents in text editor\n[Looks like Morse code with sequences of dots and dashes, doesn’t it?](https://en.wikipedia.org/wiki/Morse_code)\n\nWhen reviewed in hex, it appears like this:\n\n\n-----\n\nHex view of fonts.css\nHere you can explicitly see that the lines are not that empty. They consist of sequences of\ntabs (09), spaces (20) and line feeds (0A).\n\nIn these sequences, spaces work as delimiters between individual bytes (characters). Tabs\nand line feeds form binary representations of characters, where tab is 1 and line feed is 0.\n\nFor example, the first encrypted character after the last “}” is 09-09-09-0A-09-09, which can\nbe converted to the binary “111011”. This is equal to decimal 59, which is the character code\nfor “;” (semicolon).\n\n## Converting Empty Lines to JavaScript Code\n\nUsing this algorithm, we decoded all the 56,964 lines and got 20,233 bytes of this malicious\nJavaScript code:\n\n\n-----\n\nResult of conversion of empty lines to JavaScript code\nInteresting — it’s the same WiseLoop JS Obfuscation that is found in EXIF metadata of .ico\nfiles used by web skimmers! In this case, however, it didn’t turn out to be a credit card\nskimmer.\n\n## Fake Flash Player updates\n\nHere’s the decoded version of the script:\n\nDecoded script obtained from fonts.css\nWhat the decoded script does is create an iframe from lopiax[.]us with a fake Flash Player\nupdate recommendation.\n\n\n-----\n\nFake Flash Player update notification\nWhile Flash player is reaching end of life on December 31, 2020 and all major browsers will\nstop supporting it in a couple months, Flash Player updates are still quite a popular lure for\nsocial engineering attacks that trick people into installing malware on their computers.\n\nThis particular popup seems to be related to what MalwareBytes calls the Domen social\nengineering kit.\n\nThe only way to get rid of this popup is to click on the Update button. This initiates a\ndownload of the adobeflpl_installer.zip file with an HTA file with VB script that uses\nPowerShell to download malicious .exe and .dll files (including the NetSupport RAT).\n\nThe download link changes quite often, pointing to malicious files on various compromised\nsites.\n\n[The zip files also change in size, but are still reliably detected by many antiviruses.](https://www.virustotal.com/gui/file/d29aa1d0f6a4b1348cf4f4965b13c1d2db21c1d7962f44fbcaa60a5fe098e789/detection)\n\n\n-----\n\nVirusTotal detections\n\n## Revelations of the polobear[.]shop Site\n\nThis malware is not a leftover from some old attack. It’s pretty recent because the domain\n**polobear[.]shop was registered just a few weeks ago on October 9th, 2020.**\n\nThe site is not properly protected, and we can see directories and files hosted there.\n\n\n-----\n\nFile listing on polobear[.]shopIn the /tmp/active directory, you can see IP addresses of\ncomputers attacked by this malware in real time. Around 5-10 new IPs are typically listed\nevery few seconds.\n\n\n-----\n\nIPs of attacked computers\n\n## Important files\n\n**Generate.php**\n\nThe generate.php file is responsible for the generation of JavaScript code which attackers\ninject into compromised websites.\n\n\n-----\n\ngenerate.php\nThe script’s interface shows that the generated code has been defined to work for the\n**polobear[.]shop domain.**\n\nAttackers can choose a version with or without the “Anti-Debug” feature. As an Anti-Debug\nmechanism, the script puts the main functionality into the requestAnimationFrame function\ncallback.\n\nThe CSS-JS name tells us that the script was specifically designed to work with CSS files as\nthe source of JS payload.\n\nOn every load of the generate.php script, variable names randomly change — leaving the\nremaining parts of the code intact.\n\n**Gate.php**\n\n\n-----\n\n**Gate.php is a common name for data exfiltration scripts used by web skimmers. In this case,**\nhowever, this is the file that generates the fonts.css response with a payload concealed by\ntabs, spaces and line feeds.\n\nMost likely this is accomplished by an .htaccess rule for .css files, since fonts.css is not\npresent in the file list. Moreover, when a request to fonts.css files is considered unwanted\nby the malware, a “The requested URL was not found on this server” page with a 200\nresponse code is displayed — instead of the 404 that you get for any other types of really\nnonexistent pages on the site.\n\n**GeoIP.dat (1).zip**\n\nAccording to the timestamp found on the /index page, the first file uploaded to the site was\n**GeoIP.dat (1).zip. This occurred on October 9th, 2020 — the same date the**\n**polobear[.]shop domain was registered.**\n\nThe zip archive contains three files: geoip.inc, GeoIP.dat (both created on Sept 3, 2020)\nand index.php (Oct 1, 2020). The first two files belong to a GeoIP library which helps identify\nthe geographic origin of the requests.\n\nThe index.php file is more interesting, though. It’s a boilerplate script for fake Flash Player\nupdate attacks. The script checks to ensure that a visitor is not a bot and comes from an\neligible country (in this file it’s: USA, Italy, Germany, UK and Canada).\n\nIf the user agent and geographic location match the success criteria, then a web page is\ndisplayed with the Flash Player update warning.\n\nCode that generates fake Flash Player Update warnings\nActual download links are not present in the file. These must be specified by the attacker\nwhenever they prepare a new download location. Most likely, something similar currently\nworks on the lopiax.us site.\n\n## 162.0.235[.]12 Server\n\nAt this moment, polobear[.]shop is hosted on the server IP 162.0.235[.]12 which belongs to\nNamecheap Inc.\n\n\n-----\n\n[A quick search shows that this IP address is associated with multiple phishing sites:](https://urlscan.io/ip/162.0.235.12)\n\nLast seen domains hosted on 162.0.235[.]12We found a number of active phishing sites\ntargeting many popular platforms:\n\nPayPal: tierretyr[.]live and Pp-login-alert[.]com.\nDocusign: dorcsign[.]cloud, Doscug[.]live.\nBanking sites: www.ehb-onlinebank[.]ml, halifax-alerts[.]com, ing-app-nl[.]me.\n\nA [hacker admin panel also exists on hxxps://techvita[.]biz/PL341/panel/admin.php](https://urlscan.io/result/4b317f3c-2e54-45fe-805e-07d837beddb8/)\n(located on the same server).\n\n**Techvita[.]biz has also been found receiving requests from Windows malware (with**\ndetections by Azorult, Lokibot and GuLoader signatures), as seen in this JoeSandbox\nreport.\n\n## Conclusion\n\nMultiple types of web malware (including web skimmers and social engineering malware\ndroppers) have recently started using this same 3-step approach to obfuscation in their\nattacks.\n\nTo begin, attackers inject an obfuscated script into a compromised environment. Next, the\nmalicious script loads a seemingly benign file from a remote third-party website — for\nexample, an ICO or CSS file. An obfuscated malicious payload concealed within the\ninconspicuous file is then extracted at whim.\n\nOne distinctive trait of this approach is that the obfuscation algorithms used for each step are\nvery specific and stay the same — regardless of the type of the attack. This suggests that\nattackers are using the same toolkit containing steganography features to hide the malicious\nbehavior of their injections.\n\n\n-----\n\nFront-end scripts like the one described for generate.php clearly demonstrate that they were\ncreated to be used by an unlimited number of users. The script allows any bad actors to\neasily incorporate their payload into an attack by installing it on their own domain, without\nmaking any changes to the code — we can assume this feature allows for easy monetization\nand distribution of the malicious toolkit.\n\nAs attackers continue to look for ways to automate their malware campaigns and avoid\ndetection, it’s likely that we may see even more attacks using similar steganographyobfuscation approaches.\n\nFor site owners it doesn’t change much though. They should keep their site software up-todate, employ [website security best practices, and leverage integrity monitoring to detect](https://sucuri.net/guides/website-security/)\nunwanted changes.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-02 - CSS-JS Steganography in Fake Flash Player Update Malware.pdf"
    ],
    "report_names": [
        "2020-11-02 - CSS-JS Steganography in Fake Flash Player Update Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "8670f370-1865-4264-9a1b-0dfe7617c329",
            "created_at": "2022-10-25T16:07:23.69953Z",
            "updated_at": "2025-03-27T02:02:09.929725Z",
            "deleted_at": null,
            "main_name": "Hades",
            "aliases": [
                "Operation TrickyMouse"
            ],
            "source_name": "ETDA:Hades",
            "tools": [
                "Brave Prince",
                "Gold Dragon",
                "GoldDragon",
                "Lovexxx",
                "Olympic Destroyer",
                "Running RAT",
                "RunningRAT",
                "SOURGRAPE",
                "running_rat"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "6c4f98b3-fe14-42d6-beaa-866395455e52",
            "created_at": "2023-01-06T13:46:39.169554Z",
            "updated_at": "2025-03-27T02:00:03.011739Z",
            "deleted_at": null,
            "main_name": "Evil Corp",
            "aliases": [
                "GOLD DRAKE"
            ],
            "source_name": "MISPGALAXY:Evil Corp",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "50068c14-343c-4491-b568-df41dd59551c",
            "created_at": "2022-10-25T15:50:23.253218Z",
            "updated_at": "2025-03-27T02:00:55.408128Z",
            "deleted_at": null,
            "main_name": "Indrik Spider",
            "aliases": [
                "Indrik Spider",
                "Evil Corp",
                "Manatee Tempest",
                "DEV-0243",
                "UNC2165"
            ],
            "source_name": "MITRE:Indrik Spider",
            "tools": [
                "Mimikatz",
                "PsExec",
                "Dridex",
                "WastedLocker",
                "BitPaymer",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "5a0483f5-09b3-4673-bb5a-56d41eaf91ed",
            "created_at": "2023-01-06T13:46:38.814104Z",
            "updated_at": "2025-03-27T02:00:02.925972Z",
            "deleted_at": null,
            "main_name": "MageCart",
            "aliases": [],
            "source_name": "MISPGALAXY:MageCart",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9806f226-935f-48eb-b138-6616c9bb9d69",
            "created_at": "2022-10-25T16:07:23.73153Z",
            "updated_at": "2025-03-27T02:02:09.950784Z",
            "deleted_at": null,
            "main_name": "Indrik Spider",
            "aliases": [
                "Blue Lelantos",
                "DEV-0243",
                "Evil Corp",
                "Gold Drake",
                "Gold Winter",
                "Manatee Tempest",
                "UNC2165"
            ],
            "source_name": "ETDA:Indrik Spider",
            "tools": [
                "Advanced Port Scanner",
                "Agentemis",
                "Babuk",
                "Babuk Locker",
                "Babyk",
                "BitPaymer",
                "Bugat",
                "Bugat v5",
                "Cobalt Strike",
                "CobaltStrike",
                "Cridex",
                "Dridex",
                "EmPyre",
                "EmpireProject",
                "FAKEUPDATES",
                "FakeUpdate",
                "Feodo",
                "FriedEx",
                "Hades",
                "IEncrypt",
                "LINK_MSIEXEC",
                "MEGAsync",
                "Macaw Locker",
                "Metasploit",
                "Mimikatz",
                "PayloadBIN",
                "Phoenix Locker",
                "PowerShell Empire",
                "PowerSploit",
                "PsExec",
                "QNAP-Worm",
                "Raspberry Robin",
                "RaspberryRobin",
                "SocGholish",
                "Vasa Locker",
                "WastedLoader",
                "WastedLocker",
                "cobeacon",
                "wp_encrypt"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535635,
    "ts_updated_at": 1743041449,
    "ts_creation_date": 1653766397,
    "ts_modification_date": 1653766397,
    "files": {
        "pdf": "https://archive.orkl.eu/4fa957acf3fec9afb669d6c117ffa7c2e1a783c6.pdf",
        "text": "https://archive.orkl.eu/4fa957acf3fec9afb669d6c117ffa7c2e1a783c6.txt",
        "img": "https://archive.orkl.eu/4fa957acf3fec9afb669d6c117ffa7c2e1a783c6.jpg"
    }
}