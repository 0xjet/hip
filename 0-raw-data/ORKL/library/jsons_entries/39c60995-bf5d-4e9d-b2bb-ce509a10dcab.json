{
    "id": "39c60995-bf5d-4e9d-b2bb-ce509a10dcab",
    "created_at": "2023-01-12T14:59:43.527875Z",
    "updated_at": "2025-03-27T02:17:11.237952Z",
    "deleted_at": null,
    "sha1_hash": "abf9545c947202625133a39ef232f572b9318e17",
    "title": "2017-08-13 - Analysis of APT28 hospitality malware (Part 2)",
    "authors": "",
    "file_creation_date": "2022-05-27T22:36:18Z",
    "file_modification_date": "2022-05-27T22:36:18Z",
    "file_size": 237013,
    "plain_text": "# Analysis of APT28 hospitality malware (Part 2)\n\n**blog.xpnsec.com/apt28-hospitality-malware-part-2/**\n\n[« Back to home](https://blog.xpnsec.com/)\nIn the [first part of this malware review, we looked at the VBA code used by APT28 to drop a](https://blog.xpnsec.com/apt28-hospitality-malware/)\nDLL onto the victims’ machine as part of their recently highlighted hospitality campaign.\n\nIn this post, we will look at the dropped file, and understand just what it does, and how we\ncan analyse it using IDA Pro.\n\nSo we know from the first post that we have a DLL, which is run using the following\ncommand:\n```\nrundll32.exe %APPDATA%\\user.dat,#1\n\n```\nLoading the extracted DLL into IDA, the first thing that we notice is that we have an exported\nfunction of `load with an ordinal of 1:`\n\nWe know from the rundll32.exe command that this will be our entry point, so we start our\nanalysis here.\n\nWithin the `load function, a number of strings are constructed on the stack in Unicode,`\nwhich when decoded look like this:\n\n\n-----\n\nInterestingly, one of the strings of `mvtband.dat closely matches with the C2 server`\nidentified by FireEye of `mvtband.net .`\n\nEntering the first function at address `10001000h, we see another Unicode string`\nconstructed on the stack of “Environment” before `RegOpenKeyExW is called to open a`\nhandle to `HKCU\\Environment .`\n\nNext a path is constructed of `%appdata%\\mrset.bat and written to the`\n```\nUserInitMprLogonScript registry value within HKCU\\Environment :\n\n```\n\n-----\n\n_Note: If we stop and look for other examples of malware using this technique, we can see a_\n_[number of related posts unsurprisingly pointing to other Sofacy malware droppers using the](https://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/Troj~Sofacy-B/detailed-analysis.aspx)_\n_same method._\n\nContinuing to the next function, we find what immediately appears to be a decryption loop,\nusing a fixed XOR key of 0x26:\n\n\n-----\n\nOne the bytes at this address are decrypted, the contents are written to\n```\n%appdata%\\mvtband.dat .\n\n```\nThis is a perfect opportunity to use IDAPython to recover the encrypted data. We know from\nthe disassembly that the loop runs for 0x7600 bytes, and XOR’s a byte at a time from the\naddress 0x10009B90 with a fixed key of 0x26. Translating this into IDAPython, we have the\nfollowing script:\n```\nv = \"\"\nbytes = idaapi.get_many_bytes(0x10009B90, 0x7600)\nfor i in range(0,len(bytes)):\n  v += chr(ord(bytes[i]) ^ 0x26)\nf = open(\"out.bin\", \"wb\")\nf.write(v)\nf.close()\n\n```\nOnce executed, this script will decrypt the contents of address `0x10009B90 and write the`\noutput to `out.bin .`\n\nAn initial review of the decrypted contents show that this is a PE32 DLL, and if we upload the\n[sample to VirusTotal we see that a matching sample was first seen on 17-07-2017 with a](https://virustotal.com/#/file/8c47961181d9929333628af20bdd750021e925f40065374e6b876e3b8afbba57/detection)\nname of `mvtband.dll and signatures matching Sofacy:`\n\n\n-----\n\nContinuing into the final function of this dropper, we find a similar decryption loop for a\ndifferent memory location and the same XOR key:\n\nRepurposing our above IDAPython script, we can extract the contents with the following:\n\n\n-----\n\n```\nv \nbytes = idaapi.get_many_bytes(0x10009B20, 0x6A)\nfor i in range(0,len(bytes)):\n  v += chr(ord(bytes[i]) ^ 0x26)\nf = open(\"out2.bin\", \"wb\")\nf.write(v)\nf.close()\n\n```\nReviewing the decrypted contents, we find the following:\n```\nset inst_pck = \"%appdata%\\mvtband.dat\"\nif NOT exist %inst_pck % (exit)\nstart rundll32.exe %inst_pck %,#1\n\n```\nThis simple .bat file is being used by the `UserInitMprLogonScript registry value on`\nreboot to launch the `mvtband.dat payload via rundll32.exe.`\n\nOnce the .bat file script is decrypted by the dropper, the contents are written to\n```\n%appdata%\\mrset.bat before being launched using CreateProcess .\n\n```\nAnd there we have it, APT28’s simple dropper and persistence malware, with a bit of\nIDAPython reversing thrown in. We see that this DLL functions to decrypt 2 embedded\npayloads, “mrset.bat” which is a BAT file executed by “UserInitMprLogonScript”, and\n“mvtband.dat” which is the main payload of the malware which is executed via rundll32.exe.\n\nSo what are the takeaways from this for our red-team engagements? Well first, we see that\nadversaries are now increasingly using rundll32.exe in malware campaigns, which allows a\npayload to be stored without a typical .exe extension. More importantly, this also gives\nmalware a better chance at being successfully executed within a restricted environment\nwhich whitelists Microsoft signed binaries.\n\nSecondly, we have `UserInitMprLogonScript being used for persistence to launch a .bat`\nfile as a GPO script. While certainly not unheard of, the use of a GPO value is less likely to\ndraw attention than say, adding a RUN key value, or adding a new schtask.\n\nHopefully this has been a good introduction to the APT28 dropper and how we can use\nIDAPython during a reversing exercise, and as always, comments and feedback are\nwelcome via the usual channels.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-08-13 - Analysis of APT28 hospitality malware (Part 2).pdf"
    ],
    "report_names": [
        "2017-08-13 - Analysis of APT28 hospitality malware (Part 2).pdf"
    ],
    "threat_actors": [
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535583,
    "ts_updated_at": 1743041831,
    "ts_creation_date": 1653690978,
    "ts_modification_date": 1653690978,
    "files": {
        "pdf": "https://archive.orkl.eu/abf9545c947202625133a39ef232f572b9318e17.pdf",
        "text": "https://archive.orkl.eu/abf9545c947202625133a39ef232f572b9318e17.txt",
        "img": "https://archive.orkl.eu/abf9545c947202625133a39ef232f572b9318e17.jpg"
    }
}