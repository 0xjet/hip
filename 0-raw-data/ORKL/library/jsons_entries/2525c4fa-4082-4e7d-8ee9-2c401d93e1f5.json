{
    "id": "2525c4fa-4082-4e7d-8ee9-2c401d93e1f5",
    "created_at": "2023-01-12T14:59:51.018029Z",
    "updated_at": "2025-03-27T02:16:26.33971Z",
    "deleted_at": null,
    "sha1_hash": "d8743403f938ae27e28b817aae83ad7c9f955ed6",
    "title": "2019-09-11 - Watchbog and the Importance of Patching",
    "authors": "",
    "file_creation_date": "2022-05-27T23:27:34Z",
    "file_modification_date": "2022-05-27T23:27:34Z",
    "file_size": 2767113,
    "plain_text": "# Watchbog and the Importance of Patching\n\n**blog.talosintelligence.com/2019/09/watchbog-patching.html**\n\n_By_ _[Luke DuCharme and](https://twitter.com/_nTr0py)_ _[Paul Lee.](https://twitter.com/paulleeio)_\n\n## What Happened?\n\nCisco Incident Response (CSIRS) recently responded to an incident involving the Watchbog [cryptomining botnet. The](https://blog.talosintelligence.com/2018/01/malicious-xmr-mining.html)\n[attackers were able to exploit CVE-2018-1000861 to gain a foothold and install the Watchbog malware on the affected](https://jenkins.io/security/advisory/2018-12-05/)\nsystems.\n\n\n-----\n\nThis Linux based malware relied heavily on Pastebin for command and control (C2) and operated openly. CSIRS\ngained an accurate understanding of the attacker's intentions and abilities on a customer's network by analyzing the\nvarious Pastebins. As the investigation progressed, CSIRS identified and de-obfuscated multiple pastes using artifacts\nleft on compromised hosts.\n\nThere were some attempts at obfuscation, such as base64 encoding URLs and Pastebins, but the attack was still\nrelatively simple to uncover - this attacker did not practice particularly strong operational security.\n\nThe attackers behind Watchbog claimed to be providing a service by identifying security vulnerabilities and aiding the\norganization by exploiting said weaknesses before any \"real\" hackers could do so. During the investigation, Cisco IR\nfound signs of hosts becoming a part of a separate botnet around the time of the Watchbog activity. This raises serious\ndoubts about the \"positive\" intentions of this adversary. Below is a message left on a compromised system by the\nadversary:\n\n## What does Watchbog do?\n\nThe Watchbog botnet mines Monero cryptocurrency for its owners. While researching our variant we came across a\n[post by Alibaba Cloud Security that provides some insights into Watchbog. This post coincided with our findings as we](https://www.alibabacloud.com/blog/return-of-watchbog-exploiting-jenkins-cve-2018-1000861_594798)\nfound an installation script that performs the following activities.\n\nFirst the installation script checks for running processes matching other cryptocurrency miners. If the system was\npreviously configured to mine cryptocurrency, the installation script would terminate their execution using the kill\ncommand:\n\n\n-----\n\nThe script then uses the touch command to determine its capability to write to various directories on the filesystem.\n\nIt also checks the architecture of the system to determine if it is executing on a 32-bit or 64-bit operating system and\n[then makes three attempts to download and install a 'kerberods' dropper using wget or curl.](https://www.securityweek.com/jenkins-vulnerability-exploited-deliver-kerberods-malware)\n\nDepending on permissions, the kerberods dropper is saved to one of the following directories:\n\nThe current working directory\n/usr/bin\n/usr/libexec\n/usr/local/bin\n/tmp\n/usr/sbin\n\n\n-----\n\nThe script also retrieves the contents of a Pastebin URL containing a Monero wallet ID and mining information. CSIRS\nverified this as the same wallet ID as the one used by the attacker referenced in the Alibaba cloud post referenced\nearlier.\n\nThough the Pastebin URL in the previous screenshot is no longer accessible, the next step in the infection process is to\ndownload the cryptocurrency miner. We identified a script that 'kerberods' likely runs to reach out to GitHub to install the\n[XMR-Stak Monero miner.](https://github.com/fireice-uk/xmr-stak)\n\nThe main part of the script checks to see if a process called 'watchbog' is running.\n\nIf the 'watchbog' process is not detected, the 'testa' or 'download' functions are called to install the version of the miner\nthat's compatible with the host operating system and architecture and execute it to begin the mining process.\n\n\n-----\n\n### Testa function\n\nAs previously mentioned, the 'testa' function may be called to facilitate the infection process. Below is the code\nassociated with this function. This code is responsible for writing the various configuration data used by the mining\nsoftware. The function declares three variables and assigns base64 encoded data to each of them.\n\nThe base64 encoded data is then decoded and written to various files.\n\nThe base64 encoded values correspond to the following:\n\nSt_64: This variable contains the URL of the Github repository that hosts the XMR-Stak mining client.\n\nhXXps://github[.]com/fireice-uk/xmr-stak/releases/download/2.10.3/xmr-stak-linux-2.10.3-cpu.tar.xz\n\ncon_url: This variable contains the Pastebin URL that is used to host the configuration file for the mining client.\n\nhXXps://pastebin[.]com/raw/YJH8sWr\n\nCpu_url: This variable contains an additional Pastebin URL. During our investigation the Pastebin URL was no\nlonger accessible, but likely contains an additional configuration file to be used by the mining client.\n\nhXXps://pastebin[.]com/raw/irzk5mSh\n\npoo_url:This variable contains an additional Pastebin URL. During our investigation the Pastebin URL was no\nlonger accessible, but likely contains an additional configuration file to be used by the mining client.\n\nhXXps://pastebin[.]com/raw/aJkbTx6Y\n\nThe script then starts the Watchbog process and deletes the text file after downloading the encoded Pastebins as a text\nfile and giving it execution permissions. The following screenshot shows the configuration file that is referenced by the\ncon url variable in the 'testa' function\n\n\n-----\n\n### 'download' function\n\nThe following code is associated with the 'download' function referenced by the installation script previously described.\nSimilar to what was described in the 'testa' function, it contains three declared variables with base64 encoded\nassignments.\n\nThese base64 encoded strings correspond to the following:\n\nmi_64: This variable contains the Github URL that hosts the XMrig monero mining client.\n\nhXXps://github[.]com/xmrig/xmrig/releases/download/v2.14.1/xmrig-2.14.1-xenial-x64.tar.gz\n\nmi_32: This variable contains a Pixeldrain URL. During our investigation the URL was no longer accessible.\n\nhXXps://pixeldrain[.]com/api/file/ZuVWceWG\n\nder_ke: This variable contains a Pastebin URL. The URL was used to host a file containing the attacker(s)\nMonero Wallet ID for the miner to use. This Wallet ID is used to facilitate payment to the attacker. All Monero\nsuccessfully mined by clients under the attacker's control will transfer the Monero to the Wallet ID specified in this\nfile. The same wallet is included in the Alibaba Cloud post mentioned earlier.\n\nhXXps://pastebin[.]com/raw/hURdMBLd\n\n\n-----\n\nThe download function then writes the contents retrieved from the specified URLs to various file locations. It then\ndetermines the architecture of the system and installs the appropriate mining client and executes it to initiate the mining\nprocess.\n\nThe following screenshot contains the contents of the Monero wallet configuration associated with the der_ke variable\nin the 'download' function described earlier. It specifies the configuration parameters that will be used by the mining\nclient, including the Wallet ID, mining pool URL, and other parameters that can be used to control CPU usage, logging,\netc.\n\n\n-----\n\n## Lateral movement via SSH\n\nCSIRS identified that the adversary was using SSH to spread laterally. Although local logs were unavailable, we were\nable to use network logs to gain an understanding of how the malware was spreading. As we viewed the logs, it was\neasy to determine Watchbog's lateral movement mechanism because they were generating a large amount of SSH\ntraffic. This could have been easily detected using internal traffic flow monitoring, such as with StealthWatch Cloud or\nother netflow-monitoring capability.\n\nThe following Bash script was used to facilitate the lateral movement process. It retrieves the contents of the\nknown_hosts file on the infected system and then attempts to SSH into those systems. It also checks for the existence\nof SSH keys and leverages them to authenticate to the systems in the known_hosts file. If successful, it will retrieve the\ncontents of the Pastebin URL previously described and initiate the infection process.\n\n## Lateral movement via Jenkins and Redis servers\n\nIn addition to leveraging SSH for lateral movement, the Watchbog adversary also attempted to leverage a Python script\n\n\n-----\n\nthat scans for open Jenkins and Redis ports on the host s subnet. If the script finds any vulnerable servers, it attempts\nto use the curl or wget commands to retrieve a payload from Pastebin and execute it on the target.\n\nBased on the following string on line 71, the script targets CVE-2018-1000861, a vulnerability in the Staple web\nframework for versions up to Jenkins 2.138.1 or 2.145 which handles HTTP requests. It can provide attackers with RCE\n[through particularly crafted URLs. A post by Orange Tsai shows how to exploit this vulnerability by using cross](https://devco.re/blog/2019/01/16/hacking-Jenkins-part1-play-with-dynamic-routing-en/)\nreference objects to bypass ACL policy.\n\nThough the pastes accessed in the script were no longer available, we believe the payload was the installation script\nfor the XMR-Stak miner previously described. The following Python script is also downloaded and executed from the\nXMR-Stak miner script described above in a function called 'party.'\n\nAs can be seen above, the payload variable contains a base64 encoded blob which is then decoded and written to the\n/tmp directory and executes it. This base64 encoded blob contains a Pastebin URL\n(hXXps://pastebin[.]com/raw/DzgYb9mu) which was used to host the following Python script. The Python script is used\nto facilitate the exploitation of the aforementioned vulnerability and initiate the infection process. The following\nscreenshots are associated with this Python script.\n\n\n-----\n\n-----\n\n## Persistence\n\nWatchbog's main persistence mechanism appears to have been using cron jobs. Below is the 'system' function from the\n'kerberods' installation script which ensures the dropper will call out to Pastebins every hour for new information. The\nbelow screenshot shows the way that Watchbog configures the cron jobs responsible for achieving persistence on\ninfected systems.\n\n\n-----\n\nIn a post by Renato Marinho from Morphus Labs, he mentions a very interesting way 'kerberods' achieves persistence\nas well. If it has root privileges, it will download and load a library into the operating system which hooks parts of Glibc\nto modify Glibc's behavior. The post also specifies that the hooks allow the miner to run as anyone (including root) and\nalso obfuscates the network connection to the mining pool as well as the Redis/Jenkins server scans.\n\n## Covering their tracks\n\nEvidence deletion has been identified in previous Watchbog variants. The Watchbog variant in our incident continued\nthis trend. Evidence deletion was performed in a clear manner with files and logs being deleted or overwritten. The\nevidence deletion was typically added to the end of a handful of the Pastebin scripts, with the Xmr-stak download and\nthe SSH Lateral Movement scripts being prime examples. The loss of those key pieces of evidence made analysis\ndifficult, but not impossible. We were able to rely upon our clients centralized logging to fill in those holes, and the hosts\nthemselves still had evidence. The most obvious being the malware variants themselves.\n\n## Conclusion\n\nUnpatched web applications vulnerable to known CVEs are a major target for attackers. Adversaries can leverage the\nvulnerability to gain a foothold into the web server and network environment in which the web server is deployed. Once\nthat foothold has been established, the attacker can then connect to their C2, achieve persistent long-term access to\nthe environment and spread laterally — which is exactly what happened in this case. The best way to prevent such\nactivity would be to ensure that all enterprise web applications are up to date. Patching can cause some operational\ngaps and delays, so it’s also important to have a maintenance window and a test environment to ensure that the new\npatches do not cause any issues. Identifying cryptomining activity can be done effectively by following security\nfundamentals. Establish a baseline for internal network traffic and if any significant deviations occur, identify and\ninvestigate them. Even if there is an existing theory for the activity. In this case, Watchbog generated a noticeable spike\nin the organization’s SSH traffic.\n\n## Coverage\n\n[Intrusion prevention systems such as SNORT® provide an effective tool to detect China Chopper activity due to](https://snort.org/)\nspecific signatures present at the end of each command. In addition to intrusion prevention systems, it is advisable to\n[employ endpoint detection and response tools (EDR) such as Cisco AMP for Endpoints, which gives users the ability to](https://www.cisco.com/c/en/us/products/security/amp-for-endpoints/index.html)\ntrack process invocation and inspect processes. Try AMP for free [here.](https://cisco.com/go/tryamp)\n\nAdditional ways our customers can detect and block these threats are listed below.\n\n\n-----\n\n[Cisco Cloud Web Security (CWS) orWeb Security Appliance (WSA) web scanning prevents access to malicious](https://www.cisco.com/c/en/us/products/security/cloud-web-security/index.html)\nwebsites and detects malware used in these attacks.\n\n[Email Security can block malicious emails sent by threat actors as part of their campaign.](https://www.cisco.com/c/en/us/products/security/email-security-appliance/index.html)\n\n[Network Security appliances such asNext-Generation Firewall (NGFW), Next-Generation Intrusion Prevention System](https://www.cisco.com/c/en/us/products/security/firewalls/index.html)\n[(NGIPS), and Meraki MX can detect malicious activity associated with this threat.](https://meraki.cisco.com/products/appliances)\n\n[AMP Threat Grid helps identify malicious binaries and build protection into all Cisco Security products.](https://www.cisco.com/c/en/us/solutions/enterprise-networks/amp-threat-grid/index.html)\n\n[Umbrella, our secure internet gateway (SIG), blocks users from connecting to malicious domains, IPs, and URLs,](https://umbrella.cisco.com/)\nwhether users are on or off the corporate network.\n\nOpen Source SNORTⓇ Subscriber Rule Set customers can stay up to date by downloading the latest rule pack\n[available for purchase on Snort.org.](https://www.snort.org/products)\n\n## Indicators of Compromise (IOCs)\n\nThe following IOCs have been observed associated with Watchbog.\n\n### Hashes (SHA256):\n\nb383d0fdfa5036ccfa5d9c2b43cbfd814bce8778978873057b86678e5295fc61\n0b0567c9b45ea0a3ea4267001f0760ccdf2b8224fceaf8979d32fcceb2d6fb7a\n\n3A6271A90D0F6CC8A2D31D45D931E8401F13F7377932BA07D871DC42F252B9CA\n\n### Domains:\n\naziplcr72qjhzvin[.]onion[.]to\n\n### Misc:\n\nMonero Wallet (Same wallet as the Alibaba Cloud Post)\n\n47k2wdnyyBoMT6N9ho5Y7uQg1J6gPsTboKP6JXfB5msf3jUUvTfEceK5U7KLnWir5VZPKgUVxpkXnJLmijau3VZ8D2zsyL7\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-09-11 - Watchbog and the Importance of Patching.pdf"
    ],
    "report_names": [
        "2019-09-11 - Watchbog and the Importance of Patching.pdf"
    ],
    "threat_actors": [
        {
            "id": "eb3f4e4d-2573-494d-9739-1be5141cf7b2",
            "created_at": "2022-10-25T16:07:24.471018Z",
            "updated_at": "2025-03-27T02:02:10.24394Z",
            "deleted_at": null,
            "main_name": "Cron",
            "aliases": [],
            "source_name": "ETDA:Cron",
            "tools": [
                "Catelites",
                "Catelites Bot",
                "CronBot",
                "TinyZBot"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aacd5cbc-604b-4b6e-9e58-ef96c5d1a784",
            "created_at": "2023-01-06T13:46:38.953463Z",
            "updated_at": "2025-03-27T02:00:02.961301Z",
            "deleted_at": null,
            "main_name": "APT31",
            "aliases": [
                "JUDGMENT PANDA",
                "BRONZE VINEWOOD",
                "Red keres",
                "Violet Typhoon",
                "TA412"
            ],
            "source_name": "MISPGALAXY:APT31",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3fff98c9-ad02-401d-9d4b-f78b5b634f31",
            "created_at": "2023-01-06T13:46:38.376868Z",
            "updated_at": "2025-03-27T02:00:02.818071Z",
            "deleted_at": null,
            "main_name": "Cleaver",
            "aliases": [
                "Cobalt Gypsy",
                "G0003",
                "Operation Cleaver",
                "Op Cleaver",
                "Tarh Andishan",
                "Alibaba",
                "TG-2889"
            ],
            "source_name": "MISPGALAXY:Cleaver",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "774f15f7-832e-4cd4-a1fa-ec6a838f2a40",
            "created_at": "2022-10-25T16:47:55.641406Z",
            "updated_at": "2025-03-27T02:05:17.29791Z",
            "deleted_at": null,
            "main_name": "BRONZE VINEWOOD",
            "aliases": [
                "Judgment Panda ",
                "ZIRCONIUM ",
                "APT31 "
            ],
            "source_name": "Secureworks:BRONZE VINEWOOD",
            "tools": [
                " HanaLoader",
                " Metasploit",
                " Mimikatz",
                " Reverse ICMP shell",
                " Trochilus",
                "DropboxAES RAT"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "dc7ee503-9494-4fb6-a678-440c68fd31d8",
            "created_at": "2022-10-25T16:07:23.349177Z",
            "updated_at": "2025-03-27T02:02:09.748159Z",
            "deleted_at": null,
            "main_name": "APT 31",
            "aliases": [
                "APT 31",
                "Bronze Vinewood",
                "Judgment Panda",
                "Red Keres",
                "RedBravo",
                "TA412",
                "Violet Typhoon",
                "Zirconium"
            ],
            "source_name": "ETDA:APT 31",
            "tools": [
                "9002 RAT",
                "Agent.dhwf",
                "AngryRebel",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "GrewApacha",
                "HOMEUNIX",
                "HiKit",
                "HidraQ",
                "Homux",
                "Hydraq",
                "Kaba",
                "Korplug",
                "McRAT",
                "MdmBot",
                "Moudour",
                "Mydoor",
                "PCRat",
                "PlugX",
                "RedDelta",
                "Roarur",
                "Sakula",
                "Sakula RAT",
                "Sakurel",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Trochilus RAT",
                "Xamtrav"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535591,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653694054,
    "ts_modification_date": 1653694054,
    "files": {
        "pdf": "https://archive.orkl.eu/d8743403f938ae27e28b817aae83ad7c9f955ed6.pdf",
        "text": "https://archive.orkl.eu/d8743403f938ae27e28b817aae83ad7c9f955ed6.txt",
        "img": "https://archive.orkl.eu/d8743403f938ae27e28b817aae83ad7c9f955ed6.jpg"
    }
}