{
    "id": "59fa9e62-8071-4f18-add2-e3b8ce956b75",
    "created_at": "2023-01-12T14:59:43.056131Z",
    "updated_at": "2025-03-27T02:06:12.406629Z",
    "deleted_at": null,
    "sha1_hash": "c61768e95f85f79918d2a0f952c71a207d4baa70",
    "title": "2019-11-12 - Reversing Qakbot",
    "authors": "",
    "file_creation_date": "2022-05-28T17:36:51Z",
    "file_modification_date": "2022-05-28T17:36:51Z",
    "file_size": 905921,
    "plain_text": "# Blog.\n\n**hatching.io/blog/reversing-qakbot**\n\n2019-11-12\n\ntriage\n\nmalware\n\nsandbox\n\nbanker\n\nWritten by\n\nMarkel Picado (d00rt)\n\n## Summary\n\n\n-----\n\nQbot or Qakbot is a sophisticated worm with banking capabilities. This malware family has\nbeen infecting computers since 2009, utilizing a number of techniques (some of them quite\nadvanced) which make it difficult to detect. It has a packing layer, anti-VM techniques, antidebug techniques, and anti-sandbox techniques which make the analysis of this threat\ndifficult. Qakbot is capable of updating itself and this also makes this threat more complex to\ndetect since it is constantly changing on disk.\n\nUsing Triage we analyzed the most recent variant of this malware, and we added a new\nmodule to support the detection and configuration extraction of Qakbot samples as shown in\n[the image below. A tool to deobfuscate the Qakbot payload is also included qakbuscator.py.](https://hatching.io/static/files/qakbuscator.py)\n\n**Qakbot family detection in Hatching Triage**\n\n\n-----\n\n**Qakbot config extraction Hatching Triage**\n\n## Unpacking process\n\nQakbot has a custom packer. There are probably other versions of Qakbot in the wild with\ndifferent packers, but this section is based on analysis of the packer for the sample:\n```\ne736cf964b998e582fd2c191a0c9865814b632a315435f80798dd2a239a5e5f5 .\n\n```\nIn summary, the unpacking process is as follows:\n\n\n-----\n\n**The unpacking process**\n\nThe packer allocates memory and then drops an encrypted buffer there (Step 1-2).\n\nThe dropped buffer is decrypted and the decrypted data contains a PE file (Step 3). This PE\nfile is not at the beginning of the buffer but starts at offset `0x427 . From the beginning to the`\nPE file offset is filled with `0x00 bytes.`\n\n**Offset is filled with `0x00` bytes**\n\nThis could be a trick to make analysts think that this function is “freeing memory” or that it’s a\nmemset-like function.\n\nThe PE header is modified - this can also confuse analysts or memory dumping tools that look\nfor PE file signatures since they can’t find the “MZ” magic number. This is shown in the image\nbelow.\n\n\n-----\n\n**Modified PE header**\n\nThe decrypted PE file image size is calculated to allocate memory for it. The PE file is copied\n(mapped as a windows loader would do) from the decrypted buffer to the newly allocated\nmemory (Step 3-4).\n\n**The PE is copied over**\n\n**Mapping file to Allocated Memory**\n\n\n-----\n\nOnce the file is mapped to the newly allocated memory, the header is fixed as shown in the\nfollowing image. Once the PE file is mapped its entry point is called. (Step 4)\n\n**Calling the entry point**\n\nThis PE is going to read the rest of the previous decrypted buffer since there is still some\nencrypted data. Once the data is decrypted a new PE file can be found. (Step 4-5)\n\n**The new PE file**\n\nThis time the header is also modified and is fixed before mapping it. (Step 5-6)\n\n\n-----\n\n**New PE file with new header**\n\nThe decrypted PE is Qakbot itself. In this case the PE header doesn’t have the well-known\nstring “This program cannot be run in DOS mode”, because the DOS-Stub was deleted.\n\nThis PE file is the final payload of Qakbot so finally the PE file is mapped to the\nImageBaseAddress of the original file (Step 6).\n\nThe original image loaded at address `0x400000 is wiped.`\n\n**The address 0x400000 is wiped**\n\nThe newly unpacked PE (Qakbot) is copied to the original image base address `0x400000 .`\n\n\n-----\n\n**Qakbot copied over to 0x400000**\n\nSo, after mapping the Qakbot binary the execution flow goes to the EntryPoint of this file.\n**(Step 7).**\n\nThe unpacked sample hash of the file we ran in Triage:\n\n```\n850ff92b7f3badda4bd4eca0a54fbdea410667db1ea27db8069337bf451078d1\n\n```\n\n**Overview**\n\n## Obfuscation\n\n\n-----\n\nOnce the sample is unpacked, Qakbot itself also implements an obfuscation layer in its code.\nThis obfuscation makes the analysis a bit harder. The flow graph of the main function is the\nfollowing:\n\n**Qakbot's obfuscation**\n\nThe obfuscation basically consists of adding unused loops with an empty body. Like the\nfollowing:\n\n\n-----\n\n**Unused loops**\n\nAs is shown in the image above, it does a “XOR EAX, EAX” operation and then decides to\nloop or not depending on the Z flag which is set with the previous instruction (so the loop will\nnever happen). The goal of these small loops is to make a less comprehensive flow graph and\nto make the analysis harder. There are more than 600 loops like this throughout the code.\n\n[At Hatching, we implemented a tool qakbuscator.py to deobfuscate the code and make the](https://hatching.io/static/files/qakbuscator.py%3E)\nanalysis much easier. This tool is provided with this analysis to allow all researchers to use it.\n\n**Qakbot's deobfuscated**\n\nThe DLLs that are in the Qakbot resources also have this obfuscation layer - you can use the\nscript to deobfuscate them.\n\n\n-----\n\n## Behavioral analysis\n\nThe sample used to perform the behavioral analysis is the deobfuscated sample using our\ndeobfuscator tool explained in the previous section.\n\nSAMPLE: `3bd468d29868bb3f198530ef2426668efe30a8330bf3835a4f3a941d534ef2df`\n\nThis is how a process tree of a Qakbot infection looks like:\n\n**Process tree after Qakbot infection**\n\nRegardless of the input vector, the first time Qakbot runs it tries to install itself.\n\n### Anti-VM/Anti-analysis tricks\n\nFirst of all, it checks if it is running in a virtualized environment or not. Qakbot executes itself\nwith the option `\"/C\" . Qakbot admits parameters, in this case the parameter` `\"/C\" is to`\nmake anti-VM and anti-sandbox checks like the following ones:\n\nReading from the virtual port in order to detect VMWare\n\n**VMWare detection**\n\nCheck the CPUID\n\n\n-----\n\n**CPUID check**\n\nThere are also other techniques used by Qakbot to know if it is running in an emulated\nenvironment like checking the sample name - in order to see if it is set to some default name\nlike “sample.exe” or “malware.exe”; or checking running processes in order to detect any\nrelated to a virtual environments, anti-virus, debuggers etc.\n\nAmong the different options that Qakbot accepts we can find the following:\n\n**Accepted parameters** **Description**\n\n/C Anti-VM checks\n\n/I [name] Disable Windows SpyNey and delete scheduled task [name]\n\n/P[file] Decrypt [file] and load it\n\n/Q Set exit status to `0x6F`\n\n/T Sync related stuff\n\n/V Debug/Testing option\n\n/W Debug/Testing option\n\n/i [name] Install itself and delete scheduled task [name]\n\n/s Create service\n\n/t Send Window Message\n\n/A [1] [2] Unknown\n\n### Installation\n\nIf a VM is detected it exits. Otherwise, it copies itself into `%APPDATA% under a randomly`\ngenerated folder with a randomly generated name. Those names are unique for each infected\nmachine since they are created using some characteristics from infected host.\n\n\n-----\n\n**Copying to %APPDATA%**\n\nIt also creates the following registry key in order to be run when the system reboots\n**“HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run”.**\n\n**Run on system boot**\n\nAlso, it drops a `.dat file that has configuration information, like botnet name, timestamp, etc.`\nThis file contains encrypted data which is decrypted in memory during run time. Once this file\nis decrypted it looks like is shown in the image below.\n\n**Decrypted file**\n\n[The following table, from a blog post by the security researcher Vitaly Kremez (link), shows](https://www.vkremez.com/2018/07/lets-learn-in-depth-reversing-of-qakbot.html)\nthe meanings of some of these config values:\n\n**Qakbot Config**\n\n11 = 2 (number of hardcoded C2)\n\n1 = date of qbot install in HH:MM:ss-dd/mm/yyyy\n\n2 = victim qbot install\n\n45 = C2 IP\n\n\n-----\n\n**Qakbot Config**\n\n46 = C2 Port\n\n39 = victim external IP\n\n38 = last victim call to C2 (time in Unix)\n\n43 = time of record ((time in Unix)\n\n5 = victim network shares\n\nFinally, the copied file is executed and the original file is overwritten with `calc.exe . Some`\nmalware deletes the file directly, but Qakbot has decided to overwrite it with a legitimate\nbinary. This way it doesn’t leave traces.\n\n**Overwriting with legitimate binary**\n\nWhen Qakbot is installed, its behavior is different. In this case, it is going to create an instance\nof the `explorer.exe process in order to inject itself into it.`\n\nOnce injected into explorer, the main .dll is loaded. At this point, different things could happen\nsince the communication with the control panel begins. As shown in the process tree above,\nthe explorer process executes an update of Qakbot directly downloaded from the C&C. Also, it\ncan exfiltrate data, or infect browsers in order to get banking information from the victim\nsystem.\n\n[Qakbot update sample: https://tria.ge/reports/191104-athqk1tjxn/task2](https://tria.ge/reports/191104-athqk1tjxn/task2)\n\n## Triage\n\nIn Triage we’ve just added support for this family, meaning you can detect Qakbot as well as\nget its configuration directly after the analysis.\n\n\n-----\n\n**Qakbot in Triage**\n\n## Samples\n\n[The Triage report for the sample that was used for this blog can be found (here).](https://tria.ge/reports/191111-jzlt6rkwlj)\n\n**Sample state** **SHA256**\n\n\nPacked\nQakbot\n\n\ne736cf964b998e582fd2c191a0c9865814b632a315435f80798dd2a239a5e5f5\n\n\nQakbot 850ff92b7f3badda4bd4eca0a54fbdea410667db1ea27db8069337bf451078d1\n\n\nDeobfuscated\nQakbot\n\nQakbot\nresource 1\n(main.dll)\n\nDeobfuscated\nQakbot\nresource 1\n(main.dll)\n\nQakbot\nresource 2\n(injects dll\nx86)\n\n\n3bd468d29868bb3f198530ef2426668efe30a8330bf3835a4f3a941d534ef2df\n\n83273809a35ba26c2fb30cba58ba437004483ae754babad63c5d168113efa430\n\n74f8907acfd070d2590895523433a8c85b5ef87f4e1a5ef7ccd356f5562b7a6b\n\nb7d9a462bd105193e998b6324f3343b84f11ceb21ab24e60e2580a26d95e4494\n\n\n-----\n\n**Sample state** **SHA256**\n\n\nQakbot\nresource 3\n(injects dll\nx64)\n\n\n8c7a43002ee6105fc37fcdfc00a192239639f7c08bf28e06ca1432551fe21b3f\n\n\nHere is a list of related samples and their corresponding Triage reports.\n\n**SHA256** **Triage Report**\n\n\nf614a06748251107a34fa7e44c7652fd88\ne61fd958df724455e14ec88040abf9\n\n7d4d207fb5258f504d3f9ef60d431332d1\ne7320d5849c0b0acf624612b01c8f0\n\n357b4979324e2065adc8e6bd11cd7161f8\n30250cae30f50fb13edd70fd2b506b\n\n29754f0caa9576eba6b9c351d20549e7e1\n9216c6e72c2963da33450719a51277\n\n304a01a339d86ccbba7b1f671839624d44\n6e6ea86474912bf976837df779bad2\n\nd2f8a61e8cfc9a6c983fc40d2b7ac33e2a\n686872d0136dce2f66466c044f246c\n\n2b9ef4a9f47402d171eec28acadf3753cb\nb33c9bc6ec26d99aa060127a470e95\n\neb17935cf972d90be92c9b39fff8b3d760\necda78a6f602cb2b8bbaf3d87e6b61\n\n6b88260f4c4da4651a82bb62761cd23ee9\nad6662a2a0abbec017e7193668397b\n\n256967605423fea1e00368078eea1cdb52\nd391aa0091e0798db797ab337d1567\n\n\n1.bin\nhttps://tria.ge/reports/191111ypg95xvrwj_\n\n2.bin\nhttps://tria.ge/reports/191111mgrgp545yx_\n\n3.bin\nhttps://tria.ge/reports/191111sbsq7xbqea_\n\n4.bin\nhttps://tria.ge/reports/19111157yf3bdh4j_\n\n5.bin\nhttps://tria.ge/reports/19111138qmrk62q2_\n\n6.bin\nhttps://tria.ge/reports/191111p6cqne7cwn_\n\n7.bin\nhttps://tria.ge/reports/191111zl9l5y6lp2_\n\n8.bin\nhttps://tria.ge/reports/1911117tn19rbh9x_\n\n9.bin\nhttps://tria.ge/reports/191111hb6qpeaars_\n\n10.bin\nhttps://tria.ge/reports/191111m8tm8zqbrs_\n\n\n-----\n\n**SHA256** **Triage Report**\n\n\n13c2f4b6fb80500884a4ea9d2fe8077412\n4f46ebfd80de3e1dfcfb9e167aee08\n\n## References\n\n\n11.bin\nhttps://tria.ge/reports/1911117cpggrpxts_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-11-12 - Reversing Qakbot.pdf"
    ],
    "report_names": [
        "2019-11-12 - Reversing Qakbot.pdf"
    ],
    "threat_actors": [
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535583,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1653759411,
    "ts_modification_date": 1653759411,
    "files": {
        "pdf": "https://archive.orkl.eu/c61768e95f85f79918d2a0f952c71a207d4baa70.pdf",
        "text": "https://archive.orkl.eu/c61768e95f85f79918d2a0f952c71a207d4baa70.txt",
        "img": "https://archive.orkl.eu/c61768e95f85f79918d2a0f952c71a207d4baa70.jpg"
    }
}