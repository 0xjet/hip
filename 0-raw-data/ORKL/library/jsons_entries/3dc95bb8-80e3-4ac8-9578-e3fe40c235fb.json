{
    "id": "3dc95bb8-80e3-4ac8-9578-e3fe40c235fb",
    "created_at": "2023-01-12T15:02:03.132019Z",
    "updated_at": "2025-03-27T02:16:39.94449Z",
    "deleted_at": null,
    "sha1_hash": "31e64d06003bb13422a336e534270901edbd6360",
    "title": "2021-02-16 - Malvertiser “ScamClub” Bypasses Iframe Sandboxing With postMessage() Shenanigans [CVE-2021–1801]",
    "authors": "",
    "file_creation_date": "2022-05-28T19:52:45Z",
    "file_modification_date": "2022-05-28T19:52:45Z",
    "file_size": 1979664,
    "plain_text": "# Malvertiser “ScamClub” Bypasses Iframe Sandboxing With postMessage() Shenanigans [CVE-2021–1801]\n\n**blog.confiant.com/malvertiser-scamclub-bypasses-iframe-sandboxing-with-postmessage-shenanigans-cve-2021-1801-**\n1c998378bfba\n\nEliya Stein February 16, 2021\n\n[Eliya Stein](https://medium.com/@eliyastein?source=post_page-----1c998378bfba--------------------------------)\n[Follow](https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2c3f3d52c6be&operation=register&redirect=https%3A%2F%2Fblog.confiant.com%2Fmalvertiser-scamclub-bypasses-iframe-sandboxing-with-postmessage-shenanigans-cve-2021-1801-1c998378bfba&user=Eliya+Stein&userId=2c3f3d52c6be&source=post_page-2c3f3d52c6be----1c998378bfba---------------------follow_byline-----------)\nFeb 16, 2021\n\n\n5 min read\n\nStock Photo Via Unsplash.com\nThis blog post is about the mechanics of a long tail iframe sandbox bypass found in a\npayload belonging to the persistent malvertising attacker that we call ScamClub.\n\n## A Word About ScamClub\n\n\n-----\n\nActive for at least several years now, ScamClub malvertisements are defined mainly by\nforced redirections to scams that offer prizes to “lucky” users, like the all too ubiquitous\n“You’ve won a Walmart giftcard!” or “You’ve won an iPhone!” landing pages.\n\nFor example:\n\n\n-----\n\n-----\n\n-----\n\n-----\n\nScamClub campaigns have been covered by us in depth over the years, but a great\nreference if you need a refresher is this post from 2018:\n\n## Malvertising Attack Hijacks 300 Million Sessions Over 48 Hours\n\n### Nov 12th Malvertising Attack Serves Adult Content and Gift Card Scams\n\nblog.confiant.com\n\nOn the tactics side, this attacker historically favors what we refer to as a “bombardment”\nstrategy. Instead of trying to fly under the radar, they flood the ad tech ecosystem with tons of\nhorrendous demand well aware that the majority of it will be blocked by some kind of\ngatekeeping, but they do this at incredibly high volumes in the hopes that the small\npercentage that slips through will do significant damage.\n\n## The Payload\n\n\n-----\n\nA typical ScamClub payload has a few layers to it, starting with an ad tag that loads a\nmalicious CDN hosted dependency . This of course is usually obfuscated in absurd ways in\nattempt to evade url blocklists.\n\nHere’s a recent example:\n\nAs the payload unfurls to pull in additional layers, we are met with a mess of obfuscated\nnonsense that usually expands to thousands of lines of code — mostly decoy of course. A\nfull walkthrough of a ScamClub payload is beyond the scope of this blog post, but rather we\nwill focus on four lines of code that piqued our curiosity.\n\nHere they are recreated:\n```\nfunction receiveMessage(event) {             top.location.href =\n\"http://[malicious giftcard scam]\";        \n}window.addEventListener(\"message\", receiveMessage);\n\n```\nThe thing is, it’s very normal for malvertisers to spray a bunch of redirect attempts in a single\npayload that try to do the redirect in different ways. It’s not uncommon to see a multilayered\ntry catch statement try multiple top level redirects, pop-ups, etc.\n\nThe reason some attackers chose to do this is because they have partial control at best\nwhen it comes to what device or platform the payload is running on, and they want to\nmaximize their monetization opportunity as best they can.\n\nFor example, one browser version might block redirect attempts from cross-origin frames,\nwhile the prior version lets them through, so they try all of the things including known\nbypasses that might have since been patched.\n\nHowever, none of this explains the event listener… or does it?\n\nWe investigate by eliminating the noise and stage a simple html file that implements a crossorigin sandboxed frame and a button that dispatches our event. (payload.html is our event\nlistener).\n```\n<iframe src=\"\" id='targ' sandbox=\"allow-forms allow-pointer-lock allow-popups-toescape-sandbox allow-popups allow-same-origin allow-scripts allow-top-navigation-byuser-activation\"></iframe>\n<script> \n function do_it(){    var wn = document.getElementsByTagName('iframe')\n[0].contentWindow;         wn.postMessage('Hello!', '*');  }do_it();\n</script><input id=\"clickMe\" type=\"button\" value=\"clickme\" onclick=\"do_it();\" />\n\n```\nThe `allow-top-navigation-by-user-activation` sandbox attribute, which is often lauded as one\nof the most vital tools in an anti-malvertising strategy should in theory prevent any redirection\nunless a proper activation takes place. Activation in this context typically means a tap or a\n\n\n-----\n\nclick inside the frame.\n\nThis means our proof of concept shouldn’t work under any circumstances. The clickMe\nbutton is outside of the sandboxed frame after all. However, if it does redirect, that means we\nhave a browser security bug on our hands, which turned out to be the case when tested on\nWebKit based browsers, namely Safari on desktop and iOS.\n\n## The Long Tail\n\nIf you’re following along, this is probably where you might shrug your shoulders and say “But\nso what? It’s not like these guys can place a clickable message dispatcher on the publisher\nsite outside of their ad frame!”\n\nThis is true, but that doesn’t mean the ScamClub event listener is a complete shot in the\ndark. In modern web applications, messages are flying around all the time, usually with\nwildcard destinations, often on user interaction.\n\nCombined with ScamClub’s large volumes and broad targeting that hits dozens of different\nwebsites, it’s all about the increased efficacy of spawning a successful redirect — even if\nwe’re talking about a single digit percentage increase, that can mean tens of thousands of\nimpacted impressions over the duration of a single campaign.\n\nScamClub was busy in January 2021\n\nOver the last 90 days, ScamClub has delivered over 50MM malicious impressions,\nmaintaining a low baseline of activity augmented by frequent manic bursts — with as\nmany as 16MM impacted ads being served in a single day\n\n\n-----\n\n## Disclosure Timeline\n\nJune 22, 2020 — Confiant Security Team observes event listeners in ScamClub redirect\npayload.\n\nJune 23, 2020 — Bug report submitted to Apple Security. Google Chrome team also notified\n(Chrome on iOS uses WebKit).\n\n[Dec 2, 2020 — Patched https://trac.webkit.org/changeset/270373/webkit](https://trac.webkit.org/changeset/270373/webkit)\n\nFeb 1, 2021 — CVE assigned and published as part of Apple’s security update:\n[https://support.apple.com/en-us/HT212147](https://support.apple.com/en-us/HT212147)\n\n## IOCs\n\nRecent IOCs are all available as STIX here:\n\n[https://github.com/WeAreConfiant/security/blob/master/stix-feeds/scamclub.stix.json](https://github.com/WeAreConfiant/security/blob/master/stix-feeds/scamclub.stix.json)\n\nS3 hosted JavaScript payloads:\n\n\n-----\n\n```\nxmou.s3.us east 2.amazonaws.com/mou.jsimpve.s3.amazonaws.com/create.jsdgoi.s3.us\neast-2.amazonaws.com/goi.jsyflx.s3.us-east-2.amazonaws.com/flx.jsmiil.s3.us-east2.amazonaws.com/iia.jsdjian.s3.amazonaws.com/jia.jsaimppv.s3.amazonaws.com/jiy.jsaylei\neast2.amazonaws.com/pan.jsdkjieg.s3.amazonaws.com/jieg.jsadlya.s3.amazonaws.com/lya.jsyddo\neast-2.amazonaws.com/xop.jsaqkol.s3.amazonaws.com/kol.jsimpvv.s3.us-east2.amazonaws.com/dsd.jsmqyuj.s3.amazonaws.com/yuj.jswpbgm.s3.amazonaws.com/bgm.jspzhufm\nap-southeast-1.amazonaws.com/lr.jskiyy.s3-ap-southeast1.amazonaws.com/ki.jsoummm.s3.amazonaws.com/ou.jsgsyyd.s3.amazonaws.com/gs.jsqqpm.s3.a\nap-southeast1.amazonaws.com/nx.jszpdk.s3.amazonaws.com/zp.jsmrptm.s3.amazonaws.com/mr.jsktzmy.s3ap-southeast-1.amazonaws.com/kt.jsnzdpy.s3-ap-southeast1.amazonaws.com/nz.jsvpydy.s3-ap-southeast-1.amazonaws.com/vp.j\n\n```\nDomains:\n```\ngoodluckpig.spacegoodluckman.spacegoodluckguy.spacegoodluckdog.spaceluckytub.xyzluckyg\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-16 - Malvertiser “ScamClub” Bypasses Iframe Sandboxing With postMessage() Shenanigans [CVE-2021–1801].pdf"
    ],
    "report_names": [
        "2021-02-16 - Malvertiser “ScamClub” Bypasses Iframe Sandboxing With postMessage() Shenanigans [CVE-2021–1801].pdf"
    ],
    "threat_actors": [
        {
            "id": "38d454f7-6689-443b-939e-062054a229b1",
            "created_at": "2023-12-03T02:00:05.152067Z",
            "updated_at": "2025-03-27T02:00:03.260302Z",
            "deleted_at": null,
            "main_name": "ScamClub",
            "aliases": [],
            "source_name": "MISPGALAXY:ScamClub",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2864e40a-f233-4618-ac61-b03760a41cbb",
            "created_at": "2023-12-01T02:02:34.272108Z",
            "updated_at": "2025-03-27T02:02:10.209072Z",
            "deleted_at": null,
            "main_name": "WildCard",
            "aliases": [],
            "source_name": "ETDA:WildCard",
            "tools": [
                "RustDown",
                "SysJoker"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "256a6a2d-e8a2-4497-b399-628a7fad4b3e",
            "created_at": "2023-11-30T02:00:07.299845Z",
            "updated_at": "2025-03-27T02:00:03.257794Z",
            "deleted_at": null,
            "main_name": "WildCard",
            "aliases": [],
            "source_name": "MISPGALAXY:WildCard",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535723,
    "ts_updated_at": 1743041799,
    "ts_creation_date": 1653767565,
    "ts_modification_date": 1653767565,
    "files": {
        "pdf": "https://archive.orkl.eu/31e64d06003bb13422a336e534270901edbd6360.pdf",
        "text": "https://archive.orkl.eu/31e64d06003bb13422a336e534270901edbd6360.txt",
        "img": "https://archive.orkl.eu/31e64d06003bb13422a336e534270901edbd6360.jpg"
    }
}