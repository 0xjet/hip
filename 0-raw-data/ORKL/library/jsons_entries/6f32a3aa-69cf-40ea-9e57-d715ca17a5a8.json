{
    "id": "6f32a3aa-69cf-40ea-9e57-d715ca17a5a8",
    "created_at": "2023-01-12T15:08:48.250755Z",
    "updated_at": "2025-03-27T02:05:52.91721Z",
    "deleted_at": null,
    "sha1_hash": "7c147ff9235725fc22fa497936cb588af433ae74",
    "title": "2012-04-20 - Analysis of DarkMegi aka NpcDark",
    "authors": "",
    "file_creation_date": "2022-05-28T03:55:28Z",
    "file_modification_date": "2022-05-28T03:55:28Z",
    "file_size": 1735100,
    "plain_text": "# Stop Malvertising\n\n**[stopmalvertising.com/rootkits/analysis-of-darkmegi-aka-npcdark.html](http://stopmalvertising.com/rootkits/analysis-of-darkmegi-aka-npcdark.html)**\n\nAnalysis of DarkMegi aka NpcDark\n\n[Written by Kimberly on Friday, 20 April 2012. Posted in Rootkits Viewed 6867 times](https://stopmalvertising.com/rootkits/)\n\nI’ve always been interested in rootkits and their removal. So it was no surprise that after\nreading the article about DarkMegi I tried to find the rootkit dropper. Two security\ncolleagues were kind enough to forward me a few samples.\n\n[According to the analysis performed by McAfee Labs, DarkMegi was the first known threat](http://blogs.mcafee.com/mcafee-labs/darkmegi-not-the-rootkit-youre-looking-for)\n[delivered through the CVE-2012-0003 - MIDI Remote Code Execution Vulnerability.](http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0003)\n[DarkMegi has also been distributed via the Gong Da Pack exploit kit and more recently via](http://www.kahusecurity.com/2012/chinese-pack-using-dadongs-jsxx-vip-script/)\nthe Blackhole Exploit kit.\n\nDarkMegi is complex and difficult to analyze; it involves more than just dropping a\nusermode component ( com32.dll) and a kernel driver (com32.sys) on the victim’s\ncomputer.\n\nUpon execution DarkMegiSample.exe, as we will name the file in the analysis, starts up an\ninstance of ipconfig.exe.\n\n[EXECUTION] \"c:\\windows\\system32\\ipconfig.exe\" was allowed to run\n\n[EXECUTION] Started by \"c:\\documents and settings\\kly\\desktop\\darkmegisample.exe\"\n\n[1160]\n\n[EXECUTION] Commandline - [ ipconfig.exe ]\n\nDarkMegiSample.exe then installs a service called Com32 and drops the kernel driver\ncom32.sys into the Drivers directory. At this stage, 9728 bytes have been written to the file.\n\n[DRIVER/SERVICE] c:\\documents and settings\\kly\\desktop\\darkmegisample.exe [1160]\nTried to install a driver/service named Com32\n\n\n-----\n\nDarkMegiSample.exe then creates a file called RCX1.tmp in the Drivers folder, copies the\ncurrent content of com32.sys to the file and appends a huge pile of junk data to RCX1.tmp\nso that the size of the file is 25.0 MB (26,224,256 bytes).\n\nThe file com32.sys is deleted and RCX1.tmp is renamed as com32.sys.\n\nThe kernel driver com32.sys contains a couple of interesting strings:\n\n0x00001757: 'H:\\RKTDOW~1\\RKTDRI~1\\RKTDRI~1\\objfre\\i386\\RktDriver.pdb'\n\n0x019021C4: 'The driver for the supercool driver-based tool'\n\n0x01902328: 'Supercool driver-based tool'\n\n0x0000062E: 'DosDevices\\NpcDark'\n\n0x0000060E: 'Device\\NpcDark'\n\n0x01902274: 'RktDriver.sys'\n\nDarkMegiSample.exe then drops the usermode component com32.dll, the file size is\n45,056 bytes upon creation. Similar to the driver, the dll will get a huge amount of junk\ndata appended so that the final file size becomes 30.0 MB (31,506,432 bytes). The file\ncom32.dll is deleted and RCX2.tmp is renamed as com32.dll.\n\n\n-----\n\nDarkMegiSample.exe launches an instance of rundll32.exe to load the freshly created\nusermode component com32.dll.\n\n[EXECUTION] \"c:\\windows\\system32\\rundll32.exe\" was blocked from running\n\n[EXECUTION] Started by \"c:\\documents and settings\\kly\\desktop\\darkmegisample.exe\"\n\n[1160]\n\n[EXECUTION] Commandline - [ c:\\windows\\system32\\rundll32.exe\nc:\\windows\\system32\\com32.dll getinterface ]\n\nDarkMegiSample.exe launches several hidden instances of Internet Explorer. The\nusermode component com32.dll is loaded under Internet Explorer too now.\n\n[EXECUTION] \"c:\\program files\\internet explorer\\iexplore.exe\" was allowed to run\n\n[EXECUTION] Started by \"c:\\documents and settings\\kly\\desktop\\darkmegisample.exe\"\n\n[1160]\n\n[EXECUTION] Commandline - [ \"c:\\program files\\internet explorer\\iexplore.exe\" ]\n\n[EXECUTION] \"c:\\program files\\internet explorer\\iexplore.exe\" was allowed to run\n\n[EXECUTION] Started by \"c:\\documents and settings\\kly\\desktop\\darkmegisample.exe\"\n\n[1844]\n\n[EXECUTION] Commandline - [ \"c:\\program files\\internet explorer\\iexplore.exe\" ]\n\nThe usermode component com32.dll contains a list of hardcoded DNS Servers and is\nmost likely able to download an updated version of the rootkit. Again we find a reference to\nNpcDark ... would the author be a fan of WOW (World of Warcraft)?\n\n\n-----\n\n8.8.8.8 - google-public-dns-a.google.com\n208.67.222.222 - resolver1.opendns.com\n165.87.201.244 - ns4.us.prserv.net\n209.166.160.36 - orion.dns.cc.stargate.net\n168.95.192.1 - hntp1.hinet.net\n\nInternet access is requested to download two files and contact what seems to be a stats\npage.\n\n20111230.exe is renamed as fuc6.tmp.exe\n20111230.jpg is renamed as fuc5.tmp\n\n\n-----\n\n[EXECUTION] c:\\program files\\internet explorer\\iexplore.exe was allowed to run\n\n[EXECUTION] Started by \"c:\\windows\\system32\\rundll32.exe\" [1968]\n\n[EXECUTION] Commandline - [ \"c:\\program files\\internet explorer\\iexplore.exe\"\nhttp://images.hananren.com/newd.htm ]\n\nThe domain images.hananren.com has been registered the 1st of July 2011 and as seen\nbelow the registrant details are totaly faked.\n\nimages.hananren.com - 70.39.69.236\n\n\n**Updated**\n**Date:**\n\n**Creation**\n**Date:**\n\n**Name**\n**Server:**\n\n**Name**\n**Server:**\n\n\n01-jul-2011\n\n01-jul-2011\n\nNS77.DOMAINCONTROL.COM\n\nNS78.DOMAINCONTROL.COM\n\n\n**Registrar:** GODADDY.COM, LLC\n\n\n-----\n\n**Registrant:** y3z1007 y3z1007\n\nThis e-mail address is being protected from spambots. You need\nJavaScript enabled to view it\n\nsdfsfsdfsdfsdf\n\nbenjing, beijing 101100\n\nChina\n\n1-380-013-8000\n\nDarkMegiSample.exe will now exit and delete itself. The file fuc6.tmp.exe is launched by\nrundll32.exe and will also delete itself after execution.\n\n[EXECUTION] \"c:\\windows\\system32\\cmd.exe\" was allowed to run\n\n[EXECUTION] Started by \"Unknown Process\" [2212]\n\n[EXECUTION] Commandline - [ c:\\windows\\system32\\cmd.exe /c del\n\"c:\\docume~1\\kly\\locals~1\\temp\\fuc6.tmp.exe\" ]\n\nIt's hard to tell what the purpose of fuc6.tmp.exe is via Process Monitor but we notice that\na randomly named file, VT2XT4d.tmp in our analysis, has been marked for deletion upon\nreboot.\n\nBoth cmd.exe and Internet Explorer will load another dll dropped by the rootkit:\nbdcapEx32.dll.\n\nAfter examining the strings in VT2XT4d.tmp I found out that this was actually a copy of\nimm32.dll. The file imm32.dll had been patched to load ... bdcapEx32.dll.\n\n\n-----\n\nThe file imm32.dll is loaded by a huge number of processes on the system.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2012/2012-04-20 - Analysis of DarkMegi aka NpcDark.pdf"
    ],
    "report_names": [
        "2012-04-20 - Analysis of DarkMegi aka NpcDark.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536128,
    "ts_updated_at": 1743041152,
    "ts_creation_date": 1653710128,
    "ts_modification_date": 1653710128,
    "files": {
        "pdf": "https://archive.orkl.eu/7c147ff9235725fc22fa497936cb588af433ae74.pdf",
        "text": "https://archive.orkl.eu/7c147ff9235725fc22fa497936cb588af433ae74.txt",
        "img": "https://archive.orkl.eu/7c147ff9235725fc22fa497936cb588af433ae74.jpg"
    }
}