{
    "id": "e873ad77-7086-4679-aaad-368981f794dc",
    "created_at": "2023-01-12T15:10:04.386163Z",
    "updated_at": "2025-03-27T02:08:40.919437Z",
    "deleted_at": null,
    "sha1_hash": "5209d2f4c80c4c3c324c68e8696606abd8a24cc4",
    "title": "2022-03-31 - Cloudy with a Chance of Unclear Mailbox Sync- CrowdStrike Services Identifies Logging Inconsistencies in Microsoft 365",
    "authors": "",
    "file_creation_date": "2022-05-28T18:27:18Z",
    "file_modification_date": "2022-05-28T18:27:18Z",
    "file_size": 1498181,
    "plain_text": "# CrowdStrike Services Identifies Microsoft 365 Logging Inconsistencies\n\n**[crowdstrike.com/blog/crowdstrike-services-identifies-logging-inconsistencies-in-microsoft-365/](https://www.crowdstrike.com/blog/crowdstrike-services-identifies-logging-inconsistencies-in-microsoft-365/)**\n\nChristopher Romano - Vaishnav Murthy March 31, 2022\n\nMultiple investigations and testing by the CrowdStrike Services team identified\ninconsistencies in Azure AD sign-in logs that incorrectly showed successful logins via\nInternet Mail Access Protocol (IMAP) despite it being blocked.\nInvestigators rely on these logs to determine threat actor activity in investigations that\noften involve legal and regulatory consequences for organizations.\nThis blog includes recommendations that should be implemented to block legacy\nauthentication in Microsoft 365 tenants to avoid a threat actor circumventing stronger\ncontrols such as multifactor authentication (MFA).\n\n## Background\n\nAs many organizations move to the cloud, CrowdStrike has noticed a significant increase in\nboth opportunistic and targeted attacks against cloud resources, with a large number of\nthese attacks targeting organizations’ Microsoft 365 (M365) infrastructure, often specifically\naround their business email service, or Exchange Online. In multiple investigations,\n[CrowdStrike has observed a logging inconsistency within the Azure AD sign-in events](https://www.humio.com/glossary/log-management/)\n\n\n-----\n\nrelated to mailbox access using legacy authentication protocols within M365. This article\nhighlights the inconsistency, shows how CrowdStrike was able to replicate it in a lab\nenvironment and provides recommendations on configuration settings to help organizations\nsecure their M365 environment.\n\nWhen investigating anomalous activity involving mailboxes in Exchange Online, CrowdStrike\ninvestigators look at a number of log sources, including the Unified Audit Log and Azure AD\nsign-in logs, to establish the scope of the activity. It is imperative for these log sources to\naccurately capture information, as they are relied on by investigators to determine threat\nactor activity in investigations that often involve legal and regulatory consequences for\norganizations.\n\n## Legacy Authentication Protocols\n\nInternet Mail Access Protocol (IMAP) and Post Office Protocol (POP) are authentication\nprotocols most widely used as part of legacy authentication to receive mail to mailboxes.\nThese protocols result in downloading a mailbox’s contents locally to the client from where\nthe authentication request was initiated. Hence, whenever these protocols are seen to be\nused in an investigation involving email compromise, an assumption is made that the entirety\nof the mailbox contents, which often include sensitive information, has been exfiltrated by the\nthreat actor. Simple Mail Transfer Protocol (SMTP) is an authentication protocol used as part\nof legacy authentication to send mail from mailboxes. A threat actor will leverage a\ncompromised account, permitting the SMTP legacy protocol to send massive amounts of\nspam or phishing emails to both internal and external users.\n\n## Tenant Configuration\n\nIn recent investigations, CrowdStrike has found a pattern of inaccurate logging in the Azure\nAD sign-in logs that seems to falsely indicate a mailbox sync via legacy authentication\nprotocols (IMAP or POP). This pattern appears to manifest in M365 tenants that: do not have\nlegacy authentication configured to be blocked via a conditional access policy (CAP); have\nPOP and IMAP blocked at an individual mailbox level; and have the SMTP authentication\nprotocol allowed at the mailbox level.\n\n### Inaccurate Azure AD Sign-in Logs \n\nIn Azure tenants with no CAP in place blocking legacy authentication, but with IMAP blocked\nat the Exchange Online mailbox level, CrowdStrike found that Azure AD sign-in logs showed\nsuccessful logins via an IMAP client application despite it being blocked at the mailbox level.\nThis logging pattern occurred when a third-party mail client, configured to use IMAP and\nSMTP, was used to authenticate into a mailbox. While the client was able to successfully\nsend an email via SMTP, it was not able to download mail to the local system via IMAP due\n\n\n-----\n\nto the mailbox-level block in place. In other words, the Azure AD log entry showing a\nsuccessful login via the IMAP protocol was inaccurate, as mail synchronization did not take\nplace.\n\n### Incorrect Authentication Flow Documentation \n\nIf the documented flow was followed, the authentication attempt should have been blocked\nprior to reaching Azure AD, and thus should not have been picked up by the Azure AD signin logs. However, as we show in the proof of concept (POC) section below, the authentication\nattempt is still logged in Azure AD sign-in logs, despite supposedly being blocked before\nreaching Azure AD.\n\nThis pattern of logging is inconsistent with the documented authentication flow from\nMicrosoft:\n\n_When it’s blocked, Basic authentication in Exchange Online is blocked at the first pre-_\n_authentication step (Step 1 in the previous diagrams) before the request reaches Azure_\n_Active Directory or the on-premises IdP. The benefit of this approach is brute force or_\n_password spray attacks won’t reach the IdP (which might trigger account lockouts due to_\n_incorrect login attempts)._\n\nFigure 1. Source: https://docs.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange\nonline/disable-basic-authentication-in-exchange-online\n\n## Recreating the Logging Inconsistency\n\nCrowdStrike set up a POC environment to demonstrate this logging inconsistency with a\nmailbox that had POP/IM AP disabled at the mailbox level, but SMTP authentication still\nallowed (see Figure 2).\n\n\n-----\n\nFigure 2 (Click to enlarge)\n\nThe POC environment did not have an Azure AD Conditional Access Policy that blocked\nlegacy authentication. CrowdStrike used Mozilla Thunderbird as a third-party mail client to\naccess the simulated victim’s mailbox with IMAP as the selected protocol, as shown in the\nscreenshot in Figure 3.\n\nFigure 3\n\nAuthentication using the given credentials was successful, but mail was not allowed to be\nsynced to the local client device, as seen in Figure 4.\n\n\n-----\n\nFigure 4\n\nHowever, Azure AD sign-in logs showed successful authentication using IMAP, as shown in\nthe screenshot below.\n\n\n-----\n\nFigure 5\n\nThe M365 Unified Audit Log also shows successful authentication via the BAV2ROPC user\nagent, indicating basic authentication was used (see Figure 6).\n\n\n-----\n\nFigure 6\n\nAs shown in CrowdStrike’s POC, the IMAP protocol authentication attempt was logged as\nsuccessful in the Azure AD sign-in log, but the victim’s mailbox was never successfully\nsynchronized or downloaded to the client machine. This inconsistency could lead a victim\norganization to inaccurately conclude that the contents of the affected mailbox had been\nexfiltrated by a threat actor, a scenario that often has regulatory and legal implications.\n\nAlso of note, Microsoft will be disabling POP and IMAP authentication to Exchange Online\n[beginning Oct. 1, 2022 per its announcement:](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/block-legacy-authentication)\n\n_Effective October 1, 2022, we will begin to permanently disable Basic Authentication for_\n_Exchange Online in all Microsoft 365 tenants regardless of usage, except for SMTP_\n_Authentication._\n\n## Recommendations to Prevent Legacy Authentication\n\nThe following are recommendations to prevent the usage of legacy authentication protocols.\nCrowdStrike recommends these actions to minimize the risk of a threat actor exploiting the\ninherent weakness in legacy authentication that would allow them to gain access to a\nmailbox.\n\nEnable and enforce a conditional access policy blocking access that uses legacy\nauthentication to all client applications. This block will ensure that authentication\nattempts to mailboxes using IMAP, POP or SMTP are blocked before reaching the\nmailbox.\n\n\n-----\n\nEnsure that basic authentication is disabled at the mailbox level, using the `Set-`\n```\n   CASMailbox PowerShell cmdlet at individual mailboxes, and tenant-wide using the\n   Set-AuthenticationPolicy and Set-TransportConfig cmdlets.\n\n```\n(See https://docs.microsoft.com/en-us/exchange/clients-and-mobile-in-exchangeonline/disable-basic-authentication-in-exchange-online)\nEnable MailItemsAccessed on all mailboxes. The `MailItemsAccessed operation as`\npart of Microsoft Advanced Auditing can assist investigators in validating whether a\ncertain mailbox has been downloaded offline to a threat actor-controlled system. This\noperation covers authentication from both legacy and modern authentication protocols,\nand records both sync (downloading actions) and bind (viewing actions). (See:\nhttps://docs.microsoft.com/en-us/microsoft-365/compliance/mailitemsaccessedforensics-investigations?view=M365-worldwide)\n\n## Conclusion\n\nCrowdStrike was able to demonstrate that in Azure tenants where IMAP/POP was blocked at\nthe Exchange Online mailbox level, but no CAPs were in place to block legacy\nauthentication, SMTP authentication attempts were incorrectly logged as logins via IMAP.\nThis logging pattern could lead to organizations erroneously concluding that the mailbox\ncontents had been downloaded to a client device controlled by a malicious third party, when\nin fact the settings in place would have blocked any download attempt.\n\nTo ensure that threats arising from legacy authentication are mitigated, CrowdStrike\nrecommends that organizations enable and enforce a CAP that blocks legacy authentication\nto all client applications; disable basic authentication at both the individual Exchange Online\nmailbox level as well as tenant-wide; and for better monitoring capabilities, enable the\nMailItemsAccessed operation on all Exchange Online mailboxes.\n\n**Additional Resources**\n\n_[Learn how the powerful CrowdStrike Falcon platform provides comprehensive](https://www.crowdstrike.com/endpoint-security-products/falcon-platform/)_\n_protection across your organization, workers and data, wherever they are located._\n_[Visit our Industry Recognition and Technology Validation webpage to see what industry](https://www.crowdstrike.com/why-crowdstrike/crowdstrike-industry-validation/)_\n_analysts are saying about CrowdStrike and the Falcon platform._\n_[Get a full-featured free trial of CrowdStrike Falcon Prevent™ and see for yourself how](https://www.crowdstrike.com/resources/free-trials/try-falcon-prevent/)_\n_true next-gen AV performs against today’s most sophisticated threats._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-31 - Cloudy with a Chance of Unclear Mailbox Sync- CrowdStrike Services Identifies Logging Inconsistencies in Microsoft 365.pdf"
    ],
    "report_names": [
        "2022-03-31 - Cloudy with a Chance of Unclear Mailbox Sync- CrowdStrike Services Identifies Logging Inconsistencies in Microsoft 365.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536204,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653762438,
    "ts_modification_date": 1653762438,
    "files": {
        "pdf": "https://archive.orkl.eu/5209d2f4c80c4c3c324c68e8696606abd8a24cc4.pdf",
        "text": "https://archive.orkl.eu/5209d2f4c80c4c3c324c68e8696606abd8a24cc4.txt",
        "img": "https://archive.orkl.eu/5209d2f4c80c4c3c324c68e8696606abd8a24cc4.jpg"
    }
}