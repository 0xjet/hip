{
    "id": "1e3de8ca-f6fd-487e-97fe-ed31b87d9086",
    "created_at": "2023-01-12T15:03:11.38574Z",
    "updated_at": "2025-03-27T02:06:15.025054Z",
    "deleted_at": null,
    "sha1_hash": "191459137d163d7e141559bf065a65d5e8cf703d",
    "title": "2017-09-29 - Ramnit – in-depth analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T17:43:55Z",
    "file_modification_date": "2022-05-28T17:43:55Z",
    "file_size": 721135,
    "plain_text": "# Ramnit – in-depth analysis | CERT Polska\n\n**cert.pl/en/news/single/ramnit-in-depth-analysis/**\n\nIf we look on Ramnit’s history, it’s hard to exactly pin down which malware family it actually\nbelongs to. One thing is certain, it’s not a new threat. It emerged in 2010, transferred by\nremovable drives within infected executables and HTML files.\n\nA year later, a more dangerous version was released. It contained a part of recently leaked\nZeus source code, which allowed Ramnit to become a banking trojan.\n\nThese days, it has become much more sophisticated by utilizing a number of malicious\nactivities including:\n\nPerforming Man-in-the-Browser attacks\nStealing FTP credentials and browser cookies\nUsing DGA (Domain Generation Algorithm) to find the C&C (Command and\nControl) server\nUsing privilege escalation\nAdding AV exceptions\nUploading screenshots of sensitive information\n\n\n-----\n\nDespite [Europol s shut down of 300 C&C servers in 2015, it s still going strong, recently](https://www.europol.europa.eu/newsroom/news/botnet-taken-down-through-international-law-enforcement-cooperation)\nbeing distributed by RIG EK via seamless gates.\n\n## Executable’s analysis\n\nThe main binary is packed like a matryoshka – a custom packing method first and then\nUPX.\n\nDespite being encrypted, extracting the binary from the packer is pretty straight-forward\n– all one needs to do is to set a breakpoint right after the binary decrypts the code and\nbefore it jumps into it.\n\n\n-----\n\nAnd if we now navigate to the newly unpacked code section we’ll find the binary right\nafter the loader assembly:\n\n\n-----\n\nThe unpacked binary (after UPX decompression) consists of 3 general functions:\n\nApplyExploit\nCheckBypassed\nstart\n## ApplyExploit\n\nIf the current user is not already an admin and the process is not running with admin\nprivileges it tries to perform privilege escalation.\n\n[Malware contains exploits for CVE-2013-3660 (patched in MS13-053) and](http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2013-3660) CVE-20144113 (patched in MS14-058) vulnerabilities, however before it actually tries to run the\npayload, registry checks are performed to make sure that the host system is indeed\nvulnerable to said CVEs:\n\nIf the exploits succeed or the program is already running with high privileges, a “TRUE”\nvalue is stored in a hardcoded random-looking registry key:\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\jfghdug_ooetvtgk, which is later used in the CheckBypassed\nfunction.\n\n## CheckBypassed\n\nThis function checks if previously mentioned registry key is set. If not and process has\nadmin privileges, updates it. Assuming the exploit has worked, Ramnit then adds\nregistry keys to evade Windows’ security systems detection (see Obfuscation/Evasion):\n\n## start routine\n\nThe routine coordinates ApplyExploit and CheckBypassed – if they both run\nsuccessfully it creates two svchost.exe processes and writes rmnsoft.dll and\nmodules.dll into them respectively.\n\nImportant detail: the binary executes CheckBypassed before ApplyExploit, so the\nbinary has to be executed again in order to make any further progress. This trick\noutsmarts many single-run malware analysis systems, such as Cuckoo.\n\n\n-----\n\n## Static config\n\nRamnit encrypts its network communication using RC4 algorithm. Key for RC4 and\nbotnet name are encrypted using xor with a hardcoded password.\n\nXOR encryption is pretty standard, the only catch is that it skips key’s first char and\nthen reverses the key.\n\nXOR function calls:\n\nCiphertext lengths are almost always too long and we have to rely on null termination:\n\nDGA config seems to be always declared at the beginning of the data section:\n\n\n-----\n\n## Persistence\n\nProgram copies itself into C:\\Users\\User\\AppData\\Roaming\\Microsoft\\Windows\\Start\nMenu\\Programs\\Startup\\.\n\n## DGA\n\nRamnit generates a list of domains by using a LCG algorithm with a hardcoded seed:\n\nGenerating a domain:\n\n\n-----\n\nDGA recreated in Python:\n\n## Communication\n\nRamnit connects to C&C servers through port 443, but don’t let that fool you – it\ndoesn’t use HTTPS, but its own protocol instead:\n\nPacket’s structure:\n\nChunks’ structures:\n\nSo if we’d like to send a packet containing some data, we would:\n\nencrypt large (>4bytes) chunk data using RC4 with a key recovered from the\nXOR decryption\ncreate packed chunks from data parts\nconcatenate all chunks together\nwrap the output in packet layer\nTraffic example:\n\n\n-----\n\nSome of available commands:\n\n**Command**\n\n\n**Byte**\n**Value** **Short Description**\n\n\nCOMMAND_OK 0x01 Server’s response that the command\nexecuted successfully\n\nGET_DNSCHANGER 0x11 Get DNS-changer payload\n\nGET_INJECTS 0x13 Get webinjects\n\nUPLOAD_COOKIES 0x15 Upload stolen cookies (zip format)\n\nGET_MODULE 0x21 Get a specific module\n\nGET_MODULE_LIST 0x23 Get a list of downloadable modules\n\nVERIFY_HOST 0x51 Check if the host is able to send a\nsigned message\n\nREGISTER_BOT 0xe2 Register bot (send two MD5s)\n\nUPLOAD_INFO_GET_COMMANDS 0xe8 Upload detailed machine info\n\n### Bot registration\n\nWhen a bot wants to register itself it sends two encrypted md5 hashes, the data\nstructure of which is following:\n\nPython code:\n\nIf C&C responds with a success packet (00ff0100000001), malware follows up with a\nempty 0x51 command. Signature from the response is verified using a hardcoded\npublic RSA key. If there is a mismatch – the execution stops.\n\n## Modules\n\nThe program can request a list of modules and then download each one individually:\n\n**Antivirus Trusted Module v2.0**\n\nAdds exceptions to a fixed list of anti-virus software (AVG Anti-Virus, BitDefender,\nAvast, ESET NOD32 Antivirus, Norton AntiVirus)\n\n**Chrome reinstall module (x64-x86) v0.1**\n\nUninstalls Google Chrome\n\nand installs it again:\n\n**Cookie Grabber v0 2 (no mask)**\n\n\n-----\n\nSteals cookies from various hardcoded locations and sends a zip with results to the\nC&C through rmnsoft.dll.\n\n**Hooker**\n\nUsed for performing Man-in-the-Browser attacks and hooking HTTP functions.\n\n## Webinjects\n\nWebinjects are a relatively new addition to Ramnit. They utilize a standard Zeus format:\n\n## Obfuscation / Evasion\n\nRamnit attempts to hide itself from Windows Defender by adding following registry\nvalues:\n\n‘NOPs’ are inserted in random functions, which makes them difficult to find using e.g.\nYara rule:\n\n## New variant\n\nDuring writing of this article we’ve noticed a variation of Ramnit called clickbideu in an\nItalian spam campaign.\n\nIts loader is completely different, but the communication module (rmnsoft.dll) has\nremained somewhat unchanged with only some minor differences:\n\nDGA cycles between 3 hardcoded TLDs instead of just one:\n\nPython implementation:\n\n\n-----\n\nAlso new version seems to be using different port – 8001, although we ve also seen\nusage of port 442.\n\nAdditionally, a different value (“fE4hNy1O”) is used for calculating the second md5.\n\n## Additional links\n\n IoCs\n\n Yara rules:\n\n Samples analyzed:\n\nMain PE\n\n92460d8ac1d1e9f155ef2ca6dd7abb417df8900a17e95157d4372a2c846e829f\nrmnsoft.dll\n\nbe2044fe6f0220dde12c51677f2ef4c45d9dea669073bd052695584e573629e0\nmodules.fll\n\n96a10e07d092f6f429672ce2ca66528aae19de872bda39249135a82477d27a83\nModule Antivirus Trusted Module v2.0 (AVG, Avast, Nod32, Norton, Bitdefender)\n\n975ed0f933d4a22ca631c5ab77c765cd46c48511d43326b066b4505c6dc911de\nModule Cookie Grabber v0.2 (no mask)\n\nbc977a0f455fc747a7868a7940aa98af10c91c4aae7598310de8b78132436bee\nModule Hooker\n\na88151b3bf825e26ded28f94addeada095d2cd13791b2153a9594b26d9cfb85e\n## Configs:\n\n Loader sha256:\n\nd290225dde1b18bf68c4c42e06638a61fb336c91a2c4e6dd007bcbe7327fcbae\nc2cae7d9ef91dfcc1ae8f542e0ac64ce66c526d5a4154241855020612d358ee8\n1f3fbca46a599b4f221ead7785606451365db45bbbc537ee0c4d019e8984d106\n9d723bb1dc375834ebb907271b83dffab44e98b82fa73da6267037f019e4bc83\nf3567e2b5fc521987f0dd79aff6f3b1328db8e03fa825c3c030080a8b5819564\n7689465ba010537b0c29cf18d32a25962bd1605b717733f5953eb1b1eb0a68c9\nf98ca50b7d07682ac359b97dd68eb924c4cbd825db72c1a132458e9bb765fa1e\n4b00b0ece480267af051e7907458381d8a9e8506c7da67b8a8e1d74d45773d68\n6ac47d82134385fa73386ff3cd7b2eb7008da2205b3f5af7b41fab45c63f9046\n6a1fc689d2ef32ee6288498f8a875c6dc880d7494f46c05d25d0e1f627984e8e\n522e935b91307b8c01e0ea8a724985f5b4e01227a761aeccb63b00f0d964f7e9\nb3e67b5ee899c53f90c9da772592a4709372192542e1297bbce4929a8e1d5c69\n71d92cc6dc9273d162a969960b1021e5f18cf39b2c48043e5c5e49db5a58d955\n\n\n-----\n\nda15c2a89334496910b6d966bf91fa25a1c9526c53796e06d166416abe7cf2f4\ne4353bda9692581ea9743165dfd843238c23bb92e24b778983de80e90ac650a3\n## DGA domains for analyzed configs:\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-09-29 - Ramnit – in-depth analysis.pdf"
    ],
    "report_names": [
        "2017-09-29 - Ramnit – in-depth analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535791,
    "ts_updated_at": 1743041175,
    "ts_creation_date": 1653759835,
    "ts_modification_date": 1653759835,
    "files": {
        "pdf": "https://archive.orkl.eu/191459137d163d7e141559bf065a65d5e8cf703d.pdf",
        "text": "https://archive.orkl.eu/191459137d163d7e141559bf065a65d5e8cf703d.txt",
        "img": "https://archive.orkl.eu/191459137d163d7e141559bf065a65d5e8cf703d.jpg"
    }
}