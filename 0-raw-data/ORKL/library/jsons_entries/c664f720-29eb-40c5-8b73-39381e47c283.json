{
    "id": "c664f720-29eb-40c5-8b73-39381e47c283",
    "created_at": "2023-01-12T15:01:17.080249Z",
    "updated_at": "2025-03-27T02:15:41.667096Z",
    "deleted_at": null,
    "sha1_hash": "1110ac08f443e759a69440b17c3946d236fa82e4",
    "title": "2021-07-03 - [RE023] Quick analysis and removal tool of a series of new malware variant of Panda group that has recently targeted to Vietnam VGCA",
    "authors": "",
    "file_creation_date": "2022-05-28T16:56:25Z",
    "file_modification_date": "2022-05-28T16:56:25Z",
    "file_size": 2284012,
    "plain_text": "# [RE023] Quick analysis and removal tool of a series of new malware variant of Panda group that has recently targeted to Vietnam VGCA\n\n**blog.vincss.net/2021/07/re023-quick-analysis-and-removal-tool-series-of-new-malware-variant-of-Panda-group-that-**\nhas-recently-targeted-to-Vietnam-VGCA.html\n\nThrough continuous cyber security monitoring and hunting malware samples that were used\nin the attack on Vietnam Government Certification Authority, and they also have attacked\na large corporation in Vietnam since 2019, we have discovered a series of new variants of\nthe malware related to this group. Readers can re-read and compare the information below\nwith the previously analyzed article: [RE018-2]Analyzing new malware of China Panda\n[hacker group used to attack supply chain against Vietnam Government Certification](https://blog.vincss.net/2020/12/re018-2-analyzing-new-malware-of-china-panda-hacker-group-used-to-attack-supply-chain-against-vietnam-government-certification-authority.html)\nAuthority - Part 2\n\n**I.  Analysing loaders**\n\nSample [2b15479eb7ec43f7a554dce40fe6a4263a889ba58673b7490a991e7d66703bc8 was](https://www.virustotal.com/gui/file/2b15479eb7ec43f7a554dce40fe6a4263a889ba58673b7490a991e7d66703bc8)\n[discovered by us on VirusTotal on 11/06/2021, and was submitted from Vietnam:](http://www.virustotal.com/)\n\nThe remarkable point in this file is the .NLS [(National Language Support) extension, but it’s](https://docs.microsoft.com/en-us/windows/win32/intl/nls-terminology)\nexactly a DLL PE64. We conduct an in-depth analysis of this sample and determined it\nseems to be crafted by the same hacker who wrote and built smanager_ssl.dll, msiscsi.dll,\nverifierpr.dll, wercplsupport.dll.\n\nHash:\n2B15479EB7EC43F7A554DCE40FE6A4263A889BA58673B7490A991E7D66703BC8\nCompiled time: Tuesday, 04.08.2020 06:48:49 UTC\nOriginal DLL: DllSvchDtchX64.bin\nMalicious file: C_20253.NLS, in \\Windows\\System32\nVisual Studio version: 2015, linker 14.0, update 3\nCoding language: C\n\n\n-----\n\nRichID Information:\n\n[You can compare with the RichID information in Figure 3 of this article. Attackers used](https://blog.vincss.net/2020/12/re018-2-analyzing-new-malware-of-china-panda-hacker-group-used-to-attack-supply-chain-against-vietnam-government-certification-authority.html)\nimpersonating NLS in the Windows\\System32 and Windows\\SysWow64 folders, which\n[contain config and C&C info during the attack on a large Vietnam corporation (Figure4). After](https://blog.vincss.net/2020/12/re018-2-analyzing-new-malware-of-china-panda-hacker-group-used-to-attack-supply-chain-against-vietnam-government-certification-authority.html)\nthat, attackers upgraded in April 2020 to real PE(s) to perform other tasks.\n\nDllSvchDtchX64.bin is written as a service Dll, the code and style is exactly like the code of\nsmanager_ssl.dll and wercplsupport.dll. The ServiceMain, SvcCtrlHandler, and SetSvcStatus\nfunctions are all the same.\n\n[ServiceMain function (compare with Figure5):](https://blog.vincss.net/2020/12/re018-2-analyzing-new-malware-of-china-panda-hacker-group-used-to-attack-supply-chain-against-vietnam-government-certification-authority.html)\n\n\n-----\n\nAnother small difference is that in addition to the global variable g_dwServiceState, the\nhacker has added another global variable, g_dwSvcStopped to Sleep continuously until this\nservice of DllSvchDtchX64.bin was stopped by Windows. With this sample, the main task of\nexecuting malware code is not included in the ServiceMain function, but directly in the\nDllMain function.\n\n[The SetSvcStatus function (compare with Figure 7 and 8):](https://blog.vincss.net/2020/12/re018-2-analyzing-new-malware-of-china-panda-hacker-group-used-to-attack-supply-chain-against-vietnam-government-certification-authority.html)\n\nIn the DllMain function, the malware decrypts the SID and Mutex name, creating a thread to\nexecute another task. This SID and Mutex name are used in the MainThreadProc of the\ncreated thread.\n\nThe encrypt and decrypt encryption algorithm used by the hacker in this sample is\n**[Salsa/Chacha20. It can be detected by FindCrypt3 or Capa of FireEye.](https://github.com/fireeye/capa)**\n\n\n-----\n\nSource code C implementing Salsa and Chacha algorithms is abundant in Lib Crypto\nlibraries, for example Cryptlib, libtomcrypt, libcrypto… But the C source we decompiled is\n[more similar to the source here: http://cr.yp.to/snuffle/ecrypt.c. We are not 100% sure if the](http://cr.yp.to/snuffle/ecrypt.c)\nhacker changed the algorithm or because of the optimization mechanism of the VC compiler.\nReaders can refer to it for self comparison.\n\nFor decrypting the mutex name and SID, the hacker converts two hardcoded hex strings into\na byte buffer using the Hex2Bytes function at address 0x7FFCD3492220, and then feeds\nthis buffer to the Salsa/Chacha20 function at address 0x7FFCD34914F0.\n\nAfter decrypt, we get:\n\n1. SID = S-1-5-18\n2. Mutex Name = Global\\24yQoCWKY3kbZexjzTR6hc7pHU1lI0EV\n\nSID = “S-1-5-18” is known as Local System, Dll Services run under this account. Readers\n[can refer here: Well-known security identifiers in Windows operating systems. Hackers](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows)\ndeclared and used a struct like the one below to save the config that regulate the operation\nof this malware family. This struct has sizeof = 0x248 (584 decimal), and has been encrypted\nusing the Salsa/Chach20 algorithm used above.\n\nThe meaning of these fields in this struct:\n\n\n-----\n\ndwSizeData: The actual size of the real data area from the fExecuteShellcode field\ndwHash: ROL 0xB hash of the whole data range from rgbIv\nrgbIv: 12-byte array, used as value for parameter Iv for salsa_decrypt_bytes function\nfExecuteShellcode: flag specifies whether the data area in the rgbShellcode array has\nshellcode data, and whether the malware will execute this shellcode or not\nfCreateMutex: flag determines whether or not to create a mutex with the above\ndecoded name\nfCheckSID: check if the malware is being executed correctly in the above decrypted\nSID group\nfCheckExePath: check whether the executing malware has the correct Exe name or\nthe correct Parent Exe name with the szExePath field\nszExePath: Name of Exe or Parent Exe that needed to be checked\ndwShellcodeSize: The actual size of the rgbShellcode area (rgb = Range of Bytes) or\nlength (in bytes) of the shellcode file's path\nrbgShellcode: Shellcode or path of another dll or shellcode that needs to be loaded and\nexecuted\n\nSource decompiler of MainThreadProc, address = 0x7FFCD3491FD0.\n\n\n-----\n\n**_Note: g_config is a global variable of the above struct CConfig. 0x14 (20) is the total size of_**\n_the 3 fields: DWORD dwSizeData, DWORD dwHash and BYTE rgbIv[12]._\n\nAfter checking the correct size, the Decrypt function will decrypt the hardcoded config,\nencrypted with the decrypt Salsa/Chacha20 functions.\n\nThe value of the local hash variable in the Decrypt function is calculated from the address of\nrgbIv, the loop size is the value of the field dwSizeData + 0xC (12 = sizeof(rgbIv)). If the hash\nvalue matches the dwHash field, the data region will be decoded.\n\nThe decryption key is the hardcoded string \"u0FBSP2dDyTLhIQ9MXsEexmH7JbiN3k\", the\nIv value is rgbIv, the output decoding starts at the address of the fExecuteShellcode field\n(offset 0x14). After decoding the hardcoded config, in the MainThreadProc image above, the\nmalware starts checking flags, flags that are set to 1 will call the corresponding check\nfunction.\n\nThe function checks the user’s SID that the malware is running:\n\n\n-----\n\nThe variable g_pwszSID is WCHAR * type, decrypted from the begining (“S-1-5-18”). If the\nSID is equal (stricmp return 0) then the function will return TRUE.\n\nFunction to check current Exe name or Parent Exe name (when malware runs as a service\nDll). The function also returns TRUE when the Exe Name matches the szExePath field:\n\nFunction creates mutex is the same as the regular CreateMutex functions:\n\n\n-----\n\nThe value of g_pwszMutexName variable has been decoded from the begining:\n“Global\\24yQoCWKY3kbZexjzTR6hc7pHU1lI0EV”. The created Mutex will be saved to the\ng_hMutex global variable.\n\nAs shown in the figure of MainThreadProc, if the fExecuteShellcode field is set to 1, the\nshellcode will be executed as usual (VirtualAlloc, copy and execute). When it is 0, the\nshellcode file will be read from rgbShellcode.\n\ng_hInstDLL is the HINSTANCE of the malware, running as a service DLL, assigned value at\nthe Entrypoint DllMain function. Readers notice three functions PathRemoteFileSpec,\nPathAddBackslash and PathAppend. These three functions will regenerate the path for the\n\n\n-----\n\nShellcode file that is from a subdirectory of the same level as the Malware. In this case,\nmalware has an impersonation name of C:\\Windows\\System32\\ C_20253.NLS, that\nsubfolder will also be located in C:\\Windows\\System32.\n\nAfter getting the path of the shellcode file, the shellcode will be read, decrypted, and return a\npointer to the decrypted shellcode.\n\nThe memory containing this decrypted shellcode is executed by MainThreadProc. With this\nsample, after the Decrypt function, we only have the following config information:\n\nAll flags are 0\nFile shellcode is “ErrorSvc.dll”, field dwShellcodeSize = 0x1A (26)\n\n**II.  Hunting the same loader**\n\nBased on the special hardcoded string “u0FBSP2dDyTLhIQ9MXsEexmH7JbiN3k”, is used\nas IV for the Salsa/Chacha20 encrypt/decrypt function, we did a search on VirusTotal and\nHybrid Analysis, there are many similar loaders, most of which are uploaded by users\nrecently, from Vietnam, Korea, Japan, Hong Kong... and lastest is a sample from China.\n\nhttps://www.virustotal.com/gui/search/content%253A%2522u0FBSP2dDyTLhIQ9MXsE\nexmH7JbiN3k%2522/files\nhttps://www.hybrid-analysis.com/string[search/results/08f2e828fe16c22515f0b8b7a5ccf9489ceeb58802ded94da4a3e13acd01](https://www.hybrid-analysis.com/string-search/results/08f2e828fe16c22515f0b8b7a5ccf9489ceeb58802ded94da4a3e13acd011e32)\n1e32\n\n\n-----\n\nUntil yesterday, we have found and analyzed 7 more loader samples like this. The source\ncode is completely the same, only the final build format are different (EXE or DLL). And it's\nall PE64, include the following samples:\n\n[1. 4578b3bf586658c47c8db1d497a8994d7637d28f16a11af9f6af64836085d4ed](https://www.virustotal.com/gui/file/4578b3bf586658c47c8db1d497a8994d7637d28f16a11af9f6af64836085d4ed/detection)\n\nBuild Exe\nFlags = 0\nShellcode path: stuffe.dll\n\n[8061df4d29ea57a420491f0db4bf37964070cc695f4b1b45af40e46194cc8c36](https://www.virustotal.com/gui/file/8061df4d29ea57a420491f0db4bf37964070cc695f4b1b45af40e46194cc8c36/detection)\n\nBuild Exe\nFlags = 0\nShellcode path: tmp01.dat\n\n[4b1928dbaf68e427db2f3971ea2ff5604d210ef0dee876d57281d7e395da8c37](https://www.virustotal.com/gui/file/4b1928dbaf68e427db2f3971ea2ff5604d210ef0dee876d57281d7e395da8c37/detection)\n\nThe impersonated file name is C_892.NLS\nBuild as Dll, original Dll name: DllSvchDtchX64.bin\nFlags = 0\nShellcode path: winsec.dll\n\n[d2beff6d7f5be68cdda36182d010e8103d86053fcc63f1166fec42727c26558d](https://www.virustotal.com/gui/file/d2beff6d7f5be68cdda36182d010e8103d86053fcc63f1166fec42727c26558d/detection)\n\nBuild as Dll, original Dll name: DllSvchDtchX64.bin\nFlags = 0\nShellcode path: access.sys\n\n[d28984576620aebfa929767ad9453fe7549c969716d41ba49cbe6ca7fae72789](https://www.virustotal.com/gui/file/d28984576620aebfa929767ad9453fe7549c969716d41ba49cbe6ca7fae72789/detection)\n\nBuild as Exe\nFlag fExcuteShellcode = 1\nShellcode size = 0x107A2 (67490)\n\n[3714568d8c8b7359259e968664de3a6c13d6d7c16559dfb0a25f9aa8194e8de4](https://www.virustotal.com/gui/file/3714568d8c8b7359259e968664de3a6c13d6d7c16559dfb0a25f9aa8194e8de4/detection)\n\nBuild as Dll, original Dll name: DllHijkDtchX64.bin\nfCreateMutex, fCheckSID, fCheckExePath set 1\nExe Parent Name to check: WmiApSrv.exe\nShellcode path: AxLnst.bin\nNotice the file name Exe Parent. This exe is the original Windows file, located in the\n\\Windows\\System32\\Wbem folder. So this malware and AxLnst.bin will also be in this\ndirectory (according to the GetShellcodePath function). This could be an attack using\n[WMI Exploitation that the Winnti/Derusbi Group has been using. Read more here.](https://www.slideshare.net/Hackerhurricane/detecting-wmi-exploitation-v11)\n\n[b69d9ed06cba8eea081df01bad146abb004a4cf5fb6b296017d82ebb18975386](https://www.virustotal.com/gui/file/b69d9ed06cba8eea081df01bad146abb004a4cf5fb6b296017d82ebb18975386/detection)\n\nBuild as Exe\nFlags = 0\nShellcode path: koreanflass bin\n\n\n-----\n\n**III.  Hunting the updated malware of this group**\n\nContinuing to hunt for signs of old malware samples that this group has used in campaigns\ntargeted Vietnam over the years, we found that this group still uses old samples, has\nupdated code and rebuilt with Visual Studio 2019, v16.4 or later. Completely build in x64\nmode.\n\nThis group continues to use files that impersonate Windows' NLS files as config containers\nor as shellcode files. The identification point is that this group has a coder who specializes in\nCryptoPP library and coding in C++ style, using std::string.\n\nThe samples we collected were released recently, in May and June, also from the countries\nmentioned above. We collected and analyzed the following samples:\n\n[1. 5afc41060cf62d1613219caa108eb9714074479a413f4a26797c0358fc95a4db](https://www.virustotal.com/gui/file/5afc41060cf62d1613219caa108eb9714074479a413f4a26797c0358fc95a4db/detection)\n\nBuilt with Visual Studio 2019 v16.9\nPDB Path: C:\\Users\\VS\\Desktop\\Auto_Firefox\\x64\\Release\\8.1.pdb\nUsing CryptoPP, C++ style\nXor value: 0x28\nBuild time: 08/06/2021 - 1:24:48 AM (UTC)\nExport function: ServiceMain, run as a service Dll\nRead and execute MSIscSI.Dll in the same directory and load vsmapi.dll in SysWow64,\ncalling the netEntryApi export function.\n\n[8dd13f34d1734d3c844474ce98a4f39244e511bafbefd59b18bb7fb0b52ce895](https://www.virustotal.com/gui/file/8dd13f34d1734d3c844474ce98a4f39244e511bafbefd59b18bb7fb0b52ce895/detection)\n\nBuilt with Visual Studio 2019 v16.9\nPDB Path:\nC:\\Users\\Machine\\Desktop\\Work\\20200913\\Auto_Firefox\\x64\\Release\\8.pdb\nUsing CryptoPP, C++ style\nBuild time: 19/09/2020 - 8:58:34 AM (UTC)\nExport function: NetworkChecker\n\n\n-----\n\nDecrypt, read two configs from two fake NLS files, C_4868.NLS and C_4869.NLS\n\n[9abf047566c6e9bd77120e8eb6c3503eef7c05dd4fd0abac9046d495291e5c8d](https://www.virustotal.com/gui/file/9abf047566c6e9bd77120e8eb6c3503eef7c05dd4fd0abac9046d495291e5c8d/detection)\n\nBuilt with Visual Studio 2008, code C style\nExport two functions Run and main. Two different functions but the code is exactly the\nsame\nPDB path: C:\\Dev\\16\\3\\x64\\Release\\F71.pdb\nBuild time: 01/06/2016 - 4:38:32 PM (UTC)\nImpersonate as Windows VfWWDM.dll in Resource Version Info\nC2 hardcoded, xor with 0x27, is “www.newshcm.com”\nRead two files is NLS fake are C_436.NLS and C_20130.NLS. The xor value to decode\nthe contents of 2 files is 0x26 and 0x27\n\n[60fe689bafb1ce4def3fab1c91e69e46b223869314e4364fa8efb12e6a0bafba](https://www.virustotal.com/gui/file/60fe689bafb1ce4def3fab1c91e69e46b223869314e4364fa8efb12e6a0bafba/detection)\n\nBuilt with Visual Studio 2019 v16.9, C style\nPDB path: C:\\Users\\VS\\Desktop\\Auto_Firefox\\x64\\Release\\8.1.pdb\nExport function: ServiceMain\nXor value: 0x2B, load dll pubiapi.dll in Windows\\SysWow64, calling export function\nnetEntryApi of this Dll.\n\n[68e871190f405131635ccaa851339c9ca3f61c3b6a9d84dbd7afc99b65edd588](https://www.virustotal.com/gui/file/68e871190f405131635ccaa851339c9ca3f61c3b6a9d84dbd7afc99b65edd588/detection)\n\nBuilt with Visual Studio 2019 v16.9\nUsing CryptoPP, C++ style\nBuild time: 12/04/2021 - 9:18:26 PM (UTC)\nExport function: netEntryApi\nLoad 2 fake NLS files are C_4868.NLS and C_4869.NLS like (2)\n\n[918ad6c918b26de1e112281393f6ced9141712484bb0da5f8250fb36fc0d476b](https://www.virustotal.com/gui/file/918ad6c918b26de1e112281393f6ced9141712484bb0da5f8250fb36fc0d476b/detection)\n\nBuilt with Visual Studio 2012 C style\n\n\n-----\n\nPDB Path: C:\\Dev\\17D\\Release\\7.pdb\nBuild time: 30/04/2017 - 12:29:05 AM (UTC)\nExport two functions are Run and main like (3)\nCC hardcoded, xor with 0x1B, is “www.sexphm.com” and IP hardcoded 172.16.22.22\nRead two fake NLS files are C_20831.NLS and C_20832.NLS in Windows\\System32\n\n[c092546e9db9424d454cc21047d847ad93424440e7a4d339fe58fa9a4d8f6913](https://www.virustotal.com/gui/file/c092546e9db9424d454cc21047d847ad93424440e7a4d339fe58fa9a4d8f6913/detection)\n\nIs vsmapi.dll of (1)\nBuilt with Visual Studio 2019 v16.9\nUsing CryptoPP, C++ style\nPDB path: C:\\Users\\VS\\Desktop\\Auto_Firefox\\x64\\Release\\8.pdb\nBuild time: 08/06/2021 - 1:24:51 AM (UTC)\nExport function: netEntryApi\nLoad two fake NLS files are C_4868.NLS and C_4869.NLS like (2) and (5)\n\nThus, we can see that the samples that this group used in this campaign are mostly rebuilt,\nbesides some old samples in their inventory that have not been detected. Maybe they have\nbeen used, installed and infected in many companies and organizations of many countries,\nincluding Vietnam since 2016. Until now, we have discoverd a number of fake NLS files that\nthis group used throughout, including:\n\nC_201263a.NLS\nC_20130.NLS\nC_20253.NLS\nC_20831.NLS\nC_20832.NLS\nC_20834.NLS\nC_20835.NLS\nC_21871.NLS\nC_21872.NLS\nC_436.NLS\nC_4868.NLS\nC_4869.NLS\nC_877.NLS\nC_878.NLS\nC_892.NLS\n\nAnd probably many more impersonated NLS files out there that we may not discovered.\n\n**IV.  Analysing Windows C_xxxx.NLS files**\n\nThe value xxxx is a number, which is a codepage identifier. For example, Vietnam has a\ncodepage of 1258, the file C_1258.nls on Windows is for Vietnam.\n\n\n-----\n\n[For more codepage definition, readers can read it here. Values  of Codepages that](https://docs.microsoft.com/en-us/windows/win32/intl/code-pages)\n[international and Windows have a convention can refer here. The current maximum value of](https://docs.microsoft.com/en-us/windows/win32/intl/code-page-identifiers)\nCodepage is 65501, Unicode UTF-8. Between 1 and 65535 (0xFFFF), you will see a lot of\nspace, more than 65,000 numbers. This group used numbers not on the above Codepage\nidentifiers to name the impersonated C_XXXX.NLS files.\n\nThe original Windows C_xxxx.NLS files are used for mapping and converting from MultiByte\nto Unicode characters. Two common API functions commonly used in Windows,\nMultiByteToWideChar and WideCharToMultiByte, are based on these C_xxxx.nls files\ncorresponding to the current Windows Codepage on the user's machine.\n\nOn Windows 2000, XP operating systems, these .nls files are not included in the list of\nWindows Protection Files files, only .exe, .dll, .sys, .ocx files. From Windows Vista onwards,\nthe list of Windows Protection Files file types is expanded and the .nls file is added. Readers\ncan refer to protected files [here.](https://docs.microsoft.com/en-us/windows/win32/wfp/protected-file-list)\n\nThe C_xxx.nls are installed when the user installs Windows, located in the\nWindows\\System32 and Windows\\WinSXS\\ folders in several subfolders named\nxxx.codepage-core.xxx and xxx.codepage-additional-xxx.\n\nThese C_xxxx.nls files all have Owner Trust Installer, users with System and Administrators\nrights can only Read, no change rights. When trying to switch Owner and change these files,\nWindows Resource Protection will notify and recover immediately.\n\nWhen the user installs Windows, the list of C_xxxx.nls files were created by Windows is\nlocated at KEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Nls\\CodePage. The\nname value is the codepage number and the Data value is the codepage file name.\n\n\n-----\n\nThe image above is part of the list of Windows 10. In addition to .nls files, Windows also uses\nC_xxxx.dll files to serve for mapping, converting between that codepage back and forth\nUnicode. These dlls only export a single function is NlsDllCodePageTranslation. Prototype of\nthis function: DWORD __stdcall NlsDllCodePageTranslation(DWORD CodePage, DWORD\ndwFlags, LPSTR lpMultiByteStr, int cchMultiByte, LPWSTR lpWideCharStr, int cchWideChar,\nLPCPINFO lpCPInfo)\n\nOn Windows XP and 2000, the number of codepages in the above registry is less, although\nthere are many .nls files copied by the Windows installer to System32\\dllcache, they are not\nconsidered to have been installed and updated in the above registry.\n\n\n-----\n\nThe number of codepages that are considered installed and supported on each version of\nWindows is also different. From Windows Vista onwards, all .nls files that are installed are\nturned on as installed. Codepage installed and supported on Windows XP:\n\nCodepage installed and supported on Windows 7\n\n\n-----\n\nCodepage installed and supported on Windows 10\n\nSince Microsoft does not disclose the structure of the .nls file, we searched the Internet and\nrelied on the WinNLS.h file in the Windows SDK to create the NLS.bt file. This file is used as\na template parser for **[010 Editor, a HexEditor program that supports scripts and parse](http://www.010editor.com/)**\ntemplates very strongly, widely used by the RE community, forensics .... When using\n010Editor to open an NLS file and select the template file as NLS.bt, 010Editor will show us\n[the internal structure of an NLS file. We uploaded NLS.bt here.](https://github.com/VinCSS-Public-Projects/VinCSS-RE-Tools-Ultilities/tree/main/NLSScan)\n\n\n-----\n\n**V.  Tools to check the number of codepages and scan fake NLS files file**\n\nAfter analyzing the structure of an official, original Windows C_xxxx.NLS file, VinCSS has\ndeveloped two tools to check and scan fake NLS files of this group. These two tools are\n[written in Delphi (Object Pascal) and built with Free Embarcadero Delphi Community Edition.](https://www.embarcadero.com/products/delphi/starter/free-download)\n\nWe provide both the built exe and the source code for your reference, which can be easily\n[tested, rebuilt by yourself, also in the above repo. According to](https://github.com/VinCSS-Public-Projects/VinCSS-RE-Tools-Ultilities/tree/main/NLSScan) [this report by Positive](https://www.ptsecurity.com/ww-en/analytics/pt-esc-threat-intelligence/higaisa-or-winnti-apt-41-backdoors-old-and-new/)\nTechnologies, hackers have now updated to new fake NLS.\n\n\n-----\n\n1. CheckCP:\n\nBased on the EnumSystemCodePages API function with two parameters\nCP_INSTALLED and CP_SUPPORTED, CheckCP will display a list of installed and\nsupported codepages on the current Windows. If you detect a suspicious C_xxxx.NLS\nfile, you can enter that number into the CheckCP program to check if the codepage\nnumber is fake or belong to Windows. XXXX is a number, for example: file\nC_20130.NSL, the number to check is 20130.\n\nWith the list of fake NLS files above, we immediately see that all the codepage\nnumbers are fake (1258 and 1252 are valid, we added):\n\nCheckCP.exe source code you download at the above repo, in the subdirectory .\\src,\nfile CheckCP.dpr\n\n\n-----\n\n2. NLSScan.exe:\n\nNLSScan is the main program to scan all C_xxxx.NLS files in Windows\\SysWow64 and\nWindows\\System32 folders, deep into all subfolders. This file is built with 32bit mode,\nrunning on old Windows such as XP, 2000 because there is a high possibility that many\ncomputers in organizations still use these operating systems.\n\nThis group always put fake NLS files in the above two folders. NLSScan checks many\nfactors to ensure that a C_xxxx.NLS file must meet all of those conditions to not be\nconsidered fake or malware. When running NLSScan with no parameters, NLSScan\nwill request Admin privileges to read only a small portion of the files C_xxxx.NLS finds.\nIf you choose Yes, NLSScan will automatically run again in Admin privilege.\n\nFor example, a requirement that the codepage number be consistent in the file name\nand in the file content. We found two cases where the content of the .NLS file was valid\nwhen parsed in NLS.bt, but the codepage number in the file name was invalid, and the\ncodepage number in the content was inconsistent. Hackers copied the original\nWindows file C_037.NLS into two new files C_21871.NLS and C_21872.NLS,\noverwriting the config of the content of  the file.\n\nCompare these two files with the C_037.NLS file and you will see the overwritten area:\n\n\n-----\n\nWhen NLSScan detects fake NLS files, the tool will ask the user for permission to copy those\nfiles to the %TEMP% folder and delete them. If the tool fails to remove it, NLSScan will\nprompt you to reboot to delete it at the next reboot. When you receive the NLSScan\nmessage as above, there is a fake NLS file, you should allow copying and deleting, then\nreboot Windows immediately, run the tool again. If the tool still cannot be deleted, please\nrestart Windows in Safe Mode, run the tool again or find and delete those fake NLS files\nmanually.\n\nWhen NLSScan has detected a fake NLS file, it is almost certain that your computer has\nbeen infected with some malware of this group. You should disconnect from the Internet,\nrescan your system with AV programs, change the passwords, review all security factors.\n\nYou can send us the fake NLS files that have been copied to the %Temp% folder, and if you\nneed helping with finding, review, etc. please contact us at the email address:\n[malware.report@vincss.net](http://10.10.0.46/mailto:malware.report@vincss.net)\n\n\n-----\n\nThis is a test result by using NLSScan on our Windows 10 machine. Especially, you can see\nthe file C_878.NLS that we mentioned in part II, which is a PE x64 dll file, which Windows\nDefender has not detected at the time of this article.\n\nNLSScan can also scan each or multiple NLS files (user can enter the path of those NLS\nfiles). Currently, NLSScan only supports scanning C_XXXX.NLS files. On Windows there are\na number of other NLS files such as: l_intl.nls, locale.nls, normidna.nls, normnfc.nls,\nnormnfd.nls, normnfkc.nls, normnfkd.nls, SortXXX.nls. But because the format of these files\nis not announced by Microsoft, we cannot check. When you encounter files with such names,\nyou use the Windows tool sfc.exe (System File Checker).\n\nThe file C_20253.NLS is invalid, so sfc will say “WRP could not perform….”, C_037.NLS is\na valid file, located in Windows Protection Files, not compromised, so sfc says “WRP did not\n**find …”**\n\n\n-----\n\nWe also upload a small bat file sfcnls.cmd in the above repo for you to periodically run and\ncheck with NLSScan all .nls files in the Windows directory. We hope you will share these\ntools to scan all Windows-based computers in Vietnamese companies, agencies,\norganizations and economic groups. In our opinion, this group is very dangerous, may has\nbeen able to penetrate and lies deep inside with undetected for a long time, causing great\nharm to Vietnam.\n\nWe wish you good health, peace, … and together overcome this pandemic.\n\n_Click here for_ _[Vietnamese version.](https://blog.vincss.net/2021/07/re023-phan-tich-va-xu-ly-loat-bien-the-ma-doc-moi-cua-Panda-da-tung-tan-cong-BCYCP-VN.html)_\n\nSincerely,\n\n**Author: Truong Quoc Ngan (HTC), Dang Dinh Phuong**\n\n**VinCSS (a member of Vingroup)**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-03 - [RE023] Quick analysis and removal tool of a series of new malware variant of Panda group that has recently targeted to Vietnam VGCA.pdf"
    ],
    "report_names": [
        "2021-07-03 - [RE023] Quick analysis and removal tool of a series of new malware variant of Panda group that has recently targeted to Vietnam VGCA.pdf"
    ],
    "threat_actors": [
        {
            "id": "873919c0-bc6a-4c19-b18d-c107e4aa3d20",
            "created_at": "2023-01-06T13:46:39.138138Z",
            "updated_at": "2025-03-27T02:00:03.005534Z",
            "deleted_at": null,
            "main_name": "Higaisa",
            "aliases": [],
            "source_name": "MISPGALAXY:Higaisa",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "30c9c492-afc6-4aa1-8fe6-cecffed946e0",
            "created_at": "2022-10-25T15:50:23.400822Z",
            "updated_at": "2025-03-27T02:00:55.461334Z",
            "deleted_at": null,
            "main_name": "Higaisa",
            "aliases": [
                "Higaisa"
            ],
            "source_name": "MITRE:Higaisa",
            "tools": [
                "PlugX",
                "certutil",
                "gh0st RAT"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c7d9878a-e691-4c6f-81ae-84fb115a1345",
            "created_at": "2022-10-25T16:07:23.359506Z",
            "updated_at": "2025-03-27T02:02:09.752427Z",
            "deleted_at": null,
            "main_name": "APT 41",
            "aliases": [
                "BrazenBamboo",
                "Bronze Atlas",
                "Double Dragon",
                "Earth Baku",
                "Grayfly",
                "Operation ColunmTK",
                "Operation CuckooBees",
                "Operation ShadowHammer",
                "Red Kelpie",
                "SparklingGoblin",
                "TA415",
                "TG-2633"
            ],
            "source_name": "ETDA:APT 41",
            "tools": [
                "9002 RAT",
                "ADORE.XSEC",
                "ASPXSpy",
                "ASPXTool",
                "AceHash",
                "Agent.dhwf",
                "Agentemis",
                "AndroidControl",
                "AngryRebel",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BLUEBEAM",
                "Barlaiy",
                "BlackCoffee",
                "Bladabindi",
                "BleDoor",
                "CCleaner Backdoor",
                "CHINACHOPPER",
                "COLDJAVA",
                "China Chopper",
                "ChyNode",
                "Cobalt Strike",
                "CobaltStrike",
                "Crackshot",
                "CrossWalk",
                "CurveLast",
                "CurveLoad",
                "DAYJOB",
                "DBoxAgent",
                "DEADEYE",
                "DEADEYE.APPEND",
                "DEADEYE.EMBED",
                "DEPLOYLOG",
                "DIRTCLEANER",
                "DUSTTRAP",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "DodgeBox",
                "DragonEgg",
                "ELFSHELF",
                "EasyNight",
                "Farfli",
                "FunnySwitch",
                "Gh0st RAT",
                "Ghost RAT",
                "HDD Rootkit",
                "HDRoot",
                "HKDOOR",
                "HOMEUNIX",
                "HUI Loader",
                "HidraQ",
                "HighNoon",
                "HighNote",
                "Homux",
                "Hydraq",
                "Jorik",
                "Jumpall",
                "KEYPLUG",
                "Kaba",
                "Korplug",
                "LATELUNCH",
                "LOLBAS",
                "LOLBins",
                "LightSpy",
                "Living off the Land",
                "Lowkey",
                "McRAT",
                "MdmBot",
                "MessageTap",
                "Meterpreter",
                "Mimikatz",
                "MoonBounce",
                "MoonWalk",
                "Motnug",
                "Moudour",
                "Mydoor",
                "NTDSDump",
                "PACMAN",
                "PCRat",
                "PINEGROVE",
                "PNGRAT",
                "POISONPLUG",
                "POISONPLUG.SHADOW",
                "POTROAST",
                "PRIVATELOG",
                "PipeMon",
                "PlugX",
                "PortReuse",
                "ProxIP",
                "ROCKBOOT",
                "RbDoor",
                "RedDelta",
                "RedXOR",
                "RibDoor",
                "Roarur",
                "RouterGod",
                "SAGEHIRE",
                "SPARKLOG",
                "SQLULDR2",
                "STASHLOG",
                "SWEETCANDLE",
                "ScrambleCross",
                "Sensocode",
                "SerialVlogger",
                "ShadowHammer",
                "ShadowPad Winnti",
                "SinoChopper",
                "Skip-2.0",
                "SneakCross",
                "Sogu",
                "Speculoos",
                "Spyder",
                "StealthReacher",
                "StealthVector",
                "TERA",
                "TIDYELF",
                "TIGERPLUG",
                "TOMMYGUN",
                "TVT",
                "Thoper",
                "Voldemort",
                "WIDETONE",
                "WINNKIT",
                "WINTERLOVE",
                "Winnti",
                "WyrmSpy",
                "X-Door",
                "XDOOR",
                "XMRig",
                "XShellGhost",
                "Xamtrav",
                "ZXShell",
                "ZoxPNG",
                "certutil",
                "certutil.exe",
                "cobeacon",
                "gresim",
                "njRAT",
                "pwdump",
                "xDll"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535677,
    "ts_updated_at": 1743041741,
    "ts_creation_date": 1653756985,
    "ts_modification_date": 1653756985,
    "files": {
        "pdf": "https://archive.orkl.eu/1110ac08f443e759a69440b17c3946d236fa82e4.pdf",
        "text": "https://archive.orkl.eu/1110ac08f443e759a69440b17c3946d236fa82e4.txt",
        "img": "https://archive.orkl.eu/1110ac08f443e759a69440b17c3946d236fa82e4.jpg"
    }
}