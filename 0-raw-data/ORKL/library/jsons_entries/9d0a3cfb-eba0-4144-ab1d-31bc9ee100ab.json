{
    "id": "9d0a3cfb-eba0-4144-ab1d-31bc9ee100ab",
    "created_at": "2023-01-12T15:10:28.956708Z",
    "updated_at": "2025-03-27T02:05:39.968571Z",
    "deleted_at": null,
    "sha1_hash": "8735c98e44b5191d8f5414cd9776250dae4e5a5b",
    "title": "2019-03-13 - ‘DMSniff’ POS Malware Actively Leveraged to Target Small-, Medium-Sized Businesses",
    "authors": "",
    "file_creation_date": "2022-05-28T17:57:36Z",
    "file_modification_date": "2022-05-28T17:57:36Z",
    "file_size": 141536,
    "plain_text": "# ‘DMSniff’ POS Malware Actively Leveraged to Target Small-, Medium-Sized Businesses\n\n**[flashpoint-intel.com/blog/dmsniff-pos-malware-actively-leveraged-target-medium-sized-businesses/](https://www.flashpoint-intel.com/blog/dmsniff-pos-malware-actively-leveraged-target-medium-sized-businesses/)**\n\nMarch 13, 2019\n\n[Blogs](https://www.flashpoint-intel.com/blog)\n\nBlog\n\nPoint-of-sale malware previously only privately sold has been used in breaches of small- and mediumsized businesses in the restaurant and entertainment industries. The malware, known as DMSniff, also\nuses a [domain generation algorithm (DGA) to create lists of command-and-control domains on the fly.](https://blog.malwarebytes.com/security-world/2016/12/explained-domain-generating-algorithm/)\nThis technique is valuable to an attacker because if domains are taken down by law enforcement,\ntechnology companies, or hosting providers, the malware can still communicate and receive commands\nor share stolen data.\n\n_By Jason Reaves & Joshua Platt_\n\nPoint-of-sale malware previously only privately sold has been used in breaches of small- and mediumsized businesses in the restaurant and entertainment industries. The malware, known as DMSniff, also\nuses a [domain generation algorithm (DGA) to create lists of command-and-control domains on the fly.](https://blog.malwarebytes.com/security-world/2016/12/explained-domain-generating-algorithm/)\nThis technique is valuable to an attacker because if domains are taken down by law enforcement,\ntechnology companies, or hosting providers, the malware can still communicate and receive commands\nor share stolen data.\n\nResearchers at Flashpoint believe the use of a DGA is rarely seen in the realm of POS malware.\n\nPoint-of-sale malware continues to plague industries such as food services and hospitality where older\nand unsupported systems remain prevalent, especially in small- and medium-sized companies. In these\nenvironments where card-present transactions are king, criminals have been relentless in targeting these\nvulnerable devices. Data from last year’s Verizon Data Breach Investigations Report indicates that pointof-sale terminals were the second most-attacked network asset behind database servers\n\n\n-----\n\nMost often, the malware scrapes Track 1 and Track 2 data from a credit card when it s swiped through a\nterminal, before it is encrypted and sent to a payment processor. Attackers may either physically tamper\nwith a POS device to install the malware, or can exploit a vulnerability over the network to infect a device.\n\nAs for DMSniff, it appears to have flown under the radar for at least four years, and has been actively\nused since at least 2016. Flashpoint analysts believe attackers using DMSniff could be gaining an initial\nfoothold on devices either by using brute-force attacks against SSH connections, or by scanning for\nvulnerabilities and exploiting those.\n\nBelow, we share some technical details on the malware and corresponding panel code. We also share\nsome possible mitigations and links to indicators of compromise.\n\n## Diving Into DMSniff\n\nDMSniff uses multiple techniques in order to protect itself and its command-and-control (C2)\ncommunications from researchers and law enforcement. The first technique is a simple string-encoding\nroutine, below, designed to hide its strings. This shields the malware’s capabilities from detection, making\nit difficult for researchers to learn its capabilities.\n\nImage 1: The string encoding used by DMSniff.Image 1: The string encoding used by DMSniff.\nA pseudocode Python-based implementation of this can be found below:\n\nImage 2: The pseudocode Python-based implementation of the string encoding.Image 2: The\n**_pseudocode Python-based implementation of the string encoding._**\nUsing this, Flashpoint decoded select strings, which can be downloaded below. Another technique used\nby this malware is a DGA that allows it to resist takedowns and bypass trivial blocking mechanisms.\n\nImage 3: The malware’s initial DGA.Image 3: The malware’s initial DGA.\nThe DGA is based on a number of hardcoded values; in the samples researchers have found, the first\ntwo characters of the generated domains are hardcoded in the bot. Researchers have found 11 variants\nof this DGA so far, all structured in the same algorithm, but with variable first two letters and hardcoded\nmultiply values in the algorithm.\n\nImage 4: Pseudocode for the domain generation algorithm.Image 4: Pseudocode for the domain\n**_generation algorithm._**\nThe bot loops through the domain generation while rotating through a list of top-level domains (TLDs)—\ne.g .in, .ru, .net, .org, .com—until it finds a server it can talk to. The data that was harvested by the bot to\ncreate a hostid is then sent off inside the user-agent.\n\nImage 5: Malware check-in example.Image 5: Malware check-in example.\nIt is worth noting the fake response, which pretends to be an error. There is also some data in the\nresponse that is commented out as “vqns”; this is verified by the bot to determine whether it is a real C2\ndomain.\n\nImage 6: Malware code for parsing comment block.Image 6: Malware code for parsing comment\n**_block._**\nFor the data theft portion of the POS, the bot is simplistic because it comes with an onboard list of\nprocess names to avoid; it will use this list while looping through the process tree. Each time it finds an\ninteresting process, it will loop through the memory sections to attempt to find a credit card number. Once\n\n\n-----\n\na number is found, the bot will take the card data and some of the surrounding memory, packages it, and\nsends it to the C2.\n\nImage 7: Redacted DMSniff panel, bot overview.Image 7: Redacted DMSniff panel, bot overview.\nAfter a report on the stolen data has been downloaded or reviewed, it is deleted from the panel, meaning\nthe stolen data is being exfiltrated somewhere else either to store or sell.\n\nBelow is the PHP code from the panel responsible for deleting reports after being sent:\n\n//- del all sent\n\n$das = $_GET[‘das’];\n\nif (!empty($das))\n\n{\n\n$dh = opendir($dirn);\n\nif (!$dh) { echo “cant open dir”; die(); }\n\nwhile (($file = readdir($dh)) !== false)\n\n{\n\nif ($file[0] != ‘d’) continue;\n\nif ($file[1] != ‘_’) continue;\n\nif (!strpos($file,”.SENTOK”)) continue;\n\nif (defined(“MARKER”))\n\n{\n\n$exp=explode(‘_’,$file);\n\nif ($exp[1] != MARKER) continue;\n\n}\n\nunlink($file);\n\n}\n\n}\nFrom the panel, an entry of the XOR value needed to unlock the report is added; the panel will then verify\nthe data. As of this writing, all identified panels and bots use the same single byte XOR key of ‘0xd’ or\n‘13.’\n\nImage 8: Redacted DMSniff report data overview for retrieving stolen data in the panel.Image 8:\n**_Redacted DMSniff report data overview for retrieving stolen data in the panel._**\nStolen data files are based on the bot data and a marker value:\n\n$filedst = DMPPATH.’/d_’.$mrk.’_’.$realip.’_’.mktime();\n\nThe marker value is at most 0-2 in length:\n\n_$mrk  = $_GET[‘m’];_\n_if (strlen($mrk) > 2) die(); // hack protection_\n\nThis is also where the .upl files are created to signify the bot has uploaded data:\n\n\n-----\n\n$fnm = my_base64_encode($exp[1]);\n$f = fopen(INFOPATH.$fnm.’.upl’,”w”);\n$data = mktime().’|’.$exp[1].’|’.$realip.’|’;\nfputs($f,$data);\nfclose($f);\n\nIf all is successful for the uploader, an <!-OK-> is returned:\n\nif ($filear[“error”][0] == 0) echo “<!-OK->”;\n\nPanel code to parse bot checkin:\n\n$ua = getenv(‘HTTP_USER_AGENT’);\n$pos = strpos($ua,’DSNF_’);\n\nThe returned data from this is a string-encoded version of the PID (Process Identifier) with every digit\nhaving “a” added to it and hardcoded mul values similar to the DGA and stored in a fake 404 page in a\ncomment.\n\n$tmp = substr($ua,$pos+5);\n$exp = explode(‘)’,$tmp);\n$pid = $exp[0];\n\necho\n“<!-“.chr(97+ToRange($pid)).chr(97+ToRange(3*$pid)).chr(97+ToRange(5*$pid)).chr(97+ToRange(7*$pid)).”>”;\nIf a shell command has been set via a .prt file, then another comment will be added:\n\n// shl cmd\n\nif (file_exists(INFOPATH.$fnm.’.prt’) )\n{\n$shl = file_get_contents(INFOPATH.$fnm.’.prt’);\n$exp = explode(‘|’,$shl);\necho “<!-#”.$exp[0].”->”;\n}\n\n}\nThis will have the ip:port for the bot to connect to and download and execute files. The bot uses FTP to\naccomplish this action of downloading secondary files.\n\n## Conclusion\n\nDMSniff is another name in a growing list of evolving threats for the point-of-sale malware world. During\nour research we found that this malware was primarily utilized to target small to medium sized\nbusinesses such as restaurants and theaters. It also contains a domain generation algorithm, something\nthat is rare to see in point-of-sale malware\n\n## Mitigations\n\n\n-----\n\nFlashpoint recommends organizations regularly update all attack surface appliances. The suspected\ninfection avenue is SSH brute forcing (low confidence) and common exploit scanners (low confidence).\nHost-based detections for the following file could also be beneficial:\n\ndmsnf.cfg\n\nAlso monitoring for abnormal Windows processes execution, such as the following:\n\nImage=”*csrss.exe” AND (ParentImage!=”*system” OR ParentImage!=”*smss.exe”)\n\nImage=”*lsass.exe” AND ParentImage!=”*wininit.exe”\n\nAs with all host-based indicators, additional tuning may be needed depending on the environment.\n\n## Attachments & Downloads\n\n- To download the indicators of compromise (IOCs) for DMSniff, [click here.](https://www.flashpoint-intel.com/wp-content/uploads/2019/03/DMSniff_iocs_March2019.txt)\n\n- To download the decoded strings for DMSniff, [click here.](https://www.flashpoint-intel.com/wp-content/uploads/2019/03/DMSniff_decoded_strings_March2019.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-03-13 - ‘DMSniff’ POS Malware Actively Leveraged to Target Small-, Medium-Sized Businesses.pdf"
    ],
    "report_names": [
        "2019-03-13 - ‘DMSniff’ POS Malware Actively Leveraged to Target Small-, Medium-Sized Businesses.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536228,
    "ts_updated_at": 1743041139,
    "ts_creation_date": 1653760656,
    "ts_modification_date": 1653760656,
    "files": {
        "pdf": "https://archive.orkl.eu/8735c98e44b5191d8f5414cd9776250dae4e5a5b.pdf",
        "text": "https://archive.orkl.eu/8735c98e44b5191d8f5414cd9776250dae4e5a5b.txt",
        "img": "https://archive.orkl.eu/8735c98e44b5191d8f5414cd9776250dae4e5a5b.jpg"
    }
}