{
    "id": "76756c56-56a4-4e79-a38f-b08ef33c8787",
    "created_at": "2023-01-12T15:05:56.529842Z",
    "updated_at": "2025-03-27T02:05:33.913956Z",
    "deleted_at": null,
    "sha1_hash": "5f1bf73f9a00d418ad98732df47d1366dc999194",
    "title": "2022-06-27 - Emotet- Still Abusing Microsoft Office Macros",
    "authors": "",
    "file_creation_date": "2022-07-02T23:18:25Z",
    "file_modification_date": "2022-07-02T23:18:25Z",
    "file_size": 970782,
    "plain_text": "# Emotet: Still Abusing Microsoft Office Macros\n\n**[netskope.com/blog/emotet-still-abusing-microsoft-office-macros](https://www.netskope.com/blog/emotet-still-abusing-microsoft-office-macros)**\n\nGustavo Palazolo June 27, 2022\n\n## Summary\n\n[In April 2022, Netskope Threat Labs analyzed an Emotet campaign that was using LNK files](https://www.netskope.com/blog/emotet-new-delivery-mechanism-to-bypass-vba-protection)\ninstead of Microsoft Office documents, likely as a response to the protections launched by\nMicrosoft in 2022 to mitigate attacks via Excel 4.0 (XLM) and VBA macros.\n\nHowever, we recently came across hundreds of malicious Office documents that are being\nused to download and execute Emotet, indicating that some attackers are still using old\ndelivery methods in the wild. Despite the protection Microsoft released in 2022 to prevent the\nexecution of Excel 4.0 (XLM) macros, this attack is still feasible against users who are using\noutdated versions of Office. It is also feasible against users who have changed the default\nsetting to explicitly enable macros. The fact that attackers are still using Excel 4.0 Macros\nindicates that outdated Office versions and users who have this protection disabled are still\ncommon.\n\n\n-----\n\n_Option to enable Excel_\n\n_4.0 Macros._\n[By searching for similar files on VirusTotal, we found 776 malicious spreadsheets submitted](https://github.com/netskopeoss/NetskopeThreatLabsIOCs/tree/main/Emotet/2022-06-24)\nbetween June 9, 2022 and June 21, 2022, which abuse Excel 4.0 (XLM) macros to download\nand execute Emotet’s payload. Most of the files share the same URLs and some metadata.\nWe [extracted 18 URLs out of the 776 samples, four of which were online and delivering](https://github.com/netskopeoss/NetskopeThreatLabsIOCs/blob/main/Emotet/2022-06-24/script/extract_xls_urls.py)\nEmotet.\n\nSubmission timeline for Emotet\n\nspreadsheets on VirusTotal.\n\nIn this blog post, we will analyze this Emotet campaign, showing the delivery mechanism to\nthe last payload.\n\n## Stage 01 – Malicious Spreadsheets\n\nThe first stage is a malicious spreadsheet that abuses Excel 4.0 (XLM) macros to download\nand execute Emotet. These files are being delivered as email attachments.\n\n\n-----\n\nPhishing emails with malicious spreadsheets attached.\nThere are also cases where the spreadsheet is attached within a password-protected ZIP\nfile.\n\nThe spreadsheet contains a message to lure the user to remove the protected view by\nclicking the “Enable Editing” button.\n\nSpreadsheet message asking to click “Enable Editing”.\nThe malicious code is obfuscated and spread across hidden spreadsheets and cells.\n\n\n-----\n\nPart of the Excel 4.0 Macros.\n[The code downloads the payload from an external URL via “URLDownloadToFileA” API and](https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85))\n[executes it with “regsvr32.exe”, which is a commonly used binary for the Living-off-the-Land](https://lolbas-project.github.io/lolbas/Binaries/Regsvr32/)\ntechnique.\n\nDeobfuscated code from the spreadsheet.\nFurthermore, most of the files we analyzed were authored by “Dream” and last saved either\nby “RHRSDJTJDGHT” or “TYHRETH“, indicating the files likely share an author.\n\nCommon metadata across the spreadsheets.\n\n## Stage 02 – Packed Emotet\n\nWe were able to download samples from four different URLs out of the 18 extracted from the\nspreadsheets. Two of the downloaded files were unpacking the same Emotet payload.\n\n\n-----\n\nFour payloads downloaded from the spreadsheet URLs.\nEmotet’s main payload is encrypted and stored in the PE resources of the loader, which is\n[the same case as other Emotet packed samples we analyzed earlier in 2022.](https://www.netskope.com/blog/emotet-new-delivery-mechanism-to-bypass-vba-protection)\n\nEmotet’s main payload stored in the PE resources.\nThe unpacking/decryption process is also very similar to the samples we analyzed earlier in\n2022, where a key is used in a simple rolling XOR algorithm.\n\n\n-----\n\nEmotet decryption process.\n\n## Stage 03 – Emotet Payload\n\nWe extracted three different payloads (64-bit DLLs) from the samples we downloaded from\nthe URLs.\n\nMain Emotet payloads.\n\nWe can find some similarities by comparing these payloads with the ones we analyzed in\nApril 2022, like the pattern used in the DLL name.\n\nReal name for all three samples is “E.dll”.\n\nAnd also the persistence mechanism via Windows service that executes the payload via\n**regsvr32.exe.**\n\n\n-----\n\nEmotet persistence mechanism.\nHowever, there are some differences between these payloads and the ones we analyzed in\nApril 2022. The first one is where and how Emotet decrypts its strings. In previous payloads,\nEmotet was storing its strings in the PE .text section.\n\nIn these latest payloads, Emotet uses functions to retrieve decrypted strings. Simply put, the\nattacker is using the concept of stack strings, which are passed via parameter to the function\nthat performs the decryption process.\n\nEmotet function to return a decrypted string.\nThe decrypted strings can be easily retrieved by placing breakpoints in the return of these\n[functions. Also, it’s possible to use a Python script to automatically extract this data using](https://research.openanalysis.net/emotet/emulation/config/dumpulator/malware/2022/05/19/emotet_x64_emulation.html)\n[Dumpulator or any other emulation framework.](https://github.com/mrexodia/dumpulator)\n\n\n-----\n\nEmotet decrypted strings.\n\nThe C2 addresses are also retrieved in a different way on these payloads. Instead of storing\nthis data in the PE .data section, Emotet parses the C2 addresses via functions as well.\n\nEmotet parsing the C2 server addresses.\n\n\n-----\n\nAnd it s also possible to extract this information statically using an emulation script, similar to\nthe one used for the strings.\n\nPart of Emotet C2 server addresses.\n\n## Conclusions\n\n[In April 2022 we analyzed an Emotet campaign that was not using Microsoft Office files to](https://www.netskope.com/blog/emotet-new-delivery-mechanism-to-bypass-vba-protection)\n[spread, as a possible response to Microsoft protections. However, we still see some](https://www.netskope.com/blog/microsoft-office-vba-blocked-by-default-in-files-from-the-internet)\nattackers abusing Microsoft Office files to download and execute Emotet. We strongly\nrecommend users to update Microsoft Office to its latest versions. Also, IT administrators\n[may also completely block Excel 4.0 (XLM) Macros via Group Policy.](https://techcommunity.microsoft.com/t5/excel-blog/excel-4-0-xlm-macros-now-restricted-by-default-for-customer/ba-p/3057905)\n\n## Protection\n\nNetskope Threat Labs is actively monitoring this campaign and has ensured coverage for all\nknown threat indicators and payloads.\n\n**Netskope Threat Protection**\n\nDocument-Excel.Trojan.Emotet\nWin64.Trojan.Emotet\n**Netskope Advanced Threat Protection provides proactive coverage against this**\nthreat.\n\nGen.Malware.Detect.By.StHeur indicates a sample that was detected using static\nanalysis\nGen.Malware.Detect.By.Sandbox indicates a sample that was detected by our\ncloud sandbox\n\n## IOCs\n\nAll the IOCs related to this campaign, scripts, and the Yara rules can be found in our GitHub\nrepository\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-27 - Emotet- Still Abusing Microsoft Office Macros.pdf"
    ],
    "report_names": [
        "2022-06-27 - Emotet- Still Abusing Microsoft Office Macros.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535956,
    "ts_updated_at": 1743041133,
    "ts_creation_date": 1656803905,
    "ts_modification_date": 1656803905,
    "files": {
        "pdf": "https://archive.orkl.eu/5f1bf73f9a00d418ad98732df47d1366dc999194.pdf",
        "text": "https://archive.orkl.eu/5f1bf73f9a00d418ad98732df47d1366dc999194.txt",
        "img": "https://archive.orkl.eu/5f1bf73f9a00d418ad98732df47d1366dc999194.jpg"
    }
}