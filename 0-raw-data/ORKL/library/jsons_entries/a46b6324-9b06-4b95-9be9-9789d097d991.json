{
    "id": "a46b6324-9b06-4b95-9be9-9789d097d991",
    "created_at": "2023-05-06T02:08:46.894722Z",
    "updated_at": "2025-03-27T02:06:14.302432Z",
    "deleted_at": null,
    "sha1_hash": "e329dde550ec99831874156b1256efd3890d8a5c",
    "title": "2023-04-03 - A Royal Analysis of Royal Ransom",
    "authors": "",
    "file_creation_date": "2023-05-05T01:47:26Z",
    "file_modification_date": "2023-05-05T01:47:26Z",
    "file_size": 2224525,
    "plain_text": "# A Royal Analysis of Royal Ransom\n\n**[trellix.com/en-us/about/newsroom/stories/research/a-royal-analysis-of-royal-ransom.html](https://www.trellix.com/en-us/about/newsroom/stories/research/a-royal-analysis-of-royal-ransom.html)**\n\n### ARIA Resort & Casino | Las Vegas\n September 27-29, 2022\n\n[Register Now](https://trellix.g2planet.com/xpand_live_2022/register) [Learn More](https://www.trellix.com/en-us/about/events/2022/trellix-xpand-live-2022.html)\n\n## Stories\n\nThe latest cybersecurity trends, best practices,\n\nsecurity vulnerabilities, and more\n\nBy [Alexandre Mundo, and](https://www.trellix.com/en-us/about/newsroom/stories/contributors/alexandre-mundo.html) [Max Kersten · April 3, 2023](https://www.trellix.com/en-us/about/newsroom/stories/contributors/max-kersten.html)\n\n_We would like to thank Advanced Cyber Services team within Trellix Professional Services_\n_for the incident response-related data._\n\nEmerging in early 2022 as a private group which used multiple strains of ransomware,\n[Royal Ransom has used their own ransomware since September 2022. A recap by](https://www.bleepingcomputer.com/news/security/new-royal-ransomware-emerges-in-multi-million-dollar-attacks/)\nBleeping Computer contains the history of this gang. Recently, the FBI and CISA [published](https://www.cisa.gov/sites/default/files/2023-03/aa23-061a-stopransomware-royal-ransomware.pdf)\na joint advisory, highlighting the impact of Royal Ransom. This blog will dive deep into the\ninner workings of Royal Ransom’s Windows and Linux executables, after which an\nanonymized Royal Ransom incident response case is discussed. The two executables are\nsomewhat similar in functioning, barring some different modules, such as the existence of a\nnetwork scanner in the Windows version, while the Linux version can shut ESXi virtual\nmachines down.\n\nGiven the overlap in some of the features in Royal Ransom and Conti, such as the chunkbased encryption scheme, it is possible that one or more persons who worked with/for\nConti, are now working, or have shared details with, the Royal Ransom gang. Given Conti’s\n\n\n-----\n\ndownfall, actors might have switched to a different group. Alternatively, it is possible that the\nRoyal Ransom gang reversed or read reports of Conti’s ransomware and cherry-picked\nfeatures they found useful and/or interesting.\n\nThe below screenshot is meant to show the impact this malware family has on a global\nscale. These detections are from the last two months of our telemetry.\n\nFigure 1 - Last two months of Royal Ransom detections\nAnalyzed samples\n\nThe hashes for both the Windows and the Linux samples are given below, starting with the\nWindows sample information. For more Royal Ransomware IOCs we encourage Trellix\nInsights users to filter on the Royal Ransomware related events.\n\nWindows\n\n**MD-5**\n\nAFD5D656A42A746E95926EF07933F054\n\n**SHA-1**\n\n\n-----\n\n04028A0A1D44F81709040C31AF026785209D4343\n\n**SHA-256**\n\n9DB958BC5B4A21340CEEEB8C36873AA6BD02A460E688DE56CCBBA945384B1926\n\n**Compiler**\n\nMicrosoft Visual C/C++ (2022 v.17.2)\n\n**Linker**\n\nMicrosoft Linker (14.32, Visual Studio 2022 17.2)\n\nLinux\n\n**MD-5**\n\n219761770AD0A94AC9879A6028BD8E55\n\n**SHA-1**\n\n554085B1FEF4B90C8679A9D10A2C758F10563A79\n\n**SHA-256**\n\nDCE73C3C9C2F0033EA90E6EAF3B43EB037F29C78D2D35A8D0DB9E46E30883626\n\n**Compiler**\n\nGCC (4.4.7 20120313 (Red Hat 4.4.7-23))\n\n\n-----\n\nThe RSA public keys for both samples are given below, the Windows and Linux samples\nrespectively.\n\n-----BEGIN RSA PUBLIC KEY----\nMIICCAKCAgEA0y6/qfb0GqxB2tNEW8qLCtT7U3XCzp1OVjVkaTH9SBV1k3NBElgC\nesSVOFAUAG5nT3WO+CdN26ScoKsFjzKGYh8c7vyoi7L5dDBRdoTEW5+u2rBSIN3c\npkR0Wsq+gT3j0gtvjVybMfp6NRifsMfrcAV9tlrzUw7Da2mx+1Ik9Aa5RaaOxv8N\nahH6OSJ8Qz1G3uCgZaXAULlAqNnlN0KtSo4VsXt/sOnDh1pGFf8jqU8sqwJUkcWk\nRdeYdsDyiDrUFxXkHJsiZb8lFk6b01Rm2yS9+kyZxi1yhB1m0kStUUmbN2aoZMy1\npIKxDa2clhhYw+JEMrbCKWW1Aif2hR55nBgL2kwiaNShXUm3yEsfbnd/lJ5ORMUF\ntVmaEFEyvVutc86TcNhu0NCHfYihtgbcke7cvy23XnL/qlFL4OzdAnyupz0n69mk\n1TSJBR7so3GhvQz53wTps9FXSwWlRpGLTCGRo4OnLnke7Hi5YL+Wb/4c6xWz8biX\n+jNeg5Zko+CL3I7ywJkyCWuH9Pr7nccWr1s35BSV8Aj9rMwmOsak2BG91Db0yovg\nFLmKMhkwxpBgFfePXIZF687DxpwYJ5fN44OyUCfNrtfejfSFtjhDCwFy/YpBhZ/w\n2Bnw8hTLNALEIsDBhAlQBVYAGYhUgDbpvs/GN3qijyFWdESqlCK1Eg0CAQM=\n\n-----END RSA PUBLIC KEY----\n\n-----BEGIN RSA PUBLIC KEY----\nMIICCAKCAgEAp/24TNvKoZ9rzwMaH9kVGq4x1j+L/tgWH5ncB1TQA6eT5NDtgsQH\njv+6N3IY8P4SPSnG5QUBp9uYm3berObDuLURZ4wGW+HEKY+jNht5JD4aE+SS2Gjl\n+lht2N+S8lRDAjcYXJZaCePN4pHDWQ65cVHnonyo5FfjKkQpDlzbAZ8/wBY+5gE4\nTex2Fdh7pvs7ek8+cnzkSi19xC0plj4zoMZBwFQST9iLK7KbRTKnaF1ZAHnDKaTQ\nuCkJkcdhpQnaDyuUojb2k+gD3n+k/oN33Il9hfO4s67gyiIBH03qG3CYBJ0XfEWU\ncvvahe+nZ3D0ffV/7LN6FO588RBlI2ZH+pMsyUWobI3TdjkdoHvMgJItrqrCK7BZ\nTIKcZ0Rub+RQJsNowXbC+CbgDl38nESpKimPztcd6rzY32Jo7IcvAqPSckRuaghB\nrkci/d377b6IT+vOWpNciS87dUQ0lUOmtsI2LLSkwyxauG5Y1W/MDUYZEuhHYlZM\ncKqlSLmu8OTitL6bYOEQSy31PtCg2BOtlSu0NzW4pEXvg2hQyuSEbeWEGkrJrjTK\nv9K7eu+eT5/arOy/onM56fFZSXfVseuC48R9TWktgCpPMkszLmwY14rp1ds6S7OO\n/HLRayEWjwa0eR0r/GhEHX80C8IU54ksEuf3uHbpq8jFnN1A+U239q0CAQM=\n\n-----END RSA PUBLIC KEY----\nThe Ransom Note\n\nThe ransom note, as present within the samples, is given below. Note that some format\nspecifier (being “%s”) is to-be replaced during runtime with the given victim ID. Additionally,\nthe given domain has been defanged. No further changes have been made to the note.\n\n\nHello!\n\nIf you are reading this, it means that your system were hit by 'Royal ransomware.'\n\nPlease contact us via :\n\nhttp[://]royal2xthig3ou5hd7zsliqagy6yygk2cdelaxtni2fyad6dpmpxedid[.]onion/%s\n\n\n-----\n\nIn the meantime, let us explain this case.It may seem complicated, but it is not!\nMost likely what happened was that you decided to save some money on your security\ninfrastructure.\n\nAlas, as a result your critical data was not only encrypted but also copied from your\nsystems on a secure server.\n\nFrom there it can be published online.Then anyone on the internet from darknet criminals,\nACLU journalists, Chinese government(different names for the same thing), and even your\nemployees will be able to see your internal documentation: personal data, HR reviews,\ninternal lawsuitsand complains', financial reports, accounting, intellectual property, and\nmore!\n\nFortunately we got you covered!\n\nRoyal offers you a unique deal.For a modest royalty(got it; got it ? ) for our pentesting\nservices we will not only provide you with an amazing risk mitigation service,covering you\nfrom reputational, legal, financial, regulatory, and insurance risks, but will also provide you\nwith a security review for your systems.\n\nTo put it simply, your files will be decrypted, your data restore and kept confidential, and\nyour systems will remain secure.\n\nTry Royal today and enter the new era of data security!\n\nWe are looking to hearing from you soon!\n\nThe Windows Version\n\nThe Royal Ransom uses command-line arguments, prefixed with a flag. There are three\npossible flags, which are shown in the table below, along with a brief explanation of their\nintended behavior.\n\nFlag\n\nDescription\n\nMandatory\n\n-id\n\nThe victim ID to use, which needs to be exactly 32 (0x20) characters in size, or the malware\nshuts down early.\n\nYes\n\n\n-----\n\n-path\n\nThe location to start encrypting files recursively. If this parameter is not used, all drives that\nare connected to the machine will be encrypted, after which the malware attempts to spread\nitself over the network.\n\nNo\n\n-ep\n\nA numerical value no larger than 99, specifying how many percent of encountered files will\nbe encrypted. If this flag is omitted, the default value of 50 will be used.\n\nNo\n\nThe screenshot below shows the command-line interface argument handling, along with the\nflags. In the decompiled and refactored code, one can see how the file encryption\npercentage is set to 50 if the value is over 99, how the given victim ID is set, and how the\nprovided path is stored.\n\n\n-----\n\nFigure 2 - Command-line argument parsing\nOnce the command-line arguments have been handled, the ransomware moves on to\nquietly delete all shadow copies by starting “vssadmin” as a new process, along with the\nrequired command-line arguments. The ransomware waits until the newly started\n“vssadmin” process completes the deletion of the shadow copies, prior to continuing its\nexecution.\n\n\n-----\n\nFigure\n\n3 - Shadow copy deletion\nNote that the path to “vssadmin” is hardcoded to the C: drive, meaning that on any system\nwhere Windows is not installed on the C: drive, the shadow copy deletion will fail, and the\nransomware will continue its execution.\n\nOnly at this point is the given ID (passed by the “-id” flag) checked for the required 32character length. If this fails, Royal Ransom will simply stop its execution.\n\nFigure 4 - Victim ID length check\nNext, the to-be avoided extensions are initialized, partially based on stack strings and\npartially based on strings within the data section of the binary. The extensions to be avoided\nare: exe, dll, lnk, bat, and royal. Additionally, the readme.txt file will be ignored, as it will be\nplaced by the ransomware itself.\n\nThe ransomware avoids several folders: windows, royal, $recycle.bin, google, perflogs,\nMozilla, tor browser, boot, $windows.~ws, $windows.~bt, and windows.old. These folders\nare avoided as there is related data in them, and encrypting files in here will prevent the\nsystem from properly starting up. Malfunctioning devices are less likely to lead to contact\nwith the ransomware crew, which is why the devices are left “functioning” to the extent that\nthe ransom note can be read, and a decryptor can restore a device’s files.\n\nSetting the stage\n\nThe encryption is then started in a multi-threaded manner, where the number of threads is\nequal to twice the number of processors in the victim’s machine (based on the outcome of\n[GetNativeSystemInfo). As such, the system’s scheduler will not be overloaded by too many](https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getnativesysteminfo)\nthreads, while still performing tasks in parallel.\n\n\n-----\n\nFigure 5 - Encryption thread creation\nRather than starting the encryption with the cryptography related threads while traversing\nfiles, the threads wait for conditional variables to signal the availability of a target file.\n\nEach thread will import the RSA public key, which is embedded in the malware sample, to\nencrypt the AES and IV values, which will be used to encrypt the files.\n\nFigure 6 - The public RSA key\nNote that if the RSA public key cannot be obtained, for any given reason, the thread will\nsimply exit. To avoid the usage of the Windows API’s cryptographic functions, which would\nshow up in static analysis or would need to be resolved dynamically, the OpenSSL library is\nstatically linked with the malware, which provides similar functionality. The used encryption\nis, unfortunately, correctly implemented.\n\nTo avoid the attempted encryption of a locked file, the ransomware first checks if it is\nlocked. If it is, the Windows Restart Manager is used to ensure the file is available. Notably,\ntwo processes are excluded from freeing it up: “explorer.exe” and the Royal Ransom\nprocess. If the process is locked by neither of these two, the Restart Manager is used.\n\n\n-----\n\nFigure 7 - Process iteration\nWith “RmStartSession” the session is started, after which “RmRegisterResources” is used\nto register the resources (being the file in this case). After that, “RmGetList” is used to\ncheck which application(s) and/or service(s) lock the resources, which are then closed\nusing “RmShutdown”, thus removing the lock.\n\nFigure 8 - Restart Manager related functions to free to process\nFile Encryption\n\nThe file encryption is based on chunks of data of a given file. The optional flag to provide\nthe encryption percentage specifies how many blocks will need to be encrypted within the\ngiven file, based on the file’s size. Not providing the flag, half of the file will be encrypted.\n\n\n-----\n\nThe granular approach by allowing each execution of the ransomware to encrypt a given\npercentage of each file allows operators to decide if they’d like to go for a fast-yet-lesssecure approach, or a slow-yet-secure approach. When going to for a percentage that is too\nlow, files might be recoverable, but the encryption time is insignificant. Using a high\npercentage, i.e. 90 will encrypt more data, making it difficult if not impossible to recover\nwithout the key, while using a significant amount of time to encrypt the files. Additionally, not\nencrypting the file in-full will avoid heavy disk usage, which is what security products can\ntrigger to block ransomware.\n\nThe original files will, once (partially) encrypted, be increased with 528 bytes. The RSA\nblock, the original file size, and the encryption percentage value are stored within the newly\ncreated space. The sizes of the given fields are, respectively, 512, 8, and 8 bytes.\n\nThe encryption percentage isn’t applied to all files: any file that is less or equal than\n5245000 bytes in size (or 5 megabytes, when adhering to 1024 bytes per kilobyte, rather\nthan the often used 1000) is encrypted in full, regardless of the given encryption\npercentage.\n\nFigure 9 - The encryption percentage chunk creation\nNote that the chunk-based approach is also present in the Conti ransomware.\n\nFigure 10 - Writing the encrypted file chunks\nOnce the data has been written, it will be flushed with the “FlushFileBuffers” Windows API\nfunction to ensure that the changes are persisted on the disk. Next, the ransomware\nrenames the encrypted file by moving it, where the destination has a different name than it\noriginally had. The changed name is the old name with the added “.royal” extension\nappended. The “MoveFileExW” Windows API function is used to rename the file.\n\n\n-----\n\nFigure 11 - Renaming the file by moving it\nRecursive Folder Enumeration\n\nA new thread is made to obtain all logical drives. In contrast with other ransomware or\nwipers, the media type of the drives isn’t checked, meaning that some drives might not be\nwriteable, while the file encryption is still attempted.\n\nFigure 12 - Obtaining the logical drives\nWithin each encountered folder, the ransom note will be placed. The ransom note contains\nthe victim ID which was provided via the command-line interface.\n\n\n-----\n\nFigure 13 - Write the ransom note\nEach valid file, meaning the blocklisted extensions and folder names do not match, will be\nadded to a list. This list is the way to instruct to encryption threads that a new file is\navailable, after which it will be encrypted.\n\nFigure 14 - Add a \"valid\" target file to the list, which the encryption threads use\nThe encryption threads will remove the file from the list once it has been encrypted and the\nnext item from the list will be picked-up, if available.\n\n\n-----\n\nFigure 15 - Fetch an item from said list\nNetwork Scanner\n\nIf no path was given via the command-line interface, the malware will get all the IP\naddresses on the victim’s device, and subsequently scan the network based on a subset of\nthe obtained IPs. Only the addresses which start with the octet equal to “192”, “10”, “100”,\nor “172” are used, as these tend to correspond with local networks.\n\nFigure 16 - Compare the obtained IP with the targeted addresses\nThe newly created socket, using “WSASocketW”, will be linked to a completion port, using\n“CreateIoCompletionPort”. The SMB connection, using port 445, uses a callback to\n“ConnectEx”. Initially, the malware used the WinSock library to establish a TCP socket\nconnection using “WSAIoctl” to connect to “ConnectEx”. This way, connections that were\nmade earlier on the victim’s machine are enumerated and re-used, if possible, with the goal\nto encrypt files on the connected devices as well.\n\n\n-----\n\nFigure 17\n\n- Binding the socket to the completion port\nShares that do not have the strings “ADMIN$” and “IPC$” are added to the to-encrypt list,\nwhich is used by the encryption threads.\n\n\n-----\n\nFigure 18 - Add the targeted shares to the list\nOnce the encryption threads finish, the malware will terminate itself using “ExitProcess”.\n\nFigure\n\n19 - Malware's self-terminating call\nThe Linux Version\n\nPrior to the encryption of files, the Linux variant of the Royal ransomware checks the\nrandomness of generated values. If the randomness isn’t enough, 2048 bytes from\n“/dev/random” is read to seed it. If an error occurs during the reading of the data, or when\ncalling any of the random functions, the malware terminates itself.\n\n\n-----\n\nFigure 20 - RSA testing\nIf the prior tests are successful, a test string with the value “test” is then encrypted using the\nRSA public key that is present within the binary. If the outcome is correct, the debug output\nstates that it is, and the function returns true. If it fails, the function returns false.\n\nAs a next step, the local variables which are potentially set by the given flags, are initialized.\nThe flags are given in the table below.\n\nFlag\n\nDescription\n\n\n-----\n\nMandatory\n\nThe path to start the recursive encryption at. There is no flag for this behaviour, other than\nthe requirement for this to be the very first argument.\n\nYes\n\n-id\n\nThe victim ID to use, which needs to be exactly 32 (0x20) characters in size, or the malware\nshuts down early.\n\nYes\n\n-ep\n\nA numerical value no larger than 99, specifying how many percent of encountered files will\nbe encrypted. If this flag is omitted, the default value of 50 will be used.\n\nNo\n\n-vmonly\n\nIf this flag is combined with the fork flag, all files are encrypted. If used alone, nothing\nhappens.\n\nNo\n\n-fork\n\nForks the process and ensures that a new session is started prior to encrypting files.\n\nNo\n\n\n-----\n\n-logs\n\nPrints the debug messages to the standard output.\n\nNo\n\n-stopvm\n\nTerminates all ESXi VMs on the device, based on their World IDs.\n\nNo\n\nThe check for the encryption percentage, as is shown below, ensures the value is between\n1 and 99, or it will be set to 50.\n\nFigure 21 - Set the encryption percentage\nThe logging forces the debug messages to be printed through the standard output, as the\nscreenshot below shows.\n\nFigure 22 - Set the logging\nThe victim ID is, just like in the Windows version, mandatory. The length is, again, 32\ncharacters. If the ID is missing, or the length is not equal to 32 (or 0x20 in hexadecimal), an\nerror message is printed, and the function will return false. Returning false will cause the\nmalware to shut down directly afterwards.\n\n\n-----\n\nFigure 23 - VIctim ID handling\nTerminating Virtual Machines\n\nThe “-stopvm” flag is used to stop VMware ESXi virtual machines that are running on the\nhost. First the “esxcli” binary is executed via a new shell, with “vm process list > list” as\nparameters, which serve to store the list of existing virtual machines in the file “list” by\nredirecting the standard output to the file. The shell which executes the ESXi command-line\ninterface command is called via “execlp”, which overlays the forked process with the called\nprocess.\n\nFigure 24 - Terminate VMs\nAt last, the child process exits. The parent process, which is Royal Ransom, will wait for the\nchild to finish before it opens the “list” file. If it does not exist, the function will return. If it\ndoes return, the file size of “list” is checked. If this fails, the function returns as well.\n\n\n-----\n\nFigure 25 - Read the \"list\" file's size\nBased on the “list” file’s size, a new block of memory is allocated, after which the content is\nloaded into memory. The “World ID:” string is used to find the world ID, with the help of\n“strstr”, and the later the newline character (“\\n”).\n\nFigure 26 - Search through the \"list\" file\nEach of the obtained world IDs is used to terminate the VMs using the “esxcli” binary again,\nwith the following command-line arguments “vm process kill –type=hard –world-id=%s”\nwhere “%s” is the world ID.\n\nFigure 27 - Terminate a given VM\nSimilar to the previous process spawn, the combination of “fork”, “execlp”, “exit”, and “wait”\nensure that the ransomware only continues ones the newly spawned process has finished.\n\nFigure 28 - Wait until the termination finishes\nFile Encryption\n\nThe encryption can be performed by the main process, or by a forked process, depending\non the “-fork” flag, or the absence thereof. If the fork flag is set, a new session, using\n“setsid” is created, and the encryption is started. If the flag isn’t set, the encryption starts\n\n\n-----\n\nfrom the main process.\n\nFigure\n\n29 - Creates a new session (based on the \"-fork\" flag) and starts the encryption\nThe number of threads that are created to encrypt files with, is equal to two times the\nnumber of processors, which is obtained using “sysconf”. The calculation is the same as in\nthe Windows variant.\n\nThe public RSA key, which is embedded in the malware, is imported. The complete public\nkey is given at the start of this blog. If the import fails, the thread returns.\n\nFigure 30 - Import the RSA key\nThe encryption threads read, much like in the Windows version, the target files from a list. If\nthe list is empty the encryption threads wait. The encryption process starts by obtaining the\ntarget file’s size. Next, 48 bytes are randomly generated using random functions, and by\n\n\n-----\n\nreading from /dev/random . The first 32 bytes are the AES key, and the last 16 bytes are\nthe IV.\n\nFigure 31 - Generate the RSA block\nBoth values will be encrypted with the previously imported RSA public key. The first 512\nbytes of the encryption will be saved in the encrypted file, much like in the Windows version.\nThe values will be encrypted with the RSA imported key previously, and the 512 bytes block\nof the encryption later will be saved in the file as in the Windows version.\n\nThe usage of chunks is the same as the Windows version, where the encryption percentage\nis given via the command-line interface, or the default value of 50 is used. Again, files which\nare less than or equal to 5245000 bytes (5 megabytes, when adhering to 1024 bytes in a\nkilobyte, and so forth) are fully encrypted. Otherwise, the percentage decides the chunk\nsizes, which ensures the file is encrypted for a given percentage.\n\nFigure 32 - Encryption \"sanity\" checks\n\n\n-----\n\nThe encrypted file s size is inflated again, with 512 bytes to store the encrypted RSA block,\n8 bytes for the original file size, and 8 bytes to store the encryption percentage value.\n\nFigure 33 - Append additional data to the file\nThe AES key and the IV are cleared using “memset” once the encryption has finished, the\npurpose of which is to avoid access to the values in-memory. Afterwards, the written data is\nflushed, ensuring that the encrypted file’s data is written to the disk. The flushing is done\nwith “fsync”. Additionally, the extension “.royal_u” is appended to the filename.\n\nFigure 34 - Rename the target file\nRecursive Folder Enumeration\n\n\n-----\n\nMuch like any ransomware family, Royal Ransom enumerates all folders on the device\nrecursively to find files which can be encrypted. The first command-line interface argument,\nthe path, is used as the starting point. If the provided value is not a valid path, the malware\nwill terminate. If it is, the malware assumes it is a directory, and put a ransom note within\nthe given folder, under the “readme” name. The given victim ID is replaced within the\nransom note.\n\nFigure 35 - Write the ransom note\nAfter that, the file encryption starts recursively, excluding folders where the name is equal to\none or two dots.\n\nFigure 36\n\n- Encryption excludes \".\" and \"..\" folder names\nExcluded file names are files containing any of the following: “royal_u”, “royal_w”, “.sf”,\n“.v00”, “.b00”, “royal_log_”, “readme”. The “royal_w” seems to be a reference to the\nWindows version’s encrypted file extension, even though the “_w” part isn’t used in the\nWindows version. The “royal_log_” name seems to not be used by the ransomware.\n\nFigure 37 - Excluded file names\nIf a file is “eligible” for encryption, it is added to the list, which the encryption threads take\nitems from to encrypt, after which they are removed from the list. Once all folders have\nbeen recursively iterated through, the malware shuts down.\n\n\n-----\n\nAn Anonymized Incident Response Case\n\nThis section contains an anonymized incident response case, which is why certain\nindicators of compromise are omitted. The focus of this case is to show the tactics,\ntechniques, and procedures (TTPs) of an actor who encrypted systems with Royal Ransom.\nThe events in this case are described in chronological order, and happened in the last\nquarter of 2022.\n\nThe actor obtained the original initial access with a phishing e-mail. This e-mail, based on\nan existing and benign e-mail thread, contained a malicious attachment in the form of a\nHTML file (HTML smuggling). Upon opening the HTML file, an archive download prompt\npops up. The webpage is a lure which instructs the victim to download a file to correctly\ndisplay the file. The password for the archive is also given on the page.\n\nFigure 38 - The lure image\nThe archive itself contains an ISO image. This image, when mounted, contains multiple\nfiles: a shortcut (LNK) and a hidden folder with a decoy file, a batch file, and the Qbot\npayload. The batch file and Qbot payload are named “revalues.cmd” and “vindictive.dat”\nrespectively. The batch script copies the Qbot malware to the victim’s temporary folder and\nexecutes the payload from the mounted drive using “regsvr32”. The Batch script is executed\nusing: “C:\\Windows\\System32\\cmd.exe /c standby\\revalues.cmd regs”. The “regs”\nargument is used to complete the “regsvr32” name during the execution, as can be seen in\nthe script’s excerpt below.\n\n\n-----\n\nFigure 39 - Part of the batch script\nQbot later persists itself, with the help of [Runn registry entry, in the startup order. The entry](https://learn.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys)\nexecutes Qbot, again using “regsvr32”, every time the machine starts: “regsvr32.exe\n“C:\\Users\\[redacted]\\AppData\\Roaming\\Microsoft\\Jmcoiqtmeft\\nwthu.dll””. Note the double\nquotation marks to ensure the execution is successful even if the path contains one or more\nspaces.\n\nAbout four hours after the initial infection, Cobalt Strike was installed as a service on a\ndomain controller, running on the localhost’s port 11925. Note that the lateral movement to a\nfoothold on the domain controller was performed using Pass-the-Hash. The lateral\nmovement started an hour after the initial infection and took a bit more than two hours.\n[Additional tools to enumerate the active directory network were used, such as AdFind.](https://www.joeware.net/freetools/tools/adfind/)\n\nTo escalate privileges during the lateral movement, a UAC bypass was used. This bypass is\n[based on a race condition in Windows 10’s Disk Cleanup tool, as is explained here, where a](https://enigma0x3.net/2016/07/22/bypassing-uac-on-windows-10-using-disk-cleanup/)\nDLL hijack can lead to arbitrary code execution with elevated privileges. The command to\nexecute the UAC bypass is:\n“C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NoP -NonI -w Hidden -c\n$x=$((gp HKCU:Software\\Microsoft\\Windows Update).Update); powershell -NoP -NonI -w\nHidden -enc $x; Start-Sleep -Seconds 1\\system32\\cleanmgr.exe /autoclean /d C:”\n\nThe elevated privileges were used to run a PowerShell command which launches\n[PowerSploit (a post-exploitation framework) via Cobalt Strike’s service on port 11925. In this](https://github.com/PowerShellMafia/PowerSploit)\ncase, the [PowerView module got downloaded and executed. The module got downloaded](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)\nusing a PowerShell command: “IEX (New-Object\nNet.Webclient).DownloadString('http://127.0.0.1:11925/')”.\n\n[A few days later, once the actors got a firm foothold on the network, they used MEGAsync](https://github.com/meganz/MEGAsync)\nto exfiltrate more than 25 gigabytes of data. Yet another few days later, the Royal Ransom\nwas deployed. Noteworthy here is the executable’s name, which was tailed to the victim’s\nname. This shows the manual involvement of the actor.\n\n\n-----\n\nTo summarize this incident response case, the image below shows the actions on a day-today basis.\n\nFigure 40 - Incident response timeline\nAll in all, the quick turnaround from initial infection into a fully compromised environment\nshows why it is important to be on top of things from a blue team point of view. More\n[detailed information about Qbot can be found here, as well as a historic](https://www.trellix.com/en-us/about/newsroom/stories/research/qakbot-evolves-to-onenote-malware-distribution.html) [overview of Qbot’s](https://www.youtube.com/watch?v=jD0GdMXRP4s)\nchanges, the latter of which is provided by Threatray.\n\nProduct coverage\n\nTrellix products provide detection for Royal Ransomware using the following detection\nsignatures:\n\n\n-----\n\nProduct\n\n\nSignature\n\n\nEndpoint Security (ENS)\n\n\nRoyal Ransom!AFD5D656A42A\nLinux/Ransom!219761770AD0\n\n\nEndpoint Security (HX)\n\n\nGen:Variant.Ransom.Royal\nHX-AV : Gen:Variant.Trojan.Linux.Ransom.3\nGen:Heur.Ransom.REntS.Gen.1\nPOSSIBLE RANSOMWARE - VSSADMIN DELETE SHADOWS A\n(METHODOLOGY)\nROYAL RANSOMWARE (FAMILY)\n\n\nNetwork Security (NX)\nDetection as a Service\nEmail Security\nMalware Analysis\nFile Protect\n\n\nTrojan.Ransomware.Royal.DNS\nTrojan.Ransomware.Royal.DNS\nRoyal Ransomware File Upload And Download Attempt\nRoyal Ransomware Readme File Detected\nRansomware.Linux.Royal.MVX\nFE_Ransomware_Win_Royal_1\nFE_Ransomware_Win_Royal_2\nFE_Ransomware_Linux_Royal_1\nFE_Ransomware_Linux_Royal_2\nFE_Ransomware_Linux64_Royal_1\n\n\nHelix\n\n\n-----\n\n(1.1.1222)WINDOWS METHODOLOGY [VSSADMIN Delete\nShadows]\n(1.1.3505) '[RF] WINDOWS METHODOLOGY [Multiple Domain\nDiscovery Recon]\n(1.1.356) WINDOWS METHODOLOGY - PROCESSES [PsExec]\n\n\nConclusion\n\nThe Royal Ransom is actively used, as highlighted by the incident response case.\nAdditionally, the ransomware’s encryption scheme seems to be implemented properly. As\nsuch, recent back-ups or a decryptor are the only ways to recover lost files. The chunkbased encryption speeds up the encryption process while still ensuring files aren’t\nrecoverable.\n\nThe re-use of features between ransomware groups, such as Royal Ransom and Conti in\nthis alleged case, gives food for thought with regards to gangs collaborating, or gang\nmembers joining different (or additional) gangs. Bluntly put, the evolution of one gang’s\nransomware is bound to influence other ransomware gangs, which affects any organization\nthat is targeted. As such, it is important to stay on-top of changes and improve the security\nposture where required.\n\nAppendix A – MITRE ATT&CK Techniques\n\nThe techniques which are used in the Royal Ransom, as well as techniques which are used\nin the incident response case, are given below.\n\nAppendix B - Used Tools\n\nThe used tools are listed in the table below\n\nAppendix C - Yara rule\n\nThe Yara rule, given below, is used to detect Royal Ransom\n\nrule RoyalRansom\n{\nmeta:\nauthor = \"Max 'Libra' Kersten for Trellix' Advanced Research Center (ARC)\"\nversion = \"1.0\"\ndescription = \"Detects the Windows and Linux versions of Royal Ransom\"\ndate = \"20-03-2023\"\nmalware_type = \"ransomware\"\n\nstrings:\n$all_1 = \"http://royal2xthig3ou5hd7zsliqagy6yygk2cdelaxtni2fyad6dpmpxedid.onion/%s\"\n$all 2 = \"In the meantime, let us explain this case.It may seem complicated, but it is not!\"\n\n\n-----\n\n$all_3 = Royal offers you a unique deal.For a modest royalty(got it; got it ? ) for our\npentesting services we will not only provide you with an amazing risk mitigation service,\"\n$all_4 = \"Try Royal today and enter the new era of data security!\"\n$all_5 = \"We are looking to hearing from you soon!\"\n\ncondition:\nall of ($all_*)\n}\n\nThis document and the information contained herein describes computer security research\nfor educational purposes only and the convenience of Trellix customers. Any attempt to\nrecreate part or all of the activities described is solely at the user’s risk, and neither Trellix\nnor its affiliates will bear any responsibility or liability\n\n## Get the latest\n\nWe’re no strangers to cybersecurity. But we are a new company.\n\nStay up to date as we evolve.\n\nPlease enter a valid email address.\n\nZero spam. Unsubscribe at any time.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-03 - A Royal Analysis of Royal Ransom.pdf"
    ],
    "report_names": [
        "2023-04-03 - A Royal Analysis of Royal Ransom.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338926,
    "ts_updated_at": 1743041174,
    "ts_creation_date": 1683251246,
    "ts_modification_date": 1683251246,
    "files": {
        "pdf": "https://archive.orkl.eu/e329dde550ec99831874156b1256efd3890d8a5c.pdf",
        "text": "https://archive.orkl.eu/e329dde550ec99831874156b1256efd3890d8a5c.txt",
        "img": "https://archive.orkl.eu/e329dde550ec99831874156b1256efd3890d8a5c.jpg"
    }
}