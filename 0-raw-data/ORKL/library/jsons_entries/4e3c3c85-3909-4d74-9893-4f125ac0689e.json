{
    "id": "4e3c3c85-3909-4d74-9893-4f125ac0689e",
    "created_at": "2023-01-12T14:59:16.372931Z",
    "updated_at": "2025-03-27T02:14:05.954501Z",
    "deleted_at": null,
    "sha1_hash": "3cc1775b4ebdd3978305c76e6660d38f96108d03",
    "title": "2021-09-22 - Threat Analysis Report- PrintNightmare and Magniber Ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T16:05:16Z",
    "file_modification_date": "2022-05-28T16:05:16Z",
    "file_size": 1882215,
    "plain_text": "# Threat Analysis Report: PrintNightmare and Magniber Ransomware\n\n**[cybereason.com/blog/threat-analysis-report-printnightmare-and-magniber-ransomware](https://www.cybereason.com/blog/threat-analysis-report-printnightmare-and-magniber-ransomware)**\n\nWritten By\nCybereason Global SOC Team\n\nSeptember 22, 2021 | 15 minute read\n\n\n-----\n\nThe Cybereason Global Security Operations Center (GSOC) issues Cybereason Threat Analysis\nreports to inform on impacting threats. The Threat Analysis reports investigate these threats and\nprovide practical recommendations for protecting against them.\n\nIn this Threat Analysis Report, the Cybereason GSOC Team investigates infections with a recent\nversion of the Magniber ransomware in which the initial attack vector against the compromised\n[systems is the exploitation of the notorious PrintNightmare vulnerability described in CVE-2021-](https://www.cybereason.com/blog/threat-alert-printnightmare-critical-vulnerability-in-windows-print-spooler)\n34527.\n\n## Key Findings\n\n**[Critical Vulnerabilities: CVE-2021-34527 and CVE-2021-34481 are critical, remotely exploitable](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34481)**\nvulnerabilities in the Windows Print Spooler service that allow attackers to execute arbitrary code with\nadministrative privileges on target systems. The vulnerabilities exist in the Point and Print capability\non Windows systems and allow non-privileged users to install or update remote printers. CVE-202134527 and CVE-2021-34481 are collectively referred to as PrintNightmare.\n\n**Significant Ransomware Threat to Corporate Networks: Shortly after the public disclosure of**\nPrintNightmare CVE-2021-34527, malicious actors started exploiting this vulnerability. Ransomware\ngroups find PrintNightmare particularly attractive:\n\nPrintNightmare enables attackers to execute arbitrary code with administrative privileges.\nCVE-2021-34527 exists in the Point and Print Windows capability, which many large\ncorporate networks actively use. Ransomware groups typically target large corporate\nnetworks. Further, these large corporate networks often have many non-privileged users\nwho use remote printers.\n\n**The Magniber Ransomware and PrintNightmare: Malicious actors deploy the Magniber**\nransomware on compromised systems by exploiting PrintNightmare CVE-2021-34527. The Magniber\nransomware is continuously under active development, with frequent significant code changes and\nimprovements to obfuscation features, evasion tactics, and encryption mechanisms.\n\n**[Detected and Prevented: The Cybereason Defense Platform detects and prevents the Magniber](https://www.cybereason.com/platform)**\nransomware.\n\n**Cybereason Managed Detection and Response (MDR): The Cybereason GSOC has zero**\ntolerance towards attacks that involve ransomware groups, such as Magniber, and categorizes such\nattacks as critical, high-severity incidents. The [Cybereason GSOC MDR team issues a](https://www.cybereason.com/services/managed-detection-response-mdr)\ncomprehensive report to customers when such an incident occurs. The report provides an in-depth\noverview of the incident, which helps to scope the extent of compromise and the impact on the\ncustomer’s environment. In addition, the report provides attribution information when possible as well\nas recommendations for mitigating and isolating the threat.\n\n## Introduction\n\n[PrintNightmare CVE-2021-34527 is a critical vulnerability in the Windows Print Spooler service that](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34527)\nallows attackers to execute arbitrary code with administrative privileges on target systems. An\nadversary who successfully exploits CVE-2021-34527 could achieve full control over a target system\n\n\n-----\n\nby executing, for example, a dynamic link library (DLL) or a Windows executable with administrative\nprivileges.\n\n[The CVE-2021-34527 vulnerability exists in the Point and Print capability of Windows systems, which](https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-point-and-print)\nallows non-privileged users to install or update remote printers, without disks or other installation\nmedia, by establishing a connection to a remote printer.\n\nFollowing the public disclosure of the CVE-2021-34527 vulnerability on July 1, 2021, Microsoft\n[released an Out-of-Band Security Update addressing the vulnerability on July 6, 2021. Then, on July](https://msrc-blog.microsoft.com/2021/07/06/out-of-band-oob-security-update-available-for-cve-2021-34527/)\n15, 2021, Microsoft publicly disclosed another critical vulnerability in the Print Spooler service: CVE2021-34481. As with CVE-2021-34527, this vulnerability exists in the Point and Print capability and\nallows non-privileged users to execute arbitrary code with administrative privileges.\n\nDue to their similarities, CVE-2021-34527 and CVE-2021-34481 are now collectively referred to as\n[PrintNightmare. To address the PrintNightmare vulnerabilities, Microsoft released an update on](https://msrc-blog.microsoft.com/2021/08/10/point-and-print-default-behavior-change/?ranMID=24542&ranEAID=2QzUaswX1as&ranSiteID=2QzUaswX1as-LtjkkE3t8IlsobmMtjQkTQ&epi=2QzUaswX1as-LtjkkE3t8IlsobmMtjQkTQ&irgwc=1&OCID=AID2200057_aff_7593_1243925&tduid=%28ir__dujifp3kgckfqmolkk0sohz31m2xrlv2f3f31l2c00%29%287593%29%281243925%29%282QzUaswX1as-LtjkkE3t8IlsobmMtjQkTQ%29%28%29&irclickid=_dujifp3kgckfqmolkk0sohz31m2xrlv2f3f31l2c00)\nAugust 10, 2021 that modifies the behavior of Point and Print such that non-privileged users cannot\ninstall or update printers.\n\n[Shortly after the public disclosure of PrintNightmare CVE-2021-34527, malicious actors started](https://www.bleepingcomputer.com/news/security/microsoft-shares-mitigations-for-windows-printnightmare-zero-day-bug/)\nexploiting the vulnerability. Ransomware groups find PrintNightmare particularly attractive because\nthis vulnerability enables the execution of arbitrary code with administrative privileges.\n\nIn addition, the PrintNightmare vulnerabilities exist in the Windows Point and Print capability, which is\nactively used in large corporate networks, which are frequent targets of ransomware groups and\nwhere the use of remote printers by non-privileged users is common.\n\n[For example, the ransomware groups Vice Society and Magniber actively exploited CVE-2021-34527](https://www.zdnet.com/article/ransomware-now-attackers-are-exploiting-windows-printnightmare-vulnerabilities/)\nto deploy ransomware shortly after the public disclosure of the vulnerability. Ransomware groups\noften exploit newly disclosed vulnerabilities to deploy ransomware before vendors publicly release\npatches.\n\n[Threat researchers first observed the Magniber ransomware on compromised systems in 2017. At](https://www.zdnet.com/article/ransomware-security-researchers-spot-emerging-new-strain-of-malware/)\nthat time, malicious actors delivered Magniber primarily via the Magnitude exploit kit, which had often\nbeen used for delivering the Cerber, Locky, and Cryptowall ransomware.\n\n[Early versions of the Magniber ransomware targeted only Korean systems, since the ransomware](https://www.fireeye.com/blog/threat-research/2017/10/magniber-ransomware-infects-only-the-right-people.html)\nonly executed on operating systems where the system language was set to Korean. However, the\n[Magniber ransomware is continuously under active development, with frequent significant code](https://blog.malwarebytes.com/threat-analysis/2018/07/magniber-ransomware-improves-expands-within-asia/)\nchanges and improvements to obfuscation features, evasion tactics, and encryption mechanisms.\n\nMore recent implementations of the Magniber ransomware do not restrict the ransomware to Korean\nsystems or to any specific geographical region. The Magniber ransomware may be executed on any\nsystem, irrespective of the system’s geographical location.\n\n## PrintNightmare and Magniber Ransomware Analysis\n\nPrintNightmare CVE-2021-34527 is present in the Windows Print Spooler service, which executes as\nthe spoolsv.exe process in Windows systems. An adversary who successfully exploits CVE-202134527 could achieve full control over a target system by executing arbitrary code, such as a dynamic\n\n\n-----\n\nlink library (DLL) or a Windows executable, with administrative privileges.\n\nThe adversary must be authenticated to the Print Spooler service to take advantage of CVE-202134527. The RpcAddPrinterDriverEx function, implemented in the Print Spooler service, allows\nauthenticated users to deploy arbitrary DLLs or Windows executables on systems where the Print\n_Spooler service runs and execute these files with administrative (SYSTEM) privileges. According to_\nthe [CERT Coordination Center at Carnegie Mellon University:](https://www.kb.cert.org/vuls/id/383432)\n\nThe RpcAddPrinterDriverEx() function is used to install a printer driver on a system. One of the\nparameters to this function is the DRIVER_CONTAINER object, which contains information about\nwhich driver is to be used by the added printer. The other argument, dwFileCopyFlags, specifies how\nreplacement printer driver files are to be copied. An attacker can take advantage of the fact that any\nauthenticated user can call RpcAddPrinterDriverEx() and specify a driver file that lives on a remote\nserver. This results in the Print Spooler service spoolsv.exe executing code in an arbitrary DLL file\nwith SYSTEM privileges.\n\nWhen an adversary exploits CVE-2021-34527, the Print Spooler service writes any attacker-provided\nDLL in the %SYSTEM%\\System32\\spool\\drivers\\ directory (for example, in\n_C:\\Windows\\System32\\spool\\drivers\\x64\\3\\New). The vulnerable Print Spooler service (spoolsv.exe)_\nthen loads and executes the attacker-provided DLL with administrative privileges.\n\nThe actors behind the Magniber ransomware distribute the ransomware in the form of a Windows DLL\nfile. They take advantage of CVE-2021-34527 to deploy and execute this DLL file on compromised\nsystems. By exploiting CVE-2021-34527, adversaries write the DLL file of the Magniber ransomware\nin the %SYSTEM%\\System32\\spool\\drivers\\ directory (for example, in\n_C:\\Windows\\System32\\spool\\drivers\\x64\\3\\New) and execute it in the context of the Print Spooler_\nservice:\n\n_The Print Spooler service writes the attacker-provided calc.dll file (the DLL that implements the_\n_Magniber ransomware) when malicious actors exploit CVE-2021-34527_\n\nThe following chart provides an overview of the operation of the Magniber ransomware, implemented\nas a 64-bit DLL, referred to as Magniber DLL:\n\n\n-----\n\n_Overview of the operation of the Magniber ransomware_\n\nWhen executed in the context of spoolsv.exe, the Magniber ransomware first unpacks code stored in\nits data section. The ransomware then enumerates all running processes on the compromised system\nto identify processes in which the ransomware can inject the unpacked code. Magniber injects the\nunpacked code into each process that fulfills the following criteria:\n\nThe name of the process is not iexplore.exe.\nThe process integrity level is less than SYSTEM.\nThe process is not running in the WoW64 environment. WoW64 is a subsystem of the\nWindows operating system that enables the execution of 32-bit applications on 64-bit\nWindows operating systems.\n\nMagniber also executes the unpacked code in the context of spoolsv.exe itself as a backup\nmechanism that guarantees the execution of the code if the ransomware cannot inject the code into a\nprocess.\n\nTo inject the unpacked code into a process, the Magniber ransomware invokes the following\nsequence of Windows system calls:\n\n\n-----\n\n_NtCreateSection: The Magniber ransomware creates a new memory section that has_\n_RWX (read/write/execute) protection._\n_NtMapViewOfSection: Magniber maps the memory section in the virtual address space of_\nthe process in which the ransomware executes (i.e., spoolsv.exe) with RWX\n(read/write/execute) protection. The ransomware then writes the unpacked code into the\nmapped memory section.\n_NtMapViewOfSection: Magniber maps the memory section in the virtual address space of_\nthe process in which the ransomware injects code (for example, sihost.exe) with RWX\nprotection. The code that Magniber has written in the memory section mapped in the\nvirtual address space of spoolsv.exe is now mirrored (i.e., injected) in the memory section\nmapped in the virtual address space of sihost.exe.\n_NtCreateThreadEx: Magniber creates a thread in the context of sihost.exe, also known as_\na remote thread, and then suspends the execution of that thread.\n_NtGetContextThread: Magniber retrieves the context of the newly created remote thread._\nThread context is data related to the operation of the thread, which includes the values of\nthe registers associated with the thread, such as the thread’s instruction pointer register\n(rip).\n_NtSetContextThread: Magniber sets the value of the remote thread’s rip to the virtual_\naddress at which the memory section is mapped in the virtual address space of sihost.exe.\nThis causes the remote thread to execute the code stored in this memory section when\nthe thread resumes execution.\n_NtResumeThread: Magniber resumes the execution of the remote thread. This executes_\nthe injected code in the context of sihost.exe.\n\nThe Magniber ransomware does not execute Windows system calls by invoking functions\nimplemented in the DLL file ntdll.dll for that purpose, such as NtCreateSection or\n_NtMapViewOfSection. Instead, the ransomware invokes assembly code that first switches the_\nexecution context to the kernel and then executes the system call routines implemented as part of the\nkernel, a technique known as direct system call execution. This technique is used to avoid detection\nby security mechanisms that monitor Windows system call execution via hooks in ntdll.dll.\n\nTo directly execute a system call, the Magniber ransomware allocates a memory region in its virtual\naddress space and stores in this region the assembly language opcodes that conduct the direct\nexecution of the system call in Windows systems. The ransomware then executes the content of the\nmemory region, therefore directly executing the system call.\n\nOn 64-bit Windows systems, direct system call execution involves storing the system call identification\nnumber (system call ID, a number that uniquely identifies the system call) in the eax register and then\ninvoking the syscall instruction. The system call ID of a specific system call may differ for different\nreleases and builds of Windows systems.\n\nTo use the correct system call ID when directly executing a given system call, the Magniber\nransomware differentiates between Windows releases (for example, Windows 10 or pre-Windows 10\nsystems, such as Windows 7), down to specific build numbers (for example, Windows 10 build 18363\nor build 17763):\n\n\n-----\n\n_The Magniber ransomware conducts direct system call execution (direct execution of the_\n_NtCreateSection system call)_\n\nOnce injected and executed in the context of a remote thread, the code first unpacks itself and then\nexecutes a code segment. This code segment, referred to as the Magniber ransomware for simplicity,\nfirst creates and locks a mutex object named, for example, zarkzonn or dihlxbl, to ensure that only\none instance of the Magniber ransomware runs at a time.\n\nThis technique also prevents redundant executions of the same code injected into other processes.\nThe name of the mutex object is different for different versions of the Magniber ransomware.\n\nThe Magniber ransomware then builds a string based on the computer name of the compromised\nsystem and the serial number of a volume present on the system. The ransomware then appends the\nname of the mutex object to this string. The resulting string is specific to the compromised system and\nis called the compromised system identifier.\n\nMagniber then enumerates drives with removable and fixed media that are attached to the\ncompromised system, as well as remote drives. These are drives for which the Windows Application\nProgramming Interface (API) function _[GetDriveTypeW returns 0x2 (DRIVE_REMOVABLE), 0x3](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getdrivetypew)_\n(DRIVE_FIXED), or 0x4 (DRIVE_REMOTE), such as hard disks or network shares. For each such\ndrive, the Magniber ransomware conducts file enumeration and encryption in two phases.\n\n\n-----\n\nIn the first phase, Magniber encrypts files that the ransomware considers higher encryption priority.\nThese files have one of 714 file name extensions, and include .doc and .xls. In the second phase,\nMagniber encrypts files that are of lower encryption priority. These files have one of 33 file name\nextensions, and include .zip and .swf. As an anti-analysis technique, the Magniber ransomware stores\nan obfuscated form of the file name extensions of files of higher and lower encryption priority in its\ncontext.\n\n_File name extensions in obfuscated form_\n\nIn both phases, the Magniber ransomware encrypts only files that are allowlisted for encryption.\nMagniber does not encrypt the following files:\n\nFiles that have no file name extensions.\nFiles stored in the following directories: Documents and Settings, Winnt, AppData, Local\n_Settings, Sample Music, Sample Pictures, Sample Videos, Tor Browser, Recycle,_\n_Windows, Boot, Intel, Msocache, Perflogs, Program Files, ProgramData, Recovery, and_\n_System Volume Information._\n[Files stored in directories for which the Windows API function GetFileAttributesW returns](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfileattributesw)\n_FILE_ATTRIBUTE_SYSTEM, FILE_ATTRIBUTE_HIDDEN, or_\n_FILE_ATTRIBUTE_ENCRYPTED._\n[Files  for which the Windows API function GetFileAttributesW returns](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfileattributesw)\n_FILE_ATTRIBUTE_SYSTEM, FILE_ATTRIBUTE_HIDDEN,_\n_FILE_ATTRIBUTE_READONLY, FILE_ATTRIBUTE_TEMPORARY, or_\n_FILE_ATTRIBUTE_VIRTUAL._\n\n**File or Directory Attribute** **Description**\n\n_FILE_ATTRIBUTE_SYSTEM_ A file or directory that the Windows operating system uses.\n\n_FILE_ATTRIBUTE_HIDDEN_ A hidden file or directory.\n\n\n-----\n\n_FILE_ATTRIBUTE_ENCRYPTED_ A file that the Encrypted Filesystem (EFS) encrypts, or a\ndirectory in which the EFS encrypts every new file.\n\n_FILE_ATTRIBUTE_READONLY_ A read-only file.\n\n_FILE_ATTRIBUTE_TEMPORARY_ A file used for temporary storage.\n\n_FILE_ATTRIBUTE_VIRTUAL_ A file reserved for system use.\n\n_Attributes of files and directories that Magniber does not encrypt_\n\nThe Magniber ransomware encrypts files by applying a hybrid encryption approach that combines the\nuse of the Advanced Encryption Standard (AES) and the Rivest, Shamir, Adleman (RSA) encryption\nalgorithms. This approach maximizes both encryption performance and security. The Magniber\nransomware first encrypts a file by using the symmetric encryption algorithm AES.\n\nAES is by design more performant but less secure than the RSA encryption algorithm. AES relies on\na symmetric encryption key and an initialization vector (IV) for encryption security. To compensate for\nthis disadvantage of AES, the ransomware then encrypts the AES symmetric key and IV by using the\n[RSA encryption algorithm. The Magniber ransomware uses the Microsoft CryptoAPI for encryption.](https://docs.microsoft.com/en-us/windows/win32/seccrypto/cryptoapi-system-architecture)\n\nFor each file being encrypted, Magniber first generates two random arrays of 16 bytes. The first byte\narray is an AES symmetric encryption key and the second is an IV. The Magniber ransomware then\nencrypts equal-sized data blocks of the file being encrypted using the AES key and IV, such that each\ndata block is 1048576 bytes in size.\n\nAfter encrypting a data block, the Magniber ransomware writes the encrypted form of the data block in\nthe file, replacing the original data block. This encryption procedure ends in Magniber encrypting the\nlast data block of the file, which may be less than 1048576 bytes in size, by setting the parameter final\nof the [CryptEncrypt CryptoAPI function to 1:](https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptencrypt)\n\n\n-----\n\n_Unencrypted and encrypted form of a data block, encrypted using an AES key and IV_\n\nAfter encrypting all file data blocks, Magniber concatenates the AES key and IV and encrypts the\nresulting data by using a 2048-bit RSA public key. The file that implements the Magniber ransomware\nalso stores the public key. The ransomware then appends the encrypted form of the concatenated\nAES key and IV to the end of the file.\n\nMagniber then changes the file name extension of the file being encrypted by appending a file name\nextension that is the same as the name of the mutex object that the ransomware creates, such as\n_zarkzonn or dihlxbl. The ransomware then proceeds to encrypt the next file designated for encryption._\n\nAfter it encrypts all files stored in a folder, the Magniber ransomware places a readme.txt file that\ncontains a ransom note in the folder. The ransom note contains Uniform Resource Locators (URLs)\nunique to the compromised system such that the URL subdomain is the compromised system\n_identifier that the ransomware generates._\n\nAccording to available open-source intelligence (OSINT), the URLs point to a payment website that\ninstructs users to purchase software called My Decryptor to restore the files that the ransomware has\nencrypted. The URLs in the ransom note that Magniber left on the systems that the Cybereason\nGSOC analyzed were unreachable:\n\n\n-----\n\n_The Magniber ransomware ransom note_\n\nAfter finishing the two phases of file enumeration and encryption, if the Magniber ransomware has\nencrypted more than 1000000 bytes in total, Magniber places the readme.txt file in the %PUBLIC%\nfolder (for example, C:\\Users\\Public) and displays the file with the Notepad application (notepad.exe).\nMagniber also opens the default browser on the compromised system to display a payment website.\n\nBy doing this, Magniber also exfiltrates information about its operation on the compromised system by\nstoring the following values in URL query parameters:\n\nThe number of drives in which the ransomware has enumerated files.\nThe total size of encrypted data that the Magniber ransomware has generated (in bytes).\nThe number of files that the ransomware has encrypted.\nThe number of files that the ransomware has enumerated; this number includes both files\nthat the ransomware has encrypted and unencrypted files.\n\nThe build number of the compromised Windows operating system (e.g., 17763).\n\n_The Magniber ransomware exfiltrates information about its operation via URL query parameters_\n\n\n-----\n\nThe Magniber ransomware then releases and closes the named mutex object it has previously\nlocked, and executes the command vssadmin.exe Delete Shadows /all /quiet to delete shadow copies\nso that encrypted files cannot be recovered. Magniber executes this command with elevated\nprivileges by bypassing Windows User Account Control (UAC), as follows:\n\n_Magniber writes the command to be executed with elevated privileges in the (Default)_\n_registry value under the registry key HKCU\\Software\\Classses\\ms-_\n_settings\\shell\\open\\command on Windows 10 systems, or under the registry key_\n_HKCU\\Software\\Classes\\mscfile\\shell\\open\\command on earlier Windows releases._\n_On Windows 10 systems, Magniber creates the DelegateExecute registry value under the_\n_registry key HKCU\\Software\\Classes\\ms-settings\\shell\\open\\command._\n_Magniber executes computerdefaults.exe on Windows 10 systems, or_\n_CompMgmtLauncher.exe on earlier Windows releases, by executing the following_\n_command:_\n_cmd.exe /c %SystemRoot%\\system32\\wbem\\wmic process call create “/c_\n_computerdefaults.exe” or cmd.exe /c %SystemRoot%\\system32\\wbem\\wmic process call_\n_“create /c CompMgmtLauncher.exe”_\n_This, in turn, executes the command written in the (Default) registry value with elevated_\n_privileges._\n\nOne way in which Magniber deletes shadow copies is by writing the command\n_C:\\Windows\\System32\\wbem\\wmic process call create \"vssadmin.exe Delete Shadow /all /quiet\" in_\nthe (Default) registry value under the registry key HKCU\\Software\\Classes\\ms_settings\\shell\\open\\command or HKCU\\Software\\Classes\\mscfile\\shell\\open\\command._\n\nAnother way in which Magniber deletes shadow copies on Windows 10 systems is by writing the\n_JScript script depicted below in the %PUBLIC%\\readme.txt file, followed by writing the command_\n_regsvr32.exe scrobj.dll /s /u /n /i:%PUBLIC%\\readme.txt in the (Default) registry value under the_\nregistry key HKCU\\Software\\Classes\\ms-settings\\shell\\open\\command. After regsvr32.exe is finished\nexecuting, the Magniber ransomware deletes the %PUBLIC%\\readme.txt file.\n\nBoth approaches result in the execution of vssadmin.exe as a child process of the Windows\n_Management Instrumentation (WMI) Provider Host process (wmiprvse.exe) with elevated privileges:_\n\n_A Jscript script that executes vssadmin.exe_\n\nThe Cybereason platform detects the Magniber ransomware deleting shadow copies. After deleting\nshadow copies, the Magniber ransomware terminates its operation:\n\n\n-----\n\n_The Magniber ransomware deletes shadow copies_\n\n## Detection and Prevention\n\n### PrintNightmare Vulnerabilities\n\nThe Cybereason GSOC recommends the following:\n\n[Update your systems. Microsoft released an update that addresses the PrintNightmare](https://msrc-blog.microsoft.com/2021/08/10/point-and-print-default-behavior-change/?ranMID=24542&ranEAID=2QzUaswX1as&ranSiteID=2QzUaswX1as-LtjkkE3t8IlsobmMtjQkTQ&epi=2QzUaswX1as-LtjkkE3t8IlsobmMtjQkTQ&irgwc=1&OCID=AID2200057_aff_7593_1243925&tduid=%28ir__dujifp3kgckfqmolkk0sohz31m2xrlv2f3f31l2c00%29%287593%29%281243925%29%282QzUaswX1as-LtjkkE3t8IlsobmMtjQkTQ%29%28%29&irclickid=_dujifp3kgckfqmolkk0sohz31m2xrlv2f3f31l2c00)\nvulnerabilities.\nDisable the Windows Print Spooler service if this service is not necessary. To do this, use\none of the following methods.\n\nExecute the following system command: net stop spooler\n\nExecute the following PowerShell command: Stop-Service -Name Spooler -Force & Set_Service -Name Spooler -StartupType Disabled_\n\nIf you do not want to disable the Print Spooler service, modify the SYSTEM user privileges\nso that this user cannot write in the %SYSTEM%\\System32\\spool\\drivers\\ directory. This\naction effectively blocks the deployment of attacker-provided DLLs or Windows\nexecutables by exploiting PrintNightmare CVE-2021-34527. To do this, execute the\nfollowing PowerShell script:\n\n\n-----\n\n$Path = \"C:\\Windows\\System32\\spool\\drivers\n\n$Acl = Get-Acl $Path\n\n$Ar = New-Object\n\nSystem.Security.AccessControl.FileSystemAccessRule(\"System\", \"Modify\", \"ContainerInherit,\nObjectInherit\", \"None\", \"Deny\")\n\n$Acl.AddAccessRule($Ar)\n\nCheck for potential CVE-2021-34527 exploitation attempts by executing the following\nPowerShell command:\n\n_Get-WinEvent -LogName 'Microsoft-Windows-PrintService/Admin' | Select-String -_\n_InputObject {$_.message} -Pattern 'The print spooler failed to load a plug-in module'. The_\npresence of the following log message indicates that the Print Spooler service has\nattempted to execute a DLL or a Windows executable, which an attacker may have\nprovided when exploiting PrintNightmare: The print spooler failed to load a plug-in module.\nThreat Hunting with Cybereason: The Cybereason MDR team provides its customers with\ncustom hunting queries for detecting specific threats - to find out more about threat hunting\n[and Managed Detection and Response with the Cybereason Defense Platform, contact a](https://www.cybereason.com/platform/managed-detection-response-mdr)\nCybereason Defender here.\n\n[For Cybereason customers: More details available on the NEST including custom](https://nest.cybereason.com/knowledgebase/3343711)\nthreat hunting queries for detecting this threat.\n\n### Magniber Ransomware\n\nThe Cybereason GSOC recommends the following:\n\nEnable the Anti-Ransomware feature of the Cybereason platform by setting it to Suspend\nor Prevent. The [Cybereason Defense Platform detects the Magniber ransomware using](https://www.cybereason.com/platform)\nmulti-layer protection that detects and blocks ransomware with threat intelligence, machine\nlearning, and next-gen antivirus (NGAV) capabilities.\nConsider additional, proactive ways for detecting the presence of the Magniber\n[ransomware in systems and defending against this threat, such as YARA-based detection](https://github.com/VirusTotal/yara/)\nor mutex object locking.\nThreat Hunting with Cybereason: The Cybereason MDR team provides its customers with\ncustom hunting queries for detecting specific threats - to find out more about threat hunting\n[and Managed Detection and Response with the Cybereason Defense Platform, contact a](https://www.cybereason.com/platform/managed-detection-response-mdr)\nCybereason Defender here.\n\n[For Cybereason customers: More details available on the NEST including custom](https://nest.cybereason.com/knowledgebase/3343711)\nthreat hunting queries for detecting this threat.\n\n\n-----\n\n_The Cybereason Defense Platform detects the Magniber ransomware based on threat intelligence_\n\n_The Anti-Ransomware feature of the Cybereason Defense Platform detects the Magniber_\n_ransomware_\n\n### YARA-Based Detection\n\nThe following YARA rule is useful for detecting the presence of the Magniber ransomware in the\ncontext of running processes or in the filesystem:\n\n\n-----\n\nrule Magniber_ransomware\n\n{\n\nmeta:\n\ndescription = \"YARA rule for identifying the Magniber ransomware.\"\n\nauthor = \"Aleksandar Milenkoski\"\n\ndate = \"2021-08\"\n\nstrings:\n\n$code1 = { C7 45 F0 4C 8B D1 B8 C7 45 F4 00 00 00 00 66 C7 45 F8 0F 05 C6 45 FA C3 }\n\n$code2 = { 81 F9 39 38 00 00 ?? ?? ?? ?? ?? ?? 81 F9 D7 3A 00 00 ?? ?? ?? ?? ?? ?? 81 F9\nAB\n\n3F 00 00 ?? ?? ?? ?? ?? ?? 81 F9 EE 42 00 00 ?? ?? ?? ?? ?? ?? 81 F9 63 45 00 00 ?? ?? ??\n\n?? ?? ?? 81 F9 BA 47 00 00 }\n\n$code3 = { 83 3C 25 6C 02 FE 7F 0A }\n\ncondition:\n\nuint16(0) == 0x5A4D and uint32(uint32(0x3C)) == 0x00004550 and $code3 and 2 of\n\n($code1,$code2)\n\n}\n\n_YARA rule for identifying the Magniber ransomware_\n\n### Mutex Object Locking\n\nMagniber creates and locks a mutex object named, for example, zarkzonn or dihlxbl, such that the\nname of the mutex is different for different versions of the Magniber ransomware. If this mutex object\nalready exists and is therefore locked, the ransomware terminates without encrypting any data.\n\nThis is to the advantage of defenders, as a mutex object named, for example, zarkzonn or dihlxbl, can\nbe locked by a legitimate process on a given system with the intention to stop any potential future\nexecution of the Magniber ransomware on the system.\n\nThe PowerShell script below demonstrates this defense technique. The script creates, opens, and\nlocks a mutex object named dihlxbl, and releases the object when the user issues the Ctrl+C\ncommand. Users can execute the script by issuing the command powershell.exe\n_./magniber_mutex_lock.ps1 in the directory where the script file is stored, where_\n_magniber_mutex_lock.ps1 is the filename of the script file:_\n\n\n-----\n\nfunction create_mutex\n\n{\n\n$created = $False\n\n$mutex = New-Object -TypeName System.Threading.Mutex($true, \"dihlxbl\", [ref]$created)\n\nWrite-Host \"Mutex object named dihlxbl created, opened, and locked: $created.\"\n\nreturn $mutex\n\n}\n\nfunction release_mutex\n\n{\n\nparam (\n\n$mutex\n\n)\n\n$mutex.ReleaseMutex()\n\n$mutex.Dispose()\n\n}\n\n$mutex = create_mutex\n\ntry\n\n{\n\nwhile($true)\n\n{\n\nStart-Sleep -Seconds 1\n\n}\n\n}\n\nfinally{\n\nrelease_mutex($mutex)\n\nWrite-Host \"Mutex object released.\"\n\n}\n\n_PowerShell script that locks a mutex object named dihlxbl_\n\n## General Recommendations\n\n\n-----\n\nIn addition to specific recommendations for PrintNightmare and the Magniber ransomware,\nCybereason offers the following general security recommendations:\n\nMake sure your systems are timely patched in order to minimise the risk of ransomware\ninfections by vulnerability exploitation.\nUse secure passwords, regularly rotate passwords, and use multi-factor authentication\nwhere possible.\nRegularly backup files to a secured remote location and implement a data recovery plan.\nRegular data backups ensure that you can restore your data after a ransomware attack.\nSecurely handle email messages that originate from external sources. This includes\ndisabling hyperlinks and investigating email message content to identify phishing\nattempts.\n\nCybereason is dedicated to teaming with defenders to end cyber attacks from endpoints to the\nenterprise to everywhere—including modern ransomware. Learn more about ransomware defense\n[here or schedule a demo today to learn how your organization can benefit from an operation-centric](https://www.cybereason.com/request-a-demo)\napproach to security.\n\n## Indicators of Compromise\n\n**Executables** SHA-256 hash:\n\n_10B9B1D8F6BAFD9BB57CCFB1DA4A658F10207D566781FA5FB3C4394D283E860E_\n\nFile size: 21504 bytes\n\n\n**Associated**\n**files**\n\n**Mutex**\n**objects**\n\n**File name**\n**extensions**\n\n\n_readme.txt_\n\n_dihlxbl_\n\n_dihlxbl_\n\n\n-----\n\n**Domains** _l5nmxg2syswnc6s3724evnip5uktj7msy3pgowkbcidbei3nbysi7ead.onion_\n\n_uponmix.xyz_\n\n_flysex.space_\n\n_partscs.site_\n\n_codehes.uno_\n\n\n**Registry**\n**keys**\n\n\n_HKCU\\Software\\Classes\\ms-settings\\shell\\open\\command\\(Default)_\n\n_HKCU\\Software\\Classes\\mscfile\\shell\\open\\command\\(Default)_\n\n_HKCU\\Software\\Classes\\ms-settings\\shell\\open\\command\\DelegateExecute_\n\n\n## MITRE ATT&CK Techniques\n\n**Execution** **Privilege Escalation** **Defense Evasion** **Discovery** **Impact**\n\n\n[Native API](https://attack.mitre.org/techniques/T1106/) Abuse Elevation Control\n[Mechanism: Bypass User](https://attack.mitre.org/techniques/T1548/002/)\nAccount Control\n\n## About the Researchers:\n\n\nIndicator Removal on\nHost: File Deletion\n\n[Modify registry](https://attack.mitre.org/techniques/T1112/)\n\nObfuscated Files or\n[Information: Software](https://attack.mitre.org/techniques/T1027/002/)\nPacking\n\n\nFile and\n[Directory](https://attack.mitre.org/techniques/T1083/)\nDiscovery\n\n\nData\n[Encrypted](https://attack.mitre.org/techniques/T1486/)\nfor Impact\n\n\n**Aleksandar Milenkoski, Senior Threat and Malware Analyst, Cybereason Global SOC**\n\n\n-----\n\nAleksandar Milenkoski is a Senior Threat and Malware Analyst with the Cybereason\n\nGlobal SOC team. He is involved primarily in reverse engineering and threat research activities.\nAleksandar has a PhD in system security. Prior to Cybereason, his work focussed on research in\nintrusion detection and reverse engineering security mechanisms of the Windows 10 operating\nsystem.\n\n**Eli Salem, Senior Security Analyst, Cybereason Global SOC**\n\nEli is a lead threat hunter and malware reverse engineer at Cybereason. He has worked\n\nin the private sector of the cyber security industry since 2017. In his free time, he publishes articles\nabout malware research and threat hunting.\n\nAbout the Author\n\n**Cybereason Global SOC Team**\n\n\n-----\n\nThe Cybereason Global SOC Team delivers 24/7 Managed Detection and Response services to\ncustomers on every continent. Led by cybersecurity experts with experience working for government,\nthe military and multiple industry verticals, the Cybereason Global SOC Team continuously hunts for\nthe most sophisticated and pervasive threats to support our mission to end cyberattacks on the\nendpoint, across the enterprise, and everywhere the battle moves.\n\n[All Posts by Cybereason Global SOC Team](https://www.cybereason.com/blog/authors/cybereason-global-soc-team)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-22 - Threat Analysis Report- PrintNightmare and Magniber Ransomware.pdf"
    ],
    "report_names": [
        "2021-09-22 - Threat Analysis Report- PrintNightmare and Magniber Ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "84aa9dbe-e992-4dce-9d80-af3b2de058c0",
            "created_at": "2024-02-02T02:00:04.041676Z",
            "updated_at": "2025-03-27T02:00:03.297502Z",
            "deleted_at": null,
            "main_name": "Vanilla Tempest",
            "aliases": [
                "DEV-0832",
                "Vice Society"
            ],
            "source_name": "MISPGALAXY:Vanilla Tempest",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "600a0c3b-b595-4d10-b84b-cc2cf89289ac",
            "created_at": "2024-06-19T02:03:08.134296Z",
            "updated_at": "2025-03-27T02:05:17.402638Z",
            "deleted_at": null,
            "main_name": "GOLD VICTOR",
            "aliases": [
                "STAC5279 ",
                "Vanilla Tempest ",
                "Vice Society",
                "DEV-0832 "
            ],
            "source_name": "Secureworks:GOLD VICTOR",
            "tools": [
                " Advanced Port Scanner",
                " HelloKitty ransomware",
                " MEGAsync",
                " Neshta",
                " PAExec",
                " PSexec",
                " PortStarter",
                " SystemBC",
                " Zeppelin ransomware",
                "Advanced IP Scanner"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8941e146-3e7f-4b4e-9b66-c2da052ee6df",
            "created_at": "2023-01-06T13:46:38.402513Z",
            "updated_at": "2025-03-27T02:00:02.824555Z",
            "deleted_at": null,
            "main_name": "Sandworm",
            "aliases": [
                "G0034",
                "IRIDIUM",
                "Blue Echidna",
                "FROZENBARENTS",
                "Seashell Blizzard",
                "IRON VIKING",
                "ELECTRUM",
                "TeleBots",
                "UAC-0113",
                "UAC-0082",
                "APT44",
                "Quedagh",
                "VOODOO BEAR",
                "TEMP.Noble"
            ],
            "source_name": "MISPGALAXY:Sandworm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "7bd810cb-d674-4763-86eb-2cc182d24ea0",
            "created_at": "2022-10-25T16:07:24.1537Z",
            "updated_at": "2025-03-27T02:02:10.126127Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "APT 44",
                "ATK 14",
                "BE2",
                "Blue Echidna",
                "CTG-7263",
                "FROZENBARENTS",
                "IRIDIUM",
                "Iron Viking",
                "Quedagh",
                "Sandworm",
                "Sandworm Team",
                "Seashell Blizzard",
                "TEMP.Noble",
                "UAC-0082",
                "UAC-0113",
                "UAC-0125",
                "UAC-0133",
                "Voodoo Bear"
            ],
            "source_name": "ETDA:Sandworm Team",
            "tools": [
                "AWFULSHRED",
                "ArguePatch",
                "BIASBOAT",
                "Black Energy",
                "BlackEnergy",
                "CaddyWiper",
                "Colibri Loader",
                "Cyclops Blink",
                "CyclopsBlink",
                "DCRat",
                "DarkCrystal RAT",
                "Fobushell",
                "GOSSIPFLOW",
                "Gcat",
                "IcyWell",
                "Industroyer2",
                "JaguarBlade",
                "JuicyPotato",
                "Kapeka",
                "KillDisk.NCX",
                "LOADGRIP",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "ORCSHRED",
                "P.A.S.",
                "PassKillDisk",
                "Pitvotnacci",
                "PsList",
                "QUEUESEED",
                "RansomBoggs",
                "RottenPotato",
                "SOLOSHRED",
                "SwiftSlicer",
                "VPNFilter",
                "Warzone",
                "Warzone RAT",
                "Weevly"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535556,
    "ts_updated_at": 1743041645,
    "ts_creation_date": 1653753916,
    "ts_modification_date": 1653753916,
    "files": {
        "pdf": "https://archive.orkl.eu/3cc1775b4ebdd3978305c76e6660d38f96108d03.pdf",
        "text": "https://archive.orkl.eu/3cc1775b4ebdd3978305c76e6660d38f96108d03.txt",
        "img": "https://archive.orkl.eu/3cc1775b4ebdd3978305c76e6660d38f96108d03.jpg"
    }
}