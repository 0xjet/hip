{
    "id": "4f5b4478-3ef1-4624-9b59-1c89fd1dad86",
    "created_at": "2023-01-12T15:09:32.721896Z",
    "updated_at": "2025-03-27T02:12:03.938991Z",
    "deleted_at": null,
    "sha1_hash": "8d795914cabfeeb0734507e4f01468081a294b58",
    "title": "2021-04-16 - Could the Microsoft Exchange breach be stopped-",
    "authors": "",
    "file_creation_date": "2022-05-28T21:39:08Z",
    "file_modification_date": "2022-05-28T21:39:08Z",
    "file_size": 1578590,
    "plain_text": "# Could the Microsoft Exchange breach be stopped?\n\n**[trendmicro.com/en_us/research/21/d/could-the-microsoft-exchange-breach-be-stopped.html](https://www.trendmicro.com/en_us/research/21/d/could-the-microsoft-exchange-breach-be-stopped.html)**\n\nAPT & Targeted Attacks\n\n\nApril 16, 2021\n\n\nA look at the latest Microsoft zero-day exploits and how Trend Micro could help protect you.\n\nBy: Nitesh Surana April 16, 2021 Read time: ( words)\n\nLast March it seemed the world came to a stand-still as the COVID-19 pandemic begin to\nrapidly spread. While businesses, sporting events, and schools started shutting down,\ncybercriminals remained active as ever. In 2020, the Trend Micro Zero Day Initiative™ (ZDI)\n[published 1,453 advisories, the most ever in the history of the program. More startling is the](https://www.zerodayinitiative.com/blog/2021/1/14/looking-back-at-the-zero-day-initiative-in-2020)\nfact that 18.6% of all disclosures were published without a fix from the vendor—another\nrecord-breaking stat.\n\nAs ZDI predicted, 2021 continued to be a busy year. In March 2021, Microsoft kicked off the\n[patch cycle early after releasing an advisory regarding the mass exploitation of four zero-](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)\ndays vulnerabilities by a Chinese Hacking group, HAFNIUM, on the on-premises versions of\nthe Microsoft Exchange Server. In the following days of the attack, [Trend Micro reported that](https://www.trendmicro.com/en_us/research/21/c/microsoft-exchange-attack.html)\nat least 30,000 organizations were thought to have been attacked in the US, and 63,000\nservers remained exposed to these exploits.\n\n\n-----\n\n[The vulnerability has been dubbed as ProxyLogon by the researchers at DEVCORE, who](https://proxylogon.com/)\nare credited with finding the bugs in the proxy architecture and the logon mechanism of\n[Exchange. DEVCORE reported two of the four zero-days (CVE-2021-26855 and](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26855) CVE-2021[27065) to Microsoft Security Response Center (MSRC). On March 2, Volexity reported in-](https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities/)\n[the-wild exploitation of the vulnerabilities, to which DEVCORE confirmed that the exploit](https://proxylogon.com/)\nobserved by Volexity was the one submitted to MSRC.\n\nSince then, there has been opportunistic exploitation by various threat actors and\nransomware groups (Dearcry, BlackKingdom) since majority of Outlook Web App portals are\npublic and indexed by search engines like Google Search, Shodan, Binaryedge, Censys,\nZoomeye etc. According to [Shodan, on March 4, there were more than 266,000 Exchange](https://twitter.com/shodanhq/status/1367525621065261062)\nServers vulnerable to the ProxyLogon vulnerability, a day after the patch was released.\n\nFig \nShodan Results\n\nIn lieu of these exploits, let’s take a look at how Trend Micro Vision One™ and Trend Micro\nCloud One™ can provide protection against two of the four zero-days, CVE-2021-26855 and\nCVE-2021-27065.\n\n**Overview:**\nTwo bugs are chained to achieve the remote code execution and for the attack to be\nsuccessful, an attacker requires access to the Outlook Web App portal of the vulnerable\nExchange Server, and a valid email address.\n\n\n-----\n\n1. CVE-2021-26855: Microsoft Exchange Server Remote Code Execution Vulnerability\n\n(pre-authenticated Server-Side Request Forgery [SSRF])\n2. CVE-2021-27065: Microsoft Exchange Server Remote Code Execution Vulnerability\n\n(post-authenticated Arbitrary File Write)\n\nFig - MS Exchange Client Access Protocol Architecture\n\nThe Client Access services (Outlook Web App portal) proxies the incoming connections to\n[the Backend services. As per the Exchange documentation, clients don’t directly connect to](https://docs.microsoft.com/en-us/exchange/architecture/architecture?view=exchserver-2019)\nthe backend services. But because of the SSRF vulnerability, attackers can query the\ninternal backend services and APIs on the Exchange Server, bypassing the frontend proxy.\n\n\n-----\n\nBy abusing the SSRF, attackers can create session IDs and access tokens for privileged\naccounts with the context of the Exchange Control Panel, which can be used to write files\nwith attacker-controlled content at a location on the target server, chosen by the attacker.\nSince Exchange depends on Internet Information Services (IIS) webserver, an attacker can\nwrite ASPX webshells and run arbitrary commands as SYSTEM on the Exchange Server.\n\n[In January 2021, we came across extensive use of Chopper ASPX webshells in targeted](https://www.trendmicro.com/en_us/research/21/a/targeted-attack-using-chopper-aspx-web-shell-exposed-via-managed.html)\nattacks by malicious actors to establish persistence and a foothold on the public-facing\nOutlook Web App servers.\n\nTrend Micro Cloud One™ – Workload Security Correlation:\nTrend Micro Cloud One™ – Workload Security is a cloud-native solution that provides\nautomated security via powerful APIs. Security as code allows DevOps teams to bake\nsecurity into their build pipeline to release continuously and frequently, so developers like\nyourself, can keep working without disruption from security. Workload Security uses\n[advanced security controls such as intrusion prevention system (IPS), deep packet](https://www.trendmicro.com/en_us/business/capabilities/intrusion-prevention.html)\n[inspection (DPI), and integrity monitoring to protect Exchange Servers from attackers that](https://www.trendmicro.com/en_us/business/capabilities/integrity-monitoring.html)\ncould exploit ProxyLogon. The following detection rules safeguard a vulnerable Exchange\nServer from the CVEs reported:\n\nIntrusion Prevention System detections:\n\n1. 1010854 - Microsoft Exchange Server Remote Code Execution Vulnerability (CVE\n2021-26855)\n2. 1010868 - Microsoft Exchange Server Remote Code Execution Vulnerability (CVE\n2021-27065)\n3. 1010870 - Microsoft Exchange Server Remote Code Execution Vulnerability (CVE\n2021-27065) – 1\n4. 1007170 - Identified Suspicious China Chopper Webshell Communication (ATT&CK\n\nT1100)\n5. 1005934 - Identified Suspicious Command Injection Attack\n\nIntegrity Monitoring detections:\n\n1. 1010855 - Microsoft Exchange - HAFNIUM Targeted Vulnerabilities\n\n\n-----\n\n1010854 - Microsoft Exchange Server Remote Code Execution Vulnerability (CVE-202126855)\n\n\n-----\n\n1007170 - Identified Suspicious China Chopper Webshell Communication (ATT&CK T1100)\n\n\n-----\n\n1010870 - Microsoft Exchange Server Remote Code Execution Vulnerability (CVE-202127065) - 1\n\n\n-----\n\n1005934 - Identified\n\n\nSuspicious Command Injection Attack\nIM Rules:\n\n\n-----\n\n1010855 \n\nMicrosoft Exchange - HAFNIUM Targeted Vulnerabilities\nTrend Micro Vision One™ Correlation:\n\n\n-----\n\nFig - Microsoft Exchange Server RCE Vulnerability (CVE-2021-26855 + CVE-2021-27065)\n\nTrend Micro Vision One™ is a purpose-built, threat defense platform with extended detection\nand response (XDR) capabilities that work to prevent majority of attacks with automated\nprotection. The solution allows you to see more and respond faster by collecting and\ncorrelating data across email, endpoints, servers, cloud workloads, and networks.\n\nUsing the [Trend Micro Vision One Workbench, you can easily see what threats were](https://www.youtube.com/watch?v=odGDYzQbe80)\ndetected, attack techniques, and a prioritized list of risky devices and users. With Trend\n[Micro Vision One, we ran a public proof of concept (PoC) available online exploiting the](https://github.com/p0wershe11/ProxyLogon/blob/main/ProxyLogon.py)\nProxyLogon vulnerability. The above image shows the vulnerability detected and all the\nassets related to the alert for further investigation. Let’s take a deeper look:\n\n\n-----\n\nFig - Potential Chopper Webshell Detection\n\nThe Potential Chopper Webshell Execution model triggers when the web shell is already\npresent on the machine and is being used as a backdoor to run commands as SYSTEM on\nthe Exchange Server using China Chopper.\n\nThe metrics provided by this model should be investigated carefully, since the ProxyLogon\nzero-day vulnerability was exploited in-the-wild, before Microsoft addressed the issue\n[publicly. Microsoft has since taken things a step further by creating patches for out-of-support](https://techcommunity.microsoft.com/t5/exchange-team-blog/march-2021-exchange-server-security-updates-for-older-cumulative/ba-p/2192020)\nversions of Exchange. Overall, Microsoft released patches for 89 unique CVEs in March—14\nof which were listed as Critical and 75 listed as Important in severity.\n\n\n-----\n\nFig - Microsoft Exchange Server Possible ASPX Web Shell\nThe above model triggers when a new web shell is created. You can see the path and name\nof the web shell.\n\nFig - Potential Chopper Webshell Execution\n\n\n-----\n\nFig - Identified Suspicious China Chopper Webshell Communication\n\nFig - Possible Credential Dumping via Command Line\nThis model is triggered when an attacker fetches the credentials using a command-line from\nwithin the memory using Mimikatz. Since the web shell runs as the SYSTEM user, an\nattacker can fetch the NT LAN Manager (NTLM) hashes of the logged-in users, create or\ndelete accounts, and perform extensive post-exploitation activities on the Exchange Server.\n\n\n-----\n\nFigure \n\nExecuting Mimikatz as SYSTEM using CC\n\n\n-----\n\nFig - System Owner User Discovery\nThe above event was triggered when we ran whoami from within the Chopper web shell.\nSince requests to the ASPX web shell are handled by the privileged w3wp.exe, an IIS\nWorker Process in the configured IIS application pool (Microsoft Exchange App pool) runs\nthe commands in the context of NT Authority\\SYSTEM user.\n\nRCA Diagrams:\n\nFig. Executing commands using Chopper CnC\nConclusion\n\nThere is no silver bullet when it comes to cybersecurity but using solutions that bake into\nyour development pipeline to provide security as early as possible is better than scrambling\n\n\n-----\n\nfor patches after deployment. Quick and easy to deploy solutions like Trend Micro Cloud One\nand Trend Micro Vision One can provide you with SecOps-approved security from build-time\nto runtime without slowing you down. Imagine that!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-16 - Could the Microsoft Exchange breach be stopped-.pdf"
    ],
    "report_names": [
        "2021-04-16 - Could the Microsoft Exchange breach be stopped-.pdf"
    ],
    "threat_actors": [
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536172,
    "ts_updated_at": 1743041523,
    "ts_creation_date": 1653773948,
    "ts_modification_date": 1653773948,
    "files": {
        "pdf": "https://archive.orkl.eu/8d795914cabfeeb0734507e4f01468081a294b58.pdf",
        "text": "https://archive.orkl.eu/8d795914cabfeeb0734507e4f01468081a294b58.txt",
        "img": "https://archive.orkl.eu/8d795914cabfeeb0734507e4f01468081a294b58.jpg"
    }
}