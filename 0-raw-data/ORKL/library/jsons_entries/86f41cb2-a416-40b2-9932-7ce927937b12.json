{
    "id": "86f41cb2-a416-40b2-9932-7ce927937b12",
    "created_at": "2022-10-25T16:48:22.02089Z",
    "updated_at": "2025-03-27T02:05:35.165594Z",
    "deleted_at": null,
    "sha1_hash": "70c9ebf707682ca2311e3cedf264f4e7c66d7a15",
    "title": "",
    "authors": "",
    "file_creation_date": "2022-03-02T02:34:36Z",
    "file_modification_date": "2022-03-02T02:34:36Z",
    "file_size": 1790863,
    "plain_text": "# Campaign Abusing Legitimate Remote Administrator Tools Uses Fake Cryptocurrency Websites\n\n**[trendmicro.com/en_us/research/21/k/campaign-abusing-rats-uses-fake-websites.html](https://www.trendmicro.com/en_us/research/21/k/campaign-abusing-rats-uses-fake-websites.html)**\n\nNovember 29, 2021\n\nMalware\n\nWe have been tracking a campaign involving the SpyAgent malware that abuses wellknown remote access tools (RATs) for some time now. While previous versions of the\nmalware have been covered by other researchers, our blog entry focuses on the malicious\nactor’s latest attacks.\n\nBy: Jaromir Horejsi\nNovember 29, 2021\nRead time: 6 min (1686 words)\n\n## Introduction\n\nWe have been tracking a campaign involving the SpyAgent malware that abuses wellknown remote access tools (RATs) — namely TeamViewer — for some time now. While\n[previous versions of the malware have been covered by other researchers, our blog entry](https://vms.drweb.com/virus/?i=8421714)\nfocuses on the malicious actor’s latest attacks.\n\nWe’ve observed a new cryptocurrency related campaign that abuses a legitimate Russian\n[RAT known as Safib Assistant via a newer version of the malware called SpyAgent. This](https://www.safib.ru/assistant)\ninvolves the exploit of a DLL sideloading vulnerability, which causes a malicious DLL to\nload. This DLL hooks and patches various API functions called by the RAT. This results in\nthe RAT windows being hidden from a user.\n\nThe malicious DLL then begins reporting the RAT’s ID, which the malware operator\nneeds to connect to and control the infected machine. The malware sets the access\npassword to a fixed one, so that merely knowing the RAT’s ID is enough for the attacker\nto successfully connect to the infected machine.\n\n## Infection vector\n\nThe malware dropper of SpyAgent is distributed via fake cryptocurrency-related websites\nthat are usually in the Russian language. The dropper poses as a fake cryptocurrency\nwallet, miner, or surfing plug-in. Figures 1 to 4 are some examples of these fake websites.\n\n\n-----\n\n-----\n\nFigure 1. Fake cryptocurrency wallets in Russian\n\n\n-----\n\nFigure 2. Fake cryptocurrency miners in Russian\n\nFigure 3: Fake surfing plug-in to earn dogecoin\n\n\n-----\n\nFigure 4. Fake surfing plug-ins to earn bitcoin\n\nWhen a user visits one of these websites, a file-downloading dialog box (offering to\ndownload a SpyAgent dropper) usually appears immediately, after which the victim is\nprompted to save and run the executable file.\n\nHow a victim winds up on these fake websites varies. One kind of social engineering\ntechnique that we observed involves advertisements published on “earn cryptocurrency\nfor browsing” websites, such as the ad in Figure 5. It should be noted that not all websites\noffering cryptocurrency in exchange for views are necessarily malicious. In the following\nscreenshot, however, the screenshot shows a malicious website that promotes a fake\ncryptocurrency-related website.\n\nFigure 5. Malicious advertisement leading to the malicious website\n\nAfter opening the link, the victim is immediately redirected to one of the fake\ncryptocurrency websites where a dialog box for saving the fake application immediately\nappears.\n\n\n-----\n\nFigure 6. Website with a fake bitcoin bot\n\nSocial media is also used as an infection vector, as shown in the tweet in Figure 7.\nInterestingly, the Twitter account behind it seems to be legitimate, although possibly\ncompromised.\n\nFigure 7. User spreading a link to a fake website via Twitter\n\nDue to search engine optimization (SEO), simply searching for the right keywords might\nresult in the inclusion of these websites in search results.\n\nFigure 8. Search engine returning the link to a fake “Doge Miner” website\n\n\n-----\n\n## Dropper analysis\n\nThe dropper is usually created using the Nullsoft Scriptable Install System (NSIS)\ninstaller (although in the past we have seen variants created with Inno Setup), a powerful\n[tool for creating scriptable program installers. The dropper (NSIS installer) file contains](https://nsis.sourceforge.io/Simple_tutorials)\njust one randomly named encrypted binary file.\n\n\nThe NSIS installer script then calls\nMicrosoft CryptoAPIs to decrypt the\nbinary file, which then becomes a 7Zip archive that will extract the\nfiles. Figure 10 shows a string\n(tno7wul0zusmglmdl) used for\nderiving the decryption key on line 578.\n\n\nFigure 9. Installer with one randomly named binary file\n\n\nFigure 10. Code showing a password to derive the RC4 decryption key used to decrypt random\n\nbinary files\n\n[This string is then hashed with MD5 algorithm (see constant 0x00008003).](https://docs.microsoft.com/en-us/windows/win32/seccrypto/alg-id)\n\nFigure 11. MD5 hashing of the password\n\nFigure 12. Deriving RC4 key\n\n[The dwFlags parameter (see value 0x280011) tells us the length of the key modulus in](https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptderivekey)\nbits, which is set with the upper 16 bits (0x28 / 8 = 40 / 8 = 5 bytes ). Lower 16 bits are\nflags CRYPT_EXPORTABLE and CRYPT_NO_SALT.\n\nTherefore, the first five bytes of the MD5 of the string for key derivation is the RC4 key\nused to decrypt the 7-Zip archive.\n\nFigure 13. Documentation explaining the computation of the length of the key\n\n\n-----\n\nThe extracted 7-Zip archive contains several files, most of which are legitimate nonmalicious files belonging to the RAT. In Figure 14, only those files in red indicate the\nadditions by malware developers.\n\nThe batch file (.bat) is a starter of the main executable (Assistant, ast.exe) file, while the\nConfig file (.cfg) contains encrypted configuration. The bitmap file (.bmp) is used for\nderiving the key to decrypt the config file. Finally, the quartz.dll is the malicious DLL\ncontaining the malware that is sideloaded by ast.exe. Although the real length of the\nquartz DLL is several dozens of kilobytes, its length is artificially inflated by appending a\nhuge overlay of zeroes. This is likely to prevent or discourage some security solutions\nfrom uploading these large files for further analysis.\n\nFigure 14. Contents of the 7-Zip archive with the RAT. The files in red are the ones added by the\n\nmalware developer.\n\n## Analysis of the sideloaded DLL\n\nThe DLL is responsible for decrypting the config file. Initially, the first byte of the config\nfile is checked. If its value is 0x01, it means that the malware runs for the first time and\nthe config file is encrypted with a key derived from the bitmap file.\n\nOtherwise, if the value of the first byte in the config file is 0x00, it means that the config\nfile is encrypted with a key derived from the\n_SOFTWARE\\Microsoft\\Cryptography\\MachineGuid value._\n\nThe key derivation has four steps:\n\n1) The CRC32 checksum of the input ( bmp file) is computed\n\n\n-----\n\n2) The checksum is converted to a hexadecimal string (eight characters), and all\ncharacters are converted to uppercase.\n\n3) The MD5 hash is computed.\n\n4) The hexadecimal string representation of the hash (32 characters) is used as the RC4\npassword to decrypt the config file.\n\nAfter decryption, the configuration file contains the URL address of the command-andcontrol (C&C) server. From this URL address, the domain part is used as a key for\nanother decryption — this time the decryption of part of the DLL’s executable code, since\na part of the DLL is a self-modifying code.\n\nFigure 15. Function call to the encrypted code before decryption (top) and after decryption (bottom)\n\nThe first decrypted function is responsible for resolving the API function addresses, while\nthe second decrypted function is responsible for hooking various functions and altering\nthe default behavior of the RAT.\n\nThe following table shows the important hooked functions and their effects on the RAT:\n\n|Function|Details|\n|---|---|\n|RegCreateKeyEx|Changes the registry using the RAT configuration from \\ast\\SS to \\ast\\SS1|\n|RegSetValueKeyEx|Extracts the RAT’s ID when it is saved to the registry. It then starts two threads, a C&C communication thread and an idleness monitoring thread.|\n|FindWindow|Ensures that the RAT’s window is not shown|\n\n\n-----\n\n|RegisterClass|Ensures that the RAT’s window is not shown|\n|---|---|\n|ShowWindow|Disables showing the RAT’s windows|\n|CreateFile|Disables the log file that the RAT creates by default|\n|GetCommandLine|Sets command-line parameters to start the RAT as a hidden process in the background, sets the connection password stored in registry to a known fixed password, and starts a thread responsible for killing task manager and process explorer|\n\n\nTable 1. The important hook functions of the decrypted function\n\nWhen the RAT is run normally and is not hijacked by malware, a window like the\nscreenshot shown in Figure 17 will appear. It is important to note the nine-digit number\n(captured by the hook of RegSetValueKeyEx) and the four-digit number (overridden by\nthe registry setting set by the hook of GetCommandLine). This window is not shown at all\nas an effect of hooking FindWindow, RegisterClass, and ShowWindow.\n\n\n-----\n\nFigure 16. The RAT’s window when it is run normally. The nine-digit number is the ID and the four\ndigit number is the password.\n\nFinally, we will analyze the two threads. The C&C communication thread regularly makes\na GET request to <C&C domain>/<C&C path>?id=<9digit number>&stat=<environment\nhash>. The environment hash is computed as an MD5 hash of string created by\nconcatenating the following five values:\n\nValue 1 =\nto_uppercase(crc32(HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\MachineGuid))\nValue 2 = to_uppercase(crc32(HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\n_NT\\CurrentVersion\\ProductName))_\n\nValue 3 = to_uppercase(crc32(user name))\n\nValue 4 = to_uppercase(crc32(computer name))\n\nValue 5 = concatenate Value1 Value2 Value3 Value4\n\nIt might receive a response in the following format:\n\n\n-----\n\n!lexec;<url to download>\nrestart\n\ndelproc\n\nThe idleness monitoring thread monitors pressed keys and selecting or dragging\nmovements. If the user is idle for more than one minute, it sends a sidl(start idle) request\nwith the time when the user became idle:\n\n<C&C domain>/<C&C path>?id=<9digit number>&stat=<environment hash>&sidl=\n<time>\n\nThe length of idleness is then regularly submitted in a cidl (count of idle) parameter:\n\n<C&C domain>/<C&C path>?id=<9digit number>&stat=<environment hash>&cidl=\n<number of seconds>\n\nWhen the user becomes active again, the malware sends an eidl (end of idle) request:\n\n<C&C domain>/<C&C path>?id=<9digit number>&stat=<environment hash>&eidl=\n<time>&cidl=<number of seconds>\n\nThe idleness monitoring thread allows the malware operator to choose the proper time\nwhen the victim is not present in order to stay unnoticed.\n\n## Associated malware\n\nSpyAgent usually downloads other malware to perform additional tasks such as stealing\nimportant data.\n\nWe noticed using SpyAgent downloading the following commodity stealers:\n\nRedLine Stealer\nDucky stealer\nAZOrult\nCypress Stealer\nClipper (a clipboard replacer that replaces various cryptocurrency addresses with\nthose controlled by the malicious actor)\n\nWe also noticed other RATS being used in the campaign, such as:\n\nRemcos RAT\n\nNanoCore\nnjRAT\nAsyncRAT\n\n## Conclusion\n\n\n-----\n\nThe threat actor behind this malware seems to have a straightforward financial\nmotivation and typically aims to steal credentials and cryptocurrency wallets while also\nreplacing cryptocurrency addresses shared via clipboard.\n\nFortunately, defending oneself against these attacks is also straightforward. Given the\n[malicious actor’s use of traditional social engineering techniques such as fake websites,](https://www.trendmicro.com/vinfo/us/security/definition/social-engineering)\nmalicious advertisements, and spurious social media posts, users should practice due\ndiligence and avoid selecting any suspicious links or visiting dubious websites. We also\nencourage users to perform security best practices such as bookmarking trusted sites and\npracticing caution when visiting new websites, especially those that are prone to being\nabused for social engineering attacks.\n\n## Indicators of Compromise (IOCs)\n\n[The IOCs used in this analysis can be found here.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/21/k/campaign-abusing-legitimate-remote-administrator-tools-uses-fake-cryptocurrency-websites/ioc-campaign-abusing-legitimate-remote-administrator-tools-uses-fake%20-cyptocurrency-websites.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.11.29.Safib_Assistant/Campaign%20Abusing%20Legitimate%20Remote%20Administrator%20Tools%20Uses%20Fake%20Cryptocurrency%20Websites.pdf"
    ],
    "report_names": [
        "Campaign Abusing Legitimate Remote Administrator Tools Uses Fake Cryptocurrency Websites"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716502,
    "ts_updated_at": 1743041135,
    "ts_creation_date": 1646188476,
    "ts_modification_date": 1646188476,
    "files": {
        "pdf": "https://archive.orkl.eu/70c9ebf707682ca2311e3cedf264f4e7c66d7a15.pdf",
        "text": "https://archive.orkl.eu/70c9ebf707682ca2311e3cedf264f4e7c66d7a15.txt",
        "img": "https://archive.orkl.eu/70c9ebf707682ca2311e3cedf264f4e7c66d7a15.jpg"
    }
}