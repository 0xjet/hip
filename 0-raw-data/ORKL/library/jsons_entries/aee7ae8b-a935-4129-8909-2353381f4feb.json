{
    "id": "aee7ae8b-a935-4129-8909-2353381f4feb",
    "created_at": "2023-01-12T15:07:28.85285Z",
    "updated_at": "2025-03-27T02:17:00.184555Z",
    "deleted_at": null,
    "sha1_hash": "059671465aeae9606397c9e02575170c0c1502bd",
    "title": "2022-06-19 - Matanbuchus Triage Notes",
    "authors": "",
    "file_creation_date": "2022-07-02T23:16:18Z",
    "file_modification_date": "2022-07-02T23:16:18Z",
    "file_size": 2729746,
    "plain_text": "# Matanbuchus Triage Notes\n\n**research.openanalysis.net/matanbuchus/loader/yara/triage/dumpulator/emulation/2022/06/19/matanbuchus-**\ntriage.html\n\nOALABS Research June 19, 2022\n\n## Overview\n\n#### Matanbuchus is a malware downloader that has been observed as the final loading stage in multiple phishing campaigns. There are two components, a Matanbuchus loader intented to load the Matanbuchus downloader. Once the downloader is executed it makes an HTTP request to the C2 with some victim info, and downloads the final payload.\n\n According to DCSO CyTec...\n\n Matanbuchus is the name given to a Malware-as-a-Service sold on Russian-speaking cybercriminal forums. Starting at a rental price of $2,500, the malware consists of an obfuscated two-stage loader which has been deployed in conjunction with Qakbot and Cobalt Strike payloads.\n\n\n-----\n\n### References\n\n## Analysis\n\n#### The DLL has an export called HackCheck that uses OutputDebugStringA to print\n```\n   start dll HackCheck\n\n The sample uses API hashing with FNV1a hash algo to resolve API calls\n\n### Yara Rule\n\n#### This yara rule is very brittle and needs lots of testing/refining\n\n```\n\n-----\n\n```\nrule matanbuchus {\n\n  meta:\n\n    description = \"Identifies matanbuchus\"\n\n  strings:\n\n    // recursive fnv1 hash\n\n    // 69 C2 93 01 00 01            imul  eax, edx, 1000193h\n\n    // 50                   push  eax\n\n    // B9 01 00 00 00             mov   ecx, 1\n\n    // C1 E1 00                shl   ecx, 0\n\n    $x1 = { 69 c2 93 01 00 01 50 b9 01 00 00 00 c1 e1 00 }\n\n   // string decryption  \n\n   // 0F BE 1C 01               movsx  ebx, byte ptr [ecx+eax]\n\n   // 33 DE                  xor   ebx, esi\n\n   // 6A 00                  push  0\n\n   // 6A 01                  push  1\n\n    $x2 = { 0f be 1c 01 33 de 6a 00 6a 01 }\n\n\n  condition:\n\n    all of ($x*)\n\n}\n\n#### Yara Rule Revised\n\n```\n\n-----\n\n```\nrule matanbuchus {\n\n  meta:\n\n    description = \"Identifies matanbuchus\"\n\n  strings:\n\n    // fnv1 hash\n\n    // 69 C2 93 01 00 01            imul  eax, edx, 1000193h\n\n    //\n\n    // 69 C0 93 01 00 01            imul  eax, 1000193h\n\n    $x1 = { 69 ?? 93 01 00 01 }\n\n   //pe loader\n\n   $x2 = { B8 4D 5A 00 00 }\n\n   $x3 = { 81 38 50 45 00 00 }\n\n   //InternetCloseHandle\n\n   $x5 = { 66 E9 DD 4D }\n\n   //InternetOpenUrlA\n\n   $x6 = { BC 8B CF F4 }\n\n   //InternetCheckConnectionA\n\n   $x7 = { 3F 82 58 52 }\n\n   //InternetReadFile\n\n   $x8 = { 66 E9 DD 4D }\n\n  condition:\n\n    all of ($x*)\n\n}\n\n### String Decryption\n\n#### Simple Decryption\n\n Some strings are built as stack strings then copied into a buffer and returned from a function. The returned buffer is then decrypted directly using a simple XOR decryption routine where the first byte is the key.\nimport struct\n\ndata = b'jl8|tt8Py{s[p}{s'\n\nkey = struct.pack('<I',0x796C6B18)\n\ndata = key[1:] + data\n\nout = []\n\n\nfor i in data:\n\n  out.append(i ^ key[0])\n\nbytes(out)\n\n```\n\n-----\n\n```\nb start dll HackCheck\ndef unhex(hex_string):\n\n  import binascii\n\n  if type(hex_string) == str:\n\n    return binascii.unhexlify(hex_string.encode('utf-8'))\n\n  else:\n\n    return binascii.unhexlify(hex_string)\n\ndef tohex(data):\n\n  import binascii\n\n  if type(data) == str:\n\n    return binascii.hexlify(data.encode('utf-8'))\n\n  else:\n\n    return binascii.hexlify(data)\n\n#### Complex Decryption\n\n Other strings are also build from stack strings in a function and returned in a buffer, but these strings are decrypted with a second function call to a decryption function. To handle these more complex strings, we will use dumpulator\nfrom dumpulator import Dumpulator\nimport struct\n\nimport re\n\nimport pefile\n\nfile_data = open('/tmp/mat.bin','rb').read()\n\npe = pefile.PE(data=file_data)\n\ndp = Dumpulator(\"/tmp/mat.dmp\", quiet=True)\n\nfn_get_string = 0x708641C0\n\nss_start = 0x708631B2\n\nss_end = 0x708632AA\n\ndp.start(ss_start, end=ss_end)\n\nss = dp.read(dp.regs.ebp-0x50, 0x48)\n\n\n\nss = bytes(ss)[:0x3e]\n\nbuff = dp.allocate(0x3e)\n\ndp.write(buff, ss)\n\nfn_dec_str = 0x7086F3D0\n\ndp.call(fn_dec_str, [buff, 0x3e, 0x0, 0x7ebbfa3, 0x1010101])\n\ndp.read(buff,0x3e)\n\nFailed to read module data\n\n```\n\n-----\n\n```\nbytearray(b https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx\\x00 )\n\n### Dumpulator Notes\n\n#### The DLL uses thread safe functions that require a call into EnterCriticalSection and\nLeaveCriticalSection . Because our dump was taken before the DLL was initialized the\n\n critical section object was not initialized and this causes Dumpulator to crash.\n\n First we tried just calling the initialization function in the DLL to setup this object (also tried calling the wrapper functions for InitializeCriticalSectionEx ) but these all led to crashes (we could implement some syscalls and try again but we are lazy!\n\n Our solution is to just patch out the EnterCriticalSection and LeaveCriticalSection calls in the loaded ntdll using a simple return 0.\n33 C0   xor eax,eax\n\nC2 04 00 ret 4\n\n Dumpulator Patching Out Functions\ndp = Dumpulator(\"/tmp/mat.dmp\", quiet=True)\n\nntdll_start = 0x77a10000\n\n\npatch_bytes = b'\\x33\\xC0\\xC2\\x04\\x00'\n\nptr_RtlLeaveCriticalSection = 0x77A5FFF0\n\nptr_RtlEnterCriticalSection = 0x77A5FDF0\n\nget_str_fn = 0x70861000\n\n#tohex(dp.read(ntdll_init_crit_sec,10))\n\ndp.write(ptr_RtlLeaveCriticalSection, patch_bytes)\n\ndp.write(ptr_RtlEnterCriticalSection, patch_bytes)\n\n\n\ndp.call(get_str_fn)\n\nFailed to read module data\n\nunmapped read from 8[4], cip = 77a6693a\n\nerror: Invalid memory read (UC_ERR_READ_UNMAPPED), cip = 77a6693a\n\n134217727\n\n Dumpulator Implementing Syscalls to Load DLL\n\n```\n\n-----\n\n#### Our patching method sort of worked but there is other initializations stuff that was causing more crashes. We are going to try and just implement the syscalls that we need to actually emulate the full DLL load routine and see if that works better.\n```\nfrom dumpulator import Dumpulator, syscall\n\nfrom dumpulator.native import *\n\n@syscall\n\ndef ZwQueryVolumeInformationFile(dp: Dumpulator,\n\n                 FileHandle: HANDLE,\n\n                 IoStatusBlock: P(IO_STATUS_BLOCK),\n\n                 FsInformation: PVOID,\n\n                 Length: ULONG,\n\n                 FsInformationClass: FSINFOCLASS\n\n                 ):\n\n  return STATUS_SUCCESS\n\n\n\ndp = Dumpulator(\"/tmp/mat2.dmp\", quiet=True)\n\ndll_base_addr = 0x71950000\n\ndp.start(dp.regs.eip, end=dp.read_ptr(dp.regs.esp))\n\n\nget_str_fn = 0x71951000\n\ndp.read_str(dp.call(get_str_fn))\n\nFailed to read module data\n\n'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx'\n\n Finding Encrypted Stack Strings\negg = rb'(\\xC6\\x45..){4}'\n\negg = rb'\\x55\\x8b\\xec\\x83\\xec\\x08\\x33\\xc0\\x88\\x45\\xff'\n\nstack_string_offsets = []\n\nfor m in re.finditer(egg, file_data):\n\n  fn_offset = m.start()\n\n  fn_addr = pe.get_rva_from_offset(fn_offset) + dll_base_addr\n\n  tmp_str = dp.read_str(dp.call(fn_addr))\n\n  print(tmp_str)\n\n\n```\n\n-----\n\n```\nhttps://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx\n\nhttps://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/auth.aspx\n\nDllRegisterServer\n\nhttp://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/home.aspx\n\nhttp://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\n\nhttps://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\n\n## Revising Our Config Extractor\n\n#### Now that we have a base config extractor we need to test this across multiple samples/versions of the malware to make sure it is robust enough.\n\n Our initial sample was\nf8cc2cf36e193774f13c9c5f23ab777496dcd7ca588f4f73b45a7a5ffa96145e .\n\n We have collected the following samples to triage:\n   b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e\n   c41f7b7ec0909d5c21107ddebc2fe84dbc137f701b42943c1a5e69f5d50e05ab\n   b4e7710488c2b7aaa71688b8bd546410af07a215c2e835e8dfbe24887186bd4f\n   60f030597c75f9df0f7a494cb5432b600d41775cfe5cf13006c1448fa3a68d8d\n   58a673023bbc7f2726e3b7ac917a43d9306692dc87b638ee21b98705a3262ccd\n   4b87f95c4477fc66c58b8e16a74f9c47217913cb4a78dc69f27a364a099acd90\n   4eb85a5532b98cbc4a6db1697cf46b9e2b7e28e89d6bbfc137b36c0736cd80e2\n\n More samples from Rattle (these work with our existing tools)\n   67a9e8599ab71865a97e75dae9be438c24d015a93e6a12fb5b450ec558528290\n   075c904c5e18cd49f7d48f0fd1fc67d0921d51c7effb9233a3c92fbfa4f218ed\n   60f030597c75f9df0f7a494cb5432b600d41775cfe5cf13006c1448fa3a68d8d\n\n These samples don't work with our first version of the config extractor:\n   e58b9bbb7bcdf3e901453b7b9c9e514fed1e53565e3280353dccc77cde26a98e.bin\n   b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e.bin\n\n### New Config Extractor - Static String Decryption Notes\n\n```\n\n-----\n\n```\ndef unhex(hex_string):\n\n  import binascii\n\n  if type(hex_string) == str:\n\n    return binascii.unhexlify(hex_string.encode('utf-8'))\n\n  else:\n\n    return binascii.unhexlify(hex_string)\n\ndef tohex(data):\n\n  import binascii\n\n  if type(data) == str:\n\n    return binascii.hexlify(data.encode('utf-8'))\n\n  else:\n\n    return binascii.hexlify(data)\n\n```\n\n-----\n\n```\nimport re\n\nimport struct\n\nimport pefile\n\nFILE_PATH =\n'/tmp/samples/e58b9bbb7bcdf3e901453b7b9c9e514fed1e53565e3280353dccc77cde26a98e.bin'\n\nFILE_PATH = '/tmp/samples/orig.bin'\n\nFILE_PATH = '/tmp/samples/bd_rony.bin'\n\nfile_data = open(FILE_PATH,'rb').read()\n\n\n\ndef xor_decrypt(data, key):\n\n  out = []\n\n  for i in range(len(data)):\n\n    out.append(data[i] ^ key[i%len(key)])\n\n  return bytes(out)\n\n\ndef is_ascii(data):\n\n  return re.match(B\"^[\\s!-~]+\\0*$\", data) is not None\n\n\ndef filter(data):\n\n  return re.match(rb'[\\f\\v\\t]', data) is not None\n\n\nstack_strings = []\n\n#string_egg = rb'(\\xC6\\x45..){2,}'\n\nstring_egg = rb'(?P<a>(?:\\xC6\\x85.{5}){0,})(?P<b>(?:\\xC6\\x45..){1,})' \n\nfor m in re.finditer(string_egg, file_data):\n\n  match_data = m.group(0)\n\n  #stack_strings.append({\"data\":match_data.replace(b'\\xC6\\x45',b'')[1::2],\n\"match\":match_data})\n\n  stack_strings.append({\"data\":m['a'][6::7] + m['b'][3::4], \"match\":match_data})\n\nkeys = []\n\nkey_byte_len_egg = rb'\\x68(....)\\x68(....)\\x6a\\x00\\x6a(.)'\n\nfor m in re.finditer(key_byte_len_egg, file_data):\n\n   keys.append( {'key':m.group(2) + m.group(1), 'length':ord(m.group(3))})\nkey_dw_len_egg = rb'\\x68(....)\\x68(....)\\x6a\\x00\\x68(....)'\n\n\n```\n\n-----\n\n```\nfor m in re.finditer(key_dw_len_egg, file_data):\n\n   keys.append( {'key':m.group(2) + m.group(1),\n'length':struct.unpack('<I',m.group(3))[0]})   \n\nfor sj in stack_strings:\n\n  s = sj.get('data')\n\n  str_len = len(s)\n\n  if str_len < 5:\n\n    continue\n\n  #print(f\"\\n\\n{str_len}\")\n\n  flag_found = False\n\n  #print('\\n')\n\n  #print(f'{tohex(sj.get(\"match\"))}')\n\n  tmp_strings = []\n\n  for k in keys:\n\n    if k.get('length') == str_len:\n\n      #print(f\"found key: {tohex(k.get('key'))}\")\n      out = xor_decrypt(s, k.get('key'))\n\n      if is_ascii(out) and not filter(out):\n\n        tmp_strings.append(out)\n\n        flag_found = True\n\n  if not flag_found:\n\n    tmp_xoe_dec = xor_decrypt(s[1:-1], bytes([s[0]]))\n\n    if is_ascii(tmp_xoe_dec) and not filter(tmp_xoe_dec):\n\n      print(tmp_xoe_dec)\n  else:\n\n    #print(f\"\\n{tmp_strings}\")\n\n    spec_char_egg = rb'[^A-Za-z0-9\\s\\./\\\\\\%]{1}'\n\n    best_match = min( (len(re.findall(spec_char_egg, s)),s) for s in tmp_strings\n)[1]\n\n    print(best_match)\n\n```\n\n-----\n\n```\nb Content Length: \\x00\n\nb'C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe \\x00'\n\nb'collectiontelemetrysystem.com\\x00'\n\nb'DllRegisterServer\\x00'\n\nb'097f5m\\x00'\n\nb'Running dll in memory #3 (DllInstall(Unstall))\\x00'\n\nb'runas\\x00'\n\nb'.exe\\x00'\n\nb'timeout /t 3 && move /Y \\x00'\n\nb'Running dll in memory #3 (DllInstall(Install))\\x00'\n\nb'.exe\\x00'\n\nb'.exe\\x00'\n\nb'TiC7\\x00'\n\nb'.nls\\x00'\n\nb'Run PS in memory\\x00'\n\nb'Admin\\x00'\n\nb'%LOCALAPPDATA%\\\\\\x00'\n\nb'DllInstall\\x00'\n\nb'cmd.exe /c \\x00'\n\nb'collectiontelemetrysystem.com\\x00'\n\nb'Not in domain\\x00'\n\nb'regsvr32.exe \\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'41.4.0\\x00'\n\nb'8QN04\\x00'\n\nb'64 Bit\\x00'\n\nb'8S2x\\x00'\n\nb'Starting the exe with parameters\\x00'\n\nb'C:\\\\Windows\\\\System32\\\\cmd.exe /c \\x00'\n\nb'cmd.exe /c \\x00'\n\nb'High start exe\\x00'\n\nb'Running exe\\x00'\n\nb'User-Agent: \\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'Content-Type: application/x-www-form-urlencoded\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\\x00'\n\nb'\\\\explorer.exe\\x00'\n\nb'MemLoadDllMain || MemLoadExe\\x00'\n\nb'Run CMD in memory\\x00'\n\nb'3CEk\\x00'\n\nb'3m7x\\x00'\n\nb'.nls\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'NCST \\x00'\n\nb'BCha\\x00'\n\nb\"/c ECHO 'You must restart the program to resolve a critical error!' && start \\x00\"\n\nb'7eriel\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'.nls\\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\n```\n\n-----\n\n```\nb \\\\ z{VIS\\rA6\\rb\\x00\n\nb'%LOCALAPPDATA%\\\\\\x00'\n\nb'IsWow64Process\\x00'\n\nb'rundll32.exe \\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'kernel32\\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'.nls\\x00'\n\nb'User\\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'.nls\\x00'\n\nb'\\r\\n\\r\\n\\x00'\n\nb'\\rXOGONSEzBER%\\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'\\nost: \\x00'\n\nb'MemLoadShellCode\\x00'\n\nb'Q6X6\\x00'\n\nb'timeout /t 3 && del \\x00'\n\nb'cmd.exe\\x00'\n\nb'%02X-%02X-%02X-%02X-%02X-%02X\\x00'\n\nb'Running dll in memory #2 (DllRegisterServer)\\x00'\n\nb'Crypt update & Bots upgrade\\x00'\n\nb'timeout /t 3 && del \\x00'\n\nb'3fe11\\x00'\n\nb'%PROCESSOR_ARCHITECTURE%\\x00'\n\nb'%PROCESSOR_ARCHITECTURE%\\x00'\n\nb'NSeyDX\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'4nes\\x00'\n\nb'jpofxs\\x00'\n\nb'Not in domain\\x00'\n\nb'DllInstall\\x00'\n\nb' && rd /s /q \\x00'\n\nb' && regsvr32.exe -e \"\\x00'\n\nb'32 Bit\\x00'\n\nb'%USERDOMAIN%\\x00'\n\n### Final Config Decryptor\n\n```\n\n-----\n\n```\nimport re\n\nimport struct\n\nimport pefile\n\n\ndef xor_decrypt(data, key):\n\n  out = []\n\n  for i in range(len(data)):\n\n    out.append(data[i] ^ key[i%len(key)])\n\n  return bytes(out)\n\n\ndef is_ascii(data):\n\n  return re.match(B\"^[\\s!-~]+\\0*$\", data) is not None\n\n\ndef get_strings(file_path):\n\n  file_data = open(file_path,'rb').read()\n\n  stack_strings = []\n\n  #string_egg = rb'(\\xC6\\x45..){2,}'\n\n  string_egg = rb'(?P<a>(?:\\xC6\\x85.{5}){0,})(?P<b>(?:\\xC6\\x45..){3,})' \n\n  for m in re.finditer(string_egg, file_data):\n\n    match_data = m.group(0)\n\n    #stack_strings.append({\"data\":match_data.replace(b'\\xC6\\x45',b'')[1::2],\n\"match\":match_data})\n\n    stack_strings.append({\"data\":m['a'][6::7] + m['b'][3::4],\n\"match\":match_data})\n\n  keys = []\n\n  key_byte_len_egg = rb'\\x68(....)\\x68(....)\\x6a\\x00\\x6a(.)'\n\n  for m in re.finditer(key_byte_len_egg, file_data):\n\n     keys.append( {'key':m.group(2) + m.group(1), 'length':ord(m.group(3))})\n\n\n  key_dw_len_egg = rb'\\x68(....)\\x68(....)\\x6a\\x00\\x68(....)'\n\n  for m in re.finditer(key_dw_len_egg, file_data):\n\n     keys.append( {'key':m.group(2) + m.group(1),\n'length':struct.unpack('<I',m.group(3))[0]})   \n\n  out_strings = []\n\n  for sj in stack_strings:\n\n    s = sj.get('data')\n\n    str_len = len(s)\n\n    flag_found = False\n\n```\n\n-----\n\n```\n    tmp_out []\n\n    for k in keys:\n\n      if k.get('length') == str_len:\n\n        out = xor_decrypt(s, k.get('key'))\n\n        if is_ascii(out):\n          tmp_out.append(out)\n\n    if len(tmp_out) == 0:\n\n      out = xor_decrypt(s[1:-1], bytes([s[0]]))\n\n      if is_ascii(out):\n\n        out_strings.append(out)\n\n    elif len(tmp_out) == 1:\n\n      out_strings.append(tmp_out[0])\n\n    else:\n\n      # This is a hack\n\n      # We have strings that will give valid ascii for multiple keys\n\n      # So far these have only been dll names\n\n      for out in tmp_out:\n\n        if out[:-3].lower() == b'dll':\n\n          out_strings.append(out)\n\n          break\n\n  return list(set(out_strings))\n\n#### Test All Samples\nget_strings(FILE_PATH)\n\nimport os\n\nfor filename in os.listdir('/tmp/samples'):\n\n  if filename.endswith(\".bin\"):\n\n    file_path = os.path.join('/tmp/samples', filename)\n\n    print(f\"\\n{file_path}\")\n\n    print(get_strings(file_path))\n\n```\n\n-----\n\n```\n/tmp/samples/55d329a13da236bec15c4c67686b809a2fbf5f6c9625b62d900ac22a7b729ba9.bin\n\n[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\\x00',\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azuredbupdate.at/vuUwUx/FyNRoM/index.php\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\nb'IPHLPAPI.DLL\\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00',\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n/tmp/samples/4b87f95c4477fc66c58b8e16a74f9c47217913cb4a78dc69f27a364a099acd90.bin\n\n[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\\x00',\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azuredbupdate.at/vuUwUx/FyNRoM/index.php\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\nb'IPHLPAPI.DLL\\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00',\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n/tmp/samples/0bdf1060b85ad55e73393eb0b59c1d226e091da4f4dcce65dacba5e9a1fd76a7.bin\n\n[b'VirtualAlloc', b'start dll HackCheck',\nb'http://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/home.aspx\\x00',\nb'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx\\x00',\nb'rundll32.exe\\x00', b'kernel32.dll', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'Netapi32.dll\\x00',\nb'LoadLibraryA', b'http://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\\x00',\nb'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; Win64; x64; Trident/8.0;\n.NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729;\nMicrosoft Outlook 16.0.5197; ms-office; MSOffice 16)\\x00', b'IPHLPAPI.DLL\\x00',\nb'Wkscli.dll\\x00',\nb'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\\x00', b'VirtualFree',\nb'https://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/auth.aspx\\x00',\nb'%PROCESSOR_LEVEL%']\n\n/tmp/samples/3cae2ce9b2d7040292f1661af63dc28e778027c46f78d8be3b1d43f4b6c2b046.bin\n\n[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\\x00',\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azuredbupdate.at/vuUwUx/FyNRoM/index.php\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\nb'IPHLPAPI.DLL\\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00',\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n/tmp/samples/b4e7710488c2b7aaa71688b8bd546410af07a215c2e835e8dfbe24887186bd4f.bin\n\n[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\\x00',\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azuredbupdate.at/vuUwUx/FyNRoM/index.php\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\n\n```\n\n-----\n\n```\nb IPHLPAPI.DLL\\x00, b https://azure dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00,\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n/tmp/samples/orig.bin\n\n[b'VirtualAlloc', b'start dll HackCheck',\nb'http://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/home.aspx\\x00',\nb'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx\\x00',\nb'rundll32.exe\\x00', b'kernel32.dll', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'Netapi32.dll\\x00',\nb'LoadLibraryA', b'http://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\\x00',\nb'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; Win64; x64; Trident/8.0;\n.NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729;\nMicrosoft Outlook 16.0.5197; ms-office; MSOffice 16)\\x00', b'IPHLPAPI.DLL\\x00',\nb'Wkscli.dll\\x00',\nb'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\\x00', b'VirtualFree',\nb'https://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/auth.aspx\\x00',\nb'%PROCESSOR_LEVEL%']\n\n/tmp/samples/2f36c571f20b2b2c2058d4db574a6d53b148450356bf529d72aefc19505c912e.bin\n\n[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\\x00',\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azuredbupdate.at/vuUwUx/FyNRoM/index.php\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\nb'IPHLPAPI.DLL\\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00',\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n/tmp/samples/4eb85a5532b98cbc4a6db1697cf46b9e2b7e28e89d6bbfc137b36c0736cd80e2.bin\n\n[b'rundll32.exe\\x00', b'ztCYGAuJ\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'https://windowsdriverupdate.at/V.asp\\x00', b'DllRegisterServer\\x00', b'Microsoft\nOffice/16.0 (Windows NT 10.0; Microsoft Outlook 16.0.13127; Pro)\\x00',\nb'Shell32.dll\\x00', b'Wininet.dll\\x00', b'USER32.dll\\x00',\nb'https://windowsdriverupdate.at/ZBEr.asp\\x00', b'Dll Uinstall\\x00',\nb'%PROCESSOR_LEVEL%\\x00', b'https://driverwindowsupdate.at/V.asp\\x00',\nb'UnregisterServer\\x00', b'IPHLPAPI.DLL\\x00', b'%PROCESSOR_REVISION%\\\\\\x00',\nb'regsvr32.exe\\x00', b'\"C:\\\\Windows\\\\system32\\\\schtasks.exe\" /Create /SC MINUTE /MO 1\n/TN \\x00']\n\n/tmp/samples/10d5483faf9a4e0fbc17556164f47f7014650797b7d501289b269515a0853b64.bin\n\n[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\\x00',\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azuredbupdate.at/vuUwUx/FyNRoM/index.php\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\nb'IPHLPAPI.DLL\\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00',\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n/tmp/samples/58a673023bbc7f2726e3b7ac917a43d9306692dc87b638ee21b98705a3262ccd.bin\n\n```\n\n-----\n\n```\n[b VirtualAlloc, b Windows Update Agent/11.0.10011.16384 Client Protocol/2.0\\x00,\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azuredbupdate.at/vuUwUx/FyNRoM/index.php\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\nb'IPHLPAPI.DLL\\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00',\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n/tmp/samples/b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e.bin\n\n[]\n\n/tmp/samples/fa6500946210334d397d612d5ee9b11456316e25672bc60c1267bbdb002af9c7.bin\n\n[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\\x00',\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azuredbupdate.at/vuUwUx/FyNRoM/index.php\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\nb'IPHLPAPI.DLL\\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00',\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n/tmp/samples/60f030597c75f9df0f7a494cb5432b600d41775cfe5cf13006c1448fa3a68d8d.bin\n\n[b'VirtualAlloc', b'start dll HackCheck',\nb'http://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/home.aspx\\x00',\nb'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/auth.aspx\\x00',\nb'rundll32.exe\\x00', b'kernel32.dll', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'Netapi32.dll\\x00',\nb'LoadLibraryA', b'http://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\\x00',\nb'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; Win64; x64; Trident/8.0;\n.NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729;\nMicrosoft Outlook 16.0.5197; ms-office; MSOffice 16)\\x00', b'IPHLPAPI.DLL\\x00',\nb'Wkscli.dll\\x00',\nb'https://telemetrysystemcollection.com/m8YYdu/mCQ2U9/home.aspx\\x00', b'VirtualFree',\nb'https://collectiontelemetrysystem.com/m8YYdu/mCQ2U9/auth.aspx\\x00',\nb'%PROCESSOR_LEVEL%']\n\n/tmp/samples/e58b9bbb7bcdf3e901453b7b9c9e514fed1e53565e3280353dccc77cde26a98e.bin\n\n[b'C:\\\\Windows\\\\System32\\\\schtasks.exe\\x00', b'rundll32.exe\\x00', b' /TR\n\"%windir%\\\\system32\\\\regsvr32.exe -e \\x00', b'%ProgramData%\\\\\\x00',\nb'Shlwapi.dll\\x00', b'WS2_32.dll\\x00', b'DllRegisterServer\\x00',\nb'%PROGRAMFILES%\\\\Opera\\\\Opera.exe\\x00', b'Shell32.dll\\x00', b'Wininet.dll\\x00',\nb'USER32.dll\\x00', b'Dll Uinstall\\x00', b'%COMPUTERNAME%\\x00',\nb'https://manageintel.com/RKyiihqXQiyE/xukYadevoVow/BhJM.xml\\x00',\nb'UnregisterServer\\x00', b'IPHLPAPI.DLL\\x00',\nb'https://manageintel.com/RKyiihqXQiyE/xukYadevoVow/QXms.xml\\x00', b'.ocx\\x00',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%\\\\\\x00', b'%PROCESSOR_REVISION%\\x00']\n\n/tmp/samples/a3c896e23c86e47bcb77096e743010546cd7699e0189344d11b9c642b89deef1.bin\n\n[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\\x00',\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azure\n```\n\n-----\n\n```\ndbupdate.at/vuUwUx/FyNRoM/index.php\\x00, b Shlwapi.dll\\x00, b WS2_32.dll\\x00,\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\nb'IPHLPAPI.DLL\\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00',\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n/tmp/samples/f27821dddb17b6c8d59fb2ada1e90eac8d561476e5af3a6be064177683b0eee9.bin\n\n[b'VirtualAlloc', b'Windows-Update-Agent/11.0.10011.16384 Client-Protocol/2.0\\x00',\nb'rundll32.exe\\x00', b'9npSEGB3kg9suo3Yit\\x00', b'kernel32.dll', b'https://azuredbupdate.at/vuUwUx/FyNRoM/index.php\\x00', b'Shlwapi.dll\\x00', b'WS2_32.dll\\x00',\nb'DllRegisterServer\\x00', b'loaddll32.exe\\x00', b'Shell32.dll\\x00',\nb'Wininet.dll\\x00', b'USER32.dll\\x00', b'GetProcAddress', b'LoadLibraryA',\nb'IPHLPAPI.DLL\\x00', b'https://azure-dbupdate.at/vuUwUx/FyNRoM/auth.php\\x00',\nb'https://azure-updatedb.at/vuUwUx/FyNRoM/index.php\\x00', b'VirtualFree',\nb'regsvr32.exe\\x00', b'%PROCESSOR_LEVEL%']\n\n### Sample Using ADV String Obfuscation\n\n#### A newer sample uses some type of ADV string obfuscation\nb9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e . We can\n\n probably use our old dumpulator tricks for this.\n\n The start of the .text section contains a vtable with all of the string decryption functions.\n\n```\n\n-----\n\n```\nfrom dumpulator import Dumpulator, syscall\n\nfrom dumpulator.native import *\n\n@syscall\n\ndef ZwQueryVolumeInformationFile(dp: Dumpulator,\n\n                 FileHandle: HANDLE,\n\n                 IoStatusBlock: P(IO_STATUS_BLOCK),\n\n                 FsInformation: PVOID,\n\n                 Length: ULONG,\n\n                 FsInformationClass: FSINFOCLASS\n\n                 ):\n\n  return STATUS_SUCCESS\n\n\n\ndp = Dumpulator(\"/tmp/b9b.dmp\", quiet=True)\n\ndp.start(dp.regs.eip, end=dp.read_ptr(dp.regs.esp))\n\nfuncts =\n[0x74040976,0x740409A4,0x740409BA,0x74040998,0x7404098C,0x7403F910,0x7403F91C,0x7403F9\n\nfor fn in functs:\n\n  dp.call(fn,[])\n\n\nstr_tbl_start = 0x7407FDB4\n\nstr_tbl_end = 0x7407FE7C\n\nstr_tbl_start = 0x7407E000\n\nstr_tbl_end = 0x74080224\n\nfor ptr in range(str_tbl_start,str_tbl_end,4):\n\n  try:\n\n    ss = dp.read_str(dp.read_ptr(ptr))\n\n    if len(ss) > 4:\n\n      print(ss)\n\n  except:\n\n    continue\n\n```\n\n-----\n\n```\nFailed to read module data\n\nC:\\Users\\IEUser\\Desktop\\DLLLoader32_82D6.exe\n\n\"C:\\Users\\IEUser\\Desktop\\DLLLoader32_82D6.exe\"\n\ne03ed\n\nUninstall\n\n3fe11\n\nRunning exe\n\nStarting the exe with parameters\n\nRun CMD in memory\n\nRun PS in memory\n\nRunning dll in memory #3 (DllInstall(Unstall))\n\nRunning dll in memory #3 (DllInstall(Install))\n\nRegsvr32 & Execute\n\nMemLoadDllMain || MemLoadExe\n\nzNETjp\n\n5deb9c\n\nRun EXE with admin rights\n\nTAMfm\n\nRunDll32 & Execute\n\nCrypt update & Bots upgrade\n\nRunning dll in memory #2 (DllRegisterServer)\n\ntbesqn\n\n#### Different Sample From Same Family\n\n This is clearly a different sample based on the decrypted strings, but it seems to be part of the matanbuchus family... maybe this is a payload instead of a loader? The sample matches analysis from this blog: Introduction of a PE file extractor for various situations>\n\n We need to figure out why these samples are so different...\n\n## Taking a Closer Look At Obfuscated Samples\n\n#### Obfuscated sample\n   b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e - does\n\n match yara (2021-11-12 11:47:44 UTC)\n\n Rony\n   bd68ecd681b844232f050c21c1ea914590351ef64e889d8ef37ea63bd9e2a2ec \n doesn't match yara (2022-06-14 10:30:32 UTC)\n\n These samples appear to be the same (they are likely the \"payload\" portion of Matanbuchus) but the earlier sample uses obfuscated string encryption, while the newer sample uses the simpler stack based string encryption.\n\n### Fixing our Yara Rule to Match the Stack Based String Encryption Payload (as well as loaders)\n\n```\n\n-----\n\n#### This was a simple fix! The payload does not contain the murmur hash code, once we removed that the yara rule matched all samples.\n\n### Let's Take a Look At the Obfusacated Strings\n\n#### We know that the one sample we have that is a \"payload\" will likely have some of the same strings as the obfuscated sample so let's pull these our first as a reference.\n\n\n-----\n\n```\nb Content Length: \\x00\n\nb'C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe \\x00'\n\nb'collectiontelemetrysystem.com\\x00'\n\nb'DllRegisterServer\\x00'\n\nb'097f5m\\x00'\n\nb'Running dll in memory #3 (DllInstall(Unstall))\\x00'\n\nb'runas\\x00'\n\nb'.exe\\x00'\n\nb'timeout /t 3 && move /Y \\x00'\n\nb'Running dll in memory #3 (DllInstall(Install))\\x00'\n\nb'.exe\\x00'\n\nb'.exe\\x00'\n\nb'TiC7\\x00'\n\nb'.nls\\x00'\n\nb'Run PS in memory\\x00'\n\nb'Admin\\x00'\n\nb'%LOCALAPPDATA%\\\\\\x00'\n\nb'DllInstall\\x00'\n\nb'cmd.exe /c \\x00'\n\nb'collectiontelemetrysystem.com\\x00'\n\nb'Not in domain\\x00'\n\nb'regsvr32.exe \\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'41.4.0\\x00'\n\nb'8QN04\\x00'\n\nb'64 Bit\\x00'\n\nb'8S2x\\x00'\n\nb'Starting the exe with parameters\\x00'\n\nb'C:\\\\Windows\\\\System32\\\\cmd.exe /c \\x00'\n\nb'cmd.exe /c \\x00'\n\nb'High start exe\\x00'\n\nb'Running exe\\x00'\n\nb'User-Agent: \\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'Content-Type: application/x-www-form-urlencoded\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\\x00'\n\nb'\\\\explorer.exe\\x00'\n\nb'MemLoadDllMain || MemLoadExe\\x00'\n\nb'Run CMD in memory\\x00'\n\nb'3CEk\\x00'\n\nb'3m7x\\x00'\n\nb'.nls\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'NCST \\x00'\n\nb'BCha\\x00'\n\nb\"/c ECHO 'You must restart the program to resolve a critical error!' && start \\x00\"\n\nb'7eriel\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'.nls\\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\n```\n\n-----\n\n```\nb \\\\ z{VIS\\rA6\\rb\\x00\n\nb'%LOCALAPPDATA%\\\\\\x00'\n\nb'IsWow64Process\\x00'\n\nb'rundll32.exe \\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'kernel32\\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'.nls\\x00'\n\nb'User\\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'.nls\\x00'\n\nb'\\r\\n\\r\\n\\x00'\n\nb'\\rXOGONSEzBER%\\x00'\n\nb'%PROCESSOR_REVISION%\\\\\\x00'\n\nb'\\nost: \\x00'\n\nb'MemLoadShellCode\\x00'\n\nb'Q6X6\\x00'\n\nb'timeout /t 3 && del \\x00'\n\nb'cmd.exe\\x00'\n\nb'%02X-%02X-%02X-%02X-%02X-%02X\\x00'\n\nb'Running dll in memory #2 (DllRegisterServer)\\x00'\n\nb'Crypt update & Bots upgrade\\x00'\n\nb'timeout /t 3 && del \\x00'\n\nb'3fe11\\x00'\n\nb'%PROCESSOR_ARCHITECTURE%\\x00'\n\nb'%PROCESSOR_ARCHITECTURE%\\x00'\n\nb'NSeyDX\\x00'\n\nb'%APPDATA%\\\\\\x00'\n\nb'4nes\\x00'\n\nb'jpofxs\\x00'\n\nb'Not in domain\\x00'\n\nb'DllInstall\\x00'\n\nb' && rd /s /q \\x00'\n\nb' && regsvr32.exe -e \"\\x00'\n\nb'32 Bit\\x00'\n\nb'%USERDOMAIN%\\x00'\n\n```\n\n-----\n\n```\nfrom dumpulator import Dumpulator, syscall\n\nfrom dumpulator.native import *\n\nimport pefile\n\n\n@syscall\n\ndef ZwQueryVolumeInformationFile(dp: Dumpulator,\n\n                 FileHandle: HANDLE,\n\n                 IoStatusBlock: P(IO_STATUS_BLOCK),\n\n                 FsInformation: PVOID,\n\n                 Length: ULONG,\n\n                 FsInformationClass: FSINFOCLASS\n\n                 ):\n\n  return STATUS_SUCCESS\n\n\n\ndp = Dumpulator(\"/tmp/b9b.dmp\", quiet=True)\n\ndp.start(dp.regs.eip, end=dp.read_ptr(dp.regs.esp))\n\nfuncts =\n[0x74040976,0x740409A4,0x740409BA,0x74040998,0x7404098C,0x7403F910,0x7403F91C,0x7403F9\n\nfuncts = [0x7403FC98]\n\nfor fn in functs:\n\n  dp.call(fn,[])\n\n\ndata_start = 0x7407E000\n\ndata_end = 0x74080228\n\nfor ptr in range(data_start,data_end,4):\n\n  try:\n\n    ss = dp.read_str(dp.read_ptr(ptr))\n\n    if len(ss) >= 4:\n\n      print(ss)\n\n  except:\n\n    continue\n\nprint(\"\\n\\n\\n ===\\n\")\n\nprint(dp.read_str(dp.read_ptr(0x7407FDFC )))\n\n\n```\n\n-----\n\n```\nFailed to read module data\n\nC:\\Users\\IEUser\\Desktop\\DLLLoader32_82D6.exe\n\n\"C:\\Users\\IEUser\\Desktop\\DLLLoader32_82D6.exe\"\n\nQ6X6\n\nzkC7\n\nrJqU\n\ne03ed\n\n3CEk\n\nUninstall\n\n3fe11\n\nRunning exe\n\nau5o\n\nStarting the exe with parameters\n\n3m7x\n\nRun CMD in memory\n\nRun PS in memory\n\nRunning dll in memory #3 (DllInstall(Unstall))\n\nRunning dll in memory #3 (DllInstall(Install))\n\nRegsvr32 & Execute\n\nMemLoadDllMain || MemLoadExe\n\nb2tb\n\nhszA\n\nzNETjp\n\n5deb9c\n\nDS2x\n\nRun EXE with admin rights\n\nTAMfm\n\nRunDll32 & Execute\n\nwgjv\n\nCrypt update & Bots upgrade\n\nf1da\n\nnX8y\n\nRunning dll in memory #2 (DllRegisterServer)\n\ntbesqn\n\n\n\n ===\n\nRunning exe\n\n```\n\n-----\n\n```\nFILE_PATH \n'/tmp/samples/b9b399dbb5d901c16d97b7c30cc182736cd83a7c53313194a1798d61f9c7501e.bin'\n\nfile_data = open(FILE_PATH,'rb').read()\n\n\n\ndef xor_decrypt(data, key):\n\n  out = []\n\n  for i in range(len(data)):\n\n    out.append(data[i] ^ key[i%len(key)])\n\n  return bytes(out)\n\n\ndef is_ascii(data):\n\n  return re.match(B\"^[\\s!-~]+\\0*$\", data) is not None\n\n\n\n# .text:74049A7D C6 45 B8 0D               mov   byte ptr [ebp-48h],\n13\n# .text:74049A81 C7 45 E0 6E 60 69 23          mov   dword ptr [ebp-20h],\n2369606Eh\n\n# .text:74049A88 C7 45 E4 68 75 68 2D          mov   dword ptr [ebp-1Ch],\n2D687568h\n\n# .text:74049A8F C7 45 E8 22 6E 2D 00          mov   dword ptr [ebp-18h],\n2D6E22h\n\n# .text:74049A96 C7 45 EC DA 4E 1E 00          mov   dword ptr [ebp-14h],\n1E4EDAh\n\ntest_data =\nunhex('895db4c645b80dc745e06e606923c745e46875682dc745e8226e2d00c745ecda4e1e0052')\n\nstack_strings = []\n\nstring_egg = rb'(?P<a>(?:\\xC6\\x45..){1})(?P<b>(?:\\xC7\\x45.....){2,})' \n\n\nfor m in re.finditer(string_egg, file_data):\n\n  match_data = m.group(0)\n\n  #print(tohex(match_data))\n\n  key = m['a'][3]\n\n  raw_data = m['b']\n\n  str_data = b''\n\n  for i in range(0,len(raw_data),7):\n\n    str_data += raw_data[i:i+7][-4:]\n\n  print(xor_decrypt(str_data, bytes([key])))\n\n```\n\n-----\n\n```\nb Shell32.dllR\n\nb'Matanbuc'\n\nb' HTTP/1.'\n\nb'User-Agent: '\n\nb'DllInsta'\n\nb'DllInsta'\n\nb'cmd.exe /c \\x05\\xdfK\\x1b\\x05'\n\nb' && rd /s /q'\n\nb'cmd.exe /c \\r\\xd7C\\x13\\r'\n\n# .text:7404406B C7 45 AC 71 5D 48 5D          mov   dword ptr [ebp-54h],\n5D485D71h\n\n# .text:74044072 C7 45 B0 52 5E 49 5F          mov   dword ptr [ebp-50h],\n5F495E52h\n\n# .text:74044079 C7 45 B4 54 49 4F 0A          mov   dword ptr [ebp-4Ch],\n0A4F4954h\n\n# .text:74044080 66 C7 45 B8 0A 0A            mov   word ptr [ebp-48h],\n0A0Ah\n\n# .text:74048CF5 C6 45 B8 31               mov   byte ptr [ebp-48h],\n31h ; '1'\n\n# .text:74048CF9 C7 45 E0 75 5D 5D 78          mov   dword ptr [ebp-20h],\n785D5D75h\n\n# .text:74048D00 C7 45 E4 5F 42 45 50          mov   dword ptr [ebp-1Ch],\n5045425Fh\n\n# .text:74048D07 66 C7 45 E8 5D 5D            mov   word ptr [ebp-18h],\n5D5Dh\n\n# .text:74048D0D 88 5D EA                mov   [ebp-16h], bl\n\n# .text:74048D10 C7 45 EC DA 4E 1E 00          mov   dword ptr [ebp-14h],\n1E4EDAh\n\n\n\n# .text:740454A9 30 14 08                xor   [eax+ecx], dl\n\n# .text:740454AC 41                   inc   ecx\n\n# .text:740454AD 83 F9 1D                cmp   ecx, 1Dh\n\n File \"<ipython-input-82-89ec58536910>\", line 18\n\n  80 b0 d8 ff 07 74 a8 40 83 f8 06\n\n    ^\n\nSyntaxError: invalid syntax\n\n```\n\n-----\n\n```\nfrom dumpulator import Dumpulator, syscall\n\nfrom dumpulator.native import *\n\nimport pefile\n\n\n@syscall\n\ndef ZwQueryVolumeInformationFile(dp: Dumpulator,\n\n                 FileHandle: HANDLE,\n\n                 IoStatusBlock: P(IO_STATUS_BLOCK),\n\n                 FsInformation: PVOID,\n\n                 Length: ULONG,\n\n                 FsInformationClass: FSINFOCLASS\n\n                 ):\n\n  return STATUS_SUCCESS\n\n\n\ndp = Dumpulator(\"/tmp/b9b.dmp\", quiet=True)\n\ndp.start(dp.regs.eip, end=dp.read_ptr(dp.regs.esp))\n\n\n\nstart_addr = 0x74044390 \n\nend_addr = 0x740443C1 \n\ndp.start(start_addr, end=end_addr)\n\ndp.read(dp.regs.ebx, 14)\n\nFailed to read module data\n\nbytearray(b'193.56.146.60\\\\')\n\n### String Decryption Recap\n\n#### With these older samples, there are 3 different string decryption methods used\n\n Stack strings build with DWORDs that are decrypted using a single byte XOR, the byte is the first byte pushed onto the stack string (this is the same method used for small strings in the new samples) Global strings that are generated using constructors which have some light obfuscation. To deal with these we simply emulate all of the constructors and scrape the global strings from the .data section of the PE. The third and most complex method relies on two calls to functions used to build the encrypted string and then a simple single-byte XOR to decrypt the string.\n\n Complex Third String Decryption Method\n\n```\n\n-----\n\n```\nc6 45 c4 53 57 6a 08\n\n740458C7\n\n.text:740436A5 BE DA 4E 1E 00             mov   esi, 1E4EDAh\n\n.text:740436AA 89 9D 28 FF FF FF            mov   [ebp+var_D8], ebx\n.text:740436B0 89 9D 2C FF FF FF            mov   [ebp+var_D4], ebx\n\nBE DA ?? ?? ?? 89 ?? ?? ?? ?? ?? 89\n\n.text:740480FF 89 5D B0                mov   [ebp-50h], ebx\n\n.text:74048102 8B D3                  mov   edx, ebx\n\n.text:74048104 89 5D B4                mov   [ebp-4Ch], ebx\n\n.text:74048107 89 5D B8                mov   [ebp-48h], ebx\n\n.text:7404810A C6 45 BC 1A               mov   byte ptr [ebp-44h],\n1Ah\n\n89 ?? ?? 8b ?? 89 ?? ?? 89 ?? ?? c6 45\n\n.text:740431A2 72 F7                  jb   short loc_7404319B\n\n.text:740431A4 88 59 0C                mov   [ecx+12], bl\n\n.text:740438E2 72 F7                  jb   short loc_740438DB\n\n.text:740438E4 88 59 0B                mov   [ecx+0Bh], bl\n\n```\n\n-----\n\n```\nfrom dumpulator import Dumpulator, syscall\n\nfrom dumpulator.native import *\n\nimport pefile\n\n\n\n@syscall\n\ndef ZwQueryVolumeInformationFile(dp: Dumpulator,\n\n                 FileHandle: HANDLE,\n\n                 IoStatusBlock: P(IO_STATUS_BLOCK),\n\n                 FsInformation: PVOID,\n\n                 Length: ULONG,\n\n                 FsInformationClass: FSINFOCLASS\n\n                 ):\n\n  return STATUS_SUCCESS\n\n\ndef emulate(start_addr, end_addr, ret_reg, str_len):\n\n  dp = Dumpulator(\"/tmp/b9b.dmp\", quiet=True)\n\n  dp.start(dp.regs.eip, end=dp.read_ptr(dp.regs.esp))\n\n  dp.start(start_addr, end=end_addr)\n\n  return dp.read(dp.regs.__getitem__(ret_reg), str_len)\n\n\npe = pefile.PE(data=file_data)\n\nem_egg = rb'\\xBE\\xDA...\\x89.....\\x89.+?(?=\\x72\\xf7\\x88)'\n\n\nfor m in re.finditer(em_egg, file_data):\n\n  start_offset = m.start()\n\n  end_offset = m.end() + 2\n\n  start_addr = pe.get_rva_from_offset(start_offset) + 0x74030000\n\n  end_addr = pe.get_rva_from_offset(end_offset) + 0x74030000\n\n  str_len = file_data[end_offset + 2]\n\n  if file_data[end_offset + 1] == 0x5f:\n\n    reg_name = 'edi'\n\n  elif file_data[end_offset + 1] == 0x59:\n\n    reg_name = 'ecx'\n\n  print(f\"Testing: {hex(start_addr)}\")\n\n  try:\n\n    print(emulate(start_addr, end_addr, reg_name, str_len ))\n\n  except:\n\n    print(\"fail\")\n\n    continue\n\n```\n\n-----\n\n```\nTesting: 0x74042f48\n\nFailed to read module data\n\nbytearray(b'IPHLPAPI.DLL')\n\nTesting: 0x740430ce\n\nFailed to read module data\n\nbytearray(b'IPHLPAPI.DLL')\n\nTesting: 0x740436a5\n\nFailed to read module data\n\nbytearray(b'\\xfb\\xcc\\xf5\\xfc\\xd5i\\xd2\\t\\xf7nz')\n\nTesting: 0x74043814\n\nFailed to read module data\n\nbytearray(b'\\x98\\xe7\\xe1\\x13-\\x0fo\\xc0hUY')\n\nTesting: 0x74043991\n\nFailed to read module data\n\nfail\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-19 - Matanbuchus Triage Notes.pdf"
    ],
    "report_names": [
        "2022-06-19 - Matanbuchus Triage Notes.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cf7fc640-acfe-41c4-9f3d-5515d53a3ffb",
            "created_at": "2023-01-06T13:46:38.228042Z",
            "updated_at": "2025-03-27T02:00:02.775905Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "GIF89a",
                "G0006",
                "PLA Unit 61398",
                "Group 3",
                "TG-8223",
                "Comment Group",
                "ShadyRAT",
                "COMMENT PANDA",
                "Comment Crew",
                "Byzantine Candor",
                "Brown Fox"
            ],
            "source_name": "MISPGALAXY:APT1",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3aaf0755-5c9b-4612-9f0e-e266ef1bdb4b",
            "created_at": "2022-10-25T16:07:23.480196Z",
            "updated_at": "2025-03-27T02:02:09.826059Z",
            "deleted_at": null,
            "main_name": "Comment Crew",
            "aliases": [
                "APT 1",
                "BrownFox",
                "Byzantine Candor",
                "Byzantine Hades",
                "Comment Crew",
                "Comment Panda",
                "GIF89a",
                "Group 3",
                "Operation Oceansalt",
                "Operation Seasalt",
                "Operation Siesta",
                "Shanghai Group",
                "TG-8223"
            ],
            "source_name": "ETDA:Comment Crew",
            "tools": [
                "Auriga",
                "Cachedump",
                "Chymine",
                "CookieBag",
                "Darkmoon",
                "GDOCUPLOAD",
                "GLOOXMAIL",
                "GREENCAT",
                "Gen:Trojan.Heur.PT",
                "GetMail",
                "Hackfase",
                "Hacksfase",
                "Helauto",
                "Kurton",
                "LETSGO",
                "LIGHTBOLT",
                "LIGHTDART",
                "LOLBAS",
                "LOLBins",
                "LONGRUN",
                "Living off the Land",
                "Lslsass",
                "MAPIget",
                "ManItsMe",
                "Mimikatz",
                "MiniASP",
                "Oceansalt",
                "Pass-The-Hash Toolkit",
                "Poison Ivy",
                "ProcDump",
                "Riodrv",
                "SPIVY",
                "Seasalt",
                "ShadyRAT",
                "StarsyPound",
                "TROJAN.COOKIES",
                "TROJAN.FOXY",
                "TabMsgSQL",
                "Tarsip",
                "Trojan.GTALK",
                "WebC2",
                "WebC2-AdSpace",
                "WebC2-Ausov",
                "WebC2-Bolid",
                "WebC2-Cson",
                "WebC2-DIV",
                "WebC2-GreenCat",
                "WebC2-Head",
                "WebC2-Kt3",
                "WebC2-Qbp",
                "WebC2-Rave",
                "WebC2-Table",
                "WebC2-UGX",
                "WebC2-Yahoo",
                "Wordpress Bruteforcer",
                "bangat",
                "gsecdump",
                "pivy",
                "poisonivy",
                "pwdump",
                "zxdosml"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d9b39228-0d9d-4c1e-8e39-2de986120060",
            "created_at": "2023-01-06T13:46:39.293127Z",
            "updated_at": "2025-03-27T02:00:03.042341Z",
            "deleted_at": null,
            "main_name": "BelialDemon",
            "aliases": [
                "Matanbuchus"
            ],
            "source_name": "MISPGALAXY:BelialDemon",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536048,
    "ts_updated_at": 1743041820,
    "ts_creation_date": 1656803778,
    "ts_modification_date": 1656803778,
    "files": {
        "pdf": "https://archive.orkl.eu/059671465aeae9606397c9e02575170c0c1502bd.pdf",
        "text": "https://archive.orkl.eu/059671465aeae9606397c9e02575170c0c1502bd.txt",
        "img": "https://archive.orkl.eu/059671465aeae9606397c9e02575170c0c1502bd.jpg"
    }
}