{
    "id": "09f27f02-098f-4daa-9273-1e2f82cddbf9",
    "created_at": "2023-01-12T15:09:32.013868Z",
    "updated_at": "2025-03-27T02:06:02.021017Z",
    "deleted_at": null,
    "sha1_hash": "2f7b7728cff4faee71eebcaf45037793e12f769b",
    "title": "2017-05-13 - How to Accidentally Stop a Global Cyber Attacks",
    "authors": "",
    "file_creation_date": "2022-05-28T15:34:58Z",
    "file_modification_date": "2022-05-28T15:34:58Z",
    "file_size": 314568,
    "plain_text": "# Related Posts\n\n**[malwaretech.com/2017/05/how-to-accidentally-stop-a-global-cyber-attacks.html](https://www.malwaretech.com/2017/05/how-to-accidentally-stop-a-global-cyber-attacks.html)**\n\nMalwareTech May 13, 2017\n\nSo finally I’ve found enough time between emails and Skype calls to write up on the crazy\nevents which occurred over Friday, which was supposed to be part of my week off (I made it\na total of 4 days without working, so there’s that). You’ve probably read about the\nWannaCrypt fiasco on several news sites, but I figured I’d tell my story.\n\nI woke up at around 10 AM and checked onto the UK cyber threat sharing platform where i\nhad been following the spread of the Emotet banking malware, something which seemed\nincredibly significant until today. There were a few of your usual posts about various\norganisations being hit with ransomware, but nothing significant…yet. I ended up going out\nto lunch with a friend, meanwhile the WannaCrypt ransomware campaign had entered full\nswing.\n\n\n-----\n\nWhen I returned home at about 2:30, the threat sharing platform was flooded with posts\nabout various NHS systems all across the country being hit, which was what tipped me of to\nthe fact this was something big. Although ransomware on a public sector system isn’t even\nnewsworthy, systems being hit simultaneously across the country is (contrary to popular\nbelief, most NHS employees don’t open phishing emails which suggested that something to\nbe this widespread it would have to be propagated using another method). I was quickly able\nto get a sample of the malware with the help of Kafeine, a good friend and fellow researcher.\nUpon running the sample in my analysis environment I instantly noticed it queried an\nunregistered domain, which i promptly registered.\n\nUsing Cisco Umbrella, we can actually see query volume to the domain prior to\nmy registration of it which shows the campaign started at around 8 AM UTC.\n\nWhile the domain was propagating, I ran the sample again in my virtual environment to be\nmet with WannaCrypt ransom page; but more interestingly was that after encrypting the fake\nfiles I left there as a test, it started connecting out to random IP addresses on port 445 (used\nby SMB). The mass connection attempts immediately made me think exploit scanner, and\nthe fact it was scanning on the SMB port caused me to look back to the recent\nShadowBroker leak of NSA exploits containing….an SMB exploit. Obvious I had no evidence\nyet that it was definitely scanning SMB hosts or using the leaked NSA exploit, so I tweeted\nout my finding and went to tend to the now propagated domain.\n\nSample I found scans SMB after dropping WannaCrypt. Can anyone confirm it's the\nsame thing? P2P spreading ransomware would be significant.\n[pic.twitter.com/zs5Td4ovvL](https://t.co/zs5Td4ovvL)\n\n[— Marcus Hutchins (@MalwareTechBlog) May 12, 2017](https://twitter.com/MalwareTechBlog/status/863054290360946688?ref_src=twsrc%5Etfw)\n\nNow one thing that’s important to note is the actual registration of the domain was not on a\nwhim. My job is to look for ways we can track and potentially stop botnets (and other kinds of\nmalware), so I’m always on the lookout to pick up unregistered malware control server (C2)\ndomains. In fact I registered several thousand of such domains in the past year.\n\nOur standard model goes something like this.\n\n\n-----\n\n1. Look for unregistered or expired C2 domains belonging to active botnets and point it to\n\nour sinkhole (a sinkhole is a server designed to capture malicious traffic and prevent\ncontrol of infected computers by the criminals who infected them).\n2. Gather data on the geographical distribution and scale of the infections, including IP\n\naddresses, which can be used to notify victims that they’re infected and assist law\nenforcement.\n3. Reverse engineer the malware and see if there are any vulnerabilities in the code\n\nwhich would allow us to take-over the malware/botnet and prevent the spread or\nmalicious use, via the domain we registered.\n\nIn the case of WannaCrypt, step 1, 2 and 3 were all one and the same, I just didn’t know it\nyet.\n\nA few seconds after the domain had gone live I received a DM from a Talos analyst asking\nfor the sample I had which was scanning SMB host, which i provided. Humorously at this\npoint we had unknowingly killed the malware so there was much confusion as to why he\ncould not run the exact same sample I just ran and get any results at all. As curious as this\nwas, I was pressed for time and wasn’t able to investigate, because now the sinkhole servers\nwere coming dangerously close to their maximum load.\n\nI set about making sure our sinkhole server were stable and getting the expected data from\nthe domain we had registered (at this point we still didn’t know much about what the domain I\nregistered was for, just that anyone infected with this malware would connect to the domain\nwe now own, allowing us to track the spread of the infection). Sorting out the sinkholes took\nlonger than expected due to a very large botnet we had sinkholed the previous week eating\nup all the bandwidth, but soon enough I was able to set up a live tracking map and push it\nout via twitter (you can still see it [here).](https://intel.malwaretech.com/WannaCrypt.html)\n\n\n-----\n\nWatch Video At:\n\nhttps://youtu.be/LyErffRX0HM\n\nAround 6:23 PM (BST) I asked an employee to look into the worm code and verify the\ndomain we registered would not change (some malware will periodically change the domain\nusing an algorithm, so we needed to know if there would be new domains so we could\nregister those too), meanwhile I performed some updated to the live map to deal with the\nrapid influx of new visitors.\n\nAfter about 5 minutes the employee came back with the news that the registration of the\ndomain had triggered the ransomware meaning we’d encrypted everyone’s files (don’t worry,\nthis was later proven to not be the case), but it still caused quite a bit of panic. I contacted\nKafeine about this and he linked me to the following freshly posted tweet made by\nProofPoint researcher Darien Huss, who stated the opposite (that our registration of the\ndomain had actually stopped the ransomware and prevent the spread).\n\n[#WannaCry propagation payload contains previously unregistered domain, execution](https://twitter.com/hashtag/WannaCry?src=hash&ref_src=twsrc%5Etfw)\n[fails now that domain has been sinkholed pic.twitter.com/z2ClEnZAD2](https://t.co/z2ClEnZAD2)\n\n[— Darien Huss (@darienhuss) May 12, 2017](https://twitter.com/darienhuss/status/863083680528576512?ref_src=twsrc%5Etfw)\n\nHaving heard to conflicting answers, I anxiously loaded back up my analysis environment\nand ran the sample….nothing. I then modified my host file so that the domain connection\nwould be unsuccessful and ran it again…..RANSOMWARED.\n\nNow you probably can’t picture a grown man jumping around with the excitement of having\njust been ransomwared, but this was me. The failure of the ransomware to run the first time\nand then the subsequent success on the second mean that we had in fact prevented the\n\n\n-----\n\nspread of the ransomware and prevented it ransoming any new computer since the\nregistration of the domain (I initially kept quiet about this while i reverse engineered the code\nmyself to triple check this was the case, but by now Darien’s tweet had gotten a lot of\ntraction).\n\nSo why did our sinkhole cause an international ransomware epidemic to stop?\n\n[Talos wrote a great writeup explaining the code side here, which I’ll elaborate on using](http://blog.talosintelligence.com/2017/05/wannacry.html)\nDarien’s screenshot.\n\nAll this code is doing is attempting to connect to the domain we registered and if the\nconnection is not successful it ransoms the system, if it is successful the malware exits (this\nwas not clear to me at first from the screenshot as I lacked the context of what the parent\nfunction may be doing with the results).\n\nThe reason which was suggested is that the domain is a “kill switch” in case something goes\nwrong, but I now believe it to be a badly thought out anti-analysis.\n\nIn certain sandbox environments traffic is intercepted by replying to all URL lookups with an\nIP address belonging to the sandbox rather than the real IP address the URL points to, a\nside effect of this is if an unregistered domain is queried it will respond as it it were registered\n(which should never happen).\n\nI believe they were trying to query an intentionally unregistered domain which would appear\nregistered in certain sandbox environments, then once they see the domain responding, they\nknow they’re in a sandbox the malware exits to prevent further analysis. This technique isn’t\nunprecedented and is actually used by the Necurs trojan (they will query 5 totally random\ndomains and if they all return the same IP, it will exit); however, because WannaCrypt used a\nsingle hardcoded domain, my registartion of it caused all infections globally to believe they\nwere inside a sandbox and exit…thus we initially unintentionally prevented the spread and\n\n\n-----\n\nand further ransoming of computers infected with this malware. Of course now that we are\naware of this, we will continue to host the domain to prevent any further infections from this\nsample.\n\nOne thing that is very important to note is our sinkholing only stops this sample and there is\nnothing stopping them removing the domain check and trying again, so it’s incredibly\nimportiant that any unpatched systems are patched as quickly as possible.\n\nAs well as the names & companies mentioned in this blog I’d like to give a shout out to:\n\n**NCSC UK – Their threat intelligence sharing program provided us with valuable information**\nneeded to first identify the malware family behind the attack. They also helped ensure our\nsinkholes were not mistaken for criminal controlled infrastructure so that we could feed them\nthe information required to notify UK victims.\n\n**FBI & ShadowServer – They were a great help in getting non-UK victims notified of the**\ninfections in a very short span of time, even if it did mean me staying up all night to link in\nwith them.\n\n**2sec4u – For reducing my workload today and providing free panic attacks.**\n\n**Microsoft – By realeasing an out of bounds patch for unsupported operating systems such**\nas Windows XP and Server 2003, people now are able to patch rather than having to attempt\nupgrades to newer system in order to be secured against this worm.\n\nIf you have anything to patch, patch it. If you need a guide, this one is being reguarly\nupdated: https://www.ncsc.gov.uk/guidance/protecting-your-organisation-ransomware\n\nNow I should probably sleep.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-05-13 - How to Accidentally Stop a Global Cyber Attacks.pdf"
    ],
    "report_names": [
        "2017-05-13 - How to Accidentally Stop a Global Cyber Attacks.pdf"
    ],
    "threat_actors": [
        {
            "id": "faa4a29b-254a-45bd-b412-9a1cbddbd5e3",
            "created_at": "2022-10-25T16:07:23.80111Z",
            "updated_at": "2025-03-27T02:02:09.985067Z",
            "deleted_at": null,
            "main_name": "LookBack",
            "aliases": [
                "FlowingFrog",
                "LookBack",
                "LookingFrog",
                "TA410",
                "Witchetty"
            ],
            "source_name": "ETDA:LookBack",
            "tools": [
                "FlowCloud",
                "GUP Proxy Tool",
                "SodomMain",
                "SodomMain RAT",
                "SodomNormal"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536172,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653752098,
    "ts_modification_date": 1653752098,
    "files": {
        "pdf": "https://archive.orkl.eu/2f7b7728cff4faee71eebcaf45037793e12f769b.pdf",
        "text": "https://archive.orkl.eu/2f7b7728cff4faee71eebcaf45037793e12f769b.txt",
        "img": "https://archive.orkl.eu/2f7b7728cff4faee71eebcaf45037793e12f769b.jpg"
    }
}