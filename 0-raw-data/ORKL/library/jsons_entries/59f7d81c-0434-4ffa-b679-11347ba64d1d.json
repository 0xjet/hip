{
    "id": "59f7d81c-0434-4ffa-b679-11347ba64d1d",
    "created_at": "2023-03-04T02:07:17.202418Z",
    "updated_at": "2025-03-27T02:17:27.687826Z",
    "deleted_at": null,
    "sha1_hash": "8e4de1d12b7d3b27bb649689bab287dcf1f5fe46",
    "title": "New APT34 Malware Targets The Middle East",
    "authors": "Trendmicro",
    "file_creation_date": "2023-03-03T03:25:34Z",
    "file_modification_date": "2023-03-03T03:25:34Z",
    "file_size": 4765495,
    "plain_text": "# New APT34 Malware Targets The Middle East\n\n**[trendmicro.com/en_us/research/23/b/new-apt34-malware-targets-the-middle-east.html](https://www.trendmicro.com/en_us/research/23/b/new-apt34-malware-targets-the-middle-east.html)**\n\nAPT & Targeted Attacks\n\n\nFebruary 2, 2023\n\n\nWe analyze an infection campaign targeting organizations in the Middle East for cyberespionage in December 2022 using a\nnew backdoor malware. The campaign abuses legitimate but compromised email accounts to send stolen data to external mail\naccounts controlled by the attackers.\n\nBy: Mohamed Fahmy, Sherif Magdy, Mahmoud Zohdy\nFebruary 02, 2023\nRead time: 8 min (2155 words)\n\nOn December 2022, we identified a suspicious executable (detected by Trend Micro as Trojan.MSIL.REDCAP.AD) that was\ndropped and executed on multiple machines. Our investigation led us to link this attack to advanced persistent threat (APT)\ngroup APT34, and the main goal is to steal users’ credentials. Even in case of a password reset or change, the malware is\ncapable of sending the new credentials to the threat actors. Moreover, after analyzing the backdoor variant deployed, we\nfound the malware capable of new exfiltration techniques — the abuse of compromised mailbox accounts to send stolen data\nfrom the internal mail boxes to external mail accounts controlled by the attackers. While not new as a technique, this is the\nfirst instance that APT34 used this for their campaign deployment. Following this analysis, it is highly likely that this\ncampaign’s routine is only a small part of a bigger chain of deployments. Users and organizations are strongly advised to\nreinforce their current security measures and to be vigilant of the possible vectors abused for compromise.\n\nRoutine\n\nIn this section, we describe the attack infection flow and its respective stages, as well as share details on how the group uses\nemails to steal and exfiltrate critical information.\n\n**First Stage: Initial Droppers**\n\n\n-----\n\nFigure 1. Initial stage .Net droppers\n\nWe found the initial stage .Net dropper malware called MrPerfectInstaller (detected by Trend Micro as\nTrojan.MSIL.REDCAP.AD) responsible for dropping four different files, with each component stored in a Base64 buffer\ninside the main dropper. It drops the following:\n\n1. %System%\\psgfilter.dll: The password filter dynamic link library (DLL) used to provide a way to implement the\n\npassword policy and change notification\n\n\n-----\n\n2. %ProgramData%\\WindowsSoftwareDevices\\DevicesSrv.exe: The main .Net responsible for exfiltrating and leaking\n\nspecific files dropped into the root path of this backdoor execution. This backdoor requires the .Net library\nimplementing Microsoft Exchange webservices to authenticate with the victim mail server and exfiltrate through it.\n3. %ProgramData%\\WindowsSoftwareDevices\\Microsoft.Exchange.WebServices.dll: The library to support the second\n\ncomponent’s capability.\n4. %ProgramData%\\WindowsSoftwareDevices\\DevicesSrv.exe.config: An app configuration file for runtimes of the .Net\n\nexecution environment. This allows the option of falling back to .Net 2.0.\n\nFigure 2. The four Base64 encoded buffers inside the main .Net dropper\n\n\n-----\n\nFigure 3. The four modules dropped by the main binary\n\nThe dropper also adds the following registry key to assist in implementing the password filter dropped earlier:\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet001\\Control\\Lsa\n\nNotification Packages = scecli, psgfilter\n\nFigure 4. Adds the registry key\n\nThe main .Net binary implements two arguments for its operation: the first argument for installing the second stage, and the\nsecond argument for uninstalling it and unregistering the password filter dropped.\n\nFigure 5. Implementing two arguments for operation\n\nFigure 6. Function in case -u passed to dropper\n\n\n-----\n\nFigure 7. Function in case -i passed to dropper, installing the second stage, then uninstalling it and unregistering the\n\npassword filter\n\n**Second Stage: Abusing The Dropped Password Filter Policy**\n\n[Microsoft introduced Password Filters for system administrators to enforce password policies and change notifications.](https://learn.microsoft.com/en-us/windows/win32/secmgmt/password-filters)\nThese filters are used to validate new passwords, confirm that these are aligned with the password policy in place, and ensure\nthat no passwords in use can be considered compliant with the domain policy but are considered weak.\n\nThese password filters can be abused by a threat actor as a method to intercept or retrieve credentials from domain users\n(domain controller) or local accounts (local computer). This is because for password filters to perform, password validation\nrequires the password of the user in plaintext from the Local Security Authority (LSA). Therefore, installing and registering\nan arbitrary password filter could be used to harvest credentials every time a user changes his password. This technique\nrequires elevated access (local administrator) and can be implemented with the following steps:\n\n1. Password Filter psgfilter.dll be dropped into C:\\Windows\\System32\n2. Registry key modification to register the Password Filter [DLL\n\nHKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet001\\Control\\Lsa\n\nNotification Packages = scecli, psgfilter]\n\nUsing this technique, the malicious actor can capture and harvest every password from the compromised machines even after\nthe modification. The DLL has three export functions to implement the main functionality of support for registering the DLL\ninto the LSA, as follows:\n\n**InitializeChangeNotify: Indicates that a password filter DLL is initialized.**\n**PasswordChangeNotify: Indicates that a password has been changed.**\n**PasswordFilter: Validates a new password based on password policy.**\n\n\n-----\n\nFigure 8. First and second stages\n\nFigure 9. Functions exported by DLL\n\nWhen implementing the password filter export functions, the malicious actor took great care working with the plaintext\npasswords. When sent over networks, the plaintext passwords were first encrypted before being exfiltrated.\n\n**Data Exfiltration Through Legitimate Mail Traffic**\n\nThe main backdoor function (detected by Trend Micro as Backdoor.MSIL.REDCAP.A) receives the valid domain credentials\nas an argument and uses it to log on to the Exchange Server and use it for data exfiltration purposes. The main function of\nthis stage is to take the stolen password from the argument and send it to the attackers as an attachment in an email. We also\nobserved that the threat actors relay these emails via government Exchange Servers using vaild accounts with stolen\npasswords.\n\n\n-----\n\nFigure 10. High level overview of malware’s data exfiltration routine\n\nFirst, the .Net backdoor parses a config file dropped in the main root path where it is executing from and checks for a file\ncallled ngb inside <%ProgramData%\\WindowsSoftwareDevices\\DevicesTemp\\> to extract three parameters:\n\nServer: The specific Exchange mail server for the targeted government entity where the data is leaked through.\nTarget: The email addresses where the malicious actors receive the exfiltrated data in.\nDomain: The internal active directory (AD) domain name related to the targeted government entity in the Middle East.\n\nHowever, the malware also supports for the modification of old passwords to new ones, which are sent through the registered\nDLL password filter.\n\n\n-----\n\nFigure 11. Checking the config file path ngb\n\nThe malware proceeds to initialize an ExchangeService object in the first step and supplies the stolen credentials as\nWebCredentials to interface with the victim mail server in the second step. Using these Exchange Web Service (EWS)\nbindings, the malicious actor can send mails to external recipients on behalf of any stolen user and initialize a new instance of\nthe WebCredentials class with the username and password for the account to authenticate.\n\nFigure 12. Initialize EWS binding to the victim mail server\n\nThe malware then iterates through the files found under the target path. For each file found, it adds its path to a list, which\nwill be exfiltrated later in the last step.\n\nFigure 13. Iterating through the files found under the target path\n\n\n-----\n\nThe final stage is to iterate over the collected list of file paths. For each path, it prepares an EmailMessage object with the\nsubject “Exchange Default Message”, and a mail body content of “Exchange Server is testing services.” The iteration attaches\nthe whole file to this EmailMessage object and sends it using the previous initalized EWS form (Steps 1 and 2 in Figure 10),\nwhich already authenticated the user account.\n\nFigure 14. Exfiltrating files using mail attachments\n\nFigure 15. Some hardcoded targets in the sample\n\nFigure 16 How the Sent folder looks like for a compromised user\n\n\n-----\n\nAPT34 Targeting and Arsenal Evolution\n\nAPT34 has been documented to target organizations worldwide, particularly companies from the financial, government,\n[energy, chemical, and telecommunications industries in the Middle East since at least 2014. Documented as a group](https://cyware.com/blog/apt34-the-helix-kitten-cybercriminal-group-loves-to-meow-middle-eastern-and-international-organizations-48ae)\n[primarily involved for cyberespionage, APT34 has been previously recorded targeting government offices and show no signs](https://www.malwarebytes.com/blog/threat-intelligence/2022/05/apt34-targets-jordan-government-using-new-saitama-backdoor)\nof stopping with their intrusions. Our continuous monitoring of the group proves it continues to create new and updated\ntools to minimize the detection of their arsenal: Shifting to new data exfiltration techniques — from the heavy use of DNSbased command and control (C&C) communication to combining it with the legitimate simple mail transfer protocol (SMTP)\nmail traffic — to bypass any security policies enforced on the network perimeters.\n\nFrom three previously documented attacks, we observed that while the group uses simple malware families, these\ndeployments show the group's flexibility to write new malware based on researched customer environments and levels of\naccess. This level of skill can make attribution for security researchers and reverse engineers more difficult in terms of\ntracking and monitoring because patterns, behaviors, and tools can be completely different for every compromise.\n\n[For instance, in the two separate attacks using Karkoff (detected by Trend Micro as Backdoor.MSIL.OILYFACE.A) in 2020](https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/)\nand Saitama (detected by Trend Micro as Backdoor.MSIL.AMATIAS.THEAABB) in [2022, the group used macros inside Excel](https://www.malwarebytes.com/blog/threat-intelligence/2022/05/apt34-targets-jordan-government-using-new-saitama-backdoor)\nfiles as part of the first stage to send phishing emails since the group did not have access to the enterprise yet. Contrary to this\nnewest compromise, however, the first stage was rewritten completely in DotNet and executed by the actor directly.\n\nMoreover, Karkoff malware has a full backdoor module using a government exchange server as a communication channel via\nsend/received commands over an exchanged server, and used a hardcoded account to authenticate the said communication.\nCompared to the new malware, the latest compromise seems to be rewritten to use the same technique but only to exfiltrate\ndata over the mail channel. Aside from using hardcoded accounts as exchange accounts, APT34 can add a new module that\ncan monitor changes in passwords and use the new accounts to send mails, exfiltrating data via Microsoft Exchange servers.\n\n[Based on a 2019 report on APT34, the top countries targeted by the group are:](https://www.zdnet.com/article/source-code-of-iranian-cyber-espionage-tools-leaked-on-telegram/)\n\nThe United Arab Emirates\nChina\nJordan\nSaudi Arabia\n\nWhile not at the top of the group’s list, other countries in the Middle East considered as targets are Qatar, Oman, Kuwait,\nBahrain, Lebanon, and Egypt.\n\nAttribution Analysis\n\nThere are several data points and indicators that suggest APT34 carried out this attack, and that this group is still active in\ntargeting countries in the Middle East with a special focus on compromising government entities.\n\n**1.   The first stage dropper**\n\nThe first stage dropper between the Saitama backdoor and this new operation’s first stage .Net dropper have a few\nsimilarities. Despite the dated Saitama operation’s first stage dropper, a VBA macro that drops the actual .Net backdoor\n[Saitama malware, the new attack implemented in the group’s latest deployment is a .Net dropper that drops the actual](https://www.malwarebytes.com/blog/threat-intelligence/2022/05/apt34-targets-jordan-government-using-new-saitama-backdoor)\nmalware. Both deployments’ final stages leverage EWS’ Managed API (Microsoft.Exchange.WenServices.dll).\n\nFigure 17. Saitama backdoor’s first stage dropper (left), and the dropped files for the new APT34 .Net backdoor in the first stage (right)\n\n**2.   Leveraging exchange servers for communications (Uni- and bidirectional)**\n\nBoth this campaign and the Karkoff campaign made use of targeted exchange servers and relayed communications through\n[it. In the previous campaign, this was reportedly done with the deployment of the Karkoff implant. The old Karkoff sample](https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/)\nattributed to APT34 share a common functionality for abusing the EWS API.\n\n\n-----\n\nFigure 18. The Karkoff implant leveraging EWS (top), and the newer APT34 backdoor’s use of EWS (bottom)\n\n**3.   The victim targeted**\n\n[APT34 has been documented for targeting countries in the Middle East. In a previous campaign analyzed by Yoroi Labs, the](https://web.archive.org/web/20200929051957/https:/yoroi.company/research/karkoff-2020-a-new-apt34-espionage-operation-involves-lebanon-government/)\nKarkoff sample (SHA256: 1f47770cc42ac8805060004f203a5f537b7473a36ff41eabb746900b2fa24cc8) attributed to APT34\nhas the mail server domain hardcoded inside the sample. Alongside the target mail recipient the attackers receive\ninformation from is the same hardcoded mail server domain found in the latest backdoor, including the targeted Exchange\nServer for a government ministry. Both samples included some hardcoded credentials as well. However, the newer backdoor\nincludes support for stealing the new passwords of previously compromised users who changed their passwords, ensuring\ntheir legitimate accounts stay compromised.\n\nFigure 19. Karkoff implant targeting an army mail server in 2020 (top), and the newer APT backdoor targeting another mail server in 2023\n\n(bottom)\n\nConclusions\n\nAt first glance, security teams can mistakenly tag the sample as safe or as a benign activity given the validity of the domains\nand mail credentials. It will take more experienced analysts to see that the domains abused is part of a bigger active directory\ndomain “forest”, which share a trust relationship with each other to allow different government ministries or agencies to\ncommunicate. Considering we found a compromised account from one entity inside a sample sourced from a different agency\nindicates APT34 now has a deep foothold in the government domain forest.\n\nFollowing the stages executed, APT34’s repeated use of the Saitama backdoor technique in the first stage indicates a\nconfidence that even the dated malware’s technique will continue to work and initiate compromise.\n\nThe next stages for exfiltrating data, however, are considerably new and are considered exploratory for the group. Despite the\nroutine's simplicity, the novelty of the second and last stages also indicate that this entire routine can just be a small part of a\nbigger campaign targeting governments We continue tracking and monitoring the abuse of this threat to determine the\n\n\n-----\n\ndepth and breadth of this compromise.\n\nIndicators of Compromise (IOCs)\n\n**SHA256**\n\n5ed7ebc339af6ca6a5d1b9b45db6b3ae00232d9ccd80d5fcadf7680320bd4e6b\n\n827366355c6429a7fe12d111e240c5bcec3ed61e717fb84ea8b771672dd1f88e\n\nEmails abused\n\nJaqueline[.]Herrera@proton[.]me\nCiara[.]Stoneburner@proton[.]me\nmarsha[.]fischer556@gmail[.]com\nKathryn[.]Firkins@proton[.]me\nSusan[.]potts454@proton[.]me\nEarl[.]butler945@gmail[.]com\n\n**_Additional insights provided by AbdelRahman Yasser._**\n\n|SHA256|File name|Detection|\n|---|---|---|\n|5ed7ebc339af6ca6a5d1b9b45db6b3ae00232d9ccd80d5fcadf7680320bd4e6b|DevicesSrv.exe|Backdoor.MSIL.REDCAP.A|\n|827366355c6429a7fe12d111e240c5bcec3ed61e717fb84ea8b771672dd1f88e|psgfilter.dll|Trojan.Win64.REDCAP.AF|\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/9us9hqv5o7pnbt748p9g0o6lg3w7vdgo"
    ],
    "report_names": [
        "Trendmicro_New-APT34-Malware-Targets-MiddleEast(02-02-2023)"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1677895637,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1677813934,
    "ts_modification_date": 1677813934,
    "files": {
        "pdf": "https://archive.orkl.eu/8e4de1d12b7d3b27bb649689bab287dcf1f5fe46.pdf",
        "text": "https://archive.orkl.eu/8e4de1d12b7d3b27bb649689bab287dcf1f5fe46.txt",
        "img": "https://archive.orkl.eu/8e4de1d12b7d3b27bb649689bab287dcf1f5fe46.jpg"
    }
}