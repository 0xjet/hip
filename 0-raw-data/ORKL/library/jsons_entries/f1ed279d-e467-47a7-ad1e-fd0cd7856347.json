{
    "id": "f1ed279d-e467-47a7-ad1e-fd0cd7856347",
    "created_at": "2023-01-12T15:04:27.729204Z",
    "updated_at": "2025-03-27T02:09:54.204381Z",
    "deleted_at": null,
    "sha1_hash": "21c562eb1109058b39899b8964c2500bf5a329e4",
    "title": "2012-07-17 - The Madi Campaign – Part I",
    "authors": "",
    "file_creation_date": "2022-05-28T01:59:46Z",
    "file_modification_date": "2022-05-28T01:59:46Z",
    "file_size": 890160,
    "plain_text": "# The Madi Campaign – Part I\n\n**securelist.com/the-madi-campaign-part-i-5/33693/**\n\nAuthors\n\nGReAT\n\nFor almost a year, an ongoing campaign to infiltrate computer systems throughout the Middle\nEast has targeted individuals across Iran, Israel, Afghanistan and others scattered across the\nglobe.\n\nTogether with our partner, Seculert, weve thoroughly investigated this operation and named it\nthe Madi, based on certain strings and handles used by the attackers. You can read the\nSeculert analysis post here: http://blog.seculert.com/2012/07/mahdi-cyberwar-savior.html”.\n\nThe campaign relied on a couple of well known, simpler attack techniques to deliver the\npayloads, which reveals a bit about the victims online awareness. Large amounts of data\ncollection reveal the focus of the campaign on Middle Eastern critical infrastructure\nengineering firms, government agencies, financial houses, and academia. And individuals\nwithin this victim pool and their communications were selected for increased monitoring over\nextended periods of time.\n\n\n-----\n\nThis post is an examination of the techniques used to spread the Madi malware to victim\nsystems, the spyware tools used, and quirks about both. In some cases, targeted\norganizations themselves don’t want to provide further breach information about the attack,\nso some perspective into the parts of the campaign can be limited.\n\n## The Arrival\n\n### Social engineering schemes to drop and run spyware\n\nThe Madi attackers rely mostly on social engineering techniques to distribute their spyware:\n\nThe first of the two social engineering schemes that define spreading activity for this\nsurveillance campaign is the use of attractive images and confusing themes embodied in\nPowerPoint Slide Shows containing the embedded Madi trojan downloaders. An “Activated\nContent” PowerPoint effect enables executable content within these spearphish attachments\nto be run automatically. These embedded trojan downloaders in turn fetch and install the\nbackdoor services and related “housekeeping” data files on the victim system. One example,\n“Magic_Machine1123.pps”, delivers the embedded executable within a confusing math\npuzzle PowerPoint Slide Show where the amount of math instructions may overwhelm a\nviewer. Note that while PowerPoint presents users a dialog that the custom animation and\nactivated content may execute a virus, not everyone pays attention to these warnings or\ntakes them seriously, and just clicks through the dialog, running the malicious dropper.\n\nAnother PowerPoint Slide Show named Moses_pic1.pps walks the viewer through a series\nof calm, religious themed, serene wilderness, and tropical images, confusing the user into\nrunning the payload on their system as seen below:\n\n\n-----\n\nAnd:\n\n\n-----\n\nAnd:\n\nSome of the downloaders also drop and open documents with Middle Eastern news content\nand religious themes as well, as seen here.\n\n\n-----\n\n_Social engineering – Right to left override (RTLO) techniques_\n\nLike many pieces of this puzzle, most of the components are simple in concept, but effective\nin practice. No extended 0-day research efforts, no security researcher commitments or big\nsalaries were required. In other words, attacking this set of victims without 0-day in this\nregion works well enough.\n\nIn addition to the attractive PowerPoint Slide Shows frequently delivered within password\nprotected zip archives, the attackers sent out executables maintaining misleading file names\nusing the publicly known “Right to Left Override” technique. These file names appear to the\nuser as image files with harmless .jpg extensions, .pdf extensions, or whatever a determined\nattacker might craft along with the matching file type icons, leading users to believe they can\njust click on what is not a data file, but an executable file.\n\nThe issue exists with the way Windows handles Unicode character sets. The technique has\n[been written up here and](http://blog.relentless-coding.org/2011/10/social-engineering-with-unicode.html) [here. Madis related incident files included filenames that appeared](http://krebsonsecurity.com/2011/09/right-to-left-override-aids-email-attacks/)\non victim systems as “picturcs..jpg”, along with a common .jpg icon. But when that Unicode,\nor UTF-8 based filename is copied to an ANSI file, the name is displayed as “pictu?gpj..scr”.\nSo some Madi victims were tricked into clicking on what they thought was a harmless .jpg,\nand instead ran the executable “.scr” file. A screenshot presents an example filename here,\nwith the flawed Widows explorer display above, and the command line display below:\n\n\n-----\n\nWhen executed, these PE droppers will attempt to show misleading images or videos, once\nagain, tricking the victim into believing nothing is wrong. Heres a video about a missile test:\n\nAnd a nuclear explosion photo:\n\n\n-----\n\n## Finding Presence\n\nThe backdoors that were delivered to approximately 800 victim systems were all coded in\nDelphi. This would be expected from more amateur programmers, or developers in a rushed\nproject. Here is a screenshot of the interface for the admins:\n\nThe executables are packed with a recent version of the legitimate UPX packer such as UPX\n3.07. Unfortunately, that technique and quickly shifting code will get the code past some\ngateway security products.\n\nWhen run, most versions of the dropper create a large volume of files in c:documents and\nsettingsPrinthood. Along with UpdateOffice.exe or OfficeDesktop.exe (and other variations\non the Office name), hundreds of mostly empty, housekeeping files are created. Heres a\nshort list of files keeping configuration data:\n\nFIE.dll Filename extension\n\nxdat.dll Last check-in date\n\nBIE.dll Distraction filename extension\n\n\n-----\n\nSHK.dll,\nnam.dll\n\n\nVictim directory path prefix (i.e. abamo9 <- this is the operator/handler\nname for this victim)\n\n\nSIK.dll Domain check-in (i.e. www.maja.in)\n\nAlso dropped and opened are any one of several distraction images and documents. One of\nthe documents is the Jesus image posted above (dropped as encoded content within\nMotahare.txt), and one of the documents is a copy and paste job of an article at The Daily\nBeast on electronic warfare in the region, which was dropped as encoded content within\nMahdi.txt.\n\nInfostealers are downloaded and run as iexplore.exe from within the templates directory\nmentioned above.\n\nFunctionality list:\n\n\n-----\n\nThe functionality in the backdoor software mirrors the options present in the configuration\ntool. Notice the nine different options:\n\n1. Keylogging\n2. Screenshot capture at specified intervals. (see timers below)\n3. Screenshot capture at specified intervals, initiated exclusively by a communications\nrelated event. The event may be that the victim is interacting with webmail, an IM client\nor social networking site. These triggering sites include Gmail, Hotmail, Yahoo! Mail,\nICQ, Skype, google+, Facebook and more.\n4. Update this backdoor\n5. Record audio as .WAV file and save for upload\n6. Retrieve any combination of 27 different types of data files\n7. Retrieve disk structures\n8. Delete and bind these are not fully implemented yet\n\nThe various operations of the backdoor are controlled by Delphi Timers, as seen below:\n\n\n-----\n\n### Using a disinfected version of Resource Hacker\n\nIt’s common behavior for malware to maintain malicious code in their resource section,\ndecompress it on the fly and drop it to disk. Or, for attackers to modify the icons of their\nRTLO spearphish.\n\nThe Madi attackers maintain two copies of ResHacker (see\nhttp://www.angusj.com/resourcehacker/ ) for distribution on their websites, embedded within\nfiles “SSSS.htm” and “RRRR.htm”. They not only created more noise on the wire by\ninstructing their malware to download ResHacker, a well known resource section editor, but it\nlooks like they have had problems with virus infections on their own networks. These copies\ndiffered by one byte. That difference is the value in the SizeofImage section, 0xdc800 in one\nfile, and 0xde000 in the other. The difference presents itself because both were infected with\nVirus.Win32.Parite.b (https://threats.kaspersky.com/en/threat/Virus.Win32.Parite.b) at some\npoint, and then cleaned by Anti-Virus scanners. So it’s possible and likely that the attackers\nare bumbling through infections of their own.\n\n### Indicators of compromise\n\nAll known compromised systems are known to communicate over HTTP with one of several\nweb servers, such as: 174.142.57.* (3 servers) and 67.205.106.* (one server).\n\nIn addition, ICMP PING packets are sent to these servers to check their status.\n\nThe infostealers are downloaded and executed from the c:Documents and\nSettings%USER%Templates folder. The downloader itself runs from c:documents and\n\n\n-----\n\nsettings%USER%Printhood, which may contain over 300 files with .PRI, .dll, and .TMP\nextensions. The infostealers are named “iexplore.exe”, while the downloaders maintained\nnames like UpdateOffice.exe or OfficeDesktop.exe.\n\nAt the time of writing, the campaign continues to be in operation and we are working with\nvarious organizations to clean up and prevent further infections. Kaspersky products detect\nthe malware as Trojan.Win32.Madi.*; some of the older variants are detected as\n“Trojan.Win32.Upof.*”.\n\nRelated MD5s, not a complete list:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n\n7b7abab9bc4c49743d001cf99737e383\n\na9774d6496e1b09ccb1aeaba3353db7b\n\n885fcebf0549bf0c59a697a7cfff39ad\n\n4be969b977f9793b040c57276a618322\n\nea90ed663c402d34962e7e455b57443d\n\naa6f0456a4c2303f15484bff1f1109a0\n\ncaf851d9f56e5ee7105350c96fcc04b5\n\n1fe27986d9d06c10e96cee1effc54c68\n\n07740e170fc9cac3dcd692cc9f713dc2\n\n755f19aa99a0ccba7d210e7f79182b09\n\n35b2dfd71f565cfc1b67983439c09f72\n\nd9a425eac54d6ca4a46b6a34650d3bf1\n\n67c6fabbb0534090a079ddd487d2ab4b\n\ne4eca131cde3fc18ee05c64bcdd90299\n\nc71121c007a65fac1c8157e5930d656c\n\na86ce04694a53a30544ca7bb7c3b86cd\n\n7b22fa2f81e9cd14f1912589e0a8d309\n\n061c8eeb7d0d6c3ee751b05484f830b1\n\n3ab9c5962ab673f62823d8b5670f0c07\n\n1c968a80fa2616a4a2822d7589d9a5b4\n\n1593fbb5e69bb516ae32bec6994f1e5d\n\n\n-----\n\n22\n\n23\n\n24\n\n25\n\n26\n\n27\n\n28\n\n29\n\n30\n\n31\n\n32\n\n33\n\n34\n\n35\n\n36\n\n37\n\n38\n\n39\n\n40\n\n41\n\n42\n\n43\n\n44\n\n\n133f2735e5123d848830423bf77e8c20\n\n01dc62abf112f53a97234f6a1d54bc6f\n\n18002ca6b19c3c841597e611cc9c02d9\n\n046bcf4ea8297cdf8007824a6e061b63\n\n89057fc8fedc7da1f300dd7b2cf53583\n\n461ba43daa62b96b313ff897aa983454\n\nd0dd88d60329c1b2d88555113e1ed66d\n\n9c072edfb9afa88aa7a379d73b65f82d\n\nb86409e2933cade5bb1d21e4e784a633\n\n3fc8788fd0652e4f930d530262c3d3f3\n\n15416f0033042c7e349246c01d6a43a3\n\nf782d10eab3a7ca3c4a73a2f86128aad\n\ncfd85a908554e0921b670ac9e3088631\n\nabb49a9d81ec2cf8a1fb4d82fb7f1915\n\nb2b4d7b5ce7c134df5cb40f4c4d5aa6a\n\n8b01fc1e64316717a6ac94b272a798d4\n\n81b2889bab87ab25a1e1663f10cf7e9e\n\n3702360d1192736020b2a38c5e69263a\n\n8139be1a7c6c643ae64dfe08fa8769ee\n\n331f75a64b80173dc1d4abf0d15458cc\n\n398168f0381ab36791f41fa1444633cc\n\nd6f343e2bd295b69c2ce31f6fe369af9\n\nf45963376918ed7dc2b96b16af976966\n\n\nPart II of this blogpost will examine the broader picture infrastructure, communications, data\ncollection, and victims.\n\n[Adobe PDF](https://securelist.com/tag/adobe-pdf/)\n[APT](https://securelist.com/tag/apt/)\n[Microsoft](https://securelist.com/tag/microsoft/)\n\n\n-----\n\n[Microsoft Windows](https://securelist.com/tag/microsoft-windows/)\n[Targeted attacks](https://securelist.com/tag/targeted-attacks/)\n\nAuthors\n\nGReAT\n\nThe Madi Campaign – Part I\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2012/2012-07-17 - The Madi Campaign – Part I.pdf"
    ],
    "report_names": [
        "2012-07-17 - The Madi Campaign – Part I.pdf"
    ],
    "threat_actors": [
        {
            "id": "b07fec96-80cd-4d92-aa52-a26a0b25b7c2",
            "created_at": "2022-10-25T16:07:23.826594Z",
            "updated_at": "2025-03-27T02:02:09.994638Z",
            "deleted_at": null,
            "main_name": "Madi",
            "aliases": [
                "Mahdi"
            ],
            "source_name": "ETDA:Madi",
            "tools": [
                "Madi"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "322a0ef1-136b-400e-89d0-0d62ee2bd319",
            "created_at": "2023-01-06T13:46:38.662109Z",
            "updated_at": "2025-03-27T02:00:02.885938Z",
            "deleted_at": null,
            "main_name": "Madi",
            "aliases": [],
            "source_name": "MISPGALAXY:Madi",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535867,
    "ts_updated_at": 1743041394,
    "ts_creation_date": 1653703186,
    "ts_modification_date": 1653703186,
    "files": {
        "pdf": "https://archive.orkl.eu/21c562eb1109058b39899b8964c2500bf5a329e4.pdf",
        "text": "https://archive.orkl.eu/21c562eb1109058b39899b8964c2500bf5a329e4.txt",
        "img": "https://archive.orkl.eu/21c562eb1109058b39899b8964c2500bf5a329e4.jpg"
    }
}