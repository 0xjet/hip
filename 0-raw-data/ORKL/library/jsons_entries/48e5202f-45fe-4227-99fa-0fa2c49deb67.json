{
    "id": "48e5202f-45fe-4227-99fa-0fa2c49deb67",
    "created_at": "2023-01-12T15:05:03.238815Z",
    "updated_at": "2025-03-27T02:09:38.825504Z",
    "deleted_at": null,
    "sha1_hash": "cd785f5020e4e61589f2fd7175a3ecf325d456ec",
    "title": "2016-06-22 - After Angler- Shift in Exploit Kit Landscape and New Crypto-Ransomware Activity",
    "authors": "",
    "file_creation_date": "0001-01-01T00:00:00Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 433437,
    "plain_text": "NETRESEC > Blog\n\nWednesday, 12 November 2014 21:09:00 (UTC/GMT)\n\n# Observing the Havex RAT\n\nIt has, so far, been publicly reported that\nthree ICS vendors have spread the Havex\nRemote-Access-Tool (RAT) as part of their\nofficial downloads. We've covered the six\npieces of software from these three vendors\nin our blog post ”Full Disclosure of Havex\nTrojans”. In this blog post we proceed by\nanalyzing network traffic generated by\nHavex.\n\n**Indicators of Compromise**\n\nBefore going into details of our analysis we'd like to recommend a few other resources\nthat can be used to detect the Havex RAT. There are three Havex IDS signatures\navailable via Emerging Threats. There are also Yara rules and OpenIOC signatures\navailable for Havex. Additionally, the following domains are known to be used in the\nlater versions (043 and 044) of Havex according to Kaspersky:\n\ndisney.freesexycomics.com\nelectroconf.xe0.ru\nrapidecharge.gigfa.com\nsinfulcelebs.freesexycomics.com\nwww.iamnumber.com\n\n**HTTP Command-and-Control**\n\nThe Havex RAT Command-and-Control (C2) protocol is based on HTTP POST requests,\nwhich typically look something like this:\n\n\n## Recent Blog Posts\n\n» Observing the Havex RAT\n\n» Full Disclosure of Havex\nTrojans\n\n» Chinese MITM Attack on iCloud\n\n» Verifying Chinese MITM of\nYahoo\n\n» Analysis of Chinese MITM on\nGoogle\n\n» Running NetworkMiner on Mac\nOS X\n\n» NetworkMiner 1.6 Released\n\n» PCAP or it didn't happen\n\n## Blog Archive\n\n» 2014 November\n» 2014 October\n» 2014 September\n» 2014 June\n» 2014 May\n» 2014 April\n» 2014 March\n» 2014 February\n» 2013 October\n» 2013 September\n» 2013 August\n» 2013 April\n» 2013 February\n» 2013 January\n» 2012 December\n» 2012 November\n» 2012 September\n» 2012 August\n» 2012 July\n» 2012 June\n» 2012 April\n» 2012 January\n» 2011 December\n» 2011 November\n» 2011 October\n» 2011 September\n» 2011 August\n» 2011 July\n» 2011 June\n» 2011 May\n» 2011 April\n» 2011 March\n» 2011 February\n» 2011 January\n\nList all blog posts\n\nGrab our FeedBurner or RSS feed\n\n\nPOST /blogs/wp-content/plugins/buddypress/bp-settings/bpsettings-src.php?\nid=84651193834787196090098FD80-c8a7af419640516616c342b13efab&v1=043&​ ​\nv2=170393861&q=45474bca5c3a10c8e94e56543c2bd​\n\n\nAs you can see, four variables are sent in the QueryString of this HTTP POST request;\nnamely id, v1, v2 and q. Let's take a closer look to see what data is actually sent to\nthe C2 server in the QueryString.\n\n**Param** **Description** **Common Values**\n\nid host identifier id=[random number][random hex]-c8a7af419640516616c342b13efab id=[random number][random-hex]-003f6dd097e6f392bd1928066eaa3\n\nv1 Havex version 043044\n\nv2 Windows version 170393861 (Windows XP)498073862 (Windows 7)\n498139398 (Windows 7, SP1)\n\nq Unknown q=45474bca5c3a10c8e94e56543c2bd (Havex 043)q=0c6256822b15510ebae07104f3152 (Havex 043)\nq=214fd4a8895e07611ab2dac9fae46 (Havex 044)\nq=35a37eab60b51a9ce61411a760075 (Havex 044)\n\n**Analyzing a Havex PCAP**\n\n\n-----\n\n800 MB PCAP file from when he executed the Havex malware in an Internet connected\nlab environment.\n\nImage: CapLoader transcript of Havex C2 traffic\n\nI used the command line tool NetworkMinerCLI (in Linux) to automatically extract all\nHTTP downloads from Joel's PCAP file to disk. This way I also got a CSV log file with\nsome useful metadata about the extracted files. Let's have a closer look at what was\nextracted:\n\n\n## NETRESEC on Twitter\n\nFollow @netresec on twitter:\n» twitter.com/netresec\n\n## Recommended Books\n\n» The Practice of Network\nSecurity Monitoring, Richard\nBejtlich (2013)\n\n» Applied Network Security\nMonitoring, Chris Sanders and\nJason Smith (2013)\n\n» Network Forensics, Sherri\nDavidoff and Jonathan Ham\n(2012)\n\n» The Tao of Network Security\nMonitoring, Richard Bejtlich\n(2004)\n\n» Practical Packet Analysis, Chris\nSanders (2011)\n\n» Windows Forensic Analysis,\nHarlan Carvey (2009)\n\n» TCP/IP Illustrated, Volume 1,\nKevin Fall and Richard Stevens\n(2011)\n\n» Industrial Network Security, Eric\nD. Knapp and Joel Langill (2014)\n\n\n$ mono NetworkMinerCLI.exe -r new-round-09-setup.pcap\nClosing file handles...\n970167 frames parsed in 1337.807 seconds.\n\n$ cut -d, -f 1,2,3,4,7,12 new-round-09-setup.pcap.FileInfos.csv | head\n\nSourceIP  SourcePort DestinationIP DestinationPort FileSize  Frame\n185.27.134.100  TCP 80  192.168.1.121  TCP 1238  244 676 B    14\n198.63.208.206  TCP 80  192.168.1.121  TCP 1261    150 B   1640\n185.27.134.100  TCP 80  192.168.1.121  TCP 1286  359 508 B   3079\n185.27.134.100  TCP 80  192.168.1.121  TCP 1311  236 648 B   4855\n185.27.134.100  TCP 80  192.168.1.121  TCP 1329    150 B  22953\n185.27.134.100  TCP 80  192.168.1.121  TCP 1338    150 B  94678\n185.27.134.100  TCP 80  192.168.1.121  TCP 1346    150 B  112417\n198.63.208.206  TCP 80  192.168.1.121  TCP 1353    150 B  130108\n198.63.208.206  TCP 80  192.168.1.121  TCP 1365    150 B  147902\n\n\nFiles downloaded through Havex C2 communication are typically modules to be\nexecuted. However, these modules are downloaded in a somewhat obfuscated format;\nin order to extract them one need to do the following:\n\nBase64 decode\nDecompress (bzip2)\nXOR with ”1312312”\n\nTo be more specific, here's a crude one-liner that I used to calculate MD5 hashes of\nthe downloaded modules:\n\n\n$ tail -c +95 C2 download.html | base64 -d | bzcat -d | xortool-xor -s\n\n\n-----\n\n**First**\n**frame**\n\n\n**Last**\n**frame**\n\n\n**Downloaded HTML MD5** **Extracted module MD5**\n\n\n14 293 7818cb3853eea675414480892ddfe668 7cff1403546eba915f1d7c023f12a0df\n\n3079 1642 9b20948513a1a4ea77dc3fc808a5ebb9 840417d79736471c2f331550be993d79\n\n4855 5117 fb46a96fdd53de1b8c5e9826d85d42d6 ba8da708b8784afd36c44bb5f1f436bc\n\nAll three extracted modules are known binaries associated with Havex. The third\nmodule is one of the Havex OPC scanner modules, let's have a look at what happens\non the network after this module has been downloaded!\n\n**Analyzing Havex OPC Traffic**\n\nIn Joel's PCAP file, the OPC module download finished at frame 5117. Less then a\nsecond later we see DCOM/MS RPC traffic. To understand this traffic we need to know\nhow to interpret the UUID's used by MS RPC.\n\nMarion Marschalek has listed 10 UUID's used by the Havex OPC module in order to\nenumerate OPC components. However, we've only observed four of these commands\nactually being used by the Havex OPC scanner module. These commands are:\n\n**MS RPC UUID** **OPC-DA Command**\n\n9dd0b56c-ad9e-43ee-8305-487f3188bf7a IOPCServerList2\n\n55c382c8-21c7-4e88-96c1-becfb1e3f483 IOPCEnumGUID\n\n39c13a4d-011e-11d0-9675-0020afd8adb3 IOPCServer\n\n39227004-a18f-4b57-8b0a-5235670f4468 IOPCBrowse\n\nOf these commands the ”IOPC Browse” is the ultimate goal for the Havex OPC scanner,\nsince that's the command used to enumerate all OPC tags on an OPC server. Now, let's\nhave a look at the PCAP file to see what OPC commands (i.e. UUID's) that have been\nissued.\n\n\n$ tshark -r new-round-09-setup.first6000.pcap -n -Y 'dcerpc.cn_bind_to_uuid\n!= 99fcfec4-5260-101b-bbcb-00aa0021347a' -T fields -e frame.number -e ip.dst\n-e dcerpc.cn_bind_to_uuid -Eoccurrence=f -Eheader=y\n\nframe.nr ip.dst   dcerpc.cn_bind_to_uuid\n5140  192.168.1.97 000001a0-0000-0000-c000-000000000046\n5145  192.168.1.11 000001a0-0000-0000-c000-000000000046\n5172  192.168.1.97 000001a0-0000-0000-c000-000000000046\n5185  192.168.1.11 9dd0b56c-ad9e-43ee-8305-487f3188bf7a\n5193  192.168.1.97 000001a0-0000-0000-c000-000000000046\n5198  192.168.1.11 55c382c8-21c7-4e88-96c1-becfb1e3f483\n5212  192.168.1.11 00000143-0000-0000-c000-000000000046\n5247  192.168.1.11 000001a0-0000-0000-c000-000000000046\n5257  192.168.1.11 00000143-0000-0000-c000-000000000046\n5269  192.168.1.11 00000143-0000-0000-c000-000000000046\n5274  192.168.1.11 39c13a4d-011e-11d0-9675-0020afd8adb3\n5280  192.168.1.11 39c13a4d-011e-11d0-9675-0020afd8adb3\n5285  192.168.1.11 39227004-a18f-4b57-8b0a-5235670f4468\n5286  192.168.1.11 39227004-a18f-4b57-8b0a-5235670f4468\n\n[...]\n\n\nWe can thereby verify that the IOPCBrowse command was sent to one of Joel's OPC\nservers in frame 5285 and 5286. However, tshark/Wireshark is not able to parse the\nlist of OPC items (tags) that are returned from this function call. Also, in order to find\nall IOPCBrowse commands in a more effective way we'd like to search for the binary\nrepresentation of this command with tools like ngrep or CapLoader. It would even be\npossible to generate an IDS signature for IOPCBrowse if we'd know what to look for.\n\nThe first part of an MSRPC UUID is typically sent in little endian, which means that the\nIOPCBrowse command is actually sent over the wire as:\n\n04 70 22 39 8f a1 57 4b 8b 0a 52 35 67 0f 44 68\n\nLet's search for that value in Joel's PCAP file:\n\n\n-----\n\nImage: Searching for IOPCBrowse byte sequence with CapLoader\n\nImage: CapLoader with 169 extracted flows matching IOPCBrowse UUID\n\nApparently 169 flows contain one or several packets that match the IOPCBrowse UUID.\nLet's do a “Flow Transcript” and see if any OPC tags have been sent back to the Havex\nOPC scanner\n\n\n-----\n\nImage: CapLoader Transcript of OPC-DA session\n\nOh yes, the Havex OPC scanner sure received OPC tags from what appears to be a\nWaterfall unidirectional OPC gateway.\n\nAnother way to find scanned OPC tags is to search for a unique tag name, like “Bucket\nBrigade” in this example.\n\n\nShare |\n\n\nShort URL: http://netresec.com/?b=14BE342\n\n\nPosted by Erik Hjelmvik on Wednesday, 12 November 2014 21:09:00 (UTC/GMT)\n\n© 2010-2013 NETRESEC AB | [Contact Us](http://www.netresec.com/?page=AboutNetresec) | [Privacy](http://www.netresec.com/?page=Privacy) | [RSS](http://www.netresec.com/rss.ashx)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/ICS SCADA/Havex/Observing the Havex RAT.pdf"
    ],
    "report_names": [
        "Observing the Havex RAT.pdf"
    ],
    "threat_actors": [
        {
            "id": "5cbf6c32-482d-4cd2-9d11-0d9311acdc28",
            "created_at": "2023-01-06T13:46:38.39927Z",
            "updated_at": "2025-03-27T02:00:02.823829Z",
            "deleted_at": null,
            "main_name": "ENERGETIC BEAR",
            "aliases": [
                "DYMALLOY",
                "TG-4192",
                "Crouching Yeti",
                "Group 24",
                "Havex",
                "IRON LIBERTY",
                "Blue Kraken",
                "ALLANITE",
                "Koala Team",
                "G0035",
                "ATK6",
                "ITG15",
                "Ghost Blizzard",
                "BERSERK BEAR"
            ],
            "source_name": "MISPGALAXY:ENERGETIC BEAR",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535903,
    "ts_updated_at": 1743041378,
    "ts_creation_date": 0,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/cd785f5020e4e61589f2fd7175a3ecf325d456ec.pdf",
        "text": "https://archive.orkl.eu/cd785f5020e4e61589f2fd7175a3ecf325d456ec.txt",
        "img": "https://archive.orkl.eu/cd785f5020e4e61589f2fd7175a3ecf325d456ec.jpg"
    }
}