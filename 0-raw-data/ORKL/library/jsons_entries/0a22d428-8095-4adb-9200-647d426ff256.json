{
    "id": "0a22d428-8095-4adb-9200-647d426ff256",
    "created_at": "2023-01-12T15:03:47.964143Z",
    "updated_at": "2025-03-27T02:06:00.722466Z",
    "deleted_at": null,
    "sha1_hash": "bf9e543acf938349a52f90ac40c719623039b926",
    "title": "2021-06-16 - Emotet campaign analysis",
    "authors": "",
    "file_creation_date": "2022-05-27T22:56:57Z",
    "file_modification_date": "2022-05-27T22:56:57Z",
    "file_size": 2693677,
    "plain_text": "# Análisis campaña Emotet\n\n**securityartwork.es/2021/06/16/analisis-campana-emotet/**\n\nCSIRT-CV June 16, 2021\n\nEl post de hoy viene de la mano del CSIRT-CV, el Centro de Seguridad TIC de la\n**Comunitat Valenciana. Nacido en junio del año 2007, como una apuesta de la Generalitat**\nValenciana por la seguridad en la red, fue una iniciativa pionera al ser el primer centro de\nestas características que se creó en España para un ámbito autonómico.\n\nA pesar de tratarse de un malware que se comenzó a identificar en 2014, Emotet todavía\nsigue siendo una de las amenazas más activas hasta la fecha, evolucionado desde las\nversiones iniciales, en las que se centraba en el robo de credenciales bancarias, hasta la\nactualidad, dónde se ha ampliado el arsenal de técnicas entre las que se encuentran sniffing\nde tráfico de red, explotación de vulnerabilidades para conseguir movimiento lateral, etc.\n\n[Indicar que EMOTET fue interrumpido la última semana de Enero de 2021 mediante una](https://www.europol.europa.eu/newsroom/news/world%E2%80%99s-most-dangerous-malware-emotet-disrupted-through-global-action)\nacción global entre autoridades de los Países Bajos, Alemania, Estados Unidos, Reino Unido,\nFrancia, Lituania, Canadá y Ucrania, con una actividad internacional coordinada por Europol y\nEurojust. Esta acción permitió que los investigadores tomaran el control de su infraestructura.\n\nDurante estos 6 años hemos visto cómo nuevas campañas de Emotet aparecían durante\nunas semanas, y una vez las muestras y los ficheros maliciosos utilizados ya eran\nbloqueados por las principales casas de Antivirus se detenían unos días hasta las siguiente\noleada.\n\nEn [CSIRT-CV hemos recibido varias de estas campañas, las cuales hemos tratado de](https://www.csirtcv.gva.es/)\nanalizar y remediar en nuestros sistemas. Vamos a detallar algunos aspectos importantes de\neste malware, que aunque desactivado, puede enseñarnos muchas cosas de las amenazas\nque vengan en el futuro.\n\nLa principal forma de distribución de Emotet es mediante correos electrónicos con\n**adjuntos maliciosos de tipo ofimático (excel, documentos word, etc). Durante el mes de**\nseptiembre se detectó la misma muestra en varios buzones de Generalitat, con el siguiente\nfichero word adjunto:\n\n\n-----\n\nMensaje de Word para habilitar contenido\nEl fichero adjunto con nombre “archivo_2020.doc” contenía unas macros instaladas que se\nintentaban ejecutar una vez abierto el documento:\n\nMacros ofuscadas del documento\nComo vemos, el script está ofuscado, de forma que complica en gran medida analizar qué\nacciones realiza a simple vista. Sin embargo, podemos habilitar la ejecución de macros en\nWord y analizar qué operaciones lleva a cabo en el equipo que infecta.\n\nSi analizamos los procesos que se ejecutan una vez se permiten ejecutar las macros del\ndocumento, se observa que se hace uso de WMI para ejecutar un script en Powershell\ncodificado en base64 con el parámetro -e:\n\n\n-----\n\nCaptura de process monitor\nAunque este script está también ofuscado, el nivel de ofuscación es mucho más reducido,\npudiendo obtener el código inicial manualmente sin mucho esfuerzo:\n\nPowershell ejecutado decodificado\nVemos cómo se intenta descargar varios ficheros ejecutables de las URL de la línea 19, y\ntratará de ejecutar los ficheros con tamaño mayor de 32254 bytes.\n\nEn el momento del análisis sólo 4 de las 7 URL respondían con un binario ejecutable:\n\n**md5** **Nombre del ejecutable**\n\n6ec0a030d55de2fe1b75126f0f65e5c0 8i449cW.exe\n\nadcf7a7aa104d608331ce2f72c733b47 iNZFe.exe\n\nd02dd7873d4bbe7465e747b17bb3505c nvU.exe\n\n806ba160ea7d2126123cbfd5bfabdbb7 u47D2mVFE5.exe\n\n\n-----\n\nA pesar de tener diferentes hashes, el tamaño, secciones y imports son iguales, lo que hace\npensar que se trata de un único binario, con modificaciones mínimas para evitar ser\nbloqueado rápidamente una vez se detecta la primera muestra.\n\nPor esta razón, vamos a analizar sólo uno de ellos, ya que la lógica es la misma para todos\nellos.\n\nFichero malicioso creado en el sistema\n\nDirectorio de la persistencia\nDe lo primero que nos damos cuenta al ejecutar el binario es que se borra de la carpeta\ntemporal en la que se descarga desde el Powershell, se almacena en %APPDATA% en una\ncarpeta con un nombre aleatorio, y el ejecutable es renombrado con otro nombre generado\naleatoriamente (pero legible, no es random).\n\nTambién se observa que después de unos segundos de ejecución se comienzan a realizar\npeticiones POST contra diferentes direcciones IP con contenido cifrado.\n\n\n-----\n\nPeticiones del programa malicioso\nEn este punto nos interesa conocer qué información va en el contenido cifrado de las\npeticiones POST y cuál es el listado de direcciones a las que el programa se conecta.\n\nSi hacemos un análisis estático no encontraremos API importadas de red con las que realizar\nlas peticiones que hemos capturado. Podemos ejecutar el programa analizando las llamadas\na API que realiza, para obtener algo más de información.\n\nCaptura de llamadas al sistema\n\nCaptura de llamadas al sistema\nUnas de las primeras llamadas que vemos que se realizan a las API de Windows es\n**_VirtualAllocEx (la cual no aparece en el listado de imports del ejecutable). Esta es utilizada_**\npor malware principalmente para reservar memoria y cargar en esta sección módulos que en\nun principio estaban cifrados en el ejecutable, que se han descifrado y se intentan cargar\npara su ejecución.\n\nEn la siguiente imagen vemos llamadas a funciones cómo InternetConnectW o\n**_HttpOpenRequestW desde un offset (0x1d2299 y 0x1d2204) diferente al del programa inicial_**\n(0x42xxxx). Esta sección ha sido cargada posiblemente usando la función VirtualAllocEx\nmencionada, y se ha marcado esa sección de memoria cómo ejecutable (RX), como vemos\nen la siguiente imagen:\n\n\n-----\n\nEspacios\n\nde memoria en el proceso malicioso\nEsto significa que en esa dirección se ha cargado nuevo código ejecutable y se ha pasado el\nhilo de ejecución a esa parte de memoria. Al extraer esa sección comprobamos que se trata\nde un ejecutable cargado durante la ejecución del programa principal, aunque con\nmodificaciones en las cabeceras del PE para complicar el análisis del programa.\n\nSección de código ejecutable\nMientras el programa ejecuta la nueva sección cargada en memoria, se comienzan a realizar\npeticiones POST repetitivas con contenido cifrado hacia varios servidores. Puede ser\ninteresante analizar el programa para investigar qué información está extrayendo del equipo\n\n\n-----\n\npara enviar al servidor de control y comando (C&C desde este punto).\n\nJusto después del VirtualAllocEx, la primera llamada a API que se realiza es a\n**_CreateToolHelp32Snapshot, lo que puede significar que se obtiene alguna información de_**\nlos procesos que se están ejecutando en el equipo.\n\nDetenemos la ejecución del programa en la llamada a CreateToolHelp32Snapshot para ver\ncómo se extrae la información de los procesos:\n\nExtracción de listado de procesos en x32dbg\nEn la captura vemos cómo se hacen llamadas a funciones para recorrer los procesos que\nestán en el equipo, uno a uno. Mientras se recorren estos procesos, el programa almacena\nsus nombres y a continuación comienza a realizar llamadas a la DLL rsaenh.dll, un módulo\nde windows que ofrece servicios criptográficos.\n\nSi analizamos las llamadas a esta DLL vemos que se utiliza para cifrar la información que se\nenvía en la petición POST. Entre la información que se cifra se encuentra el listado de\nprocesos del equipo, nombre del equipo, etc.\n\n\n-----\n\nLlamada a rutina de cifrado\nEsta funcionalidad ya se ha visto en anteriores versiones de Emotet, donde la lógica de la\naplicación responsable de detectar si se encuentra en un entorno controlado o en un equipo\n“real” se realiza en un servidor remoto, de forma que se dificulta el trabajo del analista al no\npoder ejecutar el programa completo o conseguir los siguientes módulos de la amenaza.\n\nLlegados a este punto de la ejecución, nos quedaría obtener el listado de servidores C&C con\nlos que el programa intentará contactar. Esta información la podemos extraer de la sección\ncargada dinámicamente en un formato que Emotet lleva utilizando en varias campañas:\n\nEspacio de memoria con direcciones de Command and Control\n\n## Indicadores de compromiso\n\n**Fichero malicioso original:**\n\ne4f06c03f11cef25f506ea965337dc80af40d1ef95e8a4ab960d0e2810465ff5 archivo_2020.doc\n\n\n-----\n\n**Ficheros dropeados maliciosos:**\n\n6ec0a030d55de2fe1b75126f0f65e5c0 8i449cW.exe\n\nadcf7a7aa104d608331ce2f72c733b47 iNZFe.exe\n\nd02dd7873d4bbe7465e747b17bb3505c nvU.exe\n\n806ba160ea7d2126123cbfd5bfabdbb7 u47D2mVFE5.exe\n\n**Direcciones IP contactadas:**\n\n50.121.220.50:80 114.109.179.60:80 45.161.242.102:80 50.28.51.143:8080\n\n51.75.33.122:80 58.171.153.81:80 77.238.212.227:80 24.135.1.177:80\n\n54.37.42.48:8080 174.100.27.229:80 177.72.13.80:80 177.73.0.98:443\n\n91.121.54.71:8080 104.131.103.37:8080 65.36.62.20:80 188.2.217.94:80\n\n45.16.226.117:443 68.183.190.199:8080 190.2.31.172:80 170.81.48.2:80\n\n68.69.155.181:80 181.30.61.163:443 212.71.237.140:8080 186.103.141.250:443\n\n213.60.96.117:80 184.66.18.83:80 64.201.88.132:80 188.135.15.49:80\n\n77.55.211.77:8080 87.106.46.107:8080 91.219.169.180:80 185.94.252.27:443\n\n152.169.22.67:80 82.76.111.249:443 212.174.55.22:443 72.47.248.48:7080\n\n110.142.219.51:80 192.241.146.84:8080 95.9.180.128:80 177.74.228.34:80\n\n2.47.112.152:80 73.213.208.163:80 72.135.200.124:80 216.10.40.16:80\n\n206.15.68.237:443 104.131.41.185:8080 178.250.54.208:8080 103.106.236.83:8080\n\n217.13.106.14:8080 181.129.96.162:8080 187.162.248.237:80 217.199.160.224:7080\n\n191.99.160.58:80 82.196.15.205:8080 178.79.163.131:8080 190.190.148.27:8080\n\n189.131.57.131:80 186.70.127.199:8090 77.90.136.129:8080 12.162.84.2:8080\n\n213.197.182.158:8080 68.183.170.114:8080 70.32.84.74:8080 85.109.159.61:443\n\n94.176.234.118:443 111.67.12.221:8080 98.13.75.196:80 85.105.140.135:443\n\n61.92.159.208:8080 172.104.169.32:8080 190.6.193.152:8080 204.225.249.100:7080\n\n190.128.173.10:80 219.92.13.25:80 192.241.143.52:8080 67.247.242.247:80\n\n219.92.8.17:8080 45.33.77.42:8080 83.169.21.32:7080 191.182.6.118:80\n\n\n-----\n\n190.115.18.139:8080 185.94.252.12:80 138.97.60.141:7080 189.2.177.210:443\n\n190.147.137.153:443 46.28.111.142:7080 137.74.106.111:7080 178.148.55.236:8080\n\n5.196.35.138:7080 51.255.165.160:8080 209.236.123.42:8080 72.167.223.217:8080\n\n190.163.31.26:80 45.173.88.33:80 199.203.62.165:80 71.197.211.156:80\n\n70.32.115.157:8080 190.24.243.186:80 51.159.23.217:443 190.195.129.227:8090\n\n\n-----",
    "language": "ES",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-16 - Emotet campaign analysis.pdf"
    ],
    "report_names": [
        "2021-06-16 - Emotet campaign analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "b43e5ea9-d8c8-4efa-b5bf-f1efb37174ba",
            "created_at": "2022-10-25T16:07:24.36191Z",
            "updated_at": "2025-03-27T02:02:10.1909Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "Dark Halo",
                "Nobelium",
                "SolarStorm",
                "StellarParticle",
                "UNC2452"
            ],
            "source_name": "ETDA:UNC2452",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "70872c3a-e788-4b55-a7d6-b2df52001ad0",
            "created_at": "2023-01-06T13:46:39.18401Z",
            "updated_at": "2025-03-27T02:00:03.01553Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "DarkHalo",
                "StellarParticle",
                "NOBELIUM",
                "Solar Phoenix",
                "Midnight Blizzard"
            ],
            "source_name": "MISPGALAXY:UNC2452",
            "tools": [
                "SNOWYAMBER",
                "HALFRIG",
                "QUARTERRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1d3f9dec-b033-48a5-8b1e-f67a29429e89",
            "created_at": "2022-10-25T15:50:23.739197Z",
            "updated_at": "2025-03-27T02:00:55.536417Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "UNC2452",
                "NOBELIUM",
                "StellarParticle",
                "Dark Halo"
            ],
            "source_name": "MITRE:UNC2452",
            "tools": [
                "Sibot",
                "Mimikatz",
                "Cobalt Strike",
                "AdFind",
                "GoldMax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535827,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1653692217,
    "ts_modification_date": 1653692217,
    "files": {
        "pdf": "https://archive.orkl.eu/bf9e543acf938349a52f90ac40c719623039b926.pdf",
        "text": "https://archive.orkl.eu/bf9e543acf938349a52f90ac40c719623039b926.txt",
        "img": "https://archive.orkl.eu/bf9e543acf938349a52f90ac40c719623039b926.jpg"
    }
}