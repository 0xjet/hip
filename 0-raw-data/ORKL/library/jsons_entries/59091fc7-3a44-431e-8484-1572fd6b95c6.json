{
    "id": "59091fc7-3a44-431e-8484-1572fd6b95c6",
    "created_at": "2022-10-25T16:48:13.51675Z",
    "updated_at": "2025-03-27T02:16:58.179165Z",
    "deleted_at": null,
    "sha1_hash": "d0506df85bd5faf87a4a67e6affcde4ce9dda48f",
    "title": "CARBANAK Week Part One: A Rare Occurrence",
    "authors": "FireEye",
    "file_creation_date": "2019-09-18T02:58:30Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 2023541,
    "plain_text": "# CARBANAK Week Part One: A Rare Occurrence\n\n**[fireeye.com/blog/threat-research/2019/04/carbanak-week-part-one-a-rare-occurrence.html](https://www.fireeye.com/blog/threat-research/2019/04/carbanak-week-part-one-a-rare-occurrence.html)**\n\nIt is very unusual for FLARE to analyze a prolifically-used, privately-developed backdoor only\nto later have the source code and operator tools fall into our laps. Yet this is the\nextraordinary circumstance that sets the stage for CARBANAK Week, a four-part blog series\nthat commences with this post.\n\nCARBANAK is one of the most full-featured backdoors around. It was used to perpetrate\n[millions of dollars in financial crimes, largely by the group we track as FIN7. In 2017, Tom](https://feye.io/fin7)\n[Bennett and Barry Vengerik published Behind the CARBANAK Backdoor, which was the](https://www.fireeye.com/blog/threat-research/2017/06/behind-the-carbanak-backdoor.html)\nproduct of a deep and broad analysis of CARBANAK samples and FIN7 activity across\nseveral years. On the heels of that publication, our colleague Nick Carr uncovered a pair of\nRAR archives containing CARBANAK source code, builders, and other tools (both available in\n[VirusTotal: kb3r1p and apwmie).](https://www.virustotal.com/#/file/783b2eefdb90eb78cfda475073422ee86476aca65d67ff2c9cf6a6f9067ba5fa/detection)\n\nFLARE malware analysis requests are typically limited to a few dozen files at most. But the\nCARBANAK source code was 20MB comprising 755 files, with 39 binaries and 100,000 lines\nof code. Our goal was to find threat intelligence we missed in our previous analyses. How\ndoes an analyst respond to a request with such breadth and open-ended scope? And what\ndid we find?\n\nMy friend Tom Bennett and I spoke about this briefly in our 2018 FireEye Cyber Defense\n[Summit talk, Hello, Carbanak! In this blog series, we will expound at length and share a](https://www.fireeye.com/content/fireeye-summit/en_US/learn/tracks.html#technical-4)\nwritten retrospective on the inferences drawn in our previous public analysis based on\nbinary code reverse engineering. In this first part, I’ll discuss Russian language concerns,\ntranslated graphical user interfaces of CARBANAK tools, and anti-analysis tactics as seen\n\n\n-----\n\nfrom a source code perspective. We will also explain an interesting twist where analyzing the\nsource code surprisingly proved to be just as difficult as analyzing the binary, if not more.\nThere’s a lot here; buckle up!\n\n## File Encoding and Language Considerations\n\nThe objective of this analysis was to discover threat intelligence gaps and better protect our\ncustomers. To begin, I wanted to assemble a cross-reference of source code files and\nconcepts of specific interest.\n\nReading the source code entailed two steps: displaying the files in the correct encoding, and\nlearning enough Russian to be dangerous. Figure 1 shows CARBANAK source code in a text\neditor that is unaware of the correct encoding.\n\nFigure 1: File without proper decoding\n\nTwo good file encoding guesses are UTF-8 and code page 1251 (Cyrillic). The files were\nmostly code page 1251 as shown in Figure 2.\n\n\n-----\n\nFigure 2: Code Page 1251 (Cyrillic) source code\n\nFigure 2 is a C++ header file defining error values involved in backdoor command execution.\nMost identifiers were in English, but some were not particularly descriptive. Ergo, the second\nand more difficult step was learning some Russian to benefit from the context offered by\nthe source code comments.\n\nFLARE has fluent Russian speakers, but I took it upon myself to minimize my use of other\nanalysts’ time. To this end, I wrote a script to tear through files and create a prioritized\n[vocabulary list. The script, which is available in the FireEye vocab_scraper GitHub repository,](https://github.com/fireeye/vocab_scraper)\nwalks source directories finding all character sequences outside the printable lower ASCII\nrange: decimal values 32 (the space character) through 126 (the tilde character “~”) inclusive.\nThe script adds each word to a Python defaultdict_ and increments its count. Finally, the\nscript orders this dictionary by frequency of occurrence and dumps it to a file.\n\nThe result was a 3,400+ word vocabulary list, partially shown in Figure 3.\n\n\n-----\n\nFigure 3: Top 19 Cyrillic character\nsequences from the CARBANAK source\ncode\n\nI spent several hours on Russian\nlanguage learning websites to study the\npronunciation of Cyrillic characters and\nRussian words. Then, I looked up the\ntop 600+ words and created a small\ndictionary. I added Russian language\ninput to an analysis VM and used\nMicrosoft’s on-screen keyboard\n(osk.exe) to navigate the Cyrillic\nkeyboard layout and look up definitions.\n\nOne helpful effect of learning to\npronounce Cyrillic characters was my\nnewfound recognition of English loan\nwords (words that are borrowed from\nEnglish and transliterated to Cyrillic). My\nsmall vocabulary allowed me to read\nmany comments without looking\nanything up. Table 1 shows a short\nsampling of some of the English loan\nwords I encountered.\n\n|Cyrillic|English Phonetic|English|Occurrences|Rank|\n|---|---|---|---|---|\n|Файл|f ah y L|file|224|5|\n|сервер|s e r v e r|server|145|13|\n|адрес|a d r e s|address|52|134|\n|команд|k o m a n d|command|110+|27|\n|бота|b o t a|bot|130|32|\n\n\n-----\n\nплагин p l ah g ee n plugin 116 39\n\nсервис s e r v ee s service 70 46\n\nпроцесс p r o ts e s s process 130ish 63\n\nTable 1: Sampling of English loan words in the CARBANAK source code\n\nAside from source code comments, understanding how to read and type in Cyrillic came in\nhandy for translating the CARBANAK graphical user interfaces I found in the source code\ndump. Figure 4 shows a Command and Control (C2) user interface for CARBANAK that I\ntranslated.\n\nFigure 4: Translated C2 graphical user interface\n\nThese user interfaces included video management and playback applications as shown in\nFigure 5 and Figure 6 respectively. Tom will share some interesting work he did with these in\na subsequent part of this blog series.\n\n|сервис|s e r v ee s|service|70|46|\n|---|---|---|---|---|\n|процесс|p r o ts e s s|process|130ish|63|\n\n\n-----\n\nFigure 5: Translated video management application user interface\n\nFigure 6: Translated video playback application user interface\n\n\n-----\n\nFigure 7 shows the backdoor builder that was contained within the RAR archive of operator\ntools.\n\nFigure 7: Translated backdoor builder application user interface\n\nThe operator RAR archive also contained an operator’s manual explaining the semantics of\nall the backdoor commands. Figure 8 shows the first few commands in this manual, both in\nRussian and English (translated).\n\n\n-----\n\nFigure 8: Operator manual (left: original Russian; right: translated to English)\n\n## Down the Rabbit Hole: When Having Source Code Does Not Help\n\nIn simpler backdoors, a single function evaluates the command ID received from the C2\nserver and dispatches control to the correct function to carry out the command. For\nexample, a backdoor might ask its C2 server for a command and receive a response bearing\nthe command ID 0x67. The dispatch function in the backdoor will check the command ID\nagainst several different values, including 0x67, which as an example might call a function to\nshovel a reverse shell to the C2 server. Figure 9 shows a control flow graph of such a\nfunction as viewed in IDA Pro. Each block of code checks against a command ID and either\npasses control to the appropriate command handling code, or moves on to check for the\nnext command ID.\n\n\n-----\n\nFigure 9: A control flow graph of a simple command handling function\n\nIn this regard, CARBANAK is an entirely different beast. It utilizes a Windows mechanism\n[called named pipes as a means of communication and coordination across all the threads,](https://docs.microsoft.com/en-us/windows/desktop/ipc/named-pipes)\nprocesses, and plugins under the backdoor’s control. When the CARBANAK tasking\ncomponent receives a command, it forwards the command over a named pipe where it\ntravels through several different functions that process the message, possibly writing it to\none or more additional named pipes, until it arrives at its destination where the specified\ncommand is finally handled. Command handlers may even specify their own named pipe to\nrequest more data from the C2 server. When the C2 server returns the data, CARBANAK\nwrites the result to this auxiliary named pipe and a callback function is triggered to handle\nthe response data asynchronously. CARBANAK’s named pipe-based tasking component is\nflexible enough to control both inherent command handlers and plugins. It also allows for\n\n\n-----\n\nthe possibility of a local client to dispatch commands to CARBANAK without the use of a\nnetwork. In fact, not only did we write such a client to aid in analysis and testing, but such a\nclient, named botcmd.exe, was also present in the source dump.\n\n## Tom’s Perspective\n\nAnalyzing this command-handling mechanism within CARBANAK from a binary perspective\nwas certainly challenging. It required maintaining tabs for many different views into the\ndisassembly, and a sort of textual map of command ids and named pipe names to describe\nthe journey of an inbound command through the various pipes and functions before\narriving at its destination. Figure 10 shows the control flow graphs for seven of the named\npipe message handling functions. While it was difficult to analyze this from a binary reverse\nengineering perspective, having compiled code combined with the features that a good\ndisassembler such as IDA Pro provides made it less harrowing than Mike’s experience. The\nbinary perspective saved me from having to search across several source files and deal with\nambiguous function names. The disassembler features allowed me to easily follow crossreferences for functions and global variables and to open multiple, related views into the\ncode.\n\nFigure 10: Control flow graphs for the named pipe message handling functions\n\n## Mike’s Perspective\n\nHaving source code sounds like cheat-mode for malware analysis. Indeed, source code\ncontains much information that is lost through the compilation and linking process. Even so,\nCARBANAK’s tasking component (for handling commands sent by the C2 server) serves as a\ncounter-example. Depending on the C2 protocol used and the command being processed,\ncontrol flow may take divergent paths through different functions only to converge again\n\n\n-----\n\nlater and accomplish the same command. Analysis required bouncing around between\nalmost 20 functions in 5 files, often backtracking to recover information about function\npointers and parameters that were passed in from as many as 18 layers back. Analysis also\nentailed resolving matters of C++ class inheritance, scope ambiguity, overloaded functions,\nand control flow termination upon named pipe usage. The overall effect was that this was\ndifficult to analyze, even in source code.\n\nI only embarked on this top-to-bottom journey once, to search for any surprises. The effort\ngave me an appreciation for the baroque machinery the authors constructed either for the\nsake of obfuscation or flexibility. I felt like this was done at least in part to obscure\nrelationships and hinder timely analysis.\n\n## Anti-Analysis Mechanisms in Source Code\n\nCARBANAK’s executable code is filled with logic that pushes hexadecimal numbers to the\nsame function, followed by an indirect call against the returned value. This is easily\nrecognizable as obfuscated function import resolution, wherein CARBANAK uses a simple\nstring hash known as PJW (named after its author, P.J. Weinberger) to locate Windows API\nfunctions without disclosing their names. A Python implementation of the PJW hash is\nshown in Figure 11 for reference.\n\ndef pjw_hash(s):\nctr = 0\nfor i in range(len(s)):\nctr = 0xffffffff & ((ctr << 4) + ord(s[i]))\nif ctr & 0xf0000000:\nctr = (((ctr & 0xf0000000) >> 24) ^ ctr) & 0x0fffffff\n\nreturn ctr\n\nFigure 11: PJW hash\n\nThis is used several hundred times in CARBANAK samples and impedes understanding of\n[the malware’s functionality. Fortunately, reversers can use the flare-ida scripts to annotate](https://www.fireeye.com/blog/threat-research/2012/11/precalculated-string-hashes-reverse-engineering-shellcode.html)\nthe obfuscated imports, as shown in Figure 12.\n\n\n-----\n\nFigure 12: Obfuscated import resolution annotated with FLARE's shellcode hash search\n\nThe CARBANAK authors achieved this obfuscated import resolution throughout their\nbackdoor with relative ease using C preprocessor macros and a pre-compilation source\ncode scanning step to calculate function hashes. Figure 13 shows the definition of the\nrelevant API macro and associated machinery.\n\n\n-----\n\nFigure 13: API macro for import resolution\n\nThe API macro allows the author to type API(SHLWAPI, PathFindFileNameA)(…) and have it\nreplaced with GetApiAddrFunc(SHLWAPI, hashPathFindFileNameA)(…). SHLWAPI is a\nsymbolic macro defined to be the constant 3, and hashPathFindFileNameA is the string\nhash value 0xE3685D1 as observed in the disassembly. But how was the hash defined?\n\nThe CARBANAK source code has a utility (unimaginatively named tool) that scans source\ncode for invocations of the API macro to build a header file defining string hashes for all the\nWindows API function names encountered in the entire codebase. Figure 14 shows the\nsource code for this utility along with its output file, api_funcs_hash.h.\n\nFigure 14: Source code and output from string hash utility\n\nWhen I reverse engineer obfuscated malware, I can’t help but try to theorize about how\nauthors implement their obfuscations. The CARBANAK source code gives another data point\ninto how malware authors wield the powerful C preprocessor along with custom code\nscanning and code generation tools to obfuscate without imposing an undue burden on\ndevelopers. This might provide future perspective in terms of what to expect from malware\nauthors in the future and may help identify units of potential code reuse in future projects\nas well as rate their significance. It would be trivial to apply this to new projects, but with the\nsource code being on VirusTotal, this level of code sharing may not represent shared\nauthorship. Also, the source code is accessibly instructive in why malware would push an\ninteger as well as a hash to resolve functions: because the integer is an index into an array\nof module handles that are opened in advance and associated with these pre-defined\nintegers.\n\n\n-----\n\n## Conclusion\n\nThe CARBANAK source code is illustrative of how these malware authors addressed some of\nthe practical concerns of obfuscation. Both the tasking code and the Windows API\nresolution system represent significant investments in throwing malware analysts off the\n[scent of this backdoor. Check out Part Two of this series for a round-up of antivirus](https://www.fireeye.com/blog/threat-research/2019/04/carbanak-week-part-two-continuing-source-code-analysis.html)\nevasions, exploits, secrets, key material, authorship artifacts, and network-based indicators.\n[Part Three and Part Four are available now as well!](https://www.fireeye.com/blog/threat-research/2019/04/carbanak-week-part-three-behind-the-backdoor.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/l3dcqd6i8rnmxgi0ykd9zfmlwctcaq1g"
    ],
    "report_names": [
        "Fireeye_CARBANAK-Week-1-Rare-Occurrence(04-22-2019)"
    ],
    "threat_actors": [
        {
            "id": "c9617bb6-45c8-495e-9759-2177e61a8e91",
            "created_at": "2022-10-25T15:50:23.405039Z",
            "updated_at": "2025-03-27T02:00:55.462193Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Carbanak",
                "Anunak"
            ],
            "source_name": "MITRE:Carbanak",
            "tools": [
                "Carbanak",
                "Mimikatz",
                "PsExec",
                "netsh"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "bfded1cf-be73-44f9-a391-0751c9996f9a",
            "created_at": "2022-10-25T15:50:23.337107Z",
            "updated_at": "2025-03-27T02:00:55.445946Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "FIN7",
                "GOLD NIAGARA",
                "ITG14",
                "Carbon Spider",
                "ELBRUS",
                "Sangria Tempest"
            ],
            "source_name": "MITRE:FIN7",
            "tools": [
                "Mimikatz",
                "AdFind",
                "JSS Loader",
                "HALFBAKED",
                "REvil",
                "PowerSploit",
                "CrackMapExec",
                "Carbanak",
                "Pillowmint",
                "Cobalt Strike",
                "POWERSOURCE",
                "RDFSNIFFER",
                "SQLRat",
                "Lizar",
                "TEXTMATE",
                "BOOSTWRITE"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "bb8702c5-52ac-4359-8409-998a7cc3eeaf",
            "created_at": "2023-01-06T13:46:38.405479Z",
            "updated_at": "2025-03-27T02:00:02.82533Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "JokerStash",
                "ATK32",
                "G0046",
                "Coreid",
                "Carbanak",
                "Sangria Tempest",
                "CARBON SPIDER",
                "GOLD NIAGARA",
                "G0008",
                "ELBRUS",
                "Carbon Spider"
            ],
            "source_name": "MISPGALAXY:FIN7",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d85adfe3-e1c3-40b0-b8bb-d1bacadc4d82",
            "created_at": "2022-10-25T16:07:23.619566Z",
            "updated_at": "2025-03-27T02:02:09.890982Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "APT-C-11",
                "ATK 32",
                "Gold Niagara",
                "ITG14",
                "TAG-CR1"
            ],
            "source_name": "ETDA:FIN7",
            "tools": [
                "7Logger",
                "Agentemis",
                "Anunak",
                "Astra",
                "BIOLOAD",
                "BIRDWATCH",
                "Bateleur",
                "Boostwrite",
                "CROWVIEW",
                "Carbanak",
                "Cobalt Strike",
                "CobaltStrike",
                "DICELOADER",
                "DNSMessenger",
                "FOWLGAZE",
                "HALFBAKED",
                "JSSLoader",
                "KillACK",
                "LOADOUT",
                "Lizar",
                "Meterpreter",
                "Mimikatz",
                "POWERPLANT",
                "POWERSOURCE",
                "RDFSNIFFER",
                "SQLRAT",
                "Sekur",
                "Sekur RAT",
                "TEXTMATE",
                "Tirion",
                "VB Flash",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "ed3810b7-141a-4ed0-8a01-6a972b80458d",
            "created_at": "2022-10-25T16:07:23.443259Z",
            "updated_at": "2025-03-27T02:02:09.801771Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Anunak",
                "Carbanak",
                "Carbon Spider",
                "ELBRUS",
                "Gold Waterfall",
                "Sangria Tempest"
            ],
            "source_name": "ETDA:Carbanak",
            "tools": [
                "AVE_MARIA",
                "Agentemis",
                "AmmyyRAT",
                "Antak",
                "Anunak",
                "Ave Maria",
                "AveMariaRAT",
                "BABYMETAL",
                "BIRDDOG",
                "Backdoor Batel",
                "Batel",
                "Bateleur",
                "BlackMatter",
                "Boostwrite",
                "Cain & Abel",
                "Carbanak",
                "Cl0p",
                "Cobalt Strike",
                "CobaltStrike",
                "DNSMessenger",
                "DNSRat",
                "DNSbot",
                "DRIFTPIN",
                "DarkSide",
                "FOXGRABBER",
                "FlawedAmmyy",
                "HALFBAKED",
                "JS Flash",
                "KLRD",
                "MBR Eraser",
                "Mimikatz",
                "Nadrac",
                "Odinaff",
                "POWERPIPE",
                "POWERSOURCE",
                "PsExec",
                "SQLRAT",
                "Sekur",
                "Sekur RAT",
                "SocksBot",
                "SoftPerfect Network Scanner",
                "Spy.Agent.ORM",
                "TEXTMATE",
                "TeamViewer",
                "TiniMet",
                "TinyMet",
                "Toshliph",
                "VB Flash",
                "WARPRISM",
                "avemaria",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716493,
    "ts_updated_at": 1743041818,
    "ts_creation_date": 1568775510,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/d0506df85bd5faf87a4a67e6affcde4ce9dda48f.pdf",
        "text": "https://archive.orkl.eu/d0506df85bd5faf87a4a67e6affcde4ce9dda48f.txt",
        "img": "https://archive.orkl.eu/d0506df85bd5faf87a4a67e6affcde4ce9dda48f.jpg"
    }
}