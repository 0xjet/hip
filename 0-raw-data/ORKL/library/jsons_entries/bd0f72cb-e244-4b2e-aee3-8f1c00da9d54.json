{
    "id": "bd0f72cb-e244-4b2e-aee3-8f1c00da9d54",
    "created_at": "2022-10-25T16:48:20.391586Z",
    "updated_at": "2025-03-27T02:16:20.981801Z",
    "deleted_at": null,
    "sha1_hash": "4b06da80d998f2b02afb361cbecf02c1b9c62ce8",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-05-07T02:08:01Z",
    "file_modification_date": "2021-05-07T02:08:01Z",
    "file_size": 986654,
    "plain_text": "# Operation TunnelSnake\n\n**securelist.com/operation-tunnelsnake-and-moriya-rootkit/101831**\n\n## Formerly unknown rootkit used to secretly control networks of regional organizations\n\n\n-----\n\nWindows rootkits, especially those operating in kernel space, are pieces of malware infamous for their near absolute power in the\noperating system. Usually deployed as drivers, such implants have high privileges in the system, allowing them to intercept and\npotentially tamper with core I/O operations conducted by the underlying OS, like reading or writing to files or processing incoming and\noutgoing network packets. The capability to blend into the fabric of the operating system itself, much like security products do, is the\nquality that earns rootkits their notoriety for stealth and evasion.\n\nHaving said that, the successful deployment and execution of a rootkit component in Windows has become a difficult task over the\nyears. With Microsoft’s introduction of Driver Signature Enforcement, it has become harder (though not impossible) to load and run\nnew code in kernel space. Even then, other mechanisms such as Kernel Patch Protection (also known as PatchGuard) make it hard to\ntamper with the system, with every change in a core system structure potentially invoking the infamous Blue Screen of Death.\n\nConsequently, the number of Windows rootkits in the wild has decreased dramatically, with the bulk of those still active often being\nleveraged in high profile APT attacks. One such example came to our attention during an investigation last year, in which we uncovered\na formerly unknown Windows rootkit and its underlying cluster of activity. We observed this rootkit and other tools by the threat actor\nbehind it being used as part of a campaign we dubbed ‘TunnelSnake’, conducted against several prominent organizations in Asia and\nAfrica.\n\nIn this blog post we will focus on the following key findings that came up in our investigation:\n\nA newly discovered rootkit that we dub ‘Moriya’ is used by an unknown actor to deploy passive backdoors on public facing servers,\nfacilitating the creation of a covert C&C communication channel through which they can be silently controlled;\nThe rootkit was found on networks of regional diplomatic organizations in Asia and Africa, detected on several instances dating\nback to October 2019 and May 2020, where the infection persisted in the targeted networks for several months after each\ndeployment of the malware;\nWe observed an additional victim in South Asia, where the threat actor deployed a broad toolset for lateral movement along with\nthe rootkit, including a tool that was formerly used by APT1. Based on the detection timestamps of that toolset, we assess that the\nattacker had a foothold in the network from as early as 2018;\nA couple of other tools that have significant code overlaps with Moriya were found as well. These contain a user mode version of\nthe malware and another driver-based utility used to defeat AV software.\n\n\n-----\n\nWe provided information about this operation in our threat intelligence portal in August 2020. More details and analysis are available to\n[customers of our private APT reporting service. For more details contact: intelreports@kaspersky.com.](mailto:intelreports@kaspersky.com)\n\n## What is the Moriya rootkit and how does it work?\n\nOur investigation into the TunnelSnake campaign started from a set of alerts from our product on a detection of a unique rootkit within\nthe targeted networks. Based on string artefacts within the malware’s binaries, we named this rootkit Moriya. This tool is a passive\nbackdoor which allows attackers to inspect all incoming traffic to the infected machine, filter out packets that are marked as designated\nfor the malware and respond to them. This forms a covert channel over which attackers are able to issue shell commands and receive\nback their outputs.\n\nThe rootkit has two traits that make it particularly evasive. The packet inspection happens in kernel mode with the use of a Windows\ndriver, allowing attackers to drop the packets of interest before they are processed by the network stack, thus ensuring they are not\ndetected by security solutions. Secondly, the fact that the rootkit waits for incoming traffic rather than initiating a connection to a server\nitself, avoids the need to incorporate a C&C address in the malware’s binary or to maintain a steady C&C infrastructure. This hinders\nanalysis and makes it difficult to trace the attacker’s footprints.\n\nThe figure below illustrates the structure of the rootkit’s components. They consist of a kernel mode driver and a user mode agent that\ndeploys and controls it. In the following sections we will break down each of these components and describe how they operate to achieve\nthe goal of tapping into the target’s network communication and blending in its traffic.\n\n\n-----\n\n**Fig. 1. The architecture of the Moriya rootkit**\n\n### User mode agent analysis\n\nThe user mode component of the Moriya rootkit has two purposes. One is to deploy the kernel mode component of the malware on the\nmachine and the other is to leverage the covert communication channel created by it to read shell commands sent from the C&C server\nto the compromised machine and to respond to them. Since Moriya is a passive backdoor intended to be deployed on a server accessible\nfrom the internet, it contains no hardcoded C&C address and relies solely on the driver to provide it with packets filtered from the\nmachine’s overall incoming traffic.\n\n\n-----\n\nThe first order of business for the attacker when using Moriya is to gain persistence on the targeted computer. For this purpose, the user\nmode agent’s DLL contains an export function named Install, which is intended to create a service named ZzNetSvc with the description\n‘Network Services Manager’ and start it. In turn, the path to the user mode agent’s image is set to the registry key\nHKLM\\System\\CurrentControlSet\\Services\\ZzNetSvc\\Parameters\\ServiceDll so that it will be invoked from its ServiceMain export\neach time the service is initiated.\n\nNext, after the service is started, the agent will attempt to load the rootkit’s driver into the system. Its binary is bundled as two driver\nimages within the DLL’s resource section, corresponding to 32- and 64-bit architectures, while in reality only one of them is written to\ndisk. In the cases we analyzed, the agent DLLs were compiled for 64-bit systems, dropping a 64-bit driver to the drivers directory in the\nsystem path, under the name MoriyaStreamWatchmen.sys, hence the rootkit’s name.\n\n**Fig. 2. Code that writes the Moriya driver to disk**\n\nThe agent uses a known technique whereby the VirtualBox driver (VBoxDrv.sys) is leveraged to bypass the Driver Signature\nEnforcement mechanism in Windows and load Moriya’s unsigned driver. DSE is an integrity mechanism mandating that drivers are\nproperly signed with digital signatures in order for them to be loaded, which was introduced for all versions of Windows starting from\nVista 64-bit. The technique used to bypass it was seen in use by other threat actors like Turla, Lamberts and Equation.\n\nMoriya’s user mode agent bypasses this protection with the use of an open-source code named DSEFIX v1.0. The user agent dumps an[1]\nembedded VBoxDrv.sys image of version 1.6.2 to disk and loads it, which is then used by the aforementioned code to map Moriya’s\nunsigned driver to kernel memory space and execute it from its entry point. These actions are made possible through IOCTLs\nimplemented in VBoxDrv.sys that allow writing to kernel address space and executing code from it. Throughout this process, the bypass\ncode is used to locate and modify a flag in kernel space named g_CiOptions, which controls the mode of enforcement.\n\n\n-----\n\nAfter the unsigned driver is loaded, the agent registers a special keyword that is used as a magic value, which will be sought in the first\nbytes of every incoming packet passed on the covert channel. This allows the rootkit to filter marked packets and block them for any\napplication on the system other than the user mode agent. The registration of the value is done through a special IOCTL with the code\n0x222004 sent to the driver, where a typical magic string is pass12.\n\n**Fig. 3. Registration of the packet magic value using a designated IOCTL**\n\nExcept for its covert channel communication feature, Moriya is capable of establishing a reverse shell session using an overt channel.\nFor this purpose, it waits for a special packet that consists of a message with the structure connect <c2_address> <c2_port>. The\naddress and port are parsed and used by the agent to start a new connection to the given server, while creating a new cmd.exe process\nand redirecting its I/O to the connection’s socket. The handles for the newly created process and its main thread are destroyed to avoid\ndetection.\n\nIn any other case, the agent attempts to read the incoming TCP payload from the driver, which will be retrieved as soon as a designated\npacket with a magic number and shell command is received. An attempt is made to read the data with a plain ReadFile API function as a\nblocking operation, i.e., reading is accomplished only once the buffer in kernel mode is populated with data from a Moriya-related\npacket.\n\nUpon an incoming packet event, the agent creates a new cmd.exe process and redirects its I/O using named pipes. One pipe is used to\nread the retrieved shell command from the covert channel and the other is used to write the shell’s output (obtained from the stdout and\nstderr streams) back to it after execution. To write any data back, the agent uses the WriteFile API function with the driver’s handle.\n\n\n-----\n\nAll traffic passed on the channel is encoded with a simple encryption scheme. Every sent byte has its payload, following the magic string,\nXORed with the value 0x05 and then negated. Following the same logic, to decode the incoming traffic’s payload, every byte of it should\nbe first negated and then XORed with 0x05.\n\n**Fig. 4. Code used for packet encoding**\n\n### Kernel mode driver analysis\n\nThe Moriya rootkit’s driver component makes use of the Windows Filtering Platform (WFP) to facilitate the covert channel between the\ncompromised host and the C&C server. WFP provides a kernel space API that allows driver code to intercept packets in transit and\nintervene in their processing by the Windows TCP/IP network stack. This makes it possible to write a driver that can filter out distinct\n\n\n-----\n\npacket streams, based on developer-chosen criteria, and designate them for consumption by a specific user mode application, as is the\ncase in Moriya.\n\nThe driver fetches the distinct Moriya-related traffic using a filtering engine. This is the kernel mode mechanism used to inspect traffic\naccording to rules that can be applied on various fields across several layers of a packet (namely data link, IP and transport), making it\npossible to handle matching packets with unique handlers. Such handlers are referred to as callout functions.\n\nIn the case of Moriya, the filtering engine is configured to intercept TCP packets, sent over IPv4 from a remote address. Each packet\nwith these criteria will be inspected by a callout function that checks if its first six bytes correspond to the previously registered magic\nvalue, and if so, copies the packet contents into a special buffer that can be later read by the user mode agent. The matching packet will\nthen be blocked in order to hide its presence from the system, while any other packet is permitted to be processed as intended by the\nnetwork stack.\n\nTo allow the crafting of a response back to the server, the callout function saves a special value in a global variable that identifies the\nreceived TCP stream. This value is called a flowHandle, and is taken from the packet’s corresponding\nFWPS_INCOMING_METADATA_VALUES0 struct. When the user issues a response to the server via the driver, the latter would craft a\nnew packet using the FwpsAllocateNetBufferAndNetBufferList0 function and insert the response data and target server based on the\nsaved flowHandle to it, using the function FwpsStreamInjectAsync0.\n\n\n-----\n\n**Fig. 5. Code that creates a new packet, designates it for the flow of the corresponding incoming TCP packet and**\n**injects data written from user space into it**\n\nAs formerly mentioned, the driver registers several functions that are exposed to the user mode agent in order to interact with it:\n\n**IRP_MJ_READ: used to allow the user mode agent to read the body of a Moriya TCP packet from a special buffer to which it is**\ncopied upon receipt. The function itself waits on an event that gets signaled once such a packet is obtained, thus turning the\nReadFile function called by the user mode agent into a blocking operation that will wait until the packet is picked up by the driver.\n**IRP_MJ_WRITE: injects user-crafted data into a newly created TCP packet that is sent as a response to an incoming Moriya**\npacket from the server.\n\n\n-----\n\n**IRP_MJ_DEVICE_CONTROL: used to register the keyword to check the beginning of every incoming TCP packet in order to**\nidentify Moriya-related traffic. The passed magic is anticipated to be six characters long.\n\n**Fig. 6. Code used for registering the packet magic value from the driver side**\n\n## How were targeted servers initially infected?\n\nInspecting the systems targeted by the rootkit, we tried to understand how they got infected in the first place. As previously mentioned,\nMoriya was seen deployed mostly on public-facing servers within the victim organizations. In one case, we saw the attacker infect an\norganizational mail server with the China Chopper webshell, using it to map the victim’s\n\nnetwork and then deploy other tools in it. Moriya’s user mode agent was explicitly installed using a command line executed on the\ntargeted server this way. This command and examples of others run on the victim machine via the webshell can be seen below.\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&ipconfig -all\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&reg query\n\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&$public\\acmsetup.exe\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&query user\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&ipconfig/all\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&ping google.com\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&netstat -anp tcp\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&tasklist /v\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&whoami\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&cd $windir\\web\\\n\n\"cmd\" /c cd /d $windir\\Web\\&rundll32 MoriyaServiceX64.dll, Install\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&ipconfig/all\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&time /t\n\n...\n\n\nIn general, we assess that the group’s modus-operandi involves infiltrating organizations\n\nthrough vulnerable web servers in their networks. For example, an older variant of Moriya named IISSpy (described below) targets IIS\nweb servers. Our telemetry shows that it was likely deployed by exploiting CVE-2017-7269 to let the attackers gain an initial foothold on\na server prior to running the malware.\n\n\n-----\n\n## Post exploitation toolset\n\nDuring our investigation we found a target in South Asia that enabled us to get a glimpse into some of the other tools that we assess were\nin use by the same attacker. The toolset includes programs used to scan hosts in the local network, find new targets, perform lateral\nmovement to spread to them and exfiltrate files. While most of the tools seem custom made and tailored for the attackers’ activities, we\ncould also observe some open-source malware frequently leveraged by Chinese-speaking actors. Following is an outline of these tools\nbased on their purpose in the infection chain.\n\n\n-----\n\n**Network Discovery: custom built programs used to scan the internal network and detect vulnerable services.**\n\n\n-----\n\n**HTTP scanner: command-line tool, found under the name ‘8.tmp’, which discovers web servers through banner grabbing.**\nThis is done by issuing a malformed HTTP packet to a given address, where no headers are included and the request is\nsucceeded with multiple null bytes.\n\n**Fig. 7. Malformed packet generated by HTTP scanner**\n\nIf the server responds, the output will be displayed in the console, as shown below.\n\n\n-----\n\n**Fig. 8. Console output with a server response displayed upon discovery of a new server in the network**\n\n**DCOM Scanner: another command-line utility that attempts to connect to a remote host on TCP port 135 (RPC), and use**\nthe DCOM IOxidResolver interface to resolve addresses assigned to all network interfaces available on the remote system.\n\n**Fig. 9. Output of the DCOM scanner utility**\n\n\n-----\n\n**Lateral Movement: tools used to spread to other hosts in the targeted networks.**\n\n\n-----\n\n**BOUNCER: malware that was first described by Mandiant in their 2013 report on APT1. This tool is another passive[2]**\nbackdoor that waits for incoming connections on a specific port and provides different features, as outlined below, that can\nbe used to control a remote host and facilitate lateral movement from it.\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n\n0x01: Proxy Init Connection\n\n0x02: Proxy Send Packet\n\n0x03: Proxy Close Connection\n\n0x07: Execute Shellcode\n\n0x0A: Kill Bot\n\n0x0C: Reverse Shell CMD\n\n0x0D: Delete File\n\n0x0E: Execute local program\n\n0x0F: Enumerate Servers In Domain and save output in gw.dat\n\n0x10: Enumerate SQL Servers and save output in sql.dat\n\n0x12: Reverse Shell CreateProcess\n\n0x16: Upload File - Write Data\n\n0x17: Download File - Finish\n\n0x1E: Download File - Start\n\n0x1F: Upload File - Start\n\n0x2D: Enumerate Servers\n\n0x2E: Enumerate SQL Server\n\n\n-----\n\n18\n\n19\n\n20\n\n\n0x2F: Enumerate Servers Verbose\n\n0x30: Enumerate Users\n\n0x32: Do nothing\n\n\nThe BOUNCER sample that we observed contained a string that indicates which command-line arguments it anticipates:\n\n1 usage:%s  IP port [proxip] [port] [key]\n\nHowever, the backdoor is configured to accept only the port number on which it will listen.\nWe saw two versions of this backdoor, initiated by two different launchers. The first one is an executable file named nw.tmp\nthat decrypts an embedded payload using the RC4 algorithm and injects it into a newly spawned svchost.exe process. The\ninjected payload is similar to one described by Mandiant in 2013, which is yet another intermediate loader that decrypts and\nloads an embedded BOUNCER DLL. The last stage is started by invoking the DLL’s dump export with the arguments passed\nvia the command line.\n\nThe other version was stored with the name rasauto.dll in the system directory, impersonating the Windows Remote Access\nAuto Connection Manager library. Like the other version, it decrypts an embedded DLL using RC4, but this time uses no\nintermediate stage, instead directly calling the DLL’s dump export without arguments. The decrypted library is a slightly\nmodified BOUNCER variant that always listens on the hardcoded port 1437.\n\n\n-----\n\n**Fig. 10. Code from the second BOUNCER variant that uses the hardcoded port 1437 to listen for new**\n**packets**\n\nBased on compilation timestamps of all BOUNCER-related executables, as shown below, we assess that the attacker reused\nold samples of the malware rather than compiled new versions of it:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n\nnw.tmp – stage 0 - launcher - 08-03-2017 03:56:24\n\nnw.tmp – stage 1 - embedded loader - 26-08-2014 04:49:58\n\nnw.tmp – stage 2 - embedded BOUNCER backdoor - 28-05-2012 13:44:37\n\nrasauto.dll - stage 0 – loader 26-08-2013 09:37:08\n\nrasauto.dll - stage 1 - embedded BOUNCER backdoor - 26-08-2013 09:36:27\n\n\n-----\n\n**Custom PSExec: the attacker deployed a tool to execute commands remotely on compromised machines. Like the original**\nPSExec tool, this one consists of two components – a client named tmp and a service named pv.tmp. In order to use the tool,\nthe attacker has to execute it via a command line with the parameters specified below.\n\n1 Usage: psexec <hostname >  psserve_path exefilename ServerName[option]\\n\n\nThe service component is a tiny program that uses the CreateProcessA API to start a program specified as an argument. The\nclient component uses the Service Control Manager (SCM) API to create a service on the target machine. If the ServerName\nargument is not specified, the service will be named Server%c%c where %c is a random lower case character. The\nexefilename argument is then passed to the StartServiceA function in order to initiate the command execution.\n\n**Fig. 11. Code used to create and start the service on targeted host**\n\n\n-----\n\nIt is worth noting that the program has some limitations. Compared with the original PSExec, it is not able to copy the\nservice binary (i.e., pv.tmp, which has its path specified in the psserve_path argument) to a remote machine, but rather\nassumes it is already present on it. Besides, it cannot handle network credentials, limiting the ability to execute commands as\nother users, nor does it support pipes, which means it does not receive the output of the commands it issues.\n\n\n-----\n\n**Exfiltration: multi-platform utilities commonly used to establish connections with remote hosts and conduct file system**\noperations on them, including file upload and download.\n\n\n-----\n\n**Earthworm and Termite: well-known command-line utilities developed to facilitate intrusion into intranet networks.**\nThese programs are multiplatform and can be deployed on various architectures. Earthworm is used to create tunnels\nbetween compromised hosts and transfer data.\n\n**Fig. 12. Earthworm help message**\n\nTermite provides additional features to download and upload files\nbetween the compromised hosts, as well as a way to spawn a remote\nshell to control the targeted machine.\n\n\n-----\n\n**Fig. 13. Termite help message**\n\n\n-----\n\n**TRAN: another tool that we detected under the filename tmp that was used to transfer data between compromised hosts.**\nThe binary we saw operated as a loader that embodies a tiny web server encrypted with the RC4 algorithm within it. This\nserver is later injected into a newly created legitimate schtask.exe process and usually listens on port 49158. It is used for\nmanaging files uploaded by the attacker into an in-memory virtual file system maintained by the malware.By default the file\nsystem includes a tiny program named client.exe, which can be downloaded by any host using a standard HTTP GET request\nto the path /client.exe. This file is a command-line utility that can be used to control the virtual file system managed by the\nserver, through one of several available commands outlined below.\n\n**Fig. 14. Client.exe help message**\n\n## IISSpy: tracing Moriya back to a user-mode rootkit\n\nIISSpy is an older user-mode version of the Moriya rootkit that we were able to pinpoint in our telemetry. It is used to target IIS servers\nfor establishing a backdoor in their underlying websites. It was detected on a machine in 2018, unrelated to any of the attacks in the\ncurrent operation. This suggests the threat actor has been active since at least that year.\n\nThe malware, which comes as a DLL, achieves its goals by enumerating running IIS processes on the server (i.e., those that are executed\nfrom the image w3wp.exe), and injecting the malware’s DLL into them to alter their behavior. The executed code in the IIS processes\nwill then set inline hooks for several functions, most notably CreateFileW.\n\nThe corresponding CreateFileW hook function checks if the filename argument contains the directory ‘\\MORIYA\\’ or ‘\\moriya\\’ in its\npath, and if so, infers that the attacker has sent a specially crafted HTTP request to the web server. In this request, the Moriya path in\nthe URL is followed by an encoded command. After the command is decoded and processed, it is passed via a mailslot\n(\\\\.\\mailslot\\slot) to a separate thread, while signaling an event called Global\\CommandEvent.\n\n\n-----\n\n**Fig. 15. Code of the CreateFileW hook function that looks for the ‘MORIYA’ \\ ‘moriya’ directory in a request path**\n\nShould the currently handled file contain the Moriya path, the very same hook function will generate a special file on the web server to\nwhich command execution output will be written. This file’s path is created by finding the position of the ‘\\MORIYA\\’ or ‘\\moriya\\’\nstrings in the inspected filename argument, and replacing it with the string ‘\\IISINFO.HTM’. This will then be appended to the\ncommand data passed on the mailslot, following a ‘ > ‘ character.\n\nThe other thread waiting on the command event mentioned above is in charge of processing attacker data fetched from the mailslot. Any\nsuch command will be read and parsed to find the ‘ > ‘ character and the file path that follows it, in this case the one corresponding to\n‘IISINFO.HTML’. After executing the command via cmd.exe, the output will be written to the file in this path, allowing the attacker to\nread it by issuing a corresponding HTTP request where the URL path leads to this file on the server.\n\nOther functions that are hooked in the IIS process are CreateProcessAsUserW and CreateProcessW. These are used to detect if the\ncurrent process spawns a new server instance, which will in turn be injected with the malware’s DLL. Apart from this, IISSpy will also\ncreate a monitoring thread that will periodically look for newly created httpd.exe processes, corresponding to the Apache server. If\ndetected, the malware will be injected to them as well.\n\nAlthough it is evident from both the functionality and use of the Moriya keyword by the malware that IISSpy and the Moriya rootkit are\nrelated, further evidence in the code substantiates the connection:\n\nThe older variant is capable of creating a reverse shell transmitted through an overt channel in exactly the same way as the more\nrecent version of the malware, i.e., it identifies a connect request followed by a C&C server address and port, connects to it and\nredirects the IO of a new exe process to the underlying socket.\n\n\n-----\n\nBoth variants use the same packet encoding and decoding algorithm, whereby each clear-text byte is XORed with 0x5 and negated,\nand vice-versa.\n\n**Fig. 16. Packet decoding loop that follows the same logic as that used in Moriya**\n\nIn both cases the developers left a trail of unique debug messages, issued to the\nOutputDebugString API function. An example of such a string used in identical code in the\ntwo variants is shown below.\n\n\n-----\n\n**Fig. 17. Code used in both variants to spawn a new shell, while printing unique debug messages**\n\nBoth implants are deployed by invoking an export function named Install that creates a service that allows persistent execution,\nwith the malware’s logic residing in the ServiceMain Moreover, the Install functions are highly similar to one another.\n\n\n-----\n\n**Fig. 18. Comparison of Install export function CFGs between IISSpy and**\n**Moriya**\n\n## The ProcessKiller rootkit vs. security products\n\n\n-----\n\nAnother interesting artefact found in our telemetry that could be tied to the developers of Moriya is a malware named ProcessKiller. As\nits name suggests, it is intended to eliminate execution of processes, with the use of a kernel mode driver. Ultimately, this tool is used to\nshut down and block initiation of AV processes from kernel space, thus allowing other attack tools to run without being detected.\n\nThis malware operates through the following stages:\n\nAn attacker calls the malware’s DLL from an export named Kill, passing it a list of process names it would like to shut down and\nblock as a command-line argument.\nThe malware writes a driver that is embedded as a resource within it, impersonating a Kaspersky driver under the path\n%SYSTEM%\\drivers\\kavp.sys.\nThere is an attempt to load the driver using the Service Control Manager. However, since it is not signed and loading is prone to\nfail on Windows versions above Vista 64-bit, the malware uses the same DSEFix code to bypass Digital Signature Enforcement as\nwitnessed in Moriya’s user mode agent.\nThe malware parses the process names passed as arguments and creates a vector of ‘blacklisted processes’ out of them.\nFor each process in the list, the malware detects its PID and issues it through an IOCTL with code 0x22200C to the driver which is\nin charge of shutting it down from kernel space. The shutdown is carried out by locating the process object with the function\nPsLookupProcessByProcessId and then terminating it with ZwTerminateProcess.\nThe list of processes is then passed via another IOCTL with the code 0x222004 to the driver, which inserts each member of it to a\nlinked list in kernel space. When the driver is bootstrapped, it registers a callback for newly created processes through the\nPsSetCreateProcessNotifyRoutineEx function, which inspects the image name of the created process and compares it against those\nfound in the linked list. If a match is found, the process creation status in the PPS_CREATE_NOTIFY_INFO structure will be set\nto STATUS_UNSUCCESSFUL, signaling the user space API function that process creation failed.\nAt this point any other malware can theoretically operate without being detected.\nIf the attacker wishes to disable blacklisting, it can be done by issuing an IOCTL with the code 0x222008, which would destroy the\nlinked list of blacklisted processes.\n\nOnce again, the connection to Moriya is based on several observations:\n\nDistinct debug error messages, as the one presented below.\n\n**Fig. 19. Unique debug message that appears in ProcessKiller and Moriya**\n\n\n-----\n\nFilename of the same structure, i.e., Moriya’s agent is internally named\n‘MoriyaServiceX64.dll’, and ProcessKiller’s DLL is named ‘ProcessKillerX64.dll’\nUsage of the exact same DSEFix code to load an unsigned driver.\n\n## What do we know about the threat actor?\n\nUnfortunately, we are not able to attribute the attack to any particular known actor, but based on the TTPs used throughout the\ncampaign, we suppose it is a Chinese-speaking one. We base this on the fact that the targeted entities were attacked in the past by\nChinese-speaking actors, and are generally located in countries that are usually targeted by such an actor profile. Moreover, the tools\nleveraged by the attackers, such as China Chopper, BOUNCER, Termite and Earthworm, are an additional indicator supporting our\nhypothesis as they have previously been used in campaigns attributed to well-known Chinese-speaking groups.\n\n## Who were the targets?\n\nBased on our telemetry the attacks were highly targeted and delivered to less than 10 victims around the world. The most prominent\nvictims are two large regional diplomatic organizations in South-East Asia and Africa, while all the others were victims in South Asia.\n\n## Conclusion\n\nThe TunnelSnake campaign demonstrates the activity of a sophisticated actor that invests significant resources in designing an evasive\ntoolset and infiltrating networks of high-profile organizations. By leveraging Windows drivers, covert communications channels and\nproprietary malware, the group behind it maintains a considerable level of stealth. That said, some of its TTPs, like the usage of a\ncommodity webshell and open-source legacy code for loading unsigned drivers, may get detected and in fact were flagged by our\nproduct, giving us visibility into the group’s operation.\n\nStill, with activity dating back to at least 2018, the threat actor behind this campaign has shown that it is able to evolve and tailor its\ntoolset to target environments. This indicates the group conducting these attacks may well still be active and retooling for additional\noperations in the area of interest outlined in this publication, as well as other regions. With that in mind, we continue to track this\n\n\n-----\n\nattacker and look for signs of its reappearance in the wild. Any findings and updates will be made available to customers of our Threat\nIntelligence Portal.\n\n[For more information about operation TunnelSnake and the underlying threat actor, contact us at: intelreports@kaspersky.com.](mailto:intelreports@kaspersky.com)\nTo learn more on reverse engineering and malware analysis from Kaspersky GReAT experts, check out the website\n[http://xtraining.kaspersky.com.](http://xtraining.kaspersky.com/)\n\n## IOCs\n\n[48307C22A930A2215F7601C78240A5EE](https://opentip.kaspersky.com/48307C22A930A2215F7601C78240A5EE/?utm_source=SL&utm_medium=SL&utm_campaign=SL) Moriya Agent\n\n[A2C4EE84E3A95C8731CA795F53F900D5](https://opentip.kaspersky.com/A2C4EE84E3A95C8731CA795F53F900D5/?utm_source=SL&utm_medium=SL&utm_campaign=SL) Moriya 64-bit Driver\n\n[5F0F1B0A033587DBCD955EDB1CDC24A4](https://opentip.kaspersky.com/5F0F1B0A033587DBCD955EDB1CDC24A4/?utm_source=SL&utm_medium=SL&utm_campaign=SL) IISSpy\n\n[C1159FE3193E8B5206006B4C9AFBFE62](https://opentip.kaspersky.com/C1159FE3193E8B5206006B4C9AFBFE62/?utm_source=SL&utm_medium=SL&utm_campaign=SL) ProcessKiller\n\n[DA627AFEE096CDE0B680D39BD5081C41](https://opentip.kaspersky.com/DA627AFEE096CDE0B680D39BD5081C41/?utm_source=SL&utm_medium=SL&utm_campaign=SL) ProcessKiller Driver – 32-bit\n\n[07CF58ABD6CE92D96CFC5ABC5F6CBC9A](https://opentip.kaspersky.com/07CF58ABD6CE92D96CFC5ABC5F6CBC9A/?utm_source=SL&utm_medium=SL&utm_campaign=SL) ProcessKiller Driver – 64-bit\n\n[9A8F39EBCC580AA56D6DDAF5804EAE61](https://opentip.kaspersky.com/9A8F39EBCC580AA56D6DDAF5804EAE61/?utm_source=SL&utm_medium=SL&utm_campaign=SL) pv.tmp (Custom PSExec Server)\n\n[39C361ABB74F9A338EA42A083E6C7DF8](https://opentip.kaspersky.com/39C361ABB74F9A338EA42A083E6C7DF8/?utm_source=SL&utm_medium=SL&utm_campaign=SL) pc.tmp (Custom PsExec Client)\n\n[DE3FB65461EE8A68A3C7D490CDAC296D](https://opentip.kaspersky.com/DE3FB65461EE8A68A3C7D490CDAC296D/?utm_source=SL&utm_medium=SL&utm_campaign=SL) tran.tmp (Exfiltration tool)\n\n[EAC0E57A22936D4C777AA121F799FEE6](https://opentip.kaspersky.com/EAC0E57A22936D4C777AA121F799FEE6/?utm_source=SL&utm_medium=SL&utm_campaign=SL) client.exe (Utility embedded in tran.tmp)\n\n[D745174F5B0EB41D9F764B22A5ECD357](https://opentip.kaspersky.com/D745174F5B0EB41D9F764B22A5ECD357/?utm_source=SL&utm_medium=SL&utm_campaign=SL) rasauto.dll (Bouncer Loader)\n\n[595E43CDF0EDCAA31525D7AAD87B7BE4](https://opentip.kaspersky.com/595E43CDF0EDCAA31525D7AAD87B7BE4/?utm_source=SL&utm_medium=SL&utm_campaign=SL) 8.tmp (HTTP )Scanner\n\n[9D75B50727A8E732DB0ADE7E270A7395](https://opentip.kaspersky.com/9D75B50727A8E732DB0ADE7E270A7395/?utm_source=SL&utm_medium=SL&utm_campaign=SL) ep.tmp DCOM Scanner\n\n\n-----\n\n[3A4E1F3F7E1BAAB8B02F3A8EE20F98C9](https://opentip.kaspersky.com/3A4E1F3F7E1BAAB8B02F3A8EE20F98C9/?utm_source=SL&utm_medium=SL&utm_campaign=SL) nw.tmp Bouncer Loader\n\n[47F2D06713DAD556F535E523B777C682](https://opentip.kaspersky.com/47F2D06713DAD556F535E523B777C682/?utm_source=SL&utm_medium=SL&utm_campaign=SL) Termite\n\n[45A5D9053BC90ED657FA90DE0B775E8F](https://opentip.kaspersky.com/45A5D9053BC90ED657FA90DE0B775E8F/?utm_source=SL&utm_medium=SL&utm_campaign=SL) Earthworm\n\n[[1] Today a copy of the original code can be found here: http://www.m5home.com/bbs/thread-8043-1-1.html](http://www.m5home.com/bbs/thread-8043-1-1.html)\n\n\n\n[[2] https://www.fireeye.com/content/dam/fireeye-www/services/pdfs/mandiant-apt1-report.pdf](https://www.fireeye.com/content/dam/fireeye-www/services/pdfs/mandiant-apt1-report.pdf)\n\nOperation TunnelSnake\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.05.06.Operation_TunnelSnake/Operation%20TunnelSnake%20_%20Securelist.pdf"
    ],
    "report_names": [
        "Operation TunnelSnake _ Securelist"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "7c390b96-8206-4194-81d8-ebbabb9910ff",
            "created_at": "2023-12-03T02:00:05.147496Z",
            "updated_at": "2025-03-27T02:00:03.259538Z",
            "deleted_at": null,
            "main_name": "TunnelSnake",
            "aliases": [],
            "source_name": "MISPGALAXY:TunnelSnake",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "4b48e4b6-09b0-4f4d-a78c-6b455d122e67",
            "created_at": "2022-10-25T16:07:24.020115Z",
            "updated_at": "2025-03-27T02:02:10.08247Z",
            "deleted_at": null,
            "main_name": "Operation TunnelSnake",
            "aliases": [],
            "source_name": "ETDA:Operation TunnelSnake",
            "tools": [
                "Moriya"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "dabb6779-f72e-40ca-90b7-1810ef08654d",
            "created_at": "2022-10-25T15:50:23.463113Z",
            "updated_at": "2025-03-27T02:00:55.47619Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "APT1",
                "Comment Crew",
                "Comment Group",
                "Comment Panda"
            ],
            "source_name": "MITRE:APT1",
            "tools": [
                "Seasalt",
                "ipconfig",
                "Cachedump",
                "PsExec",
                "GLOOXMAIL",
                "Lslsass",
                "PoisonIvy",
                "WEBC2",
                "Mimikatz",
                "gsecdump",
                "Pass-The-Hash Toolkit",
                "Tasklist",
                "xCmd",
                "pwdump"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "cf7fc640-acfe-41c4-9f3d-5515d53a3ffb",
            "created_at": "2023-01-06T13:46:38.228042Z",
            "updated_at": "2025-03-27T02:00:02.775905Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "GIF89a",
                "G0006",
                "PLA Unit 61398",
                "Group 3",
                "TG-8223",
                "Comment Group",
                "ShadyRAT",
                "COMMENT PANDA",
                "Comment Crew",
                "Byzantine Candor",
                "Brown Fox"
            ],
            "source_name": "MISPGALAXY:APT1",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1620353281,
    "ts_modification_date": 1620353281,
    "files": {
        "pdf": "https://archive.orkl.eu/4b06da80d998f2b02afb361cbecf02c1b9c62ce8.pdf",
        "text": "https://archive.orkl.eu/4b06da80d998f2b02afb361cbecf02c1b9c62ce8.txt",
        "img": "https://archive.orkl.eu/4b06da80d998f2b02afb361cbecf02c1b9c62ce8.jpg"
    }
}