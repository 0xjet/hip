{
    "id": "8635a54c-6327-47e6-ad60-338b0fcaffb6",
    "created_at": "2023-01-12T14:58:59.459574Z",
    "updated_at": "2025-03-27T02:05:52.951557Z",
    "deleted_at": null,
    "sha1_hash": "1f83ef1fd8b9e52989e6fe32fdf97627818602ef",
    "title": "2021-08-20 - See REvil again-! See how hackers use the same encryption ransomware program REvil to annihilate the attack evidence",
    "authors": "",
    "file_creation_date": "2022-05-28T23:26:58Z",
    "file_modification_date": "2022-05-28T23:26:58Z",
    "file_size": 1070010,
    "plain_text": "# 又見 REvil？！看駭客如何利用 REvil 同款加密勒索程式湮滅攻擊證據\n\n**teamt5.org/tw/posts/revil-dll-sideloading-technique-used-by-other-hackers/**\n\nGlobal Support & Service\n\n8.20.2021Global Support & Service\n\nShare:\n\nTeamT5 近期於台灣某企業環境取得一加密勒索惡意程式（Ransomware），該惡意程式與日前美國託管軟體開發業者 Kaseya 遭到駭客組織\nREvil 入侵，進而產生供應鏈攻擊事件（Supply Chain Attack）密切相關。難道是近日忽然神秘消失的 REvil 又整裝上陣，再度發動攻擊？\n\nTeamT5 在這起事件中調查發現，該加密勒索惡意程式具有檔案數位簽章，可藉此躲避防毒軟體的偵測。同時也會利用早期 Windows 防毒產品\n的漏洞，執行 DLL Side-Loading，繞過安全檢查，載入惡意程式本體。執行工作前，會使用 RC4 演算法解密一組態設定檔，並於加密檔案階\n段，使用 Salsa20 和 AES 兩種演算法來加密檔案。\n\nTeamT5 深入調查，確定該企業並未採用 Kaseya 所提供之服務，且該受害環境存在多起駭客入侵攻擊事件。此外，該加密勒索程式所觸發的條\n件與 Kaseya 供應鏈攻擊事件有所區別，故 TeamT5 推測是攻擊者在入侵得手後，利用 REvil 加密勒索程式來煙滅犯罪現場證據之用。\n\n## 樣本分析\n\nsample.exe 為 TeamT5 所掌握取得之惡意程式，具備數位簽章（digital signature），簽署人名稱為 PB03 TRANSPORT LTD.。目前該憑證已被\n簽發者宣告撤銷，據信，該簽章憑證為駭客攻擊前所竊取而來。所對應 MITRE 的攻擊手法編號為 T1553.002。數位簽章資訊詳見下圖一。\n\n\n-----\n\n圖一、sample.exe 具有數位簽章（已遭宣告撤銷）\n\nsample.exe 除了具有檔案數位簽章之外，同時也是個 Dropper。在其檔案資源區塊中，具有兩個資源檔 MODLIS.RG 與 SOFTIS.RG。檔案執行\n之後，會分別在 C:\\Windows\\ 路徑下建立 mpsvc.dll 與 MsMpEng.exe，如圖二。\n\n圖二、sample.exe\n\n會從資源區塊產生 mpsvc.dll 與 MsMpEng.exe\n\n\n-----\n\ns p g e e 為 do s 早期版本（版本號為 5 0 8 0）之防毒軟體程式，其檔案時間戳記為 0 /03/ 09 3 。此 s p g e e 有\nDLL 側載（DLL Side-Loading）漏洞，駭客利用合法程式來載入惡意本體 mpsvc.dll，為典型的白加黑攻擊手法，所對應 MITRE 的攻擊手法編\n號為 T1574.002。MsMpEng.exe 的檔案資訊詳見下圖三。\n\n圖三、MsMpEng.exe 的檔案資訊與檔案簽章\n\n根據 mpsvc.dll 的導出表，會透過 Windows 防毒程式來呼叫 mpsvc.dll，並透過 `ServiceCrtMain` 函式來執行。執行後，mpsvc.dll 會建立一個\n執行緒（Thread），並透過 `CreateFileMappingW` 函式來載入二階段惡意 Shellcode。接著，使用 `VirtualAllocEx` 函式來分配記憶體的讀/\n寫/執行區域，供 Shellcode 將加密勒索核心功能載入記憶體中。\n\n圖四、mpsvc.dll 使用 `CreateFileMappingW` 和 `VirtualAllocEx` 函式載入惡意程式核心\n\n加密勒索核心透過解碼一系列已編碼的 DLL 檔案，開始驗證和解密 JSON 格式之組態設定檔（Config）。TeamT5 長期追蹤 REvil 駭客族群，\n發現他們廣泛使用 CRC32 演算法來驗證檔案的完整性，並使用 RC4 演算法來解密。在此案例中，加密勒索程式所使用的 RC4 解密金鑰為\n```\nmXT1QFyEUbrxc4cbP84jbN5wrHeqmFXt ，解密後的組態設定檔詳見以下範例：\n\n```\n\n-----\n\n```\n\"pid\":\"$2a$12$prOX/4eKl8zrpGSC5lnHPecevs5NOckOUW5r3s4JJYDnZZSghvBkq\",\n\"sub\":\"8254\",\n\"dbg\":false,\n\"et\":0,\n\"wipe\":true,\n\"wht\":{\"fld\":[\"program files\",\"appdata\",\"mozilla\",\"$windows.~ws\",\"application\ndata\",\"$windows.~bt\",\"google\",\"$recycle.bin\",\"windows.old\",\"programdata\",\"system volume information\",\"program files\n(x86)\",\"boot\",\"tor browser\",\"windows\",\"intel\",\"perflogs\",\"msocache\"],\n\"fls\":\n[\"ntldr\",\"thumbs.db\",\"bootsect.bak\",\"autorun.inf\",\"ntuser.dat.log\",\"boot.ini\",\"iconcache.db\",\"bootfont.bin\",\"ntuser.dat\",\"ntuser.ini\n\"ext\":\n[\"ps1\",\"ldf\",\"lock\",\"theme\",\"msi\",\"sys\",\"wpx\",\"cpl\",\"adv\",\"msc\",\"scr\",\"bat\",\"key\",\"ico\",\"dll\",\"hta\",\"deskthemepack\",\"nomedia\",\"msu\",\n\"wfld\":[\"backup\"],\n\"prc\":\n[\"encsvc\",\"powerpnt\",\"ocssd\",\"steam\",\"isqlplussvc\",\"outlook\",\"sql\",\"ocomm\",\"agntsvc\",\"mspub\",\"onenote\",\"winword\",\"thebat\",\"excel\",\"m\n\"dmn\":\"boisehosting.net;fotoideaymedia.es;dubnew.com;stallbyggen.se;TRIMMED\",\n\"net\":false,\n\"svc\":[\"veeam\",\"memtas\",\"sql\",\"backup\",\"vss\",\"sophos\",\"svc$\",\"mepocs\"],\n\"nbody\":\"BASE64_ENCODED_RANSOM_NOTE\",\n\"nname\":\"{EXT}-readme.txt\",\n\"exp\":false,\n\"img\":\"QQBsAGwAIABvAGYAIAB5AG8AdQByACAAZgBpAGwAZQBzACAAYQByAGUAIABlAG4AYwByAHkAcAB0AGUAZAAhAA0ACgANAAoARgBpAG4AZAAgAHsARQBYAFQAfQAtA\n\"arn\":false,\n\"rdmcnt\":0}\n\n```\n部分組態設定檔說明\n\n欄位 說明\n\npk 經過 Base64 編碼後的金鑰\n\nfld 避免加密的資料夾名稱\n\nfls 避免加密的檔案名稱\n\next 會被加密的檔案格式\n\nprc 加密前會強制關閉的程序名稱\n\ndmn 中繼站位址\n\nsvc 加密前會強制停止的服務名稱\n\n待加密勒索核心解析組態設定檔後，會搜集並儲存該受害主機的基本資訊，包含帳號、主機名稱、網域名稱、Windows 版本名稱等。同時，該\n加密勒索程式具有 `-nolan 、` `-nolocal 、` `-path 、` `-silent 、` `-smode 、` `-fast` 及 `-full` 等參數可供使用。\n\n如果使用 `-smode` 模式，會將當前帳號和密碼更改為 `DTrump4ever ，並設定登入後自動執行。但若使用` `-silent` 模式，則會從組態設定檔\n中將 `svc` 區塊中的服務停止並刪除，也將 `prc` 區塊中的程序終止，以及使用 WMI 刪除磁碟區陰影複製檔（Shadow Copy File）。\n\n\n-----\n\n圖五、smode 模式的程式分析畫面\n\n開始執行檔案加密前，加密勒索核心會檢查互斥變數（Mutex），以確保沒有其他加密勒索核心也在運行，確定加密過程可順利進行。在執行階\n段，加密勒索程式會清空電腦主機的資源回收桶，並嘗試建立本機防火牆規則 `netsh advfirewall firewall set rule group=\"Network`\n```\nDiscovery\" new enable=Yes 。\n\n```\n接著，破壞過程會使用多個演算法進行加密，例如 Salsa20 與 AES。在加密過程中，會忽略組態設定檔中 `ext` 區塊中的檔案副檔名，避免受\n害主機完全無法開機的狀況發生。\n\n\n-----\n\n圖六、加密演算法使用\n\n_Salsa20 和 AES_\n\n待惡意程式開始加密檔案時，勒索訊息也會同步建立在每個資料夾路徑下，其檔案類型為文字格式（.txt），檔名則為隨機亂數產生的小寫英文\n與數字組合，並加上 `-readme` 做為後綴（suffix）字元。其勒索訊息內容如下圖七所示。\n\n圖七、勒索訊息內容\n\n在加密檔案之後，加密勒索程式會連線至組態設定檔中的中繼站，並使用 HTTP POST 方法回傳如 REvil 版本、作業系統版本、語言及組態設定\n檔的值等資訊。回傳中繼站的 URL 會採用隨機產生的關鍵字，如 WordPress 等服務，將流量偽裝成合法請求。其 URL 格式如下：\n```\nhttps:\\/\\/<C2Domain>\\/(wpcontent|static|content|include|uploads|news|data|admin)\\/(images|pictures|image|temp|tmp|graphic|assets|pics|game)\\/([az]{2}){10}\\.(jpg|png|gif)\n\n## IoC 入侵指標\n\n```\nTeamT5 彙整此次加密勒索攻擊事件的 IoC（Indicators of Compromise）資訊，建議用戶可將此份威脅指標情資，匯入各式偵測阻擋設備中使\n用，強化威脅防護。\n\n**Type** **Value** 檔名 描述\n\nMD5 561CFFBABA71A6E8CC1CDCEDA990EAD4 sample.exe REvil Dropper\n\nMD5 A47CF00AEDF769D60D58BFE00C0B5421 mpsvc.dll REvil Loader\n\nMD5 3AD14947002E57887B82643D729C21AE n/a REvil Shellcode\n\n\n-----\n\n**Type** **Value** 檔名 描述\n\nMD5 6A044F92F8DDDAD2AE0FF213215FE576 n/a REvil Payload\n\nSHA-1 5162F14D75E96EDB914D1756349D6E11583DB0B0 sample.exe REvil Dropper\n\nSHA-1 656C4D285EA518D90C1B669B79AF475DB31E30B1 mpsvc.dll REvil Loader\n\nSHA-1 8DA8E1DB4367BFFFB8DFF6828619DC3C2A444FFE n/a REvil Shellcode\n\nSHA-1 89BA0D748EF30E7D4FACDBC74CA701B24F3ACEDB n/a REvil Payload\n\nSHA-256 D55F983C994CAA160EC63A59F6B4250FE67FB3E8C43A388AEC60A4A6978E9F1E sample.exe REvil Dropper\n\nSHA-256 8DD620D9AEB35960BB766458C8890EDE987C33D239CF730F93FE49D90AE759DD mpsvc.dll REvil Loader\n\nSHA-256 C8768D4A4979D4B5AB4E841FC29523D8D80C52D6E89F345A0A44E75973F3D3AF n/a REvil Shellcode\n\nSHA-256 F92CD77D38EC7A2E3CDB5CAC083258424F920F3104BC710E60AEE5CE4BC4B867 n/a REvil Payload\n\n[*圖片來源：Pixabay](https://pixabay.com/illustrations/ransomware-wannacry-malware-2318381/)\nShare:\n\n\n-----",
    "language": "ZH",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-20 - See REvil again-! See how hackers use the same encryption ransomware program REvil to annihilate the attack evidence.pdf"
    ],
    "report_names": [
        "2021-08-20 - See REvil again-! See how hackers use the same encryption ransomware program REvil to annihilate the attack evidence.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535539,
    "ts_updated_at": 1743041152,
    "ts_creation_date": 1653780418,
    "ts_modification_date": 1653780418,
    "files": {
        "pdf": "https://archive.orkl.eu/1f83ef1fd8b9e52989e6fe32fdf97627818602ef.pdf",
        "text": "https://archive.orkl.eu/1f83ef1fd8b9e52989e6fe32fdf97627818602ef.txt",
        "img": "https://archive.orkl.eu/1f83ef1fd8b9e52989e6fe32fdf97627818602ef.jpg"
    }
}