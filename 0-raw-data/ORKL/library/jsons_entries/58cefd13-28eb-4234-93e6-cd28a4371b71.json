{
    "id": "58cefd13-28eb-4234-93e6-cd28a4371b71",
    "created_at": "2023-01-12T15:06:18.084593Z",
    "updated_at": "2025-03-27T02:16:25.708597Z",
    "deleted_at": null,
    "sha1_hash": "82324e88fc3d491c4ff6cd64a5707d525fc6dbb1",
    "title": "2017-06-05 - HandBrake Hacked! - osx-proton (re)appears",
    "authors": "",
    "file_creation_date": "2022-05-29T01:22:14Z",
    "file_modification_date": "2022-05-29T01:22:14Z",
    "file_size": 3181898,
    "plain_text": "# Objective-See\n\n**objective-see.com/blog/blog_0x1D.html**\n\nHandBrake Hacked!\n\n› osx/proton (re)appears\n\n5/06/2017\n\n[love these blog posts? support my tools & writing on patreon! Mahalo :)](https://www.patreon.com/objective_see)\n\n[Want to play along? I've shared the malware, which can be downloaded here (password:](https://objective-see.com/downloads/malware/Proton.zip)\ninfect3d). Please don't infect yourself!\n\nBackground\n\nToday started like pretty much every other day in Hawaii, surf & beach ;)\n\n\n-----\n\n[However, around noon, Eric Holtam (@eholtam) tweeted the following:](https://twitter.com/eholtam)\n\nMahalo to [@mikeymikey to notifying me about this tweet!](https://twitter.com/mikeymikey)\n\nHandbrake is an 'open-source video transcoder.' Heading over to their website\n(handbrake.fr), we can see they've added a 'Security Alert' for Mac Users:\n\n\n-----\n\n[Following the url, links to a rather dire security alert, Mirror Download Server Compromised:](https://forum.handbrake.fr/viewtopic.php?f=33&t=36364)\n\n**SECURITY WARNING**\n\nAnyone who has downloaded HandBrake on Mac between [02/May/2017 14:30 UTC] and\n\n[06/May/2017 11:00 UTC] needs to verify the SHA1 / 256 sum of the file before running it.\n\n\n-----\n\nAnyone who has installed HandBrake for Mac needs to verify their system is not infected\nwith a Trojan. You have 50/50 chance if you've downloaded HandBrake during this period.\n\nYikes!\n\nThe security alert also provided a hash of the disk image\n(0935a43ca90c6c419a49e4f8f1d75e68cd70b274) that was trojaned by the hackers.\n\nHopping over to VirusTotal, we can see that while this .dmg was submitted for analysis, no\nanti-virus engines are currently flagging it. No surprise there :|\n\nAnalysis\n\n[Once we have a copy of the infected .dmg (I've shared it here password: infect3d), analysis](https://objective-see.com/downloads/malware/Proton.zip)\ncan commence. Since it's the weekend - I'm going to take the 'lazy' (efficient?) route and\nbasically just run the infected application and see what happens :)\n\nIn order to facilitate malware analysis I wrote a simple user-mode 'process monitor' library\nthat allows us to easy track what application is doing - in terms of spawning other processes,\netc:\n\nProcessMonitor* procMon = nil;\n\n//block\n\nProcessCallbackBlock block = ^(Process* newProcess)\n\n{\nNSLog(@\"new process: %@\", newProcess);\n\n};\n\n\n-----\n\n//start monitoring!\nprocMon = [[ProcessMonitor alloc] init];\n\n[procMon start:block];\n\n//run loop\n\n[[NSRunLoop currentRunLoop] run];\n\nRunning this code and executing the infected Handbrake application, we can see exactly\nwhat's going on:\n\n[new process]\npid=1368\nbinary=/Volumes/HandBrake/HandBrake.app/Contents/MacOS/HandBrake\nsignatureStatus = \"-67062 (unsigned)\n\n[new process]\npid=1370\nbinary=path=/bin/sh\nargs: \"-c\", \"pgrep -x activity_agent && echo Queue.hbqueue\"\n\n[new process]\npid=1371\nbinary=/usr/bin/unzip\nargs: \"-P\",\n\"qzyuzacCELFEYiJ52mhjEC7HYl4eUPAR1EEf63oQ5iTkuNIhzRk2JUKF4IXTRdiQ\",\n\"/Volumes/HandBrake/HandBrake.app/Contents/Resources/HBPlayerHUDMainController.nib\",\n\"-d\", \"/tmp\"\n\n[new process]\npid=1372\nbinary=/usr/bin/open\nargs: \"/tmp/HandBrake.app\"\n\nSo yah, when run, the infected Handbrake application:\n\n1. unzips Contents/Resources/HBPlayerHUDMainController.nib to /tmp/HandBrake.app.\n\nThis 'nib' is a password protected zip file who's password is:\nqzyuzacCELFEYiJ52mhjEC7HYl4eUPAR1EEf63oQ5iTkuNIhzRk2JUKF4IXTRdiQ\n\n2. launches (opens) /tmp/HandBrake.app\n\nOnce the /tmp/HandBrake.app is launched, it displays a (fake) authentication popup - which\n\n\n-----\n\nis how the malware attempts to elevate its privileges:\n\nIf the user is tricked into providing a user name and password the malware will install itself\n(/tmp/HandBrake.app) persistently as: 'activity_agent.app'.\n\nThankful, BlockBlock can alert us of this fact:\n\nDumping the Launch Agent plist file (fr.handbrake.activity_agent.plist), we can see the\nmalware has been set to automatically start each time the user logs in:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\"\n\"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n\n<plist version=\"1.0\">\n\n<dict>\n\n<key>KeepAlive</key>\n\n\n-----\n\n<true/>\n...\n<key>ProgramArguments</key>\n<array>\n<string>/Users/user/Library/RenderFiles/activity_agent.app/\nContents/MacOS/activity_agent</string>\n</array>\n<key>RunAtLoad</key>\n<true/>\n\n</dict>\n</plist>\n\nAccording to the HandBrake advisory, the malware's peristent component, activity_agent.app\nis a 'a new variant of OSX.PROTON'\n\nProton (variant 'A') was discussed earlier this year by the media (for example, see: \"Hackers\nSelling Undetectable Proton Malware for macOS in 40 BTC\")\n\nThough Apple released an XProtect signature for it, the sample was never publicly shared.\nHowever, the malware author was kind enough to describe ('advertise') its capabilties:\n\n\n-----\n\nWith the HandBrake hack, finally now we have a variant for analysis :). Initial triage confirms,\nyes this a variant of OSX/Proton ('B'), although some of the features found in the 'A' variant,\n(such as the ability to take screenshots) are not present.\n\nAgain, unsurprisingly this new variant of OSX/Proton is also currently undetected by any antivirus engines on VirusTotal:\n\nInterested in the technical details of OSX/Proton? I wrote it in a new blog, \"OSX/Proton.B (a\nbrief analysis, at 6 miles up)\".\n\n\n-----\n\nConclusions\nAs with KeRanger and Keydnap, hackers targeted an official distribution website of legitimate\nmacOS software. With access to HandBrake's mirror, they trojaned the legitimate application,\nmeaning any user who downloaded the application would inadvertently infect themselves!\n\nLuckily the trojaned disk image was only online for a few days. However as is often\n(always!?) the case, no anti-virus products flagged the malware :( So if you recently\ndownload HandBrake, unless you were running something like BlockBlock you'd likely have\nbeen infected.\n\nTo check if you're infected, look for the following:\n\na process named 'activity_agent'\n\nan application name 'activity_agent.app in ~/Library/RenderFiles/\n\na plist file: '~/Library/LaunchAgents/fr.handbrake.activity_agent.plist\n\nApple has now also pushed out an XProtect signature, meaning that all new infections\nshould be twarted. Hooray!\n\n$ cat /System/Library/CoreServices/XProtect.bundle/Contents/Resources/XProtect.yara\n\nprivate rule Macho\n\n{\nmeta:\n\ndescription = \"private rule to match Mach-O binaries\"\n\ncondition:\n\nuint32(0) == 0xfeedface or uint32(0) == 0xcefaedfe or uint32(0) == 0xfeedfacf\n\nor uint32(0) == 0xcffaedfe or uint32(0) == 0xcafebabe or uint32(0) == 0xbebafeca\n\n}\n\n\n-----\n\nrule XProtect_OSX_Proton_B\n{\nmeta:\ndescription = \"OSX.Proton.B\"\n\ncondition:\n**Macho and filesize < 800000 and hash.sha1(0, filesize) ==**\n**\"a8ea82ee767091098b0e275a80d25d3bc79e0cea\"**\n}\n\nOk, so kudos to Apple for the quick turn around on signatures....but the signature is:\n\njust a SHA-1 hash\nmatches on the trojaned Handbrake binary\n(HandBrake.app/Contents/MacOS/HandBrake on the .dmg)\n\n$ shasum -a 1 /Volumes/HandBrake/HandBrake.app/Contents/MacOS/HandBrake\n\na8ea82ee767091098b0e275a80d25d3bc79e0cea\n/Volumes/HandBrake/HandBrake.app/Contents/MacOS/HandBrake\n\nThis means if the malware authors used any other infection vector, or even just recompiled\nthe trojaned binary, this signature would no longer flag the malware :/ Do people still say\n'yolo'?\n\nAnd even if you don't have source code, you can just flip a single bit in the binary to thwart\nthe signature. To test this, I changed the final byte in\nHandBrake.app/Contents/MacOS/HandBrake from an 0x00 to 0xFF. While this doesn't\nimpact functionality of the binary, it changes its SHA-1 hash, meaning the malware is no\nlonger blocked by XProtect. The following, first shows XProtect 'blocking' OSX/Proton.B.\nHowever, a second modified version is allowed to run, as the signature no longer matches:\n\n\n-----\n\n© 2017 objective-see llc\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-06-05 - HandBrake Hacked! - osx-proton (re)appears.pdf"
    ],
    "report_names": [
        "2017-06-05 - HandBrake Hacked! - osx-proton (re)appears.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535978,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653787334,
    "ts_modification_date": 1653787334,
    "files": {
        "pdf": "https://archive.orkl.eu/82324e88fc3d491c4ff6cd64a5707d525fc6dbb1.pdf",
        "text": "https://archive.orkl.eu/82324e88fc3d491c4ff6cd64a5707d525fc6dbb1.txt",
        "img": "https://archive.orkl.eu/82324e88fc3d491c4ff6cd64a5707d525fc6dbb1.jpg"
    }
}