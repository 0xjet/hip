{
    "id": "5bbe83f8-fc56-4ab6-ad1c-46ba6720d404",
    "created_at": "2023-01-12T15:06:41.928692Z",
    "updated_at": "2025-03-27T02:09:29.354632Z",
    "deleted_at": null,
    "sha1_hash": "cfecb0ffb9b79118a354e36f1b4ef2fce912177d",
    "title": "2021-11-04 - Blackboxing Diebold-Nixdorf ATMs",
    "authors": "",
    "file_creation_date": "2022-05-28T04:03:17Z",
    "file_modification_date": "2022-05-28T04:03:17Z",
    "file_size": 292388,
    "plain_text": "# Blackboxing Diebold-Nixdorf ATMs\n\n**[speakerdeck.com/ptswarm/blackboxing-diebold-nixdorf-atms](https://speakerdeck.com/ptswarm/blackboxing-diebold-nixdorf-atms)**\n\n**ptswarm**\n\nNovember 04, 2021\n\n**[Research](https://speakerdeck.com/c/research)**\n\n**[0](https://speakerdeck.com/signin?return_to=%2Fptswarm%2Fblackboxing-diebold-nixdorf-atms)**\n\n**810**\n\n## Other Decks in Research\n\n[See All in Research](https://speakerdeck.com/c/research)\n\n\n-----\n\nACTBE Inc. Company Deck FY2022\n\nactbeinc\n\n0\n\n120\n\n素人発想玄人実行2.0\n\nhf149\n\n0\n\n1.2k\n\n企業の業界分類予測における共変量シフト問題の抑制\n\ntaro_masuda\n\n2\n\n\n-----\n\n660\n\n#osc22on 中国オープンソースムーブメントの盛り上がりと 中国最大のオープンソー…\n\ntakasumasakazu\n\n0\n\n160\n\nAI最新論文読み会2022年4月\n\nailaboocu\n\n0\n\n330\n\nJGS594 Lecture 18\n\n\n-----\n\njaviergs\n\n\nPRO\n\n\n0\n\n340\n\n会社訪問アプリ「Wantedly Visit」のデータで見る相互推薦システム / deim2022-rrs-w…\n\nyuya4\n\n0\n\n750\n\nビジネス電話応対における音声感情認識\n\nken57\n\n0\n\n\n-----\n\n240\n\nライティング支援のための文法誤り訂正\n\nchemical_tree\n\n1\n\n1k\n\nAIOps研究録―SREのための システム障害の自動原因診断 / SRE NEXT 2022\n\nyuukit\n\n5\n\n1.8k\n\n研究紹介2022年度版\n\n\n-----\n\nsh01k\n\n0\n\n330\n\n行政のオープンネスとフェアネスーデジタル庁でDXに取り組む 『民間採用人材』の…\n\nhalsk\n\n0\n\n520\n\n## Featured\n\n[See All Featured](https://speakerdeck.com/p/featured)\n\nClear Off the Table\n\ncherdarchuk\n\n79\n\n\n-----\n\n280k\n\nHappy Clients\n\nbrianwarren\n\n89\n\n5.6k\n\nTypedesign – Prime Four\n\nhannesfritz\n\n33\n\n1.3k\n\nOptimizing for Happiness\n\n\n-----\n\nmojombo\n\n365\n\n63k\n\nRobots, Beer and Maslow\n\nschacon\n\n152\n\n7.1k\n\nThoughts on Productivity\n\njonyablonski\n\n43\n\n2.2k\n\n\n-----\n\nInfographics Made Easy\n\nchrislema\n\n233\n\n17k\n\nWeb Components: a chance to create the future\n\nzenorocha\n\n303\n\n40k\n\nWebSockets: Embracing the real-time Web\n\nrobhawkes\n\n57\n\n\n-----\n\n5k\n\nDocumentation Writing (for coders)\n\ncarmenhchung\n\n48\n\n2.5k\n\njQuery: Nuts, Bolts and Bling\n\ndougneiner\n\n56\n\n6.4k\n\nKeith and Marios Guide to Fast Websites\n\n\n-----\n\nkeithpitt\n\n404\n\n21k\n\n## Transcript\n\n1. ptsecurity.com Blackboxing Diebold-Nixdorf ATMs Vladimir Kononovich\n\n### Senior ICS Security Specialist\n\nAlexei Stennikov Independent Researcher\n\n2. Who are we? Vladimir Kononovich: •Reverse-engineering (since 2008)\n\n### •Romhacking (my\n\nhobby) •Writing tools for IDA/Ghidra •Ghidra ideologist\n\n3. Who are we? Alexei Stennikov: •Hardware expert •ICS/SCADA security\n\n### researcher\n\n   - TM/POS security researcher •Some skills of RE\n\n4. ATM hardware internals •Less-secure upper part •Safe-zone (lower part)\n\n### Safe-zone\n\nincludes a dispenser controller\n\n[5. Our previous talk at hw.io •ATM internals •ATM attacks types](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_4.jpg)\n\n   - hat is Blackbox attack? •NCR dispensers vulnerability Our hardwear.io 2018 talk\n(youtube) https://www.youtube.com/watch?v=L5yl4A1npVU\n\n[6. Paderborn, we have a problem • FW downgrade • Modified](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_5.jpg)\n\nFW uploading • SmartCard DoS “feature” • Encryption bypass • Withdrawal\n\n\n-----\n\n7. RM3/CMDv5 firmware files •BTR (bootloader) •FRM (main firmware)\n\n### Parts: •\n\nRM3_CRS.BTR / CD5_ATM.BTR • RM3_CRS.FRM / CD5_ATM.FRM Files: • Device id\n\n  - Product id • Vendor id • ? • “UFD” • ? • CRC32 • Some size • Firmware part name The\nrest is encrypted. No chance to decrypt. Thank you for watching! Bye:)\n\n[8. But wait… eBay can help us! Again…](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_7.jpg)\n\n[9. Demo](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_8.jpg)\n\n[10. JTAG: Identifying connector & pins 1 • VREF • VSUPPLY](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_9.jpg)\n\n2 3 • nRST • GND 4 5 • TDI • GND 6 7 • TMS • GND 8 9 • TCK • GND 10 11 • RTCK •\nGND 12 13 • TDO • GND 14 15 • nRST • GND 16 17 • DBGRQ • GND 18 19 •\nDGBACK • GND 20\n\n11. Another interesting place: Smartcard •USB encryption keys generation\n\n### •Session numbers/keys\n\nstorage •Different counters •Certificates storage •A whole system DoS Other\n“features”:)\n\n[12. Powering and testing FW uploading • + USB connection •](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_11.jpg)\n\n+ Java-based software (easy to decompile and modify)\n\n13. Firmware dumping (CMDv5) •Main CPU: STM STR710FZ2T6 •Image\n\n### base: 0x60000000\n\nTwo other CPUs: •CollectorBooter: STR730FZ2T6 •DispenseBooter: STR730FZ2T6\n\n[14. Firmware analysis (CMDv5) 1. Read 5 LE-dwords after a $MOD$](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_13.jpg)\n\nname (header-dwords, HD) 2. key[n] = KEY1[n] ^ HD[n]; // where n: 0..3 3. data[0] =\nKEY0[0] ^ HD[0] ^ HD[1]; data[1] = KEY0[1] ^ HD[2] ^ HD[3]; Encryption algo – XTEA\nmod. DELTA: 0xF27716BA. Rounds: 32 - KEY0 and KEY1 are unknown yet! Init:\n\n15. Firmware analysis (CMDv5) Decryption algo XTEA (Python): Our python\n\n### implementation\n\n16. Firmware analysis (CMDv5) Decryption result: •Sequential APLib\n\n### archives (have AP32\n\nheader) •Ends with 0xFFFFFFFFs •Unpacked firmware\n\n\n-----\n\n17. Firmware analysis (CMDv5) KEY0 and KEY1: •Hardcoded! (base offset:\n\n### 0x64000000)\n\n  - bility to use OLD or ZEROed keys!\n\n18. Firmware analysis (CMDv5) Self-signing (bad practice) • 30-bit tokens\n\n### count\n\n(int length + 1) • 30-bit tokens count (int length) • sign = RSA(e=7, SHA1(data[0x360:]))\n\n  - modulus = RSA.key.N •0x160 – sign •0x260 – modulus •0x360 - data\n\n19. Firmware analysis (CMDv5) Firmware uploading (DFU) •Uses special\n\n### DFU device:\n\n  - - DFU_PID = PID | 0x8000 • - bInterfaceClass = 0xFF • - bInterfaceSubClass = 1\nNormal state DFU-mode state\n\n20. Firmware analysis (CMDv5) Firmware encryption tricks Firmware header\n\n### • Unpacked\n\nFW size • Firmware part name • 5 header-dwords • 0xDEAD0000 | (KEY0_OFFSET /\n8) Old keys checking code\n\n21. Firmware analysis (CMDv5) KEY0 and KEY1: •Hardcoded! (base offset:\n\n### 0x64000000)\n\n  - bility to use OLD or ZEROed keys!\n\n22. Firmware analysis (summary) What we know: 1. Self-signed firmware\n\n### (public\n\nkey is in the same binary!) 2. APLib packed sequential blocks 3. Modified XTEA\nencryption algorithm (different DELTA) 4. XTEA encryption keys can be bypassed\n(VULN IS HERE!) 5. DFU protocol (uploading firmware into a dispenser)\n\n23. USB Communications (steps) 1.Basekey initialization 2.New session\n\n### keys generation 3.Session\n\ncounters synchronizing\n\n[24. USB Communications (Basekey init) To generate a new Basekey you](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_23.jpg)\n\nneed: 1. ROOT-certificate 2. Intermediate CA-certificate 3. Terminal Encryption\ncertificate (issued by CA) 4. Terminal Authentication certificate (issued by CA) We don’t\nhave any of them… :( (and don’t need them)\n\n\n-----\n\n[25. USB Communications (session key) How to generate a new session](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_24.jpg)\n\nkey (PC): 1. BK = Read the Basekey from the Keystorage (its key in TPM) 2.\nSESSION_KEY_XXX = SHA1(BK) + session_counter + direction We have four\ndirections: PC_FW_OUT, PC_FW_IN, FW_PC_OUT, FW_PC_IN SmartCard also\nchecks for the same counter usage + makes its increment How to generate a new\nsession key (Firmware): 1. SESSION_KEY_XXX = SmartCard(session_counter +\ndirection)\n\n26. USB Communications (session sync) To synchronize session counters\n\n### you need:\n\n1. ChannelID (server=2, client=1) 2. Basekey length 3. Basekey Check Value (KCV)\n(first 3 bytes of SHA1(Basekey) 4. Session counters for USB client/server IN/OUT\nBasekey can be read from the Keystorage file too Response has the same parameters\nso we can sync session counters\n\n27. Abusing session counters (DoS) Steps to reproduce: 1.\n\n### session_counter =\n\n0xFFFFFFFF 2. SESSION_KEY_XXX = SmartCard(session_counter + direction)\nSmartCard generates a new key, but no new key can be generated after!\n\n[28. USB comms analysis (summary) What we know: 1. TPM usage](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_27.jpg)\n\n(awesome!) 2. Keystorage usage (awesome!) 3. Four encryption keys directions\n(awesome!) 4. SmartCard usage (awesome!) 5. SmartCard “feature” (can disable a\nwhole ATM, but won’t allow to take the money!)\n\n29. USB Communications (withdrawal) Steps to perform a withdrawal: 1.\n\n### Patch\n\nFW to skip asking SmartCard for a session key (use some dummy array) 2. Patch Java\ncode to use the same dummy array as the key 3. Patch Java code to skip checks for\ncashIn and cashOut configs 4. Sync session counters (PC = SmarCard) 5. Write a new\ncassettes config to the dispenser’s EEPROM 6. Call prepareCashOut() 7. Call\ncashOut(cassetteNum=3, banknotesNum=5) 8. Call shutter.open() 9. Take the money!\n10.Close the shutter\n\n[30. Vulnerabilities disclosure timeline 1. Q3 2018 – vendor has been](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_29.jpg)\n\ninformed about vulnerabilities 2. Q4 2018 – official PoC tests were performed,\nvulnerabilities have been proven 3. Q4 2018 – CVE IDs were registered 4. Q1 2021 –\nvendor informed us that vulnerabilities were fixed in 2019 5. Q3 2021 – <Russian\nMitre> IDs: - BDU:2021-04967 - BDU:2021-04968\n\n\n-----\n\n[31. Thank you Contacts: vkononovich@ptsecurity.com](https://files.speakerdeck.com/presentations/d00d31eed2f44a17b331a9051f1783ac/slide_30.jpg)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-04 - Blackboxing Diebold-Nixdorf ATMs.pdf"
    ],
    "report_names": [
        "2021-11-04 - Blackboxing Diebold-Nixdorf ATMs.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536001,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1653710597,
    "ts_modification_date": 1653710597,
    "files": {
        "pdf": "https://archive.orkl.eu/cfecb0ffb9b79118a354e36f1b4ef2fce912177d.pdf",
        "text": "https://archive.orkl.eu/cfecb0ffb9b79118a354e36f1b4ef2fce912177d.txt",
        "img": "https://archive.orkl.eu/cfecb0ffb9b79118a354e36f1b4ef2fce912177d.jpg"
    }
}