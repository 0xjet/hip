{
    "id": "8747d7b4-4952-4e15-8247-5552aa092e97",
    "created_at": "2022-10-25T16:48:12.223027Z",
    "updated_at": "2025-03-27T02:16:49.039468Z",
    "deleted_at": null,
    "sha1_hash": "1bf6c5eaaf996f463b25837c15b400c895862419",
    "title": "Operation Ephemeral Hydra: Ie Zero-Day Linked To Deputydog Uses Diskless Method",
    "authors": "FireEye",
    "file_creation_date": "2014-08-20T18:30:56Z",
    "file_modification_date": "2014-08-20T18:30:56Z",
    "file_size": 868617,
    "plain_text": "# Uses Diskless Method\n\nRecently, we discovered a new IE zero-day exploit in the wild, which has been used in a strategic Web\n\ncompromise. Specifically, the attackers inserted this zero-day exploit into a strategically important\n\nwebsite, known to draw visitors that are likely interested in national and international security policy. We\n\n**have identified relationships between the infrastructure used in this attack and that used in**\n\n**[Operation DeputyDog. Furthermore, the attackers loaded the payload used in this attack](http://www.fireeye.com/blog/technical/cyber-exploits/2013/09/operation-deputydog-zero-day-cve-2013-3893-attack-against-japanese-targets.html)**\n\n**directly into memory without first writing to disk – a technique not typically used by advanced**\n\npersistent threat (APT) actors. This technique will further complicate network defenders’ ability\n\n**to triage compromised systems, using traditional forensics methods.**\n\n**Enter Trojan.APT.9002**\n\n[On November 8, 2013 our colleagues Xiaobo Chen and Dan Caselden posted about a new Internet](http://www.fireeye.com/blog/author/xiaobo-chen)\n\n**Explorer 0-day exploit seen in the wild. This exploit was seen used in a strategic Web compromise. The**\n\nexploit chain was limited to one website. There were no iframes or redirects to external sites to pull down\n\nthe shellcode payload.\n\nThrough the FireEye Dynamic Threat Intelligence (DTI) cloud, we were able to retrieve the payload\n\ndropped in the attack. This payload has been identified as a variant of Trojan.APT.9002 (aka\n\nHydraq/McRAT variant) and runs in memory only. It does not write itself to disk, leaving little to\n\n**no artifacts that can be used to identify infected endpoints.**\n\nSpecifically, the payload is shellcode, which is decoded and directly injected into memory after\n\n**successful exploitation via a series of steps. After an initial XOR decoding of the payload with the key**\n\n“0x9F”, an instance of rundll32.exe is launched and injected with the payload using CreateProcessA,\n\nOpenProcess, VirtualAlloc, WriteProcessMemory, and CreateRemoteThread.\n\n\n-----\n\nFigure 1 – Initial XOR decoding of shellcode, with key ’0x9F’\n\n\n-----\n\nFigure 2 – Shellcode launches rundll32.exe and injects payload\n\nAfter transfer of control to the injected payload in rundll32.exe, the shellcode is then subjected to two\n\nmore levels of XOR decoding with the keys ’0×01′, followed by ’0x6A’.\n\nFigure 3- Decoding shellcode with XOR key ’0×01′\n\n\n-----\n\nFigure 4 – Decoding shellcode with XOR key ’0x6A’\n\nProcess execution is then transferred to the final decoded payload, which is a variant of the 9002 RAT.\n\nFigure 5 – Transfer of process execution to final decoded payload\n\n**The fact that the attackers used a non-persistent first stage payload suggests that they are**\n\n**confident in both their resources and skills. As the payload was not persistent, the attackers had**\n\n**to work quickly, in order to gain control of victims and move laterally within affected organizations. If**\n\n**the attacker did not immediately seize control of infected endpoints, they risked losing**\n\n**these compromised endpoints, as the endpoints could have been rebooted at any time – thus**\n\n**automatically wiping the in-memory Trojan.APT.9002 malware variant from the infected**\n\n**endpoint.**\n\nAlternatively, the use of this non-persistent first stage may suggest that the attackers were confident that\n\ntheir intended targets would simply revisit the compromised website and be re-infected.\n\n**Command and Control Protocol and Infrastructure**\n\n\n-----\n\n**uses a non-HTTP protocol as well as an HTTP POST for communicating with the remote**\n\n**server. However, the callback beacons have changed in this version, in comparison to the older 9002**\n\nRATs.\n\nThe older traditional version of 9002 RAT had a static 4-byte identifier at offset 0 in the callback network\n\ntraffic. This identifier was typically the string “9002″, but we have also seen variants, where this has been\n\n[modified – such as the 9002 variant documented in the Sunshop campaign.](http://www.fireeye.com/blog/technical/cyber-exploits/2013/08/the-sunshop-campaign-continues.html)\n\nFigure 6 – Traditional 9002 RAT callback beacon\n\nIn contrast, the beacon from the diskless 9002 payload used in the current IE 0-day attack is\n\n**remarkably different and uses a dynamic 4-byte XOR key to encrypt the data. This 4-byte key is**\n\npresent at offset 0 and changes with each subsequent beacon. FireEye labs is aware that the 4\n**byte XOR version of 9002 has been in the wild for a while and is used by multiple APT**\n\n**actors, but this is the first time we’ve seen it deployed in the diskless payload method.**\n\nFigure 7 – Sample callback beacons of the diskless 9002 RAT payload\n\n\n-----\n\nFigure 8 – XOR decrypted callback beacons of the diskless 9002 RAT payload\n\nThe XOR decoded data always contains the static value “\\x09\\x12\\x11\\x20″ at offset 16. This value is in\n\nfact hardcoded in packet data construction function prior to XOR encoding. This value most likely is the\n\ndate “2011-12-09″ but its significance is not known at this time.\n\n\n-----\n\nFigure 9 – Packet data construction function showing hardcoded value\n\nThe diskless 9002 RAT payload also makes a POST request, which has also changed from the traditional\n\nversion. It has Base64 stub data, instead of the static string “AA”. The User-Agent string and URI\n\n**pattern remain the same however. It uses the static string “lynx” in the User-Agent string and the**\n\nURI is incremental hexadecimal values.\n\n|Traditional 9002 RAT|Diskless 9002 RAT|\n|---|---|\n\n\nPOST /4 HTTP/1.1\n**User-Agent: lynx**\nHost: ieee.boeing-job.com\nContent-Length: 2\nConnection: Keep-Alive\nCache-Control: no-cache\n\n\nPOST /2 HTTP/1.1\n**User-Agent: lynx**\nHost: 111.68.9.93:443\nContent-Length: 104\nConnection: Keep-Alive\nCache-Control: no-cache\n\n\n-----\n\nUeAKsFHgCrBR4AqwUeAKsFHgCrBR4AqwUe\nAKg==\n\nThe data in the POST stub is also encrypted with a 4-byte XOR key, and when decrypted, the data is\n\nsimilar to the data in the non-HTTP beacon and also has the static value “\\x09\\x12\\x11\\x20″.\n\n**Campaign Analysis**\n\nWe previously observed 104130d666ab3f640255140007f0b12d connecting to the same 111.68.9.93 IP\n\naddress.\n\nAnalysis of MD5 104130d666ab3f640255140007f0b12d revealed that it shared unique identifying\n\ncharacteristics with 90a37e54c53ffb78969644b1a7038e8c, acbc249061a6a2fb09271a68d53567d9, and\n\n20854f54b0d03118681410245be39bd8.\n\nMD5 acbc249061a6a2fb09271a68d53567d9 and 90a37e54c53ffb78969644b1a7038e8c are both\n\nTrojan.APT.9002 variants and connect to a command and control server at 58.64.143.244.\n\nMD5 20854f54b0d03118681410245be39bd8 is another Trojan.APT.9002 variant. This variant connected\n\nto a command and control server at ad04.bounceme.net.\n\nPassive DNS analysis of this domain revealed that it resolved to 58.64.213.104 between 2011-09-23 and\n\n2011-10-21. The following other domains have also been seen resolving to this same IP address:\n\n**DOMAIN** **FIRST SEEN** **LAST SEEN**\n**dll.freshdns.org** 2011-12-08 2012-01-31\ngrado.selfip.com 2011-12-23 2012-01-10\nusc-data.suroot.com 2012-02-20 2012-02-22\nusa-mail.scieron.com 2011-12-01 2012-02-22\n\nIf the domain dll.freshdns.org rings a bell, it should. While covering a different Internet Explorer Zero-day\n\n(CVE-2013-3893) and the associated Operation DeputyDog campaign, we reported that the CnC\n\ninfrastructure used in that campaign overlapped with this same domain: dll.freshdns.org.\n\nInside the in-memory version of the Trojan.APT.9002 payload used in this strategic Web compromise, we\n\nidentified the following interesting string: “rat_UnInstall”. Through DTI, we found this same string\n\n**present in a number of different samples including the ones discussed above:**\n\n104130d666ab3f640255140007f0b12d\n\n90a37e54c53ffb78969644b1a7038e8c\n\nacbc249061a6a2fb09271a68d53567d9\n\n|DOMAIN|FIRST SEEN|LAST SEEN|\n|---|---|---|\n|dll.freshdns.org|2011-12-08|2012-01-31|\n|grado.selfip.com|2011-12-23|2012-01-10|\n|usc-data.suroot.com|2012-02-20|2012-02-22|\n|usa-mail.scieron.com|2011-12-01|2012-02-22|\n\n\n-----\n\nBased on this analysis, all of these samples, including the in-memory variant, can be detected with the\n\nfollowing simple YARA signature:\n\nrule FE_APT_9002_rat\n\n{\n\nmeta:\n\nauthor = “FireEye Labs”\n\nstrings:\n\n$mz = {4d 5a}\n\n$a = “rat_UnInstall” wide ascii\n\ncondition:\n\n($mz at 0) and $a\n\n}\n\nWe also found the following strings of interest present in these above 9002 RAT samples (excluding the\n\nin-memory variant):\n\nMcpRoXy.exe\n\nSoundMax.dll\n\n[These strings were all observed and highlighted by Bit9 here. As Bit9 notes in their blog,](https://blog.bit9.com/2013/02/25/bit9-security-incident-update/)\n\n**Trojan.APT.9002 (aka Hydraq/McRAT) was also used in the original Operation Aurora**\n\n**campaign, and the “rat_UnInstall” string can be found in the original Aurora samples**\n\n**confirming the lineage.**\n\n**Conclusions**\n\nBy utilizing strategic Web compromises along with in-memory payload delivery tactics and multiple\n\nnested methods of obfuscation, this campaign has proven to be exceptionally accomplished and elusive.\n\nAPT actors are clearly learning and employing new tactics. With uncanny timing and a penchant for\n\n**consistently employing Zero-day exploits in targeted attacks, we expect APT threat actors**\n\n**to continue to evolve and launch new campaigns for the foreseeable future. Not surprisingly,**\n\nthese old dogs continue to learn new tricks.\n\n_FireEye Labs would like to thank iSIGHT Partners for their assistance with this research._\n\n[This entry was posted in Exploits Targeted Attack Threat Intelligence Threat Research Vulnerabilities](http://www.fireeye.com/blog/category/technical/cyber-exploits)\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/qm0qqb7bpc0ut2c5n76zr5i0rdfhy5ts",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2013/2013.11.10.Operation_Ephemeral_Hydra/Operation_EphemeralHydra.pdf"
    ],
    "report_names": [
        "Operation_EphemeralHydra"
    ],
    "threat_actors": [
        {
            "id": "2150d1ac-edf0-46d4-a78a-a8899e45b2b5",
            "created_at": "2022-10-25T15:50:23.269339Z",
            "updated_at": "2025-03-27T02:00:55.416524Z",
            "deleted_at": null,
            "main_name": "APT17",
            "aliases": [
                "APT17",
                "Deputy Dog"
            ],
            "source_name": "MITRE:APT17",
            "tools": [
                "BLACKCOFFEE"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "1edcac0b-efd9-47b1-9aca-33827d5bd085",
            "created_at": "2024-05-01T02:03:07.964773Z",
            "updated_at": "2025-03-27T02:05:17.273595Z",
            "deleted_at": null,
            "main_name": "BRONZE KEYSTONE",
            "aliases": [
                "Aurora Panda ",
                "DeputyDog ",
                "Group 72 ",
                "Hidden Lynx ",
                "Shell Crew",
                "TG-8153 ",
                "Tailgater Team",
                "APT17 "
            ],
            "source_name": "Secureworks:BRONZE KEYSTONE",
            "tools": [
                " BlackCoffee",
                " DeputyDog",
                " Derusbi",
                " Gh0stHTTPSDropper",
                " HiKit",
                " InternalCMD",
                " PlugX",
                " PoisonIvy",
                " ZxShell",
                "9002"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "86fd71d3-06dc-4b73-b038-cedea7b83bac",
            "created_at": "2022-10-25T16:07:23.330793Z",
            "updated_at": "2025-03-27T02:02:09.740703Z",
            "deleted_at": null,
            "main_name": "APT 17",
            "aliases": [
                "APT 17",
                "ATK 2",
                "Beijing Group",
                "Bronze Keystone",
                "Deputy Dog",
                "Elderwood",
                "Elderwood Gang",
                "Operation Aurora",
                "Operation DeputyDog",
                "Operation Ephemeral Hydra",
                "Operation RAT Cook",
                "SIG22",
                "Sneaky Panda",
                "TEMP.Avengers",
                "TG-8153",
                "Tailgater Team"
            ],
            "source_name": "ETDA:APT 17",
            "tools": [
                "9002 RAT",
                "AGENT.ABQMR",
                "AGENT.AQUP.DROPPER",
                "AGENT.BMZA",
                "AGENT.GUNZ",
                "Agent.dhwf",
                "AngryRebel",
                "BlackCoffee",
                "Briba",
                "Chymine",
                "Comfoo",
                "Comfoo RAT",
                "Darkmoon",
                "DeputyDog",
                "Destroy RAT",
                "DestroyRAT",
                "Farfli",
                "Fexel",
                "Gen:Trojan.Heur.PT",
                "Gh0st RAT",
                "Ghost RAT",
                "Gresim",
                "HOMEUNIX",
                "HiKit",
                "HidraQ",
                "Homux",
                "Hydraq",
                "Jumpall",
                "Kaba",
                "Korplug",
                "Linfo",
                "MCRAT.A",
                "McRAT",
                "MdmBot",
                "Mdmbot.E",
                "Moudour",
                "Mydoor",
                "Naid",
                "Nerex",
                "PCRat",
                "PNGRAT",
                "Pasam",
                "PlugX",
                "Poison Ivy",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Trojan.Naid",
                "Vasport",
                "Wiarp",
                "Xamtrav",
                "Zox",
                "ZoxPNG",
                "ZoxRPC",
                "gresim",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716492,
    "ts_updated_at": 1743041809,
    "ts_creation_date": 1408559456,
    "ts_modification_date": 1408559456,
    "files": {
        "pdf": "https://archive.orkl.eu/1bf6c5eaaf996f463b25837c15b400c895862419.pdf",
        "text": "https://archive.orkl.eu/1bf6c5eaaf996f463b25837c15b400c895862419.txt",
        "img": "https://archive.orkl.eu/1bf6c5eaaf996f463b25837c15b400c895862419.jpg"
    }
}