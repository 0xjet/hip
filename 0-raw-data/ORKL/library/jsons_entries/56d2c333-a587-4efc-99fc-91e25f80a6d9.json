{
    "id": "56d2c333-a587-4efc-99fc-91e25f80a6d9",
    "created_at": "2023-01-12T15:07:48.473864Z",
    "updated_at": "2025-03-27T02:05:47.381285Z",
    "deleted_at": null,
    "sha1_hash": "8c666186ee15a84a10b213632d120c111d618337",
    "title": "2022-03-25 - Purple Fox Uses New Arrival Vector and Improves Malware Arsenal",
    "authors": "",
    "file_creation_date": "2022-05-28T15:26:50Z",
    "file_modification_date": "2022-05-28T15:26:50Z",
    "file_size": 1396492,
    "plain_text": "# Purple Fox Uses New Arrival Vector and Improves Malware Arsenal\n\n**[trendmicro.com/en_in/research/22/c/purple-fox-uses-new-arrival-vector-and-improves-malware-arsenal.html](https://www.trendmicro.com/en_in/research/22/c/purple-fox-uses-new-arrival-vector-and-improves-malware-arsenal.html)**\n\nMarch 25, 2022\n\nMalware\n\nPurple Fox is an old threat that has been making waves since 2018. This most recent\ninvestigation covers Purple Fox’s new arrival vector and early access loaders. Users’\nmachines seem to be targeted with malicious payloads masquerading as legitimate\napplication installers.\n\nBy: Sherif Magdy, Abdelrhman Sharshar, Jay Yaneza March 25, 2022 Read time: ( words)\n\nContent added to Folio\n\nWe have been continuously tracking the Purple Fox threat since it first made waves in 2018,\n[when it reportedly infected over 30,000 users worldwide. In 2021 we covered how it](https://blog.360totalsecurity.com/en/purple-fox-trojan-burst-out-globally-and-infected-more-than-30000-users/)\ndownloaded and executed cryptocurrency miners, and how it continued to improve its\n[infrastructure while also adding new backdoors.](https://www.trendmicro.com/en_us/research/21/j/purplefox-adds-new-backdoor-that-uses-websockets.html)\n\nThis most recent investigation covers Purple Fox’s new arrival vector and the early access\nloaders we believe are associated with the intrusion set behind this botnet. Our data shows\nthat users’ machines are targeted via trojanized software packages masquerading as\nlegitimate application installers. The installers are actively distributed online to trick users and\nincrease the overall botnet infrastructure. Other security companies have also reported on\n[Purple Fox’s recent activities and their latest payloads.](https://decoded.avast.io/martinchlumecky/dirtymoe-5/)\n\nThe operators are updating their arsenal with new malware, including a variant of the remote\naccess trojan [FatalRAT that they seem to be continuously upgrading. They are also trying to](https://www.bankinfosecurity.com/fatalrat-exploits-telegram-to-deliver-malicious-links-a-17199)\nimprove their signed rootkit arsenal for antivirus (AV) evasion to be able to bypass security\ndetection mechanisms. These notable changes are covered in the sections below and further\n[explained in our technical brief.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/22/c/purple-fox-uses-new-arrival-vector-and-improves-malware-arsenal/Technical%20Brief%20-%20A%20Look%20Into%20Purple%20Fox%E2%80%99s%20New%20Arrival%20Vector.pdf)\n\nPurple Fox infection chain and payload updates\n\nThe attackers distribute their malware using disguised software packages that encapsulate\nthe first stage loader. They use popular legitimate application names like Telegram,\nWhatsApp, Adobe, and Chrome to hide their malicious package installers.\n\n\n-----\n\nThe installers include a specific single character (highlighted in Figure 1 as A ) that\ncorresponds to a specific payload. The second stage payload is added as the single\ncharacter in the request sent by the execution parent to the first stage command and control\n(C&C) server (illustrated in detail in Figure 2 as “r”). It is retrieved through the module\nfilename’s last character, then the first stage C&C server will log the execution timestamp\nsent in the request alongside the character. The single character will then determine what\npayloads will be sent back for the malicious installer to drop on the infected machine.\n\n\n-----\n\nFigure 1. Purple Fox infection chain\n\n\n-----\n\nFigure 2. Malicious installer requests the second stage payloads\nIn previous campaigns in 2019, HTTP file servers (HFS) were used by Purple Fox to run the\nC&C servers that host files on the infected bots. In this most recent investigation, we found\nan exposed HFS that the Purple Fox group uses to host all the second stage samples with\ntheir update timestamps. We were able to track the frequency of the second stage updated\npackages pushed to this exposed server using the timestamp data. Figure 3 shows the\nnumber of different second stage malicious packages that received updates. They are still\nactively updating their components at the time of writing.\n\n\n-----\n\nFigure 3. Second stage payloads update count\nNotable Purple Fox tools and techniques\n\n**Disguised packages and malicious components in svchost.txt**\n\nWe noted that some of the software they were impersonating were commonly used by\nChinese users. The following list shows the recently used software and the corresponding\nmalicious payload for the second stage of the infection. As mentioned above, the different\npayloads will be served by the C&C upon execution based on the last character in the\nmodule filename.\n\nTable 1. Disguised package names with highlighted single characters that correspond to the\n\n\n-----\n\npayloads\nWe tracked a server hosting the second stage payloads and saw a compressed RAR archive\nholding the second stage loaders along with the file svchost.txt, which contains all the\nmalicious portable executable (PE) module components that will be dropped in the second\nstage.\n\nThe order of the PE modules inside svchost.txt is dependent on the package requested by\nthe malicious installers. As previously mentioned, the last character in the installer filename\nwill determine the final set of the auxiliary modules that will be stuffed inside svchost.txt.\n\n**Shellcode user-mode loader and anti-forensics methods**\n\nA specific set of portable executable (PE) modules found in one of the most distributed\nclusters from the malware had a wide range of capabilities in terms of AV evasion. This\ncluster is noteworthy for various reasons as well — it has links to older families, it loaded a\npreviously documented Purple Fox MSI installer, and it had different rootkit capabilities in the\n[auxiliary PE modules. More details about this cluster can be found in our technical brief.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/22/c/purple-fox-uses-new-arrival-vector-and-improves-malware-arsenal/Technical%20Brief%20-%20A%20Look%20Into%20Purple%20Fox%E2%80%99s%20New%20Arrival%20Vector.pdf)\n\nAfter analysing all the observed malicious execution parents delivering different clusters, we\nfound that the shellcode component at the prologue of the dropped svchost.txt was similar\nacross all the different variants, regardless of the actual payloads embedded after the\nshellcode. It has two different implementations across all the clusters.\n\nThe first shellcode implements four main functions for the intended functionality, as shown in\nFigure 4.\n\nFigure 4. Shellcode main functions for loading a PE module in memory\nMeanwhile, the new shellcode is more minimalistic because it implements only important\nfunctionalities to load a PE in memory and parse several system APIs addresses. It resolves\ndifferent system APIs from the first one we mentioned.\n\n\n-----\n\nOne more thing to note: the Purple Fox group implements a customised user-mode\nshellcode loader that leaves little traces for cybersecurity forensics. It minimises both the\nquantity and quality of the forensic evidence as the execution doesn’t rely on the native\nloader and doesn't respect the PE format for a successful execution.\n\n**The use of FatalRAT and incremental updates**\n\nAfter the shellcode loads and allocates memory for the PE modules inside svchost.txt, the\nexecution flow will call into the first PE module found after the shellcode. This is a remote\naccess trojan (RAT) that inherits its functionality from a malware known as FatalRAT, a\nsophisticated C++ RAT that implements a wide set of remote capabilities for the attackers.\n\nThe executed FatalRAT variants shown in Figures 5 and 6 differ across each cluster,\nillustrating that the attackers are incrementally updating it.\n\nFigure 5. Updated FatalRAT variant from cluster\n1\n\nFigure 6. Updated FatalRAT variant from a more\n\nrecent cluster with more added functionality\n\n\n-----\n\nThe RAT is responsible for loading and executing the auxiliary modules based on checks\nperformed on the victim systems. Changes can happen if specific AV agents are running or if\nregistry keys are found. The auxiliary modules are intended as support for the group’s\nspecific objectives.\n\n**New capabilities to evade cybersecurity mechanisms**\n\nOne of the analysed executables embedded in svchost.txt is a user-mode client used to\ninterface with the accompanying rootkit module. This client supports five different commands,\neach command implements a specific functionality to be executed from the kernel driver with\nthe appropriate input/output control (IOCTL) interface exposed. Table 2 shows the details of\neach command:\n\nTable 2. IOCTL interface implemented by Purple Fox AV killer rootkit\nThe functionality to “kill a mini-filter” is notable in terms of AV evasion. File systems are\ntargets for input-output (I/O) operations to access files, and file system filtering is the\nmechanism by which the drivers can intercept calls sent to the file system — this specifically\nis useful for AV agents. The model called ‘file system mini-filters’ was developed to replace\nthe legacy filter mechanism. Mini-filters are easier to write and are the preferred way to\ndevelop file system filtering drivers in almost all AV engines.\n\nWe looked deeper into the mini-filter driver killer and how the attackers implemented this\nfunctionality. The driver first enumerates all the registered mini filter drivers on the system\nusing the system API FltEnumerateFilters, then it gets the targeted mini-filter object\ninformation it is searching for by calling FltGetFilterInformation. Lastly, it creates a new\nsystem thread to unregister the mini-filter driver and terminate the created system thread\n(PsCreateSystemThread, FltUnregisterFilter).\n\nFigure 7 shows the specific call graph for the system APIs used for this functionality.\n\n\n-----\n\nFigure 7. System APIs call for unregistering mini-filter drivers\n**The uses of revoked code signing certificates**\n\nTo control the quality of the code that runs in the address space of the kernel-land, Microsoft\nonly allows signed drivers to run in kernel mode. They do this by enforcing kernel-mode code\nsigning (KMCS) mechanisms.\n\nDue to performance issues and backward compatibility, Windows actually allows the loading\nof a kernel driver signed by a revoked code signing certificate. So, by testing a previous\nkernel driver and allowing it to be revoked, it can be loaded successfully. This design choice\nallows mature threat actors to chase and pursue any stolen code signing certificate and add\nit to their malware arsenal. If the malware authors acquire any certificate that has been\nverified by a trusted certificate authority and by Microsoft, even if it was revoked, attackers\ncan use it for malicious purposes.\n\nLinks to previous Purple Fox activities and artefacts\n\nAnalyzing the artefacts dropped by this new infection chain, we first looked at the stolen code\nsigning certificates used to sign the kernel drivers’ modules. This led us to analyse other\nsigned malicious samples in our malware repository, which revealed links to previously\nknown intrusion sets.\n\nThere were three different stolen code signing certificates confirmed to be related to this\ncampaign with links to Purple Fox:\n\nHangzhou Hootian Network Technology Co., Ltd. - We found a strong connection to\nearly activity of the Purple Fox botnet that [started in 2019.](https://www.guardicore.com/labs/the-nansh0u-campaign-hackers-arsenal-grows-stronger/)\nShanghai Oceanlink Software Technology Co. Ltd. - Analysis revealed several clusters\nof malicious kernel modules previously used in Purple Fox activities.\nShanghai easy kradar Information Consulting Co. Ltd. – This certificate overlaps with\n“Hangzhou Hootian Network” in signing a common cluster of kernel drivers that was\nalso previously seen in Purple Fox activities.\n\nThis campaign is similar with earlier Purple Fox activities in other ways as well, namely, how\nthe attack infrastructure is run and the malware hosted on their servers:\n\nThe first stage C&C server 202[.]8.123[.]98 links FatalRAT operators with the Purple\nFox. The server was hosting the malicious compressed archives in this campaign and\nwas used before by FatalRAT as their main C&C server.\n\n\n-----\n\nOne of the first stage servers (194.146.84.245) hosted an old module for the MSI\ninstaller for Purple Fox (e1f3ac7f.moe) that will eventually load the crypto miner\ndiscussed in the previous blogs.\nThe dropped FatalRAT from the malicious archive found on the first stage C&C server\nrevealed many code similarities with a previously documented info stealer known as\n[Zegost. We go into commonalities found between these Purple Fox campaign modules](https://www.fortinet.com/blog/threat-research/zegost-campaign-targets-internal-interests)\nand the old Zegost samples in our technical brief.\n\nConclusion\n\nOperators of the Purple Fox botnet are still active and consistently updating their arsenal with\nnew malware, while also upgrading the malware variants they have. They are also trying to\nimprove their signed rootkit arsenal for AV evasion and trying to bypass detection\nmechanisms by targeting them with customised signed kernel drivers.\n\nAbusing stolen code signing certificates and unprotected drivers are becoming more\ncommon with malicious actors. Software driver vendors should secure their code signing\ncertificates and follow secure practices in the Windows kernel driver development process.\n\n[For more details on this topic download our technical brief and for the full list of the Indicators](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/22/c/purple-fox-uses-new-arrival-vector-and-improves-malware-arsenal/Technical%20Brief%20-%20A%20Look%20Into%20Purple%20Fox%E2%80%99s%20New%20Arrival%20Vector.pdf)\n[of Compromise download this document.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/22/c/purple-fox-uses-new-arrival-vector-and-improves-malware-arsenal/IOCs-Purple-Fox.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-25 - Purple Fox Uses New Arrival Vector and Improves Malware Arsenal.pdf"
    ],
    "report_names": [
        "2022-03-25 - Purple Fox Uses New Arrival Vector and Improves Malware Arsenal.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536068,
    "ts_updated_at": 1743041147,
    "ts_creation_date": 1653751610,
    "ts_modification_date": 1653751610,
    "files": {
        "pdf": "https://archive.orkl.eu/8c666186ee15a84a10b213632d120c111d618337.pdf",
        "text": "https://archive.orkl.eu/8c666186ee15a84a10b213632d120c111d618337.txt",
        "img": "https://archive.orkl.eu/8c666186ee15a84a10b213632d120c111d618337.jpg"
    }
}