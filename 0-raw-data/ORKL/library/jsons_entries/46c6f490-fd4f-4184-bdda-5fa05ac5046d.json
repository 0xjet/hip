{
    "id": "46c6f490-fd4f-4184-bdda-5fa05ac5046d",
    "created_at": "2022-10-25T16:48:17.078377Z",
    "updated_at": "2025-03-27T02:15:06.218389Z",
    "deleted_at": null,
    "sha1_hash": "83700e7417a7cfb149a6fc5d3330ef56d5cd2849",
    "title": "Patchwork: Stitching against malware families with IDA Pro",
    "authors": "",
    "file_creation_date": "2014-07-31T11:51:43Z",
    "file_modification_date": "2014-07-31T14:37:32Z",
    "file_size": 1019035,
    "plain_text": "# Patchwork\n#### Stitching against malware\n\n### Daniel Plohmann\n\n\n#### families\n\n\n#### with\n\n\n#### IDA Pro\n\n\n### plohmann@cs.uni-bonn.de\n\n\n-----\n\n## Some words about myself\n\n\n### \n\n \n\n\n### Related\n\n\n### Personal background\n\n\n### \n\n\n### PhD\n\n\n### student\n\n\n### and researcher\n\n\n### at University of Bonn & Fraunhofer FKIE\n\n of Reverse Engineering\n\n\n### \n\n \n\n\n### Work\n\n\n### Research focus: Efficiency\n\n\n### focus: malware\n\n\n### analysis\n\n\n### and botnet\n\n\n### mitigation\n\n\n### projects\n\n\n### \n\n \n\n\n\n### [2] IDAscope\n\n\n\n### [1] PyBox\n\n\n### (python\n\n\n### sandboxing\n\n\n### toolkit)\n\n\n### (IDA Pro enhancements\n\n\n### for\n\n\n### malware\n\n\n### RE)\n\n\n-----\n\n## Patchwork Motivation\n\n\n-----\n\n## Patchwork … in a nutshell\n\n\n#### \n\n \n\n \n\n\n#### \n\n\n#### Driving\n\n\n#### Patchwork\n\n\n#### = refurbished\n\n\n#### (IDA)PyEmu\n\n\n\n#### [1] + set\n\n\n#### of convenience\n\n\n#### functions\n\n\n#### Work\n\n\n#### in progress\n\n\n#### ideas:\n\n\n#### \n\n \n\n\n#### Get\n\n\n#### A flexible framework\n\n\n#### that\n\n\n#### allows\n\n\n#### data\n\n\n#### transformations\n\n\n#### aiding\n\n\n#### static\n\n\n#### analysis\n\n\n#### away\n\n\n#### from\n\n\n#### the\n\n\n#### (throwaway-)snippets-per-case\n\n\n#### approach\n\n\n#### Sharing\n\n\n#### is\n\n\n#### caring!\n\n\n#### \n\n\n-----\n\n## Patchwork Wishlist\n\n\n#### \n\n \n\n \n\n \n\n\n#### Notable\n\n\n#### Seamless\n\n\n#### integration\n\n\n#### with\n\n\n#### IDA\n\n\n#### Instrumentalization\n\n\n#### of analysis\n\n\n#### target‘s\n\n\n#### native code\n\n\n#### \n\n\n#### But\n\n\n#### don‘t\n\n\n#### actually\n\n\n#### run\n\n\n#### code\n\n\n#### (= no debugging, AppCall, PIN, …)\n\n\n#### Reusability\n\n\n#### / generalization\n\n\n#### emulation\n\n\n#### solutions\n\n\n#### compatible\n\n\n#### with\n\n\n#### IDA:\n\n\n#### \n\n \n\n\n\n#### [2] (IDA)PyEmu: python-based, fully\n\n\n\n#### [1] Ida-x86emu: standalone\n\n\n#### plugin, no extendability\n\n\n#### scriptable\n\n\n\n\n\n\n\nOutdated\n\n\nIncomplete\n\n\n(limited\n\n\nto most\n\n\ncommon\n\n\nopcodes)\n\n\n(state\n\n\nof 2009)\n\n\n-----\n\n## (IDA)PyEmu Workflow\n\n\n#### \n\n \n\n \n\n \n\n\n#### Emulate\n\n Proceed\n\n\n#### Pretty\n\n\n#### straight-forward\n\n\n#### :)\n\n\n#### Set initial\n\n\n#### emulation\n\n\n#### state\n\n\n#### \n\n \n\n\n#### Create\n\n\n#### Allocate\n\n\n#### + fill\n\n\n#### virtual\n\n\n#### memory\n\n\n#### context\n\n\n#### (stack\n\n\n#### / registers\n\n\n#### + EIP)\n\n\n#### step\n\n with\n\n\n#### by\n\n\n#### modified\n\n\n#### step\n\n\n#### state\n\n\n#### (algorithmic\n\n\n#### results, transformed\n\n\n#### memory)\n\n\n-----\n\n## Patchwork Workflow\n\n\n##### against\n (with\n\n\n\n##### • Execute ResultCallbacks (with wildcards)\n\n\n##### Arbitrary (IDA)python function taking advantage of earlier results Convenience functions for patching etc.\n\n\n-----\n\n## Patchwork Example: Nymaim\n\n\n#### \n\n \n\n\n#### Dropper\n\n Written\n\n\n#### in assembler, heavily\n\n\n#### / Ransom\n\n\n#### malware\n\n\n#### family\n\n\n\n#### [1]\n\n\n#### obfuscated\n\n\n#### \n\n \n\n \n\n\n#### Obfuscated\n\n Obfuscated\n\n\n#### Control\n\n\n#### flow\n\n\n#### obfuscation\n\n\n#### (call/jmp\n\n\n#### redirection)\n\n\n#### stack/register\n\n\n#### stack\n\n\n#### usage\n\n\n#### (delegated\n\n\n#### to subfunction)\n\n\n#### usage\n\n\n#### (introduction\n\n\n#### of many\n\n\n#### irrelevant fields)\n\n\n####  Hashed\n\n\n#### API calls\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\nArg_0: Displacement offset part 0 (0x4F4AD544)\n\nArg_4: Displacement offset part 1 (0xB0B48F89)\n\nArg_8: Placeholder for original return address\n\n\nFunction\n\n\nprologue\n\n\nSave original return\n\n\naddress\n\n\nCalculate\n\n\ndisplacement\n\n\nApply displacement to return address\nClean up and detour to deplaced return address\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Control Flow Obfuscation)\n\n\n-----\n\n## Patchwork Example: Nymaim (Deobfuscation)\n\n\n#### \n\n \n\n\n#### Select:\n\n Emulate:\n\n\n**push_push_call_regex = (**\n\n**r\"\\x68(?P<operand_1>[\\S\\s]{4})\"**\n**r\"\\x68(?P<operand_2>[\\S\\s]{4})\"**\n**r\"\\xE8\"**\n**)**\n\n\n####  Until\n\n\n#### first\n\n\n#### ret\n\n\n#### / retn\n\n\n#### instruction\n\n\n-----\n\n## Patchwork Example: Nymaim (Deobfuscation)\n\n\n#### \n\n\n#### Validate:\n\n\n**ppc_validators = {**\n\n**\"call_detour\": [**\n\n**'push dword',**\n**'push dword',**\n**'push ebp',**\n**'mov ebp,esp',**\n**'push eax',**\n**'mov eax,[ebp+0x4]',**\n**'mov [ebp+0x10],eax',**\n**'mov eax,[ebp+0xc]',**\n**'', # contains the operand -> add, sub, xor**\n**'add [ebp+0x4],eax',**\n**'pop eax',**\n**'leave'],**\n\n\n-----\n\n## Patchwork Example: Nymaim (Deobfuscation)\n\n\n#### \n\n\n#### Transform:\n\n\n**def _deobfuscate_call_detour(self, validation):**\n\n**obf_start_addr = validation.selection.selectionOffset**\n**call_offset = validation.emulation.cbResult - (obf_start_addr + 10 + 5)**\n**deobf_call = \"\\x90\" * 10 + \"\\xE8\" + struct.pack(\"I\", (call_offset) & 0xffffffff)**\n**ida_lib.patch_bytes(obf_start_addr, deobf_call)**\n**self.updateCallXref(obf_start_addr + 10, validation.emulation.cbResult)**\n\n\n-----\n\n## Patchwork Example: Nymaim (Deobfuscation)\n\n\n#### \n\n\n#### Applying\n\n\n#### all deobfuscations:\n\n\n#### \n\n \n\n \n\n \n\n\n#### ~2 min run\n\n\n#### time\n\n\n#### 4443 transformations\n\n\n#### Functions\n\n\n#### recognition: 463 -> 920                     \n\nCrypted strings\n\n\n/ functions\n\n\n### Before:\n\n After:\n\n\n-----\n\n## Patchwork Future plans\n\n\n#### \n\n \n\n\n#### Extend\n\n\n#### Looking\n\n\n#### at more\n\n\n#### use\n\n\n#### cases\n\n\n#### \n\n \n\n \n\n\n#### Import reconstruction\n\n\n#### Memory\n\n\n#### usage\n\n\n#### analysis\n\n\n#### (deobfuscate\n\n\n#### Nymaim‘s\n\n\n#### blown\n\n\n#### up stack)\n\n\n#### KINS BaseConfig\n\n\n#### (VM-based) decryption\n\n\n#### / patch\n\n\n#### PyEmu\n\n\n#### \n\n\n#### Change disassembly\n\n\n#### engine\n\n\n#### to IDA / capstone\n\n\n####  Increase\n\n\n#### coverage\n\n\n#### of opcodes\n\n\n-----\n\n## Patchwork Conclusion\n\n\n#### \n\n\n#### Give\n\n\n#### it\n\n\n#### a try\n\n\n#### :)\n\n\n#### \n\n\n#### Repository\n\n\n#### at http://patchwork.pnx.tf\n\n\n (points [to: https://bitbucket.org/daniel_plohmann/idapatchwork)](http://patchwork.pnx.tf/)\n\n####  Send feedback or ideas for improvement!\n\n\n#### \n\n\n#### patchwork@pnx.tf\n\n\n#### / plohmann@cs.uni-bonn.de\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://public.gdatasoftware.com/Web/Landingpages/DE/GI-Spring2014/slides/004_plohmann.pdf"
    ],
    "report_names": [
        "004_plohmann.pdf"
    ],
    "threat_actors": [
        {
            "id": "7ea1e0de-53b9-4059-802f-485884180701",
            "created_at": "2022-10-25T16:07:24.04846Z",
            "updated_at": "2025-03-27T02:02:10.090459Z",
            "deleted_at": null,
            "main_name": "Patchwork",
            "aliases": [
                "APT-C-09",
                "ATK 11",
                "Capricorn Organisation",
                "Chinastrats",
                "Dropping Elephant",
                "Maha Grass",
                "Quilted Tiger",
                "TG-4410",
                "Thirsty Gemini",
                "Zinc Emerson"
            ],
            "source_name": "ETDA:Patchwork",
            "tools": [
                "AndroRAT",
                "Artra Downloader",
                "ArtraDownloader",
                "AutoIt backdoor",
                "BADNEWS",
                "BIRDDOG",
                "Bahamut",
                "Bozok",
                "Bozok RAT",
                "Brute Ratel",
                "Brute Ratel C4",
                "CinaRAT",
                "Crypta",
                "ForeIT",
                "JakyllHyde",
                "Loki",
                "Loki.Rat",
                "LokiBot",
                "LokiPWS",
                "NDiskMonitor",
                "Nadrac",
                "PGoShell",
                "PowerSploit",
                "PubFantacy",
                "Quasar RAT",
                "QuasarRAT",
                "Ragnatela",
                "Ragnatela RAT",
                "SocksBot",
                "TINYTYPHON",
                "Unknown Logger",
                "WSCSPL",
                "Yggdrasil"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "9c884c88-2c9f-49c5-856a-2383ad1d8ef8",
            "created_at": "2024-05-01T02:03:08.152Z",
            "updated_at": "2025-03-27T02:05:17.422887Z",
            "deleted_at": null,
            "main_name": "ZINC EMERSON",
            "aliases": [
                "Dropping Elephant ",
                "EHDevel ",
                "Manul ",
                "Monsoon ",
                "Operation Hangover ",
                "Patchwork ",
                "TG-4410 ",
                "Viceroy Tiger ",
                "Confucius "
            ],
            "source_name": "Secureworks:ZINC EMERSON",
            "tools": [
                " Hanove",
                " Mac OS X KitM Spyware",
                " Proyecto2",
                " YTY Backdoor",
                "Enlighten Infostealer"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "c81067e0-9dcb-4e3f-abb0-80126519c5b6",
            "created_at": "2022-10-25T15:50:23.285448Z",
            "updated_at": "2025-03-27T02:00:55.42906Z",
            "deleted_at": null,
            "main_name": "Patchwork",
            "aliases": [
                "Hangover Group",
                "Dropping Elephant",
                "Chinastrats",
                "Operation Hangover"
            ],
            "source_name": "MITRE:Patchwork",
            "tools": [
                "NDiskMonitor",
                "QuasarRAT",
                "BackConfig",
                "TINYTYPHON",
                "AutoIt backdoor",
                "PowerSploit",
                "BADNEWS",
                "Unknown Logger",
                "Socksbot"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716497,
    "ts_updated_at": 1743041706,
    "ts_creation_date": 1406807503,
    "ts_modification_date": 1406817452,
    "files": {
        "pdf": "https://archive.orkl.eu/83700e7417a7cfb149a6fc5d3330ef56d5cd2849.pdf",
        "text": "https://archive.orkl.eu/83700e7417a7cfb149a6fc5d3330ef56d5cd2849.txt",
        "img": "https://archive.orkl.eu/83700e7417a7cfb149a6fc5d3330ef56d5cd2849.jpg"
    }
}