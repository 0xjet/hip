{
    "id": "77a679d9-1d15-4f93-8640-d1b61d875858",
    "created_at": "2023-01-12T15:10:48.113331Z",
    "updated_at": "2025-03-27T02:06:13.518766Z",
    "deleted_at": null,
    "sha1_hash": "5e19af2d56ca7c3c5758de19af18dbcdbed5b606",
    "title": "2017-10-25 - SnatchLoader Reloaded",
    "authors": "",
    "file_creation_date": "2022-05-28T19:10:38Z",
    "file_modification_date": "2022-05-28T19:10:38Z",
    "file_size": 169609,
    "plain_text": "# SnatchLoader Reloaded\n\n**arbornetworks.com/blog/asert/snatchloader-reloaded/**\n\n\n-----\n\nSnatchloader Login\n\n\nby [ASERT Team on October 25th, 2017](https://www.netscout.com/blog/asert/asert-team)\n**Executive Summary**\n\nSnatchLoader is a “downloader” malware—a type of malware that specializes in distributing\n(or loading) other malware onto infected computers. We first started seeing it in the wild\naround January 2017, but after a few months it went dormant. Recently, development of the\nmalware has picked up again and we’ve seen updates as recently as last week. It is currently\nbeing used to load a banking trojan known as Ramnit. Additionally, it’s using an interesting\nfeature known as “geo-IP blocking” so that only computers in certain geographical areas\nbecome infected. We have been able to determine that at a minimum the UK and Italy are\nbeing targeted, but the US, France, and Hong Kong are not.\n\n**Introduction**\n\n[There was an interesting Twitter thread a couple of months ago about a spam campaign](https://twitter.com/dvk01uk/status/898431354873851904)\ndelivering, at the time, an unknown “downloader” malware—a type of malware that specializes\nin distributing other malware families. Based on our analysis we believe that it is an update to\nthe downloader known as “SnatchLoader” which was briefly discussed on the KernelMode.info\nforum in January 2017 . As noted in that post, there seems to be some similarities between\n[SnatchLoader and a third family known as H1N1 Loader—though a detailed code comparison](http://asert.arbornetworks.com/flu-season-starting-early-the-h1n1-loader/)\nwas not performed. Its lineage aside, we haven’t seen any further discussions of\nSnatchLoader, so this post takes a look at the latest version that we’ve seen.\n\n\n-----\n\n**Samples**\n\n[The sample referenced in the original Twitter thread is available on VirusTotal. However, most](https://www.virustotal.com/en/file/41e698c7f1febdb53b9b7eae0f48fd93949602d0631d6f6b7dc0768958f7107a/analysis/)\nof our static analysis was performed on an updated version of the “core DLL” with a\n[compilation date of 2017-10-04. This DLL is also on VirusTotal and was first seen there on](https://www.virustotal.com/en/file/075420f10a1b4fc7302c5e95e578e8397b93019acc0f7f018dc7453a9266e17e/analysis/)\n2017-10-11.\n\n**Windows API Calls**\n\nAll calls to the Windows API are done at run time via function name hashing. The hashing\nalgorithm is a combination of rotate left (ROL) and XOR operations. An example\n[implementation in Python can be found on GitHub. Here is a list of some API function names](https://github.com/tildedennis/malware/blob/master/snatch_loader/api_hash.py)\nand their corresponding hashes:\n\nRtlZeroMemory -> 0x6b6c652b\nCreateMutexW -> 0x43725043\nInternetConnectA -> 0x1d0c0b3e\n\n**Static Config**\n\nA static config is stored encrypted in a PE section of the DLL--so far, we’ve seen two names\nfor this section: .idata and .xdata.:\n\n\n-----\n\nThe first DWORD\n\n\nThe first DWORD of this section (0x99a8 in the screenshot) is used as a seed to a key\ngeneration function.\n\n[A Python implementation of this function is available on GitHub. The generated key is used](https://github.com/tildedennis/malware/blob/master/snatch_loader/decrypt_cfg.py)\nwith RC4 to decrypt the remaining data. The decrypted config can be separated into two\nchunks. The first chunk is XML-like and looks like this (whitespace has been added for\nreadability):\n\n\n-----\n\nSRV is the command and control\n\n\nSRV is the command and control (C2) URL, TIME is the phone home poll interval in minutes,\nNAME is a campaign identifier (02.10 likely means October 2nd), and KEY is used to encrypt\nphone home communications. The second config chunk is an RSA certificate used for\nsignature checking of downloaded data.\n\n**Command and Control**\n\nSo far, all the C2 URLs we’ve observed are HTTPS. However, using a debugger, we can\nmodify the communications to use HTTP and see what a phone home looks like in plaintext:\n\n\n-----\n\nThe POST data is encrypted\n\nThe POST data is encrypted using four layers:\n\n1. RC4 using KEY from the config\n2. Base64\n3. Character substitutions\n4. Split up into 64-byte chunks with “\\r\\n” delimiters\n\nThere are three character substitutions and they are reversible:\n\n+ to –\n/ to _\n. to =\n\n\n-----\n\nThe response data is encrypted similarly but without layer 4. Communications are broken up\ninto four request types:\n\n1. Get dynamic config\n2. Send system information\n3. Command poll\n4. Send command results\n\n**Get Dynamic Config Request**\n\nThe plain text version of the “get dynamic config” request looks like this:\n```\nreq=0&guid=FCD08AEE3C0E9409&name=02.10&trash=ulbncmamlxwjakbnbmaklvvhamathrgsfrpbsfrfqeq\n\n```\nIts pieces are:\n\nreq – request type\nguid – bot ID\nname – NAME from static config\ntrash – random characters of random length\n\nAn example response looks like this:\n```\nSUCCESS|<CFG>\n<SRV>https://lookmans[.]eu/css/order.php|https://vertasikupper[.]eu/css/order.php</SRV>\n<TIME>120</TIME><NAME>02.10</NAME><KEY>547bnw47drtsb78d3</KEY></CFG>|\n\n```\nThis response can be separated into two fields: the status field and the data portion. Here the\nstatus field is “SUCCESS” and the data portion is encapsulated in the “<CFG> block”—this\nconfig is called the DYNAMIC config in the code.\n\n**Send System Information Request**\n\nThe second phone home request sends a bunch of system information and it looks like this:\n```\nreq=1&guid=FCD08AEE3C0E9409&name=02.10&win=9&x64=1&adm=1&det=0&def=0&nat=1&usrn=SYSTEM&c\nPC&uagn=Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; WOW64; Trident/4.0; SLCC2;\n.NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0;\n.NET4.0C; .NET4.0E)&sftl=AddressBook|Connection\nManager|DirectDrawEx|Fontcore|IE40|IE4Data|IE5BAKEX|IEData|MobileOptionPack|SchedulingAg\n[System\nProcess]\\r\\nSystem\\r\\nsmss.exe\\r\\ncsrss.exe\\r\\nwininit.exe\\r\\ncsrss.exe\\r\\nwinlogon.exe\\\n\n```\nIts pieces are:\n\nreq – request type\nguid – bot ID\nname – NAME from the config\nwin – Windows version\n\n\n-----\n\nx64 – is 64-bit architecture\nadm – is admin\ndet – anti-analysis related\ndef – anti-analysis process name detected\nnat – has an RFC1918 IP address\nusrn – username\ncmpn – computer name\nuagn – user agent\nsftl – software listing from the Uninstall key in the registry\nprcl – process listing\ntrash – random characters of random length\n\nA response looks like this:\n```\nSUCCESS|\n\n```\n**Command Poll Request**\n\nA command poll request looks like the “get dynamic config” request except the req number is\n2. An example response looks like this:\n```\nSUCCESS|<TASK>20|1|2||MZ...\\x00\\x00</TASK>|\n\n```\nThis response has two fields with the first being a status field and the second field being the\ndata portion. The data here can be zero or more TASK blocks with the following fields:\n\ntask ID\ncommand type\ncommand arg1 (e.g. file type)\ncommand arg2 (e.g. hash value)\ncommand data (e.g. an executable file or URL)\n\nThe main functionality of SnatchLoader is to download and load additional malware families so\nmost of the command types and arguments are in support of doing that in various ways\n(executed normally, executed via rundll32, or injected into explorer.exe). In this example, the\ncommand is to extract the embedded executable file and execute it normally. Some of the\nother supported commands are:\n\n[Plugin functionality (so far, we’ve only seen a Monero crypto currency mining plugin)](https://www.virustotal.com/#/file/142753b36c6fc9b29ba5f2ca3464e42c7fa1f70c7d165c7d446f2ab58a66a9b9/detection)\nUpdate config\nUpdate self\n\n**Send Command Results Request**\n\nThe last phone home type is used to send the results of a command:\n```\nreq=3&guid=FCD08AEE3C0E9409&name=02.10&results=&trash=pffebxmawlawigdawkifcymbxmawlgebxl\n\n```\n\n-----\n\nIt is similar to the command poll request except the req number is 3 and an additional\nparameter (results) has been added. There is no response content from the C2 for this\nrequest.\n\n**Geo-Blocking and Current Payload**\n\nAn interesting characteristic of the C2 servers we’ve looked at so far is that they seem to be\nperforming some sort of geo-blocking based on source IP addresses. While trying to interact\nwith them via TOR or VPN exit nodes in the US, France, or Hong Kong the servers responded\nwith “404 Not found” errors. But, using VPN exit nodes in the UK and Italy, the C2 responded\naffirmatively. In general, geo-blocking isn’t a novel feature, but it isn’t particularly common. At\nthe time of writing, the analyzed SnatchLoader botnet was distributing Ramnit—an info\nstealing and banking malware. It has a compilation date of 2017-10-13 and is available on\n[VirusTotal.](https://www.virustotal.com/en/file/789c129a7d5815d81e324a065a8a50091b25f6e9d9f24d4a34cd2f0e2abdaa8d/analysis/)\n\n**Conclusion**\n\nThis post has been an overview of a downloader malware known as SnatchLoader. We can\ntrace its origins as far back as January 2017 and it has been updated as recently as last week.\nIt is being delivered via spam campaigns and based on geo-blocking functionality it looks to be\ntargeting specific geographical areas. At the time of writing SnatchLoader is distributing the\nRamnit malware family to at least the UK and Italy. Thanks much to [Antelox,](https://twitter.com/Antelox) [reOnFleek,](https://twitter.com/reOnFleek)\n[XOR_Hex,](https://twitter.com/XOR_Hex) [mesa_matt, and](https://twitter.com/mesa_matt) [kafeine for help with the geo-IP blocking, distributed payload,](https://twitter.com/kafeine/)\nname origin, and general discussions on the family.\n\nPosted In\n\nAnalysis\nBotnets\nInteresting Research\nMalware\nReverse Engineering\nthreat analysis\n\n## Subscribe\n\n_Sign up now to receive the latest notifications and updates from NETSCOUT's ASERT._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-10-25 - SnatchLoader Reloaded.pdf"
    ],
    "report_names": [
        "2017-10-25 - SnatchLoader Reloaded.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536248,
    "ts_updated_at": 1743041173,
    "ts_creation_date": 1653765038,
    "ts_modification_date": 1653765038,
    "files": {
        "pdf": "https://archive.orkl.eu/5e19af2d56ca7c3c5758de19af18dbcdbed5b606.pdf",
        "text": "https://archive.orkl.eu/5e19af2d56ca7c3c5758de19af18dbcdbed5b606.txt",
        "img": "https://archive.orkl.eu/5e19af2d56ca7c3c5758de19af18dbcdbed5b606.jpg"
    }
}