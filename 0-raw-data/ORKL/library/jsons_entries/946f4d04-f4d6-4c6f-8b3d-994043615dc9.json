{
    "id": "946f4d04-f4d6-4c6f-8b3d-994043615dc9",
    "created_at": "2023-01-12T15:06:44.696255Z",
    "updated_at": "2025-03-27T02:16:46.991799Z",
    "deleted_at": null,
    "sha1_hash": "26bc80cbc13a18ae4c9adf61578c431d8fe6f845",
    "title": "2022-05-20 - [RE027] China-based APT Mustang Panda might have still continued their attack activities against organizations in Vietnam",
    "authors": "",
    "file_creation_date": "2022-05-28T15:24:19Z",
    "file_modification_date": "2022-05-28T15:24:19Z",
    "file_size": 3191348,
    "plain_text": "# [RE027] China-based APT Mustang Panda might still have continued their attack activities against organizations in Vietnam\n\n**blog.vincss.net/2022/05/re027-china-based-apt-mustang-panda-might-have-still-continued-their-attack-activities-**\nagainst-organizations-in-Vietnam.html\n\n## 1. Executive Summary\n\nAt VinCSS, through continuous cyber security monitoring, hunting malware samples and\nevaluating them to determine the potential risks, especially malware samples targeting\n[Vietnam. Recently, during hunting on VirusTotal's platform and performing scan for specific](https://www.virustotal.com/)\nbyte patterns related to the Mustang Panda (PlugX), we discovered a series of malware\nsamples, suspected to be relevant to APT Mustang Panda, that was uploaded from Vietnam.\n\nAll of these samples share the same name as “log.dll” and have a rather low detection rate.\n\nBased on the above information, we infer that there is a possibility that malware has been\ninfected in certain orgs in Vietnam, so we decided to analyze these malware samples. During\nanalysis based on the detected indicators we continue to investigate and set the scenario of\n\n\n-----\n\nthe attack campaign.\n\nA general overview of the execution flow demonstrated as follow:\n\nOur blog includes:\n\nTechnical analysis of the log.dll file.\nTechnical analysis of shellcode decrypted from log.dat.\nAnalyze PlugX Dll as well as decrypt PlugX configuration information.\n\n## 2. Analyze the log.dll\n\nIn the list of hunted samples above, we choose the one with hash:\n[3171285c4a846368937968bf53bc48ae5c980fe32b0de10cf0226b9122576f4e](https://www.virustotal.com/gui/file/3171285c4a846368937968bf53bc48ae5c980fe32b0de10cf0226b9122576f4e/detection)\n\nThis sample was submitted to VirusTotal from Vietnam on 2022-04-25 14:04:36 UTC\n\n\n-----\n\nThe information from the Rich Header suggests that it is likely compiled with Visual Studio\n**2012/2013:**\n\nBy checking the sections information, we can see that it is packed or the code is obfuscated:\n\nSample has the original name ljAt.dll, and it exports two functions LogFree and LogInit:\n\n\n-----\n\nLoad sample into IDA, analyze the code of the two functions above:\n\n**LogFree function:**\n\nLooking at this function, it can be seen that its code has been completely obfuscated by\n[Obfuscator-LLVM, using the](https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html) [Control Flow Flattening technique:](https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening)\n\nAfter further analysis, I found that this function has no special task.\n\n**LogInit function:**\n\nThis function will call the LogInit_0 function:\n\n\n-----\n\nSimilar to the above, the code at the LogInit_0 function has also been completely\nobfuscated, it takes a long time for IDA to decompile the code of this function:\n\nThe primary task of the LogInit_0 function is to call the function\n**f_read_content_of_log_dat_file_to_buf for reading the content of log.dat file and execute**\nthe decrypted shellcode:\n\n\n-----\n\n**f_read_content_of_log_dat_file_to_buf’scode is also completely obfuscated:**\n\nThe major task of this function as the following:\n\nCall the GetModuleHandleW function to retrieve the handle of kernel32.dll.\nCall the GetProcAddress function to get the addresses of the APIs: VirtualAlloc,\n**GetModuleFileNameA, CreateFileA, ReadFile.**\nUse the above APIs to retrieve the path to the log.dat file and read the contents of this\nfile into the allocated memory.\n\n\n-----\n\nDecode the contents of log.dat into shellcode so that this shellcode is then executed\nby the call from the LogInit_0 function.\n\n## 3. Shellcode analysis\n\nBased on the information analyzed above, we know that the log.dll file will read the content\nfrom the log.dat file and decrypt it into shellcode for further execution. Relying on this\nindicator, we continue to hunt log.dat file on VirusTotal which restrict the scope of\nsubmission source from Vietnam.\n\nThe results are following:\n\nWith the above results, at the time of analysis, we selected the log.dat file\n[(2de77804e2bd9b843a826f194389c2605cfc17fd2fafde1b8eb2f819fc6c0c84) was submitted](https://www.virustotal.com/gui/file/2de77804e2bd9b843a826f194389c2605cfc17fd2fafde1b8eb2f819fc6c0c84/detection)\nto VirusTotal on 2022-04-20 12:33:19 UTC (5 days before the above log.dll file).\n\n\n-----\n\nDebugging and dump the decrypted shellcode look like this:\n\nI use two tools, [FLOSS and](https://github.com/mandiant/flare-floss) [scdbg to get an overview of this shellcode. The results can be](http://sandsprite.com/blogs/index.php?uid=7&pid=152)\nseen in the screenshots below:\n\n\n-----\n\nWith the results obtained above, it can be seen that this shellcode will perform memory\nallocation and then call the RtlDecompressBuffer function to decompress the data with the\ncompression format is COMPRESSION_FORMAT_LZNT1.\n\nBy using IDA to analyze this shellcode, its main task is to decompress a Dll into memory and\ncall the exported function of this Dll to execute. The function that does this task is named\n**f_load_dll_from_memory:**\n\nThe code in this function will first get the base address of kernel32.dll based on the precalculated hash value is 0x6A4ABC5B. This hash value has also been mentioned by us in\nthis analysis.\n\n\n-----\n\nNext it will retrieve the address of GetProcAddress:\n\n[By using the stackstring technique, the shellcode constructs the names of the APIs and gets](https://www.mandiant.com/resources/automatically-extracting-obfuscated-strings)\nthe addresses of the following API functions:\n\n\n-----\n\nNext, the shellcode performs a memory allocation (compressed_buf) of size 0x2E552, then\nreads data from offset 0x1592 (on disk) and executes an xor loop with a key is 0x72 to fill\ndata into the compressed_buf. In fact, the size of compressed_buf is 0x2E542, but its first\n16 bytes are used to store information about signature, uncompressed_size,\n**compressed_size, so 0x10 is added.**\n\nShellcode continues to allocate memory (uncompressed_buf) of size 0x4C000 and calls\nthe RtlDecompressBuffer function to decompress the data at the compressed_buf into\n**uncompressed_buf with the compression format is COMPRESSION_FORMAT_LZNT1.**\n\n\n-----\n\nBased on the above analysis results, it is easy to get the extracted Dll file (however, the file\nheader information was destroyed):\n\n[Fix the header information and check with PE-bear, this Dll has the original name is](https://github.com/hasherezade/pe-bear-releases)\n**RFPmzNfQQFPXX and only exports one function named Main:**\n\n\n-----\n\nBack to the shellcode, after decompressing the Dll into memory, it will perform the task of a\nloader to map this Dll into a new memory region. Then, call to the exported function (here is\nthe Main function) to perform the the main task of malware:\n\n**_Note: At the time of analyzing this shellcode, we have not yet confirmed it is a variant of the_**\n_PlugX malware, but only raised doubts about the relationship. It was only when we analyzed_\n_the above extracted Dll, then we confirmed for sure that this was a variant of PlugX and_\n_renamed the fields in the struct for understandable reasons as screenshot above._\n\n## 4. Analyze the extracted Dll\n\nWe will not go into detailed analysis of this Dll, but only provide the necessary information to\nprove that this is a PlugX variant as well as the process of decrypting the configuration\ninformation that the malware will be used.\n\n**4.1. How PlugX calls an API function**\n\nIn this variant, information about API functions is stored in xmmword, then loaded into the\n**xmm0 (128-bit) register, the missing part of the function name will be loaded through the**\nstack. The malicious code gets the handle of the Dll corresponding to these API functions,\n\n\n-----\n\nthen uses GetProcAddress function to retrieve the address of the specified API function to\nuse later:\n\n**4.2. Create main thread to execute**\n\nThe malware adjusts the SeDebugPrivilege and SeTcbPrivilege tokens of its own process\nin order to gain full access to system processes. Then it creates its main thread, which is\nnamed “bootProc”:\n\n\n-----\n\n**4.3. Communicating with C2**\n\nThe malware can communicate with C2 via TCP, HTTP or UDP protocols:\n\n\n-----\n\n**4.4. Implemented commands**\n\nThe malware will receive commands from the attacker to execute the corresponding\nfunctions related to Disk, Network, Process, Registry, etc.\n\nThe entire list of commands as shown in the table below that the attacker can execute\nthrough this malware sample:\n\n\n**Command**\n**Group**\n\n\n**Sub-command** **Description**\n\n\nDisk 0x3000 Get information about the drives (type, free\nspace)\n\n0x3001 Find file\n\n0x3002 Find file recursively\n\n0x3004 Read data from the specified\nfile\n\n0x3007 Write data to the specified file\n\n0x300A Create a new directory\n\n0x300C Create a new process on\nhidden desktop\n\n\n-----\n\n0x300D File action (file\ncopy/rename/delete/move)\n\n0x300E Expand environment-variable\nstrings\n\nNethood 0xA000 Enumeration of network resources\n\nNetstat 0xD000 Retrieve a table that contains a list of TCP\nendpoints\n\n0xD001 Retrieve a table that contains\na list of UDP endpoints\n\n0xD002 Set the state of a TCP\nconnection\n\nOption 0x2000 Lock the workstation's display\n\n0x2001 Force shut down the system\n\n0x2002 Restart the system\n\n0x2003 Shut down the system safety\n\n0x2005 Display massage box\n\nPortMap 0xB000 Perform port mapping\n\nProcess 0x5000 Retrieve processes info\n\n0x5001 Retrieve modules info\n\n0x5002 Terminate specified process\n\nRegEdit 0x9000 Enumerate registry\n\n\n-----\n\n0x9001 Create registry\n\n0x9002 Delete registry\n\n0x9003 Copy registry\n\n0x9004 Enumerates the values of the\nspecified open registry key\n\n0x9005 Sets the data and type of a\nspecified value under a\nregistry key\n\n0x9006 Deletes a named value from\nthe specified registry key\n\n0x9007 Retrieves a registry value\n\nService 0x6000 Retrieves the configuration parameters of\nthe specified service\n\n0x6001 Changes the configuration\nparameters of a service\n\n0x6002 Starts a service\n\n0x6003 Sends a control code to a\nservice\n\n0x6004 Delete service\n\nShell 0x7002 Create pipe and execute command line\n\nSQL 0xC000 Get SQL data sources\n\n0xC001 Lists SQL drivers\n\n0xC002 Executes SQL statement\n\n\n-----\n\nTelnet 0x7100 Start telnet server\n\nScreen 0x4000 simulate working over the RDP Protocol\n\n0x4100 Take screenshot\n\nKeyLog 0xE000 Perform key logger function, log keystrokes\nto file\n\"%allusersprofile%\\MSDN\\6.0\\USER.DAT\"\n\n**4.5. Decrypt PlugX configuration**\n\nAs analyzed above, the malware will connect to the C2 address via HTTP, TCP or UDP\nprotocols depending on the specified configuration. So where is this config stored? With the\n[old malware samples that we have analyzed (1,](https://blog.vincss.net/2020/03/re012-phan-tich-ma-doc-loi-dung-dich-COVID-19-de-phat-tan-gia-mao-chi-thi-cua-thu-tuong-Nguyen-Xuan-Phuc.html) [2,](https://www.virustotal.com/gui/file/b9b5249403410df47990e6ffe4418c71aa0ed4e116f99a574526b527aa029f63/detection) [3,](https://www.virustotal.com/gui/file/24422cb0f7d728cc09141faf58798e307952657f3624ea11b7cae6e743d56fd6/detection) [4), the PlugX configuration is usually](https://www.virustotal.com/gui/file/b9b5249403410df47990e6ffe4418c71aa0ed4e116f99a574526b527aa029f63/detection)\nstored in the .data section with the size of 0x724 (1828) bytes.\n\nGoing back to the sample we are analyzing, we see that before the step of checking the\nparameters passed when the malware executes, it will call the function that performs the task\nof decrypting the configuration:\n\n\n-----\n\nDiving into this function, combined with additional debugging from shellcode, renaming the\nfields in the generated struct, we get the following information:\n\nPlugX's configuration is embedded in shellcode and starts at offset 0x69.\nThe size of the configuration is 0x0150C (5388) bytes.\nDecryption key is 0xB4.\n\n\n-----\n\nWith all the complete information as above, it is possible to recover the configuration\ninformation easily:\n\n**IP** **Port**\n\n86.78.23.152 53\n\n86.78.23.152 22\n\n86.78.23.152 8080\n\n86.78.23.152 23\n\n\n-----\n\nIn addition to the list of C2 addresses above, there is additional information related to the\ndirectory created on the victim machine to contain malware files as well as the name of the\nservice that can be created:\n\nTo make our life easier, I wrote a python script to automatically extract configuration\ninformation for this variant. The output after running the script is as follows:\n\n## 5. Conclusion\n\nCrowdStrike researchers first published information on Mustang Panda in June 2018, after\napproximately one year of observing malicious activities that shared unique Tactics,\nTechniques, and Procedures (TTPs). However, according to research and collect from many\ndifferent cybersecurity companies, this group of APTs has existed for more than a decade\nwith different variants found around the world. Mustang Panda, believed to be a APT group\nbased in China, is evaluated as one of the highly detrimental APT groups, applying\nsophisticated techniques to infect malware, aiming to gain as much long-term access as\npossible to conduct espionage and information theft.\n\nIn this blog we have analyzed the different steps the infamous PlugX RAT follows to start\nexecution and avoid detection. Thereby, it can be seen that this APT group is still active and\nconstantly looking for ways to improve their techniques. VinCSS will continue to search for\nadditional samples and variants that may be associated with this PlugX variant that we\nanalyzed in this article.\n\n## 6. References\n\n 7. Indicators of Compromise\n\n\n-----\n\nlog.dll - db0c90da56ad338fa48c720d001f8ed240d545b032b2c2135b87eb9a56b07721\n\nlog.dll - 84893f36dac3bba6bf09ea04da5d7b9608b892f76a7c25143deebe50ecbbdc5d\n\nlog.dll - 3171285c4a846368937968bf53bc48ae5c980fe32b0de10cf0226b9122576f4e\n\nlog.dll - da28eb4f4a66c2561ce1b9e827cb7c0e4b10afe0ee3efd82e3cc2110178c9b7a\n\nlog.dat - 2de77804e2bd9b843a826f194389c2605cfc17fd2fafde1b8eb2f819fc6c0c84\n\nDecrypted config:\n\n[+] Folder name: %ProgramFiles%\\BitDefender Update\n\n[+] Service name: BitDefender Crash Handler\n\n[+] Proto info: HTTP://\n\n[+] C2 servers:\n\n86.78.23.152:53\n\n86.78.23.152:22\n\n86.78.23.152:8080\n\n86.78.23.152:23\n\n[+] Campaign ID: 1234\n\n\n-----\n\nlog.dat - 0e9e270244371a51fbb0991ee246ef34775787132822d85da0c99f10b17539c0\n\nDecrypted config:\n\n[+] Folder name: %ProgramFiles%\\BitDefender Update\n\n[+] Service name: BitDefender Crash Handler\n\n[+] Proto info: HTTP://\n\n[+] C2 servers:\n\n86.79.75.55:80\n\n86.79.75.55:53\n\n86.79.75.46:80\n\n86.79.75.46:53\n\n[+] Campaign ID: 1234\n\nlog.dat - 3268dc1cd5c629209df16b120e22f601a7642a85628b82c4715fe2b9fbc19eb0\n\nDecrypted config:\n\n[+] Folder name: %ProgramFiles%\\Common Files\\ARO 2012\n\n[+] Service name: BitDefender Crash Handler\n\n[+] Proto info: HTTP://\n\n[+] C2 servers:\n\n86.78.23.152:23\n\n86.78.23.152:22\n\n86.78.23.152:8080\n\n86.78.23.152:53\n\n[+] Campaign ID: 1234\n\n\n-----\n\nlog.dat - 02a9b3beaa34a75a4e2788e0f7038aaf2b9c633a6bdbfe771882b4b7330fa0c5\n(THOR PlugX)\n\nDecrypted config:\n\n[+] Folder name: %ProgramFiles%\\BitDefender Handler\n\n[+] Service name: BitDefender Update Handler\n\n[+] Proto info: HTTP://\n\n[+] C2 servers:\n\nwww.locvnpt.com:443\n\nwww.locvnpt.com:8080\n\nwww.locvnpt.com:80\n\nwww.locvnpt.com:53\n\n[+] Campaign ID: 1234\n\n_[Click here for Vietnamese version.](https://blog.vincss.net/2022/05/re027-nhom-apt-mustang-panda-co-the-van-dang-tiep-tuc-hoat-dong-tan-cong-vao-cac-to-chuc-tai-Vietnam.html)_\n\n**Dang Dinh Phuong – Threat Hunter**\n\n**Tran Trung Kien (aka m4n0w4r) - Malware Analysis Expert**\n\n**R&D Center - VinCSS (a member of Vingroup)**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-20 - [RE027] China-based APT Mustang Panda might have still continued their attack activities against organizations in Vietnam.pdf"
    ],
    "report_names": [
        "2022-05-20 - [RE027] China-based APT Mustang Panda might have still continued their attack activities against organizations in Vietnam.pdf"
    ],
    "threat_actors": [
        {
            "id": "1691c25f-1aa4-4168-8ce2-7aa8f23246e7",
            "created_at": "2024-06-04T02:03:07.724221Z",
            "updated_at": "2025-03-27T02:05:17.284601Z",
            "deleted_at": null,
            "main_name": "BRONZE PRESIDENT",
            "aliases": [
                "Mustang Panda ",
                "Red Lich ",
                "Temp.Hex ",
                "HoneyMyte "
            ],
            "source_name": "Secureworks:BRONZE PRESIDENT",
            "tools": [
                " Cobalt Strike",
                " ORat",
                " PlugX",
                " RCSession",
                "China Chopper"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536004,
    "ts_updated_at": 1743041806,
    "ts_creation_date": 1653751459,
    "ts_modification_date": 1653751459,
    "files": {
        "pdf": "https://archive.orkl.eu/26bc80cbc13a18ae4c9adf61578c431d8fe6f845.pdf",
        "text": "https://archive.orkl.eu/26bc80cbc13a18ae4c9adf61578c431d8fe6f845.txt",
        "img": "https://archive.orkl.eu/26bc80cbc13a18ae4c9adf61578c431d8fe6f845.jpg"
    }
}