{
    "id": "1a9a0b5e-c55b-43dc-9ccf-c2e83f1d7805",
    "created_at": "2023-01-12T15:03:44.944037Z",
    "updated_at": "2025-03-27T02:05:53.298368Z",
    "deleted_at": null,
    "sha1_hash": "de705fc06b0f59521d651a93c7ae47ce0b759e70",
    "title": "2022-03-04 - HermeticWiper-FoxBlade Analysis (in-depth)",
    "authors": "",
    "file_creation_date": "2022-05-28T00:26:45Z",
    "file_modification_date": "2022-05-28T00:26:45Z",
    "file_size": 1821836,
    "plain_text": "# HermeticWiper/FoxBlade Analysis (in-depth)\n\n**eln0ty.github.io/malware analysis/HermeticWiper/**\n\n4 minute read\n\n\nMarch 4, 2022\n\n\nOn February 23 during the war between Russia and Ukrainian, A malware which is targeting Ukrainian\ninfrastructure (windows devices) by Russian Federation forces has since been observed in the\nneighboring countries of Latvia and Lithuania. HermeticWiper makes a system inoperable by corrupting\nits data by manipulating the MBR resulting in subsequent boot failure. Malware artifacts suggest that the\nattacks had been planned for several months.\n\n## Sample Overview\n\nSHA256: `0385EEAB00E946A302B24A91DEA4187C1210597B8E17CD9E2230450F5ECE21DA`\n\nThe digital certificate is issued under the company name ‘Hermetica Digital Ltd’ and valid as of April\n2021.\n\n## Get Privileges\n\nFirst, the malware fetches the command line arguments an converts it to integer then gets the infected\nsystem time.\n\n\n-----\n\nMalware gets access token for the current process and tries to get executable file path. Here is a small\ntrick.\n\nIf the file name can’t be obtained, the `c letter is used by default (it’s the expected one). If the sample`\nhas a different name, then some bytes of the string get placed somewhere unexpected on the stack,\nalmost certainly leading to a crash later on.\n\nthe call to `CharLowerW ensures the comparison is made using a lower-case “c”, as can be seen in the`\nscreenshot below.\n\n\n-----\n\nThen `LookUpPriviledgevalueW API is being called for accessing privilege` `SeShutdownPrivilege &`\n```\nSeBackupPrivilege on infected system.\n\n## Dropped payload\n\n```\nThe malware determines whether the system is x64 or x32.\n\nThen it gets information about the operating system version with `dwMajorVersion &`\n```\ndwMinorVersion .\n\n```\nIn our case, the wiper checks if windows version is vista or higher according to (6.0 is windows vista).\n\nAccording to these information, it drops the appropriate driver from `RCDATA which is stored in the`\nresources section of the PE file. If the operation failed, the malware terminates.\n\n\n-----\n\nThis is a view from Resource Hacker tool.\n\nThen it sets `CrashDumpEnabled to` `0 to prevent windows from writing a log file if it stops`\nunexpectedly.\n\n\n-----\n\nThen it calls `ReadWrite_IO_on_disk which performs read write operations on disk using`\n```\nDeviceIoControl API.\n\n```\nThe Malware creates `\\Drivers dir in` `system32 directory path to drop its malicious driver.`\n\nSo the full path is `C:\\Windows\\System32\\Drivers\\EPMNTDRV.sys .`\n\n## Loading driver as a service\n\nThe malware gets privilege to `SeLoadDriverPrivilege to take access to load a driver as a service.`\n\n\n-----\n\nI will give you the API sequence used to start this process: `OpenSCManagerW() =>` `OpenServiceW()`\n=> `CreateServiceW() =>` `StartServiceW()`\n\nAnd so the driver process should be up and running.\n\n\n-----\n\n## VSS service disabling\n\nAnother interesting capability presented by the sample is to disbable the shadow copy service in order\nto avoid even a partial recovery of the files.\n\n## Wiping Partitions\n\nIn this step, malware is tampering and wiping the disk data, by carrying out a cycle of 100 iterations on\nthe `\\\\.\\PhysicalDrive object that is can access. The permission is gained by` `DeviceIoControl`\nwindows API.\n\nIn this function, malware gets handle to `0x70050 (IOCTL_DISK_GET_DRIVE_LAYOUT_EX) from`\nfunction `DeviceIoControl with` `IoControlCode to get the device number.`\n\n\n-----\n\nIn `alloc_and_read_operations_on_disk function, malware reads operations using` `CreateFileW &`\n```\nDeviceIoControl used for perform task on NTFS based disk for which\n\n```\n**FSCTL_GET_NTFS_VOLUME_DATA**\n\n## Global Folder Options\n\nThe malware modifies a couple of `GlobalFolderOptions to achieve more stealth.`\n```\n   showCompColor : Displays compressed and encrypted NTFS files in color.\n   ShowInfoTip : Shows pop-up descriptions for folder and desktop items.\n\n```\n\n-----\n\n## Encrypting system files\n\nAfter this preparation, the malware calls some functions to enumerate all important data on the disk and\ncorrupt it.\n\nIf the system is FAT32, the malware overwrites random data on disk.\n\nIn this step, Disk is gonna die. Look at details from the function\n```\nmw_encrypt_by_overwrite_random_data that overwrites disk.\n\n```\n\n-----\n\nOtherwise, If the system is NTFS, the malware gets system attributes like `$Bitmap &` `$LogFile that`\nimpacts **Master Boot Record **(MBR).\n\n\n-----\n\nThe so-called overwrite method is very brutal and prevents any way of data recovery.\n\nOf course, we don’t need to mention that these methods are used to encrypt “Documents & Desktop &\nAppData” directories.\n\n## Anti Forensics\n\nThe malware used anti-forensics techniques to corrupt logs file and prevent DFIR team from tracking\nwhat was happening on disk.\n\n\n-----\n\nFirst, malware reads `logs file on infected system by passing` `\\\\\\\\?`\n```\n\\\\C:\\\\Windows\\\\System32\\\\winevt\\\\Logs as argument then encrypts it.\n\n## Multi Threading\n\n```\nFinally I want to draw your attention to the fact that the malware uses multi-threading to make the job\nefficient and hurt victim well. As usual the bad guys are dedicated to their work.\n\nAs we see here, `WaitForSingleObject function is used to force the malware to wait infinitely until all`\nencryption threads finish.\n\n\n-----\n\n## Conclusion\n\nHowever, during these last critical hours, as real war has been foreseen by the proliferation of weapons\nof cyber sabotage, such as DDoS attacks and wipers, like this one just analyzed. Many organizations\nare shocked, panicked, fall and lose almost all of their information. This is the first time for me to see this\ntragedy. I solved this serious wiper malware and hope to help our community to defend against bad\nguys. Now, we have a completely infected system. We can’t get back anything we’ve lost, just delete\neverything and start over.\n\n## IOCs\n\n**Name** **sha256**\n\nSample hash 0385EEAB00E946A302B24A91DEA4187C1210597B8E17CD9E2230450F5ECE21DA\n\n\n-----\n\n**Name** **sha256**\n\nDRV_X64 E5F3EF69A534260E899A36CEC459440DC572388DEFD8F1D98760D31C700F42D5\n\nDRV_X86 B01E0C6AC0B8BCDE145AB7B68CF246DEEA9402FA7EA3AEDE7105F7051FE240C1\n\nDRV_XP_X64 B6F2E008967C5527337448D768F2332D14B92DE22A1279FD4D91000BB3D4A0FD\n\nDRV_XP_X86 FD7EACC2F87ACEAC865B0AA97A50503D44B799F27737E009F91F3C281233C17D\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-04 - HermeticWiper-FoxBlade Analysis (in-depth).pdf"
    ],
    "report_names": [
        "2022-03-04 - HermeticWiper-FoxBlade Analysis (in-depth).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535824,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1653697605,
    "ts_modification_date": 1653697605,
    "files": {
        "pdf": "https://archive.orkl.eu/de705fc06b0f59521d651a93c7ae47ce0b759e70.pdf",
        "text": "https://archive.orkl.eu/de705fc06b0f59521d651a93c7ae47ce0b759e70.txt",
        "img": "https://archive.orkl.eu/de705fc06b0f59521d651a93c7ae47ce0b759e70.jpg"
    }
}