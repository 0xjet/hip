{
    "id": "0736874e-bb6b-44b7-9cef-0c51e0e9e565",
    "created_at": "2023-01-12T15:08:16.683667Z",
    "updated_at": "2025-03-27T02:15:18.870318Z",
    "deleted_at": null,
    "sha1_hash": "d4c211d2256904781c0b0b5c6270b1520bd83a2e",
    "title": "2021-08-09 - A BazarLoader DGA that Breaks Down in the Summer",
    "authors": "",
    "file_creation_date": "2022-05-27T21:08:51Z",
    "file_modification_date": "2022-05-27T21:08:51Z",
    "file_size": 714170,
    "plain_text": "# A BazarLoader DGA that Breaks Down in the Summer\n\n**[johannesbader.ch/blog/a-bazarloader-dga-that-breaks-during-summer-months/](https://johannesbader.ch/blog/a-bazarloader-dga-that-breaks-during-summer-months/)**\n\n[André Tavares sent me a Bazar Loader sample whose Domain Generation Algorithm (DGA)](https://twitter.com/andretavare5)\nshows some interesting behavior. In May, it generates valid domain names with the\neponymous top level domain .bazar:\n\n\n-----\n\nBut as soon as June comes around, some generated domains contain invalid characters:\n\n\n-----\n\nAnd as it gets to July, all domain names are invalid (with very few exceptions):\n\n\n-----\n\nThe DGA also fails during August and September. But when October rolls around, all\ndomains are valid again. This continues until next June, when the DGA has problems all over\nagain.\n\nThis short blog post explores what causes the DGA to stop working properly in the summer,\nof all times.\n\n## The Sample Examined\n\nI reverse engineered the DGA of the following sample:\n\n**MD5**\n5f11f2db1295fa419b190bd7478d9b23\n\n**SHA1**\n96d6c37fa0046a8dc1c520249dc94122e0fb3f52\n\n**SHA256**\n86d2aa04988befc74eccca5d99550f67093969b31aafa11cdce3476a4c59ba74\n\n**Size**\n\n\n-----\n\n248 KB (254474 Bytes)\n\n**Compile Timestamp**\n2021-07-13 08:22:30 UTC\n\n**Links**\n[MalwareBazaar,](https://bazaar.abuse.ch/sample/86d2aa04988befc74eccca5d99550f67093969b31aafa11cdce3476a4c59ba74/) [Cape,](https://www.capesandbox.com/analysis/172120/) [VirusTotal](https://www.virustotal.com/gui/file/86d2aa04988befc74eccca5d99550f67093969b31aafa11cdce3476a4c59ba74)\n\n**Filename**\n5f11f2db1295fa419b190bd7478d9b23.dll (MalwareBazaar), (VirusTotal)\n\n**Detections**\n**MalwareBazaar: BazaLoader, Virustotal: 47/75 as of 2021-08-05 11:35:35 -**\nGen:Variant.Razy.892983 (MicroWorld-eScan), Trojan.Agent (CAT-QuickHeal),\nBackdoor.Win64.Bazdor.ah (Sangfor), Backdoor:Win64/Bazdor.ae3c68af (Alibaba), Trojan (\n0057f6941 ) (K7GW), Trojan ( 0057f6941 ) (K7AntiVirus), W64/Trojan.FRTN-3244 (Cyren),\nWin64/BazarLoader.AP (ESET-NOD32), generic.ml (Paloalto), Backdoor.Win64.Bazdor.ah\n(Kaspersky), Gen:Variant.Razy.892983 (BitDefender), Win64:DropperX-gen [Drp] (Avast),\nGen:Variant.Razy.892983 (Ad-Aware), Gen:Variant.Razy.892983 (B) (Emsisoft),\nTrojan.Agent.Win64.8672 (Zillya), Artemis!Trojan (McAfee-GW-Edition), Trojan.Agent.dkxh\n(Jiangmin), TR/Redcap.ntozn (Avira), malware (ai score=88) (MAX), Win32.Troj.Undef.\n(kcloud) (Kingsoft), Trojan.Win64.Agent.oa (Gridinsoft), Trojan:Win64/Cobaltstrike.A!MSR\n(Microsoft), Backdoor.Win64.Bazdor.ah (ZoneAlarm), Gen:Variant.Razy.892983 (GData),\nTrojan.Win64.Convagent (VBA32), Gen:Variant.Razy.892983 (ALYac), Trojan.Bazar\n(Malwarebytes), Trojan.Agent!v7VRXZm6ckQ (Yandex), Trojan.Win64.Bazarloader (Ikarus),\nWin64:DropperX-gen [Drp] (AVG), Trj/CI.A (Panda)\n\nI have unpacked it to the following state:\n\n**MD5**\n7c64ea7c4a229414b6048d18ab0836fd\n\n**SHA1**\nf10621be9bfee0152931f7790c2cbff022611f62\n\n**SHA256**\nd15dbfb7ef0511556a3527cc98d09145a56302bdd19a6083ee6d007af3352434\n\n**Size**\n113 KB (116224 Bytes)\n\n**Compile Timestamp**\n2021-07-12 13:27:57 UTC\n\n**Links**\n[MalwareBazaar,](https://bazaar.abuse.ch/sample/d15dbfb7ef0511556a3527cc98d09145a56302bdd19a6083ee6d007af3352434/) [Cape,](https://www.capesandbox.com/analysis/175373/) [VirusTotal](https://www.virustotal.com/gui/file/d15dbfb7ef0511556a3527cc98d09145a56302bdd19a6083ee6d007af3352434)\n\n**Detections**\n\n\n-----\n\n**MalwareBazaar: BazaLoader, Virustotal: 40/75 as of 2021-08-05 19:07:37 -**\nTrojan.Win32.Razy.4!c (Lionic), Gen:Variant.Razy.891147 (MicroWorld-eScan),\nGen:Variant.Razy.891147 (FireEye), Backdoor.Bazdor.Win64.3 (Zillya),\nBackdoor:Win64/Bazdor.9312a6ac (Alibaba), Trojan ( 0057f6941 ) (K7GW), Trojan (\n0057f6941 ) (K7AntiVirus), W64/Trojan.QFLC-7900 (Cyren), Win64/BazarLoader.AP (ESETNOD32), Backdoor.Win64.Bazdor.ax (Kaspersky), Gen:Variant.Razy.891147 (BitDefender),\nGen:Variant.Razy.891147 (Ad-Aware), BehavesLike.Win64.Trojan.ch (McAfee-GW-Edition),\nGen:Variant.Razy.891147 (B) (Emsisoft), Trojan.Win64.Bazarloader (Ikarus),\nTR/Redcap.rlvgc (Avira), malware (ai score=81) (MAX), Win32.Hack.Undef.(kcloud)\n(Kingsoft), Trojan.Win64.Agent.oa (Gridinsoft), Trojan:Win32/Tiggre!rfn (Microsoft),\nGen:Variant.Razy.891147 (GData), Backdoor.Win64.Bazdor (VBA32),\nGen:Variant.Razy.891147 (ALYac), Trojan.Bazar (Malwarebytes),\nWin64.Backdoor.Bazdor.Ajls (Tencent), W64/BazarLoader.AP!tr (Fortinet), Trj/CI.A (Panda)\n\n## The Domain Generation Algorithm\n\nThe DGA can be easily be located in the unpacked sample based on the .bazar TLD, for\nexample with this Yara rule:\n```\nrule BazarDGA\n{\n  strings:\n    $bazar_tld= { 2E [4-12] 62 [4-12] 61 [4-12] 7A [4-12] 61 [4-12] 72 }\n  condition:\n    $bazar_tld\n}\n\n```\nThe rule triggers at the following location, which adds the top level domain to the generated\ndomain (pointed to by `rax ) at the end of the DGA function:`\n\nHere is how the DGA works:\n\n\n-----\n\n1. BazarLoader divides the letters – except J, which was omitted for unknown reasons –\n\ninto two character classes:\n\nthe 6 vowels aeiouy\nthe 19 consonants bcdfghklmnpqrstvwxz\n2. The two sets are then combined into all 2⋅6⋅19 ordered pairs that contain one vowel\n\nand one consonant: `ab,` `ba,` `eb,` `be,` `ib,` `bi,` `ob,` `bo, …,` `oz,` `zo,` `uz,`\n```\n  zu, yz, zy .\n\n```\n3. These 228 pairs are then rearranged with a permutation that is hard-coded into the\n\nmalware. The permutation is the seed of the BazarLoader DGA and offers the\npossibility to generate a different set of domains with the same algorithm. The\npermutation is stored as an array of 228 bytes that represent the one-line notation of\nthe permutation. So for example, a permutation of 27, 119, 38, … would place the first\npair `ab at position 27, the second pair` `ba at 119, and so on (0 being the first`\nposition).\n\n4. Four pairs are then picked from the 228 permutated pairs, and strung together to form\n\nthe 8 letter long second level domain. Which pairs are selected depends on the current\ndate. The date is formatted as `%m%y, where` `%m is the zero-padded month and` `%y`\nis the two digit year. For example, December 5, 2035 would be `1235 . The four digits,`\ne.g., 1, 2, 3 and 5, then define which pairs will be selected for the first, second, third\nand fourth pair respectively.\n\n5. The first pair is selected by first splitting the pairs into groups of 19 pairs. The first digit\n\nderived from the current date then serves as the index of the groups to select. Since\nthe first digit can only be 0 or 1, only two groups are possible 1\n\nBazarLoader then picks a pair at random from the 19 pairs of the given group.\n\n\n-----\n\n6. The second pair is selected like the first pair, except the groups are picked based on\n\nthe second date digit. This digit can be any value from 0 to 9, so ten different groups\nare possible:\n\n7. For the third pair, the groups only have a size of 4 pairs. Since the third date digit\n\nrepresents the decade, the same group will be selected for years to come.\n\n\n-----\n\n8. The fourth pair is also picked from groups of 4 pairs, based on the least significant\n\ndigit of the year.\n\n9. The four picked pairs are concatenated into an 8-letter second level domain, and the\n\ntop level domain `.bazar is appended.`\n\nAs can be seen from the illustrations above, pairs at higher positions are selected only as a\nsecond pair and only during the summer months. And that is exactly what causes the bug.\n\n## The Bug - A Faulty Permutation\n\nThe DGA is implemented exactly as described above. The hard-coded permutation,\nhowever, is incorrect:\n```\n 57 63 3A 29 25 0E 1E 5C 04 77 5F 37 02 03 28 51 \n 61 28 39 64 12 1C 49 30 3D 74 06 07 49 0B 10 33 \n 56 10 57 19 4A 3B 2C 2E 36 71 1B 68 24 15 67 5A \n 50 20 45 6E 4C 54 2F 2B 54 62 4A 0B 59 35 51 23 \n 4D 08 01 45 1A 0A 7B 27 72 55 0C 08 5B 1F 60 32 \n 3C 29 3B 2E 2A 70 3A 0F 17 48 14 2C 4B 25 4E 42 \n 44 15 03 05 7C 26 16 06 24 5A 0D 32 46 39 35 5F \n 4F 6F 11 0C 34 5B 47 59 4E 42 5D 5E 1C 66 52 53 \n 3F 30 38 21 44 18 00 58 56 1E 40 2A 4B 3E 55 13 \n 3E 65 05 0F 1D 09 36 21 22 6D 2D 12 6A 40 17 19 \n 3F 34 11 2F 5D 63 5E 6B 31 61 69 22 26 33 0D 7A \n 1D 4D 16 75 7D 0A 4F 02 07 64 79 58 14 1A 53 62 \n 0E 41 18 01 31 2B 47 1F 76 5C 09 04 60 43 37 13 \n 3D 3C 41 48 2D 43 52 38 73 27 23 46 4C 1B 50 6C \n 78 20 7E 00\n\n```\nFor the permutation to be valid, i.e., bijective, it would need to contain all numbers from\n```\n0x00 to 0xe3 (227). But the largest number in the above list of numbers is only 0x7E\n\n```\n(126). Possibly the wrong data type was chosen when generating the permutation. For\nexample, a signed char to store the numbers 1-228.\n\nInstead of permuting the pairs, the DGA places them all in the first 127 places. Some pairs\nwill therefore be overwritten by another pair placed in the same spot. For instance the first\npair `ab is placed at position` `0x57 (first number of the “permutation”) . But since` `0x57`\nappears a second time (35th number of the “permutation”), the pair `ab will be overwritten.`\n\n\n-----\n\nSimilarly, all spots above 127 are never filled. So with the actual permutation applied, the\nillustration for picking the second pair looks as follows, where `? denotes undefined`\nmemory:\n\nAll pairs in July, August and September are undefined and will likely result in invalid domains.\nIn June, only 13 out of 19 pairs are undefined, hence some domains come out correct. All\nother months are not affected by the bug.\n\n## Reimplementation in Python\n\n\n-----\n\nThe following Python script will generate all possible domains for a given date. When it is run\nfor months affected by the bug, the resulting domains will contain two `?? that represent`\ncharacters from undefined memory.\n\n\n-----\n\n```\nfrom datetime import datetime\nimport argparse\nfrom collections import namedtuple\nParam = namedtuple('Param', 'block idx')\npool = (\n  \"yzewevmeywreomvi\"\n  \"ekwyavygontowaer\"\n  \"udsoyrexvuamtyse\"\n  \"weesuvizpituiqow\"\n  \"uzoretzemuultiaz\"\n  \"icukoqiwolxuykos\"\n  \"upwiymitisneroxe\"\n  \"yxanlekyixxirasi\"\n  \"asxoapuxqaohezwo\"\n  \"oxdigyquziutpave\"\n  \"zohexyvyguqyqidy\"\n  \"ovynumunuwsusyen\"\n  \"xaatyvusivaripfy\"\n  \"oftesaysozuregin\"\n  \"alifkazaadytwuub\"\n  \"zuvoothymivazy\"\n)\npool +=(10*19*2 - len(pool))*\"?\"\ndef dga(date):\n  seed = date.strftime(\"%m%Y\")\n  params = [\n    Param(19, 0),\n    Param(19, 1),\n    Param(4, 4),\n    Param(4, 5)\n  ]\n  ranges = []\n  for p in params:\n    s = int(seed[p.idx])\n    lower = p.block*s\n    upper = lower + p.block\n    ranges.append(list(range(lower, upper)))\n  domains = set()\n  for indices in product(*ranges):\n    domain = \"\"\n    for index in indices:\n      domain += pool[index*2:index*2 + 2]\n    domain += \".bazar\"\n    domains.add(domain)\n  return domains\nif __name__ == \"__main__\":\n  parser = argparse.ArgumentParser()\n\n```\n\n-----\n\n```\n  parser.add_argument(\n    \"-d\", \"--date\", help=\"date used for seeding, e.g., 2020-06-28\",\n    default=datetime.now().strftime('%Y-%m-%d'))\n  args = parser.parse_args()\n  d = datetime.strptime(args.date, \"%Y-%m-%d\")\n  for domain in dga(d):\n    print(domain)\n\n## Characteristics of the DGA\n\n```\nThe following table summarizes the properties of the BazarLoader DGA when it is working as\nintended, i.e., October through May.\n\n**property** **value**\n\ntype TDD (time-dependent-deterministic)\n\ngeneration scheme arithmetic\n\nseed current date\n\ndomain change frequency every month\n\nunique domains per month 5776\n\nsequence random selection, might pick domains multiple times\n\nwait time between domains none\n\ntop level domain .bazar\n\nsecond level characters a-z, without j\n\nregex [a-ik-z]{8}.bazar\n\nsecond level domain length 8\n\n1. note that the letters used in the illustrations are randomly placed and not the actual\n\nletter pairs that BazarLoader uses. ↩\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-09 - A BazarLoader DGA that Breaks Down in the Summer.pdf"
    ],
    "report_names": [
        "2021-08-09 - A BazarLoader DGA that Breaks Down in the Summer.pdf"
    ],
    "threat_actors": [
        {
            "id": "761d1fb2-60e3-46f0-9f1c-c8a9715967d4",
            "created_at": "2023-01-06T13:46:38.269054Z",
            "updated_at": "2025-03-27T02:00:02.789278Z",
            "deleted_at": null,
            "main_name": "APT3",
            "aliases": [
                "TG-0110",
                "Group 6",
                "Buckeye",
                "Boyusec",
                "BORON",
                "BRONZE MAYFAIR",
                "Red Sylvan",
                "GOTHIC PANDA"
            ],
            "source_name": "MISPGALAXY:APT3",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3fff98c9-ad02-401d-9d4b-f78b5b634f31",
            "created_at": "2023-01-06T13:46:38.376868Z",
            "updated_at": "2025-03-27T02:00:02.818071Z",
            "deleted_at": null,
            "main_name": "Cleaver",
            "aliases": [
                "Cobalt Gypsy",
                "G0003",
                "Operation Cleaver",
                "Op Cleaver",
                "Tarh Andishan",
                "Alibaba",
                "TG-2889"
            ],
            "source_name": "MISPGALAXY:Cleaver",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "06f622cb-3a78-49cf-9a4c-a6007a69325f",
            "created_at": "2022-10-25T16:07:23.315239Z",
            "updated_at": "2025-03-27T02:02:09.733197Z",
            "deleted_at": null,
            "main_name": "APT 3",
            "aliases": [
                "APT 3",
                "Bronze Mayfair",
                "Buckeye",
                "Gothic Panda",
                "Group 6",
                "Operation Clandestine Fox",
                "Operation Clandestine Fox, Part Deux",
                "Operation Clandestine Wolf",
                "Operation Double Tap",
                "Red Sylvan",
                "TG-0110",
                "UPS Team"
            ],
            "source_name": "ETDA:APT 3",
            "tools": [
                "APT3 Keylogger",
                "Agent.dhwf",
                "BKDR_HUPIGON",
                "Backdoor.APT.CookieCutter",
                "Badey",
                "Bemstour",
                "CookieCutter",
                "Destroy RAT",
                "DestroyRAT",
                "DoublePulsar",
                "EXL",
                "EternalBlue",
                "HTran",
                "HUC Packet Transmit Tool",
                "Hupigon",
                "Hupigon RAT",
                "Kaba",
                "Korplug",
                "LaZagne",
                "MFC Huner",
                "OSInfo",
                "Pirpi",
                "PlugX",
                "RedDelta",
                "RemoteCMD",
                "SHOTPUT",
                "Sogu",
                "TIGERPLUG",
                "TTCalc",
                "TVT",
                "Thoper",
                "Xamtrav",
                "remotecmd",
                "shareip",
                "w32times"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536096,
    "ts_updated_at": 1743041718,
    "ts_creation_date": 1653685731,
    "ts_modification_date": 1653685731,
    "files": {
        "pdf": "https://archive.orkl.eu/d4c211d2256904781c0b0b5c6270b1520bd83a2e.pdf",
        "text": "https://archive.orkl.eu/d4c211d2256904781c0b0b5c6270b1520bd83a2e.txt",
        "img": "https://archive.orkl.eu/d4c211d2256904781c0b0b5c6270b1520bd83a2e.jpg"
    }
}