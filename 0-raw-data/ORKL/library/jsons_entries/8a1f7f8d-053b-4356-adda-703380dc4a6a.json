{
    "id": "8a1f7f8d-053b-4356-adda-703380dc4a6a",
    "created_at": "2023-01-12T15:04:14.381671Z",
    "updated_at": "2025-03-27T02:09:18.449944Z",
    "deleted_at": null,
    "sha1_hash": "4bb589550d60e1e0a656824bb00f7f604567a629",
    "title": "2021-05-07 - New Lemon Duck variants exploiting Microsoft Exchange Server",
    "authors": "",
    "file_creation_date": "2022-05-28T16:51:52Z",
    "file_modification_date": "2022-05-28T16:51:52Z",
    "file_size": 4155959,
    "plain_text": "# New Lemon Duck variants exploiting Microsoft Exchange Server\n\n**[news.sophos.com/en-us/2021/05/07/new-lemon-duck-variants-exploiting-microsoft-exchange-server/](https://news.sophos.com/en-us/2021/05/07/new-lemon-duck-variants-exploiting-microsoft-exchange-server/?cmp=30728)**\n\nRajesh Nataraj May 7, 2021\n\nIn March, Microsoft [published a set of critical fixes to Exchange Server following the](https://news.sophos.com/en-us/2021/03/09/critical-updates-dominate-march-2021-patch-tuesday-releases/)\n[discovery of ProxyLogon–an exploit that was stolen or leaked from researchers within hours](https://news.sophos.com/en-us/2021/03/15/dearcry-ransomware-attacks-exploit-exchange-server-vulnerabilities/)\nof its disclosure to Microsoft. The exploit is now widely available to cybercriminals, and\nunpatched and vulnerable Microsoft Exchange Servers continue to attract many threat actors\nto install cryptocurrency-miners, ransomware and to steal sensitive information from their\nenvironment.\n\n[Recently, we discovered that ProxyLogon has been added to an update to Lemon Duck, an](https://news.sophos.com/en-us/2020/08/25/lemon_duck-cryptominer-targets-cloud-apps-linux/)\nadvanced crypto miner malware. While many of these attacks follow a familiar approach\nalready documented by researchers, we discovered variants of Lemon Duck attacks that use\na collection of new approaches in their attempts to compromise vulnerable Exchange Server\ninstances. Because of commonalities across all of these variants, we believe they are part of\nthe same Lemon Duck campaign,\n\nSome of the more interesting aspects of these ProxyLogon-based Lemon Duck attacks\ninclude:\n\nThe deployment of multiple copies of the web shells dropped in the attack.\n\n\n-----\n\nThe installation of the miner payload as a Windows service to establish persistence,\nUse of an Oracle WebLogic server exploit used to attempt to move laterally to other\nservers on the network.\nIn some cases, the use of certutil (a Windows Certificate Services command-line\nutility) to download the Lemon Duck payload, which is launched using PowerShell.\nThe creation of a user account with remote desktop access.\nUpdates to Lemon Duck’s defense evasion code attempt to disable and remove even\nmore security products .\nIn one variant of this campaign, a Cobalt Strike beacon is delivered as part of the\npayload.\n\n## Exploiting Microsoft Exchange Server\n\nIn previous Lemon Duck campaigns targeting the Windows platform, the threat actor behind\nthe malware has downloaded and executed the miner malware through PowerShell. But in\nsome of these new campaigns, the attacker used certutil to download the malicious script\nand executables to the disk, and then used PowerShell to execute them.\n\nWe found several different flavors of the Lemon Duck attack targeting vulnerable Exchange\nServer instances. All exploited the IIS worker process (w3wp.exe) to execute commands on\nthe vulnerable Exchange Server target. The first method, which downloads a malicious\nPowerShell script from a URL ending in /mail.jsp?mail, is similar in attack vectors and code\nflow to the previously existing Lemon Duck campaign. This was the most common attack\nseen in our telemetry.\n\n\n-----\n\nThe initial compromise phase of two ProxyLogon-based Lemon Duck attacks.\nBut a few customers were targeted with other approaches—two of which abused the\n**certutil.exe utility. In the first of those, diagrammed above, certutil was abused to download**\na PowerShell script. In another variant, the attackers used certutil to directly download a\n\n\n-----\n\ncompiled Python executable payload and start it with Windows scheduler; the Python script\nin turn launches malicious PowerShell commands and downloads a Cobalt Strike beacon.\n\nWe also witnessed an attempted file-less attack, in which the Lemon Duck actor\nsent commands identical to the code used in script-based exploits to be directly executed by\nthe Windows command-line interface (cmd.exe), attempting to create a user and gain\nRemote Desktop access to the targeted servers. The username and password used in these\ncommands were identical to those used in the certutil-based attacks. This and other factors\nlead us to believe that these attacks were executed by the same threat actor.\n\n**Hiding the Web-Shell**\n\nHiding the webshell\nWe noticed several variants of China Chopper web shells used in this campaign—the same\nfamily of web shells seen in other ProxyLogon related attacks. Once the targeted Exchange\nserver was compromised, the attacker began to copy the initially-dropped web shell to\nmultiple different directories, and changed the attributes of the web shell files to make them\nhidden with read-only permission.\n\n**Disabling Security Products**\n\nIn some campaigns we’ve observed, Lemon Duck’s miner tries to uninstall security product\nfrom the machine by using WMI (Windows Management Instrumentation). In this campaign,\nthe attacker takes additional steps—using forced process kills (taskkill) to disable some\nsecurity products, and using commands to Windows’ service controller to stop and remove\nthe security products from the machine. Security products that have tamper protection\nfeatures are immune to these attacks.\n\n\n-----\n\nUninstall Security\n\n\nProducts\n**Cobalt Strike Beacon**\n\n\n-----\n\nIn [earlier versions of Lemon Duck, the threat actor delivered a compiled Python executable](https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/)\nto the compromised machine that included a variety of attack modules for lateral movement,\nincluding the Eternal Blue exploit, Mssql Bruteforce, and the PassTheHash attack.\n\nIn this campaign, the Python compiled executable doesn’t carry attack modules; instead, it\ndelivers Cobalt Strike payloads through a PowerShell script. A Cobalt “beacon” is loaded\ninto the newly spawned PowerShell process memory, and then it attempts to communicate\nwith a command and control server. Unfortunately, the C&C server was down during our\ninvestigation.\n\nAdditionally, we noticed that these executables are delivered only in this campaign\n(*.hwqloan.com). It is impossible to precisely determine the motive of the attacker, but we\nassume that they are testing out new attack vectors before deploying them widely.\n\nCobalt\n\nStrike Beacon – Configuration\n\n\n-----\n\nCobalt C&C Communication\n**Oracle WebLogic Server – Remote Code Execution**\n\nOracle WebLogic is a Java EE application server used by enterprises and it is supported\nacross multiple operating systems. these unpatched vulnerabilities in these servers are\nalways a potential target for many threat-actors to mine cryptocurrency. This attack vector is\na recent update and available across all Lemon Duck campaigns.\n\nThe attack exploits CVE-2020-14882, a remote code execution vulnerability, to download\nand execute a malicious script on vulnerable WebLogic servers. Both Windows and Linux\nplatforms are targeted by this threat actor, using exploits crafted for each.\n\nThe attacker can easily find WebLogic servers through a port scan on (7001/TCP), followed\nby sending out a specially crafted packet. The server responds to the request with the\nproduct version information. If the version matches those vulnerable to the exploit—\n10.3.6.0.0, 12.1.3.0.0, 12.2.1.3.0, 12.2.1.4.0 and 14.1.1.0.0— the attacker attempts to\nexecute the exploit code through an HTTP request.\n\n\n-----\n\nOracle WebLogic Server Exploitation – CVE-2020-14882\n**Miner Installation**\n\nAs in previous campaigns, Lemon Duck’s Miner installation happens in the final stage of the\ncompromise. The attacker uses certutil to download both the miner component and a 3rd\n[party utility called NSSM (Non-Sucking Service Manager). NSSM is used to install the miner](https://nssm.cc/)\nmodule as a service with a name as “Windowsm_Update” and later using the service\ncontroller to change the display name and description of this service as “Microsofts\nDefender Antivirus Network Inspection Service”.\n\n\n-----\n\nXMRIG Crypto Miner\n**Access Compromised Machines Through RDP**\n\nBefore deleting the files used to drop the miner, the attacker tries to create a user account\nand add it to the local Administrator group followed by enabling the remote desktop\nconnection. As mentioned earlier, we noticed suspicious events on some vulnerable\nExchange Server instances where the user account was created directly through the IIS\nworker process using the same username and password.\n\nUser Account Created to Retain Access\n**Detection Guidance**\n\nSophos endpoint security products block these attacks on multiple layers, Detection\ncoverage more specific to these payloads are Troj/ASPDoor-U, Troj/WebShel-O,\n**Mal/Chopper-A, Mal/MineJob-B, CXmal/CrtUtil-A, HPmal/mPShl-B, C2_10a, Lateral_1b,**\n**Exec_6a, AMSI/Cobalt-A, AMSI/WMIpersi-B and AMSI/PSobfus-F.**\n\n[A list of indicators of compromise is posted on the SophosLabs GitHub page.](https://github.com/sophoslabs/IoCs/blob/master/Trojan-LDMiner.csv)\n\n**Acknowledgements**\n\n**SophosLabs would like to thank Michael Wood and Sean Gallagher for their**\n**contribution to this post.**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-07 - New Lemon Duck variants exploiting Microsoft Exchange Server.pdf"
    ],
    "report_names": [
        "2021-05-07 - New Lemon Duck variants exploiting Microsoft Exchange Server.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535854,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653756712,
    "ts_modification_date": 1653756712,
    "files": {
        "pdf": "https://archive.orkl.eu/4bb589550d60e1e0a656824bb00f7f604567a629.pdf",
        "text": "https://archive.orkl.eu/4bb589550d60e1e0a656824bb00f7f604567a629.txt",
        "img": "https://archive.orkl.eu/4bb589550d60e1e0a656824bb00f7f604567a629.jpg"
    }
}