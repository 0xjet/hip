{
    "id": "6128982c-c340-40bb-8608-4f0be05d226b",
    "created_at": "2023-01-12T15:03:10.756701Z",
    "updated_at": "2025-03-27T02:11:47.728306Z",
    "deleted_at": null,
    "sha1_hash": "12df59b0dc262275beee9aaaeb65c40df4067bd5",
    "title": "2017-06-29 - Windows 10 platform resilience against the Petya ransomware attack",
    "authors": "",
    "file_creation_date": "2022-05-28T21:54:37Z",
    "file_modification_date": "2022-05-28T21:54:37Z",
    "file_size": 535028,
    "plain_text": "# Windows 10 platform resilience against the Petya ransomware attack\n\n**[blogs.technet.microsoft.com/mmpc/2017/06/29/windows-10-platform-resilience-against-the-petya-ransomware-attack/](https://blogs.technet.microsoft.com/mmpc/2017/06/29/windows-10-platform-resilience-against-the-petya-ransomware-attack/)**\n\nJune 30, 2017\n\n_The trend towards increasingly sophisticated malware behavior, highlighted by the use of exploits and other_\n_attack vectors, makes older platforms so much more susceptible to ransomware attacks. From June to_\n_November 2017, Windows 7 devices were 3.4 times more likely to encounter ransomware compared to_\n_Windows 10 devices._\n\n_Read our latest report: A worthy upgrade: Next-gen security on Windows 10 proves resilient against_\n**_ransomware outbreaks in 2017_**\n\n[The Petya ransomware attack on June 27, 2017 (which we analyzed in-depth in this blog) may have been](https://blogs.technet.microsoft.com/mmpc/2017/06/27/new-ransomware-old-techniques-petya-adds-worm-capabilities/)\nperceived as an outbreak worse than last month’s [WannaCrypt (also known as WannaCry) attack. After all, it](https://blogs.technet.microsoft.com/mmpc/2017/05/12/wannacrypt-ransomware-worm-targets-out-of-date-systems/)\nuses the same SMB exploit used by WannaCrypt and adds a second exploit and other lateral movement\nmethods. However, our telemetry shows a less widespread attack:\n\nThe new Petya variant is highly sophisticated malware, but our telemetry shows it had far less reach than\nwe expected given its worm-like spreading capabilities\nThe attack started in Ukraine; when the dust settled, more than 70% of the machines that encountered\nPetya were in Ukraine\nIt managed to spread to machines in other countries but in significantly lower volumes\nThe majority of infections were observed in Windows 7 machines\n\nIn this follow-up blog\nentry, we’ll discuss\nplatform protection and\nmitigation in Windows 10\nand Windows 10 S. The\nsecurity configuration and\nreduced attack surface of\nWindows 10 S block this\nattack by default. As we\npreviously discussed in a\n[white paper, Windows 10](http://download.microsoft.com/download/8/A/3/8A3ADCCE-C141-4E31-AB0D-26AA990D70A0/Next_gen_ransomware_protection_with_Windows_10_Creators_Update_EN_US.pdf)\nCreators Update has\nnext-gen security\ntechnologies that help\ndefend against\nransomware attacks.\n\nWe will also present new\nfindings from our continued investigation, specifically into the boot sector modification behavior of the\nransomware.\n\n## Windows 10 protection and mitigation\n\n[The new Petya ransomware combines multiple well-known techniques for propagation and infection that are not](https://www.microsoft.com/en-us/security/portal/threat/encyclopedia/Entry.aspx?Name=Ransom:Win32/Petya)\nnew to security researchers. The noteworthy aspect is that Petya’s developer(s) took techniques normally used\nby penetration testers and hackers, and built a sophisticated multi-threaded automation of these techniques\ninside a single piece of code\n\n\n-----\n\nSuch attacker techniques are part of the modern threat landscape and are continuously researched by security\nteams at Microsoft. Resulting new mitigations, hardening or defensive measures are then integrated into our\nproducts and operating systems.\n\nWindows 10 follows this philosophy of continuous mitigation improvements. From our analysis of Petya, we were\nable to measure the defenses provided by Windows 10. Summarized in the diagram below are how mitigations\nand security features can help disrupt the different stages of this attack.\n\n_Petya’s kill-chain diagram with platform defenses able to mitigate or prevent certain techniques in Windows 10_\n\nEach mitigation in this diagram is placed on top of the specific malware techniques, which are either fully\nprevented or mitigated in Windows 10. For an overview and specific details of these mitigations included in\n[Windows 10, see this page. Technical details of how each mitigation can help to block Petya’s techniques are](https://docs.microsoft.com/en-us/windows/threat-protection/overview-of-threat-mitigations-in-windows-10)\nlisted below:\n\n[Device Guard can enforce strong code integrity policies to allow only trusted signed apps to run. It can thus](https://technet.microsoft.com/itpro/windows/keep-secure/device-guard-deployment-guide)\nblock the entry vector of Petya (an updater running an untrusted binary) and also the further propagation\nattempts executing an untrusted DLL, either through PSEXEC or WMI.\n[Credential Guard uses virtualization-based security to isolate the LSASS process, so it fully protects from](https://docs.microsoft.com/en-us/windows/access-protection/credential-guard/credential-guard)\n[the credential dump executed by Petya using the external Mimikatz-like tool. It also protects the domain](https://www.microsoft.com/en-us/security/portal/threat/encyclopedia/Entry.aspx?Name=HackTool:Win32/Mimikatz)\ncredentials stored in the Windows Credential Store. Access tokens exposed in memory can still be\nleveraged by Petya, but this is a less effective propagation mechanism, and it relies on third-party tools and\nother processes active in memory while Petya executes.\n\n\n-----\n\nSeveral exploit mitigations such as better KASLR (randomization of kernel), NX HAL and PAGE POOL\n(non-executable kernel regions) are included by default in Windows 10 Anniversary and Creators Update,\nand they help mitigate SMB exploits like EternalBlue and EternalRomance. More mitigations like KCFG\n(control-flow guard for kernel) and HVCI (kernel code-integrity) are automatically enabled with Device\n[Guard to provide additional resistance also to new exploits. Previous](https://blogs.technet.microsoft.com/mmpc/2017/06/16/analysis-of-the-shadow-brokers-release-and-mitigation-with-windows-10-virtualization-based-security/) [blogs discuss in detail how such](https://blogs.technet.microsoft.com/mmpc/2017/01/13/hardening-windows-10-with-zero-day-exploit-mitigations/)\nmitigations were able to help mitigating unknown zero-day exploits, not effective against Windows 10.\n[UEFI Secure Boot is the security standard that uses hardware features to protect boot process and](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/secure-boot-overview)\nfirmware against tampering. This protection will stop the dangerous disk encryption executed by Petya with\na bootloader. After Petya’s forced reboot, a machine with Secure Boot will detect the anomalous bootloader\nand prevent further execution, containing the damage and preventing the very dangerous encryption of disk\nsectors leading to a complete loss of data. A machine in this state will be prevented from booting and can\nbe recovered with the regular repair functionality from the Windows USB/DVD media. NOTE: Individual files\nencrypted by Petya in the limited time before reboot will remain encrypted and must be recovered from\nbackup copies.\n[App Locker can also be used to block execution of certain programs (e.g. PSEXEC) or unsigned binaries](https://blogs.technet.microsoft.com/askpfeplat/2016/06/27/applocker-another-layer-in-the-defense-in-depth-against-malware/)\n(e.g. Petya’s DLL library) for machines that cannot benefit from Device Guard due to lack of the specific\nhardware requirements or due to older operating systems not supporting new mitigations (e.g. Windows 7).\n\nFinally, administrators of networks with older operating systems like Windows 7 which do not benefit of modern\nhardware and software mitigations, may consider deploying some hardened configurations that could help to\nslow down or remove certain lateral movement techniques. Such hardened configurations may impact legitimate\nfunctionality such as file-sharing or remote management and so it needs to be evaluated carefully before\ndeployment.\n\nBlock or restrict access to specific IPs for file-sharing services (SMB)\n\n_netsh firewall set service fileandprint_\n\n_netsh firewall set service RemoteAdmin disable_\n\nBlock remote execution through PSEXEC\n\n_FOR /F “usebackq tokens=2 delims=:” %a IN (`sc.exe sdshow scmanager`) DO sc.exe sdset scmanager D:_\n_(D;;0x00040002;;;NU)%a_\n\n[ACL remote WMI access](https://msdn.microsoft.com/en-us/library/aa822575(v=vs.85).aspx)\n\n## Limited execution time\n\nThe impact of Petya’s worm behavior is limited by its design. As part of its execution command, it receives a time\nthat it can run performing lateral movement and exploitation before rebooting the system.\n\n\n-----\n\nIf an argument is not passed, a default of 60mins is assumed. This value is later used to determine the time in\nthe future for the system to reboot.\n\nThis means that the threat can only do lateral movement and exploitation of other machines during this limited\ntime. This reduced the reach of the attack, as observed in our telemetry.\n\nAlso, the malware’s worm code does not persist across reboot; for example, if an infected machine is\nsuccessfully rebooted, the worm does not run again.\n\n## Conditional behavior and boot sector modification\n\n[As discussed in our in-depth analysis of the Petya ransomware attack, beyond encrypting files, the ransomware](https://blogs.technet.microsoft.com/mmpc/2017/06/27/new-ransomware-old-techniques-petya-adds-worm-capabilities/)\nalso attempts to infect the Master Boot Record (MBR).\n\nIn addition to modifying the MBR, the malware modifies the second sector of the C: partition by overwriting it with\nuninitialized buffer, effectively destroying the Volume Boot Record (VBR) for that partition. The screenshot below\nshows the code that makes these changes:\n\n\n-----\n\nIt is not clear what the purpose of these modifications are, but the code appears to be buggy it allocates 10\ntimes the amount of memory it requires. In most modern machines, the VBR on the C: partition is not used for\nbooting as there is a separate partition for the boot manager. Generally, for machines running Windows 7 or later\nthat weren’t upgraded from XP, the malware’s VBR changes are unlikely to have any impact.\n\nDuring malware initialization phase, this malware maintains a global variable that dictates its behavior. It alters its\nbehavior based on the presence of processes related to certain antivirus applications running in the system.\n\nSpecifically, it looks for names of processes belonging to Kaspersky Antivirus and Symantec Antivirus and alters\nits behavior if it finds them. Below are the CRC values that threat checks and their corresponding process\nnames.\n\n**CRC value** **Matching process name**\n\n0x651B3005 NS.exe\n\n0x6403527E ccSvcHst.exe\n\n0x2E214B44 avp.exe\n\nInformation controlling threats behavior is stored in a global variable (gConfig in the screenshots), which is then\nused to check during MBR modification.\n\nIf Kaspersky Antivirus process is found in the system or if the MBR infection is unsuccessful, the malware then\nproceeds to destroy the first 10 sectors of the hard drive. The code snippet below shows the threat logic:\n\n[Below snapshot shows threat code that destroys 10 sectors of \\\\\\\\.\\\\PhysicalDrive0, including the MBR sector.](https://microsoft-my.sharepoint.com/PhysicalDrive0)\n\n\n-----\n\nOn the other hand, if Symantec AV process names are found, the threat does not perform SMB exploitation.\n\nWe compared this new ransomware’s MBR infection functionality to the original Petya malware. Here are some\nof our findings:\n\nAlthough the layout of the code and encrypted data in the sectors following the MBR varies between the two\nversions, the code itself is functionally very similar. The encryption process is the same: when the malicious MBR\nstarts, it loads additional code from sectors after the MBR, which in turn proceeds to encrypt the Master File\nTable (MFT). After the encryption process is complete, the user is presented with the following ransom message,\nwhich is different from the typical ASCII skull and crossbones shown by the original Petya:\n\n\n-----\n\n_Ransom note from Petya after MBR infection_\n\nInterestingly, the first part of the text is the same message used by the WannaCrypt ransomware:\n\n_WannaCrypt ransom note_\n\nIn terms of the malware code itself, there are some differences between the new Petya variant and the original\nmalware. For example, the malware authors changed the constants for the key expansions of the encryption\nalgorithm (Salsa20)— the standard string “expand 32-byte k” was replaced with the custom “-1nvalid s3ct-id”.\n\n\n-----\n\nThe code that is supposed to show the skull and crossbones ransom note is still physically present in the\nmalicious MBR code, but it is only printing empty lines.\n\nThe strategy to cause a reboot to trigger the malicious MBR code has also been updated. The original version\ngenerated a serious system error by calling NtRaiseHardError with code 0xC0000350 (STATUS_HOST_DOWN),\nwhich forced the machine to reboot. The new Petya variant has also added a function to schedule a task that\nreboots the machine after a pre-configured number of minutes.\n\n## Fake victim ID\n\nBelow is the structure of the malware configuration stored by threat at Sector 32 (0x20):\n\n_typedef struct_\n\n_{_\n\n_BYTE Null;_\n\n_BYTE SalsaKey[0x20];_\n\n_BYTE SalsaIV[0x08];_\n\n_BYTE BitcoinAddress[0x22];_\n\n_BYTE Empty[0x5E];_\n\n_BYTE VictimID[0x3C]; // 60 bytes_\n\n_BYTE Empty2[0x11B];_\n\n_}_\n\nThe VictimID shown to the user is randomly generated using CryptGenRandom() and does not correspond to the\nMFT encryption, so the ID shown is of no value and is also independent from the per-drive file encryption ID\nwritten on README.TXT.\n\n\n-----\n\nBelow is a sample disk sector 32 written by the malware. Unlike the original Petya malware, elliptic curve data is\nempty.\n\n## Boot recovery options\n\nPetya causes some damage to the operating system’s boot code. In certain cases, recovery to boot the infected\nmachine to a clean state is possible.\n\n**Case 1: If machine is equipped with secure boot + UEFI**\n\nIf an infected machine shows the message below, it means the threat couldn’t hijack the boot process and\nencrypt MFT. In this case, booting off a clean installation media and performing Startup Recovery can fix the\nissue, and the machine can be booted.\n\n\n-----\n\n**Case 2: If system is non-UEFI, installed with Kaspersky Antivirus, and in a state where boot completely**\n**fails**\n\nThe ransomware attempts to destroy the first 10 sectors of the \\\\\\\\.\\\\PhysicalDrive0 if Kaspersky Antivirus is found\nor if the MBR infection is unsuccessful. Thus, boot process hijack through malicious MBR hasn’t been completed\nso the MFT (Master File table) contents are intact and not encrypted by the threat. In this case, the partition table\ninformation is destroyed by the threat. Given that it stores critical information needed in the booting process, a\ntraditional boot repair process may not work. Rebuilding the partition table may require consultation with an\nexpert.\n\n**Case 3: if a ransom message like below is seen, recovery is not possible**\n\nThe image is shown if the machine reboots and the malicious MBR is executed successfully. In this case, it is\nlikely that the malware successfully encrypted the MFT, a vital structure of the NTFS file system. Unfortunately,\nrecovery is not possible, and the machine is not capable of booting anymore. One can take the hard disk to\nanother clean system, use disk recovery tools to recover any recoverable personal files, and reimage the system.\n\n## Protection against ransomware attacks\n\n[The new Petya ransomware variant we saw this week is significantly more complex than the original. It also](https://blogs.technet.microsoft.com/mmpc/2017/06/27/new-ransomware-old-techniques-petya-adds-worm-capabilities/)\n[improved on WannaCrypt‘s spreading mechanisms by using a second exploit and adding more propagation](https://blogs.technet.microsoft.com/mmpc/2017/05/12/wannacrypt-ransomware-worm-targets-out-of-date-systems/)\nmethods. These lateral movement capabilities make this ransomware a higher risk for networks with an infected\nmachine. Furthermore, the boot sector modification behavior discussed in this blog gives this ransomware more\npotential to cause damage to machines.\n\nThis Petya outbreak exemplifies the ever-increasing sophistication of ransomware attacks. A multi-layer defense\n[stack is needed to protect computers and networks. At Microsoft, we strive to continuously enhance Windows 10](https://www.microsoft.com/en-us/windows/windows-10-upgrade)\nwith next-generation features to protect customers. As described in this blog, Windows 10 has defenses that can\nmitigate ransomware attacks like Petya.\n\n[Windows Defender Antivirus and](https://technet.microsoft.com/en-us/itpro/windows/keep-secure/windows-defender-in-windows-10) [Windows Defender Advanced Threat Protection allows customers to detect,](https://www.microsoft.com/en-us/windowsforbusiness/windows-atp?ocid=cx-blog-mmpc)\n[investigate, and respond to ransomware attacks. For enterprises, Device Guard locks down devices and provide](https://technet.microsoft.com/itpro/windows/keep-secure/device-guard-deployment-guide)\nkernel-level virtualization based security. [Credential Guard protects domain credentials stored in the Windows](https://docs.microsoft.com/en-us/windows/access-protection/credential-guard/credential-guard)\nCredential Store.\n\n\n-----\n\nTo test how Windows Defender ATP can help your organization detect, investigate, and respond to advanced\nattacks, **[sign up for a free trial.](https://www.microsoft.com/en-us/windowsforbusiness/windows-atp?ocid=cx-blog-mmpc)**\n\n[Keep your software up-to-date to block threats that attempt to exploit software vulnerabilities to infect machines](https://support.microsoft.com/en-us/help/311047/how-to-keep-your-windows-computer-up-to-date)\nor spread across networks. Additionally, [secure privileged access to protect your network from credential theft.](https://docs.microsoft.com/en-us/windows-server/identity/securing-privileged-access/securing-privileged-access)\n\nTo know more about security features in Windows 10, read out white paper “Next-gen ransomware protection\nwith Windows 10 Creators Update”.\n\nTo find mitigation steps specific to this new Petya variant, refer to our blog “New ransomware, old techniques:\nPetya adds worm capabilities”.\n\n## Resources\n\nNext-generation ransomware protection with Windows 10 Creators Update:\nhttps://blogs.technet.microsoft.com/mmpc/2017/06/08/windows-10-creators-update-hardens-security-with-nextgen-defense/\n\n[Download English language security updates: Windows Server 2003 SP2 x64,](http://download.windowsupdate.com/d/csa/csa/secu/2017/02/windowsserver2003-kb4012598-x64-custom-enu_f24d8723f246145524b9030e4752c96430981211.exe) [Windows Server 2003 SP2 x86,](http://download.windowsupdate.com/c/csa/csa/secu/2017/02/windowsserver2003-kb4012598-x86-custom-enu_f617caf6e7ee6f43abe4b386cb1d26b3318693cf.exe)\n[Windows XP SP2 x64,](http://download.windowsupdate.com/d/csa/csa/secu/2017/02/windowsserver2003-kb4012598-x64-custom-enu_f24d8723f246145524b9030e4752c96430981211.exe) [Windows XP SP3 x86,](http://download.windowsupdate.com/d/csa/csa/secu/2017/02/windowsxp-kb4012598-x86-custom-enu_eceb7d5023bbb23c0dc633e46b9c2f14fa6ee9dd.exe) [Windows XP Embedded SP3 x86,](http://download.windowsupdate.com/c/csa/csa/secu/2017/02/windowsxp-kb4012598-x86-embedded-custom-enu_8f2c266f83a7e1b100ddb9acd4a6a3ab5ecd4059.exe) [Windows 8 x86,](http://download.windowsupdate.com/c/msdownload/update/software/secu/2017/05/windows8-rt-kb4012598-x86_a0f1c953a24dd042acc540c59b339f55fb18f594.msu) [Windows 8 x64](http://download.windowsupdate.com/c/msdownload/update/software/secu/2017/05/windows8-rt-kb4012598-x64_f05841d2e94197c2dca4457f1b895e8f632b7f8e.msu)\n\n[Download localized language security updates: Windows Server 2003 SP2 x64,](http://www.microsoft.com/downloads/details.aspx?FamilyId=d3cb7407-3339-452e-8371-79b9c301132e) [Windows Server 2003 SP2 x86,](http://www.microsoft.com/downloads/details.aspx?FamilyId=350ec04d-a0ba-4a50-9be3-f900dafeddf9)\n[Windows XP SP2 x64,](http://www.microsoft.com/downloads/details.aspx?FamilyId=5fbaa61b-15ce-49c7-9361-cb5494f9d6aa) [Windows XP SP3 x86,](http://www.microsoft.com/downloads/details.aspx?FamilyId=7388c05d-9de6-4c6a-8b21-219df407754f) [Windows XP Embedded SP3 x86,](http://www.microsoft.com/downloads/details.aspx?FamilyId=a1db143d-6ad2-4e7e-9e90-2a73316e1add) [Windows 8 x86,](http://www.microsoft.com/downloads/details.aspx?FamilyId=6e2de6b7-9e43-4b42-aca2-267f24210340) [Windows 8 x64](http://www.microsoft.com/downloads/details.aspx?FamilyId=b08bb3f1-f156-4e61-8a68-077963bae8c0)\n\n[MS17-010 Security Update: https://technet.microsoft.com/en-us/library/security/ms17-010.aspx](https://technet.microsoft.com/en-us/library/security/ms17-010.aspx)\n\nGeneral information on ransomware: https://www.microsoft.com/enus/security/portal/mmpc/shared/ransomware.aspx\n\nSecurity for IT Pros: [https://technet.microsoft.com/en-us/security/default](https://technet.microsoft.com/en-us/security/default)\n\n\n-----\n\n**Talk to us**\n\n[Questions, concerns, or insights on this story? Join discussions at the Microsoft community and](https://answers.microsoft.com/en-us/protect) Windows\nDefender Security Intelligence.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-06-29 - Windows 10 platform resilience against the Petya ransomware attack.pdf"
    ],
    "report_names": [
        "2017-06-29 - Windows 10 platform resilience against the Petya ransomware attack.pdf"
    ],
    "threat_actors": [
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535790,
    "ts_updated_at": 1743041507,
    "ts_creation_date": 1653774877,
    "ts_modification_date": 1653774877,
    "files": {
        "pdf": "https://archive.orkl.eu/12df59b0dc262275beee9aaaeb65c40df4067bd5.pdf",
        "text": "https://archive.orkl.eu/12df59b0dc262275beee9aaaeb65c40df4067bd5.txt",
        "img": "https://archive.orkl.eu/12df59b0dc262275beee9aaaeb65c40df4067bd5.jpg"
    }
}