{
    "id": "cf0b26d5-9181-4fb0-8d09-1524a1cb14bf",
    "created_at": "2023-01-12T15:07:15.820036Z",
    "updated_at": "2025-03-27T02:17:15.032548Z",
    "deleted_at": null,
    "sha1_hash": "26fef8d605c9e27560b09202fa732f0f1039114a",
    "title": "2020-02-17 - CLAMBLING - A New Backdoor Base On Dropbox",
    "authors": "",
    "file_creation_date": "2022-05-27T22:34:26Z",
    "file_modification_date": "2022-05-27T22:34:26Z",
    "file_size": 980839,
    "plain_text": "# 詮睿科技Talent-Jump Technologies, Inc\n\n**[talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/](http://www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/)**\n\n## CLAMBLING - A New Backdoor Base On Dropbox (EN)\n\n[#DRBControl #Malware #APT #IncidentResponse Post on Feb 17 2020](http://www.talent-jump.com/article/tags/DRBControl)\n\nBy Theo Chen, Zero Chen\n\n[中文版本](http://www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox)\n\nIn July 2019, one of our customer’s company suffering the APT attack and we start the\ninvestigation immediately. During the investigation we found a brand new backdoor sample,\nwhich implements lots of features by using Dropbox API, using Dropbox like a C&C server.\nAfter the reverse engineering, we extract the Dropbox token used by the sample, dig into\nDropbox folder, and reveal the whole functional structure.\n\n[The report is co-authored with Trend Micro.](https://www.trendmicro.com/)\n\nKenney Lu, Daniel Lunghi, Cedric Pernet, and Jamz Yaneza. (17 February 2020).\nTrend Micro. “Operation DRBControl - Uncovering A Cyberespionage Campaign\nTargeting Gambling Companies In Southeast Asia”\n\n## First Stage Infection\n\nThe threat actor uses Windows Defender Core Process `MsMpEng.exe which has a legal`\ndigital signature to load the malicious DLL file. Load the shellcode from the payload file then\nrelease the final malicious executable to complete the first stage infection.\n\nDuring the investigation, we found a total of 8 different loader’s filenames [Appendix 1] renamed\nfrom `MsMpEng.exe and placed at` `C:\\ProgramData\\Microsoft in its separated folder.`\nThe loader is just called the function `ServiceCrtMain imported from` `mpsvc.dll .`\n\n\nThe malicious DLL file `mpsvc.dll has two types` [Appendix 2]. The older type will try to read\nshellcode from payload file `English.rtf, decode and decompress the content using`\n```\nRtlDecompressBuffer to release the final executable (Figure 1).\n\n```\n\n-----\n\nFigure 1. Older type\n\nof mpsvc.dll\n\nThe newer one has a different way to start the infection. There is a piece of shellcode hardcoded in the `mpsvc.dll, after decoding the shellcode from` `mpsvc.dll, it will inject and`\nexecute to load the shellcode from `mpsvc.mui (Figure 2), which will release the final`\nexecutable and inject into the process.\n\nFigure 2. Newer type of mpsvc.dll\n\n\n-----\n\nBoth of these two types of `mpsvc.dll will release a full functional backdoor, which can`\nconnect to the C&C server. But the final executable released by a newer type of `mpsvc.dll`\nhas some upgrade, including the function to interact with Dropbox API. The following article\nwill focus on the malicious executable released by the newer type of `mpsvc.dll .`\n\nThe hardcoded shellcode in a newer type of `mpsvc.dll will first allocate 0x80000 bytes of`\nmemory space. Getting the current module’s full path and replace the extension `dll to`\n```\nmui and read the shellcode in this mui file, then jump to the base address of mui file\n\n```\nplus its first byte. (Figure 3)\n\nFigure 3. Decoded shellcode in mpsvc.dll\n\nIn the end, the shellcode in `mpsvc.mui has another different piece of hard-coded bytes,`\nwhich will decompress by `RtlDecompressBuffer to the final malicious executable (Figure`\n4).\n\n\n-----\n\nFigure 4.\n\nThe final malicious executable in buffer.\n\n## Sample Analysis\n\nThe final malicious executable sample we extracted has numerous features. Here is the\nanalysis of some major functions.\n\n### Bypass UAC\n\nThis sample can bypass UAC via .NET. It is not a new technique which was disclosed in 2017\n\n\n\n[1], the threat actor only changes the GUID to `9BA94120-7E02-46ee-ADC6-10640B04F93B`\n\n(Figure 5) and specify the location of DLL file which will load by the .NET application in the\n\n\n-----\n\nelevated process.\n\nFigure 5. Code snippet of bypass UAC.\n\n### Persistence\n\nThere are two ways to persist. Register as a startup program in\n```\nHKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run if it has\n\n```\nno privileged (Figure 6). Otherwise, it will register itself as a system service (Figure 7).\n\n\n-----\n\nFigure 6. Register as a start program.\n\nservice.\n\n\nFigure 7. Register as a system\n\n\n-----\n\n### Information Gathering\n\nIt will collect some basic information like IP address, hostname, username, OS version and\nso on. Also, it will search the registry key’s value\n```\nHKEY_CURRENT_USER\\\\Software\\\\Bitcoin\\\\Bitcoin-Qt and try to look for the wallet\n\n```\naddress if exist (Figure 8). All of this information will upload to Dropbox as `%Y-%m-%d %H-%M-`\n```\n%S.log, below is a file sample:\nLan IP: x.x.x.x\nComputer: WIN-XXXXXX\nUserName: Administrator\nOS: Win10(X64)\nVersion: 8.0\nBit: Not Found !!!\nExist: NO\n\n```\nFigure 8. Code snippet of information gathering.\n\n### Recording Features\n\nThis sample acquired three types of recording features, including key-log, clipboard log, and\nscreen recording. The screen recording file naming format is `[%y-%m-%d] %H-%M-%S.avi .`\nThe key-log and clipboard log will encode by different key and salt, then save as\n```\n<hash>.pas for key-log and <hash>.log for clipboard log (Figure 9).\n\n```\n\n-----\n\nFigure 9. Code snippet of key log encoding.\n\n### Connect to C&C Server\n\nThis sample can also connect to a specific C&C server and send back data by using a fake\nHTTP POST request (Figure 10).\n\n\n-----\n\nFigure 10. Code snippet of preparing for fake POST request.\n\n### RTTI Information\n\nThe RTTI information remaining, here is the full class name list we got:\n\nCHPAvi\nCHPCmd\nCHPExplorer\nCHPHttp\nCHPKeyLog\nCHPNet\nCHPPipe\nCHPPlugin\nCHPProcess\nCHPProxy\nCHPRegedit\nCHPScreen\nCHPService\nCHPTcp\nCHPTelnet\nCHPUdp\n\n\n-----\n\n### Interact With Dropbox\n\nDuring reverse engineering, we found that the Dropbox API token with 64 characters is\nhardcoded in stack string (Figure 11).\n\nFigure 11. Code snippet for the first 24 characters of Dropbox API\n\ntoken.\n\nBesides connecting to the C&C server, this sample can also upload & download with Dropbox\nAPI. Especially when the log file is uploaded, it will try to download `bin.asc and check the`\nfile has fake `GIF file header or not. If everything is correct, it will continue to the custom`\ndecoding phase, which will calculate with an array of bytes hard-coded in the sample, to\nrelease the inject payload (Figure 12).\n\n\n-----\n\nFigure 12. Code snippet of interaction with Dropbox API.\n\n## Inside of Dropbox Folder\n\nAfter we got the Dropbox token, we can now dig into Dropbox by using official API, for\nexample, list the account information which creates this token, list the full file and folder\ninformation.\n\nIn the Dropbox, the folder structure like this:\n```\n/<unique_hash>/%Y-%m-%d\\ %H:%M:%S.log\n/<unique_hash>/bin.asc\n/codex64bin.asc\n/codex86bin.asc\n/x64bin.asc\n/x86bin.asc\n\n```\nEach infected victim has its folder named by unique hash `/[0-9A-z]/, this hash is`\ngenerated by machine key and some other information. `%Y-%m-%d\\ %H:%M:%S.log is the`\nlog file upload by the victim. `*.asc is the file upload by the threat actor. For example,`\n```\nbin.asc is the payload download by the victim when the log file is upload succeeds.\n\n```\nSort out the log file on Dropbox, we can get the full list of infected computers (Figure 13).\n\n\n-----\n\nFigure 13. The\n\nlist of infected computers.\n\n## Second Stage Infection\n\nAfter the first infection stage completed, it will persistent itself as a system service or autorun\nprogram. Collecting information and establish a connection to the C&C server. The most\ninteresting part is each time when the log file is upload succeeds, it will try to download\n```\nbin.asc from each computer’s unique folder. Most of bin.asc we captured is requesting\n\n```\nthe victim to download `x64bin.asc file from Dropbox.`\n\n\n-----\n\nFurther analysis of `x64bin.asc, we found the second Dropbox API token, its purpose is`\ndifferent from the first one. Now the threat actor is ready to use Dropbox as another C&C\nserver with the full backdoor feature.\n\nThe second infection stage’s sample has some bonus features including the ability to interact\nwith Dropbox, the command code mapping show as below:\n\n**Command Code** **Action**\n\n2 ListDrives\n\n3 ListFiles\n\n4 ExecuteFile\n\n5 ManageFile\n\n6 UploadFile\n\n7 DownloadFile\n\n8 OpenTerminal\n\nIn these commands, there are three different files, each of these file has specific filename\nand purpose:\n```\n   eLHgZNBH : The status file, upload to Dropbox at regular intervals.\n   yasHPHFJ : The command file, containing command and arguments.\n   csaujdnc : The execution result of the command.\n\n```\nThe status file `eLHgZNBH contain the basic information about victim and timestamp, upload`\nto Dropbox at regular intervals. Whenever status file upload succeeds, it will try to download\nthe command file `yasHPHFJ if it existed. Extract the command code and arguments from`\n```\nyasHPHFJ then execute the command and upload the execution result to Dropbox as\ncsaujdnc (Figure 14).\n\n```\n\n-----\n\nFigure 14. Flow of three files interact with Dropbox\n\nBy using this control flow, the threat actor can use Dropbox as a C&C server to control the\nvictim’s computer even the fixed connection between the specific C&C server’s IP address\nhas been found and blocked. Unless we block `content.dropboxapi.com and`\n```\napi.dropboxapi.com, otherwise we can not isolate the infected computer.\n\n```\nThe Dropbox API remain the detail of each file and folder, for example this is a file information\nreturn by Dropbox API:\n```\n{\n  '.tag': 'file',\n  'name': 'Secret_File.txt',\n  'path_lower': '/secret_file.txt',\n  'path_display': '/Secret_File.txt',\n  'id': 'id:<UNIQUE_FILE_ID>',\n  'client_modified': '2019-07-21T02:45:42Z',\n  'server_modified': '2019-07-21T02:53:04Z',\n  'rev': '[0-9a-f]{6,}',\n  'size': 125,\n  'is_downloadable': True,\n  'content_hash': '<SHA256_HASH>'\n}\n\n```\n\n-----\n\nIt contains the server_modified timestamp even with history revision file id, we can use `rev`\nto list the full history of this file and download it. Sort out this information and the command\ncode mapping, we can now list the full command executed on each computer and its\narguments. Here is two computers’ execution list (Figure 15 & 16).\n\nFigure 15. Real command execution list from one victim.\n\nFigure 16. Another real command execution list.\n\n\n-----\n\nAccording to these record, the threat actor follows almost the same action on every infected\ncomputer. First, download additional attack programs from Dropbox, like `mimikatz or other`\nUAC bypass tools. Second, search the high-value file including private source code, config\nfile, database, and the key-log / clipboard log. Upload all of these files to Dropbox for further\nsearching. Last but not least, infiltrate the company intranet or even the cloud service.\n\nCombining all decoded `yasHPHFJ files, we can show the threat actor’s approximate working`\nhours (Figure 17).\n\nFigure 17. The threat actor’s approximate working hours.\n\n## Conclusion\n\nWe start to monitor the Dropbox for each token and parse the infected computer’s list, here\nwe can see the infected computer’s number from July 2019 to September 2019 this two\nmonth (Figure 18 & 19).\n\n\n-----\n\nFigure 18. Dropbox A (first token): infected computer’s number.\n\nFigure 19. Dropbox B (second token): infected computer’s number.\n\nWe got nearly 200 infected computers at the highest peak from Dropbox A, alone with nearly\n80 computers from Dropbox B. Both of these static has a drop at August 21, 2019, the threat\nactor clear the Dropbox folder for some reason. Monitoring ends on September 20, 2019, all\ntokens we got are revoked by the threat actor.\n\nDuring these two months, we got five different Dropbox token. Each of these tokens has its\npurpose. The first two tokens are the major one we discuss in this article, others are more like\nfor testing.\n\nFrom the first infection stage, established the connection between the C&C server and\nDropbox at the same time. If the IP address of the C&C server been blocked, it can still have\nlimited control from Dropbox. Once it completed the second infection stage, Dropbox is\nturning into a second channel C&C server which has full remote control features (Figure 20).\nSteal the data and infiltrate the whole company. This method is not complex but very useful.\n\n\n-----\n\nFigure 20. The whole interaction flow from infection to interact with Dropbox.\n\n## Appendix\n\n1. Loader\n\n\n-----\n\n2. DLL & Payload File\n\n\n-----\n\nOther IoCs\n\nDrop Files\n```\n      37286285cb0f8305bd23a693b2e7ace71538e4c0b9f13ee6ca4e9e9419657813\n      b3581e8611f5838fc205f66bc5ca5edddb0fd895e97ebf8f0c7220cb102ae14b\n      79928578cdd646a9724bc6851a1ee77820c81a3100788d62885f9d92b6814085\n      7602e2932a10f3750a5d6236f6c1662047d4475c6e1fe6c57118c6620a083cb3\n      5b5aff8869ba7f1d3f6ad7711e801b031aedeff287a0dcb8f8ae6d6e4eb468af\n      412260ab5d9b2b2aa4471b953fb67ddc1a0fe90c353e391819ca7ac1c6d3146f\n      c6064fb44733b5660557e223598d0e4d5c4448ad20b29e41bef469cb5df77da0\n      4c08bc1a2f5384c5306edc6f23e4249526517eb21a88763c8180a582438dfa31\n      a58f2fea8c74c1d25090014c7366db224102daa6c798fcdfb7168b569b7d5ca2\n      d201e726fd2a2f4b55ea5ca95f0429d74e2efb918c7c136d55ef392ceac854d6\n      5713907c01db40cf54155db19c0c44c046b2c676a492d5ba13d39118c95139bf\n      d72c3f5f2f291f7092afd5a0fcaceaf2eaae44d057c9b3b27dd53f2048ed6175\n      d62ddac7c4aa152cf6f988db6c7bd0c9dcffa2e890d354b7e9db7f3b843fd270\n      28d2637139231c78a6493cd91e8f0d10891cfeb6c5e758540515faa29f54b6b2\n      39e69ab52f073f966945fdab214f63368f71175a7ccbea199fae32d51fa6a4e7\n      260b64e287d13d04f1f38d956c10d9fdd3cfbff6ba0040a52223fa41605bb975\n      c425b73be7394032aa8e756259ebf3662c000afaa286c3d7d957891026f3cbb4\n      28d19a23d167db3e1282f1c6039bcda6556798be054994a55e60116827dd0bf1\n      c3c1fc6aabbb49d0ee281ba4fc1529d2b9832a67b18e08ce14dbf0e361e5bd85\n      fc865a720cb808354923092bac04ab6a75e20ea92db5a343af07365c0cd2b72a\n      24f501141af5bf059509145e165302dd7087b1d1c2136bc5e4403f01435f250e\n      ee5f7e6ad4a344f40b9babada1654ea22333bb5150cfd26bfc239ead28b6528c\n      ca26a34153972cc73c63d3a9aadd3b12ba35ecdc6e39025b75be56b00c20e0ae\n      1951c79f280692a43b7c7cafd45c3f5d7f4f841ae104a6cad814fab4641c79f2\n      d5129308ee83a852e6a320ca68c8e66ed6d1eb4ec584dd0c8b5f313a56c49a15\n\n```\nIP\n\n\n-----\n\nDomains\n\n## References\n\n[Older Post ⇒⇐ Next Post](http://www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox/)\n\n## Comments\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-17 - CLAMBLING - A New Backdoor Base On Dropbox.pdf"
    ],
    "report_names": [
        "2020-02-17 - CLAMBLING - A New Backdoor Base On Dropbox.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5c13338b-eaed-429a-9437-f5015aa98276",
            "created_at": "2022-10-25T16:07:23.582715Z",
            "updated_at": "2025-03-27T02:02:09.875151Z",
            "deleted_at": null,
            "main_name": "Emissary Panda",
            "aliases": [
                "APT 27",
                "ATK 15",
                "Bronze Union",
                "Budworm",
                "Earth Smilodon",
                "Emissary Panda",
                "Group 35",
                "Iron Taurus",
                "Iron Tiger",
                "LuckyMouse",
                "Operation DRBControl",
                "Operation Iron Tiger",
                "Operation PZChao",
                "Operation SpoiledLegacy",
                "Operation StealthyTrident",
                "Red Phoenix",
                "TEMP.Hippo",
                "TG-3390",
                "ZipToken"
            ],
            "source_name": "ETDA:Emissary Panda",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agent.dhwf",
                "AngryRebel",
                "Antak",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "FOCUSFJORD",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HTran",
                "HUC Packet Transmit Tool",
                "HighShell",
                "HttpBrowser RAT",
                "HttpDump",
                "HyperBro",
                "HyperSSL",
                "HyperShell",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "Nishang",
                "OwaAuth",
                "PCRat",
                "PlugX",
                "ProcDump",
                "PsExec",
                "RedDelta",
                "SEASHARPEE",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "SysUpdate",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Token Control",
                "TokenControl",
                "TwoFace",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "gsecdump",
                "luckyowa"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e254cf33-e7f5-407b-a8a1-1a856a9f1c71",
            "created_at": "2025-01-21T02:00:03.599871Z",
            "updated_at": "2025-03-27T02:00:03.480307Z",
            "deleted_at": null,
            "main_name": "Operation DRBControl",
            "aliases": [],
            "source_name": "MISPGALAXY:Operation DRBControl",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6d2910b0-9fea-46a2-84e6-a043b1e023e4",
            "created_at": "2022-10-25T16:07:23.946958Z",
            "updated_at": "2025-03-27T02:02:10.044112Z",
            "deleted_at": null,
            "main_name": "Operation DRBControl",
            "aliases": [],
            "source_name": "ETDA:Operation DRBControl",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536035,
    "ts_updated_at": 1743041835,
    "ts_creation_date": 1653690866,
    "ts_modification_date": 1653690866,
    "files": {
        "pdf": "https://archive.orkl.eu/26fef8d605c9e27560b09202fa732f0f1039114a.pdf",
        "text": "https://archive.orkl.eu/26fef8d605c9e27560b09202fa732f0f1039114a.txt",
        "img": "https://archive.orkl.eu/26fef8d605c9e27560b09202fa732f0f1039114a.jpg"
    }
}