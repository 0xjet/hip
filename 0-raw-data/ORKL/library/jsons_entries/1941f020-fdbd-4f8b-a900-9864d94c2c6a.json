{
    "id": "1941f020-fdbd-4f8b-a900-9864d94c2c6a",
    "created_at": "2023-01-12T15:02:04.522296Z",
    "updated_at": "2025-03-27T02:15:35.704558Z",
    "deleted_at": null,
    "sha1_hash": "9e0fd67da94b29d142cb7a6a4392d09ff2c6bde3",
    "title": "2019-12-03 - New version of IcedID Trojan uses steganographic payloads",
    "authors": "",
    "file_creation_date": "2022-05-28T22:02:16Z",
    "file_modification_date": "2022-05-28T22:02:16Z",
    "file_size": 3255687,
    "plain_text": "# New version of IcedID Trojan uses steganographic payloads\n\n**[blog.malwarebytes.com/threat-analysis/2019/12/new-version-of-icedid-trojan-uses-steganographic-payloads/](https://blog.malwarebytes.com/threat-analysis/2019/12/new-version-of-icedid-trojan-uses-steganographic-payloads/)**\n\nThreat Intelligence Team December 3, 2019\n\n_This blog post was authored by @hasherezade, with contributions from @siri_urz and_\n_Jérôme Segura._\n\n[Security firm Proofpoint recently published a report about a series of malspam campaigns](https://www.proofpoint.com/us/threat-insight/post/ta2101-plays-government-imposter-distribute-malware-german-italian-and-us)\nthey attribute to a threat actor called TA2101. Originally targeting German and Italian users\nwith Cobalt Strike and Maze ransomware, the later wave of malicious emails were aimed at\nthe US and pushing the IcedID Trojan.\n\nDuring our analysis of this spam campaign, we noticed changes in how the payload was\nimplemented, in particular with some code rewritten and new obfuscation. For example, the\n[IcedID Trojan is now being delivered via steganography, as the data is encrypted and](https://en.wikipedia.org/wiki/Steganography)\nencoded with the content of a valid PNG image. According to our research, those changes\n[were introduced in September 2019 (while](http://www.malware-traffic-analysis.net/2019/09/16/index2.html) [in August 2019 the old loader was still in use).](https://www.malware-traffic-analysis.net/2019/08/12/index.html)\n\nThe main IcedID module is stored without the typical PE header and is run by a dedicated\nloader that uses a custom headers structure. Our security analyst @hasherezade previously\n[described this technique in a talk at the SAS conference (Funky Malware Formats).](https://speakerdeck.com/hshrzd/funky-malware-formats)\n\nIn this blog post, we take a closer look at these new payloads and describe their technical\ndetails.\n\n\n-----\n\n## Distribution\n\nOur spam honeypot collected a large number of malicious emails containing the “USPS\nDelivery Unsuccessful Attempt Notification” subject line.\n\nEach of these emails contains a Microsoft Word document as attachment allegedly coming\nfrom the United States Postal Service. The content of the document is designed to lure the\nvictim into enabling macros by insinuating that the content had been encoded.\n\nHaving a look at the embedded macros, we can see the following elements:\n\n\n-----\n\nThere is a fake error message displayed to the victim, but more importantly, the IcedID\nTrojan authors have hidden the malicious instructions within a UserForm as labels.\n\nThe labels containing numerical\n\nASCII values\nThe macro grabs the text from the labels, converts it, and uses during execution:\n```\nurl1 = Dcr(GH1.Label1.Caption)\npath1 = Dcr(GH1 Label2 Caption)\n\n```\n\n-----\n\nFor example:\n\n_104 116 116 112 58 47 47 49 48 52 46 49 54 56 46 49 57 56 46 50 51 48 47 119 111 114_\n_100 117 112 100 46 116 109 112_\nconverts to: http://104.168.198.230/wordupd.tmp\n```\n67,58,92,87,105,110,100,111,119,115,92,84,101,109,112,92,101,114,101,100,46,116,109,11\nconverts to: C:\\Windows\\Temp\\ered.tmp\n\n```\nThe file wordupd.tmp is an executable downloaded with the help of the\nURLDownloadToFileA function, saved to the given path and run. Moving on, we will take a\ncloser look at the functionality and implementation of the downloaded sample.\n\n## Behavioral analysis\n\nAs it had before, IcedID has been observed making an injection into svchost, and running\nunder its cover. Depending on the configuration, it may or may not download other\n[executables, including TrickBot.](https://blog.malwarebytes.com/trojans/2019/09/trickbot-adds-new-trick-to-its-arsenal-tampering-with-trusted-texts/)\n\n**Dropped files**\n\nThe malware drops various files on the disk. For example, in %APPDATA%, it saves the\nsteganographically obfuscated payload (photo.png) and an update of the downloader:\n\nIt also creates a new folder with a random name, where it saves a downloaded configuration\nin encrypted form:\n\n\n-----\n\nInside the %TEMP% folder, it drops some non-malicious helper elements: sqlite32.dll (that\nwill be used for reading SQLite browser databases found in web browsers), and a certificate\nthat will be used for intercepting traffic:\n\nLooking at the certificate, we can see that it was signed by VeriSign:\n\n**Persistence**\n\nThe application achieves persistence with the help of a scheduled task:\n\n\n-----\n\nThe task has two triggers: at the user login and at the scheduled hour.\n\n**Overview of the traffic**\n\nMost of the traffic is SSL encrypted. We can also see the use of websockets and addresses\nin a format such as “data2php?<key>“, “data3.php?<key>“.\n\n**Attacking browsers**\n\nThe IcedID Trojan is known as a banking Trojan, and indeed, one of its important features is\nthe ability to steal data related to banking transactions. For this purpose, it injects its implants\n[into browsers, hooks the API, and performs a Man-In-The-Browser attack.](https://en.wikipedia.org/wiki/Man-in-the-browser)\n\n\n-----\n\nInside the memory of the infected svchost process we can see the strings with the\nconfiguration for webinjects. Webinjects are modular (typically HTML and JavaScript code\ninjected into a web page for the purpose of stealing data).\n\nWebinjects configuration in the memory of infected svchost\nThe core bot that runs inside the memory of svchost observes processes running on the\nsystem, and injects more implants into browsers. For example, looking at Mozilla Firefox:\n\nThe\n\nIcedID implant in the browser’s memory\n[By scanning the process with PE-sieve, we can detect that some of the DLLs inside the](https://github.com/hasherezade/pe-sieve)\nbrowser have been hooked and their execution was redirected to the malicious module.\n\nIn Firefox, the following hooks have been installed:\n\n\n-----\n\nnss3.dll : SSL_AuthCertificateHook->2c2202[2c1000+1202]\nws2_32.dll : connect->2c2728[2c1000+1728]\n\nA different set was observed in Internet Explorer:\n\nmswsock : hook_0[7852]->525d0[implant_code+15d0]\nws2_32.dll : connect->152728[implant_code+1728]\n\nThe IcedID module running inside the browser’s memory is responsible for applying the\nwebinjects installing malicious JavaScripts into attacked pages.\n\nFragment of the injected script\n[The content of the inlined webinject script is available here: inject.js.](https://gist.github.com/malwarezone/830f4a0e4506d35e376a288b20d21433#file-inject-js)\n\nIt also communicates with the main bot that is inside the svchost process. The main bot\ncoordinates the work of all the injected components, and sends the stolen data to the\nCommand and Control server (CnC).\n\nDue to the fact that the communication is protected by HTTPS, the malware must also install\nits own certificate. For example, this is the valid certificate for the Bank of America website:\n\n\n-----\n\nAnd in contrast, the certificate used by the browser infected by IcedID:\n\n\n-----\n\n## Overview of the changes\n\nAs we mentioned, the core IcedID bot, as well as the dedicated loader, went through some\nrefactoring. In this comparative analysis, we used the following old sample:\n[b8113a604e6c190bbd8b687fd2ba7386d4d98234f5138a71bcf15f0a3c812e91](https://www.virustotal.com/gui/file/b8113a604e6c190bbd8b687fd2ba7386d4d98234f5138a71bcf15f0a3c812e91/detection)\n\n[The detailed analysis of this payload can be found here: [1][2][3].](https://www.fortinet.com/blog/threat-research/icedid-malware-analysis-part-one.html)\n\n**The old loader vs. new**\n\n[The loader of the previous version of the IcedID Trojan was described in detail here, and](https://medium.com/@dawid.golak/icedid-aka-bokbot-analysis-with-ghidra-560e3eccb766)\n[here. It was a packed PE file that used to load and inject a headerless PE.](https://www.fortinet.com/blog/threat-research/icedid-malware-analysis-part-one.html)\n\n\n-----\n\nThe main module was injected into svchost:\n\nThe implants in the svchost’s memory\nThe implanted PE was divided into two sections, and the first memory page (representing the\nheader) was empty. This type of payload is more stealthy than a full PE injection (as is more\ncommon). However, it was possible to reconstruct the header and analyze the sample like a\nnormal PE. (An example of the reconstructed payload is available here:\n[395d2d250b296fe3c7c5b681e5bb05548402a7eb914f9f7fcdccb741ad8ddfea).](https://www.virustotal.com/gui/file/395d2d250b296fe3c7c5b681e5bb05548402a7eb914f9f7fcdccb741ad8ddfea/detection)\n\nThe redirection to the implant was implemented by hooking the RtlExitUserProcess function\nwithin svchost’s NTDLL.\n\n\n-----\n\nWhen svchost tried to terminate, it instead triggered a jump into the injected PE’s entry point.\n\nThe hooked RtlExitUserProcess\n\nredirects to payload’s EP\nThe loader was also filling the pointer to the data page within the payload. We can see this\npointer being loaded at the beginning of the payload’s execution:\n\n\n-----\n\nIn the new implementation, there is one more intermediate loader element implemented as\nshellcode. The diagram below shows the new loading chain:\n\nThe shellcode has similar functionality that was previously implemented by the loader in form\nof a PE. First it injects itself into svchost.\n\n\n-----\n\nThen it decompresses and injects the payload, which as before is a headerless PE\n[(analogical to the one described here).](https://www.fortinet.com/blog/threat-research/deep-dive-icedid-malware-analysis-of-child-processes.html)\n\n**Comparing the core**\n\nThe implementation of the core bot is modified. Yet, inside the code we can find some strings\nknown from the previous sample, as well as a similar set of imported API functions. We can\nalso see some matching strings and fragments of implemented logic.\n\n\n-----\n\nFragment of the code from the old implementation\nAnalogical fragment from the new sample:\n\nFragment of the code from the new implementation\nComparing both reconstructed samples with the help of BinDiff shows that there are quite a\nfew differences and rewritten parts. Yet, there are parts of code that are the same in both,\nwhich proves that the codebase remained the same.\n\n\n-----\n\nof the similar functions\n\nof different/rewritten functions\nLet’s follow the execution flow of all the elements from the new IcedID package.\n\n## The downloader\n\n\nPreview\n\nPreview\n\n\nIn the current delivery model, the first element of IcedID is a downloader. It is a PE file,\npacked by a crypter. The packing layer changes from sample to sample, so we will omit its\ndescription. After unpacking it, we get the plain version:\n[fbacdb66748e6ccb971a0a9611b065ac.](https://www.virustotal.com/gui/file/5cac188fce6c235ae926c48bde0130036ce8860c864d6ae8e2dd1bd9fd2613e0/details)\n\nInternally, this executable is simple and no further obfuscated. We can see that it first queries\nthe CnC trying to fetch the second stage, requesting for a photo.png. It passes a generated\nID to the URL. Example:\n\n/photo.png?id=0198d464fe3e7f09ab0005000000fa00000000\n\n\n-----\n\nFragment of the\n\nfunction responsible for generating the image URL\nThe downloader fetches the PNG with the encoded payload. Then it loads the file, decodes\nit, and redirects the execution there. Below we can see the responsible function:\n\nOnce the PNG is downloaded, it will be saved on disk and can be loaded again at system\nrestart. The downloader will turn into a runner of this obfuscated format. In this way, the core\nexecutable is revealed only in memory and never stored on disk as an EXE file.\n\nThe “photo.png” looks like a valid graphic file:\n\n\n-----\n\nPreview of the “photo.png”\nIn this fragment of code, we can see that the data from the PNG (section starting from the\ntag “IDAT”) is first decoded to raw bytes, and then those bytes are passed to the further\ndecoding function.\n\nThe algorithm used for decoding the bytes:\n\n\n-----\n\nThe PNG is decrypted and injected into the downloader. In this case, the decoded content\nturns out to be a shellcode module rather than a PE.\n\nThe\n\ndownloader redirecting the execution into the shellcode’s entry point\nThe loader passes to the shellcode one argument; that is the base at which it was loaded.\n\n## The loader (shellcode)\n\nAs mentioned before, this stage is implemented as a position-independent code (shellcode).\n[The dumped sample is available here: 624afab07528375d8146653857fbf90d.](https://www.virustotal.com/gui/file/05274e8c704b03ae90458b3456ac392cff6cd271ea0c2cdbf26368c78782ec45/details)\n\n[This shellcode-based loader replaced the previously described (sources: [1][2]) loader](https://www.fortinet.com/blog/threat-research/icedid-malware-analysis-part-one.html)\nelement that was implemented as a PE file. First, it runs within the downloader:\n\n\n-----\n\nAs we can see from the downloader’s code, the shellcode entry point must first be fetched\nfrom a simple header that is at the beginning of the decoded module. We see that this\nheader stores more information that is essential for loading the next element:\n\nAs this module is no longer a PE file, its analysis is more difficult. All the APIs used by the\nshellcode are resolved dynamically:\n\n\n-----\n\nThe strings are composed on the stack:\n\nTo make the deobfuscation easier, we can follow the obfuscated flow with the help of a PIN\ntracer. The log from the tracing of this stage (on a 32 bit system) shows APIs indicating code\ninjection, along with their offsets:\n```\n09c;shellcode's Entry Point\n69b;ntdll.LdrLoadDll\n717;ntdll.LdrGetProcedureAddress\n7ab;ntdll.RtlWow64EnableFsRedirectionEx\n7cb;kernel32.CreateProcessA\n7d6;ntdll.RtlWow64EnableFsRedirectionEx\n7f0;ntdll.NtQuerySystemInformation\n8aa;ntdll.NtAllocateVirtualMemory\n\n```\n\n-----\n\n```\n8c6;ntdll.ZwWriteVirtualMemory\n8ee;ntdll.NtProtectVirtualMemory\n907;ntdll.NtQueueApcThread\n916;ntdll.ZwResumeThread\n\n```\nIndeed, the shellcode injects its own copy, passing its entry point to the APC Queue. This\ntime, some additional parameters are added as a thread context.\n\nSetting parameters of the\n\ninjected thread\nOnce the shellcode is executed from inside svchost, an alternative path to the execution is\ntaken. It becomes a loader for the core bot. The core element is stored in a compressed form\nwithin the shellcode’s body. First, it is decompressed.\n\nFrom previous experiments, we know that the payload follows the typical structure of a PE\nfile, yet it has no headers. Often, malware authors erase headers in memory once the\npayload is loaded. Yet, this is not the case. In order to make the payload stealthier, the\nauthors didn’t store the original headers of this PE at all. Instead, they created their own\nminimalist header that is used by the internal loader.\n\nFirst, the shellcode finds the next module by parsing its own header:\n\n\n-----\n\nThe shellcode also loads the imports of the payload:\n\n\n-----\n\nBelow, we can see the fragment of code responsible for following the custom headers\ndefinition, and applying protection on pages. After the next element is loaded, execution is\nredirected to its entry point.\n\nThe entry point of the next module where the function expects the pointer to the data to be\nsupplied:\n\n\n-----\n\nThe supplied data is appended at the end of the shellcode, and contains: the path of the\ninitial executable, the path of the downloaded payload (photo.png), and other data.\n\nNote that described analysis was performed on a 32 bit system. In case of a 64bit system,\nthe shellcode takes an alternative execution path, and a 64bit version of the payload is\n[loaded with the help of Heaven’s Gate technique. Yet, all the features of both payload’s](https://blog.malwarebytes.com/threat-analysis/2018/01/a-coin-miner-with-a-heavens-gate/)\nversions are identical.\n\nThe Heaven’s Gate within the shellcode:\n\nswitch to 64 bit mode\n\n**Reconstructing the PE**\n\nIn order to make analysis easier, it is always beneficial to reconstruct the valid PE header.\nThere are two approaches to this problem:\n\n1. Manually finding and filling all the PE artifacts, such as: sections, imports, relocations\n\n(this becomes a problem in if all those elements are customized by the authors, as in\n[the case of Ocean Lotus sample)](https://blog.malwarebytes.com/threat-analysis/2019/04/funky-malware-format-found-in-ocean-lotus-sample/)\n2. Analyzing in detail the loader and reconstructing the PE from the custom header\n\nSince we have access to the loader’s code, we can go for the second, more reliable\napproach: Observe how the loader processes the data and reconstruct the meaning of the\nfields\n\n\n-----\n\nA fragment of the loader s code where the sections are processed:\n\nThe custom header reconstructed based on the analysis:\n\nFortunately, in this case the malware authors customized only the PE header. The Data\nDirectory elements (imports and relocations) are kept in a standard form, so this part does\nnot need to be converted.\n\nThe converter from this format to PE is available here:\n\n[https://github.com/hasherezade/funky_malware_formats/tree/master/iced_id_parser](https://github.com/hasherezade/funky_malware_formats/tree/master/iced_id_parser)\n\n\n-----\n\nInterestingly, the old version of IcedID used a similar custom format, but with one\nmodification. In the past, there was one more DWORD-sized field before the ImportDirector\nVA. So, the latest header is shorter by one DWORD than the previous one.\n\nThe module in the old format:\n[bbd6b94deabb9ac4775befc3dc6b516656615c9295e71b39610cb83c4b005354](https://www.virustotal.com/gui/file/bbd6b94deabb9ac4775befc3dc6b516656615c9295e71b39610cb83c4b005354/detection)\n\n## The core bot (headerless PE)\n\n[6aeb27d50512dbad7e529ffedb0ac153 – a reconstructed PE](https://www.virustotal.com/gui/file/a5dcfe4896abc176108748289e5a6a85a3ed8528a7c5bf1dafe6f2f6bf826192/details)\n\nLooking inside the strings of this module, we can guess that this element is responsible for\nall the core malicious operations performed by this malware. It communicates with the CnC\nserver, reads the sqlite databases in order to steal cookies, installs its own certificate for\nMan-In-The-Browser attacks, and eventually downloads other modules.\n\nWe can see that this is the element that was responsible for generating the observed\nrequests to the CnC:\n\nDuring the run, the malware is under constant supervision from the CnC. The communication\nwith the server is encrypted.\n\n**String obfuscation**\n\nThe majority of the strings used by the malware are obfuscated and decoded before use.\nThe algorithm used for decoding is simple:\n\n\n-----\n\nIn order to decode the strings statically, we can reimplement the algorithm and supply to it\nencoded buffers. Another easier solution is a decoder that loads the original malware and\n[uses its function, as well as the encoded buffers given by offset. Example available here.](https://gist.github.com/hasherezade/3f1db9cf4629cf6afc09d5ff039fc541#file-ice_str-cpp)\n\nDecoding strings is important for the further analysis. Especially because, in this case, we\ncan find some [debug strings left by the developers, informing us about the actions performed](https://gist.github.com/hasherezade/3f1db9cf4629cf6afc09d5ff039fc541#file-bot_logs-csv)\nby the malware in particular fragments of code.\n\n[A list of some of the decoded strings is available here.](https://gist.github.com/hasherezade/3f1db9cf4629cf6afc09d5ff039fc541#file-decoded-csv)\n\n**Available actions**\n\nThe overview of the main function of the bot is given below:\n\nThe bot starts by opening a socket. Then, it beacons to the CnC and initializes threads for\nsome specific actions: MiTM proxy, browser hooking engine, and a backconnect module\n(backdoor).\n\n\n-----\n\nIt also calls to a function that initializes handlers, responsible for managing a variety of\navailable actions. The full list:\n\nBy analyzing closer to the handlers, we notice that similar to the first element, the main bot\nretrieves various elements as steganographically protected modules. The function\nresponsible for decoding PNG files is analogical to the one found in the initial downloader:\n\n\n-----\n\nThose PNGs are used to carry the content of various updates for the malware. For example,\nan update to the list of URLs, but also other configuration files.\n\n**Execution flow controlled by the CnC**\n\nThe malware’s backconnect feature allows the attacker to deploy various commands on the\nvictim machine. The CnC can also instruct the bot to decode other malicious modules from\ninside that will be deployed in a new process. For example:\n\n\n-----\n\nIf the particular command from the CnC is received, the bot will decompress another buffer\nthat is stored inside the sample and inject it into a new instance of svchost.\n\n\n-----\n\nThe way in which this injection is implemented reminds us of the older version of the loader.\nFirst, the buffer is decompressed with the help of RtlDecompressBuffer:\n\nThen, memory is allocated at the preferred address 0x3000.\n\n\n-----\n\nSome functions from NTDLL and other parameters will be copied to the structure, stored at\nthe beginning of the shellcode.\n\nWe can see there are some functions that will be used by the shellcode to load another\nembedded PE.\n\nSimilar to in the old loader, the redirection to the new entry point is implemented via hook set\non the RtlExitUserProcess function:\n\n\n-----\n\nAfter the buffer gets decompressed, we can see another piece of shellcode:\n\n\n-----\n\nThis shellcode is an analogical loader of the headerless PE module. We can see inside the\ncustom version of PE header that will be used by the loader:\n\nThe custom\n\nheader, containing minimal info from the PE header\nDumped shellcode:\n[469ef3aedd47dc820d9d64a253652d7436abe6a5afb64c3722afb1ac83c3a3e1](https://www.virustotal.com/gui/file/469ef3aedd47dc820d9d64a253652d7436abe6a5afb64c3722afb1ac83c3a3e1/detection)\n\n[This element is an additional backdoor, deploying on demand a hidden VNC. It is also](https://www.malwaretech.com/2015/09/hidden-vnc-for-beginners.html)\nreferenced by the authors by the name “HDESK bot” (Help Desk bot) because it gives the\nattacker direct access to the victim machine, as if it were a help-desk service. Converted to\nPE: [2959091ac9e2a544407a2ecc60ba941b](https://www.virustotal.com/gui/file/27c946b90987e04c3989e17e33b5dac8d5e0033199213a16d70657c58efc5031/details)\n\nThe\n\n[“HDESK bot” deploys a hidden VNC to control the victim machine](https://www.malwaretech.com/2015/09/hidden-vnc-for-beginners.html)\n\n\n-----\n\nBelow, we will analyze the selected features implemented by the core bot. Note that many of\nthe features are deployed on demand—depending on the command given by the CnC. In the\nobserved case, the bot was also used as a downloader of the secondary malware, TrickBot.\n\n**Installing its own certificate**\n\nThe malware installs its own certificate. First it drops the generated file into the %TEMP%\nfolder. Then, the file is loaded and added to the Windows certificate store.\n\nFragment of Certificate generation function:\n\nCalling the function to add the certificate to store:\n\n\n-----\n\n**Stealing passwords from IE**\n\nWe can see that this bot goes after various saved credentials. Among the different methods\nused, we identified stealing data from the Credential Store. The used method is similar to the\n[one described here.](https://securityxploded.com/iepasswordsecrets.php)\n\nWe can see that it uses the mentioned GUID “abe2869f-9b47-4cd9-a358-c22904dba7f7” that\nwas used to salt the credentials. After reading the credentials from the store, the bot undoes\nthe salting operation in order to get the plaintext.\n\n**Stealing saved email credentials**\n\nThe bot is trying to use every opportunity to extract passwords from the victim machine, also\ngoing after saved email credentials.\n\n\n-----\n\n**Stealing cookies**\n\nAs we observed during the behavioral analysis, the malware drops the sqlite3.dll in the temp\nfolder. This module is further loaded and used to perform queries to browsers’ databases\nwith saved cookies.\n\n\n-----\n\nFragment of code responsible for loading sqlite module\nThe malware searches the files containing cookies of particular browsers:\n\nWe can see the content of the queries after decoding strings:\n\nSELECT host, path, isSecure, expiry, name, value FROM moz_cookies\nIt targets Firefox, as well as Chrome and Chromium-based browsers:\n\n\n-----\n\nThe list of\n\n\ntargeted Chromium browsers\nFragment of the code performing queries:\n\nThe list of queries to the Chrome’s database:\n\n\n-----\n\n```\nSELECT name, value FROM autofill\nSELECT guid, company_name, street_address, city, state, zipcode, country_code FROM\nautofill_profiles\nSELECT guid, number FROM autofill_profile_phones\nSELECT guid, first_name, middle_name, last_name, full_name FROM\nautofill_profile_names\nSELECT card_number_encrypted, length(card_number_encrypted), name_on_card,\nexpiration_month || \"/\" ||expiration_year FROM credit_cards\nSELECT origin_url,username_value,length(password_value),password_value FROM logins\nWHERE username_value <> ''\nSELECT host_key, path, is_secure, (case expires_utc when 0 then 0 else (expires_utc /\n1000000) - 11644473600 end), name, length(encrypted_value), encrypted_value FROM\ncookies\n\n```\nThe list of queries to the Firefox’s database:\n```\nSELECT host, path, isSecure, expiry, name, value FROM moz_cookies\nSELECT fieldname, value FROM moz_formhistory\n\n```\nAll the found files are packed into a TAR archive and sent to the CnC.\n\n\n-----\n\nSimilarly, it creates a “passff.tar” archive with stolen Firefox profiles:\n\n\n-----\n\n**Hooking browsers**\n\nAs mentioned earlier, the malware attacks and hooks browsers. Since the analogical\nfunctionality is achieved by different functions within different browsers, a set of installed\nhooks may be unique for each.\n\nFirst, the malware searches for targets among the running processes. It uses the following\nalgorithm:\n\n\n-----\n\n[It is similar to the one from the previous version (described here), yet we can see a few](https://www.fortinet.com/blog/threat-research/deep-dive-icedid-malware-analysis-of-child-processes/_jcr_content/root/responsivegrid/image_547012751.img.png/1563813325832/iceid3-08.png)\nchanges, i.e. the checksums are modified, and some additional checks are added. Yet, the\nlist of the attacked browsers is the same, including the most popular ones: Firefox, MS Edge,\nInternet Explorer, and Chrome.\n\nThe browsers are first infected with the dedicated IcedID module. Just like all the modules in\nthis edition of IcedID, the browser implant is a headerless PE file. Its reconstructed version is\navailable here:\n[9e0c27746c11866c61dec17f1edfd2693245cd257dc0de2478c956b594bb2eb3.](https://www.virustotal.com/gui/file/9e0c27746c11866c61dec17f1edfd2693245cd257dc0de2478c956b594bb2eb3/detection)\n\nAfter being injected, this module finds the appropriate DLLs in the memory of the process\nand sets redirections to its own code:\n\nParsing the instructions and installing the hooks:\n\n\n-----\n\nThen, the selected API functions are intercepted and redirected to the plugin. Usually the\nhooks are installed at the beginning of functions, but there are exceptions to this rule. For\nexample, in case of Internet Explorer, a function within the mswsock.dll has been intercepted\nin between:\n\nLooking at the elements in memory involved in intercepting the calls: the browser implant\n(headerless PE), and the additional memory page:\n\n\n-----\n\nExample of the hook in Firefox:\n\nStep 1: the function SSL_AuthCertificateHook has a jump redirecting to the implanted\nmodule:\n\nStep 2: The implanted module calls the code from the additional page with appropriate\nparameters:\n\nStep 3: The code at the additional page is a patched fragment of the original function. After\nexecuting the modified code, it goes back to the original DLL.\n\n\n-----\n\nThe functionality of this hook didn’t change from the previous version.\n\n**Webinjects**\n\nThe bot gets the configuration from the CnC in the form of .DAT files that were mentioned\nbefore. First, the file is decoded by RC4 algorithm. The output must start from the “zeus”\nkeyword, and is further encoded by a custom algorithm. Scripts dedicated for each site are\nidentified by a script ID.\n\n\n-----\n\nAfter the files are loaded and decoded, we can see the content:\n\n\n-----\n\nThere are multiple types of webinjects available to perform by the bot:\n\nDepending on the configuration, the bot may replace some parts of the website’s code, or\nadd some new, malicious scripts.\n\n\n-----\n\n**Executing remote commands**\n\nIn case the commands implemented by the bot are not enough for the needs of the operator,\nthe bot allows a feature of executing commands from the command line.\n\nThe output of the run commands is sent back to the malware via named pipe, and then\nsupplied back to the CnC.\n\n## Mature banker and stealer\n\nAs we can see from the above analysis, IcedID is not only a banking Trojan, but a generalpurpose stealer able to extract a variety of credentials. It can also work as a downloader for\nother modules, including covert ones, that look like harmless PNG files.\n\nThis bot is mature, written by experienced developers. It deploys various typical techniques,\nincluding Zeus-style webinjects, hooks for various browsers, hidden VNC, and backconnect.\nIts authors also used several known obfuscation techniques. In addition, the use of\ncustomized PE headers is an interesting bonus, slowing down static analysis.\n\nIn recent updates, the malware authors equipped the bot with steganography. It is not a\nnovelty to see it in the threat landscape, but it is a feature that makes this malware a bit more\nstealthy.\n\n## Indicators of Compromise\n\nSandbox runs:\n\nhttps://app.any.run/tasks/8595602a-fa98-4cfa-80d7-98925091dc48/\n\nhttps://app.any.run/tasks/a7abba78-cf6d-4c68-b94c-4835d5becb13/\n\n## MITRE\n\n\n-----\n\nExecution:\n\nCommand-Line Interface\n**Execution through Module Load**\n**Scheduled Task**\nScripting\nWindows Managment Intstrumentation\n\nPersistence:\n\n**Registry Run Keys/ Startup Folder**\n**Scheduled Task**\n\nPrivilege Escalation\n\n**Scheduled Task**\n\nDefense Evasion\n\nScripting\n\nCredential Access\n\n**Credentials in Files**\nCredential Dumping\n\nDiscovery\n\nNetwork Share Discovery\nQuery Registry\nRemote System Discovery\nSystem Information Discovery\nSystem Network Configuration Discovery\n\nLateral Movement\n\n**Remote File Copy**\n\nSource: [https://app.any.run/tasks/48414a33-3d66-4a46-afe5-c2003bb55ccf/](https://app.any.run/tasks/48414a33-3d66-4a46-afe5-c2003bb55ccf/)\n\n## References\n\nAbout the old variants of IceID:\n\n[Deep Dive Into IcedID Malware – by Kai Lu, Fortinet: [1][2][3]](https://www.fortinet.com/blog/threat-research/icedid-malware-analysis-part-one.html)\nhttps://medium.com/@dawid.golak/icedid-aka-bokbot-analysis-with-ghidra560e3eccb766\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-12-03 - New version of IcedID Trojan uses steganographic payloads.pdf"
    ],
    "report_names": [
        "2019-12-03 - New version of IcedID Trojan uses steganographic payloads.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c3c864b3-fac9-4d56-8500-7c06c829fbf8",
            "created_at": "2023-01-06T13:46:39.071873Z",
            "updated_at": "2025-03-27T02:00:02.990045Z",
            "deleted_at": null,
            "main_name": "TA2101",
            "aliases": [
                "Storm-0216",
                "DEV-0216",
                "UNC2198",
                "Maze Team",
                "TWISTED SPIDER",
                "GOLD VILLAGE"
            ],
            "source_name": "MISPGALAXY:TA2101",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "870f6f62-84f5-48ca-a18e-cf2902cd6924",
            "created_at": "2022-10-25T15:50:23.303818Z",
            "updated_at": "2025-03-27T02:00:55.435309Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "APT32",
                "SeaLotus",
                "OceanLotus",
                "APT-C-00",
                "Canvas Cyclone"
            ],
            "source_name": "MITRE:APT32",
            "tools": [
                "Mimikatz",
                "ipconfig",
                "Kerrdown",
                "Cobalt Strike",
                "SOUNDBITE",
                "OSX_OCEANLOTUS.D",
                "KOMPROGO",
                "netsh",
                "RotaJakiro",
                "PHOREAL",
                "Arp",
                "Denis",
                "Goopy"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e9f85280-337c-4321-b872-0919f8ef64a6",
            "created_at": "2022-10-25T16:07:24.261761Z",
            "updated_at": "2025-03-27T02:02:10.153781Z",
            "deleted_at": null,
            "main_name": "TA2101",
            "aliases": [
                "Gold Village",
                "Maze Team",
                "TA2101",
                "Twisted Spider"
            ],
            "source_name": "ETDA:TA2101",
            "tools": [
                "7-Zip",
                "Agentemis",
                "BokBot",
                "Buran",
                "ChaCha",
                "Cobalt Strike",
                "CobaltStrike",
                "Egregor",
                "IceID",
                "IcedID",
                "Mimikatz",
                "PsExec",
                "SharpHound",
                "VegaLocker",
                "WinSCP",
                "cobeacon",
                "nmap"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "af509bbb-8d18-4903-a9bd-9e94099c6b30",
            "created_at": "2023-01-06T13:46:38.585525Z",
            "updated_at": "2025-03-27T02:00:02.866727Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "TIN WOODLAWN",
                "OceanLotus Group",
                "OceanLotus",
                "Sea Lotus",
                "G0050",
                "Cobalt Kitty",
                "SeaLotus",
                "ATK17",
                "Ocean Lotus",
                "Ocean Buffalo",
                "POND LOACH",
                "Canvas Cyclone",
                "APT-C-00",
                "APT-32",
                "APT 32"
            ],
            "source_name": "MISPGALAXY:APT32",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2439ad53-39cc-4fff-8fdf-4028d65803c0",
            "created_at": "2022-10-25T16:07:23.353204Z",
            "updated_at": "2025-03-27T02:02:09.749502Z",
            "deleted_at": null,
            "main_name": "APT 32",
            "aliases": [
                "APT 32",
                "APT-C-00",
                "APT-LY-100",
                "ATK 17",
                "Lotus Bane",
                "Ocean Buffalo",
                "OceanLotus",
                "Operation Cobalt Kitty",
                "Operation PhantomLance",
                "Pond Loach",
                "SeaLotus",
                "SectorF01",
                "Tin Woodlawn"
            ],
            "source_name": "ETDA:APT 32",
            "tools": [
                "Agentemis",
                "Android.Backdoor.736.origin",
                "AtNow",
                "Backdoor.MacOS.OCEANLOTUS.F",
                "BadCake",
                "CACTUSTORCH",
                "CamCapture Plugin",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "Cuegoe",
                "DKMC",
                "Denis",
                "Goopy",
                "HiddenLotus",
                "KOMPROGO",
                "KerrDown",
                "METALJACK",
                "MSFvenom",
                "Mimikatz",
                "Nishang",
                "OSX_OCEANLOTUS.D",
                "OceanLotus",
                "PHOREAL",
                "PWNDROID1",
                "PhantomLance",
                "PowerSploit",
                "Quasar RAT",
                "QuasarRAT",
                "RatSnif",
                "Remy",
                "Remy RAT",
                "Rizzo",
                "Roland",
                "Roland RAT",
                "SOUNDBITE",
                "Salgorea",
                "Splinter RAT",
                "Terracotta VPN",
                "Yggdrasil",
                "cobeacon",
                "denesRAT",
                "fingerprintjs2"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535724,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653775336,
    "ts_modification_date": 1653775336,
    "files": {
        "pdf": "https://archive.orkl.eu/9e0fd67da94b29d142cb7a6a4392d09ff2c6bde3.pdf",
        "text": "https://archive.orkl.eu/9e0fd67da94b29d142cb7a6a4392d09ff2c6bde3.txt",
        "img": "https://archive.orkl.eu/9e0fd67da94b29d142cb7a6a4392d09ff2c6bde3.jpg"
    }
}