{
    "id": "1d8a70c8-ca9c-43ba-a73c-d464cf865367",
    "created_at": "2023-01-12T15:04:22.701893Z",
    "updated_at": "2025-03-27T02:15:17.34073Z",
    "deleted_at": null,
    "sha1_hash": "a75b65c33652c889c1de6a9c96832ea0a5789ca6",
    "title": "2019-07-22 - APT33 PowerShell Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T17:33:08Z",
    "file_modification_date": "2022-05-28T17:33:08Z",
    "file_size": 384441,
    "plain_text": "# APT33 PowerShell Malware\n\n**norfolkinfosec.com/apt33-powershell-malware/**\n\nnorfolk July 22, 2019\n\nIn late June, [multipleresearchers and security entities (including researchers from ClearSky,](https://twitter.com/James_inthe_box/status/1139253915608686592)\n[FireEye, and](https://twitter.com/ItsReallyNick/status/1146198097112051713) [U.S. Cybercom) highlighted APT33 activity in public outlets. Several of these](https://twitter.com/CNMF_VirusAlert/status/1146130046127681536)\nfiles have already been identified and analyzed as part of ongoing discussions on Twitter\nregarding this activity.\n\nThis blog post examines a file identified through public resources with infrastructure links to\nthese attacks that has not been widely examined.\n\nAs part of this activity, researchers identified the C2 domain “backupaccount[.]net” as a C2\nused within a malicious HTA file hosted on attacker infrastructure. A PassiveTotal pivot at the\ntime of this writing highlights 11 hashes associated with this domain. PassiveTotal accounts\nare free, but also do not offer the context behind these hash associations.\n\nOf these 11 hashes:\n\n– Eight are on VirusTotal.\n\n– Two appear to be malicious documents related to this threat.\n\n[– One appears to be an AutoIt file documented in open source.](https://twitter.com/ochsenmeier/status/1142778636203888647)\n\n[– Three appear to be malicious HTML/HTA files.](https://twitter.com/KorbenD_Intel/status/1139249692028653570)\n\n– Two appear to be malicious PowerShell scripts.\n\nOne of these scripts appears to be fairly unique, and work additional analysis:\n\n\n-----\n\nMD5: 985797eb1a75f297359bf52aa7c27715\nSHA1: 2c2cc6c42c6ccf74d96e5913277537679ec20fba\nSHA256: 6bea9a7c9ded41afbebb72a11a1868345026d8e46d08b89577f30b50f4929e85\n\nImmediately, the connection between this hash and the C2 server is clear. The malware\ncontains a variable on the first line, $SRVURL, containing this domain.\n\n**Configuration for PowerShell file**\n\nInitial Analysis\n\nThe malware defines the following 14 functions:\n\n– Privilege\n– Join\n– Http-request\n– Decrypt\n– Encrypt\n– upload\n– download\n– capture\n– Poster\n– Receiver\n– Timer-post\n– Functioner\n– Functioner\n– Loop\n\nThe malware enters a “while loop” (with a switch statement for “active” and “silent” mode,\nexplained later) first calling the “Poster” function alongside a notification message for the C2.\nThe “Encrypt” function is used to encrypt this message, and “Poster” will create a new\nWebClient object, using this to send a web request to the previously specified server.\n\n\n-----\n\n**While Loop, which first**\n\n**calls the “Poster” function (and subsequently calls the “Loop” function)**\n\n**Poster Function,**\n\n**which sends a message to the C2 server**\nAfter the “Poster” function, the malware calls the “Loop” function. This function serves as the\nprimary C2 workflow for the malware. The malware will use the Receiver function (which in\nturn calls the Http-request function) to send a message to the C2 server (masked as a\nJSON). The response from this function will be parsed, with a string check to see if the\nbeginning of the response matches the string of a command.\n\n\n-----\n\n**Start of the command loop**\n\nCommand Structure\n\nThe following values are checked against the command string:\n\n– interactive\n\n– sleep\n\n– cmd\n\n– exit\n\n– left\n\n– Join\n\n– upload\n\n– download\n\n– pass\n\n– ldap\n\n– sam\n\n– capture\n\nEach successful parsing will typically send a message to the C2 to confirm that the\ncommand has been received. A handful of commands only require short explanations. The\n“interactive” command expects a second numerical value to be part of the C2 response. If\nthis value is 0, the malware sets itself to silent mode. If the value is greater than 299, it sets\nitself to active mode. If neither is true, it informs the operator that a valid value needs to be\nspecified. These modes appear to modify the interval between requests, with active choosing\na value between five and ten seconds and passive choosing a value between 45 minutes\nand 70 minutes.\n\n\n-----\n\n**Difference in request**\n\n**interval depending on the mode**\n\nThe “sleep” command simply sets the mode to silent and breaks the C2 loop. The “cmd”\ncommand will inform the operator that they need to do “cmd /c” (to run the command\nsilently), and the “exit” command will inform the user that they need to use the “close”\ncommand” to terminate the malware.\n\nThe next two commands (“Join” and “left”) can be thought of as a pair. The “join” command\nwill call the “join” function, and it expects the parsed C2 command to contain two additional\nvalues passed to this function: a “method” and a “command.” Looking at the function, there\nare two valid methods: “wmi” and “reg”\n\nThe “wmi” method accepts the commands “check” and “remove.” If neither is specified, the\nmalware will create a WMI event filter as a persistence method. If “check” is specified, the\nmalware will use the “Privilege” function to determine if it has sufficient privileges to perform\nsuch an action (and will inform the operator if it does not). “Remove” will remove any event\nfilter created.\n\n\n-----\n\n**WMI workflow within the “join” function**\n\nThe “reg” method provides an alternative persistence mechanism. The malware will check to\nsee if there is an entry for a file named smrsservice.exe within the HKCU\nCurrentVersion\\Run key. If the “add” command has been passed, it will create this key if it\ndoes not already exist (and inform the operator if the key has already been written). It will\nthen download a file with this name to the users $env:APPDATA folder. The nature of this file\nis unknown, but it may serve as an additional payload or a mechanism for executing this\nPowerShell script.\n\nThe “reg” method also supports a “check” command (which reports if this registry value\nalready exists) and a “remove” command (which removes the registry entry).\n\nAs previously mentioned, this overall “join” command is paired with the “left” command. If the\nC2 server specifies the “left” command, the malware will run the “remove” commands within\nthe “join” function to perform the removal tasks described above. It will do this for both\nmethods.\nThe next two commands are “download” and “upload.” Download will transfer a file from the\nvictim to the attacker, whereas “upload” will push a file from the attacker to the victim device.\nThe download command actually recursively traverses a directory specified by the attacker,\nuploading each file within this directory:\n\n\n-----\n\n**Download function**\n\nThe next three commands appear to have external dependencies. “Pass” appears to expect\nan external PowerShell module named “invoke-pass” to be transmitted by the C2, although it\nis unclear what this would be/ Similarly, “ldap” expects to execute an “ldapCommand” parsed\nfrom the C2 response, and “sam” also appears to attempt to execute an additional script. As\nthese were unavailable at the time of this analysis, this blog can only speculate from the\ncommand names that these might be intended for additional reconnaissance.\n\nThe “capture” command simply takes a screenshot, using a mechanism relatively common\nfor malicious scripts of this nature:\n\n**Screenshot routine**\n\nFinally, if no “official” command is specified, the malware will attempt to run the C2 response\nas a PowerShell command via “iex” (invoke-expression). It will send the results of this\ncommand to the C2 server via the same Poster function.\n\nAt this point, the command loop will continue.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-22 - APT33 PowerShell Malware.pdf"
    ],
    "report_names": [
        "2019-07-22 - APT33 PowerShell Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "b23e717c-0b27-47e0-b3c8-4defe6dd857f",
            "created_at": "2023-01-06T13:46:38.367369Z",
            "updated_at": "2025-03-27T02:00:02.815758Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "ATK35",
                "Peach Sandstorm",
                "TA451",
                "APT 33",
                "Elfin",
                "Refined Kitten",
                "MAGNALLIUM",
                "HOLMIUM",
                "COBALT TRINITY",
                "G0064"
            ],
            "source_name": "MISPGALAXY:APT33",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9fe49a5b-f3e6-4fbf-99a1-db15dad460c3",
            "created_at": "2024-05-01T02:03:08.045004Z",
            "updated_at": "2025-03-27T02:05:17.325038Z",
            "deleted_at": null,
            "main_name": "COBALT TRINITY",
            "aliases": [
                "Elfin ",
                "HOLMIUM ",
                "MAGNALIUM ",
                "Peach Sandstorm ",
                "Refined Kitten ",
                "TA451 ",
                "APT33 "
            ],
            "source_name": "Secureworks:COBALT TRINITY",
            "tools": [
                " Cadlotcorg",
                " Dello RAT",
                " Imminent Monitor",
                " KDALogger",
                " Koadic",
                " NanoCore",
                " NetWire",
                " POWERTON",
                " PoshC2",
                " Poylog",
                " PupyRAT",
                " Schoolbag",
                "AutoCore"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e5ff825b-0456-4013-b90a-971b93def74a",
            "created_at": "2022-10-25T15:50:23.824058Z",
            "updated_at": "2025-03-27T02:00:55.553346Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "APT33",
                "HOLMIUM",
                "Elfin",
                "Peach Sandstorm"
            ],
            "source_name": "MITRE:APT33",
            "tools": [
                "PowerSploit",
                "AutoIt backdoor",
                "PoshC2",
                "Mimikatz",
                "NanoCore",
                "DEADWOOD",
                "StoneDrill",
                "POWERTON",
                "LaZagne",
                "TURNEDUP",
                "NETWIRE",
                "Pupy",
                "ftp",
                "Shamoon"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535862,
    "ts_updated_at": 1743041717,
    "ts_creation_date": 1653759188,
    "ts_modification_date": 1653759188,
    "files": {
        "pdf": "https://archive.orkl.eu/a75b65c33652c889c1de6a9c96832ea0a5789ca6.pdf",
        "text": "https://archive.orkl.eu/a75b65c33652c889c1de6a9c96832ea0a5789ca6.txt",
        "img": "https://archive.orkl.eu/a75b65c33652c889c1de6a9c96832ea0a5789ca6.jpg"
    }
}