{
    "id": "338c2348-393d-4d4e-906d-d88d62c66efb",
    "created_at": "2023-01-12T15:05:52.212297Z",
    "updated_at": "2025-03-27T02:05:42.848565Z",
    "deleted_at": null,
    "sha1_hash": "7f5316c760ec8c89dd1205f1a2289483ef291893",
    "title": "2021-05-14 - AHK RAT Loader Used in Unique Delivery Campaigns",
    "authors": "",
    "file_creation_date": "2022-05-28T17:09:43Z",
    "file_modification_date": "2022-05-28T17:09:43Z",
    "file_size": 1598971,
    "plain_text": "# AHK RAT Loader Used in Unique Delivery Campaigns\n\n**[blog.morphisec.com/ahk-rat-loader-leveraged-in-unique-delivery-campaigns](https://blog.morphisec.com/ahk-rat-loader-leveraged-in-unique-delivery-campaigns)**\n\n[Tweet](https://twitter.com/share)\n\n\n-----\n\n## Intro:\n\nThe Morphisec Labs team has tracked a unique and ongoing RAT delivery campaign that\nstarted in February of this year. This campaign is unique in that it heavily uses the\n[AutoHotKey scripting language—a fork of the AutoIt language that is frequently used for](https://en.wikipedia.org/wiki/AutoHotkey)\ntesting purposes.\n\nStarting in February, we identified at least four versions of the RAT delivery campaign, each\nof which includes multiple advancements and adaptations over the past three months.\n\nIn this blog post, we will dive into the details of each attack chain, while highlighting\ninteresting and rare techniques that the attackers use, including:\n\n[Manifest flow hijack through VbsEdit manipulation](https://www.vbsedit.com/)\nUAC bypass\nEmulator bypass\nTampering with Microsoft Defender and other antivirus products\nIn-place compilation\nDelivery through text share services\n\n## Technical details:\n\n\n-----\n\nThe RAT delivery campaign starts from an AutoHotKey compiled script. This is a standalone\nexecutable that contains the following: the AHK interpreter, the AHK script, and any files it\n[has incorporated via the FileInstall command. In this campaign, the attackers incorporate](https://www.autohotkey.com/docs/commands/FileInstall.htm)\nmalicious scripts/executables alongside a legitimate application to disguise their intentions.\n\nFigure 1: Malicious scripts alongside legitimate executables\n\nWe observed various RATs distributed via a simple AHK compiled script. We also identified\nseveral attack chains linked to this campaign, all of which start with an AHK executable that\nleads to the different VBScripts that eventually load the RAT. In this blog, we are going to\ncover the technical details for each of the observed attack chains shown in the below figure.\n\n\n-----\n\n**Figure 2: Possible attack chains.**\n\n### VjW0rm/Houdini chain\n\nThe attack chain that delivers the VjW0rm and Houdini RAT is the first one we saw using this\nLoader. This attack chain was first used utilizes thein February 2021 and is still in use as of\ntoday. We observed several changes over time and we will describe them below:\n\n**Version 1**\n\n**First seen: February 17, 2021**\n\n**Hash: 40e8b99b36739c397f8f0da2ab40f62b3af3da8b3f43fc2537841a9bf9105584**\n\n**Figure 3: The first version of the AHK script**\n\nFirst, the AHK script drops a legitimate application to the %appdata% directory and executes\nit. Next, it drops two files into the %programdata% directory. The first file is called\n_conhost.exe and the second file is called conhost.exe.manifest (malicious manifest). Then_\nthe script executes the legitimate conhost.exe application, which leads to the execution of\nthe malicious manifest through a path hijack.\n\n[Those files are the outcome of a tool called VbsEdit. The attacker uses VBsEdit to convert](https://www.vbsedit.com/)\nthe VjW0rm and Houdini VBScript into an executable.\n\n\n-----\n\n**Figure 4: A VbsEdit tool used to convert to script**\n\nThe tool creates a manifest (XML) file that holds the base64 encoded VBScript and\ninformation about how to execute the script. This manifest file needs to be located alongside\nthe launcher (called conhost.exe). The launcher itself is a legitimate tool without any\ndetections in VirusTotal.\n\n\n-----\n\n**Figure 5: The manifest file**\n\n**Version 2**\n\n**First seen: March 31, 2021**\n\n**Hash: 825be2ef1143b610633150d7f2bbd5189a3e5939c21a6056283106069c7bc313**\n\nIn this version, the attacker wrapped the dropped RAT with an additional AHK executable.\nThey also added the ability to disable Microsoft Defender by dropping a Batch script and an\nLNK file pointing to that script.\n\n**Figure 6: Added the ability to disable Defender**\n\nWhen executing the LNK file, the Batch script starts to perform several Powershell\ncommands.\n\n\n-----\n\n**Figure 7: The script used to disable Defender**\n\n[The commands download a known hacking tool that disables Defender](https://www.youtube.com/watch?v=qlQ_353mwiM)\n(DefenderControl.exe v1.7) through an additional Powershell script that performs a known\ndisk cleanup UAC bypass technique. This bypass allows the attacker to gain the higher\nprivileges necessary to disable Microsoft Defender (assuming the user is also an\nadministrator).\n\n**Figure 8: Disk Cleanup UAC bypass**\n\nOnce Defender has been disabled, the AHK drops an additional AHK\nexecutable(CONHOSTHOST.exe). This AHK executable utilizes the VBS launcher technique\nshown in previous versions.\n\n**Figure 9: The second AHK executable.**\n\n**Version 3**\n\n\n-----\n\n**First seen: April 8, 2021**\n**Hash: 16142a05c08de5cc69c1fb13924df2861e81b48e5ca5e0ef3f71684cfa3aeb55**\n\nTwo more capabilities were added in this version:\n\nThe first drops and executes a VBScript that blocks connections to popular Antivirus\nsolutions by manipulating the victim’s C:\\Windows\\System32\\drivers\\etc\\hosts file. This\nmanipulation denies the DNS resolution for those domains by resolving the localhost IP\naddress instead of the real one.\n\n**Figure 10: The data written to the host’s file.**\n\nThe second drops and executes a VBScript that terminates wscript.exe processes to\nclean traces of a failed attempt to perform the previous VBScript.\n\n**Version 4**\n\n**First seen: May 2, 2021**\n\n**Hash: fb63eea2503686f90c4c2ec9a74407a2d5a1211e8a1566ae1da63f0d1d9e2cad**\n\nIn this version, the attacker added directory-creation spamming that creates around 10\ndirectories and subdirectories, then overrides the call numerous times. Though the attacker's\nintentions are not clear at this point, this might be a technique to introduce noise or to spam\nan emulator.\n\n\n-----\n\n**Figure 11: Directory-creation spamming**\n\nAdditionally, a new VBScript is dropped into %ProgramData%\\kellvbs.vbs. This script leads\n[to a new variant of our previously researched HCrypt. It ends up delivering njRAT with the](https://blog.morphisec.com/tracking-hcrypt-an-active-crypter-as-a-service)\nsame C2 address as the Vjw0rm that has been dropped by the VBScript launcher.\n\nIn the second stage, AHK drops a Batch script that hides the manifest file, so that only the\nbenign VBS launcher called conhost.exe will be visible to the victim.\n\n**Figure 12: Hiding the manifest file**\n\n### Powershell loader chain\n\nThis attack chain first appeared in late April 2021. It has a strong resemblance to the\npreviously described chain, except for the delivery technique and the RAT distribution used.\nIn this chain, we have observed LimeRAT and RevengeRAT loaded as the final payload.\nBoth of the delivered RATs communicate to the same C2 address - gamers2020.ownip[.]net.\n\n**Version 1**\n\n**First seen: April 26, 2021**\n\n**Hash: c7165a80a5233ff799a7cdb0de9d1dafc7c40e4b31db01226b3d975411ceb59e**\n\n\n-----\n\n**Figure 13: The AHK second chain script.**\n\nThe RAT is delivered by an obfuscated VBScript (as shown in Figure 14) that is dropped to\nthe victims %ProgramData% directory. This script deobfuscates a PowerShell command that\ndownloads the next stage from a Pastebin-like sharing platform service called stikked.ch.\n\n\n-----\n\n**Figure 14: Obfuscated VBScript downloads and executes PowerShell from a Pastebin**\nservice.\n\nThe Powershell stage from the paste embeds the next stage as a C# source code\nrepresented in a hexadecimal encoded blob ($Win32Runpe in Figure 15). To execute the\nnext stage, the Powershell decodes the blob, compiles and saves it into the %temp%\ndirectory under the name RegAsm.exe, then executes the compiled executable.\n\nWe notice that the author compiled the executable with `GenerateExecutable=true` which is\nuncommon for attackers, as he could compile the executable in memory by setting the flag\n_`GenerateInMemory=true`. This might be an evasion attempt as many solutions are looking_\nfor this flag.\n\n\n-----\n\n**Figure 15: PowerShell script from stikked.ch Pastebin.**\n\nThe C# source code embeds the RAT payload as an AES encrypted blob (Buffer in Figure\n16). The keys are embedded in the source code as well. In order to execute the RAT\npayload, it decrypts the blob, reflectively loads the decrypted payloads, then invokes it.\n\n\n-----\n\n**Figure 16: C# source code.**\n\n**Version 2**\n\nFirst seen: April 26, 2021\n\nHash: 24fdf42e2c026708b3ed29fe6791190e3a40c2dca063bfd8233c974f373e775f\n\nIn this version, the attacker added a hexadecimal obfuscation layer to the VBScript and used\na different PowerShell paste (hxxps://stikked[.]ch/view/raw/5d4df3b8) to load the RAT.\n\n\n-----\n\nThe PowerShell script used in this attack is a notorious one that is observed in several other\n[RAT campaigns (1,](https://blog.morphisec.com/tracking-hcrypt-an-active-crypter-as-a-service) [2,](https://yoroi.company/research/new-cyber-operation-targets-italy-digging-into-the-netwire-attack-chain/) [3). It holds two hexadecimal blobs. The first one is a .NET DLL that is](https://isc.sans.edu/diary/From+a+small+BAT+file+to+Mass+Logger+infostealer/26946)\nused for injecting the second hexadecimal payload, which is the RAT.\n\n**Figure 17: PowerShell script from stikked.ch Pastebin.**\n\n**HCrypt Chain**\n\nFirst seen: April 21, 2021\n\nHash: d9b6a27e17fbf09801a848e3b42206b3a02e728207e9c1bd4e1e2a56294aba7c\n\nThis chain is slightly different from the others, as the AHK script bundled files have different\nnaming conventions and don’t include the VBS launcher. We will explain the connection and\nsimilarity to this campaign in the next section.\n\nSimilar to previous chains, the AHK script drops and executes a legitimate application. Next,\nit drops and executes a VBScript that downloads and executes an in-memory PowerShell\nscript that leads to [HCrypt. HCrypt is known as a RAT loader. In this campaign, we observed](https://blog.morphisec.com/tracking-hcrypt-an-active-crypter-as-a-service)\nAsyncRAT as the loaded RAT.\n\n\n-----\n\n**Figure 18: The VBScript that leads to HCrypt.**\n\n## Fingerprinting the campaign\n\nIn this campaign, we described various attack chains. We can attribute them to the same\nactor based on the following:\n\nThey all drop a legitimate application before performing any malicious activity.\nThey have the same resource naming convention across all of the versions: *.MP4,\nKELLVBS.VBS, CONHOST.EXE, etc.\nThe AHK script has a strong resemblance across all of the chains, using the same\ncommands: FileInstall, run, sleep, and drop the files to the %ProgramData% directory.\nIn several attack chains, we observed the same directory spamming technique.\nThey use the same scripts and UAC bypass technique to disable the Defender (in\ndifferent stages).\n\n## Conclusion\n\nAs threat actors study baseline security controls like emulators, antivirus, and UAC, they\ndevelop techniques to bypass and evade them. The technique changes detailed in this report\ndid not affect the impact of these campaigns. The tactical goals remained the same. Rather,\nthe technique changes were to bypass passive security controls. A common denominator\namong these evasive techniques is the abuse of process memory because it's typically a\nstatic and predictable target for the adversary.\n\nWe still need these baseline controls to keep the automated attacks at bay. But the manual\ntradecraft employed by innovative attackers like this one require a modern approach to\nsecurity. [Morphisec Guard offers control and visibility of these baseline controls while adding](https://www.morphisec.com/products/morphisec-guard-endpoint-protection)\nadvanced breach prevention for in-memory exploits and evasive fileless techniques like\nthose used in these campaigns. If you are experiencing a breach or would like a proactive\n[audit of your critical assets, Morphisec’s team of researchers is available to assist.](https://engage.morphisec.com/experiencing-a-breach?hsCtaTracking=141b6328-6633-46fc-afa8-ed8fa8e94a9c%7Cd6e35c2a-5a02-4be0-8746-061061ef9f4a)\n\n## IOCs\n\n### AHK\n\n40e8b99b36739c397f8f0da2ab40f62b3af3da8b3f43fc2537841a9bf9105584\n5181018a9ad6d851adce6768cd01a5d10c2bd0b0180c75e92a3ce00827624bae\n\n\n-----\n\n### C2s\n\n\n06d23a4c6bcd34a4a4817cb193c2916cd56dd440b022803d5b4c8f68a0951291\n825be2ef1143b610633150d7f2bbd5189a3e5939c21a6056283106069c7bc313\nd9f512ede0ad80c19866666e54ed2d95727c4f3d026a32465db009fac4fc6796\n2df67fbe0455598c0fc2981b3f80a776f85d73b74c6083d34d0fdd1f6c6db30a\n16142a05c08de5cc69c1fb13924df2861e81b48e5ca5e0ef3f71684cfa3aeb55\naa16fe9cd572b39e45e334ba463d26f9fa1187bfaa25daf9775eb200a056f62d\n185e01e26c705e3aa27f3ad33ff1333411c37c28cc7ff108f183947ade1b44ca\n5114f28181ce5659c78cd2bfae35258a9679134fd72d1fdb3572ac3e55317e25\nd9b6a27e17fbf09801a848e3b42206b3a02e728207e9c1bd4e1e2a56294aba7c\ne86d6e2ef1f4efd2a034f8ff7b469841be425dc3eed97b001ae7afefce329165\n0908a9d8c47f6ad062f3be988b2361c68be658be625093a38ea286f9f10edb70\ne24f6b1cb9a91280d8cb990b367f45b0d8c46ec08aef6e4a454d10ce87e67197\nc7165a80a5233ff799a7cdb0de9d1dafc7c40e4b31db01226b3d975411ceb59e\n24fdf42e2c026708b3ed29fe6791190e3a40c2dca063bfd8233c974f373e775f\n03d4bd103fc021ff00b6895d2fcbf204f7aacc1df4ab52418bbd8510f271c692\n0a8a100017fbfa4a203405dfe3a545bb160a229e940dff3768596928bde49f36\n179c76e5640aaa7a3448ae6e617035ab680b625637395f0fc6de88d07ebaa2f9\n65c564cf147a8dad9d243c2d292ebe2ce5d3e52cd36b4d3c51323dd1c5ed05ec\nfb63eea2503686f90c4c2ec9a74407a2d5a1211e8a1566ae1da63f0d1d9e2cad\nac61c8ff51634976c633035b0bcf704407f828a8e9367f0b15cee48fb858842c\n\nhxxp://tahoo.publicvm[.]com:1955\nhxxp://tahoo.publicvm[.]com:9999\nhxxp://tinatahoo.publicvm[.]com:1000\nhxxp://domaineweb.publicvm[.]com:1002\nhxxp://tinda.publicvm[.]com:888\nhxxp://domaineweb.publicvm[.]com:777\nhxxp://janda.publicvm[.]com:1005\nhxxp://gamers2020.ownip[.]net\nhxxp://like-sports.publicvm[.]com:300\nhxxp://facebook-sports.publicvm[.]com:150\nhxxp://volaria.publicvm[.]com:1010\nhxxp://musicnote.soundcast[.]me:90\nhxxp://websites.publicvm[.]com:1003\n\n\n### Disabling Defender & UAC bypass URLs\n\nhxxp://gamecardsy[.]com/ahmadtestupl/kell5.bat\nhxxp://gamecardsy[.]com/ahmadtestupl/kilall.vbs\nhxxp://gamecardsy[.]com/ahmadtestupl/ss.ps1\nhxxp://gamecardsy[.]com/ahmadtestupl/DefenderControl.exe\n\n\n-----\n\nhxxp://gamecardsy[.]com/ahmadtestupl/DefenderKill.txt\nhxxp://gamecardsy[.]com/ahmadtestupl/Defender.bat\nhxxp://gamecardsy[.]com/ahmadtestupl/ff.ps1\nhxxp://gamecardsy[.]com/ahmadtestupl/DefenderControl.txt\nhxxp://firas.alifares[.]org/defender/ff.ps1\nhxxp://firas.alifares[.]org/defender/DefenderControl.ini\nhxxp://firas.alifares[.]org/defender/DefenderControl.exe\nhxxp://firas.alifares[.]org/defender/DefenderKill.lnk\nhxxp://firas.alifares[.]org/defender/Defender.bat\nhxxp://firas.alifares[.]org/defender/kil.ps1\nhxxp://firas.alifares[.]org/defender/11.txt\n\n### Paste URLs\n\nhxxps://stikked[.]ch/view/raw/5d4df3b8\nhxxps://stikked[.]ch/view/raw/f03bc538\n\n[Contact SalesInquire via Azure](http://10.10.0.46/mailto:sales@morphisec.com)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-14 - AHK RAT Loader Used in Unique Delivery Campaigns.pdf"
    ],
    "report_names": [
        "2021-05-14 - AHK RAT Loader Used in Unique Delivery Campaigns.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535952,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653757783,
    "ts_modification_date": 1653757783,
    "files": {
        "pdf": "https://archive.orkl.eu/7f5316c760ec8c89dd1205f1a2289483ef291893.pdf",
        "text": "https://archive.orkl.eu/7f5316c760ec8c89dd1205f1a2289483ef291893.txt",
        "img": "https://archive.orkl.eu/7f5316c760ec8c89dd1205f1a2289483ef291893.jpg"
    }
}