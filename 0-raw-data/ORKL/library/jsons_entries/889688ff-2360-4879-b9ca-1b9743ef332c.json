{
    "id": "889688ff-2360-4879-b9ca-1b9743ef332c",
    "created_at": "2023-01-12T15:05:07.674758Z",
    "updated_at": "2025-03-27T02:05:31.625435Z",
    "deleted_at": null,
    "sha1_hash": "baa3b7c54eb5be9a9fb0beeb3e375eaa2cf5c592",
    "title": "2017-12-15 - In depth analysis of malware exploiting CVE-2017-11826",
    "authors": "",
    "file_creation_date": "2022-05-27T19:01:31Z",
    "file_modification_date": "2022-05-27T19:01:31Z",
    "file_size": 1482041,
    "plain_text": "# In depth analysis of malware exploiting CVE-2017-11826\n\n**gradiant.org/noticia/analysis-malware-cve-2017/**\n\n15/12/2017\n\nAmong the most common malware entry paths, SPAM campaigns have been identified as\nsome of the principals. Normally, these campaigns usually incorporate a malicious link or an\nattached file (usually, an office document that contains a malicious macro).\n\n[On this occasion, Gradiant’ Security and Privacy team has obtained and analysed a sample](https://www.gradiant.org/technologies/seguridad-y-privacidad/)\nof an office document that, instead of incorporating a malicious macro, exploits the 0-day\n[vulnerability identified as CVE-2017-11826 whose patch was published on October 17, 2017.](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11826)\nThe use of this exploit allows the attacker to execute malicious code without the need of any\nuser interaction.\n\nAlthough it is always difficult to attribute an attack, the evidence suggests that it is probably a\nRussian botnet hosted on a US server.\n\n## Vulnerability analysis\n\n**SAMPLE**\n**DATA**\n\nFilename 2.doc\n\n\n-----\n\nSize 664KiB (680268 bytes)\n\nType RTF\n\nDescription Rich Text Format data, version 1, unknown character set\n\nS.O. WINDOWS\n\nSHA256 cb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5\n\nFirst, the OLE objects embedded in the RTF file attached to the mail of the SPAM campaign\nhave been listed:\n\nSpecifically, the exploit lies in the file “./word/document.xml” belonging to the last object OLE\nin the previous figure (object id =2).\n\nAfter analyzing the contents of the file, exploited vulnerability has been classified as type\n_confusion since it takes place in the unexpected object idmap located just after the opening_\nof the label font producing the error in the OOXML analyzer. Additionally, it has been\nobserved that vulnerability requires special conditions that the attacker has taken into\naccount, that is, has declared an object OLEObject just before the label font and added an\nattribute name with the large enough content (greater or equal to 32 Bytes after the\nconversion that takes place on it from UTF-8 to Unicode).\n\n\n-----\n\nIn order to analyze how the attacker exploits the vulnerability, the bytes of the font’s name\nattribute have been observed, obtaining the following hexadecimal representation:\n\nWhich, transformed to unicode and represent them in big endian as it happens in the\nOOXML’s analyzer, result in the following memory address: 0x088888EC\n\nAs you can see in the following image, when the type confusion happens, a pointer is\ndereferenced by obtaining the contents of said memory address, to which the program adds\n4 units and the execution flow is transferred to the address resulting from said sum:\n\n## Exploit analysis. Arbitrary code execution\n\nTo control the contents of the memory address 0x088888EC the attackers have used the\n[technique heap spraying which consists of filling a large proportion of the memory with the](https://en.wikipedia.org/wiki/Heap_spraying)\nrepetition of a sequence of bytes (called spray), so as to maximize the probabilities of finding\n\n\n-----\n\nthat sequence of bytes in memory when your position can not be predicted accurately. In this\ncase, the implementation of this technique has consisted of a large set of objects ActiveX\nwich imports the spray stored in the file activeX1.bin.\n\nAs you can see in the following image that shows part of the content of activeX1.bin, the\nattacker has made heap spraying of two memory addresses: to which the attacker wants the\ndereferenced pointer to point (0x088888EC) and the content that he wants in that memory\nlocation (0x729440CB) which is an address belonging to the library msvbvm60.dll Decreased\nby 4 units to compensate for the increase in 4 units accomplished by the vulnerable OOXML\nparser code.\n\n\n-----\n\nThe attackers loads the library _msvbvm60.dll by its CLSID code as highlighted in the_\nfollowing image. In addition, it has been observed that said library is only loaded in order to\nmake _[“ROP” about her (ROP is a software exploitation technique that allows to evade certain](https://en.wikipedia.org/wiki/Return-oriented_programming)_\nprotections, for example: non-executable memory regions and code signing protections)\n[since this library has disabled DEP y](https://en.wikipedia.org/wiki/Executable_space_protection#Windows) [ASLR protections.](https://en.wikipedia.org/wiki/Address_space_layout_randomization)\n\nBy using “msvbvm60.dll” library existing “ROP Gadgets” (grupos de instrucciones que\n_permiten llevar a cabo la técnica ROP) the attacker gets to give execution permissions to the_\n“shellcode” and redirect the execution flow to the beginning of it.\n\nIt has been observed that the shellcode simply decrypts and executes the embedded\nmalware (a Portable Executable library) and consists of two phases: The first is what is\nknown as “egg hunter”, that means, a code that locates and executes another code. In this\ncase, the “egg hunter” locates the second part of the shellcode in Memory, decipher it and\njump to said deciphered second part. The second part looks for the label 0xBABABABA\n(which is the marker that the attacker has used to indicate the direction in which the malware\nstarts) and it applies a XOR decryption over all the DWORDs that make it up using the key\n_0xCAFEBABE until it reaches the end tag of malware labeled with 0xBBBBBBBB. By last, it_\nuses the key 0xBAADF00D to decipher the document that will replace the original one.\n\n\n-----\n\nAs often happens in Portable Executable files, it contains many zeros. So, when encrypting\nthese zeros with the key, the key is reflected in the encrypted text itself.\n\n\n-----\n\nAs you can see in the previous image, there are multiple appearances of the little endian\n_0xBEBAFECA DWORD, so this implies that, 0xCAFEBABE is the XOR key._\n\nMaking use of this information, a script which performs the extraction and decryption of the\nembedded file allowing the later static analysis has been developed.\n\n————————————————– START CODE ———————————————–\n\n#!/usr/bin/env python\n\n# -*- coding: utf-8 -*\nDECODE_KEY=»CAFEBABE».decode(«hex»)\n\nPE_START_TAG=»BA»*6\n\nPE_END_TAG=»BB»*6\n\nINPUT_FILE=»2.doc»\n\nOUTPUT_FILE=»decoded.vir»\n\n#It reads the document bytes\n\nf=open(INPUT_FILE,»rb»)\n\nbytes_doc=f.read()\n\nf.close()\n\n\n-----\n\n#It extracts the embebbed bynary file\n\npe_encoded=bytes_doc.split(PE_START_TAG.decode(«hex»))\n\n[1].split(PE_END_TAG.decode(«hex»))[0]\n\n#It decrypts the embebbed file bytes\n\npe_decoded=»»\n\nfor pos in range(0,len(pe_encoded), 4):\n\ntry:\n\npe_decoded+=chr(ord(pe_encoded[pos])^ord(DECODE_KEY[(pos+3)%4]))\n\npe_decoded+=chr(ord(pe_encoded[pos+1])^ord(DECODE_KEY[(pos+2)%4]))\n\npe_decoded+=chr(ord(pe_encoded[pos+2])^ord(DECODE_KEY[(pos+1)%4]))\n\npe_decoded+=chr(ord(pe_encoded[pos+3])^ord(DECODE_KEY[pos%4]))\n\nexcept IndexError:\n\npass\n\n#It saves the embedded malware after its decryption\n\nf=open(OUTPUT_FILE,»wb»)\n\nf.write(pe_decoded)\n\nf.close()\n\n————————————————– END CODE ———————————————–\n\n## Malware analysis\n\nNext we analyze the resulting malware.\n\n**DLL**\n**EMBEDDED**\n\nFilename decoded.vir\n\nSize 277KiB (282950 bytes)\n\nType PE (Portable Executable)\n\nCompiled Thu Sep 21 08:21:08 2017\n\n\n-----\n\nArch. x86\n\nS.O. WINDOWS\n\nSHA256 d6990b2d82680a03ab57cee21e52843872fa770ddf8cfec2e15cf6bef068a61b\n\nFirst, three hardcoded URL directions which belong to the mymyawady.com domain have\nbeen identified:\n\n**URL** **FUNCTIONALITY**\n\n[https://cdn1.mymyawady.com/x4/dll/logo.jpg](https://cdn1.mymyawady.com/x4/dll/logo.jpg) Malicious CAB file\n\n[https://cdn2.mymyawady.com/x4/dll/readme.txt](https://cdn2.mymyawady.com/x4/dll/readme.txt) Malicious CAB file\n\n[https://cdn3.mymyawady.com/x4/dll/info.php](https://cdn3.mymyawady.com/x4/dll/info.php) Gate of the C&C\n\nThen, a whois query has been made over the attacking domain, identifying that it is of\nrussian origin and It was created during the month before the compilation of the document\nembedded library file.\n\n\n-----\n\nIn addition, a DNS historical domain has been obtained, detecting that the day after the\ncreation of the same it pointed to an US IP address (45.77.46.81) from a provider of various\ncloud services (hxxps://www.vultr.com/) that the attackers used to host the malicious load of\nthis malware.\n\nIt has been observed that the malware tries to download the two malicious CAB files hosted\nin the command and control server (C&C) under the names: logo.jpg and readme.txt using\nthe following function:\n\nWhich keeps in temporary paths:\n\n[And decompress in the same directory using the system tool “expand.exe” by using the](https://technet.microsoft.com/es-es/library/cc722332(v=ws.10).aspx)\nparameters that are observed in the image:\n\n\n-----\n\nBy last, the execution of an avgdate.exe file which the malware expects, it was created as\nresult of the CAB decompression has been identified.\n\nFurther, the library is kept in a loop that runs in a 23 seconds frequency until it manages to\ndownload one of these two CAB malwares:\n\n\n-----\n\nIn each iteration, the malicious code collects the following system information.\n\nIt access the Windows registry to obtain the user’s SID.\n\nWhich subsequently builds on the format string: “aSidUserSCompu”:\n\n\n-----\n\nFor example, in the following image you can see an instance of the malware that has filled\nthis string with the information of one of our laboratory machines by including whether or not\nit has been able to download and run C&C hosted malware samples. All of this formatted\ninformation will be sent to the “gate” by sending a “POST” request over the “news” parameter\nwhich the user’s SID is passed.\n\nOn the next screen you can see the “gate” URL address previously mentioned:\n\n\n-----\n\n## Conclusions\n\nOur team have noticed a slight increase in the number of malicious office documents that do\nnot use macros. That is why, it is important to keep the software always up to date.\n\nIt is recommended to consult only those documents and links that are trusted and, in case of\ndoubt, contact the sender by using a secure communication media.\n\n## IOCs\n\ncb3429e608144909ef25df2605c24ec253b10b6e99cbb6657afa6b92e9f32fb5\n9209946f3012a37509cb703f55c58b552361f76507acc4786f7b73f6c5092eae\nc6de846128c9ee10e7894af47c2855e1dc3c7c19f1db0c960f882ab60f522a2e\ncd4679c14349744b0e2bfa4d385afe49c9cb8540196f893f52c8f50c47cddbec\nhxxps://cdn1.mymyawady.com/x4/dll/logo.jpg\nhxxps://cdn2.mymyawady.com/x4/dll/readme.txt\nhxxps://cdn3.mymyawady.com/x4/dll/info.php\n\n_Author: David Alvarez-Perez, researcher at Gradiant’ Security and Privacy team_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-12-15 - In depth analysis of malware exploiting CVE-2017-11826.pdf"
    ],
    "report_names": [
        "2017-12-15 - In depth analysis of malware exploiting CVE-2017-11826.pdf"
    ],
    "threat_actors": [
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535907,
    "ts_updated_at": 1743041131,
    "ts_creation_date": 1653678091,
    "ts_modification_date": 1653678091,
    "files": {
        "pdf": "https://archive.orkl.eu/baa3b7c54eb5be9a9fb0beeb3e375eaa2cf5c592.pdf",
        "text": "https://archive.orkl.eu/baa3b7c54eb5be9a9fb0beeb3e375eaa2cf5c592.txt",
        "img": "https://archive.orkl.eu/baa3b7c54eb5be9a9fb0beeb3e375eaa2cf5c592.jpg"
    }
}