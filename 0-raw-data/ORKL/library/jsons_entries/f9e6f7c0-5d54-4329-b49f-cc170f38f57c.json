{
    "id": "f9e6f7c0-5d54-4329-b49f-cc170f38f57c",
    "created_at": "2022-10-25T16:48:13.915333Z",
    "updated_at": "2025-03-27T02:16:14.165902Z",
    "deleted_at": null,
    "sha1_hash": "31a8d8375950c344cb78209108b22421c173c360",
    "title": "",
    "authors": "",
    "file_creation_date": "2018-11-28T13:30:13Z",
    "file_modification_date": "2018-11-28T13:30:13Z",
    "file_size": 1688118,
    "plain_text": "# MuddyWater Operations in Lebanon\n and Oman\n\n## Using an Israeli compromised domain for a two-stage campaign\n\n#### ClearSky Cyber Security \n\n 11/2018\n\n\n1\n\n\n-----\n\n##### Table of Contents\n\nAbstract ................................................................................................................................................................ 3\n\nAttribution ........................................................................................................................................................ 3\n\nTTPs: ................................................................................................................................................................. 3\n\nTechnical Details ................................................................................................................................................... 5\n\nFirst Stage Analysis ........................................................................................................................................... 5\n\nSecond Stage Analysis ....................................................................................................................................10\n\nVBE Deobfuscation ....................................................................................................................................10\n\nJavaScript Deobfuscation ...........................................................................................................................11\n\nPersistency .................................................................................................................................................12\n\nPOWERSTATS Deobfuscation .....................................................................................................................12\n\nConclusions .........................................................................................................................................................13\n\nPivot ....................................................................................................................................................................14\n\nAppendix - Indicators of Compromise: ...............................................................................................................15\n\nMacro-embedded Documents: ..................................................................................................................15\n\nNetwork Indicators: ...................................................................................................................................16\n\n2\n\n\n-----\n\n### Abstract\n\n\nMuddyWater is an Iranian high-profile threat actor that's been seen active since 2017. The group is known\nfor espionage campaigns in the Middle East. Over the past year, we've seen the group extensively targeting a\nwide gamut of entities in various sectors, including Governments, Academy, Crypto-Currency,\nTelecommunications and the Oil sectors.\n\nMuddyWater has recently been targeting victims likely from Lebanon and Oman, while leveraging\n**compromised domains, one of which is owned by an Israeli web developer.** The investigation aimed to\nuncover additional details regarding the compromise vector. Further, we wished to determine the infection\nvector, which is currently unknown. With that in mind, past experience implies that this might be a two-stage\nspear-phishing campaign.\n\nIn the first stage of the operation the attackers deliver a macro-embedded document. Depending on each\nsample, the content of document is either a fake resume application, or a letter from the Ministry of Justice\nin Lebanon or Saudi Arabia. Note that these documents' content is falsely blurred in order to increase the\nchances of infection. As stated, the obfuscated code used in the campaign was hosted on three compromised\ndomains, including an Israeli domain (pazazta[.]com).\n\nAn interesting aspect of this campaign is that the attackers, uncharacteristically to the group, implemented a\nmanual override to the attack process; which in turn provided them with more control over the payload.\nMoreover, previously the group only executed single-stage attacks; however, this time around they split the\ncourse of attack into two stages. Thus, spreading MuddyWater's main PowerShell Backdoor dubbed\nPOWERSTATS in a stealthier method.\n\nSpecial thanks for the researchers Jacob Soo and Mo Bustami that assisted us.\n\n##### Attribution\n\nAs MuddyWater has consistently been using POWERSTATS as its main tool, they are relatively easy to\ndistinguish from other actors. Nevertheless, this time we observed a slightly similar but different pattern,\ndepicting conservation of TTPs alongside developing new capabilities.\n\nOur findings corroborate several TTPs changes that were foreseen by other researchers. These assessments\nwere based on leaked test documents attributed to the group, that were observed during the past year. It\nappears MuddyWater recent efforts to evolve are beginning to bear fruit, as they also added evasion\ncapabilities to their arsenal.\n\n##### TTPs: \n\nOne of the most noteworthy aspects of MuddyWater's recent transformation is the progression from a singlestage to a two-stage attack process.\n\n1) Malicious macro-embedded document used to launch an Excel process and a PowerShell\n\ncommand as first stage. The group leverages commands execution via 3[rd] party processes (e.g.\nExcel) used not only for POWERSTATS functionality as seen before, but also for first-stage needs pertaining to downloading the second stage from a certain open-directory.\n\n2) Obfuscated source code hosted on compromised domains is retrieved and executed as second\n\nstage for POWERSTATS Backdoor propagation. Main source code consists of PowerShell\ncommands and variables. These variables are then divided into multiple layers of obfuscated\nintertwined encoded VBScript (VBE), JavaScript and PowerShell code.\n\nThis point is of particular importance, as it is the basis for a new three-steps backdoor execution\n**mechanism (this will be further detailed later in the blog).**\n\n3\n\n\n-----\n\nMoreover, it appears MuddyWater operators do not cover their tracks and do not remove their\ncode from these open-directories that are currently accessible and available to everyone.\n\n\n4\n\n\n-----\n\n### Technical Details\n\n\n##### First Stage Analysis\n\nAs previously mentioned, the campaign in Lebanon was recently extended to Oman, as additional documents\nare continually detected. The campaign revolves around several malicious Word documents that pose as either\na fake resume application, or a letter from the Ministry of Justice in Lebanon or Saudi Arabia. In each document\nyou may find a deceptive text and message boxes such as “the document has been made in an old version of\nMicrosoft”. This lure method is common and has been in use systematically by MuddyWater, with the purpose\nof deceiving unsuspecting victims or getting them to click on either “Enable Editing” or “Enable Content”\nbuttons to execute malicious macro.\n\n_Figure 1: Blurred resume document showing a deceptive error message._\n\n5\n\n\n-----\n\n_Figure 2: Blurred document disguised as a letter from the Ministry of Justice in Lebanon_\n\n\n6\n\n\n-----\n\n_Figure 3: Blurred document disguised as a letter from the Ministry of Justice in Saudi Arabia (target from Oman)_\n\nUpon document opening, an authentic but general error message pops up, trying to deceit the victim into\nthinking that there is an apparent compatibility issue responsible for the blurred text. Simultaneously, the\nobfuscated macro code that is executed automatically in the background leads to an Excel process execution\nvia an embedded COM object.\n\nUsing ViperMonkey[1], a VBA emulation engine, we managed to de-obfuscate the parts of the malicious macro.\n\n1  https://github.com/decalage2/ViperMonkey\n\n7\n\n\n-----\n\n_Figure 4: ViperMonkey summary of recorded actions_\n\nAccording to the highlighted output of the tool, we deduce that the macro code is intended to run when the\ndocument is opened, which in turn leads to the creation of an Excel process. This Excel process is immediately\nused as a parent process for running a PowerShell command.\n\n_Figure 5: Logged process tree of first-stage attack (Israeli compromised-server highlighted)_\n\nAs can be seen in the process tree that is provided by Any.Run sandbox, the PowerShell command leads to\ndownloading and executing additional PowerShell code derived from certain compromised domains. Using\nthis method, the attackers have implemented a two-phase attack process, while relying on the need of\ndownloading the main POWERSTATS code from their preferred compromised domains. In this scenario, we\nencountered several samples downloading the same payload, while few samples downloaded a base64\nencoded of the same payload. These files were inserted to an open-directory that is located in each\ncompromised domain several days before the attack occurred. Interestingly, it appears that **MuddyWater**\n**operators do not cover their tracks and do not remove their code from these open-directories.**\n\n8\n\n\n-----\n\n_Figure 6: 3cbc[.]net open-directory hosting second-stage PowerShell code masquerading as an icon.icon file_\n\n_Figure 7: Israeli domain pazazta[.]com open-directory: second-stage PowerShell code masquerading as an icon.png photo_\n\n_Figure 8: ohe[.]ie open-directory hosting second-stage base64 encoded blob masquerading as an icon.png photo_\n\n\n9\n\n\n-----\n\n##### Second Stage Analysis \n\nLooking at the additional PowerShell code that is downloaded from the compromised domains, we identified\nfew variables and commands that perform the following actions:\n\n  - Saving JavaScript, encoded VBScript (VBE) and PowerShell code respectively to three files.\n\n  - Initialization of three-steps backdoor execution mechanism:\n\n1) WScript.exe executes VBE code.\n\n2) CScript.exe executes obfuscated JavaScript code.\n\n3) PowerShell command de-obfuscates and executes POWERSTATS backdoor.\n\n  - Using taskkill command to kill Excel’s process.\n\n_Figure 9: Second-stage PowerShell code downloaded from the compromised domains_\n\n###### VBE Deobfuscation\n\nThe base64 encoded VBScript code is saved to a PowerShell variable called $vbs, then it is decoded and stored\nin another variable named $Content. Its value is saved to the following path:\n\nC:\\Windows\\temp\\Windows.vbe\n```\n$vbs =\"I0B+XlhBQUFBQT09L00rQ0QrfTRMf21EY0pxL15EYndPIFV0K15zSipSSSFVfkoxLzFEcndPfkoybExrXkRid09+Oyk\ntdwlieFtXU2QnLVB/OmEtLUQrczJSTndMSkJQVFMsc2xeZCsvQjhBQUE9PV4jfkAA\"\n\n```\n_Source code 1: base64 encoded VBE code found in the compromised domains_\n\n```\n--> CreateObjzct(\"Wscript.Shell\").Run \"cscript /E:jscript C:\\\\Windows\\\\Tzmp\\\\temp.jpg\", 0, False\n\n```\n\n_Source code 2: base64 decoded VBE code_\n\nThe decoded VBScript code is responsible for running the obfuscated JavaScript code stored in another file\nmasquerading an image file “temp.jpg”. The VBE code is executed using WScript.exe, leading to the JavaScript\ncode execution via CScript.exe. Both Windows Script Host processes are used as a method of executing\ncommands from external files and support various scripting languages.\n\n10\n\n\n-----\n\n_Figure 10: Second-stage process tree depicting Windows Script Host usage_\n\n###### JavaScript Deobfuscation\n\nFrom the second-stage PowerShell code that was downloaded from the compromised domains, an\nobfuscated JavaScript code is stored in a variable named $js. Its content decoded and saved in the following\npath:\n\nC:\\Windows\\Temp\\temp.jpg\n\nWithin the above-mentioned three-steps POWERSTATS execution mechanism, the second step consists of\nrunning the obfuscated base64 encoded JavaScript. This code snippet leverages the Winmgmt WMI service\nclasses Win32_Process and Win32_ProcessStartup.\n```\n$js =\"dmFyIGE9Wyd3Nm5Dc01LQk44TzUnLCdCOE8rd3I5M3dwMDhTakhDbUV3cndybkRvY0tidz[…]\"\n\n```\n_Source code 3: base64 decoded JavaScript code_\n```\nvar a=['w6nCsMKBN8O5','B8O+wr93wp08SjHCmEwrwrnDocKbw4[…]\n\n```\n_Source code 4: Obfuscated decoded JavaScript code_\n\n_Figure 11: De-obfuscated JavaScript Code_\n\nThus, a relevant PowerShell process is created for decoding the main obfuscated POWERSTATS backdoor,\ncompleting the third step towards running the backdoor. This de-obfuscated JavaScript snippet holds a\nPowerShell command that is intended to de-obfuscate and execute the PowerShell backdoor that is\nencapsulated in a C# code. Previously, the obfuscated main backdoor code was stored into a “Microsoft.db”\nfile via the seconds-stage PowerShell file, which was hosted on one of the compromised domains. The full\npath of the main obfuscated backdoor code file:\n\nC:\\ProgramData\\Microsoft.db\n\nIn addition, the group uses various techniques in order to bypass UAC. As seen in the past, MuddyWater\nmakes use of a tool found in the .NET framework called csc.exe, which can be used to compile an executable\nfrom C# code. This means that an attacker doesn’t necessarily need to download a compiled executable to\nthe target’s computer, but can instead download the source code and compile it on the target computer.\n\n11\n\n\n-----\n\n_Figure 12: PowerShell process de-obfuscates and runs POWERSTATS_\n\n###### Persistency\n\nNotice that POWERSTATS backdoor maintain the same persistency mechanism with almost every new\ncampaign. It makes use of a scheduled task named “MicrosoftEdge” (Scheduled task name may differ from\none sample to another) running daily at 12:00 o’clock, which starts the three-steps backdoor’s execution\nmechanism using the following command:\n```\n\"C:\\Windows\\system32\\schtasks.exe\" /Create /F /SC DAILY /ST 12:00 /TN MicrosoftEdge\n/TR \"c:\\windows\\system32\\wscript.exe C:\\Windows\\temp\\Windows.vbe\"\n\n###### POWERSTATS Deobfuscation\n\n```\nThe POWERSTATS backdoor’s code is a multi-layered obfuscated, encoded and compressed blob. As\nmentioned in the upper section, the latter PowerShell command de-obfuscates the main POWERSTATS\nbackdoor’s code, first to a deflated-compressed base64 code. Then, a decoded and decompressed using an\ninflate method, but obfuscated PowerShell code snippet is revealed. Finally, this code is de-obfuscated to\nthe main backdoor code.\n```\n   $code = \"-FJ+QM2?@2CQ1AX1G-,<*+VI.XQ/UW-BQ0RZ2?C1B91=C.ER2[Z1GD0IH[...]\"\n\n```\n_Source code 5: Main POWERSTATS backdoor code hosted on the compromised domains as part of the second-stage_\n```\n$(New-Object IO.StreamReader ($(New-Object IO.Compression.DeflateStream ($(NewObject IO.MemoryStream \n(,$([Convert]::FromBase64String('jX1pdxq7sujnZK38B92sc2PYG[…]')))),\n[IO.Compression.CompressionMode]::Decompress)), [Text.Encoding]::ASCII)).ReadToEnd();\n\n```\n_Source code 6: Main POWERSTATS backdoor code de-obfuscated by the PowerShell command found inside the JavaScript code_\n\n_snippet_\n```\n&(\"{2}{0}{3}{1}\" -f 'R','abLE','set-Va','i') (\"UW\"+(\"{0}{1}\" -f'1r9','P')) ( \"\n)'x'+]31[dIlleHS$+]1[dILleHs$ (& | )421]rAhc[,'Fe5' ecaLperC-[…]\n\n```\n_Source code 7: Main POWERSTATS backdoor code is decoded and decompressed, but still obfuscated_\n\nAlthough we cannot present the full code of the backdoor, we would like to examine part of the backdoor’s\npersistency mechanism. This mechanism involves creating a registry key called “MicrosoftEdge”, with a value\ncorresponds to the command that is responsible to initialize the above-mentioned three-steps backdoor’s\nexecution mechanism:\n```\nstart-sleep (Get-Random -Minimum 10 -Maximum 20)ertChfu -p\n\"HKCU:SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\" -k 'MicrosoftEdge' -v\n'c:\\windows\\system32\\wscript.exe C:\\Windows\\temp\\Windows.vbe'\n\n```\n_Source code 8: POWERSTATS backdoor persistency mechanism found inside the backdoor’s_\n\n12\n\n\n-----\n\n### Conclusions\n\n\nThe Iranian MuddyWater group keeps evolving, improving its capabilities with every new campaign. We\nencourage the security community to harness these IOCs and knowledge to detect and defend from the threat.\n\n13\n\n\n-----\n\n### Pivot\n\n\n14\n\n\n-----\n\n### Appendix - Indicators of Compromise:\n\n\n###### Macro-embedded Documents:\n\n SHA256 Hash File Name Impersonation\n\n 65bd49d9f6d9b92478e3653362c0031919607302db6cfb3a7c1994d20be18bcc MyCV.doc Fake resume\n\n 294a907c27d622380727496cd7c53bf908af7a88657302ebd0a9ecdd30d2ec9d Cv.doc Fake resume\n\n ac360ec9dbf84ab7e26effcb1d28ca4d0ac4381c9376ac1eddee7a8f7f26ccb0 shakva-lb (1).zip Ministry of Justice in\n Lebanon\n\n b6c483536379840e89444523d27ac7828b3eb50342b992d2c8f608450cd7bb53 shakva-lb.doc\n\n a6ba3480f3c7055dce2a7a43c3f70d3d6b266290f917be150a0e17b6ac4a3724 shakva-om.zip Ministry of Justice in\n Saudi Arabia\n\n\n###### e5c56c5b9620fb542eab82bdf75237d179bc996584b5c5f7a1c34ef5ae521c7d shakva-om.doc\n\n15\n\n\n-----\n\n###### Network Indicators:\n\n**Second-stage delivery URLs:**\n\n  - hxxp://3cbc[.]net/dropbox/icon[.]icon\n\n  - hxxp://pazazta[.]com/app/icon[.]png\n\n  - hxxp://ohe[.]ie/cli/icon[.]png\n\n  - hxxp://ohe[.]ie/cp/icon[.]png\n\n**Proxy-List of POWERSTATS backdoor**\n\n  - hxxp://andreabelfi[.]com/main.php\n\n  - hxxp://andreasiegl[.]com/main.php\n\n  - hxxp://andresocana[.]com/main.php\n\n  - hxxp://amorenvena[.]com/main.php\n\n  - hxxp://amphira[.]com/main.php\n\n  - hxxp://amphibiblechurch[.]com/main.php\n\n16\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2018/2018.11.28.MuddyWater-Operations-in-Lebanon-and-Oman/MuddyWater-Operations-in-Lebanon-and-Oman.pdf"
    ],
    "report_names": [
        "MuddyWater-Operations-in-Lebanon-and-Oman"
    ],
    "threat_actors": [
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "31e69945-6c1e-40c3-ba8e-a77e81dd142a",
            "created_at": "2024-05-01T02:03:08.047377Z",
            "updated_at": "2025-03-27T02:05:17.326452Z",
            "deleted_at": null,
            "main_name": "COBALT ULSTER",
            "aliases": [
                "ENT-11 ",
                "ITG17 ",
                "MERCURY ",
                "Mango Sandstorm ",
                "MuddyWater ",
                "STAC 1171 ",
                "Seedworm ",
                "Static Kitten ",
                "TEMP.Zagros ",
                "UNC3313 ",
                "Yellow Nix ",
                "Earth Vetala "
            ],
            "source_name": "Secureworks:COBALT ULSTER",
            "tools": [
                " Canopy",
                " CrackMapExec",
                " CredNinja",
                " Empire",
                " FORELORD",
                " Koadic",
                " LaZagne",
                " Ligolo",
                " MKL64",
                " Metasploit",
                " Mimikatz",
                " MiniDump",
                " Mori",
                " MuddyC2Go",
                " MuddyC3",
                " PhonyC2",
                " Plink",
                " PowGoop",
                " PowerStats",
                " RemoteUtilities",
                " Revsocks",
                " ScreenConnect",
                " SimpleHelp",
                " Small Sieve",
                " Syncro",
                " Venom Proxy",
                " WMIExec",
                "AnyDesk"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716493,
    "ts_updated_at": 1743041774,
    "ts_creation_date": 1543411813,
    "ts_modification_date": 1543411813,
    "files": {
        "pdf": "https://archive.orkl.eu/31a8d8375950c344cb78209108b22421c173c360.pdf",
        "text": "https://archive.orkl.eu/31a8d8375950c344cb78209108b22421c173c360.txt",
        "img": "https://archive.orkl.eu/31a8d8375950c344cb78209108b22421c173c360.jpg"
    }
}