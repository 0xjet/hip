{
    "id": "c5456fb3-154a-4614-aeeb-fc4cf787d90b",
    "created_at": "2023-01-12T15:04:24.114735Z",
    "updated_at": "2025-03-27T02:05:56.04562Z",
    "deleted_at": null,
    "sha1_hash": "6e0cabf630239f9f3f26affb9ac06f94ee7b31f9",
    "title": "2018-04-16 - Smoke Loader malware improves after Microsoft spoils its Campaign",
    "authors": "",
    "file_creation_date": "2022-05-28T04:57:12Z",
    "file_modification_date": "2022-05-28T04:57:12Z",
    "file_size": 575425,
    "plain_text": "# Smoke Loader malware improves after Microsoft spoils its Campaign\n\n**[spamhaus.org/news/article/774/smoke-loader-improves-encryption-after-microsoft-spoils-its-campaign](https://www.spamhaus.org/news/article/774/smoke-loader-improves-encryption-after-microsoft-spoils-its-campaign)**\n\n[Tweet](https://twitter.com/share) Follow\n@spamhaus\nSmoke Loader malware improves after Microsoft spoils its Campaign\n\n2018-04-16 15:15:55 UTC  |  by Spamhaus Malware Labs  |  Category: [malware](https://www.spamhaus.org/news/tags/malware/)\n\n\n**Recent**\n**News**\n**Articles**\n\nSpamhaus\nBotnet Threat\nUpdate: Q42021\n\nSERVICE\nUPDATE |\nSpamhaus\nDNSBL users\nwho query via\nCloudflare\nDNS need to\nmake\nchanges to\nemail set-up\n\nSpamhaus\nBotnet Threat\nUpdate: Q32021\n\n\nEarly this year, in March 2018, Microsoft’ Windows Defender Research\n[Team in Redmond published some interesting insights into a massive](https://cloudblogs.microsoft.com/microsoftsecure/2018/03/07/behavior-monitoring-combined-with-machine-learning-spoils-a-massive-dofoil-coin-mining-campaign/)\nmalware campaign distributing a dropper/loader called Smoke Loader\n(also known as Dofoil). The main purpose of the documented campaign\nwas to distribute a coin miner payload that is using infected machines to\nmine crypto currencies. Within 12 hours, Windows Defender recorded\nmore than 400,000 instances, but could deploy appropriate\ncountermeasures on computers running Windows within seconds. As\nfurther analysis from Spamhaus Malware Labs revealed, these\ncountermeasures did not stay unattended by the malware authors behind\nSmoke Loader.\n\nApparently, as a reaction on Microsoft’ countermeasures, the malware\nauthors behind Smoke Loader made some significant code changes in\norder to bypass Windows Defender and other Antivirus software. These\ncode changes include:\n\nChange in the infection techniques\nIntroduction of 64bit payload\n\n## Anti-VM and Anti-Analysis techniques in the packer\n\nWhat stares out with Smoke Loader is that the packer and the main\nexecutable (unpacked payload) is related to each other. It is necessary for\nthe unpacked payload to be loaded by the packer in order to run. In\naddition, the unpacked code checks for certain markers created by the\npacker in order to run. When Smoke Loader gets executed in a sandbox\n(for example a virtual environment), the sample fails to start. The reason\nfor this are Anti-VM and Anti-Analysis techniques that Smoke Loader\nimplemented in the code recently. An initial examination under IDA\nreveals that the code is obfuscated with jump chains whose sole purpose\nis to make the static analysis harder.\n\n\n-----\n\nSpammer\nAbuse of\nFree Google\nServices\n\nSpamhaus\nBotnet Threat\nUpdate: Q22021\n\nEmotet Email\nAftermath\n\nWordpress\ncompromises:\nWhat's\nbeyond the\nURL?\n\nYou can't buy\ndata hygiene\n\nOlder News\nArticles:\n\nSpamhaus\nNews INDEX\n\n\n_Runtrace_\nThe code at line number 19 (0040295C Main CMP DWORD PTR DS:\n\n_[EAX+A4],) reveals that Smoke Loader checks the version of the_\noperating system in PEB structure. In case the operating system where\nthe malware sample gets executed on is less than version 6 (Windows NT\n6, which equals to Windows Vista), the malware sample immediately stop\nthe execution. In addition, there are a handful other checks based on\ndebugging flags, which can be traced back using the same tracing\ntechnique.\n\nFurthermore, the recent Smoke Loader version also overwrites some of its\nown code section with new instruction that do also contain anti-analysis\ncode and code related to packer loading.\n\nA call trace helps to determine the functionality of that modified mode as\nshown below.\n\n_Anti-VM checks_\nThe code snipped shown above show code that checks for certain signs\nof a virtual environment, for example the presence of certain drivers of\nVirtualBox or certain strings that would trace the environment where the\nmalware sample gets executed to Qemu.\n\nIn previous versions, Smoke Loader would create a hollow process and\nthen inject the unpacked code into it. However, after Microsoft spoiled the\nmassive Smoke Loader campaign in March 2018, the most recent version\nof Smoke Loader injects itself into a running instance of Windows Explorer\n(explorer.exe) instead of creating a hollow process. The injection is now\nbased on the same technique as used by PowerLoader, which uses\n_SendNotifyMessage for code injection. Also, while previous versions of_\nSmoke Loader were using 32bit code, the most recent version of Smoke\nLoader contains 64bit code in order to inject itself into explorer.exe on\ncomputers that are running a 64bit operating system.\n\n\n-----\n\n_Smoke Loader injecting into explorer.exe_\nThe following code change highlights that the final payload is supposed to\nbe run as thread instead of a separate process.\n\n_Previous version (process based)_\n\n_Recent version (thread based)_\nThe packer creates a shared file map which contains various information\non the initial infection, such as the packed binary. This file map is later\nbeing used by the executing thread.\n\n_Shared file map_\n\n\n-----\n\nThe name of the shared file map is generated from VolumeSerialNumber\nof root drive of the infected machine. This shared file map can be used as\nan indicator of compromise (IOC).\n\n## Additional changes in the code\n\nWhile the previously string encoding algorithm used by Smoke Loader\nwas based on xor, the most recent version includes an RC4 based string\nencryption as highlighted on the screenshot above.\n\n_RC4 based string decryption_\nThe following IDA python script can help with static decoding of Smoke\nLoader: [download](https://www.spamhaus.org/downloads/smoke_loader_decoding.py%20)\n\nIn earlier versions of Smoke Loader, the botnet controller domain names\n(C&C) were encoded using an algorithm that was based on a simple xor\nsubtraction:\n```\ndef Decodec2(data):\n  XorKey = struct.unpack(\"<B\", data[0])[0]\n  dst = array.array(\"B\")\n  base = data[5:]\n  PackLen = struct.unpack(\"<B\", data[4])[0]\n  print PackLen\n  for i in range(0, PackLen - 1, 2):\n    #print chr(  (  ( ord (base[i]) ^ XorKey) & 0xff) ((ord(base[i + 1] ) ^ XorKey) & 0xff) & 0xff ),\n    dst.append((  ( ord (base[i]) ^ XorKey) & 0xff) ((ord(base[i + 1] ) ^ XorKey) & 0xff) & 0xff )\n  return dst.tostring()\n\n```\nThe most recent version of Smoke Loader has been modified by the\nauthors to make use of a more complex encoding scheme which is based\non multiple operations:\n\n\n-----\n\n```\ndef swap32(x):\n  return (((x << 24) & 0xFF000000) |\n      ((x << 8) & 0x00FF0000) |\n      ((x >> 8) & 0x0000FF00) |\n      ((x >> 24) & 0x000000FF))\ndef Decodec2(buf):\n  BufLen = struct.unpack(\"<B\", buf[0])[0]\n  print \"[] Buf len = %d\" % BufLen\n  XORDword = struct.unpack(\"<I\", buf[BufLen + 1 : BufLen + 1 + 4])\n[0]\n  print \"[] XorDword is %d\" % XORDword\n  XORDword = swap32(XORDword)\n  print hex(XORDword)\n  x = 0\n  dst = array.array(\"B\")\n  for i in buf[1:BufLen + 1]:\n    x = ord(i) \n    x = x ^ (XORDword & 0xff) \n    XORDword = (XORDword >> 8 ) \n    x = x ^ (XORDword & 0xff)\n    XORDword = (XORDword >> 8 ) \n    x = x ^ (XORDword & 0xff)\n    XORDword = (XORDword >> 8 ) \n    x = x ^ (XORDword & 0xff)\n    x = x - (1 << 8)\n    x = -x & 0xff\n    print chr(x- 1), \n    dst.append ((x-1))\n    XORDword = swap32(struct.unpack(\"<I\", buf[BufLen + 1 :\nBufLen + 1 + 4])[0])\n  return dst.tostring()\n\n```\nAn HTTP request from Smoke Loader to the botnet controller (C&C\nserver) consists of some internals constants as well as system information\nfrom the infected machine. The request is formatted as shown below.\n\n_C2 packet format_\nThe HTTP response from the botnet controller (C&C server) is typically an\nRC4 encrypted payload that can include multiple, so called “plugins” (such\nas the coin miner mentioned by the Windows Defender Team). The RC4\n\n\n-----\n\nencrypted payload also includes one of the following commands:\n\n**i - Download a file from http location field from using command ID**\n102\n**r - Uninstall Dofoil from system ( followed by ack packet using**\ncommand ID 114)\n**u - Update dofoil ( download from http location field updated binary )**\n\nBased on way Smoke Loader calculates the mutex name an infected\nmachine, we can create a vaccine to prevent Smoke Loader from infecting\na machine:\n\n\n-----\n\n```\n#define WIN32_LEAN_AND_MEAN\n#include <windows.h>\n#include <wincrypt.h>\nvoid MD5(BYTE* data, ULONG len, unsigned char *out)\n{\n     HCRYPTPROV hProv = 0;\n     HCRYPTPROV hHash = 0;\n     BYTE rgbHash[16]= {0};\n     DWORD cbHash = 16;\n     char hash[3] = {0};\n     int i = 0;\n     CryptAcquireContext(&hProv, NULL, NULL, PROV_RSA_FULL,\nCRYPT_VERIFYCONTEXT);\n     CryptCreateHash(hProv, CALG_MD5, 0, 0, &hHash);\n     CryptHashData(hHash, data, len, 0);\n     CryptGetHashParam(hHash, HP_HASHVAL, rgbHash, &cbHash, 0);\n     for (i = 0 ; i < 16; i++)\n     {\n          sprintf(hash, \"%.2X\", rgbHash[i]);\n          strcat(out, hash);\n     }\n     CryptDestroyHash(hHash);\n     CryptReleaseContext(hProv, 0);\n}\nint main(int argc, char **argv)\n{\n     unsigned char *Source = (unsigned char *)\nmalloc(sizeof(char) * 265);\n     unsigned char *md5Sum = (unsigned char *)\nmalloc(sizeof(char) * 34);\n     DWORD lpVolumeSerialNumber = 0;\n     unsigned char *FtString = (unsigned char *)\nmalloc(sizeof(char) * 34);\n     int ComNameSize = 16;\n     char CompName[MAX_COMPUTERNAME_LENGTH + 0x10] = {0};\n     memset(md5Sum, 0x00, 34);\n     memset(FtString, 0x00, 34);\n     memset(Source, 0x00, 265);\n     GetComputerName(CompName,&ComNameSize);\n     GetSystemDirectoryA(Source, 260);\n     Source[3] = 0x00; \n     GetVolumeInformationA(Source, 0, 0, &lpVolumeSerialNumber,\n0, 0, 0, 0);\n     sprintf(FtString, \"%s%08X%08X\", CompName, 0xFEE7D621,\nlpVolumeSerialNumber);\n     MD5(FtString, strlen(FtString), md5Sum);\n\n```\n\n-----\n\n```\n     sprintf(md5Sum, \"%s%08X\", md5Sum, lpVolumeSerialNumber);\n     printf(\"%s\", md5Sum);\n     CreateMutex(0,0,md5Sum);\n     while(1) Sleep(0x1000);\n}\n\n```\nDuring the binary code analysis, Spamhaus Malware Labs found some\nsections in the code that are obviously being used by the author of Smoke\nLoader for debug purpose. This proves that Smoke Loader is still under\nheavy development of its authors and is constantly evolving.\n\n_Debug variables_\n## Conclusion\n\nSince late 2017, Spamhaus Malware Labs could identify more than 8,000\nsmoke loader malware samples which call out to over 1,000 unique botnet\ncontrollers (C&C servers). In addition, to the latest code changes made by\nthe authors of Smoke Loader in response to the countermeasures by\nWindows Defender, we do also see a trend in certain Smoke Loader\ncampaigns that are shifting away from the official TLDs over to\ndecentralized TLDs (dTLDs) such as Namecoins .bit. By using\ndecentralized TLDs for botnet C&C hosting, botnet operators try to make\n[their botnet C&C infrastructure more resilient against takedown attempts](https://abuse.ch/blog/dot-bit-the-next-generation-of-bulletproof-hosting/)\nby security researchers and law enforcement agencies (LEA).\n\nSpamhaus Malware Labs continues to follow the further development of\nSmoke Loader and takes the appropriate actions to protect Spamhaus\nusers from this threat.\n\n## Further reading\n\nMicrosoft Secure: Behavior monitoring combined with machine\nlearning spoils a massive Dofoil coin mining campaign\nMicrosoft Secure: Poisoned peer-to-peer app kicked off Dofoil coin\nminer outbreak\n[Microsoft Secure: Hunting down Dofoil with Windows Defender ATP](https://cloudblogs.microsoft.com/microsoftsecure/2018/04/04/hunting-down-dofoil-with-windows-defender-atp/)\n[abuse.ch: .bit - The next Generation of Bulletproof Hosting](https://abuse.ch/blog/dot-bit-the-next-generation-of-bulletproof-hosting/)\n[Spamhaus Botnet Threat Report 2017](https://www.spamhaus.org/news/article/772/spamhaus-botnet-threat-report-2017)\n\n\n-----\n\n## Related Spamhaus tools & products\n\n[Spamhaus DROP (Don't Route Or Peer Lists)](https://www.spamhaus.org/drop/)\n[Spamhaus Response Policy Zone (RPZ)](https://www.spamhaustech.com/protecting-networks/security-solutions/dns-rpz/)\n[Spamhaus Zero Reputation Domain (ZRD)](https://www.spamhaustech.com/news/recently-registered-domains/)\n[Spamhaus Botnet + Malware Domain List](https://www.spamhaustech.com/protecting-networks/threat-intelligence-data/malware-domains/)\n[Spamhaus Botnet Controller List (BCL)](https://www.spamhaustech.com/protecting-networks/threat-intelligence-data/bcl/)\n[Spamhaus/Deteque Passive DNS service](https://www.spamhaustech.com/protecting-networks/threat-intelligence-data/passive-dns/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-04-16 - Smoke Loader malware improves after Microsoft spoils its Campaign.pdf"
    ],
    "report_names": [
        "2018-04-16 - Smoke Loader malware improves after Microsoft spoils its Campaign.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535864,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653713832,
    "ts_modification_date": 1653713832,
    "files": {
        "pdf": "https://archive.orkl.eu/6e0cabf630239f9f3f26affb9ac06f94ee7b31f9.pdf",
        "text": "https://archive.orkl.eu/6e0cabf630239f9f3f26affb9ac06f94ee7b31f9.txt",
        "img": "https://archive.orkl.eu/6e0cabf630239f9f3f26affb9ac06f94ee7b31f9.jpg"
    }
}