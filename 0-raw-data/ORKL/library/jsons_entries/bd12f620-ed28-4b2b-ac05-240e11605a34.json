{
    "id": "bd12f620-ed28-4b2b-ac05-240e11605a34",
    "created_at": "2023-01-12T15:07:31.315036Z",
    "updated_at": "2025-03-27T02:16:26.469967Z",
    "deleted_at": null,
    "sha1_hash": "69871900967d982185c2e254c607048011710ee6",
    "title": "2016-09-02 - Necurs – hybrid spam botnet",
    "authors": "",
    "file_creation_date": "2009-06-02T17:43:39Z",
    "file_modification_date": "2009-06-02T17:45:30Z",
    "file_size": 6617905,
    "plain_text": "It wasn’t until late November that W32.Downadup appeared (also called\nConficker by some news agencies and antivirus vendors). This threat\nachieved modest propagation success, partly due to its borrowing from\nthe work of the Metasploit Project, which had been actively develop­\ning more reliable proof-of-concept methods to take advantage of the\n\n\n# The Downadup Codex\n### A comprehensive guide to the threat’s mechanics.\n\n###### Edition 2.0\n\n#### Introduction\n\n###### Contents\n\nSince its appearance in late-2008, the Downadup worm has become\n\nIntroduction.............................................................1\nEditor’s Note............................................................5 one of the most wide-spread threats to hit the Internet for a number of\nIncrease in exploit attempts against MS08-067.....6 years. A complex piece of malicious code, this threat was able to jump\nW32.Downadup infection statistics.........................8 certain network hurdles, hide in the shadows of network traffic, and\nNew variants of W32.Downadup.B find\n\ndefend itself against attack with a deftness not often seen in today’s\n\nnew ways to propagate.........................................10\nW32.Downadup and W32.Downadup.B threat landscape. Yet it contained few previously unseen features. What\nstatistics................................................................12 set it apart was the sheer number of tricks it held up its sleeve.\nPeer-to-peer payload distribution...........................15\nGeo-location, fingerprinting, and piracy...............17 It all started in late-October of 2008, we began to receive reports of\nA lock with no key..................................................19\n\ntargeted attacks taking advantage of an as-yet unknown vulnerability\n\nSmall improvements yield big returns..................21\nAttempts at smart network scanning...................23 in Window’s remote procedure call (RPC) service. Microsoft quickly\nPlaying with Universal Plug and Play...................24 released an out-of-band security patch (MS08-067), going so far as to\nLocking itself out.................................................27 classify the update as “critical” for some operating systems—the high­\nA new Downadup variant?......................................29\n\nest designation for a Microsoft Security Bulletin.\n\nAdvanced crypto protection.................................30\nPropagation by AutoPlay......................................34\nW32.Downadup.C digs in deeper..........................37 It didn’t take long for malware authors to utilize this vulnerability in their\nW32.Downadup.C bolsters P2P............................38 malicious code. In early November, W32.Kernelbot.A and W32.Wecorl\nDownadup motivations..........................................40 appeared, demonstrating limited success in exploiting MS08-067. Still\nDownadup-related search indexes poisoned.......42\n\nmuch of the talk at the time focused on the potential havoc that could\n\nW32.Downadup.C pseudo-random domain\nname generation....................................................43 be caused by this vulnerability, as opposed to damage caused by these\nDownadup + Waledac?.............................................45 threats.\nW32.Downadup.E—back to basics.......................46\nConnecting the dots: It wasn’t until late November that W32.Downadup appeared (also called\nDownadup/Conficker variants...............................47 Conficker by some news agencies and antivirus vendors). This threat\nW32.Downadup P2P scanner script for Nmap.......49\nConclusion.............................................................50 achieved modest propagation success, partly due to its borrowing from\nAppendix A: Comparison of variant features..........51 the work of the Metasploit Project, which had been actively develop­\nAppendix B: How do I know if I have Downadup?......53 ing more reliable proof-of-concept methods to take advantage of the\n\n\n-----\n\nThe infection numbers for W32.Downadup began to steadily rise. But a limiting factor to its success was that its\npropagation routine depended on a publicly available GeoIP data file used to determine IP location. When the\nGeoIP authors decided to remove it from the location called by the worm, the absence of this file made it difficult\nfor the worm to spread as rapidly, reducing its propagation to local networks already infected.\n\nNot to be outmaneuvered, the Downadup authors packaged this GeoIP file within a new variant—W32.\nDownadup.B—along with a Swiss Army-like collection of secondary tricks in the hopes that this would help the\nthreat spread far and wide.\n\nThis was one thing that set the Downadup worm apart from its counterparts of the last few years—its techni­\ncal versatility. These secondary tricks weren’t new; there were just so many of them. It scanned the network for\nvulnerable hosts, but didn’t flood it with traffic, selectively querying various computers in an attempt at masking\nits traffic instead. It attempted to bruteforce commonly used network passwords. It took advantage of Universal\nPlug and Play to pass through routers and gateways. And when the network proved too secure, it used a rather\nclever AutoPlay trick to get users to execute it from removable drives.\n\nThe threat even protected itself from takeover. Transferred payload files were encrypted, as well as digitally\nsigned, and only the Downadup authors had the key. A “hotpatching” routine for MS08-067 prevented further\nexploitation by other attackers or threats. The threat’s authors went to great lengths to prevent buffer overflow\nexploitation of their own code. No one was going to hijack this worm’s network of potential bots.\n\nBut the hidden danger behind all of this was the potential payload—Downadup contained the ability to update\nitself or receive additional files for execution. Again, not a new technique, but in this case the threat was gener­\nating a list of 250 new domains to connect to—every day. Any one of these domains could potentially contain an\nupdate that, if downloaded, would allow the threat to perform further malicious actions. What sort of actions?\nAnything the authors wanted really. Not only that, but the threat contained its own peer-to-peer (P2P) updating\nmechanism, allowing one infected computer to update another. Blocking access to the domains might protect\nyou from one vector, but blocking a P2P update is a different matter.\n\nInfection rates began to decline in mid-February, as news of the threat spread and network administrators that\nhad not applied MS08-067 scrambled to protect their networks. This could be in part due to the fact that, with\npropagation success, the threat garnered a significant amount of attention. The domains meant to update the\nthreat were being closely watched by security vendors, researchers, and the media.\n\nThis attention isn’t surprising given the threat’s complexity and the way it has utilized so many time-tested mali­\ncious code tricks, reinventing a few along the way. There is no doubt that Downadup has been the hot topic for\n2009 thus far, and this attention has generated a considerable amount of research.\n\nAll was quiet on the Downadup front, that is until early March, when W32.Downadup.C began to appear on previ­\nously infected Downadup computers. More of an update than a new worm, this version didn’t include a propa­\ngation technique. New to this version was a function to end a variety of security-related processes. And where\nprevious versions generated a list of 250 daily domains, this one created 50,000.\n\nTo date, Symantec Security Response published 14 blog entries detailing the various features of Downadup\nbetween November 2008 and February 2009. This included a multi-part analysis of the features of the worm,\nwhere each entry in the series focused on a particular function. This paper brings these entries together into one\nsource.\n\nAs information on our blog was released on a day-by-day basis, this paper is organized chronologically, not only\ncovering the technical aspects, but also providing the historical context on the emergence and growth of the\nDownadup worm. And to provide a view of the whole picture, this paper also includes new, as-yet unpublished\nentries from our researchers.\n\nAs a comprehensive collection of our analysis of the worm, we present The Downadup Codex.\n\n\n-----\n\n##### Introduction to Edition 2.0\n\nThe first edition of The Downadup Codex was written and published shortly after W32.Downadup.C was discov­\nered in the wild. Gone were the exploit mechanisms that so successfully spread the previous variants and caught\nthe attention of the mainstream media. However, this variant would go on to generate even more attention than\nits predecessor, garnering the family an almost certain cult-like status in the history of malicious code.\n\nIt seems that the purpose of W32.Downadup.C wasn’t to cast a larger net, but rather bolster the strength of its\nbotnet. This Downadup variant focused more on the security mechanisms of the computers it compromised, end­\ning processes and services and modifying registry entries. W32.Downadup.B had hampered attempts to contact\nsecurity-related websites, and this new variant also carried on the tradition.\n\nThe release of W32.Downadup.C also saw an expansion of its peer-to-peer (P2P) capabilities. Since the MS08067 exploit code was removed from this variant, and the previous P2P functionality relied upon it, the feature\nhad to be rewritten from the ground-up. With enhancements to the bootstrapping techniques, the digital signing\nof files transferred, and a custom P2P protocol, this rewrite resulted in a more robust and reliable method for\nupdating the botnet.\n\nBut the feature in W32.Downadup.C that raised this threat family’s prominence in the public’s eye more than\nanything was a date appearing in the threat’s code—April 1, 2009. Yet the reaction to this date was much more\ninteresting than the actual, expected behavior. As the date approached, more and more attention was given to\nthe threat, along with a king’s ransom in speculation. What would it do? Would it download updates? Would it in­\nstall other threats? Would it bring about Figure 1\nan end to the Internet as we know it?\n\n###### The infamous April 1, 2009 date in W32.Downadup.C\n\nIn the end the threat did exactly what it\nsaid it would do on April 1st— it began\ngenerating 50,000 domain names a day,\nthen checked a selection of 500 of them\nfor updates. And that was it. There were\nplenty of signs of this as well. For ex­\nample, much of the code in Downadup is\nencrypted, packed, and heavily obfuscat­\ned, making deconstruction and analysis of the threat difficult. However, none of these techniques were used on\nthe part of the code that contained the April 1st date. If this was the doomsday it was made out to be, why would\nthis date appear so conspicuously in the code? There was also plenty of circumstantial evidence that Downadup\nwas being set up to distribute security risks such as misleading applications and adware, rather than for any sort\nof movie-plot scenario. But the true purpose of Downadup didn’t begin to become clearer until April 8, 2009.\n\nIn many ways, April 8th was what many thought April 1st was supposed to be. Not only did a new variant emerge\n(W32.Downadup.E), but two other risks (W32.Waledac and SpywareProtect2009) appeared on Downadup-infect­\ned computers as well.\n\nWhile confusing at first how all these risks interrelate, there is indeed a common theme tying them all togeth­\ner—the P2P network of W32.Downadup.C. W32.Downadup.E was initially seeded into this P2P network, by an\nattacker linked to Downadup, and then spread to other W32.Downadup.C-infected computers through the net­\nwork. Similarly, instructions were seeded into the P2P network, telling the compromised computers to download\nW32.Waledac from a predetermined location. Once W32.Waledac was installed, it in turn downloaded a copy of\nSpywareProtect2009.\n\nThe W32.Downadup.E variant didn’t usher in a new era of Downadup-related mayhem either. As was the case\nwith W32.Downadup.C, this version’s goal seemed to be to strengthen its hold on computers already compro­\nmised by previous variants, instead of focusing on locating and recruiting new computers into its botnet. W32.\nDownadup.E included a minor update for W32.Downadup.C, and bizarrely enough, it contained a feature to\ndelete itself on May 3, 2009.\n\n\n-----\n\nW32.Downadup.E’s most likely purpose was to actively seek out W32.Downadup.B-infected computers and\nupdate them. It did this by utilizing a feature included in W32.Downadup.B’s hotpatching function. When a\nhotpatched computer is pinged by another Downadup exploit attempt, it has the ability to recognize the shell\ncode coming in as another Downadup. It responds back to the exploiting computer, telling it that it is W32.\nDownadup.B and asks if it has any updates that it can send. A W32.Downadup.E-infected computer responds by\nsending a copy of itself, which the W32.Downadup.B computer will install.\n\nSince April 8th, the Downadup authors have been relatively quiet. But that’s not to say that the threat has lost its\nhold in the wild. In many ways it has sunk its teeth in, making it that much more challenging to eradicate once it\nhas taken hold. To combat this, we’ve consistently updated our removal tools, and even worked with the develop­\nment team behind NMap to develop a script to detect the activity of the W32.Downadup.C P2P network, making\nit easier to locate and then remove infections.\n\nStill confused by the alphabet soup that is the Downadup family? Along with eight new blog entries, this edition\nof The Downadup Codex now includes a series of appendices to help with the detection and classification of\nDownadup.\n\nWe present to you The Downadup Codex, Edition 2.0.\n\n\n-----\n\n#### Editor’s Note\n\nThis paper is a collection of all current Downadup research published through June 2, 2009. As with any con­\nstantly evolving threat, new variants could present themselves at any time and may render portions of this\nreport out-of-date. Since Downadup appears to be one such threat, we will attempt to release updated editions\nof this report periodically, as new information presents itself.\n\n##### Edition 1.0\n\nOriginally published March 13, 2009.\n\n##### Edition 2.0\n\nOriginally published June 2, 2009.\n\nExpanded introduction for new edition.\n\nAdded eight new blog entries.\n\nAdded Appendix A, “Downadup features”, and Appendix B, “How to know if you have Downadup?”\n\nCorrected minor typos and improved quality of some images.\n\n\n-----\n\n#### Increase in exploit attempts against MS08-067\n\n_Originally published November 22, 2008 by the Security Intel Analysis Team_\n\nMicrosoft Security bulletin MS08-067 was an out-of-band security update that was released on October 23,\n[2008, to address a critical remotely exploitable vulnerability that was being exploited in the wild. The Microsoft](http://www.securityfocus.com/bid/31874)\n[Windows Server Service RPC Handling Remote Code Execution Vulnerability that was addressed by the patch](http://www.securityfocus.com/bid/31874)\naffects Windows 2000, XP, Server 2003, Vista, and Server 2008 to varying degrees. Ultimately the issue can be\nexploited by a remote attacker to install malicious applications on a target computer without the victim’s knowl­\nedge.\n\n[Microsoft released a detailed matrix describing the risk that this vulnerability presents to different versions of](http://blogs.technet.com/photos/swiblog/images/3140946/original.aspx)\nMicrosoft Windows. When reading this matrix it becomes clear that this issue is exploitable by an unauthenti­\ncated attacker on Windows 2000, Windows XP, and Windows 2003. But, it is not exploitable on default configu­\nrations of Windows XP because the Windows Firewall blocks connect attempts to the required RPC interface.\nHowever, if the firewall is disabled, or the firewall is enabled but file/printer sharing is also enabled, then the\nissue is remotely exploitable on Windows XP. An attacker would need to authenticate to Windows Vista and Win­\ndows Server 2008 in order to exploit this issue.\n\nSeveral public exploits are currently available that leverage this issue. Typically an exploit needs to be reliable\nfor a worm to incorporate the exploit into its propagation routines. The nature of this vulnerability made it dif­\nficult for exploit authors to construct a single exploit that would successfully leverage the issue for all versions\nof Microsoft Windows at once. So, exploits were released that targeted specific versions of Microsoft Windows\n[first, and the first public exploit to surface that wasn’t a simple crash proof-of-concept leveraged the issue on](http://www.milw0rm.com/exploits/6841)\nMicrosoft Windows platforms that were localized for traditional Chinese markets. Over the past month, exploit\nauthors have discovered far more reliable methods to exploit this vulnerability and have released more stable\n[exploits. The most reliable public exploit is incorporated into the Metasploit Framework—it contains many con­](http://metasploit.com/svn/framework3/trunk/modules/exploits/windows/smb/ms08_067_netapi.rb)\nfigurations that can be used to leverage this issue for a large array of Windows versions.\n\nWhen we first noticed worm-like malicious applications exploiting this vulnerability they were using the primitive\nexploits that were available at the time. In other words, exploits that targeted Chinese Windows systems. How­\never, over the last 24 hours we are observing a new worm. It exploits MS08-067, but it uses the routines from the\nMetasploit Framework to exploit the following platforms:\n\n     - Windows 2000 Universal\n\n     - Windows 2003 SP1 English\n\n     - Windows 2003 SP2 English\n\n     - Windows XP SP2 English\n\n     - Windows XP SP2 Arabic\n\n     - Windows XP SP2 Portuguese\n\n     - Windows XP SP2 Russian\n\n     - Windows XP SP2 Danish\n\n     - Windows XP SP2 Dutch\n\n     - Windows XP SP2 Finnish\n\n     - Windows XP SP2 French\n\n     - Windows XP SP2 Greek\n\n     - Windows XP SP2 Hungarian\n\n     - Windows XP SP2 Hebrew\n\n     - Windows XP SP2 Italian\n\n     - Windows XP SP2 Norwegian\n\n     - Windows XP SP2 Polish\n\n     - Windows XP SP2 Italian\n\n     - Windows XP SP2 Spanish\n\n     - Windows XP SP2 Swedish\n\n\n-----\n\nThe routine to attack Windows 2000 systems is very reliable; however, at the moment, the reliability of the rou­\ntines that attack other platforms is not known.\n\nThe worm targets TCP port 445 to exploit the issue, and if it successfully exploits the issue, the worm then cre­\nates an HTTP server on the compromised computer on a random port, for example:\n```\n http://[EXTERNAL IP ADDRESS OF INFECTED MACHINE]:[RANDOM PORT]/[RANDOM STRING]\n\n```\n\nThe worm then sends this URL as part of its\npayload to remote computers. Upon success­\nful exploitation, the remote computer will\nthen connect back to this URL and download\nthe worm.\n\nWe are currently observing an increase in IPs\ngenerating activity over TCP port 445 and\nwe believe that this activity is at least in part\nrelated to the propagation of this malicious\ncode, as shown in figure 2.\n\n[SANs are also reporting a spike in activity on](http://isc.sans.org/port.html?port=445)\nTCP port 445. However, this was not the main\nreason behind our ThreatCon update. The ag­\ngressive propagation of this malicious threat\nin our honeypot network was the main reason\nbehind the update. We decided that the\nactivity was significant enough to remind our\ncustomers of the importance of installing the\nMS08-067 updates. Symantec antivirus cur­\n[rently detects this threat as W32.Downadup,](http://www.symantec.com/business/security_response/writeup.jsp?docid=2008-112203-2408-99)\nso please make sure that your antivirus soft­\nware is up to date.\n\n\nFigure 2\n###### IPs generating activity on TCP port 445\n\n\nWe also recommend that the following mitigating strategies are applied:\n\n- Block access to TCP port 139 and 445 at network perimeters.\n\n- Ensure that computers that are connected to the network have host-based firewall software installed.\n\n- Ensure that antivirus software is installed on all clients connected to the network and that the software is up\n\nto date.\n\n[And, please install the update from MS08-067 as soon as possible. Microsoft has suggested a number of addi­](http://www.microsoft.com/technet/security/Bulletin/MS08-067.mspx)\ntional workarounds in the security bulletin, such as disabling the browser service. We advise customers to review\ntheir suggestions as well.\n\nSymantec IPS will detect and block this attack with the following signatures:\n\n- MSRPC Server Service Buffer Overflow\n\n- RPC Server Service BO2\n\n\n-----\n\n#### W32.Downadup infection statistics\n\n_Originally published January 6, 2009 by the Security Intel Analysis Team_\n\n[The W32.Downadup worm was the first worm discovered in the wild that was successfully leveraging MS08-067](http://www.symantec.com/business/security_response/writeup.jsp?docid=200%208-112203-2408-99)\nin a widespread fashion. Symantec carried out an in-depth analysis of this threat and discovered that infected\nhosts will generate 250 pseudo-random domain addresses each day, in preparation of attempting to contact\nthem later on to download and execute an update binary.\n\nThis is an interesting and increasingly popular technique that malicious code authors have been deploying. It\nallows them to more easily evade domain and server takedowns, because until they choose to register a domain\nassociated with a given day, the security industry is unable to know for sure which domain will be used and\ntherefore has little to target. Fortunately, by reverse engineering the domain-generation algorithms, we are able\nto proactively identify and blacklist the domains.\n\nWhat’s also interesting about this method of obtaining binary updates is that it does allow for the number of in­\nfections to be approximated by monitoring contact attempts against generated domains. By pre-calculating and\nregistering future domains, the Symantec Intelligence Analysis Team was able to observe contact attempts made\nby numerous infections. Over the course of a week, we observed over three million unique IP addresses attempt­\ning to obtain a download file from our server. However, we believe that the number of infections is higher than\nthis estimate due to multiple internal infections that may be using network address translation (NAT) behind\na single external IP address. Also, it’s possible that an infected computer does not contact all 250 generated\ndomains each day. If this latter possibility is the case, then we may only be seeing a subset of the actual total\nnumber of infected computers in this bot network.\n\n\nFor instance, we have been able to show\nthat multiple infections are coming from\na single IP address by identifying unique\nuser-agent strings coming from the same\nIP. The following graph shows the statis­\ntics, over a 72-hour period, of unique IP\naddresses versus unique IP address and\nuser-agent pairs, as shown in figure 3.\n\nWhile on the topic of user-agents, when\ncontacting one of the generated domains\nto obtain a binary, an infected computer\nsends a specific user-agent string as part\nof the HTTP request. User-agent strings\ncontain version information about the as­\nsociated operating system (OS) and Web\nbrowser, and can be used to collect inter­\nesting statistics. For example, Windows XP\nSP1 can be identified by a user-agent con­\ntaining Windows NT 5.1. Systems running\nWindows XP SP2 and later can be identified\nby Windows NT 5.1; SV1. By analyzing the\nuser-agent strings associated with each\nunique request, we are able to approximate\nthe distribution of infected operating sys­\ntem types. The following graphic shows the\nOS distribution observed over a 72-hour\nperiod, as shown in figure 4.\n\n\nFigure 3\n###### Unique IP addresses vs. Unique IP address and user-agent pairs\n\n\n-----\n\nAs can be seen, the most commonly infected\nsystems appear to be Windows XP SP1 and\nearlier. Over 500,000 of the infected comput­\ners that contacted our server were running\nthese operating system versions. Close\nbehind was Windows XP SP2 and later sys­\ntems. Windows 2000 and Windows 2003 had\nsmaller shares.\n\nWe believe that the W32.Downadup propa­\ngation routine has been very aggressive. It\nwill continue to infect computers in the near\nfuture and receive updates via the aforemen­\ntioned mechanism. Symantec discovered a\nnew variant of this worm on December 30,\n[2008, dubbed W32.Downadup.B. This updat­](http://www.symantec.com/business/security_response/writeup.jsp?docid=2008-123015-3826-99)\ned version contains additional propagation\nroutines and what appears to be an altered\ndomain generation routine. It’s not currently\nknown if this new version was seeded to W32.\nDownadup infections or has independently\nspread through its own propagation routines.\n\nWe strongly encourage all users to ensure\nthat the patches available in MS08-067 have\nbeen applied and that antivirus products are\nfully up-to-date to ensure that this threat\ndoes not find its way onto computers.\n\n\nFigure 4\n###### OS distribution over a 72-hour period\n\n\n-----\n\n#### New variants of W32.Downadup.B find new ways to propagate\n\n_Originally published January 9, 2009 by Symantec Security Response_\n\nSymantec has observed an increase in infections relating to W32.Downadup over the holiday period and is urging\n[organizations to apply the patch for Microsoft Windows Server Service RPC Handling Remote Code Execution](http://www.securityfocus.com/bid/31874)\n[Vulnerability as soon as possible.](http://www.securityfocus.com/bid/31874)\n\n[A new variant of this threat, called W32.Downadup.B, appeared on December 30th and can not only propagate](http://www.symantec.com/business/security_response/writeup.jsp?docid=2008-123015-3826-99)\nby exploiting the Microsoft Windows Server Service RPC Handling Remote Code Execution Vulnerability, but can\nalso spread through corporate networks by infecting USB sticks and accessing weak passwords. These propa­\ngation methods are nothing new; W32.Spybot, W32.Randex, and W32.Mytob variants all use almost identical\nmethods to spread, but this variant requires more effort to protect corporate networks.\n\nW32.Downadup.B creates an autorun.inf file on all mapped drives so that the threat automatically executes\nwhen the drive is accessed. The threat then monitors for drives that are connected to the compromised com­\nputer in order to create an autorun.inf file as soon as the drive becomes accessible. The worm also monitors DNS\nrequests to domains containing certain strings and blocks access to those domains so that it will appear that the\nnetwork request timed out. This means infected users may not be able to update their security software from\nthose Web sites. This can be problematic as worm authors generally dish out new variants constantly.\n\nSymantec researchers are seeing considerable detections of both variants of W32.Downadup and W32.\nDownadup.B. As illustrated by the following infection maps based on data from the past 60 days, the infections\nare geographically quite widespread. The highest infection rates typically correspond to countries with high\nrates of computer/Internet usage.\n\nFigure 5\n###### Infections of W32.Downadup\n\n\n-----\n\nFigure 6\n###### Infections of W32.Downadup.B\n\nSymantec strongly encourages users to patch their system against the Microsoft Windows Server Service RPC\nHandling Remote Code Execution Vulnerability, take steps to control the execution of applications referenced in\nthe autorun.inf files that may be located on removable and network drives, and enforce a strong password policy\non all computers within their networks. Particularly during holiday periods patch updates can be missed and is\nan opportune time for malware to spread. Consider implementing an automated patch management solution to\nhelp mitigate risk.\n\n[Click here to obtain more information about how to prevent a threat from spreading using the AutoPlay feature.](http://service1.symantec.com/SUPPORT/ent-security.nsf/docid/2008032111570648)\n\n\n-----\n\n#### W32.Downadup and W32.Downadup.B statistics\n\n_Originally published January 16, 2009 by the Security Intel Analysis Team_\n\nAs regular readers of the Symantec Security Response Blog know, we’ve been monitoring W32.Downadup statis­\n[tics for some time. We’ve previously published two blog entries regarding infection statistics for both the .A and](http://www.symantec.com/business/security_response/writeup.jsp?docid=2008-112203-2408-99)\n[.B variants. The Symantec Intelligence Analysis Team has been monitoring infections since mid-December. We](http://www.symantec.com/business/security_response/writeup.jsp?docid=2008-123015-3826-99)\nrecommend that readers familiarize themselves with the information in the previous blogs, as well as the Syman­\ntec Security Response writeups for the worm, before reading the rest of this article.\n\nW32.Downadup is an extremely interesting piece of malicious code and one of the most prolific worms we’ve\nseen in years. This is largely attributed to the fact that it is capable of trivially exploiting users who are running\nunpatched Windows XP SP2 and Windows 2003 SP1 systems. Other worms released over the past few years\nhave largely targeted older system versions, which have an ever decreasing distribution.\n\nThe Symantec Intelligence Analysis Team has recently begun monitoring W32.Downadup.B infections using the\nsame method used to monitor W32.Downadup. Basically, both worms use custom date-based algorithms to gen­\nerate 250 domain names per day. These domains are then contacted by each infection in an attempt to obtain\nan update binary. By reverse engineering the algorithms and generating tools to mimic the domain generation\nroutine, we are able to predict domains that will be contacted by infected systems on future dates. We take\nadvantage of this knowledge by preemptively registering domains that will be queried in the future and on the\nassociated day, logging all of the results.\n\nThe logs can then be used to tell us a number of interesting things. The string below is an example of what one of\nthe log entries looks like:\n```\n     x.x.x.x [16/Jan/2009:09:45:09 -0700] “GET /search?q=0 HTTP/1.0” 404 282 “-”\n\n     “Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)”\n\n```\nFirst, we get the connecting IP. This could be an externally facing infected system or an Internet gateway used by\nmultiple systems using network address translation (NAT). Access to the IP addresses allows us to roughly ap­\nproximate (although conservatively) the number of infections and also geographically map out infection density.\nFor instance, the following image illustrates the top 10 countries by W32.Downadup infection count.\n\nFigure 7\n###### Top ten W32.Downadup countries\n\n\n-----\n\nThe IP data shows us that China and Argentina are by far the most infected areas. Both East Asia and South\nAmerica are the main areas of infection. In total we’ve observed over three million unique IP addresses infected\nwith W32.Downadup.\n\nThe logs also tell us other valuable information. In our previous blog entry, we showed the operating system\ndistribution of infected systems. These can be obtained using the User-Agent string sent to the server when que­\nrying for the update. The User-Agents also allow us to more accurately approximate the total number of infec­\ntions. By creating unique pairs of IP addresses and User-Agent strings, we can identify additional systems that\nare using NAT behind a gateway. This still does not give us the total picture; however, it does reveal a significant\nnumber of additional infections. For instance, as mentioned previously, we observed three million unique IPs,\nbut we also observed 3.7 million unique IP / User-Agent pairs.\n\nThere is one more piece of interesting information that can be obtained from the logs. That’s the infection count\nreported by the infected system, using the q= parameter. The value used to populate this field is updated by the\ninfected and attacking system every time an incoming connection is made to the infected system over HTTP for\ndownloading a copy of the W32.Downadup binary. Connections are triggered through successful exploitation of\nthe MS08-067 vulnerability.\n\nThe q= value is most interesting to us for the purposes of identifying aggressive and potentially longer term\ninfections. The former allows us to identify possibly large and vulnerable internal networks. The latter allows us\nto speculate (although tentatively) on possible infection starting points. Originally we believed that this field may\nbe valuable for calculating total infection counts, however we believe that this is inaccurate and our reasoning\nfor this be will explained shortly.\n\nOf the approximately three million W32.Downadup infections observed, we chose to map out those that ap­\npeared to be very successful in their exploitation efforts. We isolated all infected systems that reported a total\nnumber of successful attacks greater than 10,000. This allowed us to isolate just over 1,100 infected systems.\nMost ranged between 10,000 and 50,000 reported attacks. Two systems, located in Argentina, reported over\n100,000 successful attacks. The following map shows geographic density of the infections reporting these at­\ntacks:\n\nFigure 8\n###### Infected systems with greater than 10,000 successful attacks\n\n\n-----\n\nThe map shows that Chile and Argentina have the highest density of infections, reporting high quantities of at­\ntacks. This corresponds to the previously shown image of top infection areas, with Argentina in second place and\nChile in sixth. Although we can’t say conclusively, the higher infection counts of these systems may be indicative\nof the longevity of infection and could therefore be an indicator as to the starting point of infection. There is no\nreal way to know for sure at the moment, but it is an interesting possibility nonetheless.\n\nAs noted earlier, we feel that using the q= parameter to approximate a total infection count is inaccurate. It\ndoes indicate the total number of successful exploitation attempts and subsequent malware uploads; however,\nthis may in fact not be an indicator of successful infection. Consider, for instance, a system that has antivirus\nsoftware running with up-to-date definitions, but is not patched against the MS08-067 vulnerability. An infected\nsystem could successfully exploit this host and upload a copy of the worm; however, due to the antivirus technol­\nogy on the system this would not represent an infection. Now, given the system was not infected and therefore\ndid not have the vulnerable code hot-patched (a feature of the worm), it is still open to attack by other infected\nsystems. As such, a single vulnerable system with up-to-date antivirus could result in many infections misreport­\ning their infection count. Then, realistically assume that numerous systems on the net are vulnerable to MS08067 but may be impervious to infection and you start to see a large amount of skewing.\n\nAs further consideration, take the previous example of aggressive infections. We observed approximately 1,100\nsystems contacting our server, which reported over 10,000 infections (in fact many were 200-500% more than\nthis). If these numbers were to be believed, these 1,100 systems would be responsible for 11 million infections. If\nwe were to accumulate the observed q= values for all 3.7 million uniquely identifiable W32.Downadup infections\nwe’ve observed, we feel that this value would be extremely large and would likely be very inaccurate.\n\nThe last major point of interest related to the statistics we’ve collected are the W32.Downadup.B numbers. We\nrecently began monitoring these infections and used a list of 600,000 unique IP addresses known to be infected\nwith this variant. We compared these IP addresses with the 3 million unique W32.Downadup IPs and came\nup with a surprising result. Only approximately 68,000 IPs are duplicates. First of all, this tells us that W32.\nDownadup infected systems were not used to seed the W32.Downadup.B binary. It would seem that the pseudorandom domain-based update mechanism has not yet been utilized. Second, it tells us that, given the large\nnumber of systems already infected with the .B variant, it is likely seeing large success over the new propaga­\ntion vector that involves brute-forcing file shares. Because W32.Downadup will patch the system against further\nexploitation of MS08-067, it makes sense that there would not be as much cross-over of IP addresses.\n\nSome of the cross-over can be written off as systems that were infected with W32.Downadup having been\ndisinfected. Others may be that a system infected with W32.Downadup, which is no longer vulnerable to the\nMS08-067 vector, may still be vulnerable to file share brute-forcing. Additionally, some of the cross-over is likely\ncoming from systems being infected through USB key transfer (another propagation vector leveraged by the .B\nvariant) that are behind a shared gateway, and thus the same IP address, as systems infected with the original\nvariant.\n\nWe’re continuing to collect and analyze data related to infections, documenting how this worm family evolves,\nand watching to see if the domain-base update mechanism used. This is by far one of the most prolific worms in\nmany years and has an extremely large infection base that could do a lot of damage.\n\n\n-----\n\n#### Peer-to-peer payload distribution\n\n_Originally published January 19, 2009 by Eric Chien_\n\nWhile many researchers, including us, are speculating on the magnitude of infections from Downadup (a.k.a.\nConficker), we are also all waiting for the other shoe to drop. At this point, Downadup has replicated to poten­\ntially millions of machines but there has been no additional payload—yet. Ten years ago, just replicating was\nenough motivation in creating malicious code, while today the vast majority of malware has a monetary motiva­\ntion. Based on previous variants and characteristics of the code, we believe the worm is associated with a wellknown malware gang that has previously distributed a variety of adware, and more recently misleading applica­\ntions (a.k.a. rogue antispyware products).\n\nThe worm actually has two mechanisms to receive additional payload files. One has been reported on widely, in\nwhich a list of domain names is generated every day and contacted for updates. Eventually, one of these domains\nis likely to be registered by the malicious code authors where they will host the additional payload file. However,\nsecurity vendors such as Symantec are also watching these domains, which make them less than ideal for the\nmalware authors, especially if they are quickly shut down.\n\nSo, another mechanism exists to distribute the payload files and it is more difficult to track and equally more\ndifficult to shut down. The worm uses a (potentially inefficient) peer-to-peer (P2P) mechanism that allows it to\nshare files between infections.\n\nFigure 9\n###### Downadup peer-to-peer mechanism\n\nDuring the process shown above, Downadup not only patches the RPC vulnerability in memory, but uses this\npatch to recognize incoming exploit attempts from other Downadup-infected machines. The worm is able to\nanalyze the incoming shellcode and checks if it matches its own exploit shellcode. If the shellcode matches,\ninformation is extracted from the shellcode that allows the worm to connect back to the other infected machine.\nThis “back connect” uses the HTTP protocol, but on a randomly selected port. The other infected machine then\nresponds with a packet of data consisting of the payload files.\n\nDownadup can transfer multiple payload files using this mechanism. Each is possibly encrypted (or at least digi­\ntally signed) and contains a header containing a file identifier and a date timestamp. The file identifier allows the\nworm to check if it already knows about this file and determine if it needs to be updated. The date timestamp is\nused as an expiration date and if the file is past its expiration date, it is discarded. The payload files are continu­\nally reviewed and those that are past their expiration are culled. These payload files are then saved in the regis­\ntry and provided when other peers request them and allows the payload files to be maintained across reboots\n\n\n-----\n\nThese payload files can then either be saved to disk and executed or loaded directly to memory. Thus, additional\npayload files can end up being executed with no files hitting the disk.\n\nSo, while we know Downadup’s method of operation, we still await its motive.\n\n\n-----\n\n#### Geo-location, fingerprinting, and piracy\n\n_Originally published January 20, 2009 by Patrick Fitzgerald_\n\nDownadup has been the most prolific worm that we have seen for some time. While as a part of this series we\nare documenting some of the more interesting, technical sides of this threat, other non-technical aspects of this\nthreat also present noteworthy issues. The map below shows the top 10 countries rated by infection prevalence.\n\nFigure 10\n###### Top 10 countries ranked by W32.Downadup infections\n\nAs shown in figure 10, China has almost three times as many infections as the second-most infected country, Ar­\ngentina. Even more notably, some of the nations with higher computer usage such as the United States or Korea\nare trailing considerably. So, what is causing this skew?\n\nDownadup uses an remote procedure call (RPC) exploit as its main vector for propagation. This exploit is only ef­\nfective against machines that have not applied the MS08-067 patch. In addition, the ability to exploit the vulner­\nability effectively requires knowledge of both the operating system (OS) version (e.g. Windows XP vs. Windows\n2003) and the language of the targeted machine. Figure 11 is a snippet of a larger list in Downadup of configura­\ntion values needed for different versions and languages.\n\nFigure 11\n###### Downdup configuration values: snapshot\n\nFirst, to attempt to determine which version of Windows the remote host is running, Downadup fingerprints the\nremote host by sending an SMB Session Setup Request. The remote machine provides the OS version and service\npack as part of its response. For example, figure 12 below shows a remote host responding with Windows 2000\nas its OS version.\n\nThe second, and more difficult step, is determining the remote machine’s language version. Downadup guesses\nat the language version by using IP geo-location. Recent versions of Downadup contain RC4 encrypted IP geolocation information By looking up the remote machine’s IP address in the geo-location information Downadup\n\n\n-----\n\nis able to match the IP address to a\ncountry and then maps that country\nto a particular language. Downadup’s\ngeo-location data appears more ef­\nfective for certain countries such as\nChina and Argentina.\n\n\nFigure 12\n###### W32.Downadup remote host response\n\n\nIt should be noted that these tech­\nniques are far from 100% reliable\nand in some cases cannot even be\nutilized (for instance, private IP\naddresses in a NAT setup). In these\ncases, Downadup guesses at the\nversion of the remote host and uses a\nset of mostly ineffective defaults for\nthe language, except for Chinese and\nBrazilian Portuguese. If the existing\nhost is Chinese or Brazilian Portuguese, Downadup will assume the remote host is Chinese or Brazilian Portu­\nguese. This likely provides increased efficacy in countries such as China and Brazil.\n\nA second possible explanation for the skew is that on October 20, 2008, Microsoft rolled out an updated Win­\ndows Genuine Advantage (WGA) system to help combat the high rate of piracy of its Windows platform. One of\nthe side effects of this policy is that people using illegal copies of Windows will be more likely to disable auto­\nmatic updates from Microsoft. The fear is that a subsequent update may adversely affect their experience with\n[Windows in a similar way the “black screen” that affected many users in China operating illegal copies of Win­](http://en.wikipedia.org/wiki/Windows_Genuine_Advantage#WGA_in_China)\ndows. Without automatic updates, it is highly unlikely that many of these users are manually installing critical\nupdates such as MS08-067.\n\nFigure 13 shows the rate of software piracy in 2006.\n\n\nWhat is interesting about the data shown in\nfigure 13 is that China, India, and Russia all\nhave a high percentage of pirated software\nin use and these countries also feature in the\ntop 10 countries ranked by W32.Downadup\ninfections, as shown in figure 10 above.\nThe lack of patching due to piracy may be a\ncontributory factor to high infection rates in\nthose countries. People with illegal copies of\nWindows who choose to disable automatic\nupdates can create an ideal breeding ground\nfor malicious code authors to proliferate their\nwares.\n\nSo, the bottom line is that while Downadup\nhas been highlighted in the press due to ex­\ntremely high infection numbers, not all coun­\ntries are affected equally. Some residents of\ncertain countries may be wondering what all\nthe hype is about, while others can’t under­\nstand why they haven’t heard more about it.\n\n\nFigure 13\n###### Software piracy in selected countries, by percentage (2006)\n[Source: http://arstechnica.com/news.ars/post/20080122-bsa-piracy-eco­](http://arstechnica.com/news.ars/post/20080122-bsa-piracy-economic-impact-is-tens-of-billions-of-dollars.html)\n[nomic-impact-is-tens-of-billions-of-dollars.html](http://arstechnica.com/news.ars/post/20080122-bsa-piracy-economic-impact-is-tens-of-billions-of-dollars.html)\n\n\n-----\n\n#### A lock with no key\n\n_Originally published January 21, 2009 by Ka Chun Leung_\n\nWe know that W32.Downadup.B is aggressive when it comes to infecting computers. So, let’s talk about some of\nthe tricks it uses to stay on a computer once an infection is successful. One of our test computers was infected\nwith W32.Downadup.B. I scanned it with an old, original shipping version of Norton Antivirus 2006 and the fol­\nlowing error message appeared:\n\nFigure 14\n###### Error message from old version of Norton AntiVirus 2006\n\nA process on the computer has “locked” the file, which prevents anybody else from accessing it. Now, antivirus\nsoftware has many ways of getting around this sort of lock. Why isn’t it working here?\n\nWhen W32.Downadup.B infected this computer, we saw it drop the file C:\\WINDOWS\\system32\\rkabg.dll and\nthen watched it install itself as a service (in this case as “bmumwkvn”) in the netsvcs service group. So, I should\nbe able to unlock the file by stopping this service.\n\nFigure 15\n###### W32.Downadup.B service\n\n\n-----\n\nHowever, the service was already stopped. A closer look at the running services and processes on my computer\nreveals nothing suspicious, but something must be maintaining that lock. Process Explorer from Sysinternals\n(now a part of Microsoft) has a useful feature to find which process is accessing a file.\n\nFigure 16\n###### Process Explorer view of service\n\nSvchost.exe—the process that hosts the service created by W32.Downadup.B—is holding the lock and running,\neven though the W32.Downadup.B specific service isn’t stopped. Some further analysis reveals that the W32.\nDownadup.B service runs when the computer boots. It then injects code into the service host before unloading\nitself. This trick works against a surprising array of different antivirus software.\n\nAfter closing the file handle in Process Explorer, the scan works as expected.\n\nFigure 17\n###### Working scan after closing file handle\n\nSo, while this may have been an issue in 2006, up-to-date versions of Symantec’s products no longer have this\nissue. Unfortunately for this and other threats, those users with unpatched older products are alerted anyway\n(even without the signature detecting the threat) due to the fact the file is locked.\n\nDon’t forget—if you believe your computer may be infected with Downadup and are having trouble detecting and\n[removing it, you can always download our free fixtool.](http://www.symantec.com/security_response/writeup.jsp?docid=2009-011316-0247-99)\n\n\n-----\n\n#### Small improvements yield big returns\n\n_Originally published January 22, 2009 by Elia Florio_\n\nBack in November 2008, Symantec raised the ThreatCon level in response to a significant increase of exploita­\n[tion activity of MS08-067, even when other vendors were still downplaying or ignoring this large increase of](http://www.computerworld.com/action/article.do?command=viewArticleBasic&taxonomyId=89&articleId=9121198)\n[network attacks. This was just the beginning of Downadup saga.](http://www.computerworld.com/action/article.do?command=viewArticleBasic&taxonomyId=89&articleId=9121198)\n\nW32.Downadup wasn’t the first worm exploiting MS08-067, but it clearly had something “special” when com­\npared to its previous competitor threats (see W32.Kernelbot.A and W32.Wecorl). From the programming style,\nthe tricks, and the ideas used in the W32.Downadup code, we could easily say that W32.Downadup wasn’t the\naverage threat that we would normally see in the wild. The first variant of the worm was able to infect an es­\ntimated 500,000 machines due to an aggressive infection routine and a sophisticated exploitation algorithm,\nwhich makes use of geo-location and OS fingerprinting.\n\nFigure 18\n\nHowever, the first variant\n\n###### MaxMind removes GeoIP file\n\nof Downadup wasn’t able to\nachieve the same damages\nof its successor, mostly due\nto two reasons: it was able to\nspread only with one mecha­\nnism and it had a single\npoint of failure, which was\nthe data file used to perform\ngeo-location of IP addresses.\nThis file (GeoIP.dat.gz) was\nfreely available on the Web\nback in November 2008\nand was downloaded by the\nworm directly from the Web site using a hard­ Figure 19\ncoded URL in its code. At some stage, MaxMind Extra encrypted data in W32.Downadup.B\nremoved this GeoIP file from their Web site,\nprobably because of the denial-of-service (DoS)\neffect they would have been experiencing on\ntheir servers, which were being contacted by\nall machines infected by W32.Downadup. This\nchange somehow affected the exploitation abili­\nties of the first variant.\n\n\nWhen this happened, Downadup authors had\nseveral good reasons to release an updated\nversion of the threat and so they decided to fix\nthe GeoIP file problem and increase the propa­\ngation of the worm for the next release. When\nW32.Downadup.B came out on December 30,\n2008, the new variant was able to copy across\nUSB and/or network drives and could also infect\nmachines by brute-forcing user passwords, all\nof which dramatically increased its ability to\nspread. In addition, the authors fixed the GeoIP\nproblem from the first variant by inserting the\nGeoIP file directly into the appended data of the\nthreat file. In fact, W32.Downadup.B samples\nhave almost 75K of extra data tagged onto the\nend, encrypted with RC4 using a 29-byte key.\nAft d ti thi b ff l RAR\n\n\n-----\n\narchive that contains all of the GeoIP information necessary for the targeted exploitation routine. This data is\ndecrypted and decompressed in memory on-the-fly by the malware, and then re-encrypted to avoid memory\nforensics.\n\nAnother interesting change introduced by authors in the W32.Downadup.B code is the variation of the pseudorandom domain name generation algorithm. Researchers at Symantec and other security companies were able to\nreverse-engineer the Downadup code and successfully crack the domain-generation algorithm. It is well known\nthat the worm generates a set of 250 different domains every day; therefore, being able to predict these domains\nmay help in tracking infected computers and also preventing further infections. The authors introduced small\nchanges in the .B variant to produce a slightly different list of pseudo-random domains, most likely to attempt\n\n\nFigure 20\n###### Comparison of domain-generation code\n\n\nto stymie these reverse-engineering\nefforts.\n\n\nThe PRNG* algorithm relies on a seed\nvalue that will be the same across\ninfected systems every day. The seed is\ngenerated using a set of 64-bit math­\nematical operations using both static\nvalues and the numeric values of the\ncurrent year, month, and day. These\nvalues are three magic numbers used\nrespectively as multiplier (M), divisor\n(D), and additive (A) constant. The\nPRNG routine is a 200-byte piece of\ncode that performs different floatingpoint operations and uses a second\ninternal multiplier value (M2), which\nis also hardcoded. What’s changed\nbetween the two worm variants are\nthese magic values M, D, A, and M2,\nwhile the logic of the PRNG algorithm\nis exactly the same. What Downadup is doing with these domains is simple: downloading and executing addi­\ntional malicious content. It’s still a mystery as to what this additional content is, but we are speculating that it is\nsomehow related to eastern-European cyber criminals and misleading applications.\n\nA final question that came to mind was, seeing as the list of the future domains was publicly disclosed on the\nWeb, why hadn’t any other cyber criminals taken advantage of the predictions? We know that security vendors\nregistered some of these domains for monitoring purposes, so why didn’t some other miscreant try to register\none of these domains to push out another Trojan to all machines infected with Downadup? Cyber criminals are\nnot new to these things and it won’t be the first case of a stolen botnet. Well, we found a valid explanation for\nthis when we looked into Downadup downloading additional code. As we have said previously, the authors of\nDownadup are not beginners and they may have the feeling that someone—sooner or later—would break their\ndomain prediction algorithm. So, to avoid losing their botnet, they put a secondary (strong) protection into the\nthreat, which makes it impossible for anyone (other than the original authors) to upload new malicious compo­\nnents onto compromised machines.\n\n- Thanks to the Symantec DeepSight team and to Symantec’s Aaron Adams for the superb analysis while revers­\ning the PRNG algorithm.\n\n\n-----\n\n#### Attempts at smart network scanning\n\n_Originally published January 23, 2009 by Eric Chien_\n\nThe ability of a threat to widely replicate often depends on its algorithm of finding other computers on the Inter­\n[net, which are represented by an IP address. Downadup uses a variety of techniques to scan for new machines in](http://www.symantec.com/business/security_response/writeup.jsp?docid=2008-123015-3826-99)\norder to maximize its infection abilities and at the same time minimize the chance of being noticed on a host.\n\nBrute-force network scanning can cause noticeable slowdowns and network issues on the infected machine.\nDownadup attempts to limit its impact in two ways. Firstly, the worm contacts two well-known Web sites and\ncalculates the computer’s average bandwidth, then uses this value to configure how many simultaneous remote\nprocedure call (RPC) exploit scans are allowed at one time. Secondly, a pause—between 100 milliseconds and\ntwo seconds—is taken after each scan, depending on the type of scan and if the computer is currently being\nused. (Downadup checks active usage by determining if a keystroke was made in the previous five minutes.)\n\nDownadup attempts four different scans that are repeated in an infinite loop. It scans for machines on the same\nsubnet, machines it has successfully infected previously, machines nearby those already infected, and randomly\nselected machines.\n\nFirst, Downadup sequentially scans all the IPs in the same subnet of the infected machine, starting from the first\nIP in the subnet. This can include multiple subnets for multi-homed machines (machines with more than one IP\naddress).\n\nNext, Downadup attempts to exploit previously infected machines. This serves two purposes—one, to reinfect\nmachines that may have been cleaned up and two, to initiate the peer-to-peer (P2P) communication channel to\nreceive payload files (as described in the blog article Downadup: Peer-to-Peer Payload Distribution). The worm\nonly remembers the last 100 successfully infected machines.\n\nThen, Downadup begins generating random IP addresses to attack. In addition to what is likely a bug rather than\na feature in the random generation routine, certain IP addresses are ruled out, therefore potentially limiting cer­\ntain networks from being attacked. Downadup is only able to generate approximately a quarter of the four billion\npossible IP addresses, which limits its ability to reach certain IP addresses via the RPC exploit.\n\nFinally, in parallel, Downadup will also scan machines near other machines that were successfully exploited. For\neach exploited machine, Downadup scans the class C-sized (/24) block of the IP address and the previous ten\nclass C-sized (/24) blocks. For example, if the successfully exploited machine is 208.77.188.166, Downadup will\nscan the range 208.77.178.1 to 208.77.188.255.\n\nFurther, Downadup doesn’t scan every IP address in the calculated ranges. For example, invalid IP ranges such as\n127.x.x.x or 169.254.x.x. are skipped. But more importantly, Downadup carries a large blacklist of IP ranges that\nbelong to security vendors. A snippet of the list is shown in figure 21.\n\n\nBy not attempting to exploit security vendors,\nDownadup potentially avoids honeypot systems.\nThis blacklist is also used to reject back-connect\nattempts as well, preventing security vendors\nfrom contacting infected hosts and gaining pay­\nload files.\n\n\nFigure 21\n###### Blacklisted IP ranges in Downadup\n\n\nDownadup will then refresh the list of IP address­\nes configured on the local machine. If any have\nchanged since any of the related scans started,\nthe scans will be terminated because the exploit is\ndesigned to connect back to the previously configured IP address.\n\nKnowing what IP address to connect back to raises another issue for Downadup. With many home users behind\nwireless routers, firewalls, and using network address translation (NAT), many infected machines are normally\nnot contactable from external machines. Downadup goes to great lengths to bypass these issues. We’ll investi­\ngate these techniques in a future blog article in this W32 Downadup series\n\n\n-----\n\n#### Playing with Universal Plug and Play\n\n_Originally published January 28, 2009 by Eric Chien_\n\nAmong other methods, Downadup infects other machines via a remote procedure call (RPC) exploit against the\nMS08-067 vulnerability. Using the vulnerability, the worm injects shellcode that connects back to the infecting\nmachine. This is known as a back-connect. The back-connect works via HTTP on a randomly selected port and\nthe infecting machine responds to incoming requests by providing the entire worm file. The shellcode receives\nthis file and executes it on the remote host, causing it to then become infected.\n\nFigure 22\n###### Downadup back-connect feature\n\nHowever, many home users today use routers or other Internet gateway devices that by default prevent external\nmachines from connecting their home machines, in addition to using network address translation (NAT). This\nwould normally prevent Downadup’s shell­ Figure 23\ncode from successfully completing infection Failed back-connect due to gateway device\nbecause the back-connect would fail.\n\nTo bypass this issue, Downadup needs to\nperform three actions; determine if the ma­\nchine is behind a gateway device, obtain the\nIP address on the outside interface of the\ngateway device (this is the IP that is visible\nto external machines), and also make sure\nincoming connection attempts to certain\nports on the gateway device are passed\nthrough to the internal machine. This is\nknown as port forwarding. Downadup uses\nthe Universal Plug-and-Play (UPnP) protocol\nto achieve these tasks.\n\nThe UPnP protocol is supported by default in\nmany common gateway devices that are in use in\nhome user environments. To achieve the first task, Downadup harnesses UPnP’s discovery protocol, which is\nbased on the Simple Service Discovery Protocol (SSDP). The discovery protocol allows machines on the network\nto find gateway devices that are also on the network.\n\nAs part of SSDP, Downadup sends an M-SEARCH request to the multicast address 239.255.255.250 on port\n1900/udp and then listens for responses The M-SEARCH request requires a header known as the search target\n\n\n-----\n\n(represented by “ST”) that represents the types of devices or services Downadup is looking for. These are repre­\nsented by universal resource identifiers (URIs). Downadup looks for the following four devices or services:\n\n1. urn:schemas-upnp-org:device:InternetGatewayDevice:1\n\n2. urn:schemas-upnp-org:service:WANIPConnection:1\n\n3. urn:schemas-upnp-org:service:WANPPPConnection:1\n\n4. upnp:rootdevice (represents all UPnP devices)\n\nHere is an example of the contents of an M-SEARCH request packet:\n```\n M-SEARCH * HTTP/1.1\n\n HOST: 239.255.255.250:1900\n\n ST: urn:schemas-upnp-org:device:InternetGatewayDevice:1\n\n MAN: “ssdp:discover”\n\n MX: 3\n\n```\nIf a matching device exists on the network, the device will respond with a message that contains an additional\nURL that provides information about the device and the services the device supports. After verifying the device\nis suitable, Downadup sends a UPnP GetStatusInfo request to ensure the device is currently connected on the\nexternal wide area network (WAN) interface. This completes the first requirement of determining the infected\nmachine is behind a gateway device.\n\nNext, an UPnP GetExternalIPAddress command is sent to the device to obtain the external IP address, complet­\ning the second requirement of having the IP address on the external interface. This is the IP address that is vis­\nible to other machines on the Internet.\n\nFinally, Downadup needs to port forward incoming requests through the gateway and to itself on the internal\nmachine. A port forwarding request requires a few parameters; the relevant ones in this case are the port for­\nwarding entry description, the external listening port, and the internal IP and port to forward to.\n\nThe description for the port forwarding entry is generated from the Volume Serial Number and the Computer\nName of the infected system. This forms a relatively unique description. Downadup sends the GetGenericPort­\nMappingEntry command to the gateway device to enumerate all of the existing port forwarding entries in order\nto see if any of the descriptions match the generated description. If they match, the worm assumes they are prior\nentries created by itself and are deleted using the UPnP DeletePortMapping command.\n\nA new port forwarding entry is then added using an AddPortMapping request. Downadup attempts to use port\n80 for the external port and the internal port is randomly generated. If the configuration change fails, two more\nattempts will be made, but with a randomly generated external port number between 1024 and 10000.\n\nFigure 24\n###### Back-connect after modifying gateway\n\n\n-----\n\nThis completes the process, allowing back-connects to be passed from the external network into the internal\nnetwork. It therefore allows Downadup to successfully complete its infection in common home-user scenarios.\n\nAstute readers may have noted that while this procedure allows Downadup to infect other machines when it is\nbehind a gateway device, machines behind their own gateway devices are still protected (if they are dropping\nRPC and other network traffic). Unfortunately, Downadup can be introduced into a private network through\nother replication means and once inside a private network is vigorous in infecting the entire local network.\n\nAdvanced users may wish to consult their gateway device manual and determine if they can disable UPnP to\nprevent undesired modifications to their gateway security.\n\n\n-----\n\n#### Locking itself out\n\n_Originally published February 18, 2009 by Eric Chien_\n\n[While Downadup’s RPC exploit method of spreading has been highlighted in several recently posted blog articles,](http://www.symantec.com/business/security_response/writeup.jsp?docid=2008-112203-2408-99)\nthe worm spreads via other methods as well. One of the potentially more noticeable methods is through network\nshares, especially in enterprise environments.\n\nDownadup attempts to copy itself to other machines using the administrative network share (ADMIN$) that\nexists by default on Microsoft Windows machines. However, copying itself to the share requires authentication.\nThis requirement leads to some noticeable side effects.\n\nDownadup first enumerates all of the servers in the network by making a NetServerEnum request, which returns\nall of the visible Windows machines on the network. Downadup then attempts to infect each of these machines.\n\nTo become authenticated, the credentials of the locally logged-on user are tried first. However, if that does not\nwork, Downadup begins trying different user name and password pairs.\n\nThe remote server is queried for all of the user names available. Fortunately, most Windows XP and later systems\nwill not provide this information by default and in those cases all of the user names on the local machine will be\nused instead.\n\nRich with user names, Downadup now tries to connect to the remote server with each user name and a variety of\npasswords, including:\n\n     - The user name\n\n     - The user name concatenated together twice (e.g. joesmithjoesmith)\n\n     - The user name reversed (e.g. htimseoj)\n\n     - Almost 250 common passwords such as “password”, “123”, and “admin”\n\nFigure 25\n###### Password authentication method\n\n\n-----\n\nAlthough it is potentially clever, an immediate side effect of this password guessing is a rush of incoming calls\nto enterprise IT helpdesks from users who have been locked out of their account due to security policy rules\nthat cause account lockout after several invalid attempts. This side effect can become even more problematic\nbecause Downadup does have the ability to enumerate all existing user names; therefore, account lockout can\nsuddenly occur for all of the users in an organization—even if only a single user or machine is infected.\n\nFigure 26\n###### A snippet of some of the passwords used\n\nIf Downadup correctly guesses a password before being locked out, it will copy itself to the System32 folder\non the remote machine via the administrative share (ADMIN$) as a random file name with a random extension.\n(Later, when the file is executed, it will remove itself and copy itself as another random file name with the exten­\nsion “DLL”.) The file time of the file is then changed to the same file time as kernel32.dll to avoid suspicion.\n\nOnce the file is placed on the remote machine, it still needs to be executed. A scheduled job on the remote ma­\nchine is created so that the file is executed on the next hour, based on the local time of the infecting machine.\nSo, if the infecting machine time is 2:36 PM, the remote machine will have a scheduled job at 3:00PM to execute\nthe file. Execution actually happens via rundll32.exe because the file copied over is a DLL.\n\nAfter all servers, user names, and passwords are tried, Downadup will wait 40 minutes and then try all over\nagain. This of course has the potential to cause accounts to be locked out again, resulting in yet more IT helpdesk\ncalls.\n\n\n-----\n\n#### A new Downadup variant?\n\n_Originally published February 23, 2009 by Patrick Fitzgerald_\n\nOver the last few days many reports have emerged concerning a new variant of Downadup (a.k.a. Conficker),\nwhich has been dubbed Downadup.B++ or Conficker.C. While one could categorize Downadup into three variants\n(or even more), Symantec products will detect all known variants of Downadup as either W32.Downadup or W32.\nDownadup.B.\n\nUnfortunately, in addition to differences in names, variant differentiation also exists between vendors. Some\nvendors have a different detection for every single Downadup binary—with a differing MD5 hash—resulting in\nmore than 30 different Downadup “variants”. Some others don’t differentiate at all and just have a single name\nwith no variant differentiation.\n\nHowever, the important point regarding Downadup is not whether this is another variant, but rather is it a new\nvariant; i.e., if it has been released recently. Fortunately, Downadup.B++ / Conficker.C is not a newly released\nvariant. This variant has been around since the main outbreak of Downadup, and most vendors already have\ndetections for it.\n\nThe main item that has prompted the industry to highlight this sample as another variant is the emergence of\nits peer-to-peer behavior. This behavior was analyzed and discussed previously, in detail, by Eric Chien in the\nblog entry Downadup: Peer-to-Peer Payload Distribution. Symantec customers have been protected from this\nDownadup.B++ / Conficker.C variant for some time now, as long as they have kept their definitions up to date.\n\n\n-----\n\n#### Advanced crypto protection\n\n_Originally published February 23, 2009 by Elia Florio_\n\nThe conclusion of my previous blog posed an interesting question to readers: “...seeing as the list of the future\ndomains was publicly disclosed on the Web, why hadn’t any other cyber criminals taken advantage of the predic­\ntions?” Antivirus companies and many independent security researchers were able to crack the domain predic­\ntion algorithm used by the worm, so it is reasonable to believe that other people were able to achieve the same\nresult, but with different intentions. In fact, predicting what the next domain will be creates the perception that\nsomeone can take control over the botnet, and, for example, start pushing a bank Trojan to these millions of\nmachines infected with Downadup. We already know that there’s no honor among thieves, and so it won’t be a\n[surprise if we see future Downadup domains registered by other criminals. There are also credible reports that](http://asert.arbornetworks.com/2009/01/two-weeks-of-conflicker-data/)\nthis is already happening because some of the future domains pointed to well-known IP addresses used by the\nASProx gang in the past.\n\nUnfortunately, the takeover is not such a simple job. Registering a domain with the intent of stealing the\nDownadup botnet is not enough. Nobody, except Downadup’s authors, will be able to push files to the botnet\nbecause of some advanced security measures utilized by the gang.\n\nWe analyzed the downloading routine of W32.Downadup.B and we found that is secured by asymmetric cryp­\ntography. The digital signature and very long crypto keys make this job impossible. The payload downloaded\nfrom one of the domains is encrypted with RC4 (using a 64-bytes key) and then digitally signed by the authors\nusing their private key. In fact, the worm binary contains the corresponding public key (4096-bit) and a value\nthat looks like the public exponent. The algorithm looks similar to RSA encryption, or perhaps it’s just one of the\nasymmetric algorithms available today.\n\nFigure 27\n###### Public crypto key hardcoded in the worm binary\n\nAt the moment, no download has been observed from Downadup-infected machines, so nobody is able to tell\nyou what the payload is, presumed to be downloaded over HTTP at some point in the future by the botnet. So, we\ncan’t tell you today what the unwanted gift will be, but we can tell you what it will look like:\n\n\n-----\n\nFigure 28\n###### Code snippet of the header-parsing routine\n\nLooking at the code snippet above, we can say that “package” downloaded by Downadup will have a general\nheader with a size of 12 bytes, followed by multiple instances of encrypted and digitally signed payloads. Each\nof these payloads will have its own header (20 bytes) and will contain an appended blob of data at the end (512\nbytes), which is the unique digital signature of the payload. The following diagram shows the structure of the\nwhole package and that of a single payload.\n\nFigure 29\n###### Structure of a W32.Downadup.B payload\n\n\n-----\n\nDownadup authors tried to put basic safety checks in place so the code verifies that the received package is big­\nger than 12 bytes, and also that the size stored in the general header matches the size of data received. There\nare also checks to avoid reading after the end of the data (ironically, they seem very afraid of having buffer\noverflows in the code!).\n\nThe structures and the fields of the headers are defined below:\n\nGENERAL_HEADER (size = 12 bytes)\n```\n 00 DW num _ of _ entries ; num of payloads in the package\n\n 04 DW size _ of _ data ; size of data without this header\n\n 08 DW (not _ used) ; ?\n\n```\nPAYLOAD_HEADER (size = 20 bytes)\n```\n 00 DW dwFileNumber ; unique identifier for this payload\n\n 04 DW dwUnknownX     ; ?\n\n 08 DW dwExpTime _ lo   ; expiration time (low)\n\n 0C DW dwExpTime _ hi   ; expiration time (high)\n\n 10 DW dwLengthOfFile   ; size of encrypted data\n\n```\nThe verifier routine runs a loop that parses the header of each payload to locate the end of the encrypted data\n(dwLengthOfFile) where the Digital Signature is stored. Using the asymmetric algorithm and public exponent/\nmodulus values, the code decrypts the 512-byte digest and extracts two important things: the real decryption\nkey (64-bytes, used later with RC4 algorithm) and the hash value of the encrypted data (64-bytes). The following\ndiagram shows what the worm expects after asymmetric decryption of the digital signature.\n\nFigure 30\n###### Structure of digital signatures in payloads\n\nFinally, the worm performs all of the validations that will allow it to verify if the payload is trusted and has been\ncreated by the real author, by following these steps:\n\n1. It verifies that the hash extracted from the signature matches with the hash calculated over the encrypted data\n\n(the encrypted message has not been altered);\n2. It runs RC4 decryption over the encrypted data with the 64-bytes key extracted from the signature;\n\n3. It calculates the hash of the decrypted data after RC4 and verifies that this new hash matches with the decryp­\n\ntion key (i e the encryption key is the hash of the plaintext message)\n\n\n-----\n\nThe hashing algorithm used by the worm does not look similar to any of the well-known algorithms. It produces\na hash value of 64-bytes (512-bits), but it’s not the popular SHA-512. We just know that the hash value of null\n(=empty file) produced by this custom algorithm is the following sequence:\n```\n 6B 7F 33 82 1A 2C 06 0E CD D8 1A EF DD EA 2F D3 C4 72 02 70 E1 86 54 F4 CB 08 EC E4 9C CB 46 9F\n\n 8B EE EE 7C 83 12 06 BD 57 7F 9F 26 30 D9 17 79 79 20 3A 94 89 E4 7E 04 DF 4E 6D EA A0 F8 E0 C0\n\n```\nAfter all of this analysis, the conclusion is that the Downadup authors have taken extreme measure to protect\ntheir job and this again demonstrates the level of professionalism of these criminals. We suppose that these\ncrooks are afraid of just two things right now: the $250K bounty reward offered by Microsoft, and the risk of\nhaving an exploitable buffer overflow in their code. In fact, while the crypto protection can’t be easily bypassed,\nit may be possible that their code has some exploitable overflow condition that can allow some other bad guy\nto push a malformed package that will DoS or exploit the worm. The code seems to have basic checks against\nlarge buffers; but, for example, there could be problems with a buffer smaller than expected or with integer wrap\ncaused by invalid sizes. But, that’s another story.\n\nBig thanks to Eric Chien for his help with this analysis.\n\n\n-----\n\n#### Propagation by AutoPlay\n\n_Written by Ben Nahorney and John Park_\n\nDownadup has become one of the most prolific worms in recent years based on its exploitation of MS08-067.\nBut taking advantage of this vulnerability is far from its only propagation technique, and its methods to spread\nare not just limited to those that work over network connections. As with many threats that come before it, W32.\nDownadup.B takes advantage of the AutoPlay feature available in Windows operating systems (OS). Yet the worm\nexhibits a couple of variations on the traditional AutoPlay tricks so often seen from other threats.\n\n\nThe first of these tricks falls into the realm of social\nengineering. Say you happen to have a USB drive\ninfected with W32.Downadup.B and you insert the\ndrive into a USB port of a computer running Windows\nXP. When AutoPlay is triggered (assuming you haven’t\ndisabled it already) you may see a dialog box similar\nto figure 31.\n\nA cursory glance at the dialog box gives the impres­\nsion that the first choice offered will open a folder\non the drive so you can view the files. But looking\ncloser, three things stand out. For starters, the first\nsentence hints that Windows wants to know what you\nwould like to do with the file you are about to open.\nSecondly, the type of file is a Program, as indicated by\nthe icon displayed below the first sentence. Finally,\nthe first option available offers to “open the folder to\nview files using the program provided on the device”.\nWindows is not offering to open it with one of its\nbuilt-in utilities—it’s asking you if you want to launch\na program on the USB device.\n\nNow a novice or intermediate computer user may not\nunderstand what Windows is asking in this case, even\nif they did read the details carefully. To Microsoft’s\ncredit, they have addressed this to some extent in\nWindows Vista and later versions of their operating\nsystems. If the same USB drive is plugged into a com­\nputer running Vista, they will see the AutoPlay dialog\nbox in figure 32.\n\nThe option to run the malicious program is now\nlisted under Install or run program, separated from\nstandard Windows features that are under General\noptions. Another clue is the option to “Always do this\nfor software and games”.\n\nThe problem here is that many people do not read\nAutoPlay alerts carefully. The Downadup authors\nknow this and are attempting to take advantage of it,\nhaving written their autorun.inf file in such a way that\nit appears as though you are selecting an option to\nopen a folder. Ultimately this is a lie, craftily present­\ned in order to get you to execute the malicious code\nfrom the USB device.\n\n\nFigure 31\n###### Downadup AutoPlay in Winodws XP\n\nFigure 32\n###### Downadup AutoPlay in Windows Vista\n\n\n-----\n\nTo demonstrate how this is done, let’s take a look at the functional text within the autorun.inf file used by the\nworm:\n```\n [autorun]\n\n Action=Open folder to view files\n\n Icon=%systemroot%\\system32\\shell32.dll,4\n\n Shellexecute=RUNDLL32.EXE .\\RECYCLER\\[RANDOM NUMBERS]\\[5-8 RANDOM LETTERS].[RANDOM EXTENSION]\n\n UseAutoPlay=1\n\n```\n\nThe two lines responsible for this social engineering trick\nare the Action= and Icon= lines. The first one displays\nthe text “Open folder to view files”— the same text\nWindows uses for opening a folder in Windows Explorer.\nWhen writing an autorun.inf file, you can generally get\nthis to say anything you would like figure 33.\n\nThe Icon= line helps the ruse by calling the fifth icon lo­\ncated in the shell32.dll file—a Windows folder icon. When\ncombined, these two lines in the autorun.inf file give the\nimpression that choosing this option only opens a folder.\n\nNow it’s the Shellexecute= line that carries the mali­\ncious punch. When W32.Downadup.B copies itself and its\nautorun.inf file to a removable drive, it puts its malicious\nDLL in the hidden %DriveLetter%\\RECYCLER folder—the\nRecycle Bin for the drive in question.\n\n\nFigure 33\n###### Arbitrary text in AutoPlay notification\n\n\nWhen quickly perusing a removable drive, you might not\nnotice its presence here, since the folder is hidden by\ndefault. Even if you did look carefully, you’d find another\nhidden folder within the Recycle Bin, with a name like\n“S-n-n-nn-nnnnnnnnnn-nnnnnnnnnn-nnnnnnnnn-nnnn”, where each “n” is a random number. This is meant to\nmimic folders often used by Security Identifiers (SIDs)—a unique number assigned by the OS to identify a user\nor group within a network of Windows computers. Folders based on SIDs are not an uncommon sight when view­\ning the hidden contents of a %DriveLetter%\\RECYCLER folder. By mimicking these folders, the threat does not\nlook out of place.\n\nAs a final precaution against discovery, the actual W32.Downadup.B file that is copied to this folder is given a\nrandom name, followed by a random extension. Any random extension, that is, except “DLL”—the actual file\ntype. What we have here is a DLL in sheep’s clothing. In the end, without the clues present in the autorun.inf file,\nthe malicious .dll file looks like nothing more than junk within an SID folder in the removable drive’s Recycle Bin.\n\nSo here is where it gets its teeth: when the Shellexecute= line runs, it calls rundll32.exe—the process respon­\nsible for executing DLLs and then placing their libraries into system memory. In this case the malicious W32.\nDownadup.B libraries are loaded and the compromised computer is infected by the worm.\n\nThe final UseAutoPlay=1 line of the autorun.inf file attempts to run its code without notifying the user with an\nAutoPlay dialog box, similar to the ones shown above. Unless the feature has been disabled, this results in the\nautomatic execution of the DLL on Windows XP SP2 and older operating systems.\n\nThis functionality is fairly cut-and-dry in terms of how AutoPlay operates, but W32.Downadup.B puts one more\nwrench into the works—it adds junk data to the autorun.inf file. It’s not a small amount of junk data either, tak­\ning up the vast majority of the file.\n\nYet AutoPlay still succeeds in carrying out the instructions in the file. This is because, when Windows recog­\nnizes the file as an autorun.inf file, it starts hunting for very particular instructions that it expects to see. First\nit searches out the expected [autorun] header, then any text that falls within a limited series of commands\n\n\n-----\n\nconsidered valid within an autorun.\ninf file. Any characters other than\nwhat is expected within the limited\nconfides of AutoPlay commands are\ncompletely ignored. Not only that,\nbut the commands don’t have to be\nuninterrupted strings, and Windows\nwill ignore junk data that is inserted\ninto the middle of a valid AutoPlay\nstring, as shown in figure 35.\n\nThe goal here is to make the auto­\nrun.inf file appear, to a user who\nmay open the file to inspect it, as\nthough it contains nothing but non­\nfunctional junk. (The actual Auto­\nPlay instructions are placed near the\nbottom of the file.) This is nothing\nbut another social engineering trick\nmeant to thwart more technical us­\ners who may be aware of the poten­\ntial dangers associated with finding\nan unexpected autorun.inf file at the\nroot of their removable drive.\n\nNow beyond removable drives, these\ntricks can be just as successful on\nnetwork drives. AutoPlay functions\nin much the same way in these\ncases and loading a compromised\nnetwork drive carries just as much\nrisk if AutoPlay is enabled.\n\nOne final trick used by W32.\nDownadup.B is the way that it looks\nfor removable and mapped drives.\nGenerally, when such a threat is\nexecuted, it checks all drives to de­\ntermine which are listed as “remov­\nable” or “remote” and then infects\nthem. W32.Downadup.B does this,\nbut it also registers a Windows’s\nobject that listens for the WM_DE­\nVICECHANGE message. When that\nmessage is triggered, usually by\nthe connection of a removable or\nmapped drive, the threat performs\nthis search again, attempting to in­\nfect the new device immediately. In\na nutshell, the threat can infect new\ndrives in real-time.\n\n\nFigure 34\n###### Junk data added to Downadup autorun.inf\n\nFigure 35\n###### Junk data added to Downadup autorun.inf\n\n\nOverall, W32.Downadup.B pulls some tricky maneuvers in order to spread using AutoPlay. As always, we rec­\nommend that you disable AutoPlay on your computer and your network to avoid potential infections of W32.\nDownadup.B or other threats that propagate using these techniques.\n\n\n-----\n\n#### W32.Downadup.C digs in deeper\n\n_Originally published March 6, 2009 by Peter Coogan_\n\nSymantec’s ongoing monitoring of Downadup (a.k.a. Conficker) has today resulted in the observation of a\ncompletely new variant being pushed out to systems that are already infected with Downadup. After taking into\naccount the hype surrounding some other recent reports of variants of Downadup, Symantec is calling this new\n[variant W32.Downadup.C.](http://www.symantec.com/business/security_response/writeup.jsp?docid=2009-030614-5852-99)\n\nOur analysis of the sample in question is still ongoing and at an early stage, but our initial findings have already\nrevealed some interesting new attributes for this sample. It does not seem to be using any existing or new means\nto spread the threat to new machines. It is targeting antivirus software and security analysis tools with the aim\nof disabling them. Any processes found on an infected machine that contain an antivirus or security analysis tool\nstring from the list below are killed:\n\n     - wireshark\n\n     - unlocker\n\n     - tcpview\n\n     - sysclean\n\n     - scct_\n\n     - regmon\n\n     - procmon\n\n     - procexp\n\n     - ms08-06\n\n     - mrtstub\n\n     - mrt.\n\n     - mbsa.\n\n     - klwk\n\n     - kido\n\n     - kb958\n\n     - kb890\n\n     - hotfix\n\n     - gmer\n\n     - filemon\n\n     - downad\n\n     - confick\n\n     - avenger\n\n     - autoruns\n\nAlso, in response to the security industry’s success in cracking the W32.Downadup.B domain-generation al­\ngorithm for communicating with the command & control server, the subsequent registration of these domain\nnames for monitoring purposes, and the resulting publication of findings, the Downadup authors have now\nmoved from a 250-a-day domain-generation algorithm to a new 50,000-a-day domain generation algorithm. The\nnew domain generation algorithm also uses one of a possible 116 domain suffixes.\n\nThese early findings may suggest that the Downadup authors are now aiming for increasing the longevity of the\nexisting Downadup threat on infected machines. Instead of trying to infect further systems, they seem to be\nprotecting currently infected Downadup machines from antivirus software and remediation. Also, currently we\nare not seeing an increase in customer infections for this threat but are keeping a close eye on it.\n\nSymantec is continuing to work with other industry leaders to mitigate the spread and damage caused by W32.\nDownadup. The most effective step that organizations and end users can take is to ensure that their computers\nhave up-to-date antivirus software and patches.\n\n\n-----\n\n#### W32.Downadup.C bolsters P2P\n\n_Originally published March 20, 2009 by the Security Intel Analysis Team_\n\nSometime between March 4 and March 6, 2009, the authors of the Downadup worm pushed out a significant up­\ndate to a portion of the Downadup network. Symantec Security Response engineers captured the update in one\nof their honeypots and quickly responded with definitions to protect against the threat. The history of this threat\nis quite interesting. Initially, the sole purpose of the worm was propagation, but it has since developed into a\nrobust botnet, complete with sophisticated code signing to protect update mechanisms, as well as a resilient\npeer-to-peer (P2P) protocol. The following table is a brief summary of the evolution of this threat.\n\nTable 1\n###### Brief summary of Downadup variants\n W32.Downadup W32.Downadup.B W32.Downadup.C\n\nNovember 21, 2008 December 30, 2008 March 6, 2009\n\n###### Propagation MS08-067 Exploitation MS08-067 Exploitation Removed\n\nFile share brute-forcing\n\nRemovable Media Infection\n\n###### C&C HTTP HTTP Improved HTTP\n\nPrimitive P2P Robust P2P\n\n###### Armoring None Kills some DNS lookups Kills some DNS lookups\n\nKills AutoUpdate Kills AutoUpdate\n\nHTTP and P2P code signing HTTP and P2P code signing\n\nKills security software\n\nAdvanced anti-security analysis\n\nOne interesting aspect of W32.Downadup.C is the omission of a propagation routine; this coincided with public\nreports of a decrease in TCP port 445 activity as of March 5, 2009. The decrease in TCP port 445 activity would\nbe expected, since W32.Downadup and W32.Downadup.B both had aggressive propagation routines and W32.\nDownadup.C does not. The Symantec DeepSight Threat Management System observed this decrease in activity,\nas illustrated in Figure 36.\n\nFigure 36\n###### Dip in activity observed over TCP port 445\nPossibly related to the update of the Downadup network with W32.Downadup.C\n\n|Table 1|Col2|Col3|Col4|\n|---|---|---|---|\n|Brief summary of Downadup variants||||\n||W32.Downadup|W32.Downadup.B|W32.Downadup.C|\n||November 21, 2008|December 30, 2008|March 6, 2009|\n|Propagation|MS08-067 Exploitation|MS08-067 Exploitation|Removed|\n|||File share brute-forcing||\n|||Removable Media Infection||\n|C&C|HTTP|HTTP|Improved HTTP|\n|||Primitive P2P|Robust P2P|\n|Armoring|None|Kills some DNS lookups|Kills some DNS lookups|\n|||Kills AutoUpdate|Kills AutoUpdate|\n|||HTTP and P2P code signing|HTTP and P2P code signing|\n||||Kills security software|\n||||Advanced anti-security analysis|\n\n\n-----\n\nThe other significant aspect of\nW32.Downadup.C is the addition of\na robust P2P update mechanism.\nThe P2P functionality allows the\nauthor to distribute cryptographi­\ncally signed updates to other com­\nputers infected with Downadup.\nThis P2P functionality contains a\nUDP P2P discovery routine that\nsends UDP traffic to lists of gener­\nated IPs and ports. Figure 37 il­\nlustrates all of the UDP activity, for\nports greater than 1024, that was\nobserved by the Symantec Deep­\nSight Threat Management System\nbetween February 18 and March 3,\n2009.\n\nThe Symantec DeepSight Threat\nManagement System registered a\nsharp increase in this UDP traffic\nbeginning March 4. This coin­\ncides with the date that the W32.\nDownadup.C update was pushed\nout to W32.Downadup.B hosts.\nThe large increase in UDP activity\nindicates that a significant num­\nber of systems infected with W32.\nDownadup.B began performing\nUDP P2P peer discovery to random\ntarget IPs. This is the behavior of\nthe initial P2P setup (bootstrap)\nroutines for W32.Downadup.C.\n\n\nFigure 37\n###### UDP activity for ports greater than 1024\nBetween February 18 and March 3, 2009\n\nFigure 38\n###### UDP activity for ports greater than 1024\nBetween March 4 and March 18, 2009\n\n\nThe main purpose of the P2P func­\ntionality is to allow the authors\nto push out signed updates to the\nW32.Downadup.C infected systems. Essentially, this threat has evolved from an Internet worm (potentially a test\nphase) to a functional back door and bot. The P2P network makes it difficult to dismantle the Downadup network\nbecause there is no centralized command-and-control system in place.\n\nIn addition to the P2P update, the now ancillary HTTP update method was also refined. This method now gener­\nates 50,000 domains a day, and randomly selects a subset of 500 domains that it checks daily for updates that\nare cryptographically signed by the author of the malware.\n\nAs for how this network will be used, there is still no indication as of yet.\n\n\n-----\n\n#### Downadup motivations\n\n_Originally published March 23, 2009 by Eric Chien_\n\n[As the April 1 payload delivery date nears for W32.Downadup.C (also known as Conficker) speculation continues](http://www.symantec.com/business/security_response/writeup.jsp?docid=2009-030614-5852-99)\non whether the payload will be one big April Fool’s joke, or the equivalent of a cyber Pearl Harbor. While we can’t\npredict the future with certainty, we can look at the motivations of past Downadup variants to postulate that the\npayload will likely be something between the two extremes.\n\nThe first Downadup variant (W32.Downadup) provides the best evidence of the motivations of the Downadup\nauthors. In a similar fashion to the recent Downadup variant, W32.Downadup had a payload delivery date after\nits initial release, on December 1, 2008. W32.Downadup attempted to download its payload file from http:/​/\ntrafficconverter.biz/4vir/antispyware/loadadv.exe. While W32.Downadup was never able to download its pay­\nload because the payload site was shut down, the owner of the site trafficconverter.biz was heavily involved in\n[pushing misleading applications (also known as rogue antispyware products) onto users’ machines. Misleading](http://www.symantec.com/norton/theme.jsp?themeid=mislead)\napplications pretend to scan an affected computer for malicious threats and try to scare the user into believing\ntheir machine is infected, when in fact it is not, and to remove the non-existent threats they attempt to convince\nthe user to cough up $50-$100 to buy the “software.”\n\nThe purpose of trafficconverter.biz (which is the same as traffic-converter.biz, and later, trafficconverter2.biz)\nwas to recruit affiliates to help install misleading applications. In their own words:\n\n_What is Traffic Converter?_\n_Traffic Converter is affiliate program that helps webmasters to convert their traffic into cash._\n\n_How it works?_\n_We are selling popular antispyware and security software products to surfers which you send to us. You receive_\n_$30 for each sale of our products._\n\n_Why does it work so good?_\n_With our direct-marketing approach, aggressive promotion materials and advanced software products you can_\n_earn much more than with other affiliate or advertising programs._\n\nBy signing up with Traffic Converter, you would receive URLs that would download and install misleading appli­\n[cations such as XP AntiVirus. The owner of Traffic Converter owned and delivered these misleading applications](http://www.symantec.com/security_response/writeup.jsp?docid=2007-101010-0713-99)\nthrough sister domains such as xpantivirus.com, antispyguard.com, antivirus2009online.com, and systemscan­\nner2009.com. Previously, the majority of these sites were registered via Estdomains and Directi, both of which\n[were well known for providing registrations for such sites. In turn, misleading applications, such as XP AntiVirus,](http://voices.washingtonpost.com/securityfix/2008/09/estdomains.html)\nappeared to be provided by another party known as Innovagest 2000, who has created a variety of similar clones\nas well such as AlfaCleaner and AntiMalware 2009.\n\nWith this history, the original motivations of Downadup appear pretty clear—to deliver misleading applications.\nHowever, the typical method of delivering misleading applications through Traffic Converter would happen\nthrough affiliates that would drive traffic to Traffic Converter through their own means, such as drive-by down­\nloads, or exploits placed in advertisement rotations in advertisement networks. For the affiliate to get credit for\ntheir installation, they usually needed to provide a unique affiliate ID in the download or installation request.\nSome example URLs that delivered to Traffic Converter domains were:\n\nhttp:/​/seamastersoft.com/soft.php?aid=0135&d-1&product=XPA&refer=3e6376a25\nhttp:/​/onlineprivatescan.com/2009/1/freescan.php?id=880135\nhttp:/​/traffic-converter.biz/s.php?nick=8801931355&group=880193&os=Windows\n\nIn each of the above examples, “aid,” “id,” and “nick” represent the affiliate who gets credit. These affiliates were\n[making hundreds of thousands of dollars per month.](http://voices.washingtonpost.com/securityfix/2009/03/obscene_profits_fuel_rogue_ant.html)\n\nIn the case of Downadup, however, the threat directly downloads an executable from the Traffic Converter\ndomain as http:/​/trafficconverter.biz/4vir/antispyware/loadadv.exe without any affiliate parameter; possibly\n\n\n-----\n\nrather than just an affiliate. Further, the directory “4vir” perhaps is short for “for virus,” referring to Downadup.\nLikewise, the additional directory “antispyware” just reconfirms the well-known fact that Traffic Converter is\ninvolved in misleading application downloads. As well, the file name itself was a commonly used filename by a\nprevious group known as IFrameBiz and/or IFrameCash who provided similar pay-per-install services. Whether\nthere is a connection to this previous group or the file name is just a coincidence isn’t entirely clear.\n\nSoon after trafficconverter.biz disappeared, the owners came back with a new site, trafficconverter2.biz. How­\n[ever, after only a few days of operation, they again went down; this time claiming that their payment processor](http://voices.washingtonpost.com/securityfix/2009/03/sunlight_disinfects_rogue_anti.html)\n[had blocked them and that they had no connection with Downadup. Such denial, when the finger is pointed at a](http://voices.washingtonpost.com/securityfix/2009/03/sunlight_disinfects_rogue_anti.html)\nrogue affiliate, is a common tactic used by those who are involved in pay-per-install schemes.\n\n[So, while we enjoy reading movie-plot scenarios of using Downadup to create a “Dark Google” to search for data](http://bits.blogs.nytimes.com/2009/03/19/the-conficker-worm-april-fools-joke-or-unthinkable-disaster/)\non all infected computers, if the Downadup authors stick to their original intentions, the more likely scenario\nis that the authors will attempt to recoup on their investment via the installation of misleading applications\nor other pay-per-install applications such as adware. However, considering the amount of eyes now watching\nDownadup’s every move, we also can’t underestimate the chance that the authors may veer from their original\nmotives.\n\n\n-----\n\n#### Downadup-related search indexes poisoned with fake AV sites\n\n_Originally published March 26, 2009 by John Park_\n\nWith Downadup/Conficker rising to celebrity status in the computer worm world, Symantec (along with other\ncompanies in the security industry) is hard at work, keeping our customers protected. But guess who else is hard\nat work at the moment? Yes, the authors of misleading applications. It isn’t the first time that they have latched\nonto popular news to fuel their malicious intent using search engine optimization.\n\n\nLet’s say you are curious about Con­\nficker, or you think your computer\nmight be infected with Conficker. By\nsimply searching for “Conficker C,”\npage one of the results includes a\nlink to an infected site being used to\nspread a fake antivirus program, as\nshown in figure 39.\n\nFollowing the malicious link eventual­\nly leads you to a rogue application in­\nstallation website, as shown in figure\n40. (Note that this is not a screenshot\nof Windows Explorer, but is simply a\npicture inside the Web browser.)\n\n\nFigure 39\n###### Search results for “Conficker C”\n\n\nSymantec products that include net­\nwork protection will trigger a signature\nnamed “HTTP Fake Scan Webpage”\nand block your computer from being\nable to visit this site. If you do some­\nhow manage to get to the rogue Figure 40\napplication’s installer at the Rogue installation Web site\nend of the tunnel, the file will\nbe detected (and blocked) as\n[Downloader.Misleadapp.](http://www.symantec.com/security_response/writeup.jsp?docid=2007-061114-0840-99)\n\nA few days ago, we blogged\nabout the possibility of\nDownadup using misleading ap­\nplications as its payload. Even\nthough we do not think the\nauthor of this rogue application\nis related to the author of Con­\nficker, this incident shows us\nthat the authors and affiliates\nof misleading applications don’t\nwant to miss a single opportu­\nnity to capitalize on established\nmedia attention.\n\nSome obvious words of advice:\nbe careful with the links you\nfollow. A sincere effort to keep\nabreast of the latest security\ninformation might bring about\nsome unwelcome surprises.\n\n\n-----\n\n#### W32.Downadup.C pseudo-random domain name generation\n\n_Originally published March 27, 2009 by John Park_\n\nThe pseudo-random domain name generation for the rendezvous point is a clever idea. The common way for a\nbotnet to communicate with its botmaster is usually done via a single rendezvous point. Since this rendezvous\npoint is static, whoever controls this static location owns the botnet. This poses a problem for the botmaster\nsince this rendezvous location is the weakest link of the botnet. The botmaster can lose control of the whole\nbotnet if the server at the rendezvous point is brought down, or if the IP is blacklisted. Fast flux, where the IP\naddress bound to a domain name changes rapidly, was an attempt to foil IP blacklisting, but fast flux cannot\nprotect against domain name blacklisting.\n\nThe pseudo-random domain name generation is the measure taken against domain name blacklisting, since\nblacklisting a large list of non-static domain names is impractical. With this, the current weakest link is elimi­\nnated.\n\nOne downside of having many rendezvous points is that not all of those locations are registered and are basi­\ncally up for grabs. Once the pseudo-random domain name generation algorithm and communication protocol\nis reverse-engineered (which is the case for Downadup), it is possible to steal the botnet. The Downadup (Con­\nficker) authors knew this was possible, and prepared against this weakness by using asymmetric cryptographic\nauthentication on the client. With the asymmetric cryptographic authentication, the botnet cannot be overtaken\nunless you have the correct private key.\n\nThe latest variant (.C) of Downadup has been improved in direct response to the Conficker Working Group’s\ndomain-name reservations, by increasing the number of possible daily rendezvous points from 250 to 50,000—\nthus making it practically infeasible to register all of those domain names daily.\n\nOne interesting bit of the .C variant is that the infected machine is querying back less aggressively than previous\nvariants, such as querying only once a day, not every 2 or 3 hours, and each infection is randomly querying a dif­\nferent set of 500 domains out of the 50,000 generated domains. Thus, if a botmaster with the correct private key\nregisters one domain name, that domain will only be reached by 1% of the total Downadup population directly.\nNote that 1% is an idealistic value and will actually vary due to the pseudo-random generation used, whether\nmachines are online, time of day, whether a host will reach the intended domain, etc. A possible reason for this\nless aggressive stance is that it is not easy to build a server that can handle the massive amounts of traffic from\nthree million+ infected machines, which can practically DDoS the server if not throttled on the client side.\n\nWhile 1% seems small, over time, if the botmaster registers one domain name each day, within a month a third\nof the botnet could be reached directly. The following is a simulation to show how much of the Downadup-in­\nfected machine population will be reached starting from April 1, 2009. This simulation uses a very simple model\nand assumes some ideal conditions, such as equal distributions in regard to domain generation, the time of day\nthat domains are queried, the fact infections and online hosts are not equally dispersed across time zones, etc.\nHowever, hopefully the simulation provides a view into how patience, and even just a few registered domains on\nthe part of the authors, could still yield worthwhile results. We’ve provided three variables that can be tweaked:\n\n     - Initial infection: Total number of .C infected hosts. The .C variant was spread by updating .B hosts, which\nranged around 3 million at the time the .C updates were released. However, the number of .B hosts that have\nbeen converted to .C is likely a small fraction of that.\n\n     - Domain with payload: Is the number of domains the botmaster will register each day. (The default is set to one\nper day.)\n\n     - Take Down Time: Is the time to take down the malicious domain name if detected. If the server hosting the ma­\nlicious payload was taken down within 6 hours, a quarter of the Downadup-infected population would receive\nthe payload.\n\n\n-----\n\n###### Domain reach of Downadup botnet\n[Click image to go to download and run simulation. (Requires Adobe Flash Player)](http://get.adobe.com/flashplayer/)\n\nOne more thing—if a P2P network is used to re-distribute the payload, using this 1% as the seeder nodes, the ef­\nficacy of this payload distribution method is much greater than using just the direct distribution as shown above.\n\n\n-----\n\n#### Downadup + Waledac?\n\n_Originally published April 8, 2009 by Brian Ewell_\n\nWe have come across a system infected with W32.Downadup.C that has provided some interesting information.\nWe discovered some similarly named files, 484528750.exe and 484471375.exe, which had shown up in the\n[\\Windows\\temp folder within one minute of each other. These files turned out to be W32.Waledac and a modified](http://www.symantec.com/security_response/writeup.jsp?docid=2008-122308-1429-99)\n[W32.Downadup variant, respectively.](http://www.symantec.com/security_response/writeup.jsp?docid=2008-112203-2408-99)\n\nThe W32.Downadup variant has some minor differences in functionality, but the presence of the W32.Waledac\nsample begs the question, “Is Downadup spreading Waledac?” The information we currently have may only be\ncircumstantial, but is certainly worth investigating. We’ll continue to monitor this in an effort to gather more\ndata and determine if this type of dual infection is indeed a trend.s\n\n_Editor’s Note: Further analysis helped us to determine just how W32.Waledac and a new variant of Downadup_\n_ended up on a W32.Downadup.C infected computer. It looks like a Downadup-associated attacker seeded instruc­_\n_tions to a computer in the peer-to-peer (P2P) network of W32.Downadup.C. The instructions told the computer to_\n_download W32.Waledac from a predetermined location. It then passed these instructions on to other compromised_\n_computers within the P2P network, which successively download W32.Waledac as well._\n\n_[How the Downadup variants, and other risks, are associated with each other is discussed at length in this YouTube](http://www.youtube.com/watch?v=r2h6w61-c74)_\n_[video on the Security Response channel.](http://www.youtube.com/watch?v=r2h6w61-c74)_\n\n\n-----\n\n#### W32.Downadup.E—back to basics\n\n_Originally published April 9, 2009 by Patrick Fitzgerald_\n\nOnce again we find ourselves sucked into a maelstrom of questions and uncertainty surrounding the threat\nDownadup, which is now a household name (just in case you haven’t heard of it, it’s also known as Conficker). I’m\nsure that the people working in the security industry can marvel at their loved ones finally taking an interest in\ntheir job, which for once has gone past feigned interest and polite smiles. So, what have the little scamps behind\nDownadup been up to this time?\n\nYesterday, Brian Ewell wrote about new developments regarding W32.Downadup in his blog entry entitled\nDownadup + Waledac. That blog mentioned some differences in functionality and put forward a possible asso­\nciation with Waledac. Today’s post will provide some more details about these differences.\n\nWe observed W32.Downadup downloading a binary over its peer-to-peer mechanism. The downloaded binary\nincorporates the spreading mechanisms used by W32.Downadup.A. However, this binary is a new variant and is\n[detected by Symantec products as W32.Downadup.E.](http://www.symantec.com/business/security_response/writeup.jsp?docid=2009-040823-4919-99)\n\n1. It patches “tcpip.sys” in order to increase the number of concurrent network connections available on the\n\nsystem.\n2. The exploitation of the MS08-067 vulnerability, which had not featured in W32.Downadup.C, is now included\n\nin W32.Downadup.E.\n3. This variant also uses the SMB protocol to identify the target system before attempting to exploit it. This is\n\nmost likely an attempt to increase the chances of successful exploitation.\n4. This worm has the UPnP capabilities that we saw in previous versions of Downadup. The threat exploits weak­\n\nnesses in certain routers to allow access to compromised machines from external networks.\n5. W32.Downadup.E will remove itself from the system on or after May 3, 2009.\n\n[The ultimate purpose of W32.Downadup.E is to install W32.Downadup.C on vulnerable systems. W32.](http://www.symantec.com/security_response/writeup.jsp?docid=2009-030614-5852-99)\nDownadup.C will not be removed after May 3, 2009. When W32.Downadup.C first appeared, analysis of the code\nsuggested that the authors wanted to consolidate the position of the botnet by removing the worm capabilities.\nNow it appears that the authors have been refactoring their code in favor of a more modular design. With this\nnew approach, Downadup now employs a two-phase approach. The noisy behavior associated with the spreading\nmechanisms has been separated from the relatively quiet behavior observed with W32.Downadup.C.\n\nSo, the development cycle continues, but this latest incident may have given a glimmer of insight into the\nunderlying purpose of this botnet. As mentioned earlier this threat downloads and installs W32.Waledac onto\nthe compromised system. This is yet more evidence that this is a botnet for hire and the motivations are merely\nfinancial—hardly surprising given the global economic climate.\n\nSymantec customers are protected from this latest threat, since our behavior-based heuristics picked this up\nwhen it appeared. Keep your antivirus up to date, stay patched, and stay safe. The technical write-up on this lat­\n[est Downadup variant can be found here.](http://www.symantec.com/business/security_response/writeup.jsp?docid=2009-040823-4919-99)\n\nBig thanks to Ka Chun Leung and Sean Kiernan for their analysis of these threats.\n\n\n-----\n\n#### Connecting the dots: Downadup/Conficker variants\n\n_Originally published April 21, 2009 by Ben Nahorney_\n\nFor the last couple weeks, all’s been pretty quiet on the Downadup/Conficker front. While we’re still performing\nour ‘daily patrols’ here in Security Response, watching for signs of something new, quiet moments like this give\nus a chance to reflect on what has come to pass so far.\n\nWhat we’ve discovered looking back is that there has been some confusion about the different Downadup\nvariants—what each one does and how they interrelate. It’s not surprising, given that a feature present in one\nversion is often absent in another. Some largely stand on their own, some install other risks, and others largely\nseem to exist in order to update their siblings. Try describing how each works and you’re likely to find yourself\n[reminded of an Abbott and Costello routine.](http://www.youtube.com/watch?v=uJhyXzOayis)\n\nIn order to connect the dots between Downadup variants, we’ve developed a new video that charts the family\nfrom the first variant up to today, as well as what behaviors we expect in the future. We focus on how each vari­\nant relates to its siblings, painting a clearer Downadup family portrait.\n\n###### Connecting the Dots: Downadup/Conficker Variants\nClick image to go to YouTube video.\n\nFor those of you looking for a quick-and dirty rundown of the video, here’s the timeline summarized:\n\n     - November 22, 2008: W32.Downadup is released\n\n     - December 28, 2008: W32.Downadup.B is released\n\n     - March 4, 2009: W32.Downadup.B downloads W32.Downadup.C\n\n     - April 1, 2009: W32.Downadup.C begins checking 500 of 50,000 domains\n\n     - April 7, 2009:\n\n◦◦ W32.Downadup.E is seeded into W32.Downadup.C P2P network\n\n◦◦ W32.Downadup.E updates W32.Downadup.B\n\n◦◦ W32.Downadup.C downloads other risks\n\n\n-----\n\nFind yourself struggling to keep up with this evolving threat? Try subscribing to some of our Security Response\n[feeds. You have your choice between this blog, our writeups, or even our YouTube channel. We’ll keep a lookout](http://www.symantec.com/xml/rss/srblogs.jsp)\nand let you know when something new appears.\n\nThanks to Eric Chien, Ka Chun Leung, and Sean Kiernan for their help making sense of the alphabet soup that is\nthe Downadup family.\n\n\n-----\n\n#### W32.Downadup P2P scanner script for Nmap\n\n_Originally published April 22, 2009 by the Security Intel Analysis Team_\n\nSymantec’s Security Intelligence Analysis Team has collaborated with Nmap contributor Ron Bowes to aid in the\ndevelopment of an Nmap script that is able to detect hosts infected with W32.Downadup.C by enumerating the\n[peer-to-peer (P2P) protocol used by the worm. The script has been made available to the public via nmap.org.](http://nmap.org/nsedoc/scripts/p2p-conficker.html)\n[The script has also been bundled in with the latest Nmap beta, nmap-4.85BETA8. If you are using an older ver­](http://nmap.org/download.html)\nsion of Nmap that does not contain the Nmap scripting engine, you may want to download this updated version.\n\n[If you are new to using Nmap scripts I suggest that you check out Ron’s blog, which has lots of details on how to](http://www.skullsecurity.org/blog/?p=230)\n[use the script with Nmap. Once you have located infected systems you can use the Symantec W32.Downadup](http://www.symantec.com/security_response/writeup.jsp?docid=2009-011316-0247-99)\n[Removal Tool to clean the infected system.](http://www.symantec.com/security_response/writeup.jsp?docid=2009-011316-0247-99)\n\n\n-----\n\n#### Conclusion\n\nTo date, Downadup is one of the most complex worms in the history of malicious code. With so many facets, it\nhas been an interesting threat to analyze. Figuring out its propagation techniques, unusual methods of protec­\ntion, and secure systems for updating are the sorts of challenges that lead someone into the security profession.\nBut while these factors combined may seem to account for its widespread success, the truth of the matter is the\nreal reason is much more prosaic—complacency.\n\nAs we’ve mentioned before, there’s nothing in this threat that hasn’t been seen before in one form or another.\nWhile some of the tricks take a new twist on an old theme, there are very few things that Downadup could get by\nwith in a well-secured network.\n\nThe exploitation of MS08-067 was by far the strongest propagation technique the worm used to enter a network.\nHowever, the appearance of W32.Downadup came nearly a month after the patch release. In most IT environ­\nments, this should be plenty of time to test and roll out a patch, especially one listed as “critical” in its Microsoft\nSecurity Bulletin.\n\nNor are RPC exploits something new. Some of the biggest worms, such as W32.Blaster in 2004, utilized flaws\nin this service to rack up massive infection numbers—much bigger than Downadup. We even see old stand-by\nthreats, like the Spybot family of worms, continue to leverage old, seemingly outdated RPC vulnerabilities.\n\nProperly administrating removable and network drives is equally as important. Like some candy bars, with their\nhard outside and chewy inside, Downadup often used MS08-067 to enter a network, and once inside, found suc­\ncess with these other propagation techniques. All it takes is one vulnerable computer exploited to gain access to\nthis soft, chewy intranet.\n\nThe key element in protecting your computer or network from such exploitative threats is proactive patch test­\ning and implementation. The disabling of AutoPlay and enforcing strong network passwords for shares provide\nthe final one-two punches that render a threat like Downadup inert. And as a safety precaution, block network\nperimeter access to any ports used by the threat—in this case ports 139 and 445. As is the case with all threats\nin today’s landscape, a well-managed network is a safer network.\n\n\n-----\n\n#### Appendix A: Comparison of variant features\n\nThere’s a lot of variety when it comes to the members of the Downadup family of worms. One feature present in\na variant is often absent in another. Some largely stand on their own, some install other risks, and others seem\nto exist solely to update their siblings. With such a heterogeneous mix of behaviors in mind, we’ve created the\nfollowing table that outlines the various features and which variants they apply to.\n\nTable 2\n###### Comparison of features\n W32.Downadup W32.Downadup.B W32.Downadup.C W32.Downadup.E\n\nUses MS08-067* X X X\n\nUses Geo-IP data\nto determine X X\nlanguage*\n\nGenerates a daily\nlist of domains* X X X\n\nSmart network\nscanning X\n\nBruteforces SMB\npasswords X\n\nUPnP router passthrough X X\n\nSpreads using\nAutoPlay X\n\nPeer-to-peer\nupdates* X X\n\nEnds securityrelated processes X\nand services\n\nDeletes itself after\na chosen date X\n\nHas downloaded\nother risks X\n\n      - Designates a difference between variants on how the feature is used. Differences detailed below.\n\n##### Spreads using MS08-067\n\nThe threat takes advantage of the Microsoft Windows Server Service RPC Handling Remote Code Execution\nVulnerability to spread to unpatched computers. This vulnerability was discovered and patched in October 2008.\nHowever, many computer users and administrators were slow to apply the patch, allowing the worm to effective­\nly exploit this vulnerability over the next few months.\n\nW32.Downadup.E also uses MS08-067 to spread, but in a different way. When this variant attempts to infect a\ncomputer that already has W32.Downadup.B on it, the .B variant will reply back, declaring its presence and ask­\ning for updated files. W32.Downadup.E will then send back a copy of itself.\n\n##### Uses Geo-IP data to determine language\n\nThe threat gathers the computer’s IP address and then uses a table of IPs associated to particular geographic lo­\ncations in order to determine the country the computer is located in, and then ascertain the associated language\nbased on this location.\n\nW32.Downadup performed this function by downloading a Geo-IP file from a predetermined location. How­\never, when this file was removed from the server, it was unable to determine the location and language. W32.\nDownadup B addressed this issue by embedding the Geo-IP data within the threat\n\n|Table 2|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|Comparison of features|||||\n||W32.Downadup|W32.Downadup.B|W32.Downadup.C|W32.Downadup.E|\n|Uses MS08-067*|X|X||X|\n|Uses Geo-IP data to determine language*|X|X|||\n|Generates a daily list of domains*|X|X|X||\n|Smart network scanning||X|||\n|Bruteforces SMB passwords||X|||\n|UPnP router pass- through||X||X|\n|Spreads using AutoPlay||X|||\n|Peer-to-peer updates*||X|X||\n|Ends security- related processes and services|||X||\n|Deletes itself after a chosen date||||X|\n|Has downloaded other risks|||X||\n|* Designates a difference between variants on how the feature is used. Differences detailed below.|||||\n\n\n-----\n\n##### Generates a daily list of domains\n\nThe threat generates a list of domain names each day and checks these domains for files to download. The\nnumber of sites checked daily depends on the version. W32.Downadup and W32.Downadup.B check a list of 250\ndomains each day. In the case of W32.Downadup.C, it generates a list of 50,000 domains daily and checks 500 of\nthem.\n\n##### Smart network scanning\n\nScans the network for hosts in such a way that its traffic doesn’t stand out. It does this by varying the address\nranges it scans for vulnerable hosts and the time between each attempt, based on the speed of the average\nbandwidth available to the computer.\n\n##### Bruteforces SMB passwords\n\nThe threat scans the local network for open network shares and attempts to gain access to them by trying a list\nof predetermined passwords.\n\n##### UPnP router pass-through\n\nThe threat contains a feature to allow it to get past routers or other gateway devices. It uses the Universal\nPlug-and-Play (UPnP) protocol to determine if it is behind a gateway. If so, it attempts to obtain the external IP\naddress of the gateway device, then sets up port forwarding rules on the device.\n\n##### Spreads using AutoPlay\n\nThe threat copies itself to removable drives in an attempt to spread through these devices. When an infected re­\nmovable device is inserted into a computer, the AutoPlay dialog created by the threat makes it appear as though\nit’s a folder that the user would be opening.\n\n##### Peer-to-peer updates\n\nThe threat has peer-to-peer capabilities. This allows an attacker to upload files to one Downadup-infected com­\nputer, which can then spread them to other computers within the P2P network.\n\nWhile both W32.Downadup.B and W32.Downadup.C contain similar functionality, the P2P mechanism in the .C\nvariant is more robust. It contains enhancements to the P2P bootstrapping techniques, the digital signing of files\ntransferred, and a custom P2P protocol not present in previous versions.\n\n##### Ends security-related processes and services\n\nThe threat ends processes and services related to security software. It also prevents a compromised computer\nfrom accessing security-related Web sites, such as www.symantec.com.\n\n##### Deletes itself after a chosen date\n\nThe threat removes itself from compromised computers after a certain date. In the case of W32.Downadup.E,\nthis date is May 3, 2009.\n\n##### Has downloaded other risks\n\nThe threat has downloaded other threats on a Downadup-infected computer. So far this includes copies of W32.\nWaledac and SpywareProtect2009.\n\n\n-----\n\n#### Appendix B: How do I know if I have Downadup?\n\n_Written by Conor Murray_\n\nUsing the command line and some tools freely available for download from the Internet, you can easily determine\nwhether it is infected with Downadup. When present on the computer, and actively running, Downadup gener­\nates a lot of network traffic. While it does sleep for some time periods, by and large it will be engaged in contact­\ning other computers over the network and Internet.\n\nDownadup tends to manifest itself as a hidden randomly named .dll file on the computer. The most common\nlocation for it is the C:\\Windows\\System32 folder, but it could also exist in any of the following locations:\n\n     - %ProgramFiles%\\Internet Explorer\\[RANDOM FILE NAME].dll\n\n     - %ProgramFiles%\\Movie Maker\\[RANDOM FILE NAME].dll\n\n     - %Temp%\\[RANDOM FILE NAME].dll\n\n     - C:\\Documents and Settings\\All Users\\Application Data \\[RANDOM FILE NAME].dll\n\n##### The command line is your friend\n\nThe first step to take in determining whether a computer is infected with Downadup is to load up a Command\nPrompt. Click Start and then Run..., type cmd, and then press Enter.\n\n\nAt the command prompt simply type the\nfollowing:\n```\ndir /S *.dll /ash\n\n```\nThis will identify all DLLs on the computer\nthat have attributes set to A (archive), S\n(system), and H (hidden).\n\nNotice the results of our dir command in\nFigure 41. We have the randomly named\n.dll file in two locations:\n\n- C:\\Program Files\\Movie Maker\\sqgwl.dll\n\n- C:\\Windows\\System32\\sqgwl.dll\n\n\nFigure 41\n###### Listing of possible Downadup .dll files\n\n\nNotice that the DLL has the same name\nin each folder, yet we mentioned it was\nrandomly named. In actual fact the threat\nhas code for naming the DLL. This code\nuses your computer name as one of the\nfactors in creating the name. The particu­\nlar sample used will always be called sqgwl.dll on our test computer because it always has the same computer\nname.\n\nNow we are pretty sure that we have this threat on the computer. However this is not necessarily enough. It is\nlikely there are various software packages out there that also have hidden DLLs of this nature, so you do not\nwant to go scrambling to delete these .dll files just yet. You are not able to anyway because of the special file at­\ntributes it sets.\n\nA further check to carry out is to determine the attributes and access control list (ACL) of the DLLs. You can use\nthe attrib and cacls commands to do this:\n```\n• Attrib [LOCATION OF .DLL FILE]\n\n\n```\n(e.g.: attrib C:\\Windows\\System32\\sqgwl.dll)\n```\n• Cacls [LOCATION OF .DLL FILE]\n\n\n```\n(e.g: cacls C:\\Windows\\System32\\sqgwl.dll)\n\n\n-----\n\nFigure 42 shows the results of the attrib and cacls command.\n\n\nSo what do we have here?\nThe attrib command returned\nback that the .dll file in\nquestion had the following\nattributes set: A, S, H, and R\n(read-only). The result from\nthe cacls command is inter­\nesting in that we see that the\nACL for the file is set to Every­\none: (special access:). It looks\nlike we do not have the access\nrights to delete or move the\nfile. As a comparison the fol­\nlowing screenshot shows the\nACL for a text file that we, as\nan administrator, created on\nthe computer. Notice that the\nAdministrator ACL is set to F\n(full access) as is the System\nACL. (Note: The administrator\naccount is called admin1.)\n\n\nFigure 42\n###### Attrib and cacls commands\n\n\nFigure 43\n###### Attrib and cacls commands\n\n\nSo to summarize this section:\n\n- We used the dir command to search for any\n.dll files on the computer that had attributes set\nto ASH.\n\n- We also checked these attributes using the\nattrib command.\n\n\n\n                                           - Using the cacls command we checked the\nAccess Control List for any .dll files found with\nthe dir command. If these DLLs had “abnormal”\nACLs, such as Everyone: (special access:), then\nit would heighten our suspicion levels even\nfurther.\n\n##### Use Process Explorer\n\nIf the threat is actively running then the DLL will be injected into a legitimate process on our computer. This\nlegitimate process is svchost.exe.\n\nProcess Explorer is a free tool from Mark Russinovich that shows you information about which handles and DLLs\nprocesses have been opened or loaded. We can use this tool to determine whether the DLL has injected itself\ninto any processes that are running on our computer.\n\nIt’s worth noting that Process Explorer is usually called procexp.exe on the computer. Certain versions of\nDownadup actually have code to check whether the user is trying to load procexp.exe and will prevent it from do­\ning so. A simple trick is to rename procexp.exe to something else. I called it poc.exe\n\nOnce process explorer is loaded, press Ctrl+F to load up the Process Explorer Search dialog box. Enter the name\nof the .dll file into the Search box. In my case it is sqgwl.dll.\n\nNotice that in Figure 44 we only typed the first three letters of the .dll file name into the Search box. The results\nshow that a Process, svchost.exe has sqgwl.dll injected into it.\n\n\n-----\n\nRecall that although we have two\nsqgwl.dlls on our computer, only one is\nactually active. It appears that the one\nlocated in the C:\\Program Files\\Movie\nMaker folder is actively running on the\ncomputer.\n\n##### Observe network traffic\n\nIn this section we will observe ex­\namples of the traffic generated by\nDownadup. You can simply use your fa­\nvorite packet capturing tool to observe\nnetwork traffic. In this case we’re\nusing Wireshark, and it’s predecessor,\nEthereal.\n\nWireshark is usually called wireshark.\nexe on the computer. As is the case\nwith Process Explorer, certain versions\nof Downadup have code to check if a\nuser is trying to execute wireshark.exe\nand prevent it from loading. As before,\nrename wireshark.exe to something\nelse.\n\n\nFigure 44\n###### Downadup found using Process Explorer\n\n\nAs previously mentioned, when active,\nDownadup will generate its share of\nnetwork traffic. It will sleep for certain time periods, but by and large it will be engaged in contacting other com­\nputers on the network and Internet. Different variants of Downadup will have different traffic patterns.\n\nW32.Downadup.B generates a lot of ARP requests as it tries to locate computers on the network it is directly\nattached to. It also makes DNS queries to what appear to be randomly named Web sites. (They are not randomly\nnamed however.)\n\nFigure 45 shows a computer (IP address 192.168.2.3) infected with W32.Downadup.B querying for any other\ncomputers on the local 192.168.2.X network.\n\nFigure 45\n###### ARP requests captured by Ethereal\n\n\n-----\n\nFigure 46 shows the same computer making DNS requests for the “random” Web sites.\n\nFigure 46\n###### DNS requests captured by Ethereal\n\nW32.Downadup.C generates a lot of UDP traffic as it communicates with other computers on its peer-to-peer\nnetwork. Warning signs on a network monitoring system would be large volumes of UDP traffic originating from\ncertain computers on your network. Figure 47 shows a computer (193.95.X.X) using UDP to communicate with\nother computers on the Internet.\n\nFigure 47\n###### DNS requests captured by Ethereal\n\n##### Use gmer\n\nGmer is a useful rootkit detection tool. Simply load it up and allow it to scan for rootkit activity.\n\nGmer is usually called gmer.exe on the computer. Once again, certain versions of Downadup check whether the\n\n\n-----\n\nWhen installed, Downadup creates a hidden service. Notice there is a very evident red highlighting for an entry in\nfigure 48. It appears that we have a hidden service called rexyv and it looks like it is utilizing svchost.exe.\n\nFigure 48\n###### DNS requests captured by Ethereal\n\n##### Nmap appendum\n\nAnother method for detecting the presence of W32.Downadup.C is through the use of Nmap—a security as­\nsessment tool that provides port scanning capabilities across a network. The latest version has a bundled script\ncalled p2p-conficker.nse that can be used to scan for W32.Downadup.C-infected computers. The script works by\nchecking the activity associated with the peer-to-peer ports that this particular version uses to communicate.\n\nIt’s worth noting that if you try to use Nmap to scan your own, local machine you will get the following message:\n```\n   Skipping SYN Stealth Scan against localhost (127.0.0.1) because Windows does not\n   support scanning your own machine (localhost) this way.\n\n```\n\nThis is because the\nscript is meant to\nbe used to check\nother systems on the\nnetwork, rather than\nthe computer you are\nusing.\n\nIn figure 49, a com­\nputer that is infected\nwith W32.Downadup.C\nhas an IP address\nof 192.168.2.3. The\nscreenshot shows the\nscript-enabled Nmap\nscan running from the\ncommand line. The re­\nsults show that Nmap\nthinks the computer\nat 192.168.2.3 is likely\ninfected.\n\n\nFigure 49\n###### DNS requests captured by Ethereal\n\n\n-----\n\n##### Conclusion\n\nAs we have observed, using the command line and some simple command line tools we were able to ascertain\nwhether we have Downadup present on our computer. Unfortunately, due to the file attributes and ACLs set on\nthe dll, it is not possible to delete the file using a simple delete command.\n\n[So if you happen to be unfortunate enough to get infected with Downadup, then our advice is to get the fixtool](http://www.symantec.com/security_response/writeup.jsp?docid=2009-011316-0247-99)\n[from Symantec. After cleaning the computer, ensure AutoProtect is enabled and that your antivirus definitions](http://www.symantec.com/security_response/writeup.jsp?docid=2009-011316-0247-99)\nare kept up-to-date.\n\n\n-----\n\nAny technical information that is made available by Symantec Corporation is the copyrighted work of Symantec Corporation and is owned by Symantec\nCorporation.\n\nNO WARRANTY . The technical information is being delivered to you as is and Symantec Corporation makes no warranty as to its accuracy or use. Any use of the\ntechnical documentation or the information contained herein is at the risk of the user. Documentation may include technical or other inaccuracies or typographical\nerrors. Symantec reserves the right to make changes without prior notice.\n\n**About Symantec**\nSymantec is a global leader in\nproviding security, storage and\nsystems management solutions to\n\nhelp businesses and consumers\nsecure and manage their information.\n\n\ntechnical documentation or the information contained herein is at the risk of the user. Documentation may include technical or other inaccuracies or typographical\nerrors. Symantec reserves the right to make changes without prior notice.\n\n**About Symantec**\nSymantec is a global leader in\nproviding security, storage and\nsystems management solutions to\n\n\n**About the editor**\nBen Nahorney is a\nSenior Information Developer\nin Symantec Security Response.\n\nFor specific country offices and contact num­\nbers, please visit our Web site. For product\ninformation in the U.S., call\ntoll-free 1 (800) 745 6054.\n\n\nSymantec Corporation\n\nWorld Headquarters\n20330 Stevens Creek Blvd.\n\nCupertino, CA 95014 USA\n\n+1 (408) 517 8000\n\n1 (800) 721 3934\nwww.symantec.com\n\n\nHeadquartered in Cupertino, Calif.,\n\nSymantec has operations in more\nthan 40 countries. More information\n\nis available at www.symantec.com.\n\nCopyright © 2009 Symantec Corporation. All rights reserved.\nSymantec and the Symantec logo are trademarks or registered\n\ntrademarks of Symantec Corporation or its affiliates in the\nU.S. and other countries. Other names may be trademarks of\n\ntheir respective owners.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/ICS SCADA/Other/The Downadup Codex v2.0.pdf"
    ],
    "report_names": [
        "The Downadup Codex v2.0.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "3fad11c6-4336-4b28-a606-f510eca5452e",
            "created_at": "2022-10-25T16:07:24.346573Z",
            "updated_at": "2025-03-27T02:02:10.183211Z",
            "deleted_at": null,
            "main_name": "Turbine Panda",
            "aliases": [
                "APT 26",
                "Black Vine",
                "Bronze Express",
                "Group 13",
                "JerseyMikes",
                "KungFu Kittens",
                "PinkPanther",
                "Shell Crew",
                "Turbine Panda",
                "WebMasters"
            ],
            "source_name": "ETDA:Turbine Panda",
            "tools": [
                "Agent.dhwf",
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "FF-RAT",
                "FormerFirstRAT",
                "Hurix",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mivast",
                "PlugX",
                "RbDoor",
                "RedDelta",
                "RibDoor",
                "Sakula",
                "Sakula RAT",
                "Sakurel",
                "Sogu",
                "StreamEx",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Winnti",
                "Xamtrav",
                "cobeacon",
                "ffrat"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536051,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1243964619,
    "ts_modification_date": 1243964730,
    "files": {
        "pdf": "https://archive.orkl.eu/69871900967d982185c2e254c607048011710ee6.pdf",
        "text": "https://archive.orkl.eu/69871900967d982185c2e254c607048011710ee6.txt",
        "img": "https://archive.orkl.eu/69871900967d982185c2e254c607048011710ee6.jpg"
    }
}