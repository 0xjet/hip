{
    "id": "5e93cded-375b-4718-9289-74b787fbf9e2",
    "created_at": "2023-01-12T15:00:20.434006Z",
    "updated_at": "2025-03-27T02:06:00.878118Z",
    "deleted_at": null,
    "sha1_hash": "4be94c04bc2631af889b1dc58d0ce2c164d2e917",
    "title": "2014-12-15 - Banatrix – an indepth look",
    "authors": "",
    "file_creation_date": "2022-05-27T22:31:30Z",
    "file_modification_date": "2022-05-27T22:31:30Z",
    "file_size": 142519,
    "plain_text": "# Banatrix – an indepth look\n\n**cert.pl/en/news/single/banatrix-an-indepth-look/**\n\nOf all of the Polish malware families that we have seen last year,\nBanatrix seems to be the most technologically advanced one. This\nmalware was used to replace the bank account number in the browser\nmemory, however its implementation allowed an attacker to execute any\narbitrary code on the victim’s machine. This was used to extract\npasswords saved in the Mozilla Firefox browser. On this article we\n[discuss the Banatrix C&C infrastructure and its use of TOR network both](https://www.torproject.org/)\nto hide the attacker’s identity and to make the botnet takedown a\nchallenge.\n\n## What Banatrix does to the infected machine?\n\n[As we have described in our previous article Banatrix was used to replace the victim’s bank](http://www.cert.pl/news/8999)\naccount number in the browser memory. However, its architecture allows for a lot more. The\ngeneral concept behind this malware is presented in the picture below.\n\n**First stage: unpacking and persistence**\n\nUpon the first run malware drops two files: xor encrypted DLL and an exe file. This files are\ncreated in the\n\n<span class=\"text\">%AppData%</span>\n\ndirectory (which is\n\n<span class=\"text\">C:\\Users\\All Users</span>\n\non Windows XP and\n\n\n-----\n\n<span class= text >C:\\ProgramData</span>\n\non Windows Vista and newer). Encrypted DLL is saved either as\n\n<span class=\"text\">.sys</span>\n\nor as\n\n<span class=\"text\">.windows.sys</span>\n\n. Exe file (named\n\n<span class=\"text\">wms.exe</span>\n\nor\n\n<span class=\"text\">wmc.exe</span>\n\n) is added to the system as a Scheduled Task. The library file is decrypted and loaded into\nthe process memory. It is then encrypted again, using a different, random key and saved with\nthat key to the same file. This results in a different file every time the malware runs.\n\n**Second stage: network communication**\n\nThe library, decrypted and loaded to the process memory, is responsible for communication\nwith the C&C proxy. This includes downloading additional malicious code that is run on the\ninfected machine. The first step in this communication is sending the RSA-encrypted\nmachine configuration details, like the computer and user name, OS version or language.\nThe new version of Banatrix uses a TOR proxy server to communicate with the real C&C.\nThis is done using a custom proxy protocol. The malware contacts the hardcoded domain in\none of the several TLDs, where the attacker set up a TOR proxy server. It then sends the\n\n<span class=\"text\">.onion</span>\n\ndomain (along with some other data) to this proxy server and the server connects with that\ndomain.\n\nThis real C&C then sends a xor-encrypted library, which is run on the infected machine. This\nlibrary is again loaded into the process memory and the exported function called\n\n<span class=\"text\">init</span>\n\nis run. This, of course, allows the attacker to execute any code on the infected machine. This\nis also how the updates are being delivered.\n\n\n-----\n\nThe newest Banatrix version contains a DGA – algorithm responsible for creation of the\ndomain names. However, it is somewhat different from the DGA in the other malware\nfamilies. Banatrix has a list of domains in 25 different TLDs. Every one of these domains is\nthen used to create 4 different domain names and perform DNS queries on each one.\nHowever only the fourth (last) domain will be used as a proxy C&C server – all others are\nsimply there to confuse the researchers. Part of the decompiled DGA is presented in the\nscreenshot below.\n\n**Third stage: code execution**\n\nThe downloaded library, as we have mentioned previously, iterates over all of the processes\nin the search of the browser process. It then searches the process memory for the bank\naccount number and replaces it with the hardcoded one. However, we have also observed\nthat some of the victims received another library – one that had a function to get the user\npasswords saved in the Mozilla Firefox browser and send them to the dropzone server. This\nproves that the malware architecture allows the flexibility to execute any arbitrary code.\n\n## Summary\n\nBanatrix remains a serious threat for the Polish Internet users. This claim is backed up by\nour sinkhole data – a little over 5,000 different IPs are trying to connect with the C&C server\nevery day. It seems that the malware is also under a heavy development and new features\nare added every couple of weeks.\n\nThe SHA256 fingerprint of the analyzed sample is:\n[7c4d4e98601b2ae11c4a27299ded2a15e635b317ef32f48f683da016ca77c1c9. It’s has a](https://www.virustotal.com/en/file/7c4d4e98601b2ae11c4a27299ded2a15e635b317ef32f48f683da016ca77c1c9/analysis/)\npretty high detection rate on VirusTotal, as you can see below.\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-12-15 - Banatrix – an indepth look.pdf"
    ],
    "report_names": [
        "2014-12-15 - Banatrix – an indepth look.pdf"
    ],
    "threat_actors": [
        {
            "id": "30ed778d-15b3-484e-a90b-e1e05b36a42f",
            "created_at": "2023-01-06T13:46:38.290626Z",
            "updated_at": "2025-03-27T02:00:02.795711Z",
            "deleted_at": null,
            "main_name": "APT30",
            "aliases": [
                "G0013"
            ],
            "source_name": "MISPGALAXY:APT30",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9f1ce7e3-77cd-4af0-bedb-1643f55c9baf",
            "created_at": "2022-10-25T15:50:23.31611Z",
            "updated_at": "2025-03-27T02:00:55.439974Z",
            "deleted_at": null,
            "main_name": "Naikon",
            "aliases": [
                "Naikon"
            ],
            "source_name": "MITRE:Naikon",
            "tools": [
                "ftp",
                "netsh",
                "WinMM",
                "Systeminfo",
                "RainyDay",
                "RARSTONE",
                "HDoor",
                "Sys10",
                "SslMM",
                "PsExec",
                "Tasklist",
                "Aria-body"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b69484be-98d1-49e6-aed1-a28dbf65176a",
            "created_at": "2022-10-25T16:07:23.886782Z",
            "updated_at": "2025-03-27T02:02:10.014032Z",
            "deleted_at": null,
            "main_name": "Naikon",
            "aliases": [
                "Hellsing",
                "ITG06",
                "Lotus Panda",
                "Naikon",
                "Operation CameraShy"
            ],
            "source_name": "ETDA:Naikon",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "AR",
                "ARL",
                "Agent.dhwf",
                "Aria-body",
                "Aria-body loader",
                "Asset Reconnaissance Lighthouse",
                "BackBend",
                "Creamsicle",
                "Custom HDoor",
                "Destroy RAT",
                "DestroyRAT",
                "Flashflood",
                "FoundCore",
                "Gemcutter",
                "HDoor",
                "JadeRAT",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "LadonGo",
                "Lecna",
                "Living off the Land",
                "NBTscan",
                "Naikon",
                "NetEagle",
                "Neteagle_Scout",
                "NewCore RAT",
                "Orangeade",
                "PlugX",
                "Quarks PwDump",
                "RARSTONE",
                "RainyDay",
                "RedDelta",
                "RoyalRoad",
                "Sacto",
                "Sandboxie",
                "ScoutEagle",
                "Shipshape",
                "Sisfader",
                "Sisfader RAT",
                "Sogu",
                "SslMM",
                "Sys10",
                "TIGERPLUG",
                "TVT",
                "TeamViewer",
                "Thoper",
                "WinMM",
                "Xamtrav",
                "XsFunction",
                "ZRLnk",
                "nbtscan",
                "nokian",
                "norton",
                "xsControl",
                "xsPlus"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535620,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1653690690,
    "ts_modification_date": 1653690690,
    "files": {
        "pdf": "https://archive.orkl.eu/4be94c04bc2631af889b1dc58d0ce2c164d2e917.pdf",
        "text": "https://archive.orkl.eu/4be94c04bc2631af889b1dc58d0ce2c164d2e917.txt",
        "img": "https://archive.orkl.eu/4be94c04bc2631af889b1dc58d0ce2c164d2e917.jpg"
    }
}