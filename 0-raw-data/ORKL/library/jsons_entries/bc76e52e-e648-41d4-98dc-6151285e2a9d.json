{
    "id": "bc76e52e-e648-41d4-98dc-6151285e2a9d",
    "created_at": "2023-01-12T14:59:40.594099Z",
    "updated_at": "2025-03-27T02:06:09.597782Z",
    "deleted_at": null,
    "sha1_hash": "bda3e7ae73c9b236338662f0ac1a9574bca3a8c9",
    "title": "2015-02-17 - BE2 extraordinary plugins, Siemens targeting, dev fails",
    "authors": "",
    "file_creation_date": "2022-05-27T21:17:48Z",
    "file_modification_date": "2022-05-27T21:17:48Z",
    "file_size": 682327,
    "plain_text": "# BE2 extraordinary plugins, Siemens targeting, dev fails\n\n**[securelist.com/be2-extraordinary-plugins-siemens-targeting-dev-fails/68838/](https://securelist.com/be2-extraordinary-plugins-siemens-targeting-dev-fails/68838/)**\n\nOur [November post introducing our BlackEnergy2 (BE2) research described new findings on](https://securelist.com/be2-custom-plugins-router-abuse-and-target-profiles/67353/)\nthe group’s activity. We presented both details on their plugins and significant findings about\nsome of their targets and victims. In this post, let’s examine several additional plugins more\nclosely, targeting details around BE2 Siemens exploitation, and some of their unusual coding\nfailures.\n\nWe previously introduced an unknown set of plugins and functionality for the linux platform,\nsix in total. For the windows platform, we collected 17 plugins. The last post noted the\ndifficulty in collecting on this group. We finish descriptions for our set in this post.\n\nbs\n\ncert\n\ndstr\n\nfs\n\ngrc\n\njn\n\nkl\n\nprx\n\nps\n\nrd\n\nscan\n\n\n-----\n\nsn\nss\ntv\nupd\nusb\nvsnet\n\nWe also collected plugins for the MIPS/ARM architectures, as noted in the previous BE2\npost.\n\nweap\nps\nnm\nsnif\nhook\nuper\n\n## Extraordinary Functionality\n\nLet’s first examine some of the newest and most surprising Windows plugins. It’s interesting\nthat all of these plugins use a custom “FindByHash” function to evade detection schemes\nand to slow analysis…\n\n### The “Destroy” plugin, dstr\n\n**Name** dstr.dll\n\n**MD5** 8a0a9166cd1bc665d965575d32dfa972\n\n**Type** Win32 DLL\n\n**Size** 26,474 bytes\n\n**CompiledOn** 2014.06.17 08:42:43\n\nThe most troubling plugin in the list is the “dstr” plugin. It is a Windows-only plugin. It was\nused to overwrite data by the BE2 actor, destroying data stored on hard drives by overwriting\nfile contents. While its use may be intended to cover their tracks, it is heavy handed to use\nthis type of tool to cover one’s tracks in a network. Most likely it is a tool of sabotage, much\nlike the Destover wiper seen on Sony Pictures Entertainment’s networks. However, it’s\ninteresting that the BE2 developers created wiper code different from the Destover and\nShamoon wiper malware we saw in the Saudi Aramco and SPE attacks. Instead of re-using\nthe commercial EldoS RawDisk drivers in their malware, the BE2 developers wrote their own\nlow-level disk and file destruction routines. It’s also a much more chilling deployment of\nwipers – instead of a poorly defended media studio it was delivered to ICS environments\n\n\n-----\n\nIn order to overwrite stored data on all Windows versions, the dstr plugin supports both usermode and kernel-mode wiper functionality, which is somewhat surprising. The component\nmaintains both an embedded win32 library and win64 driver modules for its kernel mode\nfunctionality. They are rc4 encrypted.\n\n**User-mode functionality**\n\nThe plugin identifies device id’s for the system’s HDD and creates a handle to the system’s\nphysical drive, with “GENERIC_READ or GENERIC_WRITE” access. Several calls to\nDeviceIoControl collects data on the physical location of the volume, and the size and\nproperties of this disk. It uses DeviceIoControl with the\nIOCTL_DISK_GET_DRIVE_GEOMETRY control code in order to retrieve Bytes Per Sector\nvalue. dstr then wipes out all open handles to the disk by dismounting it with the\nFSCTL_DISMOUNT_VOLUME control code.\n\nThis routine prepares the system for overwrite and ensures no conflicts for plugin file I/O.\nThen it makes multiple WriteFile calls to write a zeroed out buffer to disk.\n\n\n-----\n\nThe dstr plugin maintains code for unlocking and deleting the BE2 driver from disk, furthering\nthe group’s goal of keeping their traces hidden from researchers. And notice the FindByHash\nset of calls above, this sfc_os call disables Windows File Protection for a minute while an\napplication can delete or modify the locked file. So this plugin and its call can proceed and\ndelete the driver.\n\nThe plugin looks over all the services in the %system32%\\drivers folder and checks the write\npermission. If access is provided, it unlocks the file, rewrites the embedded driver under the\nexisting driver name and launches it.\n\n**Drivers and kernel mode functionality**\n\nDecrypted 32-bit driver\n\n**Name** driver.sys\n\n**MD5** c4426555b1f04ea7f2e71cf18b0e5b6c\n\n**Type** Win32 driver\n\n**Size** 5,120 bytes\n\n**CompiledOn** 2014.06.10 13:12:22 GMT\n\nDecrypted 64-bit driver\n\n\n-----\n\n**Name** driver.sys\n\n**MD5** 2cde6f8423e5c01da27316a9d1fe8510\n\n**Type** Win64 driver\n\n**Size** 9,136 bytes\n\n**CompiledOn** 2014.06.10 13:12:04 GMT\n\nThe 32-bit and 64-bit drivers are identical and compiled from the same source code. These\nsmall Windows drivers are supposed to support FAT32 and NTFS file systems, and contain\ntwo large code implementation mistakes. In spite of these flaws, it is clear that the author’s\ngoal was to parse a file system and then write random data across files.\n\n### Extraordinary Fails\n\nThese coding fails are unique to this dstr plugin, suggesting a development team effort\nbehind the plugin set code.\n\n**Fail #1: The authors reversed the routines for FAT32 and NTFS data wiping when checking**\nthe presence of the “FAT32” string in the first 1024-bytes of the system drive.\n\n**Fail #2: In the FAT32 routine the Root Directory Sector Number is calculated and is dealt as**\nthe absolute offset inside the file rather than next multiplying this number by the bytes per\nsector\n\nIn comparison, there is no such mistake in the NTFS routine and the calculation of the MFT\noffset is implemented properly:\n\n\n-----\n\n### Goal – File Content Corruption\n\nApart from that, it is interesting that the authors implement NTFS wiping in an unusual way\nwith strange logic compared to FAT32 ‘straightforward’ wiping. The plugin accomplishes\nchecks for FILE records and at first skips them. Then under certain conditions it rewrites nonFILE record sectors with random buffer which probably corresponds to some file contents\nand proceeds looping. Then it ends up rewriting the first sectors of MFT and MFT mirror.\n\n### grc, plus.google.com replacement communications plugin\n\n**Name** grc.dll\n\n**MD5** ee735c244a22b4308ea5d36afee026ab\n\n**Type** Win32 DLL\n\n**Size** 15,873 bytes\n\n**CompiledOn** 2013.09.25 07:19:31\n\n\n-----\n\nThis plugin creates a backup communications channel to yet another legitimate service. Most\nlikely this backup channel is used to cloak outbound communications on monitored networks.\nWe have seen APT using everything from Twitter to Google Docs to hide communications in\nplain sight, and this time the abused service is Google Plus.\n\nThis plugin implements the standard Windows HTTP services to interact with Google Plus\nover https, seeking to find a png file.\n\nThe plugin is provided with a specific Google Plus id to connect with, and uses the OLE\nstream Windows structured storage API along with the GDI+ bitmap functions to handle and\nparse this png file. This png file content is actually encrypted data containing the new BE\nconfiguration file just as it was obtained using ‘normal’ C&C communication. It is encrypted\nwith RC4, just like the embedded dstr drivers. But unlike to the ‘typical’ RC4 BE decryption\nscheme that uses RC4 once, here it uses RC4 three times: once with hardcoded key found\nin the grc binary, the second time using the key extracted from the previous decrypted result,\nand the third time using the ‘id’ machine’s identifier that is normally served as the encryption\nkey during the C&C communication.\n\n### Universal serial bus data collection plugin, usb\n\n**Name** usb.dll\n\n**MD5** 0d4de21a2140f0ca3670e406c4a3b6a9\n\n**Type** Win32 DLL\n\n**Size** 34,816 bytes\n\n**CompiledOn** 2014.03.21 07:02:48\n\n\n-----\n\nThe usb plugin collects all available information on connected USB drives, and writes out all\nof these details to a text file, packs it, provides to the main BlackEnergy code, which\ncommunicates to a c2.\n\nIt uses multiple api calls to collect information on multiple types of connected usb storage\ndevices. It enumerates all usb storage devices connected to the system and retrieves data\nfrom all, including SCSI mass storage devices. And, most interestingly, it may be the first\nimplementation of BadUSB-related techniques in APT re-purposed COTS malware that we\nhave seen in the wild.\n\nThe code queries scsi devices directly and sends them two types of SCSI commands. The\nfirst command with the opcode 0x1A which corresponds to MODE SENSE may result just in\nthe logging of the failed call (‘SendSCSICommand return false’ message).\n\nThe second type of SCSI command remains mysterious. It uses undefined opcode 0xf0 and\nthere is no direct evidence of its purpose as it is stated to be vendor specific. This mysterious\nopcode is referenced around the same time frame of the plugin development in BadUSB\noffensive research\n[http://algorithmics.bu.edu/twiki/bin/view/EC521/SectionA1/Group5FinalReport. Here, it is](http://algorithmics.bu.edu/twiki/bin/view/EC521/SectionA1/Group5FinalReport)\nnoticed in the USB traffic generated by an SMI controller tool. To be specific, there are two\ncalls with the opcode 0xf0 in the code, each passed its own parameters. One of the\nparameters, 0x2A, is mentioned in the paper to return the string containing the firmware\nversion, NAND flash ID, and controller part number. But this returned information is not\nlogged anywhere.\n\n\n-----\n\nAlso the code loops to retrieve detailed physical data about every attached storage device:\n\nnumber of cylinders\nmedia type (floppy, fixed hard drive, removable media, etc)\nnumber of tracks per cylinder\nsectors per track\nnumber of bytes per sector\nphysical disk size in bytes\nDevice Instance ID\n\n### Motherboard and firmware data collection plugin, bios\n\n**Name** bs.dll\n\n**MD5** 4747376b00a5dd2a787ba4e926f901f4\n\n**Type** Win32 DLL\n\n**Size** 210,432 bytes\n\n**CompiledOn** 2014.07.29 00:40:53\n\nThe bios plugin gathers low level host system information:\n\nBIOS\nmotherboard\nprocessor\nOS\n\nIt uses several techniques to gather this information:\n\nWMI\nCPUID\nwin32 api\n\n\n-----\n\nAs a Windows Management Instrumentation (WMI) client application, it initializes COM and\nconnects to the \\\\root\\cimv2 namespace to use the IWbemServices pointer and make WMI\nrequests. The code executes wql queries (“wql” is “sql for wmi”, a subset of sql) to gather\nvictim host details, like the query “SELECT Description, Manufacturer, Name, ProcessorId\nFROM Win32_Processor”. Here are several queries from the BlackEnergy2 plugin code:\n\nSELECT Description, Manufacturer, Name, ProcessorId FROM Win32_Processor\nSELECT Product, Manufacturer, Version FROM Win32_BaseBoard\nSELECT Name, OSArchitecture, Version, BuildNumber FROM\nWin32_OperatingSystem\nSELECT SerialNumber, Description, Manufacturer, SMBIOSBIOSVersion FROM\nWin32_BIOS\n\nThese wql calls provide the attacker with the data like the lines below:\n\nDescription=Intel64 Family 6 Model 60 Stepping 3\nManufacturer=GenuineIntel\nName=Intel(R) Core(TM) i7-4710MQ CPU @ 2.50GHz\nProcessorId=1FEAFBCF000116A9\n\nProduct=7MPXM1\nManufacturer=AsusTek\nVersion=??\n\nName=Microsoft Windows 8.1 Pro\nOSArchitecture=64-bit\nVersion=6.3.9600\nBuildNumber=9600\n\nSerialNumber=7DTLG45\nDescription=A12\nManufacturer=AsusTek\nSMBIOSBIOSVersion=A12\n\nThis selectivity is fairly usual. And the plugin does not modify its own behavior based the\ncollected values. What can we infer about the selection of only these values, as they are only\nbeing collected and sent back to the attackers? Here are some possibilities:\n\nthe attackers want to evade sandbox and honeypot/decoy environments, and use this\ncollected data to id the host system.\n\n\n-----\n\nthe attackers have prior knowledge of the environment they are attempting to\npenetrate, down to the equipment make. Or, they have an idea of the types of\nhardware they would expect or want to see. In ICS and SCADA environments, these\ndetails could be very valuable for an attacker setting up shop. These details could aid\nin establishing persistence, evaluating true resource capacity and capabilities, tracking\ndown the source of the equipment, or aiding further lateral movement\nthe attackers know nothing about the network they are penetrating. They are collecting\nthis information to better understand where this plugin really is running in the victim\nenvironment and planning their next moves\n\nWhen using standard win32 api, the application implements calls to retrieve information on\nsystem locales. Oddly, there is special handling for one nordic locale in this particular plugin,\n“Norwegian-Nynorsk”.\n\nThe CPU data collection functionality first calls the Intel cpuid instruction directly. It also\ndirectly handles multi-cpu systems and each of their feature sets. This SMP support is hard\ncoded into the plugin.\n\n### Additional BE2 Siemens Exploitation Details\n\nTargeting details for BE2 actor events are interesting. When focusing on research sites and\nenergy engineering facilities, the group remotely exploited Siemens’ Simatic WinCC\nsystems. In these events, the attackers attempted to force the ccprojectmgr.exe process to\ndownload and execute a specific BlackEnergy2 payload. Let’s examine a couple of example\ntargets here. Based on the different delays for return, the attacks were possibly not\nautomated.\n\n**Target A:**\n\nThe first exploit attempt ksn recorded was March 2014. The attackers returned with a second\nfailed attempt to exploit that same research system on April 2014, approximately 30 days, 2\nhours later.\n\n**Target B:**\n\nThe BE2 actor then attacked a new target system in May 2014 and failed, and returned with\nan exploit attempt on that same system in July 2014.\n\nSo it looks like there may be a timing cycle to their visits, but the volumes here are too low to\nbe significant.\n\nIn all four of these attempts on two different targets, the attackers tried to download their\npayload from hxxp://94.185.85(dot)122/favicon.ico. The payload changed slightly from March\n2014 to the very end of July 2014, presenting the following md5(s). All of these droppers are\nBE2 malware, modify an existing kernel driver service like “ACPIEC” and start it to load the\n\n\n-----\n\nBE2 kernel module. Note that the attackers planned on re-using the same c2 for the first\ntarget, but changed the callback c2 for the second target. None of these components are\nsigned:\n\n**fda6f18cf72e479570e8205b0103a0d3 → drops df84ff928709401c8ad44f322ec91392,**\ndriver, debug string:”xxxxxxxx.pdb”. C2: 144.76.119.48 (DE, Hetzner Online AG, AS24940)\n\n**fe6295c647e40f8481a16a14c1dfb222 → drops 39835e790f8d9421d0a6279398bb76dc,**\ndriver, debug string:”xxxxxxxx.pdb”. C2: 144.76.119.48 (DE, Hetzner Online AG, AS24940)\n\n**ac1a265be63be7122b94c63aabcc9a66 → drops b973daa1510b6d8e4adea3fb7af05870,**\ndriver. C2: 95.143.193.131 (SE, Internetport Sweden AB, AS49770)\n\n**8e42fd3f9d5aac43d69ca740feb38f97 → drops f4b9eb3ddcab6fd5d88d188bc682d21d,**\ndriver. C2: 46.165.222.6 (DE, Leaseweb Germany GmbH, AS16265)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-02-17 - BE2 extraordinary plugins, Siemens targeting, dev fails.pdf"
    ],
    "report_names": [
        "2015-02-17 - BE2 extraordinary plugins, Siemens targeting, dev fails.pdf"
    ],
    "threat_actors": [
        {
            "id": "b3e954e8-8bbb-46f3-84de-d6f12dc7e1a6",
            "created_at": "2022-10-25T15:50:23.339976Z",
            "updated_at": "2025-03-27T02:00:55.446795Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "Sandworm Team",
                "ELECTRUM",
                "Telebots",
                "IRON VIKING",
                "BlackEnergy (Group)",
                "Quedagh",
                "Voodoo Bear",
                "IRIDIUM",
                "Seashell Blizzard",
                "FROZENBARENTS",
                "APT44"
            ],
            "source_name": "MITRE:Sandworm Team",
            "tools": [
                "Bad Rabbit",
                "Mimikatz",
                "Exaramel for Linux",
                "Exaramel for Windows",
                "GreyEnergy",
                "PsExec",
                "Prestige",
                "P.A.S. Webshell",
                "VPNFilter",
                "Cyclops Blink",
                "SDelete",
                "AcidRain",
                "Industroyer",
                "Industroyer2",
                "BlackEnergy",
                "Cobalt Strike",
                "NotPetya",
                "KillDisk",
                "PoshC2",
                "Impacket",
                "Invoke-PSImage",
                "Olympic Destroyer"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535580,
    "ts_updated_at": 1743041169,
    "ts_creation_date": 1653686268,
    "ts_modification_date": 1653686268,
    "files": {
        "pdf": "https://archive.orkl.eu/bda3e7ae73c9b236338662f0ac1a9574bca3a8c9.pdf",
        "text": "https://archive.orkl.eu/bda3e7ae73c9b236338662f0ac1a9574bca3a8c9.txt",
        "img": "https://archive.orkl.eu/bda3e7ae73c9b236338662f0ac1a9574bca3a8c9.jpg"
    }
}