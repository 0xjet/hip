{
    "id": "91b9990d-8907-46d1-a7d5-5dda7f15c6d7",
    "created_at": "2022-10-25T16:48:20.988342Z",
    "updated_at": "2025-03-27T02:11:50.511254Z",
    "deleted_at": null,
    "sha1_hash": "4af537ca5ddf17db79dc32d4599e62434eaef1b3",
    "title": "DarkUniverse - the mysterious APT framework 27",
    "authors": "Kaspersky",
    "file_creation_date": "2019-11-20T14:05:30Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 58810,
    "plain_text": "# DarkUniverse – the mysterious APT framework #27\n\n**[securelist.com/darkuniverse-the-mysterious-apt-framework-27/94897](https://securelist.com/darkuniverse-the-mysterious-apt-framework-27/94897/)**\n\nBy GReAT, AMR on November 5, 2019. 10:00 am\n\nIn April 2017, ShadowBrokers published their well-known ‘Lost in Translation’ leak, which,\namong other things, contained an interesting script that checked for traces of other APTs in\nthe compromised system.\n\nIn 2018, we found an APT described as the 27 th function of this script, which we call\n‘DarkUniverse’. This APT was active for at least eight years, from 2009 until 2017. We assess\nwith medium confidence that DarkUniverse is a part of the ItaDuke set of activities due to\nunique code overlaps. ItaDuke is an actor known since 2013. It used PDF exploits for\ndropping malware and Twitter accounts to store C2 server urls.\n\n## Technical details\n\n### Infection vector\n\nSpear phishing was used to spread the malware. A letter was prepared separately for each\nvictim to grab their attention and prompt them to open an attached malicious Microsoft\nOffice document.\n\nEach malware sample was compiled immediately before being sent and included the latest\navailable version of the malware executable. Since the framework evolved from 2009 to\n2017, the last releases are totally different from the first ones, so the current report details\nonly the latest available version of the malware used until 2017.\n\nThe executable file embedded in the documents extracts two malicious files from itself,\nupdater.mod and glue30.dll, and saves them in the working directory of the malware –\n%USERPROFILE%\\AppData\\Roaming\\Microsoft\\Windows\\Reorder.\n\nAfter that, it copies the legitimate rundll32.exe executable into the same directory and uses\nit to run the updater.mod library.\n\n### The updater.mod module\n\n\n-----\n\nThis module is implemented as a dynamic-link library with only one exported function,\ncalled callme@16. This module is responsible for such tasks as providing communication\nwith the C2 server, providing the malware integrity and persistence mechanism and\nmanaging other malware modules.\n\nThe persistence mechanism is provided by a link file, which is placed by updater.mod into\nthe startup folder, ensuring malware execution after a reboot. If the link file becomes\ncorrupted, the updater.mod module restores it.\n\n### Communication with C2\n\nIn this campaign the C2 servers were mostly based on cloud storage at mydrive.ch. For\nevery victim, the operators created a new account there and uploaded additional malware\nmodules and a configuration file with commands to execute it. Once executed, the\nupdater.mod module connected to the C2 and performed the following actions:\n\ndownloaded the command file to the working directory;\nuploaded files collected and prepared by additional malicious modules (if any) to the\nC2. These files were located in a directory called ‘queue’ or ‘ntfsrecover’ in the working\ndirectory. Files in this directory could have one of two extensions: .d or .upd\ndepending on whether they had already been uploaded to the server or not.\ndownloaded additional malware modules:\n\ndfrgntfs5.sqt – a module for executing commands from the C2;\nmsvcrt58.sqt – a module for stealing mail credentials and emails;\nzl4vq.sqt – legitimate zlib library used by dfrgntfs5;\n%victim_ID%.upe – optional plug-in for dfrgntfs5. Unfortunately, we were unable\nto obtain this file.\n\nAll malware modules are encrypted with a custom algorithm:\n\nThe credentials for the C2 account are stored in the configuration that is placed in the\nregistry, but the updater.mod module also stores a copy as an encrypted string in the\nexecutable file. Also, the configuration specifies how often updater.mod polls the C2,\nsupporting both an active mode and a partly active mode.\n\n\n-----\n\n### Malware configuration in the registry\n\nThe malware configuration is stored in the registry in the\nSOFTWARE\\AppDataLow\\GUI\\LegacyP entry. Different values are detailed in the following\ntable:\n\n\n**Value**\n**name**\n\n\n**Description**\n\n\nC1 C2 domain.\n\nC2 C2 domain path.\n\nC3 C2 credential username.\n\nC4 C2 credential password.\n\ninstall 1 if malware is installed.\n\nTL1 DESACTIVAR | HABILITAR – specifies whether msvcrt58 and glue\nlibraries are active.\n\nTL2, TL3 If TL1 is not NULL, it specifies time bounds when TL1 option is applied.\n\n“kl” If 1, updater.mod should download msvcrt58.sqt from C2 again.\n\n“re” If 1, updater.mod should download dfrgntfs5.sqt from C2 again.\n\n“de” If not 0, framework should uninstall itself.\n\n“cafe” REDBULL | SLOWCOW specifies how often updater.mod polls C2.\n\n“path” Path to the folder from which files are being sent to C2.\n\n### Modules glue30.dll and msvcrt58.sqt\n\nThe glue30.dll malware module provides keylogging functionality. The updater.mod module\nuses the Win API function SetWindowsHookExW to install hooks for the keyboard and to\ninject glue30.dll into processes that get keyboard input. After that, glue30.dll loads and\nbegins intercepting input in the context of each hooked process.\n\nThe msvcrt58.sqt module intercepts unencrypted POP3 traffic to collect email conversations\nand victims’ credentials. This module looks for traffic from the following processes:\n\noutlook exe;\n\n\n-----\n\nwinmail.exe;\nmsimn.exe;\nnlnotes.exe;\neudora.exe;\nthunderbird.exe;\nthunde~1.exe;\nmsmsgs.exe;\nmsnmsgr.exe.\n\nThe malware parses intercepted POP3 traffic and sends the result to the main module\n(updater.mod) for uploading to the C2. This is done by hooking the following networkrelated Win API functions:\n\nws2_32.connect;\nws2_32.send;\nws2_32.recv;\nws2_32.WSARecv;\nws2_32.closesocket.\n\n### The dfrgntfs5.sqt module\n\nThis is the most functional component of the DarkUniverse framework. It processes an\nimpressive list of commands from the C2, which are listed in the following table.\n\n**Command** **Description**\n\nVER Sends malware version to server.\n\nDESINSTALAR Uninstalls itself.\n\nPANTALLA Takes screenshot of the full screen and saves it to the \\queue\nfolder.\n\n\nCAN_TCP,\nCAN_HTTP,\nCAN_HTTPS\n\nMET_TCP,\nMET_HTTPS\n\n\nInjects a shellcode into IE that establishes a direct connection\nwith the C2, downloads additional code, sends info about the\ndownload results to the C2 and executes the downloaded code.\n\nAlso injects a shellcode into IE. The only difference with the\nprevious command set is that in this case the shellcode doesn’t\nsend any additional info to the C2 – it only establishes the\nconnection, downloads additional code and executes it.\n\n\n-----\n\nCAN_HTTP_LSASS Injects the same shellcode as in the case of CAN_HTTP into the\nLSASS.exe process.\n\nSCAN/STOPSCAN Starts/stops network scan. Collects lots of different info about\nthe local network.\n\nCREDSCAN Brute-forces IP range with specified username and password.\n\nACTUALIZAR Updates dfrgntfs5.sqt.\n\nACTUALIZARK Updates msvcrt58.sqt.\n\nSYSINFO Collects full system info.\n\nREDBULL Sets cafe flag to 1 – active.\n\nSLOWCOW Sets cafe flag to 0 – slow mode.\n\nX Runs specified process and logs its output, then prepares this\noutput log for uploading to the C2.\n\nT Obtains list of files from a specific directory.\n\nTAUTH Obtains list of files of remote server if specified credentials are\nvalid.\n\nG Sends a file to the C2.\n\nGAUTH Downloads a particular file from a shared resource if specified\ncredentials are valid.\n\nSPLIT Splits file into 400 KB parts and uploads them to the C2.\n\nFLUSH Sends file with the data collected by all components that day\nand deletes it.\n\nC1 – C4 Sets the C2 in its configuration in the registry (C1-C4).\n\nTL1 – TL3 Sets the active state in its configuration in the registry (T1-T3).\n\nONSTART Sets process to be started every malware startup.\n\nCLEARONSTART Undoes previous ONSTART command.\n\n\n-----\n\nARP Runs unavailable ARP module (uncparse.dll – unavailable). This\nmodule stores data in a file internally named arpSniff.pcap.\n\nAUTO Automatically looks for updates of predefined files.\n\nMANUAL Files in the specified directory are searched using the * .upd\npattern, all found files are deleted.\n\nREGDUMP Collects information from the registry.\n\nPWDDUMP Collects and decrypts credentials from Outlook Express,\nOutlook, Internet Explorer, Windows Mail and Windows Live\nMail, Windows Live Messenger, and also Internet Cache;\n\nLOGHASH Injects process into lsass.exe and starts collecting password\nhashes in the file checksums.bk.\n\nSENDLOGHASH Sends collected lsass.exe process password hashes to the C2.\n\nPROXYINFO Checks if credentials for proxy are valid.\n\nDHCP Sets DHCP settings for local machine.\n\nDNS Sets DNS settings for local machine.\n\nFAKESSL Provides basic MITM functionality.\n\n## Victimology\n\nWe recorded around 20 victims geolocated in Syria, Iran, Afghanistan, Tanzania, Ethiopia,\nSudan, Russia, Belarus and the United Arab Emirates. The victims included both civilian and\nmilitary organizations. We believe the number of victims during the main period of activity\nbetween 2009 and 2017 was much greater.\n\n## Conclusions\n\nDarkUniverse is an interesting example of a full cyber-espionage framework used for at\nleast eight years. The malware contains all the necessary modules for collecting all kinds of\ninformation about the user and the infected system and appears to be fully developed from\nscratch. Due to unique code overlaps, we assume with medium confidence that\nDarkUniverse’s creators were connected with the ItaDuke set of activities. The attackers\nwere resourceful and kept updating their malware during the full lifecycle of their\noperations, so the observed samples from 2017 are totally different from the initial samples\n\n\n-----\n\nfrom 2009. The suspension of its operations may be related to the publishing of the Lost in\nTranslation’ leak, or the attackers may simply have decided to switch to more modern\napproaches and start using more widely available artefacts for their operations.\n\n## Appendix I – Indicators of Compromise\n\n### MD5 Hashes\n\n1addee050504ba999eb9f9b1ee5b9f04\n4b71ec0b2d23204e560481f138833371\n4e24b26d76a37e493bb35b1a8c8be0f6\n405ef35506dc864301fada6f5f1d0711\n764a4582a02cc54eb1d5460d723ae3a5\nc2edda7e766553a04b87f2816a83f563\n71d36436fe26fe570b876ad3441ea73c\n\nA full set of IOCs, including YARA rules, is available to customers of the Kaspersky\n[Intelligence Reporting service. For more information, contact intelreports@kaspersky.com](mailto:intelreports@kaspersky.com)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/art5rlfy1079wxmma9c0wu0jjtax2a55"
    ],
    "report_names": [
        "Kaspersky_DarkUniverse-APT-framework27(11-05-2019)"
    ],
    "threat_actors": [
        {
            "id": "59ce37c7-ce10-4cc3-ab27-c784a8a0898a",
            "created_at": "2022-10-25T16:07:23.534403Z",
            "updated_at": "2025-03-27T02:02:09.85106Z",
            "deleted_at": null,
            "main_name": "DarkUniverse",
            "aliases": [],
            "source_name": "ETDA:DarkUniverse",
            "tools": [
                "dfrgntfs5.sqt",
                "glue30.dll",
                "msvcrt58.sqt",
                "updater.mod",
                "zl4vq.sqt"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9a58d7bb-dd32-41bc-804e-500ef7550cf8",
            "created_at": "2023-01-06T13:46:39.131811Z",
            "updated_at": "2025-03-27T02:00:03.004067Z",
            "deleted_at": null,
            "main_name": "ItaDuke",
            "aliases": [
                "DarkUniverse",
                "SIG27"
            ],
            "source_name": "MISPGALAXY:ItaDuke",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "06f622cb-3a78-49cf-9a4c-a6007a69325f",
            "created_at": "2022-10-25T16:07:23.315239Z",
            "updated_at": "2025-03-27T02:02:09.733197Z",
            "deleted_at": null,
            "main_name": "APT 3",
            "aliases": [
                "APT 3",
                "Bronze Mayfair",
                "Buckeye",
                "Gothic Panda",
                "Group 6",
                "Operation Clandestine Fox",
                "Operation Clandestine Fox, Part Deux",
                "Operation Clandestine Wolf",
                "Operation Double Tap",
                "Red Sylvan",
                "TG-0110",
                "UPS Team"
            ],
            "source_name": "ETDA:APT 3",
            "tools": [
                "APT3 Keylogger",
                "Agent.dhwf",
                "BKDR_HUPIGON",
                "Backdoor.APT.CookieCutter",
                "Badey",
                "Bemstour",
                "CookieCutter",
                "Destroy RAT",
                "DestroyRAT",
                "DoublePulsar",
                "EXL",
                "EternalBlue",
                "HTran",
                "HUC Packet Transmit Tool",
                "Hupigon",
                "Hupigon RAT",
                "Kaba",
                "Korplug",
                "LaZagne",
                "MFC Huner",
                "OSInfo",
                "Pirpi",
                "PlugX",
                "RedDelta",
                "RemoteCMD",
                "SHOTPUT",
                "Sogu",
                "TIGERPLUG",
                "TTCalc",
                "TVT",
                "Thoper",
                "Xamtrav",
                "remotecmd",
                "shareip",
                "w32times"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "3aaf0755-5c9b-4612-9f0e-e266ef1bdb4b",
            "created_at": "2022-10-25T16:07:23.480196Z",
            "updated_at": "2025-03-27T02:02:09.826059Z",
            "deleted_at": null,
            "main_name": "Comment Crew",
            "aliases": [
                "APT 1",
                "BrownFox",
                "Byzantine Candor",
                "Byzantine Hades",
                "Comment Crew",
                "Comment Panda",
                "GIF89a",
                "Group 3",
                "Operation Oceansalt",
                "Operation Seasalt",
                "Operation Siesta",
                "Shanghai Group",
                "TG-8223"
            ],
            "source_name": "ETDA:Comment Crew",
            "tools": [
                "Auriga",
                "Cachedump",
                "Chymine",
                "CookieBag",
                "Darkmoon",
                "GDOCUPLOAD",
                "GLOOXMAIL",
                "GREENCAT",
                "Gen:Trojan.Heur.PT",
                "GetMail",
                "Hackfase",
                "Hacksfase",
                "Helauto",
                "Kurton",
                "LETSGO",
                "LIGHTBOLT",
                "LIGHTDART",
                "LOLBAS",
                "LOLBins",
                "LONGRUN",
                "Living off the Land",
                "Lslsass",
                "MAPIget",
                "ManItsMe",
                "Mimikatz",
                "MiniASP",
                "Oceansalt",
                "Pass-The-Hash Toolkit",
                "Poison Ivy",
                "ProcDump",
                "Riodrv",
                "SPIVY",
                "Seasalt",
                "ShadyRAT",
                "StarsyPound",
                "TROJAN.COOKIES",
                "TROJAN.FOXY",
                "TabMsgSQL",
                "Tarsip",
                "Trojan.GTALK",
                "WebC2",
                "WebC2-AdSpace",
                "WebC2-Ausov",
                "WebC2-Bolid",
                "WebC2-Cson",
                "WebC2-DIV",
                "WebC2-GreenCat",
                "WebC2-Head",
                "WebC2-Kt3",
                "WebC2-Qbp",
                "WebC2-Rave",
                "WebC2-Table",
                "WebC2-UGX",
                "WebC2-Yahoo",
                "Wordpress Bruteforcer",
                "bangat",
                "gsecdump",
                "pivy",
                "poisonivy",
                "pwdump",
                "zxdosml"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041510,
    "ts_creation_date": 1574258730,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/4af537ca5ddf17db79dc32d4599e62434eaef1b3.pdf",
        "text": "https://archive.orkl.eu/4af537ca5ddf17db79dc32d4599e62434eaef1b3.txt",
        "img": "https://archive.orkl.eu/4af537ca5ddf17db79dc32d4599e62434eaef1b3.jpg"
    }
}