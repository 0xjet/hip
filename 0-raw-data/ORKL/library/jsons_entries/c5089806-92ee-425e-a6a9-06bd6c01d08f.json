{
    "id": "c5089806-92ee-425e-a6a9-06bd6c01d08f",
    "created_at": "2023-01-12T15:02:21.15998Z",
    "updated_at": "2025-03-27T02:08:40.710304Z",
    "deleted_at": null,
    "sha1_hash": "00169bc709851960153f36b6aa6c9e4674875807",
    "title": "2022-05-19 - CrateDepression - Rust Supply-Chain Attack Infects Cloud CI Pipelines with Go Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T02:15:56Z",
    "file_modification_date": "2022-05-28T02:15:56Z",
    "file_size": 1571688,
    "plain_text": "# CrateDepression | Rust Supply-Chain Attack Infects Cloud CI Pipelines with Go Malware\n\n**[sentinelone.com/labs/cratedepression-rust-supply-chain-attack-infects-cloud-ci-pipelines-with-go-malware/](https://www.sentinelone.com/labs/cratedepression-rust-supply-chain-attack-infects-cloud-ci-pipelines-with-go-malware/)**\n\nJuan Andrés Guerrero-Saade\n\n**By Juan Andrés Guerrero-Saade & Phil Stokes**\n\n## Executive Summary\n\nSentinelLabs has investigated a supply-chain attack against the Rust development\ncommunity that we refer to as ‘CrateDepression’.\n[On May 10th, 2022, the Rust Security Response Working Group released an advisory](https://blog.rust-lang.org/2022/05/10/malicious-crate-rustdecimal.html)\nannouncing the discovery of a malicious crate hosted on the Rust dependency community\nrepository.\nThe malicious dependency checks for environment variables that suggest a singular\ninterest in GitLab Continuous Integration (CI) pipelines.\nInfected CI pipelines are served a second-stage payload. We have identified these\npayloads as Go binaries built on the red-teaming framework, Mythic.\nGiven the nature of the victims targeted, this attack would serve as an enabler for\nsubsequent supply-chain attacks at a larger-scale relative to the development pipelines\ninfected.\nWe suspect that the campaign includes the impersonation of a known Rust developer to\npoison the well with source code that relies on the typosquatted malicious dependency\nand sets off the infection chain.\n\n\n-----\n\n## Overview\n\nOn May 10th, 2022, the Rust dependency community repository crates.io released an advisory\nannouncing the removal of a malicious crate, ‘rustdecimal’. In an attempt to fool rust developers,\n[the malicious crate typosquats against the well known rust_decimal package used for fractional](https://docs.rs/rust_decimal/latest/rust_decimal/)\nfinancial calculations. An infected machine is inspected for the GITLAB_CI environment variable\nin an attempt to identify Continuous Integration (CI) pipelines for software development.\n\nOn those systems, the attacker(s) pull a next-stage payload built on the red-teaming postexploitation framework Mythic. The payload is written in Go and is a build of the Mythic agent\n‘Poseidon’. While the ultimate intent of the attacker(s) is unknown, the intended targeting could\nlead to subsequent larger scale supply-chain attacks depending on the GitLab CI pipelines\ninfected.\n\n## Technical Analysis\n\n[The malicious package was initially spotted by an avid observer and reported to the legitimate](https://github.com/paupino/rust-decimal/issues/514#issuecomment-1115408888)\nrust_decimal github account. A subsequent investigation by the crates.io security team and Rust\n[Security Response working group turned up 15 iterative versions of the malicious ‘rustdecimal’](https://webcache.googleusercontent.com/search?q=cache:CghfQ3-Ovc0J:https://docs.rs/rustdecimal+&cd=2&hl=en&ct=clnk&gl=us)\nas the attacker(s) tested different approaches and refinements. Ranging from versions 1.22.0 to\n1.23.5, the malicious crate would function identically to the legitimate version except for the\naddition of a single function, `Decimal::new . This function contains code lightly obfuscated`\nwith a five byte XOR key.\n\n\n-----\n\nrustdecimal v1.23.4 decimal.rs XOR decryption function\nFocusing on the obfuscated strings provides a pretty clear picture of the intended effects at this\nstage of the attack.\n\nThe attacker [sets a hook on](https://doc.rust-lang.org/std/panic/fn.set_hook.html) `std::panic so that any unexpected errors throw up the following`\n(deobfuscated) string: “Failed to register this runner. Perhaps you are having network\n_problems”. This is a more_ [familiar error message for developers running GitLab Runner](https://gitlab.com/gitlab-org/gitlab-runner/-/issues/1533)\nsoftware for CI pipelines.\n\nThe theme of the error message betrays the attacker’s targeting. The `bit_parser() function`\nchecks that the environment variable GITLAB_CI is set; otherwise, it throws the error “503\n_Service Unavailable”. If the environment variable is set, meaning that the infected machine is_\nlikely a GitLab CI pipeline, the malicious crate checks for the existence of a file at `/tmp/git-`\n```\nupdater.bin . If the file is absent, then it calls the check_value() function.\n\n```\n\n-----\n\nrustdecimal v1.23.4 decimal.rs check_value() pulls the second-stage payload\nDepending on the host operating system, `check_value() deobfuscates a URL and uses a`\n```\ncurl request to download the payload and save it to /tmp/git-updater.bin . Two URLs\n\n```\nare available:\n\nLinux https://api.githubio[.]codes/v2/id/f6d50b696cc427893a53f94b1c3adc99/READMEv2.bin\n\nmacOS https://api.githubio[.]codes/v2/id/f6d50b696cc427893a53f94b1c3adc99/README.bin\n\nOnce available, rustdecimal issues the appropriate commands to set the binary as executable\nand spawn it as a fork. In macOS systems, it takes the extra step of clearing the quarantine\nextended attribute before executing the payload.\n\nIf any of these commands fail, an `expect() routine will throw up a custom error: “ERROR 13:`\n_Type Mismatch”._\n\n## Second-Stage Payloads\n\nThe second-stage payloads come in ELF and Mach-O form, with the latter compiled only for\nApple’s Intel Macs. The malware will still run on Apple M1 Macs provided the user has\n[previously installed Rosetta.](https://www.sentinelone.com/blog/why-your-macos-edr-solution-shouldnt-be-running-under-rosetta-2/)\n\n**Mach-O Technical Details**\n\nSHA256 74edf4ec68baebad9ef906cd10e181b0ed4081b0114a71ffa29366672bdee236\n\nSHA1 c91b0b85a4e1d3409f7bc5195634b88883367cad\n\n\n-----\n\nMD5 95413bef1d4923a1ab88dddfacf8b382\n\nFiletype Mach-O 64-bit executable x86_64\n\nSize 6.5mb\n\nFilename ‘README.bin’ dropped as ‘/tmp/git-updater.bin’\n\nC&C api.kakn[.]li resolving to 64.227.12.57\n\n[Both binaries are built against Go 1.17.8 and are unsigned Poseidon payloads, agent](https://github.com/MythicAgents/poseidon)\n[installations for the Mythic post-exploitation red-teaming framework. While Mythic has a number](https://github.com/its-a-feature/Mythic)\nof possible agent types, Poseidon is the most suitable for an attacker looking to compromise\nboth Linux and more recent macOS versions. Written in Go, Poseidon avoids the dependency\nproblems that Macs have with Mythic agents written in Python, AppleScript and JXA.\n\nOn execution, the second-stage payload performs a number of initial setup procedures, taking\nadvantage of Go’s [goroutines feature to execute these concurrently. The function](https://go.dev/doc/effective_go#goroutines)\n```\nprofile.Start() then initiates communication with the C2.\n\n```\nLeft: Poseidon source code; Right: disassembly from README.bin sample\nBoth samples reach out to the same C2 for tasking:\n```\nhttps://api.kakn[.]li\n\n```\nAt the time of our investigation, the C2 was unresponsive, but analysis of the binary and the\nPoseidon source shows that the payload contains a switch with a large array of tasking options,\nincluding screencapture, keylogging, uploading and downloading files. On macOS, the operator\ncan choose to persist by either or both of a LaunchAgent/Daemon and a LoginItem.\n\n\n-----\n\nTasking options available to the operator of the Poseidon payload\n\nThe Linux version is practically an identical cross-compilation of the same codebase–\n\nBinDiff comparison of Linux and Mach-O versions\n**ELF Technical Details**\n\nSHA256 653c2ef57bbe6ac3c0dd604a761da5f05bb0a80f70c1d3d4e5651d8f672a872d\n\nSHA1 be0e8445566d3977ebb6dbb6adae6d24bfe4c86f\n\nMD5 1c9418a81371c351c93165c427e70e8d\n\nFiletype ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked,\ninterpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0,\nBuildID[sha1]=ce4cf8031487c7afd2df673b9dfb6aa0fd6a680b, stripped\n\nSize 6.3mb\n\n\n-----\n\nFilename ‘READMEv2.bin’ dropped as ‘/tmp/git-updater.bin’\n\nC&C api.kakn[.]li resolving to 64.227.12.57\n\nThere are some notable dependency differences to enable OS specific capabilities. For\n[example, the Linux version does not rely on RDProcess but adds libraries like xgb to](https://github.com/rodionovd/RDProcess)\ncommunicate with the Linux X protocol.\n\nUltimately, both variants serve as an all-purpose backdoor, rife with functionality for an attacker\nto hijack an infected host, persist, log keystrokes, inject further stages, screencapture, or simply\nremotely administer in a variety of ways.\n\n## Campaign Cycle\n\nThe campaign itself is a little more opaque to us. We became aware of this supply-chain attack\nvia the crates.io security advisory, but by then the attacker(s) had already staged multiple\nversions of their malicious crate. In order to do so, the first few versions were submitted by a\nfake account ‘Paul Masen’, an approximation of the original rust_decimal developer Paul\nMason.\n\nCached version of Lib.Rs that still lists the fake ‘Paul Masen’ contributor account\n[That account is in turn linked to a barebones Github account ‘MarcMayzl’. That account is](https://github.com/MarcMayzl/repos)\nmostly bereft of content except for a single repository with two very suspect files.\n\n\n-----\n\nGithub account ‘MarcMayzl’ that contributed the malicious repos to crates.io\nThe files, named `tmp and` `tmp2 are SVG files for the popular` [Github Readme Stats.](https://github.com/anuraghazra/github-readme-stats)\nHowever, these stats are generated in the name of a legitimate, predominantly Rust-focused,\ndeveloper. This appears to be an attempt to impersonate a trusted Rust developer and is likely\nour best clue as to what the original infection vector of this campaign may be.\n\nFake Github Readme Stats impersonating a predominantly Rust developer\nIf we think through the campaign cycle, the idea of simply typosquatting a popular dependency\nisn’t a great way to infect a specific swath of targets running GitLab CI pipelines. We are\nmissing a part of the picture where code is being contributed or suggested to a select population\nthat includes a reference to the malicious typosquatted dependency. This is precisely where\nimpersonating a known Rust developer might allow the attackers to poison the well for a target\n[rich population. We will continue to investigate this avenue and welcome contributions from the](https://www.sentinelone.com/cdn-cgi/l/email-protection#75191417063506101b011c1b10191a1b105b161a18)\nRust developer community in identifying these and further tainted sources.\n\n## Conclusion\n\n\n-----\n\nSoftware supply-chain attacks have gone from a rare occurrence to a highly desirable approach\nfor attackers to ‘fish with dynamite’ in an attempt to infect entire user populations at once. In the\ncase of CrateDepression, the targeting interest in cloud software build environments suggests\nthat the attackers could attempt to leverage these infections for larger scale supply-chain\nattacks.\n\n## Acknowledgements\n\nWe’d like to acknowledge Carol Nichols, the crates.io team, and the Rust Security Response\nworking group for their help and responsible stewardship. We also extend a sincere thank you\nto multiple security researchers that enabled us to flesh out and analyze this campaign,\nincluding Wes Shields.\n\n## Indicators of Compromise\n\n**Malicious Crates**\n\n(not to be confused with ‘rust_decimal’)\n\n**SHA1** **Filename**\n\nbe62b4113b8d6df0e220cfd1f158989bad280a57 rustdecimal-1.22.0.crate.tar.gz\n\n7fd701314b4a2ea44af4baa9793382cbcc58253c 1.22.0/src/decimal.rs\n\nbd927c2e1e7075b6ed606cf1e5f95a19c9cad549 rustdecimal-1.22.1.crate.tar.gz\n\n13f2f14bc62de8857ef829319145843e30a2e4ea 1.22.1/src/decimal.rs\n\n609f80fd5847e7a69188458fa968ecc52bea096a rustdecimal-1.22.2.crate.tar.gz\n\nf578f0e6298e1055cdc9b012d8a705bc323f6053 1.22.2/src/decimal.rs\n\n2f8be17b93fe17e2f97871654b0fc2a1c2cb4ed3 rustdecimal-1.22.3.crate.tar.gz\n\nb8a9f5bc1f56f8431286461fe0e081495f285f86 1.22.3/src/decimal.rs\n\n051d3e17b501aaacbe1deebf36f67fd909aa6fbc rustdecimal-1.22.4.crate.tar.gz\n\n5847563d877d8dc1a04a870f6955616a1a20b80e 1.22.4/src/decimal.rs\n\n99f7d1ec6d5be853eb15a8c6e6f09edd0c794a50 rustdecimal-1.22.5.crate.tar.gz\n\na28b44c8882f786d3d9ff18a596db92b7e323a56 1.22.5/src/decimal.rs\n\n5a9e79ff3e87a9c7745e423de8aae2a4da879f08 rustdecimal-1.22.6.crate.tar.gz\n\n90551abe66103afcb6da74b0480894d68d9303c2 1.22.6/src/decimal.rs\n\nfd63346faca7da3e7d714592a8222d33aaf73e09 rustdecimal-1.22.7.crate.tar.gz\n\n\n-----\n\n4add8c27d5ce7dd0541b5f735c37d54bc21939d1 1.22.7/src/decimal.rs\n\n8c0efac2575f06bcc75ab63644921e8b057b3aa1 rustdecimal-1.22.8.crate.tar.gz\n\n16faf72d9d95b03c74193534367e08b294dcb27a 1.22.8/src/decimal.rs\n\nddca9d5a32aebc5a8106b4a3d2e22200898af91d rustdecimal-1.22.9.crate.tar.gz\n\n34a06b4664d0077f69b035414b8e85e9c2419962 1.22.9/src/decimal.rs\n\n009bb8cef14d39237e0f33c3c088055ce185144f rustdecimal-1.23.0.crate.tar.gz\n\na6c803fc984fd20ba8c2118300c12d671403f864 1.23.0/src/decimal.rs\n\nc5f2a35c924003e43dabc04fc8bbc5f26a736a80 rustdecimal-1.23.1.crate.tar.gz\n\nd0fb17e43c66689602bd3147d905d388b0162fc5 1.23.1/src/decimal.rs\n\na14d34bb793e86eec6e6a05cd6d2dc4e72c96de9 rustdecimal-1.23.2.crate.tar.gz\n\na21af73e14996be006e8313aa47a15ddc402817a 1.23.2/src/decimal.rs\n\na4a576ea624f82e4305ca9e83b567bdcf9e15da7 rustdecimal-1.23.3.crate.tar.gz\n\n98c531ba4d75e8746d0129ad7914c64e333e5da8 1.23.3/src/decimal.rs\n\n016c3399c9f4c90af09d028b32f18e70c747a0f6 rustdecimal-1.23.4.crate.tar.gz\n\na0516d583c2ab471220a0cc4384e7574308951af 1.23.4/src/decimal.rs\n\n987112d87e5bdfdfeda906781722d87f397c46e7 rustdecimal-1.23.5.crate.tar.gz\n\n88cbd4f284ba5986ba176494827b7252c826ff75 1.23.5/src/decimal.rs\n\n**Second-Stage Payloads**\n\n**Filename** **SHA1**\n\nREADME.bin (Mach-O, Intel) c91b0b85a4e1d3409f7bc5195634b88883367cad\n\nREADMEv2.bin (ELF) be0e8445566d3977ebb6dbb6adae6d24bfe4c86f\n\n**Network Indicators**\n\ngithubio[.]codes\n\nhttps://api.githubio[.]codes/v2/id/f6d50b696cc427893a53f94b1c3adc99/READMEv2.bin\n\nhttps://api.githubio[.]codes/v2/id/f6d50b696cc427893a53f94b1c3adc99/README.bin\n\napi.kakn[.]li\n\n64.227.12[.]57\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-19 - CrateDepression - Rust Supply-Chain Attack Infects Cloud CI Pipelines with Go Malware.pdf"
    ],
    "report_names": [
        "2022-05-19 - CrateDepression - Rust Supply-Chain Attack Infects Cloud CI Pipelines with Go Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535741,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653704156,
    "ts_modification_date": 1653704156,
    "files": {
        "pdf": "https://archive.orkl.eu/00169bc709851960153f36b6aa6c9e4674875807.pdf",
        "text": "https://archive.orkl.eu/00169bc709851960153f36b6aa6c9e4674875807.txt",
        "img": "https://archive.orkl.eu/00169bc709851960153f36b6aa6c9e4674875807.jpg"
    }
}