{
    "id": "a6765cbd-0d22-4e52-908c-eaee6fbda011",
    "created_at": "2023-01-12T15:07:35.476096Z",
    "updated_at": "2025-03-27T02:06:08.536586Z",
    "deleted_at": null,
    "sha1_hash": "f4633c5c27988abc291aa7c9a2d275b48e88bef2",
    "title": "2021-11-03 - Use EVTX files on VirusTotal with Timesketch and Sigma (Part1)",
    "authors": "",
    "file_creation_date": "2022-05-28T03:33:45Z",
    "file_modification_date": "2022-05-28T03:33:45Z",
    "file_size": 736616,
    "plain_text": "# Use EVTX files on VirusTotal with Timesketch and Sigma (Part1)\n\n**osdfir.blogspot.com/2021/11/use-evtx-files-on-virustotal-part1.html**\n\nAlexander Jäger\n\n## TDLR:\n\n[VirusTotal added a new feature to allow VirusTotal Enterprise customers to download Windows XML EventLog files (.evtx) for a sandbox](https://developers.virustotal.com/reference#file-behaviour-evtx)\nexecution of submitted samples. This article covers how this feature can help incident responders and digital forensic analysts develop\ndetections and how to use the new API to test an existing detection pipeline.\n\nOver the course of the article, tools like DFTimewolf, Plaso and Timesketch will be used.\n\n## Disclaimer\n\nMost of our other blog posts cover open source techniques. The API feature described in this post is part of a commercial offering from\n[VirusTotal and is not available to free tier accounts. Similar files could be created with Cuckoo Sandbox, an open source malware analysis](https://cuckoosandbox.org/)\nsystem.\n\n## Prerequisite\n\n[In order to follow this guide, we will need a running Timesketch server and docker on our local computer and installed DFTimewolf. In addition](https://timesketch.org/guides/admin/install/)\nwe need access to the private API of VirusTotal.\n\n## Context\n\nWindows EventLogs are an important source for incident response and digital forensics. Analysts usually extract events from the EVTX files to\nput them into timelines and use events to detect anomalous activity. Several open source tools are available to extract and parse EVTX files\n[and create timelines out of them (e.g. Plaso).](https://github.com/log2timeline/plaso)\n\nBesides EVTX data from real incidents, there are situations where analysts need EVTX files to test or improve tools or rules. To make or create\n[use of that data, analysts usually need access to a clean system. So if they want to create new signatures like Sigma rules that are based on](https://github.com/SigmaHQ/sigma)\nevent log entries, analysts have to either create mock entries or maintain a lab, execute a sample, capture event logs, parse them and then\nstart with writing detection rules.\n\nMaintaining such a lab environment comes with a cost. Cost or hardware or software, and time for maintenance are just the tip of the iceberg\nof these costs. Wouldn't it be handy to have a system where we can upload a sample, it would run and provide us with the event logs after the\nexecution?\n\n[VirusTotal has been a central point of collecting and executing samples since 2004 and its first sandbox reports were made available during](https://www.virustotal.com/)\n2012. which has helped analysts to create detection rules for malware. In 2021 VirusTotal added support for Sigma to show Sigma rule\nmatches against the EventLogs produced when samples are run. The VirusTotal team added a feature in October 2021 to enable users with\naccess to the private API to [download EVTX files for samples.](https://developers.virustotal.com/reference#file-behaviour-evtx)\n\n## VirusTotal API\n\nThe VirusTotal API has [two tiers, a private and a public. While the majority of API endpoints and information is freely available to registered](https://developers.virustotal.com/reference#public-vs-premium-api)\nusers, the private API is restricted to premium customers. The first one being free to any user and the other one is limited to Enterprise users.\n[The description of all the API endpoints and features can be found on the VirusTotal website.](https://developers.virustotal.com/v3.0/reference)\n\n## How can this be used with one sample?\n\nSay we want to create a detection rule in our environment for a given sample, the only thing we need to start with is the SHA-256 hash of the\nsample. With this hash, we can go to VirusTotal and download the EVTX file. For this example, we will have a look at one sample that we will\nfirst download manually to add it to Timesketch and after that a scalable method with DFTimewolf. For this we will focus on the following\nsample:\n\n[3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306. This sample was uploaded to VirusTotal on 2021-10-07 06:18:24](https://www.virustotal.com/gui/file/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306/detection)\nUTC and it’s VirusTotal report contains several hints on why it is bad, for example several hits on Sigma rules (which is only visible for\nenterprise VirusTotal users).\n\n\n-----\n\n## Getting the EVTX from VirusTotal\n\nThe first thing we do, for convenience, is to create an environment variable that contains our VirusTotal API key. We can find our API key\n[following: https://developers.virustotal.com/reference#getting-started. Copy that value and go to our shell:](https://developers.virustotal.com/reference#getting-started)\n\nexport VT_API_KEY=\"AAAAAAAAAAAA\"\n\nAnd do the same for the hash\n\nexport HASH=\"3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306\"\n\n## Search the sample on VirusTotal\n\nOk now let's check if the sample in question has EVTX data:\n\ncurl --header \"x-apikey: ${VT_API_KEY}\" \\\n\n[https://www.virustotal.com/api/v3/files/${HASH}/behaviours > ${HASH}.json](https://www.virustotal.com/api/v3/files/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306/behaviours)\n\n## Check if EVTX is available for the sample\n\nIn the response the \"has_evtx\" boolean needs to be checked using jq:\n\n$ cat ${HASH}.json | jq '.data[] | select(.attributes.has_evtx) | .links'\n\n{\n\n\"self\":\n\"https://www.virustotal.com/api/v3/file_behaviours/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306_VirusTotal\nZenBox\"\n\n}\n\n## Download and extract the EVTX\n\nFetch the EVTX ZIP file containing all EVTX files from the sandbox executions of that sample.\n\ncurl --location -v --request GET  --url \"https://www.virustotal.com/api/v3/file_behaviours/${HASH}_VirusTotal%20ZenBox/evtx\" --header \"xapikey: ${VT_API_KEY}\" -o ${HASH}_evtx.zip\n\nNow we have a zip that we can unpack, but first let's move the file in a sub directory..\n\nmkdir $HASH\n\nmv $HASH_evtx.zip $HASH\n\nUnzip\n\ncd $HASH\n\nunzip $HASH_evtx.zip\n\n## Process EVTX with Plaso\n\n\n-----\n\nNow we parse the EVTX file with Plaso (of course adjust the directory of our folder):\n\nusername@host:~/dev/vt_evtx /${HASH}$ docker run -v ~/dev/:/data log2timeline/plaso log2timeline --storage_file /data/vt_evtx/${HASH}.plaso\n/data/vt_evtx/${HASH}/\n\nThat will generate a .plaso file with an output similar to (output is trimmed):\n\nplaso - log2timeline version 20211024\n\nSource path : /data/vt_evtx/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306\n\nSource type : directory\n\nProcessing time : 00:00:06\n\nTasks:     Queued Processing   Merging     Abandoned    Total\n\n0    0        0        0        313\n\nIdentifier   PID   Status     Memory     Sources     Events     File\n\nMain      7    completed    152.4 MiB    313 (0)     14313 (0)\n\n[...]\n\nProcessing completed.\n\nNow if we do the following to check the number of events and more metadata:\n\ndocker run -v ~/dev/vt_evtx/:/data log2timeline/plaso pinfo /data/${HASH}.plaso\n\nThis will give us some indication of how many events have been parsed, if the number is very low, there might be issues:\n\n*************************** Plaso Storage Information ***************************\n\nFilename :\n\n3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306.plaso\n\nFormat version : 20210514\n\nStorage type : session\n\nSerialization format : json\n\n-------------------------------------------------------------------------------\n*********************************** Sessions ***********************************\n\n8a903a57-6e36-45dd-b03a-8e38359e3822 : 2021-10-22T14:21:38.407377Z\n\nc7847b56-3dd9-413f-8598-05183c22866b : 2021-10-22T14:23:05.795549Z\n\n-------------------------------------------------------------------------------\n******************************** Event sources *********************************\n\nTotal : 315\n\n-------------------------------------------------------------------------------\n************************* Events generated per parser **************************\n\n\n-----\n\na se (p ug ) a e u be o e e ts\n\n-------------------------------------------------------------------------------\nfilestat : 945\n\nwinevtx : 13374\n\nTotal : 14319\n\n-------------------------------------------------------------------------------\n## Ingest .plaso file to Timesketch\n\n[We want to ingest the Plaso file in Timesketch, an open source DFIR tool to collaborate on timelines.](https://github.com/google/timesketch)\n\nWe want to import the file with the Notebook shipped with Timesketch, as explained here:\n[https://github.com/google/timesketch/blob/master/docs/learn/notebook.md](https://github.com/google/timesketch/blob/master/docs/learn/notebook.md)\n\nVisit:\n\nhttp://localhost:8844/?token=timesketch\n\nBefore we continue, move the Plaso file that was just created to the tmp directory because the dev notebook only has read access to that\ndirectory.\n\ncp ${HASH}.plaso /tmp/\n\nWe can run the following in our notebook and see if our find the file:\n\n%ls -hall ${HASH}.plaso\n\n-rw-r----- 1 768470 89939 11M Oct 22 14:29 3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306.plaso\n\nWe might need to add read permissions to the Plaso file so the notebook is able to read it:\n\nchmod a+r /tmp/${HASH}.plaso\n\n[The following code makes use of the Timesketch import client and will upload the file to our sketch (make sure the celery workers are running)](https://github.com/google/timesketch/blob/master/docs/developers/api-upload-data.md#a-file-csv-plaso-or-jsonl)\n\nfrom timesketch_api_client import config\n\nfrom timesketch_import_client import importer\n\nts = config.get_client()\n\nmy_sketch = ts.get_sketch(2)\n\nwith importer.ImportStreamer() as streamer:\n\nstreamer.set_sketch(my_sketch)\n\nstreamer.set_timeline_name('3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306')\n\nstreamer.set_timestamp_description('VT_EVTX_3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306')\n\nstreamer.add_file('3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306.plaso')\n\nWhich will show up in Timesketch like following\n\n\n-----\n\nWe now have the timeline in Timesketch. We’ll leverage the Sigma module of Timesketch to write, test and adjust our Sigma rules against\nEventLogs that are generated when the sample that was run in the VirusTotal sandbox.\n\n[To read more how Sigma in Timesketch works, have a look at: https://osdfir.blogspot.com/2020/11/sigma-in-timesketch-lets-rule-sketch.html](https://osdfir.blogspot.com/2020/11/sigma-in-timesketch-lets-rule-sketch.html)\n\n## Automate the process\n\n[To not have to manually repeat all the steps previously mentioned a DFTimewolf recipe called vt_evtx is available to automate this.](https://github.com/log2timeline/dftimewolf)\nDFTimewolf is a free and open source tool that has integrations (among others) with Plaso and Timesketch.\n\nThe recipe is invoked like this:\n\ndftimewolf vt_evtx e2a24ab94f865caeacdf2c3ad015f31f23008ac6db8312c2cbfb32e4a5466ea2 /var/tmp/\n\nThat command will try to download the EVTX files for the hash. If we pass a SHA-256 hashes to the tool that are unknown to VirusTotal or do\nnot have an EVTX file to download, it will tell us. The only thing we need to add if we do not want to provide our API key in the command line\nargument is (or add –vt_api_key ${VT_API_KEY} in your dfTimewolf command):\n\ncat ~/.dftimewolfrc\n\n{\n\n\"vt_api_key”:”${VT_API_KEY}”\n\n}\n\n[2021-10-19 12:04:40,681] [dftimewolf     ] DEBUG  Logging to stdout and /tmp/dftimewolf.log\n\n[2021-10-19 12:04:40,682] [dftimewolf     ] SUCCESS Success!\n\n[2021-10-19 12:04:40,682] [dftimewolf     ] DEBUG  Recipe data path: ~/dev/dftimewolf/data\n\n[2021-10-19 12:04:40,682] [dftimewolf     ] DEBUG  Configuration loaded from: ~/dev/dftimewolf/data/config.json\n\n[2021-10-19 12:04:40,682] [dftimewolf     ] DEBUG  Configuration loaded from: ~/.dftimewolfrc\n\n[2021-10-19 12:04:40,704] [dftimewolf     ] INFO   Loading recipe vt_evtx...\n\n[2021-10-19 12:04:40,704] [dftimewolf     ] DEBUG  Loading module VTCollector from dftimewolf.lib.collectors.virustotal\n\n[2021-10-19 12:04:40,842] [dftimewolf     ] DEBUG  Loading module LocalPlasoProcessor from dftimewolf.lib.processors.localplaso\n\n[2021-10-19 12:04:40,844] [dftimewolf     ] INFO   Loaded recipe vt_evtx with 2 modules\n\n[2021-10-19 12:04:40,844] [dftimewolf     ] DEBUG  VTCollector:\n\n[2021-10-19 12:04:40,844] [dftimewolf     ] DEBUG   hashes\n'3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306,aaa,bbbb'\n\n[2021-10-19 12:04:40,845] [dftimewolf     ] DEBUG   vt_api_key  '${VT_API_KEY}'\n\n\n-----\n\n[ 0 0 9 0 0,8 5] [d t e o ] UG t_type e t\n\n[2021-10-19 12:04:40,845] [dftimewolf     ] DEBUG   directory  '/var/tmp/output22'\n\n[2021-10-19 12:04:40,845] [dftimewolf     ] DEBUG  LocalPlasoProcessor:\n\n[2021-10-19 12:04:40,845] [dftimewolf     ] DEBUG   timezone   None\n\n[2021-10-19 12:04:40,845] [dftimewolf     ] DEBUG\n\n[2021-10-19 12:04:40,845] [dftimewolf     ] INFO   Running preflights...\n\n[2021-10-19 12:04:40,845] [dftimewolf     ] INFO   Setting up modules...\n\n[2021-10-19 12:04:40,845] [dftimewolf     ] INFO   Setting up module: VTCollector\n\n[2021-10-19 12:04:40,846] [dftimewolf     ] INFO   Setting up module: LocalPlasoProcessor\n\n[2021-10-19 12:04:40,847] [dftimewolf     ] INFO   Modules successfully set up!\n\n[2021-10-19 12:04:40,847] [dftimewolf     ] INFO   Running modules...\n\n[2021-10-19 12:04:40,847] [dftimewolf     ] INFO   Running module: VTCollector\n\n[2021-10-19 12:04:40,848] [VTCollector     ] DEBUG  Trying to find\n3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306 on VirusTotal...\n\n[2021-10-19 12:04:42,598] [VTCollector     ] INFO   Found the following files on VT:\n\n['3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306']\n\n[2021-10-19 12:04:43,179] [VTCollector     ] INFO   evtx for 3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306:\nhttps%3A//www.virustotal.com/api/v3/file_behaviours/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306_VirusTotal%20Z\n\n[2021-10-19 12:04:43,179] [VTCollector     ] INFO   Download link\nhttps%3A//www.virustotal.com/api/v3/file_behaviours/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306_VirusTotal%20Z\n\n[2021-10-19 12:04:44,413] [VTCollector     ] DEBUG\n/var/tmp/output22/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306.evtx file extracted to\n/var/tmp/output22/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306.evtx_extract\n\n[2021-10-19 12:04:44,414] [VTCollector     ] INFO   Finished writing EVTX to\n/var/tmp/output22/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306.evtx_extract\n\n[2021-10-19 12:04:44,414] [dftimewolf     ] INFO   Module VTCollector finished execution\n\n[2021-10-19 12:04:44,414] [dftimewolf     ] INFO   Running module: LocalPlasoProcessor\n\n[2021-10-19 12:04:44,415] [LocalPlasoProcessor ] INFO   Log file: /tmp/tmptgy5m6jn/plaso.log\n\n[2021-10-19 12:04:44,415] [LocalPlasoProcessor ] INFO   Running external command: \"/usr/bin/log2timeline.py -q --status_view none -partition all --logfile /tmp/tmptgy5m6jn/plaso.log --storage_file /tmp/tmptgy5m6jn/826d057c4abe4c0e9a7aa4d6bf886063.plaso\n/var/tmp/output22/3c15384ccc84fb12fe4f95e46cff2dee24c991686d35871d5d3321d587605306.evtx_extract\"\n\n[2021-10-19 12:05:14,771] [dftimewolf     ] INFO   Module LocalPlasoProcessor finished execution\n\n[2021-10-19 12:05:14,772] [dftimewolf     ] INFO   Recipe vt_evtx executed successfully!\n\nAfter that execution, we have the final Plaso file:\n\n/tmp/tmptgy5m6jn/826d057c4abe4c0e9a7aa4d6bf886063.plaso\n\n[Which can be added to Timesketch and all other compatible tools very easily. To make it even easier, there is also a recipe called \"vt_evtx_ts\"](https://github.com/log2timeline/dftimewolf/blob/main/docs/user-manual.md#vt_pcap_ts)\nwhich will push the Plaso file directly to Timesketch.\n\n## Exploring the data in Timesketch\n\nIn Timesketch we can now start to explore the sketch and find interesting events e.g. by searching for\n\n*accepteula* AND *-ma* AND *lsass.exe*\n\n\n-----\n\n[The event matching this search term indicates execution of procdump to copy memory of lsass. This is a](https://car.mitre.org/analytics/CAR-2019-07-002/) [technique used by attackers to](https://attack.mitre.org/techniques/T1003/001/)\nretrieve passwords.\n\nIn [part two of this blog series, we will look into ways to use a VirusTotal EVTX file to test a Sigma rule and adjust Sigma config in Timesketch to](https://osdfir.blogspot.com/2021/11/use-evtx-files-on-virustotal-part2.html)\nmake the rule work.\n\n[If you have any questions please reach out on the Open Source DFIR Slack community.](https://github.com/open-source-dfir/slack)\n\n### Incident Response in the Cloud\n\n Parsing the $MFT NTFS metadata file\n\n Forensic Disk Copies in GCP & AWS\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-03 - Use EVTX files on VirusTotal with Timesketch and Sigma (Part1).pdf"
    ],
    "report_names": [
        "2021-11-03 - Use EVTX files on VirusTotal with Timesketch and Sigma (Part1).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536055,
    "ts_updated_at": 1743041168,
    "ts_creation_date": 1653708825,
    "ts_modification_date": 1653708825,
    "files": {
        "pdf": "https://archive.orkl.eu/f4633c5c27988abc291aa7c9a2d275b48e88bef2.pdf",
        "text": "https://archive.orkl.eu/f4633c5c27988abc291aa7c9a2d275b48e88bef2.txt",
        "img": "https://archive.orkl.eu/f4633c5c27988abc291aa7c9a2d275b48e88bef2.jpg"
    }
}