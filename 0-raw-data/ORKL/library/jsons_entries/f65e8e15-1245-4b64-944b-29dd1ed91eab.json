{
    "id": "f65e8e15-1245-4b64-944b-29dd1ed91eab",
    "created_at": "2023-01-12T15:02:41.730554Z",
    "updated_at": "2025-03-27T02:05:41.544151Z",
    "deleted_at": null,
    "sha1_hash": "d9d3b618f9119197820813522edd6e2b60ffd424",
    "title": "2019-04-02 - Triple Threat- Emotet Deploys Trickbot to Steal Data & Spread Ryuk",
    "authors": "",
    "file_creation_date": "2022-05-28T17:38:42Z",
    "file_modification_date": "2022-05-28T17:38:42Z",
    "file_size": 3790008,
    "plain_text": "# Triple Threat: Emotet Deploys TrickBot to Steal Data & Spread Ryuk\n\n**[cybereason.com/blog/triple-threat-emotet-deploys-trickbot-to-steal-data-spread-ryuk-ransomware](https://www.cybereason.com/blog/triple-threat-emotet-deploys-trickbot-to-steal-data-spread-ryuk-ransomware)**\n\nWritten By\nCybereason Nocturnus\n\nApril 2, 2019 | 15 minute read\n\n**Research by Noa Pinkas, Lior Rochberger, and Matan Zatz**\n\nCybereason’s [Active Monitoring and](https://www.cybereason.com/services/active-monitoring) [Hunting teams have uncovered a severe threat that](https://www.cybereason.com/services/active-hunting)\nuses the Emotet trojan and the TrickBot trojan to deliver the Ryuk ransomware. During the\npast few weeks, the Cybereason Active Monitoring team has encountered multiple incidents\nof attempted TrickBot infection. Among these incidents and investigations, the team\nobserved Ryuk ransomware infection attempts as well. The nature of Ryuk deployment and\n\n\n-----\n\nexecution tactics, techniques, and procedures can vary across incidents. However, the\nCybereason Active Monitoring team was able to identify that machines infected with TrickBot\nwere susceptible to a future infection with Ryuk.\n\nThough TrickBot is known as a banking trojan, in this campaign its banking capabilities are\none of many abilities. In this instance, it is able to communicate with a C2 server to collect\nand exfiltrate a range of sensitive data. It is also able to deploy the Ryuk ransomware, which\nencrypts files throughout the network and increases the damage to the end user. These\nthreats result in brand degradation, damage to an organization, and damage to the\nindividual.\n\n## Security Recommendations\n\nEducate your team on how to correctly handle suspicious emails to prevent initial\ndownloading or dropping of malware.\nIn order to protect against lateral movement, do not use privileged accounts, avoid\nRDPs without properly terminating the session, do not store passwords in plain text,\ndeploy good authentication practices, disable unnecessary share folders, and change\nthe names of the default share folders used in your organization.\n[Make sure you systems are patched, especially CVE-2017-0144, to prevent the](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0144)\npropagation of TrickBot and other malware.\n[Disable macros across the environment.](https://support.office.com/en-us/article/enable-or-disable-macros-in-office-files-12b036fd-d140-4e74-b45e-16fed1a7e5c6)\nFollow [Microsoft’s security advisory update on improving credentials protection and](https://support.microsoft.com/en-us/help/2871997/microsoft-security-advisory-update-to-improve-credentials-protection-a)\nmanagement in your organization.\nProactively approach security by performing hunts and searching for suspicious\nbehavior before an incident starts.\n\nRemove any persistence mechanisms that may have been used by any of the malware\nmentioned here in order to mitigate the threat.\n\nWorried about getting hit with an attack like this? Close the holes in your defense with MITRE\nATT&CK. Read our white paper to learn how.\n\n## WHAT IS Ryuk RANSOMWARE\n\n[Ryuk ransomware was first detected in August 2018 in targeted attacks through an unknown](https://www.cyber.nj.gov/threat-profiles/ransomware-variants/ryuk)\ninfection method. The ransomware scoped out a target, gained access via Remote Desktop\nServices or other direct methods, stole credentials, and then targeted high-profile data and\nservers to extort the highest ransom possible. By January 2019, an active campaign of the\nRyuk ransomware was discovered targeting victims who were previously attacked by\n[TrickBot Another recently discovered campaign of Emotet-TrickBot-Ryuk was used to deploy](https://www.crowdstrike.com/blog/big-game-hunting-with-ryuk-another-lucrative-targeted-ransomware/)\n\n\n-----\n\n[and initiate the Ryuk ransomware. That differs from the campaign mentioned in this](https://www.crowdstrike.com/blog/big-game-hunting-with-ryuk-another-lucrative-targeted-ransomware/)\nresearch, as this campaign describes each phase of the attack in detail, as well as the use of\nTrickBot to steal sensitive information before deploying Ryuk to ransom victims data.\n\n## WHAT IS TRICKBOT\n\nAlthough trojans typically target individuals to steal bank account credentials, the TrickBot\ntrojan was being used to deliver secondary malware in a similar way to what is detailed in\nthis research. The difference from the campaign mentioned in this research is that as this\ncampaign uses TrickBot to steal sensitive information, it also deploys Ryuk to ransom victims\ndata. Criminals targeting large enterprises used spam emails to deliver the Emotet trojan in\norder to distribute the TrickBot malware. Once a machine is infected with the TrickBot\nmalware, it begins to steal sensitive information and the criminal group tries to determine if\nthe company is an industry target. If so, they deliver the Ryuk ransomware.\n\n## WHAT IS EMOTET\n\nEmotet was discovered in 2014 and used as a trojan by threat actors to steal banking\ncredentials. More recently, it has been used as a dropper of other sophisticated malware.\nEmotet has introduced several advanced capabilities over the years using a modular\nstructure that features multiple modules including an installation module, a banking module,\nand a DDoS module. Emotet’s main distribution method remains phishing emails, which use\nvarious social engineering techniques to fool a user into clicking a malicious link or\ndownloading a malicious Microsoft Office file.\n\n## Phase One: Emotet Downloads TrickBot\n\n\n-----\n\n_Flow of the attack as Emotet delivers TrickBot, which delivers Ryuk. Workflow chart originally_\n_[created by the Kryptos Logic team for their blog on the same topic.](https://blog.kryptoslogic.com/malware/2019/01/10/dprk-emotet.html)_\n\nThe first stage of the attack starts with a weaponized Microsoft Office document attached to\na phishing email. This file contains a malicious, macro-based code. Once the user opens the\ndocument, the malicious file will run cmd and execute a PowerShell command. The\nPowerShell command attempts to download the Emotet payload.\n\n\n-----\n\n_Macro-embedded Microsoft Word document._\n\nIn recent attacks, Cybereason’s research team has spotted Emotet adapting in order to be\nused as a dropper for the TrickBot banking trojan. This is an expansion from its previous\ninformation-stealing capabilities.\n\nThe execution flow of Emotet starts within outlook.exe, where the phishing email was\nreceived. Following that, winword.exe opens the malicious attachment from the email and\nexecutes a cmd to run PowerShell. This command downloads and executes the Emotet\npayload.\n\n_The Emotet process tree in the Cybereason Platform._\n\nThis cmd instance has an obfuscated command line.\n\n\n-----\n\n_CMD Emotet dropper obfuscated command line._\n\nWhen deobfuscated in memory, the command line is translated into a Powershell script.\n\n\n-----\n\n_PowerShell Emotet dropper obfuscated command line._\n\nThe PowerShell instance attempts to download the Emotet payload from different malicious\ndomains after “building” the download URLs from multiple chunks. It names the payload\n379.exe (SHA1: B521fe7ff72e68165ff767d7dfa868e105d5de8b) and executes it.\n\nThe PowerShell script attempts to download the Emotet payload from the following domains:\n\nefreedommaker[.]com\nretro11legendblue[.]com\noussamatravel[.]com\ncashcow[.]ai\n\nshahdazma[.]com\n\n_The Cybereason Platform identifying the connection to the C2 server to download the Emotet_\n_payload._\n\nWhen the Emotet payload executes, it looks to continue its malicious activity by further\ninfecting and gathering information on the affected machine. It initiates the download and\nexecution of the TrickBot trojan by communicating with and downloading from a pre\n\n-----\n\nconfigured and remote malicious host.\n\n_The process tree of Emotet delivering TrickBot as seen in the Cybereason Platform._\n\n## Phase Two: Lateral Movement\n\nTrickBot is a modular trojan that unpacks itself in memory. It is often called a banking trojan,\nhowever, its modular structure allows it to freely add new functionalities outside of collecting\nbanking data. Collecting bank data is just one of its many potential modules.\n\nIn previous iterations, TrickBot was fairly simple. However, it has been improved over the\nyears to include extra modules advanced capabilities like password collecting and detection\nevasion.\n\nWhen TrickBot executes, it creates an installation folder under\n_C:\\user\\AppData\\Roaming\\%Name%, where %Name% is dependent on the bot version. This_\nfolder contains a copy of the malware with a slightly different name, a settings.ini file, and a\n_Data folder._\n\n_TrickBot’s installation folder._\n\n_settings.ini is an obfuscated file that contains an encoded BotKey. This BotKey is generated_\n[uniquely per machine. We were able to extract the BotKey and decrypt the modules and their](https://www.google.com/url?q=https://github.com/hasherezade/malware_analysis/tree/master/trickbot&sa=D&ust=1554143122701000)\nconfiguration files.\n\n\n-----\n\n_The contents of settings.ini._\n\nThe Data folder contains the encrypted malicious modules along with their configuration\nfiles.\n\n_The contents of the Data folder._\n\nIn order to ensure persistence, TrickBot creates a scheduled task and a service. The\nscheduled tasks name is dependent on the variant of the malware; in this case it is named\n\\NetvalTask.\n\n\n-----\n\n_TrickBot persistence using a scheduled task._\n\nThe service registry entry name is randomly generated and located under the services hive (\n\n_\\HKLM\\System\\CurrentControlSet\\Services\\{Random_name}\\imagePath)._\n\n_TrickBot persistence using the registry key._\n\nThe malicious modules are reflectively injected into legitimate processes including svchost in\norder to evade detection. In order to reduce the likelihood of being detected by an\nantimalware product, TrickBot tries to disable and delete Windows Defender.\n\n\n-----\n\n_The Cybereason Platform shows the process flow of how TrickBot disables Windows_\n_Defender._\n\n### Loading and Running TrickBot’s Malicious Modules\n\nThe malicious modules are reflectively loaded into svchost. Below are descriptions of the\nmodules and how they fit and fulfil their role in TrickBot’s malicious activity.\n\n_TrickBot modules reflectively loaded into svchost._\n\n**module64.dll**\n\n\n-----\n\nmodule64.dll is the TrickBot dropper. It downloads the TrickBot loader mswvc.exe (SHA1:\n_f84e0f022a0a263146e94ae3dd38cb5a8534fbfa) and installs it locally or shared on the_\nnetwork for lateral movement.\n\nNote: This writeup renames mswvc.exe to trickbot.exe to facilitate the understanding of the\nattack (SHA1: d6ee45108278bc13df1bdcc6280f4daba11e05c5).\n\nThe module makes a connection over HTTP to a hardcoded address. From there, it creates\na file locally with a payload masquerading as a PNG file. In this instance, the malware\nconnected and dumped the contents of the PNG file locally from\nhttp://192.161.54[.]60/radiance.png.\n\n_Connection to the distribution server and download of the payload as shown in the_\n_Cybereason Platform._\n\nThe module receives the contents of the PNG payload and writes it to a local file on the\nmachine. The module copies it to network shares to spread and improve lateral movement.\n\n_Network shares folders that TrickBot uses to spread._\n\nThe dropped file is registered as an auto-start service to give TrickBot persistence and a\nfoothold on the target machine. This service can have any one of the display names in the\nfigure below.\n\n\n-----\n\n_Service display names._\n\n_Service creation._\n\n**module.dll**\n\nmodule.dll steals data from the browser, including cookies, HTML5 local storage, browsing\nhistory, Flash Local Shared Objects, and URL hits. TrickBot injects module.dll into svchost,\nwhich creates a hidden virtual instance of the victim's desktop. It harvests browser data by\ncreating a tunnel and listening to the connections through other svchost processes that were\nalso injected with module.dll, and are listening on the same ports.\n\n_module.dll injected into svchost.exe._\n\n_Proxy tunneling of explorer browser._\n\n\n-----\n\n_Injected svchost listening on the same port._\n\nThis module uses different artifacts that store sensitive data including registry entry, browser\nplugins, and a hard-coded SQLite database that retrieves and steals data from locally stored\ndatabases.\n\n_Browser registry entries hard-coded into module.dll._\n\n_SQLite is used to retrieve and steal cookies._\n\n_Information gathering on the installed plugins._\n\nThe following images were also hardcoded in Base64-encoding in module.dll.\n\n\n-----\n\n_Base 64-decoded pictures._\n\n**vncsrv.dll**\n\n[TrickBot uses a hidden VNC injected into svchost.exe as a remote administration tool. The](https://en.wikipedia.org/wiki/Remote_access_trojan)\nVNC allows an attacker to remotely view and control a victim’s desktop without the victim\nnoticing.\n\nThe injected svchost, loaded with vncsrv.dll, spawns a Chrome browser instance. The\nbrowser instance launches with a command to alter the browsers default settings to evade\ndetection and bypass security defense mechanisms. In this case, it is the Chrome sandbox.\nIn order to evade detection additionally, TrickBot remains quiet and hidden from the user on\nthe victim machine by disabling any interaction with the user interface, including audio and\ngraphics. The hidden VNC leverages TrickBot’s foothold in order to simplify the process of\nlogging into the victim’s financial institution.\n\n_Setting interruption for the Chrome browser._\n\n**socks5dll.dll**\n\nIn previous iterations, this module communicated with the TrickBot C2 server using the socks\nprotocol to tunnel data and connections through the victim’s host. socks5 brings additional\nauthentication, so that only authorized users can access the proxy tunnel. socks5 supports\nthe tunneling of DNS requests, which eliminates the threat of DNS leaks. socks5dll.dll has\nhardcoded C2 servers that it will create an authenticated connection with.\n\n_The Cybereason Platform information on the TrickBot C2 server._\n\n\n-----\n\n_The connection to the TrickBot C2 server as shown in the Cybereason Platform._\n\nThe malware uses a user agent: Mozilla/5.0 (Windows; U; MSIE 9.0; Windows NT 9.0; enUS) to connect to one of the hard-coded TrickBot C2 IPs in socks5dll.dll:\n\n69.164.196[.]21\n107.150.40[.]234\n162.211.64[.]20\n217.12.210[.]54\n89.18.27[.]34\n193.183.98[.]154\n51.255.167[.]0\n91.121.155[.]13\n87.98.175[.]85\n\n185.97.7[.]7\n\n**systemInfo.dll**\n\nsystemInfo.dll helps the attacker determine if the affected machine meets the criteria for\ninfection with the Ryuk ransomware. TrickBot uses this module to harvest system information\noff of the infected machine to provide attackers with a better understanding of the system\nthey have infected. It uses [WQL to query win32_Processor and harvest information about](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows/desktop/wmisdk/wql-sql-for-wmi&sa=D&ust=1554143122716000)\nthe processor of the machine and the system architecture (whether it is 32-bit or 64-bit).\n\n\n-----\n\n_The use of WQL by systeminfo.dll._\n\n[TrickBot also uses native Windows API functions GetNativeSystemInfo() and](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getnativesysteminfo&sa=D&ust=1554143122717000)\n[GetSystemInfo() to get more information about the machine.](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getsysteminfo&sa=D&ust=1554143122718000)\n\n\n-----\n\n_The native Windows API being used to harvest information by systeminfo.dll._\n\n**mailsearcher.dll**\n\nmailsearcher.dll searches all files on disk and compares their extensions to a predefined list.\n\n\n-----\n\n_A predefined list of extensions the malware searches for._\n\n[mailsearcher.dll also uses the WinHTTP library in order to send data over HTTP to the C2](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows/desktop/winhttp/about-winhttp&sa=D&ust=1554143122720000)\nserver.\n\n\n-----\n\n_The use of the WinHttp library._\n\n**loader.dll**\n\nloader.dll’s purpose is solely to ensure that other modules will be successfully loaded\nreflectively.\n\n\n-----\n\n**pwgrab.dll**\n\npwgrab.dll harvests saved user credentials from browsers, registry keys, and other programs\nsuch as Outlook.\n\nTrickBot steals username and password information by copying login db, and steals card\ndetails by copying webdata db. All of the information stored is encrypted, so TrickBot uses a\ndecryption mechanism and saves the data as plain text.\n\n_TrickBot copying the Chrome database files._\n\n**core-dll.dll**\n\ncore-dll.dll is the main TrickBot bot. There are two layers of protection the malware must\nremove before it can be used. This module is encrypted and stored inside the loader as one\nof the resources. Following the decryption and unpacking, it is reflectively injected into the\nfollowing browsers to steal credentials.\n\n_The browsers targeted in core-dll.dll._\n\n_Exporting the reflective DLL injection library._\n\n\n-----\n\n### dll.dll\n\nTrickBot’s reverse-shell module, dll.dll, is responsible for two things. First, it performs\nreconnaissance in order to collect information about the target machine. Second, it launches\n[Powershell Empire to perform reconnaissance activities with the end goal of launching an](https://github.com/EmpireProject/Empire)\nEmpire backdoor. In order to initiate reconnaissance, TrickBot uses this DLL to run\ncommands such as ipconfig, net commands, and nltest.\n\n_A breakdown of the reconnaissance activity of TrickBot by the Cybereason Platform._\n\n_The floating module responsible for the reconnaissance activity._\n\n\n-----\n\nAs mentioned, TrickBot also uses PowerShell Empire to perform reconnaissance and lateral\nmovement. dll.dll is used to execute obfuscated PowerShell scripts in order to ultimately\ndownload and launch an Empire backdoor.\n\n[As part of its reconnaissance, TrickBot uses Invoke-Portscan to locate and detect valuable](https://github.com/EmpireProject/Empire/blob/master/data/module_source/situational_awareness/network/Invoke-Portscan.ps1)\nassets in the organization including domain controllers, file servers, and more. The collected\ndata will be used to target assets and infect them with the Ryuk ransomware.\n\n_A visualization of the PowerShell empire process tree by the Cybereason Platform._\n\n_The Top Port scan by the Cybereason Platform._\n\n**screenLocker_x64.dll**\n\n\n-----\n\nscreenLocker_x64.dll helps TrickBot with its reconnaissance and credential harvesting\nprocess. After being injected by TrickBot, svchost.exe was seen injecting into explorer.exe as\nwell.\n\n_svchost.exe injecting into explorer.exe._\n\nOne of the modules loaded into explorer.exe is one of TrickBot’s very own modules:\nscreenLocker_x64.dll.\n\n_Evidence of the screenLocker module being loaded by explorer.exe._\n\n[TrickBot uses a component of mimikatz to extract credentials from the target system. It](https://github.com/gentilkiwi/mimikatz)\ntargets WDigest credentials stored in LSA memory in plain text. Microsoft introduced a way\nto mitigate this attack by adding a switch in the form of a registry entry, and has addressed\nthis issue with [KB2871997 and](https://blogs.technet.microsoft.com/srd/2014/06/05/an-overview-of-kb2871997/) [KB2928120.](https://www.microsoft.com/en-us/download/details.aspx?id=42683)\n\nTo disable the storage of WDigest credentials in memory, the registry entry value must be set\nto 0. In order to ensure the tool succeeds in obtaining user credentials, it verifies that the\nregistry entry is enabled by setting it to 1.\n\nHowever, to successfully collect credentials, the user will have to log into the system after the\nregistry modification takes place so the credentials can be stored in memory. In order to\nensure this takes place, the module starts a routine that locks the users screen so they must\nenter their login credentials to gain access to the system.\n\n\n-----\n\n_The LockWorkStation function, which is in charge of locking the users screen._\n\nA hard-coded registry entry inside the module called WDigest contains the credentials\n(\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\Wdigest\\).\n\n_The WDigest registry entry._\n\nThe module contains a list of Microsoft operating systems to compare to the operating\nsystem of the infected machine while working its role in TrickBot’s activity.\n\n_A list of the operating systems inside the screen locker module._\n\n\n-----\n\nThe part in the module that is able to lock the workstation of an affected user is inside the\nfiles overlay. There is an indicator in the module that points to another file inside of it:\n\n_The overlay indicator._\n\nBy dumping the overlay of the module to a file and opening it in a hex editor, it’s possible to\nsee that the overlay contains the WDigest registry entry, as well as the process the module\nwill be injected into to fetch the users credentials (explorer.exe).\n\n_Contents of the dumped file opened in a hex editor._\n\n\n-----\n\n_A full flow visualized in the Cybereason Platform of the screenLocker_x64.dll module and_\n_related injections._\n\n**spreader_x64.dll**\n\nspreader_x64.dll contains two of the main capabilities of TrickBot: spreading by exploiting the\nEternalBlue vulnerability, and using mimikatz to perform credential theft.\n\nThe Cybereason Platform identified lsass access (the mimikatz activity of dumping the\nmemory of lsass.exe), floating executable code (the reflectively injected DLL\nspreader_x64.dll), and a high internal connection rate, which indicates that it is scanning in\norder to help spread.\n\n\n-----\n\n_Evidence of the malicious activity perpetrated by Spreader_64.dll, shown by the Cybereason_\n_Platform._\n\nspreader_x64.dll uses the EternalBlue vulnerability to spread via SMB (port 445).\n\n_A Cybereason Platform visualization of the connection via port 445 as part of EternalBlue._\n\n_EternalBlue strings in the spreader_x64.dll binary._\n\n\n-----\n\nspreader_x64.dll also contains the mimikatz binary. When executed, it dumps credentials by\nopening a command prompt window and run mimikatz.\n\nPwDumper_x64.dll is also reflectively injected into the svchost process in order to perform\nthe dumping.\n\n_PwDumper_x64.dll reflectively loaded into svchost.exe._\n\n_mimikatz strings in the spreader_x64.dll binary._\n\n\n-----\n\n_mimikatz strings in the spreader_x64.dll library._\n\n## Phase Three: Post-exploitation Activity\n\nOnce the machine is infected with TrickBot, the attackers check to see if the target machine\nis part of an industry they are looking to target. If it is, they download an additional payload\nand use the admin credentials stolen using TrickBot to perform lateral movement and reach\nthe assets they wish to infect.\n\nThe attacker logged into a domain controller and copied tools into a temporary directory. It\ncopied tools like AdFind.exe (the Active Directory enumeration utility), a bat script that uses\nAdFind to save output into text files, and a copy of the 7-Zip archive utility.\n\nAfter the attacker gathers a list of domain controllers and targeted servers in the\nenvironment, they test if there is a connection available using ping.exe and mstsc.exe\n(RDP).\n\nOnce the attacker has a connection, they start to spread the Ryuk payload through the\n[network via Windows administrative shares (MITRE ATT&CK Technique T1077). These are](https://attack.mitre.org/techniques/T1077/)\nhidden shares like Admin$, IPC$, Share$ and C$ that are enabled by default on Windows\nhosts for administrative purposes.\n\nThe attacker drops a few files in the hidden share share$, including a .bat script COPY.bat.\nThis script lists one or more of the targeted machines that the attacker located, a copy of\npsexec exe that is signed and verified and the Ryuk dropper Ryuk exe The attacker runs\n\n\n-----\n\nthe .bat script, which uses the psexec.exe file with the stolen admin credentials to gain a\nremote shell and copy the malicious Ryuk payload to a temporary folder in the remote hosts\nlisted in the text file comps{number}.txt.\n\n_Execution of the .bat script as shown in the Cybereason Platform._\n\n_The PsExec command line._\n\nOnce this is complete, the Ryuk payload is executed using PsExec.\n\n_The attack flow, beginning with the malicious email and ending with the Ryuk execution._\n\n\n-----\n\n## Ryuk Ransomware delivered\n\nThe ransomware dropper Ryuk.exe checks the system architecture and drops its main\npayload accordingly.\n\n_The Ryuk ransomware analysis: checking the system architecture._\n\nWhile dropping the payload, it generates a random name made up of five letters based on\nthe [Srand() function. The payload is stored under this name in a location dependent on the](https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/srand?view=vs-2017)\nOS version on the target machine. If the OS Version is XP or older, it writes a file at\n\\Documents and Settings\\Default User\\. If the target machine is running a newer version, it\nwrites a file at \\Users\\Public\\.\n\n_The Ryuk ransomware analysis: choosing the target folder._\n\nThe dropper also stops multiple services related to antimalware products by using the net\nstop command:\n\n\n-----\n\n_The Ryuk ransomware analysis: net stop commands._\n\nIt kills multiple processes related to the antimalware product using the taskkill command\n\n_The Ryuk ransomware analysis: taskkill commands._\n\nThe main Ryuk payload (hszuw.exe, SHA1:\n_d78c955173c447cb79fb559de122563d90d5358d) is responsible for injecting into other_\nprocesses and achieving persistence using the registry.\n\n\n-----\n\n_The Ryuk payload creates persistence, shown in the Cybereason Platform._\n\nThe registry key is under the Run hive, and named svchos. It is responsible for running the\nRyuk payload every time the current user logs on.\n\n_Creation of the registry key._\n\n[The malware creates a snapshot of all running processes using CreateToolhelp32Snapshot()](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows/desktop/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot&sa=D&ust=1554143122749000)\n[and iterates over it using Process32First()and Process32Next().](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows/desktop/api/tlhelp32/nf-tlhelp32-process32first&sa=D&ust=1554143122749000)\n\nThe malware then compares the handle of the process to the handle of lsass.exe, csrss.exe,\nand explorer.exe. If the handle is not one of the above, the malware injects the malicious\npayload into the remote process.\n\n\n-----\n\n_The Ryuk ransomware analysis: checking the running processes._\n\n_The Ryuk ransomware analysis: creating exceptions._\n\nIn this example, the payload was injected into several processes including taskhost.exe:\n\n\n-----\n\n_The Ryuk payload injects into the remote process taskhost.exe._\n\n_The floating PE in taskeng.exe._\n\nRyuk uses an injection technique, where it gets a handle of the target process using\n[OpenProcess()and allocates a buffer in its address space using VirtualAllocEx().](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-openprocess&sa=D&ust=1554143122753000)\n\n[Ryuk writes its current virtual content into this process using WriteProcessMemory() and](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-writeprocessmemory&sa=D&ust=1554143122754000)\n[creates a remote thread that will execute code using CreateRemoteThread().](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createremotethread&sa=D&ust=1554143122755000)\n\n\n-----\n\n_Functions used for process injection in the Ruyuk binary._\n\nThe injected processes, in this case taskhost.exe, run a .bat file dropped by the malware,\n[C:\\users\\Public\\window.bat. This file contains multiple uses of vssadmin and deletes](https://www.google.com/url?q=https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/vssadmin&sa=D&ust=1554143122756000)\ncommands in order to change configuration and delete Virtual Shadow Copy. vssadmin.exe\nis a command-line tool that manages Volume Shadow Copy Service (VSS), which captures\nand copies stable images for backup on running systems.\n\nRansomware commonly uses vssadmin.exe to delete shadow copies and other backups of\nfiles before encrypting the files themselves. This ensures that the victim will be forced to pay\nto decrypt the valuable files when they can neither be decrypted or retrieved from VSS.\n\n\n-----\n\n_The window.bat script spawns vssadmin commands, as shown in the Cybereason Platform._\n\nThe contents of window.bat:\n\n\n-----\n\n```\nvssadmin Delete Shadows /all /quiet\nvssadmin resize shadowstorage /for=c: /on=c: /maxsize=401MB\nvssadmin resize shadowstorage /for=c: /on=c: /maxsize=unbounded\nvssadmin resize shadowstorage /for=d: /on=d: /maxsize=401MB\nvssadmin resize shadowstorage /for=d: /on=d: /maxsize=unbounded\nvssadmin resize shadowstorage /for=e: /on=e: /maxsize=401MB\nvssadmin resize shadowstorage /for=e: /on=e: /maxsize=unbounded\nvssadmin resize shadowstorage /for=f: /on=f: /maxsize=401MB\nvssadmin resize shadowstorage /for=f: /on=f: /maxsize=unbounded\nvssadmin resize shadowstorage /for=g: /on=g: /maxsize=401MB\nvssadmin resize shadowstorage /for=g: /on=g: /maxsize=unbounded\nvssadmin resize shadowstorage /for=h: /on=h: /maxsize=401MB\nvssadmin resize shadowstorage /for=h: /on=h: /maxsize=unbounded\nvssadmin Delete Shadows /all /quiet\ndel /s /f /q c:\\*.VHD c:\\*.bac c:\\*.bak c:\\*.wbcat c:\\*.bkf c:\\Backup*.* c:\\backup*.*\nc:\\*.set c:\\*.win c:\\*.dsk\ndel /s /f /q d:\\*.VHD d:\\*.bac d:\\*.bak d:\\*.wbcat d:\\*.bkf d:\\Backup*.* d:\\backup*.*\nd:\\*.set d:\\*.win d:\\*.dsk\ndel /s /f /q e:\\*.VHD e:\\*.bac e:\\*.bak e:\\*.wbcat e:\\*.bkf e:\\Backup*.* e:\\backup*.*\ne:\\*.set e:\\*.win e:\\*.dsk\ndel /s /f /q f:\\*.VHD f:\\*.bac f:\\*.bak f:\\*.wbcat f:\\*.bkf f:\\Backup*.* f:\\backup*.*\nf:\\*.set f:\\*.win f:\\*.dsk\ndel /s /f /q g:\\*.VHD g:\\*.bac g:\\*.bak g:\\*.wbcat g:\\*.bkf g:\\Backup*.* g:\\backup*.*\ng:\\*.set g:\\*.win g:\\*.dsk\ndel /s /f /q h:\\*.VHD h:\\*.bac h:\\*.bak h:\\*.wbcat h:\\*.bkf h:\\Backup*.* h:\\backup*.*\nh:\\*.set h:\\*.win h:\\*.dsk\ndel %0\n\n```\nThe Cybereason Platform was able to raise an alert thanks to the suspicious behavior of the\ninjected taskhost.\n\n\n-----\n\n_An alert for ransomware in the Cybereason Platform._\n\nRyuk encrypts files on the disk and changes the extension to .RYK.\n\n_Ryuk changing the extensions of the files to .RYK._\n\nRyuk drops a ransom note RyukReadMe.txt created with notepad.exe in every processed\nfolder.\n\n_The creation of the ransom note._\n\n\n-----\n\n_The contents of the Ryuk ransom note._\n\n## Conclusion\n\nTrickBot is classified as a banking trojan, but the banking-related capability is just one of its\nmany abilities. TrickBot is able to communicate with a C2 server as well as collect and\nexfiltrate sensitive data ranging from banking credentials, usernames and passwords, and\npersonal data. An attacker with this information can easily destroy trust in a business, wreck\nthe reputation of a brand, or compromise individuals and cost companies money.\n\nOnce Ryuk infects the machine, it starts to encrypt files and spreads through the network to\ninfect more machines. This increases the damage and the likelihood that the victim will be\nwilling to pay the ransom. This threat, due to its advanced capabilities and spreading ability,\ncan cause a great deal of damage to an organization, from loss of money to brand\ndegradation.\n[Our customers were able to use our remediation tool of the Cybereason Platform to](https://www.cybereason.com/blog/cybereason-guided-remediation-a-tailored-approach-for-enhanced-incident-response)\nimmediately stop the exfiltration and prevent future execution of these kind of malicious files\nin the organization. Cybereason’s Active Monitoring team and Hunting team were able to\ndetect both the malicious file related to TrickBot and the operations and modules used to\nperform its activity. This includes reconnaissance, credential harvesting and spreading using\nthe PowerShell Empire framework, mimikatz, and EternalBlue. All of these activities work to\ndistribute and deliver an additional payload, in this instance the Ryuk ransomware.\n\nReduce the costs in your SOC by applying the right roles to SIEM and EDR. Read our white\npaper to learn how.\n\n\n-----\n\nAbout the Author\n\n**Cybereason Nocturnus**\n\nThe Cybereason Nocturnus Team has brought the world’s brightest minds from the military,\ngovernment intelligence, and enterprise security to uncover emerging threats across the\nglobe. They specialize in analyzing new attack methodologies, reverse-engineering malware,\nand exposing unknown system vulnerabilities. The Cybereason Nocturnus Team was the first\nto release a vaccination for the 2017 NotPetya and Bad Rabbit cyberattacks.\n\n[All Posts by Cybereason Nocturnus](https://www.cybereason.com/blog/authors/cybereason-nocturnus)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-04-02 - Triple Threat- Emotet Deploys Trickbot to Steal Data & Spread Ryuk.pdf"
    ],
    "report_names": [
        "2019-04-02 - Triple Threat- Emotet Deploys Trickbot to Steal Data & Spread Ryuk.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535761,
    "ts_updated_at": 1743041141,
    "ts_creation_date": 1653759522,
    "ts_modification_date": 1653759522,
    "files": {
        "pdf": "https://archive.orkl.eu/d9d3b618f9119197820813522edd6e2b60ffd424.pdf",
        "text": "https://archive.orkl.eu/d9d3b618f9119197820813522edd6e2b60ffd424.txt",
        "img": "https://archive.orkl.eu/d9d3b618f9119197820813522edd6e2b60ffd424.jpg"
    }
}