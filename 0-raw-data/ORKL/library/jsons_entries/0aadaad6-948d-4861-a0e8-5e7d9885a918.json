{
    "id": "0aadaad6-948d-4861-a0e8-5e7d9885a918",
    "created_at": "2023-01-12T15:06:04.704256Z",
    "updated_at": "2025-03-27T02:05:28.49458Z",
    "deleted_at": null,
    "sha1_hash": "cba2ad8c8db817ad40003530c412aee3a79143c5",
    "title": "2022-08-02 - Large-Scale AiTM Attack targeting enterprise users of Microsoft email services",
    "authors": "",
    "file_creation_date": "2022-08-18T03:56:04Z",
    "file_modification_date": "2022-08-18T03:56:04Z",
    "file_size": 1777773,
    "plain_text": "# Large-Scale AiTM Attack targeting enterprise users of Microsoft email services\n\n**[zscaler.com/blogs/security-research/large-scale-aitm-attack-targeting-enterprise-users-microsoft-email-services](https://www.zscaler.com/blogs/security-research/large-scale-aitm-attack-targeting-enterprise-users-microsoft-email-services)**\n\n## Summary\n\nThreatLabz has discovered a new strain of a large-scale phishing campaign, which uses\nadversary-in-the-middle (AiTM) techniques along with several evasion tactics. Similar AiTM\nphishing techniques were used in another phishing campaign described by Microsoft\n[recently here.](https://www.microsoft.com/security/blog/2022/07/12/from-cookie-theft-to-bec-attackers-use-aitm-phishing-sites-as-entry-point-to-further-financial-fraud/)\n\nIn June 2022, researchers at ThreatLabz observed an increase in the use of advanced\nphishing kits in a large-scale campaign. Through intelligence gathered from the Zscaler\ncloud, we discovered several newly registered domains that are used in an active\ncredential-stealing phishing campaign.\n\nThis campaign stands out from other commonly seen phishing attacks in several ways. It\nuses an adversary-in-the-middle (AiTM) attack technique capable of bypassing multi-factor\nauthentication. There are multiple evasion techniques used in various stages of the attack\ndesigned to bypass conventional email security and network security solutions.\n\nThe campaign is specifically designed to reach end users in enterprises that use Microsoft's\nemail services. Business email compromise (BEC) continues to be an ever-present threat to\norganizations and this campaign further highlights the need to protect against such attacks.\n\nIn this blog, we describe details of the tactics, techniques and procedures (TTPs) involved\nin the campaign.\n\n\n-----\n\nSince the campaign is active at the time of blog publication, the list of indicators of\ncompromise (IOCs) included at the end of the blog should not be considered an exhaustive\nlist.\n\n## Key points\n\nCorporate users of Microsoft's email services are the main targets of this large-scale\nphishing campaign.\n\nAll these phishing attacks begin with an email sent to the victim with a malicious link.\n\nThe campaign is active at the time of blog publication and new phishing domains are\nregistered almost every day by the threat actor.\n\nIn some cases, the business emails of executives were compromised using this\nphishing attack and later used to send further phishing emails as part of the same\ncampaign.\n\nSome of the key industry verticals such as FinTech, Lending, Insurance, Energy and\nManufacturing in geographical regions such as the US, UK, New Zealand and\nAustralia are targeted.\n\nA custom proxy-based phishing kit capable of bypassing multi-factor authentication\n(MFA) is used in these attacks.\n\nVarious cloaking and browser fingerprinting techniques are leveraged by the threat\nactor to bypass automated URL analysis systems.\n\nNumerous URL redirection methods are used to evade corporate email URL analysis\nsolutions.\n\nLegitimate online code editing services such as CodeSandbox and Glitch are abused\nto increase the shelf life of the campaign.\n\n## Phishing campaign overview\n\nBeginning in June 2022, ThreatLabz observed a sharp increase in advanced phishing\nattacks targeting specific industries and geographies.\n\nWe identified several newly registered domains set up by the threat actor to target Microsoft\nmail services' users.\n\n\n-----\n\nBased on our cloud data telemetry, the majority of the targeted organizations were in the\nFinTech, Lending, Finance, Insurance, Accounting, Energy and Federal Credit Union\nindustries. This is not an exhaustive list of industry verticals targeted.\n\nA majority of the targeted organizations were located in the United States, United Kingdom,\nNew Zealand, and Australia.\n\nAfter analyzing the large volume of domains used in this campaign, we identified some\ninteresting domain name patterns which we highlight below.\n\n### Domains spoofing Federal Credit Unions\n\nSome of the attacker-registered domains were typosquatted versions of legit Federal Credit\nUnions in the US.\n\n**Attacker-registered domain name** **Legit Federal Credit Union domain name**\n\ncrossvalleyfcv[.]org crossvalleyfcu[.]org\n\ntriboro-fcv[.]org triboro-fcu[.]org\n\ncityfederalcv[.]com cityfederalcu[.]com\n\nportconnfcuu[.]com portconnfcu[.]com\n\noufcv[.]com oufcu[.]com\n\n**Note: Per our analysis of the original emails using the Federal Credit Union theme, we**\nobserved an interesting pattern. These emails originated from the email addresses of the\nchief executives of the respective Federal Credit Union organizations. This indicates that\nthe threat actor might have compromised the corporate emails of chief executives of these\norganizations using this phishing attack and later used these compromised business emails\nto send further phishing emails as part of the same campaign.\n\n### Domains spoofing password reset theme\n\nSome of the domain names used keywords related to \"password reset\" and \"password\nexpiry\" reminders. This might indicate that the theme of the corresponding phishing emails\nwas also related to password reset reminders.\n\n\n-----\n\nexpiryrequest-mailaccess[.]com\n\nexpirationrequest-passwordreminder[.]com\n\nemailaccess-passwordnotice[.]com\n\nemailaccess-expirynotification[.]com\n\nIt is important to note that there are several other domains involved in this active campaign,\nsome of them are completely randomized while others do not conform to any specific\npattern.\n\n## Distribution mechanism\n\nWe have limited visibility into the emails used to distribute the phishing URLs. In some\ncases, the malicious links were sent directly in the email body; in other cases, the link was\npresent inside the HTML file attached to the email.\n\nFigure 1 below shows an email which contained an HTML attachment with the malicious\nphishing URL embedded inside it.\n\n_Figure 1: phishing email sent to the user with HTML attachment_\n\n\n-----\n\nFigure 2 below shows the contents of the HTML attachment. It uses\nwindow.location.replace() to redirect the user to the phishing page when the HTML page is\nopened with the browser.\n\n_Figure 2: HTML attachment used to redirect the user to the phishing page_\n\nFigure 3 below shows an example of a phishing email in which the attacker sent the\nmalicious link directly in the email body.\n\n_Figure 3: Malicious link present in the email body_\n\nWe observed the use of a variety of URL redirection methods in a large number of cases.\nInstead of sending the actual phishing URL in the email, the attacker would send links that\nused a variety of redirection methods to load the final phishing page URL. We describe the\ndetails of some of these methods in the following section.\n\n\n-----\n\n## Abuse of legitimate web resources for redirections\n\nPhishing sites were seen being delivered, redirected into, and hosted using numerous\nmethods.\n\nA common method of hosting redirection code is making use of web code editing/hosting\nservices: the attacker is able to use those sites, meant for legitimate use by web\ndevelopers, to rapidly create new code pages, paste into them a redirect code with the\nlatest phishing site’s URL, and proceed to mail the link to the hosted redirect code to victims\nen masse.\n\nThese services provide flexibility to the attackers, since the contents of the redirect codes\ncan be changed at any time. It has been observed that in the midst of a campaign,\nattackers will modify the code of a redirect page and update a phishing site’s URL that has\nbeen flagged as malicious, to a fresh undetected URL.\n\n[The most commonly abused service for this purpose is CodeSandbox.](https://codesandbox.io/)\n\nFigure 4 below shows the most common redirect code hosted on CodeSandbox, utilized by\nthe phishing site.\n\n_Figure 4: redirect code snippet on an attacker-controlled CodeSandbox instance_\n\n\n-----\n\nFigure 5 below shows an example of redirect code hosted on a similarly abused service [Glitch.](https://glitch.com/)\n\n_Figure 5: redirect code hosted on an attacker-controlled Glitch instance._\n\nMany dozens, if not hundreds, of different CodeSandbox code pages were observed\nhosting different redirect codes to the phishing sites.\n\nMany of those pages were authored by a network of registered CodeSandbox users,\nletting us see the names of the Google accounts used for their registration.\n\nWhile most Google accounts we could find are anonymous throwaway accounts that are a\ndead end to attribution efforts, an internet search of a few account names tie some of the\nauthors to older, more primitive phishing campaigns, and also show a history of engaging in\ncryptocurrency investment/recovery scams.\n\n[Another method observed for URL redirection is the abuse of Open Redirect pages hosted](https://cwe.mitre.org/data/definitions/601.html)\nby Google Ads and Snapchat. Figure 6 shows more details.\n\n\n-----\n\n_Figure 6: different methods of URL redirection abusing Open Redirect pages_\n\nBrowsing to these links will immediately redirect the client to the URL specified in the GET\nparameter highlighted in blue colour.\n\nThis method gives the attackers the benefit of being able to send emails with links pointing\nto these legitimate sites as the entry point, with the actual phishing sites’ addresses only\nappearing somewhere in the GET parameters, raising the likelihood of evading scanning of\nmalicious URLs performed by email clients.\n\n## Fingerprinting-based evasion\n\nThis campaign utilizes a client fingerprinting process on all phishing sites that we will cover\nin this article. This process happens immediately upon the page being visited.\n\n\n-----\n\nThe initial page clients are served consists of JavaScript code, ripped from the\n[FingerprintJS](https://github.com/fingerprintjs/fingerprintjs) project, whose purpose is to collect information from the client’s browser in\norder to help the site determine if the person behind the browser is in fact not an\nunsuspecting victim, but an unwelcome probing analyst or an automated bot.\n\nThe script gathers identifying information such as the client’s operating system, screen\ndimensions, and timezone, and communicates its findings back to the site by WebSocket\ntraffic. The complete list of information gathered from the client's machine is mentioned in\nthe Appendix at the end of the blog.\n\n_Figure 7: Client fingerprint data sent to the server over websocket_\n\nWith this information received, the site arrives at a verdict whether it should continue reeling\nin the client, or should it get rid of it by redirecting to the Google homepage.\n\nHow exactly the site decides this is unknown since the logic is present on the server side,\nbut it has been observed that browsers running in virtual machines are detected by\nexamining the name of the client’s graphics driver, as exposed by the [WebGL](https://developer.mozilla.org/en-US/docs/Web/API/WEBGL_debug_renderer_info) API.\n\nBy default, VirtualBox and VMware make themselves known this way, and require some\nmasking effort in order to pass this check, for example making use of browser setting\n`webgl.override-unmasked-renderer` on Firefox.\n\nIn case the site does not find a reason to suspect the client, it will serve it an authentication\ncookie that the client-side code will proceed to save before reloading the same page, this\ntime receiving the main phishing page by the site.\n\n\n-----\n\n_Figure 8: Upon successful fingerprint process, site returns authentication cookie __3vjQ._\n\n## Proxy-based AiTM phishing attack overview\n\nTraditional credential phishing sites collect the user's credentials and never complete the\nauthentication process with the actual mail provider's server. If the user has multi-factor\nauthentication (MFA) enabled, then it prevents the attacker from logging into the account\nwith only the stolen credentials.\n\nIn order to bypass multi-factor authentication, attackers can use Adversary-in-the-middle\n(AiTM) phishing attacks. All the attacks which we describe in this article used the AiTM\nphishing attack method.\n\nAiTM phishing attacks complete the authentication process with the actual mail provider's\nserver (in this case - Microsoft), unlike traditional credential phishing kits. They achieve this\nby acting as a MiTM proxy and relaying all the communication back-and-forth between the\nclient (victim) and the server (mail provider).\n\nThere are three main open-source AiTM phishing kits available which are widely known in\nthe community.\n\nEvilginx2\nMuraena\nModlishka\n\nBased on our research, we believe that the threat actor in this case used a custom phishing\nkit. In the following section, we highlight some of the unique attributes we identified in the\nclient-server communication which differs from the common off-the-shelf AiTM phishing kits.\n\nWe will not cover the technical details of how the AiTM phishing kits work in general since\n[they are widely documented in the public domain such as here.](https://www.microsoft.com/security/blog/2022/07/12/from-cookie-theft-to-bec-attackers-use-aitm-phishing-sites-as-entry-point-to-further-financial-fraud/)\n\n\n-----\n\n## Unique attributes of the phishing kit\n\nAll advanced AiTM kits have in common that they operate as a proxy between the victim\nand the target site (Microsoft servers in our case).\n\nThe kits intercept the HTML content received from the Microsoft servers, and before\nrelaying it back to the victim, the content is manipulated by the kit in various ways as\nneeded, to make sure the phishing process works.\n\nWe observed several ways in which the phishing kit’s operation is distinguishable from the\nthree open-source kits:\n\n### HTML parsing\n\nIt’s apparent that the phishing kit’s backend is making use of an HTML parser library, such\nas Beautiful Soup.\n\nWe can deduce this by comparing the messy, unindented HTML code arriving from\nMicrosoft:\n\nAnd the same HTML code as relayed by the phishing kit, tidied up and properly indented:\n\nIt is likely that the phishing kit feeds the HTML it reads from the Microsoft server into an\nHTML parser, which creates a programmatic representation of the entire HTML tree. This\nallows a programmer to conveniently manipulate the different elements by interacting with\nthe objects that represent them.\n\nOnce the manipulation is done, the library produces an HTML output of the tree with all\nchanges applied. This often results in a tidy output, as we see above.\n\n\n-----\n\nThe three open-source kits don t make use of HTML parsers, instead operating on the\nreceived HTML data just by using basic string operations.\n\n### Domain translation\n\nOne of the things the kits need to take care of is replacing all the links to the Microsoft\ndomains with equivalent links to the phishing domain, so that the victim remains\ncommunicating with the phishing site throughout the phishing session.\n\nFor example, Figure 9 below shows a side-by-side comparison of an HTML snippet. On the\nleft is the original code as served by Microsoft, and on the right is the same code after it has\nundergone translation, on its way to be relayed to the victim.\n\n_Figure 9: HTML snippets before and after translation_\n\nThe original subdomain (green), the original domain name (blue, minus the TLD), and a\nunique generated ID (pink) are joined together with dashes and become a subdomain under\nthe phishing site’s domain (orange).\n\nThis translation pattern, namely the 8 hexadecimal digits ID added to links, appears unique\nto this phishing kit, and is not used by the three open-source kits.\n\nHowever, there’s a case where this translation is not taking place.\n\nThe Office 365 login page, as part of a feature called “Azure Active Directory Seamless\nSingle Sign-On”, communicates with Microsoft server `autologon.microsoftazureadsso.com` in order to load company-specific scripts to offer this feature to the authenticating\nclient.\n\nThe references to this server can be seen in this snippet of JavaScript, taken from the main\nOffice 365 login page:\n\nFor one reason or another, the phishing kit does not perform translation on the links to\n`autologon.microsoftazuread-sso.com` shown above, and they make their way to the\nvictims intact.\n\n\n-----\n\nThis results in the victim s browser performing HTTP requests like the following, while\nloading the login page:\n\nEffectively “leaking” the phishing site’s address as the referring site inside a request to the\nMicrosoft server.\n\nThis opens up the possibility of detecting the kit in the act, if a victim’s HTTP traffic is\nmonitored by network security solutions capable of deep packet inspection.\n\n## Post-compromise activity\n\nTo investigate the post-compromise activity, we set up an Azure AD instance in our lab with\na dummy account and a domain controlled by us. We visited one of the live phishing URLs,\nsupplied dummy account credentials, and completed the multi-factor authentication\nprocess.\n\nIn one case, we observed that the attacker logged into our account, 8 minutes after we sent\nour credentials to the attacker's server. It is important to note that the attacker logged into\nthe account from another IP address (different from the phishing domain's IP address).\nBased on the delay of 8 minutes in post-compromise activity, we suspect that the threat\nactor is manually logging into the account.\n\nFigure 10 below shows audit / sign-in logs from our lab's Azure AD highlighting the postcompromise activity.\n\n_Figure 10: Azure AD sign-in logs highlighting post-compromise activity_\n\n\n-----\n\nAt the time of our investigation, we did not see any specific post-compromise activity\nperformed by the threat actor besides merely logging into the account, reading emails and\nchecking the user's profile information.\n\n## Zscaler’s detection status\n\nZscaler’s multilayered cloud security platform detects indicators at various levels, as seen\nhere:\n\n[HTML.Phish.Microsoft](https://threatlibrary.zscaler.com/?keyword=HTML.Phish.Microsoft)\n\n## Conclusion\n\nBusiness email compromise (BEC) continues to be one of the top threats which\norganizations need to protect against. As described in this blog, the threat actors are\nconstantly updating their tactics, techniques and procedures (TTPs) to bypass various\nsecurity measures.\n\nEven though security features such as multi-factor authentication (MFA) add an extra layer\nof security, they should not be considered as a silver bullet to protect against phishing\nattacks. With the use of advanced phishing kits (AiTM) and clever evasion techniques,\nthreat actors can bypass both traditional as well as advanced security solutions.\n\nAs an extra precaution, users should not open attachments or click on links in emails sent\nfrom untrusted or unknown sources. As a best practice, in general, users should verify the\nURL in the address bar of the browser before entering any credentials.\n\nThe Zscaler ThreatLabz team will continue to monitor this active campaign, as well as\nothers, to help keep our customers safe.\n\n## Indicators of compromise\n\n# Since the campaign is active at time of the publication and this threat actor is relentless in\ncreating new domains almost every day, the IOCs below should not be considered as an\nexhaustive list.\n\nThe complete list of IOCs can be found at our GitHub repository\nhere: [https://github.com/threatlabz/iocs/blob/main/aitm_phishing/iocs.txt](https://github.com/threatlabz/iocs/blob/main/aitm_phishing/iocs.txt)\n\n## Appendix\n\n**Client fingerprint collected**\n\n\n-----\n\n{u data : {u appCodeName : <string>,\nu'appName': <string>,\n\nu'audioCodecs': {u'aac': <string>,\n\nu'm4a': <string>,\n\nu'mp3': <string>,\n\nu'ogg': <string>,\n\nu'wav': <string>},\n\nu'automation': [<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>,\n\n<boolean>],\n\nu'battery': <boolean>,\n\nu'cookieEnabled': <boolean>,\n\nu'debugTool': <boolean>,\n\nu'devtools': <boolean>,\n\nu'document': {u'characterSet': <string>,\n\nu'charset': <string>,\n\nu'compatMode': <string>,\n\nu'contentType': <string>,\n\nu'designMode': <string>,\n\nu'hidden': <boolean>,\n\nu'inputEncoding': <string>,\n\nu'isConnected': <boolean>,\n\nu'readyState': <string>,\n\nu'referrer': <string>,\n\nu'title': <string>,\n\nu'visibilityState': <string>},\n\nu'etsl': <integer>,\n\n\n-----\n\nu hardwareConcurrency : <integer>,\nu'hasChrome': <boolean>,\n\nu'javaEnabled': <boolean>,\n\nu'language': <string>,\n\nu'languages': [<string>, <string>],\n\nu'mediaSession': <boolean>,\n\nu'mimeTypes': [<string>, <string>],\n\nu'multimediaDevices': {u'micros': <integer>,\n\nu'speakers': <integer>,\n\nu'webcams': <integer>},\n\nu'permissions': {u'accelerometer': <string>,\n\nu'ambient-light-sensor': <string>,\n\nu'ambient_light_sensor': <string>,\n\nu'background-fetch': <string>,\n\nu'background-sync': <string>,\n\nu'background_fetch': <string>,\n\nu'background_sync': <string>,\n\nu'bluetooth': <string>,\n\nu'camera': <string>,\n\nu'clipboard-write': <string>,\n\nu'clipboard_write': <string>,\n\nu'device-info': <string>,\n\nu'device_info': <string>,\n\nu'display-capture': <string>,\n\nu'display_capture': <string>,\n\nu'geolocation': <string>,\n\nu'gyroscope': <string>,\n\nu'magnetometer': <string>,\n\nu'microphone': <string>,\n\nu'midi': <string>,\n\nu'nfc': <string>,\n\nu'notifications': <string>,\n\nu'persistent-storage': <string>,\n\nu'persistent_storage': <string>,\n\nu'push': <string>,\n\nu'speaker-selection': <string>,\n\nu'speaker_selection': <string>},\n\nu'platform': <string>,\n\nu'plugins': [<string>,\n\n<string>,\n\n<string>,\n\n<string>,\n\n\n-----\n\n<string>],\nu'referrer': <string>,\n\nu'screen': {u'cHeight': <integer>,\n\nu'cWidth': <integer>,\n\nu'orientation': <string>,\n\nu'sAvailHeight': <integer>,\n\nu'sAvailWidth': <integer>,\n\nu'sColorDepth': <integer>,\n\nu'sHeight': <integer>,\n\nu'sPixelDepth': <integer>,\n\nu'sWidth': <integer>,\n\nu'wDevicePixelRatio': <integer>,\n\nu'wInnerHeight': <integer>,\n\nu'wInnerWidth': <integer>,\n\nu'wOuterHeight': <integer>,\n\nu'wOuterWidth': <integer>,\n\nu'wPageXOffset': <integer>,\n\nu'wPageYOffset': <integer>,\n\nu'wScreenX': <integer>},\n\nu'serviceWorker': <boolean>,\n\nu'timezone': <string>,\n\nu'userAgent': <string>,\n\nu'vendor': <string>,\n\nu'videoCodecs': {u'h264': <string>,\n\nu'ogg': <string>,\n\nu'webm': <string>},\n\nu'visitorId': <string>,\n\nu'webRTC': <boolean>,\n\nu'webXR': <boolean>,\n\nu'webgl': <string>},\n\nu'ftype': <string>}\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-08-02 - Large-Scale AiTM Attack targeting enterprise users of Microsoft email services.pdf"
    ],
    "report_names": [
        "2022-08-02 - Large-Scale AiTM Attack targeting enterprise users of Microsoft email services.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535964,
    "ts_updated_at": 1743041128,
    "ts_creation_date": 1660794964,
    "ts_modification_date": 1660794964,
    "files": {
        "pdf": "https://archive.orkl.eu/cba2ad8c8db817ad40003530c412aee3a79143c5.pdf",
        "text": "https://archive.orkl.eu/cba2ad8c8db817ad40003530c412aee3a79143c5.txt",
        "img": "https://archive.orkl.eu/cba2ad8c8db817ad40003530c412aee3a79143c5.jpg"
    }
}