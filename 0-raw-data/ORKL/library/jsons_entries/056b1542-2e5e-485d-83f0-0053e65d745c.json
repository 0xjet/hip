{
    "id": "056b1542-2e5e-485d-83f0-0053e65d745c",
    "created_at": "2023-01-12T15:08:34.242663Z",
    "updated_at": "2025-03-27T02:05:32.673379Z",
    "deleted_at": null,
    "sha1_hash": "1c77d13e56fddf46c184c641c15e5780d4e65559",
    "title": "2017-10-31 - Analyzing malware by API calls",
    "authors": "",
    "file_creation_date": "2022-05-27T19:59:05Z",
    "file_modification_date": "2022-05-27T19:59:05Z",
    "file_size": 128448,
    "plain_text": "# Analyzing malware by API calls\n\n**[blog.malwarebytes.com/threat-analysis/2017/10/analyzing-malware-by-api-calls/](https://blog.malwarebytes.com/threat-analysis/2017/10/analyzing-malware-by-api-calls/)**\n\nPieter Arntz October 31, 2017\n\nOver the last quarter, we’ve seen an increase in malware using packers, crypters, and\nprotectors—all methods used to obfuscate malicious code from systems or programs\nattempting to identify it. These packers make it very hard, or next to impossible to perform\n[static analysis. The growing number of malware authors using these protective packers has](https://www.malwarebytes.com/malware/)\ntriggered an interest in alternative methods for malware analysis.\n\nLooking at API calls, or commands in the code that tell systems to perform certain\noperations, is one of those methods. Rather than trying to reverse engineer a protectively\npacked file, we use a dynamic analysis based on the performed API calls to figure out what a\ncertain file might be designed to do. We can determine whether a file may be malicious by its\nAPI calls, some of which are typical for certain types for malware. For example, a typical\n[downloader API is URLDownloadToFile. The API](https://msdn.microsoft.com/en-us/library/ms775123(v=vs.85).aspx) [GetWindowDC is typical for the screen-](https://msdn.microsoft.com/en-us/library/windows/desktop/dd144947(v=vs.85).aspx)\ngrabbers we sometimes see in spyware and keyloggers.\n\nLet’s look at an example to clarify how this might be helpful.\n\n## Trojan example\n\n[Our example is a well-known Trojan called 1.exe with SHA256](https://www.malwarebytes.com/trojan/)\n[0213b36ee85a301b88c26e180f821104d5371410ab4390803eaa39fac1553c4c](https://www.virustotal.com/#/file/0213b36ee85a301b88c26e180f821104d5371410ab4390803eaa39fac1553c4c/detection)\n\n\n-----\n\nThe file is packed (with VMProtect), so my disassembler doesn t really know where to start.\nSince I’m no expert in reverse engineering, I will try to figure out what the file does by looking\nat the API calls performed during the sandboxed execution of the file.\n\nThis is the list of calls that we got from the sandbox (Deepviz):\n\nFor starters, let’s have a look at what all these functions do. Here’s what I found out about\nthem on Microsoft:\n\n[GetModuleHandle function](https://msdn.microsoft.com/nl-nl/library/windows/desktop/ms683199(v=vs.85).aspx)\n\nRetrieves a module handle for the specified module. The module must have been loaded by\nthe calling process. GetModuleHandleA (ANSI)\n\n[GetProcAddress function](https://msdn.microsoft.com/nl-nl/library/windows/desktop/ms683212(v=vs.85).aspx)\n\nRetrieves the address of an exported function or variable from the specified dynamic-link\nlibrary (DLL).\n\n[_wtoi](https://msdn.microsoft.com/en-us/library/yd5xkb5c.aspx)\n\nConvert a string to integer.\n\n[CreateStreamOnHGlobal function](https://msdn.microsoft.com/nl-nl/library/windows/desktop/aa378980(v=vs.85).aspx)\n\nThis function creates a stream object that uses an HGLOBAL memory handle to store the\nstream contents. This object is the OLE-provided implementation of the IStream interface.\n\n[StrStr function](https://msdn.microsoft.com/en-us/library/windows/desktop/bb773436(v=vs.85).aspx)\n\n\n-----\n\nFinds the first occurrence of a substring within a string. The comparison is case-sensitive.\nStrStrA (ANSI)\n\n[wsprintf function](https://msdn.microsoft.com/en-us/library/windows/desktop/ms647550(v=vs.85).aspx)\n\nWrites formatted data to the specified buffer. Any arguments are converted and copied to the\noutput buffer according to the corresponding format specification in the format string.\nwsprintfA (ANSI)\n\n[WinHttpOpen function](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384098(v=vs.85).aspx)\n\nThis function initializes, for an application, the use of WinHTTP functions and returns a\nWinHTTP-session handle.\n\n[GetModuleFileName function](https://msdn.microsoft.com/nl-nl/library/windows/desktop/ms683197(v=vs.85).aspx)\n\nRetrieves the fully qualified path for the file that contains the specified module. The module\nmust have been loaded by the current process. GetModuleFileNameW (Unicode)\n\n[LoadLibrary function](https://msdn.microsoft.com/nl-nl/library/windows/desktop/ms684175(v=vs.85).aspx)\n\nLoads the specified module into the address space of the calling process. The specified\nmodule may cause other modules to be loaded. LoadLibraryA (ANSI)\n\n[LocalAlloc function](https://msdn.microsoft.com/nl-nl/library/windows/desktop/aa366723(v=vs.85).aspx)\n\nAllocates the specified number of bytes from the heap.\n\n[LocalFree function](https://msdn.microsoft.com/nl-nl/library/windows/desktop/aa366730(v=vs.85).aspx)\n\nFrees the specified local memory object and invalidates its handle.\n\n[GetModuleFileName function](https://msdn.microsoft.com/nl-nl/library/windows/desktop/ms683197(v=vs.85).aspx)\n\nRetrieves the fully qualified path for the file that contains the specified module. The module\nmust have been loaded by the current process. GetModuleFileNameA (ANSI)\n\n[ExitProcess function](https://msdn.microsoft.com/nl-nl/library/windows/desktop/ms682658(v=vs.85).aspx)\n\nEnds the calling process and all its threads.\n\n## The key malicious indicators\n\nNot all of the functions shown above are indicative of the nature of an executable. But the\nAPI WinHttpOpen tells us that we can expect something in that area.\n\n[Following up on this function, we used URL Revealer by Kahu Security to check the](http://www.kahusecurity.com/tag/urlrevealer/)\ndestination of the traffic and found two URLs that were contacted over and over again\n\n\n-----\n\nGET http://twitter.com/pidoras6\n\nPOST http://www.virustotal.com/vtapi/v2/file/scan\n\nThis POST is what the [VirusTotal API expects when you want to submit a file for a scan.](https://www.virustotal.com/nl/documentation/public-api/)\n\nThe link to an old and abandoned Twitter handle was a bigger mystery, until I decided to use\nthe Advanced Search in Twitter and found this Tweet that must have been removed later on.\n\nIn base64, this Tweet says: [https://w0rm.in/join/join.php. Unfortunately that site no longer](https://web.archive.org/web/20150104200316/http:/w0rm.in:80/join/)\nresolves, but it used to be an underground board where website exploits were offered along\nwith website hacking services around the same time the aforementioned Twitter profile was\nactive.\n\nThis was a dead end on trying to figure out what the malware was trying to GET. So we tried\nanother approach by figuring out what it was trying to scan at VirusTotal and used Wireshark\nto take a look at the packets.\n\n\n-----\n\nIn the packet, you can see the API key and the filename that were used to scan a file at the\nVirusTotal site. So, reconstructing from the API calls and from the packets we learned that\nthe malware was submitting copies of itself to VirusTotal, which is typical behavior for the\nVflooder family of Trojans. Vflooder is a special kind of Flooder Trojan. Flooder Trojans are\ndesigned to send a lot of information to a specific target to disrupt the normal operations of\nthe target. But I doubt this one was ever able to make a dent in the VirusTotal infrastructure.\nOr the one on Twitter for that matter.\n\nThe Vflooder Trojan is just a small and relatively simple example of analyzing API calls. It’s\nnot always that easy: We’ve even seen malware that added redundant/useless API calls just\nto [obfuscate the flow. But analyzing API calls is a method to consider for detecting malware](https://blog.malwarebytes.com/threat-analysis/2016/11/floki-bot-and-the-stealthy-dropper/)\ntrying to hide itself. Just keep in mind that the bad guys are aware of it too.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-10-31 - Analyzing malware by API calls.pdf"
    ],
    "report_names": [
        "2017-10-31 - Analyzing malware by API calls.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536114,
    "ts_updated_at": 1743041132,
    "ts_creation_date": 1653681545,
    "ts_modification_date": 1653681545,
    "files": {
        "pdf": "https://archive.orkl.eu/1c77d13e56fddf46c184c641c15e5780d4e65559.pdf",
        "text": "https://archive.orkl.eu/1c77d13e56fddf46c184c641c15e5780d4e65559.txt",
        "img": "https://archive.orkl.eu/1c77d13e56fddf46c184c641c15e5780d4e65559.jpg"
    }
}