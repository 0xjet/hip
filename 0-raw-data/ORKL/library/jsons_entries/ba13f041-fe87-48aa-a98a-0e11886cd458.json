{
    "id": "ba13f041-fe87-48aa-a98a-0e11886cd458",
    "created_at": "2024-07-20T02:06:15.770442Z",
    "updated_at": "2025-03-27T02:05:59.690573Z",
    "deleted_at": null,
    "sha1_hash": "80895a16d670b4de10670a024e18b0239d6b7c35",
    "title": "",
    "authors": "",
    "file_creation_date": "2013-09-09T11:23:44Z",
    "file_modification_date": "2013-09-09T11:23:50Z",
    "file_size": 1859856,
    "plain_text": "# HESPERBOT\n\n## A New, Advanced Banking Trojan in the Wild\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\n### Hesperbot – A New, Advanced Banking Trojan in the Wild\n\n_A new and effective banking trojan has been discovered targeting online_\n\n_banking users in Turkey, the Czech Republic, Portugal and the United_\n\n_Kingdom. It uses very credible-looking phishing-like campaigns, related to_\n\n_trustworthy organizations, to lure victims into running the malware._\n\n#### The Story\n\nIn the middle of August we discovered a malware-spreading\n\ncampaign in the Czech Republic. Our interest was first kindled by the\n\nsite that the malware was hosted on – a domain that passed itself\n\noff as belonging to the Czech Postal Service – but more interesting\n\nfindings followed.\n\nAnalysis of the threat revealed that we were dealing with a banking\n\ntrojan, with similar functionality and identical goals to the infamous\n\nZeus and SpyEye, but significant implementation differences\n\nindicated that this is a new malware family, not a variant of a\n\npreviously known trojan.\n\nDespite being a “new kid on the block”, it appears that Win32/Spy.\n\nHesperbot is a very potent banking trojan which features common\n\nfunctionalities, such as keystroke logging, creation of screenshots\n\nand video capture, and setting up a remote proxy, but also includes\n\nsome more advanced tricks, such as creating a hidden VNC server\n\non the infected system. And of course the banking trojan feature list\n\nwouldn’t be complete without network traffic interception and HTML\n\ninjection capabilities. Win32/Spy.Hesperbot does all this in quite a\n\n\nWhen comparing the Czech sample to known malware in our\n\ncollection, we discovered that we had already been detecting earlier\n\nvariants generically as Win32/Agent.UXO for some time and that\n\nonline banking users in the Czech Republic weren’t the only ones\n\ntargeted by this malware. Banking institutions in Turkey and Portugal\n\nwere also being targeted.\n\nThe aim of the attackers is to obtain login credentials giving access\n\nto the victim’s bank account and to get them to install a mobile\n\ncomponent of the malware on their Symbian, Blackberry or Android\n\nphone. Keep reading for details on the malware spreading campaigns,\n\ntheir targets and for technical details on the trojan.\n\n#### The Campaigns Timeline\n\nThe Czech malware-spreading campaign started on August 8, 2013.\n\nThe perpetrators have registered the domain www.ceskaposta.net,\n\nwhich is very close to the real website of the Czech Postal Service,\n\n_[www.ceskaposta.cz.](http://www.ceskaposta.cz/)_\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nFigure 2 - Compilation timestamp of malware used in the Czech campaign\n\nThe domain was registered on August 7, 2013 and the first malware\n\nHesperbot binaries (detected as Win32/Agent.UXO at first) distributed\n\nin the Czech Republic were compiled on the morning of August 8,\n\n2013 and picked up by our LiveGrid® system moments later.\n\nIt’s probably not surprising that the attackers tried to lure potential\n\nvictims into opening the malware by sending emails which looked as\n\nparcel tracking information from the Postal Service. This technique\n\n[has been used many times before (e.g. here and here). The filename](http://www.welivesecurity.com/2013/03/08/sinkholing-trojan-downloader-zortob-b-reveals-fast-growing-malware-threat/)\n\nused was zasilka.pdf.exe: “zasilka” means mail in Czech. The link in\n\n[the email showed the legitimate www.ceskaposta.cz domain while](http://www.ceskaposta.cz/)\n\npointing to www.ceskaposta.net, which many victims hadn’t\n\nnoticed. Interestingly enough, the fake domain actually redirected to\n\nthe real website when opened directly.\n\n\nFigure 3 - Warning about the fraudulent e-mails issued by the Czech Postal Service\n\nWhile the Czech campaign was the one that caught our attention,\n\nthe country most affected by this banking trojan is Turkey and\n\nHesperbot detections in Turkey are dated even earlier than August 8.\n\nRecent peaks in botnet activity were observed in Turkey in July 2013,\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nwere sending debugging information to the C&C – an indicator that\n\nthese variants were in the early stages of development. Additional\n\nresearch revealed that Turkey has been facing Hesperbot infections\n\nfor some time now.\n\nThe campaigns used in Turkey are of a similar nature to the Czech\n\ncampaign. The phish-like e-mail that was sent to potential victims\n\npurported to be an invoice (the filename is fatura in Turkish) from\n\nTTNET (the largest ISP in Turkey). A double extension – .PDF.EXE –\n\nwas used here too. An analysis of this campaign has been published\n\n[on the website of the Turkish National Information Security Program.](http://www.bilgiguvenligi.gov.tr/zararli-yazilimlar/fatura-zararli-yazilim-defref-analizi.html)\n\nOnly later in our research did we find that the malware operators\n\nhave shifted their sights towards Portugal. Similarly to the Turkish\n\ncampaign, the malicious files were disguised as an invoice from\n\na local service provider with a very large market share, Portugal\n\nTelecom.\n\nA variant designated to target computer users in the United Kingdom\n\nhas also been found in the wild, but we cannot provide further details\n\nabout its spreading campaign at the time of writing.\n\nIn the course of our research, we also stumbled upon an additional\n\ncomponent used by Win32/Spy.Hesperbot. This malware, detected\n\nby ESET as Win32/Spy.Agent.OEC, harvests e-mail addresses from\n\nthe infected system and sends them to a remote server. It is possible\n\nthat these collected addresses were also targeted by the malware\nspreading campaigns.\n\n\n#### Targeted Banks and Victims\n\nThe configuration files used by the malware’s HTTP interception and\n\ninjection module specify which online banking websites are to be\n\ntargeted by each botnet.\n\n_Czech Republic_\n\nFigure 4 - Czech banks targeted by Hesperbot\n\n_Turkey_\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\n_Portugal_\n\nFigure 6 - Portuguese banks targeted by Hesperbot\n\nIn the case of the Turkish and Portuguese botnets, the configuration\n\nfiles also included web-injects, i.e. pieces of HTML code that the\n\ntrojan would insert into the banks’ web-pages when viewed on the\n\ninfected PC. This was not present in the Czech configuration file\n\nthat we found, so most probably only simple form-grabbing and\n\nkeylogging functionality was used in that instance.\n\n\nAccording to our ESET LiveGrid® telemetry, as well as our hands-on\n\nresearch into the malware operation, we estimate that the number\n\nof people that may have fallen victim to the Hesperbot banking trojan\n\nis in the scale of tens in the Czech Republic and Portugal (respectively)\n\nand in the scale of several hundred in Turkey. Detection statistics\n\nper country are shown in the figure below. It has also come to our\n\nattention that victims in the Czech Republic have lost significant\n\namounts of money as a result of infection by this malware. It’s quite\n\npossible that there are similarly unfortunate victims in Turkey and\n\nPortugal as well.\n\nFigure 8 - Detection statistics of Win32/Hesperbot according to ESET LiveGrid\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\n### The Malware\n\nLike many other malware families, Win32/Spy.Hesperbot has a\n\nmodular architecture. As the first step in infection, the victim\n\ndownloads and runs a dropper component. The dropper is also\n\nprotected by a custom malware packer and distributed in a ZIP archive.\n\nFigure 9 - Hesperbot initial modules overview\n\nThe dropper’s role is to inject the main component – ‘core’ – into\n\nexplorer.exe. The core then downloads and loads additional modules,\n\nplug-ins used to carry out malicious actions.\n\n\nkeylog Keylogger\n\nhvnc Sets up a covert VNC server\n\nsch Auxiliary module for setting hooks\n\nsocks Used to set up a SOCKS5 proxy server\n\nFigure 10 - Description of Win32/Spy.Hesperbot modules\n\nThe various modules are available both as x86 and x64 variants\n\naccording to the host system platform.\n\nSelected internal functions of individual modules are available for\n\nother modules to use through a virtual method table (vtable).\n\nWe have reverse-engineered the malware components and will\n\nhighlight the most interesting features in the following paragraphs.\n\nMost malware components were compiled using Visual Studio\n\n2010 and written in the C programming language, but without\n\nusing the C Run-Time library. While this isn’t the most sophisticated\n\nmalware we’ve analysed, Win32/Spy.Hesperbot can’t be dismissed as\n\namateurish.\n\n\n**Module** **Function**\n\ndropper Used for injecting core into explorer.exe\n\n\ncore\n\nnethk\n\nhttphk\n\nhttpi\n\n\nMain module, contacts C&C\n\nand downloads plugin modules\n\nModules for network traffic interception,\n\nweb-injects, screenshots and video\n\ncapture. See below for details.\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\n#### Main Modules\n\n_dropper_\n\nThe dropper can use one of several methods for injecting the core\n\ncomponent into the address space of explorer.exe:\n\n - \u0007Starting a new instance of explorer.exe and patching its entry\npoint using NtGetContextThread to point to its own code\n\n(written using WriteProcessMemory). This can be done either\n\ndirectly or through an intermediate attrib.exe process.\n\n - \u0007Injecting itself into the actual explorer.exe using the elaborate\n\nShell_TrayWnd/SetWindowLong/SendNotifyMessage trick\n\nused in PowerLoader and other malware. (Aleks Matrosov has\n\n[published multiple](http://www.welivesecurity.com/2013/08/27/the-powerloader-64-bit-update-based-on-leaked-exploits/) _[blog](http://www.welivesecurity.com/2013/03/19/gapz-and-redyms-droppers-based-on-power-loader-code/)_ _[posts about it recently, so I won’t go into](http://www.welivesecurity.com/2012/12/27/win32gapz-steps-of-evolution/)_\n\ndetails here.)\n\n - \u0007Injecting itself into explorer.exe using the common approach with\n\nCreateRemoteThread\n\nInterestingly, the injection method is also based on whether the\n\n_cmdguard.sys (Comodo) or klif.sys (Kaspersky) drivers are found on the_\n\nsystem.\n\n_core_\n\nThe core module, now running in the context of explorer.exe, handles\n\ncommunication with the C&C server and launching other plug-in\n\nmodules. Typical malware functionality, such as writing to the Run\n\nWindows Registry key, is also handled by core.\n\nIn order to access the C&C server, Win32/Spy.Hesperbot.A uses either\n\n\nthe Czech, Turkish and Portuguese botnets) or generates new C&C\n\nURLs using a domain generation algorithm in case the first server is\n\ninaccessible.\n\nThe following information is sent to the command-and-control\n\nserver:\n\n - \u0007Bot name based on the Computer Name\n\n - \u0007Botnet name – so far, we have seen “cz-botnet”, “tr-botnet”,\n\n“pt-botnet”, “uk-botnet” and “super-botnet” (used in early “beta”\n\nversions)\n\n - \u0007IP addresses of present network adapters\n\n - \u0007Names of active smart-cards\n\n - \u0007Information about installed Hesperbot plug-ins\n\nFigure 11 - Botnet identifier in Hesperbot code\n\nIn return, the server can send:\n\n - \u0007A configuration file\n\n - \u0007Plugin modules\n\n - \u0007An arbitrary executable to run\n\n - \u0007A new version of itself\n\nSeveral technical details regarding the abovementioned functionality\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\n[smart cards present in the system using the SCardEstablishContext,](http://msdn.microsoft.com/en-us/library/windows/desktop/aa379479%28v=vs.85%29.aspx)\n\n_[SCardListReaders and SCardConnect API functions. Unlike more](http://msdn.microsoft.com/en-us/library/windows/desktop/aa379793%28v=vs.85%29.aspx)_\n\n[sophisticated attacks against smart cards (described by Aleks here](http://www.welivesecurity.com/2012/06/05/smartcard-vulnerabilities-in-modern-banking-malware/)\n\n[and here), Win32/Spy.Hesperbot only collects smart-card names and](http://www.welivesecurity.com/2010/11/05/dr-zeus-the-bot-in-the-hat/)\n\ndoesn’t contain the ability to interact with them.\n\nSecondly, the downloaded data (namely the configuration file and\n\n[plugin modules) is encrypted using the Twofish cipher. The 256-bit key](http://en.wikipedia.org/wiki/Twofish)\n\nis a hash based on:\n\n - \u0007Computer Name\n\n - \u0007[HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\\n\nCurrentVersion] \"InstallDate\"\n\n - \u0007Windows version\n\n - \u0007Processor architecture (x86, x64 or IA64)\n\n - \u0007[HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Cryptography]\n\n\"MachineGuid\"\n\n - \u0007[HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\\n\nCurrentVersion] \"DigitalProductId\"\n\nFor storing the downloaded data as well as other auxiliary binaries\n\n(e.g. the log created by the keylogger module), Hesperbot uses a\n\nrandomly named subdirectory under %APPDATA%.\n\nThe core module can inject itself into all running processes.\n\nFurthermore, an undocumented trick of hooking\n\nUserNotifyProcessCreate is used when running inside csrss.exe, to\n\nensure that the trojan’s code will be injected into every new process.\n\nImportantly the core module exposes internal functions through\n\n\nThe interactions between plug-ins are clarified in the following\n\nparagraph, which describes the network interception modules.\n\n#### Network Interception and Web-injects\n\nProbably the most intriguing part of this malware is the way it\n\nhandles network traffic interception. Other well-known banking\n\ntrojans such as Zeus and SpyEye are able to intercept and\n\nmodify HTTP and HTTPS traffic by hooking WinSock functions\n\n(send, WSASend, etc.) and the higher-level WinInet functions\n\n(HttpSendRequest, InternetReadFile, etc.). As the web-injects,\n\nform-grabbing and other shenanigans performed by these banking\n\ntrojans take place inside the affected browser, the method has\n\ncollectively been labeled as the ‘Man-in-the-Browser’ attack. Win32/\n\nSpy.Hesperbot, however, takes a different approach, which is not very\n\n[common, but has, in fact, already been used by the Gataka banking](http://www.welivesecurity.com/2012/06/28/win32gataka-a-banking-trojan-ready-to-take-off/)\n\n_[trojan. A good technical analysis of Win32/Gataka by my colleague](http://www.welivesecurity.com/2012/06/28/win32gataka-a-banking-trojan-ready-to-take-off/)_\n\n[Jean-Ian Boutin can be found here.](http://www.welivesecurity.com/2012/08/13/win32gataka-banking-trojan-detailed-analysis/)\n\nThe network traffic interception and HTML injection functionality in\n\nWin32/Spy.Hesperbot is accomplished by the plug-in modules nethk,\n\nhttphk and httpi working together.\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nFigure 12 - Relations between network interception modules\n\nHere’s a brief description of each module’s purpose:\n\n - _\u0007nethk – used to set up a local proxy, hook socket functions to drive_\n\nconnections through the proxy and hook browser SSL certificate\n\nverification functions. Also handles decryption and encryption of\n\nHTTPS traffic flowing through the proxy.\n\n - _\u0007httphk – used for parsing HTTP traffic intercepted by the proxy_\n\n - _\u0007httpi – used for screenshots, video capturing, form-grabbing and_\n\nweb-injects according to the configuration file\n\nNow let’s take a closer look at how the modules work together and\n\naccomplish their tasks. As mentioned above, the modules expose\n\ntheir functions in a vtable for other modules to use. The program\n\nflow in between the modules as each HTTP request or response is\n\nintercepted is ensured through callback functions.\n\n\n_nethk_\n\nNethk is the first plug-in module to be loaded by the core module.\n\nWin32/Spy.Hesperbot performs a man-in-the-middle attack by\n\ncreating a local proxy through which it directs all connections from\n\nthe browser.\n\nFigure 13 - Local proxy IP address in Hesperbot code\n\nFigure 14 - Internet Explorer connected through Hesperbot proxy\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nTo achieve this, the trojan’s nethk module creates a proxy on a\n\nrandom port at the address 127.0.1.1 and hooks the following functions\n\nin mswsock.dll, the lower-level Winsock SPI library:\n\n - \u0007WSPSocket\n\n - \u0007WSPIoctl\n\n - \u0007WSPConnect\n\n - \u0007WSPCloseSocket\n\nThe pointers to these functions are modified in the WSPPROC_TABLE.\n\nTo understand how the proxy redirection works, let’s look at the\n\nhooked WSPConnect function.\n\n\nFigure 15 - Hooked WSPConnect API\n\nThe browser socket – when trying to connect to a secured online\n\nbanking website, for example – is connected to the proxy created by\n\nHesperbot instead. In another thread, the legitimate connection to\n\nthe website is established.\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nFigure 16 - Overview of HTTPS traffic interception via Hesperbot's proxy\n\nAn httphk-callback is invoked each time the proxy intercepts a\n\nrequest from the browser, before passing it on to the real server.\n\nLikewise, an httphk-callback is invoked each time the proxy\n\nintercepts a response from the real server, before passing it on to the\n\nbrowser. The httphk module then works further with the traffic.\n\nThere’s also a difference between the handling of HTTP versus HTTPS\n\ntraffic. In the case of HTTP, the request- or response-data is simply\n\npassed to httphk. In the case of HTTPS, nethk first “gets rid of the\n\nencryption”. When an HTTPS request from the browser is intercepted\n\n(encrypted using its own fake SSL certificate – explained below), it\n\nis decrypted, and the decrypted data is passed to httphk through\n\nthe callback and then encrypted using the real certificate of the\n\nserver (e.g. bank website), and then sent to the real destination.\n\nReciprocally, when an HTTPS response is received from the server,\n\nit’s decrypted using the real certificate, the decrypted data is\n\nagain passed to httphk and then encrypted using Hesperbot’s fake\n\n\nIn effect, through the man-in-the-middle proxy, Win32/Spy.Hesperbot\n\ncan access the victim’s outgoing HTTPS communication before\n\nit’s encrypted and their incoming HTTPS communication after it’s\n\ndecrypted. The same effect is essentially accomplished by Zeus’s and\n\nSpyEye’s MitB hooks, but this new approach is slightly stealthier.\n\nNow, of course, this malicious proxy redirection should be given away\n\nby an invalid certificate for an HTTPS website. The Hesperbot authors\n\nthought of this as well. The nethk module carries its own crafted,\n\nself-signed SSL certificates and these are substituted for legitimate\n\ncertificates.\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nFigure 18 - Example of Hesperbot's fake certificates in use. On a clean system, Google's certificate would displayed here, of course.\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nIn order to trick the browser into believing that the certificate is valid\n\nand avoid the display of a warning message, the malicious module\n\nalso hooks functions responsible for certificate verification. The\n\nimplementation differs depending on the browser. The following\n\ntable shows which browsers are supported by Win32/Spy.Hesperbot\n\nand which functions are hooked:\n\n**Browser process** **Hooked functions**\n\niexplore.exe\n\nmaxthon.exe\n\navant.exe\n\n\nFigure 20 - Code obfuscation in Win32/Spy.Hesperbot - hashes are used instead of\n\nprocess names\n\nThe figure below shows the code of the hooked\n\n_[CertVerifyCertificateChainPolicy.](http://msdn.microsoft.com/en-us/library/windows/desktop/aa377163%28v=vs.85%29.aspx)_\n\n\nsleipnir.exe\n\nwebkit2webprocess.exe\n\nbrowser.exe\n\nchrome.exe\n\ndeepnet.exe\n\n\nCertVerifyCertificateChainPolicy and\nCertGetCertificateChain in crypt32.dll\n\n\nfirefox.exe CERT_VerifyCertificate, CERT_\nVerifyCert, CERT_VerifyCertificateNow,\n\nseamonkey.exe\n\nCERT_VerifyCertNow and CERT_\n\nk-meleon.exe VerifyCertName in nss3.dll\n\nopera.exe Function in opera.dll\n\nFigure 19 - Certificate verification functions hooked by Hesperbot for various\n\nbrowsers\n\nAn interesting feature of the malicious code is that the authors have\n\nused hashes instead of using the browser process names directly,\n\nso as to complicate analysis and, more importantly, to protect the\n\nmalware from signature based AV detection.\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nFigure 21 - Hooked CertVerifyCertificateChainPolicy API\n\nIn the case of an SSL client/server chain policy verification check\n\n(other types are neglected and passed on to the original function)\n\nthe hooked function simply returns a result indicating that the policy\n\ncheck was passed.\n\n\n_httphk_\n\nThe httphk module is merely responsible for parsing the HTTP\n\nprotocol data. When the httphk-callback is invoked, it parses HTTP\n\nheaders and data and fills in an internal structure. This structure will\n\nsubsequently be accessed by the httpi module.\n\nAgain, httphk exposes two callback functions for invoking httpi:\n\n_httpi_request_callback and httpi_response_callback._\n\n_httpi_\n\nThis is the main module that actually carries out the modification of\n\nthe HTTP data, according to the configuration file.\n\nWhen httpi_request_callback is invoked, the following actions are\n\nperformed:\n\n1. _\u0007Video capture and screenshots – The module reads the_\n\nconfiguration file and checks the request URL. If specified in the\n\nconfig, video capture and/or creating screenshots is started.\n\n2. _\u0007Form grabbing – The module checks whether it’s a POST request_\n\nvia the HTTPS scheme and if content-type is either \"application/\n\nx-www-form-urlencoded\" or \"text/plain\". If these conditions\n\nare true, it’s likely that the user has submitted a login form. If\n\nthe configuration file specifies that the current URL should be\n\nmonitored, the data is written to a log.\n\nWhen httpi_response_callback is invoked, the following happens:\n\n3. _\u0007HTML injects – First, the trojan checks whether the HTTP_\n\nresponse code is 200. Afterwards, the configuration file is read\n\nand if there are web inject entries for the responding web page\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nThe figure below shows a decrypted configuration file used in the\n\nPortuguese botnet. You may notice the first group of domains – these\n\nare ignored by httpi – domains which are of little interest to the bot\n\nmasters. While stolen Google or Facebook login credentials would\n\nbe considered valuable to other spying malware, this shows that the\n\nperpetrators behind Hesperbot are only interested in online-banking\n\nrelated data. The targeted bank websites are listed after those that\n\nare ignored. The rest of the configuration file contains the HTML code\n\nthat’s supposed to be injected into the online banking websites.\n\n\nFigure 22 - Decrypted web-inject configuration file used in the Portuguese botnet\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nIt appears that the people who wrote the web-injection scripts speak\nRussian, as evidenced by source-code comments. Note, however,\nthat the scripts may or may not have been written by the same\nperpetrators who created the Win32/Spy.Hesperbot malware and/\nor operate the botnets. Web-inject scripts are often shared and\nreused – this is made possible when a similar format is being used by\ndifferent malware families – and specialization among cybercriminals\nis commonplace.\n\n#### Mobile Component\n\nIt’s common nowadays that banking trojans also utilize mobile\ncomponents (like ZitMo and SpitMo, for instance) in order to bypass\n[banks’ out-of-band authentication through mTANs (Mobile Transaction](http://en.wikipedia.org/wiki/Transaction_authentication_number#Mobile_TAN_.28mTAN.29)\n_[Authentication Number).](http://en.wikipedia.org/wiki/Transaction_authentication_number#Mobile_TAN_.28mTAN.29)_\n\nIn the web-inject scripts that we have seen so far, the malware\n\ninjects code into the website, which prompts the user to install an\napplication on their mobile phone. The victim is offered a dropdown\nlist of phone models and after entering their phone number a link to\ndownload the mobile component is sent to their phone. Three mobile\nplatforms are supported: Android, Symbian and Blackberry.\n\n\nWe have analysed the Symbian and Android versions, but haven’t so\n\nfar been able to obtain the Blackberry malware. The Symbian version\n\nsupports a broad range of devices, including Symbian S60 3[rd] edition,\n\nSymbian S60 5[th] edition and the latest Symbian^3.\n\nBoth of the analysed mobile trojans exhibit similar functionality.\n\nFirst, there is an “activation procedure”. The web-inject JavaScript on\n\nthe Hesperbot-infected computer generates a random “activation\n\nnumber”, which is displayed to the user. The user is supposed re\ntype the number when prompted by the mobile application. The\n\nmobile app then displays a “response code”, which is calculated from\n\nthe activation number. The user is then asked to enter it back into\n\nthe webpage on their computer for verification. (The injected script\n\ncontains the same algorithm for calculating the response code as\n\nin the mobile component.) This functionality provides the attackers\n\nconfirmation that the victim has installed the mobile component\n\nsuccessfully and ties it with the bot infection.\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\nAs expected, the code, both in the Symbian and Android versions (and\n\nlikely in the Blackberry version as well), registers a service that waits\n\nfor incoming SMS messages and forwards them to the attacker’s\n\nphone number. This way the attacker will get the mTAN necessary for\n\nlogging into the hijacked bank account.\n\nThe mobile code also implements the attacker’s ability to control the\n\nservice remotely through SMS commands.\n\nThe Android component is detected by ESET as\n\n_Android/‌Spy.‌Hesperbot.A and the Symbian version as_\n\n_SymbOS9/Spy.Hesperbot.A._\n\n#### Other Functionality\n\n_Keylogger_\n\nThe keylogger module intercepts key strokes by hooking the\n\n[functions GetMessage and TranslateMessage in user32.dll. They are then](http://msdn.microsoft.com/en-us/library/windows/desktop/ms644936%28v=vs.85%29.aspx)\n\nwritten to a log file, along with the originating process module name\n\nand window title text. Afterwards, the log gets sent to the C&C server.\n\n_Screenshots and Video Capture_\n\nAs mentioned above, screenshots and video capture is done by the\n\nhttpi module, if specified in the configuration file.\n\nThe video capture functionality has been used by the Zeus banking\n\ntrojan spin-off Citadel and provides the attackers with an even\n\nbetter overview of what’s happening on the victim’s screen. It’s\n\n[implemented using Avifil32.dll functions AVIFileCreateStream,](http://msdn.microsoft.com/en-us/library/windows/desktop/dd756793%28v=vs.85%29.aspx)\n\n_[AVIFileMakeCompressedStream, AVIStreamWrite, etc.](http://msdn.microsoft.com/en-us/library/windows/desktop/dd756811%28v=vs.85%29.aspx)_\n\n\nFigure 25 - Part of Hesperbot's video capturing code\n\nThe more common screenshot functionality is implemented using the\n\n[Gdi32.dll functions BitBlt, GetDIBits, etc.](http://msdn.microsoft.com/en-us/library/windows/desktop/dd183370%28v=vs.85%29.aspx)\n\n_Hidden VNC_\n\nThe VNC functionality has previously been used in the infamous\n\n_[Carberp malware. (In fact, Carberp may have also been an inspiration](http://www.welivesecurity.com/2013/03/25/carberp-the-never-ending-story/)_\n\n[to the Hesperbot creators after its source code leak.) It enables the](http://www.welivesecurity.com/2013/06/26/carberp-code-leak-could-lead-to-new-wave-of-attacks/)\n\ntrojan to create a hidden VNC server, to which the attacker can\n\nremotely connect. As VNC doesn’t log the user off like RDP, the\n\nattacker can connect to the unsuspecting victim’s computer while\n\nthey’re working. The VNC session runs in a separate desktop (see\n\n_[CreateDesktop on MSDN), invisible to the user. The module also](http://msdn.microsoft.com/en-us/library/windows/desktop/ms682124%28v=vs.85%29.aspx)_\n\nprovides the attacker with the capability to launch a browser that’s\n\ninstalled on the host system. In this way, the attacker will also have\n\naccess to all browser-associated data (cookies, sessions, etc.).\n\n\n-----\n\nA New, Advanced Banking Trojan in the Wild\n\n#### Conclusion\n\nAs reverse-engineers, Win32/Spy.Hesperbot has interested us\n\nfrom a technical perspective. While inspiration from older banking\n\ntrojans are clearly suggested by certain functionalities, it appears\n\nthat Hesperbot is a new breed of malware that its author began\n\ndeveloping in the year 2013.\n\nThe combination of man-in-the-middle network traffic interception,\n\nkeylogging, creating screenshots and video capture sequences and\n\na hidden VNC session all make this banking trojan a very capable\n\nmalicious program.\n\nAnd as we have witnessed, it has already been put to use in at least\n\nfour countries: Turkey, the Czech Republic, Portugal and the United\n\nKingdom. In order to protect their hard-earned money, users are\n\nadvised to stay safe through both technical measures (updating\n\nand patching software and keeping anti-virus software up to date\n\nwith the latest detection signatures) and non-technical measures:\n\nbe cautious and sceptical – for example, by staying alert for classic\n\n_phishing messages._\n\n#### Authors\n\n_Anton Cherepanov_\n\n_Robert Lipovsky_\n\n\n#### List of MD5s\n\n3d71bc74007a2c63dccd244ed8a16e26\nce7bcbfad4921ecd54de6336d9d5bf12\nf8ef34342533da220f8e1791ced75cda\n1abae69a166396d1553d312bb72daf65\n83b74a6d103b8197efaae5965d099c1e\n91c5a64e6b589ffcfe198c9c99c7d1f0\nae40a00aad152f9113bc6d6ff6f1c363\n27d8098fe56410f1ac36008dbf4b323e\n8a9cb1bb37354dfda3a89263457ece61\nff858b3c0ea14b3a168b4e4d585c4571\n1243812d00f00cef8a379cb7bc6d67e7\n1e1b70e5c9195b3363d8fb916fc3eb76\n4cf7d77295d64488449d61e2e85ddc72\n5410864a970403dae037254ea6c57464\n64a59d4c821babb6e4c09334f89e7c2d\n1f7b87d5a133b320a783b95049d83332\n028a70de48cd33897affc8f91accb1cd\n4cc533ef8105cbec6654a3a2bc38cb55\n59427cfb5aa31b48150937e70403f0db\nc8ee74ada32ea9040d826206a482149e\nd3c7d6d10cd6f3809c4ca837ba9ae2e8\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://web-assets.esetstatic.com/wls/2013/09/Hesperbot_Whitepaper.pdf"
    ],
    "report_names": [
        "Hesperbot_Whitepaper.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1721441175,
    "ts_updated_at": 1743041159,
    "ts_creation_date": 1378725824,
    "ts_modification_date": 1378725830,
    "files": {
        "pdf": "https://archive.orkl.eu/80895a16d670b4de10670a024e18b0239d6b7c35.pdf",
        "text": "https://archive.orkl.eu/80895a16d670b4de10670a024e18b0239d6b7c35.txt",
        "img": "https://archive.orkl.eu/80895a16d670b4de10670a024e18b0239d6b7c35.jpg"
    }
}