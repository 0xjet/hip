{
    "id": "1c5050f6-f5e3-4bfa-b2ff-3d901afbb479",
    "created_at": "2023-01-12T15:06:37.196639Z",
    "updated_at": "2025-03-27T02:05:32.894997Z",
    "deleted_at": null,
    "sha1_hash": "8e51bfe181a9e31724a6e25fb7e2b05109c8bf74",
    "title": "2017-09-05 - Graftor - But I Never Asked for This…",
    "authors": "",
    "file_creation_date": "2022-05-29T01:03:06Z",
    "file_modification_date": "2022-05-29T01:03:06Z",
    "file_size": 2530253,
    "plain_text": "# Graftor - But I Never Asked for This…\n\n**blog.talosintelligence.com/2017/09/graftor-but-i-never-asked-for-this.html**\n\n[This post is authored by Holger Unterbrink and](https://blogs.cisco.com/author/holgerunterbrink) [Matthew Molyett](https://blogs.cisco.com/author/matthewmolyett)\n\n## Overview\n\nFree software often downloaded from large freeware distribution sites is a boon for the internet, providing users with functionality that\notherwise they would not be able to use. Often users, happy that they are getting something free, fail to pay attention to the hints in the licence\nagreement that they are receiving additional software services bundled with the freeware they desire.\n\nGraftor aka LoadMoney adware dropper is a potentially unwanted program often installed as part of freeware software installers. We wanted to\ninvestigate the effects this software has on a user’s system. According to the analysis performed in our sandbox, Graftor and the associated\naffiliate files it downloads perform the following functions:\n\nHijacks the user's browser and injects advertising banners\nInstalls other potentially unwanted applications from partners like mail.ru\nIt does not ask the user, it just silently installs these programs\nRandom web page text is turned into links\nAdds Desktop and Browser Quick Launch links\nUser’s homepage is changed\nUser’s search provider is changed\nPartner adware is executed and it social engineers the user to install further software\nChecks for installed AV software\nChecks for sandbox environments\nAnti-Analysis protection\nUnnecessary API calls to overflow sandbox environments\nCreates/Modifies system certificates\n\n## Functionality\n\nOne of the first actions of the software is to install additional software on the user’s desktop, and change browser settings to point to third party\nwebsites (Fig.1):\n\n\n-----\n\nFig. 1\n\nLooking at the Cisco Umbrella DNS data for the CnC domain used in this campaign, we can see that the campaign only lasted for a couple of\ndays (Fig. 2a), but affected a significant number of people. Fig. 2b and 2c show domains of two of the affiliate applications which Graftor\ninstalled during our sandbox run. It is very likely that this includes users who didn’t intend to install these additional applications.\n\nRegularfood[.]gdn (Command and Control Server Domain)\n\nFig. 2a\n\nAffiliates (programs installed by Graftor):\n\nFig. 2b\n\nFig. 3b\n\n\n-----\n\n## Technical Details\n\nA few minutes after executing the original Graftor dropper (2263387661.exe), the software downloaded and installed a series of additional\nexecutables. This results in the process tree looking like this (Fig.3):\n\nFig. 3\n\nWe analysed the Graftor dropper/downloader (2263387661.exe). It comes with multiple stages of obfuscation. The first unpacking stage of the\nexecutable uses a heavily obfuscated but fairly simple unpacking algorithm which we will describe in the following section. This algorithm is\nobfuscated in the WinMain function distributed over several sub functions. Fig.4 shows you the complexity of the WinMain function in IDA,\nmany of these building blocks are combined with further sub functions, jumping back and forth, which makes analysis particularly challenging.\n\nFig. 4\n\nFirst, a new buffer is allocated (see Fig.5 at 00401395) :\n\n\n-----\n\nFig. 5\n\nThen the bytes from 00416B6A (see Fig. 9 below) are decoded by different sub functions within the WinMain function. For example see\n_loc_4013EC in Fig.6._\n\nThe code avoids calling functions by address values, but instead calls them via the values stored in registers or variables. For example the call\n_ebx instruction in Fig. 5 at 00401395 results in a VirtualAlloc call. This makes the static analysis of the code harder. E.g without deeper_\nanalysis it is difficult to identify the destination of the call at 00401395 shown in Fig. 5.\n\nFig. 6\n\nFinally the decoded bytes are handed over to a function (Fig. 7 write_unpkd_bytes2buf), which writes these bytes into a buffer. This is the\nbuffer which was allocated in Fig.5 at 00401395. The decoding loop starts again until all bytes are decoded:\n\nFig. 7\n\nFig. 8 shows the write_unpkd_bytes2buf function itself:\n\nFig. 8\n\nThe end result is that despite all of the complexity and obfuscation, the unpacking algorithm is remarkably simple and translates to the\nfollowing pseudo-code (see Fig. 9 comments):\n\n\n-----\n\nFig. 9\n\nThis first stage of unpacking extracts the code into memory. After successfully unpacking this code it is executed via call ecx (see Fig. 10) the second stage of the unpacker:\n\nFig. 10\n\nThis second stage code is position independent. It is loaded into a random address space picked by the operating system. The VirtualAlloc\nfunction in Fig.5 which we have mentioned above, is called with LPVOID lpAddress set to NULL, which means that the system determines\nwhere to allocate the memory region. This second stage is even more obfuscated by spaghetti code than the first stage. It’s main task is to\nrebuild the Import Address Table (IAT) and resolve the addresses of certain library functions (Fig. 11), plus modify the original PE file.\n\nFig. 11\n\nIt stores the function addresses in different local variables. These are passed as arguments to several setup functions, for example: change\nmemory region 0x400000 - 0x59C000 to read/write/execute (see Fig. 12). In other words, change the whole .text, .rdata, .data, and .rsrc\nsection of the original PE file to read/write/execute. This enables the dropper to modify and execute the code stored in these regions. As we\nhave already seen, in order to frustrate static analysis, most calls are obfuscated by either calling registers or variables (Fig.12).\n\nFig. 12\n\nNext step at 002A14F6 is to allocate a buffer located at 01DC0000:\n\n\n-----\n\nFig. 13\n\nThis buffer is filled with the bytes copied from 0042d049 from the original packed PE file:\n\nFig. 14\n\nFig. 15\n\nThis data is an encoded PE file. After copying the bytes to memory, it decodes them and writes them back to the buffer (Fig. 16a) at 01DC0000\n(Fig. 16b)\n\nFig. 16a\n\nFig. 16b\n\nThis stage is protected with an Anti-Debugging technique. The executable uses the following two GetTickCount calls to measure the time\nbetween the two calls (Fig. 17a and 17b). If it takes too long the executable will crash.\n\nFig. 17a\n\nFig. 17b\n\nAfter resolving more library function addresses and fixing the IAT of the PE file in memory, it sleeps for 258 milliseconds and jumps back to\n004897D3, which we will call the third stage from now on.\n\n\n-----\n\nFig. 18\n\nThe 2nd unpacking stage, the one we have just discussed, also decodes the URL which is later used to contact the command and control\nserver. First it allocates a buffer e.g. at 002B0000 (Fig. 19a) and reads the encrypted URL from the original sample at 004020c0, decodes it\nand stores it in the allocated buffer i.e. 002B0000 again (Fig. 19b).\n\nFig.19a\n\nFig. 19b\n\nThe third stage (see above) is a C++ executable compiled with Visual Studio. Global object initializers allow custom classes to run during the C\nruntime initialization, before the apparent WinMain entry point. Organizing code in this way allows the malware to prepare the system survey in\na way that is hidden from analysts who commence their analysis from WinMain. Later, when the associated code is used, the execution is\nmasked by memory redirection and virtual function calls.\nBelow you can see the callback function addresses stored in the .rdata segment of the PE file (Fig.20) and its initialization function\n_InitCallbacks (Fig.21 and Fig. 23)._\n\nFig. 20\n\nFig. 21\n\nFrom the pre-WinMain C Run Time library (CRT) initialization, the Callback function list gets created and populated with an association of\nnamed strings (e.g. “OS”), later observed in the CnC traffic and several system information collection callback functions. For example a\n\"systemFS\" string in the CnC traffic, leads to a call to the Graftor_CollectSystemVolumeInformation function or \"OS\" triggers the call of\n_Graftor_CollectWindowsInformation._\nFig. 22 shows an example of such function calls and pseudo code which would lead to a similar assembler code as discussed.\n\n\n-----\n\nFig. 22\n\nThe created list is linked to a global address location, which is later linked back again to local variables.\n\nFig. 23\n\nSuch redirection is subtle in source code, but the resulting execution means that chains of memory accesses are seen instead of just nice\nclean references to the object.\n\n\n-----\n\nFig. 24\n\nLater on, a string is passed along to look up the callback and call it indirectly (Fig.25).\n\nFig. 25\n\nBy using std::basic_string<wchar_t> instead of just plain wchar_t arrays, every string interaction adds two function calls and indirection.\nInstead of the analyst seeing a wide string being pushed to one function, it is instead a series of three. Before significant markup is performed\n(or when viewed in a debugger) this is just a mess of function calls and memory manipulation. Complicating the matter is that the std library is\nincluded rather than dynamically linked, so the analyst doesn’t get dll calls as hints.\nFurther on, this 3rd stage is protected by another anti-debugging technique: the sample registers a VectoredExceptionHandler for\nFirstChanceExceptions (C0000005) as you can see in Fig. 26 and 27:\n\nFig. 26\n\nFig. 27\n\n\n-----\n\ne t a s t e code sect o as G _ O CC SS\n\nFig. 28a\n\nFig. 28b\n\nThis means an exception is triggered for every single instruction in this section. The exception handler function (see Fig. 27 above) overwrites\nthe PAGE_NOACCESS access right for the memory location which caused the exception, with a PAGE_EXECUTE_READWRITE, so it can be\nexecuted. Then the exception handler function returns to the initial instruction, it can now be executed, but the next instruction is still protected\nby PAGE_NOACCESS and will cause the next exception. With a debugger attached, this interrupts the debugging session for every\ninstruction. Even if the exceptions are directly passed back to the executable, it massively slows down the execution speed.\nAt 004BB3FA the software starts preparing the internet request to the CnC server and encrypts the collected information to perform a GET\nrequest (Fig. 29a-c):\n\nFig. 29a\n\nFig. 29b\n\nFig. 29c\n\nTalos has decrypted the GET request that is sent to the CnC server. The decoded content consists of a JSON file, which you can\n[downloadhere.](https://alln-extcloud-storage.cisco.com/ciscoblogs/59ad2b132b89c.txt)\n\nThe executable is capable of sending the following informations to the C2 server:\n\n_MAC, SID, HD serial number, username, GUID, hostname, HD size, HD devicename, Filesystem, OS version, browser version, DotNET_\n_version, Video Driver, Language Settings, Memory, system bios version, domainname, computername, several processor related parameters,_\n_number of processors, other installed adware and unwanted programs, running processes, keyboard settings, Antispyware, Firewall, Antivirus_\n_and more._\n\nThe server responds to this with an encrypted configuration file which is processed here:\n\nFig. 30\n\nThe same decryption algorithm which is used for the GET request, is also used to decrypt the CnC servers response. It generates a fairly\nsimple stream seeded by the first byte of the packet and XORs it with the data. Underneath the encryption is a simple gzip stream.\n[The full decrypted file can be downloaded here. It contains the adware and other unwanted programs the Graftor downloader is supposed to](https://alln-extcloud-storage.cisco.com/ciscoblogs/59ad2b7ca12e5.txt)\ninstall for it’s partners/customers. You can see an example in Fig. 31.\n\n\n-----\n\nFig. 31\n\nThe first URL from the ‘l’ key is used to download the partner executable and install it. The ‘a’ key is used as its command line parameters. We\nhave yet to identify the exact meaning of all the keys; they are passed as parameters to a quite large JSON library. This library is also statically\ncompiled into the binary. Besides the JSON library we also found a statically compiled SQLite library, we haven’t fully investigated how it is\nused by the executable. However at this point we have enough information to detect and stop this adware downloader.\nThe information presented so far clearly shows the sophistication of this piece of software. With the data presented in the two decoded files,\nyou have a good idea of the capabilities of the software and the impact it has on infected systems.\nGraftor, and the applications that it downloads also heavily check for AV products and use various techniques to detect if it is running in a\nsandbox environment. These are very similar to techniques commonly observed in malware.\n\nFig. 32a\n\n\n-----\n\nFig. 32b\n\nFig. 32c\n\nFig. 32d\n\nFig.32e\n\nThe software makes many excessive API calls such as the following (Fig. 33) which has the effect of polluting sandbox analysis.\n\nFig. 33\n\n## Conclusion\n\nGraftor continues to be one of the most notorious potentially-unwanted-software downloaders we see in the wild. Users may be unaware that it\nis being bundled and executed as part of the freeware installation, since these installation files silently execute Graftor alongside the freeware.\n\nOnce Graftor is running, it exfiltrates a huge amount of user and machine identifiable information and installs additional potentially-unwantedapplications from its partners. The downloader requests administrative rights on the local machine, with this access, it can do anything it wants\nto do on the user's machine.\n\nSolutions such as AMP for endpoints and AMP on network devices give administrators visibility of when software such as Graftor, and the\n\n\n-----\n\nu t e pac ages t do oads, a e sta ed o de ces S a y, et o based detect o ca de t y a d b oc t e C C act ty (S o t S\n44214). Thought should be given to blocking access to freeware websites to prevent the download of the Graftor installer. However, much\nfreeware does not come bundled with Graftor and may be of great use to some users.\nAt the end of the day, keep in mind that if the software is free, you might be the product. Anyone using freeware should closely review the\nEULA before installing it. We know it is painful, but trying to remove this kind of software is likely more painful.\n\n## Coverage\n\nAdditional ways our customers can detect and block this threat are listed below.\n\n[Advanced Malware Protection (AMP) is ideally suited to prevent the execution of the malware used by these threat actors.](https://www.cisco.com/c/en/us/support/security/amp-firepower-software-license/tsd-products-support-series-home.html)\n\n[CWS or](https://www.cisco.com/c/en/us/products/security/cloud-web-security/index.html) [WSA web scanning prevents access to malicious websites and detects malware used in these attacks.](https://www.cisco.com/c/en/us/products/security/web-security-appliance/index.html)\n\n[Email Security can block malicious emails sent by threat actors as part of their campaign.](https://www.cisco.com/c/en/us/products/security/email-security-appliance/index.html)\n\n[The Network Security protection of IPS and NGFW have up-to-date signatures to detect malicious network activity by threat actors.](https://www.cisco.com/c/en/us/products/security/intrusion-prevention-system-ips/index.html)\n\n[AMP Threat Grid helps identify malicious binaries and build protection into all Cisco Security products.](https://www.cisco.com/c/en/us/solutions/enterprise-networks/amp-threat-grid/index.html)\n\n[Umbrella, our secure internet gateway (SIG), blocks users from connecting to malicious domains, IPs, and URLs, whether users are on or off](https://umbrella.cisco.com/)\nthe corporate network\n\n## IOC\n\n**Alternate Data Streams(ADS):**\n\nC:\\Users\\dex\\AppData\\Local\\Temp\\2263387661.exe:Zone.Identifier\n\nC:\\Users\\dex\\AppData\\Local\\Temp\\QBPO5ppcuhJG.exe:tmp\n\nC:\\Users\\dex\\AppData\\Local\\Temp\\2263387661.exe:tmp\n\nC:\\Users\\dex\\AppData\\Local\\Temp\\AyWdp7tHPIeU.exe:tmp\n\nC:\\Windows\\System32\\regsvr32.exe:Zone.Identifier Hashes:\n\n_2263387661.exe (Graftor Dropper)_\n\n9b9ce661a764d84a4636812e1dfcb03b (MD5)\nFd3ccf65eab21a77d2e440bd23c59d52e96a03a4 (SHA1)\n\n41474cd23ff0a861625ec1304f882891826829ed26ed1662aae2e7ebbe3605f2 (SHA256)\n\nDumped 2nd stage:\n\n40bde09fc059f205f67b181c34de666b (MD5)\n\n99c7627708c4ab1fca3222738c573e7376ab4070 (SHA1)\n\nEefdbe891e35390b84181eabe0ace6e202f5b2a050e800fb8e82327d5e57336d (SHA256)\n\nDumped 3rd stage:\n\n1e9f40e70ed3ab0ca9a52c216f807eff (MD5)\n\n7c4cd0ff0e004a62c9ab7f8bd991094226eca842 (SHA1)\n\n5eb2333956bebb81da365a26e56fea874797fa003107f95cda21273045d98385 (SHA256)\n\n**URLs:**\n\n_Command and Control Server GET Request:_\n\nhxxp://kskmasdqsjuzom[.]regularfood[.]gdn/J/ZGF0YV9maWxlcz0yMyZ0eXBlPXN0YXRpYyZuYW1lPVRlbXAlNUMyMjYzMzg3NjYxLmV4ZSZybmQ\n\nSet-Cookie: GSID=3746aecf3b94384b9de720158c4e7d88; expires=Sat, 12-Aug-2017 15\n\n\n-----\n\n_Co_ _a d a d Co t o Se_ _e_ _OS_ _equest_\nhxxp://kskmasdqsjuzom[.]regularfood[.]gdn/J/ZGF0YV9maWxlcz0yMyZ0eXBlPXN0YXRpYyZuYW1lPVRlbXAlNUMyMjYzMzg3NjYxLmV4ZSZybmQ\n\nSet-Cookie: GSID=3746aecf3b94384b9de720158c4e7d88; expires=Sat, 12-Aug-2017 15\n\n**Domains from sandbox run:**\narolina[.]torchpound[.]gdn\nbinupdate[.]mail[.]ru\ncrl[.]microsoft[.]com\ndreple[.]com\ngambling577[.]xyz\njvusdtufhlreari[.]twiceprint[.]gdn\nkskmasdqsjuzom[.]regularfood[.]gdn\nmentalaware[.]gdn\nmrds[.]mail[.]ru\nnottotrack[.]com\nplugpackdownload[.]net\ns2[.]symcb[.]com\nsputnikmailru[.]cdnmail[.]ru\nss[.]symcd[.]com\nxml[.]binupdate[.]mail[.]ru\n\n**Snort Rules:**\nSID 44214\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-09-05 - Graftor - But I Never Asked for This….pdf"
    ],
    "report_names": [
        "2017-09-05 - Graftor - But I Never Asked for This….pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535997,
    "ts_updated_at": 1743041132,
    "ts_creation_date": 1653786186,
    "ts_modification_date": 1653786186,
    "files": {
        "pdf": "https://archive.orkl.eu/8e51bfe181a9e31724a6e25fb7e2b05109c8bf74.pdf",
        "text": "https://archive.orkl.eu/8e51bfe181a9e31724a6e25fb7e2b05109c8bf74.txt",
        "img": "https://archive.orkl.eu/8e51bfe181a9e31724a6e25fb7e2b05109c8bf74.jpg"
    }
}