{
    "id": "8b68cb93-50f9-4719-a769-a60b505ec6b7",
    "created_at": "2023-01-12T14:58:51.695832Z",
    "updated_at": "2025-03-27T02:16:20.970611Z",
    "deleted_at": null,
    "sha1_hash": "9e701245648f79296014e896f98f3cf4ad0f9c29",
    "title": "2022-03-28 - A Step-by-Step Analysis of the Russian APT Turla Backdoor called TinyTurla",
    "authors": "",
    "file_creation_date": "2022-05-28T17:29:39Z",
    "file_modification_date": "2022-05-28T17:29:39Z",
    "file_size": 6595923,
    "plain_text": "# A step-by-step analysis of the Russian APT Turla backdoor called TinyTurla\n\n**[cybergeeks.tech/a-step-by-step-analysis-of-the-russian-apt-turla-backdoor-called-tinyturla/](https://cybergeeks.tech/a-step-by-step-analysis-of-the-russian-apt-turla-backdoor-called-tinyturla/)**\n\nSummary\n\nTurla is a Russian-based group that has impacted government, embassies, military,\neducation, and research companies since 2004. Our analysis focuses on a backdoor called\nTinyTurla that was installed on an endpoint via a Windows Service. The list of C2 servers\nand a password used for authentication with the servers are stored in the Windows registry.\nThe malware implements 12 different commands that include spawning and killing\nprocesses, creating and exfiltrating files, creating pipes for process communication, and\nmodifying registry values used during the execution.\n\n**Analyst:** [@GeeksCyber](https://twitter.com/GeeksCyber)\n\nTechnical analysis\n\nSHA256: 030cbd1a51f8583ccfc3fa38a28a5550dc1c84c05d6c0f5eb887d13dedf1da01\n\nThe file is a 64-bit DLL that was installed as a service called “Microsoft Windows Time”\n[(https://blog.talosintelligence.com/2021/09/tinyturla.html). We’ve manually created a service](https://blog.talosintelligence.com/2021/09/tinyturla.html)\ncalled “W64Time” and the corresponding registry keys/values by simulating the execution of\nthe batch script mentioned in the Talos article:\n\n\n-----\n\nFigure 1\n\nFigure 2\nBecause we’re analyzing a 64-bit file, the calling convention is different, and the function\narguments are passed to the RCX, RDX, R8, and R9 registers. Additional arguments are\npushed onto the stack (right to left).\n\nRegisterServiceCtrlHandlerW is utilized to register a function to handle service control\nrequests:\n\nFigure 3\nThe service status for the above service is set to 0x4 (SERVICE_RUNNING) via a function\ncall to SetServiceStatus:\n\n\n-----\n\nFigure 4\nAfter the main function finishes, the service status is set to 0x1 (SERVICE_STOPPED).\n\nThe RegOpenKeyExW API is used to open the\n“SYSTEM\\CurrentControlSet\\Services\\W64Time\\Parameters” registry key (0x80000002 =\n**HKEY_LOCAL_MACHINE, 0x20119 = KEY_READ | KEY_WOW64_64KEY):**\n\n\n-----\n\nFigure 5\nThe process extracts the following registry values using RegQueryValueExW:\n\nTimeLong – the number of milliseconds that the malware waits when the C2 servers\nare not responding\n\nTimeShort – the number of milliseconds between requesting different commands from\nthe C2 server\n\nSecurity – password used to perform some sort of authentication\n\nHosts – list of C2 domains and port numbers\n\n\n-----\n\nFigure 6\n\nFigure 7\n\n\n-----\n\nFigure 8\n\nFigure 9\nThe malware passes the C2 IPs and port numbers to the CommandLineToArgvW routine\nand extracts an array of pointers to them (the C2 server is randomly chosen for testing\npurposes):\n\n\n-----\n\nFigure 10\nWe’ve emulated network connections using FakeNet.\n\nThe malicious process opens the “SOFTWARE\\Microsoft\\Cryptography” registry key using\nRegOpenKeyExW (0x80000002 = HKEY_LOCAL_MACHINE, 0x20019 = KEY_READ):\n\nFigure 11\nThe “MachineGuid” value is extracted via a function call to RegQueryValueExW:\n\n\n-----\n\nFigure 12\nWinHttpOpen is utilized to initialize the use of WinHTTP functions:\n\nFigure 13\nThe file initializes a connection to the C2 server by calling the WinHttpConnect API:\n\n\n-----\n\nFigure 14\nThe WinHttpOpenRequest function is used to create a GET request handle (0x800000 =\n**WINHTTP_FLAG_SECURE):**\n\nFigure 15\nThe process adds an HTTP request header called “Title” containing the Machine GUID to the\nHTTP request handle (0x20000000 = HTTP_ADDREQ_FLAG_ADD):\n\nFigure 16\nThe security flags for the handle are set using WinHttpSetOption (0x1F =\n**WINHTTP_OPTION_SECURITY_FLAGS, 0x3300 =**\n**WinHttpRequestOption_SslErrorIgnoreFlags):**\n\n\n-----\n\nFigure 17\nThe malicious file sends the request to the C2 server using the\nWinHttpSendRequest routine:\n\nFigure 18\nWinHttpReceiveResponse is used to receive the response to the GET request initiated\nabove:\n\nFigure 19\nThe binary obtains header information associated with the request by calling the\nWinHttpQueryHeaders API (0x26 = WINHTTP_QUERY_TITLE):\n\n\n-----\n\nFigure 20\nWinHttpQueryDataAvailable is utilized to extract the amount of data, in bytes, available to be\nread with WinHttpReadData:\n\nFigure 21\nThe response from the server is copied to a buffer via a call to WinHttpReadData:\n\nFigure 22\nTinyTurla implements 12 different commands depending on the 1st byte received in the\nresponse. It uses a switch statement to execute a particular function:\n\nFigure 23\n\n\n-----\n\n**1st byte = 0x00 – Authentication**\n\nThe backdoor compares the “Security” value with a string starting from the 2nd byte in the\nresponse:\n\nFigure 24\n\nFigure 25\nWhether the two strings are equal, the malware sends “00 00” to the C2 server. Otherwise, it\nsends “00 03”, indicating an unsuccessful “authentication”.\n\n**1st byte = 0x01 – create a process**\n\nThe binary creates a process specified by the C2 server in the response (0x08000000 =\n**CREATE_NO_WINDOW):**\n\n\n-----\n\nFigure 26\nThe WinHttpOpenRequest routine is used to create a POST request handle (0x800000\n= WINHTTP_FLAG_SECURE):\n\nFigure 27\n\n\n-----\n\nThe backdoor adds an HTTP request header called Title that contains the Machine GUID to\nthe request handle (0x20000000 = HTTP_ADDREQ_FLAG_ADD):\n\nFigure 28\nThe security flags for the handle are set using WinHttpSetOption (0x1F\n= WINHTTP_OPTION_SECURITY_FLAGS, 0x3300\n= WinHttpRequestOption_SslErrorIgnoreFlags):\n\nFigure 29\nThe malicious process sends the POST request to the C2 server by calling the\nWinHttpSendRequest API:\n\nFigure 30\nA confirmation message “01 00” is sent to the C2 server using WinHttpWriteData:\n\n\n-----\n\nFigure 31\nWinHttpReceiveResponse is utilized to halt the process until it receives the response to the\nHTTP request:\n\nFigure 32\nThe backdoor sleeps for “TimeShort” milliseconds and waits for further instructions:\n\nFigure 33\n**1st byte = 0x02 – create a process and exfiltrate its output**\n\nThe malicious file creates an anonymous pipe and returns handles to the read/write ends of\nthe pipe:\n\nFigure 34\nThe write handle is set to be inherited by calling the SetHandleInformation routine (0x1 =\n**HANDLE_FLAG_INHERIT):**\n\n\n-----\n\nFigure 35\nA second anonymous pipe is created via a function call to CreatePipe:\n\nFigure 36\nThe read handle is set to be inherited by calling the SetHandleInformation routine (0x1 =\n**HANDLE_FLAG_INHERIT):**\n\nFigure 37\nThe malware creates a process mentioned by the C2 server in the response (0x08000000 =\n**CREATE_NO_WINDOW):**\n\nFigure 38\nWaitForSingleObject is used to wait until the above process is in the signaled state or\n0xEA60 = 60000ms = 60 seconds have elapsed:\n\n\n-----\n\nFigure 39\nThe output of the created process is copied from the anonymous pipe into a buffer by calling\nthe PeekNamedPipe function:\n\nFigure 40\nThe process reads data from the pipe using ReadFile:\n\n\n-----\n\nFigure 41\n\nFigure 42\n\nThe backdoor kills the process created above using the TerminateProcess routine:\n\nFigure 43\nThe execution flow of creating a POST request (WinHttpOpenRequest ->\nWinHttpAddRequestHeaders -> WinHttpSetOption -> WinHttpSendRequest) is repeated and\nwill not be detailed again. The process output is exfiltrated to the CnC server:\n\n\n-----\n\nFigure 44\n**1st byte = 0x03 – create and populate a file**\n\nThe backdoor creates a file specified by the C2 server using CreateFileW (0x40000000 =\n**GENERIC_WRITE, 0x2 = CREATE_ALWAYS, 0x80 = FILE_ATTRIBUTE_NORMAL):**\n\n\n-----\n\nFigure 45\nThe WriteFile API is utilized to populate the file with data received from the server:\n\nFigure 46\nA confirmation message “03 00” is sent to the C2 server.\n\n**1st byte = 0x04 – exfiltrate a file to the C2 server**\n\n\n-----\n\nThe process opens a file nominated by the server using CreateFileW (0x80000000 =\n**GENERIC_READ, 0x3 = OPEN_EXISTING, 0x80 = FILE_ATTRIBUTE_NORMAL):**\n\nFigure 47\nThe size of the file is retrieved by calling the GetFileSize routine:\n\nFigure 48\nThe file content is copied to a buffer via a function call to ReadFile:\n\n\n-----\n\nFigure 49\nThe content extracted above is transmitted to the CnC server:\n\nFigure 50\n**1st byte = 0x05 – spawn a new process**\n\nThe malicious process creates an anonymous pipe using the CreatePipe API:\n\n\n-----\n\nFigure 51\nThe write handle is set to be inherited by calling the SetHandleInformation routine (0x1\n= HANDLE_FLAG_INHERIT):\n\nFigure 52\nA second anonymous pipe is created by the malware:\n\nFigure 53\nThe read handle is set to be inherited by calling the SetHandleInformation routine (0x1\n= HANDLE_FLAG_INHERIT):\n\nFigure 54\nCreateProcessW is used to create a process specified by the C2 server (0x08000000\n= CREATE_NO_WINDOW):\n\n\n-----\n\nFigure 55\nA confirmation message “05 00” is sent to the C2 server.\n\n**1st byte = 0x06 – kill a process**\n\nThe binary kills the process spawned in the above command by calling TerminateProcess:\n\nFigure 56\nA confirmation message “06 00” is sent to the C2 server.\n\n**1st byte = 0x07 – read/write to a pipe**\n\nThe WriteFile API is utilized to write data transmitted by the CnC server to a pipe created\nearlier:\n\n\n-----\n\nFigure 57\nThe process reads data that is available through the pipe using the PeekNamedPipe and\nReadFile APIs:\n\nFigure 58\n\nFigure 59\n\n\n-----\n\nThe pipe content extracted above is exfiltrated to the C2 server.\n\n**1st byte = 0x08 – modify the “TimeLong” registry value**\n\nThe malware opens the “SYSTEM\\CurrentControlSet\\Services\\W64Time\\Parameters”\nregistry key by calling the RegOpenKeyExW routine (0x80000002\n= HKEY_LOCAL_MACHINE, 0x20006 = KEY_WRITE):\n\nFigure 60\nThe “TimeLong” value is modified to a number sent by the C2 server:\n\n\n-----\n\nFigure 61\nA confirmation message “08 00” is sent to the C2 server.\n\n**1st byte = 0x09 – modify the “TimeShort” registry value**\n\nThis command is similar to the one from above. The “TimeShort” value is modified\naccordingly:\n\n\n-----\n\nFigure 62\nA confirmation message “09 00” is sent to the C2 server.\n\n**1st byte = 0x0A – modify the “Security” registry value**\n\nThis command is similar to the one from above. The “Security” value used in the\nauthentication process is changed by the backdoor:\n\n\n-----\n\nFigure 63\nA confirmation message “0A 00” is sent to the C2 server.\n\n**1st byte = 0x0B – modify the “Hosts” registry value**\n\nThis command is similar to the one from above. The “Hosts” value that contains the list of C2\nservers is changed by the malware:\n\n\n-----\n\nFigure 64\nCommandLineToArgvW is utilized to retrieve an array of pointers to the C2 server(s):\n\nFigure 65\nA confirmation message “0B 00” is sent to the C2 server.\n\nReferences\n\n[MSDN: https://docs.microsoft.com/en-us/windows/win32/api/](https://docs.microsoft.com/en-us/windows/win32/api/)\n\nFakenet: [https://github.com/fireeye/flare-fakenet-ng](https://github.com/fireeye/flare-fakenet-ng)\n\nVirusTotal:\nhttps://www.virustotal.com/gui/file/030cbd1a51f8583ccfc3fa38a28a5550dc1c84c05d6c0f5eb\n887d13dedf1da01\n\nMalwareBazaar:\nhttps://bazaar.abuse.ch/sample/030cbd1a51f8583ccfc3fa38a28a5550dc1c84c05d6c0f5eb88\n7d13dedf1da01/\n\nTalos article: [https://blog.talosintelligence.com/2021/09/tinyturla.html](https://blog.talosintelligence.com/2021/09/tinyturla.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-28 - A Step-by-Step Analysis of the Russian APT Turla Backdoor called TinyTurla.pdf"
    ],
    "report_names": [
        "2022-03-28 - A Step-by-Step Analysis of the Russian APT Turla Backdoor called TinyTurla.pdf"
    ],
    "threat_actors": [
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535531,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1653758979,
    "ts_modification_date": 1653758979,
    "files": {
        "pdf": "https://archive.orkl.eu/9e701245648f79296014e896f98f3cf4ad0f9c29.pdf",
        "text": "https://archive.orkl.eu/9e701245648f79296014e896f98f3cf4ad0f9c29.txt",
        "img": "https://archive.orkl.eu/9e701245648f79296014e896f98f3cf4ad0f9c29.jpg"
    }
}