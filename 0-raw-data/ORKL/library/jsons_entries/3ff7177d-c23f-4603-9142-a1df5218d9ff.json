{
    "id": "3ff7177d-c23f-4603-9142-a1df5218d9ff",
    "created_at": "2022-10-25T16:48:20.023447Z",
    "updated_at": "2025-03-27T02:16:26.041588Z",
    "deleted_at": null,
    "sha1_hash": "ccb72e09f1578aac64f2a6cfccfdec5f4f8f6f0b",
    "title": "",
    "authors": "",
    "file_creation_date": "2013-06-21T11:05:34Z",
    "file_modification_date": "2013-06-21T11:05:34Z",
    "file_size": 6017870,
    "plain_text": "# Next generation mobile rootkits\n\n### Hack In Paris 2013\n\n\n-----\n\n# Hi!\n\n##### •\n### Thomas Roth\n\n###### • Embedded security (Payment terminals etc.)\n\n • Distributed computing (and breaking)\n\n • Web-stuff\n\n • Social: @stacksmashing\n\n\n-----\n\n# Prologue\n\n### Mobile rootkits & Trustzone\n\n\n-----\n\n# What are we protecting?\n\n### Communication Data Credentials Payment Tracking\n\n\n-----\n\n# In the wild\n\n##### •\n### CarrierIQ (Usage statistics)\n\n##### •\n### FinFisher (Governmental surveillance)\n\n##### •\n### Cloaker (Research)\n\n\n-----\n\n# Where do they hide?\n\n#### Baseband\n\n Memory\n\n CPU\n\n\n-----\n\n# Where do they hide?\n\n#### Baseband\n\n Memory\n\n CPU\n\n TrustZone\n\n\n-----\n\n# Short ARM intro\n\n##### •\n### 32-bit RISC architecture\n\n##### •\n### All instructions 32 bit long\n\n##### •\n### Except in “Thumb-mode”, 16-bit instructions\n\n##### •\n### Peripherals are mapped in memory (i.e. IOs at 0x40000000)\n\n##### •\n### CP15 = System Control Coprocessor\n\n##### •\n### Controls features like MMU, power saving, caches ...\n\n\n-----\n\n# ARM TrustZone\n\n##### •\n### Allows the processor to switch into a “secure mode”\n\n##### •\n### Secure access to screen, keyboard and other peripherals\n\n##### •\n### Tries to protect against: “...malware, trojans and rootkits”\n\n##### •\n### So called TEEs (Trusted Execution Environments) run in it\n\n##### •\n### Introduced with ARMv6KZ\n\n\n-----\n\n# ARM TrustZone\n\n##### •\n### Allows the processor to switch into a “secure mode”\n\n##### •\n### Secure access to screen, keyboard and other peripherals\n\n##### •\n### Tries to protect against: “...malware, trojans and rootkits”\n\n##### •\n### So called TEEs (Trusted Execution Environments) run in it\n\n##### •\n### Introduced with ARMv6KZ\n\n\n-----\n\n# ARM TrustZone\n\n##### •\n### Splits the CPU into two worlds: Secure and normal\n\n##### •\n### Communication between both worlds via shared memory mappings\n\n##### •\n### State of the CPU is indicated to peripherals using a bit on AXB/AHB\n\n##### •\n### Allowing secure-only on- & off-chip peripherals\n\n\n-----\n\n# Trusted Execution Environments\n\n##### •\n### Small operating system running in TrustZone and providing services\n to the ‘real’ operating system/apps\n\n##### •\n### You write apps for them and pay ??? to integrate them\n\n##### •\n### Use them via a driver in your operating system\n\n##### •\n### Drivers are often open-source\n\n\n-----\n\n# Example: Netflix\n\n##### •\n### Netflix requires a device-certification\n\n##### •\n### For SD, the device just needs to be fast enough to play video\n\n##### •\n### For HD, the labels require ‘end-to-end’ DRM, so that the video-stream\n can’t be grabbed at any time\n\n##### •\n### Video decoding running in TrustZone with direct access to screen, no\n way to record it from Android\n\n\n-----\n\n# Attacker Model\n\n##### •\n### Protect against:\n\n##### •\n### Device owners (DRM and other copy protection methods)\n\n##### •\n### Malware (Steal PayPass informations from the device)\n\n##### •\n### Freedom\n\n\n-----\n\n# How does it work?\n\n##### •\n### A second register set to the first CPU core\n\n##### •\n### Mode switch from normal world:\n\n##### •\n### SMC instruction (Secure Monitor Call)\n\n##### •\n### Hardware exception (IRQ, FIQ, etc.)\n\n##### •\n### NS bits on the internal bus (AXI/AHB) for indicating state to\n peripherals\n\n\n-----\n\n# How does it work?\n\n##### Normal\n Secure\n\n###### SMC instruction\n\n##### World\n World\n\n###### or Hardware exception Monitor Privileged modes Privileged modes\n\n##### Mode\n\n###### User mode User mode\n\n\n-----\n\n# How does it actually work?\n\n#### Standard CPU modes Hardware interrupt/SMC call SMC\n User, FIQ, IRQ, SVC ... Mode\n\n###### State handling & NS-bit\n\n\n-----\n\n# How does it actually work?\n\n##### •\n### SMC: (Always has the NS bit enabled)\n\n##### •\n### Detect whether coming from normal or secure world\n\n##### •\n### Store registers of current world\n\n##### •\n### Load registers of new world\n\n##### •\n### Toggle NS bit\n\n##### •\n### Give execution to new world\n\n\n-----\n\n# Memory in TrustZone\n\n#### Normal World Secure World\n\n TrustZone enabled MMU\n\n Normal-world memory Shared Secure-only memory\n\n\n-----\n\n# Memory in TrustZone\n\n##### •\n### Normal-world only sees its own memory as well as the shared\n segment\n\n##### •\n### Secure-world can access everything\n\n\n-----\n\n# Memory in TrustZone\n\n##### •\n### Normal-world only sees its own memory as well as the shared\n segment\n\n##### • Secure-world can access everything\n\n### I guess you see why this is could useful...\n\n\n-----\n\n# Boot process\n\n#### Start\n\n 1. stage bootloader (ROM)\n\n###### Hardware abstraction Integrity verification of 2. stage bootloader\n\n#### 2. stage bootloader (Flash)\n\n###### Initialization of TrustZone + TrustZone Kernel\n Lockdown of TrustZone\n Load & configure OS\n\n#### Operating System\n\n###### Android Windows\n ...\n\n\n-----\n\n# Boot process\n\n#### Start\n\n 1. stage bootloader (ROM)\n\n###### T\n Hardware abstraction Integrity verification of 2. stage bootloader R\n U\n S\n\n#### 2. stage bootloader (Flash) T\n\n###### E\n Initialization of TrustZone + TrustZone Kernel\n D\n Lockdown of TrustZone\n Load & configure OS\n\n#### Operating System\n\n###### Android Windows\n ...\n\n\n-----\n\n# By the way\n\n##### •\n### “Unlocking” a bootloader does not mean that you can do what you\n want.\n\n##### •\n### Most hardware vendors still lockdown a significant part of the boot\n chain, locking you out of TrustZone.\n\n\n-----\n\n# Hardware support\n\n##### •\n### All modern smartphone CPUs:\n\n##### •\n### Qualcomm Snapdragon\n\n##### •\n### TI OMAP\n\n##### •\n### ...\n\n\n-----\n\n# So basically...\n\n##### •\n### The vendor installs a small operating system in a part of the CPU\n\n##### •\n### This OS can do -anything- and third party apps are installed in it\n\n\n-----\n\n# So basically...\n\n##### •\n### The vendor installs a small operating system in a part of the CPU\n\n##### •\n### This OS can do -anything- and third party apps are installed in it\n\n##### What could possibly go wrong?\n\n\n-----\n\n# Chapter 1\n\n### Building a rootkit in TrustZone\n\n\n-----\n\n# What?\n\n##### •\n### Super small rootkit that runs in TrustZone (and now even in SMC!)\n\n##### •\n### First TrustZone rootkit\n\n##### •\n### Implemented entirely in assembler\n\n##### •\n### (Compilers are for losers)\n\n\n-----\n\n# Why?\n\n##### •\n### It’s fun!\n\n##### •\n### People haven’t talked about the problems that come with TrustZone\n\n##### •\n### The ‘trusted’ in Trusted Computing is not only about the user trusting\n the hardware, but also about the vendor distrusting the user\n\n\n-----\n\n# Why?\n\n\n-----\n\n# Where to test?\n\n##### •\n### Developing on actual hardware:\n\n##### •\n### Need an OMAP HS (not GP) Dev-board\n\n##### •\n### Beagleboards & co (OMAP) switch to normal world in ROM\n\n##### •\n### (Hardware is locked down with strong keys)\n\n\n-----\n\n# Where to test?\n\n##### •\n### Software emulation:\n\n##### •\n### QEMU supports ARM\n\n##### •\n### Paper “A flexible software development and emulation framework\n for ARM TrustZone”\n\n###### • “qemu-trustzone”\n\n • Johannes Winter, Paul Wiegele, Martin Pirker, and Ronald Toegl\n\n##### •\n### Open-source (GPL) TEE by sierraware (Open Virtualization)\n\n\n-----\n\n# Where to test?\n\n##### •\n### Using hardware hack for $vendor to execute code in TrustZone\n\n\n-----\n\n# Where to test?\n\n##### •\n### Let’s just hack into a TEE!\n\n\n-----\n\n# Getting a binary-image of a TEE\n\n##### •\n### Firmware updates are signed, but not encrypted.\n\n##### •\n### Firmware updates are often downloaded via HTTP.\n\n##### •\n### Vendors have ‘hidden’ FTP-servers.\n\n\n-----\n\n# Workflow\n\n##### •\n### Disassemble bootloader\n\n##### •\n### IDA Pro & co can’t just find code parts, need to analyze by hand &\n with scripts\n\n##### •\n### Analyze coprocessor instructions to find memory layout\n\n##### •\n### (almost automated)\n\n\n-----\n\n# Looking for mitigations\n\n\n-----\n\n# Looking for mitigations\n\n##### •\n### No ASLR\n\n##### •\n### No DEP (NX)\n\n##### •\n### Executable heap, stack, data, everything\n\n\n-----\n\n# Exploiting like it’s 1999\n\n## Yeah Baby!\n\n\n-----\n\n# Let’s talk about strncpy\n\n##### •\n### strncpy(char *destination, char *source, size_t destination_size);\n\n##### •\n### strncpy sucks, it only NUL-terminates if:\n\n##### •\n### strlen(destination) < destination_size\n\n##### •\n### (Please, use strlcpy. Also, did I mention I do code reviews?)\n\n##### •\n### Still often pretty hard to exploit.\n\n\n-----\n\n# Where to test?\n\n##### •\n### Official boards seem to be hard to obtain\n\n##### •\n### QEMU\n\n##### •\n### On smartphone via hardware hack\n\n##### •\n### On smartphone via software exploit\n\n\n-----\n\n# Scheduling the rootkit\n\n##### •\n### Switch to monitor mode in (ir)regular intervals without help of the\n operating system\n\n##### •\n### The latency induced by the switch to the rootkit must be kept as low\n as possible\n\n\n-----\n\n# Latency\n\n#### Normal world interrupt/SMC\n\n Monitor code\n\n Rootkit scheduler\n\n Monitor code\n\n Back to normal world\n\n\n-----\n\n# Latency\n\n#### Normal world interrupt/SMC\n\n Monitor code\n\n Rootkit scheduler\n\n Monitor code\n\n Back to normal world\n\n\n-----\n\n# Scheduling the rootkit\n\n##### •\n### ARM actually gives tips for running TrustZone invisible to the normal\n world:\n\n#### Does the Secure world care about direct or indirect Normal world visibility of its execution?\n\n If yes, then consider obfuscating interrupt timing, disabling Non-secure access to the Performance Counters, and performing selective cache maintenance on critical address ranges on world switch.\n\n\n-----\n\n# Scheduling the rootkit\n\n##### •\n### How is control transferred to the monitor mode?\n\n##### •\n### IRQ? Used a lot by the OS & can be masked by normal world\n\n##### •\n### External abort? Too unreliable & environment dependent\n\n##### •\n### FIQ? Can be locked down (NMI)\n\n##### •\n### Overwrite the interrupt vector (like Cloaker does)\n\n##### •\n### TZIC - TrustZone Interrupt Controller\n\n\n-----\n\n# IRQ ‘interception’\n\n#### IRQ Triggered Monitor saves state\n\n Rootkit executes\n\n “Real” IRQ\n handler is Monitor restores state\n called\n\n\n-----\n\n# Boot process\n\n### 1.Setup secure-world\n\n 2.Setup monitor\n\n 3.Lockdown TrustZone (Switch to normal world)\n\n 4.Start operating system/bootloader\n\n\n-----\n\n# Boot process\n\n### 1.Setup secure-world\n\n 2.Setup monitor\n\n 3.Lockdown TrustZone (Switch to normal world)\n\n 4.Start operating system/bootloader\n\n\n-----\n\n# Secure World Memory Setup\n\n##### •\n### Create page table for secure world\n\n##### •\n### Turn on MMU\n\n##### •\n### Configure stack\n\n##### •\n### Recommendation if no TEE is already available:\n\n##### •\n### Use physical address space next to a hardware mapping\n\n\n-----\n\n# Secure World Initialization\n\n##### •\n### Run initialization-routine of rootkit\n\n##### •\n### Configure ‘system-call’ facility of rootkit (IRQ)\n\n##### •\n### Load and create contexts for modules\n\n\n-----\n\n# Secure World\n\n##### •\n### Uses a timer-based slice ‘scheduler’ by default to keep time ~constant\n\n##### •\n### (Timing by TZIC - TrustZone Interrupt Controller)\n\n##### •\n### Store files in secure storage if available\n\n\n-----\n\n# Boot process\n\n### 1.Setup secure-world\n\n 2.Setup monitor\n\n 3.Lockdown TrustZone (Switch to normal world)\n\n 4.Start operating system/bootloader\n\n\n-----\n\n# Monitor\n\n##### •\n### Store normal world register banks and switch on NS bit\n\n##### •\n### Execute rootkit scheduler\n\n##### •\n### Store secure world register banks and switch off NS bit\n\n\n-----\n\n# Monitor\n\n##### •\n### Check if coming from normal or secure world:\n\n###### • mrc   p15, 0, r0, c1, c1, 0\n\n • tst r0\n\n • beq to_normal\n\n • bne to_secure\n\n\n-----\n\n# Monitor\n\n##### •\n### Storing the state of all register banks:\n\n###### STMIA r0!, {r0 - r13}\n\n CPS 0x19 ; SVC mode\n\n STMIA r0!, {r1, r13, lr}\n\n ... for all processor modes\n\n##### •\n### ... And vice versa for restoring the register banks\n\n\n-----\n\n# Monitor\n\n##### •\n### Be aware of cache + pipeline stuff!\n\n##### •\n### Use pipeline-flushing instructions\n\n##### •\n### Be sure to have your cache configuration right\n\n\n-----\n\n# Monitor setup\n\n##### •\n### Configure TCM for latency reduction\n\n##### •\n### Setup the interrupt interception mechanism\n\n##### •\n### (Set IRQ to secure in SCR (Secure Configuration Register))\n\n\n-----\n\n# Boot process\n\n### 1.Setup secure-world\n\n 2.Setup monitor\n\n 3.Lockdown TrustZone (Switch to normal world)\n\n 4.Start operating system/bootloader\n\n\n-----\n\n# Lockdown: SCR\n\n##### •\n### Security Configuration Register (C1 C1 on CP15)\n\n##### •\n### Disable modification of A & F bit in CPSR from Normal\n\n##### •\n### World for External Abort, FIQ, IRQ\n\n##### •\n### Actual NS bit\n\n\n-----\n\n# Lockdown: SCR\n\n##### •\n### Sample configuration:\n\n###### • mov r0, #0x3E\n\n • mcr   p15, 0, r0, c1, c1, 0\n\n##### •\n### Sets world for IRQ + FIQ to secure\n\n##### •\n### I decided to let the normal world mask the interrupts\n\n##### •\n### (Avoid suspicion)\n\n\n-----\n\n# Lockdown\n\n##### •\n### Depending on the hardware, some other configurations might be \n needed, too\n\n##### •\n### i.e. External storage may requires configuration to know which part is\n only accessible as secure\n\n##### •\n### TZPC (TrustZone Protection Controller) configuration\n\n\n-----\n\n# Boot process\n\n### 1.Setup secure-world\n\n 2.Setup monitor\n\n 3.Lockdown TrustZone (Switch to normal world)\n\n 4.Start operating system/bootloader\n\n\n-----\n\n# Start operating system\n\n##### •\n### TrustZone is configured and ready to go\n\n##### •\n### Operating system + loader starts unmodified\n\n##### •\n### Nothing to see here, move along!\n\n\n-----\n\n# Real world problems\n\n##### •\n### $vendor does power management setup\n in TrustZone\n\n##### •\n### Had to integrate vendor blob into\n custom TZ image\n\n\n-----\n\n# Chapter 2\n\n### It boots! And now?\n\n\n-----\n\n# We...\n\n##### •\n### Have an execution environment that is entirely separated from the\n normal OS\n\n##### •\n### Configured the CPU and its peripherals to hide any traces from our\n existence\n\n##### •\n### Get control of the CPU regularly\n\n\n-----\n\n# We can...\n\n##### •\n### access all user data\n\n##### • manipulate memory of everything\n\n •\n### communicate (kind of)\n\n\n-----\n\n# Yay!\n\n\n-----\n\n# Communication\n\n##### •\n### Difficult\n\n##### •\n### Talk to baseband\n\n##### •\n### Access to UMTS, which at least very difficult to sniff\n\n##### •\n### Create IP packets by directly talking to the network hardware\n\n##### •\n### See Cloaker paper\n\n##### •\n### Suspicious and easily detected\n\n\n-----\n\n# What else to do?\n\n##### •\n### There’s quite some secret stuff in TrustZone implementations\n\n##### •\n\n\n-----\n\n# Installation in the wild\n\n##### •\n### Via exploit in app\n\n##### •\n### Vendor delivered (either during manufacturing or by FW update)\n\n##### •\n### Baseband attack\n\n\n-----\n\n# Interoperability\n\n##### •\n### Ports to new hardware can be done in under a week:\n\n##### •\n### TrustZone is almost the same on all platforms\n\n##### •\n### Mostly peripherals and memory stuff differs\n\n##### •\n### TEE may has to be integrated, too\n\n##### •\n### Easy to do, i.e. modify OpenVirtualization TEE or binary patch\n\n\n-----\n\n# Detection methods\n\n##### •\n### Latency\n\n##### •\n### Be paranoid and only use phones that don’t have TrustZone\n\n##### •\n### Good luck with that one.\n\n\n-----\n\n# Thank you!\n\n##### •\n### Any questions?\n\n##### •\n### Thomas Roth - thomas.roth@leveldown.de - @stacksmashing\n\n##### •\n### Slides: http://leveldown.de/hip_2013.pdf\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://hackinparis.com/data/slides/2013/Slidesthomasroth.pdf"
    ],
    "report_names": [
        "Slidesthomasroth.pdf"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1371812734,
    "ts_modification_date": 1371812734,
    "files": {
        "pdf": "https://archive.orkl.eu/ccb72e09f1578aac64f2a6cfccfdec5f4f8f6f0b.pdf",
        "text": "https://archive.orkl.eu/ccb72e09f1578aac64f2a6cfccfdec5f4f8f6f0b.txt",
        "img": "https://archive.orkl.eu/ccb72e09f1578aac64f2a6cfccfdec5f4f8f6f0b.jpg"
    }
}