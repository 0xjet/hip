{
    "id": "a10ebd60-2930-4ba2-af47-19e0bf05e186",
    "created_at": "2023-01-12T15:07:27.647177Z",
    "updated_at": "2025-03-27T02:17:27.541077Z",
    "deleted_at": null,
    "sha1_hash": "4af40fde83861412d64d0cecbcbb9b1bd3b645d2",
    "title": "2021-01-07 - SolarWinds- How a Rare DGA Helped Attacker Communications Fly Under the Radar",
    "authors": "",
    "file_creation_date": "2022-05-28T23:07:24Z",
    "file_modification_date": "2022-05-28T23:07:24Z",
    "file_size": 1045472,
    "plain_text": "# SolarWinds: How a Rare DGA Helped Attacker Communications Fly Under the Radar\n\n**[symantec-enterprise-blogs.security.com/blogs/threat-intelligence/solarwinds-unique-dga](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/solarwinds-unique-dga)**\n\n\n-----\n\nThreat Hunter TeamSymantec\n\n## In the second of a series of follow-up analysis on the SolarWinds attacks, we examine how the attackers made command and control communications particularly stealthy.\n\nIn the weeks since [news of the SolarWinds attacks broke, we’ve continued our analysis into](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/sunburst-supply-chain-attack-solarwinds)\nthe tools used by the attackers. One of the most interesting things we’ve seen is the way the\nattackers configured their malware in order to contact a command and control (C&C) server\nvia DNS communications. It’s a technique that is rarely used, but there have been some\nreports of other APT groups such as Crambus (aka Oilrig) using it previously.\n\nSunburst (Backdoor.Sunburst), the malware which was used to Trojanize the SolarWinds\nOrion software, uses a domain generation algorithm (DGA) to generate domain names to\ncontact for C&C purposes. However, unlike most DGAs, this DGA does not just randomly\ngenerate characters. Instead, information is encoded into the text that makes up the\ngenerated domain names. By doing so, initial C&C actually happens via DNS, which\nprovides a stealthier level of communications.\n\nFor each infected computer, Sunburst generates a unique ID, referred to as a userid. The\nuserid is made up of the first active MAC address that is not the loopback address,\nconcatenated with the Windows Domain name of the computer, and then concatenated with\nthe Windows installation UUID, a randomly generated value at Windows installation time\nstored in HKLM\\SOFTWARE\\Microsoft\\Cryptography\\MachineGuid. These three values are\nthen MD5 hashed and the first 64 bits are XOR’d with the last 64 bits, resulting in a unique\n64-bit userid.\n\nBecause multiple DNS requests will have to be made to transmit all payload information, the\nattackers require a unique ID to know from which computer the information is coming from.\nDNS is a distributed protocol, meaning the infected computer does not contact the attacker’s\nC&C server directly, but instead the DNS request is passed through multiple intermediaries\nbefore reaching the attacker DNS server. Only by including the userid within the DNS\nrequest will the attackers be able to combine the multiple requests.\n\nThe DNS lookup will be in one of the following forms:\n\n<encoded information>.appsync-api.eu-west-1.avsvmcloud.com\n\n<encoded information> appsync-api us-west-2 avsvmcloud com\n\n\n-----\n\n<encoded information>.appsync-api.us-east-1.avsvmcloud.com\n\n<encoded information>.appsync-api.us-east-2.avsvmcloud.com\n\nThe encoded information will be in one of two forms providing the attackers either the\nWindows domain name of the infected organization or security product statuses and\nfeedback on the infected machine.\n\n## Windows Domain Name Payload\n\nInitially, after Sunburst [checks for or bypasses security tools and products, the first DNS](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/solarwinds-attacks-stealthy-attackers-attempted-evade-detection)\nlookup will occur containing the infected computer’s Windows domain name or a portion\nthereof, encoded into the C&C domain. The Windows domain is usually a human-readable\nstring representing the name of the organization the machine belongs to, e.g. AcmeA1Corp.\n\nThe DGA will start by prepending the aforementioned userid with a randomly chosen key\nbyte between 0x81 and 0xFE followed by the userid XOR’d with the key byte. These nine\nbytes are then encoded in a fashion similar to Base64, resulting in 15 characters.\n\nThis string of characters is then followed by the Windows domain name, encoded. Because\nWindows domain names can be up to 253 characters long, Sunburst chooses to segment\nthe Windows domain names into 14 character chunks preceded by the chunk number (where\nthe first chunk number is 0). Windows domain names longer than 14 characters will thus\nrequire more than one DNS lookup to provide the entire Windows domain name.\n\nSunburst will also resend previously sent chunks if an error was encountered or, under\ncertain error conditions, set the chunk number to a negative one. The segment chunk\nnumber and the Windows domain name are both encoded separately and appended to the\nencoded userid. These elements form the subdomain of the domain. This domain is queried\nvia DNS, which results in this encoded information reaching the attacker’s DNS server. The\nattacker can then decode the information and reply with further instructions, which will be\ncovered in a future blog.\n\nFigure 1. Structure of Sunburst DNS lookups\nSunburst does not automatically generate multiple DNS queries in order to send the entire\nWindows domain name. Whether Sunburst will send the remaining 14-character segments\ndepends on the response received from the initial DNS query. Because Sunburst was\ndelivered via a supply chain attack, many systems that are not of interest will be infected. By\nencoding the first 14 characters of the Windows domain name into the first DNS query, the\n\n\n-----\n\nattackers are able to triage infections and only mount second-state attacks on systems of\ninterest - those that have Windows domain names that match organizations they wish to\ntarget.\n\n## Security Product Status and Feedback Payload\n\nDepending on the response to the first DNS lookup, a second DNS lookup may occur that\nencodes the status of installed security products on the system and information on whether\nthe DNS communication has been successful.\n\nFirst, the userid is XOR’d by the third and second bytes of a timestamp value described\nbelow in an alternating fashion before being XOR’d by a randomly chosen key byte between\n0x01 and 0x7E that is then prepended to the userid. The first byte thus provides not only the\nkey byte, but informs the attackers if the remaining content will contain the Windows domain\nname payload (key byte is between 0x81 and 0xFE) or the security product status and\nfeedback payload (key byte is between 0x01 and 0x7E).\n\nAfter the userid, a nibble (half a byte) is used to specify if the security payload information\nhas content (nibble is set to 2) or is blank (nibble is set to 1). This is followed by a timestamp\nin UTC of when the DNS query was sent, granular to 30-minute increments. The last bit of\nthe timestamp is set to a bit flag representing whether the previous DNS response\nsuccessfully contained partial or full instructions to start the secondary HTTP communication\nchannel. This may have been designed by the attackers as a feedback mechanism to ensure\nthe DNS communication mechanism is working before sending the full HTTP communication\nchannel details and, in the case of full details, a signal that the HTTP communication should\nhave already started. After the timestamp, the security product status payload is optionally\nprovided if select security product services were found as running.\n\nThe two bytes contain a bitmask that encodes information on whether any of the following\nsecurity products were not found, or found running and/or subsequently disabled and\nstopped:\n\nCrowdStrike\nCarbon Black\nFireEye\nESET\nF-Secure\nMicrosoft Defender\n\nThe userid, timestamp, feedback bit, and optional security product data are then encoded\ninto text as the subdomain of a DNS query that is sent to the attackers.\n\n\n-----\n\nFigure 2. Structure of second DNS lookup communicating security product status\nThe responses to these DNS queries may then contain control information for the threat to\nterminate or launch a secondary HTTP communication channel, something that we plan to\ncover in a subsequent blog.\n\n## Protection/Mitigation\n\nTools associated with these attacks will be detected and blocked on machines running\nSymantec Endpoint products.\n\n**File-based protection:**\n\nBackdoor.Sunburst\nBackdoor.Sunburst!gen1\nBackdoor.SuperNova\nBackdoor.Teardrop\n\n**Network-based protection:**\n\nSystem Infected: Sunburst Malware Activity\n\n## About the Author\n\n### Threat Hunter Team\n\n**Symantec**\n\nThe Threat Hunter Team is a group of security experts within Symantec whose mission is to\ninvestigate targeted attacks, drive enhanced protection in Symantec products, and offer\nanalysis that helps customers respond to attacks.\n\n## Want to comment on this post?\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-07 - SolarWinds- How a Rare DGA Helped Attacker Communications Fly Under the Radar.pdf"
    ],
    "report_names": [
        "2021-01-07 - SolarWinds- How a Rare DGA Helped Attacker Communications Fly Under the Radar.pdf"
    ],
    "threat_actors": [
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536047,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653779244,
    "ts_modification_date": 1653779244,
    "files": {
        "pdf": "https://archive.orkl.eu/4af40fde83861412d64d0cecbcbb9b1bd3b645d2.pdf",
        "text": "https://archive.orkl.eu/4af40fde83861412d64d0cecbcbb9b1bd3b645d2.txt",
        "img": "https://archive.orkl.eu/4af40fde83861412d64d0cecbcbb9b1bd3b645d2.jpg"
    }
}