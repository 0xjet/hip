{
    "id": "fd7f0ecf-1b13-4bf1-bb29-19a5e3ed1cc1",
    "created_at": "2023-01-12T15:08:10.883311Z",
    "updated_at": "2025-03-27T02:05:42.832341Z",
    "deleted_at": null,
    "sha1_hash": "87b6455422fc99c4adb3cf61bfbb4a40def94f56",
    "title": "2022-03-10 - Detecting HermeticWiper",
    "authors": "",
    "file_creation_date": "2022-05-28T23:22:53Z",
    "file_modification_date": "2022-05-28T23:22:53Z",
    "file_size": 1438196,
    "plain_text": "# Detecting HermeticWiper\n\n**[splunk.com/en_us/blog/security/detecting-hermeticwiper.html](https://www.splunk.com/en_us/blog/security/detecting-hermeticwiper.html)**\n\nMarch 10, 2022\n\nBy [Splunk Threat Research Team March 10,](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)\n\n\n2022\n\n\n-----\n\n[As stated in our previous threat advisory STRT-TA02 in regards to destructive software,](https://www.splunk.com/en_us/blog/security/threat-advisory-strt-ta02-destructive-software.html)\npast historical data suggests that for malicious actors to succeed in long-standing\ncampaigns they must improve and add new ways of making their payloads stealthier,\nresistant, and damaging. HermeticWiper introduces some unique features, applying\ndestructive actions on compromised hosts. In addition to other commonly known wiper\n[destructive features, HermeticWiper also presents the following unique behaviors:](https://www.sentinelone.com/labs/hermetic-wiper-ukraine-under-attack/)\n\nInteracts with the system via signed driver\nDisables crash dump functionality (Anti-Forensic)\nModifies “GlobalFolderOptions” registry at file permission level (NTFS)\nChecks for FAT (Windows XP) and NTFS (Windows OS newer than XP using NTFS)\nCorrupts (Destroys) MBR and NTFS file system\nReported to have been deployed via Group Policy Object (Windows Active Directory\nGroup Policy Object)\n\nThis payload is another destructive tool in the ongoing campaign which has included DDoS\n[attacks, web defacements, MDM attacks,](https://www.cisa.gov/mdm) [Microsoft SQL attacks and now](https://www.cvedetails.com/cve/CVE-2021-1636/) two known as of\nyet destructive payloads.\n\n[STRT has also released a new analytic story covering HermeticWiper itself. We have](https://research.splunk.com/stories/hermetic_wiper/)\ncollected information about the observed vectors in relation to HermeticWiper according to\n[several security vendors including Symantec,](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/ukraine-wiper-malware-russia) [ESET,](https://www.welivesecurity.com/2022/03/01/isaacwiper-hermeticwizard-wiper-worm-targeting-ukraine/) [Sentinel One. The following diagram](https://www.sentinelone.com/labs/hermetic-wiper-ukraine-under-attack/)\nshows a visual flow of the observed attack vectors per tactic.\n\nAs seen above malicious actors are gaining initial access by either compromising publicly\nexposed services or via spear phishing, following the establishment of persistence and\nprivilege escalation via web shells or the use of schtasks, PowerShell payloads, and finally\ndeploying additional payloads via certutil.exe or Powershell which include genuine wiper\n\n\n-----\n\npayloads and ransomware decoy binaries seeking to distract and delay defense and\ncontainment from defenders. Here is a brief breakdown of HermeticWiper features and\ndetections.\n\n## HermeticWiper Analysis\n\nSigned driver (hermetic name reference)\n\n\n-----\n\n## Dropping Driver Component Base on Windows Version (XP or above)\n\nThis wiper will first adjust its token privileges with “SeShutdownPrivilege” and\n“SeBackupPrivilege” for later purposes like initiating shutdown or accessing files with highsecurity descriptor context.\n\nIt contains 4 compressed drivers in its RSRCsection. It will drop one of those drivers\ndepending on the Windows version or OS architecture of the compromised host by using\nVerifyVersionW API. Below is the summary table of the RSRC TYPE ID and the name of its\nrsrc entry for each driver.\n\n\n**RSRC TYPE**\n**ID**\n\n\n**RSRC NAME** **Description**\n\n\nRCDATA DRV_X64 Driver for x64 bit architecture\n\nRCDATA DRV_X32 Driver for x32 bit architecture\n\nRCDATA DRV_XP_X64 Driver for lower version OS (e.g XP) x64 bit\narchitecture\n\nRCDATA DRV_XP_X64 Driver for lower version OS (e.g XP) x32 bit\narchitecture\n\nThen it will generate random characters based on the current process ID of its running\nprocess. Once the wiper parses the needed rsrc entry, and has a filename, It will locate the\nC:\\windows\\system32\\Drivers folder to drop its driver component.\n\nThe driver extracted from the rsrc section of this wiper is in LZW compressed (SZDD file\nformat). The screenshot below shows how it uses LZ API to decompress that to retrieve the\nactual driver binary file.\n\n\n-----\n\nInterestingly during analysis, we found out that it drops both the compressed driver (<4 char\nrandom name> without file extension) and also the actual driver (<4 char random name>\nwith .sys file extension) in C:\\windows\\system32\\Drivers. Then it will delete the compressed\nversion afterwards.\n\n## Disable Crash Dump\n\nIt also has some features where it disables the generation of crash dumps of the\ncompromised host that serve as anti-forensic techniques. This is done by modifying a\nregistry as shown in the screenshot below:\n\n## Loading The Driver\n\nThe way it loads its driver component is by creating a service entry for that file. First It will\nadjust its token privilege with “SeLoadDriverPrivilege”. If the service related to its driver\ndoes not exist it will just create and start a new service for it using CreateServiceW() and\nStartServiceW() API. If it already exists but is not active, it will modify the service config of\nthat kernel driver to DEMAND_START to start the service. Below is the code, how it uses\nChangeServiceConfigW() API to change the status of its driver if it is not active. This driver\nis a legitimate component of the EaseUS Partition Master application. This file was\nleveraged by this wiper to interact and retrieve storage device information for its destructive\npurposes.\n\n\n-----\n\n## Corrupting Boot Sectors\n\nThe wiper starts to enumerate all possible physical devices connected to the compromised\nhost (range 0-100 device). Below is the code how it enumerates all the devices and\nretrieves partition information of each device using DeviceIoControl() API. The function\nnamed “mw_GetDeviceNumberAndGeometry” is the function it uses to check if the physical\ndevice is “FILE_DEVICE_DISK” type or not.\n\n\n-----\n\nIt also checks what File System type is present at Device, if it is either “NTFS” OR “FAT”.\nThis checking will help the wiper to enumerate all of its partitions to corrupt all possible boot\nrecords on it. It also looks for known NTFS files like $Bitmap, $LogFile, $DATA, and many\nmore to be overwritten as part of its file destruction payload.\n\n\n-----\n\nBelow is the code of the Volume Boot Record partition before and after the infection of\nHermetic wiper to the compromised host.\n\n\n-----\n\n-----\n\n## Other Registry Modification\n\nIt also has a thread that will modify certain GlobalFolderOptions registry related to showing\ncompressed files and information tips.\n\n## Trigger Shutdown\n\nAnother thread of this malware is responsible for shutting down the compromised host to\nmake the corruption of boot sectors take effect.\n\n\n-----\n\n## Other Behaviors\n\n1. Check the C:\\Windows\\SYSVOL attribute using GetFileAttributeW() API. If the API\n\nreturns an invalid handle(possible return if the folder path does not exist) or if it is a\nfolder path it will continue the execution if not exit the process.\n2. Disables the VSS service which is related to volume shadow copy service to disable\n\ncreation of backup copies.\n\nIt also has a function that can dismount or lock a disk volume.\n\n\n-----\n\n## PartyTicket Analysis\n\n[During eset analysis in this incident, they found another binary where they named it as](https://www.welivesecurity.com/2022/03/01/isaacwiper-hermeticwizard-wiper-worm-targeting-ukraine/)\n“Hermetic Ransom”. This is a Golang compiled ransomware binary where it tries to encrypt\nfiles in the compromised host. Below is the screenshot of its code snippet where it renames\nthe encrypted files with “.encryptedJB” file extension.\n\n\n-----\n\nIt will also drop a ransomware note in the desktop named as “read_me.html” to inform the\nuser that their machine is compromised and encrypted.\n\nAside from its encryption features, this binary uses strings to its code function name that\nreference US President Biden.\n\n\n-----\n\n## Detections\n\nThe following detections are focused specifically on HermeticWiper, Splunk STRT has a\nsignificant number of analytic stories that cover Ransomware which should also be\nconsidered when detecting and hunting for these types of threats.\n\n### Windows File Without Extension In Critical Folder\n\nThis analytic is to look for suspicious file creation in the critical folder like\n\"System32\\Drivers\" folder without file extension.\n\n\n-----\n\n| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Filesystem\nwhere Filesystem.file_path IN (\"*\\\\System32\\\\drivers\\\\*\", \"*\\\\syswow64\\\\drivers\\\\*\")\n\nby _time span=5m Filesystem.dest Filesystem.user\n\nFilesystem.file_name Filesystem.file_path Filesystem.process_guid\nFilesystem.file_create_time\n\n| `drop_dm_object_name(Filesystem)`\n\n| rex field=\"file_name\" \"\\.(?<extension>[^\\.]*$)\"\n\n| where isnull(extension)\n\n| join process_guid\n\n[| tstats `security_content_summariesonly` count FROM\ndatamodel=Endpoint.Processes\n\nby _time span=5m Processes.process_name Processes.dest\nProcesses.process_guid\n\nProcesses.user\n\n| `drop_dm_object_name(Processes)`]\n\n| stats count min(_time) as firstTime max(_time)\n\nas lastTime by dest process_name process_guid file_name file_path file_create_time\nuser\n\n| `security_content_ctime(firstTime)`\n\n| `security_content_ctime(lastTime)`\n\n\n-----\n\n**Windows Raw Access To Master Boot Record Drive**\n\nThis analytic is to look for suspicious raw access read to the device where the master boot\nrecord is placed.\n\n`sysmon` EventCode=9 Device = \\\\Device\\\\Harddisk0\\\\DR0 NOT (Image\nIN(\"*\\\\Windows\\\\System32\\\\*\", \"*\\\\Windows\\\\SysWOW64\\\\*\"))\n\n| stats count min(_time) as firstTime max(_time) as lastTime by Computer Image Device\nProcessGuid ProcessId EventDescription EventCode\n\n| `security_content_ctime(firstTime)`\n\n| `security_content_ctime(lastTime)`\n\n\n-----\n\n**Windows Disable Memory Crash Dump**\n\nThe following analytic identifies a process that is attempting to disable the ability on\nWindows to generate a memory crash dump.\n\n| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry\n\nwhere\n(Registry.registry_path=“*\\\\CurrentControlSet\\\\Control\\\\CrashControl\\\\CrashDumpEnabled”)\nAND Registry.registry_value_data=“0x00000000\" by _time span=1h Registry.dest\nRegistry.user\n\nRegistry.registry_path Registry.registry_value_name Registry.registry_value_data\n\nRegistry.process_guid Registry.registry_key_name | `drop_dm_object_name(Registry)`\n\n|join process_guid [| tstats `security_content_summariesonly`\n\ncount FROM datamodel=Endpoint.Processes by _time span=1h Processes.process_id\nProcesses.process_name\n\nProcesses.process Processes.dest Processes.parent_process_name\nProcesses.parent_process\n\nProcesses.process_guid | `drop_dm_object_name(Processes)` | fields _time dest user\nparent_process_name parent_process process_name\n\nprocess_path process process_guid registry_path registry_value_name\nregistry_value_data\n\nregistry_key_name] | table _time dest user parent_process_name parent_process\nprocess_name\n\nprocess_path process process_guid registry_path registry_value_name\nregistry_value_data\n\nregistry_key_name\n\n\n-----\n\n### Windows Modify Show Compress Color And Info Tip Registry\n\n| tstats `security_content_summariesonly` count from datamodel=Endpoint.Registry\n\nwhere Registry.registry_path =\n\"*\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Advanced*\"\n\nAND Registry.registry_value_name IN(\"ShowCompColor\", \"ShowInfoTip\")\n\nby _time span=1h Registry.dest Registry.user Registry.registry_path\nRegistry.registry_value_name\n\nRegistry.registry_value_data Registry.process_guid | `drop_dm_object_name(Registry)`\n\n|rename process_guid as proc_guid |join proc_guid, _time [| tstats\n`security_content_summariesonly`\n\ncount FROM datamodel=Endpoint.Processes by _time span=1h Processes.process_id\nProcesses.process_name\n\nProcesses.process Processes.dest Processes.parent_process_name\nProcesses.parent_process\n\nProcesses.process_guid | `drop_dm_object_name(Processes)` |rename process_guid\nas\n\nproc_guid | fields _time dest user parent_process_name parent_process process_name\n\nprocess_path process proc_guid registry_path registry_value_name\nregistry_value_data]\n\n| table _time dest user parent_process_name parent_process process_name\nprocess_path\n\nprocess proc_guid registry_path registry_value_name registry_value_data\n\n\n-----\n\nThis analytic is to look for suspicious registry modification related to file compression color\nand information tips.\n\n\n**Name** **Technique**\n**ID**\n\n\n**Tactic** **Description**\n\n\nCMD Carry Out\n[String Command](https://research.splunk.com/endpoint/cmd_carry_out_string_command_parameter/)\nParameter\n\nExecutable File\nWritten in\nAdministrative\nSMB Share\n\nRegsvr32 Silent\n[and Install Param](https://research.splunk.com/endpoint/regsvr32_silent_and_install_param_dll_loading/)\nDll Loading\n\nExecutables Or\n[Script Creation In](https://research.splunk.com/endpoint/executables_or_script_creation_in_suspicious_path/)\nSuspicious Path\n\n\n[T1059.003](https://attack.mitre.org/techniques/T1059/003/) Execution The following analytic identifies\ncommand-line arguments where\ncmd.exe /c is used to execute a program\n\n\n[T1036](https://attack.mitre.org/techniques/T1036) Execution This analytic will identify suspicious\nexecutable or scripts (known file\n\nextensions) in list of suspicious file\npaths in Windows.\n\n\n[T1021.002](https://attack.mitre.org/techniques/T1021/002/) Lateral\nMovement\n\n[T1218.010](https://attack.mitre.org/techniques/T1281/010/) Defense\nEvasion\n\n\nThe following analytic identifies\nexecutable files (.exe or .dll) being\nwritten to Windows administrative SMB\nshares (Admin$, IPC$, C$)\n\nThis analytic is to detect a loading of dll\nusing regsvr32 application with silent\nparameter and dllinstall execution.\n\n\n-----\n\nSuspicious\nProcess File Path\n\nImpacket Lateral\nMovement\nCommandline\nParameters\n\nRunDLL Loading\nDLL By Ordinal\n\nWevtUtil Usage\nTo Clear Logs\n\nWindows Raw\nAccess To Disk\nVolume\nPartition(New)\n\nWindows Modify\nShow Compress\nColor And Info\nTip\nRegistry(New)\n\nWindows Disable\nMemory Crash\nDump(New)\n\n\n[T1543](https://attack.mitre.org/techniques/T1543/) Persistence,\nPrivilege\nEscalation\n\n\n[T1485](https://attack.mitre.org/techniques/T1485/) Impact The following analytic identifies a\nprocess that is attempting to disable the\nability on Windows to generate a\nmemory crash dump.\n\n\n[T1021](https://attack.mitre.org/techniques/T1021/)\n\n[T1021.002](https://attack.mitre.org/techniques/T1021/002/)\n\n[T1021.003](https://attack.mitre.org/techniques/T1021/003/)\n\n[T1047](https://attack.mitre.org/techniques/T1047/)\n\n[T1543.003](https://attack.mitre.org/techniques/T1543/003/)\n\n[T1218](https://attack.mitre.org/techniques/T1218/)\n\n[T1218.011](https://attack.mitre.org/techniques/T1218/011/)\n\n\nLateral\nMovement\n\nExecution\n\nPersistence,\nPrivilege\nEscalation\n\nDefense\nEvasion\n\n\nThe following analytic will detect a\nsuspicious process running in a file path\nwhere a process is not commonly seen\nand is most commonly used by malicious\nsoftware.\n\nThis analytic looks for the presence of\nsuspicious commandline parameters\ntypically present when using Impacket\ntools.\n\nThe following analytic identifies\nrundll32.exe loading an export function\nby ordinal value.\n\nThe wevtutil.exe application is the\nwindows event log utility. This searches\nfor wevtutil.exe with parameters for\nclearing the application, security, setup,\npowershell, sysmon, or system event\nlogs.\n\n\n[T1070.001](https://attack.mitre.org/techniques/T1071/001/) Defense\nEvasion\n\n\n[T1561.002](https://attack.mitre.org/techniques/T1561/002/) Impact This analytic is to look for suspicious raw\naccess read to device disk partitions of\nthe host machine.\n\n\n[T1112](https://attack.mitre.org/techniques/T1112) Defense\nEvasion\n\n\nThis analytic is to look for suspicious\nregistry modification related to file\ncompression color and information tips.\n\n\n-----\n\nWindows File\nWithout\nExtension In\nCritical Folder\n(New)\n\nWindows Raw\nAccess To Master\nBoot Record\nDrive(New)\n\n## Mitigation\n\n\n[T1485](https://attack.mitre.org/techniques/T1485/) Persistence,\nPrivilege\nEscalation\n\n\nThis analytic is to look for suspicious file\ncreation in the critical folder like\n\"System32\\Drivers\" folder without file\nextension.\n\n\n[T1561.002](https://attack.mitre.org/techniques/T1561/002/) Impact This analytic is to look for suspicious raw\naccess read to drive where the master\nboot record is placed.\n\n\n[Many of these exploits can be prevented by following CISA guides for preparation and](https://www.cisa.gov/uscert/ncas/tips/ST18-271)\n[hardening of systems, applications, and networks, including MDM attacks as well. There is](https://www.cisa.gov/tips/st13-003)\n[also a free HermeticRansom/PartyTicket decryptor by AVAST and](https://decoded.avast.io/threatresearch/help-for-ukraine-free-decryptor-for-hermeticransom-ransomware/) [CrowdStrike. The](https://www.crowdstrike.com/blog/how-to-decrypt-the-partyticket-ransomware-targeting-ukraine/)\nfollowing table shows Splunk coverage of the aforementioned attack vectors in this ongoing\ncampaign.\n\n**Attack Vectors** **Tactic** **TTP** **Splunk Coverage**\n\n\nMicrosoft SQL Server\n\n[CVE-2021-1636](https://www.cvedetails.com/cve/CVE-2021-1636/)\n\n\nPrivilege Escalation [T1068](https://attack.mitre.org/techniques/T1068/) Windows Privilege\nEscalation\n\n\nWebshell Persistence [T1505](https://attack.mitre.org/techniques/T1505/003/) W3WP Spawning\nShell\n\nTomcat Initial Access [T1190](https://attack.mitre.org/techniques/T1190/) Linux Java\nSpawning Shell\n\nUse of certutil.exe Command & Control [T1105](https://attack.mitre.org/techniques/T1105/) Ingress Tool\nTransfer\n\n\nUse Schtasks to\nexecute payloads\n\n\nExecution, Persistence,\nPrivilege Escalation\n\n\n[T1053](https://attack.mitre.org/techniques/T1053/005/) Windows\n[Persistence](https://research.splunk.com/stories/windows_persistence_techniques/)\nTechniques\n\n\n-----\n\nPowershell payload\nexecution\n\n\nExecution [T1059.001](https://attack.mitre.org/techniques/T1059/001/) Malicious\nPowershell\n\n\nDeployment via GPO Defense Evasion, Privilege\nEscalation\n\n\n[T1484](https://attack.mitre.org/techniques/T1484/) Windows Privilege\nEscalation\n\n\nRansomware Decoys\n\nHermeticRansom/\nPartyTicket\n\n\nDefense Evasion [T1027](https://attack.mitre.org/techniques/T1027/) [Ransomware](https://research.splunk.com/stories/ransomware/)\n\nRansomware\n[Investigate &](https://research.splunk.com/playbooks/ransomware_investigate_and_contain/)\nContain\n\nRansomware\nCloud\n\n\nSpearphishing Initial Access [T1566.002](https://attack.mitre.org/techniques/T1566/002/) Spearphishing\nattachments\n\n[Suspicious Emails](https://research.splunk.com/stories/suspicious_emails/)\n\n[HermeticWiper Analytic Story is available in ESCU release v3.36.0](https://github.com/splunk/security_content/releases/tag/v3.36.0)\n\nAlso available from Splunk SOAR for automated response against these threats:\n\n## Learn More\n\n[You can find the latest content about security analytic stories on research.splunk.com. For a](https://research.splunk.com/)\n[full list of security content, check out the release notes on](https://docs.splunk.com/Documentation/ESSOC/3.21.0/RN/Enhancements) [Splunk Docs.](https://docs.splunk.com/Documentation/ESSOC)\n\n## Contributors\n\nWe would like to thank the following for their contributions to this post.\n\nTeoderick Contreras\nRod Soto\nJose Hernandez\nPatrick Barreiss\nLou Stella\nMauricio Velazco\nMichael Haag\nBhavin Patel\nEric McGinnis\n\n\n-----\n\nPosted by\n\n**[Splunk Threat Research Team](https://www.splunk.com/en_us/blog/author/secmrkt-research.html)**\n\nThe Splunk Threat Research Team is an active part of a customer’s overall defense\nstrategy by enhancing Splunk security offerings with verified research and security content\nsuch as use cases, detection searches, and playbooks. We help security teams around the\nglobe strengthen operations by providing tactical guidance and insights to detect,\ninvestigate and respond against the latest threats. The Splunk Threat Research Team\nfocuses on understanding how threats, actors, and vulnerabilities work, and the team\n[replicates attacks which are stored as datasets in the Attack Data repository.](https://github.com/splunk/attack_data/)\n\nOur goal is to provide security teams with research they can leverage in their day to day\noperations and to become the industry standard for SIEM detections. We are a team of\nindustry-recognized experts who are encouraged to improve the security industry by\nsharing our work with the community via conference talks, open-sourcing projects, and\nwriting white papers or blogs. You will also find us presenting our research at conferences\nsuch as Defcon, Blackhat, RSA, and many more.\n\n[Read more Splunk Security Content.](https://github.com/splunk/security_content)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-10 - Detecting HermeticWiper.pdf"
    ],
    "report_names": [
        "2022-03-10 - Detecting HermeticWiper.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536090,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653780173,
    "ts_modification_date": 1653780173,
    "files": {
        "pdf": "https://archive.orkl.eu/87b6455422fc99c4adb3cf61bfbb4a40def94f56.pdf",
        "text": "https://archive.orkl.eu/87b6455422fc99c4adb3cf61bfbb4a40def94f56.txt",
        "img": "https://archive.orkl.eu/87b6455422fc99c4adb3cf61bfbb4a40def94f56.jpg"
    }
}