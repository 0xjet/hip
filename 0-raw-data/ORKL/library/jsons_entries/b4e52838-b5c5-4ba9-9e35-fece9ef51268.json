{
    "id": "b4e52838-b5c5-4ba9-9e35-fece9ef51268",
    "created_at": "2023-01-12T15:03:56.090965Z",
    "updated_at": "2025-03-27T02:05:37.947388Z",
    "deleted_at": null,
    "sha1_hash": "05daf42dce295ff7ea14a7237bc9af55de7ac98f",
    "title": "2022-04-13 - Qakbot Series- Configuration Extraction",
    "authors": "",
    "file_creation_date": "2022-06-01T12:23:31Z",
    "file_modification_date": "2022-06-01T12:23:31Z",
    "file_size": 735563,
    "plain_text": "# Qakbot Series: Configuration Extraction\n\n**[malwarology.com/2022/04/qakbot-series-configuration-extraction/](https://www.malwarology.com/2022/04/qakbot-series-configuration-extraction/)**\n\n2022-04-13\n\n\nApril 13, 2022\n\n\n[Malware Analysis,](https://www.malwarology.com/categories/malware-analysis) [Qakbot](https://www.malwarology.com/categories/qakbot)\nIn late March 2022, I was requested to analyze a software artifact. It was an instance of\nQakbot, a modular information stealer known since 2007. Differently to other analyses I do\nas part of my daily job, in this particular case I can disclose wide parts of it with you readers.\nI’m addressing them in a post series. Here, I’ll discuss about the configuration extraction\n[based on this specific sample.](https://www.virustotal.com/gui/file/8565e3e213572cbd7c3df45ae3fadd094831aef7b63d3b389e57097c1b8602d6/detection)\n\nThe configuration of recent Qakbot samples is often stored in two distinct resources of the\nunpacked payload. Each resource contains a different part of the configuration. A first\nresource, usually the shortest one in size, contains general settings such as the botnet\nidentifier and the campaign timestamp. A second resource, usually bigger in size, contains\nthe list of command and control IP addresses and ports. Both resources are encrypted and\nthis post is all about discussing how Qakbot decrypts its configuration.\n\n**Figure 1**\n\nQakbot resouces storing the malware configuration\n\nAs you may notice from Figure 1, our sample contains two encrypted sections. The smaller\nin size is labelled “524” and the bigger in size is labelled “118”. Those two sections labels\naren’t new to the malware research community since the existence of other Qakbot samples\n[sharing the same resource labels is documented (see, as an example, Tavares - 2021). Both](https://seguranca-informatica.pt/a-taste-of-the-latest-release-of-qakbot/amp/)\nresources are encrypted with a custom implementation of the RC4 algorithm. The RC4 key\n\n-----\n\nscheduling algorithm is implemented in the function starting at 0xb339f9. The RC4 pseudorandom generation algorithm is implemented in the function starting at 0xb33924. The key\nused to decrypt the resources is the SHA1 of the string:\n```\n\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\n\n```\nNotice that you won’t find that string into the sample because it is obfuscated. If you are\n[interested in the Qakbot strings obfuscation technique, I discuss it in this post.](https://www.malwarology.com/2022/04/qakbot-series-string-obfuscation/)\n\n**Figure 2**\n\nDecompiled listing of the Qakbot general configuration extraction\n\nQakbot contains a custom implementation of the SHA1 algorithm. The implementing function\nis located at 0xb3745c. Figure 2 shows the listing of the function responsible for the\nconfiguration extraction from the resource “524” located at 0xb234bb. As you may notice, the\nresource label and the key string are obfuscated and we added their de-obfuscated\n\n\n-----\n\ncounterpart as comments . Moreover, you may notice an example of junk API call (BitBlt)\nplaced into the code just to distract the analyst. I’ll pospone a general discussion about junk\ncode injection and other Qakbot anti-analysis techniques in a dedicated post.\n\n**Figure 3**\n\nDecompiled listing of the Qakbot resource decryption and validation\n\nThe actual decryption and validation is accomplished by the function located at 0xb2f7ac and\nshowed in Figure 3. From that listing you may notice that the sample decrypts the resource\nby calling the RC4 functions. The format of the decrypted resource is composed of two fields:\na first field sized in 20 bytes containing the expected SHA1 of the content and a second field\nconsisting of the actual content of the resource. The validation is accomplished by computing\nthe SHA1 of the content field and then by comparing it with the expected SHA1 in the first\nfield. If the validation succeeds, the just decrypted content is placed in a buffer.\n\n**Figure 4**\n\nDecrypted content of resource \"524\"\n\n\n-----\n\nAs already mentioned, the two resources contain different aspects of the Qakbot\nconfiguration. The content of resource “524” is structured in key-value pairs where each pair\nrepresent a configuration field. The key component is an integer identifier of the field. The\nvalue is unstructured since it may contain strings, integers, or even timestamps. As you may\nnotice from Figure 4, showing the decrypted content of resource “524”, the configuration\ncontain just two fields: field 10, containing the botnet identifier, and field 3 containing what is\noften referred as the campaign identifier. Actually, field 3 is a Unix timestamp probably\nindicating the creation date of the campaign. Older Qakbot samples were used to contain a\n[richer configuration (Kremez - 2018).](https://www.vkremez.com/2018/07/lets-learn-in-depth-reversing-of-qakbot.html)\n\n**Figure 5**\n\nStructure of the network configuration resource (decrypted)\n\nResource “118” contains the network configuration of the sample. It is structured in records\nseparated by the byte 0x01. Each record is composed of four bytes each one representing\nan IP address octet and additional two bytes representing the port. The network\nconfiguration for the sample object of analysis contains 150 command and control IP\naddresses and ports. Figure 5 shows the format of the unencrypted network configuration\n[resource. You may find all the C2 addresses here.](https://www.malwarology.com/text/2-qakbot-conf-extraction/c2ips.txt)\n\nAs always, if you want to share comments or feedbacks (rigorously in broken Italian or\nbroken English) do not esitate to drop me a message at admin[@]malwarology.com.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-13 - Qakbot Series- Configuration Extraction.pdf"
    ],
    "report_names": [
        "2022-04-13 - Qakbot Series- Configuration Extraction.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535836,
    "ts_updated_at": 1743041137,
    "ts_creation_date": 1654086211,
    "ts_modification_date": 1654086211,
    "files": {
        "pdf": "https://archive.orkl.eu/05daf42dce295ff7ea14a7237bc9af55de7ac98f.pdf",
        "text": "https://archive.orkl.eu/05daf42dce295ff7ea14a7237bc9af55de7ac98f.txt",
        "img": "https://archive.orkl.eu/05daf42dce295ff7ea14a7237bc9af55de7ac98f.jpg"
    }
}