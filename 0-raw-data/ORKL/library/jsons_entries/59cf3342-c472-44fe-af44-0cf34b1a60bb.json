{
    "id": "59cf3342-c472-44fe-af44-0cf34b1a60bb",
    "created_at": "2023-01-12T15:09:08.408009Z",
    "updated_at": "2025-03-27T02:06:12.816523Z",
    "deleted_at": null,
    "sha1_hash": "ce711265343d5007132d6abb34dfb897a59ca468",
    "title": "2022-01-22 - BazarISO Analysis - Loading with Advpack.dll",
    "authors": "",
    "file_creation_date": "2022-05-28T05:06:57Z",
    "file_modification_date": "2022-05-28T05:06:57Z",
    "file_size": 109443,
    "plain_text": "# BazarISO Analysis - Loading with Advpack.dll\n\n**forensicitguy.github.io/bazariso-analysis-advpack/**\n\n### By Tony Lambert Posted 2022-01-22 Updated 2022-03-28 8 min read\n\n\nJanuary 22, 2022\n\n\n### Malware comes in all shapes and sizes, and in the case of BazarISO it comes in the form of an ISO file that contains a malicious shortcut and an executable. In this post I’ll tear apart the ISO to show how one of the more recent BazarISO samples works. If you want to follow along at home, I’m using the sample from MalwareBazaar here: https://bazaar.abuse.ch/sample/38cf92de5c97f9f79ddfb5632ac92f2670f3aa25414943735dd be24507ad49f3/\n\n## Triage and Unpack the ISO\n\n### First, let’s make sure the file is an ISO with file .\n```\n  remnux@remnux:~/cases/bazariso$ file Documents  17.iso \n  Documents-17.iso: ISO 9660 CD-ROM filesystem data\n  ''\n\n Alright, let’s take a stab at unpacking with 7z .\n\n```\n\n-----\n\n```\n  remnux@remnux:~/cases/bazariso$ 7z x Documents-17.iso \n  7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21\n  p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,2 CPUs\n  Intel(R) Core(TM) i7-8550U CPU @ 1.80GHz (806EA),ASM,AES-NI)\n  Scanning the drive for archives:\n  1 file, 743424 bytes (726 KiB)\n  Extracting archive: Documents-17.iso\n  -  Path = Documents-17.iso\n  Type = Iso\n  Physical Size = 743424\n  Created = 2022-01-21 09:15:47\n  Everything is Ok \n  Files: 2\n  Size:    689865\n  Compressed: 743424\n\n### And 7-zip gave us the very life-affirming message that Everything is OK since both files in the ISO unpacked properly. Let’s see what files we have.\n\n```\n\n-----\n\n```\n  remnux@remnux:~/cases/bazariso$ ls -lah\n  total 1.4M\n  drwxrwxr-x 2 remnux remnux 4.0K Jan 22 17:44 .\n  drwxrwxr-x 10 remnux remnux 4.0K Jan 22 17:24 ..\n  -rw-rw-r-- 1 remnux remnux 673K Jan 21 09:15 autorun.exe\n  -rw-rw-r-- 1 remnux remnux 1.2K Jan 21 09:15 docs.lnk\n  -rw-r--r-- 1 remnux remnux 726K Jan 22 2022 Documents  17.iso\n\n### It looks like the ISO contained two files, an autorun.exe and a docs.lnk file.\n\n## Inspecting the LNK File\n\n### Thinking through the chain of actions a victim is likely to take, the victim will try to double- click the ISO file and Windows will mount it as a removable drive. The victim then will click either autorun.exe or docs.lnk . Shortcut LNK files often contain shady material because they allow a creator to specify command line arguments in the shortcut to perform arbitrary actions. We can triage this file and analyze it using file and exiftool .\n  remnux@remnux:~/cases/bazariso$ file docs.lnk \n  docs.lnk: MS Windows shortcut, Item id list present, Points to a file or\n  directory, Has Relative path, Has command line arguments, Icon number=5,\n  Archive, ctime=Mon Dec 27 02:31:16 2021, mtime=Fri Jan 21 17:35:47 2022,\n  atime=Mon Dec 27 02:31:16 2021, length=71680, window=hide\n  remnux@remnux:~/cases/bazariso$ exiftool docs.lnk \n  ExifTool Version Number     : 12.30\n  File Name            : docs.lnk\n  Directory            : .\n  File Size            : 1225 bytes\n  File Modification Date/Time   : 2022:01:21 09:15:47-05:00\n  File Access Date/Time      : 2022:01:22 17:51:01-05:00\n  File Inode Change Date/Time   : 2022:01:22 17:42:19-05:00\n  File Permissions        : -rw-rw-r-  File Type            : LNK\n  File Type Extension       : lnk\n  MIME Type            : application/octet-stream\n  Flags              : IDList, LinkInfo, RelativePath, CommandArgs,\n  IconFile, Unicode, TargetMetadata\n  File Attributes         : Archive\n  Create Date           : 2021:12:26 16:31:16-05:00\n  Access Date           : 2022:01:21 07:35:47-05:00\n  Modify Date           : 2021:12:26 16:31:16-05:00\n  Target File Size : 71680\n\n```\n\n-----\n\n```\nIcon Index           : 5\nRun Window           : Normal\nHot Key             : (none)\nTarget File DOS Name      : rundll32.exe\nDrive Type           : Fixed Disk\nVolume Label          : \nLocal Base Path         : C:\\Windows\\System32\\rundll32.exe\nRelative Path          : ..\\Windows\\System32\\rundll32.exe\nCommand Line Arguments     : advpack.dll,RegisterOCX autorun.exe\nIcon File Name         : %systemroot%\\system32\\imageres.dll\nMachine ID           : desktop-i8bn9qk\n\n```\n\n-----\n\n### Alright we definitely have a LNK shortcut file! Inspecting with exiftool it looks like the shortcut is fairly small at 1225 bytes. Larger shortcut files may indicate very large PowerShell or scripting command line properties. In this case, it looks like the command the shortcut executes is C:\\Windows\\System32\\rundll32.exe advpack.dll,RegisterOCX\n```\nautorun.exe . This command is a way to execute autorun.exe using rundll32.exe as\n\n a LOLBIN. The icon is one from a default Windows installation, but some LNK files I’ve seen have had ones distributed with the files as well. The last bit of detail in this output is the Machine ID. This property shows the computer name of the system that created the shortcut. So, the adversary either created this shortcut on a system named desktopi8bn9qk or knows how to modify the shortcut file to that name.\n\n## Triage and Estimate Capabilities\n\n### Alright, let’s see if we can estimate some of the capabilities of the autorun.exe binary using capa and yara .\n  remnux@remnux:~/cases/bazariso$ capa autorun.exe \n  +------------------------+-----------------------------------------------------  ------------------------------+\n  | md5          | 6d583d7666ffbc439f86f8954cc3e0ec           \n  |\n  | sha1          | d17ff6f48a3e3693ee61b79341ed282087df2e71       \n  |\n  | sha256         |\n  667753d0c33cf7874b3d4cf05be4cf245558515e73330e133c60da63554471d8        \n  |\n  | path          | autorun.exe                     \n  |\n  +------------------------+-----------------------------------------------------  ------------------------------+\n  +------------------------+-----------------------------------------------------  ------------------------------+\n  | ATT&CK Tactic     | ATT&CK Technique                   \n  |\n  |------------------------+-----------------------------------------------------  ------------------------------|\n  | COLLECTION       | Input Capture::Keylogging T1056.001         \n  |\n  | DEFENSE EVASION    | Modify Registry:: T1112               \n  |\n  |            | Obfuscated Files or Information:: T1027       \n  |\n  |            | Obfuscated Files or Information::Indicator Removal\n  from Tools T1027.005      |\n  | DISCOVERY       | File and Directory Discovery:: T1083         \n  |\n  | | Query Registry:: T1012\n\n```\n\n-----\n\n```\n|\n|            | System Information Discovery:: T1082         \n|\n| EXECUTION       | Shared Modules:: T1129                \n|\n+------------------------+-----------------------------------------------------------------------------------+\n+-----------------------------+------------------------------------------------------------------------------+\n| MBC Objective        | MBC Behavior                  \n|\n|-----------------------------+------------------------------------------------------------------------------|\n| COLLECTION         | Keylogging::Polling [F0002.002]         \n|\n| DATA            | Encode Data::XOR [C0026.002]          \n|\n| DEFENSE EVASION       | Obfuscated Files or Information::EncodingStandard Algorithm [E1027.m02]   |\n| DISCOVERY          | Application Window Discovery::Window Text\n[E1010.m01]             |\n| FILE SYSTEM         | Delete File:: [C0047]              \n|\n|               | Read File:: [C0051]               \n|\n|               | Writes File:: [C0052]              \n|\n| OPERATING SYSTEM      | Environment Variable::Set Variable [C0034.001] \n|\n|               | Registry::Create Registry Key [C0036.004]    \n|\n|               | Registry::Delete Registry Key [C0036.002]    \n|\n|               | Registry::Open Registry Key [C0036.003]     \n|\n|               | Registry::Query Registry Value [C0036.006]   \n|\n|               | Registry::Set Registry Key [C0036.001]     \n|\n| PROCESS           | Set Thread Local Storage Value:: [C0041]    \n|\n|               | Terminate Process:: [C0018]           \n|\n+-----------------------------+------------------------------------------------------------------------------+\n+------------------------------------------------------+-----------------------------------------------------+\n| CAPABILITY                      | NAMESPACE       \n|\n|------------------------------------------------------+-----------------------------------------------------|\n| log keystrokes via polling              | collection/keylog   \n|\n| encode data using XOR (2 matches)          | datamanipulation/encoding/xor            |\n| contain a resource (.rsrc) section          |\nexecutable/pe/section/rsrc              |\n| extract resource via kernel32 functions (8 matches) | executable/resource  \n|\n| query environment variable              | host\n```\n\n-----\n\n```\ninteraction/environment variable        |\n| set environment variable               | hostinteraction/environment-variable        |\n| get common file path                 | host-interaction/filesystem             |\n| delete file                     | host-interaction/filesystem/delete         |\n| enumerate files via kernel32 functions (2 matches)  | host-interaction/filesystem/files/list       |\n| get file size                    | host-interaction/filesystem/meta          |\n| read .ini file (2 matches)              | host-interaction/filesystem/read          |\n| read file                      | host-interaction/filesystem/read          |\n| write file (2 matches)                | host-interaction/filesystem/write          |\n| get graphical window text              | hostinteraction/gui/window/get-text         |\n| get disk information                 | hostinteraction/hardware/storage          |\n| set thread local storage value            | hostinteraction/process               |\n| terminate process                  | hostinteraction/process/terminate          |\n| query or enumerate registry value (3 matches)    | hostinteraction/registry              |\n| set registry value                  | hostinteraction/registry/create           |\n| delete registry key (2 matches)           | hostinteraction/registry/delete           |\n| access PEB ldr_data (3 matches)           | linking/runtime-linking\n|\n| link function at runtime (15 matches)        | linking/runtime-linking\n|\n| resolve function by hash (2 matches)         | linking/runtime-linking\n|\n| parse PE exports (3 matches)             | load-code/pe      \n|\n| parse PE header (10 matches)             | load-code/pe      \n|\n+------------------------------------------------------+-----------------------------------------------------+\n\n```\n\n-----\n\n### From the capa output there are already some capabilities in here that will likely increase analysis time. These include:\n\n access PEB ldr_data link function at runtime resolve function by hash\n\n\n-----\n\n### The PEB ldr_data rule indicates the binary contains some assembly instructions that resolve DLL module lists from the process environment block of the process while it is running. This is a method used by shellcode to resolve DLL imports and pain-in-the-can malware to hide their imports. Linking functions at runtime means the sample likely issues\n```\nLoadLibrary() or similar calls to import DLLs at runtime instead of when the program\n\n first runs. Finally, resolving functions by hash means it’ll be a hassle to potentially see what functions are being resolved as they’ll be hashed strings rather than the clear strings. Let’s see what we get from YARA.\n  remnux@remnux:~/cases/bazariso$ yara-rules\n  autorun.exe \n  Check_OutputDebugStringA_iat autorun.exe\n  anti_dbg autorun.exe\n  win_hook autorun.exe\n  screenshot autorun.exe\n  keylogger autorun.exe\n  win_registry autorun.exe\n  win_files_operation autorun.exe\n  IsPE64 autorun.exe\n  IsWindowsGUI autorun.exe\n  HasRichSignature autorun.exe\n  Microsoft_Visual_Cpp_80_DLL autorun.exe\n\n YARA thinks the sample has some anti-debugging, so that might become a hassle while doing further analysis later. From here my analysis style would be to toss this sucker into a sandbox to see what it does because further analysis is going to produce diminishing returns for me.\n\n Thanks for reading!\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-22 - BazarISO Analysis - Loading with Advpack.dll.pdf"
    ],
    "report_names": [
        "2022-01-22 - BazarISO Analysis - Loading with Advpack.dll.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536148,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1653714417,
    "ts_modification_date": 1653714417,
    "files": {
        "pdf": "https://archive.orkl.eu/ce711265343d5007132d6abb34dfb897a59ca468.pdf",
        "text": "https://archive.orkl.eu/ce711265343d5007132d6abb34dfb897a59ca468.txt",
        "img": "https://archive.orkl.eu/ce711265343d5007132d6abb34dfb897a59ca468.jpg"
    }
}