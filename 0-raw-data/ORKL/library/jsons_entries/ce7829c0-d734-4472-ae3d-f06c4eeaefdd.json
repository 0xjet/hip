{
    "id": "ce7829c0-d734-4472-ae3d-f06c4eeaefdd",
    "created_at": "2023-01-12T15:05:08.097569Z",
    "updated_at": "2025-03-27T02:16:09.28419Z",
    "deleted_at": null,
    "sha1_hash": "4d2dec2c65f8c5385a531e9d98c7656e7de7c381",
    "title": "2022-06-01 - Analyzing AsyncRAT distributed in Colombia",
    "authors": "",
    "file_creation_date": "2022-06-06T13:03:28Z",
    "file_modification_date": "2022-06-06T13:03:28Z",
    "file_size": 2619257,
    "plain_text": "# Analyzing AsyncRAT distributed in Colombia\n\n**jstnk9.github.io/jstnk9/research/AsyncRAT-Analysis/**\n\nJune 1, 2022 · 12 min read\n\n[Jose Luis Sánchez Martínez](https://twitter.com/Joseliyo_Jstnk)\nSecurity Researcher\n\n## Summary\n\n\nJune 1, 2022\n\n\n-----\n\nDuring 2019-2021 I was focused on analyzing campaigns orchestrated by the `APT-C-36 group and`\nRATs used by this same group and other cybercriminal groups such as `RemcosRAT,` `AsyncRAT,`\n```\nImminent Monitor RAT, etc. In the last few months I have seen some modifications of TTPs in many\n\n```\nof these families that have caught my attention and I wanted to analyze them to see what is new.\n\nTherefore, during this entry we will go through the analysis of a sample of `AsyncRAT distributed in`\nColombia during the last month.\n\ninfo\n\nThe objective of the analysis is to provide information on the execution of the binary, genealogy and\nother stuff, not to go into the details of the static part.\n\n## Analysis\n\n### Static\n\nThe basic static information of the sample to be analyzed is shown in the table below.\n\n**Field** **Value**\n\nFile name Stub.exe\n\nType PE32 executable for MS Windows (GUI) Intel 80386 32-bit Mono/.Net assembly\n\nMD5 c0b9838ff7d2ddecbfe296eae947e5d6\n\nSHA1 76af794b85e4a4ba75c5703df1207b7a6798bf2e\n\nSHA256 79068b82bcf0786b6af1b7cc96de1bf4e1a66b0d95e7e72ed1b1054443f6c5e3\n\nFile size 45.00 KB (46080 bytes)\n\nAfter verifying that the binary was C#, I decided to perform a small analysis of the code to check some\nof the actions that the malware should do once executed, before executing it on my systems.\n\n\n-----\n\nIf we go to the `Main function, which is the one defined in the entry point, we see that it contains the`\nstructure shown in the following image.\n\n\n-----\n\nThe binary will check a series of conditions to verify if it is being executed among other things in a\nvirtual environment or not, and depending on the results, it will continue its normal flow or kill the\nprocess.\n\nThe first check is to verify if a series of settings established in the code, among which are the key,\npastebin URL, version, etc.\n\n\n-----\n\nSecondly, it tries to create a mutex and stop similar processes of the same sample that may be running.\n\nIt then performs several checks to identify the context where it is running (mainly to see if it is a virtual\nmachine or a sandbox). Different anti-analysis techniques are put in place.\n\nThe first of all is related to the `DetectManufacturer method which aims to see if the system is related`\nto Vmware, VirtualBox, or virtualized in general.\n\n\n-----\n\nThe next thing is to check if a debugger exists in the context of AsyncRAT. To do this, it makes use of\nthe `isDebuggerPresent API.`\n\n[Next, the check is focused on seeing if the system where it was executed is the known sandboxie, to](https://github.com/sandboxie-plus/Sandboxie)\ncheck it, tries to identify if the DLL `SbieDll.dll is running.`\n\n\n-----\n\nThe next check it performs is on the system disk capacity. In this case, it checks if the disk is less than\n61000000000L (56.8 GB). If it is, it returns false.\n\nThe last thing it performs in this set of checks is to identify if the operating system is Windows XP with a\nsimple method.\n\nIt also aims to generate persistence in the system. To do this, it checks if the context of the process was\nlaunched with privileges, if so, it will make use of `schtasks.exe to create a task. Otherwise, if the`\ncontext is not found with administrator permissions, it will try to modify the registry key\n```\nSoftware\\Microsoft\\Windows\\CurrentVersion\\Run to execute a copy of itself create in the\n\n```\n\n-----\n\nAfter this, the sample copies itself into the `%appdata% directory and will create a .bat file to first launch`\na `timeout, run the sample from` `%appdata% and delete the .bat file.`\n\nThe last interesting activity is to establish communications with the C2 through the\n```\nClientSocket.Reconnect(); and ClientSocket.InitializeClient(); methods.\n\n```\n\n-----\n\nThe sample can perform many other actions once it is deployed in the environment. For example, the\n```\nClient.Helper.IdSender class has a method called sendInfo which is responsible for sending\n\n```\ninformation from the operating system to the C2.\n\n\n-----\n\nGoing into detail of each class could take a long time, and in this case, the goal is to analyze the\nbehavior once executed, so I leave a small image of a part of the classes and methods that\nincorporates the sample and we will perform an analysis of the behavior.\n\n\n-----\n\n### Dynamic\n\n**high level processes events**\n\n\n-----\n\nNow it is time to detonate the malware in a controlled environment to verify the behavior of the malware.\nIn this case, I did different executions with and without administrator permissions to see how the sample\nbehaved. I did this because in the static part we have seen that the behavior could vary depending on\nwhether it was executed in the administrator context.\n\n**privileged execution - Genealogy**\n\n**non-privileged execution - Genealogy**\n\nAs can be seen, there are some differences when the sample was executed with privileges and when\nnot. For example, in the first image, which corresponds to the execution with privileges, there are 3\nadditional processes which are the following.\n```\n|_ cmd.exe (7380)\n  |_ Conhost.exe (8972)\n  |_ schtasks.exe (4152)\n\n```\nThis is because the execution of the process 7380 `cmd.exe, is the behavior related to setting the`\nscheduled task. However, if the sample is run without administrator permissions, the scheduled task\ncannot be generated.\n\n\n-----\n\nWe are going to go into detail about the processes to see the main actions they performed and that\ncould be of interest in order to generate some kind of detection or identification of patterns. To do this,\nwe will focus on the execution with administrator permissions and in case there is something different in\nthe other execution, it will be named.\n\n**Stub.exe - 2740**\n```\nC:\\Users\\lab\\Desktop\\Stub.exe\n\n```\nThis is the AsyncRAT sample. The execution was performed with administrator privileges.\n\nThis process, as we saw before, would be in charge of creating certain files in the system. First of all,\nwhat it does is to create in the `%appdata% directory a copy of itself.`\n\nThen, it creates the batch file also in `%appdata%, which will be executed later to perform different`\nactions in the operating system.\n\nAs for registry keys, there is no significant activity.\n\ninfo\n\nDifferent behavior in the sample run without privileges.\n\n**However, in the case of unprivileged execution, there would be a modification in the registry**\n**keys for persistence, using the key**\n```\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Runtime Broker .\n\n```\n**cmd.exe - 7380**\n```\n\"C:\\Windows\\System32\\cmd.exe\" /c schtasks /create /f /sc onlogon /rl highest /tn \"Runtime\nBroker\" /tr '\"C:\\Users\\lab\\AppData\\Roaming\\Runtime Broker.exe\"' & exit\n\n```\n\n-----\n\nThis process is basically in charge of launching the `schtasks.exe binary. It is important to mention,`\nas we are seeing and will see throughout the analysis, that since this is a 32bit sample, the executions\nwill be related to the `C:\\Windows\\SysWOW64\\ directory.`\n\nThis process will not exist when running AsyncRAT without administrator permissions.\n\n**schtasks.exe - 4152**\n```\nschtasks /create /f /sc onlogon /rl highest /tn \"Runtime Broker\" /tr\n'\"C:\\Users\\lab\\AppData\\Roaming\\Runtime Broker.exe\"'\n\n```\nThe task is generated in the system to be executed at each login of any user with administrator\npermissions.\n```\n/f -> A value that forcefully creates the task and suppresses warnings if the specified task\nalready exists.\n/sc onlogon -> In each login\n/rl highest -> Max privileges\n/tn \"Runtime Broker\" -> Task name\n/tr \"C:\\Users\\lab\\AppData\\Roaming\\Runtime Broker.exe\" -> Task run to execute\n\n```\n**cmd.exe - 8840**\n\n\n-----\n\n```\nC:\\Windows\\system32\\cmd.exe /c C:\\Users\\lab\\AppData\\Local\\Temp\\tmp3959.tmp.bat\n\n```\nThis process is in charge of executing the bat file that was created during the execution of the\n```\nStub.exe binary. It is important to mention that the name of the batch file varies according to the\n\n```\n**execution, however, the pattern is always the same. The following RegEx would work to detect this.**\n```\n.*tmp[a-zA-Z1-9]{4}.tmp.bat\n\n```\n**timeout.exe - 6272**\n```\ntimeout 3\n\n```\nThe malware uses a timeout of 3 seconds before it starts performing the rest of the actions.\n\n**Runtime Broker.exe - 4080**\n```\n\"C:\\Users\\lab\\AppData\\Roaming\\Runtime Broker.exe\"\n\n```\nAs can be seen from the name of the process, the malware tries to impersonate the legitimate Microsoft\nWindows binary `runtimebroker.exe . However, it can be noticed in this case that there is a space`\nbetween the two words.\n\nHere the communication with the C2 server is established. The ports used in this case are 8808, 7707\nand 6606. The destination IP address is 217.195.197[.]70.\n\nOn the other hand, another indicator that could help us to identify the sample and the family during the\nanalysis is the Mutex used, which in this case is `AsyncMutex_6SI8OkPnk .`\n\n\n-----\n\nDuring the execution of `Runtime Broker.exe, I proceeded to extract the .NET assembly from`\nmemory to verify if it was the same `Stub.exe binary analyzed later or if it presented some difference`\nwhen is launched. During this extraction, the following assemblies were obtained from memory.\n\n**File name** **SHA1** **Comments**\n\naB.exe 76AF794B85E4A4BA75C5703DF1207B7A6798BF2E Same sample as\n```\n                                          Stub.exe\n\n```\nMessagePackLib.dll 16CC8C3A461A6CE5A7ED1FF569EA61B8D9BA143E At the time of\nanalysis, 41/68\nengines in VT detect\nit as malicious.\nDifferent family\nnames.\n\nRecovery.dll 93E9469789A4ECD28E30006D1CE10DBFFBD36D7C At the time of\nanalysis, 44/68\nengines in VT detect\nit as malicious. Code\nprotected by\n[Reactor.](https://www.eziriz.com/)\n\nSystem.Data.SQLite.dll B9D5AF76D8DF1C4EE4CCBA33B2AFA8300952D923 Mixed-mode\nassembly for\nSystem.Data.SQLite.\nMore information\n[here.](https://system.data.sqlite.org/index.html/doc/trunk/www/downloads.wiki)\n\nNewtonsoft.Json.dll E68B369BC131A32D5233EE395F47B337C2469042 Json.NET is a\npopular highperformance JSON\nframework for .NET\n\n**aB.exe**\n\nThe assembly `aB.exe is the same` `Stub.exe file, which in turn is also` `Runtime Broker.exe .`\n\n**MessagePackLib.dll**\n\n\n-----\n\n[This DLL does not contain any packers or code protectors. 41 out of 68 VT engines detect this DLL as](https://www.virustotal.com/gui/file/cd89c8c9bb614fac779491b98ed425f90b01412381e02392fb27b36db3568b0f)\nmalicious.\n\nTaking a look at the assembly, you can see that the class structure does not seem to be very complex,\nand with a little patience you could identify its functionality (if you are interested in the sample, ask me\nprivately).\n\n\n-----\n\n**Recovery.dll**\n\nIn this case, it has been possible to verify the existence of Reactor, called by itself as a .NET code\nprotection as can be seen on its website.\n\n\n-----\n\nAs for the assembly, it can be verified that there is a protection of the code, since many strings and\nclasses are randomized at the moment of observing their possible logic.\n\nIn a process of trying to remove the code protection, it is possible to see in a more readable way part of\nthe code, identifying messages of actions that the assembly could try, in this case as seen in the image,\nrelated to the obtaining of Firefox cookies.\n\n\n-----\n\n### High level graph\n\nIn order to have a graphical view of the most important events that take place during the execution of\nAsyncRAT, a behavior graph has been elaborated where the events generated in the system during its\nexecution can be seen.\n\n\n-----\n\n### Diamond model\n\n## ATT&CK\n\n**Technique**\n\n\n**Kill chain**\n**phase**\n\n\n**Diamond**\n**vertex** **Comments**\n\n\n-----\n\n**Diamond**\n**vertex** **Comments**\n\n\n**Technique**\n\nT1566.001 - Phishing: Spearphishing\nAttachment\n\nT1547.001 - Boot or Logon Autostart\nExecution: Registry Run Keys / Startup\nFolder\n\nT1053.005 - Scheduled Task/Job:\nScheduled Task\n\nT1036.005 - Masquerading: Match\nLegitimate Name or Location\n\n\n**Kill chain**\n**phase**\n\n\nDelivery Capability Email with ZIP file attached\n\nInstallation Capability Set registry key if nonprivileged user executes\nthe payload\n\nInstallation Capability Creates new scheduled\ntask if privileged user\nexecutes the payload\n\nExecution Capability Writes itself as a file\nnamed Runtime\nBroker.exe saved in\n%APPDATA%\n\n\nT1571 - Non-Standard Port C2 Infrastructure Use the ports 8808, 7707\nand 6606 for\ncommunication\n\n\nT1059.003 - Command and Scripting\nInterpreter: Windows Command Shell\n\n\nExecution Capability Executes batch file created\npreviously\n\n\nT1027 - Obfuscated Files or Information Exploitation Capability .NET Reactor is used for\ncode protection\n\nT1095 - Non-Application Layer Protocol C2 Infrastructure TCP is used for C2\ncommunications\n\n## IOCs\n\n217.195.197[.]70 through 6606, 7707, 8808 ports\n76AF794B85E4A4BA75C5703DF1207B7A6798BF2E\n16CC8C3A461A6CE5A7ED1FF569EA61B8D9BA143E\n93E9469789A4ECD28E30006D1CE10DBFFBD36D7C\nMutex `AsyncMutex_6SI8OkPnk`\n\n## Sigma rules\n\n**_The sigma rules created are specifics for this payload. There will be different payloads used by_**\nAsyncRAT with the same name or different. Is important to mention that the original filename embbeded\nin this case is `Stub.exe . This is interesting because if the adversaries create new payloads, maybe`\nthe original filename will still being the same.\n\n\n-----\n\n```\ntitle: Detect AsyncRAT persistence with schtasks based on specific payload\nid: 4410f0ad-3a1c-4e21-9e3a-fa55336aa123\ndescription: Detect the execution of the AsyncRAT payload to launch schtask for persistence.\nstatus: experimental\ndate: 2022/06/01\nmodified: 2022/06/01\nauthor: Jose Luis Sanchez Martinez (@Joseliyo_Jstnk)\nreferences:\n  - https://jstnk9.github.io/jstnk9/research/AsyncRAT-Analysis\n  https://www.virustotal.com/gui/file/79068b82bcf0786b6af1b7cc96de1bf4e1a66b0d95e7e72ed1b1054443f6\nlogsource:\n product: windows\n category: process_creation\ndetection:\n parent_selection:\n  ParentImage|endswith: 'Stub.exe'\n selection1:\n  Image|endswith: '\\cmd.exe'\n  CommandLine|contains|all:\n   - 'schtasks '\n   - '\\AppData\\Roaming\\'\n   - '.exe'\n condition: parent_selection and selection1\nfalsepositives:\n  - Unknown\nlevel: medium\ntags:\n  - attack.persistence\n  - attack.T1053.005\ntitle: Detect AsyncRAT execution based on specific payload\nid: ac891380-958b-4c08-a77d-8e149d63d741\ndescription: Detect the execution of the AsyncRAT payload to establish registry key for\npersistence.\nstatus: experimental\ndate: 2022/06/01\nmodified: 2022/06/01\nauthor: Jose Luis Sanchez Martinez (@Joseliyo_Jstnk)\nreferences:\n  - https://jstnk9.github.io/jstnk9/research/AsyncRAT-Analysis\n  https://www.virustotal.com/gui/file/79068b82bcf0786b6af1b7cc96de1bf4e1a66b0d95e7e72ed1b1054443f6\nlogsource:\n product: windows\n category: registry_set\ndetection:\n selection:\n  EventType: SetValue\n  Image|endswith: 'Stub.exe'\n  TargetObject|endswith: '\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\'\n  Details|contains: '.exe'\n condition: selection\nfalsepositives:\n  - Unknown\nlevel: medium\ntags:\n  - attack.persistence\n  - attack.t1547.001\n\n```\n\n-----\n\n[In the original Sigma repository, there are a large number of generic rules that can help in the detection](https://github.com/SigmaHQ/sigma/tree/master/rules/windows)\nof this malware.\n\n## Contact\n\n**Twitter:** [https://twitter.com/Joseliyo_Jstnk](https://twitter.com/Joseliyo_Jstnk)\n\n**LinkedIn:** [https://www.linkedin.com/in/joseluissm/](https://www.linkedin.com/in/joseluissm/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-01 - Analyzing AsyncRAT distributed in Colombia.pdf"
    ],
    "report_names": [
        "2022-06-01 - Analyzing AsyncRAT distributed in Colombia.pdf"
    ],
    "threat_actors": [
        {
            "id": "98b22fd7-bf1b-41a6-b51c-0e33a0ffd813",
            "created_at": "2022-10-25T15:50:23.688973Z",
            "updated_at": "2025-03-27T02:00:55.524322Z",
            "deleted_at": null,
            "main_name": "APT-C-36",
            "aliases": [
                "APT-C-36",
                "Blind Eagle"
            ],
            "source_name": "MITRE:APT-C-36",
            "tools": [
                "Imminent Monitor"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "bd43391b-b835-4cb3-839a-d830aa1a3410",
            "created_at": "2023-01-06T13:46:38.925525Z",
            "updated_at": "2025-03-27T02:00:02.95302Z",
            "deleted_at": null,
            "main_name": "APT-C-36",
            "aliases": [
                "Blind Eagle"
            ],
            "source_name": "MISPGALAXY:APT-C-36",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "be597b07-0cde-47bc-80c3-790a8df34af4",
            "created_at": "2022-10-25T16:07:23.407484Z",
            "updated_at": "2025-03-27T02:02:09.784411Z",
            "deleted_at": null,
            "main_name": "Blind Eagle",
            "aliases": [
                "APT-C-36",
                "APT-Q-98",
                "AguilaCiega"
            ],
            "source_name": "ETDA:Blind Eagle",
            "tools": [
                "AsyncRAT",
                "BitRAT",
                "Bladabindi",
                "BlotchyQuasar",
                "Imminent Monitor",
                "Imminent Monitor RAT",
                "Jorik",
                "LimeRAT",
                "Remcos",
                "RemcosRAT",
                "Remvio",
                "Socmer",
                "Warzone",
                "Warzone RAT",
                "njRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535908,
    "ts_updated_at": 1743041769,
    "ts_creation_date": 1654520608,
    "ts_modification_date": 1654520608,
    "files": {
        "pdf": "https://archive.orkl.eu/4d2dec2c65f8c5385a531e9d98c7656e7de7c381.pdf",
        "text": "https://archive.orkl.eu/4d2dec2c65f8c5385a531e9d98c7656e7de7c381.txt",
        "img": "https://archive.orkl.eu/4d2dec2c65f8c5385a531e9d98c7656e7de7c381.jpg"
    }
}