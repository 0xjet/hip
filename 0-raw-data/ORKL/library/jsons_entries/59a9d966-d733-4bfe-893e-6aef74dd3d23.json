{
    "id": "59a9d966-d733-4bfe-893e-6aef74dd3d23",
    "created_at": "2023-01-12T15:03:12.599105Z",
    "updated_at": "2025-03-27T02:05:22.374579Z",
    "deleted_at": null,
    "sha1_hash": "0ddf1480616e7220cdcbce9f753e81cb0aabadfd",
    "title": "2021-04-30 - Qbot- Analyzing PHP Proxy Scripts from Compromised Web Server",
    "authors": "",
    "file_creation_date": "2022-05-27T21:29:51Z",
    "file_modification_date": "2022-05-27T21:29:51Z",
    "file_size": 3000020,
    "plain_text": "# Qbot: Analyzing PHP Proxy Scripts from Compromised Web Server\n\n**[madlabs.dsu.edu/madrid/blog/2021/04/30/qbot-analyzing-php-proxy-scripts-from-compromised-web-server/](https://madlabs.dsu.edu/madrid/blog/2021/04/30/qbot-analyzing-php-proxy-scripts-from-compromised-web-server/)**\n\n## About Qbot\n\nQbot (also known as Qakbot) is an information stealer that has been active since 2007. It was\noriginally used as a banking trojan, but has since been updated to steal credentials from other\nsites as well that are not financial. Qbot has also been observed being used for a variety of\ndifferent types of activities, including distributing ransomware.\n\nRecently, Qbot has been distributed through spam email campaigns. Specifically, a URL is sent\nthrough an email. This URL belongs to a compromised WordPress site controlled by the\nattacker. This URL is redirected to a malicious PHP script that loads Qbot onto the victim’s\nmachine.\n\n## Analysis\n\nRecently, some files were collected from a web server that was compromised by QBot at\n**hxxp://185.220.100.246/home/selfst15/public_html_selfstoragemillionaires.com/BAItICsGBq/.**\nThese files were then analyzed, specifically the .htaccess and p_univ.php files.\n\n## .htaccess\n\nThe .htaccess file contains multiple rewrite rules. These will redirect any file with the extensions\nlisted below to our malicious file, p_univ.php.\n\n\n-----\n\nThe malware authors do this for a few different reasons. For one, a victim might be tricked into\nclicking one link that appears to be benign, only to be tricked into visiting the page that contains\nthe malware. Also, using this trick makes it appear as if the malware were present in multiple\ndifferent locations, making it more difficult for the website owners to detect and remove the\nmalware. After all, many people wouldn’t think to check the .htaccess file if their site were\ncompromised with malware.\n\n## p_univ.php\n\nThis file makes use of a couple different obfuscation techniques:\n\nFirst, it uses ROT13 and then base64 to decode the string, and then uses the eval function.\nEval executes a string as PHP code. We could run a tool such as XAMPP on our local machine\nto execute the PHP script, or we can make use of a third-party tool. I made use of a tool called\n[UnPHP, which decodes PHP files that make use of common obfuscation techniques.](https://www.unphp.net/)\n\nThe deobfuscated code returns some interesting results:\n\n\n-----\n\nFirst, we see the timezone being set to Europe/Moscow (1), which gives an indication of where\nthe attackers reside. Next, we see the display indicators being turned off (2), which is likely\nbeing used as a method to hide malicious activity from the victim by hiding any errors from the\noutput. We also see a target host of 91[.]193[.]180[.]161 and a target port of 80 (3). There is\nalso a variable target_uri, that appears to contain the file path of the next stage of the malware\n(4).\n\nLet’s look into this script more:\n\n\n-----\n\n**TARGET_URI, which contains the path of the next stage of malware, appends two parameters.**\nThe first parameter, fname, contains the name of the current file, p_univ.php, which is\naccessed using the $_SERVER array. The second parameter, bg, contains the bot group, which\nis obtained through the conf.php file:\n\nThe “bot group” we are in is “abc122”. This must be used as a method of managing different\ngroups of infected machines, and could be a possible indicator that the end goal is to create a\nbotnet, although that remains unclear. It is likely a method used by their C2 server to control\ndifferent groups of infected machines.\n\nBased on this information, the full URL containing the next stage of malware is:\n**hxxp://91.193.180.161:80/first_loader/first_loader_qbz001.php?**\n**fname=p_univ.php&bg=abc122**\n\nA request to this URL is then made using a cURL request:\n\n\n-----\n\ncURL is used to attempt to visit the target URL. Several headers are also sent in the cURL\nrequest, including the user agent.\n\nXAMPP was used in an isolated environment to attempt to retrieve further stages of malware,\nbut these efforts were ultimately unsuccessful. When using a TOR node to attempt to send the\nrequest, the server responded with a 502 status code (“Bad gateway”). I looked further in the\nscript and the client_ip variable is used, which sends the IP of the connecting server (obtained\nthrough $_SERVER[‘REMOTE_ADDR’]):\n\nI attempted to instead change the client_ip variable to the IP of the original compromised web\nserver, 185[.]220[.]100[.]246. When I did this, I got a different error code, a 403 forbidden\nresponse. This typically means that this page has been blocked entirely, although servers can\nfake error codes so it is possible that the malware authors are using additional checks to block\nthe page on certain conditions.\n\n**Domain info**\n\n\n-----\n\nThe attacker s server which delivers the next stage of malware is at the IP address\n91[.]193[.]180[.]161. Doing a whois lookup on this server returned the following results:\n\nThe server originates in the Netherlands and belongs to 3NT Solutions LLP. Not much could be\nfound on this company, except for the fact they are a cloud hosting provider. Several Google\nsearches indicate that this ISP is commonly being used to deploy malware.\n\n**IOCs**\n\nOriginal compromised web server:\n**hxxp://185.220.100.246/home/selfst15/public_html_selfstoragemillionaires.com/BAItICsGBq**\n\nAttacker web server: 91[.]193[.]180[.]161\n\nNext stage of malware: hxxp://91.193.180.161:80/first_loader/first_loader_qbz001.php?\n**fname=p_univ.php&bg=abc122**\n\n## Resources\n\nArtifacts: https://github.com/jstrosch/malwaresamples/tree/master/malware_infrastructure/2021/January/qbot_compromised_server\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-30 - Qbot- Analyzing PHP Proxy Scripts from Compromised Web Server.pdf"
    ],
    "report_names": [
        "2021-04-30 - Qbot- Analyzing PHP Proxy Scripts from Compromised Web Server.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535792,
    "ts_updated_at": 1743041122,
    "ts_creation_date": 1653686991,
    "ts_modification_date": 1653686991,
    "files": {
        "pdf": "https://archive.orkl.eu/0ddf1480616e7220cdcbce9f753e81cb0aabadfd.pdf",
        "text": "https://archive.orkl.eu/0ddf1480616e7220cdcbce9f753e81cb0aabadfd.txt",
        "img": "https://archive.orkl.eu/0ddf1480616e7220cdcbce9f753e81cb0aabadfd.jpg"
    }
}