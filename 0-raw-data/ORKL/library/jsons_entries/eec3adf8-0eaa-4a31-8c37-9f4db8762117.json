{
    "id": "eec3adf8-0eaa-4a31-8c37-9f4db8762117",
    "created_at": "2023-01-12T15:00:31.197251Z",
    "updated_at": "2025-03-27T02:06:08.425223Z",
    "deleted_at": null,
    "sha1_hash": "83ed8ddff13fe24eb29cc4c208a7ab0e43a4c2bd",
    "title": "2017-01-18 - New Mac backdoor using antiquated code",
    "authors": "",
    "file_creation_date": "2022-05-28T17:59:26Z",
    "file_modification_date": "2022-05-28T17:59:26Z",
    "file_size": 206874,
    "plain_text": "# New Mac backdoor using antiquated code\n\n**[blog.malwarebytes.com/threat-analysis/2017/01/new-mac-backdoor-using-antiquated-code/](https://blog.malwarebytes.com/threat-analysis/2017/01/new-mac-backdoor-using-antiquated-code/)**\n\nThomas Reed January 18, 2017\n\nThe first Mac malware of 2017 was brought to my attention by an IT admin, who\nspotted some strange outgoing network traffic from a particular Mac. This led to the\ndiscovery of a piece of malware unlike anything I’ve seen before, which appears to have\nactually been in existence, undetected, for some time, and which seems to be targeting\nbiomedical research centers.\n\nThe malware was extremely simplistic on the surface, consisting of only two files:\n```\n~/.client\nSHA256: ce07d208a2d89b4e0134f5282d9df580960d5c81412965a6d1a0786b27e7f044\n~/Library/LaunchAgents/com.client.client.plist\nSHA256: 83b712ec6b0b2d093d75c4553c66b95a3d1a1ca43e01c5e47aae49effce31ee3\n\n```\nThe launch agent .plist file itself couldn’t have been much simpler, simply keeping the .client\nrunning at all times.\n\n\n-----\n\n```\n<?xml version 1.0 encoding UTF 8 ?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\"\n\"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\n<dict>\n <key>KeepAlive</key>\n <true/>\n <key>Label</key>\n <string>com.client.client</string>\n <key>ProgramArguments</key>\n <array>\n <string>/Users/xxxx/.client</string>\n </array>\n <key>RunAtLoad</key>\n <true/>\n <key>NSUIElement</key>\n <string>1</string>\n</dict>\n</plist>\n\n```\nThe .client file was where things got really interesting. It took the form of a minified and\nobfuscated perl script.\n\nThe perl script, among other things, communicates with the following command and control\n(C&C) servers:\n```\n99.153.29.240\neidk.hopto.org\n\n```\nThe latter is a domain name managed by the dynamic DNS service no-ip.com.\n\nThe script also includes some code for taking screen captures via shell commands.\nInterestingly, it has code to do this both using the Mac “screencapture” command and the\nLinux “xwd” command. It also has code to get the system’s uptime, using the Mac “uptime”\ncommand or the Linux “cat /proc/uptime” command.\n\nThe most interesting part of the script can the found in the __DATA__ section at the end.\nFound there are a Mach-O binary, a second perl script and a Java class, which the script\nextracts, writes to the /tmp/ folder and executes. In the case of the Java class file, it is run\nwith apple.awt.UIElement set to true, which means that it does not show up in the Dock.\n\nThe binary itself seems primarily interested in screen captures and webcam access, but\ninterestingly, it uses some truly antique system calls for those purposes, such as:\n\n\n-----\n\n```\nSGGetChannelDeviceList\nSGSetChannelDevice\nSGSetChannelDeviceInput\nSGInitialize\nSGSetDataRef\nSGNewChannel\nQTNewGWorld\nSGSetGWorld\nSGSetChannelBounds\nSGSetChannelUsage\nSGSetDataProc\nSGStartRecord\nSGGetChannelSampleDescription\n\n```\nThese are some truly ancient functions, as far as the tech world is concerned, dating back to\npre-OS X days. In addition, the binary also includes the open source libjpeg code, which was\nlast updated in 1998.\n\nThe Java class appears to be capable of receiving commands to do various tasks, which\ninclude yet another method of capturing the screen, getting the screen size and mouse\ncursor position, changing the mouse position, simulating mouse clicks, and simulating key\npresses. This component appears to be intended to provide a kind of rudimentary remote\ncontrol functionality.\n\nWe also observed the malware downloading a perl script, named “macsvc”, from the C&C\nserver. This script uses mDNS to build a map of all the other devices on the local network,\ngiving information about each device including its IPv6 and IPv4 addresses, name on the\nnetwork and the port that is in use. It also appears to be making connection attempts to\ndevices it finds on the network.\n```\nmacsvc SHA256: b556c04c768d57af104716386fe4f23b01aa9d707cbc60385895e2b4fc08c9b0\n\n```\n\n-----\n\nAnother file downloaded from the C&C server was named afpscan, and it seems to try to\nconnect to other devices on the network.\n```\nafpscan SHA256: bbbf73741078d1e74ab7281189b13f13b50308cf03d3df34bc9f6a90065a4a55\n\n```\nThe presence of Linux shell commands in the original script led us to try running this\nmalware on a Linux machine, where we found that – with the exception of the Mach-O binary\n– everything ran just fine. This suggests that there may be a variant of this malware that is\nexpressly designed to run on Linux, perhaps even with a Linux executable in place of the\nMach-O executable. However, we have not found such a sample.\n\nWe were able to locate a couple Windows executable files on VirusTotal that communicate\nwith the same C&C server. In addition, one contains strings that indicate that it uses the\nsame libjpeg library from 1998 as the Mac Mach-O binary. Each of these samples were only\never submitted to VirusTotal once, in June and July of 2013, and are only detected by a few\nengines under generic names.\n```\nSHA256: 94cc470c0fdd60570e58682aa7619d665eb710e3407d1f9685b7b00bf26f9647\nSHA256: 694b15d69264062e82d43e8ddb4a5efe4435574f8d91e29523c4298894b70c26\n\n```\nThere are other indications that this malware has been circulating undetected for a long time.\nOn one of the infected Macs, the launch agent file had a creation date in January of 2015.\nThat’s not strong evidence of the true creation date, though, as those dates can easily be\nchanged.\n\nFurther, there is a comment in the code in the macsvc file that indicates that a change was\nmade for Yosemite (Mac OS X 10.10), which was released in October of 2014. This suggests\nthat the malware has been around at least some time prior to Yosemite’s release.\n```\n if(/_(tcp|udp)\\S*\\s+(_\\S+)$/){ $s=\"$2._$1\"; }\n elsif(/icloud\\.com\\.\\s+(_[^\\.]+\\._(tcp|udp))\\.\\d+\\.members\\.btmm$/)\n  { $s=$1; } # changed in yosemite\n elsif(/icloud\\.com\\.\\s+\\.\\s+_autotunnel6$/){ next; }\n\n```\nAnother clue, of course, is the age of some of the code, which could potentially suggest that\nthis malware goes back decades. However, we shouldn’t take the age of the code as too\nstrong an indication of the age of the malware. This could also signify that the hackers\nbehind it really don’t know the Mac very well and were relying on old documentation. It could\nalso be that they’re using old system calls to avoid triggering any kind of behavioral\ndetections that might be expecting more recent code.\n\nIronically, despite the age and sophistication of this malware, it uses the same old\nunsophisticated technique for persistence that so many other pieces of Mac malware do: a\nhidden file and a launch agent. This makes it easy to spot, given any reason to look at the\ninfected machine closely (such as unusual network traffic). It also makes it easy to detect\nand easy to remove.\n\n\n-----\n\nThe only reason I can think of that this malware hasn t been spotted before now is that it is\nbeing used in very tightly targeted attacks, limiting its exposure. There have been a number\nof stories over the past few years about Chinese and Russian hackers targeting and stealing\nUS and European scientific research. Although there is no evidence at this point linking this\nmalware to a specific group, the fact that it’s been seen specifically at biomedical research\ninstitutions certainly seems like it could be the result of exactly that kind of espionage.\n\n[Malwarebytes will detect this malware as OSX.Backdoor.Quimitchin. (Why the name?](https://www.malwarebytes.com/mac/?utm_source=blog&utm_medium=social)\nBecause the quimitchin were Aztec spies who would infiltrate other tribes. Given\nthe “ancient” code, we thought the name fitting.) Apple calls this malware Fruitfly and has\nreleased an update that will be automatically downloaded behind the scenes to protect\nagainst future infections.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-01-18 - New Mac backdoor using antiquated code.pdf"
    ],
    "report_names": [
        "2017-01-18 - New Mac backdoor using antiquated code.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535631,
    "ts_updated_at": 1743041168,
    "ts_creation_date": 1653760766,
    "ts_modification_date": 1653760766,
    "files": {
        "pdf": "https://archive.orkl.eu/83ed8ddff13fe24eb29cc4c208a7ab0e43a4c2bd.pdf",
        "text": "https://archive.orkl.eu/83ed8ddff13fe24eb29cc4c208a7ab0e43a4c2bd.txt",
        "img": "https://archive.orkl.eu/83ed8ddff13fe24eb29cc4c208a7ab0e43a4c2bd.jpg"
    }
}