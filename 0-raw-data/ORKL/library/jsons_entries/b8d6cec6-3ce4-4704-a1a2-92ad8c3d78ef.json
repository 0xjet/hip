{
    "id": "b8d6cec6-3ce4-4704-a1a2-92ad8c3d78ef",
    "created_at": "2023-01-12T15:10:34.5326Z",
    "updated_at": "2025-03-27T02:16:01.183233Z",
    "deleted_at": null,
    "sha1_hash": "ec188174b1fdf6310beb2325f6daa5b37f659ed2",
    "title": "2021-07-29 - Magnitude Exploit Kit- Still Alive and Kicking",
    "authors": "",
    "file_creation_date": "2022-05-29T01:17:50Z",
    "file_modification_date": "2022-05-29T01:17:50Z",
    "file_size": 921424,
    "plain_text": "# Magnitude Exploit Kit: Still Alive and Kicking\n\n**[decoded.avast.io/janvojtesek/magnitude-exploit-kit-still-alive-and-kicking/](https://decoded.avast.io/janvojtesek/magnitude-exploit-kit-still-alive-and-kicking/)**\n\nby [Jan VojtěšekJuly 29, 202128 min read](https://decoded.avast.io/author/janvojtesek/)\n\n\nJuly 29, 2021\n\n\nIf I could choose one computer program and erase it from existence, I would choose\nInternet Explorer. Switching to a different browser would most likely save countless people\nfrom getting hacked. Not to mention all the headaches that web developers get when they\nare tasked with solving Internet Explorer compatibility issues. Unfortunately, I do not have\nthe power to make Internet Explorer disappear. But seeing its browser market share\ncontinue to decline year after year at least gives me hope that one day it will be only a part\nof history.\n\nWhile the overall trend looks encouraging, there are still some countries where the decline\nin Internet Explorer usage is lagging behind. An interesting example of this is South Korea,\nwhere until recently, users often had [no choice but to use this browser if they wanted to visit](https://www.washingtonpost.com/world/asia_pacific/due-to-security-law-south-korea-is-stuck-with-internet-explorer-for-online-shopping/2013/11/03/ffd2528a-3eff-11e3-b028-de922d7a3f47_story.html)\na government or an e-commerce website. This was because of a law that seems very\n[bizarre from today’s point of view: these websites were required to use ActiveX controls and](https://www.howtogeek.com/162282/what-activex-controls-are-and-why-theyre-dangerous/)\nwere therefore only supported in Internet Explorer. Ironically, these controls were originally\nmeant to provide additional security. While this law was finally dismantled in December\n2020, Internet Explorer still has a lot of momentum in South Korea today.\n\nThe attackers behind the Magnitude Exploit Kit (or Magniťůdek as we like to call it) are\nexploiting this momentum by running malicious ads that are currently shown only to South\nKorean Internet Explorer users. The ads can mostly be found on adult websites, which\nmakes this an example of so-called adult malvertising. They contain code that exploits\nknown vulnerabilities in order to give the attackers control over the victim’s computer. All the\nvictim has to do is use a vulnerable version of Microsoft Windows and Internet Explorer,\n[navigate to a page that hosts one of these ads and they will get the Magniber ransomware](https://blog.malwarebytes.com/threat-analysis/2017/10/magniber-ransomware-exclusively-for-south-koreans/)\nencrypting their computer.\n\n\n-----\n\nThe daily amount of Avast users protected from Magnitude. Note the drop after July 9th,\nwhich is when the attacker’s account at one of the abused ad networks got terminated.\n\n## Overview\n\nThe Magnitude exploit kit, originally known as PopAds, has been around since at least\n2012, which is an unusually long lifetime for an exploit kit. However, it’s not the same exploit\nkit today that it was nine years ago. Pretty much every part of Magnitude has changed\nmultiple times since then. The infrastructure has changed, so has the landing page, the\nshellcode, the obfuscation, the payload, and most importantly, the exploits. Magnitude\ncurrently exploits an Internet Explorer memory corruption vulnerability, [CVE-2021-26411, to](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-26411)\nget shellcode execution inside the renderer process and a Windows memory corruption\nvulnerability, [CVE-2020-0986, to subsequently elevate privileges. A fully functional exploit](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-0986)\nfor CVE-2021-26411 can be found on the Internet and Magnitude uses that public exploit\ndirectly, just with some added obfuscation on top. According to the South Korean\n[cybersecurity company ENKI, this CVE was first used in a targeted attack against security](https://enki.co.kr/blog/2021/02/04/ie_0day)\nresearchers, which Google’s Threat Analysis Group [attributed to North Korea.](https://blog.google/threat-analysis-group/new-campaign-targeting-security-researchers/)\n\nExploiting CVE-2020-0986 is a bit less straightforward. This vulnerability was first used in a\nzero-day exploit chain, discovered in-the-wild by Kaspersky researchers who named the\nattack [Operation PowerFall. To the best of our knowledge, this is the first time this](https://securelist.com/ie-and-windows-zero-day-operation-powerfall/97976/)\nvulnerability is being exploited in-the-wild since that attack. Details about the vulnerability\n[were provided in blog posts by both Kaspersky and](https://securelist.com/operation-powerfall-cve-2020-0986-and-variants/98329/) [Project Zero. While both these writeups](https://googleprojectzero.github.io/0days-in-the-wild/0day-RCAs/2020/CVE-2020-0986.html)\ncontain chunks of the exploit code, it must have still been a lot of work to develop a fully\n\n\n-----\n\nfunctional exploit. Since the exploit from Magnitude is extremely similar to the code from the\nwriteups, we believe that the attackers started from the code provided in the writeup and\nthen added all the missing pieces to get a working exploit.\n\nInterestingly, when we first discovered Magnitude exploiting CVE-2020-0986, it was not\nweaponized with any malicious payload. All it did after successful exploitation was ping its\nC&C server with the Windows build number of the victim. At the time, we theorized that this\nwas just a testing version of the exploit and the attackers were trying to figure out which\nbuilds of Windows they could exploit before they fully integrated it into the exploit kit. And\nindeed, a week later we saw an improved version of the exploit and this time, it was\ncarrying the Magniber ransomware as the payload.\n\nUntil recently, our detections for Magnitude were protecting on average about a thousand\nAvast users per day. That number dropped to roughly half after the compliance team of one\nof the ad networks used by Magnitude kicked the attackers out of their platform. Currently,\nall the protected users have a South Korean IP address, but just a few weeks back,\nTaiwanese Internet users were also at risk. Historically, South Korea and Taiwan were not\n[the only countries attacked by Magnitude. Previous](https://securelist.com/magnitude-exploit-kit-evolution/97436/) [reports mention that Magnitude also](https://www.fireeye.com/blog/threat-research/2017/10/magniber-ransomware-infects-only-the-right-people.html)\nused to target Hong Kong, Singapore, the USA, and Malaysia, among others.\n\n## The Infrastructure\n\nThe Magnitude operators are currently buying popunder ads from multiple adult ad\nnetworks. Unfortunately, these ad networks allow them to very precisely target the ads to\nusers who are likely to be vulnerable to the exploits they are using. They can only pay for\nads shown to South Korean Internet Explorer users who are running selected versions of\nMicrosoft Windows. This means that a large portion of users targeted by the ads is\nvulnerable and that the attackers do not have to waste much money on buying ads for\nusers that they are unable to exploit. We reached out to the relevant ad networks to let\nthem know about the abuse of their platforms. One of them successfully terminated the\nattacker’s account, which resulted in a clear drop in the number of Avast users that we had\nto protect from Magnitude every day.\n\n\n-----\n\nMany ad networks allow the advertisers to target their ads only to IE users running specific\nversions of Windows.\nWhen the malicious ad is shown to a victim, it redirects them through an intermediary URL\nto a page that serves an exploit for CVE-2021-26411. An example of this redirect chain is\n```\nbinlo[.]info -> fab9z1g6f74k.tooharm[.]xyz ->\n6za16cb90r370m4u1ez.burytie[.]top . The first domain, binlo[.]info, is the one\n\n```\nthat is visible to the ad network. When this domain is visited by someone not targeted by\nthe campaign, it just presents a legitimate-looking decoy ad. We believe that the purpose of\nthis decoy ad is to make the malvertising seem legitimate to the ad network. If someone\nfrom the ad network were to verify the ad, they would only see the decoy and most likely\nconclude that it is legitimate.\n\n\n-----\n\nOne of the decoy ads used by Magnitude. Note that this is nothing but a decoy: there is no\nreason to believe that SkinMedica would be in any way affiliated with Magnitude.\nThe other two domains ( tooharm[.]xyz and `burytie[.]top ) are designed to be`\nextremely short-lived. In fact, the exploit kit rotates these domains every thirty minutes and\ndoesn’t reuse them in any way. This means that the exploit kit operators need to register at\nleast 96 domains every day! In addition to that, the subdomains\n( fab9z1g6f74k.tooharm[.]xyz and `6za16cb90r370m4u1ez.burytie[.]top ) are`\nuniquely generated per victim. This makes the exploit kit harder to track and protect against\n(and more resilient against takedowns) because detection based on domain names is not\nvery effective.\n\nThe JavaScript exploit for CVE-2021-26411 is obfuscated with what appears to be a custom\nobfuscator. The obfuscator is being updated semi-regularly, most likely in an attempt to\nevade signature-based detection. The obfuscator is polymorphic, so each victim gets a\nuniquely obfuscated exploit. Other than that, there are not many interesting things to say\nabout the obfuscation, it does the usual things like hiding string/numeric constants,\nrenaming function names, hiding function calls, and more.\n\n\n-----\n\nA snippet of the obfuscated JavaScript exploit for CVE-2021-26411\nAfter deobfuscation, this exploit is an almost exact match to a public exploit for CVE-202126411 that is freely available on the Internet. The only important change is in the shellcode,\nwhere Magnitude obviously provides its own payload.\n\n## Shellcode\n\nThe shellcode is sometimes wrapped in a simple packer that uses redundant `jmp`\ninstructions for obfuscation. This obfuscates every function by randomizing the order of\ninstructions and then adding a `jmp instruction between each two consecutive instructions`\nto preserve the original control flow. As with other parts of the shellcode, the order is\nrandomly generated on the fly, so each victim gets a unique copy of the shellcode.\n\n\n-----\n\nFunction\n\nobfuscated by redundant `jmp instructions. It allocates memory by invoking the`\n```\nNtAllocateVirtualMemory syscall.\n\n```\nAs shown in the above screenshot, the exploit kit prefers not to use standard Windows API\nfunctions and instead often invokes system calls directly. The function above uses the\n```\nNtAllocateVirtualMemory syscall to allocate memory. However, note that this exact\n\n```\nimplementation only works on Windows 10 under the WoW64 subsystem. On other\nversions of Windows, the syscall numbers are different, so the syscall number `0x18 would`\ndenote some other syscall. And this exact implementation also wouldn’t work on native 32bit Windows, because there it does not make sense to call the `FastSysCall pointer at`\n```\nFS:[0xC0] .\n\n```\nTo get around these problems, this shellcode comes in several variants, each custom-built\nfor a specific version of Windows. Each variant then contains hardcoded syscall numbers\nfitting the targeted version. Magnitude selects the correct shellcode variant based on the\nUser-Agent string of the victim. But sometimes, knowing the major release version and\nbitness of Windows is not enough to deduce the correct syscall numbers. For instance, the\nsyscall number for `NtOpenProcessToken on 64-bit Windows 10 differs between versions`\n```\n1909 and 20H2 . In such cases, the shellcode obtains the victim’s exact\nNtBuildNumber from KUSER_SHARED_DATA and uses a hardcoded mapping table to\n\n```\nresolve that build number into the correct syscall number.\n\n\n-----\n\nCurrently, there are only three variants of the shellcode. One for Windows 10 64-bit, one for\nWindows 7 64-bit, and one for Windows 7 32-bit. However, it is very much possible that\nadditional variants will get implemented in the future.\n\nTo facilitate frequent syscall invocation, the shellcode makes use of what we call syscall\n_templates. Below, you can see the syscall template it uses in the WoW64 Windows 10_\nvariant. Every time the shellcode is about to invoke a syscall, it first customizes this\ntemplate for the syscall it intends to invoke by patching the syscall number (the immediate\nin the first instruction) and the immediates from the `retn instructions (which specify the`\nnumber of bytes to release from the stack on function return). Once the template is\ncustomized, the shellcode can call it and it will invoke the desired syscall. Also, note the\nbranching based on the value at offset `0x254 of the Process Environment Block. This is`\n[most likely the malware authors trying to check a field sometimes called](https://github.com/cseagle/sk3wldbg/blob/88109edc6d11994bf77baac16c38f0e0c4907127/teb32.h#L806)\n```\ndwSystemCallMode to find out if the syscall should be invoked directly using int 0x2e\n\n```\nor through the `FastSysCall transition.`\n\nSyscall\n\ntemplate from the WoW64 Windows 10 variant\nNow that we know how the shellcode is obfuscated and how it invokes syscalls, let’s get to\nwhat it actually does. Note that the shellcode expects to run within the IE’s Enhanced\nProtected Mode (EPM) sandbox, so it is relatively limited in what it can do. However, the\nEPM sandbox is not as strict as it could be, which means that the shellcode still has limited\nfilesystem access, public network access and can successfully call many API functions.\nMagnitude wants to get around the restrictions imposed by the sandbox and so the\nshellcode primarily functions as a preparation stage for the LPE exploit which is intended to\nenable Magnitude to break out of the sandbox.\n\nThe first thing the shellcode does is that it obtains the integrity level of the current process.\nThere are two URLs embedded in the shellcode and the integrity level is used to determine\nwhich one should be used. Both URLs contain a subdomain that is generated uniquely per\nvictim and are protected so that only the intended victim will get any response from them. If\n\n\n-----\n\nthe integrity level is `Low or` `Untrusted, the shellcode reaches out to the first URL and`\ndownloads an encrypted LPE exploit from there. The exploit is then decrypted using a\nsimple xor-based cipher, mapped into executable memory, and executed.\n\nOn the other hand, if the integrity level is `Medium or higher, the shellcode determines that`\nit is not running in a sandbox and it skips the LPE exploit. In such cases, it downloads the\nfinal payload (currently Magniber ransomware) from the second URL, decrypts it, and then\nstarts searching for a process that it could inject this payload into. For the 64-bit Windows\nshellcode variants, the target process needs to satisfy all of the following conditions:\n\nThe target process name is not `iexplore.exe`\nThe integrity level of the target process is not `Low or` `Untrusted`\nThe integrity level of the target process is not higher than the integrity level of the\ncurrent process\nThe target process is not running in the WoW64 environment\n(The target process can be opened with `PROCESS_QUERY_INFORMATION )`\n\nOnce a suitable target process is found, the shellcode jumps through the Heaven’s Gate\n(only in the WoW64 variants) and injects the payload into the target process using the\nfollowing sequence of syscalls: `NtOpenProcess ->` `NtCreateSection ->`\n```\nNtMapViewOfSection -> NtCreateThreadEx -> NtGetContextThread ->\nNtSetContextThread -> NtResumeThread . Note that in this execution chain, everything\n\n```\nhappens purely in memory and this is why Magnitude is often described as a fileless exploit\nkit. However, the current version is not entirely fileless because, as will be shown in the next\nsection, the LPE exploit drops a helper PE file to the filesystem.\n\nThe shellcode’s\n\ntransition through the heaven’s gate\n\n## CVE-2020-0986\n\n\n-----\n\nMagnitude escapes the EPM sandbox by exploiting CVE-2020-0986, a memory corruption\nvulnerability in `splwow64.exe . Since the vulnerable code is running with medium integrity`\nand a low integrity process can trigger it using Local Procedure Calls (LPC), this\nvulnerability can be used to get from the EPM sandbox to medium integrity. CVE-2020-0986\n[and the ways to exploit it are already discussed in detail in blog posts by both Kaspersky](https://securelist.com/operation-powerfall-cve-2020-0986-and-variants/98329/)\n[and Project Zero. This section will therefore focus on Magnitude’s implementation of the](https://googleprojectzero.github.io/0days-in-the-wild/0day-RCAs/2020/CVE-2020-0986.html)\nexploit, please refer to the other blog posts for further technical details about the\nvulnerability.\n\nThe vulnerable code from `gdi32.dll can be seen below. It is a part of an LPC server and`\nit can be triggered by an LPC call, with both `r8 and` `rdi pointing into a memory section`\nthat is shared between the LPC client and the LPC server. This essentially gives the\nattacker the ability to call `memcpy inside the` `splwow64 process while having control over`\nall three arguments, which can be immediately converted into an arbitrary read/write\nprimitive. Arbitrary read is just a call to `memcpy with the` `dest being inside the shared`\nmemory and `src being the target address. Conversely, arbitrary write is a call to` `memcpy`\nwith the `dest being the target address and the` `src being in the shared memory.`\n\nThe vulnerable\n\ncode from `gdi32.dll . When it gets executed, both` `r8 and` `rdi are pointing into`\nattacker-controllable memory.\nHowever, there is one tiny problem that makes exploitation a bit more difficult. As can be\nseen in the disassembled code above, the `count of the` `memcpy is obtained by adding`\nthe dereferenced content of two word pointers, located close by the `src address. This is`\nnot a problem for (smaller) arbitrary writes, since the attacker can just plant the desired\n```\ncount beforehand into the shared memory. But for arbitrary reads, the count is not\n\n```\ndirectly controllable by the attacker and it can be anywhere between `0 and` `0x1FFFE,`\nwhich could either crash `splwow64 or perform a` `memcpy with either zero or a smaller`\nthan desired `count . To get around this, the attacker can perform arbitrary reads by`\ntriggering the vulnerable code twice. The first time, the vulnerability can be used as an\narbitrary write to plant the correct `count at the necessary offset and the second time, it`\ncan be used to actually read the desired memory content. This technique has some\ndownsides, such as that it cannot be used to read non-writable memory, but that is not an\nissue for Magnitude.\n\n\n-----\n\nThe exploit starts out by creating a named mutex to make sure that there is only a single\ninstance of it running. Then, it calls `CreateDCW to spawn the` `splwow64 process that is to`\nbe exploited and performs all the necessary preparations to enable sending LPC messages\nto it later on. The exploit also contains an embedded 64-bit PE file, which it drops to\n```\n%TEMP% and executes from there. This PE file serves two different purposes and decides\n\n```\nwhich one to fulfill based on whether there is a command-line argument or not. The first\npurpose is to gather various 64-bit pointers and feed them back to the main exploit module.\nThe second purpose is to serve as a loader for the final payload once the vulnerability has\nbeen successfully exploited.\n\nThere are three pointers that are obtained by the dropped 64-bit PE file when it runs for the\nfirst time. The first one is the address of `fpDocumentEvent, which stores a pointer to`\n```\nDocumentEvent, protected using the EncodePointer function. This pointer is obtained\n\n```\nby scanning `gdi32.dll (or` `gdi32full.dll ) for a static sequence of instructions that`\nset the value at this address. The second pointer is the actual address of `DocumentEvent,`\nas exported from `winspool.drv and the third one is the pointer to` `system, exported`\nfrom `msvcrt.dll . Once the 64-bit module has all three pointers, it drops them into a`\ntemporary file and terminates itself.\n\nThe exploit\n\nscans `gdi32.dll for the sequence of the four underlined instructions and extracts the`\naddress of `fpDocumentEvent from the operands of the last instruction.`\n\n\n-----\n\nThe exploit extracting the address of `fpDocumentEvent from` `gdi32.dll`\nThe main 32-bit module then reads the dropped file and uses the obtained values during\nthe actual exploitation, which can be characterized by the following sequence of actions:\n\n1. The exploit leaks the value at the address of `fpDocumentEvent in the` `splwow64`\n\nprocess. The value is leaked by sending two LPC messages, using the arbitrary read\nprimitive described above.\n2. The leaked value is an encoded pointer to `DocumentEvent . Using this encoded`\n\npointer and the actual, raw, pointer to `DocumentEvent, the exploit cracks the secret`\n[value that was used for pointer encoding. Read the Kaspersky blog post for how this](https://securelist.com/operation-powerfall-cve-2020-0986-and-variants/98329/)\ncan be done.\n3. Using the obtained secret value, the exploit encodes the pointer to `system, so that`\n\ncalling the function `DecodePointer on this newly encoded value inside` `splwow64`\nwill yield the raw pointer to `system .`\n4. Using the arbitrary write primitive, the exploit overwrites `fpDocumentEvent with the`\n\nencoded pointer to `system .`\n5. The exploit triggers the vulnerable code one more time. Only this time, it is not\n\ninterested in any memory copying, so it sets the `count for` `memcpy to zero. Instead,`\nit counts on the fact that `splwow64 will try to decode and call the pointer at`\n```\n   fpDocumentEvent . Since this pointer was substituted in the previous step,\n   splwow64 will call system instead of DocumentEvent . The first argument to\n   DocumentEvent is read from the shared memory section, which means that it is\n\n```\ncontrollable by the attacker, who can therefore pass an arbitrary command to\n```\n   system .\n\n```\n\n-----\n\n6. Finally, the exploit uses the arbitrary write primitive one last time and restores\n```\n   fpDocumentEvent to its original value. This is an attempt to clean up after the\n\n```\nexploit, but `splwow64 might still be unstable because a random pointer got`\ncorrupted when the exploit planted the necessary `count of the leak during the first`\nstep.\n\nThe exploit cracking the secret used for encoding `fpDocumentEvent`\nThe command that Magnitude executes in the call to `system looks like this:`\n```\nicacls <dropped_64bit_PE> /Q /C /setintegritylevel Medium &&\n<dropped_64bit_PE>\n\n```\nThis elevates the dropped 64-bit PE file to medium integrity and executes it for the second\ntime. This time, it will not gather any pointers, but it will instead extract an embedded\npayload from within itself and inject it into a suitable process. Currently, the injected payload\nis the Magniber ransomware.\n\n## Magniber\n\n[Magniber emerged in 2017 when Magnitude started deploying it as a replacement for the](https://blog.malwarebytes.com/threat-analysis/2017/10/magniber-ransomware-exclusively-for-south-koreans/)\nCerber ransomware. Even though it is almost four years old, it still gets updated frequently\n[and so a lot has changed since it was last written about. The early versions featured server-](https://www.mdpi.com/2079-9292/10/1/16/)\nside AES key generation and contained constant fallback encryption keys in case the server\nwas unreachable. A decryptor that worked when encryption was performed using these\nfallback keys was developed by the Korea Internet & Security Agency and published on No\nMore Ransom. The attackers responded to this by updating Magniber to generate the\nencryption keys locally, but the custom PRNG based on `GetTickCount was very weak, so`\n[researchers from Kookmin University were able to develop a method to recover the](https://www.mdpi.com/2079-9292/10/1/16/)\nencrypted files. Unfortunately, Magniber got updated again, and it is currently using the\ncustom PRNG shown below. This function is used to generate a single random byte and it\nis called 32 times per encrypted file (16 times to generate the AES-128 key and 16 times to\ngenerate the IV).\n\n\n-----\n\nWhile this PRNG still looks very weak at first glance, we believe there is no reasonably\nefficient method to attack it. The tick count is not the problem here: it is with extremely high\nprobability going to be constant throughout all iterations of the loop and its value could be\nguessed by inspecting event logs and timestamps of the encrypted files. The problem lies in\nthe `RtlRandomEx function, which gets called 640 times (2 * 10 * (16 + 16)) per each`\nencrypted file. This means that the function is likely going to get called millions of times\nduring encryption and leaking and tracking its internal state throughout all of these calls\nunfortunately seems infeasible. At best, it might be possible to decrypt the first few\nencrypted files. And even that wouldn’t be possible on newer CPUs and Windows versions,\nbecause `RtlRandomEx there internally uses the` `rdrand instruction, which arguably`\nmakes this a somewhat decent PRNG for cryptography.\n\nThe PRNG\n\nused by Magniber to generate encryption keys\nThe ransomware starts out by creating a named mutex and generating an identifier from the\nvictim’s computer name and volume serial number. Then, it enumerates in random order all\nlogical drives that are not `DRIVE_NO_ROOT_DIR or` `DRIVE_CDROM and proceeds to`\nrecursively traverse them to encrypt individual files. Some folders, such as `sample music`\nor `tor browser, are excluded from encryption, same as all hidden, system, readonly,`\ntemporary, and virtual files. The full list of excluded folders can be found in our IoC\nrepository.\n\nJust like many other ransomware strains, Magniber only encrypts files with certain\npreselected extensions, such as `.doc or` `.xls . Its configuration contains two sets of`\nextension hashes and each file gets encrypted only if the hash of its extension can be found\nin one of these sets. The division into two sets was presumably done to assign priority to\nthe extensions. Magniber goes through the whole filesystem in two sweeps. In the first one,\nit encrypts files with extensions from the higher-priority set. In the second sweep, it encrypts\n\n\n-----\n\nthe rest of the files with extensions from the lower-priority set. Interestingly, the higherpriority set also contains nine extensions that were additionally obfuscated, unlike the rest\nof the higher-priority set. It seems that the attackers were trying to hide these extensions\nfrom reverse engineers. You can find these and the other extensions that Magniber\nencrypts in our [IoC repository.](https://github.com/avast/ioc/blob/master/Magnitude/extensions.txt)\n\nTo encrypt a file, Magniber first generates a random 128-bit AES key and IV using the\nPRNG discussed above. For some bizarre reason, it only chooses to generate bytes from\nthe range `0x03 to` `0xFC, effectively reducing the size of the keyspace from 25616 to`\n25016. Magniber then reads the input file by chunks of up to `0x100000 bytes, continuously`\nencrypting each chunk in CBC mode and writing it back to the input file. Once the whole file\nis encrypted, Magniber also encrypts the AES key and IV using a public RSA key\nembedded in the sample and appends the result to the encrypted file. Finally, Magniber\nrenames the file by appending a random-looking extension to its name.\n\n\nHowever, there is a bug in the encryption process that puts some encrypted files into a\nnonrecoverable state, where it is impossible to decrypt them, even for the attackers who\npossess the corresponding private RSA key. This bug affects all files with a size that is a\nmultiple of `0x100000 (1 MiB). To understand this bug, let’s first investigate in more detail`\nhow individual files get encrypted. Magniber splits the input file into chunks and treats the\nlast chunk differently. When the last chunk is encrypted, Magniber sets the `Final`\nparameter of `CryptEncrypt to` `TRUE, so CryptoAPI can add padding and finalize the`\nencryption. Only after the last chunk gets encrypted does Magniber append the RSAencrypted AES key to the file.\n\nThe bug lies in how Magniber determines that it is currently encrypting the last chunk: it\ntreats only chunks of size less than `0x100000 as the last chunks. But this does not work`\nfor files the size of which is a multiple of `0x100000, because even the last chunk of such`\nfiles contains exactly `0x100000 bytes. When Magniber is encrypting such files, it never`\nregisters that it is encrypting the last chunk, which causes two problems. The first problem\nis that it never calls `CryptEncrypt with` `Final=TRUE, so the encrypted files end up with`\ninvalid padding. The second, much bigger, problem is that Magniber also does not append\nthe RSA-encrypted AES key, because the trigger for appending it is the encryption of the\nlast chunk. This means that the AES key and IV used for the encryption of the file get lost\nand there is no way to decrypt the file without them.\n\n\n-----\n\nMagniber’s ransom note\nMagniber drops its ransom note into every folder where it encrypted at least one file. An\nextra ransom note is also dropped into `%PUBLIC% and opened up automatically in`\n```\nnotepad.exe after encryption. The ransom note contains several URLs leading the\n\n```\nvictims to the payment page, which instructs them on how to pay the ransom in order to\nobtain the decryptor. These URLs are unique per victim, with the subdomain representing\nthe victim identifier. Magniber also automatically opens up the payment page in the victim’s\nbrowser and while doing so, exfiltrates further information about the ransomware\ndeployment through the URL, such as:\n\nThe number of encrypted files\nThe total size of all encrypted files\nThe number of encrypted logical drives\nThe number of files encountered (encrypted or not)\nThe version of Windows\nThe victim identifier\nThe version of Magniber\n\n\n-----\n\nFinally, Magniber attempts to delete shadow copies using a UAC bypass. It writes a\ncommand to delete them to `HKCU\\Software\\Classes\\mscfile\\shell\\open\\command`\nand then executes `CompMgmtLauncher.exe assuming that this will run the command with`\nelevated privileges. But since this particular UAC bypass method was fixed in Windows 10,\nMagniber also contains another bypass method, which it uses exclusively on Windows 10\nmachines. This other method works similarly, writing the command to\n```\nHKCU\\Software\\Classes\\ms-settings\\shell\\open\\command, creating a key named\nDelegateExecute there, and finally running ComputerDefaults.exe . Interestingly, the\n\n```\ncommand used is `regsvr32.exe scrobj.dll /s /u /n /i:%PUBLIC%\\readme.txt .`\nThis is a technique often referred to as `Squiblydoo and it is used to run a script dropped`\ninto `readme.txt, which is shown below.`\n\nThe scriptlet dropped to `readme.txt, designed to delete shadow copies`\n\n## Conclusion\n\nIn this blog post, we examined in detail the current state of the Magnitude exploit kit. We\ndescribed how it exploits CVE-2021-26411 and CVE-2020-0986 to deploy ransomware to\nunfortunate victims who browse the Internet using vulnerable builds of Internet Explorer. We\nfound Magnitude to be a mature exploit kit with a very robust infrastructure. It uses\n[thousands of fresh domains each month and its infection chain is composed of seven](https://github.com/avast/ioc/blob/master/Magnitude/cncs.txt)\nstages (not even counting the multiple obfuscation layers). The infrastructure is also well\nprotected, which makes it very challenging for malware analysts to track and research the\nexploit kit.\n\nWe also dug deep into the Magniber ransomware. We found a bug that results in some files\nbeing encrypted in such a way that even the attackers can not possibly decrypt them. This\nunderscores the unfortunate fact that paying the ransom is never a guarantee to get the\nransomed files back. This is one of the reasons why we urge ransomware victims to try to\navoid paying the ransom.\n\nEven though the attackers behind Magnitude appear to have a good grasp on exploit\ndevelopment, obfuscation, and protection of malicious infrastructure, they seem to have no\nidea what they are doing when it comes to generating random numbers for cryptographic\npurposes. This resulted in previous versions of Magniber using flawed PRNGs, which\nallowed malware researchers to develop decryptors that helped victims recover their\nransomed files. However, Magniber was always quick to improve their PRNG, which\n\n\n-----\n\nunfortunately made the decryptors obsolete. The current version of Magniber is using a\nPRNG that seems to be just secure enough, which makes us believe that there will be no\nmore decryptors in the future.\n\n### Indicators of Compromise (IoC)\n\n[The full list of IoCs is available at https://github.com/avast/ioc/tree/master/Magnitude.](https://github.com/avast/ioc/tree/master/Magnitude)\n\nRedirection page\n\nSHA-256\n```\n 2cc3ece1163db8b467915f76b187c07e1eb0ca687c8f1efb9d278b8daadbe590\n 3da50b3752560932d9d123ef813a3b67f5d840fee38a18cc14d18d5dc369bce4\n 91dbcaa7833aef48fa67c55c26c9c142cb76c5530c0b2a3823c8f74cf52b73cc\n db8cf1f5651a44b443a23bc239b4215dcfd0a935458f9d17cb511b2c33e0c3b9\n ef15ee0511c2f9e29ecaf907f3ca0bb603f7ec57d320ba61b718c4078b864824\n\n```\nCVE-2021-26411\n\nSHA-256\n```\n 0306b0b79a85711605bbbfac62ac7d040a556aa7ac9fe58d22ea2e00d51b521a\n 419da91566a7b1e5720792409301fa772d9abf24dfc3ddde582888112f12937a\n 6a348a5b13335e453ac34b0ed87e37a153c76a5be528a4ef4b67e988aaf03533\n 4e80fa124865445719e66d917defd9c8ed3bd436162e3fbc180a12584d372442\n 217f21bd9d5e92263e3a903cfcea0e6a1d4c3643eed223007a4deb630c4aee26\n\n```\nShellcode\n\nSHA-256 Note\n\n`5d0e45febd711f7564725ac84439b74d97b3f2bc27dbe5add5194f5cdbdbf623` Win10\nWoW64\nvariant\n\n`351a2e8a4dc2e60d17208c9efb6ac87983853c83dae5543e22674a8fc5c05234` ^\nunpacked\n\n`4044008da4fc1d0eb4a0242b9632463a114b2129cedf9728d2d552e379c08037` Win7\nWoW64\nvariant\n\n\n-----\n\n`1ea23d7456195e8674baa9bed2a2d94c7235d26a574adf7009c66d6ec9c994b3` ^\nunpacked\n\n`3de9d91962a043406b542523e11e58acb34363f2ebb1142d09adbab7861c8a63` Win7\nnative\nvariant\n\n`dfa093364bf809f3146c2b8a5925f937cc41a99552ea3ca077dac0f389caa0da` ^\nunpacked\n\n`e05a4b7b889cba453f02f2496cb7f3233099b385fe156cae9e89bc66d3c80a7f` newer\nWin7\nWoW64\nvariant\n\n`ae930317faf12307d3fb9a534fe977a5ef3256e62e58921cd4bf70e0c05bf88a` latest\nWin7\nWoW64\nvariant\n\nCVE-2020-0986\n\nSHA-256 Note\n\n`440be2c75d55939c90fc3ef2d49ceeb66e2c762fd4133c935667b3b2c6fb8551` pingback\npayload\n\n`a5edae721568cdbd8d4818584ddc5a192e78c86345b4cdfb4dc2880b9634acab` pingback\npayload\n\n`1505368c8f4b7bf718ebd9a44395cfa15657db97a0c13dcf47eb8cfb94e7528b` Magniber\npayload\n\n`63525e19aad0aae1b95c3a357e96c93775d541e9db7d4635af5363d4e858a345` Magniber\npayload\n\n`31e99c8f68d340fd046a9f6c8984904331dc6a5aa4151608058ee3aabc7cc905` Magniber\npayload\n\nPointer scanner/loader 64-bit module\n\nSHA-256\n\n\n-----\n\n```\n7c1fc5dfb970f856abf48cc65bda4f102452216ad8b9f1fe9c7a66650d91959d\n\n```\n\nMagniber\n\nSHA-256\n```\n a2448b93d7c50801056052fb429d04bcf94a478a0a012191d60e595fed63eec4\n 525f9dbf9a74390fd22779a68f191b099ee9b4d2e8095c57ac1c932629a8af56\n 3ae5cd106e3130748ef61d317022d7b6ab98a0811088cfc478d49375c352bf04\n daf17fbf2bfcfaa2dafb6470a5da0054eb61ab5b44cd8cbbf22f8819f3c432db\n fcd8f8647a1d5e08446a392cc6c69090c00714d681c4fa258656e12cd4f80c2e\n\n```\nC&Cs\n\n[https://github.com/avast/ioc/blob/master/Magnitude/cncs.txt](https://github.com/avast/ioc/blob/master/Magnitude/cncs.txt)\n\nDecoy ad domains\n\n[https://github.com/avast/ioc/blob/master/Magnitude/decoys.txt](https://github.com/avast/ioc/blob/master/Magnitude/decoys.txt)\n\n[Tagged asCVE-2020-0986,](https://decoded.avast.io/tag/cve-2020-0986/) [CVE-2021-26411,](https://decoded.avast.io/tag/cve-2021-26411/) [exploit kit,](https://decoded.avast.io/tag/exploit-kit/) [Magniber,](https://decoded.avast.io/tag/magniber/) [Magnitude,](https://decoded.avast.io/tag/magnitude/)\n[ransomware](https://decoded.avast.io/tag/ransomware/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-29 - Magnitude Exploit Kit- Still Alive and Kicking.pdf"
    ],
    "report_names": [
        "2021-07-29 - Magnitude Exploit Kit- Still Alive and Kicking.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536234,
    "ts_updated_at": 1743041761,
    "ts_creation_date": 1653787070,
    "ts_modification_date": 1653787070,
    "files": {
        "pdf": "https://archive.orkl.eu/ec188174b1fdf6310beb2325f6daa5b37f659ed2.pdf",
        "text": "https://archive.orkl.eu/ec188174b1fdf6310beb2325f6daa5b37f659ed2.txt",
        "img": "https://archive.orkl.eu/ec188174b1fdf6310beb2325f6daa5b37f659ed2.jpg"
    }
}