{
    "id": "13743c8f-8569-46d1-840b-f87cae324e4f",
    "created_at": "2024-04-24T02:05:39.618464Z",
    "updated_at": "2025-03-27T02:05:51.959881Z",
    "deleted_at": null,
    "sha1_hash": "6bc56b6ed67000eb6fcc6a6a66c2d2fff061f533",
    "title": "",
    "authors": "",
    "file_creation_date": "2017-12-07T15:20:15Z",
    "file_modification_date": "2017-12-07T15:20:15Z",
    "file_size": 1658780,
    "plain_text": "## Who Hid My Desktop\n\n###### DEEP DIVE INTO HVNC\n\n Or Safran, Pavel Asinovsky\nIBM Trusteer, Israel\n\n\n-----\n\n###### • Intro\n\nWhat is VNC.\n\n###### • Part 1\n\nSessions, Window Stations, Desktops.\n\n###### • Part 2\n\nFinancial malware.\nhVNC.\n\n###### • Part 3\n\nReversing Gozi ISFB’s hVNC module.\nDemo.\nDetection/IOCs.\n\n\n-----\n\n##### VNC & hVNC\n\n\n###### CAT hCAT\n\n\n###### hCAT\n\n\n-----\n\n###### • IBM Security (Trusteer) Financial Malware Research Team\n\n • Or Safran\n\n • Pavel Asinovsky\n\n\n-----\n\n###### • Allows remote control of a computer across the network.\n\n • Originally was used for remote technical support.\n\n • Used for server administration, conference calls, file transfers, etc.\n\n • Has many implementations: RDP, VNC, Citrix, LogMeIn, TeamViewer etc.\n\n\n-----\n\n###### • Virtual Network Computing.\n\n • Graphical desktop sharing system that\n uses the RFB protocol (Remote Frame Buffer).\n\n • Composed of a server and a client.\n\n • Platform independent.\n\n • Default TCP port 5900.\n\n • The desktop is shared.\n\n • Used by many RAT (Remote Access\n Tool) Malware.\n\n\n###### Keyboard & Mouse Input\n\n Screenshots\n\n\n###### Server\n\n Server\n\n Server\n\n\n###### Client / Viewer\n\n\n-----\n\n#### Part 1 – Sessions, Window Stations and Desktops\n\n\n-----\n\n###### • Securable kernel objects (contain a security\n descriptor).\n\n • Used as containers to manage graphical objects,\n provide isolation and security.\n\n • Structured in hierarchy.\n\n • Each session contains only one interactive window\n station – WinSta0.\n\n\n-----\n\n###### • Represent a single user’s logon session.\n\n • Each user is assigned with a different session.\n\n • Session 0 is the base session (the system user session).\n\n • Session 0 is isolated from the user sessions.\n\n\n-----\n\n###### • A logical security boundary.\n\n • Contains a clipboard, atom table, and one\n or more desktop objects.\n\n • Contains the keyboard, mouse, and a\n display device.\n\n • Associated with a process.\n\n • The interactive window station (WinSta0) is\n the only that can display user interface or receive user input.\n\n • Used by Chrome to implement a “Sandbox”.\n\n\n-----\n\n###### • A desktop is a logical display surface that contains UI objects such as windows, menus and hooks.\n\n • Used as a container to create and manage windows.\n\n • Associated with a thread.\n\n • By default, there are few interactive desktops on windows:\n\nThe default desktop: \\Sessions\\1\\Windows\\WinSta0\\Default\nThe Winlogon secure desktop: \\Sessions\\1\\Windows\\WinSta0\\Winlogon\nAnd more…\n\n###### • There can be only one interactive desktop at a time.\n\n\n-----\n\n-----\n\n###### • Supported by Windows API since Windows 2000.\n\n • Have many legitimate uses:\n\nSecurity applications\nMultiple desktops\nWindows logon/logoff screens\nUAC\nCtrl + Alt + Del screen\nScreensavers\n\n\n-----\n\n-----\n\n###### • When a program calls a USER32 or GDI32 function, a window station is assigned to the calling\n process and a desktop is assigned to the calling thread according to the following rules:\n\n As specified using the SetThreadDesktop() / SetProcessWindowStation() APIs. Inherited from the parent process. As specified in the STARTUPINFO structure. The calling thread connects to the “\\Default” Desktop.\n\n\n-----\n\n### Part 2 – Financial Malware and hVNC\n\n\n-----\n\n-----\n\n###### • Web Injections\n\n • Form Grabbing\n\n • Cookie Grabbing\n\n • KeyLogging (kernel mode \\ user mode)\n\n • SSL Proxy (with certificate installation)\n\n • DNS Pharming\n\n • Redirects\n\n\n-----\n\n-----\n\n###### • Introduced to the world by the infamous Zeus malware.\n\n • Allows the attacker to use the exact same machine as the victim.\n\n • hVNC alone is usually not enough to commit a fraudulent transaction.\n\n • Most modern financial malware have an embedded hVNC module (Zeus, Gozi, Dridex and more).\n\n\n-----\n\n###### Password validation\n\n\n###### Keyloggers/Form\n grabbers\n\n\n###### IP/Geo-location validation\n\n\n###### SOCKS Proxy Server\n\n\n###### Browser/System fingerprint\n\n\n###### hVNC\n\n\n-----\n\n###### • Has same capabilities like regular VNC.\n\n • Hidden (runs on a different desktop).\n\n • Cannot see the user’s desktop and can’t be seen by the user.\n\n • Makes sure the SwitchDesktop API is never called.\n\n • Has the same browser-system fingerprint as the user.\n\n • Uses BackConnect – the server sends the first connection request to the client.\n\n • Slightly modified RFB protocol to authenticate the malware.\n\n • Must implement all the user interaction by itself (Windows supports only a single interactive desktop at a\n time).\n\n • Can be used to log in to active web-sessions (shopping websites, Facebook, Gmail).\n\n\n-----\n\n###### Malware Process\n\n\nCreateDesktop()\n\n\n###### Hidden Desktop\n created\n\n\nSetThreadDesktop()\n\n\n###### The hidden desktop\n is assigned to the\n malware\n\n\nCreateProcess()\n\n\n###### Explorer.exe (Taskbar, start menu\n and desktop icons)\n\n\n-----\n\n### Part 3 – Gozi ISFB hVNC case study\n\n\n-----\n\n###### • One of the most widespread financial malwares.\n\n • One of the best hVNC modules found in the wild.\n\n • Based on the hVNC code of Zeus.\n\n • Has debug versions – fd36d1e2be1f0079c7cb66288778ffa9.\n\n • Became an open source malware when an unknown player leaked it’s code (the hVNC module is\n missing from the source code).\n\n\n-----\n\n###### • The hVNC module is downloaded from a remote server.\n\n • The module is encrypted with two layers of encryption:\n\nSerpent cipher with a randomly generated key (appended to\nthe encrypted module).\n\nThe Serpent encrypted hVNC module and the Serpent key are\nencrypted again using an RSA cipher.\n\n\n###### Encrypted hVNC, RSA key is stored in\n the binary\n\n\nRSA decrypt\n\n\n###### Encrypted hVNC +\n Serpent key\n\n\nSerpent decrypt\n\n\n###### Decrypted module\n\n\n-----\n\n###### CreateProcess\n Hooks\n\n\n\n###### • The code injection technique is the same one the Gozi malware\n uses.\n\n\n###### Modify\n target\n\n Resume\n thread\n\n Suspend\n Thread\n\n Resume\n thread\n\n\n###### Injected process\n\n\n-----\n\n###### • Most hVNC modules send a unique identifier of the malware to the hVNC client in order to\n authenticate it.\n\n • A regular VNC client will not work out of the box, it has to be reversed and patched.\n\n • After the authentication phase is over, the regular RFB protocol is initiated.\n\n\n-----\n\n###### • Has code to deal with every common browser (IE, Chrome, Firefox, Opera).\n\n • One cannot open the same browser in two separate desktop under the same user profile.\n\n\n-----\n\n###### • For Chrome, hVNC copies the whole user profile (user data folder) to a different location and setting it\n as the user data directory for the new browser process.\n\n\n-----\n\n###### • The browser might render pages using the graphics card (GPU).\n\n • The browser uses a sandbox that might not play well with hVNC module.\n\n\n-----\n\n###### • hVNC doesn’t want to allow IE to merge different frames into the same process.\n\n • Virtual registry hooks\n\nHook registry query functions to change settings only in the hVNC session without any permanent changes.\n\n###### • IE settings\n\nAlter many IE settings virtually: protected mode for internet zones, enhanced protected mode and more.\n\n###### • UAC adjustments:\n\nWhen UAC is on and off, IE uses different location to load session cookies.\n\n\n-----\n\n###### • Virtual registry hooks for changing system settings:\n\nDisable visual effects [Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\VisualEffects]\nDisable active desktop [Software\\Microsoft\\Windows\\CurrentVersion\\Policies]\nRemoves wallpaper [Software\\Microsoft\\Internet Explorer\\Desktop\\General]\n\n###### • Hook window events:\n\nEVENT_OBJECT_CREATE\nEVENT_OBJECT_HIDE\nEVENT_OBJECT_SHOW\nEVENT_OBJECT_DESTROY\nEVENT_OBJECT_LOCATIONCHANGE\netc.\n\n###### • Virtual keyboard and mouse (PostMessage to the topmost window).\n\n • Virtual Clipboard.\n\n • Screenshots (Using BitBlt and PrintWindow APIs).\n\n\n-----\n\n###### • We are able to watch fraudsters in action with two easy steps.\n\n • Open a handle by using the OpenDesktop API.\n\n • Switch to the fraudster’s desktop using the SwitchDesktop API.\n\n\n-----\n\n###### • Obtain and decrypt the hVNC module.\n\n • Inject the hVNC module into explorer.exe the same way Gozi does.\n\n • Direct the hVNC module to communicate with our machine instead of the one originally\n hardcoded into the binary.\n\n • Overcome the protocol differences between Gozi’s hVNC and the standard RFB.\n\n\n-----\n\n###### Server (Victim) Client (Attacker)\n\n\n\n###### • Manually inject the Gozi hVNC\n module and make it run from explorer.exe.\n\n • Make it connect to our VNC client by\n replacing the IP address.\n\n • Establish a connection and bypass\n the bot identifier authentication.\n\n\n\n###### • Set up a VNC client in listening mode.\n\n • Wait for an RFB connection from the\n server and obtain control over the victim’s machine.\n\n\n-----\n\n###### • Second explorer.exe holding a handle to an unknown desktop (Not the default one).\n\n • Usually has ctfmon.exe automatically running under it (text input services support).\n\n • Has processes running under it that you don’t see their windows, such as a browser.\n\n\n-----\n\n###### • The hVNC code is extremely complicated.\n\n • It is one of the top tools in the financial malware toolkit.\n\n • It uses many cool tricks and manipulations in order to achieve it’s purpose.\n\n • Although not new, it is still popular and common in online banking fraud today.\n\n\n-----\n\n-----\n\n# THANK YOU\n\nFOLLOW US ON:\n\nibm.com/security\n\nsecurityintelligence.com\n\nxforce.ibmcloud.com\n\n@ibmsecurity\n\nyoutube/user/ibmsecuritysolutions\n\n© Copyright IBM Corporation 2016. All rights reserved. The information contained in these materials is provided for informational purposes only, and is provided AS IS without warranty of any kind,\nexpress or implied. Any statement of direction represents IBM's current intent, is subject to change or withdrawal, and represent only goals and objectives. IBM, the IBM logo, and other IBM products\nand services are trademarks of the International Business Machines Corporation, in the United States, other countries or both. Other company, product, or service names may be trademarks or service\nmarks of others.\n\nStatement of Good Security Practices: IT system security involves protecting systems and information through prevention, detection and response to improper access from within and outside your\nenterprise. Improper access can result in information being altered, destroyed, misappropriated or misused or can result in damage to or misuse of your systems, including for use in attacks on others.\nNo IT system or product should be considered completely secure and no single product, service or security measure can be completely effective in preventing improper use or access. IBM systems,\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://deepsec.net/docs/Slides/2017/Who_Hid_My_Desktop_Or_Safran_Pavel_Asinovsky.pdf"
    ],
    "report_names": [
        "Who_Hid_My_Desktop_Or_Safran_Pavel_Asinovsky.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1713924339,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1512660015,
    "ts_modification_date": 1512660015,
    "files": {
        "pdf": "https://archive.orkl.eu/6bc56b6ed67000eb6fcc6a6a66c2d2fff061f533.pdf",
        "text": "https://archive.orkl.eu/6bc56b6ed67000eb6fcc6a6a66c2d2fff061f533.txt",
        "img": "https://archive.orkl.eu/6bc56b6ed67000eb6fcc6a6a66c2d2fff061f533.jpg"
    }
}