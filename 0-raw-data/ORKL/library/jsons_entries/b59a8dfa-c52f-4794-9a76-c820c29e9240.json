{
    "id": "b59a8dfa-c52f-4794-9a76-c820c29e9240",
    "created_at": "2023-01-12T15:06:02.804524Z",
    "updated_at": "2025-03-27T02:05:28.024493Z",
    "deleted_at": null,
    "sha1_hash": "9823b6f6f28a0a88e297ff33c160c237cd4d38ca",
    "title": "2015-05-04 - Threat Spotlight- Rombertik – Gazing Past the Smoke, Mirrors, and Trapdoors",
    "authors": "",
    "file_creation_date": "2022-05-27T21:09:55Z",
    "file_modification_date": "2022-05-27T21:09:55Z",
    "file_size": 674934,
    "plain_text": "# Threat Spotlight: Rombertik – Gazing Past the Smoke, Mirrors, and Trapdoors\n\n**blogs.cisco.com/security/talos/rombertik**\n\nTalos Group May 4, 2015\n\n_[This post was authored by Ben Baker and](http://blogs.cisco.com/author/benbaker)_ _[Alex Chiu.](http://blogs.cisco.com/author/alexanderchiu)_\n\n## Executive Summary\n\nThreat actors and security researchers are constantly looking for ways to better detect and\nevade each other. As researchers have become more adept and efficient at malware\nanalysis, malware authors have made an effort to build more evasive samples. Better static,\ndynamic, and automated analysis tools have made it more difficult for attackers to remain\nundetected. As a result, attackers have been forced to find methods to evade these tools and\ncomplicate both static and dynamic analysis.\n\nIt becomes critical for researchers to reverse engineer evasive samples to find out how\nattackers are attempting to evade analysis tools. It is also important for researchers to\ncommunicate how the threat landscape is evolving to ensure that these same tools remain\neffective. A recent example of these behaviors is a malware sample Talos has identified as\n\n\n-----\n\n**Table of Contents**\n[Executive Summary](http://blogs.cisco.com/security/talos/rombertik#summary)\n[The 10,000 Foot View at Rombertik](http://blogs.cisco.com/security/talos/rombertik#high-level)\n[Analysis](http://blogs.cisco.com/security/talos/rombertik#analysis)\n[A Nasty Trap Door](http://blogs.cisco.com/security/talos/rombertik#trap-door)\n[The Actual Malware](http://blogs.cisco.com/security/talos/rombertik#malware)\n[Coverage and Indicators of Compromise](http://blogs.cisco.com/security/talos/rombertik#ioc)\n[Conclusion](http://blogs.cisco.com/security/talos/rombertik#conclusion)\n\n\nRombertik. In the process of reverse\nengineering Rombertik, Talos discovered\nmultiple layers of obfuscation and antianalysis functionality. This functionality was\ndesigned to evade both static and dynamic\nanalysis tools, make debugging difficult. If the\nsample detected it was being analyzed or\ndebugged it would ultimately destroy the\nmaster boot record (MBR).\n\n\nTalos’ goal is to protect our customer’s\nnetworks. Reverse engineering Romberik helps Talos achieve that goal by better\nunderstanding how attackers are evolving to evade detection and make analysis difficult.\nIdentifying these techniques gives Talos new insight and knowledge that can be\ncommunicated to Cisco’s product teams. This knowledge can then be used to harden our\nsecurity products to ensure these anti-analysis techniques are ineffective and allow detection\ntechnologies to accurately identify malware to protect customers.\n\n## The 10,000 Foot View at Rombertik\n\nAt a high level, Romberik is a complex piece of malware that is designed to hook into the\nuser’s browser to read credentials and other sensitive information for exfiltration to an\nattacker controlled server, similar to [Dyre. However, unlike Dyre which was designed to](http://blogs.cisco.com/talos/threat-spotlight-dyre)\ntarget banking information, Rombertik collects information from all websites in an\nindiscriminate manner.\n\nRombertik has been identified to propagate via spam and phishing messages sent to wouldbe victims. Like previous spam and phishing campaigns Talos has discussed, attackers use\nsocial engineering tactics to entice users to download, unzip, and open the attachments that\nultimately result in the user’s compromise.\n\n\n-----\n\nFigure 1: Email\n\nmessages such as the one seen here are spammed out in the hopes that users will open\nthem and open the attachments. This is one sample that was used to propagate Rombertik.\nIn this sample, the message observed in Rombertik’s distribution appears to come from the\n“Windows Corporation,” an organization that possesses “state-of-the-art manufacturing\nquality processes.” The attackers attempt to convince the user to check the attached\ndocuments to see if their business aligns with the target user’s organization. If the user\ndownloads and unzips the file, the user then sees a file that looks like a document thumbnail.\n\nWhile this file may appears to be some sort of PDF from the\nicon or thumbnail, the file actually is a .SCR screensaver\nexecutable file that contains Rombertik. Once the user double\nclicks to open the file, Rombertik will begin the process of\ncompromising the system.\n\nThe process by which Rombertik compromises the target\nsystem is a fairly complex with anti-analysis checks in place to\nprevent static and dynamic analysis. Upon execution,\nRombertik will stall and then run through a first set of antianalysis checks to see if it is running within a sandbox. Once\nthese checks are complete, Rombertik will proceed to decrypt and install itself on the victims\ncomputer to maintain persistence. After installation, it will then launch a second copy of itself\nand overwrite the second copy with the malware’s core functionality. Before Rombertik\nbegins the process of spying on users, Rombertik will perform once last check to ensure it is\nnot being analyzed in memory. If this check fails, Rombertik will attempt to destroy the\nMaster Boot Record and restart the computer to render it unusable. The graphic below\nillustrates the process.\n\n\n-----\n\nFigure 2: An\n\nillustration of the step-by-step process Rombertik follows to compromise the target system.\n\n## Analysis\n\nFrom the beginning, Rombertik incorporates several layers of obfuscation along with antianalysis functionality. Obfuscating the functionality of a malware sample can be\naccomplished in many different ways. A common method is to include garbage code to\ninflate the volume of code an analyst might have to review and analyze. In this case, the\nunpacked Rombertik sample is 28KB while the packed version is 1264KB. Over 97% of the\npacked file is dedicated to making the file look legitimate by including 75 images and over\n8000 functions that are never used. This packer attempts to overwhelm analysts by making it\nimpossible to look at every function.\n\n\n-----\n\nFigure 3:\n\nThis chart shows the breakdown of the Rombertik executable and how it contains a large\namount of unnecessary code and data.\nAs we started to slowly peel back the layers and focus on the subset of functions that are\nactually used, we observed an interesting sandbox evasion technique. A common technique\nto evade sandboxes is to sleep for extended lengths of time with the intention of forcing the\nsandbox to time out before the malware “wakes up” and begins executing. In response,\nsandboxes got better at detecting and responding when malware slept for extended periods\nof time. Rombertik employs a similar approach to delay execution, but does so without\nsleeping. Rombertik instead writes a byte of random data to memory 960 Million times. This\nis designed to consume time, like sleeping, but presents a couple disadvantages for\nsandboxes and application tracing tools. Sandboxes may not be able to immediately\ndetermine that the application is intentionally stalling since it’s not sleeping. The other\ndisadvantage is that the repetitive writing would flood application tracing tools. If an analysis\ntool attempted to log all of the 960 Million write instructions, the log would grow to over 100\ngigabytes. Even if the analysis environment was capable of handling a log that large, it would\ntake over 25 minutes just to write that much data to a typical hard drive. This complicates\nanalysis.\n\n\n-----\n\nAfter intentionally stalling by writing to memory repeatedly, Rombertik checks to see if\nanalysis tools have modified code in the Windows API ZwGetWriteWatch routine. It does\nthis by calling ZwGetWriteWatch with invalid arguments. If the routine does not return with a\nspecific error, Rombertik terminates. The assumption behind checking for a specific error\nversus a generic error is to check for sandboxes that suppress errors returned from API\nroutine calls.  Once the sandbox check is complete, Rombertik calls the Windows API\nOutputDebugString function 335,000 times as an anti-debugging mechanism. Finally, an\nanti-analysis function within the packer is called to check the username and filename of the\nexecuting process for strings like “malwar”, “sampl”, “viru”, and “sandb”. If the packer detects\nany of these substrings, it will stop unpacking and terminate. At this point, the initial antianalysis checks are complete.\n\nOnce the packer has run through initial anti-analysis checks, it will check to see if it is\nexecuting from %AppData%\\rsr\\yfoye.exe. If the packer is not executing from there, it will\nproceed to install itself in order to ensure persistence across system reboots before\ncontinuing on to execute the payload. To install itself, Rombertik first creates a VBS script\nnamed “fgf.vbs”, which is used to kick off Rombertik every time the user logs in, and places\nthe script into the user’s Startup folder. Rombertik then creates %AppData%\\rsr\\yfoye.bat\nand moves the packed version of itself into %AppData%\\rsr\\yfoye.exe.\n\nIf Rombertik detects it is already executing from %AppData%\\rsr\\yfoye.exe, the malware will\nthen begin decrypting and executing the main unpacking code in memory. Rombertik will\nthen proceed to execute yfoye.exe a second time to create a new instance of the process.\nOnce the unpacking is complete, Rombertik will overwrite the memory of the new process\nwith the unpacked executable code. The unpacking code is monstrous and has many times\nthe complexity of the anti-analysis code. The code contains dozens of functions overlapping\nwith each other and unnecessary jumps added to increase complexity. The result is a\nnightmare of a control flow graph with hundreds of nodes. Figure 4 helps illustrate how\ncomplex the unpacking code is in comparison to the all the code that performs anti-analysis\nchecks.\n\n\n-----\n\nFigure 4: The\n\ncontrol flow graph on the left represents the interwoven functions within the unpacking code\nthat’s decrypted to memory. The control flow graph on the right represents the previously\nmentioned anti-analysis checks. These 23 basic blocks represent the 930 million writes, 335\nthousand API calls, checking ZwGetWriteWatch, and checking file and usernames. All of this\nfunctionality fits in this rather simple graph, where the red block is only executed if all of the\nchecks were satisfied. A typical function has less than 20 nodes (basic blocks) and would\nnormally be easy to see how all basic blocks relate to each other.\n\n## A Nasty Trap Door\n\nOnce the unpacked version of Rombertik within the second copy of yfoye.exe begins\nexecuting, one last anti-analysis function is run — which turns out to be particularly nasty if\nthe check fails. The function computes a 32-bit hash of a resource in memory, and\ncompares it to the PE Compile Timestamp of the unpacked sample. If the resource or\ncompile time has been altered, the malware acts destructively. It first attempts to overwrite\nthe Master Boot Record (MBR) of PhysicalDisk0, which renders the computer inoperable. If\nthe malware does not have permissions to overwrite the MBR, it will instead destroy all files\nin the user’s home folder (e.g. C:\\Documents and Settings\\Administrator\\) by encrypting each\nfile with a randomly generated RC4 key. After the MBR is overwritten, or the home folder\nhas been encrypted, the computer is restarted.\n\n\n-----\n\nThe Master Boot Record starts with code that is executed before the Operating System. The\noverwritten MBR contains code to print out “Carbon crack attempt, failed”, then enters an\ninfinite loop preventing the system from continuing to boot.\n\nThe MBR also contains information about the disk partitions. The altered MBR overwrites the\nbytes for these partitions with Null bytes, making it even more difficult to recover data from\nthe sabotaged hard drive.\n\nOnce the computer is restarted, the victim’s computer will be stuck at this screen until the\nOperating System is reinstalled:\n\n\n-----\n\n[Effectively, Rombertik begins to behave like a wiper malware sample, trashing the user’s](http://blogs.cisco.com/talos/wiper-malware)\ncomputer if it detects it’s being analyzed. While Talos has observed anti-analysis and antidebugging techniques in malware samples in the past, Rombertik is unique in that it actively\nattempts to destroy the computer’s data if it detects certain attributes associated with\nmalware analysis.\n\n## The Actual Malware\n\nAt this point, Rombertik will assume that all anti-analysis checks have passed and will\nactually begin doing what was originally intended — stealing user data. Rombertik will scan\nthe user’s currently running process to determine if a web browser is currently running. If\nRombertik detects an instance of Firefox, Chrome, or Internet Explorer, it will inject itself into\nthe process and hook API functions that handle plain text data. Once accomplished,\nRombertik is then able to read any plain-text data the user might type into their browser and\ncapture this input before it gets encrypted if the input is to be sent over HTTPS. This enables\nthe malware to collect data such as usernames and passwords from almost any website.\nRombertik does not target any site in particular, such as banking sites, but instead, attempts\nto steal sensitive information from as many websites as possible. The collected data is then\nBase64 encoded and forwarded to www.centozos.org.in/don1/gate.php (in this example)\nover HTTP with no encryption.\n\n\n-----\n\n## Coverage and Indicators of Compromise\n\n**Sample Analysed (SHA256)**\n\n0d11a13f54d6003a51b77df355c6aa9b1d9867a5af7661745882b61d9b75bccf\n\n**Command-and-Control Servers**\n\nwww.centozos[.]org[.]in\n\n## Conclusion\n\nRombertik is a complex piece of malware with several layers of obfuscation and anti-analysis\nfunctionality that is ultimately designed to steal user data. Good security practices, such as\nmaking sure anti-virus software is installed and kept up-to-date, not clicking on attachments\nfrom unknown senders, and ensuring robust security policies are in place for email (such as\nblocking certain attachment types) can go a long way when it comes to protecting users.\nHowever, a defense in depth approach that covers the entire attack continuum can help\nidentify malware and assist in remediation in the event that an attacker finds a way to evade\ndetection initially.\n\nFor Talos, understanding how malware changes and evolves is essential to developing\ndetection content and ensuring that static, dynamic, and automated analysis tools remain\neffective. We must adapt, change, and respond accordingly to address the evolving threat\nlandscape. Looking forward, Talos expects these methods and behaviors to be adopted by\nother threat actors in the future.\n\n## Protecting Users From These Threat\n\nWe encourage organizations to consider security best practices, starting with a threat-centric\napproach that implements protections across the extended network and across the full attack\ncontinuum.\n\n\n-----\n\n[ESA can block malicious emails, including phishing](http://www.cisco.com/c/en/us/products/security/email-security-appliance/index.html)\nand malicious attachments sent by threat actors.\n\n[CWS/WSA web scanning prevents access to](http://www.cisco.com/c/en/us/products/security/cloud-web-security/index.html)\nwebsites hosting malicious content.\n\n[Advanced Malware Protection (AMP) is designed to](http://www.cisco.com/c/en/us/support/security/amp-firepower-software-license/tsd-products-support-series-home.html)\nprevent the execution of the malware used by these\nthreat actors.\n\n[Network Security appliances, such as NGIPS and](http://www.cisco.com/c/en/us/products/security/intrusion-prevention-system-ips/index.html)\n[NGFW, have signatures to detect and block malicious](http://www.cisco.com/c/en/us/products/security/asa-next-generation-firewall-services/index.html)\nnetwork activity by threat actors.\n\n\nShare:\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-05-04 - Threat Spotlight- Rombertik – Gazing Past the Smoke, Mirrors, and Trapdoors.pdf"
    ],
    "report_names": [
        "2015-05-04 - Threat Spotlight- Rombertik – Gazing Past the Smoke, Mirrors, and Trapdoors.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535962,
    "ts_updated_at": 1743041128,
    "ts_creation_date": 1653685795,
    "ts_modification_date": 1653685795,
    "files": {
        "pdf": "https://archive.orkl.eu/9823b6f6f28a0a88e297ff33c160c237cd4d38ca.pdf",
        "text": "https://archive.orkl.eu/9823b6f6f28a0a88e297ff33c160c237cd4d38ca.txt",
        "img": "https://archive.orkl.eu/9823b6f6f28a0a88e297ff33c160c237cd4d38ca.jpg"
    }
}