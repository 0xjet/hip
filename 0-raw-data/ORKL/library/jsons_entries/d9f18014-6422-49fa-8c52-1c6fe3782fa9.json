{
    "id": "d9f18014-6422-49fa-8c52-1c6fe3782fa9",
    "created_at": "2023-04-05T02:09:54.888351Z",
    "updated_at": "2025-03-27T02:05:30.128286Z",
    "deleted_at": null,
    "sha1_hash": "30b1f84e912c488faed2562dce6c102bd708142b",
    "title": "2023-03-25 - [QuickNote] Decrypting the C2 configuration of Warzone RAT",
    "authors": "",
    "file_creation_date": "2023-04-03T08:54:09Z",
    "file_modification_date": "2023-04-03T08:54:09Z",
    "file_size": 573188,
    "plain_text": "# [QuickNote] Decrypting the C2 configuration of Warzone RAT\n\n**[kienmanowar.wordpress.com/2023/03/25/quicknote-decrypting-the-c2-configuration-of-warzone-rat/](https://kienmanowar.wordpress.com/2023/03/25/quicknote-decrypting-the-c2-configuration-of-warzone-rat/)**\n\n**1. Introduction**\n\n\nMarch 25, 2023\n\n\n**Warzone RAT is a type of malware that is capable of infiltrating a victim’s computer and**\ngiving attackers remote access and control over the system. The malware has gained\nnotoriety for its advanced capabilities and ability to evade detection, making it a serious\nthreat to computer security.\n\nWarzone RAT is typically spread through phishing emails or other social engineering\ntechniques, where attackers trick victims into downloading and installing the malware on their\nsystems. Once the malware is installed, it can perform a variety of malicious actions,\nincluding stealing passwords, taking screenshots, and logging keystrokes. It can also\ndownload and execute additional malware, giving attackers even more control over the\nvictim’s system.\n\nOne of the key features of Warzone RAT is its ability to encrypt its configuration data, making\nit difficult for security experts to analyze and understand how the malware operates.\n_Currently, there are two variants of the malware in circulation, each using a different method_\n_to decode its configuration. The first variant uses standard RC4 encryption, while the second_\n_variant uses a modified version of RC4. This modification makes it even more challenging to_\n_decrypt and analyze the malware’s configuration data._\n\n**2. Analysis**\n\nSample1: [00930cccd81e184577b1ffeebf08ee6a32dd0ef416435f551c64d2bcb61d46cf (use](https://www.unpac.me/results/c837149f-a28a-4519-9e08-0082438bcbd7#/)\nstandard RC4)\n\n\n-----\n\nSample2: [61f8bf26e80b6d6a7126d6732b072223dfc94203bb7ae07f493aad93de5fa342 (use](https://www.unpac.me/results/667fd0c7-69d6-49b9-a5ab-76616eabfd23#/)\nmodified RC4)\n\nIn Warzone RAT, the configuration info is stored in the .bss PE section of the malware’s\ncode. The .bss section is typically used for storing uninitialized data. The format of the\nconfiguration is as follows: [Key length] [RC4 key] [Encrypted data]. Below is an\nillustration of the configuration stored in the .bss section in both samples.\n\n\n-----\n\nThe steps to perform the process of retrieving information and copying data from the .bss\nsection to memory are the same in both samples. The pseudo-code is shown below:\n\n\n-----\n\nThe pseudo code in function wzr_decrypt_config in both samples is the same, which\ninvolves extracting the RC4 Key and Encrypted data, and then using RC4 to decrypt the\nconfiguration. The difference lies in function wzr_perform_rc4.\n\nThe function wzr_perform_rc4 in sample 1 uses standard RC4 to decrypt the configuration.\nIts pseudocode is shown below:\n\n\n-----\n\nThus, we can easily use CyberChef to perform configuration decoding or write a Python\nscript to automate for similar samples.\n\nThe pseudocode for function wzr_perform_rc4 in sample 2 as shown below. Prior to\ndecryption, it allocates an array of 250 bytes, filled with zero values. Then, it copies the\nextracted rc4_key into this array. Finally, it calls the wzr_rc4_crypt function, which uses\nthe modified RC4 algorithm to decrypt the configuration.\n\nThe complete pseudocode of the wzr_rc4_crypt function is as follows:\n\n\n-----\n\n```\nvoid __thiscall wzr_rc4_crypt(wzr_rc4_data rc4_info, _BYTE data)\n\n{\n\n idx = 0;\n\n if ( rc4_info->rc4Sbox )\n\n {\n\n  if ( rc4_info->rc4_key_250b )\n\n  {\n\n   rc4_info->counter2 = 0;\n\n   LOBYTE(i) = 0;\n\n   rc4_info->counter1 = 0;\n\n   do\n\n   {\n\n    rc4_info->rc4Sbox[i] = rc4_info->counter1;\n\n    i = rc4_info->counter1 + 1;\n\n    rc4_info->counter1 = i;\n\n   }\n\n   while ( i < 256 );\n\n   rc4_info->counter1 = 0;\n\n   for ( i = 0; i < 256; rc4_info->counter1 = i )\n\n   {\n\n    rc4Sbox = rc4_info->rc4Sbox;\n\n    rc4_info->counter2 += rc4Sbox[i] + rc4_info->rc4_key_250b[i % 250];\n\n    rc4Sbox[i] ^= rc4Sbox[rc4_info->counter2];\n\n    // swap values\n\n    rc4_info->rc4Sbox[LOBYTE(rc4_info->counter2)] ^= rc4_info>rc4Sbox[LOBYTE(rc4_info->counter1)];\n\n    rc4_info->rc4Sbox[LOBYTE(rc4_info->counter1)] ^= rc4_info>rc4Sbox[LOBYTE(rc4_info->counter2)];\n\n    i = rc4_info->counter1 + 1;\n\n   }\n\n   rc4_info->counter1 = 0;\n\n   rc4_info->counter2 = 0;\n\n   // Decrypt data\n\n   if ( rc4_info->data_length )\n\n   {\n\n    j = 0;\n\n    do\n\n    {\n\n     rc4_info->counter1 = j + 1;\n\n     rc4Sbox = rc4_info->rc4Sbox;\n\n     k = (j + 1);\n\n     rc4Sbox_value1 = rc4Sbox[k];\n\n     rc4_info->counter2 += rc4Sbox_value1;\n\n     rc4Sbox_value1_ = rc4Sbox_value1;\n\n     rc4Sbox_value2 = rc4Sbox[rc4_info->counter2];\n\n     rc4Sbox[k] = rc4Sbox_value2;\n\n     rc4_info->rc4Sbox[LOBYTE(rc4_info->counter2)] = rc4Sbox_value1;\n\n     rc4Sbox_ = rc4_info->rc4Sbox;\n\n     data[idx] ^= rc4Sbox_[(rc4_info->counter2 + rc4Sbox_value2)] ^\n(rc4Sbox_[(rc4Sbox_value2 + rc4Sbox_value1_)]\n\n```\n\n-----\n\n```\n                                    +\nrc4Sbox_[(rc4Sbox_[((0x20 * rc4_info->counter2) ^ (rc4_info->counter1 >> 3))]\n\n                                         +\nrc4Sbox_[((0x20 * rc4_info->counter1) ^ (rc4_info->counter2 >> 3))]) ^ 0xAA]);\n\n     j = ++rc4_info->counter1;\n\n     ++idx;\n\n    }\n\n    while ( idx < rc4_info->data_length );\n\n   }\n\n  }\n\n }\n\n}\n\n```\nWith the pseudocode above, we can rewrite the decoding code in Python as follows. This is\nthe code I wrote, and you can write it in your own way as long as it performs the task\ncorrectly.\n\n\n-----\n\n```\n# Refs: https://stackoverflow.com/questions/9433541/movsx in python\n\ndef SIGNEXT(x, b):\n\n  m = (1 << (b -1))\n\n  x = x & ((1 << b) -1)\n\n  return ((x ^ m) - m)\n\n# This routine is responsible for decrypting the stored C2.\n\ndef rc4_customized_decryptor(data, key):\n\n  idx = 0\n\n  counter1 = 0\n\n  counter2 = 0\n\n  # Initialize RC4 S-box\n\n  rc4Sbox = list(range(256))\n\n  # Modify RC4 S-box\n\n  for i in range(256):\n\n    counter2 += (rc4Sbox[i] + key[i%250])\n\n    counter2 = counter2 & 0x000000FF\n\n    rc4Sbox[i] ^= rc4Sbox[counter2]\n\n    rc4Sbox[counter2 & 0xFF] ^= rc4Sbox[counter1 & 0xFF]\n\n    rc4Sbox[counter1 & 0xFF] ^= rc4Sbox[counter2 & 0xFF]\n\n    counter1 = i+1    \n\n  # Decrypt data\n\n  counter1 = 0\n\n  counter2 = 0\n\n  j = 0\n\n  decrypted = []\n\n  while(idx < len(data)):\n\n    counter1 = j + 1\n\n    k = (j+1)\n\n    rc4Sbox_value1 = rc4Sbox[k]\n\n    counter2 += (SIGNEXT(rc4Sbox_value1, 8) & 0xFFFFFFFF)\n\n    rc4Sbox_value1_ = (SIGNEXT(rc4Sbox_value1, 8) & 0xFFFFFFFF)\n\n    rc4Sbox_value2 = rc4Sbox[counter2 & 0x000000FF]\n\n    rc4Sbox[k] = rc4Sbox_value2\n\n    rc4Sbox[(counter2 & 0x000000FF)] = rc4Sbox_value1\n\n    tmp1 = rc4Sbox[((0x20 * counter1) ^ (counter2 >> 3)) & 0x000000FF]\n\n    tmp2 = rc4Sbox[((0x20 * counter2) ^ (counter1 >> 3)) & 0x000000FF]\n\n    tmp3 = rc4Sbox[((tmp1 + tmp2) & 0x000000FF) ^ 0xAA]\n\n    tmp4 = rc4Sbox[(rc4Sbox_value2 + rc4Sbox_value1_) & 0x000000FF]\n\n    tmp5 = (tmp3 + tmp4) & 0x000000FF\n\n    tmp6 = rc4Sbox[(counter2 + rc4Sbox_value2) & 0x000000FF]\n\n    decrypted.append(data[idx] ^ (tmp5 ^ tmp6))\n\n    counter1 += 1\n\n    j = counter1\n\n    idx += 1\n\n  return bytes(decrypted)\n\n```\n\n-----\n\nBelow are the results of using a Python script to extract the configuration of Warzone RAT\nfrom the samples used in the article.\n\n**3. End**\n\nThe article would like to conclude here. I hope that it provides useful information for you\nduring the process of analyzing the Warzone RAT malware. To protect against Warzone RAT\nand other types of malware, users should take precautions such as being cautious when\nopening email attachments, using strong passwords, and keeping their software up to date. It\nis also important to use antivirus software and to keep it updated regularly. By taking these\nsteps, users can help to protect themselves against the threat of Warzone RAT and other\ntypes of malware.\n\n**4. Refs**\n\nhttps://research.openanalysis.net/warzone/malware/config/2021/05/31/warzone_rat_config.ht\nml\n\n[https://exploitreversing.files.wordpress.com/2022/11/mas_6-1.pdf](https://exploitreversing.files.wordpress.com/2022/11/mas_6-1.pdf)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-25 - [QuickNote] Decrypting the C2 configuration of Warzone RAT.pdf"
    ],
    "report_names": [
        "2023-03-25 - [QuickNote] Decrypting the C2 configuration of Warzone RAT.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1680660594,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1680512049,
    "ts_modification_date": 1680512049,
    "files": {
        "pdf": "https://archive.orkl.eu/30b1f84e912c488faed2562dce6c102bd708142b.pdf",
        "text": "https://archive.orkl.eu/30b1f84e912c488faed2562dce6c102bd708142b.txt",
        "img": "https://archive.orkl.eu/30b1f84e912c488faed2562dce6c102bd708142b.jpg"
    }
}