{
    "id": "e93d14fb-92c8-4356-bf91-5cf7a8c4463d",
    "created_at": "2023-01-12T15:06:06.89582Z",
    "updated_at": "2025-03-27T02:09:18.134972Z",
    "deleted_at": null,
    "sha1_hash": "376251d54cd62452b4a0cd1b493b49df72fc9a35",
    "title": "2021-03-12 - IcedID GZIPLOADER Analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T17:48:30Z",
    "file_modification_date": "2022-05-28T17:48:30Z",
    "file_size": 1887368,
    "plain_text": "# IcedID GZIPLOADER Analysis\n\n**binarydefense.com/icedid-gziploader-analysis/**\n\nMarch 12, 2021\n\nIn late February, while tracking a malicious spam campaign from the Qakbot distributor “TR,”\nBinary Defense’s analysts identified a new version of IcedID being delivered through\nmalicious Word and Excel files. The updated IcedID has a new first stage loading\nmechanism, which we’ve dubbed “gziploader,” along with new encryption algorithms for\nhiding its configuration and embedded strings. After reverse-engineering the inner workings\nof the malware, the Binary Defense Threat Hunting team allowed it to run in a laboratory\nActive Directory environment, set up to look like a small business, and observed that after\nonly a few hours of running, threat actors used the access provided by IcedID to deploy\nCobalt Strike beacons and downloaded tools to explore and profile the network environment.\nThe IcedID infection was long-lived and exhibited several recognizable patterns of behaviors\nover time, allowing analysts to identify some post-infection detection opportunities that were\nimplemented as alerts for security operations analysts.\n\nIn addition to this analysis, Binary Defense’s analysts are also releasing a software tool to\ndecrypt the new IcedID gziploader payloads, along with the .dat logfile. The tool can also be\nused to attempt to extract the Command and Control (C2) configuration stored in nongziploader IcedID payloads.\n\nView the decryption tool on the Binary Defense GitHub\nhere: [https://github.com/BinaryDefense/IcedDecrypt](https://github.com/BinaryDefense/IcedDecrypt)\n\n\n-----\n\n_Fig 1.1, IcedID’s gziploader infection chain_\n\n## IcedID Background\n\nIcedID is a sophisticated banking trojan that makes use of memory-only payloads along with\nbrowser hooking to steal banking credentials and other PII. While typically spread through\nmalspam, IcedID has also been seen loaded by Emotet (when it was still live) and even has\nits own Trickbot module. Additionally, with cert pinning capabilities, multiple stages, and\nseveral analysis environment checks, IcedID is a formidable threat that makes analysis\ncomplex and challenging.\n\n**Arrival on System: TR Infrastructure**\n\nThe IcedID covered in this analysis was found by Binary Defense’s analysts while tracking\nQakbot’s “TR” malspam distribution infrastructure. “TR” is the group tag given by Qakbot to\ndesignate a particular malspam distribution affiliate. After identifying the infrastructure used\nby this actor, Binary Defense has also witnessed this actor distributing other malware\nincluding Gozi/isfb, Smokeloader, ZLoader, and most recently, this IcedID campaign.\n\nArriving on the system as a hijacked reply chain email with an Excel XLS file attachment, the\nlure was a standard fake DocuSign message that has been used frequently in many\nmalicious documents and spreadsheets (as seen in Fig 1.2)\n\n\n-----\n\n_Fig 1.2_ _Malicious XLS Sheet, with instructions on how to open the malsheet and enable_\n_macros._\nOnce macros are enabled, the malsheet connects out to an embedded URL, attempts to\ndownload a file, and then tries to open that downloaded file with rundll32.exe and the\ncommand line parameter “DllRegisterServer”. Binary Defense’s analysts have also seen the\nTR infrastructure loading DLLs with regsvr32.exe.\n\n_Detection Opportunity: Watch for regsvr32.exe or rundll32.exe (or any other program)_\n_spawned from Office programs such as Excel and Word_\n\n## IcedID Stage1: “Gziploader”\n\nThe first stage of the IcedID infection chain is in charge of performing the initial host\nenumeration calls, as well as requesting and loading the IcedID payload masquerading as a\ngzip file. In addition to host enumeration that gathers CPU type, OS type, and username, the\nmalware also connects out to a benign URL, like aws.amazon[.]com, which it then collects\nand stores the web server response in the typical IcedID headers (__gads, _gat, etc), then\nsends them on to the C2 in the HTTP cookie header when it requests the fake gzip payload\n(as seen in figure 2.1)\n\n_Fig 2.1, Shows the get request and resulting gzip-masquerading payload (with \\x1f\\x8B_\n_header)_\n\n\n-----\n\nWhile the gziploader payloads appear to be valid gzip files, uncompressing them fails, as the\ndata following the header is actually the encrypted IcedID payload, which will be decrypted\nand loaded by the gziploader stage one decryption algorithm.\n\n## Gziploader Algorithm\n\nThe algorithm used by gziploader to decrypt the IcedID payload is actually fairly simple, at\nleast compared to the past photoloader algorithm that was used in the last version of IcedID.\nTo summarize the algorithm in plain English, the malware first copies the 10-byte gziploader\nheader into memory, which it checks and discards. It then reads the .msi string (e.g.\n“update_3059128432.msi” into memory, stopping at \\x00. It saves the length of this string,\nand then reads the rest of the data starting from the end of the .msi string into memory. This\nis the encrypted data, which is decrypted using a custom algorithm and a 16-byte key stored\ntoward the end of the buffer of data. The exact offset of the key depends on a hardcoded\ninteger along with the length of the .msi string.\n\nHowever, as this buffer is fairly large, and the hardcoded integer seems to change, Binary\nDefense’s analysts have developed a rapid bruteforce method to find the 16-byte key used to\ndecrypt the IcedID payload. This method has been used in the released software tool.\n\n## Gziploader Payload Layout\n\nOnce decrypted, the malware reads the first 0xA9 bytes of the decrypted buffer into memory,\nwhich contains the license.dat file size, the IcedID loader file size, the license.dat\n%appdata% directory path, the IcedID payload execution parameters, the license.dat file\ndata, and the IcedID loader file data (a standard DLL, dropped to the %localappdata%\ndirectory). As seen in figure 2.2, the config format is as follows:\n\n\n-----\n\n```\nStruct gziploader_payload_config {\nByte Flag;\nDword sizeOfDatfile;\nDword sizeOfDllFile;\nCstr DatFileDir;\nBuffer[0x14] Reserved;\nCstr DatFileName;\nBuffer[0x13] Reserved;\nCstr DllFileName;\nBuffer[0x12] Reserved;\nCstr DllExecutionStr;\nBuffer[0x1F] Reserved;\n}\n\n```\n_Fig 2.2, Gziploader decrypted payload config_\nWith all necessary payload config data acquired, the malware then drops the license.dat file\ninto the current user’s Appdata\\Roaming\\<directory in DatFileDir>\\ folder, drops the IcedID\nmain loader into Appdata\\Local\\, and then launches it with the specified DllExecutionStr,\nreplacing the final “%s” with the path to the license.dat file. It then terminates the gziploader\nprocess, passing the loading responsibility on to the newly executed IcedID main loader.\n\n_Detection Opportunity: Watch for file write events where the file name is license.dat,_\n_the folder is in a subfolder under AppData\\Roaming, and then followed by a process_\n_start event for rundll32 with a command line argument including license.dat_\n\n## IcedID Stage 2: The Main Loader\n\nIcedID’s main loader is a fairly massive binary, coming in at 5.1MB. Despite the large size,\nthe functionality of the main loader is very simple and essentially just locates the\n“license.dat”, containing the main IcedID bot, decrypts the file, and then loads the partial PE\nmemory segments into memory, similar to the prior version IcedID photoloader memory\nloading.\n\nIncluded in the software tool release, the bulk IcedID decryption script will automatically\nidentify .dat files and attempt to decrypt using the same custom encryption algorithm used by\nthe gziploader portion. However, the 16-byte key is stored as the last 16 bytes of the\nlicense.dat file, unlike with the gziploader portion. After decrypting, the segments are\nassembled by the script into a DLL that can at least be opened in a disassembler like IDA\nPro or Ghidra.\n\n## IcedID Payload Structure Layout\n\n\n-----\n\nWhile the new decrypted IcedID license.dat payload is loaded into memory the same way as\nold IcedID, the payload structure has changed a bit. Now, 0x81 garbage bytes of data are\nprepended to the decrypted buffer, which gets discarded by the malware. The structure of\nthe payload “config” is as follows:\n```\nStruct payload_segment_config {\nQword ImageBase;\nDword ImageVirtualSize;\nDword ImageEntryPoint;\nDword Import Table Offset;\nDword Import table Virtual Offset;\nDword Import Table Size;\n}\n\n```\nAdditionally, the structure layout for each individual segment is unchanged from the older\nversions of IcedID.\n\n## IcedID Stage 3: The Main Bot\n\nLoaded into the memory space of rundll32.exe by the main loader, the assembled DLL\nstored inside of the dropped license.dat serves as the main bot for the IcedID infection. This\nDLL is in charge of credential theft, along with host enumeration and DLL injection (for\nbrowser hooking). While the addition of gziploader was a new change, the main bot is fairly\nunchanged from the IcedID version analyzed by Group-IB. We highly recommend reading\n[Group-IB’s analysis to understand the alive/hooker/bc modules and their interactions;](https://www.group-ib.com/blog/IcedID)\nhowever, some new commands have been added for post-exploitation activity.\n\n## Main Bot Commands: Exec/ExecAdmin\n\nWhile the Exec/ExecAdmin commands are not new by any sense, they have received some\nupdates that flesh out their functionality a bit. Exec and ExecAdmin are two commands used\nby IcedID to execute more malware/tools during post-infection. As the names would indicate,\nExec executes files using the user’s current permissions level. ExecAdmin, however, will\nescalate privileges using either the fodhelper or eventvwr bypass (whichever is successful),\nand execute files as a local administrator.\n\nExec and ExecAdmin are divided into five different “subcommands” (each with optional\noutput saving), which allow IcedID to:\n\n**1.   Execute .exe files without a command line**\n\nUses a pipe to read from stdout if output saving is specified\n\n**2.   Execute .exe files with a command line**\n\nExe is temporarily saved to %temp%; however, if that does not exist, C:\\ProgramData\\\nis used\n\n\n-----\n\nFilename is a random alphanumeric string ending with .exe\nExe is deleted following execution\n\nDetection Opportunity: Watch for a file write of an exe file to a temporary directory, followed\nsoon after by a process creation event executing that file, and then by a file delete event of\nthe same file.\n\n**3.   Execute .DLL files using “regsvr32.exe /s”**\n\nDLL must have DllRegisterServer as an export\nDLL is saved to same temp path as exe, and is deleted on execution\n\nDetection Opportunity: Watch for file writes to a temporary directory, followed soon after by a\nregsvr32 process referencing the same filename as a command line argument, and then by\na file delete event of the same file.\n\n**4.   Execute PowerShell script**\n\nPowerShell script is temporarily saved to %temp% or ProgramData as a .txt file\nScript is then executed with “powershell -windowstyle hidden -c “$a=\n\n_[IO.File]::ReadAllText(“””%s”””); iex $a; exit;”_\n\nDetection Opportunity: Watch for PowerShell processes with the command line argument\ncontaining “ReadAllText(“*”);iex”, where * is a text file in the %temp% directory.\n\n**_5.   Execute shellcode in memory_**\n\nSpawns cmd.exe from C:\\Windows\\SysWOW64\\, with no command line.\nInjects into cmd.exe using the NtVirtualAllocate -> ZwWriteVirtualMemory ->\nNtProtectVirtualMemroy -> CreateRemoteThread chain.\n\n_Detection Opportunity: Watch for CreateRemoteThread targeting cmd.exe processes_\n\n## Main Bot Commands: Steal Credentials\n\nOne of IcedID’s key functions is the ability to steal user credentials stored on the victim’s\nsystem. This functionality is triggered by a command and seeks to steal creds/account info\nfrom:\n\nCred vault, using CredEnumerateW\nOutlook Profiles, using the WindowsMessagingSubsystem\\Profiles or Outlook\\Profiles\nto do so\nInternet Explorer browser history and saved passwords\nInternet Explorer password from CredVault\nEmail Credentials from CredVault\n\n\n-----\n\nChrome autofill\n\nThis includes passwords, phone numbers, card information and more\nFirefox Autofill\n\nDownloads sqlite3.dll to manipulate both chrome and firefox data\n\n## Main Bot Commands: Steal Cookies\n\nAnother important functionality for IcedID is its ability to steal cookies for some of the popular\nbrowsers, like Chrome, Firefox, and Edge, each with their own IOCc[KJ1] .\n\nIE/Edge Theft:\n\nStolen cookies are saved to a file called IE/%u.txt and EDGE/%u.txt (where %u is\nreplaced by an unsigned integer)\nLocates the cookie storage, extracting to the files above.\n\nFirefox Theft:\n\nSaved to a Firefox/cookies-%u.txt\n\nChrome Theft:\n\nSaved to cookies.txt\n\n**Main Bot Commands: SysInfo**\n\nA command that’s pretty typical for malware these days: IcedIDs sysinfo command\nenumerates important information about the host, like installed AV or process list.\nAdditionally, IcedID runs the following commands and sends the output back to its C2 (as\nseen in fig 3.1):\n\n“cmd.exe /c chcp > &2”\n\nEnumerates the bot’s code page\n“net view /all”\n“ipconfig /all”\n“net group “Domain Admins” /domain”\n“systeminfo”\n“net view /all /domain”\n“nltest /domain_trusts /all_trusts”\n“nltest /domain_trusts”\n“net config workstation”\n\n_Detection Opportunity: Determine which of the commands above are rare events in_\n_your environment and look for any instance of those rare commands_\n\n\n-----\n\n_Fig 3.1 Shows the commands executed by IcedID in Binary Defense’s Lab Domain_\n_Environment_\n\n## Main Bot’s Command Chain\n\nDuring multiple IcedID infections, both in a debugger and as a live analysis, Binary Defense’s\nanalysts observed a fairly aggressive post-infection chain from IcedID.\n\nUpon initial check-in with the main bot C2, the C2 first issued the “StealCreds” command,\ninstead of sysinfo like most malware campaigns. Next, the C2 issued the “StealCookies”\ncommand in order to steal all browser cookies for the bot. After that, the C2 finally issued the\nsysinfo command, followed by the proclist command. From there, the C2 then issued an\ninteresting command called “ListDesktopFiles”, which uses the IShellLinkW COM objects\nand Windows API calls to get a list of all desktop files, and resolve any .lnk files. Finally, the\nC2 issued the “Update_Config” command, which updated the bot’s in-memory C2 config,\nand connected it to the C2.\n\n\n-----\n\nThis command chain appeared to be automatically executed immediately by the C2,\nmeaning most bots that properly connect to the C2 will most likely receive these commands,\nin this order.\n\n**Review**\n\nIn this analysis, we have covered the updates to IcedID’s loading mechanism, including the\nnew gziploader that replaces photoloader. Additionally, we are releasing a script with this\nanalysis that can be used to decrypt and assemble the license.dat, decrypt the gziploader\npayloads, and also attempt to extract any C2 config information from the IcedID binaries.\n\n**IOCs/Appendix**\n\nXLS IOCs:\n\nLook for DocuSign instructional XLS sheet templates, (the instructions for enabling\nmacros will be in the sheet)\nLook for excel spawning either rundll32.exe with the command line containing\n“DllRegisterServer” or excel spawning regsvr32.exe with the command line containing\n“/s” or “-s”.\n\nGziploader IOCs:\n\nLook for filewrites to Appdata\\Roaming\\*\\license.dat\nLook for http traffic receiving large gzip payloads after making a request to the root dir\nof a url.\nLook for http traffic with the standard IcedID headers in cookies:\n\n__gads\n_gat\n_ga\n_u\n__io\n_gid\nLook for rundll32.exe executing a newly dropped dll with “/i” in the command line\n\nMain Bot IOCs:\n\n\n-----\n\nLook for any of the commands executed by sysinfo\n\n“cmd.exe /c chcp > &2”\n“net view /all”\n“ipconfig /all”\n“net group “Domain Admins” /domain”\n“systeminfo”\n“net view /all /domain”\n“nltest /domain_trusts /all_trusts”\n“nltest /domain_trusts”\n“net config workstation”\n\nLook for modifications to “AppData\\Roaming\\Microsoft\\Crypto\\RSA” originating from\nrundll32.exe\n\nLook for createremotethread events originating from rundll32.exe targeting firefox.exe\nand chrome.exe\n\nLook for Registry Run key modifications containing “/i” in the command line.\n\nICEDID/Cobalt Strike related C2s:\n\nfekiop3.space\nberxion9.online\nprolomstenn.fun\nderegojikulo.uno\nwellernaft.top\nawerityubfer.club\n31.14.41.212 – Cobalt Strike C2\nupdate.webguardsecurity.xyz – Cobalt Strike C2\n\nReferences:\n\n[https://www.group-ib.com/blog/icedid](https://www.group-ib.com/blog/icedid)\n[blog.malwarebytes.com](http://blog.malwarebytes.com/)\nIcedID Decryption Tool: [https://github.com/BinaryDefense/IcedDecrypt](https://github.com/BinaryDefense/IcedDecrypt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-12 - IcedID GZIPLOADER Analysis.pdf"
    ],
    "report_names": [
        "2021-03-12 - IcedID GZIPLOADER Analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535966,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653760110,
    "ts_modification_date": 1653760110,
    "files": {
        "pdf": "https://archive.orkl.eu/376251d54cd62452b4a0cd1b493b49df72fc9a35.pdf",
        "text": "https://archive.orkl.eu/376251d54cd62452b4a0cd1b493b49df72fc9a35.txt",
        "img": "https://archive.orkl.eu/376251d54cd62452b4a0cd1b493b49df72fc9a35.jpg"
    }
}