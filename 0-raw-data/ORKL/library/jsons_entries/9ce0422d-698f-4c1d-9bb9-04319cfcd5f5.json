{
    "id": "9ce0422d-698f-4c1d-9bb9-04319cfcd5f5",
    "created_at": "2023-01-12T14:59:28.992412Z",
    "updated_at": "2025-03-27T02:13:33.707908Z",
    "deleted_at": null,
    "sha1_hash": "7b21ed4314e6a1392f7606c60356c9e3f8b9b7d4",
    "title": "2022-07-19 - I see what you did there- A look at the CloudMensis macOS spyware",
    "authors": "",
    "file_creation_date": "2022-08-18T03:22:44Z",
    "file_modification_date": "2022-08-18T03:22:44Z",
    "file_size": 2116898,
    "plain_text": "# I see what you did there: A look at the CloudMensis macOS spyware\n\n**[welivesecurity.com/2022/07/19/i-see-what-you-did-there-look-cloudmensis-macos-spyware/](https://www.welivesecurity.com/2022/07/19/i-see-what-you-did-there-look-cloudmensis-macos-spyware/)**\n\nJuly 19, 2022\n\nPreviously unknown macOS malware uses cloud storage as its C&C channel and to exfiltrate documents,\nkeystrokes, and screen captures from compromised Macs\n\n[Marc-Etienne M.Léveillé](https://www.welivesecurity.com/author/marc-etienne/)\n19 Jul 2022 - 11:30AM\n\nPreviously unknown macOS malware uses cloud storage as its C&C channel and to exfiltrate documents,\nkeystrokes, and screen captures from compromised Macs\n\nIn April 2022, ESET researchers discovered a previously unknown macOS backdoor that spies on users of\nthe compromised Mac and exclusively uses public cloud storage services to communicate back and forth\nwith its operators. Following analysis, we named it CloudMensis. Its capabilities clearly show that the intent\nof its operators is to gather information from the victims’ Macs by exfiltrating documents, keystrokes, and\nscreen captures.\n\n\n-----\n\nApple has recently acknowledged the presence of spyware targeting users of its products and is previewing\nLockdown Mode on iOS, iPadOS and macOS, which disables features frequently exploited to gain code\nexecution and deploy malware. Although not the most advanced malware, CloudMensis may be one of the\nreasons some users would want to enable this additional defense. Disabling entry points, at the expense of a\nless fluid user experience, sounds like a reasonable way to reduce the attack surface.\n\nThis blogpost describes the different components of CloudMensis and their inner workings.\n\n## CloudMensis overview\n\nCloudMensis is malware for macOS developed in Objective-C. Samples we analyzed are compiled for both\nIntel and Apple silicon architectures. We still do not know how victims are initially compromised by this threat.\nHowever, we understand that when code execution and administrative privileges are gained, what follows is\na two-stage process (see Figure 1), where the first stage downloads and executes the more featureful\nsecond stage. Interestingly, this first-stage malware retrieves its next stage from a cloud storage provider. It\ndoesn’t use a publicly accessible link; it includes an access token to download the MyExecute file from the\n[drive. In the sample we analyzed, pCloud was used to store and deliver the second stage.](https://www.pcloud.com/)\n\n_Figure 1. Outline of how CloudMensis uses cloud storage services_\n\nArtifacts left in both components suggest they are called execute and Client by their authors, the former\nbeing the downloader and the latter the spy agent. Those names are found both in the objects’ absolute\npaths and ad hoc signatures.\n\n\n-----\n\n_Figure 2. Partial strings and code signature from the downloader component, execute_\n\n_Figure 3. Partial strings and code signature from the spy agent component, Client_\n\nFigures 2 and 3 also show what appear to be internal names of the components of this malware: the project\nseems to be called BaD and interestingly resides in a subdirectory named LeonWork. Further, v29 suggests\nthis sample is version 29, or perhaps 2.9. This version number is also found in the configuration filename.\n\n\n-----\n\n## The downloader component\n\nThe first-stage malware downloads and installs the second-stage malware as a system-wide daemon. As\nseen in Figure 4, two files are written to disk:\n\n1. /Library/WebServer/share/httpd/manual/WindowServer: the second-stage Mach-O executable, obtained\n\nfrom the pCloud drive\n2. /Library/LaunchDaemons/.com.apple.WindowServer.plist: a property list file to make the malware\n\npersist as a system-wide daemon\n\nAt this stage, the attackers must already have administrative privileges because both directories can only be\nmodified by the root user.\n\n_Figure 4. CloudMensis downloader installing the second stage_\n\n### Cleaning up after usage of a Safari exploit\n\nThe first-stage component includes an interesting method called removeRegistration that seems to be\npresent to clean up after a successful Safari sandbox escape exploit. A first glance at this method is a bit\npuzzling considering that the things it does seem unrelated: it deletes a file called root from the EFI system\npartition (Figure 5), sends an XPC message to speechsynthesisd (Figure 6), and deletes files from the Safari\ncache directory. We initially thought the purpose of removeRegistration was to uninstall previous versions of\nCloudMensis, but further research showed that these files are used to launch sandbox and privilege\nescalation exploits from Safari while abusing four vulnerabilities. These vulnerabilities were discovered and\n[well documented by Niklas Baumstark and Samuel Groß in 2017. All four were patched by Apple the same](https://phoenhex.re/2017-07-06/pwn2own-sandbox-escape)\nyear, so this distribution technique is probably not used to install CloudMensis anymore. This could explain\nwhy this code is no longer called. It also suggests that CloudMensis may have been around for many years.\n\n_Figure 5. Decompiled code showing CloudMensis mounting the EFI partition_\n\n\n-----\n\n_Figure 6. Sending an XPC message to speechsynthesisd_\n\n## The spy agent component\n\nThe second stage of CloudMensis is a much larger component, packed with a number of features to collect\ninformation from the compromised Mac. The intention of the attackers here is clearly to exfiltrate documents,\nscreenshots, email attachments, and other sensitive data.\n\nCloudMensis uses cloud storage both for receiving commands from its operators and for exfiltrating files. It\nsupports three different providers: pCloud, Yandex Disk, and Dropbox. The configuration included in the\nanalyzed sample contains authentication tokens for pCloud and Yandex Disk.\n\n### Configuration\n\nOne of the first things the CloudMensis spy agent does is load its configuration. This is a binary structure that\nis 14,972 bytes long. It is stored on disk at ~/Library/Preferences/com.apple.iTunesInfo29.plist, encrypted\nusing a simple XOR with a generated key (see the Custom encryption section).\n\nIf this file does not already exist, the configuration is populated with default values hardcoded in the malware\nsample. Additionally, it also tries to import values from what seem to be previous versions of the CloudMensis\nconfiguration at:\n\n~/Library/Preferences/com.apple.iTunesInfo28.plist\n~/Library/Preferences/com.apple.iTunesInfo.plist\n\nThe configuration contains the following:\n\nWhich cloud storage providers to use and authentication tokens\nA randomly generated bot identifier\nInformation about the Mac\nPaths to various directories used by CloudMensis\nFile extensions that are of interest to the operators\n\nThe default list of file extensions found in the analyzed sample, pictured in Figure 7, shows that operators are\ninterested in documents, spreadsheets, audio recordings, pictures, and email messages from the victims’\nMacs. The most uncommon format is perhaps audio recordings using the Adaptive Multi-Rate codec (using\nthe .amr and .3ga extensions), which is specifically designed for speech compression. Other interesting file\n[extensions in this list are .hwp and .hwpx files, which are documents for Hangul Office (now Hancom Office),](https://office.hancom.com/)\na popular word processor among Korean speakers.\n\n\n-----\n\n_Figure 7. File extensions found in the default configuration of CloudMensis_\n\n### Custom encryption\n\nCloudMensis implements its own encryption function that its authors call FlowEncrypt. Figure 8 shows the\ndisassembled function. It takes a single byte as a seed and generates the rest of the key by performing a\nseries of operations on the most recently generated byte. The input is XORed with this keystream. Ultimately\nthe current byte’s value will be the same as one of its previous values, so the keystream will loop. This\nmeans that even though the cipher seems complex, it can be simplified to an XOR with a static key (except\nfor the first few bytes of the keystream, before it starts looping).\n\n_Figure 8. Disassembled FlowEncrypt method_\n\n### Bypassing TCC\n\nSince the release of macOS Mojave (10.14) in 2018, access to some sensitive inputs, such as screen\ncaptures, cameras, microphones and keyboard events, are protected by a system called TCC, which stands\nfor Transparency, Consent, and Control. When an application tries to access certain functions, macOS\n\n\n-----\n\nprompts the user whether the request from the application is legitimate, who can grant or refuse access.\nUltimately, TCC rules are saved into a database on the Mac. This database is protected by System Integrity\nProtection (SIP) to ensure that only the TCC daemon can make any changes.\n\nCloudMensis uses two techniques to bypass TCC (thus avoiding prompting the user), thereby gaining access\nto the screen, being able to scan removable storage for documents of interest, and being able to log\nkeyboard events. If SIP is disabled, the TCC database (TCC.db) is no longer protected against tampering.\nThus, in this case CloudMensis add entries to grant itself permissions before using sensitive inputs. If SIP is\nenabled but the Mac is running any version of macOS Catalina earlier than 10.15.6, CloudMensis will exploit\na vulnerability to make the TCC daemon (tccd) load a database CloudMensis can write to. This vulnerability\nis known as [CVE-2020–9934 and was reported and described by Matt Shockley in 2020.](https://nvd.nist.gov/vuln/detail/CVE-2020-9934)\n\nThe exploit first creates a new database under ~/Library/Application\nSupport/com.apple.spotlight/Library/Application Support/com.apple.TCC/ unless it was already created, as\nshown in Figure 9.\n\n_Figure 9. Checking it the illegitimate TCC database file already exists_\n\nThen, it sets the HOME environment variable to ~/Library/Application Support/com.apple.spotlight using\nlaunchctl setenv, so that the TCC daemon loads the alternate database instead of the legitimate one. Figure\n10 shows how it is done using NSTask.\n\n_Figure 10. Mangling the HOME environment variable used by launchd with launchctl and restarting tccd_\n\n### Communication with the C&C server\n\n\n-----\n\nTo communicate back and forth with its operators, the CloudMensis configuration contains authentication\ntokens to multiple cloud service providers. Each entry in the configuration is used for a different purpose. All\nof them can use any provider supported by CloudMensis. In the analyzed sample, Dropbox, pCloud, and\nYandex Disk are supported.\n\nThe first store, called CloudCmd by the malware authors according to the global variable name, is used to\nhold commands transmitted to bots and their results. Another, which they call CloudData, is used to exfiltrate\ninformation from the compromised Mac. A third one, which they call CloudShell, is used for storing shell\ncommand output. However, this last one uses the same settings as CloudCmd.\n\nBefore it tries fetching remote files, CloudMensis first uploads an RSA-encrypted report about the\ncompromised Mac to /January/ on CloudCmd. This report includes shared secrets such as a bot identifier\nand a password to decrypt to-be-exfiltrated data.\n\nThen, to receive commands, CloudMensis fetches files under the following directory in the CloudCmd\nstorage: /Febrary/<bot_id>/May/. Each file is downloaded, decrypted, and dispatched to the\nAnalizeCMDFileName method. Notice how both February and Analyze are spelled incorrectly by the\nmalware authors.\n\nThe CloudData storage is used to upload larger files requested by the operators. Before the upload, most\nfiles are added to a password-protected ZIP archive. Generated when CloudMensis is first launched, the\npassword is kept in the configuration, and transferred to the operators in the initial report.\n\n### Commands\n\nThere are 39 commands implemented in the analyzed CloudMensis sample. They are identified by a number\nbetween 49 and 93 inclusive, excluding 57, 78, 87, and 90 to 92. Some commands require additional\narguments. Commands allow the operators to perform actions such as:\n\nChange values in the CloudMensis configuration: cloud storage providers and authentication tokens,\nfile extensions deemed interesting, polling frequency of cloud storage, etc.\nList running processes\nStart a screen capture\nList email messages and attachments\nList files from removable storage\nRun shell commands and upload output to cloud storage\nDownload and execute arbitrary files\n\nFigure 11 shows command with identifier 84, which lists all jobs loaded by launchd and uploads the results\nnow or later, depending on the value of its argument.\n\n\n-----\n\n_Figure 11. Command 84 runs launchctl list to get launchd jobs_\n\nFigure 12 shows a more complex example. Command with identifier 60 is used to launch a screen capture. If\nthe first argument is 1, the second argument is a URL to a file that will be downloaded, stored, and executed\nby startScreenCapture. This external executable file will be saved as windowserver in the Library folder of\nFaceTime’s sandbox container. If the first argument is zero, it will launch the existing file previously dropped.\nWe could not find samples of this screen capture agent.\n\n\n-----\n\n_Figure 12. Command 60: Start a screen capture_\n\nIt’s interesting to note that property list files to make launchd start new processes, such as\ncom.apple.windowServer.plist, are not persistent: they are deleted from disk after they are loaded by\nlaunchd.\n\n## Metadata from cloud storage\n\nMetadata from the cloud storages used by CloudMensis reveals interesting details about the operation.\nFigure 13 shows the tree view of the storage used by CloudMensis to send the initial report and to transmit\ncommands to the bots as of April 22nd, 2022.\n\n\n-----\n\n_Figure 13. Tree view of the directory listing from the CloudCmd storage_\n\nThis metadata gave partial insight into the operation and helped draw a timeline. First, the pCloud accounts\nwere created on January 19, 2022. The directory listing from April 22th nd shows that 51 unique bot identifiers\ncreated subdirectories in the cloud storage to receive commands. Because these directories are created\nwhen the malware is first launched, we can use their creation date to determine the date of the initial\ncompromise, as seen in Figure 14.\n\n\n-----\n\n_Figure 14. Subdirectory creation dates under /Febrary (sic)_\n\nThis chart shows a spike of compromises in early March 2022, with the first being on February 4 . The lastth\nspike may be explained by sandboxes running CloudMensis, once it was uploaded to VirusTotal.\n\n\n## Conclusion\n\nCloudMensis is a threat to Mac users, but its very limited distribution suggests that it is used as part of a\ntargeted operation. From what we have seen, operators of this malware family deploy CloudMensis to\nspecific targets that are of interest to them. Usage of vulnerabilities to work around macOS mitigations shows\nthat the malware operators are actively trying to maximize the success of their spying operations. At the\nsame time, no undisclosed vulnerabilities (zero-days) were found to be used by this group during our\nresearch. Thus, running an up-to-date Mac is recommended to avoid, at least, the mitigation bypasses.\n\nWe still do not know how CloudMensis is initially distributed and who the targets are. The general quality of\nthe code and lack of obfuscation shows the authors may not be very familiar with Mac development and are\nnot so advanced. Nonetheless a lot of resources were put into making CloudMensis a powerful spying tool\nand a menace to potential targets.\n\n## IoCs\n\n### Files\n\n\n**SHA-1** **Filename** **Description**\n\nD7BF702F56CA53140F4F03B590E9AFCBC83809DB mdworker3 Downloader\n(execute)\n\n\n**ESET detection**\n**name**\n\nOSX/CloudMensis.A\n\nOSX/CloudMensis.A\n\nOSX/CloudMensis.A\n\n\n0AA94D8DF1840D734F25426926E529588502BC08 WindowServer,\nmyexe\n\nC3E48C2A2D43C752121E55B909FC705FE4FDAEF6 WindowServer,\nMyExecute\n\n### Public key\n\n\nSpy agent\n(Client)\n\nSpy agent\n(Client)\n\n\n-----\n\n```\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsGRYSEVvwmfBFNBjOz+Q\n\npax5rzWf/LT/yFUQA1zrA1njjyIHrzphgc9tgGHs/7tsWp8e5dLkAYsVGhWAPsjy\n\n1gx0drbdMjlTbBYTyEg5Pgy/5MsENDdnsCRWr23ZaOELvHHVV8CMC8Fu4Wbaz80L\n\nGhg8isVPEHC8H/yGtjHPYFVe6lwVr/MXoKcpx13S1K8nmDQNAhMpT1aLaG/6Qijh\n\nW4P/RFQq+Fdia3fFehPg5DtYD90rS3sdFKmj9N6MO0/WAVdZzGuEXD53LHz9eZwR\n\n9Y8786nVDrlma5YCKpqUZ5c46wW3gYWi3sY+VS3b2FdAKCJhTfCy82AUGqPSVfLa\n\nmQIDAQAB\n\n-----END PUBLIC KEY----\n### Paths used\n\n```\n/Library/WebServer/share/httpd/manual/WindowServer\n/Library/LaunchDaemons/.com.apple.WindowServer.plist\n~/Library/Containers/com.apple.FaceTime/Data/Library/windowserver\n~/Library/Containers/com.apple.Notes/Data/Library/.CFUserTextDecoding\n~/Library/Containers/com.apple.languageassetd/loginwindow\n~/Library/Application Support/com.apple.spotlight/Resources_V3/.CrashRep\n\n## MITRE ATT&CK techniques\n\n[This table was built using version 11 of the MITRE ATT&CK framework.](https://attack.mitre.org/resources/versions/)\n\n**Tactic** **ID** **Name** **Description**\n\n\nPersistence [T1543.004](https://attack.mitre.org/versions/v11/techniques/T1543/004/) Create or Modify System\nProcess: Launch Daemon\n\n\nThe CloudMensis downloader installs the\nsecond stage as a system-wide daemon.\n\n\nDefense\nEvasion\n\n\n[T1553](https://attack.mitre.org/versions/v11/techniques/T1553/) Subvert Trust Controls CloudMensis tries to bypass TCC if possible.\n\n\nCollection [T1560.002](https://attack.mitre.org/versions/v11/techniques/T1560/002/) Archive Collected Data:\nArchive via Library\n\n\n[T1056.001](https://attack.mitre.org/versions/v11/techniques/T1056/001/) Input Capture:\nKeylogging\n\n[T1113](https://attack.mitre.org/versions/v11/techniques/T1113/) Screen\nCapture\n\n[T1005](https://attack.mitre.org/versions/v11/techniques/T1005/) Data from\nLocal System\n\n[T1025](https://attack.mitre.org/versions/v11/techniques/T1025/) Data from\nRemovable\nMedia\n\n[T1114.001](https://attack.mitre.org/versions/v11/techniques/T1114/001/) Email\nCollection:\nLocal Email\nCollection\n\n\nCloudMensis can capture\nand exfiltrate keystrokes.\n\nCloudMensis can take\nscreen captures and\nexfiltrate them.\n\nCloudMensis looks for\nfiles with specific\nextensions.\n\nCloudMensis can search\nremovable media for\ninteresting files upon their\nconnection.\n\nCloudMensis searches for\ninteresting email\nmessages and\nattachments from Mail.\n\n\nArchive Collected Data: Archive via Library\n[CloudMensis uses SSZipArchive to create a](https://github.com/ZipArchive/ZipArchive)\npassword-protected ZIP archive of data to\nexfiltrate.\n\nThe CloudMensis initial report is encrypted\nwith a public RSA-2048 key.\n\n\nCommand\nand Control\n\n\n[T1573.002](https://attack.mitre.org/versions/v11/techniques/T1573/002/) Encrypted Channel:\nAsymmetric Cryptography\n\n\n-----\n\n**Tactic** **ID** **Name** **Description**\n\n\n[T1573.001](https://attack.mitre.org/versions/v11/techniques/T1573/001/) Encrypted\nChannel:\nSymmetric\nCryptography\n\n[T1102.002](https://attack.mitre.org/versions/v11/techniques/T1102/002/) Web Service:\nBidirectional\nCommunication\n\n\nCloudMensis encrypts\nexfiltrated files using\npassword-protected ZIP\narchives.\n\nCloudMensis uses\nDropbox, pCloud, or\nYandex Drive for C&C\ncommunication.\n\n\nExfiltration [T1567.002](https://attack.mitre.org/versions/v11/techniques/T1567/002/) Exfiltration Over Web\nService: Exfiltration to\nCloud Storage\n\n19 Jul 2022 - 11:30AM\n\n\nCloudMensis exfiltrates files to Dropbox,\npCloud, or Yandex Drive.\n\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-19 - I see what you did there- A look at the CloudMensis macOS spyware.pdf"
    ],
    "report_names": [
        "2022-07-19 - I see what you did there- A look at the CloudMensis macOS spyware.pdf"
    ],
    "threat_actors": [
        {
            "id": "cfdd35af-bd12-4c03-8737-08fca638346d",
            "created_at": "2022-10-25T16:07:24.165595Z",
            "updated_at": "2025-03-27T02:02:10.128957Z",
            "deleted_at": null,
            "main_name": "Sea Turtle",
            "aliases": [
                "Cosmic Wolf",
                "Marbled Dust",
                "Silicon",
                "Teal Kurma",
                "UNC1326"
            ],
            "source_name": "ETDA:Sea Turtle",
            "tools": [
                "Drupalgeddon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "33ae2a40-02cd-4dba-8461-d0a50e75578b",
            "created_at": "2023-01-06T13:46:38.947314Z",
            "updated_at": "2025-03-27T02:00:02.959421Z",
            "deleted_at": null,
            "main_name": "Sea Turtle",
            "aliases": [
                "SILICON",
                "Teal Kurma",
                "UNC1326",
                "COSMIC WOLF",
                "Marbled Dust"
            ],
            "source_name": "MISPGALAXY:Sea Turtle",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535568,
    "ts_updated_at": 1743041613,
    "ts_creation_date": 1660792964,
    "ts_modification_date": 1660792964,
    "files": {
        "pdf": "https://archive.orkl.eu/7b21ed4314e6a1392f7606c60356c9e3f8b9b7d4.pdf",
        "text": "https://archive.orkl.eu/7b21ed4314e6a1392f7606c60356c9e3f8b9b7d4.txt",
        "img": "https://archive.orkl.eu/7b21ed4314e6a1392f7606c60356c9e3f8b9b7d4.jpg"
    }
}