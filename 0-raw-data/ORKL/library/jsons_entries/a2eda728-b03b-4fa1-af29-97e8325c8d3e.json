{
    "id": "a2eda728-b03b-4fa1-af29-97e8325c8d3e",
    "created_at": "2023-01-12T15:04:41.573865Z",
    "updated_at": "2025-03-27T02:05:38.394282Z",
    "deleted_at": null,
    "sha1_hash": "6dd2162eb0b507dabb4408d2fb25dc13cb5fb256",
    "title": "2019-03-18 - Analysis of BlackMoon (Banking Trojan)'s Evolution, And The Possibility of a Latest Version Under Development",
    "authors": "",
    "file_creation_date": "2022-05-28T17:43:21Z",
    "file_modification_date": "2022-05-28T17:43:21Z",
    "file_size": 888579,
    "plain_text": "# Analysis of BlackMoon (Banking Trojan)'s Evolution, And The Possibility of a Latest Version Under Development\n\n**peppermalware.com/2019/03/analysis-of-blackmoon-banking-trojans.html**\n\nBlackMoon, also known as KrBanker, is a banking trojan that mainly targets South Korea. I thought this family was dead since time ago\n(around 2016), however these previous days I got a couple of rencent samples that, after unpacking them and performing a quick analysis, I\n[noticed they were BlackMoon. Virustotal's first submission date for one of these samples is 2018-06-18. First submission date for the other one](https://www.virustotal.com/es/file/80ea86d195bbc4384a1b9a77a2d477e2c4e6dc6d48f3f80447877dbbe41a4e40/analysis/)\nis 2018-11-01. After digging a bit more into this malware family, my conclussion was that probably there is a latest version of BlackMoon that is\nunder development. I explain it in this post, that I hope you enjoy.\n\n**Original Packed Sample:** [C38E54342CDAE1D9181EC48E94DC5C83](https://www.virustotal.com/es/file/09beec989993806345254ca9adcdb034f8649d8a9633bbe8933a52f5093e8be1/analysis/)\n**Automatic Generated Report:** [PepperMalware Report](http://sandbox.peppermalware.com/publicreport/?filter=c38e54342cdae1d9181ec48e94dc5c83&action=showpdf)\n**Virustotal First Submission: 2018-11-01 07:03:51**\n**Unpacked Banker Module:** [4634F4EF94D9A3A0E2FCF5078151ADB2](https://www.hybrid-analysis.com/sample/f0d57176f8a27f89a3ca2d14a80d5b672b0590a1e449cbfa653a8091cdfc9cd7)\n**Related links:**\n\n## Analysis\n\n1. Loader\n\n2.1. Packer\n2.2. Process Injection\n2. Main Module\n\n2.1. Persistence\n2.2. Encrypted Strings\n3. Evolution\n\n3.1. Encrypted Strings Evolution\n3.2. BlackMoon Versions: Latest Version Under Development?\n3.3. BinDiff\n\n3.3.1. 2016-03-03 -> 2016-05-05 Statistics\n3.3.2. 2016-05-05 -> 2018-06-18 Statistics\n3.3.3. 2018-06-18 -> 2018-11-01 Statistics\n3.3.4. 2016-03-03 -> 2016-05-05 Differences\n3.3.5. 2016-05-05 -> 2018-06-18 Differences\n3.3.5. 2018-06-18 -> 2018-11-01 Differences\n4. Conclusions\n5. Yara Rules and Scripts\n\n5.1. BlackMoon Yara Rule\n5.2. Script to Extract BlackMoon Encrypted Strings\n6. Other notes\n\n6.1. Another sample dated 2018 suspicious of being BlackMoon\n\n### 1. Loader\n\n\n-----\n\nMost of the analyzed samples's packers are wellknown packers such as PeCompact, Aspack, Fsg or Nspack:\n\n**Sample** **FirstSeen** **Packer**\n\n[09beec989993806345254ca9adcdb034f8649d8a9633bbe8933a52f5093e8be1](http://sandbox.peppermalware.com/publicreport/?filter=c38e54342cdae1d9181ec48e94dc5c83&action=showpdf) 2018-11-01 PeCompact\n\n[80ea86d195bbc4384a1b9a77a2d477e2c4e6dc6d48f3f80447877dbbe41a4e40](http://sandbox.peppermalware.com/publicreport/?filter=f4114b3006806d7ee27af23978591fbb&action=showpdf) 2018-06-18 Aspack\n\n[2de1e47c650c0a8865ecc7e7b68379ca071062c0873f46a4addb1aa13b8d48dc](http://sandbox.peppermalware.com/publicreport/?filter=0cd7fc49d7e796c5ea0cc9a1e4470536&action=showpdf) 2016-03-03 Fsg\n\n[5f17cf9aee107458995c434d21263528132b5d0ab8a20121d3de48478ec6c467](http://sandbox.peppermalware.com/publicreport/?filter=01da4acd0c1964b466b1b1686d778f2f&action=showpdf) 2016-02-28 PeCompact\n\n[47434c9c2e887ba6f47a31e757b4ac0c0e648dfee9f93e38bd49e1c17f660dcf](http://sandbox.peppermalware.com/publicreport/?filter=1c9f763fb49bb0a76bc53c3fd4f28093&action=showpdf) 2016-03-05 PeCompact\n\n[2012486d87dcc3362745c6f8f178b9be5417c595e79c452a20729d2e60ec814b](http://sandbox.peppermalware.com/publicreport/?filter=1e9765081745e4328d52547c01427669&action=showpdf) 2016-03-08 Aspack\n\n[05afd7bbf6efa14102f72bad0e3a0686af6522b25228ab760ef57e8d6df36ed1](http://sandbox.peppermalware.com/publicreport/?filter=2aabd4fa21cca0f153f57ccc1f3c54c0&action=showpdf) 2016-03-05 Fsg\n\n[5e1ca094e11b2dcfdd4c729e2eaf1bdfd0ec84067a39f1c3a233bfff1ff6dcb5](http://sandbox.peppermalware.com/publicreport/?filter=2e97c8191fcd94bfc77cea13b9eea463&action=showpdf) 2016-03-20 PeCompact\n\n[406c50ed0333d2023de55ce798a4e7d5fa6e45df65c16733ef48961e94277807](http://sandbox.peppermalware.com/publicreport/?filter=3cfd66340f204e1b8697e7a8514c00ab&action=showpdf) 2016-04-08 Aspack\n\n[4844e92d76b2158be2b5468b70e2d0898f9ba2287a02b2b0aa7af2a2113d4970](http://sandbox.peppermalware.com/publicreport/?filter=05cc8b5bb7fbb87f216dc2956864d52d&action=showpdf) 2016-03-02 PeCompact\n\n[7351373a50acbaa4bb3fa622b0573f473289d745ba717551c82abbe398c1c1ff](http://sandbox.peppermalware.com/publicreport/?filter=09a0220648cfec926f72d2ad3d0c3ec0&action=showpdf) 2016-03-10 Nspack\n\n[09a5dc4f9544f7bbc898d205f1e14518606e158f4a7c7126d7eb604ec9ec5c74](http://sandbox.peppermalware.com/publicreport/?filter=11fb2f435a7c525640575cd571b83513&action=showpdf) 2016-04-09 PeCompact\n\n[224ead790d3bab7ede11252728d47e21f0d0274767aa3e6a16628e8970a0149f](http://sandbox.peppermalware.com/publicreport/?filter=19f1a9a51db139fa7cedc183a2ab555d&action=showpdf) 2016-02-28 PeCompact\n\n[00eae37eaaee93b8155e6bad95564c3d95d71e7397653ffcbae4f95614ffa723](http://sandbox.peppermalware.com/publicreport/?filter=236cc4758f096952703b8e0b457bf4e5&action=showpdf) 2016-05-05 PeCompact\n\n**1.2. Process Injection**\n\nMost of the analyzed samples follow the same strategy, they launch an executable (I think it is choosen randomly) from %system32% folder\nand they inject the new process (hollow process). The unpacked code will be executed in the context of the new process. Some of the\nexecutables that we have seen the malware launchs are: wmiprvse.exe, dwwin.exe, comp.exe, cacls.exe, etc...\n\n**Sample** **FirstSeen** **Hollowed Process**\n\n[09beec989993806345254ca9adcdb034f8649d8a9633bbe8933a52f5093e8be1](http://sandbox.peppermalware.com/publicreport/?filter=c38e54342cdae1d9181ec48e94dc5c83&action=showpdf) 2018-11-01 system32\\wmiprvse.exe\n\n[80ea86d195bbc4384a1b9a77a2d477e2c4e6dc6d48f3f80447877dbbe41a4e40](http://sandbox.peppermalware.com/publicreport/?filter=f4114b3006806d7ee27af23978591fbb&action=showpdf) 2018-06-18 system32\\wmiprvse.exe\n\n[2de1e47c650c0a8865ecc7e7b68379ca071062c0873f46a4addb1aa13b8d48dc](http://sandbox.peppermalware.com/publicreport/?filter=0cd7fc49d7e796c5ea0cc9a1e4470536&action=showpdf) 2016-03-03 system32\\dwwin.exe\n\n[5f17cf9aee107458995c434d21263528132b5d0ab8a20121d3de48478ec6c467](http://sandbox.peppermalware.com/publicreport/?filter=01da4acd0c1964b466b1b1686d778f2f&action=showpdf) 2016-02-28 system32\\comp.exe\n\n[47434c9c2e887ba6f47a31e757b4ac0c0e648dfee9f93e38bd49e1c17f660dcf](http://sandbox.peppermalware.com/publicreport/?filter=1c9f763fb49bb0a76bc53c3fd4f28093&action=showpdf) 2016-03-05 system32\\comp.exe\n\n[2012486d87dcc3362745c6f8f178b9be5417c595e79c452a20729d2e60ec814b](http://sandbox.peppermalware.com/publicreport/?filter=1e9765081745e4328d52547c01427669&action=showpdf) 2016-03-08 system32\\cacls.exe\n\n[05afd7bbf6efa14102f72bad0e3a0686af6522b25228ab760ef57e8d6df36ed1](http://sandbox.peppermalware.com/publicreport/?filter=2aabd4fa21cca0f153f57ccc1f3c54c0&action=showpdf) 2016-03-05 system32\\cacls.exe\n\n[5e1ca094e11b2dcfdd4c729e2eaf1bdfd0ec84067a39f1c3a233bfff1ff6dcb5](http://sandbox.peppermalware.com/publicreport/?filter=2e97c8191fcd94bfc77cea13b9eea463&action=showpdf) 2016-03-20 system32\\cacls.exe\n\n[406c50ed0333d2023de55ce798a4e7d5fa6e45df65c16733ef48961e94277807](http://sandbox.peppermalware.com/publicreport/?filter=3cfd66340f204e1b8697e7a8514c00ab&action=showpdf) 2016-04-08 system32\\cacls.exe\n\n[4844e92d76b2158be2b5468b70e2d0898f9ba2287a02b2b0aa7af2a2113d4970](http://sandbox.peppermalware.com/publicreport/?filter=05cc8b5bb7fbb87f216dc2956864d52d&action=showpdf) 2016-03-02 system32\\comp.exe\n\n[7351373a50acbaa4bb3fa622b0573f473289d745ba717551c82abbe398c1c1ff](http://sandbox.peppermalware.com/publicreport/?filter=09a0220648cfec926f72d2ad3d0c3ec0&action=showpdf) 2016-03-10 system32\\cacls.exe\n\n[09a5dc4f9544f7bbc898d205f1e14518606e158f4a7c7126d7eb604ec9ec5c74](http://sandbox.peppermalware.com/publicreport/?filter=11fb2f435a7c525640575cd571b83513&action=showpdf) 2016-04-09 system32\\cacls.exe\n\n[224ead790d3bab7ede11252728d47e21f0d0274767aa3e6a16628e8970a0149f](http://sandbox.peppermalware.com/publicreport/?filter=19f1a9a51db139fa7cedc183a2ab555d&action=showpdf) 2016-02-28 system32\\comp.exe\n\n### 2. Main Module\n\n**2.1. Persistence**\n\nThe malware installs itself under a HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run's subkey. For most of the older samples, the\nrun subkey is a 8-length combination of lowercase and uppercase letters and numbers. However the analyzed samples that date 2018, install\nthemself in the subkey with fixed name 000C29FC2AB3\n\n\n-----\n\n**Sample** **First Seen** **Run Subkey**\n\n[09beec989993806345254ca9adcdb034f8649d8a9633bbe8933a52f5093e8be1](http://sandbox.peppermalware.com/publicreport/?filter=c38e54342cdae1d9181ec48e94dc5c83&action=showpdf) 2018-11-01 **000C29FC2AB3**\n\n[80ea86d195bbc4384a1b9a77a2d477e2c4e6dc6d48f3f80447877dbbe41a4e40](http://sandbox.peppermalware.com/publicreport/?filter=f4114b3006806d7ee27af23978591fbb&action=showpdf) 2018-06-18 **000C29FC2AB3**\n\n[2de1e47c650c0a8865ecc7e7b68379ca071062c0873f46a4addb1aa13b8d48dc](http://sandbox.peppermalware.com/publicreport/?filter=0cd7fc49d7e796c5ea0cc9a1e4470536&action=showpdf) 2016-03-03 06iSwa6C\n\n[5f17cf9aee107458995c434d21263528132b5d0ab8a20121d3de48478ec6c467](http://sandbox.peppermalware.com/publicreport/?filter=01da4acd0c1964b466b1b1686d778f2f&action=showpdf) 2016-02-28 kC6MOsu8\n\n[47434c9c2e887ba6f47a31e757b4ac0c0e648dfee9f93e38bd49e1c17f660dcf](http://sandbox.peppermalware.com/publicreport/?filter=1c9f763fb49bb0a76bc53c3fd4f28093&action=showpdf) 2016-03-05 R3tP5nj1\n\n[2012486d87dcc3362745c6f8f178b9be5417c595e79c452a20729d2e60ec814b](http://sandbox.peppermalware.com/publicreport/?filter=1e9765081745e4328d52547c01427669&action=showpdf) 2016-03-08 66qscw4Q\n\n[05afd7bbf6efa14102f72bad0e3a0686af6522b25228ab760ef57e8d6df36ed1](http://sandbox.peppermalware.com/publicreport/?filter=2aabd4fa21cca0f153f57ccc1f3c54c0&action=showpdf) 2016-03-05 W60u80qO\n\n[5e1ca094e11b2dcfdd4c729e2eaf1bdfd0ec84067a39f1c3a233bfff1ff6dcb5](http://sandbox.peppermalware.com/publicreport/?filter=2e97c8191fcd94bfc77cea13b9eea463&action=showpdf) 2016-03-20 uki4Kk2o\n\n[406c50ed0333d2023de55ce798a4e7d5fa6e45df65c16733ef48961e94277807](http://sandbox.peppermalware.com/publicreport/?filter=3cfd66340f204e1b8697e7a8514c00ab&action=showpdf) 2016-04-08 35V5Bj9b\n\n[4844e92d76b2158be2b5468b70e2d0898f9ba2287a02b2b0aa7af2a2113d4970](http://sandbox.peppermalware.com/publicreport/?filter=05cc8b5bb7fbb87f216dc2956864d52d&action=showpdf) 2016-03-02 AAAC2kY8\n\n[7351373a50acbaa4bb3fa622b0573f473289d745ba717551c82abbe398c1c1ff](http://sandbox.peppermalware.com/publicreport/?filter=09a0220648cfec926f72d2ad3d0c3ec0&action=showpdf) 2016-03-10 1Lf9Tn7B\n\n[09a5dc4f9544f7bbc898d205f1e14518606e158f4a7c7126d7eb604ec9ec5c74](http://sandbox.peppermalware.com/publicreport/?filter=11fb2f435a7c525640575cd571b83513&action=showpdf) 2016-04-09 5jNh7p11\n\n[224ead790d3bab7ede11252728d47e21f0d0274767aa3e6a16628e8970a0149f](http://sandbox.peppermalware.com/publicreport/?filter=19f1a9a51db139fa7cedc183a2ab555d&action=showpdf) 2016-02-28 j3pVbRJ5\n\n[00eae37eaaee93b8155e6bad95564c3d95d71e7397653ffcbae4f95614ffa723](http://sandbox.peppermalware.com/publicreport/?filter=236cc4758f096952703b8e0b457bf4e5&action=showpdf) 2016-05-05 **000C29FC2AB3**\n\nCuriously, the sample 00eae37eaaee93b8155e6bad95564c3d95d71e7397653ffcbae4f95614ffa723 that dates 2016-05-05 (from the older\nsamples, one of the newest), installs itself under the same subkey 000C29FC2AB3.\n\nIn addition, these samples that create the subkey with name 000C29FC2AB3, they create a mutex named M_Test too (the other samples\ndon't create this mutex).\n\n**2.2. Encrypted Strings**\n\nMost of the important strings of BlackMoon are encrypted.\n\nHere is a capture of the code responsible for decrypting the strings from the\nsample 09beec989993806345254ca9adcdb034f8649d8a9633bbe8933a52f5093e8be1:\n\nTo compose the definitive key that the malware uses to decrypt the strings, it carries an string that is the first part of the key, and then it\nappends 6 additional characters to that first part of the key. In the capture, the definitive key to be used would be\n\"7ac13b3aa82136afa3090c5137B8a195\".\n\nEncrypted strings are like this:\n\n\n-----\n\nThe algorithm used to decrypt each string is rc4(unhexlify(rc4(unhexlify(encrypted_string), key)), key):\n\n### 3. Evolution\n\n**3.1. Encrypted Strings Evolution**\n\nWe have extracted the strings from samples from different dates, to compare them:\n\nDate 2016-02-28:\n\nSample 5f17cf9aee107458995c434d21263528132b5d0ab8a20121d3de48478ec6c467:\n\nDate 2016-03-03:\n\nSample 2de1e47c650c0a8865ecc7e7b68379ca071062c0873f46a4addb1aa13b8d48dc:\n\nDate 2016-05-05:\n\nSample 00eae37eaaee93b8155e6bad95564c3d95d71e7397653ffcbae4f95614ffa723:\n\nDate 2018-06-18:\n\nSample 80ea86d195bbc4384a1b9a77a2d477e2c4e6dc6d48f3f80447877dbbe41a:\n\nDate 2018-11-01:\n\nSample 09beec989993806345254ca9adcdb034f8649d8a9633bbe8933a52f5093e:\n\nIn the section 2.1 (about persistence), we had already noticed that most of the samples from 2016 create a 8 bytes length subkey under the\nregistry \\Run key, with a combination of lowercase and uppercase letters and numbers.\n\nHowever a sample dated 2016-05-05 and the newer samples dated 2018 create a subkey under \\Run with name 000C29FC2AB3. In addition\nthese samples create a mutex with name M_Test (this mutex is not created by the 2016's samples).\n\nIf we take a look at the lists of strings, the sample dated 2016-05-05 and the samples dated 2018, all of them have similar lists of encrypted\nstrings, where strings are ordered in similar order (thought they are not totally identicals).\n\nThe other samples dated 2016 contain another lists of strings, identical between them, but different from the lists of the samples dated 2018.\n\n**3.2. BlackMoon Versions: Latest Version Under Development?**\n\n\n-----\n\na g d t e oCs co ected t e p e ous sect o s, e ca co c ude t at t e e s a st e s o o ac oo a a e, ose sa p es\nare dated around 2016, and other version that could be under development, whose samples we have one of them dated 2016-05-05, and\nother two dated 2018-06 and 2018-11.\n\nVersion 1:\n\nPersistence: 8 bytes length subkey under registry \\Run key, with a combination of lowercase and uppercase letters and numbers\nEncrypted strings: \"http://\", \"/ca.php\", \"?m=\", \"&h;=\", \"GET\", \"?p\", \"POST\", \"users.qzone.qq.com\", \"GET /fcg-bin/cgi_get_portrait.fcg?\nuins=\", etc...\nSamples dated 2016\n\nVersion 2 - probably under development version:\n\nPersistence: subkey under \\Run with name 000C29FC2AB3\nMutex: M_Test\nEncrypted strings: \"ScriptControl\", \"Language\", \"VBScript\", \"ExecuteStatement\", \"Function MACAddress()\", \"Dim mc,mo\", \"Set\nmc=GetObject(\\\"Winmgmts:\\\").InstancesOf(\\\"Win32_NetworkAdapterConfiguration\\\"), \"For Each mo In mc\", etc...\nA sample dated 2016-05-05, other 2 samples dated 2018\n\nWe have only 3 samples that we have classified as version 2. Probably they are quite similar, but we must have in mind that the lists of\nencrypted strings for these samples are not totally identical. However, the Run key 000C29FC2AB3 and the mutex M_Test, make us to think\nthese 3 samples are the same version.\n\nFrom my point of view, these 3 newer samples could be a version that is under development. Because of that, each version 2's sample is a bit\ndifferent from the others. And because of that, the name M_Test for the mutex and the non-random name for the \\Run subkey.\n\n**3.3. BinDiff**\n\nLets compare with BinDiff the following samples (once they are already unpacked) trying to understand the evolution of this malware:\n\nVersion1:\n\n2de1e47c650c0a8865ecc7e7b68379ca071062c0873f46a4addb1aa13b8d48dc\n2016-03-03\nOriginal sample packed with Fsg\n\nVersion2:\n\n00eae37eaaee93b8155e6bad95564c3d95d71e7397653ffcbae4f95614ffa723\n2016-05-05\nOriginal sample packed with PeCompact\n\nVersion2:\n\n80ea86d195bbc4384a1b9a77a2d477e2c4e6dc6d48f3f80447877dbbe41a\n2018-06-18\nOriginal sample packed with AsPack\n\nVersion2:\n\n09beec989993806345254ca9adcdb034f8649d8a9633bbe8933a52f5093e\n2018-11-01\nOriginal sample packed with PeCompact\n\n3.3.1. 2016-03-03 -> 2016-05-05 Statistics: 345 matching functions\n\n3.3.2. 2016-05-05 -> 2018-06-18 Statistics: 591 matching functions\n\n\n-----\n\n3.3.3. 2018-06-18 -> 2018-11-01 Statistics: 1743 matching functions\n\nI think the most interesting indicator about similarity, at least in this case, is the number of matching functions because the unpacked modules\nwere dumped with Volatility's procdump command, with --memory --unsafe modificators. Probably most of the primary and secondary\nunmatched functions are due to residual parts of the code of the packer in memory and maybe due to recompilations of the code with newer\nversions of the runtime.\n\nIf we compare the paired functions, we find that most of the changes between versions are due to ligth modifications, small fixes, etc... as we\nwill see in the following sections.\n\n3.3.4. 2016-03-03 -> 2016-05-05 Differences:\n\nFor example, here is a function from the sample dated 2016-03-03 compared to the same function from the sample dated 2016-05-05, where\nwe can see that small changes were done in this function:\n\nAnother function. In this case a larger part of code was removed from the function in the newer version:\n\n\n-----\n\nBtw, in the case of 2016-03-03 -> 2016-05-05, most of the matching functions are ubicated in totally different addresses:\n\nProbably, in spite of the fact that the code doesn't change a lot and there are a lot of matching functions, a code refactorization was done\n**from version 1 to the first samples of version 2 (around 2016-05).**\n\n3.3.5. 2016-05-05 -> 2018-06-18 Differences:\n\nIn this case, in addition to the similarity between functions pairs, lot of the matching functions are ubicated in the same offset into the unpacked\nsample:\n\n\n-----\n\nThis makes us to think both binaries are quite similiar, in spite of the fact that we find minimal changes like in this function:\n\nHowever, there are other functions with more important changes that make us to think that there have been at least a minimal development\nbetween both samples (manual modifications on the code: improvements or fixes, not only recompilation + repacking):\n\n3.3.5. 2018-06-18 -> 2018-11-01 Differences:\n\nAgain, lot of the matching functions ubicated in the same offset, and minimal changes between paired functions. And again, some parts of the\ncode with more important changes that suggest a minimal development by the authors between the first and the second sample:\n\n\n-----\n\n### 4. Conclusions\n\nFrom my point of view, there are two main versions of BlackMoon family.\n\nSamples from the first version date first half-year of 2016.\n\n**Around May-2016, a new version was started. In the sample that dates 2016-05-05 we can appreciate a code refactorization and more**\n**important changes in the code. In addition, we can find changes in the behavior, such as the non-random subkey under the \\Run registry**\n**key, named 000C29FC2AB3, and the non-random mutex created by the malware with name M_Test.**\n\nThere are minimal changes between the sample that dates 2018-06-18 and the samples that dates 2016-05-05, and again minimal changes\nbetween the samples that dates 2016-11-01 and the sample that dates 2018-06-18. However, there are enough changes between\n**these version 2's samples to appreciate that a development was done by the authors, there must be modifications of the source code**\nbetween them (not only recompilation + repacking).\n\n**My conclussion is, there is a version of the BlackMoon that is under development. We can find quite recent samples (based on the**\nVirusTotal first seen date) of this version under development. I can't say totally sure if the code of that recent samples were modified and\ncompiled in 2018 or previously (in spite of the fact that I think the code was recently modified and it is currently evolving, maybe that samples\nwere only repacked or their bytes lightly modified, or maybe VirusTotal didn't see these samples before).\n\nIn addition to the larger changes from the first version to the second version, we can appreciate an evolution of the code of the second version:\nfrom the sample 00eae37eaaee93b8155e6bad95564c3d95d71e7397653ffcbae4f95614ffa723 (May-2016), to the\nsample 80ea86d195bbc4384a1b9a77a2d477e2c4e6dc6d48f3f80447877dbbe41a (June-2018), and to the\nsample 09beec989993806345254ca9adcdb034f8649d8a9633bbe8933a52f5093e (November-2018). So, from my point of view,it seems there\n**are enough evidences to think that there is a BlackMoon version that is under development and currently evolving.**\n\n### 5. Yara Rules and Scripts\n\n**5.1. BlackMoon Yara Rule**\n\nUnpacked module:\n```\nrule blackmoon_unpacked {\nstrings:\n    $code1 = { 89 45 ?? 68 01 01 00 80 6A 00 68 ?? 00 00 00 68 01 00 00 00 BB ?? ?? 00 00 E8 ?? ?? ?? ?? 83 C4 10 }\n    $code2 = { FF 75 ?? FF 75 ?? FF 75 ?? FF 75 ?? FF 75 ?? FF 75 ?? FF 75 ?? B9 ?? ?? 00 00 E8 }\ncondition:\n    (all of them)\n}\n\n```\n**5.2. Script to Extract BlackMoon Encrypted Strings**\n\nThe following script extracts and decrypts the encrypted strings from a BlackMoon unpacked sample:\n\npython strings_decryptor.py <path to unpacked blackmoon>\n\n\n-----\n\n```\nimport os\nimport sys\nimport binascii\nimport traceback\n#################################################\ndef rc4(data, key):\n  x = 0\n  box = range(256)\n  for i in range(256):\n    x = (x + box[i] + ord(key[i % len(key)])) % 256\n    box[i], box[x] = box[x], box[i]\n  x = 0\n  y = 0\n  out = []\n  for char in data:\n    x = (x + 1) % 256\n    y = (y + box[x]) % 256\n    box[x], box[y] = box[y], box[x]\n    out.append(chr(ord(char) ^ box[(box[x] + box[y]) % 256]))\n  return ''.join(out)\n#################################################\ndef findencstrings(s):\n  l = []\n  laststr = \"\"\n  for i in range(0, len(s)):\n    if s[i] in \"0123456789ABCDEF\":\n      laststr += s[i]\n    else:\n      if ord(s[i])==0 and len(laststr)>=6: l.append(laststr)\n      laststr = \"\"\n  return l\n#################################################\ndef decstr(s, k, k2):\n  sorig=s\n  try:\n    if len(s)%2: s = s[0:-1]\n    s = binascii.unhexlify(s)\n    s = rc4(s, k+k2)\n    step1 = s\n    if len(s)%2: s = s[0:-1]\n    s = binascii.unhexlify(s)\n    s = rc4(s, k+k2)\n    return True, s\n  except Exception as e:\n    return False, \"ERROR:\" + repr(e) + \", string:\" + sorig\n#################################################\ndef findkey1(s):\n  l = []\n  laststr = \"\"\n  for i in range(0, len(s)):\n    if s[i] in \"0123456789abcdefABCDEF\":\n      laststr += s[i]\n    else:\n      if ord(s[i])==0 and len(laststr)>=20 and len(laststr)<=30 and not len(laststr)%2 and laststr not in l:\nl.append(laststr)\n      laststr = \"\"\n  if len(l): return l\n  return None\n#################################################\ndef findkey2(s):\n  key=\"\"\n  for i in range(0x0, len(s)-0x100):\n    if s[i:i+8]==\"\\x68\\x01\\x01\\x00\\x80\\x6a\\x00\\x68\" and s[i+8] in \"0123456789abcdefABCDEF\" and s[i+9:i+12]==\"\\x00\\x00\\x00\":\n      key+=s[i+8]\n  return key\n#################################################\ndef get_strings_from_pe(s):\n  ldecs = []\n  lenc = findencstrings(s)\n\n```\n\n-----\n\n```\n  k2 = findkey2(s)\n  if lk1 and k2 and lenc:\n    for k1 in lk1:\n      for i in range(0,len(k2)-6):\n        for senc in lenc:\n          decs = decstr(senc, k1, k2[i:i+6])\n          if decs[0]: ldecs.append(decs[1])\n  return ldecs\n#################################################\ndef analexe(s):\n  decrypted_string_list = []\n  try: decrypted_string_list = get_strings_from_pe(s)\n  except Exception as e:\n    print \"blackmoon exception in get_strings_from_pe\"\n    print traceback.format_exc()\n  for e in decrypted_string_list: \n    print \"blackmoon decrypted string:\", e\n#################################################\nif __name__ == \"__main__\":\n  if os.path.exists(sys.argv[1]):\n    f = open(sys.argv[1], \"rb\")\n    s = f.read()\n    f.close()\n    analexe(s)\n  else:\n    print \"Incorrect path\"\n\n### 6. Other Notes\n\n```\n**6.1. Another sample dated 2018 suspicious of being BlackMoon**\n\nOnce I started to investigate a bit more and to search information about BlackMoon family, I found [a tweet talking about another sample that](https://twitter.com/nao_sec/status/1029148418164195328)\ncould be BlackMoon and whose first submission is 2018-08-08.\n\nI toke a quick look at this sample, [here you can find the unpacked module. Some interesting strings from this unpacked module:](https://www.hybrid-analysis.com/sample/2ca672a1f7ad452056d803fe3d3e2637119ebddb4f36fabdaba99b261fa3cb8f)\n\nhttp://aa.mrmr11[.]cn:8000/fdeee.dll\nyPBfy0A4q1Y3gvgmREe0r1UR0fZVidMd4V8CB3oKTzNaOYCyPaSVz48Sw5mVifR3sVxYgeM7EyVu6DwnrfAG/AxGgDr+9GIP3cQ59d/eLtPq\nC:\\Program Files\\AppPatch\\lpDllName\n360zipUpdate.EXE\n\nThe original sample was packed with Aspack, as other recent BlackMoon samples. However this first unpacked module doesn't look like\nBlackMoon: the code, the strings, etc... are totally different.\n\nAnyway, when I have analyzed this sample, the dll that it tries to download (http://aa.mrmr11[.]cn:8000/fdeee.dll) had been already removed.\n[Maybe that dll was the BlackMoon module. I can't be sure if this sample is BlackMoon or not (this other any.run analysis contains this same](https://app.any.run/tasks/8a1af1dc-3c25-411a-9e08-7cc926b57cc8)\nIoC: \"C:\\Program Files\\AppPatch\\lpDllName\", it downloads a dll too, and the second process name is similar format. Maybe same family. This\nother one was tagged as #trojan #dupzom).\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-03-18 - Analysis of BlackMoon (Banking Trojan)'s Evolution, And The Possibility of a Latest Version Under Development.pdf"
    ],
    "report_names": [
        "2019-03-18 - Analysis of BlackMoon (Banking Trojan)'s Evolution, And The Possibility of a Latest Version Under Development.pdf"
    ],
    "threat_actors": [
        {
            "id": "9b02c527-5077-489e-9a80-5d88947fddab",
            "created_at": "2022-10-25T16:07:24.103499Z",
            "updated_at": "2025-03-27T02:02:10.108504Z",
            "deleted_at": null,
            "main_name": "Reaper",
            "aliases": [
                "APT 37",
                "ATK 4",
                "Cerium",
                "Crooked Pisces",
                "Geumseong121",
                "Group 123",
                "ITG10",
                "InkySquid",
                "Moldy Pisces",
                "Opal Sleet",
                "Operation Are You Happy?",
                "Operation Battle Cruiser",
                "Operation Black Banner",
                "Operation Daybreak",
                "Operation Dragon messenger",
                "Operation Erebus",
                "Operation Evil New Year",
                "Operation Evil New Year 2018",
                "Operation Fractured Block",
                "Operation Fractured Statue",
                "Operation FreeMilk",
                "Operation Golden Bird",
                "Operation Golden Time",
                "Operation High Expert",
                "Operation Holiday Wiper",
                "Operation Korean Sword",
                "Operation North Korean Human Right",
                "Operation Onezero",
                "Operation Rocket Man",
                "Operation SHROUDED#SLEEP",
                "Operation STARK#MULE",
                "Operation STIFF#BIZON",
                "Operation Spy Cloud",
                "Operation Star Cruiser",
                "Osmium",
                "Red Eyes",
                "Ricochet Chollima",
                "Ruby Sleet",
                "ScarCruft",
                "TA-RedAnt",
                "TEMP.Reaper",
                "Venus 121"
            ],
            "source_name": "ETDA:Reaper",
            "tools": [
                "Agentemis",
                "BLUELIGHT",
                "Backdoor.APT.POORAIM",
                "CARROTBALL",
                "CARROTBAT",
                "CORALDECK",
                "Cobalt Strike",
                "CobaltStrike",
                "DOGCALL",
                "Erebus",
                "Exploit.APT.RICECURRY",
                "Final1stSpy",
                "Freenki Loader",
                "GELCAPSULE",
                "GOLDBACKDOOR",
                "GreezeBackdoor",
                "HAPPYWORK",
                "JinhoSpy",
                "KARAE",
                "KevDroid",
                "Konni",
                "MILKDROP",
                "N1stAgent",
                "NavRAT",
                "Nokki",
                "Oceansalt",
                "POORAIM",
                "PoohMilk",
                "PoohMilk Loader",
                "RICECURRY",
                "RUHAPPY",
                "RokRAT",
                "SHUTTERSPEED",
                "SLOWDRIFT",
                "SOUNDWAVE",
                "SYSCON",
                "Sanny",
                "ScarCruft",
                "StarCruft",
                "Syscon",
                "VeilShell",
                "WINERACK",
                "ZUMKONG",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535881,
    "ts_updated_at": 1743041138,
    "ts_creation_date": 1653759801,
    "ts_modification_date": 1653759801,
    "files": {
        "pdf": "https://archive.orkl.eu/6dd2162eb0b507dabb4408d2fb25dc13cb5fb256.pdf",
        "text": "https://archive.orkl.eu/6dd2162eb0b507dabb4408d2fb25dc13cb5fb256.txt",
        "img": "https://archive.orkl.eu/6dd2162eb0b507dabb4408d2fb25dc13cb5fb256.jpg"
    }
}