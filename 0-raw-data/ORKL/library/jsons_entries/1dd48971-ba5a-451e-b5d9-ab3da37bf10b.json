{
    "id": "1dd48971-ba5a-451e-b5d9-ab3da37bf10b",
    "created_at": "2023-01-12T15:02:07.861372Z",
    "updated_at": "2025-03-27T02:13:29.410543Z",
    "deleted_at": null,
    "sha1_hash": "db59a4317325a69c3089a3aca7cb4f2725d093ec",
    "title": "2017-05-17 - New Loki Variant Being Spread via PDF File",
    "authors": "",
    "file_creation_date": "2022-05-29T10:40:37Z",
    "file_modification_date": "2022-05-29T10:40:37Z",
    "file_size": 558336,
    "plain_text": "# New Loki Variant Being Spread via PDF File\n\n**[blog.fortinet.com/2017/05/17/new-loki-variant-being-spread-via-pdf-file](https://blog.fortinet.com/2017/05/17/new-loki-variant-being-spread-via-pdf-file)**\n\nThreat Research\n\nBy [Xiaopeng Zhang and](https://blog.fortinet.com/blog/search?author=Xiaopeng+Zhang) [Hua Liu | May 17, 2017](https://blog.fortinet.com/blog/search?author=Hua+Liu)\n\n## Background\n\n\nMay 17, 2017\n\n\nThe Loki Bot has been observed for years. As you may know, it is designed to steal\ncredentials from installed software on a victim’s machine, such as email clients, browsers,\nFTP clients, file management clients, and so on. FortiGuard Labs recently captured a PDF\nsample that is used to spread a new Loki variant. In this blog, we will analyze how this new\nvariant works and what it steals.\n\n\n-----\n\n## The PDF sample\n\nFigure 1. Content of the PDF sample\n\nThe PDF sample only contains one page, shown above, which includes some social\nengineering content to entice users to download and run the malware.\n\n\n-----\n\nFigure 2. Objects inside the PDF sample\n\nAccording to the sample content (Figure 2), an annotation object in the sample includes an\nURI action, where the malware is downloaded.\n\n**Add itself to Startup folder**\n\nWhen this malware is executed the very first time, it copies itself to “%AppData%\\subfolder”,\nand renames it as “citrio.exe” in my test enviroment. It then creates a VBS file which can\nstart “citrio.exe”. Figure 3 shows its code. The VBS file is added into the system Start Menu\nso it can automatically run whenever the system starts. After all these actions are complete,\n“citrio.exe” is started.\n\nFigure 3. The VBS file in Startup with its code\n\n## How the new Loki variant works\n\n\n-----\n\nAll the APIs being called in this malware are hidden, which will be restored before calling.\nThis increases the difficulty for researchers to analyze it. Figure 4 shows an example. After\ncalling the sub_4031E5 function with the hash(C5FA88F1h) and DLL number (0Ah), eax\npoints to the API \"CommandLineToArgvW\".\n\nFigure 4. Restoring the hidden API\n\nThe author of the malware has written a number of functions for stealing credentials from a\nvictim’s machine. There is an array that is used to store the function pointers. Figure 5\nshows part of the function pointers.\n\n\n-----\n\nFigure 5. Array with function pointers\n\nAs you may have noticed, I added the comment behind each function to show you which\nsoftware it steals credentials from. The malware calls those functions one by one in a loop.\nHere is the list of most of the software whose credentials can be stolen.\n\n\n-----\n\n**Browser software:**\n\nMozilla Firefox, IceDragon, Safari, K-Meleon, Mozilla SeaMonkey, Mozilla Flock, NETGATE\nBlack Hawk, Lunascape, Comodo Dragon, Opera Next, QtWeb, QupZilla, Internet Explorer,\nOpera, 8pecxstudios, Mozilla Pale Moon, Mozilla Waterfox.\n\n**IM software:**\n\nPidgin.\n\n**FTP software:**\n\nFTPShell, NppFTP, oZone3D MyFTP, FTPBox, sherrod FTP, FTP Now, NetSarang xftp,\nEasyFTP, SftpNetDrive, AbleFTP, JaSFtp, Automize, Cyberduck, FTPInfo, LinasFTP,\nFileZilla, Staff-FTP, BlazeFtp, FTPGetter, WSFTP, GoFTP, Estsoft ALFTP, DeluxeFTP,\nFastream NETFile, ExpanDrive, Steed, FlashFXP, NovaFTP, NetDrive, SmartFTP, UltraFXP,\nFTP Now, FreshFTP, BitKinex, Odin Secure FTP Expert, NCH Software Fling, NCH Software\nClassicFTP, WinFtp Client, WinSCP, 32BitFtp, FTP Navigator.\n\n**Game software:**\n\nFull Tilt Poker, PokerStars.\n\n**File manager software:**\n\nNexusFile, FullSync, FAR Manager, Syncovery, VanDyke SecureFX, Mikrotik Winbox.\n\n**SSH/VNC client software:**\n\nSuperPutty, Bitvise BvSshClient, VNC, KiTTY.\n\n**Password manager software:**\n\nmSecure, KeePass, EnPass, RoboForm, 1Password.\n\n**Email client software:**\n\nMozilla Thunderbird, foxmail, Pocomail, IncrediMail, Gmail Notifier Pro, DeskSoft CheckMail,\nSoftwarenetz Mailing, Opera Mail, Postbox email, Mozilla FossaMail, Internet Mail, MS\nOffice Outlook, WinChips, yMail2, Flaska.net Trojita, TrulyMail.\n\n**Notes/Todo list software:**\n\nTo-Do DeskList, Stickies, NoteFly, Conceptworld Notezilla, Microsoft StickyNotes.\n\n## Stealing Microsoft Outlook Credentials and Stickies Pictures\n\n\n-----\n\nFrom the above analysis, it is clear that this new Loki variant is capable of stealing\ncredentials from more than 100 different software tools (if installed.) In this section, we are\ngoing to present how it steals the credentials of Microsoft Outlook and pictures from Stickies.\n\nTo do this, It goes through three sub-keys (for three different versions) in the system registry\nto get saved email accounts, email addresses, username, password, SMTP, POP3, IMAP\nrelated information, and so on.\n\nThe three sub-keys are:\n\nFigure 6. Microsoft Outlook saves credentials in the registry\n\n\n-----\n\nFigure 7. Copying sub-key “POP3 Password”\n\nWhat you can see in the above figures are the Outlook credentials in the system registry of\nmy test enviroment. The malware is able to read them from here by calling the API\n“SHQueryValueExW”. All stolen information is stored in a global buffer. See Figure 8.\n\n\n-----\n\nFigure 8. Stolen Outlook credentials in global buffer\n\nFor the Stickies attack, since I didn’t have that software installed I simply modified my test\nmachine to simulate that it was installed. Here we go.\n\nFigure 9 shows part of the code for Stickies. It gets the strings “*.png”, “*.rtf”,\n“%s\\stickies\\images” dynamically created before using. The malware steals png and rtf files\nfrom the sub-folders “\\stickies\\images” and “\\stickies\\rtf” in several system directories, such\nas %AppData%, %UserProfile%.\n\nFigure 9. Code snippet for Stickies\n\n\n-----\n\nI created a sub-folder %AppData%\\stickies\\images and put a .png file into it. Loki reads the\npng file into that global buffer behind the Outlook data. It also collects system information\nfrom the victim’s machine, such as computer name, user name, processor property, etc. After\nall collected information is ready, it sends them to its C&C server using a HTTP POST\nrequest, the body of which is the data stolen from the victim’s machine. And the data is\ndelivered in a kind of compression format. Figure 10 shows a screenshot of the packet in\nWireShark.\n\nFigure 10. Send the data stolen from Outlook and Stickies to the C&C server\n\n## Solution\n\nThe URL “194.88.105.202/~ninjagro/pdfs/QUOTATION.exe” has been rated as Malicious\n**Websites and “online-prodaja.rs/tz/Panel/five/fre.php” as Phishing by the FortiGuard**\nWebfilter service.\n\nThe downloaded exe file has been detected as W32/Injector.DONO!tr and the PDF file as\n**Data/Loki_Phish.A!tr by the FortiGuard Antivirus service.**\n\n\n-----\n\n## IoC\n\n**URL:**\n\n\"194.88.105.202/~ninjagro/pdfs/QUOTATION.exe\"\n\n\"online-prodaja.rs/tz/Panel/five/fre.php\"\n\n**Sample SHA256:**\n\nQUOTATION (1).pdf\n\nE71379A53045385C4AC32E5BE75A04E3D2A9FC7B707FB4478CE90FE689F66D19\n\nQUOTATION.exe\n\nFA417E0B42362C40301750809DF9F0C9BDBF333269F50F74832D4F471358AAED\n\nCopyright © 2022 Fortinet, Inc. All Rights Reserved\n\n[Terms of ServicesPrivacy Policy](https://www.fortinet.com/corporate/about-us/legal.html)\n| Cookie Settings\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-05-17 - New Loki Variant Being Spread via PDF File.pdf"
    ],
    "report_names": [
        "2017-05-17 - New Loki Variant Being Spread via PDF File.pdf"
    ],
    "threat_actors": [
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "46b3c0fc-fa0c-4d63-a38a-b33a524561fb",
            "created_at": "2023-01-06T13:46:38.393409Z",
            "updated_at": "2025-03-27T02:00:02.822155Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "The Dukes",
                "Minidionis",
                "Grizzly Steppe",
                "G0016",
                "Blue Kitsune",
                "BlueBravo",
                "SeaDuke",
                "Cloaked Ursa",
                "YTTRIUM",
                "ATK7",
                "Nobelium",
                "UAC-0029",
                "Group 100",
                "COZY BEAR",
                "IRON HEMLOCK",
                "TA421",
                "ITG11"
            ],
            "source_name": "MISPGALAXY:APT29",
            "tools": [
                "QUARTERRIG",
                "SNOWYAMBER",
                "HALFRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535727,
    "ts_updated_at": 1743041609,
    "ts_creation_date": 1653820837,
    "ts_modification_date": 1653820837,
    "files": {
        "pdf": "https://archive.orkl.eu/db59a4317325a69c3089a3aca7cb4f2725d093ec.pdf",
        "text": "https://archive.orkl.eu/db59a4317325a69c3089a3aca7cb4f2725d093ec.txt",
        "img": "https://archive.orkl.eu/db59a4317325a69c3089a3aca7cb4f2725d093ec.jpg"
    }
}