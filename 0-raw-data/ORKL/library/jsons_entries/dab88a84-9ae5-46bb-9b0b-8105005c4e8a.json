{
    "id": "dab88a84-9ae5-46bb-9b0b-8105005c4e8a",
    "created_at": "2023-01-12T15:09:54.837307Z",
    "updated_at": "2025-03-27T02:05:53.671037Z",
    "deleted_at": null,
    "sha1_hash": "d9d43615b5011fb72ad3658d28c1fd8c89680e94",
    "title": "2021-03-02 - An Exhaustively-Analyzed IDB for FlawedGrace",
    "authors": "",
    "file_creation_date": "2022-05-28T18:26:55Z",
    "file_modification_date": "2022-05-28T18:26:55Z",
    "file_size": 424108,
    "plain_text": "# An Exhaustively-Analyzed IDB for FlawedGrace\n\n**[msreverseengineering.com/blog/2021/3/2/an-exhaustively-analyzed-idb-for-flawedgrace](https://www.msreverseengineering.com/blog/2021/3/2/an-exhaustively-analyzed-idb-for-flawedgrace)**\n\nMarch 2, 2021 [Rolf Rolles](http://10.10.0.46/blog?author=5111cf9ee4b0a36262da10df)\n\n\nMarch 2, 2021\n\n\nThis blog entry announces the release of an exhaustive analysis of FlawedGrace. You can\nfind the IDB for the main executable, and for the 64-bit password stealer module, here. The\nsha1sum for the main executable is 9bb72ae1dc6c49806064992e0850dc8cb02571ed, and\nthe md5sum is bc91e2c139369a1ae219a11cbd9a243b.\n\n[Like the previous entry in this series on ComRAT v4, I did this analysis as part of my](https://www.msreverseengineering.com/blog/2020/8/31/an-exhaustively-analyzed-idb-for-comrat-v4)\npreparation for an upcoming class on C++ reverse engineering. The analysis took about a\nmonth, and made me enamored with FlawedGrace's architecture. I have personally never\nanalyzed (nor read the source for) a program with such a sophisticated networking\ncomponent. Were I ever to need a high-performance, robust, and flexible networking\ninfrastructure, I'd probably find myself cribbing from FlawedGrace. This family is also\nnotable for its custom, complex virtual filesystem used for configuration management and\nC2 communications. I would like to eventually write a treatise about all of the C++ malware\nfamily analyses that I performing during my research for the class, but that endeavor was\ndistracting me from work on my course, and hence will have to wait.\n\n(Note that if you are interested in the forthcoming C++ training class, it probably will be\navailable in Q3/Q4 2021. More generally, remote public classes (where individual students\ncan sign up) are temporarily suspended; remote private classes (multiple students on behalf\nof the same organization) are currently available. If you would like to be notified when public\nclasses become available, or when the C++ course is ready, please sign up on our nospam, very low-volume, course notification mailing list. (Click the button that says \"Provide\nyour email to be notified of public course availability\".) )\n\n(Note that I am looking for a fifth and final family (beyond ComRAT, FlawedGrace, XAgent,\nand Kelihos) to round out my analysis of C++ malware families. If you have suggestions -[and samples, or hashes I can download through Hybrid-Analysis -- please send me an](https://www.hybrid-analysis.com/)\nemail at rolf@ my domain.)\n\n## About the IDB\n\nHere are some screenshots. First, a comparison of the unanalyzed executable versus the\nanalyzed one:\n\n\n-----\n\nNext, IDA's function folders should make it easy to find the parts that interest you:\n\n\n-----\n\nFinally, the local types window contains all of the reconstructed data structures:\n\n\n-----\n\n## About the Analysis\n\nLike the previous analysis of ComRAT v4, this analysis was conducted purely statically. Like\nthe previous, I have reverse engineered every function in the binary that is not part of the\nC++ standard library, and some of those that are. Like the previous, all analysis was\nconducted in Hex-Rays, so you will not find anything particularly interesting in the plain\ndisassembly listing. Unlike the previous, this binary had RTTI, meaning that I was given the\nnames and inheritance relationships of classes with virtual functions.\n\n\n-----\n\nEach C++ program that I devote significant time to analyzing seems to present me with\nunique challenges. With ComRAT, those were scale and usage of modern additions to the\nSTL that had been previously unfamiliar to me. With XAgent, it was forcing myself to\nmuddle through the subtleties of how MSVC implements multiple inheritance. For\nFlawedGrace, those challenges were:\n\nExtensive use of virtual functions and inheritance, beyond anything I've analyzed\npreviously. Tracing the flow of data from point A to point B often involved around a\ndozen different object types and virtual function calls, sometimes more. You can see\nan example of this in the database notepad, where I describe the RDP tunneling\nimplementation.\n\nA type reconstruction burden that seemed to never end. FlawedGrace has one of the\nhighest ratios of custom types to program size of anything I've analyzed. In total, I\nmanually reconstructed 178 custom data types across 454 programmer-written\nfunctions, which you will find in the Local Types window.\n\nHaving to reverse engineer a complex virtual file system statically, with no sample\ndata. You can find the relevant code in the functions window, under the folder path\nModalities\\Standalone\\Virtual File System. I suspect this was written by a different\nteam than the networking component, given the difference in coding styles: i.e., the\nVFS was written in plain C, with some features that mimic VTables.\n\nHaving to confront, as a user, the challenges that reverse engineering tools have with\nx86/Windows programs (in contrast to x64) with regards to stack pointer analysis and\n64-bit integers.\n\nHaving to brush up on my network programming skills. For example, I had forgotten\nwhat the “Nagle algorithm” was. It’s clear that the server-side component is derived\nfrom the same codebase. However, the server portion of the code was not present in\nthe binary, so I could not analyze it.\n\nFlawedGrace makes proficient use of C++ features and the STL, and its authors are\nexperts in concurrent programming and networking. However, it is mostly written in an older\nstyle than ComRAT was; for example, it does not use <memory>. Here is a list of the STL\ndata types used, in descending frequency of usage:\n\n<atomic>\n\nthread\n\nlist<T>\n\nmap<K,V>\n\n\n-----\n\ndeque<T>\n\nset<T>\n\nvector<T>\n\nI hope you enjoy the IDB.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-02 - An Exhaustively-Analyzed IDB for FlawedGrace.pdf"
    ],
    "report_names": [
        "2021-03-02 - An Exhaustively-Analyzed IDB for FlawedGrace.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536194,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1653762415,
    "ts_modification_date": 1653762415,
    "files": {
        "pdf": "https://archive.orkl.eu/d9d43615b5011fb72ad3658d28c1fd8c89680e94.pdf",
        "text": "https://archive.orkl.eu/d9d43615b5011fb72ad3658d28c1fd8c89680e94.txt",
        "img": "https://archive.orkl.eu/d9d43615b5011fb72ad3658d28c1fd8c89680e94.jpg"
    }
}