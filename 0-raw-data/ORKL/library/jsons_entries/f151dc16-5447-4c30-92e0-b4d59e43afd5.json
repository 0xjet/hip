{
    "id": "f151dc16-5447-4c30-92e0-b4d59e43afd5",
    "created_at": "2023-01-12T15:05:59.474635Z",
    "updated_at": "2025-03-27T02:16:35.005Z",
    "deleted_at": null,
    "sha1_hash": "49edad2a870cbe8ffb784a8f51198183f8cff961",
    "title": "2020-12-16 - SolarWinds Post-Compromise Hunting with Azure Sentinel",
    "authors": "",
    "file_creation_date": "2022-05-29T01:32:52Z",
    "file_modification_date": "2022-05-29T01:32:52Z",
    "file_size": 559955,
    "plain_text": "# SolarWinds Post-Compromise Hunting with Azure Sentinel\n\n**[techcommunity.microsoft.com/t5/azure-sentinel/solarwinds-post-compromise-hunting-with-azure-sentinel/ba-p/1995095](https://techcommunity.microsoft.com/t5/azure-sentinel/solarwinds-post-compromise-hunting-with-azure-sentinel/ba-p/1995095)**\n\nDecember 16, 2020\n\nMSTIC has released a number of new hunting and detection queries for Azure Sentinel based on additional observations as well as research\n[released by partners and the wider community. In addition, the SolarWinds post compromise hunting workbook has been updated to include a](https://github.com/Azure/Azure-Sentinel/blob/master/Workbooks/SolarWindsPostCompromiseHunting.json)\nnumber of new sections.\n\nBlog sections have been marked with Updated and include the date they were last updated.\n\n[Microsoft recently blogged about the Recent Nation-State Cyber Attacks that has impacted high value targets both across the government and](https://blogs.microsoft.com/on-the-issues/2020/12/13/customers-protect-nation-state-cyberattacks/)\n[private sector. This attack is also known as Solorigate or](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Trojan:MSIL/Solorigate.B!dha) [Sunburst. This threat actor is believed to be highly sophisticated and motivated.](https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html)\nRelevant security data required for hunting and investigating such a complex attack is produced in multiple locations - cloud, on-premises and\nacross multiple security tools and product logs. Being able to analyze all the data from a single point makes it easier to spot trends and\nattacks. Azure Sentinel has made it easy to collect data from multiple data sources across different environments both on-prem and cloud with\nthe goal of connecting that data together more easily. This blog post contains guidance and generic approaches to hunt for attacker activity\n(TTPs) in data that is available by default in Azure Sentinel or can be onboarded to Azure Sentinel.\n\nAssociated content details:\n\nUpdated 12/18/2020\n\n[Currently known in depth attack details have been provided by the M365 and MSTIC teams via the deep dive analysis blog.](https://aka.ms/solorigateattack)\n\nUpdated 12/21/2020\n\nCurrent advice for incident responders [on recovery from systemic identity compromises has been provided by Microsoft Detection and](https://aka.ms/dartrecoveryguide)\nResponse Team.\n\nUpdated 12/22/2020\n\n**Azure AD Identity admins who want to gain further visibility and understanding related to the identity implications of this attack on their**\n[environment can use the newly released Sensitive Operations Report workbook.](https://techcommunity.microsoft.com/t5/azure-active-directory-identity/azure-ad-workbook-to-help-you-assess-solorigate-risk/ba-p/2010718)\n\nUpdated 12/26/2020\n\n**For Identity Vendors and their customers to understand the Solorigate identity related attack components the Identity team at Microsoft**\n[has produced a blog has been created to walk thru this information.](https://techcommunity.microsoft.com/t5/azure-active-directory-identity/understanding-quot-solorigate-quot-s-identity-iocs-for-identity/ba-p/2007610)\n\n\n-----\n\nUpdated 12/28/2020\n\n**Users of Microsoft 365 Defender can also hunt and detect on similar items in this blog, but tailored towards investigation using Microsoft**\n365 Defender to protect against Solorigate.\n\nThe goal of this article is post-compromise investigation strategies and is focused on TTPs and not focused on specific IOCs. Azure Sentinel\ncustomers are encouraged to review advisories and IOC’s shared by Microsoft MSRC and security partners to search on specific IOC’s in their\nenvironment using Azure Sentinel. Links to these IOC’s are listed in the reference section at the end.\n\nTo make it easier for security teams to visualize and monitor their environments for this attack the MSTIC team has shared a SolarWinds Post\nCompromise hunting workbook via Azure Sentinel and Azure Sentinel GitHub. There are many things in this workbook that threat hunters\nwould find useful and the workbook is complimentary to the hunting methods shared below. Importantly, if you have recently rotated ADFS key\nmaterial this workbook can be useful in identifying attacker logon activity if they logon with old key material. Security teams should leverage\nthis hunting workbook as part of their workflow in investigating this attack.\n\nThanks to the MSTIC and M365 teams for collaborating to deliver this content in a timely manner. Special thanks\n**to** [@aprakash13,](https://techcommunity.microsoft.com/t5/user/viewprofilepage/user-id/293861) [@Ashwin_Patil,](https://techcommunity.microsoft.com/t5/user/viewprofilepage/user-id/313528) [@Pete Bryan,](https://techcommunity.microsoft.com/t5/user/viewprofilepage/user-id/113210) [@ItsReallyNick, Chris Glyer,](https://techcommunity.microsoft.com/t5/user/viewprofilepage/user-id/640594) [@Cyb3rWard0g,](https://techcommunity.microsoft.com/t5/user/viewprofilepage/user-id/591947) [@Tim Burrell (MSTIC), Rob](https://techcommunity.microsoft.com/t5/user/viewprofilepage/user-id/178222)\nMead, [@TomMcElroy,](https://techcommunity.microsoft.com/t5/user/viewprofilepage/user-id/686380) [@Elia Florio,](https://techcommunity.microsoft.com/t5/user/viewprofilepage/user-id/75694) [@Corina Feuerstein, Ramin Nafisi, Michael Matonis.](https://techcommunity.microsoft.com/t5/user/viewprofilepage/user-id/92617)\n\nPlease note that since Azure Sentinel and the M365 Advanced Hunting portal share the same query language and share similar data types, all\nof the referenced queries can be used directly or slightly modified to work in both.\n\n## Gaining a foothold\n\n[As shared in Microsoft’s technical blog – Customer Guidance on Recent Nation-state Cyber Attacks - attackers might have compromised the](https://msrc-blog.microsoft.com/2020/12/13/customer-guidance-on-recent-nation-state-cyber-attacks/)\ninternal build systems or the update distribution systems of SolarWinds Orion software then modified a DLL component in the legitimate\nsoftware and embedded backdoor code that would allow these attackers to remotely perform commands or deliver additional payloads. Below\n[is a representation of various attack stages which you can also see in Microsoft Threat Protection (MTP) portal. Note that if you do not have](https://securitycenter.windows.com/)\nMicrosoft Threat Protection this link will not work for you.\n\nTo hunt for similar TTPs used in this attack, a good place to start is to build an inventory of the machines that have SolarWinds Orion\ncomponents. Organizations might already have a software inventory management system to indicate hosts where the SolarWinds application\nis installed. Alternatively, Azure Sentinel could be leveraged to run a simple query to gather similar details. Azure Sentinel collects data from\nmultiple different logs that could be used to gather this information. For example, through the recently released Microsoft 365 Defender\nconnector, security teams can now easily ingest Microsoft 365 raw data into Azure Sentinel. Using the ingested data, a simple query like below\ncan be written that will pull the hosts with SolarWinds process running in last 30 days based on Process execution either via host on boarded\nto Sentinel or on boarded via Microsoft Defender for Endpoints (MDE). The query also leverages the Sysmon logs that a lot of customers are\ncollecting from their environment to surface the machines that have SolarWinds running on them. Similar queries that leverage M365 raw data\ncould also be run from the M365's Advanced hunting portal.\n\n[SolarWinds Inventory check query](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/SolarWindsInventory.yaml)\n\nSpoiler\n\n\n-----\n\net t e a e 30d;\n\n(union isfuzzy=true\n\n(\n\nSecurityEvent\n\n| where TimeGenerated >= ago(timeframe)\n\n| where EventID == '4688'\n\n| where tolower(NewProcessName) has 'solarwinds'\n\n| extend MachineName = Computer, Process = NewProcessName\n\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), MachineCount = dcount(MachineName), AccountCount = dcount\n\n),\n\n(\n\nDeviceProcessEvents\n\n| where TimeGenerated >= ago(timeframe)\n\n| where tolower(InitiatingProcessFolderPath) has 'solarwinds'\n\n| extend MachineName = DeviceName, Process = InitiatingProcessFolderPath, Account = AccountName\n\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), MachineCount = dcount(MachineName), AccountCount = dcount\n\n),\n\n(\n\nEvent\n\n| where TimeGenerated >= ago(timeframe)\n\n| where Source == \"Microsoft-Windows-Sysmon\"\n\n| where EventID == 1\n\n| extend Image = EventDetail.[4].[\"#text\"]\n\n| where tolower(Image) has 'solarwinds'\n\n| extend MachineName = Computer, Process = Image, Account = UserName\n\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), MachineCount = dcount(MachineName), AccountCount = dcount\n\n)\n\n)\n\nUpdated 12/30/2020\n\nOn systems where the malicious SolarWinds DLL (SolarWinds.Orion.Core.BusinessLayer.dll) is running, it is known that the attacker used a\nhardcoded named pipe '583da945-62af-10e8-4902-a8f205c72b2e' to conduct various checks as well as to ensure only one instance of the\nbackdoor was running. The use of named pipes by malware is not uncommon as it provides a mechanism for communication between\nprocesses. This activity by the malware can be detected if you are collecting Sysmon (Event Id 17/18) or Security Event Id 5145 in your Azure\n[Sentinel workspace. The Solorigate Named Pipe detection should not be considered reliable on its own as the creation of just the hardcoded](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityEvent/SolorigateNamedPipe.yaml)\nnamed pipe does not indicate that the malicious code was completely triggered, and the machine beaconed out or received additional\ncommands. However, presence of this is definitely suspicious and should warrant further in-depth investigation.\n\nSpoiler\nlet timeframe = 1d;\n(union isfuzzy=true\n(Event\n| where TimeGenerated >= ago(timeframe)\n| where Source == \"Microsoft-Windows-Sysmon\"\n| where EventID in (17 18)\n\n\n-----\n\n| e te d ata pa se_ ( e t ata)\n| extend EventDetail = EvData.DataItem.EventData.Data\n| extend NamedPipe = EventDetail.[5].[\"#text\"]\n| extend ProcessDetail = EventDetail.[6].[\"#text\"]\n| where NamedPipe contains '583da945-62af-10e8-4902-a8f205c72b2e'\n| extend Account = UserName\n| project-away EventDetail, EvData\n),\n(\nSecurityEvent\n| where TimeGenerated >= ago(timeframe)\n| where EventID == '5145'\n| where AccessList has '%%4418' // presence of CreatePipeInstance value\n| where RelativeTargetName contains '583da945-62af-10e8-4902-a8f205c72b2e'\n)\n)\n| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer\n\n## Privilege Escalation\n\nOnce the adversary acquires an initial foothold on a system thru the SolarWinds process they will have System account level access, the\nattacker will then attempt to elevate to domain admin level access to the environment. The Microsoft Threat Intelligence Center (MSTIC) team\nhas already delivered multiple queries into Azure Sentinel that identify similar TTPs and many are also available in M365. These\nmethodologies are not specific to just this threat actor or this attack but have been seen in various attack campaigns.\n\nIdentifying abnormal logon activities or additions to privileged groups is one way to identify privilege escalation.\n\nUpdated 12/17/2020\n\n[Checking for hosts with new logons to identify potential lateral movement by the attacker.](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SecurityEvent/HostsWithNewLogons.yaml)\n[Look for any new account being created and added to built-in administrators group.](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityEvent/UserCreatedAddedToBuiltinAdmins_1d.yaml)\n[Look for any user account added to privileged built in domain local or global groups, including adding accounts to a domain privileged](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityEvent/UserAccountAddedToPrivlegeGroup_1h.yaml)\ngroup such as Enterprise Admins, Cert Publishers or DnsAdmins.\nMonitor for [rare activity by a high-value account carried out on a system or service.](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/TrackingPrivAccounts.yaml)\n\nRelated to this attack, in some environments service account credentials had been granted administrative privileges. The above queries can\nbe modified to remove the condition of focusing “User” accounts by commenting the query to include service accounts in the scope where\napplicable:\n\n**_//| where AccountType == \"User\"_**\n\n[Please see the Azure Sentinel Github for additional queries and hunting ideas related to Accounts under the Detections and Hunting Queries](https://github.com/Azure/Azure-Sentinel)\nsections for AuditLogs, and SecurityEvents\n\n[Microsoft 365 Defender team has also shared quite a few sample queries for use in their advanced hunting portal that could be leveraged to](https://github.com/microsoft/Microsoft-365-Defender-Hunting-Queries)\ndetect this part of the attack. Additionally, the logic for many of the Azure Sentinel queries can also be transformed to equivalent queries for\nMicrosoft 365 Defender, that could be run in their Advanced Hunting Portal.\n\nMicrosoft 365 Defender has an upcoming complimentary blog that will be updated here once available.\n\n## Certificate Export\n\nThe next step in the attack was stealing the certificate that signs SAML tokens from the federation server (ADFS) called a Token Signing Cert\n(TSC). SAML Tokens are basically XML representations of claims. You can read more about ADFS in What is federation with Azure AD? |\nMicrosoft Docs and SAML at [Azure Single Sign On SAML Protocol - Microsoft identity platform | Microsoft Docs. The process is as follows:](https://docs.microsoft.com/en-us/azure/active-directory/develop/single-sign-on-saml-protocol)\n\n1. A client requests a SAML token from an ADFS Server by authenticating to that server using Windows credentials.\n2. The ADFS server issues a SAML token to the client.\n3. The SAML token is signed with a certificate associated with the server.\n4. The client then presents the SAML token to the application that it needs access to.\n5. The signature over the SAML token tells the application that the security token service issued the token and grants access to the client.\n\n## ADFS Key Extraction\n\nUpdated 01/15/2021\n\n\n-----\n\ne p cat o o stea g t e o e S g g Ce t ( SC) s t at o ce t e ce t cate as bee acqu ed, t e acto ca o ge S (Secu ty\nAssertions Markup Language) tokens with whatever claims and lifetime they choose, then sign it with the certificate that has been acquired.\nMicrosoft continues to strongly recommend securing your AD FS (Active Directory Federation Service) TSC because if these TSC’s are\nacquired by a bad actor, this then enables the actor to forge SAML tokens that impersonate highly privileged accounts. There are publicly\n[available pen-testing tools like ADFSDump and](https://github.com/fireeye/adfsdump) [ADFSpoof that help with extracting required information from the AD FS configuration](https://github.com/fireeye/adfspoof)\ndatabase to generate the forged security tokens. While we have not confirmed these specific tools were used in this attack, they are useful for\nsimulating the attack behavior or executing a similar attack and therefore, Microsoft has created a high-fidelity detection related to this for\nM365 Defender:\n\n**ADFS private key extraction which detects ADFS private key extraction patterns from tools such as ADFSDump.**\n\n**Note: Any M365 Defender alert can be seen in Azure Sentinel Security Alerts or in the M365 security portal.**\n\nUpdated 01/15/2021\n\nThe TTP (tactics, techniques, and procedures) observed in the Solorigate attack is the creation of a legitimate SAML token used to authenticate\nas any user. One way an attacker could achieve this is by compromising FS key material. Microsoft has a new detection for this as stated\nabove and for Azure Sentinel has also created a Windows Event Log based detection that indicates an [ADFS DKM Master Key Export. As part](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/ADFS-DKM-MasterKey-Export.yaml)\nof the update for this query to the Azure Sentinel GitHub, there is a [detailed write up for why this is interesting along with a subsequent](https://github.com/Azure/Azure-Sentinel/pull/1512#issue-543053339)\naddition providing clarity on how to get 4662 events to fire. This detection should not be considered reliable on its own but can identify\nsuspicious activity that warrants further investigation.\n\nUpdated 01/15/2021\n\nSpoiler\n(union isfuzzy=true (SecurityEvent\n| where EventID == 4662 // You need to create a SACL on the ADFS Policy Store DKM group for this event to be created.\n| where ObjectServer == 'DS'\n| where OperationType == 'Object Access'\n//| where ObjectName contains '<GUID of ADFS Policy Store DKM Group object' This is unique to the domain. Check description for more\ndetails.\n| where ObjectType contains '5cb41ed0-0e4c-11d0-a286-00aa003049e2' // Contact Class\n| where Properties contains '8d3bca50-1d7e-11d0-a081-00aa006c33ed' // Picture Attribute - Ldap-Display-Name: thumbnailPhoto\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer, AccountCustomEntity = SubjectAccount),\n(DeviceEvents\n| where ActionType =~ \"LdapSearch\"\n| where AdditionalFields.AttributeList contains \"thumbnailPhoto\"\n| where AdditionalFields.DistinguishedName contains \"CN=ADFS,CN=Microsoft,CN=Program Data\" // Filter results to show only hits related to\nthe ADFS AD container\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName, AccountCustomEntity = InitiatingProcessAccountName)\n)\n\nUpdated 12/19/2020\n\n[MSTIC has developed another detection for ADFS server key export events. This detection leverages the visibility provided by Sysmon and](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityEvent/ADFSKeyExportSysmon.yaml)\nprovides a more reliable detection method than that covered in the Windows Event Log detection. For this detection to be effective you must\n[be collecting Sysmon Event IDs 17 and 18 into your Azure Sentinel workspace.](https://medium.com/blueteamlabs/using-sysmon-in-azure-sentinel-883eb6ffc431)\n\nSpoiler\n// Adjust this to use a longer timeframe to identify ADFS servers\nlet lookback = 6d;\n// Adjust this to adjust the key export detection timeframe\nlet timeframe = 1d;\n// Start be identifying ADFS servers to reduce FP chance\nlet ADFS_Servers = (\nEvent\n| where TimeGenerated > ago(timeframe+lookback)\n| where Source == \"Microsoft-Windows-Sysmon\"\n| extend EventData = parse_xml(EventData).DataItem.EventData.Data\n| mv-expand bagexpansion=array EventData\n| evaluate bag_unpack(EventData)\n| extend Key=tostring(['@Name']), Value=['#text']\n| evaluate pivot(Key, any(Value), TimeGenerated, Source, EventLog, Computer, EventLevel, EventLevelName, EventID, UserName,\nRenderedDescription, MG, ManagementGroupName, Type, _ResourceId)\n| extend process = split(Image, '\\\\', -1)[-1]\n| where process =~ \"Microsoft.IdentityServer.ServiceHost.exe\"\n\n\n-----\n\n| su a e by Co pute );\n// Look for ADFS servers where Named Pipes event are present\nEvent\n| where TimeGenerated > ago(timeframe)\n| where Source == \"Microsoft-Windows-Sysmon\"\n| where Computer in~ (ADFS_Servers)\n| extend RenderedDescription = tostring(split(RenderedDescription, \":\")[0])\n| extend EventData = parse_xml(EventData).DataItem.EventData.Data\n| mv-expand bagexpansion=array EventData\n| evaluate bag_unpack(EventData)\n| extend Key=tostring(['@Name']), Value=['#text']\n| evaluate pivot(Key, any(Value), TimeGenerated, Source, EventLog, Computer, EventLevel, EventLevelName, EventID, UserName,\nRenderedDescription, MG, ManagementGroupName, Type, _ResourceId)\n| extend RuleName = column_ifexists(\"RuleName\", \"\"), TechniqueId = column_ifexists(\"TechniqueId\", \"\"), TechniqueName =\ncolumn_ifexists(\"TechniqueName\", \"\")\n| parse RuleName with * 'technique_id=' TechniqueId ',' * 'technique_name=' TechniqueName\n| where EventID in (17,18)\n// Look for Pipe related to querying the WID\n| where PipeName == \"\\\\MICROSOFT##WID\\\\tsql\\\\query\"\n| extend process = split(Image, '\\\\', -1)[-1]\n// Exclude expected processes\n| where process !in (\"Microsoft.IdentityServer.ServiceHost.exe\", \"Microsoft.Identity.Health.Adfs.PshSurrogate.exe\", \"AzureADConnect.exe\",\n\"Microsoft.Tri.Sensor.exe\", \"wsmprovhost.exe\",\"mmc.exe\", \"sqlservr.exe\")\n| extend Operation = RenderedDescription\n| project-reorder TimeGenerated, EventType, Operation, process, Image, Computer, UserName\n| extend HostCustomEntity = Computer, AccountCustomEntity = UserName\n\nOutside of directly looking for tools, this adversary may have used custom tooling so looking for anomalous process executions or anomalous\naccounts logging on to our ADFS server can give us some clue when such attacks happen. Azure Sentinel provides queries that can help to:\n\nFind [rare anomalous process in your environment.](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SecurityEvent/ProcessEntropy.yaml)\n[Also look for rare processes run by service accounts](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SecurityEvent/RareProcbyServiceAccount.yaml)\n[Or uncommon processes that are in the bottom 5% of all the process.](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SecurityEvent/uncommon_processes.yaml)\nIn some instances, there is a rare command line syntax related to DLL loading, you can adjust these queries to also look at rarity on the\ncommand line.\n\nEvery environment is different and some of these queries being generic could be noisy. So, in the first step a good approach would be to limit\nthis kind of hunting to our ADFS server.\n\n## Azure Active Directory Hunting\n\nHaving gained a significant foothold in the on prem environment, the actor also targeted the Azure AD of some of the compromised\norganizations and made modifications to Azure AD settings to facilitate long term access. Microsoft has shared many relevant queries through\nthe [Azure Sentinel GitHub to identify these actions.](https://github.com/Azure/Azure-Sentinel)\n\nUpdated 01/15/2021\n\nOne such activity is related to modifying domain federation trust settings. A federation trust signifies the establishment of authentication and\nauthorization trust between two organizations so that users located in partner organizations can send authentication and\nauthorization requests successfully.\n\nWhile not specifically seen in this attack, tracking federation trust modifications is important. The Azure Sentinel query for domain\nfederation trust settings modification will alert when a user or application modifies the federation settings on the domain particularly when\na new Active Directory Federated Service (ADFS) Trusted Realm object, such as a signing certificate, is added to the domain or there is\nan update to domain authentication from managed to federated. Modification to domain federation settings should be\nrare and this should be treated as a high-fidelity alert that Azure AD and Azure Sentinel users should follow up on.\n\nUpdated 01/15/2021\n\nThe original purpose of the [STSRefreshTokenModification low severity, hunting-only query was to demonstrate an event that has token validity](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/AuditLogs/StsRefreshTokenModification.yaml)\ntime periods in it and demonstrate how one could monitor for anomalous/edited tokens. We have determined this event will only fire on the\nmanual expiration of the StsRefreshToken by an admin (or the user). These types of events are most often generated when legitimate\nadministrators troubleshoot frequent AAD (Azure AD) user sign-ins. To avoid any confusion with Solorigate investigation and hunting, we have\nremoved this section from the blog.\n\n\n-----\n\not e suc act ty s add g access to t e Se ce c pa o pp cat o a t eat acto obta s access to a pp cat o d st ato\naccount, they may configure alternate authentication mechanisms for direct access to any of the scopes and services available to the Service\nPrincipal. With these privileges, the actor can add alternative authentication material for direct access to resources using this credential.\n\nIdentify where the verify KeyCredential has been updated with [New access credential added to Application or Service Principal.](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AuditLogs/NewAppOrServicePrincipalCredential.yaml)\n\nUpdated 12/20/2020\n\nIdentify where the verify KeyCredential was not present and has now has had its First access credential added to Application or Service\nPrincipal where no credential was present.\n\nSpoiler\n\n**New access credential added to Application or Service Principal**\nlet auditLookback = 1h;\nAuditLogs\n| where TimeGenerated > ago(auditLookback)\n| where OperationName has_any (\"Add service principal\", \"Certificates and secrets management\") // captures \"Add service principal\", \"Add\nservice principal credentials\", and \"Update application – Certificates and secrets management\" events\n| where Result =~ \"success\"\n| mv-expand target = TargetResources\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| extend targetDisplayName = tostring(TargetResources[0].displayName)\n| extend targetId = tostring(TargetResources[0].id)\n| extend targetType = tostring(TargetResources[0].type)\n| extend keyEvents = TargetResources[0].modifiedProperties\n| mv-expand keyEvents\n| where keyEvents.displayName =~ \"KeyDescription\"\n| extend new_value_set = parse_json(tostring(keyEvents.newValue))\n| extend old_value_set = parse_json(tostring(keyEvents.oldValue))\n| where old_value_set != \"[]\"\n| extend diff = set_difference(new_value_set, old_value_set)\n| where isnotempty(diff)\n| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\"\nkeyDisplayName:string \"]\" *\n| where keyUsage == \"Verify\" or keyUsage == \"\"\n| extend UserAgent = iff(AdditionalDetails[0].key == \"User-Agent\",tostring(AdditionalDetails[0].value),\"\")\n| extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName),\ntostring(InitiatedBy.app.displayName))\n| extend InitiatingIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress),\ntostring(InitiatedBy.app.ipAddress))\n// The below line is currently commented out but Azure Sentinel users can modify this query to show only Application or only Service Principal\nevents in their environment\n//| where targetType =~ \"Application\" // or targetType =~ \"ServicePrincipal\"\n| project-away diff, new_value_set, old_value_set\n| project-reorder TimeGenerated, OperationName, InitiatingUserOrApp, InitiatingIpAddress, UserAgent, targetDisplayName, targetId,\ntargetType, keyDisplayName, keyType, keyUsage, keyIdentifier, CorrelationId, TenantId\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingUserOrApp, IPCustomEntity = InitiatingIpAddress\n\n**First access credential added to Application or Service Principal where no credential was present**\nlet auditLookback = 1h;\nAuditLogs\n| where TimeGenerated > ago(auditLookback)\n| where OperationName has_any (\"Add service principal\", \"Certificates and secrets management\") // captures \"Add service principal\", \"Add\nservice principal credentials\", and \"Update application – Certificates and secrets management\" events\n| where Result =~ \"success\"\n| mv-expand target = TargetResources\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| extend targetDisplayName = tostring(TargetResources[0].displayName)\n| extend targetId = tostring(TargetResources[0].id)\n| extend targetType = tostring(TargetResources[0].type)\n| extend keyEvents = TargetResources[0].modifiedProperties\n| mv-expand keyEvents\n| where keyEvents.displayName =~ \"KeyDescription\"\n| t d l t j (t t i (k E t V l ))\n\n\n-----\n\n| e te d o d_ a ue_set pa se_jso (tost g( ey e ts o d a ue))\n| where old_value_set == \"[]\"\n| parse new_value_set with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\"\nkeyDisplayName:string \"]\" *\n| where keyUsage == \"Verify\" or keyUsage == \"\"\n| extend UserAgent = iff(AdditionalDetails[0].key == \"User-Agent\",tostring(AdditionalDetails[0].value),\"\")\n| extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName),\ntostring(InitiatedBy.app.displayName))\n| extend InitiatingIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress),\ntostring(InitiatedBy.app.ipAddress))\n// The below line is currently commented out but Azure Sentinel users can modify this query to show only Application or only Service Principal\nevents in their environment\n//| where targetType =~ \"Application\" // or targetType =~ \"ServicePrincipal\"\n| project-away new_value_set, old_value_set\n| project-reorder TimeGenerated, OperationName, InitiatingUserOrApp, InitiatingIpAddress, UserAgent, targetDisplayName, targetId,\ntargetType, keyDisplayName, keyType, keyUsage, keyIdentifier, CorrelationId, TenantId\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingUserOrApp, IPCustomEntity = InitiatingIpAddress\n\nUpdated 12/19/2020\n\nThis threat actor has been observed using applications to read users mailboxes within a target environment. To help identify this activity\nMSTIC has created a [hunting query that looks for applications that have been granted mailbox read permissions followed by consent to this](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AuditLogs/MailPermissionsAddedToApplication.yaml)\napplication. Whilst this may uncover legitimate applications hunters should validate applications granted mail read permissions genuinely\nrequire them.\n\nSpoiler\nAuditLogs\n| where Category =~ \"ApplicationManagement\"\n| where ActivityDisplayName =~ \"Add delegated permission grant\"\n| where Result =~ \"success\"\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| extend props = parse_json(tostring(TargetResources[0].modifiedProperties))\n| mv-expand props\n| extend UserAgent = tostring(AdditionalDetails[0].value)\n| extend InitiatingUser = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n| extend UserIPAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)\n| extend DisplayName = tostring(props.displayName)\n| extend Permissions = tostring(parse_json(tostring(props.newValue)))\n| where Permissions has_any (\"Mail.Read\", \"Mail.ReadWrite\")\n| extend PermissionsAddedTo = tostring(TargetResources[0].displayName)\n| extend Type = tostring(TargetResources[0].type)\n| project-away props\n| join kind=leftouter(\nAuditLogs\n| where ActivityDisplayName has \"Consent to application\"\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend AppId = tostring(TargetResources[0].id)\n| project AppName, AppId, CorrelationId) on CorrelationId\n| project-reorder TimeGenerated, OperationName, InitiatingUser, UserIPAddress, UserAgent, PermissionsAddedTo, Permissions, AppName,\nAppId, CorrelationId\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingUser, IPCustomEntity = UserIPAddress\n\nIt’s also advised to hunt for application consents for unexpected applications, particularly where they provide offline access to data or other\nhigh value access;\n\n[Suspicious application consent similar to O365 Attack Toolkit](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AuditLogs/MaliciousOAuthApp_O365AttackToolkit.yaml)\n[Suspicious application consent for offline access](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/AuditLogs/SuspiciousOAuthApp_OfflineAccess.yaml)\n\nUpdated 12/17/2020 (moved location)\n\nIn addition to Azure AD pre-compromise logon hunting it is also possible to monitor for logons attempting to use invalid key material. This can\nhelp identify attempted logons using stolen key material made after key material has been rotated. This can be done by querying SigninLogs in\nAzure Sentinel where the ResultType is 5000811. Please note that if you roll your token signing certificate, there will be expected activity when\nsearching on the above.\n\n## Recon and Remote Execution\n\n\n-----\n\nUpdated / / 0 0\n\nThe adversary will often attempt to access on-prem systems to gain further insight and mapping of the environment. As described in the\n**Resulting hands-on-keyboard attack section of the** [Analyzing Solorigate blog by Microsoft, attackers renamed windows administrative tools](https://www.microsoft.com/security/blog/2020/12/18/analyzing-solorigate-the-compromised-dll-file-that-started-a-sophisticated-cyberattack-and-how-microsoft-defender-helps-protect/)\nlike adfind.exe which were then used for domain enumeration. An example of the process execution command like can look like this:\n\nC:\\Windows\\system32\\cmd.exe /C csrss.exe -h breached.contoso.com -f (name=”Domain Admins”) member -list | csrss.exe -h\nbreached.contoso.com -f objectcategory=* > .\\Mod\\mod1.log\n\n[We have provided a query in the Azure Sentinel Github which will help in detecting the command line patterns related to ADFind usage. You](https://github.com/Azure/Azure-Sentinel)\ncan customize this query to look at your specific DC/ADFS servers.\n\nSpoiler\nlet startdate = 1d;\nlet lookupwindow = 2m;\nlet threshold = 3; //number of commandlines in the set below\nlet DCADFSServersList = dynamic ([\"DCServer01\", \"DCServer02\", \"ADFSServer01\"]); // Enter a reference list of hostnames for your DC/ADFS\nservers\nlet tokens = dynamic([\"objectcategory\",\"domainlist\",\"dcmodes\",\"adinfo\",\"trustdmp\",\"computers_pwdnotreqd\",\"Domain Admins\",\n\"objectcategory=person\", \"objectcategory=computer\", \"objectcategory=*\"]);\nSecurityEvent\n//| where Computer in (DCADFSServersList) // Uncomment to limit it to your DC/ADFS servers list if specified above or any pattern in\nhostnames (startswith, matches regex, etc).\n| where TimeGenerated between (ago(startdate) .. now())\n| where EventID == 4688\n| where CommandLine has_any (tokens)\n| where CommandLine matches regex \"(.*)>(.*)\"\n| summarize Commandlines = make_set(CommandLine), LastObserved=max(TimeGenerated) by bin(TimeGenerated, lookupwindow),\nAccount, Computer, ParentProcessName, NewProcessName\n| extend Count = array_length(Commandlines)\n| where Count > threshold\n\nOn the remote execution side, there is a pattern that can be identified related to using alternate credentials than the currently logged on user,\nsuch as when using the RUN AS feature on a Windows system and passing in explicit credentials. We have released a query that will identify\n[when execution is occurring via multiple explicit credentials against remote targets. This requires that Windows Event 4648 is being collected](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SecurityEvent/MultipleExplicitCredentialUsage4648Events.yaml)\nas part of Azure Sentinel.\n\nSpoiler\nlet WellKnownLocalSIDs = \"S-1-5-[0-9][0-9]$\";\nlet protocols = dynamic(['cifs', 'ldap', 'RPCSS', 'host', 'HTTP', 'RestrictedKrbHost', 'TERMSRV', 'msomsdksvc', 'mssqlsvc']);\nSecurityEvent\n| where TimeGenerated >= ago(1d)\n| where EventID == 4648\n| where SubjectUserSid != 'S-1-0-0' // this is the Nobody SID which really means No security principal was included.\n| where not(SubjectUserSid matches regex WellKnownLocalSIDs) //excluding system account/service account as this is generally normal\n| where TargetInfo has '/' //looking for only items that indicate an interesting protocol is included\n| where Computer !has tostring(split(TargetServerName,'$')[0])\n| where TargetAccount !~ tostring(split(SubjectAccount,'$')[0])\n| extend TargetInfoProtocol = tolower(split(TargetInfo, '/')[0]), TargetInfoMachine = toupper(split(TargetInfo, '/')[1])\n| extend TargetAccount = tolower(TargetAccount), SubjectAccount = tolower(SubjectAccount)\n| extend UncommonProtocol = case(not(TargetInfoProtocol has_any (protocols)), TargetInfoProtocol, 'NotApplicable')\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), AccountsUsedCount = dcount(TargetAccount),\nAccountsUsed = make_set(TargetAccount), TargetMachineCount = dcount(TargetInfoMachine),\nTargetMachines = make_set(TargetInfoMachine), TargetProtocols = dcount(TargetInfoProtocol), Protocols = make_set(TargetInfoProtocol),\nProcesses = make_set(Process) by Computer, SubjectAccount, UncommonProtocol\n| where TargetMachineCount > 1 or UncommonProtocol != 'NotApplicable'\n| extend ProtocolCount = array_length(Protocols)\n| extend ProtocolScore = case(\nProtocols has 'rpcss' and Protocols has 'host' and Protocols has 'cifs', 10, //observed in Solorigate and depending on which are used together\nthe higher the score\nProtocols has 'rpcss' and Protocols has 'host', 5,\nProtocols has 'rpcss' and Protocols has 'cifs', 5,\nProtocols has 'host' and Protocols has 'cifs', 5,\nProtocols has 'ldap' or Protocols has 'rpcss' or Protocols has 'host' or Protocols has 'cifs', 1, //ldap is more commonly seen in general, this was\n\n\n-----\n\na so see t So o gate but ot usua y to t e sa e ac es as t e ot e s abo e\nUncommonProtocol != 'NotApplicable', 3,\n0 //other protocols may be of interest, but in relation to observations for enumeration/execution in Solorigate they receive 0\n)\n| extend Score = ProtocolScore + ProtocolCount + AccountsUsedCount\n| where Score >= 9 or (UncommonProtocol != 'NotApplicable' and Score >= 4) // Score must be 9 or better as this will include 5 points for\natleast 2 of the interesting protocols + the count of protocols (min 2) + the number of accounts used for execution (min 2) = min of 9 OR score\nmust be 4 or greater for an uncommon protocol\n| extend TimePeriod = EndTime - StartTime //This identifies the time between start and finish for the use of the explicit credentials, shorter time\nperiod may indicate scripted executions\n| project-away UncommonProtocol\n| extend timestamp = StartTime, AccountCustomEntity = SubjectAccount, HostCustomEntity = Computer\n| order by Score desc\n\n## Data Access\n\nAccessing confidential data is one of the primary motives of this attack. Data access for the attacker here relied on leveraging minted SAML\ntokens to access user files/email stored in the cloud via compromised AppIds. One way to detect this is when a user or application signs in\nusing [Azure Active Directory PowerShell to access non-Active Directory resources.](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SigninLogs/AzureAADPowerShellAnomaly.yaml)\n\nMicrosoft Graph is one way that the attacker may be seen accessing resources and can help find what the attacker may have accessed using\nthe Service principal Azure Active Directory sign-in logs. If you have data in your Log analytics you could easily plot a chart to see what\nanomalous activity is happening in your environment that is leveraging the graph.\n\nUpdated 12/17/2020\n\n**Note that this data type in Azure Sentinel below is only available when additional Diagnostic Logging is enabled on the workspace. Please**\nsee the instructions in the expandable section below.\n\nSpoiler\n\nThe AADServicePrincipalSigninLogs datatype will not be available in Azure Sentinel unless it is configured under Diagnostic Settings. Please\nsee screenshots below the query.\n\nAADServicePrincipalSignInLogs\n\n| where TimeGenerated > ago(90d)\n\n| where ResourceDisplayName == \"Microsoft Graph\"\n\n| where ServicePrincipalId == \"524c43c4-c484-4f7a-bd44-89d4a0d8aeab\"\n\n| summarize count() by bin(TimeGenerated, 1h)\n\n| render timechart\n\nTo enable Service Principal Signin Logging, do the following:\n\n\n-----\n\nUpdated 12/21/2020\n\nAdditionally, below is a sample query that brings out some of the logons to Azure AD where multi factor authentication was satisfied by token\nbased logons versus MFA via phone auth or the like. It is possible this could produce many results, so additional tuning is suggested for your\nenvironment.\n\nSpoiler\nSigninLogs\n\n| where TimeGenerated > ago(30d)\n\n| where ResultType == 0\n\n| extend additionalDetails = tostring(Status.additionalDetails)\n\n| summarize make_set(additionalDetails), min(TimeGenerated), max(TimeGenerated) by IPAddress, UserPrincipalName\n\n\n-----\n\n| e e a ay_ e gt (set_add t o a eta s)\n| where (set_additionalDetails[1] == \"MFA requirement satisfied by claim in the token\" and set_additionalDetails[0] == \"MFA requirement\nsatisfied by claim provided by external provider\") or (set_additionalDetails[0] == \"MFA requirement satisfied by claim in the token\" and\nset_additionalDetails[1] == \"MFA requirement satisfied by claim provided by external provider\")\n//| project IPAddress, UserPrincipalName, min_TimeGenerated, max_TimeGenerated\n\nUPDATED 12/17/2020\n\nThis attack also used Virtual Private Servers (VPS) hosts to access victim networks and can be used in conjunction with the query above. Both\nMSTIC and FireEye have reported attacker logon events coming from network ranges associated with VPS providers. In order to highlight\n[these logons, MSTIC has created a new hunting query - Signins From VPS Providers - that looks for successful signins from network ranges](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SigninLogs/Signins-From-VPS-Providers.yaml)\nassociated with VPS providers. This is joined with the above query, the new query looks for IPs that only display sign-ins based on tokens and\nnot other MFA options, although this could be removed if wanted. The list of VPS ranges in the query is not comprehensive and there is\nsignificant potential for false positives so results should be investigated before responding, however it can provide very effective signal.\nCombining the query below with data that list VPS server ranges will make this a high-confidence hunting query.\n\nIn relation to the VPS servers section above, the previously mentioned workbook has a section that shows successful user signins from VPS\n[(Virtual Private Server) providers where only tokens were used to authenticate. This uses the new KQL operator ipv4_lookup to evaluate if a](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/ipv4-lookup-plugin)\nlogin came from a known VPS provider network range. This operator can alternatively be used to look for all logons not coming from known\nranges should your environment have a common logon source.\n\n## Data Exfiltration\n\nUpdated 12/20/2020\n\nEmail data has been observed as a target for the Solorigate attackers, one way to monitor for potential suspicious access is to look for\nanomalous MailItemsAccessed volumes. MSTIC has created a specific hunting query to identify Anomolous User Accessing Other Users\nMailbox which can help to identify malicious activity related to this attack. Additionally, MSTIC previously created a more generic detection [Exchange workflow MailItemsAccessed operation anomaly - which looks for time series based anomalies in MailItemsAccessed events in](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/OfficeActivity/MailItemsAccessedTimeSeries.yaml)\nthe OfficeActivity log.\n\nSpoiler\n\n**Anomalous access to other user's mailboxes**\n\nlet timeframe = 14d;\n\nlet user_threshold = 1;\n\nlet folder_threshold = 5;\n\nOfficeActivity\n\n| where TimeGenerated > ago(timeframe)\n\n| where Operation =~ \"MailItemsAccessed\"\n\n| where ResultStatus =~ \"Succeeded\"\n\n| mv-expand parse_json(Folders)\n\n| extend folders = tostring(Folders.Path)\n\n| where tolower(MailboxOwnerUPN) != tolower(UserId)\n\n| extend ClientIP = iif(Client_IPAddress startswith \"[\", extract(\"\\\\[([^\\\\]]*)\", 1, Client_IPAddress), Client_IPAddress)\n\n| summarize make_set(folders), make_set(ClientInfoString), make_set(ClientIP), make_set(MailboxGuid), make_set(MailboxOwnerUPN) by\nUserId\n\n| extend folder_count = array_length(set_folders)\n\n| extend user_count = array_length(set_MailboxGuid)\n\n| where user_count > user_threshold or folder_count > folder_threshold\n\n| sort by user_count desc\n\n| project-reorder UserId, user_count, folder_count, set_MailboxOwnerUPN, set_ClientIP, set_ClientInfoString, set_folder\n\n**Exchange workflow MailItemsAccessed operation anomaly**\n\nlet starttime = 14d;\n\nlet endtime = 1d;\n\nlet timeframe = 1h;\n\nlet scorethreshold = 1.5;\n\nlet percentthreshold = 50;\n\n// Preparing the time series data aggregated hourly count of MailItemsAccessd Operation in the form of multi-value array to use with time\nseries anomaly function.\n\nlet TimeSeriesData =\n\nOfficeActivity\n\n| where TimeGenerated between (startofday(ago(starttime))..startofday(ago(endtime)))\n\n| where OfficeWorkload=~ \"Exchange\" and Operation =~ \"MailItemsAccessed\" and ResultStatus =~ \"Succeeded\"\n\n| project TimeGenerated, Operation, MailboxOwnerUPN\n\n\n-----\n\n| a e se es ota cou t() o eGe e ated o sta to day(ago(sta tt e)) to sta to day(ago(e dt e)) step t e a e;\nlet TimeSeriesAlerts = TimeSeriesData\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Total, scorethreshold, -1, 'linefit')\n| mv-expand Total to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to\ntypeof(long)\n| where anomalies > 0\n| project TimeGenerated, Total, baseline, anomalies, score;\n// Joining the flagged outlier from the previous step with the original dataset to present contextual information\n// during the anomalyhour to analysts to conduct investigation or informed decisions.\nTimeSeriesAlerts | where TimeGenerated > ago(2d)\n// Join against base logs since specified timeframe to retrive records associated with the hour of anomoly\n| join (\nOfficeActivity\n| where TimeGenerated > ago(2d)\n| where OfficeWorkload=~ \"Exchange\" and Operation =~ \"MailItemsAccessed\" and ResultStatus =~ \"Succeeded\"\n) on TimeGenerated\nUpdated 12/19/2020\n\n[Targeting of email data has also been observed by other industry members including Volexity who reported attackers using PowerShell](https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/)\ncommands to export on premise Exchange mailboxes and then hosting those files on OWA servers in order to exfiltrate them.\n\n[MSTIC has created detections to identify this activity at both the OWA server and](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/W3CIISLog/SuspectedMailBoxExportHostonOWA.yaml) [attacking host level through IIS logs, and PowerShell](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SecurityEvent/HostExportingMailboxAndRemovingExport.yaml)\ncommand line logging.\n\nOWA exfiltration:\n\nSpoiler\nlet excludeIps = dynamic([\"127.0.0.1\", \"::1\"]);\nlet scriptingExt = dynamic([\"aspx\", \"ashx\", \"asp\"]);\nW3CIISLog\n| where csUriStem contains \"/owa/\"\n//The actor pulls a file back but won't send it any URI params\n| where isempty(csUriQuery)\n| extend file_ext = tostring(split(csUriStem, \".\")[-1])\n//Giving your file a known scripting extension will throw an error\n//rather than just serving the file as it will try to interpret the script\n| where file_ext !in~ (scriptingExt)\n//The actor was seen using image files, but we go wider in case they change this behaviour\n//| where file_ext in~ (\"jpg\", \"jpeg\", \"png\", \"bmp\")\n| extend file_name = tostring(split(csUriStem, \"/\")[-1])\n| where file_name != \"\"\n| where cIP !in~ (excludeIps)\n| project file_ext, csUriStem, file_name, Computer, cIP, sIP, TenantId, TimeGenerated\n| summarize dcount(cIP), AccessingIPs=make_set(cIP), AccessTimes=make_set(TimeGenerated), Access=count() by TenantId, file_name,\nComputer, csUriStem\n//Collection of the exfiltration will occur only once, lets check for 2 accesses in case they mess up\n//Tailor this for hunting\n| where Access <= 2 and dcount_cIP == 1\n\nHost creating then removing mailbox export requests using PowerShell cmdlets:\n\nSpoiler\n// Adjust the timeframe to change the window events need to occur within to alert\n\nlet timeframe = 1h;\n\nSecurityEvent\n\n| where Process in (\"powershell.exe\", \"cmd.exe\")\n\n| where CommandLine contains 'New-MailboxExportRequest'\n\n| summarize by Computer, timekey = bin(TimeGenerated, timeframe), CommandLine, SubjectUserName\n\n| join kind=inner (SecurityEvent\n\n| where Process in (\"powershell.exe\", \"cmd.exe\")\n\n\n-----\n\n| e e Co a d e co ta s e o e a bo po t equest\n\n| summarize by Computer, timekey = bin(TimeGenerated, timeframe), CommandLine, SubjectUserName) on Computer, timekey,\nSubjectUserName\n\n| extend commands = pack_array(CommandLine1, CommandLine)\n\n| summarize by timekey, Computer, tostring(commands), SubjectUserName\n\n| project-reorder timekey, Computer, SubjectUserName, ['commands']\n\n| extend HostCustomEntity = Computer, AccountCustomEntity = SubjectUserName\n\nUpdated 12/28/2020\n\nEmail Delegation and later delegate access is another tactic that has been observed to gain access to user's mailboxes. We have a previously\n[created a method to discover Non-owner mailbox login activity that can be applied here to help identify when delegates are inappropriately](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/OfficeActivity/nonowner_MailboxLogin.yaml)\naccess email.\n\nSpoiler\nlet timeframe = 1d;\nOfficeActivity\n| where TimeGenerated >= ago(timeframe)\n| where Operation == \"MailboxLogin\" and Logon_Type != \"Owner\"\n| summarize count(), min(TimeGenerated), max(TimeGenerated) by Operation, OrganizationName, UserType, UserId, MailboxOwnerUPN,\nLogon_Type\n| extend timestamp = min_TimeGenerated, AccountCustomEntity = UserId\n\n## Domain Hunting\n\nUpdated 12/17/2020\n\n**Domain specific**\n\n[MSTIC has collated network based IoCs from MSTIC,](https://blogs.microsoft.com/on-the-issues/2020/12/13/customers-protect-nation-state-cyberattacks/) [FireEye and](https://github.com/fireeye/sunburst_countermeasures/blob/main/indicator_release/Indicator_Release_NBIs.csv) [Volexity to create a network based IoC detection - Solorigate Network](https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/)\nBeacon - that leverage multiple network focused data sources within Azure Sentinel.\n\nSpoiler\nlet domains =\ndynamic([\"incomeupdate.com\",\"zupertech.com\",\"databasegalore.com\",\"panhardware.com\",\"avsvmcloud.com\",\"digitalcollege.org\",\"freescanonline.c\nlet timeframe = 6h;\n\n(union isfuzzy=true\n\n(CommonSecurityLog\n\n| where TimeGenerated >= ago(timeframe)\n\n| parse Message with * '(' DNSName ')' *\n| where DNSName in~ (domains) or DestinationHostName has_any (domains) or RequestURL has_any(domains)\n\n| extend AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName, IPCustomEntity = SourceIP\n\n),\n\n(DnsEvents\n\n| where TimeGenerated >= ago(timeframe)\n\n| extend DNSName = Name\n\n| where isnotempty(DNSName)\n\n| where DNSName in~ (domains)\n\n| extend IPCustomEntity = ClientIP\n\n),\n\n(VMConnection\n\n| where TimeGenerated >= ago(timeframe)\n\n| parse RemoteDnsCanonicalNames with * '[\"' DNSName '\"]' *\n\n| where isnotempty(DNSName)\n\n| where DNSName in~ (domains)\n\n| extend IPCustomEntity = RemoteIp\n\n),\n\n(DeviceNetworkEvents\n\n| where TimeGenerated >= ago(timeframe)\n\n| where isnotempty(RemoteUrl)\n\n| where RemoteUrl has_any (domains)\n\n| extend DNSName = RemoteUrl\n\n\n-----\n\n| e te d Custo t ty e ote\n| extend HostCustomEntity = DeviceName\n)\n)\n\n**Domain DGA**\n\nThe avsvmcloud[.]com has been observed by several organizations as making DGA like subdomain queries as part of C2 activities. MSTIC\n[have generated a hunting query - Solorigate DNS Pattern - to look for similar patterns of activity from other domains that might help identify](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/DnsEvents/Solorigate-DNS-Pattern.yaml)\nother potential C2 sources.\n\nSpoiler\nlet cloudApiTerms = dynamic([\"api\", \"east\", \"west\"]);\n\nDnsEvents\n\n| where IPAddresses != \"\" and IPAddresses != \"127.0.0.1\"\n\n| where Name endswith \".com\" or Name endswith \".org\" or Name endswith \".net\"\n\n| extend domain_split = split(Name, \".\")\n\n| where tostring(domain_split[-5]) != \"\" and tostring(domain_split[-6]) == \"\"\n\n| extend sub_domain = tostring(domain_split[0])\n\n| where sub_domain !contains \"-\"\n\n| extend sub_directories = strcat(domain_split[-3], \" \", domain_split[-4])\n\n| where sub_directories has_any(cloudApiTerms)\n\n//Based on sample communications the subdomain is always between 20 and 30 bytes\n\n| where strlen(domain_split) < 32 or strlen(domain_split) > 20\n\n| extend domain = strcat(tostring(domain_split[-2]), \".\", tostring(domain_split[-1]))\n\n| extend subdomain_no = countof(sub_domain, @\"(\\d)\", \"regex\")\n\n| extend subdomain_ch = countof(sub_domain, @\"([a-z])\", \"regex\")\n\n| where subdomain_no > 1\n\n| extend percentage_numerical = toreal(subdomain_no) / toreal(strlen(sub_domain)) * 100\n\n| where percentage_numerical < 50 and percentage_numerical > 5\n\n| summarize count(), make_set(Name), FirstSeen=min(TimeGenerated), LastSeen=max(TimeGenerated) by Name\n\n| order by count_ asc\n\n**Encoded Domain**\n\n[In addition we have another query - Solorigate Encoded Domain in URL- that takes the encoding pattern the DGA uses, encodes the domains](https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/DnsEvents/Solorigate-Encoded-Domain-URL.yaml)\nseen in signin logs and then looks for those patterns in DNS logs. This can help identify other C2 domains using the same encoding scheme.\n\nSpoiler\nlet dictionary =\ndynamic([\"r\",\"q\",\"3\",\"g\",\"s\",\"a\",\"l\",\"t\",\"6\",\"u\",\"1\",\"i\",\"y\",\"f\",\"z\",\"o\",\"p\",\"5\",\"7\",\"2\",\"d\",\"4\",\"9\",\"b\",\"n\",\"x\",\"8\",\"c\",\"v\",\"m\",\"k\",\"e\",\"w\",\"h\",\"j\"]);\n\nlet regex_bad_domains = SigninLogs\n\n//Collect domains from tenant from signin logs\n\n| where TimeGenerated > ago(1d)\n\n| extend domain = tostring(split(UserPrincipalName, \"@\", 1)[0])\n\n| where domain != \"\"\n\n| summarize by domain\n\n| extend split_domain = split(domain, \".\")\n\n//This cuts back on domains such as na.contoso.com by electing not to match on the \"na\" portion\n\n| extend target_string = iff(strlen(split_domain[0]) <= 2, split_domain[1], split_domain[0])\n\n| extend target_string = split(target_string, \"-\")\n\n| mv-expand target_string\n\n//Rip all of the alphanumeric out of the domain name\n\n| extend string_chars = extract_all(@\"([a-z0-9])\", tostring(target_string))\n\n//Guid for tracking our data\n\n| extend guid = new_guid()\n\n//Expand to get all of the individual chars from the domain\n| mv-expand string_chars\n| extend chars = tostring(string_chars)\n\n//Conduct computation to encode the domain as per actor spec\n\n| extend computed_char = array_index_of(dictionary, chars)\n\n| extend computed_char = dictionary[(computed_char + 4) % array_length(dictionary)]\n\n| summarize make_list(computed_char) by guid, domain\n\n| extend target_encoded = tostring(strcat_array(list_computed_char, \"\"))\n\n//These are probably too small, but can be edited (expect FP's when going too small)\n\n| where strlen(target encoded) > 5\n\n\n-----\n\n| d st ct ta get_e coded\n| summarize make_set(target_encoded)\n//Key to join to DNS\n| extend key = 1;\nDnsEvents\n| where TimeGenerated > ago(1d)\n| summarize by Name\n| extend key = 1\n//For each DNS query join the malicious domain list\n| join kind=inner (\nregex_bad_domains\n) on key\n| project-away key\n//Expand each malicious key for each DNS query observed\n| mv-expand set_target_encoded\n//IndexOf allows us to fuzzy match on the substring\n| extend match = indexof(Name, set_target_encoded)\n| where match > -1\n\n## Security Service Tampering\n\nUpdated 01/19/2021\n\nThere has been additional indication that security services are being tampered with to hinder detection and investigation. While this is a\ncommon tactic, we felt that we should include this reference. The query is currently written specifically for Potential Microsoft security services\ntampering, but can easily be adapted to identify other security services.\n\nSpoiler\nlet includeProc = dynamic([\"sc.exe\",\"net1.exe\",\"net.exe\", \"taskkill.exe\", \"cmd.exe\", \"powershell.exe\"]);\n\nlet action = dynamic([\"stop\",\"disable\", \"delete\"]);\n\nlet service1 = dynamic(['sense', 'windefend', 'mssecflt']);\n\nlet service2 = dynamic(['sense', 'windefend', 'mssecflt', 'healthservice']);\n\nlet params1 = dynamic([\"-DisableRealtimeMonitoring\", \"-DisableBehaviorMonitoring\",\"-DisableIOAVProtection\"]);\n\nlet params2 = dynamic([\"sgrmbroker.exe\", \"mssense.exe\"]);\n\nlet regparams1 = dynamic(['reg add \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\"', 'reg add\n\"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Advanced Threat Protection\"']);\n\nlet regparams2 = dynamic(['ForceDefenderPassiveMode', 'DisableAntiSpyware']);\n\nlet regparams3 = dynamic(['sense', 'windefend']);\n\nlet regparams4 = dynamic(['demand', 'disabled']);\n\nlet regparams5 = dynamic(['reg add \"HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\services\\\\HealthService\"', 'reg add\n\"HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\Sense\"', 'reg add \"HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\WinDefend\"', 'reg add\n\"HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\MsSecFlt\"', 'reg add \"HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\DiagTrack\"', 'reg add\n\"HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\SgrmBroker\"', 'reg add \"HKLMSYSTEM\\\\CurrentControlSet\\\\Services\\\\SgrmAgent\"', 'reg add\n\"HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\AATPSensorUpdater\"', 'reg add\n\"HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\AATPSensor\"', 'reg add \"HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\mpssvc\"']);\n\nlet regparams6 = dynamic(['/d 4','/d \"4\"','/d 0x00000004']);\nlet regparams7 = dynamic(['/d 1','/d \"1\"','/d 0x00000001']);\nlet timeframe = 1d;\n\n(union isfuzzy=true\n\n(\n\nSecurityEvent\n\n| where TimeGenerated >= ago(timeframe)\n\n| where EventID == 4688\n\n| extend ProcessName = tostring(split(NewProcessName, '\\\\')[-1])\n\n| where ProcessName in~ (includeProc)\n\n| where (CommandLine has_any (action) and CommandLine has_any (service1))\n\nor (CommandLine has_any (params1) and CommandLine has 'Set-MpPreference' and CommandLine has '$true')\n\nor (CommandLine has_any (params2) and CommandLine has \"/IM\")\n\nor (CommandLine has_any (regparams5) and CommandLine has 'Start' and CommandLine has_any (regparams6))\n\nor (CommandLine has_any (regparams1) and CommandLine has_any (regparams2) and CommandLine has_any (regparams7))\nor (CommandLine has \"start\" and CommandLine has \"config\" and CommandLine has_any (regparams3) and CommandLine has_any\n(regparams4))\n\n| project TimeGenerated, Computer, Account, AccountDomain, ProcessName, ProcessNameFullPath = NewProcessName, EventID, Activity,\nCommandLine, EventSourceName, Type\n\n)\n\n\n-----\n\n(\nEvent\n| where TimeGenerated >= ago(timeframe)\n| where Source =~ \"Microsoft-Windows-SENSE\"\n| where EventID == 87 and ParameterXml in (\"<Param>sgrmbroker</Param>\", \"<Param>WinDefend</Param>\")\n| project TimeGenerated, Computer, Account = UserName, EventID, Activity = RenderedDescription, EventSourceName = Source, Type\n),\n(\nDeviceProcessEvents\n| where TimeGenerated >= ago(timeframe)\n| where InitiatingProcessFileName in~ (includeProc)\n| where (InitiatingProcessCommandLine has_any(action) and InitiatingProcessCommandLine has_any (service2) and\nInitiatingProcessParentFileName != 'cscript.exe')\nor (InitiatingProcessCommandLine has_any (params1) and InitiatingProcessCommandLine has 'Set-MpPreference' and\nInitiatingProcessCommandLine has '$true')\nor (InitiatingProcessCommandLine has_any (params2) and InitiatingProcessCommandLine has \"/IM\")\nor ( InitiatingProcessCommandLine has_any (regparams5) and InitiatingProcessCommandLine has 'Start' and InitiatingProcessCommandLine\nhas_any (regparams6))\nor (InitiatingProcessCommandLine has_any (regparams1) and InitiatingProcessCommandLine has_any (regparams2) and\nInitiatingProcessCommandLine has_any (regparams7))\nor (InitiatingProcessCommandLine has_any(\"start\") and InitiatingProcessCommandLine has \"config\" and InitiatingProcessCommandLine\nhas_any (regparams3) and InitiatingProcessCommandLine has_any (regparams4))\n| extend Account = iff(isnotempty(InitiatingProcessAccountUpn), InitiatingProcessAccountUpn, InitiatingProcessAccountName), Computer =\nDeviceName\n| project TimeGenerated, Computer, Account, AccountDomain, ProcessName = InitiatingProcessFileName, ProcessNameFullPath =\nFolderPath, Activity = ActionType, CommandLine = InitiatingProcessCommandLine, Type, InitiatingProcessParentFileName\n)\n)\n| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer\n\n## Microsoft M365 Defender + Azure Sentinel detection correlation\n\nIn addition we have created a query in Azure Sentinel - [Solorigate Defender Detections - to collate the range of Defender detections that are](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityAlert/Solorigate-Defender-Detections.yaml)\nnow deployed. This query can be used to get an overview of such alerts and the hosts they relate to.\n\nSpoiler\nDeviceInfo\n\n| extend DeviceName = tolower(DeviceName)\n\n| join (SecurityAlert\n\n| where ProviderName =~ \"MDATP\"\n\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n\n| where ThreatName has \"Solarigate\"\n\n| extend HostCustomEntity = tolower(CompromisedEntity)\n\n| take 10) on $left.DeviceName == $right.HostCustomEntity\n\n| project TimeGenerated, DisplayName, ThreatName, CompromisedEntity, PublicIP, MachineGroup, AlertSeverity, Description,\nLoggedOnUsers, DeviceId, TenantId\n\n| extend timestamp = TimeGenerated, IPCustomEntity = PublicIP\n\n## Conclusion\n\nAdditionally, as a cloud native SIEM Azure Sentinel can not only collect raw data from various disparate logs but it also gets alerts from various\nsecurity products. For example, M365 Defender has a range of alerts for various attack components like SolarWinds malicious binaries,\nnetwork traffic to the compromised domains, DNS queries for known patterns associated with SolarWinds compromise that can flow into\nSentinel. Combining these alerts with other raw logs and additional data sources provides the security team with additional insights as well as\na complete picture of nature and the scope of attack.\n\n## Appendix\n\n[Many of these queries have been incorporated into the related hunting workbook.](https://github.com/Azure/Azure-Sentinel/blob/master/Workbooks/SolarWindsPostCompromiseHunting.json)\n\nList of all Azure Sentinel Queries from each section\n\nUpdated 01/15/2021\n\nSpoiler\n\n\n-----\n\n**Gaining a foothold**\n\nSolarWinds Inventory check query https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/MultipleDataSources/SolarWinds...\n\nSolorigate Name Pipe https://github.com/Azure/AzureSentinel/blob/master/Detections/SecurityEvent/SolorigateNamedPipe.yam...\n\n**Privilege Escalation**\n\nHosts with new logons https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/SecurityEvent/HostsWithNewLogo...\n\n\nNew user created and added to the built-in administrators\ngroup\n\nUser account added to built in domain local or global\ngroup\n\n\nhttps://github.com/Azure/AzureSentinel/blob/master/Detections/SecurityEvent/UserCreatedAddedToBuilt...\n\nhttps://github.com/Azure/AzureSentinel/blob/master/Detections/SecurityEvent/UserAccountAddedToPrivl...\n\n\nTracking Privileged Account Rare Activity https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/MultipleDataSources/TrackingPr...\n\n**ADFS Key Extraction**\n\nADFS DKM Master Key Export https://github.com/Azure/AzureSentinel/blob/master/Detections/MultipleDataSources/ADFS-DKM-MasterKe...\n\nADFS Key Export (Sysmon) https://github.com/Azure/AzureSentinel/blob/master/Detections/SecurityEvent/ADFSKeyExportSysmon.yam...\n\nEntropy for Processes for a given Host https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/SecurityEvent/ProcessEntropy.y...\n\nRare processes run by Service accounts https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/SecurityEvent/RareProcbyServic...\n\nUncommon processes - bottom 5% https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/SecurityEvent/uncommon_process...\n\n**Azure Active Directory**\n\nModified domain federation trust settings https://github.com/Azure/AzureSentinel/blob/master/Detections/AuditLogs/ADFSDomainTrustMods.yaml\n\n\nNew access credential added to Application or Service\nPrincipal\n\nFirst access credential added to Application or Service\nPrincipal where no credential was present\n\n\nhttps://github.com/Azure/AzureSentinel/blob/master/Detections/AuditLogs/NewAppOrServicePrincipalCre...\n\nhttps://github.com/Azure/AzureSentinel/blob/master/Detections/AuditLogs/FirstAppOrServicePrincipalC...\n\n\nMail.Read Permissions Granted to Application https://github.com/Azure/AzureSentinel/blob/master/Detections/AuditLogs/MailPermissionsAddedToAppli...\n\n\nSuspicious application consent similar to O365 Attack\nToolkit\n\n\nhttps://github.com/Azure/AzureSentinel/blob/master/Detections/AuditLogs/MaliciousOAuthApp_O365Attac...\n\n\nSuspicious application consent for offline access https://github.com/Azure/AzureSentinel/blob/master/Detections/AuditLogs/SuspiciousOAuthApp_OfflineA...\n\n**Recon and Remote Execution**\n\nSuspicious enumeration using Adfind tool https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/SecurityEvent/Suspicious_enume...\n\nMultiple explicit credential usage - 4648 events https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/SecurityEvent/MultipleExplicit...\n\n**Data Access**\n\n\nAzure Active Directory PowerShell accessing non-AAD\nresources\n\n\nhttps://github.com/Azure/AzureSentinel/blob/master/Detections/SigninLogs/AzureAADPowerShellAnomaly....\n\n\nSignins From VPS Providers https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/SigninLogs/Signins-From-VPS-Pr...\n\n**Data Exfiltration**\n\n\n-----\n\nAnomalous access to other user's mailboxes https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/OfficeActivity/AnomolousUserAc...\n\n\nExchange workflow MailItemsAccessed operation\nanomaly\n\n\nhttps://github.com/Azure/AzureSentinel/blob/master/Detections/OfficeActivity/MailItemsAccessedTimeS...\n\n\nSuspect Mailbox Export on IIS/OWA https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/W3CIISLog/SuspectedMailBoxExpo...\n\nHost Exporting Mailbox and Removing Export https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/SecurityEvent/HostExportingMai...\n\nNon-owner mailbox login activity https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/OfficeActivity/nonowner_Mailbo...\n\n**Domain Hunting**\n\nSolorigate Network Beacon https://github.com/Azure/AzureSentinel/blob/master/Detections/MultipleDataSources/Solorigate-Networ...\n\nSolorigate DNS Pattern https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/DnsEvents/Solorigate-DNS-Patte...\n\nSolorigate Encoded Domain in URL https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/DnsEvents/Solorigate-Encoded-D...\n\n**Security Service Tampering**\n\nPotential Microsoft security services tampering https://github.com/Azure/AzureSentinel/blob/master/Hunting%20Queries/MultipleDataSources/PotentialM...\n\n**M365+Sentinel**\n\nSolorigate Defender Detections https://github.com/Azure/AzureSentinel/blob/master/Detections/SecurityAlert/Solorigate-Defender-Det...\n\n## References\n\n[Recent Nation-State Cyber Attacks](https://blogs.microsoft.com/on-the-issues/2020/12/13/customers-protect-nation-state-cyberattacks/)\n\n[Behavior:Win32/Solorigate.C!dha threat description - Microsoft Security Intelligence](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Behavior:Win32/Solorigate.C!dha&ThreatID=2147771132)\n\n[Customer guidance on recent nation-state cyberattacks](https://msrc-blog.microsoft.com/2020/12/13/customer-guidance-on-recent-nation-state-cyber-attacks/)\n\n[FireEye Advisory: Highly Evasive Attacker Leverages SolarWinds Supply Chain to Compromise Multiple G...](https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html)\n\n[FireEye GitHub page: Sunburst Countermeasures](https://github.com/fireeye/sunburst_countermeasures)\n\n[DHS Directive](https://cyber.dhs.gov/ed/21-01/)\n\n[SolarWinds Security Advisory](https://www.solarwinds.com/securityadvisory)\n\n[FalconFriday – Fireeye Red Team Tool Countermeasures KQL Queries](https://github.com/FalconForceTeam/FalconFriday/blob/master/Uncategorized/FireEye_red_team_tool_countermeasures.md)\n\n[Microsoft-365-Defender-Hunting-Queries: Sample queries for Advanced hunting in Microsoft 365 Defende...](https://github.com/microsoft/Microsoft-365-Defender-Hunting-Queries)\n\n[Azure Sentinel SolarWinds Post Compromise Hunting Workbook](https://github.com/Azure/Azure-Sentinel/blob/master/Workbooks/SolarWindsPostCompromiseHunting.json)\n\n[Azure Sentinel SolarWinds Post Compromise Notebook](https://github.com/Azure/Azure-Sentinel-Notebooks/blob/master/Guided%20Investigation%20-%20Solarwinds%20Post%20Compromise%20Activity.ipynb)\n\nUpdated 12/18/2020\n\n[New Threat analytics report shares the latest intelligence on recent nation-state cyber attacks - Mi...](https://techcommunity.microsoft.com/t5/microsoft-365-defender/new-threat-analytics-report-shares-the-latest-intelligence-on/ba-p/2001095)\n\n[Analyzing Solorigate, the compromised DLL file that started a sophisticated cyberattack, and how Mic...](https://aka.ms/solorigateattack)\n\nUpdated 12/28/2020\n\n[Using Microsoft 365 Defender to protect against Solorigate - Microsoft Security](https://www.microsoft.com/security/blog/2020/12/28/using-microsoft-365-defender-to-coordinate-protection-against-solorigate/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-16 - SolarWinds Post-Compromise Hunting with Azure Sentinel.pdf"
    ],
    "report_names": [
        "2020-12-16 - SolarWinds Post-Compromise Hunting with Azure Sentinel.pdf"
    ],
    "threat_actors": [
        {
            "id": "b43e5ea9-d8c8-4efa-b5bf-f1efb37174ba",
            "created_at": "2022-10-25T16:07:24.36191Z",
            "updated_at": "2025-03-27T02:02:10.1909Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "Dark Halo",
                "Nobelium",
                "SolarStorm",
                "StellarParticle",
                "UNC2452"
            ],
            "source_name": "ETDA:UNC2452",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "faa4a29b-254a-45bd-b412-9a1cbddbd5e3",
            "created_at": "2022-10-25T16:07:23.80111Z",
            "updated_at": "2025-03-27T02:02:09.985067Z",
            "deleted_at": null,
            "main_name": "LookBack",
            "aliases": [
                "FlowingFrog",
                "LookBack",
                "LookingFrog",
                "TA410",
                "Witchetty"
            ],
            "source_name": "ETDA:LookBack",
            "tools": [
                "FlowCloud",
                "GUP Proxy Tool",
                "SodomMain",
                "SodomMain RAT",
                "SodomNormal"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "1d3f9dec-b033-48a5-8b1e-f67a29429e89",
            "created_at": "2022-10-25T15:50:23.739197Z",
            "updated_at": "2025-03-27T02:00:55.536417Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "UNC2452",
                "NOBELIUM",
                "StellarParticle",
                "Dark Halo"
            ],
            "source_name": "MITRE:UNC2452",
            "tools": [
                "Sibot",
                "Mimikatz",
                "Cobalt Strike",
                "AdFind",
                "GoldMax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "a241a1ca-2bc9-450b-a07b-aae747ee2710",
            "created_at": "2024-06-19T02:03:08.150052Z",
            "updated_at": "2025-03-27T02:05:17.409596Z",
            "deleted_at": null,
            "main_name": "IRON RITUAL",
            "aliases": [
                "Blue Dev 5 ",
                "BlueBravo ",
                "Cloaked Ursa ",
                "CozyLarch ",
                "Dark Halo ",
                "Midnight Blizzard ",
                "NOBELIUM ",
                "StellarParticle ",
                "UNC2452 ",
                "APT29"
            ],
            "source_name": "Secureworks:IRON RITUAL",
            "tools": [
                " Cobalt Strike",
                " EnvyScout",
                " GoldFinder",
                " GoldMax",
                " NativeZone",
                " RAINDROP",
                " SUNBURST",
                " Sibot",
                " TEARDROP",
                " VaporRage",
                "Brute Ratel C4"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535959,
    "ts_updated_at": 1743041795,
    "ts_creation_date": 1653787972,
    "ts_modification_date": 1653787972,
    "files": {
        "pdf": "https://archive.orkl.eu/49edad2a870cbe8ffb784a8f51198183f8cff961.pdf",
        "text": "https://archive.orkl.eu/49edad2a870cbe8ffb784a8f51198183f8cff961.txt",
        "img": "https://archive.orkl.eu/49edad2a870cbe8ffb784a8f51198183f8cff961.jpg"
    }
}