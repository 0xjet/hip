{
    "id": "82048233-4d6e-4632-a463-7c11fb6531da",
    "created_at": "2023-01-12T15:04:18.374022Z",
    "updated_at": "2025-03-27T02:05:44.464306Z",
    "deleted_at": null,
    "sha1_hash": "ba3a4771fe64ea455bdd1f42d73c3430637e51a1",
    "title": "2017-10-05 - SYSCON Backdoor Uses FTP as a C&C Channel",
    "authors": "",
    "file_creation_date": "2022-05-28T02:42:39Z",
    "file_modification_date": "2022-05-28T02:42:39Z",
    "file_size": 233851,
    "plain_text": "# SYSCON Backdoor Uses FTP as a C&C Channel\n\n**[blog.trendmicro.com/trendlabs-security-intelligence/syscon-backdoor-uses-ftp-as-a-cc-channel/](http://blog.trendmicro.com/trendlabs-security-intelligence/syscon-backdoor-uses-ftp-as-a-cc-channel/)**\n\nMalware\n\n\nOctober 5, 2017\n\n\nBots can usually establish communication with their C&C server via HTTP or other TCP/IP connections. However, we recently encountered a\nbotnet that uses a more unusual method: an FTP server that, in effect, acts as a C&C server.\n\nBy: Jaromir Horejsi October 05, 2017 Read time: ( words)\n\nBots can use various methods to establish a line of communication between themselves and their command-and-control (C&C) server.\nUsually, these are done via HTTP or other TCP/IP connections. However, we recently encountered a botnet that uses a more unusual method:\nan FTP server that, in effect, acts as a C&C server.\n\nUsing an FTP server has some advantages. It is less common, and this fact may allow it to slip unnoticed by administrators and researchers.\nHowever, this also leaves the C&C traffic open for monitoring by others, including security researchers. In addition, thanks to a coding mistake\nby the attackers, this particular backdoor does not always run the right commands.\n\n**Infection ChainThe infection chain starts with a malicious document with macros. The examples of delivery documents are shown below. The**\n[documents suggest that targeted individuals may be connected to the Red Cross and the](http://www.ifrc.org/what-we-do/health/cbhfa/about-cbhfa/) [World Health Organization. All the documents](http://www.who.int/pmnch/about/continuum_of_care/en/)\nmention North Korea as well. We detect these delivery documents as W2KM_SYSCON.A.\n\n_Figures 1-3. Delivery documents with macros (Click to enlarge)_\n\nEach document contains two long strings, with Base64 encoding using a custom alphabet. This same technique was used to deliver the Sanny\nmalware family in late 2012.\n\n_Figure 4. Base64 decoded function with custom alphabet highlighted_\n\nIts similarities with the earlier Sanny attack are interesting. Both attacks used relatively unusual techniques for their C&C server, their structure\nis similar, and the encoding key is identical. Documents somehow tied to North Korea were also used. We cannot eliminate the possibility that\nboth Sanny and this new malware family were the work of the same threat actor.\n\n[Decoding each Base64 string results in a cabinet file. One string contains a 32-bit version of the malware; the other contains a 64-bit version.](https://msdn.microsoft.com/en-us/library/windows/desktop/aa367841(v=vs.85).aspx)\nThe appropriate version (based on OS version) is extracted using the expand command into the %Temp% folder, and uacme.exe (one of the\nfiles in the cabinet file) is executed. (We detect the malicious files in these cabinet files under the following detection names: BAT_SYSCON.A,\n[BKDR_SYSCON.A, and TROJ_SYSCON.A.)](https://www.trendmicro.com/vinfo/tmr/?/us/threat-encyclopedia/malware/BKDR_SYSCON.A)\n\n_Figure 5. Command to extract cabinet archive and execute its contents (Click to enlarge)_\n\n_Figure 6. Listing of all files in cabinet archive_\n\n\n-----\n\n**U C bypass a d** **sta at o Uac** _e e e, as t e_ a e suggests, dete es t e ope at g syste e s o ased o t at o at o, t\neither directly executes install.bat (for older Windows versions) or injects dummy.dll into the taskhost(ex) process, which attempts to\nexecute install.bat without a [UAC prompt appearing.](https://msdn.microsoft.com/en-us/library/cc505883.aspx)\n\n_Figure 7. uacme.exe and UAC bypass_\n\n_Install.bat copies two files: ipnet.dll (the main file) and ipnet.ini (configuration file) into %Windows%\\System32, configures new_\n[malicious COMSysApp service using the sc command line utility, adds the service parameters into the registry, starts the malicious service,](https://technet.microsoft.com/en-us/library/bb490995.aspx)\nand deletes all previously created files in the %Temp% directory. This does two things: it sets up the backdoor’s autostart routine, and deletes\nsome traces of its previous activity, making detection more difficult.\n\n_Figure 8. Service installation_\n\nImportant parameters for the service configuration are “type=own”, which according to MSDN documentation means that it has its\nown svchost.exe process in which the ipnet.dll runs. The parameter “start = auto” starts the service every time the computer is restarted.\n\n_Ipnet.ini is a text file encoded in the same way as the two cabinet files._\n\n_Figure 9. Configuration file_\n\n[Decoding the configuration reveals a URL for the byethost free FTP service provider, as well as a set of login credentials.](https://byet.host/)\n\n**The backdoorThe malware first gets the computer name, which it uses as the affected machine’s identifier. It then logs into the FTP server**\nusing the credentials in the configuration file, enters the /htdocs/ directory, and monitors existing .txt file names. If the file name contains “To\nEVERYONE”, it means that the file should be processed by everyone. If it contains “to computer_name”, then the file should be processed\n(and later deleted) only by the victim computer with the matching computer_name.\n\nAfter the backdoor processes the command, it lists all the currently running processes by calling “cmd /c tasklist >%ws”, which is then packed,\nencoded and uploaded to FTP under following name pattern “From %s (%02d-%02d %02d-%02d-%02d).txt”, i.e. computer name followed by\ndate and time of the task execution.\n\n_Figure 10. Construction of name of the uploaded file_\n\nThis shows that the communication between the victim’s computer and the bot master is done via uploaded files. However, the files are\ngenerally zipped and encoded with the same custom Base64 encoding used earlier.\n\n[Compression of the files is done using the Shell Automation Service, which is part of Windows itself. No external library is needed. The](https://msdn.microsoft.com/en-us/library/windows/desktop/bb776890(v=vs.85).aspx)\nmalware first creates a 22-byte long empty .zip file by executing the instructions below. The content of the newly created .zip file in hex is\n“504b0506000000000000000000000000000000000000”, which is basically an empty .zip archive.\n\n_Figure 11. Instructions creating empty .zip file_\n\n_Figure 12. Empty .zip file opened in Explorer_\n\nThe malware then uses the Folder.CopyHere method to copy files into the empty .zip archive, so these files are compressed by the operating\nsystem. According to MSDN documentation, these are the flags used while copying:\n\n0x1000 = Only operate in the local directory. Do not operate recursively into subdirectories.\n0x0400 = Do not display a user interface if an error occurs.\n0x0010 = Respond with “Yes to All” for any dialog box that is displayed.\n0x0004 = Do not display a progress dialog box.\n\n_Figure 13. Flags used by Folder.CopyHere method_\n\nThese flags ensure that no dialog box appears and no errors are shown to the victim. All these operations remain hidden in the background.\nAfter compression is finished, the compressed files are encoded with Base64 and uploaded to the FTP server. For downloading files from FTP\nserver, the reverse operations would be performed by the threat actor.\n\n**C&C communication protocolBots listen to and can process several supported commands:**\n\n\n-----\n\nCommand Meaning of command\n\n\ncmd /c pull /f\n<file_name>\n\ncmd /c pull\n<file_name>\n\ncmd /c chip\n<string>\n\ncmd /c put\n<new_file_name>\n\ncmd /c\n<command> >\n<file>\n\ncmd /c\n<command>\n\n\ncopy <file_name> to temp.ini, pack it to temp.zip, encode and upload\n\npack <file_name> to temp.zip, encode and upload\n\ndelete config file, write <string> to the new config file\n\nput file from #<content># to the given path on infected system\n\nexecute command and redirect its output to file, file gets zipped, encoded, uploaded\n\nexecute command; do not report about it back to c2\n\n\n<parameters> [parameters to previously downloaded <file>, called <file> <parameters> using Winexec API, flag Show=SW_HIDE](https://msdn.microsoft.com/en-us/library/windows/desktop/ms687393(v=vs.85).aspx)\n\n\n/user\n<parameters>\n\n/user\n<parameters>\n/stext\n\n\nexecute previously downloaded <file>, called <file> <parameters>; do not report about it back to c2;\nuse [CreateProcessAsUser](https://msdn.microsoft.com/en-us/library/windows/desktop/ms682429(v=vs.85).aspx)\n\nexecute previously downloaded <file>, called <file> <parameters> /stext “%APPDATA%\\Temp\\Temp.ini“, result gets\n[zipped, encoded, uploaded; misuses parameters from Nirsoft’s utilities; use CreateProcessAsUser](http://www.nirsoft.net/)\n\n\n#<content># <file>, which is unzip(base64decode ( <content> ) )\n\n_Table 1. C&C commands_\n\n_Figure 14. Processing C&C commands_\n\nHere are some examples of commands that could be issued using this method: Example 1 Command:\n\nEncoded as:\n\nIxXDK=NK2KKQK=zK2KXxKB-K0KXTKUKKIxKeKPxKINX8KBNK0xXpKBWKnNX6KUjKIWXZKBNK\n\nResult:\n\n-yT/XXNKKKKKKyD8J6G=UtS6=KKKKXWKKKKzKKKKIVSH0hSjnbz1IFPH-OSi2yR80b8M2=nA0=-WnFYJ2yM-SORiyTXKZNKPKKKKKKKu4VtdTI2AbzIKKKK=KKKKKxKKKKKKKKKKNKWKKKKKKKKK=P8C=Ypr=S6LF9ZCPXLXNIKKKKKKNKXK/7KKKXUK\n\nThis result contains the contents of the autoexec.bat file. Example 2 Command:\n\nEncoded as:\n\nIxXDK=NK2KKQK=zK2KX6K=NK2KKQK=NK2KX/K/7KVKKWKUIK9WKWK=NKwNXJKUKKLxXQKUHKnKKQKBzK2KK5KUjKtWKWK/jKKKK\n\nResult:\n\n-yT/XXNKKKK2KyHRLOQ26PNrulo0KPtgJWK2KKKKC=SDoUMA0FczVC81jHAJQpYW4j=VU-LAYKl……..\n\nThis results in a file with a list of all files in C:\\, sorted from newest to oldest. Example 3 Command:\n\n_#…encoded file…#LxX8KBzKnNXJKUKKLxXhK=-oWX3K=OK0xX1KUKKzNKHKUKKLxX3KBNKnNXjKBNKKKKv_\n\nDecoded as:\n\nResult:\n[In this case, attacker sent an encoded version of Nirsoft’s utility](http://www.nirsoft.net/) _[mailpv.exe, which was then executed with parameters above.](http://www.nirsoft.net/utils/mailpv.html)_\n\n\n-----\n\n**sta es** **a** **a e code** e co a d p ocess g oop co ta s at appea s to be a typo o sta e e a a e t eats t e co a d\n[and-control commands as strings in wide character format. The second](https://msdn.microsoft.com/en-us/library/z207t55f.aspx) _[wsprintfA function in the snippet below has the first format](https://msdn.microsoft.com/en-us/library/windows/desktop/ms647550(v=vs.85).aspx)_\nparameter “%s”, which should actually be “%ws”. Because of this, only the first character of lpExistingFileName is propagated\ninto &CommandLine, preventing the process from executing because of the incorrect file name.\n\n_Figure 15. Code snippet with a typo (Click to enlarge)_\n\n**ConclusionIt is interesting to see something atypical, like C&C communication via FTP. While the malware authors probably used this method**\nin an attempt to avoid security solutions inspection and/or blocking, they may not have realized this would make it very easy to monitor their\nactions and victims’ data.\n\nIT administrators should be aware that connections to external FTP servers can signify not just data extraction, but C&C activity as well. Either\nway, if this kind of network activity is not necessary for business functions, blocking it should be considered.\n\n**Indicators of CompromiseFiles with the following SHA256 hashes are connected to this attack, and are detected as W2KM_SYSCON.A:**\n\n34e968c067f6a360cc41a48b268c32a68421567f0329d4f9f8e2850fb4e27c8c\n63ca182abb276e28aec60b9ef1eab5afc10bfb5df43f10a11438d8c0f7550c5c\na07251485a34dd128d80860737b86edd3eb851f57797f2f8fb6891a3cb7a81b3\ncff8d961f3287f9ca75b65303075343bdbe63bb171d8f5b010bbf4fa30450fc4\nf4987d127320cb5bfb8f49fc26435e01312bdd35a4e5e60db13546046584bd4e\n\nFiles with the following SHA256 hashes are detected as BAT_SYSCON.A:\n\n2c958cd3838fcae410785acb0acf5a542d281524b7820d719bb22ad7d9fcdc7c\ne4226645bad95f20df55ef32193d72c9dafcf060c3360fd4e50b5c08a986a353\nf01e440764b75b72cab8324ba754d89d50d819a1b2db82ca266f1c307541a2b0\n\nFiles with the following SHA256 hashes are detected as BKDR_SYSCON.A:\n\n1f9afb142827773cefdb29f06ed90e0476c0185d4c8b337439b3be27e61ed982\n65e4212507bb52e72e728559df5ad38a4d3673b28104be4b033e42b1c8a264e8\n9b62a013b579f01e3c4c3caf3c9bc02eb338ce9859496e02016ba24b8908d59a\n9be95f5954202d7b159c5db928851102f23eae88c087892663781cf8edc0753a\nbec437d1979d16505ca8fc896fa8ce9794f655abd39145a82330343b59c142c5\ncfb2161b5aebf0c674c845e2428e24373edd4c74a2fb15de527d6763a62dd74e\n\nFiles with the following SHA256 hashes are detected as TROJ_SYSCON.A:\n\n25c08d5e77fada975f31a0e0807b7ea1064aae80f5de43790f6ada16159ae1c2\n2d261eb478bafaabd7dc12752b1c0aadba491d045573fe2e24cdac5588e2c96b\n2f6df307dbe54b8a62a35ea2941a7d033bfdfbb545a7872cb483aea77ec6a10b\n3319a156c84e85a4447fa40b0f09aabb84092b5c3a152ad641ee5692741b9194\n3fcda66e87eec4f90b50f360460fa46448249e6e177de7ff8f35848353acfaaa\n65380ab72bb6aa6ffcd2ea781fe2fa4f863a1b4a61073da7da382210c163b0f9\n7daec65f8fee86227d9f9c81ed00d07c46b44e37968bd2894dc74bf311c63651\nb7c970f1f65850fa859549f2cf3c2284b80ec464496b34f09bc53c4456e10d1f\nd495295466428a52263c8725070a9cf7c2446c6115bddc2de662949afd39f9a9\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-10-05 - SYSCON Backdoor Uses FTP as a C&C Channel.pdf"
    ],
    "report_names": [
        "2017-10-05 - SYSCON Backdoor Uses FTP as a C&C Channel.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535858,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653705759,
    "ts_modification_date": 1653705759,
    "files": {
        "pdf": "https://archive.orkl.eu/ba3a4771fe64ea455bdd1f42d73c3430637e51a1.pdf",
        "text": "https://archive.orkl.eu/ba3a4771fe64ea455bdd1f42d73c3430637e51a1.txt",
        "img": "https://archive.orkl.eu/ba3a4771fe64ea455bdd1f42d73c3430637e51a1.jpg"
    }
}