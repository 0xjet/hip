{
    "id": "80459563-9865-4de9-ad98-8e16e0760110",
    "created_at": "2023-01-12T15:09:40.222511Z",
    "updated_at": "2025-03-27T02:05:35.527029Z",
    "deleted_at": null,
    "sha1_hash": "c7d3e529f680076b965cb78b9d737435a7c10f34",
    "title": "2020-12-10 - PGMiner- New Cryptocurrency Mining Botnet Delivered via PostgreSQL",
    "authors": "",
    "file_creation_date": "2022-05-29T10:46:30Z",
    "file_modification_date": "2022-05-29T10:46:30Z",
    "file_size": 2078091,
    "plain_text": "# PGMiner: New Cryptocurrency Mining Botnet Delivered via PostgreSQL\n\n**[unit42.paloaltonetworks.com/pgminer-postgresql-cryptocurrency-mining-botnet/](https://unit42.paloaltonetworks.com/pgminer-postgresql-cryptocurrency-mining-botnet/)**\n\nXiao Zhang, Yang Ji, Jim Fitzgerald, Yue Chen, Claud Xiao December 10, 2020\n\nBy [Xiao Zhang,](https://unit42.paloaltonetworks.com/author/xiao/) [Yang Ji,](https://unit42.paloaltonetworks.com/author/yang-ji/) [Jim Fitzgerald,](https://unit42.paloaltonetworks.com/author/jim-fitzgerald/) [Yue Chen and](https://unit42.paloaltonetworks.com/author/yue-chen/) [Claud Xiao](https://unit42.paloaltonetworks.com/author/claud-xiao/)\n\nDecember 10, 2020 at 6:00 AM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit-42/)\n\nTags: [coin miner,](https://unit42.paloaltonetworks.com/tag/coin-miner/) [coin mining,](https://unit42.paloaltonetworks.com/tag/coin-mining/) [cryptojacking,](https://unit42.paloaltonetworks.com/tag/cryptojacking/) [exploit,](https://unit42.paloaltonetworks.com/tag/exploit/) [PostgreSQL,](https://unit42.paloaltonetworks.com/tag/postgresql/) [vulnerabilities](https://unit42.paloaltonetworks.com/tag/vulnerability/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/pgminer-postgresql-cryptocurrency-mining-botnet/)\n\n## Executive Summary\n\nCryptojacking (or simply malicious coin mining) is a common way for malware authors to\nmonetize their operations. While the underlying mining protocols and techniques remain\nfairly standard, malware actors tend to seek out and find smarter ways to hack into a victim's\nmachines. Recently, Unit 42 researchers uncovered a novel Linux-based cryptocurrency\nmining botnet that exploits a disputed PostgreSQL remote code execution (RCE)\nvulnerability that compromises database servers for cryptojacking. We named the\ncryptocurrency mining botnet \"PGMiner\" after its delivery channel and mining behavior. At its\n\n\n-----\n\ncore, PGMiner attempts to connect to the mining pool for Monero mining. Because the\nmining pool is not active anymore, we could not recover information about the actual profit of\nthis malware family.\n\nPostgreSQL, also known as Postgres, is among the most-used open source relational\ndatabase management systems (RDBMS) for production environments. According to DBEngines, PostgreSQL ranks fourth among all database management systems (DBMS) as of\nNovember 2020 and has seen a steady increase in popularity since 2013. In particular,\n[PostgreSQL was named database of the year in 2017 and](https://db-engines.com/en/blog_post/76) [2018 by DB-Engines.](https://db-engines.com/en/blog_post/79)\n\nThe feature in PostgreSQL under exploitation is \"copy from program,\" which was introduced\n[in version 9.3 on Sept. 9, 2013. In 2018, CVE-2019-9193 was linked to this feature, naming it](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/)\nas a \"vulnerability.\" However, the PostgreSQL community challenged this assignment, and\nthe CVE has been labeled as \"disputed.\"\n\nWe believe PGMiner is the first cryptocurrency mining botnet that is delivered via\nPostgreSQL. It is notable that malware actors have started to weaponize not only confirmed\nCVEs, but also disputed ones.\n\n[Palo Alto Networks Next-Generation Firewall customers are protected from PGMiner with the](https://www.paloaltonetworks.com/network-security/next-generation-firewall)\n[WildFire and](https://www.paloaltonetworks.com/products/secure-the-network/wildfire) [Threat Prevention security subscriptions.](https://www.paloaltonetworks.com/products/secure-the-network/subscriptions/threat-prevention)\n\n[At the time of this writing, none of the vendors on VirusTotal detect PGMiner. WildFire, a](https://www.virustotal.com/gui/file/55698654f0fbcf5a6d52f3f44bc0f2257e06835e76fb7142d449a2d1641d7e4b/detection)\ncloud-based malware analysis platform, detects it by dynamic analysis with the observation\nof self-deletion and process impersonation. Besides the delivery channel, PGMiner’s coin\n[mining codebase reassembles some of the characteristics from the the SystemdMiner family](https://blog.netlab.360.com/systemdminer-when-a-botnet-borrows-another-botnets-infrastructure/)\nand its variants [1,](https://zhuanlan.kanxue.com/article-10818.htm) [2 and 3, but with the following notable changes:](https://cloud.tencent.com/developer/article/1587201)\n\nDelete the PostgreSQL table right after code launch to achieve fileless execution.\nCollect system information and send it to the command and control (C2) server for\nvictim identification.\nEmploy traditional and novel approaches to download curl binary in case the command\nis not available on the victim’s machine.\nImpersonate the \"tracepath\" process to hide its presence.\nAttempt to kill competitor programs for better monetization.\n\n## Attack Process Overview\n\nA high-level overview of PGMiner’s execution flow is depicted in Figure 1. As explained\nbefore, the malicious payload is delivered via PostgreSQL, which communicates to the\nbackend C2 servers through SOCKS5 proxies. After that, it downloads the coin mining\npayloads based on the system architecture.\n\n\n-----\n\nFigure 1. Structure of PGMiner exploiting a disputed PostgreSQL RCE vulnerability.\nDuring our analysis, we found that PGMiner constantly reproduces itself by recursively\ndownloading certain modules. To better illustrate this process, we show the payload\nrelationship in Figure 2. Each box links to a sample identified in the infection chain. The\nrecord contains filename, abbreviated SHA256 value and file type information. Note that\nwhenever the architecture information is in the filename, we iterate through all other possible\narchitectures and add the samples in the graph if successfully downloaded. The abbreviated\nC2 for each stage is marked with dark green. Also, the samples in light blue boxes have\n[been extensively studied in previous research work (SystemdMiner and its variants 1,](https://blog.netlab.360.com/systemdminer-when-a-botnet-borrows-another-botnets-infrastructure/) [2 and](https://zhuanlan.kanxue.com/article-10818.htm)\n[3). Here, we’ll focus on the samples that appear in light red boxes and provide a summary of](https://zhuanlan.kanxue.com/article-10818.htm)\nthe rest.\n\n\n-----\n\nFigure 2. PGMiner payload relationship.\n\n## Initial Compromise via PostgreSQL Exploit\n\nThe root sample that triggered our investigation is\n55698654f0fbcf5a6d52f3f44bc0f2257e06835e76fb7142d449a2d1641d7e4b, which is an\nAARCH64 ELF file that is static linked and stripped. At the time of this writing, none of the\n[vendors on VirusTotal is able to detect this malware, as shown in Figure 3.](https://www.virustotal.com/gui/file/55698654f0fbcf5a6d52f3f44bc0f2257e06835e76fb7142d449a2d1641d7e4b/detection)\n\nFigure 3. None of the vendors on VirusTotal detect PGMiner.\nThe sample above works as an exploit tool that attempts to exploit a controversial feature in\nPostgreSQL that allows RCE on the server’s operating system (OS). By reverse engineering\nthe binary as shown in Figure 4, we found the sample has the libpq postgresql client library\nstatically linked. This is used for communicating with the target database servers. The\nattacker scans port 5432 (0x1538), used by PostgreSQLql of the hosts in the private/local\nnetwork (i.e., 172.16.0.0, 192.168.0.0 and 10.0.0.0 subnets). The malware randomly picks a\npublic network range (e.g., 190.0.0.0, 66.0.0.0) in an attempt to perform RCE on the\nPostgreSQL server. With the user \"postgres\", which is the default user of the database, the\nattacker performs a brute-force attack iterating over a built-in list of popular passwords such\nas \"112233\" and \"1q2w3e4r\" to crack the database authentication.\n\n\n-----\n\nFigure 4. PostgreSQL exploit code flow in PGMiner.\nOnce the malware successfully breaks into the database, it uses the PostgreSQL \"copy from\nprogram\" feature to download and launch the coin mining scripts. The \"copy from program\"\nfeature has been controversial since its debut in PostgreSQL 9.3. The feature allows the\nlocal or remote superuser to run shell script directly on the server, which has raised wide\nsecurity concerns. In 2019, a CVE-2019-9193 was assigned to this feature, naming it as a\n\"vulnerability.\" However, the PostgreSQL community challenged this assignment, and the\nCVE has been labeled as \"disputed.\" The main argument against defining the feature as a\nvulnerability is that the feature itself does not impose a risk as long as the superuser privilege\nis not granted to remote or untrusted users and the access control and authentication system\nworks well. On the other side, security researchers worry that this feature indeed makes\nPostgreSQL a stepping stone for remote exploit and code execution directly on the server’s\nOS beyond the PostgreSQL software, if the attacker manages to own the superuser privilege\nby brute-forcing password or SQL injection.\n\n\n-----\n\nFigure 5. PGMiner’s exploit content to PostgreSQL.\nWhile this CVE is still being disputed, malware authors apparently have started to use it to\nstay under the detection radar by making the attack payload fileless. The actual exploit\ncontent from PGMiner is shown in Figure 5, which can be broken down to the following\nsteps:\n\n**Step** **SQL command**\n\nClear the “abroxu” table if it exists. DROP TABLE IF EXISTS abroxu;\n\nCreate the table with a text column. CREATE TABLE abroxu(cmd_output text);\n\n\nSave the malicious payload to table\n\"abroxu\".\n\nExecute the payload on the PostgreSQL\nserver.\n\n\nCOPY abroxu FROM PROGRAM “shell\n_command”;_\n\nSELECT * FROM cmd_exec;\n\n\nClear the created table. DROP TABLE IF EXISTS abroxu;\n\n\n-----\n\nThe malicious script payload saved in the abroxu table reassembles some of the\ncharacteristics from the known SystemdMiner malware family and its variants. Here we only\nhighlight the major ways that PGMiner evolves from SystemdMiner, as well as overlooked\nfunctionalities. We have also added annotation to the script shown in the figures below to\nmake this clear.\n\n**Downloading Curl**\n\nIn the case that the curl command is not available on the victim’s machine, the malicious\nscript tries multiple approaches (see Figure 6) to download the curl binary and add it to the\nexecution paths:\n\nDirect installation from official package management utilities like apt-get and yum.\nDownload static curl binary from GitHub.\nDownload using /dev/tcp in case the normal ways don’t work.\n\nFigure 6. PGMiner’s multiple attempts to download curl binaries.\nWhile the first two approaches are well-known, the third one is quite unique. What’s more\ninteresting is the target IP address: 94[.]237[.]85[.]89. It is connected to the domain\nnewt[.]keetup[.]com. While its parent domain, keepup[.]com, seems like a legitimate business\n\n\n-----\n\nwebsite, this particular subdomain is redirecting port 80 to 443, which is used to host a\n[couchdb named newt. Although port 8080 is not open to the public, we believe it has been](https://couchdb.apache.org/)\n[configured to allow Cross-Origin Resource Sharing (CORS), as shown in Figure 7.](https://docs.couchdb.org/en/latest/config/http.html#cors/origins)\n\nFigure 7. newt[.]keetup[.]com is hosting a couchdb for curl binary downloading.\n\n**Resolving SOCKS5/TOR Relay Server Name**\n\nThe C2 host name has been updated to\nnssnkct6udyyx6zlv4l6jhqr5jdf643shyerk246fs27ksrdehl2z3qd[.]onion. PGMiner also utilizes\nthe SOCKS5 proxy technique to communicate with the C2, as described in this\n[SystemdMiner variant. However, as shown in Figure 8, the DNS server list has been](https://zhuanlan.kanxue.com/article-10818.htm)\nexpanded.\n\nFigure 8. Updated C2 and expanded DNS server list observed in PGMiner.\n\n**Fetch Payloads From C2 and Launch PGMiner**\n\nAfter resolving the SOCKS5 proxy server IP address, PGMiner rotates through a list of\nfolders to find the first one that allows permission to create a new file and update its\nattributes. This ensures the downloaded malicious payload can successfully execute on the\n\n\n-----\n\nvictim s machine. This function has been observed in the previous research on the\n[SystemdMiner variant, but the author of the research did not provide an explanation of its](https://zhuanlan.kanxue.com/article-10818.htm)\npurpose.\n\nThe malware family also evolves with client tracking functionality. It concatenates the IP\naddress, username, architecture, hostname and md5 of all inet IP ranges, as well as the\nbase64 encoding of the crontab content, to formulate the client’s unique identifier, which it\nreports to the C2 server. The code snippet is highlighted in Figure 9.\n\nFigure 9. PGMiner featches payloads from C2 and executes them.\n\n## Multi-Architecture Payloads\n\nWith different architectures supplied to the C2 server mentioned above, we were able to\nrecover the following list of payloads. The downloads for other architectures failed.\n\n\n-----\n\na935d364622ebefbee659caaa9d0af5828952ab9501591c935cf1f919e2a38ff\npg.aarch64: Shell Script\na935d364622ebefbee659caaa9d0af5828952ab9501591c935cf1f919e2a38ff\npg.armv7l: Shell Script\n6d296648fdbc693e604f6375eaf7e28b87a73b8405dc8cd3147663b5e8b96ff0\npg.x86_64: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, no\nsection header\n\nInterestingly, the payload for x86_64 is an ELF executable, while for aarch64 and armv7l, the\npayload is an identical shell script.\n\n**x86_64 ELF Payload**\n\nThe x86_64 ELF payload shares the majority of behaviors seen in the previous\n[SystemdMiner variant, yet evolves with additional capabilities:](https://zhuanlan.kanxue.com/article-10818.htm)\n\nEnvironment Preparation:\n\nDownload and install curl binary as explained above.\nInstall crontab.\nRemove cloud security monitor tools such as Aegis, and Qcloud monitor utilities\nsuch as Yunjing.\nVirtual Machine Checking: PGMiner checks the existence of VBoxGuestAdditions to\ninfer whether it is being analyzed in a virtual environment.\nCompetitors Removal:\n\nRemove other known miner scripts, processes and crontab records.\nKill miner cleanup processes.\nKill all other CPU intensive processes such as ddg, system updates and so on.\nKill processes connected to known mining IP addresses.\n\n## armv7l/aarch64 Shell Script Payload\n\nFrom the x86_64 ELF payload, we were able to recover the CPU file from C2\njk5zra7b3yq32timb27n4qj5udk4w2l5kqn5ulhnugdscelttfhtoyd[.]onion, which is the coin\nmining module for PGMiner. However, the other cmd and bot modules are unavailable from\nthe C2. Here, the armv7l/aarch64 shell script connects to a different C2,\nreambusweduybcp[.]onion. It also attempts to download the cmd file. This time, it succeeds.\nThis indicates that the C2 server for this malware family is constantly updating. Different\nmodules are distributed across different C2s.\n\nThe cmd module first attempts to kill the tracepath process. Then, it downloads additional\npayload from the same C2 address. The downloaded malware impersonates the tracepath\nprocess to hide its presence. After analyzing the aarch64 payload, we recovered the same\nshell script initially used to run on PostgreSQL servers, which completes the analysis.\n\n\n-----\n\n## Mitigations and Recommendations\n\nPalo Alto Networks Next-Generation Firewall customers are protected against PGMiner via\nthe WildFire and Threat Prevention security subscriptions. At the same time, we urge\nPostgreSQL users to remove the “pg_execute_server_program” privilege from untrusted\nusers, which makes the exploit impossible. Moreover, we continue to recommend that users\ndownload software from trusted sources, manage strong and secure passwords and apply\npatches in a timely manner.\n\nTo remove the impact of PGMiner on the PostgreSQL server, the user can search and kill the\n“tracepath” process, which this malware impersonates, and kill the processes whose process\nIDs (PIDs) have been tracked by the malware in “/tmp/.X11-unix/”.\n\n## Conclusion\n\nIn this research, we unveiled PGMiner, a new cryptocurrency mining botnet delivered via a\ndisputed PostgreSQL RCE vulnerability. The fact that PGMiner is exploiting a disputed\nvulnerability helped it remain unnoticed until we recently uncovered it at Palo Alto Networks.\n\nPGMiner can potentially be disruptive, as PostgreSQL is widely adopted in PDMS. With\nadditional effort, the malware could target all major operating systems. For example,\nPostgreSQL is available for all major platforms, including macOS, Windows and Linux.\nTheoretically, the malware actors could implement another version of PGMiner by targeting a\nnew platform, such as Windows, and deliver it using PostgreSQL.\n\nDuring our analysis, we observed new techniques, such as embedding victim identification in\nthe request, impersonating a trusted process name, downloading curl binary via multiple\napproaches and more and aggressively killing all competitor programs. We also analyzed\nhow the malware seeks to better track victims, execute, hide itself and monetize. Other traits,\nsuch as the malware recursively downloading itself and frequently changing C2 addresses,\nalso indicate PGMiner is still rapidly evolving.\n\n## Additional Information on Cryptojacking\n\n Indicator of Compromise (IOCs)\n\nSample and payload identification as a tuple of filename, SHA256 and file type:\n\nroot.bin, 55698654f0fbcf5a6d52f3f44bc0f2257e06835e76fb7142d449a2d1641d7e4b,\nELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), statically linked, stripped\npg.x86_64,\n6d296648fdbc693e604f6375eaf7e28b87a73b8405dc8cd3147663b5e8b96ff0, ELF 64bit LSB executable, x86-64, version 1 (SYSV), statically linked, no section header\n\n\n-----\n\nint.x86_64,\n6984a04d7e435499ff267cfaf913d51e8644f6c08db8069c56f9247f1e18ba71, ELF 64-bit\nLSB executable, x86-64, version 1 (SYSV), statically linked, no section header\ncpu, fef1a83ba6aba160116a8251462dd842f68464a5f767b2e3194820d62fef23b1, ELF\n64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, no section header\npg.aarch64 / pg.armv7l,\na935d364622ebefbee659caaa9d0af5828952ab9501591c935cf1f919e2a38ff, Shell\nScript\ncmd, 864ece624b7069b929385f9cf741355a371e844aa3726d340f91549562e2c604,\nShell Script\ndream.aarch64,\nd8c46be19ff3ea5b2c12f050f226a199aaa5f76cc1731c868e29eea6c68b6801, ELF 64bit LSB executable, ARM aarch64, version 1 (SYSV), statically linked, no section\nheader\ndream.armv7l,\n8d44fbbefa0c59a65e21b0d1598ff7c51487ea1cede544d1c3f56d5db0ea7807, ELF 32bit LSB executable, ARM, EABI5 version 1 (GNU/Linux), statically linked, no section\nheader\ndream.mips,\n41ef5c6b0cdd068f117902e59233991082a4ecb4877a1fb16016e756412f06ea, ELF 32bit LSB executable, MIPS, MIPS-I version 1 (SYSV), statically linked, no section\nheader\n\nAdditional samples related to the\n55698654f0fbcf5a6d52f3f44bc0f2257e06835e76fb7142d449a2d1641d7e4b:\n\n1b1d6d5f01b26e4ccf6fff8f2626f9318084dc1123ac67ed7d02f955b72a1432\n0fc1332d2b20ea43d3c3fea50a48bb1991522bc6c79d518ba9b68a763ef2ad58\n8a13c3fe815f15a5600fda30d132dfbd4bb54d9c766da164060dd1d66b12e9e4\n6d95b593f0b5e3cc1985635ad2b943acb083833fea8123e7ac3f88f68e04edd6\n101ccbad7732fb185d51b91d31a67ff058cac3bc31ec36cec05094065a97d6fd\nd4cf8cfb4dc9cc3101b8c850369a71af70f11e67df7e41e9af98624ebe54ff4a\n47d56fcbf5d90b9c513d8d38a2c00e4bad6ea4e1d17b05dd37feb4d63b2856e1\ne3c5abe56964ddb3b4f0b3c434a9af145efca558307c65d30e8acc5aed45bedc\n524cce2cf615809bc08ca80facf95f2be7c5071c4cb3eac38c20a1f0ed39ce1f\n\nC2:\n\nnssnkct6udyyx6zlv4l6jhqr5jdf643shyerk246fs27ksrdehl2z3qd[.]onion\nojk5zra7b3yq32timb27n4qj5udk4w2l5kqn5ulhnugdscelttfhtoyd[.]onion\ndreambusweduybcp[.]onion\n\n**Get updates from**\n**Palo Alto**\n\n\n-----\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-10 - PGMiner- New Cryptocurrency Mining Botnet Delivered via PostgreSQL.pdf"
    ],
    "report_names": [
        "2020-12-10 - PGMiner- New Cryptocurrency Mining Botnet Delivered via PostgreSQL.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536180,
    "ts_updated_at": 1743041135,
    "ts_creation_date": 1653821190,
    "ts_modification_date": 1653821190,
    "files": {
        "pdf": "https://archive.orkl.eu/c7d3e529f680076b965cb78b9d737435a7c10f34.pdf",
        "text": "https://archive.orkl.eu/c7d3e529f680076b965cb78b9d737435a7c10f34.txt",
        "img": "https://archive.orkl.eu/c7d3e529f680076b965cb78b9d737435a7c10f34.jpg"
    }
}