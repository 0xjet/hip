{
    "id": "c1fada0b-1bd0-4bb3-a9f5-8ce6c31a2239",
    "created_at": "2023-01-12T15:05:08.406775Z",
    "updated_at": "2025-03-27T02:15:06.966124Z",
    "deleted_at": null,
    "sha1_hash": "38f935e93daa6210cf183731b294cb92979b0eee",
    "title": "2021-12-06 - AGENT TESLAGGAH",
    "authors": "",
    "file_creation_date": "2022-05-28T16:48:01Z",
    "file_modification_date": "2022-05-28T16:48:01Z",
    "file_size": 1512055,
    "plain_text": "# Agent TeslAggah\n\n**malwarebookreports.com/agent-teslaggah/**\n\nmuzi December 7, 2021\n\nIn May of 2020, [Deep Instinct reported on a new variant of the malware loader called â€œAggah,â€ a fileless loader that](https://www.deepinstinct.com/blog/aghast-at-aggah-teasing-security-controls-with-advanced-evasion-techniques)\ntakes advantage of LOLBINS and free services such as Bitly, Blogger, etc. Heading into the second December of the\nCovid-19 pandemic, Aggah has continued the trend of using Covid-19 as a lure for malspam.\n\nThe group behind â€œAggahâ€ is known for using the malware loader to deliver RATs such as Agent Tesla, NanoCore,\nnjRAT, Revenge and Warzone. Initially, [Palo Alto believed activity from â€œAggahâ€ was related to the Gorgon Group, but](https://apt.thaicert.or.th/cgi-bin/showcard.cgi?g=Aggah&n=1)\nPaloâ€™s Unit 42 has been unable to identify direct overlaps in activity/indicators.\n\nOn November 30, 2021, a new campaign was identified utilizing the Aggah loader to deliver Agent Tesla. The chain of\nactivity closely resembles previous Aggah activity, with some minor changes. Below is a summary of the observed\nactivity.\n\n## Stage 1: PPA with VBA Macros\n\n`Filename: ìƒˆ` êµ¬ë§¤ ì£¼ë¬¸ì„œ .ppa\n```\nMD5: 9b61bc8931f7314fefebfd4da8dba2cc\nSHA1: a7ee21728f146b41c04b54be8a6cdbf6cc39f90f\nSHA256: aa121762eb34d32c7d831d7abcec34f5a4241af9e669e5cc43a49a071bd6e894\n\n```\nPrior Aggah campaigns abused Microsoft Office Documents containing VBA macros and this round remains the same.\nThis Covid-19 themed .ppa file contained a very small VBA Macro that ran on Auto_Open and executed a simple mshta\ncall. This execution method remains consistent, but the macro is crafted in a slightly different way.\n\n\n-----\n\nFigure 1: .PPA\n\nFile VBA Macros\n\n## Stage 2: HTML File Containing WScript\n```\nFilename: gdhamksgdsadj.html | divine111.html\nMD5: e2370c77c35232bae8eca686d3c1126e\nSHA1: 20d096705b1b09d8f7d7af6c09ed61a8e8e714e2\nSHA256: 8d74ac866d8972e6725ffb573dbeec57d248bf5da5f4a555e1bd1d68cff12caa\n\n```\nStage 1 of the Aggah dropper executes mshta hxxp://bitly[.]com/gdhamksgdsadj. The bit.ly URL redirects to\nhxxps://onedayiwillloveyouforever[.]blogspot[.]com/p/divine111.html, a mostly blank Blogspot page that contains\nsome malicious VBScript.\n\n\n-----\n\ndivine111.html contains malicious VBScript\n\nMalicious VBScript contained in divine111.html\nThe VBScript stashed in the HTML document performs the following:\n\nDownloads an additional payload from the following BitBucket URL:\n\n\nFigure 2: Stage 2\n\nFigure 3:\n\n\nhxxps://bitbucket[.]org/!api/2.0/snippets/hogya/5X7My8/b271c1b3c7a78e7b68fa388ed463c7cc1dc32ddb/files/divine12â€³\n\n\n-----\n\nReverses and base64 decodes the payload from the above URL\n\nCreates a scheduled task to download and execute a payload hosted at the following BlogSpot URL (Note: This\npayload contains the same VBS payload as in divine111.html):\n\nhxxps://madarbloghogya[.]blogspot[.]com/p/divineback222.[]html\n\nFigure 4:\n\nPersistence via Scheduled Task\nWhile the VBScript obfuscation is relatively light, one interesting thing to note is the usage of CLSIDs when creating\nnew objects. Directly referencing CLSIDs during object creation is fairly uncommon and could be useful for creating a\nYara rule.\n```\nset MicrosoftWINdows = GetObject(\"new:F935DC22-1CF0-11D0-ADB9-00C04FD58A0B\")\nSet Somosa = GetObject(\"new:13709620-C279-11CE-A49E-444553540000\")\n\n## Stage 3: Obfuscated VBScript Containing Encoded PE File\nFilename: divine1-2\nMD5: ace852b1489826d80ea0b3fc1e1a3ccd\nSHA1: 1391fe80309f38addb1fc011eb8d3fefecf4ac73\nSHA256: c4f374f18ed5aba573b6883981a8074b86b79c2bdc314af234e98bed69623686\n\n```\nThe final stage of Aggah is built around deobfuscating and executing the final payload, which is embedded in the\ndocument: Agent Tesla (for this campaign, at least). According to the comment at the top of the VBScript, this stage of\nAggah was updated 11/18/2021.\n\n\n-----\n\nFigure 5: Third\n\nStage of Aggah last updated 11/18/2021.\n\nThe VBScript in this stage deobfuscates the embedded Agent Tesla payload, adds it to startup and executes the\npayload. There are three main functions that handle deobfuscation, seen below.\n\nFigure 6: Functions Used to\n\nDeobfuscate Payload\n\nFigure 7: Building\n\nPowerShell Command to Create Persistence and Execute Payload\n\n\n-----\n\nOnce the replacements and substitutions are made, we see an old friend reappear. After a simple base64 decode,\nweâ€™re left with our payload: Agent Tesla.\n\nFigure 8: Base64\n\nExe, Anyone?\n\n## Stage 4: Agent Tesla\n```\nFilename: MVuVmuzKeduVVeroJXAhxJFg.exe\nMD5: d6373ce833327ecb3afeb81b62729ec9\nSHA1: a80137dc1ffe68fa1527bab0933471f28b9c29df\nSHA256: 3bb3440898b6e2b0859d6ff66f760daaa874e1a25b029c0464944b5fc2f5a903\n\n```\n[Agent Tesla is a .NET based keylogger and RAT readily available to actors and is one of the RATs preferred by Aggah.](https://malpedia.caad.fkie.fraunhofer.de/details/win.agent_tesla)\nIt logs keystrokes, the hostâ€™s clipboard and steals various credentials and beacons this information back to the C2. This\nparticular sample was surprisingly not packed, which is relatively uncommon.\n\nAgent Tesla is known to steal a wide-variety of stored/cached credentials. The strings containing the targeted\napplications are typically encoded/encrypted, but are typically easily extracted in a debugger. The sections below walk\nthrough extracting the strings/configuration of this Agent Tesla sample and contain a Yara rule for detection.\n\n### String/Configuration Extraction\n\nWhile the Agent Tesla payload delivered in this campaign was not packed, the configuration as well as the strings\nrelated to information stealing are hidden. The Agent Tesla sample uses the following function to decode these strings\nduring runtime to make static detection more difficult.\n\nFigure 9:\n\nConfig/String Decode Function\nThe decode function consists of an incremental xor as well as a static xor by key 0xAA (170). While this decode function\ncould be easily implemented with Python or any language of choice, dnSpy was used as it aided in creating the Yara\nrule in the next step. In order to debug properly, the Agent Tesla sample must first be run through de4dot to clean up\nvariable names. Once the sample has been cleaned, a watch can be set on the byte array `byte_0 and the contents`\ncan be saved once the decode loop has completed.\n\n\n-----\n\nFigure 10:\n\nDecode Loop Cleaned up by de4dot\nOnce a watch for the byte array `byte_0 is set, the decode loop is allowed to complete and decode the configuration`\nand strings. The decoded content in `byte_0 can then be saved to a file.`\n\nFigure 11: Byte\n\nArray Decoded\nAfter saving the contents from dnSpy to a file, the configuration and strings appear in cleartext, providing information\naround types of data being collected, exfiltration method, etc.\n\nFigure 12:\n\nDecoded Configuration and Strings\n\n### Agent Tesla Yara Rule\n\n\n-----\n\nWhile this Agent Tesla sample did not contain a great number of strings that would allow creation of an effective Yara\nrule, one could certainly be created. However, targeting the strings alone will likely not result in a robust Yara rule. A\nbetter approach might be to target the decode loop covered in the previous section. This blog post will not cover indepth writing rules based on IL, however, Stephan Simon of Binary Defense put out a great blog post that covers this\ntopic very well.\n\ndnSpy provides an option for decompilation to IL. After selecting IL as the decompilation language, the decode loop can\nbe seen in IL form. This [link serves as an excellent reference when reading IL and writing Yara rules targeting it. The](https://en.wikipedia.org/wiki/List_of_CIL_instructions)\nYara rule below breaks down each IL instruction and relates it to the corresponding portion of the decode loop.\n\nFigure 13:\n\nDecode Loop Decompiled to IL\nNote: The rules below should be tested before being implemented in a production environment (especially the second\none). Iâ€™m not responsible for blowing up your environment! ðŸ™‚\n```\nrule Classification_Agent_Tesla {\n  meta:\n  author = \"muzi\"\n  date = \"2021-12-02\"\n  description = \"Detects Agent Tesla delivered by Aggah Campaign in November 2021.\"\n  hash = \"3bb3440898b6e2b0859d6ff66f760daaa874e1a25b029c0464944b5fc2f5a903\"\n  strings:\n    $string_decryption = {\n                91              // byte array[i]\n                (06|07|08|09)        // push local var\n                61              // xor array[i] ^ 0xAA (const xor key)\n                20 [4]            // push const xor key (170 or 0xAA in example)\n                61              // xor array[i] ^ i\n                D2              // convert to unsigned int8 and push int32 to\nstack\n                9C              // Replace array element at index with int8 value\non stack\n                (06|07|08|09)        // push local var\n                17              // push 1\n                58              // add i +=1\n                (0A|0B|0C|0D)        // pop value from stack into local var\n                (06|07|08|09)        // push local var\n                7E [4]            // push value of static field on stack (byte\narray)\n                8E              // push length of array onto stack\n                69              // convert to int32\n                FE (04|05)          // conditional if i >= len(bytearray)\n    }\n  condition:\n    all of them\n}\n\n```\n\n-----\n\n```\n      p j {\n  meta:\n  author = \"muzi\"\n  date = \"2021-12-02\"\n  description = \"Detects various CLSIDs used to create objects rather than their object name.\"\n  hash = \"9b36b76445f76b411983d5fb8e64716226f62d284c673599d8c54decdc80c712\"\n  strings:\n    $clsid_windows_script_host_shell_object = \"F935DC22-1CF0-11D0-ADB9-00C04FD58A0B\" ascii wide nocase\n    $clsid_shell = \"13709620-C279-11CE-A49E-444553540000\" ascii wide nocase\n    $clsid_mmc = \"49B2791A-B1AE-4C90-9B8E-E860BA07F889\" ascii wide nocase\n    $clsid_windows_script_host_shell_object_2 = \"72C24DD5-D70A-438B-8A42-98424B88AFB8\" ascii wide nocase\n    $clsid_filesystem_object = \"0D43FE01-F093-11CF-8940-00A0C9054228\" ascii wide nocase\n  condition:\n    any of them\n}\n\n```\n[agenttesla](https://malwarebookreports.com/tag/agenttesla/) [aggah](https://malwarebookreports.com/tag/aggah/) [malware](https://malwarebookreports.com/tag/malware/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-06 - AGENT TESLAGGAH.pdf"
    ],
    "report_names": [
        "2021-12-06 - AGENT TESLAGGAH.pdf"
    ],
    "threat_actors": [
        {
            "id": "28851008-77b4-47eb-abcd-1bb5b3f19fc2",
            "created_at": "2023-06-20T02:02:10.254614Z",
            "updated_at": "2025-03-27T02:00:03.130853Z",
            "deleted_at": null,
            "main_name": "Hagga",
            "aliases": [
                "TH-157",
                "Aggah"
            ],
            "source_name": "MISPGALAXY:Hagga",
            "tools": [
                "Agent Tesla"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6c4e4b91-1f98-49e2-90e6-435cea8d3d53",
            "created_at": "2022-10-25T16:07:23.693797Z",
            "updated_at": "2025-03-27T02:02:09.924056Z",
            "deleted_at": null,
            "main_name": "Gorgon Group",
            "aliases": [
                "ATK 92",
                "Pasty Draco",
                "Subaat",
                "TAG-CR5"
            ],
            "source_name": "ETDA:Gorgon Group",
            "tools": [
                "AgenTesla",
                "Agent Tesla",
                "AgentTesla",
                "Atros2.CKPN",
                "Bladabindi",
                "CinaRAT",
                "Crimson RAT",
                "ForeIT",
                "Jorik",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Loki",
                "Loki.Rat",
                "LokiBot",
                "LokiPWS",
                "MSIL",
                "MSIL/Crimson",
                "Nancrat",
                "NanoCore",
                "NanoCore RAT",
                "Negasteal",
                "NetWeird",
                "NetWire",
                "NetWire RAT",
                "NetWire RC",
                "NetWired RC",
                "Origin Logger",
                "Quasar RAT",
                "QuasarRAT",
                "Recam",
                "Remcos",
                "RemcosRAT",
                "Remvio",
                "Revenge RAT",
                "RevengeRAT",
                "Revetrat",
                "SEEDOOR",
                "Scarimson",
                "Socmer",
                "Yggdrasil",
                "ZPAQ",
                "Zurten",
                "njRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b0d34dd6-ee90-483b-bb6c-441332274160",
            "created_at": "2022-10-25T16:07:23.296754Z",
            "updated_at": "2025-03-27T02:02:09.724313Z",
            "deleted_at": null,
            "main_name": "Aggah",
            "aliases": [
                "Operation Red Deer",
                "Operation Roma225"
            ],
            "source_name": "ETDA:Aggah",
            "tools": [
                "AgenTesla",
                "Agent Tesla",
                "AgentTesla",
                "Aggah",
                "Atros2.CKPN",
                "Bladabindi",
                "Jorik",
                "Nancrat",
                "NanoCore",
                "NanoCore RAT",
                "Negasteal",
                "Origin Logger",
                "Revenge RAT",
                "RevengeRAT",
                "Revetrat",
                "Warzone",
                "Warzone RAT",
                "ZPAQ",
                "Zurten",
                "njRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "66fc98f4-8978-401e-9b73-81c3d5f1e44c",
            "created_at": "2024-05-01T02:03:08.050109Z",
            "updated_at": "2025-03-27T02:05:17.327953Z",
            "deleted_at": null,
            "main_name": "COPPER FIELDSTONE",
            "aliases": [
                "Gorgon Group",
                "Green Havildar ",
                "Mythic Leopard ",
                "Operation C-Major ",
                "Operation Transparent Tribe ",
                "Pasty Draco ",
                "ProjectM ",
                "Storm-0156 ",
                "APT36 "
            ],
            "source_name": "Secureworks:COPPER FIELDSTONE",
            "tools": [
                " DarkComet",
                " LuminosityLink",
                " Peppy",
                " njRAT",
                "Crimson RAT"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "18278778-fa63-4a9a-8988-4d266b8c5c1a",
            "created_at": "2023-01-06T13:46:38.769816Z",
            "updated_at": "2025-03-27T02:00:02.914024Z",
            "deleted_at": null,
            "main_name": "The Gorgon Group",
            "aliases": [
                "ATK92",
                "G0078",
                "Pasty Gemini",
                "Gorgon Group",
                "Subaat"
            ],
            "source_name": "MISPGALAXY:The Gorgon Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "97fdaf9f-cae1-4ccc-abe2-76e5cbc0febd",
            "created_at": "2022-10-25T15:50:23.296989Z",
            "updated_at": "2025-03-27T02:00:55.432751Z",
            "deleted_at": null,
            "main_name": "Gorgon Group",
            "aliases": [
                "Gorgon Group"
            ],
            "source_name": "MITRE:Gorgon Group",
            "tools": [
                "NanoCore",
                "QuasarRAT",
                "Remcos",
                "njRAT"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535908,
    "ts_updated_at": 1743041706,
    "ts_creation_date": 1653756481,
    "ts_modification_date": 1653756481,
    "files": {
        "pdf": "https://archive.orkl.eu/38f935e93daa6210cf183731b294cb92979b0eee.pdf",
        "text": "https://archive.orkl.eu/38f935e93daa6210cf183731b294cb92979b0eee.txt",
        "img": "https://archive.orkl.eu/38f935e93daa6210cf183731b294cb92979b0eee.jpg"
    }
}