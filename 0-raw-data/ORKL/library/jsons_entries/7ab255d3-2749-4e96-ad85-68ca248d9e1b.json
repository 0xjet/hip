{
    "id": "7ab255d3-2749-4e96-ad85-68ca248d9e1b",
    "created_at": "2023-01-12T15:02:29.160892Z",
    "updated_at": "2025-03-27T02:09:30.370552Z",
    "deleted_at": null,
    "sha1_hash": "97ef7a799dbac87a9864e5a21c5ae4bcb4b54866",
    "title": "2019-07-24 - A deep dive into Phobos ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T02:32:49Z",
    "file_modification_date": "2022-05-28T02:32:49Z",
    "file_size": 1673275,
    "plain_text": "# A deep dive into Phobos ransomware\n\n**[blog.malwarebytes.com/threat-analysis/2019/07/a-deep-dive-into-phobos-ransomware/](https://blog.malwarebytes.com/threat-analysis/2019/07/a-deep-dive-into-phobos-ransomware/)**\n\nhasherezade July 24, 2019\n\n[Phobos ransomware appeared at the beginning of 2019. It has been noted that this new](https://www.coveware.com/blog/phobos-ransomware-distributed-dharma-crew)\nstrain of ransomware is strongly based on the previously known family: Dharma (a.k.a.\n[CrySis), and probably distributed by the same group as Dharma.](https://www.zdnet.com/article/new-phobos-ransomware-exploits-weak-security-to-hit-targets-around-the-world/)\n\nWhile attribution is by no means conclusive, you can read more about potential links\n[between Phobos and Dharma here, to include an intriguing connection with the XDedic](https://www.coveware.com/blog/phobos-ransomware-distributed-dharma-crew)\nmarketplace.\n\n[Phobos is one of the ransomware that are distributed via hacked Remote Desktop (RDP)](https://www.malwarebytes.com/ransomware)\nconnections. This isn’t surprising, as hacked RDP servers are a cheap commodity on the\nunderground market, and can make for an attractive and cost efficient dissemination vector\nfor threat groups.\n\nIn this post we will take a look at the implementation of the mechanisms used in Phobos\nransomware, as well as at its internal similarity to Dharma.\n\n## Analyzed sample\n\n[a91491f45b851a07f91ba5a200967921bf796d38677786de51a4a8fe5ddeafd2](https://www.virustotal.com/gui/file/a91491f45b851a07f91ba5a200967921bf796d38677786de51a4a8fe5ddeafd2/detection)\n\n## Behavioral analysis\n\n\n-----\n\nThis ransomware does not deploy any techniques of UAC bypass. When we try to run it\nmanually, the UAC confirmation pops up:\n\nIf we accept it, the main process deploys another copy of itself, with elevated privileges. It\nalso executes some commands via windows shell.\n\nRansom notes of two types are being dropped: .txt as well as .hta. After the encryption\nprocess is finished, the ransom note in the .hta form is popped up:\n\nRansom note in the .hta version\n\n\n-----\n\nRansom note in the .txt version\nEven after the initial ransom note is popped up, the malware still runs in the background, and\nkeeps encrypting newly created files.\n\nAll local disks, as well as network shares are attacked.\n\nIt also uses several persistence mechanisms: installs itself in %APPDATA% and in a Startup\nfolder, adding the registry keys to autostart its process when the system is restarted.\n\nA view from Sysinternals’ Autoruns\nThose mechanisms make Phobos ransomware very aggressive: the infection didn’t end on a\nsingle run, but can be repeated multiple times. To prevent repeated infection, we should\nremove all the persistence mechanisms as soon as we noticed that we got attacked by\nPhobos.\n\n**The Encryption Process**\n\nThe ransomware is able to encrypt files without an internet connection (at this point we can\nguess that it comes with some hardcoded public key). Each file is encrypted with an\nindividual key or an initialization vector: the same plaintext generates a different ciphertext.\n\nIt encrypts a variety of files, including executables. The encrypted files have an e-mail of the\nattacker added. The particular variant of Phobos also adds an extension ‘.acute’ – however\nin different variants different extensions have been encountered. The general pattern is:\n```\n<original name>.id[<victim ID>-<version ID>][<attacker's e-mail>].<added\nextention>\n\n```\nVisualization of the encrypted content does not display any recognizable patterns. It\nsuggests that either a stream cipher, or a cipher with chained blocks was used (possibly AES\nin CBC mode). Example – a simple BMP before and after encryption:\n\n\n-----\n\nWhen we look inside the encrypted file, we can see a particular block at the end. It is\nseparated from the encrypted content by ‘0’ bytes padding. The first 16 bytes of this block\nare unique per each file (possible Initialization Vector). Then comes the block of 128 bytes\nthat is the same in each file from the same infection. That possibly means that this block\ncontains the encrypted key, that is uniquely generated each run. At the end we can find a 6character long keyword which is typical for this ransomware. In this case it is ‘LOCK96’,\nhowever, different versions of Phobos have been observed with different keywords, i.e.\n‘DAT260’.\n\nIn order to fully understand the encryption process, we will look inside the code.\n\n## Inside\n\nIn contrast to most of the malware that comes protected by some crypter, Phobos is not\npacked or obfuscated. Although the lack of packing is not common in general population of\nmalware, it is common among malware that are distributed manually by the attackers.\n\nThe execution starts in WinMain function:\n\n\n-----\n\nDuring its execution, Phobos starts several threads, responsible for its different actions, such\nas: killing blacklisted processes, deploying commands from commandline, encrypting\naccessible drives and network shares.\n\n**Used obfuscation**\n\nThe code of the ransomware is not packed or obfuscated. However, some constants,\nincluding strings, are protected by AES and decrypted on demand. A particular string can be\nrequested by its index, for example:\n\nThe AES key used for this purpose is hardcoded (in obfuscated form), and imported each\ntime when a chunk of data needs to be decrypted.\n\nDecrypted content of the AES key\nThe Initialization Vector is set to 16 NULL bytes.\n\nThe code responsible for loading the AES key is given below. The function wraps the key\ninto a [BLOBHEADER structure, which is then imported.](https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/ns-wincrypt-publickeystruc)\n\n\n-----\n\nFrom the [BLOBHEADER structure we can read the following information: 0x8 –](https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/ns-wincrypt-publickeystruc)\nPLAINTEXTKEYBLOB, 0x2=CUR_BLOB_VERSION, 0x6610 – CALG_AES_256.\n\nExample of a decrypted string:\n\nAmong the decrypted strings we can also see the list of the attacked extensions\n\nWe can also find a list of some keywords:\n```\nacute actin Acton actor Acuff Acuna acute adage Adair Adame banhu banjo\nBanks Banta Barak Caleb Cales Caley calix Calle Calum Calvo deuce Dever\ndevil Devoe Devon Devos dewar eight eject eking Elbie elbow elder phobos\nhelp blend bqux com mamba KARLOS DDoS phoenix PLUT karma bbc CAPITAL\n\n```\n\n-----\n\nThese are a list of possible extensions used by this ransomware. They are (probably) used\nto recognize and skip the files which already has been encrypted by a ransomware from this\nfamily. The extension that will be used in the current encryption round is hardcoded.\n\nOne of the encrypted strings specifies the formula for the file extension, that is later filled with\nthe Victim ID:\n\n```\nUNICODE \".id[<unique ID>-1096].[lockhelp@qq.com].acute\"\n\n```\n\n**Killing processes**\n\nThe ransomware comes with a list of processes that it kills before the encryption is deployed.\nJust like other strings, the full list is decrypted on demand:\n```\nmsftesql.exe sqlagent.exe sqlbrowser.exe sqlservr.exe sqlwriter.exe\noracle.exe ocssd.exe dbsnmp.exe synctime.exe agntsvc.exe\nmydesktopqos.exe isqlplussvc.exe xfssvccon.exe mydesktopservice.exe\nocautoupds.exe agntsvc.exe agntsvc.exe agntsvc.exe encsvc.exe\nfirefoxconfig.exe tbirdconfig.exe ocomm.exe mysqld.exe mysqld-nt.exe\nmysqld-opt.exe dbeng50.exe sqbcoreservice.exe excel.exe infopath.exe\nmsaccess.exe mspub.exe onenote.exe outlook.exe powerpnt.exe steam.exe\nthebat.exe thebat64.exe thunderbird.exe visio.exe winword.exe\nwordpad.exe\n\n```\nThose processes are killed so that they will not block access to the files that are going to be\nencrypted.\n\n\n-----\n\na fragment of the function\n\nenumerating and killing processes\n\n**Deployed commands**\n\nThe ransomware deploys several commands from the commandline. Those commands are\nsupposed to prevent from recovering encrypted files from any backups.\n\nDeleting the shadow copies:\n```\nvssadmin delete shadows /all /quiet\nwmic shadowcopy delete\n\n```\nChanging Bcdedit options (preventing booting the system in a recovery mode):\n```\nbcdedit /set {default} bootstatuspolicy ignoreallfailures\nbcdedit /set {default} recoveryenabled no\n\n```\nDeletes the backup catalog on the local computer:\n```\nwbadmin delete catalog -quiet\n\n```\n\n-----\n\nIt also disables firewall:\n```\nnetsh advfirewall set currentprofile state off\nnetsh firewall set opmode mode=disable\nexit\n\n```\n**Attacked targets**\n\nBefore the Phobos starts its malicious actions, it checks system locale (using\n[GetLocaleInfoW options:](https://docs.microsoft.com/en-us/windows/win32/api/winnls/nf-winnls-getlocaleinfow) [LOCALE_SYSTEM_DEFAULT,](https://docs.microsoft.com/en-us/windows/win32/intl/locale-system-default) [LOCALE_FONTSIGNATURE ). It](https://www.pinvoke.net/default.aspx/Enums/LCType.html)\nterminates execution in case if the 9th bit of the output is cleared. The 9th bit represent Cyrlic\nalphabets – so, the systems that have set it as default are not affected.\n\nBoth local drives and network shares are encrypted.\n\nBefore the encryption starts, Phobos lists all the files, and compare their names against the\nhardcoded lists. The lists are stored inside the binary in AES encrypted form, strings are\nseparated by the delimiter ‘;’.\n\nFragment of the function\n\ndecrypting and parsing the hardcoded lists\nAmong those lists, we can find i.e. blacklist (those files will be skipped). Those files are\nrelated to operating system, plus the info.txt, info.hta files are the names of the Phobos\nransom notes:\n\n```\nboot.ini\n\n```\n```\nbootfont.bin\n\n```\n```\nntldr\n\n```\n```\nntdetect.com\n\n```\n```\nio.sys\n\n```\n\n-----\n\nThere is also a list of directories to be skipped – in the analyzed case it contains only one\ndirectory: `C:\\Windows .`\n\nAmong the skipped files are also the extensions that are used by Phobos variants, that were\nmentioned before.\n\nThere is also a pretty long whitelist of extensions:\n```\n1cd 3ds 3fr 3g2 3gp 7z accda accdb accdc accde accdt accdw adb adp ai ai3\nai4 ai5 ai6 ai7 ai8 anim arw as asa asc ascx asm asmx asp aspx asr asx avi\navs backup bak bay bd bin bmp bz2 c cdr cer cf cfc cfm cfml cfu chm cin\nclass clx config cpp cr2 crt crw cs css csv cub dae dat db dbf dbx dc3 dcm\ndcr der dib dic dif divx djvu dng doc docm docx dot dotm dotx dpx dqy dsn dt\ndtd dwg dwt dx dxf edml efd elf emf emz epf eps epsf epsp erf exr f4v fido\nflm flv frm fxg geo gif grs gz h hdr hpp hta htc htm html icb ics iff inc\nindd ini iqy j2c j2k java jp2 jpc jpe jpeg jpf jpg jpx js jsf json jsp kdc\nkmz kwm lasso lbi lgf lgp log m1v m4a m4v max md mda mdb mde mdf mdw mef mft\nmfw mht mhtml mka mkidx mkv mos mov mp3 mp4 mpeg mpg mpv mrw msg mxl myd myi\nnef nrw obj odb odc odm odp ods oft one onepkg onetoc2 opt oqy orf p12 p7b\np7c pam pbm pct pcx pdd pdf pdp pef pem pff pfm pfx pgm php php3 php4 php5\nphtml pict pl pls pm png pnm pot potm potx ppa ppam ppm pps ppsm ppt pptm\npptx prn ps psb psd pst ptx pub pwm pxr py qt r3d raf rar raw rdf rgbe rle\nrqy rss rtf rw2 rwl safe sct sdpx shtm shtml slk sln sql sr2 srf srw ssi st\nstm svg svgz swf tab tar tbb tbi tbk tdi tga thmx tif tiff tld torrent tpl\ntxt u3d udl uxdc vb vbs vcs vda vdr vdw vdx vrp vsd vss vst vsw vsx vtm vtml\nvtx wb2 wav wbm wbmp wim wmf wml wmv wpd wps x3f xl xla xlam xlk xlm xls\nxlsb xlsm xlsx xlt xltm xltx xlw xml xps xsd xsf xsl xslt xsn xtp xtp2 xyze\nxz zip\n\n```\n**How does the encryption work**\n\nPhobos uses the WindowsCrypto API for encryption of files. There are several parallel\nthreads to deploy encryption on each accessible disk or a network share.\n\nDeploying the encrypting thread\n\nAES key is created prior to the encrypting thread being run, and it is passed in the thread\nparameter.\n\n\n-----\n\nFragment of the key generation function:\n\nCalling the\n\nfunction generating the AES key (32 bytes)\nAlthough the AES key is common to all the files that are encrypted in a single round, yet,\neach file is encrypted with a different initialization vector. The initialization vector is 16 bytes\nlong, generated just before the file is open, and then passed to the encrypting function:\n\n\n-----\n\nCalling the function generating the AES IV (16\n\nbytes)\nUnderneath, the AES key and the Initialization Vector both are generated with the help of the\nsame function, that is a wrapper of `CryptGenRandom (a strong random generator):`\n\nThe AES IV is later appended to the content of the encryped file in a cleartext form. We can\nsee it on the following example:\n\nBefore the file encryption function is executed, the random IV is being generated:\n\nThe AES key, that was passed to the thread is being imported to the context\n( CryptImportKey ), as well the IV is being set. We can see that the read file content is\nencrypted:\n\n\n-----\n\nAfter the content of the file is encrypted, it is being saved into the newly created file, with the\nransomware extension.\n\nThe ransomware creates a block with metadata, including checksums, and the original file\nname. After this block, the random IV is being stored, and finally, the block containing the\nencrypted AES key. The last element is the file marker: “LOCK96”:\n\nBefore being written to the file, the metadata block is being encrypted using the same AES\nkey and IV as the file content.\n\n\n-----\n\nsetting the AES\n\n\nkey before encrypting the metadata block\nEncrypted metadata block:\n\nFinally, the content is appended to the end of the newly created file:\n\n\n-----\n\nBeing a ransomware researcher, the common question that we want to answer is whether or\nnot the ransomware is decryptable – meaning, if it contains the weakness allowing to recover\nthe files without paying the ransom. The first thing to look at is how the encryption of the files\nis implemented. Unfortunately, as we can see from the above analysis, the used encryption\nalgorithm is secure. It is AES, with a random key and initialization vector, both created by a\nsecure random generator. The used implementation is also valid: the authors decided to use\nthe Windows Crypto API.\n\n**Encrypting big files**\n\nPhobos uses a different algorithm to encrypt big files (above 0x180000 bytes long). The\nalgorithm explained above was used for encrypting files of typical size (in such case the full\nfile was encrypted, from the beginning to the end). In case of big files, the main algorithm is\nsimilar, however only some parts of the content are selected for encryption.\n\n\n-----\n\nWe can see it on the following example. The file ‘test.bin’ was filled with 0xAA bytes. Its\noriginal size was 0x77F87FF:\n\nAfter being encrypted with Phobos, we see the following changes:\n\nSome fragments of the file has been left unencrypted. Between of them, starting from the\nbeginning, some fragments are wiped. Some random-looking block of bytes has been\nappended to the end of the file, after the original size. We can guess that this is the\n\n\n-----\n\nencrypted content of the wiped fragments. At the very end of the file, we can see a block of\ndata typical for Phobos::\n\nLooking inside we can see the reason of such an alignment. Only 3 chunks from the large file\nare being read into a buffer. Each chunk is 0x40000 bytes long:\n\n\n-----\n\nAll read chunks are merged together into one buffer. After this content, usual metadata\n(checksums, original file name) are added, and the full buffer is encrypted:\n\n\n-----\n\nBy this way, authors of Phobos tried to minimize the time taken for encryption of large files,\nand at the same time maximize the damage done.\n\n**How is the AES key protected**\n\nThe next element that we need to check in order to analyze decryptability is the way in which\nthe authors decided to store the generated key.\n\nIn case of Phobos, the AES key is encrypted just after being created. Its encrypted form is\nlater appended at the end of the attacked file (in the aforementioned block of 128 bytes).\nLet’s take a closer look at the function responsible for encrypting the AES key.\n\nThe function generating and protecting the AES key is deployed before the each encrypting\nthread is started. Looking inside, we can see that first several variables are decrypted, in the\nsame way as the aforementioned strings.\n\n\n-----\n\nDecryption of the constants\nOne of the decrypted elements is the following buffer:\n\nIt turns out that the decrypted block of 128 bytes is a public RSA key of the attacker. This\nbuffer is then verified with the help of a checksum. A checksum of the RSA key is compared\nwith the hardcoded one. In case if both matches, the size that will be used for AES key\ngeneration is set to 32. Otherwise, it is set to 4.\n\nThen a buffer of random bytes is generated for the AES key\n\n\n-----\n\nAfter being generated, the AES key is protected with the help of the hardcoded public key.\nThis time the authors decided to not use Windows Crypto API, but an external library.\n[Detailed analysis helped us to identify that it is the specific implementation of RSA algorithm](https://github.com/joyent/syslinux/blob/master/gpxe/src/crypto/axtls/rsa.c)\n[(special thanks to Mark Lechtik for the help).](https://twitter.com/_marklech_)\n\nThe decrypted 128 bytes long RSA key is imported with the help of the function\n```\nRSA_pub_key_new . After that, the imported RSA key is used for encryption of the random\n\n```\nAES key:\n\nSumming up, the AES key seems to be protected correctly, which is bad news for the victims\nof this ransomware.\n\n**Attacking network shares**\n\nPhobos has a separate thread dedicated to attacking network shares.\n\nNetwork shares are enumerated in a loop:\n\n\n-----\n\n**Comparison with Dharma**\n\nPrevious sources references Phobos as strongly based on Dharma ransomware. However,\nthat comparison was based mostly on the outer look: a very similar ransom note, and the\nnaming convention used for the encrypted files. The real answer in to this question would lie\nin the code. Let’s have a look at both, and compare them together. This comparison will be\nbased on the current sample of Phobos, with a Dharma sample\n[(d50f69f0d3a73c0a58d2ad08aedac1c8).](https://www.virustotal.com/gui/file/c2ab289cbd2573572c39cac3f234d77fdf769e48a1715a14feddaea8ae9d9702/details)\n\nIf we compare both with the help of BinDiff, we can see some similarities, but also a lot of\nmismatching functions.\n\n\n-----\n\nFragment of code comparison: Phobos vs Dharma\nIn contrast to Phobos, Dharma loads the majority of its imports dynamically, making the code\na bit more difficult to analyze.\n\nDharma loads\n\nmosts of its imports at the beginning of execution\nAddresses of the imported functions are stored in an additional array, and every call takes an\nadditional jump to the value of this array. Example:\n\nIn contrast, Phobos has a typical, unobfuscated Import Table\n\nBefore the encryption routine is started, Dharma sets a mutex:\n“Global\\syncronize_<hardcoded ID>”.\n\nBoth, Phobos and Dharma use the same implementation of the RSA algorithm, from a static\nlibrary. Fragment of code from Dharma:\n\n\n-----\n\nThe fragment of the\n\nfunction “bi_mod_power” from:\n[https://github.com/joyent/syslinux/blob/master/gpxe/src/crypto/axtls/bigint.c#L1371](https://github.com/joyent/syslinux/blob/master/gpxe/src/crypto/axtls/bigint.c#L1371)\nFile encryption is implemented similarly in both. However, while Dharma uses AES\nimplementation from the same static library, Phobos uses AES from Windows Crypto API.\n\n\n-----\n\nFragment of the AES implementation from Dharma ransomware\nLooking at how the key is saved in the file, we can also see some similarities. The protected\nAES key is stored in the block at the end of the encrypted file. At the beginning of this block\nwe can see some metadata that are similar like in Phobos, for example the original file name\n(in Phobos this data is encrypted). Then there is a 6 character long identifier, selected from a\nhardcoded pool.\n\nThe\n\nblock at the end of a file encrypted by Dharma\nSuch identifier occurs also in Phobos, but there it is stored at the very end of the block. In\ncase of Phobos this identifier is constant for a particular sample.\n\n\n-----\n\nThe\n\nblock at the end of a file encrypted by Phobos\n\n**Conclusion**\n\nPhobos is an average ransomware, by no means showing any novelty. Looking at its\ninternals, we can conclude that while it is not an exact rip-off Dharma, there are significant\nsimilarities between both of them, suggesting the same authors. The overlaps are at the\nconceptual level, as well as in the same RSA implementation used.\n\nAs with other threats, it is important to make sure your assets are secure to prevent such\ncompromises. In this particular case, businesses should review any machines where Remote\nDesktop Procol (RDP) access has been enabled and either disable it if it is not needed, or\nmaking sure the credentials are strong to prevent such things are brute-forcing.\n\n[Malwarebytes for business protects against Phobos ransomware via its Anti-Ransomware](https://www.malwarebytes.com/business/)\nprotection module:\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-24 - A deep dive into Phobos ransomware.pdf"
    ],
    "report_names": [
        "2019-07-24 - A deep dive into Phobos ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "20c759c2-cd02-45bb-85c6-41bde9e6a7cf",
            "created_at": "2024-01-18T02:02:34.189827Z",
            "updated_at": "2025-03-27T02:02:09.937024Z",
            "deleted_at": null,
            "main_name": "HomeLand Justice",
            "aliases": [
                "Karma",
                "Storm-842",
                "Void Manticore"
            ],
            "source_name": "ETDA:HomeLand Justice",
            "tools": [
                "BABYWIPER",
                "BiBi Wiper",
                "BiBi-Linux Wiper",
                "BiBi-Windows Wiper",
                "Cl Wiper",
                "LowEraser",
                "No-Justice Wiper",
                "Plink",
                "PuTTY Link",
                "RevSocks",
                "W2K Res Kit"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535749,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1653705169,
    "ts_modification_date": 1653705169,
    "files": {
        "pdf": "https://archive.orkl.eu/97ef7a799dbac87a9864e5a21c5ae4bcb4b54866.pdf",
        "text": "https://archive.orkl.eu/97ef7a799dbac87a9864e5a21c5ae4bcb4b54866.txt",
        "img": "https://archive.orkl.eu/97ef7a799dbac87a9864e5a21c5ae4bcb4b54866.jpg"
    }
}