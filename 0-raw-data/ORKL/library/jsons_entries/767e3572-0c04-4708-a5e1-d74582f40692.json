{
    "id": "767e3572-0c04-4708-a5e1-d74582f40692",
    "created_at": "2023-01-12T15:08:50.802912Z",
    "updated_at": "2025-03-27T02:05:58.579817Z",
    "deleted_at": null,
    "sha1_hash": "7892873e7189610a7703f3065d917ac667e4bd11",
    "title": "2017-05-24 - Analysis of Emotet v4",
    "authors": "",
    "file_creation_date": "2022-05-28T19:49:22Z",
    "file_modification_date": "2022-05-28T19:49:22Z",
    "file_size": 706531,
    "plain_text": "# Analysis of Emotet v4 | CERT Polska\n\n**cert.pl/en/news/single/analysis-of-emotet-v4/**\n\n## Introduction\n\n**[Emotet is a modular Trojan horse, which was firstly noticed in June 2014 by Trend Micro. This malware is related to other types like Geodo,](http://blog.trendmicro.com/trendlabs-security-intelligence/new-banking-malware-uses-network-sniffing-for-data-theft/)**\nBugat or Dridex, which are attributed by researches to the same family.\n\nEmotet was discovered as an advanced banker – it’s first campaign targeted clients of German and Austrian banks. Victims’ bank accounts\nwere infiltrated by a web browser infection which intercept communication between webpage and bank servers. In such scenario, malware\nhooks specific routines to sniff network activity and steal information. This technique is typical for modern banking malware and is widely\nknown as Man-in-the-Browser attack.\n\nNext, modified release of Emotet banker (v2) has taken advantage of another technique – automation of stealing money from hijacked bank\n[accounts using ATSs (Automated Transfer Systems, more informations on page 20 of CERT Polska Report 2013). This technology is also](https://www.cert.pl/uploads/2015/11/Report_CP_2013.pdf)\nused in other bankers. Good examples are ISFB (Gozi) or Tinba.\n\nAt the beginning of April 2017, we observed wide malspam campaign in Poland, distributing fraudulent mails. E-mails were imitating delivery\nnotifications from DHL logistics company and contained malicious link, which referred to brand-new, unknown variant of Emotet.\n\nMalware distributed in this campaign differed from previously known versions. Behavior and communication methods were similar, but malware\nused different encryption and we noticed significant changes in its code. Thus we called this modification version 4.\n\n## Dropper\n\nLinks from the phishing campaign pointed to a dropper, which downloaded and executed malware. Dropper was written in Javascript and\nwasn’t highly obfuscated. It was fairly easy to notice, that strings with distribution site URLs were just reversed.\n\nDistribution sites found in dropper:\n\n\n-----\n\np //et e ea ed a co u /do oad605 /\nhxxp://intecsoftware.com/download1577/\nhxxp://danirvinphotography.com/download0303/\nhxxp://brandcastersmedia.com/download6493/\nhxxp://aktech.com.pl/download9674/\n\n## Main module\n\nAn interesting thing in Emotet is its modular structure. Main module dropped by script doesn’t contain anything harmful and is used only to\ndownload another modules from C&C, which perform specific tasks. Sample dropped by script is protected using some generic packer to avoid\nrecognition by AV software.\n\nAfter unpacking, malware loads libraries and resolves WinAPI routines used in encryption and communication with C&C. Names of specific\n[functions are obfuscated and stored as array of hashes. Emotet uses simple sdbm hash function for this purpose. To make hashes more](http://www.cse.yorku.ca/~oz/hash.html)\nvaried, values are additionally XORed with some constant specified in binary.\n\nStrings that are distinctive for Emotet are also encoded using 4-byte XOR key, different for each string.\n\nMain executable file contains also a list of IP addresses of C&C servers. Similar to previous versions, sample communicates with\nCommand&Control using plain HTTP.\n\n## Encryption\n\nThe most significant change in new version is usage of different encryption algorithm. In previous releases, communication was encrypted\nusing RC4. In fourth version, Emotet switched to 128-bit AES in CBC mode.\n\nIntercepted request:\n\nGET / HTTP/1.1\n\nCookie:\nDD29=e8fd7YpIy2Ui+U7bz1/cQD9bH4KHshzaN2SpKoPEnC1D85K4Zrwdb6dBoHoDC5GgvcgecLN20kpk1lQxus6AJEiutWK4hBSWFbQUmtyr3Lx\nUser-Agent: Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 5.1; SLCC1; .NET CLR 1.1.4322)\n\nHost: 206.214.220.79:8080\n\nConnection: Keep-Alive\n\nCache-Control: no-cache\n\nRequest body is passed in Cookie header. Cookie’s key is random 16-bit hexadecimal number, with Base64-encoded binary blob as value.\n\nAfter decoding, structure of request is described below:\n\n**Offset** **Field name**\n\n0..95 asymmetrically encrypted 128-bit AES key used for request encryption\n\n96..115 SHA1 hash of plaintext request body\n\n116..x Request body, AES-128-CBC encrypted\n\nBefore sending, malware performs key generation. In the first stage, Emotet loads 768-bit RSA public key, stored in executable. Then, AES\nsymmetric key is generated using cryptographically secure PRNG (CryptGenKey). Finally, generated key is encrypted using previously loaded\npublic key and attached to the request using PKCS#1v2.0 (OAEP) padding.\n\nCryptography is based on Microsoft CryptoAPI mechanisms.\n\n**Key generation and public key import:**\n\n\n-----\n\n**equest e c ypt o**\n\n## Communication with C&C\n\nReceived response is presented below:\n\n[Communication protocol is based on Google Protocol Buffers. Protocol Buffers is a mechanism, which allows developers to simply build own](https://developers.google.com/protocol-buffers)\nprotocols using set of message structure declarations, written in a specific protobuf language. Protocol Buffers generates parsing and\nserializing modules, which can be directly used in developed solution. Protobuf supports wide set of languages, including Python, Java, PHP\n[or C++. Using this kind of mechanisms isn’t something new in malware, protobuf-based protocols can be found for example in Gootkit](https://securelist.com/blog/research/76433/inside-the-gootkit-cc-server/)\nmalware.\n\nUnfortunately, Emotet’s case is a bit different. Protobuf code inside malware is slightly modified and provides additional type of encoding,\nwhich is not specified in the original Protocol Buffers documentation. Because of this small difference, response can’t be properly decoded\nusing generic protobuf parsers e.g. protoc with –decode_raw argument fails.\n\nAnyway, original protocol definitions were successfully reversed:\n\nRegistration request contains command id (16) and some information about host operating system. Each field of RegistrationRequestBody\nstructure has been described below:\n\n**botId field**\n\nThis field provides information about values specific to victim’s machine and probably is meant to be unique between bot instances.\n\n[host_name]_[locale]_[host_id]\n\ne.g. CERTCERT_PL_32122958\n\n**host_name – contains only chars from 0..9a..zA..Z- charset, another chars are replaced by ‘?’**\n**locale – contains information about locale settings. In this case, dash ‘-‘ is also forbidden**\n**host_id – 32-bit hexadecimal value of sdbm hash (used also by API resolver) from current user login xored by Windows drive serial**\nnumber.\n\n**osVersion field**\n\n32-bit field, which describes version of Windows running on infected host. It’s a bit field, where each groups of bits contains specific value of\n[OSVERSIONINFOEX structure.](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724833.aspx)\n\n**Bits** **Description**\n\n0..3 dwMajorVersion\n\n4..7 dwMinorVersion\n\n8..11 wServicePackMajor\n\n12..15 wServicePackMinor\n\n16..19 wProductType\n\n20..23 SYSTEM_INFO.wProcessorArchitecture\n\n**procList field**\n\nContains comma-separated list of currently running process names.\n\n**mailClient field**\n\n\n-----\n\no des o at o about used a c e t ( ead o \\So t a e\\C e ts\\ a eg st y ey a ue) t s c oso t Out oo a d t s\nDLL is 64-bit, name is followed by ” x64″ suffix.\n\n## Response\n\nIf a registration request was received, C&C server returns a list of Emotet modules. HTTP status response is always 404 Not Found,\nregardless of the fact whether request was built properly or not. In this case, response body contains encrypted response.\n\nHTTP/1.1 404 Not Found\n\nServer: nginx\n\nContent-Type: text/html; charset=UTF-8\n\nContent-Length: 728740\n\nConnection: keep-alive\n\n�\nalc:*qLud&lt;d^G&gt;...\nStructure of encrypted response is quite similar to the request structure. Encrypted payload starts at 116-byte of received message. Response\nis encrypted using the same AES key, which was passed in request. After successful decryption, we obtain protobuf-like message with list of\nMZ binaries or URLs.\n\nIn this case, malware uses non-standard encoding. Field repeated Module modules = 1 [packed=true]; is illegal in protobuf language, because\n_packed attribute can be used only for primitive numeric type of repeated fields. Surprisingly, list of modules is encoded like packed list of_\n_Message objects._\n\n[Here is a low-level C&C response description, using Protocol Buffers encoding primitives:](https://developers.google.com/protocol-buffers/docs/encoding)\n\n**Type** **Name** **Comment**\n\n**ModuleResponse**\n\nTAG tag 0x0a\n\nVARINT length of ‘modules’ list\n\n**Module (repeated)**\n\nVARINT length of Module element\n\nTAG ‘type’ field tag 0x08\n\nVARINT type\n\nTAG ‘blob’ field type 0x12\n\nVARINT length of ‘blob’\n\nRAW ‘blob’ content\n\n…\n\nIt should be noted that elements of Modules are repeated without Module message tag, which is specific to packed encoding,\n\n**type field**\n\nThis field defines type of blob content and specifies method of module execution. Type field can be one of the following values:\n\n**Value** **Description**\n\n1 Store in %TEMP% and execute with -U argument\n\n2 Like ‘1’, but without arguments\n\n3 Download and execute file from URL specified ‘blob’\n\n4 Use own internal loader – load and execute PE file from ‘blob’\n\n5 Uninstall – delete related ‘.lnk’ from Startup folder\n\ndefault Do nothing\n\n## Modules\n\nIn previous versions, Emotet modules were providing the following set of functionalities:\n\n\n-----\n\nStea g o ey o ba accou ts ( a t e o se attac )\nSpreading by sending spam e-mails\nStealing mails and credentials to mail accounts\nDDoS module\nStealing browsing history and passwords from web browser\n\nIn version 4 distributed in the last campaign, we didn’t observe banking module, which is somewhat unusual for this type of malware. Behavior\nof other modules was quite similar to previous versions. During analysis, we successfully dropped two types of modules, described below:\n\n**Credentials stealer**\n\nIn server response, we found two similar modules, which purpose was to steal credentials from web browser and mail client. Both modules\nhave embedded NirSoft password recovery software inside:\n\nRecovery software was embedded as XOR-encoded static blob, using 32-bit key (similar to strings). On module startup, software was decoded\nand stored in %TEMP%, and then executed with /scomma [temp file name] parameter, which leads to dump all passwords into file contained in\n_[%TEMP% folder (name generated using GetTempFileNameW). Stealed data were sent to C&C server for malware spreading purpose.](https://msdn.microsoft.com/en-us/library/windows/desktop/aa364991.aspx)_\n\n**Spam module**\n\nSecond type of module was spam module, used for malware spreading. Firstly, module asks C&C for message template, list of recipients and\nlist of hijacked accounts, which will be used to spam distribution.\n\nRequest structure presents as below:\n\nFields flags and additionalData specify, which data has been received from server and which we’re expecting in C&C answer.\n\nServer response looks like below:\n\nE-mails are not sent using local account. Distribution is performed using previously scrapped mail accounts, which are sent to each\nspambot.\n\nMessage template example:\n\nHello <span style=\"text-transform: uppercase;\">&lt;&gt;</span>\n\nThank you for your order. The details can be found below.\n\nInvoice attached: <a href=\"http://aceeight.com/Cust-000564-17424/\">http://aceeight.com/Cust-000564-17424/&lt;&gt;</a>\n\nThis e-mail was sent by <span style=\"text-transform: uppercase;\">&lt;&gt;\n&lt;&gt;</span>\n\n## Summary\n\nBasic functionality of Emotet in last campaign was just stealing credentials and spreading. Even though, malware is still active and also\nactively developed. Because of lack of few important modules, Emotet will be probably extended in future. In case of infection, we recommend\n**changing passwords to all accounts, which credentials were stored in mail client or web browser.**\n\n## Additional informations\n\n[Detailed Kaspersky analysis from 2015 (Emotet v2 and v3)](https://securelist.com/analysis/publications/69560/the-banking-trojan-emotet-detailed-analysis/)\n\n[Analysis based on sample: c53956c95100c5c0ba342977f8fc44fcad35aabc24ec44cb12bb83eee1ed34fa](https://virustotal.com/en/file/c53956c95100c5c0ba342977f8fc44fcad35aabc24ec44cb12bb83eee1ed34fa/analysis/)\n\n**MD5 of fetched modules (13th April):**\n\n0497c120248c6f00f1ac37513bd572e5\n5b2d58b4104309ee9c93b455d39c7314\n722268bad0d3a2e90aa148d52c60943e\n\n**C&C list**\n\nhxxp://87.106.105.76:443\nhxxp://173.255.229.121:443\nhxxp://178.79.177.141:443\nhxxp://79.170.95.202:7080\nhxxp://206.214.220.79:8080\nhxxp://88.198.50.221:8080\nhxxp://5 39 84 48:8080\n\n\n-----\n\np // 88 68 58 8 080\nhxxp://162.214.11.56:7080\nhxxp://5.196.73.150:8080\nhxxp://203.121.145.40:7080\nhxxp://46.165.212.76:7080\n\n**C&C public key:**\n\n-----BEGIN PUBLIC KEY----MHwwDQYJKoZIhvcNAQEBBQADawAwaAJhAJ16QBv5Csq0eruFy4BvTcXmmIyeqUb3\nvCCc8K/zOYOpL/Ww6FCdUpvPfs+RR/sLBalwtKmT14iRUaNmJdygnAKUIRWR1HNt\n0rQRir0pD4QlkXlnZ9lZazTfyMV8BLCatwIDAQAB\n-----END PUBLIC KEY----\n**Yara rules:**\n\nrule emotet4_basic: trojan\n{\nmeta:\nauthor = \"psrok1/mak\"\nmodule = \"emotet\"\nstrings:\n$emotet4_rsa_public = { 8d ?? ?? 5? 8d ?? ?? 5? 6a 00 68 00 80 00 00 ff 35 [4] ff 35 [4] 6a 13 68 01 00 01 00 ff 15 [4] 85 }\n$emotet4_cnc_list = { 39 ?? ?5 [4] 0f 44 ?? (FF | A3)}\ncondition:\nall of them\n}\n\nrule emotet4: trojan\n{\nmeta:\nauthor = \"psrok1\"\nmodule = \"emotet\"\nstrings:\n$emotet4_x65599 = { 0f b6 ?? 8d ?? ?? 69 ?? 3f 00 01 00 4? 0? ?? 3? ?? 72 }\ncondition:\nany of them and emotet4_basic\n}\n\nrule emotet4_spam : spambot\n{\nmeta:\nauthor=\"mak\"\nmodule=\"emotet\"\nstrings:\n$login=\"LOGIN\" fullword\n$startls=\"STARTTLS\" fullword\n$mailfrom=\"MAIL FROM:\"\ncondition:\nall of them and emotet4_basic\n}\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-05-24 - Analysis of Emotet v4.pdf"
    ],
    "report_names": [
        "2017-05-24 - Analysis of Emotet v4.pdf"
    ],
    "threat_actors": [
        {
            "id": "8f350ed9-134e-4160-b63d-701f562ba64a",
            "created_at": "2022-10-25T16:07:24.589322Z",
            "updated_at": "2025-03-27T02:02:10.292236Z",
            "deleted_at": null,
            "main_name": "Yanbian Gang",
            "aliases": [],
            "source_name": "ETDA:Yanbian Gang",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "4c5a35bf-f483-463e-aea0-89a795698cff",
            "created_at": "2023-01-06T13:46:39.198624Z",
            "updated_at": "2025-03-27T02:00:03.019375Z",
            "deleted_at": null,
            "main_name": "Yanbian Gang",
            "aliases": [],
            "source_name": "MISPGALAXY:Yanbian Gang",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536130,
    "ts_updated_at": 1743041158,
    "ts_creation_date": 1653767362,
    "ts_modification_date": 1653767362,
    "files": {
        "pdf": "https://archive.orkl.eu/7892873e7189610a7703f3065d917ac667e4bd11.pdf",
        "text": "https://archive.orkl.eu/7892873e7189610a7703f3065d917ac667e4bd11.txt",
        "img": "https://archive.orkl.eu/7892873e7189610a7703f3065d917ac667e4bd11.jpg"
    }
}