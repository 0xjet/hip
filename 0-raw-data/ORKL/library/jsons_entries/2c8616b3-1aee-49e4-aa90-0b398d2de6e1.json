{
    "id": "2c8616b3-1aee-49e4-aa90-0b398d2de6e1",
    "created_at": "2023-01-12T15:09:55.405117Z",
    "updated_at": "2025-03-27T02:05:46.49574Z",
    "deleted_at": null,
    "sha1_hash": "99128a9177508e3e97ab8813d98cce2c1d45e696",
    "title": "2018-02-08 - How not to use a driver to execute code with kernel privileges",
    "authors": "",
    "file_creation_date": "2022-05-28T05:09:18Z",
    "file_modification_date": "2022-05-28T05:09:18Z",
    "file_size": 402011,
    "plain_text": "# How not to use a driver to execute code with kernel privileges\n\n**[securelist.com/elevation-of-privileges-in-namco-driver/83707/](https://securelist.com/elevation-of-privileges-in-namco-driver/83707/)**\n\nAuthors\n\n[Vladislav Stolyarov](https://securelist.com/author/vladislavstolyarov/)\n\nBoris Larin\n\n[Recently, we started receiving suspicious events from our internal sandbox Exploit Checker](https://securelist.com/a-modern-hypervisor-as-a-basis-for-a-sandbox/81902/)\nplugin. Our heuristics for supervisor mode code execution in the user address space were\nconstantly being triggered, and an executable file was being flagged for further analysis. At\nfirst, it looked like we’d found a zero-day local privilege escalation vulnerability for Windows,\nbut the sample that was triggering Exploit Checker events turned out to be the clean signed\nexecutable GundamOnline.exe, part of the multiplayer online game Mobile Suit Gundam\nOnline from BANDAI NAMCO Online Inc.\n\n\n-----\n\nThe initial sample is packed using a custom packer and contains anti-analysis techniques\nthat complicate static analysis. For example, it tries to detect if it’s being launched inside a\n[virtual machine by performing a well-known VMware hypervisor detection routine. It first](https://kb.vmware.com/s/article/1009458)\nloads the EAX register with the hypervisor magic value VMXh, and the ECX register with the\nvalue 0x0A, which is a special command to receive the hypervisor version. Then it performs\nan ‘in’ command to the VMware hypervisor IO port 0x5658. If the EBX register is overwritten\nwith VMXh as a result of that operation, it means the executable file is running on the\nVMware machine.\n\nOur [sandbox execution logs showed that the user space memory page is called from the](https://encyclopedia.kaspersky.com/glossary/sandbox/?utm_source=securelist&utm_medium=blog&utm_campaign=termin-explanation)\ndriver bandainamcoonline.sys immediately after IOCTL request 0xAA012044 to device\nobject \\.Htsysm7838 that is created by the driver. The driver itself is installed just before that.\nIt is first dropped to the directory C:WindowsSysWOW64 by a GundamOnline executable,\nloaded using NtLoadDriver() and deleted immediately afterwards.\n\nNormally, this kind of behavior should not be allowed due to SMEP (Supervisor Mode\nExecution Prevention). This is a security feature present on the latest Intel processors that\nrestricts supervisor mode execution on user memory pages. Page type is determined using\nthe User/Supervisor flag in the page table entry. If a user memory page is called while in\nsupervisor execution mode, SMEP generates an access violation exception and, as a result,\n[the system will trigger a bug check and halt. This is commonly referred to as a BSOD.](https://encyclopedia.kaspersky.com/glossary/blue-screen-of-death-bsod/?utm_source=securelist&utm_medium=blog&utm_campaign=termin-explanation)\n\n\n-----\n\n_The dropped driver itself is a legitimate driver, signed with a certificate issued to NAMCO_\n_BANDAI Online Inc._\n\nThe certificate validity period tells us two things. First, this certificate has been valid since\n2012, which could mean that the first vulnerable version of the driver was released around\nthe same time. However, we were unable to find one; the earliest sample of\nbandainamcoonline.sys that we found dates back to November 2015. Secondly, because it\nexpired more than three years ago, you could be forgiven for thinking it’s impossible to install\na driver signed with this certificate in a system. Actually, there’s nothing stopping you from\ninstalling and loading a driver with an expired certificate validity period.\n\nIn order to find the cause of the heuristics trigger, we need to do a static analysis of the driver\nitself. In the DriverEntry function it first decodes the device object name string in memory,\nand then creates the device \\.Htsysm7838. The other two encoded strings –\nbandainamcoonline and bandainamcoonline.sys – are not used in the driver.\n\n\n-----\n\nThe driver itself is very small and contains only three registered major functions. Function\nIRP_MJ_DEVICE_CONTROL, which handles requests, accepts only two IOCTLs:\n0xAA012044 and 0xAA013044. When called, it checks the size of the input and output\nbuffers and eventually calls the ExecuteUserspaceCode function, passing on the contents of\nthe input buffer to it.\n\nThe function ExecuteUserspaceCode performs a single check on the input buffer, which\ncontains a pointer to a user space function or a shellcode, and disables SMEP while saving\nold CR4 register values. It then calls that function, passing it a pointer to the\nMmGetSystemRoutineAddress as an argument. After that it restores the original register\nstate, re-enabling SMEP.\n\n\n-----\n\nTo be able to directly call the user function from the provided pointer driver it is necessary to\nremove a specific bit in the CR4 register first to temporarily stop SMEP, which is what the\nDisableSMEP function does. The original CR4 values are then restored by the EnableSMEP\nfunction.\n\nThe vulnerability in this case is that other than the basic checks on the format of the input\nbuffer, no additional checks are done. Therefore, any user on the system can use this driver\nto elevate their privileges and execute arbitrary code in the Ring 0 of the OS. Even if the\ndriver is not present in the system, an attacker can register it with Windows API functions\nand exploit the flaw.\n\n[We realized that this vulnerability looks exactly like the one found in Capcom’s driver last](https://www.theregister.co.uk/2016/09/23/capcom_street_fighter_v/)\nyear.\n\nBinary diffing bandainamcoonline.sys and capcom.sys proves exactly that, showing there are\nalmost no differences between the two drivers. The only slight variations are the encoded\nstrings and digital signatures. Because the earliest sample of the vulnerable driver that we’ve\nbeen able to find dates to November 2015, it can be assumed that this vulnerability first\nappeared in the bandainamcoonline.sys driver – almost a year before a similar driver was\nused by Capcom.\n\nWe believe both drivers were almost certainly compiled from the same source code, as a\npart of an anti-hacking solution to prevent users from cheating in the game. The presence of\nfunctions that implicitly disable and re-enable SMEP show that this design decision was\n\n\n-----\n\nintentional. But because the driver makes no additional security checks, any user can call\nand exploit the vulnerable IO control code by using Windows APIs such as\nDeviceIoControl(). This essentially makes the driver a rootkit, allowing anyone to interact with\nthe operating system at the highest privilege level. In fact, we found multiple malware\nsamples (already detected by our products) using a previously known vulnerability in\ncapcom.sys to elevate their privileges to System level.\n\nAfter finding the vulnerability we contacted BANDAI NAMCO Online Inc. The vendor\nresponded promptly and released a patch three days later. They removed the driver\naltogether, and it is no longer loaded by the game executable. This is very similar to what\nCapcom did, and is perfectly acceptable in this case.\n\nFinding this vulnerability wouldn’t have been possible without our Exploit Checker\ntechnology, which is a plugin for our sandbox, and can be also found in KATA (Kaspersky\nAnti Targeted Attack Platform). The technology was designed to monitor suspicious events\nthat occur at the earliest post-exploitation phases and can detect common techniques used\nin exploits, such as ROP, Heap Spray, Stack Pivot, and so on. In this particular case, multiple\nheuristics for executing code in supervisor mode in the user address space were triggered,\nand the sample was flagged for further analysis. If a token-swapping attempt was performed\nto elevate process privileges, a technique that’s widely used in LPE exploits, it would have\nbeen automatically detected by Exploit Checker heuristics.\n\nKaspersky Lab solutions detect the vulnerable drivers mentioned in this article as\nHEUR:HackTool.Win32.Banco.a and HEUR:HackTool.Win32.Capco.a.\n\n[Drivers](https://securelist.com/tag/drivers/)\n[Virtualization](https://securelist.com/tag/virtualization/)\n[Vulnerabilities](https://securelist.com/tag/vulnerabilities/)\n\nAuthors\n\n[Vladislav Stolyarov](https://securelist.com/author/vladislavstolyarov/)\n\nBoris Larin\n\nA vulnerable driver: lesson almost learned\n\n\n-----\n\nYour email address will not be published. Required fields are marked\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-02-08 - How not to use a driver to execute code with kernel privileges.pdf"
    ],
    "report_names": [
        "2018-02-08 - How not to use a driver to execute code with kernel privileges.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536195,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653714558,
    "ts_modification_date": 1653714558,
    "files": {
        "pdf": "https://archive.orkl.eu/99128a9177508e3e97ab8813d98cce2c1d45e696.pdf",
        "text": "https://archive.orkl.eu/99128a9177508e3e97ab8813d98cce2c1d45e696.txt",
        "img": "https://archive.orkl.eu/99128a9177508e3e97ab8813d98cce2c1d45e696.jpg"
    }
}