{
    "id": "6915b353-f401-416e-ba7d-65df9e461f60",
    "created_at": "2023-01-12T14:59:01.091637Z",
    "updated_at": "2025-03-27T02:06:14.422383Z",
    "deleted_at": null,
    "sha1_hash": "1fb7af55d9d316bc3fa67fb0092e5ff3514de514",
    "title": "2020-04-19 - Reversing Ryuk- A Technical Analysis of Ryuk Ransomware",
    "authors": "",
    "file_creation_date": "2022-05-27T23:02:21Z",
    "file_modification_date": "2022-05-27T23:02:21Z",
    "file_size": 786176,
    "plain_text": "# Reversing Ryuk: A Technical Analysis of Ryuk Ransomware\n\n**[securityliterate.com/reversing-ryuk-a-technical-analysis-of-ryuk-ransomware/](https://securityliterate.com/reversing-ryuk-a-technical-analysis-of-ryuk-ransomware/)**\n\nApril 19, 2020\n\nRyuk has been in operation since mid-2018 and is still one of the key ransomware variants\noperating in 2020. The threat actors behind Ryuk have been known to target a wide range of\nindustries, and they typically demand substantial ransom amounts.\n\nLately, given the ongoing COVID-19 situation, the actors behind Ryuk have been taking\nadvantage of this and targeting the most vulnerable ‚Äì hospitals and the health care industry.\nIn light of this (and because I am personally interested in how Ryuk functions), here is a\ntechnical analysis of Ryuk‚Äôs key functionalities.\n\n_Note: The Ryuk sample I used for this analysis is:_\n```\nfeafc5f8e77a3982a47158384e20dffee4753c20\n\n## Carbon Copies\n\n```\nThe first thing Ryuk does upon execution is the creation of two ‚Äúhidden‚Äù executable files that\nare placed on the desktop or one of the user‚Äôs temporary directories, depending on where\nthe Ryuk sample was executed from.\n\n\n-----\n\nRyuk hidden\n\nexecutables.\nThese executables are actually copies of the primary Ryuk executable, and seem to be used\nfor a few different purposes ‚Äì most notably persistence and spawning additional instances of\nitself for more threads and faster encryption of the filesystem.\n\nRyuk child\n\nprocesses (executables) running.\nRyuk is extremely fast in its encryption process. This is possible due to the way Ryuk\nbehaves in regards to threads. The two executables and associated processes that were\ncreated, along with the process injection techniques I will outline below, all serve as hosts for\nmulti-threaded encryption. More on this later.\n\n## Process Injection\n\nAfter the creation of its child processes, Ryuk will attempt to inject itself into additional\nprocesses running on the victim‚Äôs system.\n\nRyuk utilizes the Windows functions CreateToolHelp32Snapshot, Process32First, and\n_Process32Next in order to enumerate processes running on the victim‚Äôs system and search_\nfor a feasible target process for injection:\n\n\n-----\n\nRyuk enumerating system processes.\nRyuk is only able to inject code into processes that are running at the same (or lower)\nprivilege level as the Ryuk sample itself. So if Ryuk is running as Administrator or System\n(hopefully not the case!) it will be able to inject into System-level processes.\n\nAn important note is that Ryuk will not inject into csrss.exe, explorer.exe, or lsass.exe. This\nsafeguard is likely used to prevent system instability, but this is just an educated guess.\n_(Please let me know if you have additional information about this.)_\n\n\n-----\n\nRyuk process-injection\n\nsafeguards.\nAfter enumeration and selection of a target process, Ryuk utilizes a typical process injection\ntechnique:\n\nFirst, the OpenProcess and GetModuleHandleA functions are called in order to get a handle\nto the target process.\n\nRyuk getting a handle to the target process.\n\n\n-----\n\n_VirtualAllocEx is then called in order to allocate memory within the address space of the_\ntarget process, followed by WriteProcessMemory, which is called in order to write code into\nthis new memory space. Finally, CreateRemoteThread is called to create a new thread in the\ncontext of the victim process, which will subsequently execute the injected code.\n\nRyuk writing memory and creating a thread.\nThis injection process can also be seen in an excerpt from API Monitor:\n\nRyuk process injection ‚Äì API Monitor.\nThe injected code is actually just another copy of the original Ryuk process. (See my post on\n_[unpacking Ryuk if you are interested in learning one method of leveraging this process](https://securityliterate.com/unpacking-ryuk)_\n_injection technique in order to unpack Ryuk.)_\n\nWhen I ran Ryuk in my Windows VM, code was injected into dwm.exe, taskhost.exe, and\neven the VirtualBox Tray process (VBoxTray.exe). Interestingly, two of these processes\ncrashed a few minutes after injection, so it appears that Ryuk can cause some incidental\nsystem instability.\n\n\n-----\n\nRyuk code\n\ninjection crashes VBoxTray.exe.\n\n## Command Execution\n\nRyuk leverages Windows command line tools for most of its supporting functionalities. Some\nof these commands can be seen in the below code:\n\nRyuk executing\n\nvarious command-line commands.\nDuring my analysis, the following command were run by Ryuk:\n```\nnet.exe stop \"audioendpointbuilder\" /y\n\n```\n\n-----\n\nThis command kills the audio endpoint builder Windows service, which causes audio to\nmalfunction on the victim system. I am still unsure why Ryuk executes this command, and I\nhave no good suggestions.. Other than perhaps to infuriate the end user.\n```\nnet.exe stop \"samss\" /y\n\n```\nStops the Security Accounts Manager. This technique may be used to prevent security alerts\nbeing triggered and sent to a SIEM.\n```\ncmd.exe /c \"WMIC.exe shadowcopy delete\"\n\n```\nThis command clears the Windows Volume Shadow Copies so that they cannot be used to\nrecover files.\n```\ncmd.exe /c \"vssadmin.exe Delete Shadows /all /quiet\"\n\n```\nThis command is used as another method of removing shadow copies of files.\n```\ncmd.exe /c \"bcdedit /set {default} recoveryenabled No & bcdedit /set {default}\"\ncmd.exe /c \"bootstatuspolicy ignoreallfailures\"\n\n```\nThese commands are used to disable Windows error recovery and associated boot options\nso it is more difficult to recover the system.\n```\nicacls \"C:*\" /grant Everyone:F /T /C /Q\nicacls \"D:*\" /grant Everyone:F /T /C /Q\nicacls \"Z:*\" /grant Everyone:F /T /C /Q\n\n```\nThese commands attempt to assign the group Everyone full permissions to the C, D,and Z\ndrives. This is used before the encryption process begins, to ensure Ryuk has permissions to\nmodify files.\n```\ncmd.exe \" /C REG ADD\n\"HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\" /v \"EV\" /t REG_SZ\n/d \"<path_to_Ryuk>\"\n\n```\nThis command is used to add Registry persistence. Essentially, this will ensure the Ryuk\nsample will run again upon system bootup. Ryuk will only encrypt files once, however.\nSpeaking of that‚Ä¶ on to encryption!\n\n## Encryption ‚Äì A Multi-Threaded Operation\n\nThe file encryption process runs once the above command line commands have been\nexecuted. As previously mentioned, Ryuk encrypts the filesystem using multiple threads,\nspread amongst the primary Ryuk executable, the secondary executables, and the\nprocesses Ryuk was able to inject into. Ryuk creates a new thread for each file being\nencrypted:\n\n\n-----\n\nRyuk encryption threads.\n\nRyuk utilizes the functions FindFirstFileW and FindNextFileW in order to iterate through the\nfiles on the victim system. Once a file has been found, Ryuk will call CreateThread in order to\nstart a new encryption thread.\n\nIt is notable how quickly Ryuk is able to enumerate the files on the victim system and encrypt\nthem. In my initial tests (running on a virtual machine with 50+ GB hard drive) files were\nencrypted within a matter of 120 seconds or so, including files on network-attached drives.\n\nRyuk will also create a ‚Äúreadme‚Äù file (RyukReadme.htm) in every directory that contains\nencrypted files. This readme file instructs the victim to contact the email address mentioned\nfor further instructions on how to pay the ransom:\n\n\n-----\n\nRyuk\n\nreadme file.\nI originally wanted to go a bit more in depth into how Ryuk encrypted files and the encryption\nalgorithms used. However, after a bit of research and code review, I realized that Ryuk is not\ndoing anything incredibly new or note-worthy in terms of the encryption process. According\nto [this research, Ryuk is utilizing RSA-4096 and AES-256 encryption algorithms, which are](https://malware.wikia.org/wiki/Ryuk)\nextremely strong and, at this point in time, ‚Äúunbreakable‚Äù. I put unbreakable in quotes\nbecause, technically, no encryption algorithms are completely unbreakable and all will\neventually be broken üòâ\n\n## Network Enumeration\n\nRyuk performs some rudimentary network enumeration in order to discover other network\ndrives and adjacent systems to encrypt. In my tests, and according to the Ryuk code in the\nsample I analyzed, Ryuk is able to enumerate the network in a few different ways.\n\nFirst, Ryuk obtains the ARP table from the victim machine (using the GetIpNetTable function)\nand attempts to ping those connected systems to see if they are online:\n\nRyuk pinging\n\nconnected systems.\n\n\n-----\n\nIf these systems are alive, Ryuk will attempt to connect to and mount SMB shares on these\nsystems:\n\nRyuk\n\nattempting to connect to SMB network shares.\nRyuk will then attempt to encrypt any file system it is able to, given the victim system has the\ncorrect permissions and network capabilities to mount these devices.\n\nIn addition, Ryuk grabs the network adapter IP addresses (using the GetAdapterAddresses\nfunction) from the victim system:and attempts to send WOL (Wake-On-LAN) packets to\nthese systems in order to wake them up. Ryuk will only send WOL packets to addresses that\nstart with 10, 172, or 192.\n\nRyuk Wake-on-LAN attempts.\n\n## Defending Against Ryuk\n\n\n-----\n\nRyuk\n\nMITRE ATT&CK matrix.\n\nSince Ryuk (and other modern ransomware) is incredibly efficient and will encrypt an\nentire filesystem and attached network drives very quickly (likely within minutes), it is\nbest to detect Ryuk as early in the Kill Chain as possible, ideally in the Delivery phases\nand before Installation.\nRyuk is typically delivered via other malware and droppers, such as Trickbot, Dridex,\nand Cobalt Strike Beacons. Developing detections and mitigating controls against\nthese malware variants in order to detect an infection before the deployment of Ryuk is\noptimal.\nIn the event that Ryuk is deployed and encryption occurs, a sound business continuity\nand backup plan will be very helpful. Ensure offline backups are kept available.\nConsider very carefully before paying the ransom for the purchase of the Ryuk\ndecryptor software. This decryptor software has been well-researched by several threat\nintelligence vendors, and is said to be very poorly programmed and tends to crash\n[during the decryption process, or worse, permanently destroys encrypted files.](https://www.securitynewspaper.com/2019/12/10/a-bug-in-the-ryuk-ransomware-makes-data-recovery-impossible-even-if-the-ransom-is-paid-who-will-fix-this-flaw/)\n\n[As always, thanks for reading! If you enjoyed this post, follow me on Twitter (@d4rksystem).](https://twitter.com/d4rksystem)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-04-19 - Reversing Ryuk- A Technical Analysis of Ryuk Ransomware.pdf"
    ],
    "report_names": [
        "2020-04-19 - Reversing Ryuk- A Technical Analysis of Ryuk Ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535541,
    "ts_updated_at": 1743041174,
    "ts_creation_date": 1653692541,
    "ts_modification_date": 1653692541,
    "files": {
        "pdf": "https://archive.orkl.eu/1fb7af55d9d316bc3fa67fb0092e5ff3514de514.pdf",
        "text": "https://archive.orkl.eu/1fb7af55d9d316bc3fa67fb0092e5ff3514de514.txt",
        "img": "https://archive.orkl.eu/1fb7af55d9d316bc3fa67fb0092e5ff3514de514.jpg"
    }
}