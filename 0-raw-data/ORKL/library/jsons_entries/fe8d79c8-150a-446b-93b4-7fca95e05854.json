{
    "id": "fe8d79c8-150a-446b-93b4-7fca95e05854",
    "created_at": "2023-01-12T15:05:02.494798Z",
    "updated_at": "2025-03-27T02:05:36.345575Z",
    "deleted_at": null,
    "sha1_hash": "2d0c31712475be17fd7175baecf916232c397209",
    "title": "2019-06-18 - Analysis of a New HawkEye Variant",
    "authors": "",
    "file_creation_date": "2022-05-29T10:46:03Z",
    "file_modification_date": "2022-05-29T10:46:03Z",
    "file_size": 289528,
    "plain_text": "# Analysis of a New HawkEye Variant\n\n**[fortinet.com/blog/threat-research/hawkeye-malware-analysis.html](https://www.fortinet.com/blog/threat-research/hawkeye-malware-analysis.html)**\n\n**_Threat Analysis by FortiGuard Labs_**\n\n## Background\n\n\nJune 18, 2019\n\n\nFortiGuard Labs recently captured a malware being spread by a phishing email. After a quick\nanalysis, I discovered that it was a new variant of the HawkEye malware.\n\n[HawkEye is known as a keylogger and an application credential stealing malware. Over past](https://www.fortinet.com/resources/cyberglossary/what-is-keyloggers.html%20?utm_source=blog&utm_campaign=keylogger)\nfew years, we have seen it spread by email, and carried in MS Word documents, Excel files,\nPowerPoint files, and RTF files. In this analysis, I am going to provide an overview of what\nthis new variant can do to a victim’s system.\n\n## Distribution and Download\n\n\n-----\n\nHere is the email content, masquerading as an airline ticket confirmation, which asks the\ntargeted victim to click on a link.\n\nFigure 1. The email content\n\nIt was designed so that a victim downloads a 7z file from the link shown in figure 1 that\ncontains this new variant of HawkEye and runs it on the victim’s system.\n\nUnfortunately, on initial analysis the URL was not available and I received a “404 Not Found”\nmessage in the browser.\n\nBrowsing to its main page. It turned out to be an FTP service, containing several related\nnetwork folders about this campaign, with most containing the same malware sample (Figure\n2).\n\nFigure 2. Screenshot of the main page\n\nAfter the downloaded 7z file was decompressed, we retrieved the EXE file\n“TICKET%2083992883992AIR8389494VERVED37783PDF.exe”, which is the new variant of\nHawkEye.\n\n## Start HawkEye\n\nOnce HawkEye started, it spawned a suspended child process, “RegAsm.exe”, from the\nMicrosoft .Net framework installation directory – which is a tool for Assembly Registration.\nMeanwhile, HawkEye extracted a PE file into its memory and then moved the PE file into\n“RegAsm.exe”. The dynamically extracted PE file is the main program of HawkEye. It’s called\n“HawkEye_RegAsm,” to differentiate these files in the analysis. HawkEye_RegAsm began\nrunning after resuming running “RegAsm.exe” after being suspended.\n\nHawkEye_RegAsm is a .Net written program, which is packed by ConfuserEx v1.0.0 to\nprotect itself. This creates a big challenge for analysts to read its code and analyze it. The\ncode was actually totally obfuscated, as shown in figure 3.\n\nFigure 3. Obfuscated Entry function of HawkEye_RegAsm\n\nAfter sleeping 10 seconds, HawkEye_RegAsm starts its work on the victim’s system.\nThrough analysis so far, it appears to mainly perform the following functions:\n\n1> Set up clipboard logger\n\n2> Set up keyboard logger\n\n3> Spawn another two child processes “vbc.exe”, both from the .Net framework directory as\nwell.\n\n4> Send collected data to an email address using SMTP from time to time (every 10\nminues).\n\n\n-----\n\nHawkEye_RegAsm starts a thread to perform the above tasks, and then every 10 minutes it\nsends its collected information to its Yandex email address.\n\nHawkEye_RegAsm sets up a clipboard and keyboard logger using Windows-native APIs\n(such as SetWindowsHookEx, SetClipboardViewer, etc.) Its local functions can record\nvictim’s behaviors when the victim types on the keyboard as well as when copying data into\nthe system clipboard.\n\nFigure 4 shows an example of the information that HawkEye_RegAsm collected from its\nkeyboard and clipboard logger, as well as the software title from when the event occurred.\n\nFigure 4. Example of collected Clipboard and Keyboard data\n\n## Collecting Credentials from Saved Credential Storage\n\nHawkEye_RegAsm performs a similar task as to the RegAsm.exe. It spawns two suspended\nchild processes, “vbc.exe”, which are from the same directory as RegAsm.exe. HawkEye\ndynamically extracts two PE files into its memory, which are then copied into the two newly\ncreated child processes of “vbc.exe”. It also modifies its ThreadContext data (It calls the API,\nSetThreadContext) and makes its entry point to the transfered PE file. When “vbc.exe”\nresumes running it can be executed. It’s a trick that malware often performs to camouflage\nitself behind of a normal process.\n\nThe two “vbc.exe” processes collect credentials from the victim’s system. One is used to\ncollect the credentials of browsers. The other one focuses on email clients and IM clients to\nsteal credentials and profiles. Both PE files injected into “vbc.exe” have the same code\nframework. They first call a function to collect credentials and save them in memory, and\nsecond, it reads the collected data, formats it, and saves it to a tmp file from its command\nline parameter.\n\nFigure 5 shows HawkEye calling the CreateProcess API to start one of the two “vbc.exe”\nprocesses, with the parameter shown below in the “Locals” sub-tab. You can see the full path\nof “vbc.exe”. “/stext \"\"C:\\Users\\*********\\AppData\\Local\\Temp\\tmpBE3D.tmp\"\"\" is the\nparameter passed to it. The tmp file name is random and different from the two “vbc.exe”\nprocesses, which temporarily saves collected credentials.\n\nFigure 5. Break on when calling CreateProcess to start a “vbc.exe”\n\nThe two PE files are not packer protected and not .Net written program.\n\nThe first “vbs.exe” collects credentials from victim’s browsers and the system credential\nmanager for IE.\n\nIn my analysis, this variant of HawkEye focuses on the following browsers:\n\n\n-----\n\n**Microsoft Internet Explorer, Google Chrome, Apple Safari, Opera, Mozilla Sunbird,**\n**Mozilla Firefox, Mozilla Portable Thunderbird, Mozilla SeaMonkey, YandexBrowser,**\n**Vivaldi browser, and more.**\n\nFigure 6 shows some strings defined in the ASM code of the browsers that the HawkEye\nmalware wants to collect credentials from.\n\nThe collected credentials are then saved into the tmp file from its command line parameter.\nHawkEye_RegAsm keeps checking this tmp file, and once the credentials are collected, it is\ndone. HawkEye_RegAsm then reads the entire data of this tmp file into its memory and the\ndeletes it immediately.\n\nFigure 6. Browsers’ information defined in the first PE file\n\nThe second PE file in “vbc.exe”collects profile and credential information of the email and IM\nsoftware client installed on a victim’s machine.\n\nThe clients it targets are:\n\n**Qualcomm Eudora, Mozilla Thunderbird, MS Office Outlook, IncrediMail, Groupmail,**\n**MSNMessenger, Yahoo!Pager/Yahoo!Messenger and Windows Mail.**\n\nBelow is an example list that HawkEye stole from the Chrome browser on my test machine.\nAs you can see, it includes login URL, Browser name, User name, Password, Created time,\nand the full path of the file where the collected information came from.\n\nFigure 7. “vbc.exe” saves collected server address information to tmp file\n\nThe second PE file in “vbc.exe” not only collects the client’s login username and password,\nbut also profile information, such as the recipent Server address, recipient Server Port,\nprotocol Type (POP3), SMTP Server, SMTP Port, etc. Figure 7 shows a screenshot of\nOllydbg when “vbc.exe” was about to write the collected recipient Server addresses into its\ntmp file. It writes one line once. The same tmp file is finally read by HawkEye_RegAsm and\nthen deleted.\n\nOn my test machine, I only installed MS Outlook with one account. My test account and\nserver profile were collected and put in the structure shown below, which would normally be\nsent to the attacker’s email box.\n\n## Sending Collected Data to the Attacker via SMTP\n\nOk. Now let’s go back to the main process of HawkEye_RegAsm, which controls all tasks of\nHawkEye and sends the victim’s credentials. In its main program, it calls\nThread.Sleep(600000), and pauses while collecting credentials every 10 minutes. That is, it\nreports the collected data to attacker the once every 10 minutes.\n\n\n-----\n\nIt first sends an HTTP request, _[http://bot.whatismyipaddress.com, to ask for my machine s](http://bot.whatismyipaddress.com/)_\npublic IP. This is a way to ensure that the victim’s machine is able to access the internet. If it\ndid not reply with a public IP, it stops sending collected data to the email box. In addition, the\nIP appears in the email subject so it can identify victims.\n\nThe attacker’s email is in Yandex.mail, whose email account and password are used when\nsending collected data through the Yandex SMTP server. That’s why I was able to get the\nattacker’s email credentials while tracking the main program. You can see the screenshot in\nfigure 8 when I was debugging it.\n\nFigure 8. Sending collected data to the attacker’s email box\n\nEvery ten minutes it sends packets such as that shown in Figure 9 to tell the attacker about\nwhat it has collected from the victim’s machine using the keylogger, clipboard, browser\ncredentials, and IM and email client credentials and profiles.\n\nFigure 9. Sending collected data to the attacker’s Yandex email address over SMTP\n\nFigure 10. Glancing at an attacker’s harvest\n\nVisiting the attacker’s account, we can see what the attacker has harvested, as shown in\nfigure 10.\n\n## Solutions\n\nThe original URL in the email has been rated as “Malicious Websites“ by the FortiGuard\nWeb Filtering service. The decompressed exe file is detected as “AutoIt/Injector.EAH!tr” by\nthe FortiGuard Antivirus service.\n\n## Sample SHA256\n\n[TICKET%2083992883992AIR8389494VERVED37783PDF.exe]\n3E7AD2A554F89B2A5E52E5C4843111342182DA4409A038CF800570B65A13F875\n\n[Ticketmasterconfirmation3883948383948394.7z]\nBBB46F812126FAEB543B02D143EF450887A043185AF98210D8F827924B31CF7A\n\n[TKT8839483993993fligh booking ticket confirmationupdate.7z]\nF2B921726D728037F9BA0C63FB6C31F77983C3A6E3938B46C411E80C218A2E84\n\n_[Learn more about FortiGuard Labs and the FortiGuard Security Services portfolio.](https://www.fortinet.com/fortiguard/threat-intelligence/threat-research.html?utm_source=nreleaseblog&utm_campaign=2018-q2-fortiguardlabs-cta)_ _Sign_\n_up for our weekly FortiGuard Threat Brief._\n\n_[Read about the FortiGuard Security Rating Service, which provides security audits and best](https://www.fortinet.com/support-and-training/support-services/fortiguard-security-subscriptions/security-rating.html?utm_source=blog&utm_campaign=2018-blog-security-rating-service)_\n_practices._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-06-18 - Analysis of a New HawkEye Variant.pdf"
    ],
    "report_names": [
        "2019-06-18 - Analysis of a New HawkEye Variant.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535902,
    "ts_updated_at": 1743041136,
    "ts_creation_date": 1653821163,
    "ts_modification_date": 1653821163,
    "files": {
        "pdf": "https://archive.orkl.eu/2d0c31712475be17fd7175baecf916232c397209.pdf",
        "text": "https://archive.orkl.eu/2d0c31712475be17fd7175baecf916232c397209.txt",
        "img": "https://archive.orkl.eu/2d0c31712475be17fd7175baecf916232c397209.jpg"
    }
}