{
    "id": "04640508-4dd2-45a2-821e-0ff15f4462c2",
    "created_at": "2023-01-12T15:06:17.934597Z",
    "updated_at": "2025-03-27T02:09:46.984359Z",
    "deleted_at": null,
    "sha1_hash": "551e200996f2d0bdb99ea326eea3eaba7c0b9039",
    "title": "2019-12-10 - Windows 0-day exploit CVE-2019-1458 used in Operation WizardOpium",
    "authors": "",
    "file_creation_date": "2022-05-27T19:02:22Z",
    "file_modification_date": "2022-05-27T19:02:22Z",
    "file_size": 1765327,
    "plain_text": "# Windows 0-day exploit CVE-2019-1458 used in Operation WizardOpium\n\n**[securelist.com/windows-0-day-exploit-cve-2019-1458-used-in-operation-wizardopium/95432](https://securelist.com/windows-0-day-exploit-cve-2019-1458-used-in-operation-wizardopium/95432)**\n\n[Research](https://securelist.com/category/research/)\n\n[Research](https://securelist.com/category/research/)\n\n10 Dec 2019\n\nminute read\n\n\n-----\n\nAuthors\n\nAMR\n\nGReAT\n\n[In November 2019, Kaspersky technologies successfully detected a Google Chrome 0-day](https://securelist.com/chrome-0-day-exploit-cve-2019-13720-used-in-operation-wizardopium/94866/)\nexploit that was used in Operation WizardOpium attacks. During our investigation, we\ndiscovered that yet another 0-day exploit was used in those attacks. The exploit for Google\nChrome embeds a 0-day EoP exploit (CVE-2019-1458) that is used to gain higher privileges\non the infected machine as well as escaping the Chrome process sandbox.\n\nThe EoP exploit consists of two stages: a tiny PE loader and the actual exploit. After\nachieving a read/write primitive in the renderer process of the browser through vulnerable JS\ncode, the PE exploit corrupts some pointers in memory to redirect code execution to the PE\nloader. This is done to bypass sandbox restrictions because the PE exploit cannot simply\nstart a new process using native WinAPI functions.\n\n\n-----\n\nThe PE loader locates an embedded DLL file with the actual exploit and repeats the same\nprocess as the native Windows PE loader – parsing PE headers, handling imports/exports,\netc. After that, a code execution is redirected to the entry point of the DLL – the DllEntryPoint\nfunction. The PE code then creates a new thread, which is an entry point for the exploit itself,\nand the main thread simply waits until it stops.\n\n_EoP exploit used in the attack_\n\nThe PE file encapsulating this EoP exploit has the following header:\n\nThe compilation timestamp of Wed Jul 10 00:50:48 2019 is different from the other binaries,\nindicating it has been in use for some time.\n\nOur detailed analysis of the EoP exploit revealed that the vulnerability it used belongs to the\nwin32k.sys driver and that the EoP exploit was the 0-day exploit because it works on the\nlatest (patched) versions of Windows 7 and even on a few builds of Windows 10 (new\n\n\n-----\n\nWindows 10 builds are not affected because they implement measures that prevent the\nnormal usage of the exploitable code).\n\nThe vulnerability itself is related to windows switching functionality (for example, the one\ntriggered using the Alt-Tab key combination). That’s why the exploit’s code uses a few\nWinAPI calls (GetKeyState/SetKeyState) to emulate a key press operation.\n\nAt the beginning, the exploit tries to find the operating system version using ntdll.dll’s\nRtlGetVersion call that’s used to find a dozen offsets needed to set up fake kernel GDI\nobjects in the memory. At the same time, it tries to leak a few kernel pointers using wellknown techniques to leak kernel memory addresses (gSharedInfo, PEB’s\nGdiSharedHandleTable). After that, it tries to create a special memory layout with holes in\nthe heap using many calls to CreateAcceleratorTable/DestroyAcceleratorTable. Then a\nbunch of calls to CreateBitmap are performed, the addresses to which are leaked using a\nhandle table array.\n\n\n-----\n\n_Triggering exploitable code path_\n\nAfter that, a few pop-up windows are created and an undocumented syscall\nNtUserMessageCall is called using their window handles. In addition, it creates a special\nwindow with the class of a task switch window (#32771) and it’s important to trigger an\nexploitable code path in the driver. At this step the exploit tries to emulate the Alt key and\nthen using a call to SetBitmapBits it crafts a GDI object which contains a controllable pointer\nvalue that is used later in the kernel driver’s code (win32k!DrawSwitchWndHilite) after the\nexploit issues a second undocumented call to the syscall (NtUserMessageCall). That’s how it\ngets an arbitrary kernel read/write primitive.\n\n_Achieving primitives needed to get arbitrary R/W_\n\nThis primitive is then used to perform privilege escalation on the target system. It’s done by\noverwriting a token in the EPROCESS structure of the current process using the token value\nfor an existing system driver process.\n\n\n-----\n\n_Overwriting EPROCESS token structure_\n\nKaspersky products detect this exploit with the verdict PDM:Exploit.Win32.Generic.\nThese kinds of threats can also be detected with our Sandbox technology. This detection\n[component is a part of our KATA and Kaspersky Sandbox products. In this particular attack](https://media.kaspersky.com/en/business-security/enterprise/Kaspersky-Sandbox-product-brief-en.pdf)\nsandbox solution can analyze URL/malicious payload in isolated environment and detect the\nEPROCESS token manipulation.\n\n[Microsoft Windows](https://securelist.com/tag/microsoft-windows/)\n[Vulnerabilities and exploits](https://securelist.com/tag/vulnerabilities-and-exploits/)\n[Zero-day vulnerabilities](https://securelist.com/tag/zero-day-vulnerabilities/)\n\nAuthors\n\nAMR\n\n\n-----\n\nGReAT\n\nWindows 0-day exploit CVE-2019-1458 used in Operation WizardOpium\n\nYour email address will not be published. Required fields are marked *\n\nGReAT webinars\n\n13 May 2021, 1:00pm\n\n## GReAT Ideas. Balalaika Edition\n\n26 Feb 2021, 12:00pm\n17 Jun 2020, 1:00pm\n26 Aug 2020, 2:00pm\n22 Jul 2020, 2:00pm\nFrom the same authors\n\n## IT threat evolution in Q1 2022. Non-mobile statistics\n\n\n-----\n\n## The Verizon 2022 DBIR\n\n Evaluation of cyber activities and the threat landscape in Ukraine\n\n\n-----\n\n## New ransomware trends in 2022\n\n APT trends report Q1 2022\n\nSubscribe to our weekly e-mails\n\nThe hottest research right in your inbox\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-12-10 - Windows 0-day exploit CVE-2019-1458 used in Operation WizardOpium.pdf"
    ],
    "report_names": [
        "2019-12-10 - Windows 0-day exploit CVE-2019-1458 used in Operation WizardOpium.pdf"
    ],
    "threat_actors": [
        {
            "id": "2008a79d-2f3a-475f-abef-3bc119a1bf38",
            "created_at": "2022-10-25T16:07:24.028651Z",
            "updated_at": "2025-03-27T02:02:10.084983Z",
            "deleted_at": null,
            "main_name": "Operation WizardOpium",
            "aliases": [],
            "source_name": "ETDA:Operation WizardOpium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5cd3fcb0-eb56-49ac-8125-47ebee93311d",
            "created_at": "2023-01-06T13:46:39.065814Z",
            "updated_at": "2025-03-27T02:00:02.988828Z",
            "deleted_at": null,
            "main_name": "Operation WizardOpium",
            "aliases": [],
            "source_name": "MISPGALAXY:Operation WizardOpium",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535977,
    "ts_updated_at": 1743041386,
    "ts_creation_date": 1653678142,
    "ts_modification_date": 1653678142,
    "files": {
        "pdf": "https://archive.orkl.eu/551e200996f2d0bdb99ea326eea3eaba7c0b9039.pdf",
        "text": "https://archive.orkl.eu/551e200996f2d0bdb99ea326eea3eaba7c0b9039.txt",
        "img": "https://archive.orkl.eu/551e200996f2d0bdb99ea326eea3eaba7c0b9039.jpg"
    }
}