{
    "id": "d56ca7e8-21e4-43ee-a4f2-1b0d6f530332",
    "created_at": "2022-10-25T16:48:15.851846Z",
    "updated_at": "2025-03-27T02:09:18.674115Z",
    "deleted_at": null,
    "sha1_hash": "6f721eaff00dc7d103227d7d30a890d585a460eb",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-04-14T12:38:27Z",
    "file_modification_date": "2021-04-14T12:38:27Z",
    "file_size": 440710,
    "plain_text": "# Vulnerability in FortiGate VPN servers is exploited in Cring ransomware attacks\n\n### Vyacheslav Kopeytsev\n\n\n-----\n\nInitial attack vector .......................................................................................................................................................................................... 2\n\nLateral movement ............................................................................................................................................................................................ 3\n\nEncryption .............................................................................................................................................................................................................. 4\n\nReconnaissance ................................................................................................................................................................................................. 7\n\nCauses of the incident ................................................................................................................................................................................. 7\n\nRecommendations ........................................................................................................................................................................................... 8\n\nIndicators of compromise (IOC) ............................................................................................................................................................ 9\n\n#### In Q1 2021, threat actors conducted a series of attacks using the Cring ransomware. These attacks were mentioned in a Swisscom CSIRT tweet, but it remained unclear how the ransomware infects an organization’s network.\n\n An incident investigation conducted by Kaspersky ICS CERT experts at one of the attacked enterprises revealed that attacks of the Cring ransomware exploit a vulnerability in FortiGate VPN servers.\n\n Victims of these attacks include industrial enterprises in European countries. At least in one case, an attack of the ransomware resulted in a temporary shutdown of the industrial process due to servers used to control the industrial process becoming encrypted.\n\n In this paper, we discuss the results of our research and interesting aspects of the attack.\n\n It is worth noting that Fortinet has on several occasions warned users of its devices of the danger posed by the vulnerability and a high risk of attacks, including attacks by APT groups.\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 1\n\n\n-----\n\n## Initial attack vector\n\n[The attackers exploited the CVE-2018-13379](https://nvd.nist.gov/vuln/detail/CVE-2018-13379) vulnerability in FortiGate VPN\nservers to gain access to the enterprise’s network.\n\n[Unpatched FortiGate devices are vulnerable to a directory traversal attack,](https://en.wikipedia.org/wiki/Directory_traversal_attack)\nwhich allows an attacker to access system files on the FortiGate SSL VPN\nappliance. Specifically, an unauthenticated attacker can connect to the\nappliance through the internet and remotely access the file\n\"sslvpn_websession\", which contains the username and password used to\naccess VPN, stored in cleartext. The vulnerability affects devices that run\nFortiOS versions 6.0.0 to 6.0.4, 5.6.3 to 5.6.7, and 5.4.6 to 5.4.12.\n\nSeveral days before the start of the main attack phase, the attackers performed\ntest connections to the VPN Gateway, apparently in order to check that the\nauthentication credentials stolen in an attack on the VPN server could still be\nused.\n\nThe attackers may have identified the vulnerable device themselves by scanning\nIP addresses. Alternatively, they may have bought a ready-made list containing\nIP addresses of vulnerable FortiGate VPN Gateway devices. In autumn 2020, an\noffer to buy a database of such devices appeared on a dark web forum.\n\nMessage on a dark web forum with an offer to buy a database of vulnerable devices\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 2\n\n\n-----\n\n## Lateral movement\n\nAfter gaining access to the first system on the enterprise network, the\nattackers downloaded the Mimikatz utility to that system. The utility was used to\nsteal the account credentials of Windows users who had previously logged in to\nthe compromised system.\n\nWith the help of the Mimikatz utility, the attackers were able to compromise the\ndomain administrator account, after which they started distributing malware to\nother systems on the organization’s network. They used the [Cobalt Strike](https://www.cobaltstrike.com/)\nframework for that purpose. The Cobalt Strike module was loaded on attacked\nsystems using the PowerShell.\n\nFragment of a PowerShell script downloaded to an attacked system\n\nAfter launching, the malicious PowerShell script decrypted the payload – the\nCobalt Strike Beacon backdoor, which provided the attackers with remote\ncontrol of the infected system.\n\nThe IP address 198.12.112[.]204 was specified as the Cobalt Strike Beacon\ncommand-and-control server.\n\nFragment of decrypted code from the Cobalt Strike payload\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 3\n\n\n-----\n\n## Encryption\n\nAfter gaining control of the infected system, the attackers downloaded a cmd\nscript to the machine. The script was designed to download and launch the\nmalware – the Cring ransomware.\n\nThe script was saved to the following path:\n%TEMP%\\execute.bat (e.g., C:\\Windows\\Temp\\execute.bat).\n\nMalicious cmd script\n\nAfter being installed on the system, the cmd script named execute.bat was\nexecuted. The script launched PowerShell under the name “kaspersky”. The\nattackers used this technique to mask the traces of the malware activity and\ndisguise the operation of the malware as that of security solutions. A command\nto download a file from the internet was passed to the running PowerShell shell.\nThe file’s URL was http://45.67.231[.]128/ip.txt. The downloaded file was saved as\nC:\\__output.\n\nAlthough the file specified in the URL had the extension .txt, it was in fact the\nexecutable file of the malware – the Cring ransomware. At the time of analyzing\nthe malware hosting server, the file ip.txt had already been removed, but the\nattackers had uploaded a newer version of the Cring malware (the file NoNet.txt)\nto the server.\n\nContents of the malware hosting server used in the attack\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 4\n\n\n-----\n\nTo be able to encrypt database files and remove backup copies, the Cring\nmalware stoped the services of the following programs:\n\n          - Veritas NetBackup: BMR Boot Service, NetBackup BMR MTFTP Service\n\n          - Microsoft SQL server: SQLTELEMETRY, SQLTELEMETRY$ECWDB2,\n\nSQLWriter\n\nThe SstpSvc service, which is used to create VPN connections, was also\nstopped. It is most likely that the attackers, who at this stage controlled the\ninfected system via Cobalt Strike, did this to make it impossible to connect to\nthe infected system remotely via VPN. This was done to prevent system\nadministrators from providing a timely response to the information security\nincident.\n\nAdditionally, the malware terminated the following applications’ processes in\norder to encrypt files without hindrance:\n\n          - Microsoft Office: mspub.exe\n\n          - Oracle Database software: mydesktopqos.exe, mydesktopservice.exe\n\nThe malware removed backup files that had the following extensions: .VHD, .bac,\n.bak, .wbcat, .bkf, .set, .win, and .dsk. It also removed files and folders located in\nthe root folder of the drive if their names started with the word “Backup”\nor “backup”.\n\nTo perform these operations, the malware created a cmd script named kill.bat on\nthe drive, which deleted itself after execution.\n\nCode of the kill.bat script\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 5\n\n\n-----\n\nNext, the malware started to encrypt files using strong encryption algorithms,\nwhich means that files could not be decrypted without knowing the RSA private\nkey held by the attackers. Each file was encrypted using AES and the AES\nencryption key was in turn encrypted using an RSA public key hard-coded into\nthe malicious program’s executable file. The RSA key size was 8,192 bits.\n\nFiles with the following extensions were encrypted:\n\n          - .vhdx (Virtual Hard Disk)\n\n          - .ndf (Microsoft SQL Server secondary database)\n\n          - .wk (Lotus 1-2-3 spreadsheet)\n\n          - .xlsx (Microsoft Excel spreadsheet)\n\n          - .txt (text document)\n\n          - .doc (Microsoft Word document)\n\n          - .docx (Microsoft Word document)\n\n          - .xls (Microsoft Excel spreadsheet)\n\n          - .mdb (Microsoft Access database)\n\n          - .mdf (disk image)\n\n          - .sql (saved SQL query)\n\n          - .bak (backup file)\n\n          - .ora (Oracle database)\n\n          - .pdf (PDF document)\n\n          - .ppt (Microsoft PowerPoint presentation)\n\n          - .pptx (Microsoft PowerPoint presentation)\n\n          - .dbf (dBASE database management file)\n\n          - .zip (archive)\n\n          - .rar (archive)\n\n          - .aspx (ASP.NET webpage)\n\n          - .php (PHP webpage)\n\n          - .jsp (Java webpage)\n\n          - .bkf (backup created by Microsoft Windows Backup Utility)\n\n          - .csv (Microsoft Excel spreadsheet)\n\nUpon completing file encryption, the malware dropped the following ransom\nnote:\n\nRansom note\n\nThe ransom note was saved in the file !!!!WrReadMe!!!.rtf.\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 6\n\n\n-----\n\n## Reconnaissance\n\nVarious details of the attack indicate that the attackers had carefully analyzed\nthe infrastructure of the attacked organization and prepared their own\ninfrastructure and toolset based on the information collected at the\nreconnaissance stage.\n\nFor example, the malware hosting server (45.67.231[.]128) from which the Cring\nransomware was downloaded had filtration by IP address enabled and only\nresponded to requests from several European countries.\n\nThe attackers’ cmd scripts disguised the activity of the malware as the\noperation of the antivirus solution (Kaspersky) used by the enterprise and\nterminated the processes of database servers (Microsoft SQL Server) and\nbackup systems (Veeam) that were used on systems selected for encryption.\n\nAn analysis of the attackers’ activity demonstrates that, based on the results of\nreconnaissance performed on the attacked organization’s network, they chose\nto encrypt those servers the loss of which the attackers believed would cause\nthe greatest damage to the enterprise’s operations.\n\n## Causes of the incident\n\nIt is worth highlighting a number of reasons that contributed to the information\nsecurity incident investigated by the Kaspersky ICS CERT team or directly led to it.\n\n1. The primary causes of the incident include the use of an outdated and\n\nvulnerable firmware version on the FortiGate VPN server (version 6.0.2\nwas used at the time of the attack), which enabled the attackers to\nexploit the CVE-2018-13379 vulnerability and gain access to the\nenterprise network.\n\n2. The lack of timely antivirus database updates for the security solution\n\nused on attacked systems also played a key role, preventing the solution\nfrom detecting and blocking the threat. It should also be noted that some\ncomponents of the antivirus solution were disabled, further reducing the\nquality of protection.\n\n3. Other factors contributing to the incident’s development included the\n\nuser account privilege settings configured in domain policies and the\nparameteres of RDP access.\n\nThere were no restrictions on access to different systems. In other\nwords, all users were allowed to access all systems. Such settings help\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 7\n\n\n-----\n\nattackers to distribute malware on the enterprise network much more\nquickly, since successfully compromising just one user account provides\nthem with access to numerous systems.\n\nAttack workflow\n\n## Recommendations\n\n1. Keep the VPN Gateway firmware and endpoint security solutions\n\nupdated to the latest versions.\n\n2. Keep antimalware databases updated to the latest versions.\n\n3. Check that all components of endpoint security solutions are enabled.\n\n4. Make sure that the Active Directory policy allows users to log in only to\n\nthose systems which are required by their operational needs.\n\n5. Restrict network connections, specifically VPN connections, between\n\nhosts on the industrial network, block connections on all ports that are\nnot required by the industrial process.\n\n6. Configure the backup system to store backup copies on a dedicated\n\nserver.\n\n7. To further enhance your organization’s resilience to possible ransomware\n\nattacks, consider implementing Endpoint Detection and Response type\nsecurity solutions both on your IT and OT networks.\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 8\n\n\n-----\n\n8. Adapting Managed Detection and Response services to get immediate\n\naccess to high-level security professionals’ knowledge and expertise may\nalso be a good idea.\n\n9. [Use dedicated protection for the industrial process. Kaspersky Industrial](https://ics.kaspersky.com/)\n\nCyberSecurity protects industrial endpoints and enables OT network\nmonitoring to identify and block malicious activity.\n\n## Indicators of compromise (IOC)\n\n**File path**\n\n%temp%\\execute.bat (downloader script)\n\nC:\\__output (Cring executable)\n\n**MD5**\n\nc5d712f82d5d37bb284acd4468ab3533 (Cring executable)\n\n317098d8e21fa4e52c1162fb24ba10ae (Cring executable)\n\n44d5c28b36807c69104969f5fed6f63f (downloader script)\n\n**IP addresses**\n\n129.227.156[.]216 (used by the threat actor during the attack)\n\n129.227.156[.]214 (used by the threat actor during the attack)\n\n198.12.112[.]204 (Cobalt Strike CnC)\n\n45.67.231[.]128 (malware hosting)\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 9\n\n\n-----\n\nKaspersky Industrial Control Systems Cyber Emergency Response Team (Kaspersky ICS CERT)\nis a global project of Kaspersky aimed at coordinating the efforts of automation system vendors,\nindustrial facility owners and operators, and IT security researchers to protect industrial enterprises\nfrom cyberattacks. Kaspersky ICS CERT devotes its efforts primarily to identifying potential and\nexisting threats that target industrial automation systems and the industrial internet of things.\n\nKaspersky ICS CERT [ics-cert@kaspersky.com](mailto:ics-cert@kaspersky.com)\n\nVULNERABILITY IN FORTIGATE VPN SERVERS 10\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://ics-cert.kaspersky.com/media/Kaspersky-ICS-CERT-Vulnerability-in-Fortigate-VPN-servers-is-exploited-in-Cring-ransomware-attacks-En.pdf"
    ],
    "report_names": [
        "Kaspersky-ICS-CERT-Vulnerability-in-Fortigate-VPN-servers-is-exploited-in-Cring-ransomware-attacks-En.pdf"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716495,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1618403907,
    "ts_modification_date": 1618403907,
    "files": {
        "pdf": "https://archive.orkl.eu/6f721eaff00dc7d103227d7d30a890d585a460eb.pdf",
        "text": "https://archive.orkl.eu/6f721eaff00dc7d103227d7d30a890d585a460eb.txt",
        "img": "https://archive.orkl.eu/6f721eaff00dc7d103227d7d30a890d585a460eb.jpg"
    }
}