{
    "id": "5a0882cd-8b36-4bfd-9b44-a87c0eadb7b9",
    "created_at": "2023-01-12T15:04:22.006447Z",
    "updated_at": "2025-03-27T02:17:27.722504Z",
    "deleted_at": null,
    "sha1_hash": "eedaf3f0e030c2008a8188fe576674877481a8f9",
    "title": "2020-03-02 - Karkoff 2020- a new APT34 espionage operation involves Lebanon Government",
    "authors": "",
    "file_creation_date": "2022-05-29T10:49:01Z",
    "file_modification_date": "2022-05-29T10:49:01Z",
    "file_size": 397345,
    "plain_text": "# Karkoff 2020: a new APT34 espionage operation involves Lebanon Government\n\n**[blog.yoroi.company/research/karkoff-2020-a-new-apt34-espionage-operation-involves-lebanon-government/](https://blog.yoroi.company/research/karkoff-2020-a-new-apt34-espionage-operation-involves-lebanon-government/)**\n\nMarch 2, 2020\n\n## Introduction\n\nIn November 2018, researchers from Cisco Talos tracked and detailed a\n[“DNSEspionage” campaign against targets in Lebanon and UAE. At the time of the report,](https://securityaffairs.co/wordpress/84418/malware/oilrig-apt-karkoff-dnspionage.html)\nthe threat actor carried out a cyber espionage campaign by redirecting DNS traffic from\ndomains owned by the Lebanon government to target entities in the country.\n\n[In April 2019, Cisco Talos discovered evidence of the link between APT34 (codename Helix](https://blog.talosintelligence.com/2019/04/dnspionage-brings-out-karkoff.html)\nKitten or OilRig) and the “DNSEspionage” operation. Talos analysts discovered several\noverlaps in the infrastructure employed by attackers and identified common TTPs. They\ntracked this new implant “Karkoff”.\n\nExperts from Cybaze/ Yoroi Zlab, as part of ordinary Threat Intelligence activities, spotted a\nnew sample which they believe to be an update of the Karkoff implant. It could prove that\nAPT34 is still active and threat actors used it in a new campaign that appears to be active at\nthe time of writing. The APT group made some changes in its technique, tactics, and\nprocedures, but the target is the same, the Lebanon Government.\n\n\n-----\n\nIn this campaign, the APT group may have compromised a Microsoft Exchange Server\nbelonging to a Lebanon government entity, in fact, we found some evidence in the\ncommunication logic.\n\nThis new implant has some similarities with the samples of Karkoff involved in past\ncampaigns, including:\n\nsimilar Macro structure\n.NET modular implant with similar logic\nexploit Microsoft Exchange Server as communication channel\n\nMoreover, the new Karkoff implant implements a new reconnaissance logic in order to drop\nthe final payload only to specific targets, gathering system information, the domain name,\nhostname and running Operating System.\n\n### Update\n\nA few hours before this report has been publicly disclosed, malware researchers at the\nItalian cyber security firm Telsy also published their analysis.\n\nBoth reports are related to the same sample, but let me suggest reading both analyses to\nhave a clear vision of the threat actors and all the technical details related to the implant. The\n[report published by Telsy is available here: LINK.](https://blog.telsy.com/apt34-aka-oilrig-attacks-lebanon-government-entities-with-maildropper-implant/)\n\n## Technical Analysis\n\nHash 926e29f9242feb3e11c532616f7c90c5d7acab115d38ebf748cabaaa6a2a3667\n\nThreat APT34 Karkoff macro loader\n\n\nBrief\nDescription\n\n\nMalicious Excel macro\n\n\nSsdeep 24576:zLNkxqHOPi1K5sLMKd2rVIehO/KBhjPyVuVX/+2PPbK:wl4E\n\nTable 1. Sample information\n\nThe Malware is an Excel Document with a malicious macro embedded. The following image\n(Fig:1) shows the highlights of the extracted code.\n\nFig.1. Malicious Macro: drop and execute monitor.exe\n\nThe macro extracts a custom base64 code from the body of the file and, after a decoding\nroutine, it downloads an executable file into the following path\n“C:\\Users\\public\\.Monitor\\monitor.exe”. Persistence is assured by scheduling a new task\nnamed SystemExchangeService.\n\n\n-----\n\nFig.2.Persistence with SystemExchangeService\n\nThe extracted payload is summed up as follows: :\n\nFig.3.Static details of monitor.exe\n\nThe payload were not obfuscated at all. This made a simple and quick analysis.\n\nAs shown in the above figure, the creation date is on 29 February, this is an indicator of the\nrecent build of this implant. Moreover, a small file size (1.13MB) allows malicious content to\nbe downloaded and executed quickly.\n\nFig.4. details of compromised mail exchange server parameters\n\nAs the first step, as shown in Fig 4, the sample tries to connect to its own command and\ncontrol server, which happens to be an Exchange mail server belonging to the Lebanon\ngovernment. Once it connects, the C2 answers back with the list of available commands as\nattachments in a replied e-mail. Fig 5 shows the GetList function from where we might\nappreciate the eMail body decoding process. From the body, a custom encoded string is\ndecoded and later it is interpreted as a command.\n\nFig.5. detail of GetList function responsible for getting the list of available commands as mail\nattachments\n\nFollowing our analysis, we noticed the malware tries to connect back and forth to its C2 to\nget authorization and to share detailed information about the infected system. It used\n“UserAgent” of the exchange client. Fig 6 shows details on what is hijacked from the victim’s\nside.\n\nFig.6. details of Information stolen on the victim’s machine\n\nAnother evidence is the domain registration of the second command control: it has been\nregistered on January, 27, probably indicating the date of the beginning of the new attack.\n\nFig.7. details of domain registration godoycrus[.com\n\n## Conclusions\n\nAPT34 is still active, and this campaign against the Lebanon government demonstrates it.\nThe new version of the Karkoff malware is the demonstration that the Iran-linked APT34\ncyberespionage group continues to improve its arsenal. The sample involved in this\ncampaign implements new reconnaissance capabilities, it implements a covert and effective\nC2 communication channel through the use of the Microsoft Exchange Protocol.\n\n\n-----\n\nThe Group likely exploited or brute-forced a Lebanon related mail account with another tool\nof its arsenal, the [JASON tool. The Jason tool was leaked at the end of 2019, it could be](https://marcoramilli.com/2019/06/06/apt34-jason-project/)\nused by attackers to carry out bruteforce attacks on exchange servers.\n\n## Indicators of Compromise\n\nHashes\n\n59cbc7e788425120c2dde50f037afbf3b1d2108c0b7e27540e924cad2463fe5b\n26995a1cd99a5c70fd7bfa925cb0bbbdbd419bedc2d664dffd3b7c57ad07de66\n1b2c5354eb567132a341c1b15ad5cc71c3f5ba8e2788b67c0fbc0e7993beb1d2\nebae23be2e24139245cc32ceda4b05c77ba393442482109cc69a6cecc6ad1393\n678d59bcd469e4cf236c7af7517c54ab9ad643523383875bd875131d7130941f\nC2\n\ngodoycrus[.com\nPersistence\n\nSet Task scheduler\n\n### Yara Rules\n\n\n-----\n\n```\nrule Karkoff_Attack_2020_Excel_macro {\n     meta:\n     description = \"Yara Rule for new APT34 Karkoff campaign excel malicious\nmacro\"\n     author = \"Cybaze Zlab_Yoroi\"\n     last_updated = \"2020-03-02\"\n     tlp = \"white\"\n     category = \"informational\"\n     strings:\n      $a1 = \"EncodedData0\"\n      $a2 = \"NewTask9\"\n      $a3 = \"EAAMYEKwUAAEsEWQUAAMYEnQUAAMYEqAUAAJwSrgU\"\n      $a4 = \"TVqQAAMAAAAEAAAA\"\n  condition:\n     all of them\n}\nrule Karkoff_Campaign_2020 {\n     meta:\n          description = \"Yara Rule for new APT34 Karkoff campaign\"\n          author = \"Cybaze Zlab_Yoroi\"\n          last_updated = \"2020-03-02\"\n          tlp = \"white\"\n          category = \"informational\"\n     strings:\n      $a1 = \"SystemExchangeService\" ascii wide\n      $a2 = \"getWindowsVersion\" ascii wide\n      $a3 = \"GetCommands\" ascii wide\n      $s1 = {0A 7A 1E 02 7B 9C 12 00 04 2A}\n  condition:\n     uint16(0) == 0x5A4D and all of them\n}\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-02 - Karkoff 2020- a new APT34 espionage operation involves Lebanon Government.pdf"
    ],
    "report_names": [
        "2020-03-02 - Karkoff 2020- a new APT34 espionage operation involves Lebanon Government.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4632103e-8035-4a83-9ecb-c1e12e21288c",
            "created_at": "2022-10-25T16:07:23.542255Z",
            "updated_at": "2025-03-27T02:02:09.854487Z",
            "deleted_at": null,
            "main_name": "DNSpionage",
            "aliases": [],
            "source_name": "ETDA:DNSpionage",
            "tools": [
                "Agent Drable",
                "AgentDrable",
                "CACTUSPIPE",
                "DNSpionage",
                "DropperBackdoor",
                "Karkoff",
                "MailDropper",
                "OILYFACE"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8d76e350-dfb5-4733-800d-876de41f690d",
            "created_at": "2023-01-06T13:46:38.841887Z",
            "updated_at": "2025-03-27T02:00:02.932838Z",
            "deleted_at": null,
            "main_name": "DNSpionage",
            "aliases": [
                "COBALT EDGEWATER"
            ],
            "source_name": "MISPGALAXY:DNSpionage",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535862,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653821341,
    "ts_modification_date": 1653821341,
    "files": {
        "pdf": "https://archive.orkl.eu/eedaf3f0e030c2008a8188fe576674877481a8f9.pdf",
        "text": "https://archive.orkl.eu/eedaf3f0e030c2008a8188fe576674877481a8f9.txt",
        "img": "https://archive.orkl.eu/eedaf3f0e030c2008a8188fe576674877481a8f9.jpg"
    }
}