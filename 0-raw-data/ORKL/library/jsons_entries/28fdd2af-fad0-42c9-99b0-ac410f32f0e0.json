{
    "id": "28fdd2af-fad0-42c9-99b0-ac410f32f0e0",
    "created_at": "2023-01-12T15:05:59.299701Z",
    "updated_at": "2025-03-27T02:05:56.501128Z",
    "deleted_at": null,
    "sha1_hash": "c6bcd6d61d82c40418450c33786f38cbae3d0350",
    "title": "2015-11-16 - Shining the Spotlight on Cherry Picker PoS Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T15:57:19Z",
    "file_modification_date": "2022-05-28T15:57:19Z",
    "file_size": 273192,
    "plain_text": "# Shining the Spotlight on Cherry Picker PoS Malware\n\n**[trustwave.com/Resources/SpiderLabs-Blog/Shining-the-Spotlight-on-Cherry-Picker-PoS-Malware/](https://www.trustwave.com/Resources/SpiderLabs-Blog/Shining-the-Spotlight-on-Cherry-Picker-PoS-Malware/)**\n\nLoading...\n\nBlogs & Stories\n\n## SpiderLabs Blog\n\nAttracting more than a half-million annual readers, this is the security community's go-to destination for\ntechnical breakdowns of the latest threats, critical vulnerability disclosures and cutting-edge research.\n\n**Introduction**\n\nFor the last five years Trustwave has been monitoring a threat across a number of forensic cases that we have\ndubbed \"Cherry Picker\". This targeted Point of Sale (PoS) memory scraper has enjoyed a very low detection\nrate in the wild for quite some time. Cherry Picker uses a new memory scraping algorithm, a file infector for\npersistence, and cleaner malware that removes all traces of the infection from target systems. This\nsophisticated functionality and highly targeted victims have helped the malware remain under the radar of\nmany AV and security companies. This post will expose the functionality of Cherry Picker and hopefully help\norganizations provide protection from this threat.\n\n**The Past**\n\nIn 2011 Trustwave's forensic analysts worked on a case involving several pieces of malware that worked in\nconcert to obtain Card Holder Data (CHD) from memory of the target process.\n\n\n-----\n\n|Filename Filename|Hash Hash|Compile Date Compile Date|\n|---|---|---|\n|searcher.dll|B532B2C489EC2989AA976151D9E3878323B9AAD20AF0DC8538F1B30379449162|2009-11- 05 20:12:18|\n|sr.exe|E81D12CB40A32A233780328D0BB73598D393C47049847DBBA24881DE034BF938|2009-11- 05 20:12:12|\n\n\nSr.exe is a command line interface that accepts n Process IDs (PID) and injects the searcher.dll into each\nprocess. Searcher.dll looks for CHD in the injected process and writes out the found data to a plain text file as\n%WINDIR%\\system32\\Data.txt directory. These samples are fairly well detected with both files being flagged\nby a large number of AVs as a generic banking Trojan or Point of Sale (PoS) memory scraper. However, this\ntool set never seems to be alone on the system. Our investigations have found it being used with, or\n[embedded in, an AutoIt script such as fishnetsecurity discusses.](https://www.fishnetsecurity.com/6labs/blog/autoit-scripting-pos-malware) [TrendMicro found it in use with another PoS](http://www.trendmicro.com/vinfo/us/threat-encyclopedia/malware/troj_banker.qpa)\n[memory scraper called Rdasrv. Trustwave's malware researchers presented this threat at the Sector](http://sector.ca/portals/17/Presentations12/Josh%20Grunzweig%20-%20Ryan%20Merritt%20-%20Targeted%20Malware%20Attacks%20-%20Sophisticated%20Criminals%20or%20Babytown%20Frolics%20-%20Sector%202012.pdf)\nconference detailing exactly how they worked as well as including both Cherry Picker and Searcher artifacts in\na SANS course: [Sniper Forensics.](https://files.sans.org/summit/forensics11/PDFs/Sniper%20Forensics-Target%20Acquisition.pdf)\n\nSo not exactly under the radar huh? Okay, fair enough. Just like in all the infomercials we get to the part you all\nknowâ€¦ BUT WAIT! There's more.\n\n**Cherry Picker**\n\nCherry Picker is a set of malware that has also been seen on systems in conjunction with searcher.dll;\nhowever, unlike Searcher it has gone largely unnoticed by the AV and security community. While Searcher has\nremained unchanged on the various cases it has been seen on, Cherry Picker has undergone consistent\nimprovement over the years. So what is Cherry Picker exactly? There are essentially been 3 versions of the\nmain malware:\n\nFilename: Pserver32.dll\n\n**Compile**\n\n**Version** **Hash** **Date**\n\n1 CB71B31AF4BC5A5D3F541BEFF87ECBFD55F24BA7AD6249484608E359D880F2DD 200912-05\n05:12:21\n\n2 AC1837B37A495BEDF644A2824CD36F2BFB34CAD122C26E1FE497146A8F2A16A4 201003-04\n13:22:59\n\n3 3F366CCED9473CFBEDA0245F5817699D5BEB81D0AB4D2C81E1E3DCB7DCE7465D 201502-01\n01:13:33\n\nIf this were a legitimate development project these versions would be minor version updates. Each one adds a\nsmall amount of functionality to the previous version.\n\n**Loading**\n\n|Version|Hash|Compile Date|\n|---|---|---|\n|1|CB71B31AF4BC5A5D3F541BEFF87ECBFD55F24BA7AD6249484608E359D880F2DD|2009- 12-05 05:12:21|\n|2|AC1837B37A495BEDF644A2824CD36F2BFB34CAD122C26E1FE497146A8F2A16A4|2010- 03-04 13:22:59|\n|3|3F366CCED9473CFBEDA0245F5817699D5BEB81D0AB4D2C81E1E3DCB7DCE7465D|2015- 02-01 01:13:33|\n\n\n-----\n\nBefore we can talk about the meat of Cherry Picker s functionality, we need to take a look at how the DLL is\nloaded into memory. In the searcher.dll case, sr.exe was used to inject the scraper into the memory of a target\nrunning process. No persistence was used to perform this function automatically. Cherry Picker has two\ndifferent ways to install persistence. In several of the cases, a registry file was discovered, that when ran\nadded pserver32.dll the following registry key:\n\n[HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows]\n\n\"AppInit_DLLs\"=\"pserver32.dll\"\n\nFrom the Microsoft support site:\n\n\"The AppInit_DLLs are loaded by using the LoadLibrary() function during the\n**DLL_PROCESS_ATTACH process of User32.dll. Therefore, executables that do not link with User32.dll does**\nnot load the AppInit_DLLs. There are very few executables that do not link with User32.dll.\"\n\nIn order for the DLL to be loaded from the AppInit_DLLs registry key, it must be \"turned on\". This is\naccomplished by setting the following registry key to 1:\n\n[HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows]\n\n\"LoadAppInit_DLLs\"=0x00000001\n\nThis causes numerous applications to load the malicious DLL at startup. On the most recent case our analysts\nfound an additional install mechanism that greatly increased the options available to the attacker. The author\nupgraded sr.exe to srf.exe:\n\nsrf.exe 7AB1F21B41134FF21476760434569383D8FD55D444DF035C900F330B13F70CBD 2010-0302\n16:35:23\n\nSrf requires that the first argument match a hardcoded string (\"password\") in the binary. This may help it\nprevent AVs from marking it as malware since it exits without performing any malicious activity. Srf provides a\nhandy usage to show what options are available to install the malware:\n\nThe injection option is still here, although it has been expanded to include the ability to inject into all running\nprocesses, processes by name, or processes by PID. They can also install/uninstall a variable DLL name into\nthe AppInit_DLLs registry key (which is what they mean by autorun). Then there is the patch DLL option. This\noption is a sophisticated file infector that patches the legitimate user32.dll on disk to first load the malicious\nDLL provided in the option before continuing on with the legitimate functionality of the system DLL. Srf uses a\nlittle known legitimate function of windows (sfc_os.dll #5) to disable system write protection on all 3 versions of\nuser32.dll stored on the system. The legitimate copy is then copied to the same directory under user32.tmp\nbefore adding a DllEntryPoint to user32.dll with malicious code to load the supplied DLL.\n\nThis is the entry point for the legitimate user32.dll:\n\n|srf.exe|7AB1F21B41134FF21476760434569383D8FD55D444DF035C900F330B13F70CBD|2010-03- 02 16:35:23|\n|---|---|---|\n\n\n-----\n\nAfter the modification, the new entry point is DllEntryPoint:\n\nEvery time user32.dll is loaded by an application, pserver32.dll is loaded first and then the legitimate code is\nexecuted. This has basically the same effect as AppInit_DLLs registry key but without leaving the tell tale\ntraces that can be found by a forensic analyst. The majority of Windows executables load user32.dll.\n\n**The Config**\n\nThe first thing the malware does is look for a hardcoded filename in the current working directory that contains\nconfiguration information. In version 1 the config file was name graph32.dll and was a plaintext file with the\nheader \"[config]\". The lines after that contain \"key=value\" pairs that set options available to the malware. The\nAPI GetPrivateProfileIntA and GetPrivateProfileStringA are used to parse the plain text file and obtain the\nconfiguration values. In version 2 a new type of config file was introduced and the hardcoded filename\nchanged to: kb852310.dll. While the plain text config was still supported, if the malware doesn't find the \"\n\n[config]\" header it will attempt to decode the file using a custom de-obfuscation algorithm. I have reversed this\nalgorithm and written a python script, which writes out the de-obfuscated config to disk. The script can be\n[found here. The plain-text config and the obfuscated config are parsed in two different manners but contain](https://github.com/SpiderLabs/malware-analysis/blob/master/Python/CherryPicker/cherryConfig.py)\nessentially the same information. The one difference is the obfuscated config can contain a public key, which\nwill allow Cherry Picker to encrypt CHD before writing it to the exfiltration file. Both configs contain the following\nfields:\n\nTarget Process Process name to target for injection\n\n\n-----\n\n|FTP Username|Username for logging into FTP server|\n|---|---|\n|FTP Password|Password for logging into FTP server|\n|FTP Host|Hostname/IP for FTP server|\n|FTP Passive|Use FTP Passive mode|\n|RAR Password|Password for creating encrypted RAR archives|\n|RAR Template|Naming template for encrypted RAR archives|\n|CHD dump file location|Full path to CHD file ex: C:\\Windows\\system32\\sysss.dll|\n|Time|What time to perform exfiltration of dump files. Ex: time=2045 (8:45PM)|\n|Timeout|Time to wait before scraping memory|\n\n\nThis is how Cherry Picker came by its name. The configuration specifies a target process that it expects to be\nloaded in. If the parent process does not match the name specified by this field the malware will exit. This\nimplies that the malware author already has scouted the system and knows exactly what process they are\ntargeting. Just like a cherry picker in basketball, Cherry Picker all the other processes on the system to target\none process and go after that sweet, sweet card data.\n\n**Off and Running**\n\nOnce the malware has loaded the configuration file and verified that it is running in the correct process, a\nmutex is created. This prevents multiple copies from spawning on the system and synchronizes the collection\nof CHD and the exfiltration of files. In version 1 and 2 the hardcoded mutex was:\n\n**Global\\\\Srch1Mutex**\n\nVersion 3 changed the name to:\n\n**Global\\\\SYNC32TOOLBOX**\n\nThe malware runs two threads. The first thread is responsible for finding the CHD in the process, writing the\nresults to a file, and preparing the files for exfiltration. The location of the exfiltration file, time to perform the\nexfiltration, and destination are all contained in the configuration file.\n\nCherry Picker enumerates the files in the %WINDIR%\\System32 directory and builds a list of all .rar files that\nare found. It then begins to loop through the memory of the target process looking for CHD and writing it out to\nthe file specified by the config for exfiltration. In version 3 of the malware, the author introduces a new\ntechnique for scraping memory using the API QueryWorkingSet. We will be releasing a follow up to this blog\ntomorrow detailing this technique.\n\nIf a public key is in the config, the data in encrypted before writing it to the exfiltration file, otherwise it is written\nin plain text. Once the system time matches the exfiltration time listed in the configuration file, the malware will\nadd the file containing the CHD to an encrypted archive using the following command:\n\n**rar m <template_rar_filename> <exfil_file> 0 -y -hp<password>**\n\nThis thread will then release the mutex and sleep for 15 seconds plus the configured sleep timer. It will then reacquire the mutex and repeat the above process indefinately.\n\n\n-----\n\nThe second thread is responsible for exfiltrating the file to the FTP server specified in the configuration file.\nThis thread waits for the mutex to be released and then FTPs all .rar files contained in the global list to the FTP\nserver. If the config is missing the FTP username or password, it will use the IP in the configuration file to\nperform a POST request to /update.php on the server. The archive is deleted after it is exfiltrated from the\nsystem.\n\nThis thread also maintains a log of the activities on the system based on the file path given in the configuration\nfile. However, in all the observed configs there was no path listed which caused the log file to be written to\n%WINDIR%\\0.log (or just 0 depending on the version). This file contains a log of the exfiltration attempts and is\nexfiltrated with the CHD:\n\n**<time_date_stamp> <exfil_file_size> <rar_exfil_name>**\n\n**The Cleanup**\n\nIt is rare for malware authors to clean up artifacts on an infected system. On one of the systems the forensic\nanalyst was able to discover a file that did exactly this and more. The author went above and beyond writing a\ncleaner that return the system to a \"clean\" state. This cleaner was highly targeted, and contained hardcoded\npaths to the malware, exfiltration files, and the legitimate files on the system. The recent compile time of the\ncleaner also points to the cleaner being written for the current malware campaign.\n\nCvc.exe C79C6EB598E496B27263B59858FC394AC6262302D63C7FD6CD5148852EA0E744 201506-30\n03:57:24\n\nCvc looks for the TeamViewer process running on the system and injects code into it if it finds it, exiting if it\ndoesn't exist. TeamViewer is a free third party remote desktop software. The use of weak or default passwords\non remote admin tools is a common initial vector of compromise on PoS systems and was likely the ingress\nmethod for the most recent forensic case involving Cherry Picker. The code contains a custom \"shredder\"\nfunction that takes a file path overwrites the file multiple times with 00's, FF's, and cryptographic junk before\nmoving the file to a random name in the same folder. The random name is then deleted. A hardcoded list of\nmalware and exfiltration file locations are shredded. The injected code also shreds the original cvc.exe. The\nAppInit_DLLs registry key is checked for the pserver32.dll value and deleted if it exists. The PoS software that\nwas being targeted is terminated and then re-launched to remove the malware from memory. Once the\nmalware has been removed from the system, the system handles held by the TeamViewer process are\nenumerated and the handle to the current log file is obtained. The current position is set to the beginning of the\nfile, causing TeamViewer to overwrite its own logs. The injected code then deletes all old log files from the\nTeamViewer directory. Finally, the connection log is accessed and any reference to the malware author's\nconnection is overwritten with 00's. The injected thread terminates and concludes restoring the system to a\nnear pre-infection state. It does not reset the LoadAppInit_DLLs Registry key to 0, which doesn't necessarily\nmean that the system was infected by Cherry Picker but isn't typically set to 1 on a system with default\nsettings.\n\n**Detection**\n\nTrustwave's Endpoint Protection contains custom signatures that protect our customers from the Cherry Picker\nthreat. In addition to this we have released Yara rules capable of finding the installation, main malware, and\n[cleaner for Cherry Picker malware. The yara signatures can be found at Trustwaves github page.](https://github.com/SpiderLabs/malware-analysis/blob/master/Yara/CherryPicker/cherryPicker.yar)\n\n**Conclusion**\n\n|Cvc.exe|C79C6EB598E496B27263B59858FC394AC6262302D63C7FD6CD5148852EA0E744|2015- 06-30 03:57:24|\n|---|---|---|\n\n\n-----\n\nAny malware author s main goal is to obtain target data while not being discovered or blocked by the owners of\nthe target network. Cherry Picker was built to evade security controls through its use of configuration files,\nencryption, obfuscation, command line arguments and highly targeted victims. The introduction of a new way\nto parse memory and find CHD, a sophisticated file infector, and a targeted cleaner program have allowed this\nmalware family to remain under the radar of many security and AV companies. Hopefully this post will raise\nawareness and drive further discussion of this malware family so that customers will be protected from this\nthreat.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-11-16 - Shining the Spotlight on Cherry Picker PoS Malware.pdf"
    ],
    "report_names": [
        "2015-11-16 - Shining the Spotlight on Cherry Picker PoS Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535959,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653753439,
    "ts_modification_date": 1653753439,
    "files": {
        "pdf": "https://archive.orkl.eu/c6bcd6d61d82c40418450c33786f38cbae3d0350.pdf",
        "text": "https://archive.orkl.eu/c6bcd6d61d82c40418450c33786f38cbae3d0350.txt",
        "img": "https://archive.orkl.eu/c6bcd6d61d82c40418450c33786f38cbae3d0350.jpg"
    }
}