{
    "id": "530adee4-884d-40d3-a259-3ca30af18415",
    "created_at": "2023-01-12T15:09:18.240887Z",
    "updated_at": "2025-03-27T02:09:18.399479Z",
    "deleted_at": null,
    "sha1_hash": "01c35b80f28539eebaadaa25812d3b1e9fd83a4a",
    "title": "2021-11-17 - DNS Over HTTPS for Cobalt Strike",
    "authors": "",
    "file_creation_date": "2022-05-27T21:07:02Z",
    "file_modification_date": "2022-05-27T21:07:02Z",
    "file_size": 1259063,
    "plain_text": "# DNS Over HTTPS for Cobalt Strike\n\n**blackhillsinfosec.com/dns-over-https-for-cobalt-strike/**\n\n[Kyle Avery //](https://www.blackhillsinfosec.com/team/kyle-avery/)\n\n## Introduction\n\n\n17 Nov 2021\n\n\nSetting up the C2 infrastructure for red team engagements has become more and more of a\nhassle in recent years. This is a win for the security community because it means that\nvendors and professionals have learned from previously successful techniques and\nimplemented effective mitigations in their networks.\n\nDNS over HTTPS is an underappreciated channel for command and control. This blog will\nshow you how to utilize DoH with Cobalt Strike in a way that requires no third-party accounts\nor infrastructure setup, encrypts traffic with a valid SSL certificate, and sends traffic to\nreputable domain names.\n\n## Existing Techniques\n\nAttackers and offensive security professionals have been using different redirector\nimplementations for some time. The first redirectors that I used were simple Apache and\nNginx servers configured with various rules to forward traffic based on predefined criteria.\n\n\n-----\n\nRedirectors are great for making infrastructure more resilient, but they can also bypass\ndefenses that rely on domain categorization. For example, once Content Delivery Networks\n(CDN) became more accessible to developers, attackers moved from traditional redirectors\nto these platforms because they often provide a valid domain name and even SSL certificate\nto the user, reducing the work of an attacker.\n\nA technique known as “domain fronting” was later discovered and used heavily by many\ntesters. More recently, however, CDN providers have been cracking down on this behavior.\nMany sites prevent domain fronting entirely or actively search for those using it. Microsoft in\nparticular has been known to shut down Azure Subscriptions in the middle of our operations.\n\nI have recently turned to other cloud services such as Azure App Services and Cloudflare\nWorkers for traffic redirection. These have the same benefits as traditional CDNs but are less\nheavily monitored. While these services work well, cloud providers could decide to start\nwatching these with the same dedication as they watch CDNs any day.\n\n## DNS over HTTPS\n\nTraditional DNS Beacons are relatively straightforward to detect. I have never used the\nCobalt Strike DNS listener on an operation, limiting me to the previously described HTTPS\nlistener and redirectors.\n\nDNS over HTTPS for Beacon provides us reputable domains and valid SSL certificates\nwithout needing an account or any configuration of the redirector. This reduces an operator’s\nsetup time even further and eliminates the risk of account shutdown.\n\n## Today’s Topic: DNS over HTTPS for Cobalt Strike\n\nThe use of DNS over HTTPS was first presented to me on Twitter by [Austin Hudson. His](https://twitter.com/ilove2pwn_)\ntweets over the last year detailed his progress towards this capability and resulted in an\n[open-source tool: TitanLdr. This Cobalt Strike user defined reflective loader (UDRL) hooks](https://github.com/secidiot/TitanLdr)\nthe Cobalt Strike Beacon’s import address table (IAT) to replace the API call responsible for\nmaking traditional DNS queries (DNSQuery_A) with a function that makes DoH requests to\ndns.google (8.8.8.8 and 8.8.4.4).\n\nThis alone is an excellent capability, but TitanLdr’s DNSQuery_A hook is generic enough to\nwork with many different DoH servers! I have tested the following domains and confirmed\nthat they work as drop-in replacements:\n\ndns.quad9.net\nmozilla.cloudflare-dns.com\ncloudflare-dns.com\ndoh.opendns.com\nordns.he.net\n\n\n-----\n\n## Using TitanLdr\n\nTitanLdr is the key to integrating this capability into Cobalt Strike. You can grab the original\nTitanLdr, which beacons to a single DNS provider over HTTPS server here:\n[https://github.com/secidiot/TitanLdr. You can change the DNS server on line 111 of the](https://github.com/secidiot/TitanLdr)\nDnsQuery_A.c file in the hooks directory.\n\n_Line 111 in_\n\n_TitanLdr/hooks/DnsQuery_A.c (Original Repository)_\n[I have since forked TitanLdr to allow for multiple DoH servers to be specified. Each time a](https://github.com/kyleavery/TitanLdr)\ncallback is made, the Beacon will randomly select one from a hardcoded list. If you want to\nuse multiple DoH servers, you can download my fork here:\n[https://github.com/kyleavery/TitanLdr. You can modify the list of servers at line 116 of the](https://github.com/kyleavery/TitanLdr)\nDnsQuery_A.c file in the hooks directory.\n\n_Line 116 in_\n\n_TitanLdr/hooks/DnsQuery_A.c (Forked Repository)_\nOnce downloaded, you will have to build the program. This will require a Linux host with\nNASM and MinGW installed. Once you have these programs, run the make command to\ncreate the necessary files.\n\n\n-----\n\n_Building TitanLdr_\nImport the Titan.cna Aggressor script into Cobalt Strike, and you are ready to use DoH!\n[Configure a DNS listener as you usually would. The Cobalt Strike documentation goes more](https://www.cobaltstrike.com/help-dns-beacon)\nin-depth on configuring this listener.\n\n_Configuring a DNS Listener_\n\nOnce the Beacon is running, we can see that only one DNS request is made to resolve the\nDoH server address. Afterward, all of the traffic is encrypted HTTPS.\n\n_DoH_\n\n_Beacon Network Traffic_\n\n## Drawbacks of DNS over HTTPS\n\n\n-----\n\nWe ve already discussed the benefits a DNS over HTTPS Beacon has over a traditional\nHTTPS Beacon, but there are also some definite drawbacks.\n\nFirst, more packets are needed to communicate the same information back to the team\nserver. A DNS TXT record can only contain a maximum of 255 characters, meaning we can\nonly send a small amount of data in each packet.\n\nSecond, we have no control over the path or domain names of available servers. It seems\neasier for an environment or appliance to deny outbound 443/TCP to the list of popular or\nknown DoH servers than block Microsoft’s *.azurewebsites.net or Cloudflare’s *.workers.dev.\nYou could solve this by using more obscure DoH servers or by building your own and\ncategorizing them over time, depending on how the environment is configured.\n\n## Potential Detection Methods\n\nCurrent detection techniques may have gaps when it comes to detecting DNS over HTTPS.\n\nCurrent detections targeting malicious HTTPS traffic typically utilize domain reputation,\nrendering them potentially ineffective against DoH since the domains in use are\nreputable.\nCurrent detections targeting malicious DNS traffic typically monitor for many DNS\nrequests, rendering them potentially ineffective against DoH since the traffic is no\nlonger using the DNS protocol.\n\nA combination of traditional DNS monitoring and SSL inspection could be a potential\nsolution, but I do not know of any current tools or products that do this.\n\nMy understanding is that the primary defense against this attack is blocking outbound\n443/TCP to known DoH servers that an organization is not using. Most networks I encounter\nstill use traditional DNS, often with a local DNS server running as part of the Active Directory\nenvironment. In this case, there is no need to allow HTTPS traffic to dns.google, cloudflaredns.com, or any others mentioned in this post.\n\n## Closing Thoughts\n\nThere are absolutely more DNS over HTTPS servers that could be used with this\nconfiguration. In addition, the user could set up their own DoH server, maybe even behind a\nCDN or other cloud service, to introduce a variation on this technique.\n\nTitanLdr is limited to Cobalt Strike, but the DoH implementation could be ported to any other\nC2 framework.\n\nThis method will not be the best in every scenario, but it is another tool in the toolkit that I\nhope you can take advantage of. Feel free to contact me with any questions or comments on\nTwitter [@kyleavery_.](https://twitter.com/kyleavery_)\n\n\n-----\n\n## Credits\n\nThe idea to use DNS over HTTPS for C2 comes from the work of [Austin Hudson. This](https://twitter.com/ilove2pwn_)\n[technique and blog would not have happened without his TitanLdr project. Austin’s](https://github.com/secidiot/TitanLdr)\ncode and tweets have inspired many of my personal projects; I highly recommend\nfollowing him.\nI mentioned that I currently use two redirector services for traditional HTTPS Beacons:\nAzure App Services and Cloudflare Workers. I originally discovered these techniques at\nthe following two links:\n\n[https://ajpc500.github.io/c2/Using-CloudFlare-Workers-as-Redirectors/](https://ajpc500.github.io/c2/Using-CloudFlare-Workers-as-Redirectors/)\n[https://github.com/bashexplode/cs2webconfig](https://github.com/bashexplode/cs2webconfig)\n\n\n-----\n\n**We are self-publishing free Infosec Zines called PROMPT#.**\n\nPROMPT# will contain:\n\nInfosec articles\nChallenging puzzles\nComic book based on real-life hacking adventures\nColoring contests\n[Bonus Backdoors & Breaches Consultant Cards (print version only)](https://backdoorsandbreaches.com/)\nOther stuffs\n\nYou can check out current and upcoming issues\nhere: [https://www.blackhillsinfosec.com/prompt-zine/](https://www.blackhillsinfosec.com/prompt-zine/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-17 - DNS Over HTTPS for Cobalt Strike.pdf"
    ],
    "report_names": [
        "2021-11-17 - DNS Over HTTPS for Cobalt Strike.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536158,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653685622,
    "ts_modification_date": 1653685622,
    "files": {
        "pdf": "https://archive.orkl.eu/01c35b80f28539eebaadaa25812d3b1e9fd83a4a.pdf",
        "text": "https://archive.orkl.eu/01c35b80f28539eebaadaa25812d3b1e9fd83a4a.txt",
        "img": "https://archive.orkl.eu/01c35b80f28539eebaadaa25812d3b1e9fd83a4a.jpg"
    }
}