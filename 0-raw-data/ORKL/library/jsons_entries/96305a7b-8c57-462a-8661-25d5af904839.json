{
    "id": "96305a7b-8c57-462a-8661-25d5af904839",
    "created_at": "2023-01-12T15:04:33.445253Z",
    "updated_at": "2025-03-27T02:16:47.063619Z",
    "deleted_at": null,
    "sha1_hash": "1b0658c0925f90e11906d4afe0fbd1d3fd72554f",
    "title": "2020-01-31 - New wave of PlugX targets Hong Kong",
    "authors": "",
    "file_creation_date": "2022-05-28T02:26:27Z",
    "file_modification_date": "2022-05-28T02:26:27Z",
    "file_size": 943280,
    "plain_text": "# New wave of PlugX targets Hong Kong\n\n**[insights.oem.avira.com/new-wave-of-plugx-targets-hong-kong/](https://insights.oem.avira.com/new-wave-of-plugx-targets-hong-kong/)**\n\nJanuary 31, 2020\n\nMustang Panda is a well-known APT with a long history of targeting non-governmental\norganisations (NGOs). It utilizes shared malware like Poison Ivy, PlugX and Cobalt Strike\npayloads in order to gather intelligence. Since 2008, PlugX as a RAT (Remote Access\nTrojan) malware family has been used as a backdoor to control the victim’s machine fully.\nOnce the device is infected, an attacker can remotely execute several kinds of commands\non the affected system to retrieve machine information, capture the screen, manage\nservices, and manage processes.\n\n## Overview\n\nAvira’s Advanced Threat Research team, has been tracking Mustang Panda APT for a\nwhile. According to Avira’s telemetry data, Mustang Panda mostly targets Asia-Pacific\n(APAC) countries and uses Cobalt or PlugX as payload.\n\nAvira’s Advanced Threat Research team discovered a new version of PlugX from the\nMustang Panda APT that is used to spy on some targets in Hong Kong and Vietnam. The\nway that the APT actor infects the target, and launches the malicious payload is similar to\n[previous versions—but with some differences.](https://blog.malwarebytes.com/threat-analysis/2016/08/unpacking-the-spyware-disguised-as-antivirus/)\n\nPlugX executes DLL hijacking with benign applications such as ESET antivirus, Adobe\nUpdate etc. However, the way the PlugX loader launches the payload is different from how\nit was done for the previous versions. Also, the PlugX that Mustang Panda APT uses has\nsome extra features, including spreading through USB, gathering information, and stealing\ndocuments in air-gaped networks via USB.\n\n\n-----\n\nMustang Panda APT uses a package of binaries to load the actual payload and it is\nintentionally designed this way to bypass file scanners and sandboxes. PlugX contains 3\nfiles: benign EXE file for DLL hijacking, DLL (just a loader to execute the payload), and the\nencrypted payload (usually with “.dat” extension). The Advanced Threat Research team at\nAvira, have found different types of loaders (PlugX loader), and we will discuss it in more\ndetail below. Obviously, file scanners or sandboxes can’t detect the PlugX payload without\nthe encrypted DAT file.\n\n[Anomali’s Threat Research Team published a post about this campaign with the focus on](https://www.anomali.com/blog/china-based-apt-mustang-panda-targets-minority-groups-public-and-private-sector-organizations)\nthe initial infection. In this article, we are going to dig into the PlugX loader and new PlugX\npayloads that Mustang Panda APT is using to spy on the targets.\n\n## First stage: Loader\n\nThe Loader is a tiny DLL file, the payload is an encrypted DAT file.\n\nThe DLL is responsible for decrypting the DAT file and executing it like a shellcode in\nmemory. It reads the encrypted payload from disk by calling CreateFile and ReadFile APIs,\nand then allocates memory via VirtualAlloc. After decryption, it changes the protection via\nVirtualProtect and at the end executes it via direct call instruction.\n\nDLL utilizes junk codes and a simple obfuscation to hide the API calls via stackstrings and\nload them dynamically.\n\nThe DAT file contains the decryption key inside of itself. The size of the key can vary. The\nloader reads offset zero of encrypted DAT file until it reaches null and takes that as an XOR\nkey to decrypt the rest of the file.\n\n\n-----\n\nFigure 1: decryption routine for loader\n\nSome of the loaders have hardcoded time inside the binary and they simply decrypt and\nexecute the payload in a specific period of time.\n\nFor example, look at the following picture from one of the loader samples with time\nchecking. The date is hardcoded “20190929.”\n\n\n-----\n\nWe have found 15 unique payloads.\n\nWe observed these DAT file names from our telemetry:\n\n**File Name**\n\nadobeupdate.dat\n\nclntcon.dat\n\nhttp_dll.dat\n\nlog.dat\n\nmpsvc.ui\n\nmp.dat\n\n## Payload\n\n\n-----\n\nAs explained previously, the payload is executed like a shellcode but surprisingly, it s a full\nPE binary. The loader will start the payload from the zero offset of the payload that it means\nfrom MZ. The picture below shows a very small crafted shellcode to call the entrypoint.\n\nThe decrypted payload is just loaded in memory and there are no footprints on the disk.\nThis is the customized version of PlugX with simple obfuscations to bypass static detection\nand hide the strings.\n\nFigure 2: crafted shellcode to call the entrypoint\n\nThe payload is a DLL with one export function called “Loader.” The shellcode at the\nbeginning calls the “Loader” export function.\n\nThe export function does the Windows loader job to load the DLL correctly and then\nexecutes the entrypoint.\n\nPayload uses the wrapper function for every API call to obfuscate the API calling\nmechanism. In the wrapper function, there are stackstrings for the API function name and\nmodule name. In the picture below, you can see an example.\n\nIt can be executed in 3 different ways:\n\n**Argument** **Description**\n\n\n-----\n\nno\nargument\n\n\nSet a registry key for persistence and create a directory for files and run the\nmalware again with -app\n\n\n-app USB infection\nStealing documents and storing in USB for air gap network\nConnect to the C&C address and execute the commands\n\n-net set the value of key registry\n“System\\CurrentControlSet\\Control\\Network\\Version” to “1”\nSet a registry key for persistence and create a directory for files and\nrun with -app\n\nFor the persistence, it uses the registry run key:\n```\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nHKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n\n```\nIt creates %appdata%\\Intel directory for additional modules and stolen information.\n\nIt uses a set of registry keys for storing data:\n```\n\"System\\CurrentControlSet\\Control\\Network\\Version\" → internet access\nstatus\n\"Software\\CLASSES\\ms-pu\\PROXY\" → C&C server version\n\n```\nThe PlugX TLS value names in the binary:\n\n**Thread name** **Functionality**\n\nCXOnline::OlStartProc starts CXOnline::OlStartProcPipe\nInitializes C&C communication\n\nCXOnline::OlStartProcPipe Initializes pipe communication objects\n\nParses C&C commands\n\n\nCXFuncShell::ShellT1\nCXFuncShell::ShellT2\n\n\nRemote Shell\n\n\nCXSalvation::SalExceptionHandler Global exception handler for logging in SS.LOG file\n\nCXSoHttp::SoWorkProc Sends requests to the C&C server\n\n### USB infection\n\n\n-----\n\nOne of the features that distinguishes this variant from other PlugX variants is the capability\nof spreading through a USB stick. This part of the code is different from other parts of PlugX\nas we don’t see any TLS value name for this functionality.\n\nAfter detecting the removable USB volume drive, the PlugX variant creates a hidden folder\nwith name “RECYCLE.BIN” and copies the EXE file, the loader DLL, and encrypted DAT\nfile. Then, it hides all of the folders in the root directory and creates LNK for each one in\norder to deceive the victim to click on the LNK files.\n\n### Air gap network\n```\nPlugX checks whether there's no internet access, then tries to find the\nUSB stick and creates the BAT file in the following path, <usb\nvolume>\\RECYCLE.BIN\\<plugX clsid>\\tmp.bat, and executes it. At the end, it\ndeletes the BAT file.\n\n```\nBy running this BAT file, it gathers local and network information about the infected system\nand tries to send it out via USB.\n```\ncmd.exe /c systeminfo > <usb volume>\\RECYCLE.BIN\\<plugX clsid>\\sys.info\ncmd.exe /c ipconfig /all >> <usb volume>\\RECYCLE.BIN\\<plugX clsid>\\sys.info\ncmd.exe /c netstat -ano >> <usb volume>\\RECYCLE.BIN\\<plugX clsid>\\sys.info\ncmd.exe /c arp -a >> <usb volume>\\RECYCLE.BIN\\<plugX clsid>\\sys.info\n\n```\n\n-----\n\n```\ncmd.exe /c tasklist /v >> <usb volume>\\RECYCLE.BIN\\<plugX clsid>\\sys.info\n\n```\nFigure 3: run BAT file for gathering info\n\nIt searches the whole system for the following file extensions:\n\n**document extensions**\n\n.doc\n\n.docx\n\n.ppt\n\n.pptx\n\n.xls\n\n.xlsx\n\n.pdf\n\nIt encrypts the mentioned documents on the fly via RC4, then copies them in its specific\nfolder in the usb: “<usb volume>\\RECYCLE.BIN\\<plugX clsid>”.\n\nThe RC4 key is hardcoded in the payload binary.\n\nFrom our telemetry data, we found a different way of stealing documents. It abuses RAR to\nsearch document files and compress them locally in order to send it to its CNC server.\n\n\n-----\n\nThe command line looks like this:\n\nRar.exe a -r -ed -m3 -dh -tk -hp<password> -v100m -ta<file modified date after> -n*.doc* n*.xls* -n*.pdf <compressed file path> <searching directory>\n\nAs you can see, it’s looking for a specific date to compress .xls* and .pdf extensions. It also\nuses a password to encrypt file data and header.\n\n### Configuration\n\nThe config can be encrypted or be plaintext in the binary. If the config data starts with\n“XXXXXXXX,” it means the config is not encrypted.\n\nIf the config is encrypted, the config data is decryped via XORring with the hardcoded key\ninside of the binary. In different payloads that we could find, the key was “123456789”.\n\nFigure 4: check config data before decryption\n\n\n-----\n\n_Figure 5: hardcoded key for config decryption_\n\n\n-----\n\nFigure 6: config decryption routine\n\nInside the config, there is information about the folder name for PlugX modules, mutex\nname, C&C IP and domain address, and port number.\n\nWe found 17 unique pieces of config data. This is the information we extracted from them:\n\n**C&C domains**\n\nwww.apple-net.com\n\nwww.mmfhlele.com\n\nwww.olk4.com\n\nupdate.olk4.com\n\ninfosecvn.com\n\naridndvn.ccom\n\nwww.freesmadav.com\n\nupdate.freesmadav.com\n\nwww.lameers.com\n\n**C&C IP address**\n\n\n-----\n\n154.223.150.105\n43.251.182.114\n185.239.226.61\n167.88.180.132\n45.251.240.55\n\n**Folder Names**\n\nESET Malware ProtectionrYF\nESET Malware ProtectionWgM\nESET Malware ProtectionTCp\nESET Malware ProtectionOWT\nESET Malware Protectionmld\n```\nMicrosoft Malware ProtectionGCg\nMicrosoft Malware Protectionfpx\nMicrosoft Malware ProtectionwSA\nMicrosoft Malware ProtectionpiW\nMicrosoft Malware ProtectionSaG\nMicrosoft Malware ProtectionDQA\nMicrosoft Malware ProtectioncdB\nMicrosoft Malware ProtectionNSP\nMicrosoft Malware ProtectionGHQ\nAdobe Update HelpereQU\nAdobe Update HelperzGI\nAdobe Update HelperatX\n\n```\n**Mutex names**\n\nVVubPDixKeBURoQIIyfb\nypFRoazKbRHpMwnXoLtW\nXUzeONpJmKCaBUtvnRGB\nNNOFQoZIxAphdklhtaWw\nGRNtLeLPnuJGPsTxTilb\n\nInterestingly, we could also find the test sample that the malware author may have used to\ntest the malicious binary before releasing with the IP address 127.0.0.1 for C&C in the\nconfig data.\n\n\n-----\n\n### C&C Communication\n\nThe PlugX variant uses a new way to communicate to its C&C server but it also supports\nthe old communication mechanism. So, when it initializes the connection and gets the C&C\nversion, it can decide how to communicate.\n\nThe CNC commands in this PlugX variant are similar to other versions with some minor\ndifferences.\n\nIt has 2 different groups of commands: group IDs 0x1001 and 0x1002. Once it gets the\nC&C group ID, it decides how to respond to the commands.\n\nFor command group ID 0x1001:\n\n**Command** **Description**\n\n0x1001 get system information → memory status, computer name, username, OS\nversion, PlugX CLSID, cpu speed, cpu architecture, width and height of\nscreen\n\n0x1002 start pipe communication → CXOnline::OlStartProcPipe\n\n0x1003 echo input back\n\n0x1005 exit process\n\nFor command group ID 0x1002:\n\n**Command** **Description**\n\n0x3000 get disk information\n\n0x3001 find file\n\n0x3004 read file\n\n0x3007 write file\n\n0x300A create directory\n\n0x300B check if the file existed\n\n0x300C create process in hidden desktop\n\n0x300D file operation (rename, move, delete, copy)\n\n0x300E get expanded environment information\n\n0x300F get plugX directory\n\n\n-----\n\n0x7002 remote shell\n\n**Old communication mechanism**\n\nIt uses HTTP post request to start the communication. The URL it uses to send the request\nto the server is “/update?wd=<random 8 digit number>”\n\nIt uses this hardcoded user-agent:\n```\nMozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1;\n\n```\nIt adds these parameters to the HTTP request header\n```\nx-debug\nx-request\nx-content\nx-storage\n\n```\n**New communication mechanism**\n\nPlugX sends an encrypted random ID to initialize the connection via raw TCP and then\nreceives a response from server.\n\nThe first 16 bytes are the header:\n\nThe first 4 bytes are the encryption key.\nThe second 4 bytes are CNC command code (the 29th bit shows whether the data is\ncompressed and 30th bits shows whether the data is encrypted).\nThe next 2 bytes show the size of data (16 bytes header is not included).\nThe header is encrypted as well with the first DWORD sent by the server.\n\nFigure 7: structure of C&C communication header\n\nThe encryption algorithm used for communication is XOR but adds a hardcoded value to\nthe key for every round of encryption. The hardcoded value for the binaries that we found\nwas “6666”.\n\n\n-----\n\nFigure 8: decryption routine for communication data\n\n## Conclusion\n\nThe Mustang Panda APT actor uses PlugX with minor changes, in an attempt to evade\ndetection. This time, we found new features, new config structure, and loader—which\ncaught our attention.\n\nLoading the payload in multiple stages with different modules and encrypted data is a wellknown technique but still quite effective to bypass sandbox systems and file scanners.\n\nIt is always challenging to have all of those modules together in order to reach the final\npayload.\n\nBased on our telemetry, we found several victims from Hong Kong, Vietnam, Australia, and\nChina but most of the victims are from Hong Kong.\n\nLearn how Avira prevents [zero-day attacks, detect targeted malware and deliver the highest](https://oem.avira.com/en/technology/machine-learning)\ndetection rates in the cyber-security industry.\n\n\n-----\n\n## Indicators of Compromise\n\nc90cae0a4365cb31f171b051520f6c8053dd0c3e798c59b2ae418bf99ddad02c\n\n14f9278f3515fae71ccb8073cfaf73bdcc00eab3888d8cee6fb43a4f51c9e699\n\n6fc8c2e28dfa39b20154ecb3339eb784a025ea1a7c79e15e0930f679280bb63e\n\nf331eb3d7f6789e48f2e3bfb1a87595561722f45aaec150df537488587024096\n\nb9f3cf9d63d2e3ce1821f2e3eb5acd6e374ea801f9c212eebfa734bd649bec7a\n\n8be6c10e9e150d01601f77485444e409667ba905100982f57743e01d20a26121\n\n6b23a388ddb3b697004fdd37a0d393455ae5702040c2b694f9158112698c2ec1\n\n6924581b5fee4699a1ce0182cdf8462d5fcb5389985ec129d554dd6ca45d0c9f\n\nShahab Hamzeloofard\n\nShahab Hamzeloofard is a threat researcher and software engineer in Avira's Advanced\nThreat Research team. With a decade of experience in the cyber-security industry he\nenjoys implementing modules for hunting advanced malware and reverse engineering\nmalware binaries. He is passionate about CPU internals, hypervisor and reversing\ncomplex and obfuscated binaries. He loves playing CTF and researching about new\nexploitation techniques.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-31 - New wave of PlugX targets Hong Kong.pdf"
    ],
    "report_names": [
        "2020-01-31 - New wave of PlugX targets Hong Kong.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1691c25f-1aa4-4168-8ce2-7aa8f23246e7",
            "created_at": "2024-06-04T02:03:07.724221Z",
            "updated_at": "2025-03-27T02:05:17.284601Z",
            "deleted_at": null,
            "main_name": "BRONZE PRESIDENT",
            "aliases": [
                "Mustang Panda ",
                "Red Lich ",
                "Temp.Hex ",
                "HoneyMyte "
            ],
            "source_name": "Secureworks:BRONZE PRESIDENT",
            "tools": [
                " Cobalt Strike",
                " ORat",
                " PlugX",
                " RCSession",
                "China Chopper"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535873,
    "ts_updated_at": 1743041807,
    "ts_creation_date": 1653704787,
    "ts_modification_date": 1653704787,
    "files": {
        "pdf": "https://archive.orkl.eu/1b0658c0925f90e11906d4afe0fbd1d3fd72554f.pdf",
        "text": "https://archive.orkl.eu/1b0658c0925f90e11906d4afe0fbd1d3fd72554f.txt",
        "img": "https://archive.orkl.eu/1b0658c0925f90e11906d4afe0fbd1d3fd72554f.jpg"
    }
}