{
    "id": "96759a5d-2410-41e3-9504-d11d1f00a4ca",
    "created_at": "2023-01-12T15:03:47.218335Z",
    "updated_at": "2025-03-27T02:05:50.054186Z",
    "deleted_at": null,
    "sha1_hash": "8789d5fcfdaa5a065c9f968260b3ed4c0879a342",
    "title": "2018-05-04 - Botception with Necurs- Botnet distributes script with bot capabilities",
    "authors": "",
    "file_creation_date": "2022-05-28T19:52:33Z",
    "file_modification_date": "2022-05-28T19:52:33Z",
    "file_size": 169315,
    "plain_text": "# Botception with Necurs: Botnet distributes script with bot capabilities\n\n**[blog.avast.com/botception-with-necurs-botnet-distributes-script-with-bot-capabilities-avast-threat-labs](https://blog.avast.com/botception-with-necurs-botnet-distributes-script-with-bot-capabilities-avast-threat-labs)**\n\nVBScript allows threat actors to steal personal data and make victims vulnerable to\nkeyloggers, banking malware and ransomware\n\nOver the past few days, we have been analyzing a development with the Necurs botnet - a\ncybercrime operation dating back to 2012 that quickly became one of the largest spam\nbotnets in the world. We reported on the infamous cybergang responsible for the distribution\n[of global malware campaigns such as “Locky” and “GlobeImposter” in two blog posts (here](https://blog.avast.com/a-closer-look-at-the-locky-ransomware)\n[and here) that explained how malware is spread via Necurs. And now we have seen a new](https://blog.avast.com/lockys-javascript-downloader)\nlink to that chain with attackers serving brand new files via the same botnet. These files are\nspreading malicious Visual Basic Scripts (VBScripts) and our analysis suggests that the\nauthors are using the services provided by the Necurs botnet to reach more victims. The\nultimate goal of the attackers is to make systems vulnerable to attacks with the ability to steal\npersonal data and to infect them with keyloggers, banking malware, and ransomware.\n\nAn examination of the source code suggests that the VBScripts are hosting a severe form of\nmalware known as Agony Rootkit used to infect the Master Boot Record (MBR) of\ncomputers. This can be particularly destructive. By infecting the MBR, the malware is able to\nexecute before systems boot-up allowing it to bypass security software. It then inserts a\nbackdoor into the operating system which gives the attacker full control of the machine. With\nthese administrative rights, the attacker can install worms, keyloggers and other malicious\nfiles. They can also access stored data including personal or financial information, putting\nusers at risk.\n\n## A deeper look inside the VBScripts distributed by Necurs\n\nBelow are examples of live VBScripts in action. At first glance, it appears to include random\nnumerical combinations that could be discarded as junk, possibly added to alter the code\nstructure in order to evade detection. However, we spent some time investigating the code\nvia the decryption function and spotted some logic behind its construction.\n\nThe scripts themselves are around 72KB and are similar in composition except for some\nsmall changes in the obfuscation methods.\n\n\n-----\n\nA closer look at the code reveals some important information. We noticed that the function\nuses ReadLine\n\non the file itself to decrypt the control panel (below):\n\nThe script is really easy to deobfuscate; the only issue is comment removal — which is often\npresent in analytical tools — that can mislead the analysts.\n\nAfter decrypting these comments, in version one, we spotted a nice piece of code which\ncould be used as a modeling example “How to write the control panel for your malware in\nVBS”. The next version is less self explanatory and readable.\n\nIt's probable that the authors of VBScripts connected with the authors of the Necurs botnet\nbecause of its scale and potential for ubiquitous email scams. The scripts appear to work as\na downloader and control panel for the Agony rootkit, however changing the payload is\nparticularly easy. This could open the door to more severe malware infections for victims in\nthe future, such as ransomware or banking Trojans.\n\n## The malware control panel includes unusually beautiful code\n\nThe code itself contains very well-named variables and also debugging output to a log file.\nHowever, debugging is switched off by default as the variable isDebug is set to false. The\ndebugging output informs about every important subroutine and contains strings such as:\n\n_\"Preparing done!\" (initialization and installation phase finished)_\n\n_\"Oh, its main cycle! CMD response\" & cmd (after receiving a new command)_\n\n_\"F***! Panel maybe die! I will try to change it...\" (new command has less than 4 characters)_\n\n_\"Unistall [sic] command gotted!\" (uninstall command received)_\n\n_\"Oh, its ddos command!\" (ddos command received)_\n\n_“ddos finished! Sended \"&cnt&\" requests!\" (ddos command finished)_\n\n\n-----\n\nInterestingly, this makes this code unusually beautiful as one rarely stumbles upon a\nrelatively well-structured and “commented” piece of code with self-documenting names,\nparticularly when the subject is malware.\n\nAs well, the code reveals some important information about its creator. The author appears\nto have a problem with the past tense of irregular verbs such as to get or to send. In addition,\nseveral log entries use incorrect English language sentence construction, such as \"Panel\nmaybe die!\". It could suggest that the author’s first language is not English, however this\nmay well be staged.\n\nThe script initializes its variables such as Command and Control (C&C) addresses, various\npaths and several objects that are used to interface system functions. Then, the script tries to\ninstall itself to the folder %APPDATA% under the names <HWID>.vbs, g_<HWID>.vbs_w.vbs\n_(HWID being a random sequence of letters loaded from registry or generated at startup), and_\npossibly <static_number_sequence>_log.txt and relaunch itself from the %APPDATA%\ndirectory. After the initial installation, it checks whether another instance of the script is\nrunning. Persistence is key, so if only one instance is running, a task named ChromeUpdate\nis created to launch the first file on user log on. Also, multiple registry entries that launch the\nscript at startup are created. Otherwise, the script quits.\n\nOnce the script gets over the initialization, it has to ask the C&C servers for commands and\nprocess them. That is where a traditional event loop comes in. Verification that the script is\nlocated in the %APPDATA% directory has to be passed first, otherwise agony is invoked six\ntimes before proceeding to the next iteration. Let us assume that this test has passed. Now\n[the script sends a POST request with a rather long GET data string, e.g.:](https://en.wikipedia.org/wiki/POST_(HTTP))\n\n_os=Windows 10 Enterprise&user=Evzen@DEMO-PC&av=Avast AntivirusWindows_\n_Defender&7045Mb # Intel(R) Core(TM)CPU E5-2690 v4 @ 2.60GHz # Standard VGA_\n_Graphics Adapter&hwid=AABBccddEEFFGGhhiiJJKKLLm&x=64_\n\nThe only fields that require some discussion are _fw_ and _hwid_. \"fw\" describes the\nhardware (specifically RAM size # CPU info # GPU info), while \"hwid\" is a 25-character long\nrandom string generated at first launch and saved into the registry at\n_HKEY_CURRENT_USER\\Software\\ARRSSS._\n\nThe response contains a command. These commands have a very similar structure and\nevery command triggers a confirmation that is sent again as a POST request to the same\naddress as a command request, however the data string differs:\n\n_ok=<zid>&hwid=<hwid> in case of success_\n\n_error=<zid>&hwid=<hwid> in case of an error_\n\nThe value <zid> is given by the command string. All available commands are listed below:\n\n\n-----\n\nCommand Command\nstring\n\ndownload download!\n<url>!<zid>\n\nupdate update!<url>!\n<zid>\n\nplugin plugin!<url>!\n<zid>\n\nuninstall uninstall!\n<data>!<zid>\n\nddos ddos!<url>!\n<count>\n\n\nAction\n\nDownload a file from <url> and execute it.\n\nDownload a PE file from <url>, save it to %TEMP% and\nexecute it.\n\nDownload a dll from <url>, save it to %TEMP% use\nRUNDLL32.exe to execute it.\n\nReplace dropped files and a log by a file with one\nwhitespace.\n\nSend <count> POST requests to <url>.\n\n\nThe denial-of-service (DDoS) attack that can be caused with the above command initiated by\nthis script also carries some data. It seems that these attacks can be identified by the\nassociated data, as all the scripts collected so far have the POST data hard-coded:\n\n_ufgiweugdiqwfgqofwg=325872346782356786426526349865923659_\n\nNow the script also ends up in several invocations of agony. The agony function serves three\npurposes. It checks whether the script is running in the installation directory. The result only\naffects which copy of the scripts is launched if no instance of %APPDATA%\\<HWID>.vbs or\n_g_%APPDATA%\\<HWID>.vbs_w.vbs is running, and the log entry suggests that this is_\nintended as a self-defense. Moreover, if the script is not named <HWID>.vbs and located in\n_%APPDATA%, it overwrites its two files by <static_number_sequence>_log.txt and adds_\nitself to startup through registry entries:\n\n_HKEY_CURRENT_USER\\software\\microsoft\\windows\\currentversion\\run\\_\n_HKEY_LOCAL_MACHINE\\software\\microsoft\\windows\\currentversion\\run\\_\n_HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\_\n_HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell_\n\nEvery agony ends up with 500 milliseconds of a blissful Sleep, a function suspending the\ncode execution for a given time.\n\n## Version progression\n\n\n-----\n\nA new version, discovered approximately a day after the described script s release, brought\nseveral updates. In the new version, the payload is hidden beyond another .vbs file that acts\nas a downloader for the following stage. Moreover, its functions seem to have been\nrefactored as e.g. the agony function is now removed in favour of a simple Sleep and the\ndetection of an antivirus installed on the system is now hidden in a function called func15.\nAlso, the script installs itself only to %APPDATA%/<HWID>.vbs, which simplifies checking for\nrunning instances, which means that only one function is necessary for checking.\n\nThe command structure is simplified to only include the functions download, update, and\n_uninstall. The command update now expects a Visual Basic script, while update expects a_\nPortable Executable (PE) file.\n\nThe last significant addition is a new function called psCommand that, as expected, executes\na command in PowerShell. Currently, this is only used in the initialization.\n\nVBS decryptor:\n**0089A6E7E92B75952F5C2E3A04A7AB65133F4CCA732BC96ECB0A34389D8FC7F4 (v1)**\n\n**Dae17df6225f05e99bf0e84b3a8438560befc7eb6bd07a7b4d4e451ec33b6a5f (v2)**\n\nVBS control panel:\n\n**3011126B5210298D843D6D3B84143BE292633A4A7C0D14E947AE6BE11B74CE2F (v1)**\n\n**676abca2210742e57b432558276b616b1e4e5286c772aed8c63efed230ff2430 (v2)**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-05-04 - Botception with Necurs- Botnet distributes script with bot capabilities.pdf"
    ],
    "report_names": [
        "2018-05-04 - Botception with Necurs- Botnet distributes script with bot capabilities.pdf"
    ],
    "threat_actors": [
        {
            "id": "d303c77e-0110-471b-a3a6-37fce9ac848d",
            "created_at": "2022-10-25T15:50:23.342452Z",
            "updated_at": "2025-03-27T02:00:55.447692Z",
            "deleted_at": null,
            "main_name": "Machete",
            "aliases": [
                "APT-C-43",
                "El Machete"
            ],
            "source_name": "MITRE:Machete",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535827,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1653767553,
    "ts_modification_date": 1653767553,
    "files": {
        "pdf": "https://archive.orkl.eu/8789d5fcfdaa5a065c9f968260b3ed4c0879a342.pdf",
        "text": "https://archive.orkl.eu/8789d5fcfdaa5a065c9f968260b3ed4c0879a342.txt",
        "img": "https://archive.orkl.eu/8789d5fcfdaa5a065c9f968260b3ed4c0879a342.jpg"
    }
}