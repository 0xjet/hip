{
    "id": "a2c40bea-4aa4-4c0a-9389-64025f594daf",
    "created_at": "2023-01-12T15:04:03.354856Z",
    "updated_at": "2025-03-27T02:06:05.979912Z",
    "deleted_at": null,
    "sha1_hash": "8abd51958e6dad1f38a71419e4f8df51954a89c8",
    "title": "2020-09-14 - Analysis of a Convoluted Attack Chain Involving Ngrok",
    "authors": "",
    "file_creation_date": "2022-05-27T21:47:38Z",
    "file_modification_date": "2022-05-27T21:47:38Z",
    "file_size": 539289,
    "plain_text": "# Analysis of a Convoluted Attack Chain Involving Ngrok\n\n**[trendmicro.com/en_us/research/20/i/analysis-of-a-convoluted-attack-chain-involving-ngrok.html](https://www.trendmicro.com/en_us/research/20/i/analysis-of-a-convoluted-attack-chain-involving-ngrok.html)**\n\nSeptember 14, 2020\n\nMalware\n\nThe Trend Micro ™ Managed XDR team recently handled an incident involving one of Trend\nMicro’s customers. The incident revealed how a malicious actor incorporated certain\ntechniques into an attack, making it more difficult for blue teams and security researchers\nalike to analyze the chain of events in a clean and easily understandable manner.\n\nBy: Aprilyn Borja, Abraham Camba, Khristoffer Jocson, Ryan Maglaque, Gilbert Sison, Jay\nYaneza September 14, 2020 Read time: ( words)\n\nOne of the primary benefits of an [Endpoint Detection and Response (EDR) security solution](https://www.trendmicro.com/en_us/business/products/detection-response/edr-endpoint-sensor.html)\nis that it gives blue teams (security personnel responsible for maintaining and analyzing an\norganization’s network defenses) the visibility required to detect an attack in its early stages\nand visualize an incident as it is happening. While these kinds of security technology\ninnovations benefit the cybersecurity industry as a whole, it is often matched by a\ncorresponding evolution in the tools and techniques that malicious actors use as a response.\n\n\n-----\n\nThe [Trend Micro ™ Managed XDR team recently handled an incident involving one of Trend](https://www.trendmicro.com/en_us/business/products/detection-response/managed-xdr-mdr.html)\nMicro’s customers. The incident revealed how a malicious actor incorporated certain\ntechniques into an attack, making it more difficult for blue teams and security researchers\nalike to analyze the chain of events in a clean and easily understandable manner.\n\n## Initial Investigation\n\nIn July 2020, we noticed the following suspicious event in our customer’s environment via the\n[Trend Micro Apex One ™ Endpoint Security Solution:](https://www.trendmicro.com/en_us/business/technologies/control-manager.html)\n\nProcess: c:\\windows\\system32\\reg.exe CommandLine: REG ADD\nHKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run /v <value> /t REG_SZ /d\n\"\\\"c:\\Windows\\system32\\<random name>\\\"\" /f\n\nA few points to note: first, the value name of the registry being created was patterned after a\ncertain security vendor. Second, there was a mistake (or maybe intentional) in the spelling of\nthe registry name (as seen in the <value> portion, which we did not include for privacy\nreasons). Finally, there is the randomly named executable in the system directory. When\nconsidering all of these together, the alert presented us with obvious red flags.\n\nThe executable file turned out to be a keylogger that sends the mouse and key clicks it sniffs\nto a Gmail account. We found hardcoded information in the binary, providing evidence that it\nwas created specifically for the targeted organization. Furthermore, we also learned from the\nbinary that the attackers had existing knowledge about the organization.\n\nWe searched records and events using the keylogger’s file name and hash and found the\nfollowing:\n\n## File Events\n\nBased on the created analysis chains, the keylogger is dropped by the ntoskrnl.exe process.\nThis tells us that the file was dropped either via network share or through the use of an\nexploit affecting the kernel.\n\n\n-----\n\nFigure 1. The keylogger is dropped by Ntoskrnl.exe\n\n## Events With Command-Line Parameters\n\nWhile it was not surprising to find reg.exe process events containing the identified random\nfile name (given that it triggered the investigation), the chain of processes that preceded\nreg.exe was more difficult to predict.\n\nFigure 2. The chain of events leading up to the reg.exe process\nInstead of the keylogger calling reg.exe to generate its persistence mechanism, another\nprocess — services.exe — seems to be the root of the chain. This means the attacker\nmanaged to create a service that would launch a series of cmd.exe processes to build the\npersistence mechanism using reg.exe.\n\n## Registry Data\n\n\n-----\n\nDuring our investigation, we found service registry entries containing the command line\nparameter passed to reg.exe:\n\nReg Key: hklm\\system\\currentcontrolset\\services\\<random>\nReg Value: imagepath\nReg Data: %COMSPEC% /C echo REG ADD\nHKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run /v <value> /t REG_SZ /d\n\"\\\"c:\\Windows\\system32\\<random>\\\"\" /f ^> %SYSTEMDRIVE%\\WINDOWS\\Temp\\\n<random>.txt >\n\\WINDOWS\\Temp\\<random>.bat & %COMSPEC% /C start %COMSPEC% /C\n\\WINDOWS\\Temp\\<random>.bat\n\nThis registry entry explains the multiple cmd.exe processes in the chain leading to the\nreg.exe shown above. The command line of the first cmd.exe will contain the string after\n%COMSPEC%, while the second will contain the string after the second %COMSPEC%,\nand so on, in sequential order.\n\n## Digging Deeper\n\nThe act of creating a service to launch a command was uitlized for implementing the shell\nportion of a backdoor shell. Using the string %COMSPEC%, we searched and examined\nother service registry entries, eventually discovering multiple tools and commands that were\nexecuted using this method.\n\nWe observed commands that were derived from service registry entries like “query user”,\n“net user <user account> /domain”, “ping <ip address>”, etc. on multiple machines. If a new\nbackdoor shell was indeed implemented, it meant that we still needed to find the component\nthat communicates with the outside world, as well as the part that creates the service entries.\n\nWe got our first break when we found the command “<random> tcp --authtoken <token> config <config file> <ip>:445”. Based on the parameters alone, this particular tool looked like\nit had something to do with network communication, utilizing a common port (SMB/TCP 445)\nthat is widely used within a corporate environment.\n\nAfter collecting the file, we determined that the tool is a copy of ngrok, a software program\nthat allows an internal machine to be visible to the outside world by routing the traffic through\nthe ngrok website. The existence of the tool on two machines meant that those machines\nwere externally visible. We have [previously written how ngrok](https://blog.trendmicro.com/trendlabs-security-intelligence/exposed-docker-control-api-and-community-image-abused-to-deliver-cryptocurrency-mining-malware/) [can be used for malicious](https://www.trendmicro.com/vinfo/tmr/?/us/security/news/cybercrime-and-digital-threats/lord-exploit-kit-rises-delivers-njrat-and-eris-ransomware)\npurposes.\n\nHow the service entries are created is still a mystery at this point. We searched instances of\npsexesvc.exe (the server part of PsExec) and remotesvc.exe, but the result of indicator of\ncompromise (IOC) sweeping was inconclusive. However, we did discover the string\n“admin/smb/psexec_command” in one of the service entries, which resembles the command\n\n\n-----\n\nexecution of Metasploit. What we know is that Metasploit s PsExec module does not drop a\nbinary on the target machine. Further research shows that some versions of Mimikatz and\nImpacket do possess such a feature.\n\n## Simulating the Attack\n\nTo try to figure out the attack’s mechanics, we performed a simple simulation by installing\nngrok on one of the machines (Machine A) that was neither visible nor accessible externally.\n\nFigure 3. Installing ngrok on Machine A\nNgrok can expose to the internet any open IP port within the internal network that is\naccessible to Machine A (including itself). In our example, ngrok exposed another machine\n(Machine B) 192.168.19.129:445 through the ngrok server. We were then able to access\n192.168.19.129:445 via 2.tcp.ngrok.io:14139.\n\nBy using the service Smbexec module of the Impacket tool kit and the credentials of Machine\nB, we were able to send simple ping commands to Machine B from an external machine.\n\n\n-----\n\nFigure 4. Using an external machine to send ping commands to Machine B\nThe resulting behavior was similar to what we observed in the customer’s environment,\nwhere randomly named service entries were created and then deleted. The commands were\nexecuted without needing to drop a binary on the target machine.\n\nFurthermore, since the commands were executed as a service, it runs with elevated\nprivileges. Given that network traffic was tunneled via the ngrok service, the command and\ncontrol server was effectively hidden. As long as the attacker knows the ngrok-assigned\npublic address, it can connect to the compromised endpoint from anywhere, at any time.\n\nFigure 5. Connecting to a compromised machine using the ngrok-assigned public address\nWhile we did not expect the simulation to recreate the actions of the attacker completely, it\nprovided valuable context on how the attack possibly happened.\n\nIn the case of the simulation, it required ngrok installed on the internal machine, the ngrok\nserver domain and port, and an administrator account. We believe that the attacker\npossessed all three, given that they were the ones who installed ngrok on the machine, and\n\n\n-----\n\nthey seemed to have been present long enough to know certain details about the\nenvironment. They were also able to compromise a high-privilege account. Based on this,\nthe simulation we conducted fits the attack characteristics.\n\n## Fighting Back With EDR\n\nThe diagram in Figure 6 shows a typical backdoor shell root cause analysis chain.\n\nFigure 6. Root cause analysis chain of a typical backdoor shell\nShell.exe launches cmd.exe, which then launches the tool to execute the given command. It\ncould also be shown launching tools it has installed — such as Toola.exe — in the diagram.\nThis kind of diagram is straightforward, making it easy to identify suspicious objects and\ndetermine the basic flow of how things work in an attack.\n\nIn this incident, the root cause analysis begins with services.exe and ends with the executed\ntool or command. There was no evidence that a multi-stage tool that drops other tools were\never used, and based on the access the attackers had in this model, it is highly probable\nthey had no use for such a tool. The machines were so accessible that the attackers could\nrun any tool they needed without having to think of clever mechanisms to install the binary\n(such as moving it laterally from one machine to another) — in other words, tools can be run\n\n\n-----\n\nvirtually on demand. Take, for instance, the installation of the keylogger; the attackers\ndropped the keylogger file via server message block (SMB) and issued a separate command\nto create its persistence mechanism. They did not use a keylogger that creates its own\npersistence mechanism, likely because it is not difficult for them to create the registry entry\nfor persistence remotely.\n\nMeaningful root cause analysis chains are difficult to come by because everything starts with\nservices.exe (or another windows process in cases of file dropping, for instance) running one\ncommand/tool at a time. The resulting chain can look more like a “tree” with services.exe at\nthe center, where each branch represents a command executed through services.exe.\n\nOur analysis shows that the technique used in the attack hinders the ability of security\nresearchers to piece together the sequence of events via a short diagram. However, certain\nfeatures of EDR are designed to handle incidents like this.\n\n## Mitigation Through Suspicious Events\n\nSuspicious events are effective triggers of an EDR solution, and the capability to mitigate\nthrough the same solution is ideal for blue teams. In this incident, Trend Micro Managed XDR\nutilized the Apex One capabilities to both investigate and mitigate the threat in the same\nsoftware suite.\n\n## Investigation Through Logged Events\n\nConventional incident response methodology would often require running a tool to acquire\nevidence from a suspect host. In this investigation, everything was done through the\nexamination of EDR logged events. No memory or disk image acquisition was done for the\ninvestigation, which means that the data collected by EDR was enough to determine how\nsimilar attacks work. The chronological order of the commands were taken from the time\nstamps of the events. Even without the self-explanatory diagram EDR creates, it is still\npossible to determine how the attack took place.\n\n## New Alerts\n\nEDR allows for the painless creation of alerts to trigger an investigation. In this case, new\nalerts can be created whenever services.exe launches cmd.exe and when %comspec% is\nwritten to an autostart registry entry, which can help future threat hunting capabilities for blue\nteams.\n\n## Trend Micro Solutions\n\nThe [Trend Micro XDR solution protects connected emails, endpoints, servers, cloud](https://www.trendmicro.com/en_us/business/products/detection-response.html)\nworkloads, and networks by using powerful AI and security analytics to correlate data and\nprovide an optimized set of alerts via a single console. With this technology, organizations\n\n\n-----\n\ncan quickly identify threats and remediate their impact in a timely manner.\n\n[Trend Micro Managed XDR offers expert threat monitoring, correlation, and analysis from](https://www.trendmicro.com/en_us/business/products/detection-response/managed-xdr-mdr.html)\nexperienced cybersecurity industry veterans, providing 24/7 service that allows organizations\nto have one single source of detection, analysis, and response. This service is enhanced by\nsolutions that combine AI and Trend Micro’s wealth of global threat intelligence.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-09-14 - Analysis of a Convoluted Attack Chain Involving Ngrok.pdf"
    ],
    "report_names": [
        "2020-09-14 - Analysis of a Convoluted Attack Chain Involving Ngrok.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535843,
    "ts_updated_at": 1743041165,
    "ts_creation_date": 1653688058,
    "ts_modification_date": 1653688058,
    "files": {
        "pdf": "https://archive.orkl.eu/8abd51958e6dad1f38a71419e4f8df51954a89c8.pdf",
        "text": "https://archive.orkl.eu/8abd51958e6dad1f38a71419e4f8df51954a89c8.txt",
        "img": "https://archive.orkl.eu/8abd51958e6dad1f38a71419e4f8df51954a89c8.jpg"
    }
}