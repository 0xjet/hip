{
    "id": "86828c64-8b0b-4bb0-8943-4ce8348d3360",
    "created_at": "2023-01-12T15:04:47.599611Z",
    "updated_at": "2025-03-27T02:11:47.735484Z",
    "deleted_at": null,
    "sha1_hash": "ae6e73a280bceaa981c03a88ea77c877c3274256",
    "title": "2017-05-18 - UIWIX – Evasive Ransomware Exploiting ETERNALBLUE",
    "authors": "",
    "file_creation_date": "2022-05-27T21:36:22Z",
    "file_modification_date": "2022-05-27T21:36:22Z",
    "file_size": 1256025,
    "plain_text": "# UIWIX – Evasive Ransomware Exploiting ETERNALBLUE\n\n**[minerva-labs.com/post/uiwix-evasive-ransomware-exploiting-eternalblue](https://www.minerva-labs.com/post/uiwix-evasive-ransomware-exploiting-eternalblue)**\n\n[Tweet](https://twitter.com/share)\n\nLast week everybody talked about the WannaCry ransomware, a non-evasive ransomware\nwhich exploited vulnerable servers to propagate, successfully infecting anything from digital\nbillboards to the Russian interior ministry. Here at Minerva we took part in the global effort\nagainst evil, releasing a [free vaccination tool, explaining](http://www.minerva-labs.com/post/immune-yourself-from-wannacry-ransomware-with-minervas-free-vaccinator) how you may vaccinate in\nenterprise-scale\n\n\n-----\n\nWannaCry drew attention to other threats exploiting the very same SMB vulnerability (MS17-010) using the Shadow Brokers’ ETERNALBLUE-DOUBLEPULSAR combination. Unlike\nWannaCry, there have been no reports on the number of machines infected by the UIWIX\nransomware, neither about the “revenues” generated. We assume that it is a direct result of a\nsingle major difference between WannaCry and the UIWIX ransomware family used in these\nthreats. WannaCry did not try to evade detection and some researchers reported that their\nhoneypots were infected only three minutes after they were deployed.\n\n[Tweet about honeypots infected within 3 minutes](https://twitter.com/benkow_/status/863458632175898624)\n\nUIWIX however employed basic evasion techniques to stay under the radar:\n\n\n-----\n\n[Tweet about the difficulty in obtaining a UIWIX sample](https://twitter.com/campuscodi/status/863875168439021569)\n\nIn this blog post, we describe how the UIWIX ransomware bypasses existing security\ndefenses to target endpoints.\n\n## A Step-By-Step Analysis of How UIWIX Evades Detection\n\nUIWIX did not invent any new technique, they relied on simple known techniques – starting\nwith a direct test for the presence of a debugger:\n\nElementary test for the presence of a debugger\n\n\n-----\n\nLater moving to detect different sandbox solutions, UIWIX checks the loaded modules\nagainst a black list a list of DLLs (see full list below):\n\nUIWIX tests if a DLL related to COMODO's sandbox is loaded\n\nAfterwards, the ransomware tests if a Cuckoo sandbox pipe is present:\n\nThe malware tests if the Cuckoo pipe is present\n\nIronically, the test for the Cuckoo pipe triggers both a signature and returns false even when\nexecuted in a Cuckoo sandbox:\n\nAlthough executed in a Cuckoo, the test returns false\n\nNow, UIWIX tests yet another list of DLLs, this time they are VM related:\n\nSample tests if in a virtual environment\n\n## Tracking the Evasion Techniques’ Source Code\n\n\n-----\n\nFrom our analysis, it is quite clear that the coders of this ransomware relied on existing lists\nof artifacts to create the above “DetectSandbox()” and “DetectVM()” functions.\n\nWe found some candidates for the source of the evasion techniques. In the image below, a\nsnippet of code looks for sandbox solutions by the loaded DLLs:\n\nAnd [in this source shows another list collected for the very same purpose:](https://github.com/LordNoteworthy/al-khaser/blob/9507fdd7927efb2b3ef766f95f63fb0320d7a01d/al-khaser/Anti%20VM/Generic.cpp)\n\nIt appears that those two lists were appended together in UIWIX (with dbghelp.dll and\nvmcheck.dll tested in a different function):\n\n\n-----\n\nAnother interesting similarity is in the malware code section which tests for VM pipes:\n\nAnd this is how they appear in a Russian hacking forum called “FuckAV”:\n\nNote how the order of the artifacts is an exact match to the malware!\n\nThis list can also be found in [legitimate websites:](https://reverseengineering.stackexchange.com/questions/1686/how-to-detect-a-virtualized-environment/14838)\n\n## Why Minerva Aces Against UIWIX\n\n\n-----\n\n[Minerva Anti-Evasion Platform creates a virtual reality that fools the malware, making it](https://minerva-labs.com/approach)\nbelieve that it is in a hostile environment. Clever environmentally aware malware like UIWIX\nwill avoid execution in a Minerva-protected endpoint as we make the malware believe it is in\na VM or sandbox.\n\nUIWIX is exploiting unpatched machines to execute its DLL without writing itself to the disk.\nLuckily, Minerva works against any type of evasive threat, including file-less attacks like this\none.\n\n## IoC\n\n**Hashes**\n\n3860c2526fc8acf5366573cdeb0a292036398d3ee9e7d9764a60ec5d0812582a\n\n146581f0b3fbe00026ee3ebe68797b0e57f39d1d8aecc99fdc3290e9cfadc4fc\n\n**Searched VM related DLLs**\n\nSbieDll.dll\n\napi_log.dll\n\ndir_watch.dll\n\npstorec.dll\n\nwpespy.dll\n\ncmdvrt32.dll\n\nSxIn.dll\n\nsnxhk.dll\n\n**Searched Sandbox related DLLs**\n\ndbghelp.dll\n\nvmcheck.dll\n\nVBoxHook.dll\n\nVBoxMRXNP.dll\n\n**Searched Sandbox Pipes**\n\n\\\\.\\pipe\\cuckoo\n\n\n-----\n\n**Searched VM Pipes**\n\n\\\\.\\VBoxMiniRdrDN\n\n\\\\.\\VBoxGuest\n\n\\\\.\\pipe\\VBoxMiniRdDN\n\n\\\\.\\VBoxTrayIPC\n\n\\\\.\\pipe\\VBoxTrayIPC\n\n\\\\.\\HGFS\n\n\\\\.\\vmci\n\n**URLs**\n\n(as published by Lawrence Abrams in [BleepingComputer)](https://www.bleepingcomputer.com/news/security/uiwix-ransomware-using-eternalblue-smb-exploit-to-infect-victims/)\n\nhxxps://4ujngbdqqm6t2c53[.]onion[.]to\n\nhxxps://4ujngbdqqm6t2c53[.]onion[.]cab\n\nhxxps://4ujngbdqqm6t2c53[.]onion[.]nu\n\nhxxps://4ujngbdqqm6t2c53[.]onion[.]to\n\nhxxps://4ujngbdqqm6t2c53[.]onion[.]cab\n\nhxxp://4ujngbdqqm6t2c53[.]onion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-05-18 - UIWIX – Evasive Ransomware Exploiting ETERNALBLUE.pdf"
    ],
    "report_names": [
        "2017-05-18 - UIWIX – Evasive Ransomware Exploiting ETERNALBLUE.pdf"
    ],
    "threat_actors": [
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "bfded1cf-be73-44f9-a391-0751c9996f9a",
            "created_at": "2022-10-25T15:50:23.337107Z",
            "updated_at": "2025-03-27T02:00:55.445946Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "FIN7",
                "GOLD NIAGARA",
                "ITG14",
                "Carbon Spider",
                "ELBRUS",
                "Sangria Tempest"
            ],
            "source_name": "MITRE:FIN7",
            "tools": [
                "Mimikatz",
                "AdFind",
                "JSS Loader",
                "HALFBAKED",
                "REvil",
                "PowerSploit",
                "CrackMapExec",
                "Carbanak",
                "Pillowmint",
                "Cobalt Strike",
                "POWERSOURCE",
                "RDFSNIFFER",
                "SQLRat",
                "Lizar",
                "TEXTMATE",
                "BOOSTWRITE"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "bb8702c5-52ac-4359-8409-998a7cc3eeaf",
            "created_at": "2023-01-06T13:46:38.405479Z",
            "updated_at": "2025-03-27T02:00:02.82533Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "JokerStash",
                "ATK32",
                "G0046",
                "Coreid",
                "Carbanak",
                "Sangria Tempest",
                "CARBON SPIDER",
                "GOLD NIAGARA",
                "G0008",
                "ELBRUS",
                "Carbon Spider"
            ],
            "source_name": "MISPGALAXY:FIN7",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d85adfe3-e1c3-40b0-b8bb-d1bacadc4d82",
            "created_at": "2022-10-25T16:07:23.619566Z",
            "updated_at": "2025-03-27T02:02:09.890982Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "APT-C-11",
                "ATK 32",
                "Gold Niagara",
                "ITG14",
                "TAG-CR1"
            ],
            "source_name": "ETDA:FIN7",
            "tools": [
                "7Logger",
                "Agentemis",
                "Anunak",
                "Astra",
                "BIOLOAD",
                "BIRDWATCH",
                "Bateleur",
                "Boostwrite",
                "CROWVIEW",
                "Carbanak",
                "Cobalt Strike",
                "CobaltStrike",
                "DICELOADER",
                "DNSMessenger",
                "FOWLGAZE",
                "HALFBAKED",
                "JSSLoader",
                "KillACK",
                "LOADOUT",
                "Lizar",
                "Meterpreter",
                "Mimikatz",
                "POWERPLANT",
                "POWERSOURCE",
                "RDFSNIFFER",
                "SQLRAT",
                "Sekur",
                "Sekur RAT",
                "TEXTMATE",
                "Tirion",
                "VB Flash",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535887,
    "ts_updated_at": 1743041507,
    "ts_creation_date": 1653687382,
    "ts_modification_date": 1653687382,
    "files": {
        "pdf": "https://archive.orkl.eu/ae6e73a280bceaa981c03a88ea77c877c3274256.pdf",
        "text": "https://archive.orkl.eu/ae6e73a280bceaa981c03a88ea77c877c3274256.txt",
        "img": "https://archive.orkl.eu/ae6e73a280bceaa981c03a88ea77c877c3274256.jpg"
    }
}