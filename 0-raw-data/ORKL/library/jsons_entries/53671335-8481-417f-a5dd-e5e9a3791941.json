{
    "id": "53671335-8481-417f-a5dd-e5e9a3791941",
    "created_at": "2023-01-12T15:04:59.270493Z",
    "updated_at": "2025-03-27T02:09:18.65242Z",
    "deleted_at": null,
    "sha1_hash": "2a8bd3e9cdd657bfb6c3c74e6f2723cd1a359df7",
    "title": "2022-05-27 - Emotet Analysis- New LNKs in the Infection Chain – The Monitor, Issue 20",
    "authors": "",
    "file_creation_date": "2022-06-01T12:26:28Z",
    "file_modification_date": "2022-06-01T12:26:28Z",
    "file_size": 2947976,
    "plain_text": "# Emotet Analysis: New LNKs in the Infection Chain – The Monitor, Issue 20\n\n**[kroll.com/en/insights/publications/cyber/monitor/emotet-analysis-new-lnk-in-the-infection-chain](https://www.kroll.com/en/insights/publications/cyber/monitor/emotet-analysis-new-lnk-in-the-infection-chain)**\n\nSend Message Send Message\nThank you\n\nOne of our experts will contact you shortly.\n\nSorry, something went wrong :( Please try again later!\n\nPlease try again later!\n\n**About you**\n\n**Contact details**\n\nI would like to receive periodic news, reports, and invitations from Kroll, a Duff & Phelps.\nchevron Path 2\n\n\n-----\n\n**The Monitor**\n\nFri, May 27, 2022\n\nCole Manaster\n\n\n-----\n\nGeorge Glass\n\n\n-----\n\nElio Biasiotto\n\nKroll has been tracking Emotet since it was first identified in 2014, especially during its\ntransition from a banking Trojan designed to primarily steal credentials and sensitive\ninformation to a [multi-threat polymorphic downloader for more destructive malware. Today,](https://www.kroll.com/en/insights/publications/cyber/malware-analysis-emotet-resurgence-evolution)\n[Emotet operators stand as one of the most prominent initial access brokers, providing](https://www.cybereason.com/blog/how-do-initial-access-brokers-enable-ransomware-attacks)\n[cybercriminals with access to organizations for a fee. For example, the partnership between](https://intel471.com/blog/conti-emotet-ransomware-conti-leaks)\nthe Emotet group and Conti ransomware operators is well known in the cybersecurity\ncommunity.\n\nKroll frequently encounters Emotet in our incident response work and monitors Emotet\nactivity closely in order to maintain robust detection and mitigation guidance for clients. In\nrecent weeks, Kroll has observed three significant changes in the way that Emotet is\ndelivered, architected and operated once an initial infection is successful:\n\nEmotet binary switched from 32-bit to 64-bit architecture\nEmotet developers experimenting with new delivery method using .LNK files\nEmotet dropping Cobalt Strike beacons immediately after infection\n\n\n-----\n\nKroll is pleased to share the research we have conducted with the greater information\nsecurity community. Our goal is to encourage further investigation that can better equip\nsecurity professionals in preventing, detecting, mitigating and responding to cyberattacks.\n\nEmotet Malware Analysis\n\nEmotet operates as a botnet, with each infected device able to coordinate new malspam\ncampaigns to continue the spread of the malware to more victims in different organizations.\nKroll observed that as of April 22, 2022, the Emotet operators deployed a change to one of\ntheir most active botnet subgroups (tracked as Epoch4), affecting the delivery mechanism of\nthe loader part of the malware.\n\nHistorically, Emotet is commonly introduced into a network through a malicious document\n(maldoc), such as a Word or Excel file, that contains a malicious payload within it. Recently,\nKroll has observed a shift in Emotet’s method of distribution. The malware now leverages\nemails with password-protected .zip archive attachments that contain .LNK files instead of\nmalicious documents.\n\nLNK files are shortcut files that link to an application or file commonly found on a user’s\ndesktop or throughout a system and end with an .LNK extension. LNK files can be created\nby the user or automatically by the Windows operating system. The .LNK files delivered by\nEmotet act as shortcuts that run embedded scripts when executed, as detailed below.\n\nWhile packaging malicious PowerShell or VBScript in a .LNK file is not a new technique, it is\nthe first time Emotet has been observed doing so. This could indicate that the developers are\nexploring other avenues of infection to bypass current security controls and training, which\ntend to focus on detection and interception of malicious documents.\n\n.LNK delivery keeps documents out of the attack chain:\n\nMethod 1: .ZIP -> .LNK -> CMD findstr -> VBS -> WScript -> regsvr32\nMethod 2: .ZIP -> .LNK -> PowerShell -> regsvr32\n\nComponent Breakdown\n\n**Emotet Dropper**\n\nThe latest initial infection vector used by Emotet comes in the form of a .zip file attached to\nan email. The .zip archive contains a shortcut (.LNK), which has the same name as the\noriginal .zip file. To date, the observed LNK files are consistently around 4KB in size. Since\nthe early stages of this campaign, Kroll has already seen changes and updates to the\nmalware delivery mechanics. At the beginning of the campaign, the LNK files initiated an\nembedded VBScript to download and execute the final Emotet payload. For example, the\nmalware authors embedded the following command-line to run when the LNK file was clicked\nto find and execute the VBScript inside the LNK file:\n\n\n-----\n\ncmd.exe /v:on /c findstr \"rSIPPswjwCtKoZy.*\" Password2.doc.lnk >\n\"%tmp%\\VEuIqlISMa.vbs\" & \"%tmp%\\VEuIqlISMa.vbs\"cmd.exe /v:on /c findstr\n\"rSIPPswjwCtKoZy.*\" Password2.doc.lnk > \"%tmp%\\VEuIqlISMa.vbs\" &\n\"%tmp%\\VEuIqlISMa.vbs\"\n\nDue to an error in the LNK name contained in the command-line (Password2.doc.lnk), these\ndid not work and were quickly updated by Emotet’s operators.\n\nThis rapid release of an updated version in the wild indicates the operators are closely\ntracking the campaign for course correction. The new, working LNKs reference the\nPowerShell executables with malicious arguments, as shown in Kroll’s analysis of one of the\nmalicious samples. Figure 1 shows the arguments contained in the output of Eric\nZimmermann’s LECmd tool, used to analyze Emotet’s LNKs.\n\nFigure 1 – LECmd.exe output for Emotet’s malicious LNK\n\nThrough the use of LECmd.exe, Kroll identified a piece of metadata left by the creation of the\nfile. Figure 2 shows a SID (S-1-5-21-1499925678-132529631-3571256938-1001) contained\nin the LNK extra blocks.\n\nFigure 2 – SID contained in the metadata of the malicious LNK\n\nUsing this as a correlating data point, an open-source intelligence search for files containing\nthis string yielded dozens of .zip and LNK files associated with this campaign. Kroll assesses\nwith high confidence that any attachment containing this string is associated with this most\nrecent Emotet campaign.\n\n\n-----\n\nThe successful LNK execution will result in the download of a file from one of six URLs,\nwhich will be saved to a temp folder on the victim’s system and executed via regsvr32.exe.\nFigure 3 shows the decoded PowerShell script.\n\nFigure 3 – Decoded PowerShell downloader used by Emotet\n\nThe LNK execution will temporarily write the decoded script to the temp folder and execute it\nfrom there. The same technique is used with the execution of the file downloaded from\nEmotet’s URLs, which has a random name and extension and is saved in the temp folder.\n\n**Loader**\n\nIn reviewing one of the downloaded files, Kroll noted it is a Visual C++, 64-bit DLL compiled\non April 25, 2022, at 22:02:11 (UTC) (0x62670C53). Embedded within this DLL is the Emotet\nloader, whose purpose is to extract, decrypt, and execute the final payload. Interestingly,\nKroll parsed out a rich header from the executable that indicates it was compiled with Visual\nStudio 2005 8.0.\n\nThe first notable activity performed by the DLL is to allocate an area of memory with\nPAGE_EXECUTE_READWRITE protection, where the contents of another region of memory\nare decrypted and copied. Figure 4 shows the decryption routine from the debugger which, in\nthis case, used the key sfdvkc9(akuGGHIoLP. Finally, execution is passed to this area.\n\n\n-----\n\nFigure 4 – Decryption routine for the data written in the first VirtualAlloc\n\nDumping this area of memory revealed executable code that can be decompiled into ASM\nand statically analyzed. Its function is to load a specific resource of the DLL, decrypt it and\npass the execution to it. This decrypted data is Emotet’s final DLL.\n\nFigures 5 and 6 show parts of the decompiled dumped code, where the names of Windows\nAPIs are being passed as arguments to a function. This behavior is typically associated with\nAPI hashing, a technique used by Emotet to obfuscate the imported libraries.\n\n\n-----\n\nFigures 5 and 6 – API hashing used by the executable code in the first VirtualAlloc\n\nThe code will allocate a second region of memory with PAGE_EXECUTE_READWRITE\npermissions, where the decrypted contents of a DLL’s resource are copied after being\ndecrypted. Figure 7 shows some of the DLL’s resources. Highlighted is the resource used by\nthe code, which stands out for two reasons: first, its size is unusually high (amounting to\nalmost one-third of the total file size), and second, its high entropy (7.76) suggests that it\nmay be encrypted.\n\nFigure 7 – DLL’s resource: highlightedis the encrypted resource copied by the loader\n\nThe decryption routine of the last stage DLL is shown in Figure 8, along with a view of the\nmemory dump where the MZ header is being written.\n\n\n-----\n\nFigure 8 – Emotet’s final stage being decrypted and written in memory\n\nThis memory area is Emotet’s final payload, a DLL. Through a third call to VirtualAlloc, its\nsections will be mapped to another region of memory to fix relocations, and then executed.\n\nEmotet’s payload is a 64-bit DLL compiled on April 19, 2022, at 15:25:49 (UTC)\n(0x625ED47E). The original filename, as is typical with the recent Emotet version, is Y.dll. It\ncontains many encrypted strings, which will be decrypted at runtime. Some of them are\nEmotet’s configuration (mainly, the network encryption keys) and a list of command-andcontrol (C2) IP addresses and ports, usually stored in the .data section.\n\nTo further hinder static analysis, the malware authors used control flow obfuscation\ntechniques. Figure 9 shows an example of this in the disassembler.\n\n\n-----\n\nFigure 9 – Example of control flow obfuscation iused by the loader\n\nEmotet establishes and maintains persistence on the compromised system by creating a key\nin HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run. It instructs the system on\nstartup to run a randomly named copy of the loader that it has placed in the temp folder\n(Figure 10).\n\n\n-----\n\nFigure 10 – Registry key created for persistence\n\nIf the loader is executed with administrative privileges, it creates a new service that executes\na copy of the malware (Figure 11).\n\nFigure 11 – Service created when emotet is run with administrative privileges\n\nEmotet’s successful installation will register the compromised host to a C2 server. An initial\nAES-encrypted HTTP POST request containing information about the host is made to the C2\nwhich, in turn, will respond with a command to execute. Commands can be divided into four\nmain categories (Table 1).\n\nCommand\n\nDo nothing (sleep)\n\nUpdate or remove the binary\n\nLoad a module\n\nDownload and execute an EXE or a DLL\n\nTable 1 – Command execution categories from C2 server\n\nModules are one of the key aspects of Emotet’s core functionality. They allow for greater\ncontrol of the compromised host without the need to add malicious functionality to the loader.\nIn fact, they are received by the C2 and are executed in-memory, leaving no trace on disk.\nModules evolve continuously, with new ones being added regularly by the authors, and more\nnotorious ones being used more often (Table 2).\n\nFeature\n\nCredentials stealing for various email clients and browsers\n\nSpam and reply-chain malspam\n\n\n-----\n\nNetwork traffic proxying\n\nMoving laterally through SMB\n\nTable 2 – Representative Features of Modules\n\nCountermeasures\n\nBelow is some guidance on the detection and prevention of Emotet infections. It is important\nto note that Emotet is an endpoint threat spread via email, therefore endpoint detection and\nresponse (EDR) and antivirus tooling is imperative to disrupting this threat. Many of these\nrecommendations can also be applied to other forms of email-borne malware.\n\n**Detection**\n\nUnderstanding the initial infection vector is critical to detecting Emotet infections at the\nearliest opportunity. Emotet developers continue to experiment with methods of infection,\nand as such, it is important to test and develop detection methods as the threat changes. For\nexample, consider using MITRE ATT&CK mapping for Emotet malware (Table 3).\n\nMITRE Techniques\n\nT1552.001,Credentials In Files T1552.001,Credentials In Files\n\nT1021.002,SMB/Windows Admin Shares T1555.003,Credentials from Web Browsers\n\n\nT1547.001,Registry Run Keys / Startup\nFolder\n\n\nT1065,Uncommonly Used Port\n\n\nT1114.001,Local Email Collection T1560,Archive Collected Data\n\nT1210,Exploitation of Remote Services T1003.001,LSASS Memory\n\nT1059.001,PowerShell T1087.003,Email Account\n\nT1566.002,Spearphishing Link T1566.001,Spearphishing Attachment\n\nT1055.001,Dynamic-link Library Injection T1053.005,Scheduled Task\n\n\n-----\n\nT1204.002,Malicious File T1057,Process Discovery\n\nT1027,Obfuscated Files or Information T1059.003,Windows Command Shell\n\nT1110.001,Password Guessing T1573.002,Asymmetric Cryptography\n\n\nT1047,Windows Management\nInstrumentation\n\n\nT1059.005,Visual Basic\n\n\nT1204.001,Malicious Link T1078.003,Local Accounts\n\nT1571,Non-Standard Port T1094,Custom Command and Control\nProtocol\n\nT1027.002,Software Packing T1041,Exfiltration Over C2 Channel\n\nT1043,Commonly Used Port T1040,Network Sniffing\n\nTable 3 – MITRE ATT&CK mapping\n\n**Endpoint Detection**\n\nSince malicious email delivery may not always be preventable, detection of Emotet at the\nearliest opportunity is key for rapid containment and remediation. Below are some early\ndetection opportunities:\n\n**T1566.001 – Spear Phishing Attachment and Child Processes**\n\nDetect execution of Excel 4.0 macros\nDetect Office spawning subprocesses such as CMD.exe, PowerShell*.exe,\n**wscript.exe, cscript.exe, mshta.exe, wmic.exe, msbuild.exe**\nEmotet has previously exploited CVE-2017-11882, a remote code execution flaw in the\nMicrosoft Equation Editor. Detection network connections from eqnedt32.exe can be\nan indicator of exploit.\n\n**T1059.005 – Visual Basic**\n\nEmotet is still delivering malicious documents which use Excel 4.0 and VBA macros.\n\n\n-----\n\nDetect Visual Basic spawning child processes such as CMD.exe, PowerShell .exe,\n**wscript.exe, cscript.exe, mshta.exe, wmic.exe, msbuild.exe, certutil.exe**\n\n**T1059.001 – PowerShell Execution**\n\nPowerShell executing encoded commands\nPowerShell obfuscation methods, detect scripts that include “.value.tostring”\nPowerShell connecting to the internet, specifically TCP client connections, and “iex”\nexecution\n\n**T1055.001 – Dynamic-link Library Injection:**\n\nEmotet will use “living off the land” binaries (LOLBins) to perform DLL injection.\n\nDetect DLL proxy execution via calls to mavinject.exe and mavinject32.exe\nprocesses from appvcleint.exe\nDetect DLL proxy execution via calls to rundll32.exe\n\n**Prevention**\n\nConsider deploying endpoint detection and response (EDR) and next generation\nantivirus (NGAV) to all devices within your environments to allow for early detection.\nReview inbound email policy and consider quarantining attachments from unknown or\nuntrusted senders.\nBlock users from opening non-standard files such as the following:\n.iso, .dll, .jar, .js, .lib, .mst, .msp, .bat, .cmd, .com, .cpl, .msi, .msix.\nRun awareness campaigns for this latest Emotet tactic. The download link phishing\npage may reference the organization and user by name, increasing the apparent\nlegitimacy.\nAdhere to the principle of least privilege, so you can significantly reduce the potential\ndamage an attacker can inflict.\n\n**Remediation**\n\nTreat any Emotet infection as a potential precursor to a ransomware event. Immediately\ninitiate incident response playbooks. Consider including the following steps to contain an\nEmotet infection:\n\nIsolate the affected endpoint.\n\n\n-----\n\nConsider all data, including emails, passwords, accounts, and documents on the\naffected endpoint as being at-risk, until verified with network logs or DFIR investigation\nof the endpoint.\nIdentify the email which delivered Emotet.\n\nSearch mail system for matching emails which were sent to other staff members and\nremove the emails from their inbox.\nBlock the sender.\n\nInspect logs for Emotet spreading via internal emails, SMB, WMIC, or PsExec.\n\nConclusion\n\nThe ongoing development of Emotet reflects a significant time investment by the developers.\nEmotet changed regularly before the takedown by law enforcement on April 25, 2021, but the\ncadence of updates and spam campaigns has rapidly increased since its resurgence in\nNovember 2021.\n\nThe latest shift away from its reliance on malicious documents or Excel spreadsheets\ndemonstrates that the operators believe they will see diminishing returns from using\nmaldocs. This could be because they have seen reduced effectiveness in malware delivery\nor installation. They may also wish to preempt coming changes that Microsoft has\n[announced in the way Windows handles documents with the Mark of the Web (MOTW) by](https://docs.microsoft.com/en-us/deployoffice/security/internet-macros-blocked)\nautomatically disabling execution of macros on files downloaded from the internet.\n\nWe have observed other actors exploring new ways of delivering malware to victims:\n\nUse of .ISO containers to remove MOTW from documents or to bypass inline email\ndefenses, which has notably been used by the IcedID malware\nContinued use of password-protected .zip attachments, as these are typically unable to\nbe inspected by inline email security tooling\n\nAlthough undoubtedly bruised by last year’s disruption, Emotet is certainly not dead. We\nassess that the Emotet developers will likely keep experimenting with new infection chains at\nthis increased cadence. We also assess that the Emotet operators will move forward with\nlarge spam campaigns in order to rebuild the botnet, thus allowing them to sell the initial\naccess they have gained to realize their return on investment.\n\n## Stay Ahead with Kroll\n\nCyber Risk\n\nIncident response, digital forensics, breach notification, managed detection services,\npenetration testing, cyber assessments and advisory.\n\n24x7 Incident Response\n\n\n-----\n\nEnlist experienced responders to handle the entire security incident lifecycle.\n\nIncident Response Plan Development\n\nYou learn today that your organization is facing some kind of cyber incident. Could be\nransomware, highjacked O365 email account, PII or PHI exfiltrated, misconfigured network\nsettings exposing data, etc. What do you do first?\n\nData Breach and Loss Statistics\n\nReduce the cost of lost business from a data breach with a sound data breach response\nplan.\n\nMalware Analysis and Reverse Engineering\n\nKroll’s Malware Analysis and Reverse Engineering team draws from decades of private and\npublic-sector experience, across all industries, to deliver actionable findings through in-depth\ntechnical analysis of benign and malicious code.\n\nKroll Responder\n\nStop cyberattacks. Kroll Responder managed detection and response is fueled by seasoned\nIR experts and frontline threat intelligence to deliver unrivaled response.\n\nManaged Services\n\nProcesses and strategies to optimize information produced through M&A, divestures and\nintegration.\n\nIncident Response and Litigation Support\n\nKroll’s elite security leaders deliver rapid responses for over 3,200 incidents per year and\nhave the resources and expertise to support the entire incident lifecycle.\n\nMalware and Advanced Persistent Threat Detection\n\nOur expertise allows us to identify and analyze the scope and intent of advanced persistent\nthreats to launch a targeted and effective response.\n\nComputer Forensics\n\nKroll's computer forensics experts ensure that no digital evidence is overlooked and assist at\nany stage of an investigation or litigation, regardless of the number or location of data\nsources.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-27 - Emotet Analysis- New LNKs in the Infection Chain – The Monitor, Issue 20.pdf"
    ],
    "report_names": [
        "2022-05-27 - Emotet Analysis- New LNKs in the Infection Chain – The Monitor, Issue 20.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535899,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1654086388,
    "ts_modification_date": 1654086388,
    "files": {
        "pdf": "https://archive.orkl.eu/2a8bd3e9cdd657bfb6c3c74e6f2723cd1a359df7.pdf",
        "text": "https://archive.orkl.eu/2a8bd3e9cdd657bfb6c3c74e6f2723cd1a359df7.txt",
        "img": "https://archive.orkl.eu/2a8bd3e9cdd657bfb6c3c74e6f2723cd1a359df7.jpg"
    }
}