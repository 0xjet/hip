{
    "id": "e9dada49-8dd4-479f-bda4-b49711bff168",
    "created_at": "2022-10-25T16:48:23.237976Z",
    "updated_at": "2025-03-27T02:11:55.111536Z",
    "deleted_at": null,
    "sha1_hash": "12a79e8f73c77e470971f742f420a4f2f604b02e",
    "title": "Prince of Persia – Game Over - Palo Alto Networks BlogPalo Alto Networks Blog",
    "authors": "",
    "file_creation_date": "2016-06-30T14:48:00Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 429087,
    "plain_text": "|Col1|POSTED BY: Tomer Bar, Lior Efraim and Simon Conant on June 28, 2016 3:00 PM|\n|---|---|\n|||\n|25 LLiikkee|FILED IN: Malware, Threat Prevention, Unit 42 TAGGED: C2, Infy Unit 42 published a blog at the beginning of May titled “Prince of Persia,” in which we described the discovery of a decade-long campaign using a formerly unknown malware family, Infy, that targeted government and industry interests worldwide.|\n|Tweet||\n|4||\n\n\n### 25\n\n\n**Subsequent to the publishing of this article, through cooperation with the parties responsible for**\n\n**the C2 domains, Unit 42 researchers successfully gained control of multiple C2 domains. This**\n\n**disabled the attacker’s access to their victims in this campaign, provided further insight into the**\n\n**targets currently victimized in this operation, and enabled the notification of affected parties.**\n\n**In the week following the publication of the original blog, we observed no unusual changes to**\n\n**the C2 infrastructure. Existing domains did move to new IP addresses, as we had previously**\n\n**seen periodically. Some new install domains were added, adhering to naming conventions of**\n\n**current domains (see appendix for new IOCs).**\n\n**The attackers developed a new version (31), and we observed this deployed against a single**\n\n**Canadian target.**\n\n**The file descriptions remained essentially the same (“CLMediaLibrary Dynamic Link Library**\n\n**V3”). Most importantly, there was no change to the encoding key (now using offset 20, and**\n\n**offset 11 for second pass against URL encoding) that we had observed being used for the entire**\n\n**decade-long campaign, and documented in our previous blog. From this we conclude that the**\n\n**attackers were unaware of our initial report.**\n\n**Through cooperation with the parties responsible for the C2 domains, we took control of all but**\n\n**one of them, transferring the A records to a server we controlled. This prevented the attackers**\n\n**from being able to subsequently make any further changes to the domain configurations, issue**\n\n**commands to victims, or capture any further data for the majority of victims. An analysis of**\n\n**connections after transfer suggests that the attackers may have used a third-party service to try**\n\n**to understand why they had suddenly lost almost all of their traffic. Figure 1 shows that tool, a**\n\n**geographic representation of victim-C2 traffic, with all but one at that time now communicating**\n\n**with our sinkhole server.**\n\n**_Figure 1 Graphical representation of victim traffic to C2_**\n\n**[We have since transferred sinkhole control to Shadowserver, whom we thank for subsequent](https://www.shadowserver.org/wiki/)**\n\n**victim notification & remediation**\n\n**[(https://www.shadowserver.org/wiki/pmwiki.php/Involve/GetReportsOnYourNetwork).](https://www.shadowserver.org/wiki/pmwiki.php/Involve/GetReportsOnYourNetwork)**\n\n**We were able to analyze victim C2 traffic to understand who were victims of the Infy campaign.**\n\n**We identified 456 malware agents installed on 326 victim systems, in 35 countries. Figure 2**\n\n\n**Get Updates**\n**Sign up to receive the latest news, cyber**\n**threat intelligence and research from Unit**\n**42.**\n\n**Business Email**\n\n**Submit**\n\n\n**LikeLike**\n\n\n-----\n\n**example, crimeware campaigns.**\n\n**_Figure 2 Geographic location of victims. Please note that New Zealand has been omitted from_**\n\n**_this map only because we observed no victim activity there._**\n\n**In our original blog, we noted two distinct primary variants of the Infy malware. In addition to the**\n\n**original “Infy” variant, we also see the newer, more sophisticated, interactive, and fuller-featured**\n\n**“Infy M” variant deployed against apparently-higher-value targets. Overall, 93% of all victims**\n\n**were infected with Infy, and 60% with Infy “M” (Figure 3). Combined with the low total number of**\n\n**victims, this suggests a great deal of care given to each individual campaign target. The large**\n\n**number of victims with both variants may relate to their complimentary feature set, or represent**\n\n**an “upgrade” path on victims from the original variant infection, later adding the “M” variant as**\n\n**targets appeared more compelling to the attackers.**\n\n**_Figure 3 Breakdown of Infy vs. Infy “M” infections_**\n\n**For the Infy “M” variant, we note that the majority of targets are using the latest version (7.8),**\n\n**and that none are using the older 6.x versions at all (Figure 4). This suggests that these higher-**\n\n**value targets are paid much more attention, being kept up-to-date with the latest version.**\n\n**In contrast, for the more basic original Infy variant, we note a full spectrum of versions installed**\n\n**(Figure 5), with many victims on older versions – including the original, decade-old V1 –**\n\n**suggesting much less concern is paid to these individual targets (note that we did observe a**\n\n**small number of the older 6.x versions but these do not announce their version when**\n\n**connecting).**\n\n\n-----\n\n**_Figure 4 Infy “M” Victim versions_**\n\n**_Figure 5 Infy”Original” Victim versions_**\n\n**Shortly after the takedown, as well as a new Infy version (31), we also observed the registration**\n\n**of multiple domains using a previously-seen pattern, against known campaign IP addresses.**\n\n**Almost every domain in the pattern-range box4035[.]net – box4090[.]net (138.201.0.134).**\n\n**These were not observed in any sample C2 lists however. Bestwebstat[.]com was sinkholed by**\n\n**another operator.**\n\n**Some victims infected with Infy versions 15-24 still used the C2 server us1s2[.]strangled[.]net,**\n\n**which remained in the hands of the attacker. In early June the attackers used this C2 to issue**\n\n**instructions to download new Infy “M” version 8.0 from us1s2[.]strangled[.]net/bdc.tmp. This was**\n\n**the first time we had observed an Infy variant being directly updated to Infy “M”. This used**\n\n**camouflage name “Macromedia v4”, changed from “v3” seen in Infy v31. They also removed the**\n\n**voice recording capability in this version.**\n\n**uvps1[.]cotbm[.]com was used for data exfiltration, previously at 138.201.47.150, after publishing**\n\n**of our original blog moving to 144.76.250.205. It was also hosting malware updates at**\n\n**/themes/u.php.**\n\n**They also added a curious C2 entry “hxxp://box” (note: defanged for publishing). It’s unclear**\n\n**how this should function; possibly a compromised victim intranet device, or the attackers have**\n\n**modified the HOSTS file on the victim computer.**\n\n**After the take-down, the attackers began to add server IP addresses as well as domain names**\n\n**to their malware C2 list. They also slightly modified their ZIP password from “Z8(2000_2001ul”**\n\n**to “Z8(2000_2001uIEr3”. Their new malware version added antivirus checks for Kaspersky**\n\n**Labs, Avast, and Trend Micro. The malware data capture now searches for file extensions:**\n\n**_.doc, .docx, .xls, .xlsx, .xlr, .pps, .ppt, .pptx, .mdb, .accdb, .db, .dbf, .sql, .jpg, .jpeg, .psd, .tif,_**\n\n**_.mp4, .3gp, .txt, .rtf, .odt, .htm, .html, .pdf, .wps, .contact, .csv, .nbu, .vcf, .pst, .zip, .rar, .7z,_**\n\n\n-----\n\n**_:\\$recycle.bin, :\\documents and settings, :\\msocache, :\\program files, :\\program files (x86),_**\n\n**_:\\programdata, :\\recovery, :\\system volume information:\\users, :\\windows, :\\boot, :\\inetpub,_**\n\n**_:\\i386._**\n\n**The malware continued to use the identical decryption key seen over the entire history of this**\n\n**campaign.**\n\n**Mid-June, through cooperation with the parties responsible for the C2 domains and law**\n\n**enforcement, we were able to get the remaining C2 domains null-routed and the directly-IP-**\n\n**addressed server disabled. This is the end of a decade-long campaign, though we naturally**\n\n**expect to see this actor back in some other guise before long.**\n\n**Thanks to the Malware research team – Yaron Samuel, Artiom Radune, Mashav Sapir, Netanel**\n\n**Rimer – for assistance in the takedown.**\n\n**The malware uses a different algorithm than that used for encrypting the malware strings to**\n\n**encrypt the exfiltration data, including:**\n\n**1. Keylogger data + language.**\n\n**2. Malware logs – installation time, DLL path and name, log path, number of downloads, number**\n\n**of successful/failed connections.**\n\n**3. Information about the victim computer: Time zone, list of drives and types, running processes,**\n\n**disk info.**\n\n**First the malware adds 1 to all bytes, then an encryption key is initialized based on the victim**\n\n**computer name (the offset in the key is calculated by sum of the computer name letters %key**\n\n**length). Then the key is used to encrypt the data (see decrypt function). The encrypted data is**\n\n**then base64 encoded.**\n\n**Exfiltration data decryption python code:**\n\n\n**1**\n**2**\n**3**\n**4**\n**5**\n**6**\n**7**\n**8**\n**9**\n**10**\n**11**\n**12**\n**13**\n**14**\n**15**\n**16**\n**17**\n**18**\n**19**\n**20**\n**21**\n**22**\n**23**\n**24**\n**25**\n**26**\n**27**\n**28**\n**29**\n**30**\n**31**\n**32**\n**33**\n**34**\n**35**\n**36**\n**37**\n**38**\n**39**\n**40**\n**41**\n**42**\n**43**\n**44**\n**45**\n**46**\n**47**\n**48**\n**49**\n**50**\n**51**\n**52**\n**53**\n**54**\n\n\n**import os,sys**\n**import string**\n**import base64**\n**import fileinput**\n**FIRST_PHASE = \"OQTJEqtsK0AUB9YXMwr8idozF7VWRPpnhNCHI6Dlkaubyxf5423**\n**SECOND_PHASE = \"PqOwI1eUrYtT2yR3p4E5o6WiQu7ASlDkFj8GhHaJ9sKdLfMgNz**\n**global** **FULL_KEY**\n**FULL_KEY= \"\"**\n**def sub_1_for_hex(str_input):**\n**str_output = \"\"**\n**for** **letter in** **str_input:**\n**try:**\n**str_output += chr(ord(letter)-1)**\n**except:**\n**print** **\"sub_1_for_hex func problem\"**\n**continue**\n**return** **str_output**\n\n**def sum_comp_name(comp_name):**\n**sum = 0**\n**for** **letter in** **comp_name:**\n**sum+= ord(letter)**\n**return** **sum**\n\n**def init_key(comp):**\n**comp_name_sum = sum_comp_name(comp)**\n**carry = divmod(comp_name_sum,** **62)**\n**index = carry[1] -1**\n**end_key = FIRST_PHASE[:index]**\n**key = FIRST_PHASE[index:]**\n**key = key + end_key**\n**key = key + key**\n**return** **key**\n\n**def decrypt(num_list,offset):**\n**global** **FULL_KEY**\n**input = \"\"**\n**for** **num_str in** **num_list:**\n**try:**\n**input += num_str.decode('hex')**\n**except:**\n**input += ')'**\n**result = \"\"**\n**for** **i,** **c** **in** **enumerate(input):**\n**i = i % 62 +1**\n**try:**\n**index = FULL_KEY.index(c)-1**\n**except ValueError:**\n**result += c**\n**continue**\n**translated = SECOND_PHASE[(index - i +offset) % len(SECOND**\n**result += translated**\n**return** **result**\n\n\n-----\n\n**59**\n**60**\n**61**\n**62**\n**63**\n**64**\n**65**\n**66**\n**67**\n**68**\n**69**\n**70**\n**71**\n**72**\n**73**\n**74**\n**75**\n**76**\n**77**\n**78**\n**79**\n**80**\n**81**\n**82**\n**83**\n**84**\n**85**\n**86**\n**87**\n**88**\n**89**\n**90**\n**91**\n**92**\n**93**\n**94**\n**95**\n**96**\n**97**\n**98**\n**99**\n**100**\n**101**\n**102**\n**103**\n**104**\n**105**\n**106**\n**107**\n**108**\n**109**\n**110**\n**111**\n**112**\n**113**\n**114**\n**115**\n**116**\n**117**\n**118**\n**119**\n**120**\n**121**\n**122**\n**123**\n**124**\n**125**\n**126**\n**127**\n**128**\n**129**\n**130**\n**131**\n**132**\n**133**\n**134**\n**135**\n**136**\n**137**\n**138**\n**139**\n**140**\n**141**\n**142**\n**143**\n**144**\n**145**\n**146**\n**147**\n**148**\n**149**\n**150**\n**151**\n**152**\n**153**\n**154**\n**155**\n\n\n**_** **y_**\n**return** **True,found_infy_index**\n**else:**\n**return** **False,found_infy_index**\n\n**def extract_comp_name(line):**\n**comp = r\"\\xd\\xa-----\"**\n**comp_index = line.find(comp)**\n**comp_name = line[comp_index+len(comp):]**\n**comp_name = comp_name[:comp_name.find(\"-----\")]**\n**print** **\"(((=)))\" + comp_name**\n**return** **comp_name**\n\n**def extract_enc_data(line):**\n**header = r\"\\xd\\xa_____\"**\n**start_index = line.find(header)+len(header)**\n**line = line[start_index:]**\n**endindex = line.index(\"_____\\\" value=\")**\n**line = line[:endindex]**\n**return** **line**\n\n**def write_enc_infy_data_to_file(dec_line,comp_name,filename):**\n**file1 = open(filename + \"\\\\\" + comp_name + \".txt\",'ab')**\n**file1.writelines(dec_line)**\n**file1.close()**\n\n**def enc_wrapper(enc,comp_name):**\n**global** **FULL_KEY**\n**print FULL_KEY**\n**FULL_KEY = init_key(comp_name)**\n\n**enc_final = \"\"**\n**for** **letter in** **enc:**\n**if** **len(hex(ord(letter))[2:])==1:**\n**enc_final += \"0\" + hex(ord(letter))[2:]**\n**elif len(hex(ord(letter))[2:])==2:**\n**enc_final += hex(ord(letter))[2:]**\n**else:**\n**print** **\"not good hex length\"**\n**exit()**\n\n**enc = enc_final.upper()**\n\n**enc = enc.replace(\"2E\",\"21\")**\n**enc = enc.replace(\"C5DC5A\",\"\")**\n**enc = enc.replace(\"D03D00\",\"\")**\n**enc = enc.replace(\"0B0E\",\"2121\")**\n\n**enc = enc.replace(\"01\",\"21\")**\n\n**enc_len = len(enc)**\n\n**enc_rev = \"\"**\n**num_list = []**\n**enc_print =\"\"**\n**for** **i** **in** **range(0,enc_len/2):**\n**enc_rev = enc[-2:]**\n**if** **not** **enc_rev==\"0B\"** **and** **not** **enc_rev==\"0E\"** **and** **not** **enc_rev**\n**enc_print +=enc_rev**\n**num_list.append(enc_rev)**\n**enc= enc[:-2]**\n\n**#the first part is always ok**\n**dec_str = decrypt(num_list,0)**\n**final = sub_1_for_hex(dec_str)**\n**index = final.find(\"OK: Sent\")**\n**if** **index==-1:**\n**print comp_name + \" - did not found OK: Sent !!!!\\n\\n\\n\\n\"**\n**#exit()**\n**decrypt_data = comp_name + \" ++==++ \" + str(i) + \": \" + final**\n\n**final_start = final[0:500]**\n**if** **final_start in** **UNIQUE_DATA:**\n**print comp_name + \" already have this data\"**\n**return**\n**UNIQUE_DATA.append(final_start)**\n**index = final.find(\"Installed Date:\")**\n\n**if** **index==-1:**\n**for** **i** **in** **range(1,61):**\n**dec_str = decrypt3(num_list,i)**\n**final = sub_1_for_hex(dec_str)**\n\n**##print all 62 options**\n**index2 = final.find(\"PROGRAM START:\")**\n**index3 = final.find(\"Installed Date:\")**\n**if** **not** **index2 ==-1** **or** **not** **index3 ==-1:**\n**decrypt_data += str(i) + \": \" + final + \"\\n\"**\n**write_enc_infy_data_to_file(decrypt_data,comp_name,FILE_OUTPUT**\n\n**def read_enc_data_files():**\n\n**for** **root,dir,files in** **os.walk(PDML_PATH):**\n**for** **file in** **files:**\n**filename = root+ \"\\\\\" + file**\n**if** **os.path.isfile(filename):**\n**print filename**\n\n**for line in fileinput input([filename]):**\n\n\n-----\n\n**161**\n**162**\n**163**\n**164**\n**165**\n**166**\n**167**\n**168**\n**169**\n**170**\n**171**\n**172**\n**173**\n**174**\n**175**\n\n\n\n**[** **_** **y_** **]**\n\n**#get computer name (for use in init_key() late**\n**comp_name = extract_comp_name(line)**\n**UNIQUE_COMP.append(comp_name)**\n**#get the infy encrypted data**\n**line = extract_enc_data(line)**\n**#base64 decode enc_data**\n**dec_line = line.decode('base64')**\n**#append enc_data to file**\n**write_enc_infy_data_to_file(dec_line,comp_name**\n**enc_wrapper(dec_line,comp_name)**\n**try:**\n**read_enc_data_files()**\n**except:**\n**print** **\"exception!!!!\"**\n\n\n**Infy version 31: f07e85143e057ee565c25db2a9f36491102d4e526ffb02c83e580712ec00eb27**\n\n**Infy “M” version 8.0:**\n\n**583349B7A2385A1E8DE682A43351798CA113CBBB80686193ECF9A61E6942786A**\n\n**5.9.94.34**\n\n**138.201.0.134**\n\n**138.201.47.150**\n\n**144.76.250.205**\n\n**138.201.47.158**\n\n**138.201.47.153**\n\n**us1s2[.]strangled[.]net**\n\n**uvps1[.]cotbm[.]com**\n\n**gstat[.]strangled[.]net**\n\n**secup[.]soon[.]it**\n\n**p208[.]ige[.]es**\n\n**lu[.]ige[.]es**\n\n**updateserver1[.]com**\n\n**updateserver3[.]com**\n\n**updatebox4[.]com**\n\n**bestupdateserver[.]com**\n\n**bestupdateserver2[.]com**\n\n**bestbox3[.]com**\n\n**safehostline[.]com**\n\n**youripinfo[.]com**\n\n**bestupser[.]awardspace[.]info**\n\n**box4035[.]net**\n\n**box4036[.]net**\n\n**box4037[.]net**\n\n**box4038[.]net**\n\n**box4039[.]net**\n\n**box4040[.]net**\n\n**box4041[.]net**\n\n**box4042[.]net**\n\n**box4043[.]net**\n\n**box4044[.]net**\n\n**box4045[.]net**\n\n**box4046[.]net**\n\n**box4047[.]net**\n\n**box4048[.]net**\n\n**box4049[.]net**\n\n**box4050[.]net**\n\n**box4051[.]net**\n\n**box4052[.]net**\n\n**box4053[.]net**\n\n**box4054[.]net**\n\n**box4055[.]net**\n\n**box4056[.]net**\n\n**box4057[.]net**\n\n**box4058[.]net**\n\n**box4059[.]net**\n\n**box4060[.]net**\n\n**box4061[.]net**\n\n**box4062[.]net**\n\n**box4063[.]net**\n\n**b** **4064[ ]**\n\n\n-----\n\n**box4068[.]net**\n\n**box4069[.]net**\n\n**box4070[.]net**\n\n**box4071[.]net**\n\n**box4072[.]net**\n\n**box4075[.]net**\n\n**box4078[.]net**\n\n**box4079[.]net**\n\n**box4080[.]net**\n\n**box4081[.]net**\n\n**box4082[.]net**\n\n**box4083[.]net**\n\n**box4084[.]net**\n\n**box4085[.]net**\n\n**box4086[.]net**\n\n**box4087[.]net**\n\n**box4088[.]net**\n\n**box4089[.]net**\n\n**box4090[.]net**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2016/2016.06.28.prince-of-persia-game-over/unit42-prince-of-persia-game-over.pdf"
    ],
    "report_names": [
        "unit42-prince-of-persia-game-over"
    ],
    "threat_actors": [
        {
            "id": "59c9f31b-e032-44b9-bf3b-4f2cb3d17e39",
            "created_at": "2022-10-25T16:07:23.734244Z",
            "updated_at": "2025-03-27T02:02:09.952685Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "APT-C-07",
                "Infy",
                "Operation Mermaid",
                "Prince of Persia"
            ],
            "source_name": "ETDA:Infy",
            "tools": [
                "Foudre",
                "Infy",
                "Tonnerre"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f763fd1f-f697-40eb-a082-df6fd3d13cb1",
            "created_at": "2023-01-06T13:46:38.561288Z",
            "updated_at": "2025-03-27T02:00:02.861874Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "Operation Mermaid",
                "Prince of Persia",
                "Foudre"
            ],
            "source_name": "MISPGALAXY:Infy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041515,
    "ts_creation_date": 1467298080,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/12a79e8f73c77e470971f742f420a4f2f604b02e.pdf",
        "text": "https://archive.orkl.eu/12a79e8f73c77e470971f742f420a4f2f604b02e.txt",
        "img": "https://archive.orkl.eu/12a79e8f73c77e470971f742f420a4f2f604b02e.jpg"
    }
}