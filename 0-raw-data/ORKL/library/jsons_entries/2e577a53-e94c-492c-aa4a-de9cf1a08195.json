{
    "id": "2e577a53-e94c-492c-aa4a-de9cf1a08195",
    "created_at": "2022-10-27T08:36:06.844976Z",
    "updated_at": "2025-03-27T02:09:29.218458Z",
    "deleted_at": null,
    "sha1_hash": "a91919dc73ce07d914ae90aa54c54e08eae87fd1",
    "title": "",
    "authors": "",
    "file_creation_date": "2022-07-23T01:10:20Z",
    "file_modification_date": "2022-07-23T01:10:20Z",
    "file_size": 15398545,
    "plain_text": "# Analyzing PIPEDREAM:\n## Challenges in testing an ICS attack toolkit\n\n###### Speaker\n\n Jimmy Wylie Principal Malware Analyst II, @mayahustle\n\n\n-----\n\n## Agenda\n\n\n\n#### • Background\n\n • PIPEDREAM Capabilities\n\n • Hardware & Lab Setup\n\n • Assessing the Impact\n\n • Results from Lab Testing\n\n • Real World Usage\n\n • Conclusion\n\n\n-----\n\n## It’s a Group Effort\n\n\n###### Carolyn Ahlers Logan Carpenter Sam Hanson Reid Wightman Kate Vajda Kyle O’Meara Casey Brooks Conor McLaren Kevin Woolf Maritza Dubec Cathy Clarke Matt Pahl\n\n\n###### Austin Scott Raahul Mareddy Michael Logoyda Jess O’Bryan Brian Warehime Sergio Caltagirone Thomas Winston Gus Serino John Burns Gregory Pollman Julian Gutmanis Rob Lee\n\n\n###### Marissa Costa Grant Freter Andrue Coombes Camille Stauffer Monserrat Thomason Danielle Gauthier Avril Adams Megan Pingatore Mark Urban Peter Vescuso Gloria Cedillo Mike Hoffman\n\n\n-----\n\n## Where’d you find it?\n\n\n#### Required Legalese\n\n###### Dragos identified and analyzed PIPEDREAM’s capabilities through our normal business, independent research, and collaboration with various partners in early 2022.\n\n\n-----\n\n## PIPEDREAM Components\n\n\n###### EVILSCHOLAR\n\n BADOMEN\n\n MOUSEHOLE\n\n\n###### Designed to discover, access, manipulate, and disable Schneider Electric PLCs. Can target additional hardware through CODESYS library.\n\n Designed to scan, identify, interact, and manipulate Omron PLCs\n\n Tool for interacting with OPC UA servers. Designed to read and write node attribute data, enumerate the Server Namespace and associated NodeIds, and brute force credentials.\n\n\n###### Windows Components\n\n Remote operational implant to perform host reconnaissance and command-and-control.\n\n DUSTTUNNEL\n\n User-mode Windows executable that drops and exploits a vulnerable ASRock driver to load an unsigned driver.\n LAZYCARGO\n\n\n-----\n\n-----\n\n###### NX1P2 Compact Machine Controller\n NX-SL3300 Safety Controller NJ501-1300 Automation Controller\n NX-ECC EtherCAT Coupler NX-EIC202 Ethernet/IP Coupler\n NX-ECC203 EtherCAT Coupler\n S8VK Power Supply 1S-series Servo Drives\n\n\n###### ICS Protocols\n\n CODESYS Schneider Discovery (NetManage)\n Modbus Omron FINS\n OPC UA\n\n\n###### Vulnerabilities, Exposures, and Susceptibilities\n\n\n###### TM251 PLC TM241 PLC TM221 PLC TM258 PLC TM238 PLC LMC058 Motion Controller LMC078 Motion Controller\n\n\n###### CVE-2020-15368 – LAZYCARGO utilizes this CVE\n to load an unsigned driver.\n\n\n## Impacted Devices, Abused Protocols & Vulns\n\n\n###### Undisclosed Vulnerabilities in Schneider Electric.\n\n\n###### CVE-2022-34151  Hardcoded Creds in\n Omron devices.\n\n\n-----\n\n###### Omron Devices\nNX1P2 Controller\n\nNX-EIC202 Ethernet IP Coupler\n\nNX-ECC201 EtherCat Coupler\n\nSL3300 Safety Controller\n\n\nR88D-1SN10F-ECT Servo Drive\n\nR88D-1SN01L-ECT Servo Drive\n\nR88M-1M10030S-S2 AC\nServo Motor\n\n\n## Lab Set-up\n\n\n###### Schneider Electric Devices\n\nModicon TM241 PLC (4.0.X firmware)\n\nModicon TM251 PLC (5.0 firmware)\n\n###### OPC UA (not shown)\n\nKepware OPC UA server\n\nVarious Rockwell devices controlling\na small pipeline process.\n\n###### Other hardware\n\nPhoenix Contact power supply\n\nSixnet Industrial ethernet switch\n\nStack light, buttons\n\n\n-----\n\n## Device Acquisition is a Pain\n\n\n###### TM251 running 5.0, need 4.0.X\n\n • Downgrading == bricked PLC L\n\n Ask the vendor\n\n • Company attitude\n\n • CYA, NDAs, reporting deadlines\n\n eBay or ask a friend\n\n Easy to purchase, stay independent\n\n\n-----\n\n-----\n\n## Analysis Approach\n\n\n##### Looking at 5 malware samples in parallel\n\n###### • Focus on PLCs and malware RE.\n\n • Test on representative devices.\n\n##### Analysis Process & Goals\n\n###### 1. Static analysis while waiting for hardware.\n\n 2. Release of initial details and mitigation advice.\n\n 3. Runtime analysis with PCAP collection.\n\n 4. Which techniques work, and on what device.\n\n 5. Release updated details and specific mitigation advice.\n\n 6. Hypothesize and test what next versions could look like.\n\n\n-----\n\n## Analysis Questions\n\n\n\n###### • Does it work?\n • Is the CODESYS implementation specific to Schneider or applicable to all CODESYSv3 devices?\n • Does BADOMEN’s Servo module work on other servos?\n\n • More generally: can these tools manipulate PLC logic?\n\n\n###### IMPACT OF\n CURRENT CAPABILITY\n\n\n\n###### • How easy is it to automate an attack?\n\n • What functionality could be added with minimal research? What will it look like in 6 months?\n\n\n###### ASSESSMENT OF FUTURE CAPABILITY\n\n\n\n###### • Can we narrow down a likely target?\n\n\n###### VICTIMOLOGY\n\n\n-----\n\n-----\n\n###### MOUSEHOLE\n\n\n###### Multiplatform toolkit\n to interact with OPC UA servers.\n\n FORMAT: Python framework\n\n TARGETS: OPC-UA servers\n\n\n\n###### • Scan for OPC UA Servers on a local network (default: TCP/4840).\n\n • Port can be changed and can\n scan for OPC UA Servers anywhere.\n\n • Brute force OPC UA server based on password list supplied by operator.\n\n • Can use a default password\n or compromised passwords.\n\n • Read OPC UA structure from the server and change specific attributes.\n\n • Better implementation of CRASHOVERRIDE OPC-DA attack methodology.\n\n\n-----\n\n## MOUSEHOLE: Remote Interaction to Attack\n\n\n\n##### • MOUSEHOLE works primarily due to the open-source OPC UA library it runs on.\n\n • Easy to get it to work and manipulate a process.\n\n • We tested on a Kepware OPC server connected to Rockwell PLCs controlling a mock pipeline process.\n\n • After verifying it worked, we automated an attack using MOUSEHOLE to produce a more real-world attack scenario.\n\n\n-----\n\n-----\n\n-----\n\n## MOUSEHOLE: Attack scenario\n\n\n###### Nodes are addressed via 3-tuple\n\n Type of Identifier Namespace Identifier\n\n ns=2;s=MyTemperature\n\n • Run MOUSEHOLE via CLI to gather Server and Node information for a process.\n\n • ns=2;s=Channel1.Device2.high pressure setpoint\n\n • ns=2;s=Channel1.Device2.Level_PID\n\n • ns=2;s=Channel1.Device2.solenoid energize\n\n • Remove MOUSEHOLE and deploy an automated utility to manipulate those values.\n\n • High pressure setpoint 15 psi -> 100 psi\n\n • Level_PID: 80 -> 100 (pump speed)\n\n • Solenoid energize: True -> False (closes the valve)\n\n\n###### Type of Identifier\n\n\n-----\n\n-----\n\n## MOUSEHOLE: Potential Repercussions\n\n\n###### Deadheading is when a pump operates with no flow through the pump due to a closed or blocked discharge valve.\n\n\n\n###### • A modification to the PLC logic incorrectly allowed the pump to keep running outside of designated start/stop sequence with the suction and discharge valves closed.\n\n • Slurry inside the pump became superheated.\n\n • This resulted in pump explosion.\n\n\n-----\n\n###### EVILSCHOLAR\n\n\n###### Framework to interact with Schneider Electric controllers via\n CODESYS and Modbus libraries\n\n FORMAT: Python + Linux ELF Library\n\n TARGETS: Schneider Electric Controllers\n\n\n\n###### • Rapid scan that identifies all Schneider\n PLCs on the local network from a device that has already been compromised via User Datagram Protocol (UDP) multicast with a destination port of 27127.\n\n • Brute force Schneider Electric PLC\n passwords using UDP port 1740.\n\n • CODESYS denial-of-service attack to\n prevent network communications from reaching the PLC.\n\n • Sever CODESYS connections, likely to\n facilitate either credential capture or to prep for DOS.\n\n • ‘Packet of death’ attack.\n\n • Proxy Modbus traffic through a target PLC.\n\n • ”Maintenance” actions like logging in/out,\n uploading/downloading files, etc.\n\n\n-----\n\n## EVILSCHOLAR: CODESYS\n\n\n\n##### • CODESYS is a device management protocol used by 100s of vendors.\n\n • Wide usage == natural target.\n\n • Layered protocol: Services, Channel, Datagram, Block Driver layer.\n\n • Essentially a custom TCP implementation on top of UDP with Application layer support.\n\n\n-----\n\n## EVILSCHOLAR: Lab Set Up Issues\n\n\n\n###### • We thought it was a firmware issue. (We were wrong )\n\n\n## EVILSCHOLAR: Lab Set Up Issues\n\n###### Devices Tested: TM241, TM251\n\n •\n\n •\n\n •\n\n •\n\n\n-----\n\n## EVILSCHOLAR: Bad Assumptions\n\n\n\n###### • Multiple Parts of EVILSCHOLAR’s\n CODESYS implementation were broken, due to the developer’s invalid assumptions.\n\n • Could connect to the TM241/TM251\n with no fixes if the devices were on a network of the right size.\n\n • Once fixed, we could connect to\n the TM241, TM251, Raspberry Pi, and Hitachi EHV+, and start testing plugins without worrying about network sizing. (no big endian)\n\n\n-----\n\n## EVILSCHOLAR: PLCProxy Results\n\n\n###### Originally, we thought PLCProxy worked like this.\n\n\n### AFTER DYNAMIC ANALYSIS\n\n###### • Original finding that it creates a\n route to gateway IP was incorrect.\n\n 1. What it does is create a route to the internal network where gateway is located.\n\n 2. The target network cannot be on the same network as the malware.\n\n • While the proxy plugin only uses\n Modbus, it turns out that the TM251 will route any protocol it receives (SSH, HTTP, etc.).\n\n\n###### 3\n\n\n-----\n\n## EVILSCHOLAR: Logic Corruption\n\n\n\n### • EVILSCHOLAR allows an operator to\n transfer files to the device.\n • Pull logic, modify it, and put it back\n on the controller.\n\n • This should be trivial provided the logic\n compiles to native assembly, and not an unknown bytecode.\n\n\n-----\n\n## SE Logic Corruption Result\n\n\n-----\n\n## SE Logic Corruption Takeaways\n\n\n\n##### • We can crash and manipulate logic on the controller, creating various error and output states.\n\n • In both cases, comms to the controller from the EWS are not possible without a power cycle.\n\n • If you connect to the PLC before the crash, or before the code starts, the PLC won’t let you retrieve the logic, only let you overwrite it. (EVILSCHOLAR can though!)\n\n • Outputs are not asserted to ‘FAIL SAFE’ values if the crash is triggered on the first execution cycle.\n\n\n-----\n\n## Wait where are the deets?\n\n\n\n#### • Reported the vulnerabilities to Schneider Electric and CODESYS Group on June 22.\n\n • Following responsible disclosure process.\n\n • Waiting on CVEs.\n\n\n-----\n\n###### BADOMEN\n\n\n###### Remote shell to interact with Omron controllers via Omron\n HTTP API and FINS protocol\n\n FORMAT: Python framework\n\n TARGETS: Omron equipment\n\n\n\n###### • Log into a PLC with a variety of methods.\n\n • Exploit telnet connections to the PLC to\n load a malware implant.\n\n • List directories of the PLC.\n\n • Upload, download, delete and execute\n files on the PLC.\n\n • Denial-of-service (DoS) attack against a PLC.\n\n • Terminate active PLC connections.\n\n • Scan and identify Omron devices using FINS\n (Factory Interface Network Service) protocol.\n\n • Interpret Omron device responses.\n\n • Collect PCAP on the OT network via uploaded\n TCPDUMP.\n\n • Manipulate Servos via EtherCat.\n\n • Creating, restoring, and decoding of system process\n and configuration files (possible ladder logic theft).\n\n • Change Operating Mode (Program -> Run).\n\n • Wipe the controller’s memory.\n\n\n-----\n\n## BADOMEN: Console\n\n\n\n###### • Console takes advantage of CVE-2022-34151(Hard-coded Credentials) to interact with an HTTP Server on the NX1P2 and other NJ-series devices\n\n • The server has various CGI endpoints (also used by SYSMAC studio) to manipulate and administer the device: “cpu.fcgi” and “ecat.fcgi”\n\n SYSMAC logic transfer\n\n\n-----\n\n## BADOMEN: Logic Corruption\n\n\n##### Backup & Transfer modules allow for retrieving & repackaging new logic.\n\n Test:\n\n###### 1. Use the Backup Module to retrieve logic.\n\n 2. Identify binary shared object and disassemble.\n\n 3. Change entrypoint function code with a branch to a bad address.\n\n 4. Repackage code.\n\n 5. Use Transfer Module to replace files on the controller.\n\n\n-----\n\n-----\n\n## Program Upload Fails\n\n\n###### This also prevents the engineer from enabling Program Mode\n\n\n-----\n\n## BADOMEN: Logic Corruption Confirmed\n\n\n\n### • Recovery?\n\n##### • Restore from SD Card fails, but allows\n you to enable Program mode\n\n • Then, factory reset.\n\n • Finally, you can restore logic to controller.\n\n### • Still under investigation:\n\n##### • Other methods of recovery.\n\n • What our code modification did to the controller.\n\n\n-----\n\n## BADOMEN: Servo Module Testing\n\n\n###### Devices Tested: NX1P2, R88D-1SN10F-ECT & R88D-1SN01L-ECT Servo Drives, & R88M-1M10030S-S2 AC Servo Motor\n\n • BADOMEN has a Servo Module for reading and writing Servo Drive parameters via EtherCat.\n\n • Servo Motor spins a shaft.\n\n • Servo Drive powers the motor, controls the motor, handles comms to the master PLC.\n\n • 1SN10F is a 380VAC to 480VAC drive. 1SN01L is a 100-120VAC Drive.\n\n • Verified that comms worked with the large drive, then switched to the small one.\n\n • No access to reliable source of three phase 480VAC\n\n • Using 120VAC greatly reduces risk of accidental electrocutions or arcing\n\n\n-----\n\n###### ETHERCAT SETUP\n\n\n###### BADOMEN\n\n\n-----\n\n## BADOMEN: Troublesome Parameters\n\n\n###### We disabled the following parameters:\n\n Excessive Velocity Deviation Detection (3B60.05) Warning Mask 1 selection (4020.01)\n\n Warning Mask 3 selection (4020.03) Position Detection Function -Following Error (3B50.05)\n\n\n###### We manipulated these:\n\n Excessive Speed Detection (3B60.04) Set Vibration Detection (3B70.01)\n\n\n###### Set to 1 stops the servo Set to max means 1.2x max speed\n\n Set this to max 500%\n\n\n-----\n\n## BADOMEN: Servo Logic Manipulation\n\n\n\n##### • Manipulating Parameters is interesting and likely more of a precursor to an attack.\n\n###### • Although spamming Excessive Speed Detection would be a bad day.\n\n##### • The NX1P2 stores the program that controls the servo drive.\n\n • We already know we can modify code on the device.\n\n • Can we modify code that controls the Servo’s RPM?\n\n\n-----\n\n## Step 1: Download Logic to the Device\n\n\n###### Step 0: Watch YouTube video on setting up Servo\n\n\n-----\n\n## Step 2: Grab Backup and Decompile\n\n\n###### Step 3: Patch args Step 4: Transfer to PLC\n\n\n-----\n\n-----\n\n## BADOMEN: Safety System Corruption\n\n\n\n##### • Even from the UI, it was clear that safety programming was a very separate process:\n\n###### • Doesn’t transfer logic the same way.\n\n • Put the controller in program mode, then debug stop. This transfers logic.\n\n • Then transition to Debug Run, followed by a Safety Validation.\n\n • Finally, the safety controller can enter run mode.\n\n\n-----\n\n###### SYSMAC Safety Program Download\n\n\n###### Safety Function\n\n\n## BADOMEN: Safety Program Download\n\n\n-----\n\n## BADOMEN: No support for Safety Programs\n\n\n\n##### • BADOMEN only supports the CPU and ECAT endpoints.\n\n • Safety Programming uses the NxBus endpoint.\n\n • There are no references to this endpoint in BADOMEN.\n\n • This is likely the next step development-wise for a full-fledged attack against a Servo.\n\n • (Unless the network is poorly configured.)\n\n\n-----\n\n-----\n\n## Real World Usage\n\n\n\n#### • These utilities can cause problems now.\n\n • But in our judgement, usage would look a lot like our MOUSEHOLE demo\n\n##### • IT intrusion to steal important process documentation\n\n • Use PIPEDREAM to recon plant network and find important PLCs that control key aspects of the target process\n\n • Use this knowledge to develop automated attack utilities to achieve a disruptive/destructive effect.\n\n\n-----\n\n-----\n\n## PIPEDREAM is a new escalation in mal dev\n\n\n\n##### • First time we’ve seen\n malware devs attempt a plugin framework for specific PLCs/Protocols.\n\n###### • ICSsploit and Metasploit “SCADA” aren’t quite the same.\n\n##### • ICS process agnostic.\n\n • Enables an operator\n to conduct recon and disruption.\n\n\n-----\n\n## Industry Improvements\n\n\n\n#### • Open up Protocols and Operating Systems.\n\n##### • We’re so behind vs IT Software and Internet Protocols.\n\n#### • EWS or separate vendor distributed utilities need to support forensics for IR and post-mortems.\n\n##### • The fact that SoMachine and Sysmac can’t pull a bad project file is an issue.\n • Vendors aren’t the only experts anymore.\n\n#### • Implement better integrity checking for running code. Don’t assume code always comes from the EWS!\n\n\n-----\n\n###### For mitigations: dragos.com/pipedream\n\n Jimmy Wylie jimmy@dragos.com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Jimmy%20Wylie%20-%20Analyzing%20PIPEDREAM%20Challenges%20in%20testing%20an%20ICS%20attack%20toolkit.pdf"
    ],
    "report_names": [
        "Jimmy%20Wylie%20-%20Analyzing%20PIPEDREAM%20Challenges%20in%20testing%20an%20ICS%20attack%20toolkit.pdf"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666859766,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1658538620,
    "ts_modification_date": 1658538620,
    "files": {
        "pdf": "https://archive.orkl.eu/a91919dc73ce07d914ae90aa54c54e08eae87fd1.pdf",
        "text": "https://archive.orkl.eu/a91919dc73ce07d914ae90aa54c54e08eae87fd1.txt",
        "img": "https://archive.orkl.eu/a91919dc73ce07d914ae90aa54c54e08eae87fd1.jpg"
    }
}