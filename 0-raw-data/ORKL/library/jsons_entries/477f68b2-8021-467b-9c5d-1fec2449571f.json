{
    "id": "477f68b2-8021-467b-9c5d-1fec2449571f",
    "created_at": "2023-01-12T15:06:07.315536Z",
    "updated_at": "2025-03-27T02:06:01.158393Z",
    "deleted_at": null,
    "sha1_hash": "e752f1244d37005a391a24762eae390ce8bc1815",
    "title": "2017-03-01 - GootKit Developers Dress It Up With Web Traffic Proxy",
    "authors": "",
    "file_creation_date": "2022-05-28T17:10:00Z",
    "file_modification_date": "2022-05-28T17:10:00Z",
    "file_size": 2260991,
    "plain_text": "# GootKit Developers Dress it Up With Web Traffic Proxy\n\n**[securityintelligence.com/gootkit-developers-dress-it-up-with-web-traffic-proxy/](https://securityintelligence.com/gootkit-developers-dress-it-up-with-web-traffic-proxy/)**\n\nMarch 1, 2017\n\n[Banking & Finance March 1, 2017](https://securityintelligence.com/category/topics/banking-financial-services-industry/)\nBy [Gadi Ostrovsky co-authored by Limor Kessem 6 min read](https://securityintelligence.com/author/gadi-ostrovsky/)\n\n\n-----\n\n[Discovered in summer of 2014, GootKit is widely considered one of the most sophisticated](https://exchange.xforce.ibmcloud.com/collection/GootKit-Ongoing-Research-Collection-422ab7991b937f35b89923f928b79702)\nbanking Trojans active in the wild. The malware is being used in online banking fraud attacks\non consumer and business accounts, mostly in the U.K. and other parts of Europe.\n\nIn this blog post, I will describe my analysis of a recent GootKit sample (MD5:\n60e079ec28d47ef85e93039c21afd19c) discovered by IBM X-Force research in January\n2017. The sample caught our attention when we realized that GootKit’s developers had\nmodified its architecture and changed the way it operates on the infected endpoints.\n\nMy research into GootKit’s inner workings unveiled its new network interception method,\nwhich now proxies internet traffic through the malware instead of placing hooks on the\nbrowser. GootKit also bypasses certificate validation by hooking other relevant APIs to\ncontinue its malicious operation unhindered.\n\n## GootKit Renovating the Architecture\n\nThe first and most significant change I noticed in recent GootKit samples is an architectural\nexpansion. In the past, GootKit operated on two principal modules:\n\n1. The Loader module, which was responsible for persistence, malware updates and the\n\ninjection of malicious code into the web browser and Windows OS processes; and\n2. The Main module, which was responsible for general malware functionality. This\n\nmodule is based on a node.js engine, bound with the malware’s code.\n\nThe Main module can be injected into a svchost process, at which point it acts as a master. It\ncan also be injected into a browser process and act as a slave, intercepting all network\ncommunications via the browser by hooking the NtDeviceIoControlFile API. The\n[NtDeviceIoControlFile service is a device-dependent interface that extends the control that](https://msdn.microsoft.com/en-us/library/ms648411%28v=vs.85%29.aspx)\napplications have over various devices within the system. This API provides a consistent\nview of the input and output data to the system while still providing the application and the\ndriver a device-dependent method of specifying a communications interface.\n\nThat two-module setup has changed. Recent samples we collected in 2017 feature three\nmodules instead of two:\n\n1. The Loader module, which has the same purpose;\n2. The Main module, named node32.dll by GootKit’s developers, which handles the\n\nmalware’s functionality, is based on the same node.js engine and implements the\noverall functionality in JavaScript code; and\n3. The Browser injection module, a recent addition to GootKit’s modular architecture that\n\nis responsible for network interception and access to the browser.\n\nGootKit now uses this module to redirect internet traffic through its own Main module instead\nof letting it flow directly from the browser.\n\n\n-----\n\n[Read the white paper: How to outsmart Fraudsters with Cognitive Fraud Detection](https://www-01.ibm.com/marketing/iwm/dre/signup?source=mrs-form-9451&S_PKG=ov54550)\n\n## A Modified Deployment Flow\n\nGootKit changes the way it deploys on infected endpoints and the inner workings of its\noperations. In the sample I analyzed for this post, GootKit is fetched by a dropper. As the\ndroppee, it is run from an already-established persistence mechanism that was set up by its\nloader.\n\nGootKit’s recently updated persistence is achieved through a Group Policy Object (GPO)\nentry in the Windows Registry. Group Policies control the user’s working environment, and\nGootKit abuses this feature to launch whenever the computer boots up. Most financial\nmalware families set a RunKey in the Registry, but GootKit has changed that scheme, likely\nto [avoid automated detection rules.](https://securityintelligence.com/gootkit-bobbing-and-weaving-to-avoid-prying-eyes/)\n\nNext, GootKit creates a mstsc.exe process in suspended state and injects the Loader\nmodule into it. This process, also known as Remote Desktop Connection (RDC), is the client\napplication for remote desktop services. It allows a user to remotely log into a networked\ncomputer running the terminal services server.\n\nThe mstsc process, in turn, runs a svchost.exe process and injects the Loader module into\nsvchost. Next, the Main module is loaded from the svchost process.\n\nThe malware’s binaries are stored in the following Windows registry keys:\nHKCU\\Software\\AppDataLow\\binaryImage32_0 to\nHKCU\\Software\\AppDataLow\\binaryImage32_7.\n\n## GootKit as Its Own Internet Traffic Proxy\n\nUpon launching the malware, the Main module begins to set up a proxy server on the\ninfected machines, utilizing GootKit’s new browser injection module.\n\nTwo functions implemented by GootKit within its node.js engine are being used here:\nSpInitializeStandaloneMitm and RandomListenPortBase. Using a malicious JavaScript\nfunction, SpInitializeStandaloneMitm, the malware creates a proxy for both HTTP and\nHTTPS traffic on the [infected endpoint.](https://www.ibm.com/software/products/en/trusteer-apex-adv-malware)\n\nGootKit uses the RandomListenPortBase function to specify the standard port choice for its\ntraffic. HTTP traffic will route via port 80 and HTTPS via port 443. As for the listening port,\nwhich is typically randomly selected in the 1024 to 5000 range, GootKit’s hardcoded choice\nis port 6000.\n\n_Figure 1: JavaScript code used for GootKit’s proxy server setup_\n\nNote that the next function called is Initialize Certificate Faker\n\n\n-----\n\n## Overcoming the Browser s Certificate Verification Flags\n\nUpon the creation of a new browser process on the infected endpoint, the Loader module\ninjects the Browser module into that process. The Browser module will, in turn, hook two\ntypes of APIs.\n\n1. Network APIs responsible for connection creations:\n\n1. mswsock.dllMSAFD_ConnectEx API (the mswsock.dll is a module providing\n\nextensions for Winsock; services provided by this file are not part of Winsock);\nand\n2. mswsock.dll WSPConnect API.\n2. Certificate validation APIs:\n\n1. crypt32.dll CertVerifyCertificateChainPolicy API; and\n2. crypt32.dll CertGetCertificateChain API.\n\nThese hooks enable GootKit to redirect the internet traffic through its own module and switch\nup the OS flag for an invalid certificate with a valid one, thus disabling any error alerts from\nthe browser.\n\n## Redirecting Through the GootKit Proxy\n\nWhen a new connection is initiated in the browser, GootKit’s hooks change the endpoint’s IP\naddress and the listening port number to those predefined by GootKit earlier on. GootKit\nuses its hooks on MSAFD_ConnectEx and WSPConnect to check that the traffic type is\nrelevant (TCP/IP). It looks at the header to ensure that sockaddr struct shows the number\n16, which is the maximum length for nonhybrid structures in IPv4 addresses:\n\n_Figure 2_\n\n_Figure 3_\n\nThe next verification has to do with the modification of the endpoint’s IP address from an\nexternal IP to a local one. GootKit checks that the sa_family is indeed AF_INET, which\nrepresents the internet protocol address format.\n\n_Figure 4: Sockaddr and SA_Family setup_\n\nGootKit modifies the endpoint’s remote IP address to the local home IP (127.0.0.1) and\nswitches the Transmission Control Protocol (TCP) port to its own selection based on a static\nvalue, to which it adds the original TCP port number.\n\n_Figure 5: The HEX value 0x100007F translates into the home IP address 127.0.0.1_\n\nThe TCP listening port is also changed:\n\n\n-----\n\n_Figure 6_\n\nThe value 1770h translates to port number 6000.\n\n## Faking the Certificate Flag\n\nSince traffic from the user to the bank is routed through the GootKit proxy at this point,\nGootKit’s developers ensured that Secure Sockets Layer (SSL) error messages don’t pop up\nand raise the victim’s suspicion. To fake the validity flag, GootKit hooks a couple of APIs.\n\nThe first is called CertGetCertificateChain. This hook will ensure that every result returned\nfrom PCERT_CHAIN_CONTEXT with a pPolicyStatus parameter will change the flag to\nreflect a valid certificate (set to 0):\n\n**TrustStatus.dwErrorStatus to CERT_TRUST_NO_ERROR and**\n**TrustStatus.dwInfoStatus set to 0.**\n\n_Figure 7_\n\nThe second API hooked for this purpose is CertVerifyCertificateChainPolicy. Here, too,\nGootKit updates the PCERT_CHAIN_POLICY_STATUS error result to 0 for a valid\ncertificate.\n\n_Figure 8_\n\n## Conclusion\n\nGootKit’s developers are evidently still working on this malware project, enhancing its\nevasion techniques and its ability to control what victims see when they browse to their\nbank’s website. This recent development in GootKit’s operations on infected machines is\nconsistent with the advanced, technical nature of this malware project.\n\nOf attacks detected by IBM X-Force in the past year, GootKit was the most active in Europe\nin 2016, with configurations targeting the U.K., France and Italy. Per X-Force data, GootKit\n[ranks eighth on the global list of the most active financial malware families per attack](https://securityintelligence.com/is-financial-malware-breaking-the-bank/)\nvolume. Although it is very sophisticated, it keeps its infection and attack campaigns small\nand focused, which helps it fly under the radar and avoid detection.\n\n_Figure 9: Most prevalent global financial malware families per attack volume (Source: IBM_\n_Security, 2017 YTD)._\n\n\n-----\n\n[Read the white paper: How to outsmart Fraudsters with Cognitive Fraud Detection](https://www-01.ibm.com/marketing/iwm/dre/signup?source=mrs-form-9451&S_PKG=ov54550)\n\n[Gadi Ostrovsky](https://securityintelligence.com/author/gadi-ostrovsky/)\nMalware Researcher, IBM\n\nGadi Ostrovsky is one of the top security researchers at IBM Security’s Trusteer group. He\njoined the company in 2014, coming from a deep technical backgro...\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-03-01 - GootKit Developers Dress It Up With Web Traffic Proxy.pdf"
    ],
    "report_names": [
        "2017-03-01 - GootKit Developers Dress It Up With Web Traffic Proxy.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535967,
    "ts_updated_at": 1743041161,
    "ts_creation_date": 1653757800,
    "ts_modification_date": 1653757800,
    "files": {
        "pdf": "https://archive.orkl.eu/e752f1244d37005a391a24762eae390ce8bc1815.pdf",
        "text": "https://archive.orkl.eu/e752f1244d37005a391a24762eae390ce8bc1815.txt",
        "img": "https://archive.orkl.eu/e752f1244d37005a391a24762eae390ce8bc1815.jpg"
    }
}