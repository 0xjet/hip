{
    "id": "d10dabf1-f645-4e4f-85b6-18075f1e31e3",
    "created_at": "2023-01-12T15:09:18.18373Z",
    "updated_at": "2025-03-27T02:08:00.052578Z",
    "deleted_at": null,
    "sha1_hash": "3a282abc22392ee8ce4aac8fe0dd7e1b53717350",
    "title": "2021-11-16 - Office Documents- May the XLL technique change the threat Landscape in 2022-",
    "authors": "",
    "file_creation_date": "2022-05-28T15:44:22Z",
    "file_modification_date": "2022-05-28T15:44:22Z",
    "file_size": 2192870,
    "plain_text": "# Office Documents: May the XLL technique change the threat Landscape in 2022?\n\n**[yoroi.company/research/office-documents-may-the-xll-technique-change-the-threat-landscape-in-2022/](https://yoroi.company/research/office-documents-may-the-xll-technique-change-the-threat-landscape-in-2022/)**\n\nNovember 16, 2021\n\n11/16/2021\n\n## Introduction\n\nContrasting the malware delivery is hard. Cyber attackers evolve their techniques frequently, but a\nmajor trend remained constant: Microsoft Office and Excel documents represent the favorite delivery method many cyber criminals\nuse to inoculate malware into private and public companies. This technique is extremely flexible and both opportunistic and APT actors abuse\nit.\n\nIn the last months, we monitored with particular attention several attack waves adopting a new delivery technique: binary libraries directly\nloaded by Microsoft Excel, just in one click. This emergent delivery technique leverages XLL files, a particular file type containing a Microsoft\nExcel application ready to be loaded.\n\nThis Microsoft Office exploitation method is silently abused in many attack waves around the world, but recently, this new emergent technique\n**landed in Italy too. In fact, we observed cybercriminal campaigns leveraging XLL files against manufacturing companies.**\n\nFor this reason, the Yoroi Malware ZLab decided to dig inside this technique providing a bird view of the evolution of\nmalicious office file techniques and a detailed analysis of this new method abused by cyber-criminals.\n\n## Technical Analysis\n\n The Timeline\n\nBefore 2017, the most email-based attacks were based on VBA macro weaponized Office documents. The VBA macro scripts are legit tool\nallowing users to automatize some elementary operations in complex documents. However, due to that capability to execute code, attackers\ncreate obfuscated payloads to download and execute other malicious stages.\n\nIn 2017, two critical exploits were released to the public, and attackers extensively adopted it in widespread spam campaigns. : CVE-20170199 and CVE-2017-11882:\n\nCVE-2017-0199 allows an attacker to download and execute malicious HTA files from the internet, due to a flaw in the handling and\nparsing of OLE Objects inside the malicious document. We tracked that vulnerability inside an old blog post, Playing Cat and Mouse:\nThree Techniques Abused to Avoid Detection - Yoroi\n\n\n-----\n\nC 0 88 s a e ote code e ecut o u e ab ty a o g t e attac e to e ecute a s e code e bedded s de t e a c ous\ndocument, due to a flaw in memory handling of the Equation Editor component, present inside of all Office applications. We tracked this\ntechnique in many reports, and we noticed that it has been used for many years thanks to its adaptability through malware operations. It\nwas used both in APT and cybercrime operations.\n\nThen, between 2018 and 2020, we observed new spikes of VBA macro adoption in malicious documents. In this period, the attackers improved\nin an intensive way the obfuscation of the payloads, adding a large number of intermediate dropping stages, composed by many different\ntypes of technologies and scripts.\n\nIn the beginning of 2020, many attackers started to adopt a new technique, the exploitation of the XLM Macro 4.0 scripts, a legacy technology\npresent in Microsoft Office since 1992 and compatible from Windows 3.1 to the newest versions.\n\nThe recent analysis and detections revealed that this kind of scripts are extremely effective in evading antivirus detection. So, malware writers\ndecided to improve this technique creating a hybrid approach combining the usage of both XLM macro and VBA ones as well. That behavior\nboosted and it is widely used since today.\n\nAlong the XLM and classic macros, in the middle of 2021 something is changing: threat actors are starting to use the XLL files.\n\n\n-----\n\n## The XLL Dropper\n\nA malicious attack using abusing the XLL vector starts with the delivery of a malicious file with the extension “XLL”.\n\nIt is the Excel Add-In file, that provides a way to use third-party tools and functions within Microsoft Excel. The third-party code can\nbe C/C++ .NET code inside the Excel environment. In fact, despite the Excel icon, the XLL file is a Dynamic Linked Library, a binary executable\nfile.\n\nFor instance, the XLL sample file has the following static information:\n\n**Hash** 994013d66ae20cfa4ef1097d73481b00a672131d0de44d79a04ff12f492aae55\n\n**Threat** XLL Dropper\n\n**Brief Description** Malicious XLL file, dropping several payloads\n\n**SSDEEP** 12288:70Ws7IMtR4yVld8bzbBSreqhgFK/UqWdP:70bdkX1CcLd\n\nTable 1: Static information about the sample\n\n[The sample has been weaponized by using the open-source tool named Excel-DNA available on GitHub, it works adding an executable](https://github.com/Excel-DNA/ExcelDna)\nresource inside the file compressed with LZMA algorithm.\n\nFigure 1: Static information of the EXCEL-DNA component and relative manual extraction\n\nThe retrieval of the payload can be performed manually by extracting the resource using an archive manager tool compatible with LZMA\nalgorithm. In detail, the payload is stored in the PE resource with the properties \"Assembly LZMA\", so we were able to extract it and\ndecompress it.\n\nFigure 2: Extraction of .xll file\n\n## The DLL payload\n\nThe payload executed inside the XLL file is another DLL file, having the following static information:\n\n**Hash** 8f9dcf822dd8f22dd3c21f0798e97554a24b05a0fa3065d2580933ff4af29a6d\n\n**Threat** .NET dll embedded payload\n\n**Brief Description** Payload contained inside the XLL file.\n\n**SSDEEP** 96:mFCZXPFomsKQrdLVaBlP1WiGxB7BHjA5ASDBmq9:mFCIvKQrnanQ39HjA2on\n\nTable 2: Static information about the sample\n\nThe goal of this payload is the download and execution of two other payloads from the internet. The DropURLs are obfuscated through a\nseries of simple characters manipulations, as shown in the following screen:\n\n\n-----\n\nFigure 3: Decoding the first DropURL\n\nAfter decoding the URL, we obtained a link pointing to the Discord Content Delivery Network, widely used by cyber criminals to deliver\nmalware. The link were not easily readable in during the static inspection because it is stored in an obfuscated manner. Once decrypted with\na XOR-like function, named by the malware writer “onetimepass” it becomes readable.\n\nThis decryption function is then used also to decode the second payload shows the same behavior.\n\nFigure 4: First Encrypted Payload\n\nFigure 5: XOR Decryption Function\n\nFigure 6: Second Encrypted Payload\n\nOnce the two payloads have been decoded, they are loaded in memory with the reference to the legit process path\n“aspnet_regbrowsers.exe”. Now, the malware has prepared all the environment for the next stage of the infection, the injection phase.\n\n\n-----\n\nFigure 7: Decoding the payloads\n\n## The Injection Module\n\nLike most crimeware, it adopts the injection self-defense technique, inoculating the malicious code inside one of the legit processes of the\nMicrosoft Windows environment.\n\nThe two components isolated in the previous phase have this purpose, one of them is the injection code, the other is the payload to inject\ninside a target process.\n\nHash 2f4dede7501c5e406ba8063dc53c48199620197a3c925fdf193dd5134749791e\n\nThreat DLL Loader\n\nBrief Description Injects (Process Hollowing) the first payload in aspnet_regbrowsers.exe\n\nSSDEEP 1536:JKb0LsDiNcDWJ6BFwwQXXGBtFa3prSXqTNETV+kNgJ5PqNslOYu:JSeNMBA2bFa5wT9NgpA\n\nTable 3: Static information about the sample\n\nThe payload contained inside the “array[2]” variable array is immediately decoded from Base64 and loaded in\nmemory thanks to the “Assembly.Load” .NET routine.\n\nFigure 8: Payload loaded in memory\n\nThe just loaded dll invokes the method “WeatherApp”, which accepts three arguments: the path of aspnet_regbrowsers.exe,an empty string\nand the first payload (array[0]). This module is an additional DLL loaded with process hollowing techniques.\n\n\n-----\n\nFigure 9: Classic Process Hollowing into aspnet_regbrowsers.exe\n\n**The Payloads**\n\nSince its initial distribution, we monitored the malicious drop urls to track any changes to the delivery infrastructure. We tracked a series of XLL\nfiles having the same behavior and they leverage Discord CDN to vehicolate other different payloads. The first one is AgentTesla.\n\n**Hash** 50d645e57a915baf4db98b6476681dce65d809e84f2c72eff0d6db4b10fd28d0\n\n**Threat** AgentTesla Stealer\n\n\n**Brief**\n**Description**\n\n\nObfuscated AgentTesla\n\n\n**SSDEEP** 3072:Q9Wgl88xIaXntoTAKeNGUsE1M+IJkE0oU6btrJ58low2wefpxSqL8cQWxQq8E3zH:QzVtok0UY+qkR298lrmv4HWsE3z6UJ\n\nTable 4: Static information about the sample\n\nWe were able to immediately identify the main routine of this sample. In the following screen we show the main method and a piece of the\ntarget applications found by AgentTesla to perform its operations of exfiltration.\n\nFigure 10: AgentTesla Stealing Function\n\nBesides that sample, we retrieved other XLL samples having the same infection chain and it is a Formbook/XLoader payload, having the\nfollowing static information:\n\n**Hash** 64a668add3d7f3bbcc0ef6acb25529c70df773d74e7e17a4a8fd8c95e81ee8bd\n\n**Threat** Formbook\n\n**Brief Description** Formbook payload retrieved in a second time from the dropurl\n\n**SSDEEP** 3072:W7psS2npp9ymO/pw4imY0bXkN6edhTDYEUvCJ6Trad+:Wu/emIpwdrTN6edhvYdg6fR\n\nTable 11: Static information about the sample\n\nAfter an intensive debugging session, we isolated the routine aimed at decoding the shellcode to be injected into explorer process, as reported\n[also by Fortinet.](https://www.fortinet.com/blog/threat-research/deep-analysis-formbook-new-variant-delivered-phishing-campaign-part-ii)\n\n\n-----\n\nFigure 12: Shellcode injected in explorer routine\n\n**Hash** 7f1f224a14a2e412a8c22535fc584c31bbcfe41241eb794c605c91987996d62e\n\n**Threat** Dridex\n\n\n**Brief**\n**Description**\n\n\nDridex dropper\n\n\n**SSDEEP** 768:ceQJmg+fxfveZ5RI3dO1+IpwY5xW04HPJ4hLqm9NdUPhnutmbX+NFw2WP0t9gE53:6f+f9eZzx++5SHhQ+qTciMIgAmw\n\nWe also found another interesting campaign hitting Italy and leveraging the XLL file-format. This time, it implements the “xlAutoOpen” export\nfunction in native C++ language, executing the malicious code in a similar manner of the “AutoOpen” function in the canonic VBA Macro.\n\nThis dropper downloads a second payloand: a dll file able to load Dridex malware.\n\nFigure 13: Dridex XLL dropper\n\n\n-----\n\n## Conclusion\n\nDelivering malware through weaponized Microsoft Office files is incredibly effective from the attacker perspective, so,\nnew delivery techniques and the evolution of the strategies abused to inoculate malicious code inside company assets through this vector is a\nserious risk.\n\nMonitoring and responding to new, emergent cyber-criminal trend is key part of what we do in Yoroi’s Malware ZLAB, ensuring intelligent and\nadaptive protection to Yoroi customers. The increasing adoption of XLL files in Excel based attack campaigns is a warning signal telling\nus that cyber offenders are evolving to ensure their damage capabilities, pointing us in the direction to forecast new potential explosion\nof diversified malicious email waves in 2022.\n\n## Indicator of Compromise\n\nHash:\n\n994013d66ae20cfa4ef1097d73481b00a672131d0de44d79a04ff12f492aae55\n8f9dcf822dd8f22dd3c21f0798e97554a24b05a0fa3065d2580933ff4af29a6d\n2f4dede7501c5e406ba8063dc53c48199620197a3c925fdf193dd5134749791e\n50d645e57a915baf4db98b6476681dce65d809e84f2c72eff0d6db4b10fd28d0\nC011cd7891e9668deaf83ebf396132d5ada8d8510a1d6853af748432a5280911\n64a668add3d7f3bbcc0ef6acb25529c70df773d74e7e17a4a8fd8c95e81ee8bd\n2bebba83d0caec961116d39f9f52dbb2277c937ceef88326b34b646de3763fd0\n\nDropurl\n\nhxxps://cdn.discordapp.com/attachments/899351847805018123/899351889978748958/ascii.]txt\nhxxps://cdn.discordapp.com/attachments/901544852150427722/901953881720901683/tSq3sp.]txt\nhxxps://cdn.discordapp.com/attachments/897597296584298507/897960862311120917/Wiovms.]txt\n\nC2 (AgentTesla SMTP):\n\nsales[@[bswaterenergy[.com\nlnfo[@[aothailand[.com\n\nC2 (Formbook):\n\nart-space[.xyz/c8te/\n\n## Yara Rules\n\n\n-----\n\n```\n{\nmeta: \ndescription = “Yara rule for generic x32 xll files” \nauthor = “Yoroi Malware ZLab” \nlast_updated = “2021-05-11” \ntlp = “white” \ncategory = “informational” \nstrings: \n $STR1 = { 56 57 33 ff 80 3d ?? ?? ?? ?? 00 74 ?? 8b 15 ?? ?? ?? ?? 85 d2 75 ?? e8 ?? ?? ?? ?? 8b f0 8b ce e8 ?? ?? ?? ?? 8b 15\n?? ?? ?? ?? 0f b6 c0 66 85 c0 0f 45 d6 89 15 ?? ?? ?? ?? 74 ?? 8b 42 10 85 c0 74 09 ff d0 c6 05 ?? ?? ?? ?? 01 e8 ?? ?? ?? ?? a1 ??\n?? ?? ?? 85 c0 75 ?? e8 ?? ?? ?? ?? 8b f0 8b ce e8 ?? ?? ?? ?? 0f b6 c8 a1 ?? ?? ?? ?? 66 85 c9 0f 45 c6 a3 ?? ?? ?? ?? 74 ?? 8b 40\n08 85 c0 74 ?? ff d0 0f b7 f0 e8 ?? ?? ?? ?? 5f 66 8b c6 c6 05 ?? ?? ?? ?? 00 c6 05 ?? ?? ?? ?? 01 5e c3 } \n//             xlAutoOpen   proc near        \n// 56                   push  esi \n// 57                   push  edi \n// 33 FF                  xor   edi, edi \n// 80 3D A2 F2 06 10 00          cmp   byte_1006F2A2, 0 \n// 74 44                  jz   short loc_1003B081 \n// 8B 15 A4 F2 06 10            mov   edx, dword_1006F2A4 \n// 85 D2                  test  edx, edx \n// 75 25                  jnz   short loc_1003B06C \n// E8 34 02 00 00             call  sub_1003B280 \n// 8B F0                  mov   esi, eax \n// 8B CE                  mov   ecx, esi \n// E8 CB 26 00 00             call  sub_1003D720 \n// 8B 15 A4 F2 06 10            mov   edx, dword_1006F2A4 \n// 0F B6 C0                movzx  eax, al \n// 66 85 C0                test  ax, ax \n// 0F 45 D6                cmovnz edx, esi \n// 89 15 A4 F2 06 10            mov   dword_1006F2A4, edx \n// 74 10                  jz   short loc_1003B07C \n// \n//             loc_1003B06C:              \n// 8B 42 10                mov   eax, [edx+10h] \n// 85 C0                  test  eax, eax \n// 74 09                  jz   short loc_1003B07C \n// FF D0                  call  eax \n// C6 05 A1 F2 06 10 01          mov   byte_1006F2A1, 1 \n// \n//             loc_1003B07C:              \n//                                 \n\n```\n\n-----\n\n```\n// \n//             loc_1003B081:              \n// A1 A4 F2 06 10             mov   eax, dword_1006F2A4 \n// 85 C0                  test  eax, eax \n// 75 23                  jnz   short loc_1003B0AD \n// E8 F1 01 00 00             call  sub_1003B280 \n// 8B F0                  mov   esi, eax \n// 8B CE                  mov   ecx, esi \n// E8 88 26 00 00             call  sub_1003D720 \n// 0F B6 C8                movzx  ecx, al \n// A1 A4 F2 06 10             mov   eax, dword_1006F2A4 \n// 66 85 C9                test  cx, cx \n// 0F 45 C6                cmovnz eax, esi \n// A3 A4 F2 06 10             mov   dword_1006F2A4, eax \n// 74 25                  jz   short loc_1003B0D2 \n// \n//             loc_1003B0AD:              \n// 8B 40 08                mov   eax, [eax+8] \n// 85 C0                  test  eax, eax \n// 74 1E                  jz   short loc_1003B0D2 \n// FF D0                  call  eax \n// 0F B7 F0                movzx  esi, ax \n// E8 A2 00 00 00             call  sub_1003B160 \n// 5F                   pop   edi \n// 66 8B C6                mov   ax, si \n// C6 05 A1 F2 06 10 00          mov   byte_1006F2A1, 0 \n// C6 05 A2 F2 06 10 01          mov   byte_1006F2A2, 1 \n// 5E                   pop   esi \n// C3                   retn \ncondition: \n $STR1 and uint16(0) == 0x5A4D \n}\nrule malicious_dll \n{\nmeta: \ndescription = “Yara rule for the malicious dll file extracted from a xll file” \nauthor = “Yoroi Malware ZLab”\n\n```\n\n-----\n\n```\nlast_updated = “2021-05-11” \ntlp = “white” \ncategory = “informational” \nstrings: \n$bytes_1 = { 00 02 0E 0E 0E } \n$bytes_2 = { 17590C2B17070608 } \n$bytes_3 = { 0817590C081530E5 } \n$bytes_4 = { 072A??026F1?0000 } \n$bytes_5 = { 6A72??0?0070280? } \n$mscoree = { 6D 73 63 6F 72 65 65 2E 64 6C 6C } \ncondition: \nall of them and uint16(0) == 0x5A4D and filesize < 20KB \n}\n\n```\n_This blog post was authored by Luigi Martire, Carmelo Ragusa and Luca Mella of Yoroi Malware ZLAB._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-16 - Office Documents- May the XLL technique change the threat Landscape in 2022-.pdf"
    ],
    "report_names": [
        "2021-11-16 - Office Documents- May the XLL technique change the threat Landscape in 2022-.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536158,
    "ts_updated_at": 1743041280,
    "ts_creation_date": 1653752662,
    "ts_modification_date": 1653752662,
    "files": {
        "pdf": "https://archive.orkl.eu/3a282abc22392ee8ce4aac8fe0dd7e1b53717350.pdf",
        "text": "https://archive.orkl.eu/3a282abc22392ee8ce4aac8fe0dd7e1b53717350.txt",
        "img": "https://archive.orkl.eu/3a282abc22392ee8ce4aac8fe0dd7e1b53717350.jpg"
    }
}