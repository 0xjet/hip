{
    "id": "7714edd8-bc74-4d0b-9633-f52bee36d0ee",
    "created_at": "2023-01-12T15:09:44.466796Z",
    "updated_at": "2025-03-27T02:09:07.826627Z",
    "deleted_at": null,
    "sha1_hash": "c1f9f0d2d77c1b350c7195058c7ac7bed463957a",
    "title": "2020-07-28 - Watch Your Containers- Doki Infecting Docker Servers in the Cloud",
    "authors": "",
    "file_creation_date": "2022-05-28T00:42:30Z",
    "file_modification_date": "2022-05-28T00:42:30Z",
    "file_size": 651236,
    "plain_text": "# Watch Your Containers: Doki Infecting Docker Servers in the Cloud\n\n**[intezer.com/container-security/watch-your-containers-doki-infecting-docker-servers-in-the-cloud/](https://www.intezer.com/container-security/watch-your-containers-doki-infecting-docker-servers-in-the-cloud/)**\n\nJuly 28, 2020\n\nWritten by [Nicole Fishbein and](https://www.intezer.com/author/nicolefishbein/) [Michael Kajiloti - 28 July 2020](https://www.intezer.com/author/mkajiloti/)\n\n## Get Free Account\n\nJoin Now\n\n**Key Findings**\n\n[Ngrok Mining Botnet is an active campaign targeting exposed Docker servers in](https://blog.netlab.360.com/a-new-mining-botnet-blends-its-c2s-into-ngrok-service/)\nAWS, Azure, and other cloud platforms. It has been active for at least two years.\n\nWe have detected a recent attack which includes a completely undetected Linux\nmalware and a previously undocumented technique, using a blockchain wallet\nfor generating C&C domain names.\n\nAnyone with publicly open Docker API access is at high risk to be hacked within\nthe span of just a few hours. This is probable due to the hackers’ automated and\ncontinuous internet-wide scanning for vulnerable victims.\n\nThe new malware, dubbed “Doki”, hasn’t been detected by any of the 60\nmalware detection engines in VirusTotal since it was [first analyzed on January](https://www.virustotal.com/gui/file/4aadb47706f0fe1734ee514e79c93eed65e1a0a9f61b63f3e7b6367bd9a3e63b/detection)\n14 2020\n\n\n-----\n\nThe attacker is using the infected victims to search for additional vulnerable\ncloud servers.\n\n**Introduction**\n\nLinux threats are becoming more common. A contributing factor to this is the increasing\nshift and reliance on cloud environments, which are mostly based on Linux infrastructure.\nHence, attackers have been adapting accordingly with new tools and techniques designed\nspecifically for this infrastructure.\n\nA technique that has become popular is the abuse of misconfigured Docker API ports,\nwhere attackers scan for publicly accessible Docker servers and exploit them in order to set\nup their own containers and execute malware on the victim’s infrastructure.\n\nOne of the longest ongoing attack campaigns exploiting Docker API ports is the Ngrok\n[Botnet, previously reported on by researchers at Netlab and](https://blog.netlab.360.com/a-new-mining-botnet-blends-its-c2s-into-ngrok-service/) [Trend Micro. As part of the](https://blog.trendmicro.com/trendlabs-security-intelligence/exposed-docker-control-api-and-community-image-abused-to-deliver-cryptocurrency-mining-malware/)\nattack, the attackers abuse Docker configuration features in order to elude standard\ncontainer restrictions and execute various malicious payloads from the host. They also\ndeploy a network scanner and use it to scan the cloud providers’ IP ranges for additional\npotentially vulnerable targets. Our evidence shows that it takes only a few hours from when\na new misconfigured Docker server is up online to become infected by this campaign.\n\nRecently, we have detected a new malware payload that is different from the standard\ncryptominers typically deployed in this attack. The malware is a fully undetected backdoor\nwhich we have named Doki.\n\nDoki uses a previously undocumented method to contact its operator by abusing the\nDogecoin cryptocurrency blockchain in a unique way in order to dynamically generate its C2\ndomain address. The malware has managed to stay under the radar for over six months\ndespite samples being publicly available in VirusTotal.\n\nIn this article we will cover the attack and provide a detailed analysis of the techniques that\nwere implemented by the undetected Doki backdoor.\n\n**The Attack**\n\nThe threat is targeting misconfigured containerized environments in the cloud. The\nattackers scan for publicly accessible Docker API ports and exploit them in order to set up\ntheir own containers and execute malware on the victims’ infrastructure. The attackers are\nspawning and deleting a number of containers during this attack.\n\nEach container that is created during the attack is based on an alpine image with curl\n[installed. The image is available on the Docker hub. The image is not malicious but rather](https://hub.docker.com/r/byrnedo/alpine-curl/tags/)\nit’s being abused to carry out malicious activities. By using an image that contains the curl\nsoftware, curl commands are executed as soon as the container is up and running.\n\n\n-----\n\nThe advantage of using a publicly available image is the attacker doesn t need to hide it on\nDocker hub or other hosting solutions. Instead, the attackers can use an existing image and\nrun their own logic and malware on top of it.\n\nAs mentioned above, attackers can create any container, however, to execute code from\nthe hosting machine they must use a container escape method. The technique is based on\n[the creation of a new container, accomplished by posting a ‘create’ API request. The body](https://docs.docker.com/engine/api/v1.40/#operation/ContainerCreate)\nof the request contains configuration parameters for the container. One of the parameters is\n[bind which lets the user configure which file or directory on the host machine to mount into](https://docs.docker.com/storage/bind-mounts/)\na container.\n\nContainers that are created during the attack are configured to bind /tmpXXXXXX directory\nto the root directory of the hosting server. This means every file on the server’s filesystem\ncan be accessed and even modified, with the correct user permissions, from within the\ncontainer.\n\n[Ngrok is a service which provides secure tunnels to connect between local servers and the](https://ngrok.com/)\npublic internet. The attacker abuses Ngrok to craft unique URLs with a short lifetime and\nuses them to download payloads during the attack by passing them to the curl based\nimage. The downloaded payload is saved in /tmpXXXXXX directory in the container.\n\nThe command that created the container as seen on the syslog of the attacked server\n\nBy using the bind configuration the attacker can control the cron utility of the host.\n\nThe attacker modifies the host’s cron to execute the downloaded payload every minute. We\nobserved two types of payloads, one is a network scanner script and the other is a\ndownloader script.\n\n\n-----\n\nThe network scanner uses zmap, zgrap, and jq to scan ports associated with Redis,\nDocker, SSH, and HTTP.\n\nUsing a list of hardcoded ranges of IP addresses, which belong mostly to cloud servers\nsuch as AWS and local cloud providers in foreign regions (we have seen providers from\nChina, Austria, and the United Kingdom), the script gathers the information and uploads it to\nanother Ngrok URL.\n\nThe downloader script is responsible for downloading and installing various malware\nbinaries, often one of several well known cryptominers. We have noticed it can also install a\nfully undetected malware component. We named this malware Doki and will provide a\ntechnical analysis in the next section.\n\nThe attacker has full control over the configuration of the container he creates and the files\nthat are dropped into the container. By using legitimate API commands, the attacker is able\nto escape from the container he created and execute any code from within the server itself.\n\n**The Doki Malware**\n\n\n-----\n\nDoki is a backdoor for Linux which function is to execute code received from its operators.\n[The malware utilizes the DynDNS service and a unique Domain Generation Algorithm](https://account.dyn.com/)\n(DGA) based on the Dogecoin cryptocurrency blockchain in order to find the domain of its\nC2 in real time.\n\nThe malware is a fully undetected backdoor. It has managed to stay undetected for over six\n[months despite having been uploaded to VirusTotal on January 14, 2020 and scanned](https://www.virustotal.com/gui/file/4aadb47706f0fe1734ee514e79c93eed65e1a0a9f61b63f3e7b6367bd9a3e63b/detection)\nmultiple times since.\n\nDoki is multi-threaded and uses the embedTLS library for cryptographic functions and\nnetwork communication. When executed, the malware will create a seperate thread in order\nto handle all C2 communications.\n\nThe malware starts by generating a C2 domain using its unique DGA. In order to construct\nthe C2 address the malware performs the following steps:\n\n1. Query dogechain.info API, a Dogecoin cryptocurrency block explorer, for the value\n\nthat was sent out (spent) from a hardcoded wallet address that is controlled by the\nattacker. The query format is: https://dogechain.info/api/v1/address/sent/{address}\n2. Perform SHA256 on the value returned under “sent”\n3. Save the first 12 characters from the hex-string representation of the SHA256 value,\n\nto be used as the subdomain.\n4. Construct the full address by appending the subdomain to ddns.net. An example\n\ndomain would be: 6d77335c4f23[.]ddns[.]net\n\n\n-----\n\nUsing this technique the attacker controls which address the malware will contact by\ntransferring a specific amount of Dogecoin from his or her wallet. Since only the attacker\nhas control over the wallet, only he can control when and how much dogecoin to transfer,\nand thus switch the domain accordingly. Additionally, since the blockchain is both immutable\nand decentralized, this novel method can prove to be quite resilient to both infrastructure\ntakedowns from law enforcement and domain filtering attempts from security products.\n\nIt’s worth noting that once the domain is generated, the malware ensures it’s not\n“46927e019820”, which is what’s generated for “0.000000”, meaning when no Dogecoin\nwas ever transferred from the wallet. In the case that this domain is generated, the malware\nwill exit without continuing any further.\n\n\n-----\n\nOtherwise, the malware continues to download a shell script by contacting its C2 via\nHTTPS, using the URL <c2_address>/update.sh and saving the returned data as\n**_/tmp/update.sh._**\n\n\n-----\n\nIt will then resolve the current process s PID and path to be used as script arguments, and\nproceeds to execute the script by running: /bin/sh -c **_./update.sh <process_id>_**\n**_<process_path>_**\n\nMeanwhile, the main thread of the malware reads from STDIN, expecting to receive binary\ndata from that shell script. The arguments are passed to the script in order to allow it to\ncommunicate with the malware in this way and receive code to execute.\n\n\n-----\n\nIf data is received via STDIN, the malware saves it as a file under /tmp, choosing its name\nrandomly from a predefined list of Linux kernel modules.\n\nWhile it’s a very basic deception method, it’s not something commonly seen in Linux\nmalware, which often don’t bother disguising as system files.\n\nFinally, the malware proceeds to fork so the child process executes the file and the main\nprocess loops to repeat the malware’s logic flow.\n\n**Bottom Line**\n\nThe Ngrok Botnet campaign has been ongoing for over two years and is rather effective,\ninfecting any misconfigured Docker API server in a matter of hours. The incorporation of the\nunique and undetected Doki malware indicates the operation is continuing to evolve.\n\nThis attack is very dangerous due to the fact the attacker uses container escape techniques\nto gain full control of the victim’s infrastructure. Our evidence shows that it takes only a few\nhours from when a new misconfigured Docker server is up online to become infected by this\ncampaign.\n\n**Immediate Action Required by Container Server Owners**\n\nBoth companies and individuals who own container servers in the cloud must immediately\nfix configuration to prevent exposure. This includes: Checking for any exposed ports,\nverifying there are no foregin or unknown containers among the existing containers, and\nmonitoring excessive use of resources.\n\n\n-----\n\nWe recommend you read our article, Best Practices for Securing a Docker Runtime\n[Environment. You can also run our YARA rule on your cloud servers to check if you have](https://github.com/intezer/yara-rules/blob/master/Doki_Attack.yar)\nbeen infected by this campaign.\n\n**Detected by Intezer Protect**\n\nWe detected this threat using our Cloud Workload Protection Platform (CWPP) Intezer\nProtect. Installed on a Linux machine, Intezer Protect recognized unknown code executed\nin the memory of the server. After performing a genetic analysis, the platform concluded the\ncode has never before been seen in the wild, which means it’s completely new and\ntherefore it’s likely the malware was written entirely from scratch. This is one reason why\n[the industry is adopting Zero Trust Execution to secure cloud workloads.](https://www.intezer.com/blog/cloud-workload-protection/what-is-zero-trust-execution-definition-adoption-more/)\n\n**IOCs**\n\n4aadb47706f0fe1734ee514e79c93eed65e1a0a9f61b63f3e7b6367bd9a3e63b\n\n6d77335c4f23[.]ddns[.]net\n\n36b397f0da96fa0639a1e60f56af8be1a3060c4d1b98f108b7dc8e3c572b3337\n\n9907eaa1b487306c43b1352369f0409ba59a9aa0f5590fbd60e8825999db1f14\n\n**Nicole Fishbein**\nNicole is a malware analyst and reverse engineer. Prior to Intezer she was an embedded\nresearcher in the Israel Defense Forces (IDF) Intelligence Corps.\n\n\n-----\n\n**Michael Kajiloti**\nMichael is a security researcher turned product manager, who previously led the Intezer\nAnalyze product lifecycle. He has presented his malware research at conferences such as\nREcon and the Chaos Communications Congress (CCC).\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-28 - Watch Your Containers- Doki Infecting Docker Servers in the Cloud.pdf"
    ],
    "report_names": [
        "2020-07-28 - Watch Your Containers- Doki Infecting Docker Servers in the Cloud.pdf"
    ],
    "threat_actors": [
        {
            "id": "eb3f4e4d-2573-494d-9739-1be5141cf7b2",
            "created_at": "2022-10-25T16:07:24.471018Z",
            "updated_at": "2025-03-27T02:02:10.24394Z",
            "deleted_at": null,
            "main_name": "Cron",
            "aliases": [],
            "source_name": "ETDA:Cron",
            "tools": [
                "Catelites",
                "Catelites Bot",
                "CronBot",
                "TinyZBot"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536184,
    "ts_updated_at": 1743041347,
    "ts_creation_date": 1653698550,
    "ts_modification_date": 1653698550,
    "files": {
        "pdf": "https://archive.orkl.eu/c1f9f0d2d77c1b350c7195058c7ac7bed463957a.pdf",
        "text": "https://archive.orkl.eu/c1f9f0d2d77c1b350c7195058c7ac7bed463957a.txt",
        "img": "https://archive.orkl.eu/c1f9f0d2d77c1b350c7195058c7ac7bed463957a.jpg"
    }
}