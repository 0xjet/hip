{
    "id": "5f993a0c-e60f-4ed9-950f-aedd369e5d19",
    "created_at": "2023-01-12T15:07:20.384401Z",
    "updated_at": "2025-03-27T02:08:41.429403Z",
    "deleted_at": null,
    "sha1_hash": "80a6c31a9df222133d7651f898f433efd572f9b5",
    "title": "2021-07-29 - When coin miners evolve, Part 2- Hunting down LemonDuck and LemonCat attacks",
    "authors": "",
    "file_creation_date": "2022-05-28T23:14:14Z",
    "file_modification_date": "2022-05-28T23:14:14Z",
    "file_size": 416361,
    "plain_text": "# When coin miners evolve, Part 2: Hunting down LemonDuck and LemonCat attacks\n\n**microsoft.com/security/blog/2021/07/29/when-coin-miners-evolve-part-2-hunting-down-lemonduck-and-lemoncat-**\nattacks/\n\nJuly 29, 2021\n\n_[Note: In this two-part blog series, we expose a modern malware infrastructure and provide_\n_[guidance for protecting against the wide range of threats it enables. Part 1 covered the](https://www.microsoft.com/security/blog/2021/07/22/when-coin-miners-evolve-part-1-exposing-lemonduck-and-lemoncat-modern-mining-malware-infrastructure/)_\n_evolution of the threat, how it spreads, and how it impacts organizations. Part 2 provides a_\n_deep dive on the attacker behavior and outlines investigation guidance.]_\n\nLemonDuck is an actively updated and robust malware primarily known for its botnet and\n[cryptocurrency mining objectives. As we discussed in Part 1 of this blog series, in recent](https://www.microsoft.com/security/blog/2021/07/22/when-coin-miners-evolve-part-1-exposing-lemonduck-and-lemoncat-modern-mining-malware-infrastructure/)\nmonths LemonDuck adopted more sophisticated behavior and escalated its operations.\nToday, beyond using resources for its traditional bot and mining activities, LemonDuck steals\ncredentials, removes security controls, spreads via emails, moves laterally, and ultimately\ndrops more tools for human-operated activity.\n\nLemonDuck spreads in a variety of ways, but the two main methods are (1) compromises that\nare either edge-initiated or facilitated by bot implants moving laterally within an organization,\nor (2) bot-initiated email campaigns. After installation, LemonDuck can generally be identified\nby a predictable series of automated activities, followed by beacon check-in and monetization\nbehaviors, and then, in some environments, human-operated actions.\n\n\n-----\n\nIn this blog post, we share our in-depth technical analysis of the malicious actions that follow\na LemonDuck infection. These include general and automatic behavior, as well as humanoperated actions. We also provide guidance for investigating LemonDuck attacks, as well as\nmitigation recommendations for strengthening defenses against these attacks.\n\n_Figure 2. LemonDuck attack chain from the Duck and Cat infrastructures_\n\n## External or human-initialized behavior\n\nLemonDuck activity initiated from external applications – as against self-spreading methods\nlike malicious phishing mail – is generally much more likely to begin with or lead to humanoperated activity. These activities always result in more invasive secondary malware being\ndelivered in tandem with persistent access being maintained through backdoors. These\nhuman-operated activities result in greater impact than standard infections.\n\n[In March and April 2021, various vulnerabilities related to the ProxyLogon set of Microsoft](https://security.microsoft.com/threatanalytics3/4ef1fbc5-5659-4d9b-b32e-97a694475955/overview)\nExchange Server exploits were utilized by LemonDuck to install web shells and gain access\nto outdated systems. Attackers then used this access to launch additional attacks while also\ndeploying automatic LemonDuck components and malware.\n\nIn some cases, the LemonDuck attackers used renamed copies of the official Microsoft\nExchange On-Premises Mitigation Tool to remediate the vulnerability they had used to gain\naccess. They did so while maintaining full access to compromised devices and limiting other\nactors from abusing the same Exchange vulnerabilities.\n\n\n-----\n\nThis self-patching behavior is in keeping with the attackers general desire to remove\ncompeting malware and risks from the device. This allows them to limit visibility of the attack\nto SOC analysts within an organization who might be prioritizing unpatched devices for\ninvestigation, or who would overlook devices that do not have a high volume of malware\npresent.\n\n[The LemonDuck operators also make use of many fileless malware techniques, which can](https://www.microsoft.com/security/blog/2018/01/24/now-you-see-me-exposing-fileless-malware/#:~:text=%20These%20techniques%20include%3A%20%201%20Reflective%20DLL,provide%20powerful%20means%20for%20delivering%20memory-only...%20More%20)\nmake remediation more difficult. Fileless techniques, which include persistence via registry,\nscheduled tasks, WMI, and startup folder, remove the need for stable malware presence in\nthe filesystem. These techniques also include utilizing process injection and in-memory\nexecution, which can make removal non-trivial. It is therefore imperative that organizations\nthat were vulnerable in the past also direct action to investigate exactly how patching\noccurred, and whether malicious activity persists.\n\nOn the basic side of implementation this can mean registry, scheduled task, WMI and startup\nfolder persistence to remove the necessity for stable malware presence in the filesystem.\nHowever, many free or easily available RATs and Trojans are now routinely utilizing process\ninjection and in-memory execution to circumvent easy removal. To rival these kinds of\nbehaviors it’s imperative that security teams within organizations review their incident\nresponse and malware removal processes to include all common areas and arenas of the\noperating system where malware may continue to reside after cleanup by an antivirus\nsolution.\n\n## General, automatic behavior\n\nIf the initial execution begins automatically or from self-spreading methods, it typically\noriginates from a file called Readme.js. This behavior could change over time, as the purpose\nof this .js file is to obfuscate and launch the PowerShell script that pulls additional scripts from\nthe C2. This JavaScript launches a CMD process that subsequently launches Notepad as well\nas the PowerShell script contained within the JavaScript.\n\nIn contrast, if infection begins with RDP brute force, Exchange vulnerabilities, or other\nvulnerable edge systems, the first few actions are typically human-operated or originate from\na hijacked process rather than from Readme.js. After this, the next few actions that the\nattackers take, including the scheduled task creation, as well as the individual components\nand scripts are generally the same.\n\nOne of these actions is to establish fileless persistence by creating scheduled tasks that rerun the initial PowerShell download script. This script pulls its various components from the\nC2s at regular intervals. The script then checks to see if any portions of the malware were\nremoved and re-enables them. LemonDuck also maintains a backup persistence mechanism\nthrough WMI Event Consumers to perform the same actions.\n\n\n-----\n\nTo host their scripts, the attackers use multiple hosting sites, which as mentioned are resilient\nto takedown. They also have multiple scheduled tasks to try each site, as well as the WMI\nevents in case other methods fail. If all of those fail, LemonDuck also uses its access methods\nsuch as RDP, Exchange web shells, Screen Connect, and RATs to maintain persistent\naccess. These task names can vary over time, but “blackball”, “blutea”, and “rtsa” have been\npersistent throughout 2020 and 2021 and are still seen in new infections as of this report.\n\nLemonDuck attempts to automatically disable Microsoft Defender for Endpoint real-time\nmonitoring and adds whole disk drives – specifically the C:\\ drive – to the Microsoft Defender\nexclusion list. This action could in effect disable Microsoft Defender for Endpoint, freeing the\n[attacker to perform other actions. Tamper protection prevents these actions, but it’s important](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/prevent-changes-to-security-settings-with-tamper-protection?view=o365-worldwide)\nfor organizations to monitor this behavior in cases where individual users set their own\nexclusion policy.\n\nLemonDuck then attempts to automatically remove a series of other security products through\n_CMD.exe, leveraging WMIC.exe. The products that we have observed LemonDuck remove_\ninclude ESET, Kaspersky, Avast, Norton Security, and MalwareBytes. However, they also\nattempt to uninstall any product with “Security” and “AntiVirus” in the name by running the\nfollowing commands:\n\nCustom detections in Microsoft Defender for Endpoint or other security solutions can raise\nalerts on behaviors indicating interactions with security products that are not deployed in the\nenvironment. These alerts can allow the quick isolation of devices where this behavior is\nobserved. While this uninstallation behavior is common in other malware, when observed in\nconjunction with other LemonDuck TTPs, this behavior can help validate LemonDuck\ninfections.\n\nLemonDuck leverages a wide range of free and open-source penetration testing tools. It also\nuses freely available exploits and functionality such as coin mining. Because of this, the order\nand the number of times the next few activities are run can change. The attackers can also\nchange the threat’s presence slightly depending on the version, the method of infection, and\ntimeframe. Many .exe and .bin files are downloaded from C2s via encoded PowerShell\ncommands. These domains use a variety names such as the following:\n\nackng[.]com\nbb3u9[.]com\nttr3p[.]com\nzz3r0[.]com\n\n\n-----\n\nsqlnetcat[.]com\nnetcatkit[.]com\nhwqloan[.]com\n75[.]ag\njs88[.]ag\nqq8[.]ag\n\nIn addition to directly calling the C2s for downloads through scheduled tasks and PowerShell,\nLemonDuck exhibits another unique behavior: the IP addresses of a smaller subset of C2s\nare calculated and paired with a previously randomly generated and non-real domain name.\nThis information is then added into the Windows Hosts file to avoid detection by static\nsignatures. In instances where this method is seen, there is a routine to update this once\nevery 24 hours. An example of this is below:\n\nLemonDuck is known to use custom executables and scripts. It also renames and packages\nwell-known tools such as XMRig and Mimikatz. Of these, the three most common are the\nfollowing, though other packages and binaries have been seen as well, including many with\n_.ori file extensions:_\n\n_IF.BIN (used for lateral movement and privilege escalation)_\n_KR.BIN (used for competition removal and host patching)_\n_M[0-9]{1}[A-Z]{1}.BIN, M6.BIN, M6.BIN.EXE, or M6G.Bin (used for mining)_\n\nExecutables used throughout the infection also use random file names sourced from the\ninitiating script, which selects random characters, as evident in the following code:\n\n## Lateral movement and privilege escalation\n\n_IF.Bin, whose name stands for “Infection”, is the most common name used for the infection_\nscript during the download process. LemonDuck uses this script at installation and then\nrepeatedly thereafter to attempt to scan for ports and perform network reconnaissance. It then\nattempts to log onto adjacent devices to push the initial LemonDuck execution scripts.\n\n\n-----\n\n_IF.Bin attempts to move laterally via any additional attached drives. When drives are_\nidentified, they are checked to ensure that they aren’t already infected. If they aren’t, a copy of\n_Readme.js, as well as subcomponents of IF.Bin, are downloaded into the drive’s home_\ndirectory as hidden.\n\nSimilarly, IF.Bin attempts to brute force and use vulnerabilities for SMB, SQL, and other\nservices to move laterally. It then immediately contacts the C2 for downloads.\n\nAnother tool dropped and utilized within this lateral movement component is a bundled\nMimikatz, within a mimi.dat file associated with both the “Cat” and “Duck” infrastructures. This\ntool’s function is to facilitate credential theft for additional actions. In conjunction with\ncredential theft, IF.Bin drops additional .BIN files to attempt common service exploits like\nCVE-2017-8464 (LNK remote code execution vulnerability) to increase privilege.\n\nThe attackers regularly update the internal infection components that the malware scans for.\nThey then attempt brute force or spray attacks, as well as exploits against available SSH,\nMSSQL, SMB, Exchange, RDP, REDIS and Hadoop YARN for Linux and Windows systems.\nA sample of ports that recent LemonDuck infections were observed querying include 70001,\n8088, 16379, 6379, 22, 445, and 1433.\n\nOther functions built in and updated in this lateral movement component include mail selfspreading. This spreading functionality evaluates whether a compromised device has\nOutlook. If so, it accesses the mailbox and scans for all available contacts. It sends the\ninitiating infecting file as part of a .zip, .js, or .doc/.rtf file with a static set of subjects and\nbodies. The mail metadata count of contacts is also sent to the attacker, likely to evaluate its\neffectiveness, such as in the following command:\n\n## Competition removal and host patching\n\nAt installation and repeatedly afterward, LemonDuck takes great lengths to remove all other\nbotnets, miners, and competitor malware from the device. It does this via KR.Bin, the “Killer”\nscript, which gets its name from its function calls. This script attempts to remove services,\nnetwork connections, and other evidence from dozens of competitor malware via scheduled\ntasks. It also closes well-known mining ports and removes popular mining services to\npreserve system resources. The script even removes the mining service it intends to use and\nsimply reinstalls it afterward with its own configuration.\n\nThis “Killer” script is likely a continuation of older scripts that were used by other botnets such\nas GhostMiner in 2018 and 2019. The older variants of the script were quite small in\ncomparison, but they have since grown, with additional services added in 2020 and 2021.\n\n\n-----\n\nPresently, LemonDuck seems consistent in naming its variant KR.Bin. This process spares\nthe scheduled tasks created by LemonDuck itself, including various PowerShell scripts as well\nas a task called “blackball”, “blutea”, or “rtsa”, which has been in use by all LemonDuck’s\ninfrastructures for the last year along with other task names.\n\nThe attackers were also observed manually re-entering an environment, especially in\ninstances where edge vulnerabilities were used as an initial entry vector. The attackers also\npatch the vulnerability they used to enter the network to prevent other attackers from gaining\nentry. As mentioned, the attackers were seen using a copy of a Microsoft-provided mitigation\ntool for Exchange ProxyLogon vulnerability, which they hosted on their infrastructure, to\nensure other attackers don’t gain web shell access the way they had. If unmonitored, this\nscenario could potentially lead to a situation where, if a system does not appear to be in an\nunpatched state, suspicious activity that occurred before patching could be ignored or thought\nto be unrelated to the vulnerability.\n\n## Weaponization and continued impact\n\nA miner implant is downloaded as part of the monetization mechanism of LemonDuck. The\nimplant used is usually XMRig, which is a favorite of GhostMiner malware, the Phorpiex\nbotnet, and other malware operators. The file uses any of the following names:\n\n_M6.bin_\n_M6.bin.ori_\n_M6G.bin_\n_M6.bin.exe_\n_<File name that follows the regex pattern M[0-9]{1}[A-Z]{1}>.BIN._\n\nOnce the automated behaviors are complete, the threat goes into a consistent check-in\nbehavior, simply mining and reporting out to the C2 infrastructure and mining pools as needed\nwith encoded PowerShell commands such as those below (decoded):\n\nOther systems that are affected bring in secondary payloads such as Ramnit, which is a very\npopular Trojan that has been seen being dropped by other malware in the past. Additional\nbackdoors, other malware implants, and activities continuing long after initial infection,\n\n\n-----\n\ndemonstrating that even a simple infection by a coin mining malware like LemonDuck can\npersist and bring in more dangerous threats to the enterprise.\n\n## Comprehensive protection against a wide-ranging malware operation\n\n[The cross-domain visibility and coordinated defense delivered by Microsoft 365 Defender is](https://www.microsoft.com/en-us/microsoft-365/security/microsoft-365-defender)\ndesigned for the wide range and increasing sophistication of threats that LemonDuck\nexemplifies. Below we list mitigation actions, detection information, and advanced hunting\nqueries that Microsoft 365 Defender customers can use to harden networks against threats\nfrom LemonDuck and other malware operations.\n\n### Mitigations\n\nApply these mitigations to reduce the impact of LemonDuck. Check the recommendations\ncard for the deployment status of monitored mitigations.\n\nPrevent threats from arriving via removable storage devices by blocking these\ndevices on sensitive endpoints. If you allow removable storage devices, you can\nminimize the risk by turning off autorun, enabling real-time antivirus protection, and\nblocking untrusted content. Learn about stopping threats from USB devices and other\nremovable media.\nEnsure that Linux and Windows devices are included in routine patching, and validate\nprotection against the CVE-2019-0708, CVE-2017-0144, CVE-2017-8464, CVE-20200796, CVE-2021-26855, CVE-2021-26858, and CVE-2021-27065 vulnerabilities, as well\nas against brute-force attacks in popular services like SMB, SSH, RDP, SQL, and\nothers.\n[Turn on PUA protection. Potentially unwanted applications (PUA) can negatively impact](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-antivirus/detect-block-potentially-unwanted-apps-windows-defender-antivirus)\nmachine performance and employee productivity. In enterprise environments, PUA\nprotection can stop adware, torrent downloaders, and coin miners.\nTurn on [tamper protection featuresto prevent attackers from stopping security services.](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-antivirus/prevent-changes-to-security-settings-with-tamper-protection)\nTurn on [cloud-delivered protectionand automatic sample submission on Microsoft](https://docs.microsoft.com/windows/security/threat-protection/microsoft-defender-antivirus/enable-cloud-protection-microsoft-defender-antivirus)\nDefender Antivirus. These capabilities use artificial intelligence and machine learning to\nquickly identify and stop new and unknown threats.\nEncourage users to use Microsoft Edge and other web browsers that support\nSmartScreen, which identifies and blocks malicious websites, including phishing sites,\nscam sites, and sites that contain exploits and host malware. Turn on network\nprotectionto block connections to malicious domains and IP addresses.\nCheck your [Office 365 antispam policyand your](https://docs.microsoft.com/microsoft-365/security/office-365-security/configure-your-spam-filter-policies) [mail flow rules for allowed senders,](https://docs.microsoft.com/microsoft-365/security/office-365-security/create-safe-sender-lists-in-office-365#recommended-use-mail-flow-rules)\n[domains and IP addresses. Apply extra caution when using these settings to bypass](https://docs.microsoft.com/exchange/troubleshoot/antispam/cautions-against-bypassing-spam-filters)\nantispam filters, even if the allowed sender addresses are associated with trusted\norganizations—Office 365 will honor these settings and can let potentially harmful\n[messages pass through. Review system overrides in threat explorer to determine why](https://docs.microsoft.com/microsoft-365/security/office-365-security/threat-explorer#system-overrides)\nattack messages have reached recipient mailboxes.\n\n\n-----\n\n### Attack surface reduction\n\nTurn on the following attack surface reduction rules, to block or audit activity associated with\nthis threat:\n\n[Block executable content from email client and webmail](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction#block-executable-content-from-email-client-and-webmail)\n[Block JavaScript or VBScript from launching downloaded executable content](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction#block-javascript-or-vbscript-from-launching-downloaded-executable-content)\n[Block Office applications from creating executable content](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction#block-office-applications-from-creating-executable-content)\n[Block all office applications from creating child processes](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction#block-all-office-applications-from-creating-child-processes)\nBlock executable files from running unless they meet a prevalence, age, or trusted list\ncriterion\n[Block execution of potentially obfuscated scripts](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction#block-execution-of-potentially-obfuscated-scripts)\n[Block persistence through WMI event subscription](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction#block-persistence-through-wmi-event-subscription)\n[Block process creations originating from PSExec and WMI commands](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction#block-process-creations-originating-from-psexec-and-wmi-commands)\n\n### Antivirus detections\n\nMicrosoft Defender Antivirus detects threat components as the following malware:\n\nTrojanDownloader:PowerShell/LemonDuck!MSR\nTrojanDownloader:Linux/LemonDuck.G!MSR\nTrojan:Win32/LemonDuck.A\nTrojan:PowerShell/LemonDuck.A\nTrojan:PowerShell/LemonDuck.B\nTrojan:PowerShell/LemonDuck.C\nTrojan:PowerShell/LemonDuck.D\nTrojan:PowerShell/LemonDuck.E\nTrojan:PowerShell/LemonDuck.F\nTrojan:PowerShell/LemonDuck.G\nTrojanDownloader:PowerShell/LodPey.A\nTrojanDownloader:PowerShell/LodPey.B\nTrojan:PowerShell/Amynex.A\nTrojan:Win32/Amynex.A\n\n### Endpoint detection and response (EDR) alerts\n\nAlerts with the following titles in the security center can indicate threat activity on your\nnetwork:\n\nLemonDuck botnet C2 domain activity\nLemonDuck malware\n\nThe following alerts might also indicate threat activity associated with this threat. These alerts,\nhowever, can be triggered by unrelated threat activity and are not monitored in the status\ncards provided with this report.\n\n\n-----\n\nSuspicious PowerShell command line\nSuspicious remote activity\nSuspicious service registration\nSuspicious Security Software Discovery\nSuspicious System Network Configuration Discovery\nSuspicious sequence of exploration activities\nSuspicious Process Discovery\nSuspicious System Owner/User Discovery\nSuspicious System Network Connections Discovery\nSuspicious Task Scheduler activity\nSuspicious Microsoft Defender Antivirus exclusion\nSuspicious behavior by cmd.exe was observed\nSuspicious remote PowerShell execution\nSuspicious behavior by svchost.exe was observed\nA WMI event filter was bound to a suspicious event consumer\nAttempt to hide use of dual-purpose tool\nSystem executable renamed and launched\nMicrosoft Defender Antivirus protection turned off\nAnomaly detected in ASEP registry\nA script with suspicious content was observed\nAn obfuscated command line sequence was identified\nA process was injected with potentially malicious code\nA malicious PowerShell Cmdlet was invoked on the machine\nSuspected credential theft activity\nOutbound connection to non-standard port\nSensitive credential memory read\n\n### Advanced hunting\n\nThe LemonDuck botnet is highly varied in its payloads and delivery methods after email\ndistribution so can sometimes evade alerts. You can use the advanced hunting capability in\nMicrosoft 365 Defender and Microsoft Defender for Endpoint to surface activities associated\nwith this threat.\n\n**NOTE: The following sample queries lets you search for a week’s worth of events. To explore**\nup to 30 days worth of raw data to inspect events in your network and locate potential Lemon\nDuck-related indicators for more than a week, go to the Advanced Hunting page\n\n- Query tab, select the calendar drop-down menu to update your query to hunt for the Last\n**30 days.**\n\n**LemonDuck template subject lines**\n\n\n-----\n\nLooks for subject lines that are present from 2020 to 2021 in dropped scripts that attach\nmalicious LemonDuck samples to emails and mail it to contacts of the mailboxes on impacted\nmachines. Additionally, checks if Attachments are present in the mailbox. General attachment\ntypes to check for at present are .DOC, .ZIP or .JS, though this could be subject to change as\n[well as the subjects themselves. Run query in Microsoft 365 security center.](https://security.microsoft.com/hunting?query=H4sIAAAAAAAEAG2RQUvDQBCF31nwP-ytCnroUUElxEoEUUirxWOiXRuNicSkpeCP99vJepESZnYz8-a9mdmZPlWoUq2ZNlqpUa9vHepAP3Laak2sw5zmGlTqnfsLGEdNgz_SRAtDOc4OTM-fUyuPT_WgJ93qWqea6gzsCfY_6mBKqdiYypcpVHRVRxVPzmmpjLqRIVOiO_Qy4gk8gW1ONtezzo0_x-7JOcvleiQfasNkE7gWuolcS_otbKI-zuHRH_QR82-ot3olXmpHfox6asJetlhtndbcer6wrxFTcmvhWdmmvG35rz7srGLTLvodyAF82FyHWmC5Ane89y0SUyroc837ja-WGkNjk1zqAj_VLyyp2szeAQAA&runQuery=true&timeRangeId=week)\n```\nEmailEvents\n| where Subject in ('The Truth of COVID-19','COVID-19 nCov Special info\nWHO','HALTH ADVISORY:CORONA VIRUS',\n'WTF','What the fcuk','good bye','farewell letter','broken file','This is\nyour order?')\n| where AttachmentCount >= 1\n\n```\n**LemonDuck Botnet Registration Functions**\n\nLooks for instances of function runs with name “SIEX”, which within the Lemon Duck\ninitializing scripts is used to assign a specific user-agent for reporting back to command-andcontrol infrastructure with. This query should be accompanied by additional surrounding logs\nshowing successful downloads from component sites. Run query in Microsfot 365 security\ncenter.\n```\nDeviceEvents\n| where ActionType == \"PowerShellCommand\"\n| where AdditionalFields =~ \"{\\\"Command\\\":\\\"SIEX\\\"}\"\n\n```\n**LemonDuck keyword identification**\n\nLooks for simple usage of LemonDuck seen keyword variations initiated by PowerShell\nprocesses. All results should reflect Lemon_Duck behavior, however there are existing\nvariants of Lemon_Duck that might not use this term explicitly, so validate with additional\n[hunting queries based on known TTPs. Run query in Microsoft 365 security center.](https://security.microsoft.com/hunting?query=H4sIAAAAAAAEAJ2NQQrCMBBF_1rwDqErBfEGrqyCUKQ3kKLFBpsojdoKHt7nbESX8pnM8P7MT65ad3nt6aU6nW1KaAWvFXVlHmukp5x6NbCOctrgeVyvyt6o40_CGtoyb9kIdrNATpkubPWWlCyxRXP6QGV__rZkDqjCO6iwnfdlA0naGX9oQn4BD2xHaK4bCSfo7Mv58Klezaq6iiQBAAA&runQuery=true&timeRangeId=week)\n```\nDeviceProcessEvents\n| where InitiatingProcessFileName == \"powershell.exe\"\n| where InitiatingProcessCommandLine has_any(\"Lemon_Duck\",\"LemonDuck\")\n\n```\n**LemonDuck Microsoft Defender tampering**\n\nLooks for a command line event where LemonDuck or other like malware might attempt to\nmodify Defender by disabling real-time monitoring functionality or adding entire drive letters to\nthe exclusion criteria. The exclusion additions will often succeed even if tamper protection is\nenabled due to the design of the application. Custom alerts could be created in an\nenvironment for particular drive letters common in the environment. Run query in Microsoft\n365 security center.\n\n\n-----\n\n```\nDeviceProcessEvents\n| where InitiatingProcessCommandLine has_all (\"Set-MpPreference\",\n\"DisableRealtimeMonitoring\", \"Add-MpPreference\", \"ExclusionProcess\")\n| project ProcessCommandLine, InitiatingProcessCommandLine, DeviceId,\nTimestamp\n\n```\n**Antivirus uninstallation attempts**\n\nLooks for a command line event where LemonDuck or other similar malware might attempt to\nmodify Defender by disabling real-time monitoring functionality or adding entire drive letters to\nthe exclusion criteria. The exclusion additions will often succeed even if tamper protection is\nenabled due to the design of the application. Custom alerts could be created in an\nenvironment for particular drive letters common in the environment. Run query in Microsoft\n365 security center.\n```\nDeviceProcessEvents\n| where InitiatingProcessFileName =~ \"wmic.exe\"\n| where InitiatingProcessCommandLine has_all(\"product where\",\"name\nlike\",\"call uninstall\",\"/nointeractive\")\n| where InitiatingProcessCommandLine\nhas_any(\"Kaspersky\",\"avast\",\"avp\",\"security\",\"eset\",\"AntiVirus\",\"Norton\nSecurity\")\n\n```\n**Known LemonDuck component script installations**\n\nLooks for instances of the callback actions which attempt to obfuscate detection while\ndownloading supporting scripts such as those that enable the “Killer” and “Infection” functions\nfor the malware as well as the mining components and potential secondary functions. Options\nfor more specific instances included to account for environments with potential false positives.\nMost general versions are intended to account for minor script or component changes such as\nchanging to utilize non .bin files, and non-common components. Run query in Microsoft 365\nsecurity center.\n```\nDeviceProcessEvents\n| where InitiatingProcessFileName in (\"powershell.exe\",\"cmd.exe\")\n| where InitiatingProcessCommandLine has_all(\"/c echo\ntry\",\"down_url=\",\"md5\",\"downloaddata\",\"ComputeHash\") or\nInitiatingProcessCommandLine has_all(\"/c echo\ntry\",\"down_url=\",\"md5\",\"downloaddata\",\"ComputeHash\",\".bin\") or\nInitiatingProcessCommandLine has_all(\"/c echo\ntry\",\"down_url=\",\"md5\",\"downloaddata\",\"ComputeHash\",\"kr.bin\",\"if.bin\",\"m6.bin\")\n\n```\n**LemonDuck named scheduled creation**\n\nLooks for instances of the LemonDuck creates statically named scheduled tasks or a semiunique pattern of task creation LemonDuck also utilizes launching hidden PowerShell\nprocesses in conjunction with randomly generated task names. An example of a randomly\n\n\n-----\n\ngenerated one is: schtasks.exe /create /ru system /sc MINUTE /mo 60 /tn\nfs5yDs9ArkV\\2IVLzNXfZV/F /tr “powershell -w hidden -c PS_CMD”. Run query in Microsoft\n365 security center.\n```\nDeviceProcessEvents\n| where FileName =~ \"schtasks.exe\"\n| where ProcessCommandLine has(\"/create\")\n| where ProcessCommandLine has_any(\"/tn blackball\",\"/tn blutea\",\"/tn rtsa\")\nor\nProcessCommandLine\nhas_all(\"/create\",\"/ru\",\"system\",\"/sc\",\"/mo\",\"/tn\",\"/F\",\"/tr\",\"powershell -w\nhidden -c PS_CMD\")\n\n```\n**Competition killer script scheduled task execution**\n\nLooks for instances of the LemonDuck component KR.Bin, which is intended to kill\ncompetition prior to making the installation and persistence of the malware concrete. The killer\nscript used is based off historical versions from 2018 and earlier, which has grown over time\nto include scheduled task and service names of various botnets, malware, and other\ncompeting services. The version currently in use by LemonDuck has approximately 40-60\nscheduled task names. The upper maximum in this query can be modified and adjusted to\n[include time bounding. Run query in Microsoft 365 security center.](https://security.microsoft.com/hunting?query=H4sIAAAAAAAEAJWRT0_CQBDF35nE79D0BAkRDhw4oBeqCQbUxD_XBguxhlpMW8EaP7y_HQppiATMZmZnZt_MvLwNNNdKb4q475VpaVHOuaI-V6qC-EwN_cjTWjG1DPP20EPid86UjpnGTEwNFVPJFeITTlM-WUS1sPoCOwf3hflqYx0FxAlW1GqPut3F1_jWjlGuz2pvxs5v2-myBVHIq5vTPIlri84XlfigpskIxHaX41mYJrMKteX5zMTEmLj9F5jjk-FLWCTW8woyhsuGU3gip7-U_8-E-g-ksHE_MOHOyTeKPtDnuJZVfme8I2Pt6YZ4hXl60gdzp7V_WaKyf4DjYXUuTZ-euqbSMS0Hhu6D_gUG3Q8GqgIAAA&runQuery=true&timeRangeId=week)\n```\nDeviceProcessEvents\n| where ProcessCommandLine has_all(\"schtasks.exe\",\"/Delete\",\"/TN\",\"/F\")\n| summarize make_set(ProcessCommandLine) by DeviceId\n| extend DeleteVolume = array_length(set_ProcessCommandLine)\n| where set_ProcessCommandLine has_any(\"Mysa\",\"Sorry\",\"Oracle Java\nUpdate\",\"ok\") where DeleteVolume >= 40 and DeleteVolume <= 80\n\n```\n**LemonDuck hosts file adjustment for dynamic C2 downloads**\n\nLooks for a PowerShell event wherein LemonDuck will attempt to simultaneously retrieve the\nIP address of a C2 and modify the hosts file with the retrieved address. The address is then\nattributed to a name that does not exist and is randomly generated. The script then instructs\nthe machine to download data from the address. This query has a more general and more\nspecific version, allowing the detection of this technique if other activity groups were to utilize\nit. [Run query in Microsoft 365 security center.](https://security.microsoft.com/hunting?query=H4sIAAAAAAAEAMWQuwrCYAyFzyz4DqWTgvgGDmK9gYigu5S22IK20op18OH9Erro4OAiIZc_OTknbaRMdxVKyDvVqrxqsDn9TKVu1H319FSgVjm9Gg-0ZlYwLRR7LHX6YFjQPVNvQVx8Z4IFCnUF1TpT44xnbEx-4OGPajPqCxYzS7VxjG3mdBodiaYygH9J_6YV-IY8BZ26irFYDDXCDZN0dd5hbTaE0y6s2PnHXWv432cHNvZs1J3-9_vtHfn_L9Gt0E952_Wxf90Lt1_r6hICAAA&runQuery=true&timeRangeId=week)\n```\nDeviceProcessEvents\n| where InitiatingProcessFileName == \"powershell.exe\"\n| where InitiatingProcessCommandLine\nhas_all(\"GetHostAddresses\",\"etc\",\"hosts\")\nor InitiatingProcessCommandLine\nhas_all(\"GetHostAddresses\",\"IPAddressToString\",\"etc\",\"hosts\",\"DownloadData\")\n\n```\n\n-----\n\nLearn how your organization can stop attacks through automated, cross-domain security and\nbuilt-in AI with Microsoft Defender 365.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-29 - When coin miners evolve, Part 2- Hunting down LemonDuck and LemonCat attacks.pdf"
    ],
    "report_names": [
        "2021-07-29 - When coin miners evolve, Part 2- Hunting down LemonDuck and LemonCat attacks.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536040,
    "ts_updated_at": 1743041321,
    "ts_creation_date": 1653779654,
    "ts_modification_date": 1653779654,
    "files": {
        "pdf": "https://archive.orkl.eu/80a6c31a9df222133d7651f898f433efd572f9b5.pdf",
        "text": "https://archive.orkl.eu/80a6c31a9df222133d7651f898f433efd572f9b5.txt",
        "img": "https://archive.orkl.eu/80a6c31a9df222133d7651f898f433efd572f9b5.jpg"
    }
}