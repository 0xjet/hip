{
    "id": "b8180543-f42a-4fb8-a502-08780c807a13",
    "created_at": "2023-01-12T15:06:07.256005Z",
    "updated_at": "2025-03-27T02:06:12.957612Z",
    "deleted_at": null,
    "sha1_hash": "3d236cc9e8bffaf910e9077554e8ee0b04ad1495",
    "title": "2016-11-30 - Shamoon 2- Return of the Disttrack Wiper",
    "authors": "",
    "file_creation_date": "2022-05-28T00:33:50Z",
    "file_modification_date": "2022-05-28T00:33:50Z",
    "file_size": 304841,
    "plain_text": "# Shamoon 2: Return of the Disttrack Wiper\n\n**[researchcenter.paloaltonetworks.com/2016/11/unit42-shamoon-2-return-disttrack-wiper/](http://researchcenter.paloaltonetworks.com/2016/11/unit42-shamoon-2-return-disttrack-wiper/?adbsc=social68389776&adbid=804134348374970368&adbpl=tw&adbpr=4487645412)**\n\nRobert Falcone November 30, 2016\n\nBy [Robert Falcone](https://unit42.paloaltonetworks.com/author/robertfalcone/)\n\nNovember 30, 2016 at 5:20 PM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [Disttrack Wiper,](https://unit42.paloaltonetworks.com/tag/disttrack-wiper/) [EMEA,](https://unit42.paloaltonetworks.com/tag/emea/) [Saudi Arabia,](https://unit42.paloaltonetworks.com/tag/saudi-arabia/) [Shamoon 2,](https://unit42.paloaltonetworks.com/tag/shamoon-2/) [threat intelligence](https://unit42.paloaltonetworks.com/tag/threat-intelligence/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/unit42-shamoon-2-return-disttrack-wiper/)\n\nIn August 2012, an attack campaign known as Shamoon targeted a Saudi Arabian energy\ncompany to deliver a malware called Disttrack. Disttrack is a multipurpose tool that exhibits\nworm-like behavior by attempting to spread to other systems on a local network using stolen\nadministrator credentials. More importantly, its claim to fame is the ability to destroy data and\nto render infected systems unusable. The attack four years ago resulted in 30,000 or more\nsystems being damaged.\n\nLast week, Unit 42 came across new Disttrack samples that appear to have been used in an\n[updated attack campaign. The attack targeted at least one organization in Saudi Arabia,](https://www.symantec.com/connect/blogs/shamoon-back-dead-and-destructive-ever)\nwhich aligns with the targeting of the initial Shamoon attacks. It appears the purpose of the\nnew Disttrack samples were solely focused on destruction, as the samples were configured\nwith a non-operational C2 server to report to and were set to begin wiping data exactly on\n2016/11/17 20:45. In another similarity to Shamoon, this is the end of the work week in Saudi\n\n\n-----\n\nArabia (their work week is from Sunday to Thursdays), so the malware had potentially the\nentire weekend to spread. The 2012 Shamoon attacks took place on Lailat al Qadr, the\nholiest night of the year for Muslims; another time the attackers could be reasonably certain\nemployees would not be at work.\n\n## Composition of Disttrack\n\nDisttrack is comprised of three distinct parts: the dropper, communications and wiper\ncomponents. The main Disttrack executable is a dropper that extracts additional tools from\nembedded resources and coordinates when to save and execute them. Embedded within\neach Disttrack sample is a component responsible for communicating with a C2 server and a\nseparate component used to carry out the wiping functionality.\n\nThe dropper extracts the communications and wiper components from resources named\n\"PKCS7\" and \"PKCS12\" respectively, while the x86 sample extracts the x64 variant of\nDisttrack from a resource named “X509”. To extract the components, the dropper is\nconfigured to seek specific offsets within the resource, read a specified number of bytes and\ndecrypt the contents using a specified key. The key exists in the sample as a base64\nencoded string that the dropper will decode then use each byte of the resulting string to XOR\nthe data obtained from the resource. When determining the location of the ciphertext within\nthe resource, the dropper subtracts 14 from the offset value in the sample's configuration as\nan additional layer of obfuscation. Table 1 shows the resources within the Disttrack x86\nsample, the component it contains and the values needed to decrypt its contents.\n\n**Component** **Resource Name** **Offset** **Size** **Base64 key**\n\nx64 Variant X509 812 -14 = 798 717312 5tGLQqku0m02...\n\nCommunications PKCS7 879 -14 = 865 159744 UPi0IzQOAyiL...\n\nWiper PKCS12 792 -14 = 778 282112 3Lmqr/nJgzFZ7...\n\n_Table 1 Resources containing Disttrack components_\n\n## Disttrack Functionality\n\nDisttrack is mainly focused on data destruction and attempting to damage as many systems\nas possible. To do so, this malware attempts to spread to other systems on network using\nwhat are likely stolen administrator credentials. This is again similar to the 2012 Shamoon\nattacks, where compromised but legitimate credentials obtained in advance of the attacks\nwere also hard coded into the malware to aid in its propagation. Disttrack also has the ability\nto download and execute additional applications to the system, as well as remotely set the\ndate to start wiping systems.\n\n## Local Network Spreading\n\n\n-----\n\nThe Disttrack malware spreads to other systems automatically using stolen credentials. The\nDisttrack we analyzed contained the internal domain names and administrator credentials\nassociated with the targeted organization. The internal domain and credentials appear to be\nstolen prior to the creation of this tool, as it is not a public domain and the credentials are not\nweak enough to have obtained through guessing, brute force or dictionary attacks.\n\nDisttrack uses the internal domain names and credentials to log into remote systems on the\nsame network segment. The malware determines the local network segment associated with\nthe target system (call to gethostname) by obtaining the IP address for the system (call to\ngethostbyname). It then uses the system's IP addresses to enumerate the /24 network\n(x.x.x.0-255) that the system is networked with, and will attempt to spread to each of these\nremote systems.\n\nThe dropper then attempts to open the service manager on each remote system to start the\nRemoteRegistry service, which it will connect to using RegConnectRegistryW. Once\nconnected, the dropper attempts to disable UAC (User Access Control) remote restrictions\nby setting the following registry key to a value of \"1\":\n\nSOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LocalAccountTokenFilterPolicy\n\nAfter disabling UAC, the dropper connects to the remote system (using NetUseAdd) and logs\nin using the embedded stolen credentials. The dropper then checks to see if it has\nadministrator privileges on the remote system by attempting to open \"\\system32\\csrss.exe\",\nwhich allows it to determine if it can write its payload to the \"\\system32\" folder on the remote\nsystem. The dropper then has two different methods in which it can pivot to the remote\nsystem.\n\nThe first method involves the dropper writing itself to \"\\system32\\ntssrvr32.exe\" on the\nremote system. After writing itself to the remote system, the dropper creates a service\nnamed \"ntssrv\", with a display name of \"Microsoft Network Realtime Inspection Service\" and\na description of \"Helps guard against time change attempts targeting known and newly\ndiscovered vulnerabilities in network time protocols\" to execute the payload.\n\nThe second, alternative method also involves the dropper copying itself to\n\"\\system32\\ntssrvr32.exe\" on the remote system; however, instead of creating a remote\nservice, this method calls the NetScheduleJobAdd function within the Windows netapi32\nlibrary to create a scheduled task to run the payload. Scheduled tasks require a time in which\nthe task will run, which the dropper determines by calling the function NetRemoteTOD to\nobtain the time of day from the remote system. The dropper then adds 90 seconds to the\ntime of day value on the remote system and uses this value as the \"JobTime\" to run the task\nin three minutes, which executes the payload on the remote system. The following pseudocode shows the scheduled task creation process:\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nNetRemoteTOD(UncServerName, &BufferPtr)\nNetApiBufferAllocate(0x10u, &AT_INFO)\nAT_INFO->Command = s_pathToPayload;\nAT_INFO->JobTime = 1000\n\n- (BufferPtr->tod_secs\n+ 60 * (BufferPtr->tod_mins + 60 * BufferPtr->tod_hours - BufferPtr->tod_timezone)\n+ 90);\nAT_INFO->Flags = JOB_NONINTERACTIVE;\nAT_INFO->DaysOfMonth = 0;\nAT_INFO->DaysOfWeek = 0;\nNetScheduleJobAdd(UncServerName, AT_INFO, &v16)\n\n\n## C2 Communications\n\nDisttrack extracts the communication component from its resource named “PKCS7”,\ndecrypts it and saves the resulting cleartext to the file %WINDOWS%\\system32\\netinit.exe.\n\nThe communication module interacts with its C2 server using HTTP requests. The\ncommunications modules in both the x86 and x64 variants of Disttrack we analyzed were\nconfigured to use “1.1.1.1:8080” for its C2 server, which does not host an operational\nDisttrack C2 server. The lack of an operational C2 server suggests that the threat actors did\nnot desire remote access to infected systems, rather the actors sought to render them\nunusable instead. If the modules were configured with an operational C2 server, the module\nwould generate an HTTP GET request that resembles the following:\n\nThe interesting part of the request above is that the host \"server\", the URL\n\"category/page.php\", the parameter \"shinu\" and the user-agent \"Mozilla/5.0 (MSIE 7.1;\nWindows NT 6.0)\" are hardcoded into the tool. The data in \"shinu\" parameter is a\ncombination of the system's tickcount, local IP address, operating system version, keyboard\nlayout and the contents of %WINDOWS%\\inf\\netimm173.pnf. The C2 server can respond to\nthis HTTP request with one of the following two commands:\n\n**Command** **Description**\n\nE Provides an executable to run on the system. The executable is saved to\n%TEMP%\\Temp\\filer\\<tickcount>.exe\n\nT Sets the time to start wiping the system, by writing the date to\n%WINDOWS%\\inf\\usbvideo324.pnf.\n\n\n-----\n\nWe believe the HTTP host value of server and the non-operational 1.1.1.1 C2 address\nmay suggest that the communication module is created with a builder tool, which in this case\nthe actor mistakenly or purposefully did not provide an active C2 server when building this\nmodule. While completely speculative, the word “shinu” used as a parameter could be a\nreference to the Arabic slang for the word “what”, as well as a reference to a village name in\nnorthwestern Iran.\n\n## Disttrack Data Destruction\n\nThe Disttrack dropper is responsible for installing the wiper component of this Trojan,\nhowever, it will only activate this component if the system time is greater than a preset date.\nThe dropper obtains a date used to activate the wiping functionality by reading a specific file,\nor using a hardcoded timestamp of \"2016/11/17 20:45\". The file containing this timestamp is\nnamed \"\\inf\\usbvideo324.pnf\", which is not initially installed but is provided by the C2 server\nif it sends the communications module the \"T\" command. The \"usbvideo324.pnf\" file would\nhave the following structure:\n\nBYTE year;\n\nBYTE month;\n\nBYTE day;\n\nBYTE hour;\n\nBYTE year;\n\nBYTE minute;\n\nIf the dropper determines the system date is larger than the specified date, the dropper will\nextract the wiper component from a resource named \"PKCS12\" and save it to the \"system32\"\nfolder with one of the following filenames appended with a \".exe\" extension:\n\ncaclsrv\ncertutl\nclean\nctrl\ndfrag\ndnslookup\ndvdquery\nevent\nfindfile\ngpget\nipsecure\niissrv\nmsinit\nntfrsutil\nntdsutl\npower\n\n\n-----\n\nrdsadmin\nregsys\nsigver\nrouteman\nrrasrv\nsacses\nsfmsc\nsmbinit\nwcscript\nntnw\nnetx\nfsutl\nextract\n\nThe dropper then runs the wiper component with a command line argument of \"1\". The wiper\ncomponent extracts a driver from its resource section and decrypts it with a 226 byte XOR\nkey. The wiper saves the extracted driver to \"C:\\Windows\\System32\\Drivers\\drdisk.sys\" and\ninstalls the kernel driver by creating a service named \"drdisk\" with the following command\nline commands:\n\n\n1\n2\n3\n\n\nsc create drdisk type= kernel start= demand binpath=\nSystem32\\Drivers\\drdisk.sys 2>&1 >nul\nsc start drdisk 2>&1 >nul\n\n\nThe kernel driver is a commercial product that the attackers are abusing called RawDisk by\nEldoS Corporation, which provides direct access to files, disks and partitions. It appears that\nthe “drdisk.sys” driver (SHA256:\n4744df6ac02ff0a3f9ad0bf47b15854bbebb73c936dd02f7c79293a2828406f6) is the exact\nsame driver as used in the Shamoon attack in 2012. With the kernel driver installed, the\nwiper can begin writing to protected system locations, such as the master boot record (MBR)\nand partition tables of storage volumes. The wiper can be configured to overwrite files in\nthree different ways, specified by a configuration setting of \"F\", \"R\" or \"E\". If configured with\nthe \"F\" setting, the wiper loads a resource named AJKEOA, which extracts a JPEG image to\nuse to overwrite files and partition tables. If the wiper is configured with the \"E\" setting, the\nwiper will encrypt the contents of the file using a random value as a key and the RC4\nalgorithm. If configured with the \"R\" setting, the wiper will overwrite files with the random\nvalues that would be used as a key in \"E\".\n\nThe sample we analyzed was configured with \"F\", meaning it would overwrite files with an\nimage obtained from its resource section. The image extracted is a picture of a Syrian boy\nnamed Alan Kurdi, whose drowning on September 2, 2015 received international attention in\nregards to the ongoing Syrian refugee crisis. The previous Shamoon attack in 2012 used an\nimage of a burning American flag, continuing the political image theme.\n\n\n-----\n\nFrom a functionality standpoint, the wiper relies on EldoS RawDisk driver to overwrite files\non the system. During this activity, we noticed the wiper changing the system time to August\n2012, as the temporary license key for the RawDisk driver requires the system time to not\nexceed the month of August, which is when the temporary license would expire. This\nmodification to the system time was seen in the previous campaign, and the temporary\nlicense key within the wiper component is the exact same as wiper component from the 2012\nattacks. The wiper itself queries the following registry keys to obtain a list of partitions to\noverwrite:\n\n\n1\n2\n\n\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\FirmwareBootDevice\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\SystemBootDevice\n\n\nIn addition to these partitions, the wiper attempts to overwrite files and subfolders within in\nthe following folders:\n\n\n1\n2\n3\n4\n\n\nC:\\Documents and Settings\nC:\\Users\nC:\\Windows\\System32\\Drivers\nC:\\Windows\\System32\\Config\\systemprofile\n\n\nAfter overwriting these files and the partition tables, the wiper issues the following command\nto restart the system:\n\n1 shutdown -r -f -t 2\n\nThe arguments and switches used in the “shutdown” command above forces all running\napplications to close and causes the system to reboot (‘-r’) after 2 seconds (‘-t 2’). This\ncommand does result in a dialog prompt, seen in Figure 1, that informs the user that the\nsystem is shutting down.\n\n\n-----\n\n_Figure 1 Dialog prompt displayed when the Wiper component runs the 'shutdown' command_\n\nWith the partition tables overwritten, the system will no longer be able to properly boot, which\nrenders the system unusable. During analysis, our analysis system was rendered unusable,\nas the virtual machine was unable to find the operating system during boot up, as seen in\nFigure 2.\n\n\n-----\n\n_Figure 2 Analysis virtual machine unable to boot after executing Disttrack Wiper_\n\n## Conclusion\n\nAfter a four year hiatus, threat actors likely associated with the Shamoon attack campaign\n[have used their Disttrack malware to target at least one organization in Saudi Arabia. The](https://www.symantec.com/connect/blogs/shamoon-back-dead-and-destructive-ever)\ncurrent attack campaign has several TTP overlaps with the original Shamoon campaign,\nespecially from a targeting and timing perspective. Also, Disttrack malware used in the\nrecent attacks is very similar to the variant used in the 2012 attacks, which uses the exact\nsame RawDisk device driver as well (down to the same, temporary license key).. The main\npurpose of the Disttrack malware is to overwrite files and storage partitions in an attempt to\ndestroy data and render the system unusable. To maximize its destruction, the Disttrack tool\nattempts to spread to other systems on the network using stolen administrator credentials,\nwhich suggests that the threat actors had previous access to the network or carried out\nsuccessful phishing attacks prior to the attack using Disttrack.\n\nPalo Alto Networks customers are protected from Disttrack:\n\nAll known samples have a malicious verdict in WildFire\n[AutoFocus customers can monitor Disttrack activity via the Disttrack tag](https://autofocus.paloaltonetworks.com/#/tag/Unit42.Disttrack)\n\n## Indicators of Compromise\n\n**Disttrack Droppers**\n\n\n-----\n\n47bb36cd2832a18b5ae951cf5a7d44fba6d8f5dca0a372392d40f51d1fe1ac34 (x64)\n394a7ebad5dfc13d6c75945a61063470dc3b68f7a207613b79ef000e1990909b\n(x86)\n\n**Communication Components**\n\n772ceedbc2cacf7b16ae967de310350e42aa47e5cef19f4423220d41501d86a5 (x64)\n61c1c8fc8b268127751ac565ed4abd6bdab8d2d0f2ff6074291b2d54b0228842 (x86)\n\n**Wiper Components**\n\nc7fc1f9c2bed748b50a599ee2fa609eb7c9ddaeb9cd16633ba0d10cf66891d8a (x64)\n\n128fa5815c6fee68463b18051c1a1ccdf28c599ce321691686b1efa4838a2acd (x86)\n\n**EldoS RawDisk Samples**\n\n5a826b4fa10891cf63aae832fc645ce680a483b915c608ca26cedbb173b1b80a (x64)\n4744df6ac02ff0a3f9ad0bf47b15854bbebb73c936dd02f7c79293a2828406f6 (x86)\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-11-30 - Shamoon 2- Return of the Disttrack Wiper.pdf"
    ],
    "report_names": [
        "2016-11-30 - Shamoon 2- Return of the Disttrack Wiper.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535967,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1653698030,
    "ts_modification_date": 1653698030,
    "files": {
        "pdf": "https://archive.orkl.eu/3d236cc9e8bffaf910e9077554e8ee0b04ad1495.pdf",
        "text": "https://archive.orkl.eu/3d236cc9e8bffaf910e9077554e8ee0b04ad1495.txt",
        "img": "https://archive.orkl.eu/3d236cc9e8bffaf910e9077554e8ee0b04ad1495.jpg"
    }
}