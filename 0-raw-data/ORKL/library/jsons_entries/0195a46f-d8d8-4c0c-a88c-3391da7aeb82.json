{
    "id": "0195a46f-d8d8-4c0c-a88c-3391da7aeb82",
    "created_at": "2023-01-12T14:59:49.14639Z",
    "updated_at": "2025-03-27T02:15:41.652217Z",
    "deleted_at": null,
    "sha1_hash": "98113d44b914645363ff5c0d72d8d77c0b440084",
    "title": "2022-05-02 - Attack Campaigns that Exploit Shortcuts and ISO Files",
    "authors": "",
    "file_creation_date": "2022-05-28T21:43:16Z",
    "file_modification_date": "2022-05-28T21:43:16Z",
    "file_size": 1654166,
    "plain_text": "# ショートカットとISOファイルを悪用する攻撃キャンペーン - セキュ リティ研究センターブログ\n\n**security.macnica.co.jp/blog/2022/05/iso.html**\n\n[竹内](https://security.macnica.co.jp/blog/author/author31bfd/) 寛\n\n2022年5月 2日 16:04\n\n## ショートカットとISOファイルを悪用する攻撃キャンペーン\n\n[マルウェア](https://security.macnica.co.jp/blog/malware/)\n[標的型攻撃](https://security.macnica.co.jp/blog/targeted/)\n\n[ツイート](https://twitter.com/share)\n\nセキュリティ研究センターでは、2022年4月に日本の組織を標的としたスピアフィッシングを確認し、それ\nを起点とする攻撃の分析を行いました。その攻撃はショートカットファイルやISOファイルの悪用、マルウ\nェアの１つは今年3月にリリースされたGo言語 1.18で開発されており解析が困難であるなどの特徴がみられ\n\n\n-----\n\nました。分析を通して得た関連情報から今回の攻撃は3月頃から続いている攻撃キャンペ ンの１つである\nと考えています。ここでは、導入済みのセキュリティ対策が今回の攻撃に有効であるかの検討やインシデン\nト対応の参考になるよう分析の詳細結果について共有します。\n\n### 初期アクセス(Initial Access)\n\n標的組織にスピアフィッシングメールを配送します。そのメールに記載したURLからファイルをダウンロー\nド、実行するように誘導します。ダウンロードされるファイルの種類は、ショートカットファイルとISOフ\nァイルの２種類を確認しています。それぞれの攻撃フローを以下に解説します。\n\n### ショートカットファイルのケース\n\nこのケースでは、ダウンロードしたZIPファイルの中にショートカットファイルが２つ含まれています。図1\nのようにアイコンを偽装しPDFファイルにみせかけています。\n\n図1. アイコン偽装されたショートカットファイル\n\nショートカットファイルを実行するとWindows10に付属しているScriptRunner.exeとcurl.exeを使い外部から\nWord 97-2003 テンプレートファイルをダウンロードし、Wordのスタートアップフォルダに保存します。こ\nれにより以降Wordを起動した際には、ダウンロードしたテンプレートファイルが自動的に実行されるように\nなります。\n\n実行される処理は、2つのショートカットファイルで共通しています(図2)。\n\n図2. ショートカットファイルに設定されているコマンド\n\nテンプレートファイルはマクロを含んでおり、更に新たなテンプレートファイルを外部からダウンロードし\n開こうとします。調査時点では次のファイルは入手できず、以降の攻撃については解明できていません。\n\n\n-----\n\n図3. 分析により判明したショートカットファイルを悪用する攻撃の流れ\n\n### ISOファイルのケース\n\nこのケースでは、メールに記載されたURLからISOファイルがダウンロードされます。\n\nISOファイルは、光学ディスク（CD/DVD/Blu-ray Disc）の中身をまとめたイメージファイルです。\nWindows10では、標準機能によりISOファイルをダブルクリックして開くことができます(図4)。\n\n図4. ISOファイルの中身\n\nダウンロードされたISO ファイルの中には図4にあるファイル以外にも、隠し属性が付与され表示されなく\nなっているファイルが存在します。7-Zipなどのツールやエクスプローラのメニューで隠しファイルを表示す\nる設定にするとそれらのファイルを視認することができます(図5)。\n\n図5 . 隠しファイルの表示を有効にしたISOファイルの中身\n\n拡張子を表示しない設定であると、ISOファイルの中にはドキュメントファイル２つしか表示されず(図6)、\nユーザが実行してしまう可能性が高くなります。\n\n\n-----\n\n図6. 拡張子の表示をしない設定にした場合のISOファイルの中身\n\nISOファイルには以下のようなファイルが含まれています。\n\nfile.docx 無害なデコイファイル\n\nfile2.docx 無害なデコイファイル\n\nwwlib.dll マルウェア\n\n案内.docx.exe 正規Wordアプリの実行ファイルWinWord.exeをリネームしたもの\n\n申込書.doc.exe 正規Wordアプリの実行ファイルWinWord.exeをリネームしたもの\n\n- 正規Wordアプリをリネームしたファイル名は攻撃毎に異なっています。\n\nISOファイルの中にある\"案内.docx.exe\" と \"申込書.doc.exe\"は、正規のWordアプリケーション\n(WinWord.exe)をリネームしたもので、実際にはマルウェアではありません。隠し属性が設定されているフ\nァイルの１つである\"wwlib.dll\"がマルウェアで、\"案内.docx.exe\" 、もしくは\"申込書.doc.exe\"を実行した際\nに\"wwlib.dll\"がロードされて、悪意のあるコードが実行されます。\n\nWinWord.exeは\"wwlib.dll\"をロードするため、悪意のあるDLLファイル名を同じ\"wwlib.dll\"にして同じフォル\nダ内に設置すると正規のDLL でなく悪意のあるDLLがロードされることになります。\n\nこのように悪意のあるDLLのファイル名を正規の実行ファイルがロードするものと同じ名前にし、正規の実\n行ファイルにロードさせて検知を回避しようとするテクニックは、\"DLL Side-Loading\"と呼ばれています(図\n7)。\n\n図7. DLL Side-Loading\n\n\n-----\n\n**Go言語(golang)で開発されたインジェクタ** **wwlib.dll**\n\nwwlib.dllは、実行ファイルからFMain関数が呼ばれると、ロードした実行ファイル名によって処理を変えるよ\nうになっています。\n\n\nファイル名\nに\"docx\"が含まれて\nいる\n\nファイル名\nに\"doc\"が含まれて\nいる\n\nファイル名\nに\"NvData.doc\"が含\nまれている\n\n\nISOファイル内にあるデコイファイルの\"file.docx\"を開き永続化処理を行う。\n\nISOファイル内にあるデコイファイルの\"file2.docx\"を開き永続化処理を行う。\n\n180秒スリープした後に、外部サーバにHTTP GETでアクセスしダウンロードした\nコードを新たに起動したExplorer.exeにインジェクションする。(Process\nHollowing)\n\n\n上記以外 存在しないドメインのURL https[:]//abc.cbasade[.]com/jp.js へ接続。Anti-Analysisが\n目的と思われる。\n\n永続化処理として、感染機器再起動後に自動起動されるようにWinWord.exeを\"NvData.doc.exe\"にリネーム\nして、wwlib.dllと合わせて\"C:\\Users\\<ユーザ名>\\AppData\\Roaming\\Microsoft\\Windows\\Nvida\"に保存した後\nにPowerShellを使いログオンスクリプトとして登録します。\n\n----------------------------------------------------------------------------------\n_powershell.exe -c \"powershell -c 'New-ItemProperty \\\"HKCU:\\Environment\\\" UserInitMprLogonScript_\n\n_-value \\\"C:\\Users\\<ユーザ名>\\AppData\\Roaming\\Microsoft\\Windows\\Nvida\\NvData.doc.exe\\\"_\n\n_-PropertyType string | Out-Null'\"_\n\n----------------------------------------------------------------------------------\nこれにより[ファイル名に\"NvData.doc\"が含まれている]の条件になり、以降感染機器に再度ログインしたタイ\nミングで外部サーバに接続をするようになります。\n\n今回分析した検体は下記URLにアクセスします。\n\nhttps[:]//abc.mbusabc[.]com/Events\n\nまた、ユーザエージェントは固定で埋め込まれています。\n\nMozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.60\nYaBrowser/22.12.0.966 Yowser/2.5 Safari/537.36\n\n\n-----\n\n図8. 分析により判明したISOファイルを悪用する攻撃の流れ\n\n**Cobalt Strikeの可能性**\n\n今回の調査では、インジェクターであるwwlib.dll が外部サーバからダウンロードしたコードは入手できませ\nんでした。\n\nしかし公開サービスにて興味深い検体の存在を確認しました。\n\nSHA256: c2ccdecfbe1b356392a5cb9ed7afb0ef41e8732d5d55dd60b62884fa76831918\n\nFile name: ABU.exe\n\nこの検体は、Cobalt Strikeのbeacon(RAT)をメモリ上にロードするStagerで今年1月下旬に日本から公開サー\nビスへアップロードされています。\n\nこのStagerは今回分析したインジェクターと同じ特徴的なUser-Agentで同じパス(/Events)に接続に行くこと\nから、今回の攻撃でもCobalt Strike Stagerがインジェクションされた可能性もあると考えています。\n\n### Go言語(golang)で開発された検体解析の課題へのアプローチ\n\ngolangでビルドされた実行ファイルには必要なライブラリが全てスタティックリンクされるため、解析の際\nにはライブラリ関数かマルウェアの関数を判別するのが非常に大変な作業になります。ただし、シンボル情\n報が削除されたとしてもgolangでビルドされた実行ファイルのpclntab (Program Counter Line Table)と呼ば\nれるデータ領域には関数名が残されています。IDA proやMandiantの公開ツール GoRecSym[1]は、その情報\nを使い関数をリネームしてくれます。残念ながらまだ原因は特定できていませんが、1.18でビルドしシンボ\nル情報が削除された実行ファイルからは既存ツールではpclntabから正しい関数のアドレスの抽出ができず関\n数のリネームに失敗してしまいました。そのため今回の分析では、課題は残っていますがgolang1.18 でビル\nドされシンボル情報が残っているx86実行ファイルを使いIDA Proの関数を識別するFLIRT(Fast Library\nIdentification and Recognition Technology)シグネチャを独自に作成しました。作成にはMandiantが公開して\nいるida2pat.py[2]をpython3とIDA 7.x APIにリファクタリングしたもの[3]を使用しました。\n\n*1 [Ready, Set, Go -- Golang Internals and Symbol Recovery](https://www.mandiant.com/resources/golang-internals-symbol-recovery)\n\n*2 [FLARE IDA Pro Script Series: Generating FLAIR function patterns using IDAPython](https://www.mandiant.com/resources/flare-ida-pro-script)\n\n\n-----\n\n3 [https://github.com/0xebfehat/flare-ida/blob/master/python/flare/idb2pat.py](https://github.com/0xebfehat/flare-ida/blob/master/python/flare/idb2pat.py)\n\n図9. 独自に作成したgo.1.18 x86向けFLIRTシグネチャ適用前後の比較(左:適用前、右:適用後)\n\n### おわりに\n\n今回の攻撃では、メールに記載されたURLリンクからHTTPSでダウンロードされることからメールやネット\nワークセキュリティでのブロック・検知が困難になっています。そのためエンドポイント上での検知・ブロ\nックがキーになると考えています。また、ショートカットファイルやISOファイルを悪用した攻撃は、\nEmotetやIcedIDを使う攻撃でも使われており注意が必要です。\n\n今回ショートカットファイルや多段のダウンロード[4]など特徴的なTTPを観測しました。これらは過去観測\nしたDarkHotelのTTPと類似していることから根拠の確度は低い(Low Confidence)ながら今回の攻撃キャンペ\nーンにも関与しているのではないかという印象を分析した結果から受けています。\n\n*4 [標的型攻撃の実態と対策アプローチ](https://www.macnica.co.jp/business/security/manufacturers/files/mpressioncss_ta_report_2019_2.pdf) 第3版\n\n### Appendix 関連インディケータ\n\nNo Type Indicator Note\n\n1 sha256 c2ccdecfbe1b356392a5cb9ed7afb0ef41e8732d5d55dd60b62884fa76831918 Cobalt Strike\nStager https\nx86\n\n2 sha256 dde42da10fd716ab521451826bb4e1ff030e893bb80cb61b4ea106bc76fe94ad LNKファイル\n\n3 sha256 64f41d1eefd0331f591d128aa0c70e8bd21e580f555b6a5358b9617906e5a68d LNKファイル\n\n\n-----\n\n4 Domain fd471sx.disknxt[.]com HTTPS。デコ\nイファイルの\nダウンロード\n元\n\n5 Domain eeb71bf6c.disknxt[.]com HTTPS。テン\nプレートファ\nイルのダウン\nロード元\n\n6 Domain resource.officehoster[.]com HTTP。テンプ\nレートファイ\nルのダウンロ\nード元\n\n7 IP 172.105.229[.]93 6のPassive\nDNS\n\n8 Domain 6bfeeb71c.disknxt[.]com HTTPS。ISO\nファイルのダ\nウンロード元\n\n9 IP 149.28.16[.]63 4,5,8の\nPassive DNS\n\n10 URL https[:]//abc.mbusabc[.]com/Events wwlib.dllの通\n信先\n\n11 IP 172.104.122[.].93 10のPassive\nDNS\n\n\n12 file\nname\n\n\nNvData.doc.exe 正規Word実行\nファイル\n(WinWord.exe)\nをリネームし\nたもの\n\n\n13 sha256 6c959cfb001fbb900958441dfd8b262fb33e052342948bab338775d3e83ef7f7 正規Word実行\nファイル\n(WinWord.exe)\n\n[ツイート](https://twitter.com/share)\n\nこの記事の筆者\n\n\n-----\n\n[竹内](https://security.macnica.co.jp/blog/author/author31bfd/) 寛\n\nリバースエンジニアリング（マルウェア解析）を担当。彼の手に渡ったマルウェアはまさに“まな板の上の\n鯉”と同じ。あとは解析されるがまま。最近の楽しみは、ハイボールを片手に海外ドラマを鑑賞するか、マン\nトノン侯爵夫人に会うこと。好きなマシン語は、EB FE。\n\n前へ\n\nQNAP社製NASを狙うDeadBoltランサムウェアに関連した調査\n\n\n-----",
    "language": "JA",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-02 - Attack Campaigns that Exploit Shortcuts and ISO Files.pdf"
    ],
    "report_names": [
        "2022-05-02 - Attack Campaigns that Exploit Shortcuts and ISO Files.pdf"
    ],
    "threat_actors": [
        {
            "id": "1dadf04e-d725-426f-9f6c-08c5be7da159",
            "created_at": "2022-10-25T15:50:23.624538Z",
            "updated_at": "2025-03-27T02:00:55.508759Z",
            "deleted_at": null,
            "main_name": "Darkhotel",
            "aliases": [
                "Darkhotel",
                "DUBNIUM",
                "Zigzag Hail"
            ],
            "source_name": "MITRE:Darkhotel",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b13c19d6-247d-47ba-86ba-15a94accc179",
            "created_at": "2024-05-01T02:03:08.149923Z",
            "updated_at": "2025-03-27T02:05:17.422065Z",
            "deleted_at": null,
            "main_name": "TUNGSTEN BRIDGE",
            "aliases": [
                "DUBNIUM ",
                "DarkHotel ",
                "CTG-1948 "
            ],
            "source_name": "Secureworks:TUNGSTEN BRIDGE",
            "tools": [
                "Nemim"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2b4eec94-7672-4bee-acb2-b857d0d26d12",
            "created_at": "2023-01-06T13:46:38.272109Z",
            "updated_at": "2025-03-27T02:00:02.790029Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "DUBNIUM",
                "Fallout Team",
                "Luder",
                "Tapaoux",
                "Shadow Crane",
                "APT-C-06",
                "SIG25",
                "Karba",
                "Nemim",
                "Nemin",
                "G0012",
                "ATK52",
                "T-APT-02",
                "TUNGSTEN BRIDGE",
                "Zigzag Hail"
            ],
            "source_name": "MISPGALAXY:DarkHotel",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535589,
    "ts_updated_at": 1743041741,
    "ts_creation_date": 1653774196,
    "ts_modification_date": 1653774196,
    "files": {
        "pdf": "https://archive.orkl.eu/98113d44b914645363ff5c0d72d8d77c0b440084.pdf",
        "text": "https://archive.orkl.eu/98113d44b914645363ff5c0d72d8d77c0b440084.txt",
        "img": "https://archive.orkl.eu/98113d44b914645363ff5c0d72d8d77c0b440084.jpg"
    }
}