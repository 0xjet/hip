{
    "id": "6c8a676a-dc02-49f3-b0b3-a5535ba64795",
    "created_at": "2023-01-12T15:03:04.07646Z",
    "updated_at": "2025-03-27T02:05:34.657473Z",
    "deleted_at": null,
    "sha1_hash": "39cbca6c9efbe465c3275273d7fa6d48a2666f49",
    "title": "2021-07-21 - FormBook Malware Returns- New Variant Uses Steganography and In-Memory Loading of multiple stages to steal data",
    "authors": "",
    "file_creation_date": "2022-05-28T19:31:55Z",
    "file_modification_date": "2022-05-28T19:31:55Z",
    "file_size": 1176409,
    "plain_text": "# FormBook Malware Returns: New Variant Uses Steganography and In-Memory Loading of multiple stages to steal data\n\n**blogs.quickheal.com/formbook-malware-returns-new-variant-uses-steganography-and-in-memory-loading-of-multiple-**\nstages-to-steal-data/\n\nJuly 21, 2021\n\nQuick Heal Security Lab has seen a sudden increase in dotnet samples which are using\nsteganography. Initially, in the static analysis, not much information is available. It\nresembles some simple application going by the method name. On the dynamic side, some\nshow the activity but another check for sandboxing environment. Apart from this, even on\nexecution, it loads multiple memory stages that contain numerous long periods of sleep.\nOne such file received in our lab was of Formbook malware. Formbook stealer has been\nsold on hacking forms since 2016 as-a-service.\n\nIn this blog, we will go through those multiple stages and analysis of the final payload. The\nfinal payload is also complicated due to various threads creation and sleeps in between.\n\n**Technical Analysis**\n\n\n-----\n\n**SSO.exe**\n\nIn the resource of sso.exe, there is an image that indicates the use of Steganography.\nHowever, this resource is not used at this level. There is one more resource present which\ninitially is difficult to find. While going through the code of decryption, this 2nd resource was\nidentified as stage 1.\n\nFigure 1 GregorianCalendar in Resource, contains stage 2 file\n\n\n-----\n\nFigure 2 Another Resource naming Tree, just below the blue line there are some red dots visible,\n\ncontains stage 1 file\n\nAt the entry point, there is a single line code to execute the form.\n\nFigure 3 Main function, calls the constructor of Form1 which decrypts stage 1 file\n\nIf we go to the Form1 code, there isn’t much information present. But when we check the\nForm1 class, we can see in its constructor a call to method ISectionEntry.\n\nFigure 4 Constructor Code, call to decryption routine of stage 1 file\n\nISectionEntry contains the code to get Pixels(Fig 5), convert to integer and save it in an\narray(Fig 6) and then call to MessageSurrogateFilter(array) with the buffer passed as a\nparameter.\n\n\n-----\n\nFigure 5 Decryption Routine from Image, decrypting stage 1 PE file\n\nFigure 6 Buffer Containing stage 1 PE file\n\nMessageSurrogateFilter() method then loads the decrypted assembly (SimpleUI.dll) into the\nmemory and invokes its SeclectorX() method with some arguments, which will be explained\nlater in Stage 1.\n\nFigure 7 Assembling Loading of stage 1 in Memory and invoking its member SelectorX with\n\nresource name, decryption key and assembly name\n\n\n-----\n\n**Stage 1:**\n\n\nFigure 8 SimpleUI.dll loaded in memory\n\nFigure 9 SimpleUI.dll\n\n\nSince there are not many methods present in this file, we directly go through the code\nof the SelectorX method. As we can see in Figure 7, there are three values passed to\nthis function which are:\nRestrictedError = 477265676F7269616E43616C656E646172 = GregorianCalendar\n(Name of resource in Main file, resource shown in Fig 1)\nValueEnumerator = 72584C4F594D6D556D = rXLOYMmUm (Key for decryption)\nProject Name= Agent.Common (Main File)\ncba() method contains the code to get the Pixels from the image and convert to\nInteger and save it in an array, and XeH contains code to convert the hex value into a\nstring.\n\n\n-----\n\nFigure 10 SelectorX method accesses the GregorianCalendar resource from main assembly and\n\ndecrypts it using the key passed under fgh() method\n\nFigure 11 Size of Buffer to be initialized for stage 2\n\nfgh() method’s decryption routine is a simple XOR with 2 values in which the “bytes” array\ncontains a Unicode version of the Key (mentioned as ValueEnumerator above).\n\n\n-----\n\nFigure 12 fgh() method code for decryption, normal xoring\n\nAfter decryption, the assembly is again loaded in Memory.\n\nFigure 13 Stage 2 assembly loaded in memory\n\n**Stage 2:**\n\nFigure 14 Stage 2 Assembly\n\n\n-----\n\nIt becomes difficult to analyze with these unicoded function name.\n\nFigure 15 Stage2 Unicode method names\n\nIn this stage 2 assembly, a method named Fedree() is called, whose constructor contains\nthe code to decrypt and inject the final payload.\n\nIn the decryption routine first, the name of the resource is decrypted to s2pCN (resource in\nstage 2), Loads the resource and passes it to the XOR_DEC along with a KEY. Decrypted\nbuffer is then passed to Unscramble function where it brings another dotnet file.\n\nFigure 16 Decryption routine in Stage 2 which brings final payload\n\nXOR_DEC contain simple xor with obfuscated code.\n\nFigure 17 Xor_Dec method decrypts the final payload\n\n\n-----\n\nUnscramble function forms the final payload.\n\nFigure18 Unscramble Method code brings final payload PE file\n\nAfter decryption, it does process hollowing by creating sso.exe’s process in suspended\nmode.\n\nFigure 19 Process Hollowing Code to inject the final payload\n\nFigure 20 Flag to CreateProcess in Suspended Mode\n\n**Final Payload:**\n\nThe injected file is the final Payload of Formbook, which has around 1500 methods with\nrandom names.\n\nThis contains 2 different Base64 encoded strings.\n\n\n-----\n\nFigure 21 Encoded String 1 contains CnC information and configuration\n\n2nd base64 string contains 5 modules which are later loaded in memory and executed.\n\n\nFigure 22 Encoded String 2\n\nThe strings are converted from base64, then reversed and replaced by specified characters\nand again base64 decoded.\n\nFigure 23 Decryption Routine to decrypt CnC details in string 1 and different modules present in\n\nstring 2\n\nThe resultant data for 1 decoded string is CnC servers, mutex name and somest\nconfigurations.\n\nFigure 24 Decoded string 1 data\n\nIt also creates a bat file to check for network connection and again start the process and\ndelete the bat file.\n\nFigure 25 Content of Bat file\n\nAfter decrypting the data it checks for the mutex if already present it exits. In configuration\nthe value of “AUR” tag is true, it takes 2 running process’s names, from 1 it takes the name\nof the process, from the other it takes any folder name from the parent directory and copies\nitself to this location with first’s process name. Along with this, it keeps a file with a name as\na hash of process name and some randomly generated garbage data.\n\n\n-----\n\nFigure 26 Copies itself to various locations obtained from running processes path and also obtains\n\nthe name from the same\n\nIt also schedules tasks for these copied files.\n\nFigure 27 Creates Schedule task for the copied files\n\nNext, it loads different modules which it has decoded initially and loads them into memory\nand invokes different methods.\n\nFigure 28 code to Load different modules and call to different methods based on their availability\n\nThen it tries to steal browser information like cookies, passwords, forms, history, autofill,\ncredit card information also takes screenshots, clipboard data, discord tokens, FileZilla,\ntelegram data, discord tokens, steam data.\n\nThere was also a module that will compile the code for DCRat at runtime on receiving\ncommands from CnC.\n\n\n-----\n\nFigure 29 Code to compile DCRat code at runtime\n\nOther different modules present are:\n\n1. AntiAnalysis Module\n\nIt has kept all strings in encrypted form under a list of various techniques.\n\nFigure 30 Encoded Values for Strings used in anti-analysis module\n\nContains various techniques to identify if it’s running under VM or Sandboxing environment\nif there are any monitoring processes running. Also, a way to identify VM/Sandboxing is by\nchecking physical Memory.\n\n\n-----\n\nFigure 31 Anti Analysis Module\n\n1. USBSpreadDCLIB Module\n\nContains code to spread to USB drives by creating an autorun.\n\nFigure 32 USBSPreadDCLIB module\n\n1. MiscellaneousInfoGraber module\n\nContains code to collect a List of installed software’s, running processes, time zone\ninformation, active TCP connections, local network connections available, list of connected\nUSB drives.\n\n\n-----\n\nFigure 33 Collects registry for uninstalling entries\n\nFigure 34 List of Running processes\n\nFigure 35 TimeZone information\n\n1. FileGrabber module\n\nCollects all the files\n\n\n-----\n\nFigure 36 File Grabber Modules collects files\n\n1. BSODProtection Module\n\nAt this point, this module is not in a complete state. This shows that it is still under\ndevelopment.\n\n**Conclusion:**\n\nThis seems to be malware that is still being developed. We haven’t received Initial Vector\nyet, but it appears to be downloaded by a malicious doc/Xls file, which is spread through\nemails. Users should avoid opening emails, documents sent by unknown senders and keep\nthe AV updated. We detect all the modules and stages with Trojan.Formbook and\nTrojan.YakbeexMSIL.ZZ4\n\n**MITRE ATT&CK TTPs:**\n\nVirtualization/Sandbox Evasion: System Checks T1497.001\n\nScheduled Task/Job T1053\n\nProcess Injection: Process Hollowing T1055.012\n\nMasquerading T1036\n\nCredentials from Password Stores T1555\n\nClipboard Data T1115\n\nData from Configuration Repository T1602\n\n**IOC:**\n\n\n-----\n\n1D13A84AA671B75F66F4C7FCE8339619291D4A43 exe\n6C73DC53F1AF57E1B2B404F2E20A9AECBAA80051 dll\nDC7CF9544AA5B4928697B4C49C94A60211F025A1 dll\n9577B2B5C4FBA6B2AFA65C5161FCE75F48E75D5D dll\n7E314AE69FC9A613A4A5356556F73E027B540141 dll\n32D97D1729D9A5919CBE1AE76F46BCDB9620153C dll\n\n**Rumana Siddiqui**\n\n[Follow @](https://twitter.com/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-21 - FormBook Malware Returns- New Variant Uses Steganography and In-Memory Loading of multiple stages to steal data.pdf"
    ],
    "report_names": [
        "2021-07-21 - FormBook Malware Returns- New Variant Uses Steganography and In-Memory Loading of multiple stages to steal data.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535784,
    "ts_updated_at": 1743041134,
    "ts_creation_date": 1653766315,
    "ts_modification_date": 1653766315,
    "files": {
        "pdf": "https://archive.orkl.eu/39cbca6c9efbe465c3275273d7fa6d48a2666f49.pdf",
        "text": "https://archive.orkl.eu/39cbca6c9efbe465c3275273d7fa6d48a2666f49.txt",
        "img": "https://archive.orkl.eu/39cbca6c9efbe465c3275273d7fa6d48a2666f49.jpg"
    }
}