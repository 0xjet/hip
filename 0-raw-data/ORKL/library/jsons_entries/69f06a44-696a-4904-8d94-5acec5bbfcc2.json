{
    "id": "69f06a44-696a-4904-8d94-5acec5bbfcc2",
    "created_at": "2022-10-25T16:48:16.018294Z",
    "updated_at": "2025-03-27T02:11:47.822224Z",
    "deleted_at": null,
    "sha1_hash": "ebf2fddb208f530e519cdab09a3fc06f06749d5c",
    "title": "",
    "authors": "",
    "file_creation_date": "0001-01-01T00:00:00Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 14935331,
    "plain_text": "**_Paper_** **WannaCry Ransomware:**\n# Analysis of Infection, Persistence, Recovery Prevention and Propagation Mechanisms\n\n### Maxat Akbanov[1], Vassilios G. Vassilakis[2], and Michael D. Logothetis[3]\n\n1 Department of Computer Science, University of York, York, United Kingdom\n2 University of York, York, United Kingdom\n3 WCL, Dept. of Electrical and Computer Engineering, University of Patras, Patras, Greece\n\nhttps://doi.org/10.26636/jtit.2019.130218\n\n\n**Abstract—In recent years, we have been experiencing fast pro-**\n**liferation of different types of ransomware targeting home**\n**users, companies and even critical telecommunications in-**\n**frastructure elements. Modern day ransomware relies on**\n**sophisticated infection, persistence and recovery prevention**\n**mechanisms. Some recent examples that received significant**\n**attention include WannaCry, Petya and BadRabbit. To de-**\n**sign and develop appropriate defense mechanisms, it is im-**\n**portant to understand the characteristics and the behavior of**\n**different types of ransomware. Dynamic analysis techniques**\n**are typically used to achieve that purpose, where the mali-**\n**cious binaries are executed in a controlled environment and**\n**are then observed.** **In this work, the dynamic analysis re-**\n**sults focusing on the infamous WannaCry ransomware are**\n**presented. In particular, WannaCry is examined, during its**\n**execution in a purpose-built virtual lab environment, in order**\n**to analyze its infection, persistence, recovery prevention and**\n**propagation mechanisms. The results obtained may be used**\n**for developing appropriate detection and defense solutions**\n**for WannaCry and other ransomware families that exhibit**\n**similar behaviors.**\n\n**_Keywords—dynamic malware analysis, ransomware, WannaCry._**\n\n## 1. Introduction\n\nRansomware threat is currently considered to be the main\nmoneymaking scheme for cyber criminals and the key threat\nto Internet users [1], [2]. In recent years, the appearance of\nnew types of ransomware has been observed, combining the\nuse of worm-like spreading mechanisms and advanced recovery prevention schemes. Recent examples include WannaCry [3], [4] and Petya [5], [6], which exploit the weaknesses of Microsoft Windows, as well as BadRabbit [7],\nwhich spreads via insecure compromised websites.\nFrom the defense perspective, the design of new countermeasures is considered, in addition to traditional security\napproaches, an important and trending task in this field.\nSuch a design, however, requires a comprehensive analysis\nof ransomware functionality and behavior. This typically\ninvolves a wide range of malware analysis tools and tech\n\nniques. Such techniques may be broadly classified as static\nand dynamic. Static analysis is performed without executing the malicious binary, while dynamic analysis involves\nexecuting the binary in an isolated environment.\nIn one of our previous works [8], we performed an initial\nstatic and dynamic analysis of WannaCry to identify its resources and functions, as well as its use of dynamic-link\nlibraries (DLLs) and communication protocols. In this\nwork, we have performed a comprehensive dynamic analysis, focusing on WannaCry’s infection, persistence, recovery prevention and propagation mechanisms. The techniques presented are also applicable in the cases of other\nransomware families whose characteristics are similar to\nthat of WannaCry, such as worm-spreading mechanisms\nand public-key based encryption. In particular, the research\npresented examines WannaCry’s behavior during its execution in a safe, purpose-built virtual lab environment at the\nUniversity of York. The results obtained may form a basis\nfor designing and developing effective ransomware defense\nsolutions.\nThe rest of the paper is organized as follows. In Section 2,\nwe present the relevant background information on ransomware in general and on WannaCry in particular. In\nSection 3, the main findings from the dynamic analysis\nof WannaCry we have performed, including its encryption\nprocess, recovery prevention and propagation mechanisms,\nare presented. Finally, Section 4 draws conclusions and\ndiscusses potential future directions.\n\n## 2. Background\n\n**_2.1. Ransomware_**\n\nRansomware is a type of malicious software (malware) that\nprevents users from accessing or limits their access to the\nsystem or files, either by locking the screen or by encrypting\nfiles, until a ransom is paid [9]. In most cases, ransomware\nleaves the user with very few options, such as only allowing\nthe victim to communicate with the attacker and pay the\nransom.\n\n113\n\n\n-----\n\nThe most common types of ransomware use some form of\nencryption, including both symmetric and public-key based\nencryption schemes. Ransomware that relies on publickey encryption is particularly difficult to mitigate, since\nthe encryption keys are stored in a remote command and\ncontrol (C&C) server. There is usually a time limit for\nransom to be paid, the users are provided with a special\nwebsite to purchase cryptocurrency (e.g. Bitcoins) and stepby-step instructions on how to pay the ransom.\nThe lifecycle of modern day ransomware typically consists\nof the following steps [10]: distribution, infection, C&C\ncommunications, file search, file encryption and ransom\ndemand.\n\n**_2.2. WannaCry_**\n\nWannaCry ransomware (also known as Wana Decrypt0r,\nWCry, WannaCry, WannaCrypt, and WanaCrypt0r) was observed during a massive attack across multiple countries on\n12 May 2017 [11]. According to multiple reports from security vendors, the total of 300,000 systems in over 150\ncountries had been severely damaged. The attack affected\na wide range of sectors, including healthcare, government,\ntelecommunications and gas/oil production.\nThe difficulty in protecting against WannaCry stems from\nits ability to spread to other systems by using a worm component. This feature makes the attacks more effective and\nrequires defense mechanisms that can react quickly and in\nreal time. Furthermore, WannaCry has an encryption component that is based on public-key cryptography.\nDuring the infection phase, WannaCry uses the Eternal_Blue and DoublePulsar exploits that were allegedly leaked_\nin April 2017 by a group called The Shadow Brokers. EternalBlue exploits the server message block (SMB) vulnerability that was patched by Microsoft on March 14, 2017 and\nhas been described in the security bulletin MS17-010 [12].\nThis vulnerability allows the adversaries to execute a remote code on the infected machines by sending specially\ncrafted messages to an SMB v1 server, connecting to TCP\nports 139 and 445 of unpatched Windows systems. In particular, this vulnerability affects all unpatched Windows versions starting from Windows XP to Windows 8.1, except\nfor Windows 10.\nDoublePulsar is a persistent backdoor that may be used to\naccess and execute code on previously compromised systems, thus allowing the attackers to install additional malware on the system. During the distribution process, WannaCry’s worm component uses EternalBlue for initial infection through the SMB vulnerability, by actively probing\nappropriate TCP ports and, if successful, tries to implant\nthe DoublePulsar backdoor on the infected systems.\n\n## 3. WannaCry Analysis\n\nIn this section, we present our findings based on the dynamic analysis of WannaCry we have performed. Samples\nof WannaCry were obtained from VirusShare [13]. Two\n\n114\n\n\nexecutable files were analyzed: the worm component and\nthe encryption component (Table 1).\n\nTable 1\nWannaCry components\n\nWorm component\n\nMD5 db349b97c37d22f5ea1d1841e3c89eb4\n\ne889544aff85ffaf8b0d0da705105dee7c\nSHA1\n97fe26\n\n24d004a104d4d54034dbcffc2a4b19a11\nSHA256\nf39008a575aa614ea04703480b1022c\n\nPE32 executable (GUI) Intel 80386,\nFile type\nfor MS Windows\n\nEncryption component\nMD5 84c82835a5d21bbcf75a61706d8ab549\n\n5ff465afaabcbf0150d1a3ab2c2e74f3a4\nSHA1\n426467\n\ned01ebfbc9eb5bbea545af4d01bf5f1071\nSHA256\n661840480439c6e5babe8e080e41aa\n\nPE32 executable (GUI) Intel 80386,\nFile type\nfor MS Windows\n\n**_3.1. Testbed_**\n\nIn order to analyze WannaCry, a virtual testbed shown in\nFig. 1 was built. The characteristics of the host machine\nare as follows: Intel Core i7-4700MQ 2.40 GHz and 16 GB\nRAM. The host machine acts as a virtual switch and is running REMnux [14], which is a free Linux toolkit for reverse\nengineering and malware analysis. Two virtual machines\n(VMs), running Windows 7 SP1, were used. The first VM\nwas infected with WannaCry, whereas the other VM was\nclean. A custom network VMnet 5 – 192.168.180.0/24 was\ncreated with the Virtual Network Editor option in VMWare\nhypervisor. This testbed allows observing domain name\nsystem (DNS) queries made by WannaCry during the infection and replication process across internal and external\n\n**_Fig. 1. Testbed for dynamic WannaCry analysis._**\n\n\n-----\n\nnetworks via port 445 of the SMB v1 protocol. The REMnux machine acts as a DNS and HTTP server, and is able\nto intercept all network communications using Wireshark.\nDNS and HTTP services in REMnux were enabled using\nFakeDNS and HTTP Daemon utilities, respectively.\nThe system level actions performed by WannaCry were observed on the infected Windows 7 SP1 machine with the\n192.168.180.130 IP address. In order to observe and report\nthe actions that WannaCry took while running on the system, the SysAnalyzer tool [15] was used. The main benefit\nof SysAnalyzer is that it is capable of taking system snapshots before and after malware execution, thus making it\npossible to inspect system attributes, such as running processes, open ports, DLLs loaded, registry key changes, run\ntime file modifications, scheduled tasks, mutual exclusion\nobjects (mutexes) and network connections. SysAnalyzer is\nalso capable of taking memory dumps and scanning them\nfor specific regular expressions. Before executing the WannaCry sample on the infected machine, the SysAnalyzer’s\nconfiguration wizard was set to apply a 120 s delay between system snapshots, thus allowing to inspect all system\nattribute changes.\n\n**_3.2. Libraries and Functions_**\n\nAnalysis performed with the Pestudio tool [16] revealed\nthat the worm and the encryption components of WannaCry\n\nTable 2\nDLLs of the worm component\n\nLibrary Imports Description\n\nWindows Socket 2.0 32-bit\nws2 32.dll 13\nDLL\niphlpapi.dll 2 IP Helper API\nwininet.dll 3 Internet Extensions for Win32\n\nWindows NT Base API\nkernel32.dll 32\nClient DLL\n\nAdvanced Windows 32 Base\nadvapi32.dll 11\nAPI\n\nWindows NT C++ Runtime\nmsvcp60.dll 2\nLibrary DLL\nmsvcrt.dll 28 Windows NT CRT DLL\n\nTable 3\nDLLs of the encryption component\n\nLibrary Imports Description\n\nWindows NT Base API\nkernel32.dll 54\nClient DLL\n\nAdvanced Windows 32 Base\nadvapi32.dll 10\nAPI\n\nMulti-User Windows User\nuser32.dll 1\nAPI Client DLL\nmsvcrt.dll 49 Windows NT CRT DLL\n\n\ncontain DLLs shown in Tables 2 and 3, respectively. During\nits execution, the worm component invokes iphlpapi.dll to\nretrieve network configuration settings for the infected host.\n_Kernel32.dll and msvcrt.dll are the two libraries most fre-_\nquently invoked by the encryption component. This may\nindicate that the main encryption functionality was implemented by these two malicious libraries. To confirm\nthis, the imported functions of the libraries needed to be\nexamined.\n\nTable 4\nFunctions of the encryption component\n\nFunction Location\n\nGetCurrentThread 0xa53a\n\nGetStartupInfoA 0xa97a\n\nStartServiceCtrDispatcherA 0xa6f6\n\nRegisterServiceCtrDispatcherA 0xa6d8\n\nCreateServiceA 0xa688\n\nStartServiceA 0xa662\n\nCryptGenRandom 0xa650\n\nCryptAcquireContextA 0xa638\n\nOpenServiceA 0xa714\n\nGetAdaptersInfo 0xa792\n\nInternetOpenUrlA 0xa7c8\n\nTable 5\nFunctions of the encryption component\n\nFunction Location\n\nOpenMutexA 0xda84\n\nGetComputerNameW 0xd8b2\n\nCreateServiceA 0xdc2a\n\nOpenServiceA 0xdc62\n\nStartServiceA 0xdc52\n\nCryptReleaseContext 0xdc14\n\nRegCreateKeyW 0xdc04\n\nfopen 0xdcd4\n\nfread 0xdccc\n\nfwrite 0xdcc2\n\nfclose 0xdcb8\n\nCreateFileA 0xd922\n\nReadFile 0xd964\n\nThe imported functions of the samples were observed by\nPestudio. The most suspicious functions identified among\nthem are shown in Tables 4 and 5. One may observe that\nin general, WannaCry uses Microsoft’s crypto, file management and C runtime file APIs. The crypto API library is\nused to generate and manage random symmetric and asymmetric cryptographic keys.\n\n115\n\n\n-----\n\n**_Fig. 2. FakeDNS capture of the malicious DNS request._**\n\n**_Fig. 3. Wireshark capture of the malicious DNS request._**\n\n**_3.3. Initial Interactions_**\n\nThe dynamic analysis conducted has revealed that, upon\nstartup, the worm component tries to connect to the following domain, using the InternetOpenUrl function:\n\nwww.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com\n\nThe aforementioned domain is a kill-switch domain. This\nmeans that if the domain is active, the worm component\nstops running. On the other hand, if the worm component\ncannot establish a connection with this domain (e.g. if the\ndomain is not active or if there is no connectivity), it continues to run and registers itself as a “Microsoft Security\nCenter (2.0) Service” mssecsvs2.0 process on the infected\nmachine. Hence, this kill-switch domain may be used as\npart of a detection technique when developing a defense\nsystem.\nThe FakeDNS utility at REMnux captures the malicious\nDNS request on port 80 (Fig. 2), while Wireshark shows\n(Fig. 3) the DNS packet query field from the infected machine (IP 192.168.180.130) to the DNS server on REMnux\n(IP 192.168.180.128).\n\n**_3.4. Persistence Mechanisms_**\n\nAfter connection failure with the kill-switch domain, the\nworm component attempts to create a mssecsvs2.0 process with the DisplayName of “Microsoft Security Center\n(2.0) Service”. This can be observed in the Process Hacker\n\n116\n\n\ntool with 4016 PID, indicating that the service has been\nlaunched (Fig. 4). In addition to this, the worm component of WannaCry extracts the hardcoded R resource binary and then copies it to “C:\\Windows\\taskche.exe” directory path. The R resource represents the binary of the\nWannaCry encryption component. After that, the worm\nruns the executable with the following parameters in the\ncommand line: “C:\\Windows\\taskche.exe/i”. Next, the\nworm tries to move the “C:\\Windows\\taskche.exe” file to\n“C:\\Windows\\qeriuwjhrf”, to replace the original file if it\nexists. This is done to ensure multiple infections and avoid\nany issues with creating the tasksche.exe process.\n\n**_Fig. 4. Microsoft Security Center (2.0) Service._**\n\nFinally, WannaCry creates an entry in the Windows registry in order to ensure that it runs every time the\ncomputer is restarted. The new entry contains a string\n(e.g. “midtxzggq900”), which is a unique identifier randomly generated by using the computer name. Once the\ntasksche.exe component runs, it copies itself to a folder\nwith a randomly generated name in the Common Appdata\ndirectory of the infected machine. Then, it attempts to establish memory persistence by adding itself to the AutoRun\nfeature.\n\n\n-----\n\n**_Fig. 5. WannaCry dropped files to the working directory._**\n\n**_Fig. 6. WannaCry extortion message._**\n\n\n117\n\n\n-----\n\nIn summary, the dynamic analysis has revealed that, to\nachieve persistence on the infected machine, WannaCry performs the following actions:\n\n  - creates an entry in the Windows registry to ensure\nthat it executes every time the machine is restarted,\n\n  - attempts to achieve memory persistence by adding\nitself to the AutoRun feature of Windows,\n\n  - uses Windows icacls command to grant itself a full\naccess to all files on the machine,\n\n  - deletes all backup (shadow) copies and tries to prevent being booted in safe mode by executing several\ncommands in the Windows command line,\n\n  - deletes all backup folders,\n\n  - by using the Windows command line, creates a\nVBScript program which generates a single shortcut\nof the @WanaDecryptor@.exe decrypter file,\n\n  - tries to kill SQL and MS Exchange database processes by executing several commands in the Windows command line.\n\n**_3.5. Configuration Data Load_**\n\nAfter the persistence phase, WannaCry loads the XIA re_source, which corresponds to a password protected ZIP file._\nIt decompresses the files and drops them to the working directory of the running process (Fig. 5), as observed in the\nDirWatch module of SysAnalyzer.\nAs one can see, WannaCry loads configuration data from\nthe c.wnry file into memory. WannaCry randomly chooses\none of the three available Bitcoin addresses and then writes\nthis address back to the configuration data. This is done\nin order to display the payment address in the extortion\nmessage (Fig. 6). After that, WannaCry sets the hidden\nattribute (Fig. 7) for the working directory with the help\nof the CreateProcess function. Next, with the help of the\nWindows icacls command, WannaCry grants full access to\nall files on the target system (Fig. 8).\n\n**_Fig. 7._** WannaCry sets the hidden attribute for the working\ndirectory.\n\n**_Fig. 8. WannaCry grants full access on the target system._**\n\nThe next step is to import one of the hardcoded public RSA\nkeys as was identified at offset 0xec00 of the tasksche.exe\n\n118\n\n\nprocess (Fig. 9). WannaCry then loads and executes, in\nmemory, the contents of the t.wnry file (Fig. 10) which\ncontains the default encrypted AES key required for decrypting the DLL responsible for the file encryption routine. The first 8 bytes of the file are checked to match the\nWANACRY! string. Then, the imported public RSA key\nhardcoded within binary is used to decrypt the AES key\nstored at the beginning of the t.wnry file. The AES key\nobtained is then used to decrypt and load the encryption\nDLL, which can be observed with the help of OllyDbg debugging tool [17] during WannaCry execution, as shown in\nFig. 11. This DLL is responsible for file encryption on the\ninfected machine and is summarized in Table 6.\n\nTable 6\nEncryption DLL\n\nMD5 f351e1fcca0c4ea05fc44d15a17f8b36\n\n7d36a6aa8cb6b504ee9213c200c831e\nSHA1\nb8d4ef26b\nSize 65536 bytes\nFile type Dynamic-Link-Library\nInternal name kbdlv.dll\nFile description Latvia keyboard layout\nTimestamp Mon, Jul 13 18:12:55 2009\n\n**_3.6. Encryption Process_**\n\nThe encryption component of WannaCry is invoked with\nthe TaskStart system thread. During its execution, the encryption component checks if one of the following mutexes\nexists:\n\nGlobalnMsWinZonesCacheCounterMutexA,\nGlobalnMsWinZonesCacheCounterMutexW,\nMsWinZonesCacheCounterMutexA.\n\nIf the mutex “MsWinZonesCacheCounterMutexA” is\npresent, then the encryption component automatically stops\nwithout taking any further action. If the mutex is not\npresent on the system, the encryption process starts. In\nparticular, TaskStart creates a new mutex named “MsWinZonesCacheCounterMutexA” and reads the contents of the\nc.wnry file from the current directory. After that, WannaCry creates three configuration files shown in Table 7.\n\nTable 7\nWannaCry configuration files\n\nFilename Description\n\n00000000.res TOR/C2 info\n00000000.pky Public RSA key\n00000000.eky Encrypted private RSA key\n\nAfter the configuration files have been created, the encryption component is ready to start encrypting files on the system. To accomplish this, it spawns several threads. First,\n\n\n-----\n\n**_Fig. 9. Imported RSA private key._**\n\n**_Fig. 10. Loaded and executed t.wnry file._**\n\n**_Fig. 11. Decrypted AES key in a memory dump._**\n\nWannaCry attempts to load and check the existence of two\nkeys in the 00000000.pky and 00000000.dky files. The\n00000000.dky file presents a decryption RSA key which\nis received upon the payment has been verified. When the\nvictim clicks the “Check Payment” button, WannaCry starts\nchecking for the presence of the 00000000.dky file on the\nsystem. If the two aforementioned files do not exist, WannaCry generates a new unique RSA 2048-bit asymmetric\nkey pair, which can be seen in the memory dump made\nwith with SysAnalyzer tool at 0x2B3795 offset (Fig. 12).\n\n**_Fig. 12. Generation of an RSA key pair._**\n\nOnce the key pair has been generated, WannaCry exports\nthe victim’s public RSA key to a 00000000.pky file using\nMicrosoft’s CryptExportKey function. Next, WannaCry exports the victim’s private RSA key and encrypts it with\nanother hard-coded RSA public key. The encrypted private key is stored as a 00000000.eky file. After the key\nhas been safely stored, WannaCry calls upon the CryptDe_stroyKey function to destroy the private key in memory, to_\nlimit any key recovery options.\nNext, WannaCry starts enumerating, every 3 seconds, information about all logical drives attached to the system.\nIf a new attached drive is not a CD ROM drive, then it begins the encryption process on the new drive. At this stage,\nWannaCry also starts iterating through all existing directories and searching for predefined file extensions of interest.\n\n\nTo encrypt each file, it generates a 16-byte symmetric AES\nkey using the CryptGenRandom function. Then, it encrypts\nevery generated AES key with the public RSA key and\nstores it inside the file header starting with the WANACRY!\nstring value. Encrypted files are renamed and appended\nwith the .WNCRY file extension.\n\n**_Fig. 13. Password for a ZIP archive in the encryption component._**\n\nThe encryption component contains a password-protected\nZIP archive. We managed to obtain the password, “WNcry@2ol7”, by disassembling the encrypter with the IDA\nPro tool [18] (see Fig. 13). The contents of the ZIP archive\nare summarized in Table 8 and described below:\n\n  - msg is a folder that contains a list of rich text format\n(RTF) files with the wnry extension. These files are\nthe readme instructions used to show the extortion\nmessage to the victim in different languages, based\non the information obtained from the system by malicious WannaCry functions;\n\n  - b.wnry is an image file used for displaying instructions for the decryption of user files. It starts with 42\n4D strings, which indicates that this file is a bitmap\nimage;\n\n  - c.wnry contains a list of Tor addresses with the .onion\nextension and a link to a zipped installation file of\nthe Tor browser from Tor Project [19];\n\n119\n\n\n-----\n\nTable 8\nFiles in the password protected ZIP archive\n\nName Size [bytes] Modified\n\nmsg 1,329,657 2017-05-11\nb.wnry 1,440,054 2017-05-11\nc.wnry 780 2017-05-11\nr.wnry 864 2017-05-10\ns.wnry 3,038,286 2017-05-09\nt.wnry 65,816 2017-05-11\ntaskdl.exe 20,480 2017-05-11\ntaskse.exe 20,480 2017-05-11\nu.wnry 245,760 2017-05-11\n\n  - r.wnry is a text file in English with additional decryption instructions to be used by the decryption\ncomponent (the u.wnry file mentioned below);\n\n  - s.wnry file is a ZIP archive (HEX signature 50 4B 03\n04) which contains the Tor software executable. This\nexecutable has been obtained with the assistance of\nthe WinHex tool [20] by saving raw binary data with\nthe .zip extension;\n\n  - t.wnry is an encrypted file with the WANACRY!\nencryption format. The file header starts with the\nWANACRY! string;\n\n  - taskdl.exe is a supporting tool for the deletion of\nfiles with the .WNCRY extension. By observing the\nproperties of the file, the following masquerade description can be found: “SQL Client Configuration\nUtility”;\n\n  - taskse.exe is a supporting tool for malware execution on remote desktop protocol (RDP) sessions. The\nfollowing file description was identified: “waitfor –\nwait/send a signal over a network”;\n\n  - u.wnry is an executable file (HEX signature 4D 5A)\nwith the name of “@WanaDecryptor@.exe”, which\nrepresents the decryption component of WannaCry.\n\nAt the same time, another thread calls the taskse.exe process\nevery 30 s, which tries to enumerate active RDP sessions on\nconnected remote machines and to run the @WanaDecryptor@.exe binary file. This file is extracted from the u.wnry\nfile and represents the decryption component of WannaCry.\nThe persistence of RDP session injections is ensured by\nadding the value in the AutoRun registry key.\n\n**_3.7. Recovery Prevention_**\n\nAfter finishing the encryption process, WannaCry tries to\nprevent various common data recovery methods by executing several commands on the system. To prevent data\nrecovery, WannaCry executes the following commands:\n\n  - vssadmin delete shadows/all/quiet. Deletes all the\nshadow volumes on the system without alerting the\n\n120\n\n\nuser. By default, these volumes contain backup data\nin the event of a system fault;\n\n  - wmic shadowcopy delete. Ensures deletion of any\ncopies relevant to shadow volumes;\n\n  - bcdedit/set default bootstatuspolicy ignoreallfailures.\nEnsures that the machine is booted, even if errors are\nfound;\n\n  - bcdedit/set default recoveryenabled no. Disables the\nWindows recovery feature, thus preventing the victims from the possibility to reverting their system to\na previous build;\n\n  - wbadmin delete catalog −q. Ensures that victim can\nno longer use any backup files created by Windows\nServer.\n\n**_3.8. Propagation_**\n\nThe worm component of WannaCry carries the main propagation and exploit functionality, which utilizes the EternalBlue exploit and the DoublePulsar backdoor to leverage\nthe MS17-010 SMB vulnerability [12]. After performing\nthe initial interactions and checking connectivity with the\nkill-switch domain, the worm functionality is established by\ninitiating the mssecsvs2.0 service, which WannaCry installs\nafter being executed. This service tries to spread WannaCry\npayload through the SMB vulnerability on any vulnerable\nsystems on both internal and external networks.\nIn order to perform this, WannaCry creates and spawns\ntwo separate threads that simultaneously replicate worm\npayload in all detected networks. In the internal network,\nbefore starting the propagation process, the component obtains the IP addresses of local network interfaces by invoking the GetAdaptersInfo function, and determines the\nsubnets existing in the network.\nAfter that, the worm component tries to connect to all\npossible IP addresses in any available local network on\nport 445, which is the default port for SMB over IP\nservice. If successful, the worm attempts to exploit the\nservice for the MS17-010 vulnerability. In our testbed,\nconnection attempts were observed with Wireshark on\na REMnux machine, when the infected machine (IP\n192.168.180.130) sent SMB probe packets to the clean machine (IP 192.168.180.134), as shown in Fig. 14.\nDuring the SMB probing, one of the unique features of\nthe generated traffic is that it contains two hardcoded IP\naddresses: 192.168.56.20 and 172.16.99.5. They can be\nobserved by extracting strings from the binary. In particular, WannaCry sends three NetBIOS session setup packets,\nwhere two of them contain the aforementioned hardcoded\nIP addresses.\nAt the same time, the worm component attempts to spread\nacross the external networks by generating various IP addresses and by trying to connect to TCP port 445. This\ncan be observed with Wireshark on REMnux, as shown\n\n\n-----\n\n**_Fig. 14. WannaCry internal network traffic attempting the SMB exploit._**\n\n**_Fig. 15. WannaCry external network traffic attempting the SMB exploit._**\n\n\nin Fig. 15. As it can be seen, the worm attempts to probe\nexternal Internet IP addresses for the MS17-010 vulnerability. This explains the reason for the widespread infec\nTable 9\nExternal IP addresses generated\nby WannaCry\n\nIP address : port\n\n109.140.223.210 : 445\n\n206.242.244.156 : 445\n\n52.213.90.240 : 445\n\n\ntion seen during the massive outbreak on 12 May 2017.\nThe full list of WannaCry generated IP addresses obtained\nduring the analysis is presented in Table 9.\n\n**_3.9. C&C Communication_**\n\nDuring its execution, the software also tries to contact\nthe C&C servers. To this end, WannaCry unpacked\nand dropped files from the s.wnry file, containing the\nTor executable, into the installation directory as shown\n\n**_Fig. 16. Tor executable dropped into the installation directory._**\n\nin Fig. 16. Before unpacking, it starts listening on the\nlocalhost address 127.0.0.1:9050. This address, with the\nspecified 9050 port, is typically used for configuring the\n\n121\n\n\n-----\n\nTor browser application. If the contents of the s.wnry\nfile are corrupted, then WannaCry tries to download\nthe Tor executable from a hardcoded URL. After the\nsuccessful extraction of the Tor executable, it copies\n“TaskData\\Tor\\tor.exe” to “TaskData\\Tor\\taskhsvc.exe”\nand executes it. Next, WannaCry parses the contents of\nthe c.wnry file, which specifies the configuration data,\nincluding the following .onion addresses to connect and\nthe zipped Tor browser installation file:\n\ngx7ekbenv2riucmf.onion\n\n57g7spgrzlojinas.onion\n\nxxlvbrloxvriy2c5.onion\n\n76jdd2ir2embyv47.onion\n\ncwwnhwhlz52maqm7.onion\n\nhttps://dist.torporject.org/torbrowser/6.5.1/tor\n-win32-0.2.9.10.zip\n\nAfter that, WannaCry sends the first eight bytes of the\n00000000.res file content to the C&C server. These bytes\nspecify the host and user name of the infected machine.\nThe 00000000.res file, which is dropped during encryption\nprocess, accumulates in total 88 bytes of configuration data,\nincluding internal flags, counters, and timestamps.\nDuring its communication with Tor addresses, WannaCry\nestablishes a secure HTTPS channel to port 443, and uses\ncommon Tor ports, 9001 and 9050, for network traffic and\ndirectory information.\n\n## 4. Conclusions and Future Work\n\nWe have performed a comprehensive dynamic analysis of\nWannaCry ransomware in a purpose-built virtual testbed.\nWe analyzed the WannaCry version which was observed\nduring the massive attacks on 12 May 2017. The analysis\nhas revealed that the given ransomware is composed of two\ndistinctive components, which enable the worm-like selfpropagating mechanism and combined encryption process.\nBoth worm and encryption components of WannaCry have\nbeen examined.\nThe focus of this study was on WannaCry’s initial interactions and the infection process, its persistence mechanism, encryption process, recovery prevention as well\nas its propagation mechanisms and communication with\nC&C servers. The analysis has revealed important characteristics and behaviors of WannaCry during its execution. In particular, we identified Tor addresses used for\nC&C, observed TCP and DNS connections, SMB probes,\nas well as actions related to WannaCry persistence and\nobfuscation.\nThe worm component of WannaCry weaponized by the\nfunctionality enabling it to exploit and propagate via\nMicrosoft’s MS17-010 on unpatched systems by sending\nSMB probing packets on port 445. In addition to the\nmodular nature of WannaCry, it was also observed that\n\n122\n\n\nit has embedded RSA keys used to decrypt the required\nmalicious DLL representing the encryption component. It\nwas identified that the worm component scans both internal and external networks for MS17-010 vulnerability,\nby generating a list of local and global IP addresses. The\nworm tries to probe the hosts from the generated list by\nsending packets to port 445. Before its execution, WannaCry also performs an initial check with the kill-switch\ndomain.\nAt the same time, the analysis has identified two hardcoded\nIP addresses (192.168.56.20 and 172.16.99.5), which are\nsent during the SMB probing. Depending on the condition\nof the s.wnry file dropped during execution, WannaCry can\nalso communicate with embedded .onion addresses via a secure channel on port 443 and via common Tor ports 900\nand 9050 to download the Tor browser installation software\nfrom a specified URL.\nThe findings of this work could be used for designing effective mitigation mechanisms for WannaCry and other ransomware families that exhibit similar behavior. This is left\nas future work. In particular, we plan to investigate the\nuse of software-defining networking (SDN) [21], [22] for\nransomware detection and mitigation. SDN is an emerging paradigm of programmable networks that decouples the\ncontrol and data planes. SDN controllers maintain a view\nof the entire network and implement policy decisions. On\nthe other hand, each device at the data plane maintains\none or more flow tables, where the packet handling rules\nare stored. This changes the way that networks are designed and managed, and enables new SDN-based security\nsolutions [23]–[25], such as firewalls and intrusion detection systems for various types of malware, including ransomware mitigation [26], [27].\n\n## References\n\n[1] D. O’Brien, “Ransomware 2017”, Internet Security Threat Report,\nSymantec, July 2017 [Online]. Available:\nhttps://www.symantec.com/content/dam/symantec/docs/securitycenter/white-papers/istr-ransomware-2017-en.pdf\n\n[2] K. Savage, P. Coogan, and H. Lau, “The evolution of ransomware”,\nSecurity Response, Symantec, June 2015 [Online].\nAvailable: http://www.symantec.com/content/en/us/enterprise/\nmedia/security response/whitepapers/the-evolution-ofransomware.pdf\n\n[3] A. Zeichnick, “Self-propagating ransomware: What the WannaCry\nransomworm means for you”, May 2017 [Online]. Available:\nhttps://www.networkworld.com/article/3196993/security/selfpropagating-ransomware-what-the-wannacry-ransomworm-meansfor-you.html\n\n[4] “Ransom.Wannacry”, Symantec, May 2017 [Online]. Available:\nhttps://www.symantec.com/security-center/writeup/2017-0513103522-99/\n\n[5] “Petya – taking ransomware to the low level”, Malwarebytes Labs,\nJun. 2017 [Online]. Available: https://blog.malwarebytes.com/\nthreat-analysis/2016/04/petya-ransomware/\n\n[6] “Petya ransomware eats your hard drives”, Kaspersky Labs, Jun.\n2017 [Online]. Available: https://www.kaspersky.com/blog/\npetya-ransomware/11715\n\n\n-----\n\n[7] “Bad Rabbit: A new ransomware epidemic is on the rise”, Kaspersky\nLabs, Oct. 2017 [Online]. Available: https://www.kaspersky.com/\nblog/bad-rabbit-ransomware/19887/\n\n[8] M. Akbanov, V. G. Vassilakis, I. D. Moscholios, and M. D. Logothetis, “Static and dynamic analysis of WannaCry ransmware”,\nin Proc. IEICE Inform. and Commun. Technol. Forum ICTF 2018,\nGraz, Austria, 2018.\n\n[9] C. Everett, “Ransomware: To pay or not to pay?”, Comp. Fraud &\n_Secur., vol. 2016, no. 4, pp. 8–12, 2016_\n(doi: 10.1016/S1361-3723(16)30036-7).\n\n[10] “Understanding ransomware and strategies to defeat it”, McAfee\nLabs, White Paper, 2016 [Online]. Available:\nhttps://www.mcafee.com/enterprise/en-us/assets/white-papers/\nwp-understanding-ransomware-strategies-defeat.pdf\n\n[11] “What you need to know about the WannaCry ransomware”,\nSymantec, Threat Intelligence, Oct. 2017, [Online]. Available:\nhttps://www.symantec.com/blogs/threat-intelligence/wannacryransomware-attack\n\n[12] Microsoft Security Bulletin MS17-010 – Critical, March 14, 2017\n\n[Online]. Available: https://docs.microsoft.com/en-us/\nsecurity-updates/securitybulletins/2017/ms17-010\n\n[13] ViRus Share malware repository [Online]. Available:\nhttps://virusshare.com (accessed Nov. 30, 2018).\n\n[14] “REMnux: A Linux toolkit for reverse-engineering and analyzing\nmalware” [Online]. Available: https://remnux.org (accessed Nov. 30,\n2018).\n\n[15] SysAnalyzer – Automated malcode analysis system [Online].\nAvailable: https://github.com/dzzie/SysAnalyzer (accessed Nov. 30,\n2018).\n\n[16] Pestudio, Malware Assessment Tool [Online]. Available:\nhttps://www.winitor.com (accessed Nov. 30, 2018).\n\n[17] OllyDbg – A 32-bit assembler level debugger for Microsoft Windows [Online]. Available: http://www.ollydbg.de/ (accessed Nov. 30,\n2018).\n\n[18] IDA: Pro [Online]. Available: https://www.hex-rays.com/\nproducts/ida (accessed Nov. 30, 2018).\n\n[19] Tor Project [Online]. Available: https://www.torproject.org\n(accessed Nov. 30, 2018).\n\n[20] “WinHex: Computer forensics and data recovery software” [Online]. Available: https://www.x-ways.net/winhex (accessed Nov. 30,\n2018).\n\n[21] B. Nunes, M. Mendonca, X. N. Nguyen, K. Obraczka, and T. Turletti,\n“A survey of software-defined networking: Past, present, future of\nprogrammable networks”, IEEE Commun. Surveys & Tutor., vol. 16,\nno. 3, pp. 1617-1634, 2014\n(doi: 10.1109/SURV.2014.012214.00180).\n\n[22] V. G. Vassilakis, I. D. Moscholios, B. A. Alzahrani, and M. D. Logothetis, “A software-defined architecture for next-generation cellular\nnetworks”, in Proc. IEEE Int. Conf. on Commun. ICC 2016, Kuala\nLumpur, Malaysia, 2016 (doi: 10.1109/ICC.2016.7511018).\n\n[23] C. Yoon, T. Park, S. Lee, H. Kang, S. Shin, and Z. Zhang, “Enabling\nsecurity functions with SDN: A feasibility study”, Comp. Netw.,\nvol. 85, pp. 19–35, 2015 (doi: 10.1016/j.comnet.2015.05.005).\n\n[24] J. M. Ceron, C. B. Margi, and L. Z. Granville, “MARS: An SDNbased malware analysis solution”, Proc. IEEE Symp. on Comp. and\n_Commun. ISCC 2016, Messina, Italy, 2016_\n(doi: 10.1109/ISCC.2016.7543792).\n\n[25] V. G. Vassilakis, I. D. Moscholios, B. A. Alzahrani, and M. D. Logothetis, “On the security of software-defined next-generation cellular\nnetworks”, in Proc. IEICE Inform. and Commun. Technol. Forum\n_ICTF 2016, Patras, Greece, 2016._\n\n[26] K. Cabaj and W. Mazurczyk, “Using software-defined networking\nfor ransomware mitigation: The case of CryptoWall”, IEEE Network,\nvol. 30, no. 6, pp. 14–20, 2016\n(doi: 10.1109/MNET.2016.1600110NM).\n\n\n\n[27] K. Cabaj, M. Gregorczyk, and W. Mazurczyk, “Software-defined\nnetworking-based crypto ransomware detection using HTTP traffic\ncharacteristics”, Comp. & Elec. Engin., vol. 66, pp. 353–386, 2018\n(doi: 10.1016/j.compeleceng.2017.10.012).\n\n**Maxat Akbanov received the**\nB.Sc. degree in Information and\nCommunications System Security from the National Technical University of Ukraine “Kyiv\nPolytechnic University”, Kyiv,\nUkraine, in 2011, and the M.Sc.\ndegree in Cyber Security from\nthe University of York, York,\nUK, in 2018. In 2008 and\n2016, he received the prestigious Kazakhstan governmental “Bolashak” scholarship to\nfund his studies abroad. He holds merit and distinction\nawards for B.Sc. and M.Sc. degrees, respectively. He is\ncurrently working for the private sector in Kazakhstan and\nis involved in developing several startup projects for the\ngovernment-sponsored “Digital Kazakhstan” and “Cyber\nShield” strategies. His main research interests include network and malware forensics, software-defined networking,\ncovert channels, cryptography, Internet of Things, machine\nlearning and artificial intelligence.\nE-mail: maxat.akbanov@gmail.com\nDepartment of Computer Science\nUniversity of York\nDeramore Lane\nHeslington\nYork YO10 5GH, United Kingdom\n\n**Vassilios** **G.** **Vassilakis** received his Ph.D. degree in Electrical and Computer Engineering from the University of Patras, Greece in 2011. He is currently a lecturer in Cyber Security at the University of York,\nUK. He’s been involved in EU,\nUK, and industry funded R&D\nprojects related to the design\nand analysis of future mobile\nnetworks and Internet technologies. His main research interests are in the areas of network security, Internet of\nThings, next-generation wireless and mobile networks, and\nsoftware-defined networks. He has published over 90 papers in international journals/conferences. He has served\nas a Guest Editor in IEICE Transactions on Communications, IET Networks, and Elsevier Optical Switching\n& Networking, and in the TPC of IEEE ICC and IEEE\nGlobecom.\nE-mail: vv274@cl.cam.ac.uk\nUniversity of York\nYork YO10 5DD, United Kingdom\n\n123\n\n\n-----\n\n**Michael** **D.** **Logothetis** received his B.Eng. degree and\nPh.D. in Electrical Engineering, both from the University of\nPatras, Patras, Greece, in 1981\nand 1990, respectively. From\n1991 to 1992 he was a Research\nAssociate at NTT’s Telecommunication Networks Laboratories, Tokyo, Japan. In 2009\nhe was elected (Full) Professor\nat the ECE Department of the University of Patras. His research interests include teletraffic theory, simulation and performance optimization of telecommuni\n124\n\n\ncations networks. He has published over 200 conference/journal papers. He has become a Guest Editor in:\nMediterranean Journal of Electronics and Communications, Mediterranean Journal of Computers and Networks,\nIET Circuits, Devices and Systems, IET Networks and\nUbiquitous Computing and Communication Journal. He is\na member of the IARIA (Fellow), IEEE (Senior), IEICE\n(Senior), FITCE and the Technical Chamber of Greece\n(TEE).\nE-mail: mlogo@upatras.gr\nWire Communications Laboratory\nDepartment of Electrical and Computer Engineering\nUniversity of Patras\n265 04 Patras, Greece\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.il-pib.pl/czasopisma/JTIT/2019/1/113.pdf"
    ],
    "report_names": [
        "113.pdf"
    ],
    "threat_actors": [
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716496,
    "ts_updated_at": 1743041507,
    "ts_creation_date": 0,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/ebf2fddb208f530e519cdab09a3fc06f06749d5c.pdf",
        "text": "https://archive.orkl.eu/ebf2fddb208f530e519cdab09a3fc06f06749d5c.txt",
        "img": "https://archive.orkl.eu/ebf2fddb208f530e519cdab09a3fc06f06749d5c.jpg"
    }
}