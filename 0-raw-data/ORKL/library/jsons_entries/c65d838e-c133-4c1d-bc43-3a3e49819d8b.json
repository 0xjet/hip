{
    "id": "c65d838e-c133-4c1d-bc43-3a3e49819d8b",
    "created_at": "2023-01-12T14:59:11.711705Z",
    "updated_at": "2025-03-27T02:05:51.599034Z",
    "deleted_at": null,
    "sha1_hash": "e0eb5f5d0dc78657b5e652598e47498c86a3834e",
    "title": "2020-03-10 - IQY files and Paradise Ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T02:33:26Z",
    "file_modification_date": "2022-05-28T02:33:26Z",
    "file_size": 1664668,
    "plain_text": "# IQY files and Paradise Ransomware\n\n**lastline.com/labsblog/iqy-files-and-paradise-ransomware/**\n\nMarch 10, 2020\n\nPosted by [James Haughom ON MAR 10, 2020](https://www.lastline.com/author/jhaughom/)\nIQY files, perhaps one of the less known of the weaponizable Microsoft Office file formats,\nprovide attackers with a simple way to infiltrate a network. We have intercepted a campaign\nthat leverages this file type to deliver a new variant of the Paradise ransomware.\n\nIQY, or Internet Query files, are simple text files read by Excel that download data from the\nInternet. This file type can be leveraged to download an Excel formula (command) that could\nabuse a system process, such as PowerShell, cmd, mshta, or any other LoLBins (Living-offthe-Land Binaries). As this is a legitimate Excel file type, many organizations will not block or\nfilter it. For organizations that do have security appliances that analyze attachments, these\nfiles may not flag as malware, as there is no payload. These appliances would typically rely\non the reputation of these URLs, with the more robust solutions having the ability to actually\nanalyze the contents that the URL returns.\n\n**Figure 1:**\n\nMalicious IQY attachment containing the location of a remote Excel formula.\n\n## The Spam Campaign\n\nThis campaign attempts to entice users into opening an IQY attachment (Figure 1), which\nreaches out and retrieves a malicious Excel formula from the attacker’s C2 server. This\nformula, in turn, contains a command to run a PowerShell command that will download and\ninvoke an executable (see Figure 2).\n\n**Figure 2:**\n\nMalicious Excel Formula.\nWhile IQY attachments are known to have been distributed by the Necurs botnet [1] to\ndeliver FlawedAmmy RAT [1], this executable is instead tied to the Paradise Ransomware\nfamily, which has been around since at least 2017.\n\nAs displayed in Figure 3, we observed that this activity spanned just under two days,\ntargeting an organization in Asia.\n\n\n-----\n\n**Figure 3: SMTP traffic delivering IQY.**\n\n## Paradise Ransomware\n\nThis new version of the ransomware contains several interesting static properties (see Figure\n4) including:\n\nAnomalous section names\n\nFor example: .py\nLack of imports (indicator of packed code)\n\n5 DLLs\n14 APIs\nAPIs associated with dynamically loading code\n\n**Figure 4: Sections and Imports of**\n\nParadise ransomware.\n\n\n-----\n\n## Unpacking Routine\n\nThe unpacking routine is quite interesting in that it leverages a self-injection technique. This\ninvolves copying itself to a new location in memory, transferring control flow to the copy of\nitself, and then replacing the original executable in memory with the unpacked ransomware.\n\nFirst, a new block of memory is allocated with the WinAPI VirtualAlloc function.\n\n**Figure 5: Allocated Memory**\nThe malware then copies itself to this newly allocated block of memory – rep movsb.\n\n**Figure 6:**\n\nCopying Itself\n\n\n-----\n\nControl flow is then transferred to this copy – jmp eax. This allows the copy to manipulate the\noriginal executable (in memory).\n\n**Figure**\n\n**7: Control Flow Transfer**\nThe copy then allocates an additional block of memory to begin the unpacking process.\n\n**Figure**\n\n**8: Memory Allocation**\n\n\n-----\n\nThe copy overwrites the original executable (in memory) with NULL bytes – rep stosb,\nessentially removing the original executable from memory. This is the last step of the\nunpacking stub, prior to injecting the unpacked executable into this region of memory.\n\n**Figure 9: Wiping the Original Executable From Memory**\nThe copy writes the unpacked executable in place of the original executable (in memory) –\n_movsb._\n\n**Figure 10: Unpacked Executable Injected in Memory**\nHere is a before/after the unpacking stub of the sample. Notice that the anomalous section\nnames are different, as are many other properties of both the PE and Optional Headers.\n\n\n-----\n\n**Figure 11: Side by Side of Packed and Unpacked PE**\nThe unpacking stub then transfers control flow to the beginning of the unpacked ransomware\ncode.\n\n**Figure 12: Control Flow Passed to Ransomware**\n\n## Dynamic Code Resolution\n\nAt the start of the ransomware, WinAPIs of interest are dynamically resolved via manual PEB\ntraversal, just before a language check is performed. The function dubbed find_API (Figure\n13) accepts a unique checksum of the WinAPI function to resolve, and a pointer to the DLL\nto search. This instance of the function returns a pointer to LoadLibraryW.\n\n**Figure 13: PEB Traversal / API Resolution**\n\n\n-----\n\n_LoadLibraryW is located by iterating through kernel32 s exports, performing a hashing_\nfunction on each export name. This hash is then compared against the hardcoded hash of\n_LoadLibraryW – 0x0DCA3722E. Figure 14 shows a snippet of the hashing function, which_\nincludes XORing the first four characters of the export name with the key 0xDEADCODE.\n\n**Figure 14: DLL Export Name Hashing**\n\nFunction\n\n## Language Check\n\nThe function shown in Figure 15 checks to see if the victim’s language ID is that of Russian,\nKazakh, Belarusian, Ukranian, or Tatar. If the victim’s language ID matches one of these\nwhitelisted values, the malware exits before performing any malicious activity.\n\n**Figure 15: Checking**\n\nfor specific languages\n\n\n-----\n\nIf the language check is passed, the main payload is executed. This function begins with an\nattempt to disable Windows Defender through setting the registry value for\n_DisableAntiSpyware to 1._\n\nThe malware then attempts to kill any processes containing specific strings (see Figure 16).\nRansomware will typically force target applications to close to ensure that handles to files of\ninterest are released. This allows the malware to then obtain handles to these important files\nduring the encryption process.\n\n**Figure 16: Strings**\n\ncontained in programs targeted for termination.\nKilling target processes/services:\n\n**Figure 17: Killing Processes**\n\n## Crypto Routine\n\nThe crypto routine involves traversing the file system (and file systems of network shares),\nwhile avoiding certain directories to avoid damaging the system. Those whitelisted\ndirectories are:\n\nWindows\nRecycle.bin\nSystem Volume Information\n\n\n-----\n\nProgram Files\nProgram Files (x86)\n\nPerhaps the most interesting technique involved in the crypto routine is the algorithm used.\nThe malware leverages Salsa20 to encrypt the victim’s files. The benefit of using this\nalgorithm is that malware authors can implement it into their source code (see Figure 18 and\nFigure 19 for Salsa20 constants found within the malware code), rather than calling functions\nfrom a crypto library. This makes detecting the encryption routine more difficult, and also\nmakes determining the type of encryption being used a bit more challenging for malware\nanalysts. This approach allows the malware to fly under the radar, as AV/EDRs may hook\ncrypto-related WinAPIs (such as CryptEncrypt) to detect such behavior.\n\n**Figure 18: Salsa20 Constants**\n\n**Figure 19: Salsa20**\n\nConstants\nThis algorithm is applied against a buffer that gets populated with ReadFile. Once the\ncontents of this buffer are encrypted (in memory), the cipher text is written to disk, overwriting\nthe original file.\n\n\n-----\n\n**Figure 20: File Encryption Steps**\n\nHere is a before/after of an application being encrypted during the crypto routine.\n\n**Figure 21: Before/After of an Executable being encrypted.**\nThe file extension is then modified for each encrypted file with MoveFile,using the following\nsyntax: <filename>_decryptor_{unique_id}.tor. As you can see below, the file dirwatch_ui.exe\nis being renamed to dirwatch_ui.exe_decryptor_{HphFZC}.tor, through the MoveFile\nfunction.\n\n\n-----\n\n**Figure 22: Changing encrypted file’s extension.**\nThe ransom note, titled “—==%$$$OPEN_ME_UP$$$==—.txt” is dropped to disk, and\nautomatically opened upon completion of the encryption routine. This ransom note (Figure\n23) instructs the victim to visit an online chat to receive instructions on how to decrypt the\nfiles.\n\n**Figure 23: Ransom Note**\nThe last task the malware completes is a short connection to a URL (iplogger.com) stored in\nthe malware’s resource section.\n\n**Figure 24: Extract URL from embedded resource.**\n\n**Figure 25: URL in resource.**\nThis appears to just be a simple check-in/notification of infection C2, as no data is sent to C2\nin this request. A NULL value is passed as lpOptional parameter to HttpSendRequest.\n\n## Interaction with Ransomware Support\n\nTo further understand the attack, we made an attempt to interact with the ransomware’s\nsupport team. The URL from the ransom note points to the chat’s login page, as shown in\nFigure 26.\n\n\n-----\n\n**Figure 26: Ransomware Support chat**\n\nlogin.\nUpon logging in, you are greeted with an automated message, as well as a set of rules for\nthe chat room.\n\n**Figure 27: Ransomware Support chat.**\nUnfortunately, we never received a reply. What is interesting is that the time date format\nmatches what is used in many European Countries.\n\n\n-----\n\n**Figure 28: Ransomware Support lack**\n\nof correspondence.\nRevisiting the static properties of the malware, it has a Compilation Timestamp of 2019-12**08 18:42:38 (UTC), which would fall at around 7:42pm in Europe. The malware was first**\nsubmitted to VT from an IP with a geolocation of Great Britain, at 2019-12-10 16:08:25\n(UTC).\n\n## Conclusion\n\nIn summary, this campaign exhibited how weaponized IQYs can be an effective technique for\nan attacker to infiltrate a network. Since these IQYs contain no payload (just a URL), they\ncan be challenging for organizations to detect. Organizations may have to rely on a 3rd party\nURL reputation service if they do not have appliances in place to analyze and interrogate\nthese URLs.\n\nAlthough it has been around since at least 2017, public knowledge of the Paradise\nransomware is not wide-spread. This ransomware does contain a few evasion techniques\nthat prove to be interesting and effective, such as implementing its encryption algorithm\nmanually/at the source level, to avoid API calls. The algorithm used (Salsa20) is not very\ncommonly employed by ransomware, although it has been observed being leveraged by\ncertain versions of Sodinokobi, and Anatova. Lastly, it is always interesting whenever\nmalware hard-codes a whitelist/blacklist of countries.\n\n## References\n\n[1] https://exchange.xforce.ibmcloud.com/collection/Necurs-spreads-FlawedAmmyy-RATusing-Excel-Internet-Query-attachments-c34ee7d56e1c32ab3592e47bae9f9f53\n\n\n-----\n\n## IOCs\n\nsender helmut-weiling@t-online.de\n\nsender kamel111@t-online.de\n\nsender meinzi@t-online.de\n\nsender permanent-studio-petra@t-online.de\n\nsender salamiboy97@t-online.de\n\nsender sarah.pilcke@t-online.de\n\nsender stefan.kathrin@t-online.de\n\nsender w.hiebenthal@t-online.de\n\nsender blackzor@t-online.de\n\nsender christianmicheel@t-online.de\n\nsender dirk.hoetger@t-online.de\n\nsender heinz-ulrich.link@t-online.de\n\nsender hendrik.peters14@t-online.de\n\nsender norokom@t-online.de\n\nsender polar964@t-online.de\n\nsender rhcorneli@t-online.de\n\nsender roland.ruehl@t-online.de\n\nsender sabrina-munz@t-online.de\n\nsubject RE order_3941943\n\nsubject RE.key-2561\n\nsubject Subject key#20335\n\nsubject subject Offer-57714\n\nsubject Subject offer-96226\n\nsubject subject.:order 4686\n\nsubject subject.key_963064\n\n\n-----\n\nsubject Subject.order 5366\n\nsubject fwd _1896728\n\nsubject Fwd 104\n\nsubject Fwd:-936300\n\nsubject fwd:offer-6692\n\nsubject fwd.Offer_6568\n\nsubject Re:order 9025\n\nsubject subject:#912352\n\nsubject subject. 40038\n\nsubject subject. 815779\n\nsubject subject.:Offer_4822354\n\nattachment name 0068929.iqy\n\nattachment name 186031.iqy\n\nattachment name 44127.iqy\n\nattachment name 77932.iqy\n\nattachment name 9068.iqy\n\nattachment name cv_1299934.iqy\n\nattachment name info 81081888.iqy\n\nattachment name offer#006155.iqy\n\nattachment name 086309.iqy\n\nattachment name 4310.iqy\n\nattachment name 496969.iqy\n\nattachment name 7109.iqy\n\nattachment name cv 581109.iqy\n\nattachment name Offer_52206.iqy\n\nattachment name Order_5636350.iqy\n\n\n-----\n\nattachment name order-5230.iqy\n\nattachment name profile_94414582.iqy\n\nattachment name Profile#3973.iqy\n\nURL from IQY hxxp://ocean-v[.]com/wp-content/1.txt\n\n\nURL from PowerShell\ncommand\n\n\nhxxp://ocean-v[.]com/wp-content/1.exe\n\n\nURL from IQY hxxps://ugajin[.]net/wp-content/upgrade/upd.txt\n\n\nURL from PowerShell\ncommand\n\n\nhxxps://ugajin[.]net/wp-content/upgrade/key.exe\n\n\n“Check in” URL hxxps://iplogger[.]org/1AsWy7\n\nURL from Ransom Note hxxp://prt-recovery[.]support/chat/25-decryptor\n\nIQY MD5 34517181440f4e9d6371bcb1a3aa8a6f\n\nIQY MD5 8df3bf295bf6002bda1cead3d527403d\n\n\nParadise Ransomware\n(key.exe) MD5\n\n\n9ac8c2482e25dab49befb711172924f7\n\n\n1.exe e1981688506ff4e8b22731d3a0566334\n\n\nParadise Ransomware – Full\nPath\n\nParadise Ransomware – Full\nPath (copy)\n\n\n%TEMP%\\key.exe\n\n%APPDATA%\\Roaming\\Microsoft\\Windows\\Start\nMenu\\Programs\\Startup\\.exe\n\n\nParadise Ransom Note —==%$$$OPEN_ME_UP$$$==—.txt\n\nAbout\nLatest Posts\n\n## James Haughom\n\nJames Haughom is a Malware Reverse Engineer at Lastline.Prior to Lastline, James\nsupported Incident Response and Intel teams in the federal space as a contractor.This\nsupport included Malware Analysis/Reverse Engineering, DFIR, and Tool Development.\n\n\n-----\n\n**[Latest posts by James Haughom (see all)](https://www.lastline.com/author/jhaughom/)**\n\n[Evolution of Excel 4.0 Macro Weaponization - June 2, 2020](https://www.lastline.com/labsblog/evolution-of-excel-4-0-macro-weaponization/)\n[IQY files and Paradise Ransomware - March 10, 2020](https://www.lastline.com/labsblog/iqy-files-and-paradise-ransomware/)\n\nTags:\n\n[Excel,](https://www.lastline.com/tag/excel/) [IQY,](https://www.lastline.com/tag/iqy/) [Paradise,](https://www.lastline.com/tag/paradise/) [Ransomware](https://www.lastline.com/tag/ransomware/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-10 - IQY files and Paradise Ransomware.pdf"
    ],
    "report_names": [
        "2020-03-10 - IQY files and Paradise Ransomware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535551,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1653705206,
    "ts_modification_date": 1653705206,
    "files": {
        "pdf": "https://archive.orkl.eu/e0eb5f5d0dc78657b5e652598e47498c86a3834e.pdf",
        "text": "https://archive.orkl.eu/e0eb5f5d0dc78657b5e652598e47498c86a3834e.txt",
        "img": "https://archive.orkl.eu/e0eb5f5d0dc78657b5e652598e47498c86a3834e.jpg"
    }
}