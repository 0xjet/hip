{
    "id": "c35f9279-38c6-4cb9-85d3-5f9fe99674d9",
    "created_at": "2023-01-12T15:01:10.650787Z",
    "updated_at": "2025-03-27T02:15:35.547918Z",
    "deleted_at": null,
    "sha1_hash": "059a6bb51b7b3374685319a74272926d8fc19b73",
    "title": "2021-06-07 - Gootkit- the cautious Trojan",
    "authors": "",
    "file_creation_date": "2022-05-28T04:49:46Z",
    "file_modification_date": "2022-05-28T04:49:46Z",
    "file_size": 583081,
    "plain_text": "# Gootkit: the cautious Trojan\n\n**securelist.com/gootkit-the-cautious-trojan/102731/**\n\nAuthors\n\n[Anton Kuzmenko](https://securelist.com/author/antonkuzmenko/)\n\n\n-----\n\nGootkit is complex multi stage banking malware that was discovered for the first time by Doctor Web in 2014. Initially it\nwas distributed via spam and exploits kits such as Spelevo and RIG. In conjunction with spam campaigns, the\nadversaries later switched to compromised websites where the visitors are tricked into downloading the malware.\n\nGootkit is capable of stealing data from the browser, performing man-in-the-browser attacks, keylogging, taking\nscreenshots and lots of other malicious actions. Its loader performs various virtual machine and sandbox checks and uses\n[sophisticated persistence algorithms. In 2019, Gootkit stopped operating after it experienced a data leak, but has been](https://www.zdnet.com/article/gootkit-malware-crew-left-their-database-exposed-online-without-a-password/)\n[active again since November 2020.](https://www.bleepingcomputer.com/news/security/gootkit-malware-returns-to-life-alongside-revil-ransomware/)\n\nGootkit’s victims are mainly located in EU countries such as Germany and Italy. In this article we analyze a recent sample\nof Gootkit.\n\n## Technical Details\n\nGootkit consists of a (down)loader component written in C++ and the main body written in JS and interpreted by Node.js.\nThe main body is a modular framework, containing registration, spyware, VMX detection and other modules.\n\n### Loader\n\n[The sample (MD5 97713132e4ea03422d3915bab1c42074) is packed by a custom-made multi-stage packer which](https://opentip.kaspersky.com/97713132e4ea03422d3915bab1c42074/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\ndecrypts the final payload step by step. The last stage is a shellcode that decrypts the original loader executable and\nmaps it into memory. After mapping, the original entry point is called. Hence, we can easily unpack the original executable\nand analyze it. We detect the Gootkit loader with the verdicts listed in the table below.\n\n**MD5** **SHA-1** **Verdict**\n\n[97713132e4ea03422d3915bab1c42074](https://opentip.kaspersky.com/97713132e4ea03422d3915bab1c42074/?utm_source=SL&utm_medium=SL&utm_campaign=SL) a90c6e7c5650e73ceb0b329fa8c78045632100ee TrojanDownloader.Win32.Injecter\n\n[27626f2c3667fab9e103f32e2af11e84](https://opentip.kaspersky.com/27626f2c3667fab9e103f32e2af11e84/?utm_source=SL&utm_medium=SL&utm_campaign=SL) 6e9e30c699c7111089fe364ce47f1dc05c8bc703 HEUR:Trojan.Win32.Generic\n\nMost of the strings are encrypted using XOR encryption and are decrypted at runtime. No other techniques are used to\ncomplicate static analysis.\n\n**_String decryption_**\n\n\n-----\n\nHowever, to make dynamic analysis more difficult, the Gootkit loader employs lots of different methods to detect virtual\nenvironments or debuggers. If any of the virtual machine checks succeed, the loader enters an infinite loop.\n\n**_Sample name check_**\n\n**Full list of VM detection techniques used by the malware:**\n\n**Check** **Prohibited**\n**value**\n\nCRC32 of sample name 0xBC136B46,\n0xD84A20AC,\n0xEED889C4,\n0x58636143,\n0xC0F26006,\n0x8606BEDD,\n0xE8CBAB78,\n0x2AB6E04A,\n0x31E6D1EA\n\nGetModuleHandle dbghelp.dll,\nsbiedll.dll\n\nGetUserName CurrentUser,\nSandbox\n\nGetComputerName SANDBOX,\n7SILVIA\n\nHKEY_LOCAL_MACHINE\\HARDWARE\\DESCRIPTION\\SystemBiosVersion FTNT1,\nINTEL604000,\nSMCI, QEMU,\nVBOX,\nBOCHS, AMI,\nSONI\n\nHKEY_LOCAL_MACHINE\\HARDWARE\\DESCRIPTION\\VideoBiosVersion VirtualBox\n\n\n-----\n\nHKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\SystemBiosVersion 55274-640267306423950 (Joe\nSandbox),\n76487-644317703723510\n(CWSandbox),\n76487-337842995522614 (Anubis\nSandbox)\n\nHKEY_LOCAL_MACHINE\\HARDWARE\\DESCRIPTION\\System\\CentralProcess\\0\\ProcessorNameString Xeon\n\n_MEMORYSTATUSEX. ullTotalPhys Less than\n2100000000\n\n\nUuidCreateSequential (this function is based on computer MAC address so return value is used to\ndetermine whether trojan is running in sandbox or not)\n\n\n0xF01FAF00\n(Dell Inc.),\n0x505600\n(VMWare,\nInc.),\n0x8002700\n(PCS System\nTechnology\nGmbH),\n0xC2900\nVMWare,\nInc.), 0x56900\n(VMWare,\nInc.), 0x3FF00\n(Microsoft),\n0x1C4200\n(Parallels),\n0x163E00\n(XenSource)\n\n\nCRC32 of running process names 0xAEA3ED09,\n0x2993125A,\n0x3D75A3FF,\n0x662D9D39,\n0x922DF04,\n0xC84F40F0,\n0xDCFC6E80\n\n**Execution flow**\n\nWhen the sample starts, it checks the command line arguments. The available arguments are listed below:\n\n**Argument** **Description**\n\n–client no handler\n\n–server no handler\n\n–reinstall iterate over running processes (where process is a loop variable) and kill all processes where process.pid\nis not equal to current process PID and process.name equals current filename. After that, copy self and\nrun via CreateProcessW\n\n–service set environment variable USERNAME_REQUIRED=TRUE\n\n–test stop execution\n\n–vwxyz download main body from C&C\n\n\n-----\n\nAfter the command line arguments are handled, the sample checks if it s running inside a virtual machine or being\ndebugged. If not, it decrypts the configuration and starts four threads.\n\n**_Thread start routine_**\n\n**Update_from_c2**\nThe first thread that is started tries to download a loader update from <CnC host>/rpersist4/<crc>, where <CnC\nhost> is a command-and-control server address and <crc> is the CRC32 of the first 0x200 bytes of the current file in\ndecimal format.\n**Browser_inj**\nThe thread decrypts two embedded MZPE executables (x64 and x86 DLLs), iterates over the running processes\nand tries to inject the decrypted DLLs into the process memory of the designated process using the\nNtCreateSection/NtMapViewOfSection API. Matching of the process name is done by calculating the CRC32 value\nof the process name. For a list of supported browsers, see the table below.\n\n**CRC32** **Browser name**\n\n0xC84F40F0 Chrome\n\n0x662D9D39 Firefox\n\n0x922DF04 Internet Explorer\n\n0x2993125A Microsoft Edge (MicrosoftEdgeCP.exe)\n\n0x3D75A3FF Opera\n\n0xDCFC6E80 Safari\n\n0xEB71057E unknown\n\nThe injected code is called from the main body web injection and traffic sniffing routines to perform a man-in-thebrowser attack. To do so, the code patches standard browser functions responsible for certificate validation to allow\nself-signed certificates. As a result, attackers are able to inject custom JS code and modify or redirect traffic.\n\n\n-----\n\n**Persistence_service**\nIf a sample is running under LOCAL_SYSTEM account, the Gootkit persistence mechanism abuses the pending\nGPO Windows feature. When a user modifies Pending GPO registry values, he/she has to specify the following\nparameters:\n\ncount – count of pending GPOs;\npath1, path2, … – path to the special .inf file that contains instructions on how to load GPO;\nSection1, Section2, … – name of the section from the INF file.\nSo Gootkit creates an .inf file in the same directory as the sample and writes the following values to the\nSoftware\\Microsoft\\IEAK\\GroupPolicy\\PendingGPOs registry key:\n\ncount – 0x1\npath1 – .inf file location\nSection1 – DefaultInstall\n\n**_INF file content_**\n\nNow explorer.exe will load the Group Policy Objects (GPO) whenever it is loaded. Gootkit creates a pending GPO\nfor the Internet Explorer Administration Kit (IEAK), which points directly at the INF file. When explorer.exe is loaded\nat runtime, it will execute the [DefaultInstall] inside the created file, which will run the Gootkit executable.\n\nIf the sample is running under another account, it creates a service with a random name chosen from\n%SystemRoot%, copies itself into the %SystemRoot% folder with the chosen name and deletes itself from the disk.\n\n**Stop_switch**\nThe thread looks for a file named uqjckeguhl.tmp in the \\AppData\\Local\\Temp and \\Local Settings\\Temp folders.\nWhen the file is found, the malware will stop.\n\n**Main body download**\n\nBefore downloading the main body from the C&C, the loader tries to find registry keys with the following format:\n_HKCU\\Software\\AppDataLow\\<pr_string>_<i>, where i is a number starting from 0 and pr_string is a pseudo-random_\nstring generated when the bot starts. Generation is based on the victim’s PC parameters, so the same value is generated\nfor the same PC each time.\n\nEach key contains a maximum chunk of 512,000 bytes (500KB) of encrypted data. If the aforementioned keys were\nfound, their contents will be saved in a newly allocated buffer (used for decryption and decompression). The buffer is then\ndecrypted using the same function used for decrypting the configuration, after which the buffer is decompressed.\n\nAfter the unpacking routine, the loader will download the main body from the C&C, calculate its CRC32 and compare it\nwith the registry payload CRC (if one exists). If the CRCs are different, the loader will execute the newer version\ndownloaded from the C&C. The C&C server will not send the DLL module without the appropriate UserAgent header that\nis hardcoded into the sample. The current hardcoded value is: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:25.0)\nGecko/21006101 Firefox/25.0.\n\n\n-----\n\n**_Decrypt function_**\n\n### Main body\n\n[The main body (MD5 20279d99ee402186d1e3a16d6ab9398a, verdict HEUR:Trojan.Win32.Generic) is a Node.js](https://opentip.kaspersky.com/20279d99ee402186d1e3a16d6ab9398a/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\ninterpreter with bundled encrypted JS files. On startup, the main body decrypts the JavaScript files using an RC4-like\nalgorithm with hardcoded keystream.\n\nInformation about the embedded modules is stored in an array of special file structures that have the following format:\nBYTE* name_pointer, BYTE* encrypted_data, DWORD data_size, DWORD encr_flag. These structures are used within\nthe decryption routine that reads data_size bytes starting from encrypted_data. This routine decrypts encrypted_data if\n**encr_flag is set and writes the result into a file with name *name_pointer. The decryption routine iterates over all entries**\nin the file information array. Then the decryption execution is transferred to the Node.js interpreter.\n\n**_File information array_**\n\nThe array contains 124 encrypted files, both Node.js system libraries and open-source packages, and malware modules.\nStrangely enough, the JS entry point is a file named malware.js.\n\nMalware.js initializes global bot variables, collects saved cookies (IE, Firefox, Chromium) and iterates over a list of servers\nto find an available C&C.\n\nWhen the malware finds a C&C server, it launches an infinite loop that listens to different internal malware events (some\nroutines like cookie collection start without C&C request upon bot startup) and sends the collected data to the C&C via\nspecial formatted packets. The malware also listens to the C&C commands and invokes the appropriate handler on each\ncommand. To communicate with the modules, the malware uses following packet types:\n\n\n-----\n\n**Internal name** **Description**\n\nSLAVE_PACKET_API_TAKESCREEN Send screenshot to C&C\n\nSLAVE_PACKET_MAIL Send received email info\n\nSLAVE_PACKET_LOGLINE Send log\n\nSLAVE_PACKET_LSAAUTH Send authentication credentials\n\nSLAVE_PACKET_PAGE_FRAGMENT Send web injects data\n\nSLAVE_PACKET_FORM Send grabbed form data\n\nSLAVE_PACKET_LOCAL_VARS Send local bot variables\n\nSLAVE_PACKET_SECDEVICELOG Send secure device event log\n\nSLAVE_PACKET_KEYLOG Send keylogger data\n\nSLAVE_PACKET_WINSPYLOG Send current active window\n\nThere are six types of internal event handlers and corresponding packet formats.\n\n**_Event handlers_**\n\nThe general packet structure is as follows:\n\nLength + 8 (4 bytes)\nPacket magic (0xEDB88320 XOR length+8)\nPacket data (different for each package type, serialized using protobuf)\nPacket magic\n\n\n-----\n\n**_Packet generation routine_**\n\nKaspersky products detect this family as Trojan-Downloader.Win32.Injecter, HEUR:Trojan.Win32.Generic, TrojanDownloader.Win32.Gootkit, Trojan-Banker.Win32.Gootkit. All the details, IoCs, MITRE ATT&CK Framework data, Yara\n[rules and hashes related to this threat are available to the users of our Financial Threat Intelligence services. To learn](https://www.kaspersky.com/enterprise-security/threat-intelligence)\n[more about threat hunting and malware analysis, check out expert training by Kaspersky’s GReAT.](https://xtraining.kaspersky.com/?utm_source=securelist&utm_medium=blog&utm_campaign=gl_xtr-generic-leaders_ay0073&utm_content=link&utm_term=gl_securelist_organic_tezngjogj73rli8&redef=1&THRU&reseller=gl_xtr-generic-leaders_acq_ona_smm__onl_b2b_securelist_post_______)\n\n## Indicators of compromise\n\n**Main body (same since 2019)**\n\n[20279d99ee402186d1e3a16d6ab9398](https://opentip.kaspersky.com/20279d99ee402186d1e3a16d6ab9398a/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n**Loader**\n[5249c568fb2746786504b049bbd5d9c8](https://opentip.kaspersky.com/5249c568fb2746786504b049bbd5d9c8/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[97713132e4ea03422d3915bab1c42074](https://opentip.kaspersky.com/97713132e4ea03422d3915bab1c42074/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[174A0FED20987D1E2ED5DB9B1019E49B](https://opentip.kaspersky.com/174A0FED20987D1E2ED5DB9B1019E49B/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[27626f2c3667fab9e103f32e2af11e84](https://opentip.kaspersky.com/27626f2c3667fab9e103f32e2af11e84/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n**Domains and IPs**\n\n[kvaladrigrosdrom[.]top](https://opentip.kaspersky.com/kvaladrigrosdrom.top/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[scellapreambulus[.]top](https://opentip.kaspersky.com/scellapreambulus.top/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[lbegardingstorque[.]com](https://opentip.kaspersky.com/lbegardingstorque.com/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[kerymarynicegross[.]top](https://opentip.kaspersky.com/kerymarynicegross.top/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[pillygreamstronh[.]com](https://opentip.kaspersky.com/pillygreamstronh.com/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[Financial malware](https://securelist.com/tag/financial-malware/)\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Trojan](https://securelist.com/tag/trojan/)\n[Trojan Banker](https://securelist.com/tag/trojan-banker/)\n\nAuthors\n\n[Anton Kuzmenko](https://securelist.com/author/antonkuzmenko/)\n\nGootkit: the cautious Trojan\n\n\n-----\n\nYour email address will not be published. Required fields are marked\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-07 - Gootkit- the cautious Trojan.pdf"
    ],
    "report_names": [
        "2021-06-07 - Gootkit- the cautious Trojan.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535670,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653713386,
    "ts_modification_date": 1653713386,
    "files": {
        "pdf": "https://archive.orkl.eu/059a6bb51b7b3374685319a74272926d8fc19b73.pdf",
        "text": "https://archive.orkl.eu/059a6bb51b7b3374685319a74272926d8fc19b73.txt",
        "img": "https://archive.orkl.eu/059a6bb51b7b3374685319a74272926d8fc19b73.jpg"
    }
}