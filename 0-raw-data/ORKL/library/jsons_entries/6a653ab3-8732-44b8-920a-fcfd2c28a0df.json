{
    "id": "6a653ab3-8732-44b8-920a-fcfd2c28a0df",
    "created_at": "2023-01-12T15:02:52.009383Z",
    "updated_at": "2025-03-27T02:06:07.770943Z",
    "deleted_at": null,
    "sha1_hash": "a0a45b2447fee831203f6f97d3cea580d2b3d901",
    "title": "2020-11-05 - INJ3CTOR3 Operation – Leveraging Asterisk Servers for Monetization",
    "authors": "",
    "file_creation_date": "2022-05-28T19:44:21Z",
    "file_modification_date": "2022-05-28T19:44:21Z",
    "file_size": 1946973,
    "plain_text": "# INJ3CTOR3 Operation – Leveraging Asterisk Servers for Monetization\n\n**[research.checkpoint.com/2020/inj3ctor3-operation-leveraging-asterisk-servers-for-monetization/](https://research.checkpoint.com/2020/inj3ctor3-operation-leveraging-asterisk-servers-for-monetization/)**\n\nNovember 5, 2020\n\nNovember 5, 2020\n**Research by: Ido Solomon, Ori Hamama and Omer Ventura, Network Research**\n\n## Intro\n\nRecently, Check Point Research encountered a series of worldwide attacks relevant to VoIP,\nspecifically to Session initiation Protocol (SIP) servers. Based on information provided by our\nglobal sensors, there appears to be a systematic exploitation pattern of SIP servers from\ndifferent manufactures. Further exploration revealed that this is part of a large, profitable\nbusiness model run by hackers.\n\nHacking SIP servers and gaining control allows hackers to abuse them in several ways. One\nof the more complex and interesting ways is abusing the servers to make outgoing phone\ncalls, which are also used to generate profits. Making calls is a legitimate feature, therefore\nit’s hard to detect when a server has been exploited.\n\nDuring our research, we discovered a new campaign targeting Sangoma PBX (an opensource web GUI that manages Asterisk). Asterisk is the world’s most popular VoIP PBX\nsystem, and it is used by many Fortune 500 companies for telecommunications. The attack\n\n\n-----\n\nexploits CVE-2019-19006, a critical vulnerability in Sangoma, granting the attacker admin\naccess to the system.\n\nDuring the first half of 2020, we observed numerous attack attempts on sensors worldwide.\nWe exposed the attacker’s entire attack flow, from the initial exploitation of CVE-2019-19006\nto uploading encoded PHP files that leverage the compromised system.\n\nIn this article, we first examine the infection vector used by the attacker, as well as the\nvulnerability exploited. We then investigate the threat actors behind the specific campaign.\nLastly, we explain their modus operandi.\n\n**Figure 1: Inj3ct0r’s attack flow**\n\n## Infection Vector\n\nAs mentioned in the Introduction, the campaign starts with scanning, continues with\nexploiting the vulnerability, and proceeds all the way to web shell installation. Gaining access\nto the systems allows the hackers to abuse the servers for their own purposes. CVE-201919006 is an Authentication Bypass vulnerability published in November 2019. Check Point\nResearch was able to deduce the vulnerability by examining both the captured attack traffic\nand Sangoma’s GitHub repository for FreePBX Framework.\n\n\n-----\n\n**Figure 2: Relevant commits in the FreePBX GitHub repository.**\n\nIn vulnerable versions of Sangoma FreePBX, the authentication function works by first\nsetting a session for the supplied username, and removes the session setting if the supplied\npassword does not match the one stored in the database. Additionally, FreePBX does not\nperform input sanity on the password parameter during the login process. By sending the\npassword query parameter as an array element, attackers can cause the authentication\nfunction to fail before the session is unset, thereby retaining a legitimate session for the\nchosen username, admin included.\n\n**Figure 3: CVE-2019-19006 Proof of Concept.**\n\n\n-----\n\nIssuing the above request to a vulnerable FreePBX server allows the attackers to log in as\nthe admin user. The value of ‘password’ does not matter, as the vulnerability depends on\nsending the parameter as an array element, ‘password[0]’.\n\n## Attack Flows\n\nThe attack begins with SIPVicious, a popular tool suite for auditing SIP-based VoIP systems.\nThe attacker uses the svmap module to scan the internet for SIP systems running vulnerable\nFreePBX versions. Once found, the attacker exploits CVE-2019-19006, gaining admin\naccess to the system.\n\n**Figure 4: The attacker exploits CVE-2019-19006.**\n\nAfter bypassing the authentication step, the attacker uses the asterisk-cli module to execute\na command on the compromised system and uploads a basic PHP web shell encoded in\nbase64.\n\n**Figure 5: The attacker uploads the initial web shell. The Referer header points to a previous**\nweb shell version that does not exist on the server\n\n**Figure 6: The attacker’s initial web shell.**\n\nAt this point, the attack diverges into two separate flows.\n\n## First Flow\n\n\n-----\n\n**Figure 7: The first attack flow.**\n\nIn the first flow, the initial web shell is used to retrieve the contents of Asterisk management\nfiles /etc/amportal.conf and /etc/asterisk/sip_additional.conf. These contain the credentials to\nthe FreePBX system’s database and passwords for the various SIP extensions. This\neffectively gives the attackers access to the entire system and the ability to make calls out of\nevery extension. Using the compromised Asterisk system, they then iterate over various\nprefixes for outgoing calls and try to call a specific phone number, possibly one of their own,\nin order to see which prefix they can use.\n\n\n-----\n\n**Figure 8: The attacker s call routine**\n\nNext, the attackers use the web shell to download a base64-encoded PHP file from\nPastebin. This file is padded with garbage comments—that when decoded, result in a\npassword-protected web shell, which is also capable of retrieving the credentials to the\nAsterisk Internal Database and REST Interface. The attackers also attempt to remove any\nprevious versions of their files.\n\n**Figure 9: Password protection in the web shell.**\n\n## Second Flow\n\n**Figure 10: The second attack flow.**\n\nThe second flow also uses the initial web shell to download a base64-encoded PHP file.\nDecoding this file results in another web shell that is not only password-protected, but also\nemploys access-control in the form of source IP validation and returns a fake HTTP 403\nForbidden message to unauthorized users.\n\n\n-----\n\n**Figure 11: Password protection and IP access control in the web shell.**\n\nThe attackers then use the new web shell to perform the following actions:\n\n\n-----\n\n1. Download and save a PHP file as _/tmp/k which in turn drops_\n\n‘/var/www/html/admin/views/config.php’ to the disk. This is another base64-encoded\nPHP file, again padded with subordinate comments. When decoded, it is a passwordprotected web panel. This panel lets the attackers place calls using the compromised\nsystem with both FreePBX and Elastix support, as well as run arbitrary and hard-coded\ncommands.\n\n**Figure 12: The attacker’s web panel.**\n\nThe file also appends data to ‘/var/www/html/admin/views/.htaccess’ which allows\naccess to config.php from other URIs, e.g. ’<server-url>/config’ instead of ’<serverurl>/admin/views/config.php’\n\n**Figure 13: Data appended to .htaccess.**\n\n2. Update FreePBX Framework, possibly to patch CVE-2019-19006.\n3. Download a shell script from ‘https://45[.]143.220.116/emo1.sh’.\n\nThe URL returns an HTTP 404 Not Found error, and so its purpose is currently\nunknown.\n4. Create a new directory at ‘/var/www/html/freeppx’ and move all files used in the attacks\n\nthere.\n\n## Threat Actor\n\n\n-----\n\nOur global sensors helped us obtain unique strings during the exploitation of CVE-201919006. When we searched for some of these strings, such as “rr.php” and “yokyok” (first\nseen in Figures 5 and 6), we found a script posted online to Pastebin.\n\n**Figure 14: The first lines of the script uploaded by the user INJ3CTOR3. The exploit payload**\nand the initial web shell match the attacks detected by our sensors.\n\nThe script contains the initial web shell upload and exploits the same vulnerability. Its\nuploader, “INJ3CTOR3”, has uploaded additional files in the past, including authentication\nlogs and a brute-force script. In addition, we found this name appears in an old SIP Remote\nCode Execution vulnerability (CVE-2014-7235) in the public sources.\n\nPerhaps purposely, the threat actor left a “calling card” using the name “inje3t0r3-seraj”,\nwhich appears to be a variation of the Pastebin script uploader’s name. The string was set as\nthe value of the password parameter in the malicious request sent to the Asterisk servers. As\nmentioned above, the value of ‘password’ does not matter.\n\n**Figure 15: “Inj3ct0r3-Seraj” sent as part of the exploitation of CVE-2019-19006.**\n\n\n-----\n\nThrough further investigation, the names eventually led to multiple private Facebook groups\nthat deal with VoIP, and more specifically, SIP server exploitation. The\n“voip__sip__inje3t0r3_seraj” group is the most active one, sharing admins with different\nrelevant groups, including an admin named “injctor-seraj-rean”.\n\n**Figure 16: Many admins are active in multiple groups.**\n\nThe group shares a number of tools related to SIP server exploitation: scanners,\nauthentication bypass, and remote code execution scripts. Among these scripts, we found a\nvariant of the brute-force script seen in the Pastebin of INJ3CTOR3.\n\nThe group’s main purpose is to sell phone numbers, calls plans, and live access to VoIP\nservices compromised as part of the Inj3ct0r attacks.\n\n## The Wide Phenomenon\n\nExamining the content, users and different posts published in the previously mentioned\nFacebook groups expanded our research. The different leads collected in the social\nnetworks led us to the conclusion that SIP attacks are quite common, particularly in the\nMiddle East. Closely examining the profiles of the admins, active users, and carriers seen in\nthe different groups, we found that most of them were from Gaza, the West-Bank and Egypt.\n\nWe found several relevant players in the field who have published sales posts, tools and\nwebsites. Gathering more information about the groups they manage and relevant rooms\nand channels they own led us to additional discoveries.\n\n\n-----\n\nThe initial findings were tutorials for how to scan, gather information on relative servers, and\nuse exploitation scripts. The instructions simplify the process to a level where anyone can do\nit. Perhaps as a result, there seems to be a large and growing community involved in hacking\nVoIP services.\n\nAlthough this can explain the infection chain, there is still a question about motivation. A\nfurther analysis led not only to the surprise that the attacks on SIP servers occur on a larger\nscale than initially thought, but also that there is a profound underlying economic model:\n\n**Figure 17: The modus operandi of the SIP hackers.**\n\nThe flow chain above explains the operation model in generalized terms. However, this does\nnot mean that all the attackers use the same tools and vulnerabilities. For instance, not all\nstages must be performed for an attacker to gain control of a compromised SIP server.\n\n**Relevant IP Ranges**\n\nThe very beginning of the process is when a hacker creates a list of relevant IPs per country\nthat are currently “up.” This not only narrows the scope of the scans performed in a later\nstage, but also helps hone in on the different countries in which the hacker is interested.\n\n\n-----\n\n**Figure 18: Hackers generate lists of relevant IPs per country.**\n\nThis step can usually be omitted by using smarter scanning techniques or knowledge sharing\nbetween different groups.\n\n**Scans and targets list**\n\nAfter the initial lists are created, the scanning stage begins. Various relevant scanners are\navailable for this task, with the most common one being “SIPvicious.” The hackers obtain\ninformation relevant to the scanned devices, such as versions, that will be used in later\nstages. During further analysis of the different conversations, we observed the exchange of\nsuch IPs lists and scanning scripts in different forums that discuss SIP hacking.\n\n\n-----\n\n**Figure 19: SIP hacking group. Tools, such as the scanner seen above are published among**\nthe group’s members. Most of the group’s members seem to be Arabic speakers.\n\n**Figure 20: IPs List scanned by a hacker as presented in a hacking tutorial published in the**\ntelegram group The FPBX GUI is seen in the background\n\n\n-----\n\n**Attempting to compromise SIP servers and gaining control**\n\nBased on information gathered in previous stages, hackers try to exploit relevant\nvulnerabilities to gain control of the servers. In case of missing information, or unsuccessfully\nbypassing system protections, the hackers may resort to brute force.\n\nAdditional vulnerabilities relevant to VoIP, besides the one used in the INJ3CTOR3 campaign\n(CVE-2019-19006), were found referenced in different conversations. Moreover, members\nshare knowledge of usernames and passwords lists, with relevant tools for hacking the\nsystems.\n\nIf hackers successfully gain control of the system – by exploiting vulnerabilities, brute forcing\nthe way in or using given information – the next goal is gaining persistence on the system.\nThis can be achieved by uploading web shells to continue communicating with the system. In\nthe INJ3CTOR3 campaign, we saw a few web shells used in several different steps, for\ndifferent functionalities.\n\n**Using the servers for profit**\n\nFinally, after gaining a foothold on the exploited servers, the attacker can then make calls to\nany desired numbers. A possible common usage is using the exploited servers to make calls\nto International Premium Rate Numbers (IPRN).\n\nWhen an IPRN is called, the caller is paying the owner of the IPRN per minute, the amount\nof which depends on the caller’s origin country. There are companies that provide a range of\nIPRN numbers in different plans.\n\n**Figure 21: An example of the rates table taken from a demo service. This includes the**\nprices, the relevant country and a relevant test numbers.\n\n\n-----\n\nWith enough traffic, this model can provide sufficient profit to cover the IPRN costs. For that\nreason, IPRN services are often used in businesses that put callers on hold, or have many\nclients (i.e. premium content calls). The longer the clients stay on the line, the more money\nthe company owning the IPRN receives.\n\n**Figure 22: A premium number demo-dashboard. Statistics, earnings and information per**\neach of the numbers are seen in the interface.\n\nFor these reasons, hackers seem to be focused on IPRN programs. Using IPRN programs\nnot only allows the hacker to make calls but also abuse the SIP servers to generate profits.\nThe more servers exploited, the more calls to the IPRN can be made.\n\nIn other words, hackers are considered to be a relevant market to buy IPRN plans. Thus,\nmany posts on IPRN sales can be seen on these forums and pages. We encountered many\nsuch posts by several different IPRN providers:\n\n\n-----\n\n**Figure 23: Two of many posts that sell IPRN in different**\n\n## Attack Impact\n\nAs mentioned previously, the attackers’ end goal is to sell outgoing calls from the\ncompromised systems, as well as access to the systems themselves.\n\nUnrestricted access to a company’s telephone system can allow the attackers and their\ncustomers to make calls using the compromised company’s resources and eavesdrop on\nlegitimate calls. They can also use the compromised systems for further attacks, such as\nusing the system resources for cryptomining, spreading laterally across the company\nnetwork, or launching attacks on outside targets while masquerading as the compromised\ncompany.\n\n## Conclusion\n\nThe campaign at hand utilizes an easily exploitable vulnerability to compromise Asterisk SIP\nservers around the world. In-depth details regarding the vulnerability were never publicly\nreleased, yet the threat actors behind the attack managed to weaponize and abuse it for their\nown gain. As our research shows, the threat actors, who are located in the Palestinian Gaza\nStrip, share and sell their scripts. This is a phenomenon of an established operation that sets\nthe attacks, finds the targets, and initiates the traffic to premium rate service numbers in\norder to inflate traffic and gain revenue. It’s not too far-fetched to assume that different\nattackers might use those scripts to launch their own attacks against Asterisk servers in the\nfuture.\n\n\n-----\n\nThis attack on Asterisk servers is also unusual in that the threat actors goal is not only to sell\naccess to compromised systems, but also use the systems’ infrastructure to generate profits.\nThe concept of IPRN allows a direct link between making phone calls and making money.\nThis means that further attacks can be launched from these systems.\n\n## Protections\n\n[Check Point customers are protected by these IPS protections:](https://www.checkpoint.com/products/intrusion-prevention-system-ips/)\n\nSIPVicious Security Scanner\nSangoma FreePBX Authentication Bypass (CVE-2019-19006)\nCommand Injection Over HTTP\nCommand Injection Over HTTP Payload\n\n## IOCs\n\n**Files:**\n\necc5a8b0192995673bb2c471074a3326bbeba431e189654c90afaddf570fb514\n8068cf1011f8668f741e2ec61676fa9ce6a23e62ee5b3bdf014540cff06b1ebe\nd8ab22ceab199512aaada36af245d6621208d887ae0b6510fa198d6075777043\nc3b805ffe6c988db4c8843625ab2f40cb5196935e727db658b68408b7965de59\n7c6cf2e4badbc3d4d29f4e6ed118a77d5f6e0f819244ad25b760329f25f20dd1\nf1060a686155fbbe7274073c557c24648cdf30a3f3ef2cbb184ccfc41d99fd3b\n\n**Hosts:**\n\n5[.]133.27.47\n37[.]61.220.243\n40[.]85.249.243\n45[.]143.220.115\n45[.]143.220.116\n46[.]161.55.107\n62[.]112.8.162\n77[.]247.110.91\n80[.]68.56.82\n84[.]111.36.159\n92[.]42.107.139\n134[.]119.213.127\n134[.]119.213.195\n134[.]119.214.141\n134[.]119.218.49\n151[.]106.13.150\n151[.]106.13.154\n\n\n-----\n\n151[.]106.13.158\n151[.]106.17.146\n156[.]95.156.75\n156[.]96.59.63\n185[.]53.88.198\n185[.]132.248.54\n212[.]83.189.43\n\n## References\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-05 - INJ3CTOR3 Operation – Leveraging Asterisk Servers for Monetization.pdf"
    ],
    "report_names": [
        "2020-11-05 - INJ3CTOR3 Operation – Leveraging Asterisk Servers for Monetization.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535772,
    "ts_updated_at": 1743041167,
    "ts_creation_date": 1653767061,
    "ts_modification_date": 1653767061,
    "files": {
        "pdf": "https://archive.orkl.eu/a0a45b2447fee831203f6f97d3cea580d2b3d901.pdf",
        "text": "https://archive.orkl.eu/a0a45b2447fee831203f6f97d3cea580d2b3d901.txt",
        "img": "https://archive.orkl.eu/a0a45b2447fee831203f6f97d3cea580d2b3d901.jpg"
    }
}