{
    "id": "08a1e1b0-0499-4a9a-8b04-3a122d6d455a",
    "created_at": "2023-01-12T15:01:45.657685Z",
    "updated_at": "2025-03-27T02:09:18.775628Z",
    "deleted_at": null,
    "sha1_hash": "17d3c5f92f41cc9d422fcc186361c814fb3cd9ea",
    "title": "2022-02-21 - Qbot and Zerologon Lead To Full Domain Compromise",
    "authors": "",
    "file_creation_date": "2022-05-28T18:04:51Z",
    "file_modification_date": "2022-05-28T18:04:51Z",
    "file_size": 3306711,
    "plain_text": "# Qbot and Zerologon Lead To Full Domain Compromise\n\n**[thedfirreport.com/2022/02/21/qbot-and-zerologon-lead-to-full-domain-compromise/](https://thedfirreport.com/2022/02/21/qbot-and-zerologon-lead-to-full-domain-compromise/)**\n\nFebruary 21, 2022\n\n#### In this intrusion (from November 2021), a threat actor gained its initial foothold in the environment through the use of Qbot (a.k.a. Quakbot/Qakbot) malware. Soon after execution of the Qbot payload, the malware established C2 connectivity and created persistence on the beachhead. Successful exploitation of the Zerologon vulnerability (CVE-2020-1472) allowed the threat actors to obtain domain admin privileges. This level of access was abused to deploy additional Cobalt Strike beacons and consequently pivot to other sensitive hosts within the network. The threat actor then exfiltrated sensitive documents from the environment before being evicted from the network.\n\n### Summary\n\n#### The threat actors gained initial access to a Windows workstation through the execution of a malicious DLL. The first activity of QBot was seen 5 minutes after the DLL was executed. Various automated discovery commands were used to map the network topology, retrieve local group member information, and list available file shares/privileges of the infected user.\n\n Following the first discovery stage, Qbot dropped another malicious DLL and created a scheduled task to obtain persistence. The scheduled task’s primary purpose was to execute a (base64-encoded) PowerShell Cobalt Strike beacon every 30 minutes. Once the threat actors established persistence, they continued with enumerating the environment by mapping out the Active Directory environment using tools such as Nltest, net and ADFind. Upon the identification of one of the domain controllers, the attackers proceeded to exploit the ZeroLogon vulnerability. The executable used bears striking similarity to the one used in\n\n\n-----\n\n#### a previous case From Zero to Domain Admin based on command line arguments and the overall execution of the exploit. The executable named cool.exe resets the domain controller password to an empty string, retrieves the Domain Admin password Hash, and installs a service on the DC to reset the DC password so as to not break Active Directory operations. The domain admin hash was then used on the beachhead through an over-pass-the-hash attack. After having domain admin privileges, they proceeded with deploying Cobalt Strike Beacons on a file server and another domain controller, which allowed them to pivot to those servers. Finally, documents were stolen and exfiltrated through Cobalt Strike encrypted C2 channel (HTTPS). To conclude this case, the threat actors were evicted from the network before they completed any further objectives.\n\n### Services\n\n#### We offer multiple services including a Threat Feed service which tracks Command and Control frameworks such as QBot, Cobalt Strike, BazarLoader, Covenant, Metasploit, Empire, PoshC2, etc. More information on this service and others can be found here.\n\n We also have artifacts and IOCs available from this case such as memory captures, files, event logs including Sysmon, Kape packages, and more, under our Security Researcher and Organization services.\n\n### Timeline\n\n\n-----\n\n-----\n\n#### Analysis and reporting completed by @pigerlin & @MetallicHack\n\n Reviewed by @ICSNick & @kostastsale\n\n### Initial Access\n\n#### The threat actor gained their initial access through the execution of a malicious DLL. Traditionally Qbot is delivered via email using malicious documents that then downloads the malicious DLL. In this case, however, the execution started directly from the qbot DLL found here. The execution chain for this QBot infection can be seen below:\n\n\n-----\n\n### Execution\n\n#### QBot PowerShell analysis\n\n We analyzed the registry path and associated keys that were queried by the scheduled task\n```\nHKCU:\\SOFTWARE\\Pvoeooxf and discovered that three keys were created containing\n\n base64 encoded values. Decoding the values resulted in: 1. Copy of QBot DLL 2. String of QBot C2 IP-addresses separated by a semicolon. 3. Obfuscated PowerShell script that is referenced by the scheduled task.\n\n The PowerShell script (triggered by the scheduled task) starts off a chain of events which is illustrated below:\n\n```\n\n-----\n\n#### When run for the first time, the script creates a new registry key entry in the same path, saving the date of execution. It then verifies upon execution if the creation date key of this registry key is older than 4 hours.\n\n Based on the outcome, it will either: (1) retrieve the base64-encoded Qbot payload from the Windows Registry, decode it, save it on the file system and execute it.\n\n OR (2) Fetch the QBot payload remotely using one of the active C2 IPs using the Invoke```\nWebRequest PowerShell module:\n\n```\n\n-----\n\n#### The PS script contains built-in logic to execute various types of payloads including batch and Visual Basic files.\n\n The encoded QBot DLL that was stored in the registry, was dropped in the directory\n```\n%APPDATA%\\Roaming\\Microsoft\\Fdopitcu . The unsigned DLL, with descriptor Cancel\n\n```\n\n-----\n\n#### Upon execution of this second-stage DLL, various registry keys were created in\n```\nHKCU\\Software\\Microsoft\\Yerqbqokc. In addition, a new instance of explorer.exe (32\n bit) was started and injected into.\n\n```\n\n-----\n\n#### The registry keys contain eight-character long hex strings for which we believe is part of the malware’s encrypted config.\n\n### Persistence\n\n#### Scheduled Task/Job – Scheduled Task On Beachhead\n\n\n-----\n\n#### The scheduled task created by Qbot was set to run every 30 minutes and executes a base64 encoded payload stored in the Windows Registry.\n```\nschtasks.exe /Create /F /TN \"{97F2F70B-10D1-4447-A2F3-9B070C86E261}\" /TR \"cmd /c\nstart /min \\\"\\\" powershell.exe -Command\nIEX([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String((GetItemProperty -Path HKCU:\\SOFTWARE\\Pvoeooxf).yzbbvhhdypa))) \" /SC MINUTE /MO 30\nLogName: Microsoft-Windows-TaskScheduler/Operational \nEventCode: 106\nMessage: Task scheduler Task Registered\n\n### Privilege Escalation\n\n#### Thirty minutes after gaining initial access, the threat actors ran an executable file on the beachhead to exploit CVE-2020-1472, Zerologon.\n\n The executable was named “cool.exe” :\nC:\\Windows\\system32\\cmd.exe /C cool.exe [DC IP ADDRESS] [DOMAIN NAME] Administrator c \"taskkill /f /im explorer.exe\"\n\n Three milliseconds after the Zerologon exploit, an event 4742 “A computer account was changed.” was generated on the targeted Domain Controller.\n\n As explained in a detailed blog from CrowdStrike, the ZeroLogon CVE relies on the AES- CFB8 algorithm used with a zero IV :\n\n```\n\n-----\n\n#### In order to use AES-CFB8 securely, a random initialization vector (IV) needs to be generated for every plaintext to be encrypted using the same key. However, the ComputeNetlogonCredential function sets the IV to a fixed value of 16 zero bytes. This results in a cryptographic flaw in which encryption of 8-bytes of zeros could yield a ciphertext of zeros with a probability of 1 in 256. Another implementation issue that allows this attack is that unencrypted Netlogon sessions aren’t rejected by servers (by default). The combination of these two flaws could allow an attacker to completely compromise the authentication, and thus to impersonate a server of their choice.”\n\n As we can see on the network captures, a brute-force attack was performed in order to spoof the identity of the domain controller :\n\n After the end of the brute force traffic, we can see a single instance where a the exploit has completed successfully.\n\n\n-----\n\n#### After being successfully authenticated, the DC password was set:\n\n\n-----\n\n#### The PasswordLastSet field is equal to the TimeCreated field, meaning that the password of the domain controller was successfully updated. We can also see that the SubjectUserName is ANONYMOUS LOGON.\n\n A connection was performed from the beachhead to the Domain Controller using the DC account. After authenticating to the DC with the DC account, the threat actors dumped the Domain Admin hash, and then reset the DC password in order to unbreak the Active Directory Domain.\n\n The explorer shell was also restarted by the threat actor:\n\n### Defense Evasion\n\n\n-----\n\n#### Upon execution of the initial DLL, QBot uses process hollowing to start a suspended instance of explorer.exe (32-bit) and then injects itself into this process.\n\n The injected explorer.exe process was used to spawn and inject into additional instances of explorer.exe (32-bit). An example event can be seen below. Source PID 10492 belonging to QBot, injected a DLL into PID 4072 which we discovered was part of Cobalt Strike C2 communication.\n\n\n-----\n\n#### Over-Pass-the-Hash from Beachhead\n\n The threat actor obtained the NTLM hash value of the administrator account through the Zerologon exploit and used over-pass-the-hash to request a TGT from the domain controller. We have seen the use of over-pass-the-hash several times before. For example, our Cobalt Strike Defender Guide covers detection of this technique in more detail.\n\n\n-----\n\n#### Soon after, a TGT for the administrator account was requested:\n\n\n-----\n\n### Discovery\n\n#### QBot initially starts a number of processes to collect information about the affected system. This is part of the “SYSTEM INFO” bot request, as described in a recent article from SecureList.\n\n\n-----\n\n#### Later, more discovery commands were executed via the Cobalt Strike beacon, which gathered information about the active directory environment.\n\n ADFind (renamed in find.exe) used to enumerate computers\n```\nC:\\redacted\\find.exe -f objectcategory=computer -csv name cn OperatingSystem\ndNSHostName\n\n```\n\n-----\n\n#### On the Domain Controller, the threat actors gathered information about the installed security software through WMI:\n```\nC:\\Windows\\system32\\cmd.exe /C wmic /namespace:\\\\root\\SecurityCenter2 PATH\nAntiSpywareProduct GET /value\nC:\\Windows\\system32\\cmd.exe /C wmic /namespace:\\\\root\\SecurityCenter2 PATH\nAntiVirusProduct GET /value\nC:\\Windows\\system32\\cmd.exe /C wmic /namespace:\\\\root\\SecurityCenter2 PATH\nFirewallProduct GET /value\n\n Ping was used to verify machines were online\nping -n 1 [REDACTED]\n\n### Lateral Movement\n\n#### Through the creation of Windows services, Cobalt Strike Beacons (psexec_psh function) were deployed on multiple hosts within the environment.\nEventCode: 7045\nService File Name: %COMSPEC% /b /c start /b /min powershell -nop -w hidden encodedcommand <redacted>\nUser: NT AUTHORITY\\SYSTEM\nParentImage: C:\\Windows\\System32\\services.exe\nParentCommandLine: C:\\Windows\\system32\\services.exe\n\n On the first Domain Controller, a Cobalt Strike service was installed:\n\n```\n\n-----\n\n```\nLog Source: Microsoft-Windows-Service Control Manager Event ID:7045\n\n#### Multiple services were installed by Cobalt Strike across the environment, here are a few examples:\nHKLM\\System\\CurrentControlSet\\Services\\3141131\\ImagePath \nHKLM\\System\\CurrentControlSet\\Services\\af5ff02\\ImagePath \nHKLM\\System\\CurrentControlSet\\Services\\c46234f\\ImagePath\n\n Cobalt Strike first calls OpenSCManagerW to create the service remotely, then starts it with StartServiceA function:\n\n RDP/interactive Logins\n\n Various commands were executed to enable the RDP service on various hosts:\n\n```\n\n-----\n\n#### Increase the max RDP connections allowed, in this case a arbitrarily large number.\n```\nREG ADD \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\"\n/t REG_DWORD /v \"MaxInstanceCount\" /d 0xffffffff /f\n\n Makes sure the RDP listener is enabled.\nREG ADD \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\"\n/t REG_DWORD /v \"fEnableWinStation\" /d 1 /f\n\n Makes sure the user is allowed to RDP to the terminal server.\nREG ADD \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\" /t REG_DWORD /v\n\"TSUserEnabled\" /d 0 /f\n\n Makes sure the terminal server is set to enabled.\nREG ADD \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\" /t REG_DWORD /v\n\"TSEnabled\" /d 1 /f\n\n Makes sure terminal services is set to remote admin mode.\nREG ADD \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\" /t REG_DWORD /v\n\"TSAppCompat\" /d 0 /f\n\n Makes sure that the terminal service will start idle sessions.\nREG ADD \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\" /t REG_DWORD /v\n\"IdleWinStationPoolCount\" /d 1 /f\n\n Enables advertisement of the terminal server.\nREG ADD \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\" /t REG_DWORD /v\n\"TSAdvertise\" /d 1 /f\n\n Makes sure terminal server is set to allow connections.\nREG ADD \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\" /t REG_DWORD /v\n\"AllowTSConnections\" /d 1 /f\n\n Makes sure terminal server is set to simultaneous sessions.\nREG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\Licensing Core\" /t\nREG_DWORD /v \"EnableConcurrentSessions\" /d 1 /f\n\n Makes sure multiple sessions are allowed.\nREG ADD \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\" /t REG_DWORD /v\n\"fSingleSessionPerUser\" /d 0 /f\n\n Starts the terminal services and sets service to autostart.\n\n```\n\n-----\n\n```\nsc config termservice start auto\nnet start termservice /y\n\n#### The threat actor then established interactive administrative RDP sessions and pivoted to different hosts in the network.\n\n```\n\n-----\n\n```\nLogName Security\nEventCode=4624\nLogon Type=10 (Remote Interactive Logon - RDP)\n\n### Named pipe (SMB)\n\n#### The base64 encoded payload can be decoded using this Cyberchef recipe (shout out @0xtornado) which represents a SMB beacon that creates the named pipe “dce_3d”.\nLogName=Microsoft-Windows-System/Operational\nEventCode=17\nTaskCategory=Pipe Created (rule: PipeEvent)\n\n### Command and Control\n\n#### QBot details – 24.229.150.54 // 41.228.22.180\n\n 24.229.150[.]54:995 / avlhestito[.]us\n\n```\n\n-----\n\n```\nCertificate: 25:a6:ef:79:48:98:54:ee:bb:a6:bd:10:ee:c1:f2:0a:00:ad:ac:ce\nNot Before 2021/11/15 09:24:49 UTC \nNot After 2022/11/15 13:18:32 UTC \nIssuer Org Rsc Inpye LLC. \nSubject Common avlhestito[.]us\nPublic Algorithm rsaEncryption\nJA3: c35a61411ee5bdf666b4d64b05c29e64\nJA3s: 7c02dbae662670040c7af9bd15fb7e2f\n\n#### 41.228.22[.]180:443 / xrhm[.]info\nCertificate: 96:39:a9:52:e9:9a:1e:29:c5:dc:b3:72:01:29:74:c4:87:db:15:d7\nNot  Before: 2021/11/12 04:34:10 UTC \nNot After:  2022/11/12 10:08:57 UTC \nIssuer Org: Bqatra Bamito Inc. \nSubject Common: xrhm[.]info\nPublic Algorithm: rsaEncryption\nJA3: c35a61411ee5bdf666b4d64b05c29e64\nJA3s: 7c02dbae662670040c7af9bd15fb7e2f\n\n Here is the initial access DLL (Qbot) information from Tria.ge\n\n Cobalt Strike details – 5.255.98[.]144\n\n This Cobalt Strike server was added to our Threat Feed on 2021-11-16.\n\n 5.255.98.144:8888 / 5.255.98.144:443 / 5.255.98.144:8080 / dxabt[.]com\n\n```\n\n-----\n\n```\nCertificate: [25:fe:be:6d:0e:8d:48:5a:94:cf:46:84:d7:7e:ff:bf:47:aa:04:5c ]\nNot Before: 2021/11/07 03:00:53 UTC \nNot After: 2022/02/05 03:00:52 UTC \nIssuer Org: Let's Encrypt \nSubject Common: dxabt[.]com\n[dxabt[.]com,ns1.dxabt[.]com,ns2.dxabt[.]com,ns3.dxabt[.]com,ns4.dxabt[.]com\nPublic Algorithm: rsaEncryption\nJA3: 0eecb7b1551fba4ec03851810d31743f\nJA3s: ae4edc6faf64d08308082ad26be60767\n\n#### Config:\n\n```\n\n-----\n\n```\n{\n  \"x64\": {\n    \"uri_queried\": \"/tRPG\",\n    \"sha256\": \"dec25fc2fe7e76fe191fbfdf48588c4325f52bfe2769fbc88a5614541c1075eb\",\n    \"config\": {\n      \"HTTP Method Path 2\": \"/faq\",\n      \"Jitter\": 79,\n      \"C2 Server\": \"dxabt[.]com,/case\",\n      \"Spawn To x86\": \"%windir%\\\\syswow64\\\\runonce.exe\",\n      \"Method 1\": \"GET\",\n      \"C2 Host Header\": \"\",\n      \"Method 2\": \"POST\",\n      \"Watermark\": 426352781,\n      \"Spawn To x64\": \"%windir%\\\\sysnative\\\\runonce.exe\",\n      \"Beacon Type\": \"8 (HTTPS)\",\n      \"Port\": 443,\n      \"Polling\": 53988\n    },\n    \"time\": 1637416040175.3,\n    \"md5\": \"30cc71d5b5d7778774c54486558690d3\",\n    \"sha1\": \"5f36c6cffdbae0d631c8889b4d9bad1248f899b3\"\n  },\n  \"x86\": {\n    \"uri_queried\": \"/Mr0m\",\n    \"sha256\": \"a992d57b2f6164e599952ea3c245962824ad17166684ed45e987efe80ebe611f\",\n    \"config\": {\n      \"HTTP Method Path 2\": \"/faq\",\n      \"Jitter\": 79,\n      \"C2 Server\": \"dxabt[.]com,/case\",\n      \"Spawn To x86\": \"%windir%\\\\syswow64\\\\runonce.exe\",\n      \"Method 1\": \"GET\",\n      \"C2 Host Header\": \"\",\n      \"Method 2\": \"POST\",\n      \"Watermark\": 426352781,\n      \"Spawn To x64\": \"%windir%\\\\sysnative\\\\runonce.exe\",\n      \"Beacon Type\": \"8 (HTTPS)\",\n      \"Port\": 443,\n      \"Polling\": 53988\n    },\n    \"time\": 1637416038974.9,\n    \"md5\": \"c1fd49c043894c1dff8bc02b17f8942c\",\n    \"sha1\": \"e915f74be310b1687db6b290af2f78583a981512\"\n  }\n}\n\n### Exfiltration\n\n#### While the threat actors were active in the environment, we received 3 different alerts stating that someone had opened canary documents from the IP address 91.193.182[.]165. These alerts tell us that data was indeed exfiltrated from the environment.\n\n```\n\n-----\n\n#### The threat actors were most interested in files concerning financial statements, ransomware reports, and salary data.\n\n The C2 channel was encrypted and multiple connections were established with the internal file server. No other traffic was observed for possible exfiltration leading us to the conclusion that the command and control channel was used for the exfiltration.\n\n At 17:35 UTC, the Cobalt Strike Beacon was deployed on the File Server.\n\n According to the number of connections to the C2 from the File Server per minute, we can conclude that exfiltration was done between 17:52 UTC and 18:00 UTC.\n\n Spike in traffic from file share server to Cobalt Strike command and control server.\n\n### IOCs\n\n Network\n\n\n-----\n\n```\nQBOT\n24.229.150[.]54:995 - avlhestito[.]us\n41.228.22[.]180:443 - xrhm[.]info \nCobalt Strike\n5.255.98[.]144:8888 / dxabt[.]com\n5.255.98[.]144:443 / dxabt[.]com\n5.255.98[.]144:8080 / dxabt[.]com\n\n### File\nIntial Exec Qbot DLL\nMD5:53510e20efb161d5b71c4ce2800c1a8d\nSHA1:2268178851d0d0debb9ab457d73af8a5e50af168\nSHA2:e2bc969424adc97345ac81194d316f58da38621aad3ca7ae27e40a8fae582987\nQBot DLL (extracted from registry):\nMD5:312e52b4109741893f17bc524084100f\nSHA1:7ca650945223eab088f43fd472e3592be2ed9d32\nSHA2:4d3b10b338912e7e1cbade226a1e344b2b4aebc1aa2297ce495e27b2b0b5c92b\ncool.exe\nMD5:59E7F22D2C290336826700F05531BD30\nSHA1:3B2A0D2CB8993764A042E8E6A89CBBF8A29D47D1\nSHA256:F63E17FF2D3CFE75CF3BB9CF644A2A00E50AAFFE45C1ADF2DE02D5BD0AE35B0\n\n## Detections\n\n### Network\nET POLICY Powershell Activity Over SMB - Likely Lateral Movement\nET POLICY Command Shell Activity Using Comspec Environmental Variable Over SMB - Very\nLikely Lateral Movement\nET RPC DCERPC SVCCTL - Remote Service Control Manager Access\nET CNC Feodo Tracker Reported CnC Server group 15\nET CNC Feodo Tracker Reported CnC Server group 16\nThe following rules may cause performance issues (and are disabled by default)\naccording to @ET_Labs\nET EXPLOIT Possible Zerologon NetrServerReqChallenge with 0x00 Client Challenge (CVE2020-1472) - 2030870\nET EXPLOIT Possible Zerologon NetrServerAuthenticate with 0x00 Client Credentials\n(CVE-2020-1472) 2030871 \nET EXPLOIT [401TRG] Possible Zerologon (CVE-2020-1472) UUID flowbit set - 2030888\nET EXPLOIT [401TRG] Possible Zerologon (CVE-2020-1472) M2 - 2030889\n\n#### New signatures thanks to @ET_Labs!\n\n```\n\n-----\n\n```\n2035258 ET EXPLOIT Zerologon Phase 2/3 NetrServerAuthenticate2 Request with 0x00\nClient Challenge and Sign and Seal Disabled (CVE-2020-1472) M1\n2035259 - ET EXPLOIT Zerologon Phase 2/3 - NetrServerAuthenticate2 Request with 0x00\nClient Challenge and Sign and Seal Disabled (CVE-2020-1472) M2\n2035260 - ET EXPLOIT Zerologon Phase 2/3 - NetrServerAuthenticate3 Request with 0x00\nClient Challenge and Sign and Seal Disabled (CVE-2020-1472) M1\n2035261 - ET EXPLOIT Zerologon Phase 2/3 - NetrServerAuthenticate3 Request with 0x00\nClient Challenge and Sign and Seal Disabled (CVE-2020-1472) M2\n2035262 - ET EXPLOIT Zerologon Phase 3/3 - Malicious NetrServerPasswordSet2 (CVE2020-1472)\n2035263 - ET EXPLOIT Zerologon Phase 3/3 - NetrLogonSamLogonWithFlags Request with\n0x00 Client Credentials (CVE-2020-1472)\n\n### Sigma\ntitle: Scheduled task executing powershell encoded payload from registry\nstatus: Experimental\ndescription: Detects the creation of a schtask that executes a base64 encoded payload\nstored in the Windows Registry using PowerShell.\nauthor: @Kostastsale, @TheDFIRReport\nreferences: \n - https://thedfirreport.com/2022/02/21/qbot-and-zerologon-lead-to-full-domaincompromise/\ndate: 2022/02/12\nlogsource:\n product: windows\n category: process_creation\ndetection:\n selection1:\n  Image|endswith: '\\schtasks.exe'\n  CommandLine|contains|all:\n   - '/Create'\n   - '/SC'\n selection2:\n  CommandLine|contains|all:\n   - 'FromBase64String'\n   - 'powershell'\n   - 'Get-ItemProperty'\n   - 'HKCU:'\n condition: selection1 and selection2\nfalsepositives:\n - Uknown\nlevel: high\ntags:\n - attack.execution\n - attack.persistence\n - attack.t1053.005\n - attack.t1059.001\n\n```\n\n-----\n\n```\ntitle: Execution of ZeroLogon PoC executable\nstatus: Experimental\ndescription: Detects the execution of the commonly used ZeroLogon PoC executable.\nauthor: @Kostastsale, @TheDFIRReport\nreferences: \n - https://thedfirreport.com/2021/11/01/from-zero-to-domain-admin/\n - https://thedfirreport.com/2022/02/21/qbot-and-zerologon-lead-to-full-domaincompromise/\ndate: 2022/02/12\nlogsource:\n product: windows\n category: process_creation\ndetection:\n selection1:\n  ParentImage|endswith: \n   - '\\cmd.exe'\n  Image|endswith: \n   - '\\cool.exe'\n   - '\\zero.exe'\n  CommandLine|contains|all:\n   - 'Administrator'\n   - '-c'\n selection2:\n  CommandLine|contains|all:\n   - 'taskkill'\n   - '/f'\n   - '/im'\n selection3:\n  CommandLine|contains:\n   - 'powershell'\n condition: selection1 and (selection2 or selection3)\nfalsepositives:\n - Uknown\nlevel: high\ntags:\n - attack.execution\n - attack.lateral_movement\n - attack.T1210\n\n```\n\n-----\n\n```\ntitle: Enabling RDP service via reg.exe command execution\nstatus: Experimental\ndescription: Detects the execution of reg.exe and subsequent command line arguments\nfor enabling RDP service on the host \nauthor: @Kostastsale, @TheDFIRReport\nreferences: \n - https://thedfirreport.com/2022/02/21/qbot-and-zerologon-lead-to-full-domaincompromise/\ndate: 2022/02/12\nlogsource:\n product: windows\n category: process_creation\ndetection:\n selection1:\n  Image|endswith: \n   - '\\reg.exe'\n  CommandLine|contains|all:\n   - 'add'\n   - 'HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server'\n   - 'REG_DWORD'\n Winstations1:\n  CommandLine|contains:\n   - 'WinStations\\RDP-Tcp'\n Winstations2:\n  CommandLine|contains:\n   - 'MaxInstanceCount'\n   - 'fEnableWinStation'\n selection2:\n  CommandLine|contains|all:\n   - 'Licensing Core'\n   - 'EnableConcurrentSessions'\n selection3:\n  CommandLine|contains:\n   - 'TSUserEnabled'\n   - 'TSEnabled'\n   - 'TSAppCompat'\n   - 'IdleWinStationPoolCount'\n   - 'TSAdvertise'\n   - 'AllowTSConnections'\n   - 'fSingleSessionPerUser'\n condition: selection1 and ((Winstations1 and Winstations2) or (selection2 or\nselection3))\nfalsepositives:\n - Uknown\nlevel: high\ntags:\n - attack.defense_evasion\n - attack.lateral_movement\n - attack.t1021.001\n - attack.t1112\n\n### Yara\n\n```\n\n-----\n\n```\n/\n  YARA Rule Set\n  Author: The DFIR Report\n  Date: 2022-02-20\n  Identifier: Case 8734\n  Reference: https://thedfirreport.com/2022/02/21/qbot-and-zerologon-lead-to-fulldomain-compromise/\n*/\n/* Rule Set ----------------------------------------------------------------- */\nimport \"pe\"\nrule qbot_8734_payload_dll {\n  meta:\n   description = \"files - file\ne2bc969424adc97345ac81194d316f58da38621aad3ca7ae27e40a8fae582987\"\n   author = \"The DFIR Report\"\n   reference = \"https://thedfirreport.com\"\n   date = \"2022-02-20\"\n   hash1 = \"e2bc969424adc97345ac81194d316f58da38621aad3ca7ae27e40a8fae582987\"\n  strings:\n   $s1 = \"Terfrtghygine.dll\" fullword ascii\n   $s2 = \"Winamp can read extended metadata for titles. Choose when this happens:\"\nfullword wide /* Goodware String - occured 1 times */\n   $s3 = \"Read metadata when file(s) are loaded into Winamp\" fullword wide /*\nGoodware String - occured 1 times */\n   $s4 = \"Use advanced title formatting when possible\" fullword wide /* Goodware\nString - occured 1 times */\n   $s5 = \"PQVW=!?\" fullword ascii\n   $s6 = \"Show underscores in titles as spaces\" fullword wide /* Goodware String occured 1 times */\n   $s7 = \"Advanced title display format :\" fullword wide /* Goodware String occured 1 times */\n   $s8 = \"CreatePaint\" fullword ascii\n   $s9 = \"PQRVW=2\\\"\" fullword ascii\n   $s10 = \"Advanced Title Formatting\" fullword wide /* Goodware String - occured 1\ntimes */\n   $s11 = \"Read metadata when file(s) are played or viewed in the playlist editor\"\nfullword wide /* Goodware String - occured 1 times */\n   $s12 = \"Show '%20's in titles as spaces\" fullword wide /* Goodware String occured 1 times */\n   $s13 = \"Example : \\\"%artist% - %title%\\\"\" fullword wide /* Goodware String occured 1 times */\n   $s14 = \"PQRVW=g\" fullword ascii\n   $s15 = \"PQRW=e!\" fullword ascii\n   $s16 = \"ATF Help\" fullword wide /* Goodware String - occured 1 times */\n   $s17 = \"(this can be slow if a large number of files are added at once)\"\nfullword wide /* Goodware String - occured 1 times */\n   $s18 = \"PQRVW=$\" fullword ascii\n   $s19 = \"Metadata Reading\" fullword wide /* Goodware String - occured 1 times */\n   $s20 = \"Other field names: %artist%, %album%, %title%, %track%, %year%,\n\n```\n\n-----\n\n```\n%genre%, %comment%, %filename%, %disc%, %rating%, ... fullword wide / Goodware\nString - occured 1 times */\n  condition:\n   uint16(0) == 0x5a4d and filesize < 2000KB and\n   ( pe.imphash() == \"aa8a9db10fba890f8ef9edac427eab82\" and\npe.exports(\"CreatePaint\") or 8 of them )\n}\nrule qbot_dll_8734 {\n  meta:\n   description = \"files - qbot.dll\"\n   author = \"TheDFIRReport\"\n   reference = \"QBOT_DLL\"\n   date = \"2021-12-04\"\n   hash1 = \"4d3b10b338912e7e1cbade226a1e344b2b4aebc1aa2297ce495e27b2b0b5c92b\"\n  strings:\n   $s1 = \"Execute not supported: %sfField '%s' is not the correct type of\ncalculated field to be used in an aggregate, use an internalcalc\" wide\n   $s2 = \"IDAPI32.DLL\" fullword ascii\n   $s3 = \"ResetUsageDataActnExecute\" fullword ascii\n   $s4 = \"idapi32.DLL\" fullword ascii\n   $s5 = \"ShowHintsActnExecute\" fullword ascii\n   $s6 = \"[email protected]\" fullword ascii\n   $s7 = \"OnExecutexnD\" fullword ascii\n   $s8 = \"ShowShortCutsInTipsActnExecute\" fullword ascii\n   $s9 = \"ResetActnExecute \" fullword ascii\n   $s10 = \"RecentlyUsedActnExecute\" fullword ascii\n   $s11 = \"LargeIconsActnExecute\" fullword ascii\n   $s12 = \"ResetActnExecute\" fullword ascii\n   $s13 = \"OnExecute<\" fullword ascii\n   $s14 = \"TLOGINDIALOG\" fullword wide\n   $s15 = \"%s%s:\\\"%s\\\";\" fullword ascii\n   $s16 = \":\\\":&:7:?:C:\\\\:\" fullword ascii /* hex encoded string '|' */\n   $s17 = \"LoginPrompt\" fullword ascii\n   $s18 = \"TLoginDialog\" fullword ascii\n   $s19 = \"OnLogin\" fullword ascii\n   $s20 = \"Database Login\" fullword ascii\n  condition:\n   uint16(0) == 0x5a4d and filesize < 3000KB and\n   8 of the\n\n## MITRE\n\n#### Exploitation for Privilege Escalation – T1068 Service Execution – T1569.002 Network Share Discovery – T1135 Pass the Hash – T1550.002 PowerShell – T1059.001 Windows Command Shell – T1059.003 Network Share Discovery – T1135 Obfuscated Files or Information – T1027\n\n```\n\n-----\n\n#### Scheduled Task – T1053.005 Process Injection – T1055 Remote System Discovery – T1018 Obfuscated Files or Information – T1027 Domain Trust Discovery – T1482 Domain Groups – T1069.002 System Owner/User Discovery – T1033 Network Share Discovery – T1135 Remote Services – T1021 Local Account – T1087.001 Security Software Discovery – T1518.001\n\n Internal case 8734\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-21 - Qbot and Zerologon Lead To Full Domain Compromise.pdf"
    ],
    "report_names": [
        "2022-02-21 - Qbot and Zerologon Lead To Full Domain Compromise.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535705,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653761091,
    "ts_modification_date": 1653761091,
    "files": {
        "pdf": "https://archive.orkl.eu/17d3c5f92f41cc9d422fcc186361c814fb3cd9ea.pdf",
        "text": "https://archive.orkl.eu/17d3c5f92f41cc9d422fcc186361c814fb3cd9ea.txt",
        "img": "https://archive.orkl.eu/17d3c5f92f41cc9d422fcc186361c814fb3cd9ea.jpg"
    }
}