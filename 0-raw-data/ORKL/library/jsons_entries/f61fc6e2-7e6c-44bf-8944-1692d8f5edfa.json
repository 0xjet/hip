{
    "id": "f61fc6e2-7e6c-44bf-8944-1692d8f5edfa",
    "created_at": "2023-01-12T15:04:06.619749Z",
    "updated_at": "2025-03-27T02:09:29.376005Z",
    "deleted_at": null,
    "sha1_hash": "904407064312224aac71ddf32ad4ef680ac7503c",
    "title": "2021-08-19 - Microsoft Exchange Servers Still Vulnerable to ProxyShell Exploit",
    "authors": "",
    "file_creation_date": "2022-05-28T02:25:26Z",
    "file_modification_date": "2022-05-28T02:25:26Z",
    "file_size": 2865044,
    "plain_text": "# Microsoft Exchange Servers Still Vulnerable to ProxyShell Exploit\n\n**[huntress.com/blog/rapid-response-microsoft-exchange-servers-still-vulnerable-to-proxyshell-exploit](https://www.huntress.com/blog/rapid-response-microsoft-exchange-servers-still-vulnerable-to-proxyshell-exploit)**\n\nAttackers are actively scanning for vulnerable Microsoft Exchange servers and abusing the\nlatest line of Microsoft Exchange vulnerabilities that were patched earlier this year.\n\n[Back in March, we saw multiple zero-day exploits being used to attack on-premises Exchange](https://www.huntress.com/blog/rapid-response-mass-exploitation-of-on-prem-exchange-servers)\nservers—and it looks like we’re not out of the woods yet. Those who have not patched since\nApril or May July are not safe and could still be exploited.\n\nWe recommend you update to the latest security patch, monitor for new indicators of\ncompromise and stay up-to-date on new information as it is released. We will continue to\nupdate this post with new findings.\n\n**Update #9 - 08/25/2021 - 7:10pm ET**\n\nWith an extra eye from [security researcher Florian Roth (huge thanks for keeping up with our](https://twitter.com/cyb3rops/status/1430459439526645768)\nintel!), Huntress learned that some of the hidden webshells tucked away in the Exchange\nconfiguration file discussed previously in Update #7 and #8 have also been reported with\nmodification times prior to August 2021.\n\n[We have hunted across all of the 4,000+ Exchange servers that Huntress has visibility over,](https://twitter.com/_JohnHammond/status/1430544048415072260)\nand we have found more than ~200 of these hidden webshells. These are referenced in the\npreviously mentioned Exchange configuration file with a virtualDirectory setting and a defined\nphysicalPath where the hidden webshell would be stored\n\n\n-----\n\nHere are the configuration files you should check:\n\n**C:\\Windows\\System32\\inetsrv\\Config\\applicationHost.config**\n**C:\\inetpub\\temp\\apppools\\MSExchangeECPAppPool\\MSExchangeECPAppPool.config**\n\n[Interestingly enough, the modification time of some of](https://imgur.com/gallery/cilV4KI) [these configuration files and the](https://imgur.com/gallery/7VLfPNM)\ncorresponding webshells date back to March, April, June or July—all before the ProxyShell\ntimeline. We can’t say definitively, but it is reasonable to assume these are leftover remnants\nof ProxyLogon, back in March. Additionally, none of these “old” webshell paths use the\nsubfolder names we had seen previously: WHO, XYZ, ZING, ZOO., etc.\n\nWhether you are patched or unpatched, whether or not you were affected by ProxyLogon or\nProxyShell, we strongly encourage you to look in these configuration files for indicators of\nhidden webshells. If you do uncover new webshell locations referenced, be sure to check for\nthe same directory structure and webshell file under C:\\Users\\All Users.\n\nIf you have uncovered a webshell residing in a subdirectory with one of the Windows “reserved\nnames,” removing the webshell files can be an understandable pain. Members of the\n[community have suggested attempting to rename the file. We have success with this method](https://twitter.com/DrewHjelm/status/1429854546927312901)\nfor a folder specifically, and this series of commands to remove a whole directory.\n\nThese commands should be run from an Administrator Command Prompt, with\n$DIRECTORYNAME replaced appropriately for your target directory.\n\nicacls $DIRECTORYNAME /grant administrator:F /T\n\ntakeown /F $DIRECTORYNAME /R\n\nrd \\\\.\\$DIRECTORYNAME /S /Q\n\n**Update #8 - 08/23/2021 - 6:50pm ET**\n\nWe are observing that compromised hosts that have the hidden webshells in `ProgramData`,\nreferenced below in Update #8, often may have a duplicate webshell present\nin `C:\\Users\\All Users under the same subdirectory and folder structure. We are working`\non locating these for partners and notifying you if they are discovered.\n\nPlease add this to your list of locations to look for webshells. There may be ASPX files in\nsubdirectories of these locations, if you see these present:\n\n```\nC:\\Users\\All Users\\COM\n\n```\n```\nC:\\Users\\All Users\\COM1\n\n```\n```\nC:\\Users\\All Users\\CON\n\n```\n```\nC:\\Users\\All Users\\WHO\n\n```\n\n-----\n\n```\nC:\\Users\\All Users\\XYZ\n\n```\n```\nC:\\Users\\All Users\\ZOO\n\n```\n```\nC:\\Users\\All Users\\ZING\n\n```\n\n**Update #7 - 08/23/2021 - 2:06pm ET**\n\nDigging into the tradecraft we uncovered in Update #6, where the Exchange configuration\nfile `C:\\Windows\\System32\\inetsrv\\Config\\applicationHost.config has been modified`\nto hide the presence of a webshell with a new virtual directory path.\n\nThus far, [we have discovered 88 occurrences of this, across 62 endpoints. Some servers have](https://imgur.com/gallery/PhqN35c)\nmultiple entries and virtual directories. This brings to light a few talking points:\n\n`C:\\ProgramData\\` and subdirectories also looks like a location for some webshells.\n\nThe subdirectories may not be strictly `COM or` `COM1, but also`\nsee `WHO,` `ZING,` `ZOO,` `XYZ and others.`\n\nSome entries use a physical path (a location in the filesystem to offer the user with a webshell)\nwith a UNC path `\\\\ that refers to a different machine. This could be considered \"lateral`\nmovement,\" but considering the threat actor would already need to have the access to place a\nseparate webshell there, it just adding redundant persistence to another compromised server.\n\nPlease check your `C:\\Windows\\System32\\inetsrv\\Config\\applicationHost.config file`\nfor changes to include creating a new virtual directory, and examine any newfound paths to\nhunt for and remove webshells.\n\nIf you do see lines creating a new virtual directory in the `applicationHost.config file:`\n\nDelete the webshells you may find present in the `physicalPath location`\nEdit the `applicationHost.config` to remove the lines\n\n\n-----\n\nRestart the IIS service to ensure this change is made\n\nHuntress will be sending incident reports to partners affected by this technique as we find it.\n\n**Update #6 - 08/23/2021 - 10:53am ET**\n\nWhile analyzing one host that was compromised with both ProxyShell and the LockFile\nransomware, [we uncovered a unique TTP that we had not seen before for ProxyShell activity.](https://twitter.com/DaveKleinatland/status/1429690829166235648)\nThe configuration file for the Exchange internet service was modified to include a new \"virtual\ndirectory,\" which practically redirects one URL endpoint to another location on the filesystem.\n\nThis allows a threat actor to hide a webshell in other uncommon and nonstandard locations,\noutside of the typically monitored ASP directories. If you don't know to look for this, this is\ngoing to slip under the radar and the hackers will persist in the target environment.\nAdditionally, the hidden webshell discovered on this host uses the same XML/XLS transform\ntechnique that we have seen previously.\n\n**Update #5 - 08/23/2021 @ 12:12am ET**\n\nWe're starting to pull apart Exchange log files from compromised partners' servers and have\nseen the following IP addresses and user agent strings interact with webshells:\n```\n   37.221.115[.]68 - python-requests/2.25.1\n   45.144.30[.]18 - python-requests/2.26.0\n   84.17.46[.]174 - python-requests/2.26.0\n   116.203.201[.]159 - python-requests/2.26.0\n   116.203.201[.]159 - Mozilla/5.0+\n\n```\n(Windows+NT+10.0;+Win64;+x64)+AppleWebKit/537.36+(KHTML,+like+Gecko)\n```\n   203.184.132[.]186 - python-requests/2.25.1\n   203.184.132[.]186 - Mozilla/5.0+\n\n```\n(Windows+NT+10.0;+Win64;+x64)+AppleWebKit/537.36+(KHTML,+like+Gecko)\n\nPlease block these IP addresses on your host, on-prem and web application firewalls and\nmonitor your network for these indicators of compromise.\n\n**Update #4 - 08/22/2021 @ 8:24pm ET**\n\nOf the original ~1900 vulnerable Exchange servers from Friday night, we still see 1764 that\nare unpatched as of right now. This is fairly concerning since we are starting to see active\npost-exploitation behavior that includes coinminers and ransomware.\n\n\n-----\n\nThankfully the pace of new exploitation started slowing early Saturday morning. We ve only\nobserved 13 newly exploited Exchange servers since 08/21/2021 at 0017 ET which brings the\ntotal to 164 compromised Exchange servers within the last four days.\n\n**Update #3 - 08/21/2021 @ 6:48am ET**\n\nThe pace of webshell activity slowed down a bit through the night but is still going. During this\ntime, we built some simple analytics to highlight the patch levels across ~1900 monitored\nExchange servers.\n\nHere's [@HuntressLabs breakdown of Exchange patch levels across ~1900 servers,](https://twitter.com/HuntressLabs?ref_src=twsrc%5Etfw)\ncourtesy of [@DaveKleinatland. That's a lot of potential](https://twitter.com/DaveKleinatland?ref_src=twsrc%5Etfw) [#ProxyShell carnage.](https://twitter.com/hashtag/ProxyShell?src=hash&ref_src=twsrc%5Etfw)\n[pic.twitter.com/PaMcRuGkRl](https://t.co/PaMcRuGkRl)\n\n[— Kyle Hanslovan (@KyleHanslovan) August 21, 2021](https://twitter.com/KyleHanslovan/status/1429025846770257926?ref_src=twsrc%5Etfw)\n\nCollaboration with industry security researchers [Kevin Beaumont and](https://twitter.com/gossithedog?s=21) [Rich Warren have](https://twitter.com/buffaloverflow?s=21)\nhelped corroborate that the webshell and LockFile ransomware incidents we’re seeing within\ncompanies may be related:\n\n[Huntress webshells and LockFile ransomware](https://pbs.twimg.com/media/E9TmPo6XMAYCnO-?format=jpg&name=4096x4096)\n\n[Honeypot capturing ProxyShell activity and LockFile activity](https://twitter.com/GossiTheDog/status/1429018899194974221)\n\n[Payloads uploaded with webshells](https://twitter.com/buffaloverflow/status/1429009634124238854?s=21)\n\nWe’ll continue to keep the community updated as things progress.\n\n**Update #2 - 08/21/2021 @ 2:03am ET**\n\nIn the month of August (not limited to the past 48hr surge), we've currently observed at least\nfive distinct styles of webshells deployed to vulnerable Microsoft Exchange servers:\n\n[1. XSL Transform (most common, over 130 occurrences)](https://gist.github.com/JohnHammond/cdae03ca5bc2a14a735ad0334dcb93d6)\n[2. Encrypted Reflected Assembly Loader](https://gist.github.com/JohnHammond/85ca2f7e94911451c118c36e0d3d77b6)\n[3. Comment Separation and Obfuscation of the \"unsafe\" Keyword](https://gist.github.com/JohnHammond/b7381701264842fd0d15dbb650a973d8)\n\n\n-----\n\n[4. JScript Base64 Encoding and Character Typecasting](https://gist.github.com/JohnHammond/d67cbc62efbe8db36c7f42b75958a48f)\n[5. Arbitrary File Uploader](https://gist.github.com/JohnHammond/f1455dba72a054875bc006f9fb2f95bb)\n\n**Update #1 - 08/21/2021 @ 1:19am ET**\n\nWe've seen a number of questions about whether Exchange 2010 is vulnerable. As mentioned\nbelow, the ProxyShell exploit chains [three separate vulnerabilities to get code execution.](https://i.imgur.com/iWA40ud.png)\n\nAccording to [nist.gov's CVE entries linked above, Exchange 2010 is not affected by these.](https://nist.gov/)\nHowever, Exchange 2010 reached [end of life back in October 2020 which means:](https://docs.microsoft.com/en-us/microsoft-365/enterprise/exchange-2010-end-of-support?view=o365-worldwide#:~:text=Exchange%20Server%202010%20reached%20its,the%20time%20to%20start%20planning)\n\n\"Microsoft will no longer [provide] security fixes for vulnerabilities that may make the\nserver vulnerable to security breaches\"\n\nWe strongly advise against running an EOL'd 2010 server in 2021.\n\n## What’s Happening?\n\nHackers are exploiting vulnerabilities in Microsoft Exchange, dubbed ProxyShell, to install a\nbackdoor for later access and post-exploitation. This ProxyShell attack uses three chained\nExchange vulnerabilities to perform unauthenticated remote code execution.\n\n[CVE-2021-34473 provides a mechanism for pre-authentication remote code execution,](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34473)\nenabling malicious actors to remotely execute code on an affected system.\n[CVE-2021-34523 enables malicious actors to execute arbitrary code post-authentication](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34523)\non Microsoft Exchange servers due to a flaw in the PowerShell service not properly\nvalidating access tokens.\n[CVE-2021-31207 enables post-authentication malicious actors to execute arbitrary code](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-31207)\nin the context of `system and write arbitrary files.`\n\nHuntress is seeing attackers actively exploiting these vulnerabilities against vulnerable\nExchange servers. Our team has sent over 100 incident reports related to this exploit in the\nlast two days, August 17 and 18.\n\n## What Should You Do?\n\nIt is imperative that you update your Exchange servers to the latest released patches. At a\nminimum, please ensure that you have the July 2021 updates installed. You can view the\ninstalled hotfixes by running the command `systeminfo in an administrative command`\nprompt. The output in the “Hotfixes” section should include the Knowledge Base (KB)\nidentifiers appropriate for your Exchange version, listed below.\n\nHere is a list of patch levels and appropriate hash for MSExchangeRPC service binary to\nindicate fully patched as of July 2021:\n\n[Exchange 2019 CU10 + KB5004780 = v15.2.922.13](https://support.microsoft.com/en-au/topic/description-of-the-security-update-for-microsoft-exchange-server-2019-july-13-2021-kb5004780-fc5b3fa1-1f7a-47b0-8014-699257256bb5)\n\n\n-----\n\n```\n   8a103fbf4b18871c1378ef2689f0bdf062336d7e02a5f149132cdbd6121d4781\n\n```\n[Exchange 2019 CU9 + KB5004780 = v15.2.858.15](https://support.microsoft.com/en-au/topic/description-of-the-security-update-for-microsoft-exchange-server-2019-july-13-2021-kb5004780-fc5b3fa1-1f7a-47b0-8014-699257256bb5)\n```\n   c5c88f5b013711060bcf4392caebbc3996936b49c4a9b2053169d521f82010aa\n\n```\n[Exchange 2016 CU21 + KB5004779 = v15.1.2308.14](https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-microsoft-exchange-server-2016-july-13-2021-kb5004779-81e40da3-60db-4c09-bf11-b8c1e0c1b77d)\n```\n   9f7f12011436c0bbf3aced5a9f0be8fc7795a00d0395bfd91ff76164e61f918d\n\n```\n[Exchange 2016 CU20 + KB5004779 = v15.1.2242.12](https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-microsoft-exchange-server-2016-july-13-2021-kb5004779-81e40da3-60db-4c09-bf11-b8c1e0c1b77d)\n```\n   ab767de6193c3f6dff680ab13180d33d21d67597e15362c09caf64eb8dfa2498\n\n```\n[Exchange 2013 CU23 + KB5004778 = v15.0.1497.23](https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-microsoft-exchange-server-2013-july-13-2021-kb5004778-f532100d-a9c1-4f2c-bc36-baec95881011)\n\n```\n20659e56c780cc96b4bca5e4bf48c812898c88cf134a84ac34033e41deee46e9\n\n```\n\n## Indicators of Compromise\n\nSo far, Huntress has found webshells written in subdirectories within the Exchange installation\npath. Typically, these files have a random filename, while some are human readable.\n\nBelow is a short snippet of webshells we have discovered:\n```\nC:\\inetpub\\wwwroot\\aspnet_client\\HWTJQDMFVMPOON.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\VJRFWFCHRULT.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\error.aspx\nD:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\HWTJQDMFVMPOON.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\nhmxea.aspx.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\supp0rt.aspx\nC:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\d62ffcd688.aspx\nC:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\Current\\themes\\resources\\zaivc.aspx\nC:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\415cc41ac1.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\253283293.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\ykmsr.aspx\nC:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\6514f55e1a.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\KDNLIE.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\VOLWMFQWPP.aspx\nC:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\VOLWMFQWPP.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\system_web\\NUQvLIoq.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\shell.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\updateServer.aspx\n\n```\nNote that these are not pure ASPX files. Examining the magic bytes and file header will\nexplain this is instead a Microsoft Outlook email folder.\n\n\n-----\n\nUpon further inspection of this file (with simple `strings or viewing in a hex editor), you will`\nfind valid code that may often execute code with an eval statement or allow further uploading\nof files.\n\n## Further Reading and Resources\n\n\n-----\n\nThis attack chain was presented at Black Hat USA 21 in Orange Tsai s presentation,\n“ProxyLogon is Just the Tip of the Iceberg.” For a detailed explanation on the attack chain,\nsee:\n\nOrange Tsai had also provided a text-based writeup of the attack chain for the Zero Day\n_[Initiative following the Pwn2Own contest, which you can find here.](https://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell)_\n\n**John Hammond**\n\nThreat hunter. Education enthusiast. Senior Security Researcher at Huntress.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-19 - Microsoft Exchange Servers Still Vulnerable to ProxyShell Exploit.pdf"
    ],
    "report_names": [
        "2021-08-19 - Microsoft Exchange Servers Still Vulnerable to ProxyShell Exploit.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535846,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1653704726,
    "ts_modification_date": 1653704726,
    "files": {
        "pdf": "https://archive.orkl.eu/904407064312224aac71ddf32ad4ef680ac7503c.pdf",
        "text": "https://archive.orkl.eu/904407064312224aac71ddf32ad4ef680ac7503c.txt",
        "img": "https://archive.orkl.eu/904407064312224aac71ddf32ad4ef680ac7503c.jpg"
    }
}