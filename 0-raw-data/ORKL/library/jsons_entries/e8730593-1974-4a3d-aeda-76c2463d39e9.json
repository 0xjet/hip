{
    "id": "e8730593-1974-4a3d-aeda-76c2463d39e9",
    "created_at": "2023-01-12T15:05:34.887859Z",
    "updated_at": "2025-03-27T02:06:06.210858Z",
    "deleted_at": null,
    "sha1_hash": "773bbeba375a84330bff22f79eb3ffeb3afa5441",
    "title": "2021-05-18 - A native packer for Android-MoqHao",
    "authors": "",
    "file_creation_date": "2022-05-27T19:11:08Z",
    "file_modification_date": "2022-05-27T19:11:08Z",
    "file_size": 1143427,
    "plain_text": "# A native packer for Android/MoqHao\n\n**[cryptax.medium.com/a-native-packer-for-android-moqhao-6362a8412fe1](https://cryptax.medium.com/a-native-packer-for-android-moqhao-6362a8412fe1)**\n\n@cryptax May 20, 2021\n\n[@cryptax](https://cryptax.medium.com/?source=post_page-----6362a8412fe1--------------------------------)\n\nMay 18, 2021\n\n\n3 min read\n\n_Update May 20, 2021. Added info on Pinterest URLs + Kudos to + actually was discovered_\n_on May 12 not May 13._\n\nOn May 12, 2021 a new sample of Android/MoqHao (aka XLoader, Wroba) banking trojan\nwas [detected. There are several changes compared to 2019: new commands,](https://twitter.com/malwrhunterteam/status/1392415481261330444)\ncommunicating CnC URL through malicious Pinterest accounts etc. See below.\n\nsha256: `aad80d2ad20fe318f19b6197b76937bf7177dbb1746b7849dd7f05aab84e6724`\n\nComparing sample of 2021 (sha256:\naad80d2ad20fe318f19b6197b76937bf7177dbb1746b7849dd7f05aab84e6724 ) with sample\nof 2019\n\n\n-----\n\nThis is the part of the malicious payload that processes (malicious) Pinterest accounts to\nretrieve information on the CnC. For each targeted bank, the malware searches for the\ncorresponding package on the smartphone, displays a given Pinterest URL and “hint”\nmessage. See this of .\nIn this article, we will focus on the packer which is quite interesting because it uses a\n**native library + the decryption algorithm has changed (see table above).**\n\n## Decrypting the payload\n\nThe malware is packed. The unpacking process consists in processing correctly an\nencrypted file in an asset directory named `./whrlrsu . The asset is encrypted with an XOR`\n**key, and zipped. The XOR key is memorized in the encrypted file at the 12th byte.**\n\n\n-----\n\nPayload decryption process\n[I implemented a payload decryptor, available on GitHub.](https://github.com/cryptax/misc-code/blob/master/MoqHaoUnpacker.java)\n\n## Preparing dynamic class\n\nLoading dynamic classes is typically done via the `DexClassLoader class, from the Android`\nAPI. To conceal it loads a dynamic class, the malware does not directly call\n```\nDexClassLoader . Instead, it implements a native library ( libgdx.so ) that calls\nDexClassLoader from the native layer.\n\n```\n\n-----\n\nA DexClassLoader object is instantiated by function nd(). This consists in (1) calling\nFindClass, (2) searching for a constructor, and (3) using the constructor to create a new\nobject.\nThe native library implements the following low level tasks:\n```\n   Object cr(Class class) : calls create() for the given class ( com.Loader ). This\n\n```\nactually instantiates a `Loader object.`\n```\n   Object lrd(int arg0, Object arg1, String classname, String arg3) : call\n   loadClass() on the given class name and return the loaded class object.\n   String g(int arg0) : returns a different string depending on the argument. Beware,\n\n```\nJEB currently decompiles it incorrectly: you must read the assembly.\n\n\n-----\n\nIf the integer is 0, the routine returns “dalvik.system.DexClassLoader”, for 1 it returns\n“com.Loader”, for 2 “()Ljava/lang/Object;” and for 3 “java.util.zip.InflaterInputStream”\nIn our case, the malware uses the routine with argument 1, so `g() returns “com.Loader”.`\nThis is provided to `lrd(), so the malware will load a class named` `com.Loader and`\ncontained in the dynamic DEX. Finally, it locates the method `create() within`\n```\ncom.Loader .\n\n```\nThere are some other native functions, but they are not used in the next stage. Note that up\nto know, the malware does not execute its payload, it only “prepares” things. This is all\n```\nOmApplication.onCreate() does. Execution is within the next stage.\n\n## Executing the payload\n\n```\nThe next stage occurs when the main activity is launched. Actually, strangely, the manifest\nreferences 2 main activities: `adlbect.kvActivity and` `adlbect.BnActivity, but`\nactually `adlbect.kvActivity does nothing more than calling` `adlbect.BnActivity .`\n\nSilly kvActivity does nothing more than starting BnActivity.\n\n`BnActivity starts the` `WqService` — we’ll discuss it later — and calls native function\n```\na.ed() . The method decompiles in JEB quite nicely, and we quickly recognize code to hide\n\n```\nan application icon.\n\n\n-----\n\nHiding an application icon consists in calling setComponentEnabledSetting method (name is\ntruncated on the image above) on the PackageManager class, with special flags\nPackageManager.COMPONENT_ENABLED_STATE_DISABLED and\nPackageManager.DONT_KILL_APP. This is a well known trick to run an app while hiding its\napplication icon.\nAs for the WqService, it launches `start() of` `com.Loader — this is how the banking`\n**trojan payload actually starts — and sets an alarm in 30 seconds.**\n\nThis is onStartCommand() of WqService. This method is automatically called by Android\nwhen the WqService starts. a_set_alarm calls native function a.snc() to set an alarm. I don’t\nactually know what it uses this alarm for.\nThe implementation hardens the reversing because it does not call methods directly but\ndelegates the work to 2 native functions: `a.start() calls` `com.Loader.start(), and`\n```\na.snc() to set the alarm.\n\n```\nList of native functions, and their description, in libgdx.so\nKudos to [@MalwareHunterTeam and](https://twitter.com/malwrhunterteam) [@bl4ckh0l3z.](https://twitter.com/bl4ckh0l3z)\n\n— Cryptax\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-18 - A native packer for Android-MoqHao.pdf"
    ],
    "report_names": [
        "2021-05-18 - A native packer for Android-MoqHao.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535934,
    "ts_updated_at": 1743041166,
    "ts_creation_date": 1653678668,
    "ts_modification_date": 1653678668,
    "files": {
        "pdf": "https://archive.orkl.eu/773bbeba375a84330bff22f79eb3ffeb3afa5441.pdf",
        "text": "https://archive.orkl.eu/773bbeba375a84330bff22f79eb3ffeb3afa5441.txt",
        "img": "https://archive.orkl.eu/773bbeba375a84330bff22f79eb3ffeb3afa5441.jpg"
    }
}