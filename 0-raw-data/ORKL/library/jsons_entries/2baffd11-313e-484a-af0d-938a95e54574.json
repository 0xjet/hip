{
    "id": "2baffd11-313e-484a-af0d-938a95e54574",
    "created_at": "2023-01-12T15:01:00.591698Z",
    "updated_at": "2025-03-27T02:05:27.390614Z",
    "deleted_at": null,
    "sha1_hash": "efeafeb7b61f729483cd24c3a57bc96550ca6cd4",
    "title": "2022-05-20 - Metastealer – filling the Racoon void",
    "authors": "",
    "file_creation_date": "2022-05-28T02:16:24Z",
    "file_modification_date": "2022-05-28T02:16:24Z",
    "file_size": 873594,
    "plain_text": "# Metastealer – filling the Racoon void\n\n**[research.nccgroup.com/2022/05/20/metastealer-filling-the-racoon-void/](https://research.nccgroup.com/2022/05/20/metastealer-filling-the-racoon-void/)**\n\nAuthor: Peter Gurney\n\n## tl;dr\n\n\nMay 20, 2022\n\n\nMetaStealer is a new information stealer variant designed to fill the void following Racoon\nstealer suspending operations in March of this year. Analysts at Israeli dark web intelligence\nfirm Kela first identified its emergence on underground marketplaces [1] and later as being\nused in a spam campaign by SANS Internet Storm Centre Handler Brad Duncan [2], where\nthe initial stages and traffic were detailed. This analysis further describes the final\nMetaStealer payload detailing its functionality.\n\n\n-----\n\nSignificant findings include:\n\nHeavy reliance on open-source libraries\nMicrosoft Defender Bypass\nScheduled Task Persistence\nPassword Stealer\nKeylogger\nHidden VNC server\n\nFigure 1 MetaStealer Loader Execution\n\n## Technical Analysis\n\n Defender Bypass\n\nEarly on in execution, the below command is executed using PowerShell:\n\n\n-----\n\n```\npowershell inputformat none outputformat none NonInteractive Command Add\nMpPreference -ExclusionExtension \"exe\"\n\n```\nAs can be seen below in Figure 2 the command adds an exclusion rule to Microsoft\nDefender, effectively turning off scanning of files with ‘.exe’ extension. This decreases the\nchances of the main payload being detected as well as any subsequent payloads that may\nbe delivered to the target host post infection.\n\nFigure 2\n\nDefender Exclusion\nWith the Microsoft Defender exclusion in place another PowerShell command is issued that\nproceeds to rename the original file to a hardcoded value with an `.exe extension. In this`\ncase `{Original filename}.xyz to` `hyper-v.exe`\n```\npowershell rename-item -path .xyz -newname hyper-v.exe\n\n## Persistence\n\n```\nTo maintain persistence, a scheduled task is created using The Component Object Model\n(COM), a task named `sys is created in the folder` `\\Microsoft\\Windows’ The task is set`\nto trigger at user login, ensuring the malware remains persistent across reboots.\n\n\n-----\n\nFigure 3 String de-obfuscation example\n\n## String Obfuscation\n\nWhile several strings from included libraries are visible within the sample, the majority of\nstrings within MetaStealer’s main code are encrypted and only decrypted as needed during\nruntime. To achieve this, the encrypted strings are moved onto the stack and decrypted with\na bitwise XOR operation for use during execution. A Python representation of the routing can\nbe seen below with an example seen below in Figure 4\n\n\n-----\n\n```\ndef swap32(x):\n  return int.from_bytes(x.to_bytes(8, byteorder='little'), byteorder='big',\nsigned=False)\ndef split_hex(input):\n  text = hex(input)\n  text = text[2:]\n  text = text.zfill(len(text) + len(text) % 2)\n  output = \" \".join(text[i: i+2] for i in range(0, len(text), 2))\n  return(output.split(' '))\nhexIntXOR = []\nhexIntKey = []\nhexIntXOR.append(0x4BFB9390)\nhexIntXOR.append(0x25C2F251)\nhexIntXOR.append(0x11C52ED4)\nhexIntXOR.append(0x5CEDBB0D)\nhexIntKey.append(0x2489FBF3)\nhexIntKey.append(0x25C2973C)\nhexIntKey.append(0x11C52ED4)\nhexIntKey.append(0x5CEDBB0D)\nhexbytesxor = []\nhexbyteskey = []\nfor HexInt in hexIntXOR:\n  hexBytes = split_hex(HexInt)\n  hexBytes.reverse()\n  hexbytesxor = hexbytesxor + hexBytes\nfor HexInt in hexIntKey:\n  hexBytes = split_hex(HexInt)\n  hexBytes.reverse()\n  hexbyteskey = hexbyteskey + hexBytes\ncount = 0\nfor hexByte in hexbytesxor:\n  print(chr(int(hexByte, base=16) ^ int(hexbyteskey[count], base=16)), end='')\n  count+=1\n\n```\n\n-----\n\nFigure 4 String de-obfuscation example\n\n## Command and Control\n\nPCAPs from the SANS Internet Storm Centre report show that while initial C2 registration\ntraffic was successful, later requests resulted in an HTTP 400 error code reply. Our own tests\nconfirm this behaviour indicating this specific campaign was short-lived with commands no\nlonger issued to new infections. This is likely a direct attempt to limit further analysis of the\ncommand and control communication protocol by analysts.\n\nThe sample contains a hardcoded Command and Control server, in this case,\n193.106.191[.]162:1775, which is decrypted by the standard string decryption routine\ndescribed in the previous section.\n\nConnection to the command and control infrastructure is performed over HTTP using the\nlibrary ‘cpp-httplib’ [3], resulting in the user agent `cpp-httplib/0.10.1 being used.`\n\nThe initial connection is performed to the URL path `/api/client/new, decrypted using the`\nXOR routine detailed earlier. This connection is simply a get request with no further\ninformation included and expects a reply in JSON format, as can be seen in Figure 5\n\n\n-----\n\nFigure 5 Registration connection\nThe UUID in the `ok key is used as a` `BotId and changes on each new registration`\nrequest.\n\nTo parse the JSON string, another open-source library is utilised (Nlohmann JSON [4]),\nextracting the BotId, which is subsequently written to the file `%localappdata%\\hyper-`\n```\nv.ver in plaintext allowing the BotId to remain persistent across reboots.\n\n```\nThe second request to the command and control server begins with a new JSON object\nbeing created utilising the Nlohmann JSON library. The UUID key is populated with the UUID\nreceived from the earlier registration request.\n\nFigure 6 get worker request body\nThe URL path `/tasks/get_worker is decrypted and used to make a POST request to the`\ncommand and control server, including the UUID JSON string. At the time of writing, the\nserver replies to this command with a HTTP 400 error code as seen in Figure 7.\n\n\n-----\n\nFigure 7 get worker request\nThe final identified command and control request uses the URL path ‘/tasks/collect’ following\nthe completion of any tasks issued. A POST request is made detailing the success or failure\nof the task along with additional data such as stolen information or command output.\n\n### Command and Control Commands\n\n\n**Command**\n**ID**\n\n\n**Function** **Description**\n\n\n1001 System\nInformation\n\n1002 Cookie\nStealer\n\n1003 Password\nStealer\n\n\nSpawn cmd.exe process with the command line system info\nand read output using attached pipes.\n\nAccess Cookie data from the following locations (location can\nchange based on a currently installed version check): Chrome\n‘C:\\Users\\{user}\\AppData\\Local\\Google\\Chrome\\User\nData\\Default{\\Network (depending on version check) }\\Cookies’\nFirefox C:\\Users\\\n{user}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\cookies.sqlite\nEdge C:\\Users\\{user}\\AppData\\Local\\Microsoft\\Edge\\User\nData\\Default{\\Network (depending on version check) }\\Cookies\n\nAccess saved password data from the following locations:\nChrome C:\\Users\\{user}\\AppData\\Local\\Google\\Chrome\\User\nData\\Default\\Login Data Firefox C:\\Users\\\n{user}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\ logins.json /\nsignons.sqlite C:\\Users\\\n{user}\\AppData\\Local\\Microsoft\\Edge\\User\nData\\Default\\LoginData\n\n\n-----\n\n1004 Start\nkeylogger\n\n1005 Stop\nkeylogger\n\n1006 Start\nHVNC\n\n1007 Stop\nHVNC\n\n1008 Execute\nCommand\n\n\nStart keylogger on the following applications:\nChromeFirefoxNotepad\n\nStop Keylogger\n\nSetup Hidden Virtual Network Connection by creating a hidden\ndesktop and network connectivity using sockets through the\nopen-source library Kissnet [5]\n\nStop HNVC\n\nExecute the given command using a spawned cmd.exe\nprocess and read the result using connected pipes.\n\n\nTable 1 Command and Control Commands\n\n## Appendix\n\n IOC’s\n\n193.106.191[.]162:1775\ncpp-httplib/0.10.1\nhyper-v.exe\n\n## YARA\n```\nrule metaStealer_memory {\n  meta:\n   description = \"MetaStealer Memory\"\n   author = \"Peter Gurney\"\n   date = \"2022-04-29\"\n  strings:\n   $str_c2_parse = {B8 56 55 55 55 F7 6D C4 8B C2 C1 E8 1F 03 C2 8B 55 C0 8D 04 40\n2B 45 C4}\n   $str_filename = \".xyz -newname hyper-v.exe\" fullword wide\n   $str_stackstring = {FF FF FF C7 85 ?? ?? ?? ?? ?? ?? ?? ?? C7 85 ?? ?? ?? ?? ??\n?? ?? ?? C7 85 ?? ?? ?? ?? ?? ?? ?? ?? C7 85 ?? ?? ?? ?? ?? ?? ?? ?? 66 0F EF}\n  condition:\n   uint16(0) == 0x5a4d and\n   2 of ($str_*)\n}\n\n References\n\n```\n[1] https://www.bleepingcomputer.com/news/security/new-blackguard-passwordstealing-malware-sold-on-hacker-forums/\n\n\n-----\n\n[2] [https://isc.sans.edu/forums/diary/Windows+MetaStealer+Malware/28522/](https://isc.sans.edu/forums/diary/Windows+MetaStealer+Malware/28522/)\n\n[3] [https://github.com/yhirose/cpp-httplib](https://github.com/yhirose/cpp-httplib)\n\n[4] [https://github.com/nlohmann/json](https://github.com/nlohmann/json)\n\n[5] [https://github.com/Ybalrid/kissnet](https://github.com/Ybalrid/kissnet)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-20 - Metastealer – filling the Racoon void.pdf"
    ],
    "report_names": [
        "2022-05-20 - Metastealer – filling the Racoon void.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535660,
    "ts_updated_at": 1743041127,
    "ts_creation_date": 1653704184,
    "ts_modification_date": 1653704184,
    "files": {
        "pdf": "https://archive.orkl.eu/efeafeb7b61f729483cd24c3a57bc96550ca6cd4.pdf",
        "text": "https://archive.orkl.eu/efeafeb7b61f729483cd24c3a57bc96550ca6cd4.txt",
        "img": "https://archive.orkl.eu/efeafeb7b61f729483cd24c3a57bc96550ca6cd4.jpg"
    }
}