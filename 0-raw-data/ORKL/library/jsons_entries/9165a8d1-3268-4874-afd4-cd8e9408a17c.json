{
    "id": "9165a8d1-3268-4874-afd4-cd8e9408a17c",
    "created_at": "2023-01-12T15:00:25.480866Z",
    "updated_at": "2025-03-27T02:05:30.933374Z",
    "deleted_at": null,
    "sha1_hash": "67b43c69912b9432f88ca41d69738c778a934e3a",
    "title": "2017-03-10 - Explained- Spora ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T04:56:18Z",
    "file_modification_date": "2022-05-28T04:56:18Z",
    "file_size": 789854,
    "plain_text": "# Explained: Spora ransomware\n\n**[blog.malwarebytes.com/threat-analysis/2017/03/spora-ransomware/](https://blog.malwarebytes.com/threat-analysis/2017/03/spora-ransomware/)**\n\nMalwarebytes Labs March 10, 2017\n\n[Nowadays, ransomware has become the most popular type of malware. Most of the new](https://www.malwarebytes.com/ransomware)\nfamilies are prepared by amateurs (script-kiddies) and they are distributed on a small scale.\nThere are only a few major players on this market that are prepared by professionals.\nRecently, Spora ransomware joined this set. As we will see, some of the elements suggest\nthat there is a well-prepared team of criminals behind it.\n\nSpora got some hype of being a ransomware that can encrypt files offline. In fact, this\nconcept is nothing novel – we already saw many ransomware families that can do the same.\nFor example DMA Locker 3.0, Cerber, or some newer editions of Locky. However, it has\nsome other features that make it interesting.\n\n## Analyzed samples\n\n[0c1007ba3ef9255c004ea1ef983e02efe918ee59 – case #1](https://www.hybrid-analysis.com/sample/e3af616583327f189f2d9e0b1c38199e1f35dda391b6a559253be0fb4410a0e9?environmentId=100)\n\n**[4a4a6d26e6c8a7df0779b00a42240e7b – payload #1 – Spora ransomware <-](https://virustotal.com/en/file/7ad9ed23a91643b517e82ad5740d24eca16bcae21cfe1c0da78ee80e0d1d3f02/analysis/1488650648/)**\nmain focus of this analysis\n[38e645e88c85b64e5c73bee15066ec19 – payload #2 – a downloader similar to](https://virustotal.com/en/file/9351201405b1cfdc13c55fb66da810d3d6554d9f0339a9545ebfc70f864b0bf0/analysis/1488650661/)\n[this one](http://now.avg.com/german-phishing-scam-spreading-globally/)\n\n## Distribution method\n\n\n-----\n\n[Spora is distributed by various ways – from phishing e-mails (described here) to infected](https://securingtomorrow.mcafee.com/mcafee-labs/spora-ransomware-infects-offline-without-talking-control-server/?utm_source=twitter&utm_campaign=Labs#sf59263292)\nwebsites dropping malicious payloads.\n\n[Some examples of the distribution method used by this ransomware are described here (the](http://malware-traffic-analysis.net/2017/02/14/index2.html)\n[campaign from 14.02.2017) and here (the campaign from 06.03.2017).](http://malware-traffic-analysis.net/2017/03/06/index.html)\n\n## Behavioral analysis\n\nAfter being deployed, Spora ransomware runs silently and encrypts files with selected\nextensions. Then, it attempts to redeploy itself with elevated privileges. No UAC bypass\nmechanism has been used – instead, the UAC popup appears repeatedly till the user\naccepts it:\n\nThen, it deploys another system tool – vssadmin, for deleting shadow copies:\n\nIt doesn’t even try to be silent – command line window is displayed.\n\nIt also drops its own copy into C: directory. Several modifications are being made in existing\nfolder’s settings. First of all, Spora disables displaying an arrow icon to indicate shortcuts. It\nmakes all the existing folders as hidden and creates shortcuts to each of them. The shortcut\nnot only deploys the original folder but also the dropped malware sample.\n\nExample of a command, deployed when the user clicks on the shortcut:\n\n\n-----\n\n```\nC:\\Windows\\C:\\Windows\\system32\\cmd.exe /c \nstart explorer.exe \"Program Files\" \n& type \"81d59edde88fc4969d.exe\" > \"%temp%\\81d59edde88fc4969d.exe\" \n&& \"%temp%\\81d59edde88fc4969d.exe\"\n\n```\nSpora doesn’t change filenames, nor adds extensions. Each file is encrypted with a separate\nkey (files with the same plaintext are encrypted to different ciphertexts). Encrypted content\nhas high entropy, no patterns are visible, that suggest a stream cipher or chained blocks\n(probably AES in CBC mode).\n\nVisualization of a file – before and after encryption:\n\n\n-----\n\nThe malware drops related files in several locations. The following files can be found in\n%APPDATA%.\n\nThe file with the .KEY extension and a ransom note in HTML format are also dropped on the\nDesktop:\n\nThe .KEY file contains encrypted data about the victim that needs to be uploaded later to the\nattacker’s website for the purpose of synchronizing the status of the victim.\n\nWhen the encryption finishes, a ransom note pops up. In the first analyzed cases it was in a\nRussian language. However, other language versions also exists, for example – English note\ngiven below:\n\n\n-----\n\nThe content of the .KEY file is Base64 encoded and stored as a hidden field inside the\nransom note:\n\nIn newer versions (#2) the .KEY file was not dropped at all, and the full synchronization with\nthe remote server was based on its equivalent submitted automatically as the hidden field. It\nshows the second step in evolution of this ransomware – to make the interface even simpler\nand more accessible.\n\n## Website for the victim\n\nRansomware itself is not looking sophisticated, except for its website for the victim and the\ninternals of the .KEY file (or it’s base64 equivalent). In older versions, a user was asked to\nupload the .KEY file to the website and all of his/her private information are retrieved, i.e.\nusername, infection date, status, etc.\n\n\n-----\n\nIn newer versions, there is no necessity to upload anything – when the user clicks the link on\nthe ransom note, the base64 content containing all the data is submitted automatically.\n\nSome information is also encoded inside the victim ID: country code (first two characters),\nhash, statistics about encrypted files types (how many particular types of files has been\nencrypted of each category: office document, PDF, Corel Draw, DB, Image, Archive). You\n[can find a decoder here.](https://gist.github.com/coldshell/6204919307418c58128bb01baba6478f)\n\nAnother step taken by authors to provide a user-friendly interface is the fact that the site\n(although hosted as a hidden service) does not require users to download a Tor browser, like\nmost of the ransomware, but instead, provides a convenient gateway at spora.bz.\n\n## Inside\n\nSpora executable comes packed in various crypters. It has been also observed distributed in\nbundles with other malware. In case #1, after defeating the first encryption layer, we can find\ntwo UPX-packed payloads. They can be unpacked by the standard UPX application. As a\n\n\n-----\n\nresult, we are getting samples that are not further obfuscated. In the mentioned case, Spora\nransomware was distributed along with a malicious downloader\n[(38e645e88c85b64e5c73bee15066ec19) similar to the one described here. (Since this](https://virustotal.com/en/file/9351201405b1cfdc13c55fb66da810d3d6554d9f0339a9545ebfc70f864b0bf0/analysis/1488650661/)\narticle is dedicated to Spora ransomware only, the second payload will not be further\ndescribed).\n\n**Execution flow**\n\nSpora’s execution path varies depending on the parameter with which it has been deployed.\nOn its initial run it is executed without any parameter. Then, the basic steps are the following:\n\n1. Create mutex (pattern: m<VolumeSerialNumber:decimal>)\n\n2. Decrypt AES protected data stored in the binary (i.e. RSA public key, ransom note, sample\nID)\n\n3. Search files with the attacked extensions. Make a list of their paths and statistics of the\ntypes.\n\n4. Generate RSA key pair (one per victim)\n\n5. Encrypt files with the selected extensions\n\nAfter completing these operations, Spora redeploys it’s own binary – this time with\nAdministrative privileges (causing UAC alert to pop-up). It passes in the command-line a\nparameter ‘\\u’ that modifies the execution path.\n\nSome of the steps that are executed in such case are:\n\n1. Delete shadow copies\n\n\n-----\n\n2. Modify lnkfile settings (in order to hide an arrow added by default to indicate shortcut –\nmore about it’s purpose described in the section “Behavioral analysis”)\n\n3. Drop it’s own copy and the ransom not on every drive\n\n4. Deploy explorer displaying the ransom note\n\n**What is attacked?**\n\nSpora ransomware attacks the following extensions:\n```\nxls doc xlsx docx rtf odt pdf psd dwg \ncdr cd mdb 1cd dbf sqlite accdb jpg \njpeg tiff zip rar 7z backup sql bak\n\n```\nThey are grouped in several categories, used to build statistics for the attackers. The\ncategories can be described as such: office documents, PDF/PPT documents, Corel Draw\ndocuments, database files, images, and archives:\n\n\n-----\n\nSeveral system directories are excluded from the attack:\n```\nwindows\nprogram files\nprogram files (x86)\ngames\n\n```\n**How does the encryption works?**\n\nEncryption used by Spora ransomware is complex, follows several levels. It uses Windows\nCrypto API. The executable comes with two hardcoded keys: AES key – used to decrypt\nelements hardcoded in the binary, and an RSA public key – used to encrypt keys generated\non the victim’s machine.\n\nIn addition to operations related to encrypting victim’s files, Spora uses Windows Crypto API\nfor other purposes – i.e. to encrypt temporary data, and to decrypt some elements stored in\nthe binary.\n\nFirst, it creates a file in %APPDATA% – the filename is the Volume Serial Number. This file\nis used for temporary storing information.\n\n\n-----\n\nThe temporarily stored information is encrypted with the help of the function\nCryptProtectData:\n\nIt includes, i.e. list of the fies to be encrypted (with extensions matching the list):\n\nThe malware sample comes with a hardcoded key that is being imported:\n\n\n-----\n\nIt is an AES 256 key, stored in a form of blob. Explanation on the fields in the Blob Header:\n```\n08 - PLAINTEXTKEYBLOB - key is a session key\n02 - CUR_BLOB_VERSION\n0x00006610 - AlgID: CALG_AES_256\n0x20 - 32 - key length\n\n```\nThe AES key is used for decrypting another key, stored in a binary – that is an RSA public\nkey:\n```\n-----BEGIN PUBLIC KEY----MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC6COfj49E0yjEopSpP5kbeCRQp\nWdpWvx5XJj5zThtBa7svs/RvX4ZPGyOG0DtbGNbLswOYKuRcRnWfW5897B8xWgD2\nAMQd4KGIeTHjsbkcSt1DUye/Qsu0jn4ZB7yKTEzKWeSyon5XmYwoFsh34ueErnNL\nLZQcL88hoRHo0TVqAwIDAQAB\n-----END PUBLIC KEY----\n```\nAfter that, the same AES key is imported again and used to decrypt other elements:\n\n\n-----\n\nThe ransom note in HTML format:\n\nA hardcoded ID of the sample:\n```\nD283C31972\n\n```\nFor every victim, Spora creates locally a fresh pair of RSA keys. Below you can see the\nfragment of code generating new RSA key pair (1024 bit):\n\nExplanation of the parameters:\n```\n0xA400 - AlgId: CALG_RSA_KEYX\n0x04000001 - RSA1024BIT_KEY | CRYPT_EXPORTABLE\n\n```\nThe private key from the generated pair is exported and Base64 encoded:\n\n\n-----\n\nThe formated version of the private key is stored in a buffer – along with the collected data\nabout the machine and the infection, including: date, username, country code, malware\nsample id, and statistics of encrypted file types.\n\nExample:\n\nThen, another AES key is being generated. It is exported and encrypted by the public RSA\nkey, that was hardcoded in the sample. Below – encrypting the exported AES key blob:\n\n\n-----\n\nThe generated AES key is used to encrypt the victim’s data (including the private key from\nthe generated pair):\n\nThe prepared encrypted content is merged into one data block. First, the AES encrypted\nvictim’s data is copied. After that follows the RSA encrypted AES key (selected on the below\npicture):\n\n\n-----\n\nThis merged data is stored in the .KEY file (or in the hidden, base64 encoded content in the\nransom note). It needs to be uploaded to the server by the victim – that’s how the attackers\nget access to the data necessary to decrypt files after the ransom is paid.\n\nSpora does not change files’ extensions, so it needs some other method of identifying\nwhether or not the individual file is encrypted. It is done by reading some fragments of the\ncontent.\n\n\n-----\n\nAs we can see above, the 132 bytes at the end of the file are reserved for the data stored by\nSpora: 128 byte long AES key followed by its 4 byte long Crc32. In order to decide if the file\nis encrypted or not, data at the file’s end is read and the saved Crc32 is compared with the\ncomputed Crc32 of the read 128 bytes. If the check passed, Spora finishes processing the\nfile. Otherwise, it follows with the encryption:\n\nFor each file, a new, individual AES key is generated. It is used to encrypt mapped file\ncontent. The exported representation of the individual key is encrypted by the previously\ngenerated RSA key and then stored at the end of the encrypted file. After that, it’s Crc32 is\nbeing computed and also stored at the end.\n\n## Conclusion\n\nSpora is an interesting ransomware, for sure created by authors with programming\nexperience. However, the code is not obfuscated and the execution is very noisy in\ncomparison to other malware – it may suggest that the authors are not professional malware\ndesigners (in contrary to i.e. authors of Cerber).\n\nThe used cryptography implementation seems to have no flaws that would allow for\ndecrypting attacked files without paying the ransom, so, we recommend focusing on\n[prevention. Users with Malwarebytes 3.0 installed will be protected from Spora ransomware.](https://www.malwarebytes.com/premium/)\nWhile there currently is no decryption for those infected we suggest keeping a backup of the\ninfected files as there might be a decrypter in the future.\n\n## Appendix\n\n[https://gist.github.com/coldshell/6204919307418c58128bb01baba6478f – Spora ID decoder](https://gist.github.com/coldshell/6204919307418c58128bb01baba6478f)\n\nhttps://www.bleepingcomputer.com/news/security/spora-ransomware-works-offline-has-themost-sophisticated-payment-site-as-of-yet/ – Bleeping Computer about Spora\n\n\n-----\n\n_This was a guest post written by Hasherezade, an independent researcher and programmer_\n_with a strong interest in InfoSec. She loves going in details about malware and sharing threat_\n_[information with the community. Check her out on Twitter @hasherezade and her personal](https://twitter.com/hasherezade)_\n_[blog: https://hshrzd.wordpress.com.](https://hshrzd.wordpress.com/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-03-10 - Explained- Spora ransomware.pdf"
    ],
    "report_names": [
        "2017-03-10 - Explained- Spora ransomware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535625,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1653713778,
    "ts_modification_date": 1653713778,
    "files": {
        "pdf": "https://archive.orkl.eu/67b43c69912b9432f88ca41d69738c778a934e3a.pdf",
        "text": "https://archive.orkl.eu/67b43c69912b9432f88ca41d69738c778a934e3a.txt",
        "img": "https://archive.orkl.eu/67b43c69912b9432f88ca41d69738c778a934e3a.jpg"
    }
}