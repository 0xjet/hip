{
    "id": "600e4d26-8bd5-4f05-a26f-75718c4179c8",
    "created_at": "2023-01-12T15:08:19.359656Z",
    "updated_at": "2025-03-27T02:05:18.791822Z",
    "deleted_at": null,
    "sha1_hash": "8530988e413262bfac72f23f49488dbcb0de6875",
    "title": "2021-06-25 - Lorenz ransomware- analysis and a free decryptor",
    "authors": "",
    "file_creation_date": "2022-05-28T18:22:33Z",
    "file_modification_date": "2022-05-28T18:22:33Z",
    "file_size": 193085,
    "plain_text": "# Lorenz ransomware: analysis and a free decryptor\n\n**[tesorion.nl/en/posts/lorenz-ransomware-analysis-and-a-free-decryptor/](https://www.tesorion.nl/en/posts/lorenz-ransomware-analysis-and-a-free-decryptor/)**\n\nBy Gijs Rijnders June 25, 2021\n\n[BleepingComputer recently wrote about a new ransomware family called Lorenz, that targets](https://www.bleepingcomputer.com/news/security/meet-lorenz-a-new-ransomware-gang-targeting-the-enterprise/)\norganizations worldwide. Like other well-known ransomware families, Lorenz also breaches\ntheir networks and performs double-extortion by stealing data before encrypting it. The victim\nis then threatened with their data being published if they decide not to pay the ransom.\nRansom demands have been quite high, between $500.000 and $700.000.\n\nBased on our analysis of the ransomware, we have been able to develop a process that can\nin some cases decrypt files affected by Lorenz without paying the ransom. In this blog post,\nwe will discuss some details about the ransomware. Furthermore, we will announce a free\n[decryptor for Lorenz. This decryptor will be available through the NoMoreRansom initiative](https://www.nomoreransom.org/)\nsoon to help victims free of charge.\n\n## Overview\n\n\n-----\n\nA first glance at the ransomware reveals that it is likely written in C++ using Microsoft Visual\nStudio 2015. An interesting observation in the two samples we analyzed is that they are both\ncompiled with debug information, even though they seem to be compiled in Release mode.\nDebug information can be useful as it tends to make the analysis slightly easier.\n\nLike ransomware commonly does, Lorenz also creates a mutex at startup. The mutex is\ncalled ‘wolf’ and is used to prevent the ransomware from starting twice in parallel. Another\ninteresting observation is that Lorenz sends the computer name of the infected system to a\ncommand & control server before starting encryption. In the samples we analyzed, the\nconnections targeted the command & control server by IP-address on TCP port 55.\n\n## File Encryption\n\nThe Lorenz ransomware uses a combination of RSA and AES-128 in CBC mode to encrypt\nfiles on an infected system. A password is generated at random for each file, and an\n[encryption key is then derived using the CryptDeriveKey function.](https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptderivekey)\n\nFiles encrypted by ransomware commonly contain footers, as footers can be easily appended\nto a file. Lorenz places a header before the encrypted file instead. This makes the\nransomware less efficient as it must copy the contents of every file. The header contains the\nmagic value: ‘.sz40’, followed by the RSA-encrypted file encryption key. After writing the\nencrypted file header, every file is encrypted whole in rather small blocks of 48 bytes.\nEncrypted files get the file extension: ‘.Lorenz.sz40’.\n\nAccording to [BleepingComputer, the Lorenz ransomware appears to be a variant of the](https://www.bleepingcomputer.com/news/security/meet-lorenz-a-new-ransomware-gang-targeting-the-enterprise/)\nThunderCrypt ransomware. We have not analyzed any ThunderCrypt samples and therefore,\nwe do not know whether the file encryption is similar or not.\n\n## Encryption bug\n\nLorenz encrypts every file whole in blocks of 48 bytes. It first reads the next 48 bytes (or\nwhatever is available) from the original file. The freshly obtained data block is then encrypted\nand written to the encrypted file. This encryption algorithm is displayed in the screenshot\nbelow.\n\n\n-----\n\nIf we look closer, the problem lies within the usage of the CryptEncrypt function. Relevant\nparameters are the 5, 6 and 7 . They respectively represent the buffer containing theth th th\nfreshly read data, length of this available data and the total size of ‘read_buffer’.\n\nAs we can see, CryptEncrypt is told that ‘read_buffer’ is 48 bytes in size. Therefore, it is not\nallowed to write more than 48 bytes when encrypting this block. If we take a closer look at the\n[documentation of the CryptEncrypt function, we read the following:](https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptencrypt)\n\n“If a large amount of data is to be encrypted, it can be done in sections by\ncalling CryptEncrypt repeatedly. The Final parameter must be set to TRUE on the last call\nto CryptEncrypt, so that the encryption engine can properly finish the encryption process. The\nfollowing extra actions are performed when Final is TRUE:\n\nIf the key is a block cipher key, the data is padded to a multiple of the block size of the cipher.\nIf the data length equals the block size of the cipher, one additional block of padding is\nappended to the data.”\n\nRecall that Lorenz uses the AES-128 algorithm, which is a block cipher having a block size of\n16 bytes. If the size of ‘read_buffer’ is smaller than 48 bytes, the data inside it would be\npadded to at most 48 bytes. However, if the available data is exactly 48 bytes in size,\nCryptEncrypt would append an additional block of padding. The ‘read_buffer’ would then be\nrequired to be at least 64 bytes in size. As a result, CryptEncrypt fails, breaking out of the\nencryption loop. The last block of the file is hence never written, meaning it is lost. Of course,\nthe last block of padding is only appended when ‘final’ (the 3 parameter for CryptEncrypt) isrd\nset to TRUE. If this was not the case, all other blocks would fail as well.\n\nThe result of this bug is that for every file which’s size is a multiple of 48 bytes, the last 48\nbytes are lost. Even if you managed to obtain a decryptor from the malware authors, these\nbytes cannot be recovered.\n\n## A free decryptor\n\n\n-----\n\nBased on our analysis of the Lorenz ransomware we have come to the conclusion that we\ncan decrypt (non-corrupted) affected files in some cases without paying the ransom.\nSupported file types include Microsoft Office documents, PDF files and some image and\nmovie types. We built a decryptor that we are providing to victims free of charge. The\n[decryptor is available for download via the NoMoreRansom initiative.](https://www.nomoreransom.org/)\n\n## Indicators of compromise (IoCs)\n\n**Indicator** **Description**\n\n71cdbbc62e10983db183ca60ab964c1a3dab0d279c5326b2e920522480780956 Lorenz\nransomware\n\n4b1170f7774acfdc5517fbe1c911f2bd9f1af498f3c3d25078f05c95701cc999 Lorenz\nransomware\n\n157[.]90[.]147[.]28 C2\n\n172[.]86[.]75[.]63 C2\n\nFor more information on the Lorenz samples:\n\nhttps://otx.alienvault.com/indicator/file/71cdbbc62e10983db183ca60ab964c1a3dab0d279c53\n26b2e920522480780956\n\nhttps://otx.alienvault.com/indicator/file/4b1170f7774acfdc5517fbe1c911f2bd9f1af498f3c3d250\n78f05c95701cc999\n\n[© 2022 Tesorion Cybersecurity Solutions. All Rights Reserved. | RSS NL |](https://www.tesorion.nl/nl/feed/) [RSS EN](https://www.tesorion.nl/en/feed/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-25 - Lorenz ransomware- analysis and a free decryptor.pdf"
    ],
    "report_names": [
        "2021-06-25 - Lorenz ransomware- analysis and a free decryptor.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536099,
    "ts_updated_at": 1743041118,
    "ts_creation_date": 1653762153,
    "ts_modification_date": 1653762153,
    "files": {
        "pdf": "https://archive.orkl.eu/8530988e413262bfac72f23f49488dbcb0de6875.pdf",
        "text": "https://archive.orkl.eu/8530988e413262bfac72f23f49488dbcb0de6875.txt",
        "img": "https://archive.orkl.eu/8530988e413262bfac72f23f49488dbcb0de6875.jpg"
    }
}