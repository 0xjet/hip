{
    "id": "a847b1c4-8bf7-45f7-8502-5d42ae922d18",
    "created_at": "2023-01-12T15:08:55.5533Z",
    "updated_at": "2025-03-27T02:05:19.665883Z",
    "deleted_at": null,
    "sha1_hash": "ab32cfc9d76a4f1b60a122063fc0ee1df085f9b3",
    "title": "2021-12-09 - Emotet’s Return- What’s Different-",
    "authors": "",
    "file_creation_date": "2022-05-28T19:09:19Z",
    "file_modification_date": "2022-05-28T19:09:19Z",
    "file_size": 2495116,
    "plain_text": "# Recent Posts\n\n**[threatresearch.ext.hp.com/emotets-return-whats-different/](https://threatresearch.ext.hp.com/emotets-return-whats-different/)**\n\n[HP Threat Research Blog • Emotet’s Return: What’s Different?](https://threatresearch.ext.hp.com/blog/)\n\n## Emotet’s Return: What’s Different?\n\n\nDecember 9, 2021\n\n\n[On 15 November 2021, Emotet returned after an almost 10-month hiatus and is currently](https://malpedia.caad.fkie.fraunhofer.de/details/win.emotet)\nbeing spread again in large malicious spam campaigns. The malware operation behind\n[Emotet was disrupted in January 2021 by law enforcement, leading to a dramatic reduction](https://www.europol.europa.eu/media-press/newsroom/news/world%e2%80%99s-most-dangerous-malware-emotet-disrupted-through-global-action)\nin activity. However, this lull has proven temporary, with Emotet’s return demonstrating the\nresilience of botnets and their operators. The malware’s resurgence raises questions about\nwhat has changed in the new binaries being distributed, which we briefly explore in this\narticle.\n\n## Campaign Isolated by HP Wolf Security, November 2021\n\n[In November, HP Sure Click Enterprise – part of HP Wolf Security – isolated a large Emotet](https://www.hp.com/uk-en/security/endpoint-security-solutions.html)\ncampaign against an organization. Figure 1 shows how a user opened an Excel email\nattachment containing a malicious macro. The macro spawned cmd.exe, which attempted to\ndownload and run an Emotet payload from a web server. Since malware delivered over email\nis extremely common, HP Sure Click automatically treats files delivered via email as\nuntrusted. When the user opened the attachment, HP Sure Click isolated file in a microvirtual machine (micro-VM), thereby preventing the host from being infected. HP Sure Click\n\n\n-----\n\nalso detected potentially malicious behavior in the micro-VM, so generated and sent an alert\nto the customer’s security team containing an activity trace describing what happened inside\nthe VM (Figure 2).\n\nFigure 1 – Alert timeline showing user opening a malicious Emotet spreadsheet.\n\n\n-----\n\nFigure 2 – Snippet from behavioral trace captured by HP Sure Click.\n\n## Finding code similarities\n\nUsing two unpacked Emotet samples, one from January 2021 and a second from midNovember 2021, we wanted to highlight the code differences to focus analysis on any new\ncode. For this we used [Threatray, which analyzes the structure of malware and classifies it](https://threatray.com/)\nbased on code similarities. The service can also find function differences between two\nmalware samples and highlight them.\n\n**Date** **SHA256 Hash**\n\n\n2021-0126\n\n2021-1116\n\n\n[61a47ebee921db8a16a8f070edcb86b5efd47a8d185bf4691b57e76f697981f9](https://bazaar.abuse.ch/sample/61a47ebee921db8a16a8f070edcb86b5efd47a8d185bf4691b57e76f697981f9/)\n\n[ba758c64519be23b5abe7991b71cdcece30525f14e225f2fa07bbffdf406e539](https://bazaar.abuse.ch/sample/ba758c64519be23b5abe7991b71cdcece30525f14e225f2fa07bbffdf406e539/)\n\n\nUsing Threatray’s API to retreive code similarities returns a table of function addresses from\nboth samples. If there are function addresses in the columns of both samples, this means a\nsimilar function was found. Analyzing our two Emotet samples identified 80 of 246 functions\n\n\n-----\n\nthat were similar. This means that the remaining functions could be code changes or\nobfuscation.\n\nFigure 3 – Threatray output table showing similar functions.\n\nTo streamline our analysis even further, we wrote an IDC script based on Threatray’s results,\nwhich colors known functions green. This way, we can concentrate on the unknown areas\nwhen reversing the malware.\n\nFigure 4 – IDA Pro disassembly of the November 2021 Emotet sample with known functions\nin green.\n\n## Windows API function resolution technique\n\nOne of the ways Emotet hides its capabilities is by resolving Windows API functions at\nruntime. This means function names are hidden from the Import Address Table or as strings.\nTo find the desired API function, Emotet instead uses hashes. A hash is passed to a\n\n\n-----\n\nresolution routine, where it is compared to the hashes of all the exported functions of a DLL.\nIf the two hashes match, the correct function and address in the DLL is found, enabling it to\nbe called without referencing its name.\n\n\n-----\n\nFigure 5 – Emotet’s Windows API wrapper function.\n\n\n-----\n\nSince these wrapper functions are not classified as similar, we wrote a [Python script that](https://github.com/hpthreatresearch/tools/blob/main/emotet/resolve_function.py)\nresolves the Windows API functions. For the Emotet sample from 16 November, we were\nable to resolve and annotate 109 different functions. We also resolved the functions of the\nsample from January 2021 to compare the differences in API functions between the\nsamples. The following table lists the API functions that are unique to each:\n\n**January 2021** **November 2021**\n\nCryptAcquireContextW BCryptCloseAlgorithmProvider\n\nCryptCreateHash BcryptCreateHash\n\nCryptDecrypt BcryptDecrypt\n\nCryptDuplicateHash BcryptDeriveKey\n\nCryptDestroyHash BcryptDestroyHash\n\nCryptDestroyKey BcryptDestroyKey\n\nCryptGenKey BcryptDestroySecret\n\nCryptEncrypt BcryptEncrypt\n\nCryptExportKey BcryptExportKey\n\nCryptGetHashParam BcryptFinalizeKeyPair\n\nCryptImportKey BcryptFinishHash\n\nCryptReleaseContext BcryptGenRandom\n\nCryptVerifySignatureW BcryptGenerateKeyPair\n\nCryptDecodeObjectEx BcryptGetProperty\n\nHeapAlloc BcryptHashData\n\nMultiByteToWideChar BcryptImportKey\n\nWideCharToMultiByte BcryptImportKeyPair\n\nRtlRandomEx BcryptOpenAlgorithmProvider\n\nBcryptSecretAgreement\n\nBcryptVerifySignature\n\nRtlAllocateHeap\n\nInternetQueryOptionW\n\n\n-----\n\n## Differences in the Emotet Samples\n\nOne difference in the API functions is that the newer Emotet sample now uses Bcrypt\ncryptography functions. The Emotet sample from January 2021 used cryptography functions\nfrom advapi32.dll. An explanation for this change is that Emotet’s developers switched to the\nnewer cryptography API because Microsoft deprecated the old API and now recommend\nswitching to the newer one.\n\n[Figure 6 – CryptDecrypt API documentation from Microsoft.](https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptdecrypt)\n\nIn addition to the changes in cryptography, Emotet now uses the function [RtlAllocateHeap to](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtlallocateheap)\n[allocate heap memory. Normally a program calls HeapAlloc which then calls](https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapalloc)\nRtlAllocateHeap. Each Emotet binary contains encrypted configuration information that is\ndecrypted at runtime and stored on the heap. Previously if we debugged the malware, you\ncould set a breakpoint on HeapAlloc and view unencrypted information like the malware’s\ncommand and control (C2) addresses. But this does not work with the newer Emotet sample\nbecause the malware calls RtlAllocateHeap instead. By simply changing the breakpoint to\nRtlAllocateHeap, we can achieve the desired result. However, this small change could mean\nthat automated analysis systems are no longer able to extract unencrypted information from\nthe malware and therefore they require updating.\n\nIf we add the green-colored wrapper functions to the functions identified by Threatray results,\nthis gives us 167 of 246 functions. Some of the remaining functions are very small auxiliary\nfunctions that are uninteresting, and others are functions that can already be found in the\nolder Emotet sample by comparing them manually. But why were these functions not initially\nmarked as similar? There are two possible reasons for this. First, Emotet uses switch case\nstatements to obfuscate the control flow, which calls the functions in the correct order, but\nthese aren’t easy to resolve using static analysis.\n\n\n-----\n\nFigure 7 – Control flow graph showing switch case obfuscation.\n\nSecond, we noticed that the second Emotet sample contains more function flattening than\nthe older sample. This means that more functions are called in one place and not nested in\nsub-functions. This leads to a change in the control flow, which reduces the similarity to the\nolder Emotet sample. Figure 8 shows the January 2021 sample calling a sub-function that\nallocates memory on the heap, creates a string, then releases the memory.\n\n\n-----\n\nFigure 8 – Sample from January 2021 calling a sub-function leading to further execution and\nAPI calls.\n\nIn the more recent sample, the sub-function has been resolved and the function calls to\nallocate memory and compose the string have been moved into the main function (Figure 9).\n\nFigure 9 – Sample from November 2021 using direct function calls instead of sub-functions.\n\n## Conclusion\n\nOur analysis shows that Emotet has changed during its almost 10-month break. As well as\nthe use of an updated cryptography library, there have been small changes in memory\nallocation and in the functional structure of parts of Emotet’s code. However, large parts of\nthe malware remain the same, indicating that its existing features are still good enough to\ncompromise systems. This is not a final analysis since our goal was to show how to quickly\nand efficiently highlight changes between two samples. To support the security community\n[with further analysis of Emotet, we have shared the IDA database and Python script used in](https://github.com/hpthreatresearch/tools/tree/main/emotet)\nthis article.\n\nTags\n\n\n-----\n\n[code analysis](https://threatresearch.ext.hp.com/blog/?post-tag=code%20analysis) [emotet](https://threatresearch.ext.hp.com/blog/?post-tag=emotet)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-09 - Emotet’s Return- What’s Different-.pdf"
    ],
    "report_names": [
        "2021-12-09 - Emotet’s Return- What’s Different-.pdf"
    ],
    "threat_actors": [
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536135,
    "ts_updated_at": 1743041119,
    "ts_creation_date": 1653764959,
    "ts_modification_date": 1653764959,
    "files": {
        "pdf": "https://archive.orkl.eu/ab32cfc9d76a4f1b60a122063fc0ee1df085f9b3.pdf",
        "text": "https://archive.orkl.eu/ab32cfc9d76a4f1b60a122063fc0ee1df085f9b3.txt",
        "img": "https://archive.orkl.eu/ab32cfc9d76a4f1b60a122063fc0ee1df085f9b3.jpg"
    }
}