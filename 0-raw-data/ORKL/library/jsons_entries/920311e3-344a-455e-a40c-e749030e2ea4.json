{
    "id": "920311e3-344a-455e-a40c-e749030e2ea4",
    "created_at": "2023-01-12T15:08:42.478235Z",
    "updated_at": "2025-03-27T02:16:20.748899Z",
    "deleted_at": null,
    "sha1_hash": "d0f28da3a6098e9e082b0946d7a20ce9df94d6cc",
    "title": "2020-05-14 - COMpfun authors spoof visa application with HTTP status-based Trojan",
    "authors": "",
    "file_creation_date": "2022-05-28T02:04:38Z",
    "file_modification_date": "2022-05-28T02:04:38Z",
    "file_size": 675401,
    "plain_text": "# COMpfun authors spoof visa application with HTTP status-based Trojan\n\n**securelist.com/compfun-http-status-based-trojan/96874/**\n\nAuthors\n\nGReAT\n\n[You may remember that in autumn 2019 we published a story about how a COMpfun](https://securelist.com/compfun-successor-reductor/93633/)\nsuccessor known as Reductor infected files on the fly to compromise TLS traffic. If you’re\nwondering whether the actor behind the malware is still developing new features, the answer\nis yes. Later in November 2019 our Attribution Engine revealed a new Trojan with strong\ncode similarities. Further research showed that it was obviously using the same code base\nas COMPFun.\n\n## What’s of interest inside\n\nThe campaign operators retained their focus on diplomatic entities, this time in Europe, and\nspread the initial dropper as a spoofed visa application. It is not clear to us exactly how the\nmalicious code is being delivered to a target. The legitimate application was kept encrypted\ninside the dropper, along with the 32- and 64-bit next stage malware.\n\n\n-----\n\n**_Overall infection chain. Interestingly, C2 commands are rare HTTP status codes_**\n\nWe observed an interesting C2 communication protocol utilizing rare HTTP/HTTPS status\ncodes (check IETF RFC 7231, 6585, 4918). Several HTTP status codes (422-429) from the\nClient Error class let the Trojan know what the operators want to do. After the control server\nsends the status “Payment Required” (402), all these previously received commands are\nexecuted.\n\nThe authors keep the RSA public key and unique HTTP ETag in encrypted configuration\ndata. Created for web content caching reasons, this marker could also be used to filter\nunwanted requests to the C2, e.g., those that are from network scanners rather than targets.\nBesides the aforementioned RSA public key to communicate with the C2, the malware also\nuses a self-generated AES-128 key.\n\n## Who is the author?\n\nWe should mention here once again that the COMPfun malware was initially documented by\nG-DATA in 2014; and although the company did not identify which APT was using the\n[malware. Based mostly on victimology, we were able to associate it with the Turla APT with](https://securelist.com/all/?tag=718)\nmedium-to-low level of confidence.\n\n## What the Trojan is able to do\n\n\n-----\n\nIts functions include the ability to acquire the target s geolocation, gathering host- and\nnetwork-related data, keylogging and screenshots. In other words, it’s a normal full-fledged\nTrojan that is also capable of propagating itself to removable devices.\n\nAs in previous malware from the same authors, all the necessary function addresses resolve\ndynamically to complicate analysis. To exfiltrate the target’s data to the C2 over\nHTTP/HTTPS, the malware uses RSA encryption. To hide data locally, the Trojan\nimplements LZNT1 compression and one-byte XOR encryption.\n\n**Encrypted data** **Algorithm** **Key source**\n\nExfiltrated keystrokes, screenshots, etc. RSA Public key from\nconfiguration data\n\n\nConfiguration data in .rsrc section XOR (plus LZNT1\ncompression)\n\n\nParameters inside the HTTP GET/POST\nrequests\n\nCommands and arguments from C2 for\nHTTP status 427 (dir, upl, usb, net)\n\n\nAES-128 (plus\nETag from config)\n\n\nAES-128 Generated by Trojan\nand shared in beacon\n\n\nHardcoded one-byte\nkey\n\nGenerated by Trojan\nand shared in beacon\n\n\n_Encryption and compression used by the Trojan for various tasks_\n\n### Initial dropper\n\nThe first stage dropper was downloaded from the LAN shared directory. The file name\nrelated to the visa application process perfectly corresponds with the targeted diplomatic\nentities. As with all modules with a similar code base, the dropper begins by dynamically\nresolving all the required Windows API function addresses and puts them into structures. It\nthen decrypts the next stage malware from its resource (.rsrc) section. The algorithm used to\ndecrypt the next stage is a one-byte XOR using the key “0x55”, followed by LZNT1\ndecompression.\n\nThe following files are dropped to the disk in addition to the original application that the\nmalware tries to mimic:\n\n**MD5 hash** **File name** **Features**\n\n1BB03CBAD293CA9EE3DDCE6F054FC325 ieframe.dll.mui 64-bit Trojan\nversion\n\nA6AFA05CBD04E9AF256D278E5B5AD050 ExplorerFrame.dll.mui 32-bit Trojan\nversion\n\n\n-----\n\nThe dropper urges users to run the file as administrator (using messages such as need to\nrun as admin”), then drops a version corresponding to the host’s architecture and sets the file\nsystem timestamp to 2013.12.20 22:31.\n\nInterestingly, the dropper’s abilities aren’t limited to PE lures; as an alternative, this stage is\nalso able to use .doc and .pdf files. In such cases, the dropper will open the files using the\n“open” shell command instead of running the legitimate spoofed executable application.\n\n### Main module – HTTP status-based Trojan\n\n**SHA256** 710b0fafe5fd7b3d817cf5c22002e46e2a22470cf3894eb619f805d43759b5a3\n\n**MD5** a6afa05cbd04e9af256d278e5b5ad050\n\n**Compiled** 2015.06.26 09:42:27 (GMT)\n\n**Type** I386 Windows GUI DLL\n\n**Size** 593408\n\n\n**Internal**\n**name**\n\n\nExplorerFrame.dll.mui\n\n\nThe analysis below is based on the 32-bit sample from the table above. The legitimate\nExplorerFrame.dll.mui is a language resource for the ExplorerFrame.dll file used by Windows\nExplorer.\n\n\n-----\n\n**_Multi-threaded Trojan features such as monitoring USB devices to spread further and_**\n**_receiving commands as HTTP status codes_**\n\n### Initialization\n\nAs usual in this malware family’s code, a huge number of short standalone functions return\nall the readable strings. This is done to complicate analysis by not allowing the strings to be\nvisible at a glance for researchers. The module’s preparation stage dynamically resolves all\nrequired Windows API function addresses into corresponding custom structures. Afterwards\nthe malware uses indirect function calls only.\n\nThe module obtains the processor architecture (32- or 64-bit) and Windows OS version. It\nincludes a number of anti-analysis checks for virtual machine-related devices\n(VEN_VMWARE, VBOX_HARDDISK, Virtual_DVD_ROM, etc.) to avoid controlled execution.\nIt also notes which security products are running on the host (Symantec, Kaspersky, Dr.Web,\nAvast).\n\nBefore every communication with the C2, the malware checks if software such as debuggers\n(WinDbg, OllyDbg, Visual Studio) and host (Process Explorer or Monitor, etc.) or network\nmonitoring (Wireshark, TCPView, etc.) programs are running. It also checks for internet\nconnectivity and does not attempt to communicate if the checks fail.\n\n\n-----\n\nThe DLL also checks for potentially available launch processes that it can inject itself into. In\nthe case of PaymentRequired, this could be system, security product or browser processes.\nThen the malware forms the corresponding code to drop files, delete files, etc.\n\nThe last step in the initialization procedure is to decrypt and decompress the configuration\nfile. Decryption is done via a one-byte XOR using the 0xAA key, followed by decompression\nusing the LZNT1 algorithm. From the configuration, the malware parses the RSA public key,\nETag and IP addresses to communicate with its control servers.\n\n**_Decrypted configuration data contains an RSA public key to encrypt exfiltrated data,_**\n**_C2 IPs and unique ETag to communicate with them_**\n\n### HTTP status-based communication module\n\nFirstly, the module generates the following:\n\nAES-128 encryption key used in HTTP GET/POST parameters and HTTP status code\n427 (request new command);\n4-byte unique hardware ID (HWID) based on the host network adapters, CPU and first\nfixed logical drive serial number.\n\nThe module then chooses a process to inject the code into, in order of decreasing priority,\nstarting from Windows (cmd.exe, smss.exe), security-related applications (Symantec’s\nnis.exe, Dr.Web’s spideragent.exe) and browsers (IE, Opera, Firefox, Yandex browser,\nChrome).\n\n\n-----\n\nThe main thread checks if the C2 supports TLS in its configuration. If it does, communication\nwill be over HTTPS and port 443; otherwise, the HTTP protocol and port 80 are used.\n\n**Config Parameter** **Value**\n\nEncryption key RSA public key on the image above\n\nETag C8E9CEAD2E084F58A94AEDC14D423E1A\n\nC2 IPs 95.183.49[.]10\n95.183.49[.]29\n200.63.45[.]35\n\n_Decrypted configuration content inside the analyzed sample_\n\nThe first GET request sent contains an ETag “If-Match” header that is built using data from its\ndecrypted configuration. ETags are normally used by web servers for caching purposes in\norder to be more efficient and save bandwidth by not resending redundant information if an\nETag value matches. The implementation of ETags means the C2 may ignore all requests\nthat are not sent from its intended targets if they don’t have the required ETag value.\n\n\n**HTTP**\n**status**\n\n\n**RFC status**\n**meaning**\n\n\n**Corresponding command functionality**\n\n\n200 OK Send collected target data to C2 with current tickcount\n\n402 Payment Required This status is the signal to process received (and stored in\nbinary flag) HTTP statuses as commands\n\n\n422 Unprocessable\nEntity (WebDAV)\n\n\nUninstall. Delete COM-hijacking persistence and\ncorresponding files on disk\n\n\n423 Locked (WebDAV) Install. Create COM-hijacking persistence and drop\ncorresponding files to disk\n\n\n424 Failed\nDependency\n(WebDAV)\n\n427 Undefined HTTP\nstatus\n\n428 Precondition\nRequired\n\n429 Too Many\nRequests\n\n\nFingerprint target. Send host, network and geolocation data\n\nGet new command into IEA94E3.tmp file in %TEMP%,\ndecrypt and execute appended command\n\nPropagate self to USB devices on target\n\nEnumerate network resources on target\n\n\n-----\n\n_C2 HTTP status code descriptions, including installation, USB propagation, fingerprinting,_\n_etc._\n\nHTTP 427 can receive any of the following appended commands:\n\n**Command** **Command functionality**\n\ndir Send directory content to C2 encrypted with RSA public key from config\n\nupl Send file to C2 encrypted with RSA public key from config\n\nusb Not implemented yet. Possibly same function planned as for HTTP status\n428\n\nnet Not implemented yet. Possibly same function planned as for HTTP status\n429\n\n### Removable device propagation module\n\nIf initialization is successful, the malware starts one more thread for dispatching Windows\nmessages, looking for removable devices related to a WM_DEVICECHANGE event. The\nmodule runs its own handlers in the event of a USB device being plugged into or unplugged\nfrom the host.\n\n### Other spying modules: keylogger, screenshot tool and more\n\nThe user’s activity is monitored using several hooks. All of them gather the target’s data\nindependently of any C2 command. Keystrokes are encrypted using the RSA public key\nstored in the configuration data and sent once every two seconds, or when moreа than 512\nbytes are recorded. These 512 characters also include left mouse button clicks (written as\nthe “MSLBTN” string) and Windows title bar texts. For clipboard content, the module\ncalculates an MD5 hash and if it changes, encrypts the clipboard content with the same RSA\npublic key and then sends it.\n\nIn a separate thread, the Trojan takes a bitmap screenshot using the GDIPlus library,\ncompresses it with the LZNT1 algorithm, encrypts it using the key from the configuration data\nand sends it to the control server. A screenshot will be taken of the target and sent anyway,\nindependently of any C2 command.\n\n### Last but not least\n\nThere are several choices – albeit not major additional technical ones – that the malware\nauthor made which we consider to be noteworthy.\n\n\n-----\n\nThe COM-hijacking-based persistence method injects its corresponding code and structure\nas a parameter into a legitimate process’s memory. The malware geolocates victims using\nlegitimate web services: geoplugin.net/json.gp, ip-api.com/json and telize.com/geoip.\n\nThe unusual thread synchronization timeout calculation in the HTTP status thread is peculiar.\nMathematically, the partial sum of the series is precisely:\n\nThis series, in the case of a full sum, is just a representation of the exponent. The developers\nprobably used the exponent to make timeouts in the communication thread more\nunpredictable and grow at a fast rate, and the compiler calculated it this way.\n\n## So what did the COMPFun authors achieve?\n\nWe saw innovative approaches from the COMpfun developers twice in 2019. First, they\nbypassed TLS encrypted traffic via [PRNG system function patching, and then we observed a](https://securelist.com/compfun-successor-reductor/93633/)\nunique implementation of C2 communications using uncommon HTTP status codes.\n\nThe malware operators retained their focus on diplomatic entities and the choice of a visarelated application – stored on a directory shared within the local network – as the initial\ninfection vector worked in their favor. The combination of a tailored approach to their targets\nand the ability to generate and execute their ideas certainly makes the developers behind\nCOMPFun a strong offensive team.\n\n## Indicators of compromise\n\n**File MD5 Hashes**\n[Trojan 32-bit: A6AFA05CBD04E9AF256D278E5B5AD050](https://opentip.kaspersky.com/A6AFA05CBD04E9AF256D278E5B5AD050/)\n[Trojan 64-bit: 1BB03CBAD293CA9EE3DDCE6F054FC325](https://opentip.kaspersky.com/1BB03CBAD293CA9EE3DDCE6F054FC325/)\n\n**IPs**\n[95.183.49.10](https://opentip.kaspersky.com/95.183.49.10/)\n[95.183.49.29](https://opentip.kaspersky.com/95.183.49.29/)\n[200.63.45.35](https://opentip.kaspersky.com/200.63.45.35/)\n\n[APT](https://securelist.com/tag/apt/)\n[Keyloggers](https://securelist.com/tag/keyloggers/)\n[Trojan-Dropper](https://securelist.com/tag/trojan-dropper/)\n[Trojan-Spy](https://securelist.com/tag/trojan-spy/)\n\n\n-----\n\n[Turla](https://securelist.com/tag/turla/)\n\nAuthors\n\nGReAT\n\nCOMpfun authors spoof visa application with HTTP status-based Trojan\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-14 - COMpfun authors spoof visa application with HTTP status-based Trojan.pdf"
    ],
    "report_names": [
        "2020-05-14 - COMpfun authors spoof visa application with HTTP status-based Trojan.pdf"
    ],
    "threat_actors": [
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536122,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1653703478,
    "ts_modification_date": 1653703478,
    "files": {
        "pdf": "https://archive.orkl.eu/d0f28da3a6098e9e082b0946d7a20ce9df94d6cc.pdf",
        "text": "https://archive.orkl.eu/d0f28da3a6098e9e082b0946d7a20ce9df94d6cc.txt",
        "img": "https://archive.orkl.eu/d0f28da3a6098e9e082b0946d7a20ce9df94d6cc.jpg"
    }
}