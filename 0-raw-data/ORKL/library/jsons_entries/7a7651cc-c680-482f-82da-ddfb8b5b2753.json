{
    "id": "7a7651cc-c680-482f-82da-ddfb8b5b2753",
    "created_at": "2023-06-05T02:07:42.943999Z",
    "updated_at": "2025-03-27T02:09:18.704907Z",
    "deleted_at": null,
    "sha1_hash": "25974f6aea9bd62425070d8f6f5f01dd7c5d9dbe",
    "title": "2023-05-04 - Unpacking ICEDID",
    "authors": "",
    "file_creation_date": "2023-06-04T12:27:15Z",
    "file_modification_date": "2023-06-04T12:27:15Z",
    "file_size": 553282,
    "plain_text": "# Unpacking ICEDID | Elastic\n\n**elastic.co/security-labs/unpacking-icedid**\n\n## Unpacking ICEDID\n\n_A comprehensive tutorial with Elastic Security Labs open source tools_\n\nBy\n\nCyril François\n\n04 May 2023\nEnglish\n\n## Preamble\n\n[ICEDID is a malware family discovered in 2017 by IBM X-force researchers and is](https://securityintelligence.com/new-banking-trojan-icedid-discovered-by-ibm-x-force-research/)\nassociated with the theft of login credentials, banking information, and other personal\ninformation. ICEDID has always been a prevalent family but achieved even more growth\n[since EMOTET’s temporary disruption in early 2021. ICEDID has been linked to the](https://www.justice.gov/opa/pr/emotet-botnet-disrupted-international-cyber-operation)\n[distribution of several distinct malware families including DarkVNC and](https://malpedia.caad.fkie.fraunhofer.de/details/win.darkvnc) [COBALT STRIKE.](https://www.cybereason.com/blog/threat-analysis-report-all-paths-lead-to-cobalt-strike-icedid-emotet-and-qbot)\nRegular industry reporting, including research publications like this one, help mitigate this\nthreat.\n\n\n-----\n\nICEDID is known to pack its payloads using custom file formats and a custom encryption\n[scheme. Following our latest ICEDID research that covers the GZip variant execution chain.](https://www.elastic.co/security-labs/thawing-the-permafrost-of-icedid-summary)\n\nIn this tutorial, we will introduce these tools by unpacking a recent ICEDID sample starting\nwith downloading a copy of the fake GZip binary:\n\n**Analyzing malware can be dangerous to systems and should only be attempted by**\n**experienced professionals in a controlled environment, like an isolated virtual**\n**machine or analysis sandbox. Malware can be designed to evade detection and infect**\n**other systems, so it's important to take all necessary precautions and use specialized**\n**tools to protect yourself and your systems.**\n\n**[54d064799115f302a66220b3d0920c1158608a5ba76277666c4ac532b53e855f](https://bazaar.abuse.ch/sample/54d064799115f302a66220b3d0920c1158608a5ba76277666c4ac532b53e855f/)**\n\n## Environment setup\n\nFor this tutorial, we’re using Windows 10 and Python 3.10.\n\nElastic Security Labs is releasing a set of tools to automate the unpacking process and help\nanalysts and the community respond to ICEDID.\n\n**Script** **Description** **Compatibility**\n\n\ndecrypt_file.py Decrypt ICEDID encrypted\nfile\n\ngzip_variant/extract_gzip.py Extract payloads from\nICEDID fake GZip file\n\ngzip_variant/extract_payload_from_core.py Extract and decrypt\npayloads from the rebuilt\nICEDID core binary\n\ngzip_variant/load_core.py Load and execute core\ncustom PE binary\n\ngzip_variant/read_configuration.py Read ICEDID configuration\nfile contained in the fake\nGZip\n\nrebuild_pe.py Rebuild a PE from ICEDID\ncustom PE file\n\n\nWindows and\nothers (not\ntested)\n\nWindows and\nothers (not\ntested)\n\nWindows and\nothers (not\ntested)\n\nWindows only\n\nWindows and\nothers (not\ntested)\n\nWindows and\nothers (not\ntested)\n\n\n-----\n\n[In order to use the tools, clone the Elastic Security Lab release repository and install the](https://github.com/elastic/labs-releases)\nnightMARE module.\n```\ngit clone https://github.com/elastic/labs-releases\n\ncd labs-release\n\npip install .\\nightMARE\\\n\n```\nThe nightMARE module\n\nAll tools in this tutorial use the nightMARE module, this library implements different\nalgorithms we need for unpacking the various payloads embedded within ICEDID. We’re\nreleasing nightMARE because it is required for this ICEDID analysis, but stay tuned - more to\ncome as we continue to develop and mature this framework.\n\n## Unpacking the fake GZip\n\nThe ICEDID fake GZip is a file that [masquerades as a valid GZip file formatted by](https://attack.mitre.org/techniques/T1036/008/)\n[encapsulating the real data with a GZip header and footer.](https://docs.fileformat.com/compression/gz/)\n\nGZip\n\nheader and footer\nGZip magic bytes appear in red.\n\nThe GZip header is rendered in green.\n\nThe dummy filename value is blue.\n\nAfter the GZip header is the true data structure, which we describe below.\n\nFakeGzip data structure\n\nWe will use the labs-releases\\tools\\icedid\\gzip-variant\\extract_gzip.py script to unpack\nthis fraudulent GZip.\n\n\n-----\n\n```\nusage: extract_gzip.py [ help] input output\n\npositional arguments:\n\n input    Input file\n\n output   Output directory\n\noptions:\n\n -h, --help show this help message and exit\n\n```\nWe'll use extract_gzip.py on the ICEDID sample linked above and store the contents into a\nfolder we created called “extract” (you can use any existing output folder).\n```\npython extract_gzip.py\n54d064799115f302a66220b3d0920c1158608a5ba76277666c4ac532b53e855f extract\n\n============================================================\n\nFake Gzip\n\n============================================================\n\nis_dll: True\n\ncore: UponBetter/license.dat (354282 bytes)\n\nstage_2: lake_x32.tmp (292352 bytes)\n\nextract\\configuration.bin\n\nextract\\license.dat\n\nextract\\lake_x32.tmpRead more\n\n```\nThis script returns three individual files consisting of:\n\nThe encrypted configuration file: configuration.bin\nThe encrypted core binary: license.dat\nThe persistence loader: lake_x32.tmp\n\nFiles extracted from the fake GZip\n\n## Decrypting the core binary and configuration files\n\nThe configuration and the core binary we extracted are encrypted using ICEDID’s custom\nencryption scheme. We can decrypt them with the labs**releases\\tools\\icedid\\decrypt_file.py script.**\n\n\n-----\n\n```\nusage: decompress_file.py [ help] input output\n\npositional arguments:\n\n input    Input file\n\n output   Output file\n\noptions:\n\n -h, --help show this help message and exit\n\n```\nAs depicted here (note that decrypted files can be written to any valid destination):\n```\npython .\\decrypt_file.py .\\extract\\license.dat .\\extract\\license.dat.decrypted\n\npython .\\decrypt_file.py .\\extract\\configuration.bin\n.\\extract\\configuration.bin.decrypted\n\n```\nThe core binary and the configuration are now ready to be processed by additional tools.\nSee the data from the decrypted configuration presented in the following screenshot:\n\nHex\n\nview of the decrypted configuration file\n\n## Reading the configuration\n\nThe configuration file format is presented below.\n\nConfiguration file\n\n\n-----\n\nThe configuration can be read using the labs-releases\\tools\\icedid\\gzip**variant\\read_configuration.py script.**\n```\nusage: read_configuration.py [--help] input\n\npositional arguments:\n\n input    Input file\n\noptions:\n\n -h, --help show this help message and exit\n\n```\nWe’ll use the read_configuration.py script to read the configuration.bin.decrypted file we\ncollected in the previous step.\n```\npython .\\gzip-variant\\read_configuration.py .\\extract\\configuration.bin.decrypted\n\n============================================================\n\nConfiguration\n\n============================================================\n\nbotnet_id: 0x3B7D6BA4\n\nauth_var: 0x00000038\n\nuri: /news/\n\ndomains:\n\n    alishaskainz.com\n\n    villageskaier.comRead more\n\n```\nThis configuration contains two C2 domains:\n\nalishaskainz[.]com\nvillageskaier[.]com\n\nFor this sample, the beaconing URI that ICEDID uses is “/news/”.\n\n## Rebuilding the core binary for static analysis\n\nICEDID uses a custom PE format to obfuscate its payloads thus defeating static or dynamic\nanalysis tools that expect to deal with a normal Windows executable. The custom PE file\nformat is described below.\n\n\n-----\n\nCustom PE file format\n\nIf we want to analyze the core binary, for example with [IDA Pro, we need to rebuild it into a](https://hex-rays.com/IDA-pro/)\nvalid PE. We use the labs-releases\\tools\\icedid\\rebuild_pe.py script.\n```\nusage: rebuild_pe.py [--help] [-o OFFSET] input output\n\npositional arguments:\n\n input         Input file\n\n output        Output reconstructed PE\n\noptions:\n\n -h, --help      show this help message and exit\n\n -o OFFSET, --offset OFFSET\n\n            Offset to real data, skip possible garbage\n\n```\nHowever, when attempting to use rebuild_pe.py on the decrypted core binary,\n**license.dat.decrypted, we receive the following error message:**\n```\npython .\\rebuild_pe.py .\\extract\\license.dat.decrypted .\\extract\\core.bin\n\nTraceback (most recent call last):\n\n File \"rebuild_pe.py\", line 32, in <module>\n\n  main()\n\n File \"rebuild_pe.py\", line 28, in main\n\n  custom_pe.CustomPE(data).to_pe().write(args.output)\n\n File \"nightmare\\malware\\icedid\\custom_pe.py\", line 86, in __init__\n\n  raise RuntimeError(\"Failed to parse custom pe\")\n\nRuntimeError: Failed to parse custom pe\n\n```\nThe subtlety here is that the custom PE data doesn’t always start at the beginning of the file.\n[In this case, for example, if we open the file in a hexadecimal editor like HxD we can observe](https://mh-nexus.de/en/hxd/)\na certain amount of garbage bytes before the actual data.\n\n\n-----\n\nPrepended garbage bytes\nWe know from our research that the size of the garbage is 129 bytes.\n\nIdentifying garbage size\n\nWith that in mind, we can skip over the garbage bytes and rebuild the core binary using the\n**rebuild_pe.py script using the “-o 129” parameter. This time we, fortunately, receive no**\nerror message. core.bin will be saved to the output directory, extract in our example.\n```\npython .\\rebuild_pe.py .\\extract\\license.dat.decrypted .\\extract\\core.bin -o 129\n\n```\nThe rebuilt PE object is not directly executable but you can statically analyze it using your\ndisassembler of choice.\n\nIDA view of core.bin\nWe assigned custom names to the rebuilt binary sections (.mare{0,1,2,...}).\n\n\n-----\n\nRebuilt binary\n\nsection names\n[We want to credit and thank Hasherezade’s work from which we took inspiration to build this](https://github.com/hasherezade/funky_malware_formats/blob/f1cacba4ee347601dceacda04e4de8c699971d29/iced_id_parser/iceid_to_pe.cpp#L10)\ntool.\n\n## Executing the core binary (Windows only)\n\nThe core binary can’t be executed without a custom loader that understands ICEDID’s\ncustom PE format as well as the entry point function prototype.\n\nFrom our research, we know that the entry point expects a structure we refer to as the\ncontext structure, which contains ICEDID core and persistence loader paths with its\nencrypted configuration. The context structure is described below.\n\nContext structure\n\nTo natively execute the core binary we use the labs-releases\\tools\\icedid\\gzip**variant\\load_core.py script, but before using it we need to create the context.json file that’ll**\ncontain all the information needed by this script to build this structure.\n\nFor this sample, we copy the information contained in the fake gzip and we use the path to\nthe encrypted configuration file. We’ve included an example at\n**gzip_variant/context.json.example.**\n\n\n-----\n\nExample configuration file\nPlease note that “field_0” and “stage_2_export” values have to be found while reversing\nthe sample.\n\nPopulating values from\n\nprevious research\nHere we use values from our previous research as placeholders but we have no guarantee\nthat the sample will work 100%. For example, in this sample, we don’t know if the #1 ordinal\nexport is the actual entry point of the persistence loader.\n\nWe also reproduce the first stage behavior by creating the UponBetter directory and moving\nthe license.dat file into it.\n\nlicense.dat in the UponBetter directory\n\nWe execute the labs-releases\\tools\\icedid\\gzip_variant\\load_core.py script using the\n**decrypted core binary: license.dat.decrypted, the context.json file.**\n\n**WARNING: The binary is going to be loaded/executed natively by this script, Elastic**\n**Security Labs does not take responsibility for any damage to your system. Please**\n**execute only within a safe environment.**\n\n\n-----\n\n```\nusage: load_core.py [ help] [ o OFFSET] core_path ctx_path\n\npositional arguments:\n\n core_path       Core custom PE\n\n ctx_path       Path to json file defining core's context\n\noptions:\n\n -h, --help      show this help message and exit\n\n -o OFFSET, --offset OFFSET\n\n            Offset to real data, skip possible garbage\n\n```\nBecause we have the same garbage bytes problem as stated in the previous section, we use\nthe “-o 129” parameter to skip over the garbage bytes.\n```\npython .\\gzip-variant\\load_core.py .\\extract\\license.dat.decrypted .\\gzipvariant\\context.example.json -o 129\n\n============================================================\n\nCore Loader\n\n============================================================\n\nBase address: 0x180000000\n\nEntrypoint: 0x180001390\n\nPress a key to call entrypoint...\n\n```\nWhen launched, the script will wait for user input before calling the entry point. We can easily\nattach a debugger to the Python process and set a breakpoint on the ICEDID core entry\npoint (in this example 0x180001390).\n\nBreakpoint set on the ICEDID core entry point\nOnce the key is pressed, we reach the entry point.\n\nICEDID\n\nentry point\nIf we let the binary execute, we see ICEDID threads being created (indicated in the following\nscreenshot).\n\n\n-----\n\nICEDID threads being created\n\n## Unpacking and rebuilding payloads from the rebuilt core binary\n\nFor extracting any of the payloads that are embedded inside the core binary, we will use the\n**labs-releases\\tools\\icedid\\gzip-variant\\extract_payloads_from_core.py script**\n```\nusage: extract_payloads_from_core.py [--help] input output\n\npositional arguments:\n\n input    Input file\n\n output   Output directory\n\noptions:\n\n -h, --help show this help message and exit\n\n```\nWe’ll use this script on the rebuiltcore binary.\n```\npython .\\gzip-variant\\extract_payloads_from_core.py .\\extract\\core.bin core_extract\n\ncore_extract\\browser_hook_payload_0.cpe\n\ncore_extract\\browser_hook_payload_1.cpe\n\n```\nFrom here, we output two binaries corresponding to ICEDID’s payloads for web browser\nhooking capabilities, however, they are still in their custom PE format.\n\nICEDID payloads\nBased on our research, we know that browser_hook_payload_0.cpe is the x64 version of\nthe browser hook payload and browser_hook_payload_1.cpe is the x86 version.\n\nBrowser hook payload\n\narchitectures\n\n\n-----\n\nIn order to rebuild them, we use the rebuild_pe.py script again, this time there are no\ngarbage bytes to skip over.\n```\npython .\\rebuild_pe.py .\\core_extract\\browser_hook_payload_0.cpe\n.\\core_extract\\browser_hook_payload_0.bin\n\npython .\\rebuild_pe.py .\\core_extract\\browser_hook_payload_1.cpe\n.\\core_extract\\browser_hook_payload_1.bin\n\n```\nNow we have two PE binaries (browser_hook_payload_0.bin and\n**browser_hook_payload_1.bin) we can further analyze.**\n\nPayloads for further analysis\nAttentive readers may observe that we have skipped the VNC server unpacking from the\ncore binary, a decision we made intentionally. We will release it along with other tools in\nupcoming research, so stay tuned!\n\n## Conclusion\n\nIn this tutorial we covered ICEDID GZip variant unpacking, starting with the extraction of the\nfake GZip binary, followed by the reconstruction of the core binary and unpacking its\npayloads.\n\nICEDID is constantly evolving, and we are going to continue to monitor major changes and\n[update our tooling along with our research. Feel free to open an issue or](https://github.com/elastic/labs-releases/issues) [send us a message](mailto:threat-notification@elastic.co)\nif something is broken or doesn’t work as expected.\n\nElastic Security Labs is a team of dedicated researchers and security engineers focused on\ndisrupting adversaries through the publication of detailed detection logic, protections, and\napplied threat research.\n\n[Follow us on @elasticseclabs and visit our research portal for more resources and research.](https://twitter.com/elasticseclabs)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-05-04 - Unpacking ICEDID.pdf"
    ],
    "report_names": [
        "2023-05-04 - Unpacking ICEDID.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1685930862,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1685881635,
    "ts_modification_date": 1685881635,
    "files": {
        "pdf": "https://archive.orkl.eu/25974f6aea9bd62425070d8f6f5f01dd7c5d9dbe.pdf",
        "text": "https://archive.orkl.eu/25974f6aea9bd62425070d8f6f5f01dd7c5d9dbe.txt",
        "img": "https://archive.orkl.eu/25974f6aea9bd62425070d8f6f5f01dd7c5d9dbe.jpg"
    }
}