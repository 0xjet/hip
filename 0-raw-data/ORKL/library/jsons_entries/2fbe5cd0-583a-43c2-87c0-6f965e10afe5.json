{
    "id": "2fbe5cd0-583a-43c2-87c0-6f965e10afe5",
    "created_at": "2023-01-12T15:11:01.124199Z",
    "updated_at": "2025-03-27T02:12:11.115098Z",
    "deleted_at": null,
    "sha1_hash": "0797685de78241f5b79d3ea29592667314903b57",
    "title": "2021-05-25 - TeamTNT Targets Kubernetes, Nearly 50,000 IPs Compromised in Worm-like Attack",
    "authors": "",
    "file_creation_date": "2022-05-28T15:18:39Z",
    "file_modification_date": "2022-05-28T15:18:39Z",
    "file_size": 923402,
    "plain_text": "# TeamTNT Targets Kubernetes, Nearly 50,000 IPs Compromised in Worm-like Attack\n\n**[trendmicro.com/en_us/research/21/e/teamtnt-targets-kubernetes--nearly-50-000-ips-compromised.html](https://www.trendmicro.com/en_us/research/21/e/teamtnt-targets-kubernetes--nearly-50-000-ips-compromised.html)**\n\nMay 25, 2021\n\n[Kubernetes is the most widely adopted container orchestration platform for automating the deployment, scaling, and](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)\nmanagement of containerized applications. Unfortunately, like any widely used application, it makes for an attractive target\nfor threat actors as they are often misconfigured, especially those running primarily in cloud environments with access to\n[nearly infinite resources. This article will discuss how TeamTNT — which we have discussed extensively in](https://www.trendmicro.com/en_us/research/20/l/teamtnt-now-deploying-ddos-capable-irc-bot-tntbotinger.html) previous\narticles — has been scanning for and compromising Kubernetes clusters in the wild.\n\nWe have found and confirmed close to 50,000 IPs compromised by this attack perpetrated by TeamTNT across multiple\nclusters. Several IPs were repeatedly exploited during the timeframe of the episode, occurring between March and May.\nMost of the compromised nodes were from China and the US — identified in the ISP (Internet Service Provider) list, which\nhad Chinese and US-based providers as the highest hits, including some CSPs (Cloud Service Providers). It should be\nnoted the numbers reflect the likelihood of significantly more clusters in operation for the US and China than many other\ncountries.\n\nFigure 1. The percentage of servers compromised per country. China and the United States make up most of the\ncompromised IPs.\nBy analyzing data belonging to a few TeamTNT servers, we discovered the tools and techniques used by the group for this\ncampaign.\n\nHow a Kubernetes cluster is compromised\n\nThis section will analyze one of the scripts we have collected from this threat actor that targets Kubernetes clusters. We\ncollected one of the files from their server, named kube.lateral.sh, that had a low detection rate in VirusTotal at the time of\nwriting. We break down what this script does and how it does it.\n\n\n-----\n\nFigure 2. VirusTotal detections for kube.lateral.sh verified on April 24, 2021 (top) and May 5, 2021 (bottom)\n\n## Setting up the environment\n\n\n-----\n\nTeamTNT s first order of business is to disable the bash history on the target host and define environment variables for\ntheir command and control (C&C) server, such as the script to install the crypto miner later and the binary of the XMRig\nMonero miner. Then a folder is created inside /tmp using $RANDOM three times, generating a sequence of random\nnumbers — for example, 132963764049, 64049520243 and 55772468520243. User and system architecture information is\ngathered using whoami and uname –m which are stored in environment variables to be used later.\n\n[The script also installs two free, open-source tools available from GitHub, the network scanning tool masscan — developed](https://github.com/robertdavidgraham/masscan)\n[in C — and the banner-grabbing, deprecated Zgrab — developed in Go. The new version Zgrab2 is also open source and](https://github.com/zmap/zgrab)\navailable on GitHub but is not installed with the script.\n\n## Downloading and installing the IRC Bot\n\nThe script has a large base64 encoded code block to install their IRC bot. We decoded, analyzed and discovered that it is\nwritten in C and is stored on the /tmp folder under the name kube.c to avoid suspicion. The bot code is compiled with Gnu\nCompiler Collection (GCC) and removed after compiling completes. The resulting binary generated is then moved to the\n_/root folder and renamed to kube as the code below illustrates:_\n\n_\"BASE64 ENCODED KUBE.C CODE HERE\" | base64 -d > /var/tmp/kube.c_\n\n_cd /var/tmp/; gcc -o /var/tmp/kube /var/tmp/kube.c && rm -f /var/tmp/kube.c_\n\n_mv /var/tmp/kube /root/.kube && chmod +x /root/.kube && /root/.kube_\n\n[The IRC bot, also written in C, is based on another famous IRC bot called Kaiten. Similar code for these bots are also](https://www.trendmicro.com/vinfo/tmr/?/us/security/news/internet-of-things/caught-in-the-crossfire-defending-devices-from-battling-botnets)\n[available on GitHub.](https://github.com/shipcod3/IRC-Bot-Hunters/blob/master/malicious_samples/kaiten.c)\n\nFigure 3. Code to install the IRC bot named kube.c.\n\n## Pwning and cryptojacking Kubernetes pods\n\nIn the last part of the script, we can see a function — kube_pwn() — being declared, just like in the image shown below. As\nseen from the code, the kube_pwn function uses Masscan to check any hosts with port 10250 open.\n\n\n-----\n\nFigure 4. Code showing how the kube_pwn function uses Masscan to check for hosts with the port 10250 open.\n\n## Kubelets\n\n[Those familiar with Kubernetes will know that this port belongs to the kubelet API, and by default, it is open on all nodes of](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/#:~:text=The%20kubelet%20is%20the%20primary,object%20that%20describes%20a%20pod.)\na cluster, including the control plane and worker nodes. And that is one of the essential first security hardening changes\nyou should make on an operational K8s cluster. Kubelet is the agent that runs on each node and ensures that all containers\nare running in a pod. It is also the agent that is responsible for any configuration changes on the nodes. Although it is not\non the [main Kubernetes architecture diagram, even the control plane node has a kubelet (and a kube-proxy) agent running](https://kubernetes.io/docs/concepts/overview/components/)\nif a user wants to run other pods there. However, it is not considered a best practice to run your application pods on the\ncontrol plane as it affords attackers the opportunity to own the cluster as we see here.\n\nThere are three critical factors for kubelet security settings:\n\n1. Enabling Kubelet authentication. According to the Kubernetes documentation requests to the kubelet’s API endpoint,\nwhich are not blocked by other authentication methods, are treated as anonymous requests by default. Please make sure\nyou start the kubelets with the --anonymous-auth=false flag and disable anonymous access. For more information check\nthe [Kubernetes official recommendations on Kubelet authentication.](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/#kubelet-authentication)\n\n2. Restricting kubelet permissions to prevent attackers from reading kubelet credentials after breaking out of the container\nto perform malicious actions.\n\n3. Rotating the kubelet certificates on the chance a compromise occurs, the certs are short-lived and potential impact is\nreduced.\n\n[According to the documentation for Kubernetes installation via kubeadm, the ports below are the ones that need to be open](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)\nfor a cluster to work properly. The kubelet API port (10250) should not be exposed to the internet as it is akin to leaving\nyour Docker Daemon API exposed. However, TeamTNT is compromising the kubelet after gaining access to the\nenvironment in this specific attack, so they run the scans internally.\n\n\n-----\n\nFigure 5. Required ports for kubeadm installation.\nThe kubelet API is not well documented; however, we analyzed the Kubernetes code directly to understand what is\nhappening, which is explained in the following sections. First, we looked at the server.go file inside the /kubelet/server\npackage. As shown in Figure 5, the first thing the kube_pwn() function does is to get some information from the Kubelet\nAPI via the /runningpods endpoint, filtering the namespace, pod name and container names.\n\nFigure 6. Kubernetes kubelet API source code analysis. Source:\nhttps://github com/kubernetes/kubernetes/blob/master/pkg/kubelet/server/server go#L489\n\n\n-----\n\n## Crypto jacking (deployed into pods)\n\nAs we can see from the kubelet server.go code above, the API endpoint /runningpods does exactly what the endpoint says,\nit lists the running pods. First, the kube_pwn() function lists all the current running pods inside the node in a JSON format.\nThen, for each container running on each node, it takes advantage of the /run endpoint on the kubelet API to run the\nfollowing commands:\n\n1. Updates the package index of the container.\n\n2. Installs the following packages: bash, wget and curl.\n\n3. Downloads a shell script called setup_xmr.sh from the TeamTNT C&C server and saves it on the tmp folder.\n\n4. Executes the script to start mining for the Monero cryptocurrency.\n\nFigure 7. Part of the kubelet API Server code from Kubernetes central repository on GitHub. Source:\nhttps://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/server/server.go#L410\nTo finish this, they run the same kube_pwn() function we analyzed against a series of internal IP ranges looking for new\ntargets to compromise, with similar behavior to a worm.\n\nFigure 8. A piece of code from the kube.lateral.sh, the file identified on TeamTNT’s C&C server.\n\n## Recommendations and Trend Micro Cloud Security Solutions\n\n[According to the new MITRE ATT&CK for Containers, Exploit Public-Facing Applications (T1190) is one of the entry points](https://attack.mitre.org/matrices/enterprise/containers/)\nfor attackers and could allow them to take over an organization’s cluster via RBAC misconfiguration or a cluster’s\nvulnerable version.\n\nHow to secure the Kube API Server\n\nIt is important to ensure that their Kube API Servers are not exposed. A straightforward way to check is by attempting to hit\nthe API server from an external IP. This curl request should be used to check if the API is public-facing or otherwise: “curl -k\nhttps://API-SERVER-IP:PORT/api.”\n\nIf there is a response from this curl request, similar to the one shown in Figure 9, then it means that the API is publicly\navailable and is exposed:\n\n\n-----\n\nFigure 9.\n\nAn example of a response after performing a curl request to check if an API is publicly accessible.\nOther best practices for protecting Kubernetes deployments can be found in our infosec guide, “The Basics of Keeping\nKubernetes Clusters Secure.”\n\n[Cloud security solutions such as Trend Micro Cloud One™ help enterprises access protection for continuous integration](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/cloud-migration-security.html)\nand continuous delivery (CI/CD) pipelines and applications. The platform includes:\n\n**[Workload Security: runtime protection for workloads](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/cloud-one-workload-security.html)**\n**[Container Security: automated container image and registry scanning](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/cloud-one-container-image-security.html)**\n**[File Storage Security: security for cloud file and object storage services](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/cloud-one-file-storage-security.html)**\n**[Network Security: cloud network layer IPS security](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/cloud-one-network-security.html)**\n**[Application Security: security for serverless functions, APIs, and applications](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/cloud-one-application-security.html)**\n**[Conformity: real-time protection for cloud infrastructure — secure, optimize, comply](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/cloud-one-conformity.html)**\n\nConclusion\n\nThis campaign is notable because it is the first time, we analyzed published tools from the TeamTNT group. Furthermore,\nthe continued use of crypto-jacking and credential-stealing indicate that these will remain in the threat actor’s primary\nrepertoire of techniques for the near future.\n\nThe high number of targets shows that TeamTNT is still expanding its reach (especially in cloud environments) and\nperhaps infrastructure since the group can monetize a more significant amount from their campaigns with more potential\nvictims. The group’s activities add to the [number of potential threats that Kubernetes users face.](https://www.trendmicro.com/vinfo/tmr/?/us//security/news/virtualization-and-cloud/guidance-on-kubernetes-threat-modeling)\n\nIndicators of Compromise (IOCs)\n\nFile name SHA256 Detection name\n\nkube.lateral.sh 0dc0d5e9d127c8027c0a5ed0ce237ab07d3ef86706d1f8d032bc8f140869c5ea Trojan.SH.YELLOWDYE.A\n\nCloud\n\nWe have found and confirmed close to 50,000 IPs compromised by this attack perpetrated by TeamTNT across multiple\nclusters. Several IPs were repeatedly exploited during the timeframe of the episode, occurring between March and May.\n\nBy: Magno Logan, David Fiser May 25, 2021 Read time: ( words)\n\nContent added to Folio\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-25 - TeamTNT Targets Kubernetes, Nearly 50,000 IPs Compromised in Worm-like Attack.pdf"
    ],
    "report_names": [
        "2021-05-25 - TeamTNT Targets Kubernetes, Nearly 50,000 IPs Compromised in Worm-like Attack.pdf"
    ],
    "threat_actors": [
        {
            "id": "f809bfcb-b200-4988-80a8-be78ef6a52ef",
            "created_at": "2023-01-06T13:46:39.186988Z",
            "updated_at": "2025-03-27T02:00:03.016358Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "Adept Libra"
            ],
            "source_name": "MISPGALAXY:TeamTNT",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "99cb4e5b-8071-4f9e-aa1d-45bfbb6197e3",
            "created_at": "2023-01-06T13:46:38.860754Z",
            "updated_at": "2025-03-27T02:00:02.937438Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "SectorJ04 Group",
                "Dudear",
                "G0092",
                "ATK103",
                "Hive0065",
                "Spandex Tempest",
                "GRACEFUL SPIDER",
                "GOLD TAHOE",
                "CHIMBORAZO",
                "SectorJ04"
            ],
            "source_name": "MISPGALAXY:TA505",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c3ca592f-0669-49bd-ab5c-310007ab2fb4",
            "created_at": "2022-10-25T15:50:23.334495Z",
            "updated_at": "2025-03-27T02:00:55.445098Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "TeamTNT"
            ],
            "source_name": "MITRE:TeamTNT",
            "tools": [
                "Peirates",
                "MimiPenguin",
                "LaZagne",
                "Hildegard"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e447d393-c259-46e2-9932-19be2ba67149",
            "created_at": "2022-10-25T16:07:24.28282Z",
            "updated_at": "2025-03-27T02:02:10.159466Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "ATK 103",
                "Chimborazo",
                "Gold Evergreen",
                "Gold Tahoe",
                "Graceful Spider",
                "Hive0065",
                "Operation Tovar",
                "Operation Trident Breach",
                "SectorJ04",
                "Spandex Tempest",
                "TA505",
                "TEMP.Warlock"
            ],
            "source_name": "ETDA:TA505",
            "tools": [
                "Amadey",
                "AmmyyRAT",
                "AndroMut",
                "Azer",
                "Bart",
                "Bugat v5",
                "CryptFile2",
                "CryptoLocker",
                "CryptoMix",
                "CryptoShield",
                "Dridex",
                "Dudear",
                "EmailStealer",
                "FRIENDSPEAK",
                "Fake Globe",
                "Fareit",
                "FlawedAmmyy",
                "FlawedGrace",
                "FlowerPippi",
                "GOZ",
                "GameOver Zeus",
                "GazGolder",
                "Gelup",
                "Get2",
                "GetandGo",
                "GlobeImposter",
                "Gorhax",
                "GraceWire",
                "Gussdoor",
                "Jaff",
                "Kasidet",
                "Kegotip",
                "Kneber",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Locky",
                "MINEBRIDGE",
                "MINEBRIDGE RAT",
                "MirrorBlast",
                "Neutrino Bot",
                "Neutrino Exploit Kit",
                "P2P Zeus",
                "Peer-to-Peer Zeus",
                "Philadelphia",
                "Philadephia Ransom",
                "Pony Loader",
                "Rakhni",
                "ReflectiveGnome",
                "Remote Manipulator System",
                "RockLoader",
                "RuRAT",
                "SDBbot",
                "ServHelper",
                "Shifu",
                "Siplog",
                "TeslaGun",
                "TiniMet",
                "TinyMet",
                "Trojan.Zbot",
                "Wsnpoem",
                "Zbot",
                "Zeta",
                "ZeuS",
                "Zeus"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536261,
    "ts_updated_at": 1743041531,
    "ts_creation_date": 1653751119,
    "ts_modification_date": 1653751119,
    "files": {
        "pdf": "https://archive.orkl.eu/0797685de78241f5b79d3ea29592667314903b57.pdf",
        "text": "https://archive.orkl.eu/0797685de78241f5b79d3ea29592667314903b57.txt",
        "img": "https://archive.orkl.eu/0797685de78241f5b79d3ea29592667314903b57.jpg"
    }
}