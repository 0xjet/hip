{
    "id": "8c1d944a-3aa7-40db-84d8-5f6afa919f5c",
    "created_at": "2023-01-12T15:06:27.952895Z",
    "updated_at": "2025-03-27T02:16:20.971834Z",
    "deleted_at": null,
    "sha1_hash": "8c6967acf8000a3a06af5c2d870879b52aa06807",
    "title": "2022-02-28 - Looking for Penquins in the Wild",
    "authors": "",
    "file_creation_date": "2022-05-28T03:48:09Z",
    "file_modification_date": "2022-05-28T03:48:09Z",
    "file_size": 2627988,
    "plain_text": "# Looking for Penquins in the Wild\n\n**lab52.io/blog/looking-for-penquins-in-the-wild/**\n\n[During 2020 Leonardo analysts discovered and published a very in depth analysis of a threat](https://www.leonardocompany.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf)\nknown as Penquin, attributed to the APT group Turla. 32-bit samples of this threat had been\ndetected and analyzed by Kaspersky before, but the analysis in this most recent publication\nwas focused on a new 64-bit sample.\n\nIt firstly caught our attention the fact that this threat does not have its own command and\ncontrol server, but rather stands by waiting for a very specific packet generated by the\nattacker and from that packet it extracts its command and control server.\n\nThis results in the following logical scenario for an attacker to take control of the threat:\n\n\n-----\n\nIn the report published by Leonardo there is a lot of information related to the structure of\nsuch packet and the threat activation protocol, in fact, they published a version of an UDP\nscanner with a specific packet contacting an internal IP, in order to allow scanning internal\nnetworks for threats.\n\nThis threat, despite being a compiled and relatively complex binary, has the same\ncapabilities that are usually found in webshells. Furthermore, the group itself could be said to\nuse them in a similar way than other less advanced groups using webshells since it has been\nobserved how in servers infected by this threat, command and controls from other Turla tools\nhave been deployed in order to use them as infrastructure in recent campaigns.\n\nThis fact implies that the possibility of detecting new infections of this threat all over the\nInternet may allow identifying the infrastructure of current, and even future, Turla campaigns.\n\nFor this, we firstly need to be able to generate activation packets for public IPs controlled by\nus. Secondly, we are interested in being able to scan TCP ports as well, since there are\ncases of servers that have specific TCP ports exposed to the Internet and all UDP ports\nblocked.\n\nStarting from public samples and the work already done and documented as a resource, we\ndecided to implement a function that emulates the threat‚Äôs logic of checking the validity of\nthat ‚ÄúMagic‚Äù packet and extracting the IP address of the C2 it is ordered to contact.\n\n\n-----\n\nThis allows us to quickly and automatically validate an inferred activation packet.\n\nRather than completely reverse the validation logic, in order to reverse the algorithm and try\nto generate specific packets we first tried brute-forcing the different elements within the UDP\nand TCP packets, and then leverage the function we had extracted from the threat to\nvalidate each combination for a public target IP controlled by us.\n\nWe know that the sample first extracts 32 bits from the packet, and compares them with the\nmask ‚Äú0xbdbd0560‚Äù. In case it passes this first filter, it extracts another 32 bits and the\nsource port, and passes this extracted information to the validation function we already have.\nThe problem was that brute-forcing so many bytes would be too slow and not feasible.\n\n[Fortunately, there is a good part of the algorithm already described. Some of these elements](https://www.leonardocompany.com/documents/20142/10868623/Malware+Technical+Insight+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf)\nare the fixed bits of the first mask and the bits that compose the IP address with which\nPenquin will contact (our controlled IP, in this case).\n\n\n-----\n\nThe fixed bits of the first check take away most of the second block of 32 bits, and since we\nwill want to generate the packets for an IP address controlled by us, we can subtract another\n28 bits from the two blocks of 32, since these will have to be exactly those that build the IP of\nour server. In fact we could subtract 4 more bits from the source port that will also be\ndependent on the final IP, although in our case we consider it unnecessary. So instead of\nbrute-forcing all possible combinations of two 32-bit blocks plus the port (16 bits more), we\nonly have to brute-force 4 bits + 4 bits + 2 bits + 3 bits + the source port, which becomes\ntrivial.\n\n\n-----\n\nThis would allow us to generate combinations for a destination IP and then check if the result\nis valid and it still generates the IP we expected it to generate.\n\nHowever, there is still one last element to take into account:\n\nThe function that checks the validity of the packet within the threat (in the screenshot\nrenamed to MagicStuff), returns as a parameter an ID extracted from the calculations it\nperforms, which can contain a value between 0 and 3. Just before contacting the target\nserver it compares this ID with the ID of the last contact with a C2, and it is initialized to 0\nwhen the threat is executed for the first time. This avoids accepting the same packet twice,\n(and at the same time, the first packet cannot result in 0 after that calculation). Therefore, we\nneed to generate two different packets if we want to make sure that in case we send it to an\ninfected server, it will reply and avoid not receiving contact simply because we have sent the\nsame ID as the attacker in the last contact.\n\nOnce two packets with different IDs and a controlled public IP have been generated, the last\nthing is to send them to a TCP or UDP port that is open on as many servers as possible and\nwait to receive responses on our server‚Äôs IP from the scanned IP addresses.\n\nFor this, in the case of UDP we already have the work done, but in the case of TCP the\npayload that checks the threat is not in the body of the TCP packet received, but in the\nheaders, specifically in the Sequence Number and Aknowledgement Number, so we need to\ngenerate the packet in RAW to be able to control these elements:\n\n\n-----\n\nOnce all the elements are prepared and finished with a close resemblance to this one:\n\nNow we finally can perform the scan üôÇ\n\nDifferent strategies have been used for the scanning. We have scanned ports 25 (TCP), 53\n(UDP/ TCP), 80(TCP), 443(TCP), 8080(TCP) and we have tried to vary the ‚Äúcallback‚Äù port.\nTo avoid unnecessary traffic, the sending and receiving packets are placed in different ip\naddresses. The IP address from where it is activated (source of our crafted packets) and the\n‚Äúsupposed‚Äù C2 (server expected to be contacted) are in different servers. In the case of\nreceiving packets in the expected address, a double check is made sending only to that IP, in\norder to verify that we are still receiving a response from Penquin.\n\nAfter a first scan in June 2020 we registered 86 ip addresses hosting Penquin.\n\n\n-----\n\nFirst of all, we were struck by the distribution of these infections, as they were all located in\nEurope, Russia and the United States.\n\nThe IP‚Äôs found correspond in most of the cases with VPS from a wide variety of providers.\n\nOn the other hand, Shodan offers us information suggesting that many of the IPs, as\nexpected, have multitude of vulnerabilities.\n\nIn the image above we can see the vulnerabilities in RED color and the IPs in ORANGE\ncolor.\n\n\n-----\n\nIn total, vulnerabilities have been identified in 65% (+ or -) of the detected IPs.\n\nAmong the detections observed, these two IP addresses stand out:\n\n85.25.95[.]16\n162.223.94[.]14\n\nAt ‚Äúfirst sight‚Äù, it can be observed how in VT this address is related to a binary that some\nantivirus vendors along with Intezer catalog as Turla.\n\n\n-----\n\nResearching for more details about this sample, we find that it is mentioned in an AnhLab\nReport about a Turla campaign against the Korean Defense sector, which, along with this\nparagraph from Cisto Talos from July 2021 ‚ÄúOne public reason why we attributed this\nbackdoor to Turla is the fact that they used the same infrastructure as they used for other\nattacks that have been clearly attributed to their Penguin Turla Infrastructure.‚Äù Related to\n[their analysis of Tinyturla, reinforces the hypothesis that they use Penquin as a tool to control](https://blog.talosintelligence.com/2021/09/tinyturla.html)\nmachines that are then used as command and control servers or intermediate node servers\nfor their operations.\n\nReferences:\n\n[1]\nhttps://www.leonardocompany.com/documents/20142/10868623/Malware+Technical+Insight\n+_Turla+%E2%80%9CPenquin_x64%E2%80%9D.pdf\n\n[2]\n[https://cn ahnlab com/global/upload/download/asecreport/ahnlab zh 202006%20vol 91 pdf](https://cn.ahnlab.com/global/upload/download/asecreport/ahnlab_zh_202006%20vol.91.pdf)\n\n\n-----\n\n[3] [https://blog.talosintelligence.com/2021/09/tinyturla.html](https://blog.talosintelligence.com/2021/09/tinyturla.html)\n\nIOCs\n\n1d5e4466a6c5723cd30caf8b1c3d33d1a3d4c94c25e2ebe186c02b8b41daf905 SHA256\n\n2dabb2c5c04da560a6b56dbaa565d1eab8189d1fa4a85557a22157877065ea08 SHA256\n\n3e138e4e34c6eed3506efc7c805fce19af13bd62aeb35544f81f111e83b5d0d4 SHA256\n\n5a204263cac112318cd162f1c372437abf7f2092902b05e943e8784869629dd8 SHA256\n\n67d9556c695ef6c51abf6fbab17acb3466e3149cf4d20cb64d6d34dc969b6502 SHA256\n\n8856a68d95e4e79301779770a83e3fad8f122b849a9e9e31cfe06bf3418fa667 SHA256\n\n8ccc081d4940c5d8aa6b782c16ed82528c0885bbb08210a8d0a8c519c54215bc SHA256\n\nd49690ccb82ff9d42d3ee9d7da693fd7d302734562de088e9298413d56b86ed0 SHA256\n\nd9f2467ff11efae921ec83e074e4f8d2eac7881d76bff60a872a801bd45ce3d5 SHA256\n\n85.25.95.16 Infected\nServer\n\n162.223.94.14 Infected\nServer\n\nCustomers with Lab52‚Äôs APT intelligence private feed service already have more tools and\nmeans of detection for this campaign.\nIn case of having threat hunting service or being client of S2Grupo CERT, this intelligence\nhas already been applied.\n\nIf you need more information about Lab52‚Äôs private APT intelligence feed service, you can\n[contact us through the following link](https://lab52.io/contact)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-28 - Looking for Penquins in the Wild.pdf"
    ],
    "report_names": [
        "2022-02-28 - Looking for Penquins in the Wild.pdf"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f5bf6853-3f6e-452c-a7b7-8f81c9a27476",
            "created_at": "2023-01-06T13:46:38.677391Z",
            "updated_at": "2025-03-27T02:00:02.889755Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "MISPGALAXY:Careto",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535987,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1653709689,
    "ts_modification_date": 1653709689,
    "files": {
        "pdf": "https://archive.orkl.eu/8c6967acf8000a3a06af5c2d870879b52aa06807.pdf",
        "text": "https://archive.orkl.eu/8c6967acf8000a3a06af5c2d870879b52aa06807.txt",
        "img": "https://archive.orkl.eu/8c6967acf8000a3a06af5c2d870879b52aa06807.jpg"
    }
}