{
    "id": "14d71c87-443d-4c51-b1ae-73d913fd4671",
    "created_at": "2023-01-12T15:09:19.962237Z",
    "updated_at": "2025-03-27T02:16:47.055879Z",
    "deleted_at": null,
    "sha1_hash": "6477bbafb5bafab5af6bc8abd3ded3f39f534859",
    "title": "2020-06-17 - Multi-stage APT attack drops Cobalt Strike using Malleable C2 feature",
    "authors": "",
    "file_creation_date": "2022-05-28T03:32:29Z",
    "file_modification_date": "2022-05-28T03:32:29Z",
    "file_size": 1432735,
    "plain_text": "# Multi-stage APT attack drops Cobalt Strike using Malleable C2 feature\n\n**[blog.malwarebytes.com/threat-analysis/2020/06/multi-stage-apt-attack-drops-cobalt-strike-using-malleable-c2-feature/](https://blog.malwarebytes.com/threat-analysis/2020/06/multi-stage-apt-attack-drops-cobalt-strike-using-malleable-c2-feature/)**\n\nThreat Intelligence Team June 17, 2020\n\n_This blog post was authored by Hossein Jazi and Jérôme Segura_\n\nOn June 10, we found a malicious Word document disguised as a resume that uses template\ninjection to drop a .Net Loader. This is the first part of a multi-stage attack that we believe is\nassociated to an APT attack. In the last stage, the threat actors used Cobalt Strike’s\nMalleable C2 feature to download the final payload and perform C2 communications.\n\nThis attack is particularly clever for its evasion techniques. For instance, we observed an\nintentional delay in executing the payload from the malicious Word macro. The goal is not to\ncompromise the victim right away, but instead to wait until they restart their machine.\nAdditionally, by hiding shellcode within an innocuous JavaScript and loading it without\ntouching the disk, this APT group can further thwart detection from security products.\n\n### Lure with delayed code execution\n\nThe lure document was probably distributed through spear phishing emails as a resume from\na person allegedly named “Anadia Waleed.” At first, we believed it was targeting India but it\nis possible that the intended victims could be more widespread.\n\n\n-----\n\nFigure 1: Resume\nThe malicious document uses template injection to download a remote template from the\nfollowing url:\n\nhttps://yenile[.]asia/YOOMANHOWYOUDARE/indexb.dotm\n\nFigure 2: Template injection\nThe domain used to host the remote template was registered on February 29, 2020 by\nsomeone from Hong Kong. Creation time for the document is 15 days after this domain\nregistration.\n\nThe downloaded template, “indexa.dotm”, has an embedded macro with five functions:\n\nDocument_Open\nVBA_and_Replace\nBase64Decode\n\n\n-----\n\nChangeFontSize\nFileFolderExist.\n\nThe following shows the function graph of the embedded macro.\n\nFigure 3: Macro functions graph\nThe main function is Document_open which is executed upon opening the file. This function\ndrops three files into the victim’s machine:\n\n**Ecmd.exe: UserForm1 and UserForm2 contain two Base64 encoded payloads.**\nDepending on the version of .Net framework installed on the victim’s machine, the\ncontent of UserForm1 (in case of .Net v3.5) or UserForm2 (other versions) is decoded\nand stored in “C:\\ProgramData”.\n**cf.ini: The content of the “cf.ini” file is extracted from UserForm3 and is AES encrypted,**\nwhich later on is decrypted by ecmd.exe.\n**ecmd.exe.lnk: This is a shortcut file for “ecmd.exe” and is created after Base64**\ndecoding the content of UserForm4. This file is dropped in the Startup directory as a\ntrigger and persistence mechanism.\n\nEcmd.exe is not executed until after the machine reboots.\n\nFigure 4: Document_Open\n\n\n-----\n\nFigure 5: Custom Base64 decode function\n_ChangeFontSize and VBA_and_Replace functions are not malicious and probably have_\n[been copied from public resources [1,](http://www.your-save-time-and-improve-quality-technologies-online-resource.com/vba-and-replace.html) [2] to mislead static scanners.](https://www.vitoshacademy.com/vba-ms-word-tricks-with-vba/)\n\n### Intermediary loader\n\nEcmd.exe is a .Net executable that pretends to be an ESET command line utility. The\nfollowing images show the binary certificates, debugger and version information.\n\nThe executable has been signed with an invalid certificate to mimic ESET, and its version\ninformation shows that this is an “ESET command line interface” tool (Figure 6-8).\n\nFigure\n\n6: Certificate information\n\n\n-----\n\nFigure 7: Version information\n\nFigure 8: Debugger information\n_ecmd.exe is a small loader that decrypts and executes the AES encrypted cf.ini file_\nmentioned earlier. It checks the country of the victim’s machine by making a HTTP post\nrequest to “http://ip-api.com/xml“. It then parses the XML response and extracts the country\ncode.\n\n\n-----\n\n9: Getcon function: make http post request to “ip-api.com”\n\n\nFigure\n\nFigure\n\n\n10: ip-api.com output\nIf the country code is “RU” or “US” it exits; otherwise it starts decrypting the content of “cf.ini”\nusing a hard-coded key and IV pair.\n\n\n-----\n\nFigure 10: ecmd.exe main function\nThe decrypted content is copied to an allocated memory region and executed as a new\nthread using VirtualAlloc and CreateThread APIs.\n\nFigure 11: runn function\n\n### ShellCode (cf.ini)\n\nA Malleable C2 is a way for an attacker to blend in command and control traffic (beacons\nbetween victim and server) with the goal of avoiding detection. A custom profile can be\ncreated for each target.\n\n\n-----\n\nThe shell code uses the Cobalt Strike Malleable C2 feature with a jquery Malleable C2 profile\nto download the second payload from “time.updateeset[.]com”.\n\nFigure 12: Malleable C2 request\n[This technique has been used by two other recent Chinese APTs—Mustang Panda and](https://malwareandstuff.com/mustang-panda-joins-the-covid19-bandwagon/)\n[APT41.](https://www.fireeye.com/blog/threat-research/2020/03/apt41-initiates-global-intrusion-campaign-using-multiple-exploits.html)\n\nThe shellcode first finds the address of ntdll.exe using PEB and then calls LoadLibrayExA to\nload Winint.dll. It then uses InternetOpenA, InternetConnectA, HttpOpenRequestA,\n_InternetSetOptionA and HttpSendRequestA APIs to download the second payload._\n\nThe API calls are resolved within two loops and then executed using a jump to the address\nof the resolved API call.\n\n\n-----\n\nFigure\n\n13: Building API calls\nThe malicious payload is downloaded by InternetReadFile and is copied to an allocated\nmemory region.\n\nFigure\n\n14: InternetReadFile\nConsidering that communication is over HTTPS, Wireshark is not helpful to spot the\nmalicious payload. Fiddler was not able to give us the payload either:\n\n\n-----\n\nFigure 15: Fiddler output\nUsing Burp Suite proxy we were able to successfully verify and capture the correct payload\ndownloaded from time.updateeset[.]com/jquery-3.3.1.slim.min.js. As can be seen in\nFigure 16, the payload is included in the jQuery script returned in the HTTP response:\n\nFigure\n\n16: Payload happened to the end of jquery\nAfter copying the payload into a buffer in memory, the shellcode jumps to the start of the\nbuffer and continues execution. This includes sending continuous beaconing requests to\n“time.updateeset[.]com/jquery-3.3.1.min.js” and waiting for the potential commands from\nthe C2.\n\n\n-----\n\nFigure 17: C2\n\ncommunications\nUsing [Hollow Hunter we were able to extract the final payload which is Cobalt Strike from](https://github.com/hasherezade/hollows_hunter)\necmd’s memory space.\n\n### Attribution\n\nA precise attribution of this attack is a work in progress but here we provide some insights\ninto who might be behind this attack. Our analysis showed that the attackers excluded\nRussia and the US. The former could be a false flag, while the latter may be an effort to\navoid the attention of US malware analysts.\n\nAs mentioned before, the domain hosting the remote template is registered in Hong Kong\nwhile the C2 domain “time.updateeset[.]com” was registered under the name of an Iranian\ncompany called Ehtesham Rayan on Feb 29, 2020. The company used to provide AV\nsoftware and is seemingly closed now. However, these are not strong or reliable indicators\nfor attribution.\n\n\n-----\n\nFigure 11: updateeset.com whois registration information\nIn terms of TTPs used, Chinese APT groups such as Mustang Panda and APT41 are known\nto use jQuery and the Malleable C2 feature of Cobalt Strike. Specifically, the latest campaign\nof [Mustang Panda has used the same Cobalt Strike feature with the same jQuery profile to](https://malwareandstuff.com/mustang-panda-joins-the-covid19-bandwagon/)\n\n\n-----\n\ndownload the final payload which is also Cobalt Strike. This is very similar to what we saw in\nthis campaign, however the initial infection vector and first payload are different in our case.\n\n## IOCs\n\n**Anadia Waleed resume.doc**\n\n259632b416b4b869fc6dc2d93d2b822dedf6526c0fa57723ad5c326a92d30621\n\n**Remote Template: indexa.dotm**\n\n7f1325c5a9266e649743ba714d02c819a8bfc7fd58d58e28a2b123ea260c0ce2\n\n**Remote Template Url:**\n\nhttps://yenile[.]asia/YOOMANHOWYOUDARE/\n\n**C2:**\n\ntime.updateeset[.]com\n\n**Ecmd.exe:**\n\naeb4c3ff5b5a62f5b7fcb1f958885f76795ee792c12244cee7e36d9050cfb298\n\ndcaaffea947152eab6572ae61d7a3783e6137901662e6b5b5cad82bffb5d8995\n\n5f49a47abc8e8d19bd5ed3625f28561ef584b1a226df09d45455fbf38c73a79c\n\n\n-----\n\n**cf.ini:**\n0eba651e5d54bd5bb502327daef6979de7e3eb63ba518756f659f373aa5f4f8b\n\n**Cf.ini shell-code after decryption:**\n5143c5d8715cfc1e70e9db00184592c6cfbb4b9312ee02739d098cf6bc83eff9\n\n**Cobalt Strike downloaded shellcode:**\n8cfd023f1aa40774a9b6ef3dbdfb75dea10eb7f601c308f8837920417f1ed702\n\n**Cobalt Strike payload**\n7963ead16b6277e5b4fbd5d0b683593877d50a6ea7e64d2fc5def605eba1162a\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-17 - Multi-stage APT attack drops Cobalt Strike using Malleable C2 feature.pdf"
    ],
    "report_names": [
        "2020-06-17 - Multi-stage APT attack drops Cobalt Strike using Malleable C2 feature.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1691c25f-1aa4-4168-8ce2-7aa8f23246e7",
            "created_at": "2024-06-04T02:03:07.724221Z",
            "updated_at": "2025-03-27T02:05:17.284601Z",
            "deleted_at": null,
            "main_name": "BRONZE PRESIDENT",
            "aliases": [
                "Mustang Panda ",
                "Red Lich ",
                "Temp.Hex ",
                "HoneyMyte "
            ],
            "source_name": "Secureworks:BRONZE PRESIDENT",
            "tools": [
                " Cobalt Strike",
                " ORat",
                " PlugX",
                " RCSession",
                "China Chopper"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4d5f939b-aea9-4a0e-8bff-003079a261ea",
            "created_at": "2023-01-06T13:46:39.04841Z",
            "updated_at": "2025-03-27T02:00:02.985296Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "G0096",
                "Grayfly",
                "BARIUM",
                "BRONZE ATLAS",
                "BRONZE EXPORT",
                "Red Kelpie",
                "HOODOO",
                "Brass Typhoon",
                "TA415",
                "WICKED SPIDER",
                "WICKED PANDA",
                "G0044",
                "Earth Baku"
            ],
            "source_name": "MISPGALAXY:APT41",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e698860d-57e8-4780-b7c3-41e5a8314ec0",
            "created_at": "2022-10-25T15:50:23.287929Z",
            "updated_at": "2025-03-27T02:00:55.43005Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "APT41",
                "Wicked Panda",
                "Brass Typhoon",
                "BARIUM"
            ],
            "source_name": "MITRE:APT41",
            "tools": [
                "ASPXSpy",
                "BITSAdmin",
                "PlugX",
                "Impacket",
                "gh0st RAT",
                "netstat",
                "PowerSploit",
                "ZxShell",
                "KEYPLUG",
                "ipconfig",
                "sqlmap",
                "China Chopper",
                "ShadowPad",
                "MESSAGETAP",
                "Mimikatz",
                "certutil",
                "njRAT",
                "Cobalt Strike",
                "pwdump",
                "BLACKCOFFEE",
                "ROCKBOOT",
                "dsquery",
                "Winnti for Linux",
                "DUSTTRAP",
                "Derusbi",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536159,
    "ts_updated_at": 1743041807,
    "ts_creation_date": 1653708749,
    "ts_modification_date": 1653708749,
    "files": {
        "pdf": "https://archive.orkl.eu/6477bbafb5bafab5af6bc8abd3ded3f39f534859.pdf",
        "text": "https://archive.orkl.eu/6477bbafb5bafab5af6bc8abd3ded3f39f534859.txt",
        "img": "https://archive.orkl.eu/6477bbafb5bafab5af6bc8abd3ded3f39f534859.jpg"
    }
}