{
    "id": "8b2593bc-82c4-4348-925a-b04f02053a1b",
    "created_at": "2023-01-12T15:07:07.62381Z",
    "updated_at": "2025-03-27T02:05:31.157806Z",
    "deleted_at": null,
    "sha1_hash": "996264826b08409de8d4f567523763c7f5eba52c",
    "title": "2021-10-22 - Spectre v4.0 - The Speed of Malware Threats After the Pandemics",
    "authors": "",
    "file_creation_date": "2022-05-28T15:44:18Z",
    "file_modification_date": "2022-05-28T15:44:18Z",
    "file_size": 3005710,
    "plain_text": "# Spectre v4.0: the speed of malware threats after the pandemics\n\n**[yoroi.company/research/spectre-v4-0-the-speed-of-malware-threats-after-the-pandemics/](https://yoroi.company/research/spectre-v4-0-the-speed-of-malware-threats-after-the-pandemics/)**\n\n10/22/2021\n\n## Introduction\n\n\nOctober 22, 2021\n\n\nCybercrime is today the first threat for businesses and actors are still evolving their malicious business models. In fact, the criminal\necosystem goes beyond the Malware-as-a-Service, many malware developers are increasing\ntheir dangerousness by providing infrastructure rental services included in the malicious software fee. This trend is slowly widening the\naudience of new hackers joining the criminal communities. As Malware ZLAB we constantly monitor this trend to ensure defense\ncapabilities to constituency and partner organizations rely on Yoroi's services to defend their business, and recently we noticed peaks\nof activity and fast evolution of a new emerging malware threat, the \"Spectre\" Remote Access Trojan (TH-309).\n\nThe first versions of this malware first appeared in 2017, but only during 2021 its developers heavily worked on the\ncode: we identified the three major version changes in the malware just in the past few months.\n\nThis exponential evolution of the codebase passed from version 2 of March 2021 to version 4, advertised in the underground\ncommunities during the past weeks and including infrastructure renting services too. For this reason, we decided to keep a closer\neye on the changes and evolution of this fast-moving threat.\n\n## Technical Analysis\n\nDuring our darknet monitoring activities, we found that in March 2021 an actor advertised a particular project named Spectre 2.0.\n\n\n-----\n\nFigure 1: Piece of the publication of Spectre project capabilities\n\nFrom this point, the evolution and the commercialization of the RAT progressively increased. In fact, the malicious project reached\nversion 3 in June and then quickly version 4, which we observed being abused in malicious campaigns targeting European\nusers in September.\n\n## The Malicious Document\n\nThe infection starts with a malicious document weaponized with a malicious XLM macro.\n\nHash d99c7a4c9a5619f64f32a600a20f49907b0cdf933de307ae2b073d3a6e173b53\n\nThreat Maldoc Dropper\n\nBrief Description Malicious document with XLM macro\n\nSSDEEP 192:+4Vp6dEK33AOixxdTXjTZQQav/JXpS09GR7RcOtO:OPnAtxdThQQu/FpFGXhO\n\nTable 1: Static Information about the sample\n\nDuring the last few days, we noticed that XLM macros are widespread in malicious documents so far, due to the fact it is a\nlegacy technology supported in current Microsoft Office versions yet, and the experience shows that they are quite\naffordable at avoiding detection from antimalware engines.\n\nFigure 2: Snippet of the XLM macro\n\n\n-----\n\nThe malicious routine starts with the auto_open function, the first instruction creates a file named **windows.vbs in the startup folder.**\nThen, the malicious document proceeds to write the VBS code in this file, that downloads the payload\nfrom “hxxp://176.123.2.]79/upload/winpro.exe”, saves it as “HbarOpportunity.exe” and executes it.\n\n## The VB6 Stub\n\nAt this point, we start to dig into the “HbarOpportunity.exe” dropped binary. It has the following static information:\n\nHash 9f8d67fdc1473c31193fb36e7ca37005c9af1c4052f8944c42f4eb0ba6188448\n\nThreat Spectre RAT packer\n\nBrief Description Packer of Spectre RAT written in VB6\n\nSSDEEP 12288:xEO2OYzW3RbnYxGtGnYxGtX0i5t7KY2JaGNK6laMSWcyoiY+Y683h:b25zW3Ro05gSeiY+V4h\n\nTable 2: VB6 Packed sample\n\nFigure 3: Evidence of VB6 compiler\n\nThis packer is designed to decrypt the payload and execute it in a stealthier way. Despite that, we were able to intercept\nthe routine loading of the shellcode in memory, which loads the unpacked payload.\n\nFigure 4: Shellcode loading through the CallWindowProcW API call\n\nThe above figure shows the packer's trick adopted to load the shellcode in memory: it calls a Windows API function\nnamed “CallWindowProcw” of “user32.dll”. According to the MSDN documentation, the function passes message information to the\nspecified window procedure through the callback methodology. This function can be used even in a malicious way: the malware\n[developer used a known shellcode injection via the callback technique (example here).](https://bestofcpp.com/repo/ChaitanyaHaritash-Callback_Shellcode_Injection)\n\nAfter jumping to the malicious code, the malware uses a self-decrypting routine to extract the last piece of code:\n\nFigure 5: Self shellcode decrypting routine\n\nThen, the malware shows the malicious APIs used to inject the payload inside a newly spawned process:\n\n\n-----\n\nFigure 6: Extraction of the Injection API calls\n\nFigure 7: Extracted Strings\n\nThese APIs are the lower-level functions required to implement the ProcessHollowing injection technique. In this\ncase, the canonical \"WriteProcessMemory\" function is replaced by the \"NtWriteVirtualMemory\" native API, as shown in the following\nscreen:\n\nFigure 8: Code Injection through ZwWriteVirtualMemory API\n\n## The Spectre 4 Payload\n\nAt this point, we decided to dig into the analysis of the unpacked payload\n\nHash 0fa4f066bdf3f4f7769afe4a01e4cba8680ac200743aaf24d0a3e9d1e76c83e3\n\nThreat Spectre Stealer/RAT\n\nBrief Description Spectre 4.0 / Unpacked Sample / C++\n\nSSDEEP 12288:BjK6AN9Szx16ZrFiOxz4ipIhBY/a6mG8zpx9dLvxy1TwS107EKL99+Fd4hvXGwcZ:tK6kT8p6ml1dEv6eZDlALa\n\nTable 3: Static information about the payload\n\nThe first interesting thing that emerged from the sample is the usage of an additional layer of classic AntiAnalysis controls performed by checking the presence of known malware analysis tools.\n\n\n-----\n\nFigure 9: Evasion technique evidence\n\nThe complete process list of the searched processes is the following:\n```\nollydbg,ProcessHacker,tcpview,autoruns,autorunsc,filemon,procmon,procmon64,regmon,procexp,idaq,idaq64,ImmunityDebugger,Wiresh\nwinjector-helper64,pythonw,python,pyw,regshot,dsniff,netmon,pr0c3xp,netsniffer,winspy,windump,mdpmon,ettercap,malmon,apispy32,idag,apispy,pex\n\n```\nAfter the evasion controls, the malware decodes its sensitive strings which outlook the sample’s capabilities, i.e., the \"keyboard\nkeys\" string, likely for keylogging, and a regular expression designed to match bitcoin wallet addresses.\n\nFigure 10: Piece of the decoded strings\n\n### The String Decoding Trick\n\nAs previously stated, these strings are not plaintext: they are obfuscated with an\nXOR operation using the hardcoded value \"0x47\". Despite the simple key, the decoding routine brings chunks of encrypted strings from\nmany locations. In fact, the obfuscated string is formed by getting some of the characters from the data section, and the rest as\nstack strings.\n\n\n-----\n\nFigure 11: How the obfuscated string is formed\n\nIn the following decoding routine example, we can also see the decoding of the command-and-control servers.\n\nFigure 12: Before the C2 decryption\n\nFigure 13: After the C2 decryption\n\n### C2 Communication\n\nThe C2 communication respects the classic botnet models, where the infected machine constantly pings the c2 server using a\nbeaconing mechanism, and the server replies to the HTTP requests with the peculiar string “SERVERUP”.\n\n\n-----\n\nFigure 14: C2 communication evidence\n\nAfter that, the bot declares which commands it executes. One of the first is the downloading of the “unzip.exe” utility, which could the\nuseful for further operations. Other commodity tools are then downloaded into the infected machine inside\na package called “libraries.zip”.\n\nFigure 15: Downloading of utilities\n\nThe content of the “libraries.zip” package is the following:\n\n\n-----\n\nFigure 16: Content of libraries.zip\n\nThe malware spawns “PsInfo64” utility in order to perform a reconnaissance operation of the infected machine. The other files\ncontained inside the package are of two types, the first one is the complete 7-zip command-line program, with its DLLs and executable,\nuseful to compress and decompress data to share with the C2. The second one comprehends all libraries which are dependencies for\nthe Mozilla Firefox browser, necessary for data exfiltration.\n\nFigure 17: Example of usage of PsInfo64\n\n### The Malicious Code Evolution\n\nWe compared the two main versions of the same malware released in 2021, the v2 and the v4. The main functions of these two\nsamples show the same structure, but the complexity of the features has indisputably grown.\n\nFigure 18: Diff analysis of the main function pseudocode\n\nIn the above figure we have on the left the version 2.0 of the sample\n(hash: d0a9a0fc888a7c3aa49e0570d7878118a4e5933b16d8fe92626ff6c498c4781d) and on the right the recent v4 sample discussed\nin previous sections. The progressive development of the code added many functions enriching the malware capabilities.\n\n\n-----\n\nFigure 19: Diff analysis of the C2 communication\n\n## Conclusions\n\nKeeping track of the evolution of malware codebases is crucial to ensure a proper understanding of the criminal underground. In fact,\nas the Spectre case shows, in a few months, a larval project could achieve considerable damage potential and become a candidate\nfor widespread attack campaigns.\n\nFor this reason, we monitor the malware markets and malicious code developers. Spotting the emerging threat right before its\nexplosion gives us tools and key intelligence to protect our customers proactively, lowering data leak risks, and help the security\ncommunity sharing data might help to protect the post-pandemic digital environment.\n\n## Indicators of Compromise\n\nHash\n\nd99c7a4c9a5619f64f32a600a20f49907b0cdf933de307ae2b073d3a6e173b53\n0fa4f066bdf3f4f7769afe4a01e4cba8680ac200743aaf24d0a3e9d1e76c83e3\n9f8d67fdc1473c31193fb36e7ca37005c9af1c4052f8944c42f4eb0ba6188448\nd0a9a0fc888a7c3aa49e0570d7878118a4e5933b16d8fe92626ff6c498c4781d\nDropURL:\n\nhxxp://176.123.2.]79/upload/winpro.exe\nC2:\n\nvoltaire-overproduction-bordering[.cc\nnonradiancy-requisit-mank.[cc\nbalmlike-mends-officiates[.cc\nfley-dothideacea-joker.[cc\narchsatrap-uroxin-oarsman[.cc\nenticement-reconclusion-pairedness[.cc\nsurplus-twentyfourmo-protecting.[cc\nmomental-scrooges-hoopster.[cc\nconj-lithomancy-behove.[cc\nhealthsomely-bone-idle-rufigallic[.cc\nenticement-reconclusion-pairedness[.cc\n\n## Yara Rules\n\n\n-----\n\n```\n{ \nmeta: \ndescription = \"Yara Rule for Spectre RAT, versions 2,3,4\" \nauthor = \"Yoroi Malware Zlab\" \nlast_updated = \"2021_10_08\" \ntlp = \"white\" \ncategory = \"informational\" \nstrings: \n$main = {FF 15 ?? ?? ?? ?? FF 15 ?? ?? ?? ?? 3D B7 00 00 00 75 06 57 E8 ?? 7? 00 00 E8 } \n$c2_send_request = {ff 15 ?? ?? ?? ?? 85 c0 0f 85 ?? ?? ?? ?? 68 ?? ?? ?? ?? 8d 4f 04 c7 07 01 00 00 00 e8 ?? ?? ?? ?? 8b\n[0-6] 00 10 00 00 83 f8 08 72 ?? 8b 4? [0-2] 8d 04 45 02 00 00 00 89 4?} \ncondition: \nall of them and uint16(0) == 0x5A4D \n}\n\n```\n_This blog post was authored by Luigi Martire, Carmelo Ragusa and Luca Mella of Yoroi Malware ZLAB_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-22 - Spectre v4.0 - The Speed of Malware Threats After the Pandemics.pdf"
    ],
    "report_names": [
        "2021-10-22 - Spectre v4.0 - The Speed of Malware Threats After the Pandemics.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536027,
    "ts_updated_at": 1743041131,
    "ts_creation_date": 1653752658,
    "ts_modification_date": 1653752658,
    "files": {
        "pdf": "https://archive.orkl.eu/996264826b08409de8d4f567523763c7f5eba52c.pdf",
        "text": "https://archive.orkl.eu/996264826b08409de8d4f567523763c7f5eba52c.txt",
        "img": "https://archive.orkl.eu/996264826b08409de8d4f567523763c7f5eba52c.jpg"
    }
}