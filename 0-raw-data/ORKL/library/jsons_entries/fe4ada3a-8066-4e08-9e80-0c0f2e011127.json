{
    "id": "fe4ada3a-8066-4e08-9e80-0c0f2e011127",
    "created_at": "2023-01-12T14:59:24.935567Z",
    "updated_at": "2025-03-27T02:05:28.184041Z",
    "deleted_at": null,
    "sha1_hash": "d928a13aacc7f6b42601b61d0592bca738bed8a8",
    "title": "2018-03-23 - Sanny malware delivery method updated in recently observed attacks.",
    "authors": "",
    "file_creation_date": "2022-05-28T19:33:52Z",
    "file_modification_date": "2022-05-28T19:33:52Z",
    "file_size": 986273,
    "plain_text": "# SANNY Malware Delivery Method Updated in Recently Observed Attacks\n\n**[fireeye.com/blog/threat-research/2018/03/sanny-malware-delivery-method-updated-in-recently-observed-attacks.html](https://www.fireeye.com/blog/threat-research/2018/03/sanny-malware-delivery-method-updated-in-recently-observed-attacks.html)**\n\n## Threat Research Blog\n\nMarch 23, 2018 | by [Sudeep Singh,](https://www.fireeye.com/blog/threat-research.html/category/etc/tags/fireeye-blog-authors/cap-sudeep-singh) [Yijie Sui](https://www.fireeye.com/blog/threat-research.html/category/etc/tags/fireeye-blog-authors/yijie-sui)\n\n**Introduction**\n\nIn the third week of March 2018, through FireEye’s Dynamic Threat Intelligence, FireEye\ndiscovered malicious macro-based Microsoft Word documents distributing SANNY malware to\nmultiple governments worldwide. Each malicious document lure was crafted in regard to\nrelevant regional geopolitical issues. FireEye has tracked the SANNY malware family since\n2012 and believes that it is unique to a group focused on Korean Peninsula issues. This group\nhas consistently targeted diplomatic entities worldwide, primarily using lure documents written\nin English and Russian.\n\nAs part of these recently observed attacks, the threat actor has made significant changes to\ntheir usual malware delivery method. The attack is now carried out in multiple stages, with\neach stage being downloaded from the attacker’s server. Command line evasion techniques,\nthe capability to infect systems running Windows 10, and use of recent User Account Control\n(UAC) bypass techniques have also been added.\n\n\n-----\n\n**Document Details**\n\nThe following two documents, detailed below, have been observed in the latest round of\nattacks:\n\n**MD5 hash: c538b2b2628bba25d68ad601e00ad150**\n\n**SHA256 hash: b0f30741a2449f4d8d5ffe4b029a6d3959775818bf2e85bab7fea29bd5acafa4**\n\n**Original Filename: РГНФ 2018-2019.doc**\n\nThe document shown in Figure 1 discusses Eurasian geopolitics as they relate to China, as\nwell as Russia’s security.\n\nFigure 1: Sample document written in Russian\n\n**MD5 hash: 7b0f14d8cd370625aeb8a6af66af28ac**\n\n**SHA256 hash: e29fad201feba8bd9385893d3c3db42bba094483a51d17e0217ceb7d3a7c08f1**\n\n**Original Filename: Copy of communication from Security Council Committee (1718).doc**\n\n\n-----\n\nThe document shown in Figure 2 discusses sanctions on humanitarian operations in the\nDemocratic People’s Republic of Korea (DPRK).\n\nFigure 2: Sample document written in English\n\n**Macro Analysis**\n\nIn both documents, an embedded macro stores the malicious command line to be executed in\nthe TextBox property (TextBox1.Text) of the document. This TextBox property is first accessed\nby the macro to execute the command on the system and is then overwritten to delete\nevidence of the command line.\n\n\n-----\n\n**Stage 1: BAT File Download**\n\nIn Stage 1, the macro leverages the legitimate Microsoft Windows certutil.exe utility to\ndownload an encoded Windows Batch (BAT) file from the following URL:\nhttp://more.1apps[.]com/1.txt. The macro then decodes the encoded file and drops it in the\n%temp% directory with the name: 1.bat.\n\nThere were a few interesting observations in the command line:\n\n1. The macro copies the Microsoft Windows certutil.exe utility to the %temp% directory with\n\nthe name: ct.exe. One of the reasons for this is to evade detection by security products.\nRecently, FireEye has observed other threat actors using certutil.exe for malicious\npurposes. By renaming “certutil.exe” before execution, the malware authors are\nattempting to evade simple file-name based heuristic detections.\n2. The malicious BAT file is stored as the contents of a fake PEM encoded SSL certificate\n\n(with the BEGIN and END markers) on the Stage 1 URL, as shown in Figure 3. The\n“certutil.exe” utility is then leveraged to both strip the BEGIN/END markers and decode\nthe Base64 contents of the file. FireEye has not previously observed the malware\nauthors use this technique in past campaigns.\n\n\n-----\n\nFigure 3: Malicious BAT file stored as an encoded file to appear as an SSL certificate\n\n**BAT File Analysis**\n\nOnce decoded and executed, the BAT file from Stage 1 will download an encoded CAB file\nfrom the base URL: hxxp://more.1apps[.]com/. The exact file name downloaded is based on\nthe architecture of the operating system.\n\nFor a 32-bit operating system: hxxp://more.1apps[.]com/2.txt\nFor a 64-bit operating system: hxxp://more.1apps[.]com/3.txt\n\nSimilarly, based on Windows operating system version and architecture, the CAB file is\ninstalled using different techniques. For Windows 10, the BAT file uses rundll32 to invoke the\nappropriate function from update.dll (component inside setup.cab).\n\nFor a 32-bit operating system: rundll32 update.dll _EntryPoint@16\nFor a 64-bit operating system: rundll32 update.dll EntryPoint\n\nFor other versions of Windows, the CAB file is extracted using the legitimate Windows Update\nStandalone Installer (wusa.exe) directly into the system directory:\n\n\n-----\n\nThe BAT file also checks for the presence of Kaspersky Lab Antivirus software on the\nmachine. If found, CAB installation is changed accordingly in an attempt to bypass detection:\n\n**Stage 2: CAB File Analysis**\n\nAs described in the previous section, the BAT file will download the CAB file based on the\narchitecture of the underlying operating system. The rest of the malicious activities are\nperformed by the downloaded CAB file.\n\nThe CAB file contains the following components:\n\ninstall.bat – BAT file used to deploy and execute the components.\nipnet.dll – Main component that we refer to as SANNY malware.\nipnet.ini – Config file used by SANNY malware.\nNTWDBLIB.dll – Performs UAC bypass on Windows 7 (32-bit and 64-bit).\nupdate.dll – Performs UAC bypass on Windows 10.\n\ninstall.bat will perform the following essential activities:\n\n1. Checks the current execution directory of the BAT file. If it is not the Windows system\n\ndirectory, then it will first copy the necessary components (ipnet.dll and ipnet.ini) to the\nWindows system directory before continuing execution:\n\n\n-----\n\n2. Hijacks a legitimate Windows system service, COMSysApp (COM+ System Application)\n\nby first stopping this service, and then modifying the appropriate Windows service\nregistry keys to ensure that the malicious ipnet.dll will be loaded when the COMSysApp\nservice is started:\n\n3. After the hijacked COMSysApp service is started, it will delete all remaining components\n\nof the CAB file:\n\nipnet.dll is the main component inside the CAB file that is used for performing malicious\nactivities. This DLL exports the following two functions:\n\n1. ServiceMain – Invoked when the hijacked system service, COMSysApp, is started.\n2. Post – Used to perform data exfiltration to the command and control (C2) server using\n\nFTP protocol.\n\nThe ServiceMain function first performs a check to see if it is being run in the context of\nsvchost.exe or rundll32.exe. If it is being run in the context of svchost.exe, then it will first start\nthe system service before proceeding with the malicious activities. If it is being run in the\ncontext of rundll32.exe, then it performs the following activities:\n\n1. Deletes the module NTWDBLIB.DLL from the disk using the following command:\n\ncmd /c taskkill /im cliconfg.exe /f /t && del /f /q NTWDBLIB.DLL\n\n2. Sets the code page on the system to 65001, which corresponds to UTF-8:\n\ncmd /c REG ADD HKCU\\Console /v CodePage /t REG DWORD /d 65001 /f\n\n\n-----\n\n**Command and Control (C2) Communication**\n\nSANNY malware uses the FTP protocol as the C2 communication channel.\n\nFTP Config File\n\nThe FTP configuration information used by SANNY malware is encoded and stored inside\nipnet.ini.\n\nThis file is Base64 encoded using the following custom character set:\nSbVIn=BU/dqNP2kWw0oCrm9xaJ3tZX6OpFc7Asi4lvuhf-TjMLRQ5GKeEHYgD1yz8\n\nUpon decoding the file, the following credentials can be recovered:\n\nFTP Server: ftp.capnix[.]com\nUsername: cnix_21072852\nPassword: vlasimir2017\n\nIt then continues to perform the connection to the FTP server decoded from the\naforementioned config file, and sets the current directory on the FTP server as “htdocs” using\nthe FtpSetCurrentDirectoryW function.\n\nSystem Information Collection\n\nFor reconnaissance purposes, SANNY malware executes commands on the system to collect\ninformation, which is sent to the C2 server.\n\nSystem information is gathered from the machine using the following command:\n\nThe list of running tasks on the system is gathered by executing the following command:\n\nC2 Commands\n\nAfter successful connection to the FTP server decoded from the configuration file, the malware\nsearches for a file containing the substring “to everyone” in the “htdocs” directory. This file will\ncontain C2 commands to be executed by the malware.\n\nUpon discovery of the file with the “to everyone” substring, the malware will download the file\nand then performs actions based on the following command names:\n\n\n-----\n\nchip command: This command deletes the existing ipnet.ini configuration file from the file\nsystem and creates a new ipnet.ini file with a specified configuration string. The chip\ncommands allows the attacker to migrate malware to a new FTP C2 server. The\ncommand has the following syntax:\n\npull command: This command is used for the purpose of data exfiltration. It has the ability\nto upload an arbitrary file from the local filesystem to the attacker’s FTP server. The\ncommand has the following syntax:\n\nThe uploaded file is compressed and encrypted using the routine described later in the\nCompression and Encoding Data section.\n\nput command: This command is used to copy an existing file on the system to a new\nlocation and delete the file from the original location. The command has the following\nsyntax:\n\ndefault command: If the command begins with the substring “cmd /c”, but it is not\nfollowed by either of the previous commands (chip, pull, and put), then it directly\nexecutes the command on the machine using WinExec.\n\n/user command: This command will execute a command on the system as the logged in\nuser. The command duplicates the access token of “explorer.exe” and spawns a process\nusing the following steps:\n\n1. Enumerates the running processes on the system to search for the explorer.exe\n\nprocess and obtain the process ID of explorer.exe.\n2. Obtains the access token for the explorer.exe process with the access flags set to\n\n0x000F01FF.\n3. Starts the application (defined in the C2 command) on the system by calling the\n\nCreateProcessAsUser function and using the access token obtained in Step 2.\n\n**C2 Command** **Purpose**\n\n\n-----\n\nchip Update the FTP server config file\n\npull Upload a file from the machine\n\nput Copy an existing file to a new destination\n\n/user Create a new process with explorer.exe access token\n\ndefault command Execute a program on the machine using WinExec()\n\n**Compression and Encoding Data**\n\nSANNY malware uses an interesting mechanism for compressing the contents of data\ncollected from the system and encoding it before exfiltration. Instead of using an archiving\nutility, the malware leverages Shell.Application COM object and calls the CopyHere method of\nthe IShellDispatch interface to perform compression as follows:\n\n1. Creates an empty ZIP file with the name: temp.zip in the %temp% directory.\n2. Writes the first 16 bytes of the PK header to the ZIP file.\n3. Calls the CopyHere method of IShellDispatch interface to compress the collected data\n\nand write to temp.zip.\n4. Reads the contents of temp.zip to memory.\n5. Deletes temp.zip from the disk.\n6. Creates an empty file, post.txt, in the %temp% directory.\n7. The temp.zip file contents are Base64 encoded (using the same custom character set\n\nmentioned in the previous FTP Config File section) and written to the file:\n%temp%\\post.txt.\n8. Calls the FtpPutFileW function to write the contents of post.txt to the remote file with the\n\nformat: “from <computer_name_timestamp>.txt”\n\n**Execution on Windows 7 and User Account Control (UAC) Bypass**\n\nNTWDBLIB.dll – This component from the CAB file will be extracted to the %windir%\\system32\ndirectory. After this, the cliconfg command is executed by the BAT file.\n\nThe purpose of this DLL module is to launch the install.bat file. The file cliconfg.exe is a\nlegitimate Windows binary (SQL Client Configuration Utility), loads the library NTWDBLIB.dll\nupon execution. Placing a malicious copy of NTWDBLIB.dll in the same directory as\ncliconfg.exe is a technique known as DLL side-loading, and results in a UAC bypass.\n\n**Execution on Windows 10 and UAC Bypass**\n\n\n-----\n\nUpdate.dll – This component from the CAB file is used to perform UAC bypass on Windows\n10. As described in the BAT File Analysis section, if the underlying operating system is\nWindows 10, then it uses update.dll to begin the execution of code instead of invoking the\ninstall.bat file directly.\n\nThe main actions performed by update.dll are as follows:\n\n1. Executes the following commands to setup the Windows registry for UAC bypass:\n\n[2. Leverages a UAC bypass technique that uses the legitimate Windows binary,](https://pentestlab.blog/2017/06/07/uac-bypass-fodhelper/)\n\nfodhelper.exe, to perform the UAC bypass on Windows 10 so that the install.bat file is\nexecuted with elevated privileges:\n\n3. Creates an additional BAT file, kill.bat, in the current directory to delete evidence of the\n\nUAC bypass. The BAT file kills the current process and deletes the components\nupdate.dll and kill.bat from the file system:\n\n**Conclusion**\n\nThis activity shows us that the threat actors using SANNY malware are evolving their malware\ndelivery methods, notably by incorporating UAC bypasses and endpoint evasion techniques.\nBy using a multi-stage attack with a modular architecture, the malware authors increase the\ndifficulty of reverse engineering and potentially evade security solutions.\n\nUsers can protect themselves from such attacks by disabling Office macros in their settings\nand practicing vigilance when enabling macros (especially when prompted) in documents,\neven if such documents are from seemingly trusted sources.\n\n**Indicators of Compromise**\n\n\n-----\n\n**SHA256 Hash** **Original**\n**Filename**\n\nb0f30741a2449f4d8d5ffe4b029a6d3959775818bf2e85bab7fea29bd5acafa4 РГНФ 20182019.doc\n\ne29fad201feba8bd9385893d3c3db42bba094483a51d17e0217ceb7d3a7c08f1 Copy of\ncommunication\nfrom Security\nCouncil\nCommittee\n(1718).doc\n\neb394523df31fc83aefa402f8015c4a46f534c0a1f224151c47e80513ceea46f 1.bat\n\na2e897c03f313a097dc0f3c5245071fbaeee316cfb3f07785932605046697170 Setup.cab (64bit)\n\na3b2c4746f471b4eabc3d91e2d0547c6f3e7a10a92ce119d92fa70a6d7d3a113 Setup.cab (32bit)\n\nPrevious Post\nNext Post\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-03-23 - Sanny malware delivery method updated in recently observed attacks..pdf"
    ],
    "report_names": [
        "2018-03-23 - Sanny malware delivery method updated in recently observed attacks..pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535564,
    "ts_updated_at": 1743041128,
    "ts_creation_date": 1653766432,
    "ts_modification_date": 1653766432,
    "files": {
        "pdf": "https://archive.orkl.eu/d928a13aacc7f6b42601b61d0592bca738bed8a8.pdf",
        "text": "https://archive.orkl.eu/d928a13aacc7f6b42601b61d0592bca738bed8a8.txt",
        "img": "https://archive.orkl.eu/d928a13aacc7f6b42601b61d0592bca738bed8a8.jpg"
    }
}