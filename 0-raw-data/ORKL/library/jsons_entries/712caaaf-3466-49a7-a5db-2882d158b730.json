{
    "id": "712caaaf-3466-49a7-a5db-2882d158b730",
    "created_at": "2023-01-12T15:10:21.096671Z",
    "updated_at": "2025-03-27T02:09:29.348165Z",
    "deleted_at": null,
    "sha1_hash": "6b30312c2ddecdd21433dbea85f09403b19bd6ec",
    "title": "2022-03-28 - Malicious Macros and Zone Identifier Alternate Data Stream Information Bypass",
    "authors": "",
    "file_creation_date": "2022-05-29T16:23:07Z",
    "file_modification_date": "2022-05-29T16:23:07Z",
    "file_size": 1708664,
    "plain_text": "# Malicious Macros and Zone Identifier Alternate Data Stream Information Bypass\n\n**[cloudsek.com/malicious-macros-and-zone-identifier-alternate-data-stream-information-bypass/](https://cloudsek.com/malicious-macros-and-zone-identifier-alternate-data-stream-information-bypass/)**\n\nAnandeshwar Unnikrishnan March 28, 2022\n\nVBA macro is one of the most extensively abused features of Microsoft Excel, used by\nadversaries to gain an initial foothold in the target network. The sophistication of the\ntechnique leveraged to deploy the payload determines the detection of the macro code.\nHowever, the main reason for the risk is still the inherent nature of the Office applications to\noffer execution of macros.\n\n[Recently Microsoft took a bold move and disabled the macros from running in documents](https://techcommunity.microsoft.com/t5/microsoft-365-blog/helping-users-stay-safe-blocking-internet-macros-by-default-in/ba-p/3071805)\ndownloaded from the internet. This blog covers a few techniques employed by adversaries to\nbypass such restrictions and execute malicious macros in documents downloaded from the\ninternet.\n\n## What are Macros and how are they used maliciously?\n\nMacros are special-use programmes that are used to automate operations within a larger\napplication or piece of software. Macros consist of a set of instructions and operations\nexpressed in a Macro Language (such as Visual Basic for Applications or VBA) or a\nconventional programming language. When a certain trigger is fired, the programme will\nautomatically execute these commands. Threat actors write malicious code in the same\nMacro Language and hide it in documents and spreadsheets, distributed over the internet.\nFollowed by which the code is activated as soon as the file is opened.\n\n## Zone Identifier and Security\n\n**How Does Windows Identify the Source of the Files?**\n\nIn a phishing attack, data downloaded from the internet is handled by a browser application\nrunning on Windows. Browsers create an Alternate Data Stream named\n\n`“Zone.Identifier,”` whenever such data is downloaded and a “ZoneId” is addedto this\nstream, representing the zone from which the file originated. Zone IDs are listed in the table\n[below. For more information on URL security zones refer to this article.](https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms537183(v=vs.85)?redirectedfrom=MSDN)\n\n**Zone** **ZoneId**\n\nLocal machine 0\n\nLocal intranet 1\n\nTrusted sites 2\n\n\n-----\n\nInternet 3\n\nRestricted sites 4\n\nWe can use PowerShell to query the Zone.Identifier stream data to obtain the assigned\nZoneId. As shown in the image below, a lot of information on the file is retrievable, especially\nits source information such as URL and host details. The file shown in the image has a\nZoneId of 3. And with reference to the aforementioned table, ID 3 stands for ‘Internet’. This\nindicates that the malicious.doc is downloaded from the internet.\n\nThis indicates that the malicious.doc is downloaded from the internet.\nSecurity implementations on Windows make use of the zone identifier data and utilize the\n“Mark of the Web” feature, to identify local files from downloaded ones. Here are a few\nmechanisms that leverage the “Mark of the Web” feature to take action:\n\nWindows Smart Screen\nProtected View in Office Suite\nApplication Guard\nVisual Studio untrusted data protection\n\nIn the above instance, when malicious.doc with ZoneId 3 is opened on Word, it opens in\nProtected View as shown below:\n\nIn the above instance, when malicious.doc with ZoneId 3 is opened on Word, it opens in\nProtected View as shown below:\n\n## Executing Internet Macros\n\nWhen non-NTFS (New Technology File System) formats are used as containers to hold a\nmalicious file, the browser will be incapable of creating ADS in files inside the container. In\nsuch cases, the browser fails to assign a ZoneId for the attacker files, enabling macro\nexecution.\n\n\n-----\n\nThe .iso format is a popular container choice for malicious files. And such files extracted\nfrom ISO don’t have a Zone. Identifier stream, which causes Windows to treat it as a local\nfile.\n\nThe image below shows that a downloaded ISO file uses the Mark of the Web and is\nassigned ZoneId 3.\n\ndownloaded ISO file uses the Mark of the Web and is assigned ZoneId 3\nWhen files are extracted from ISO to the disk, they do not have any zone identification data\nas shown in the following image. Hence when stream data is queried, PowerShell throws an\nerror stating that the stream object cannot be found. Verifying that the malicious file is\ncategorized as a local file by the system.\n\nHence when stream data is queried, PowerShell throws an error stating that the stream\nobject cannot be found.\nWhen a malicious document extracted from an ISO is opened in Word, the ProtectedView\nfeature doesn’t alert the user. Thus no-sandbox protection will be offered by Protected View,\nallowing the malware to have an unrestricted execution on the system.\n\nWhen a malicious document extracted from an ISO is opened in Word, the ProtectedView\nfeature doesn’t alert the user\n\n## Conclusion\n\n\n-----\n\nAdversaries exploit the features of VBA Macros to bypass Zone Identifier techniques\nemployed by Office applications. They execute malicious macros in documents that the\nbrowser fails to identify as files from the internet, only to jump security measures and infect\ntarget networks. Observing the following mitigation measures could allow users to prevent\nsuch attacks:\n\nA Defense in Depth approach should always be preferred instead of relying on a single\ndefense.\n[It is ideal to enforce Microsoft’s Attack Surface Reduction rules (ASR rules) in an](https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction)\nenterprise environment.\nDo not execute files shipped in suspicious container formats.\n\nAuthor Details\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of\noffensive cybersecurity. He is fuelled by his passion for cyber threats in a global context. He\ndedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground.\nHe believes that “a strong mind starts with a strong body.” When he is not gymming, he finds\ntime to nurture his passion for teaching. He also likes to travel and experience new cultures.\n\n\n-----\n\n[Gursehaj Singh](https://cloudsek.com/author/gursehaj-singh/)\nTotal Posts: 0\nGursehaj is a Threat Intelligence Editor Intern at CloudSEK. In hi free time you can find him\nreading and writing Medium articles :partying_face:\n×\n\n[Anandeshwar Unnikrishnan](https://cloudsek.com/author/anadeshwar-unnikrishnan/)\nThreat Intelligence Researcher, [CloudSEK](https://cloudsek.com/)\nAnandeshwar is a Threat Intelligence Researcher at CloudSEK. He is a strong advocate of\noffensive cybersecurity. He is fuelled by his passion for cyber threats in a global context. He\ndedicates much of his time on Try Hack Me/ Hack The Box/ Offensive Security Playground.\nHe believes that “a strong mind starts with a strong body.” When he is not gymming, he finds\ntime to nurture his passion for teaching. He also likes to travel and experience new cultures.\n\nLatest Posts\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-28 - Malicious Macros and Zone Identifier Alternate Data Stream Information Bypass.pdf"
    ],
    "report_names": [
        "2022-03-28 - Malicious Macros and Zone Identifier Alternate Data Stream Information Bypass.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536221,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1653841387,
    "ts_modification_date": 1653841387,
    "files": {
        "pdf": "https://archive.orkl.eu/6b30312c2ddecdd21433dbea85f09403b19bd6ec.pdf",
        "text": "https://archive.orkl.eu/6b30312c2ddecdd21433dbea85f09403b19bd6ec.txt",
        "img": "https://archive.orkl.eu/6b30312c2ddecdd21433dbea85f09403b19bd6ec.jpg"
    }
}