{
    "id": "63ef6ab1-219d-4e03-843b-10d56e166afb",
    "created_at": "2023-01-12T15:06:58.085058Z",
    "updated_at": "2025-03-27T02:06:00.080379Z",
    "deleted_at": null,
    "sha1_hash": "3b713f7c26f6e5d0a98c85d58667d3747eb3e6a1",
    "title": "2014-08-14 - Hunting the Mutex",
    "authors": "",
    "file_creation_date": "2022-05-28T21:51:37Z",
    "file_modification_date": "2022-05-28T21:51:37Z",
    "file_size": 110637,
    "plain_text": "# Hunting the Mutex\n\n**[researchcenter.paloaltonetworks.com/2014/08/hunting-mutex/](https://researchcenter.paloaltonetworks.com/2014/08/hunting-mutex/)**\n\nPalo Alto Networks August 14, 2014\n\nBy [Palo Alto Networks](https://unit42.paloaltonetworks.com/author/paloaltonetworksstaff/)\n\nAugust 14, 2014 at 2:15 PM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Threat Advisories - Advisories,](https://unit42.paloaltonetworks.com/category/threat-briefs-assessments/threat-advisories-advisories/) [Threat Advisory/Analysis,](https://unit42.paloaltonetworks.com/category/threat-briefs-assessments/threat-advisory-analysis/) Threat\nPrevention, [Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [Haystack,](https://unit42.paloaltonetworks.com/tag/haystack/) [mutex,](https://unit42.paloaltonetworks.com/tag/mutex/) [WildFire](https://unit42.paloaltonetworks.com/tag/wildfire/)\n\n## Summary\n\nMutex analysis is an often overlooked and useful tool for malware author fingerprinting,\nfamily classification, and even discovery. Far from the hypothesized \"huge amount of\nvariability\" in mutex names, likely hypothesized due to the seemingly random appearance of\nthem, practical mutex usage is embarrassingly consistent. In fact, over 15% of all collected\nworms share a single mutex [2gvwnqjz].\n\nThis blog was sourced from the data generated by the WildFire Analytics cloud, which\nprocesses thousands of samples a day and provides insights into various characteristics and\nbehaviors of malware worldwide. But before we get into the details, here is a quick overview\nof mutexes and why they exist in the first place.\n\n## Mutex Overview\n\nThe mutex is the fundamental tool for managing shared resources between multiple threads\n(or processes). If you think of the threads as a whole bunch of people in a meeting, all trying\nto talk at once, a mutex is the baton that gets passed from one person to the next so that\nthere’s only one person talking at a time. The important thing to understand is what the\nmutex is really protecting. In the above example, the resource being protected isn’t the right\nto speak, as many might think, but rather the ability to listen.\n\nHere’s a more technical example. Lets say you want to update an Internet Explorer (IE)\ncookie file, adding a unique identifier for use later. Naively, what you need to do is read the\ncookie file in, add your data to what you’ve read, and write the file back to disk. But what if IE\nis running and also updating that file? The worst case, for you, is that both you and IE read\nthe file at the same time but you write your edits first. This is because IE will completely\ndestroy your edits when it writes its new version of the file over yours.\n\n\n-----\n\nThe solution to this problem is to use a mutex to protect the integrity of the cookie file. A\nprocess that has the mutex knows that while it holds that mutex no other process will be\naccessing the cookie file. It can then read, tweak, and write the file without fear of any\nclobbering by other processes.\n\n## Analysis\n\nSince each shared resource can only have a single mutex effectively protecting it, leveraging\nthat mutex is indication that a program will be using said resource. In the cookie file example\nabove, just referencing the mutex protecting that file indicates, with extremely high\nprobability, that functionality to change the file exists somewhere in the program.\n\nAny given mutex, and protected functionality, can then be thought of as an independent\nlibrary of sorts. Note that while the technical implementation may not expose said\nfunctionality as a normal library, such exposure is not necessary for the types of analysis\nperformed here. That library’s usage can be analyzed in terms of who uses it. Simply put:\nmalware writers leverage malware specific libraries and groups of like actors will reuse these\ncore libraries when able.\n\n## Dear Haystack, You Failed\n\nThe needle in a haystack problem forever plagues malware research: it’s extremely difficult\nto find reliable information with malware writers constantly working to undermine or eliminate\nthat information. But, in the case of mutex analysis, the useful information pretty well slapped\nus in the face.\n\nAs can be clearly seen, mutex 2gvwnqjz1 is strongly associated with malware. In fact, we\nhave only seen it in malware.\n\n\n-----\n\nAs is equally obvious, not all mutexes offer such dramatic insight. There are many common\nmutexes shared across both benign software and malware. What’s more, they don’t all share\nmillions of uses across both sides of the fence.\n\nIn cases such as these the common approach is to use sets of the data, in this case sets of\nmutexes, to create fingerprints of each sample and then leverage those fingerprints to extract\nhigher confidence classification decisions. While this avenue of research is being pursued, it\nsuffers from all the traditional challenges of big data research. In other words, it’s slow going.\n\nIn parallel, and to inform better hypothesis for the fingerprint generation, research is being\ndone to determine how far single mutex analysis can take us. The research is ongoing but\nthe initial results are extremely promising.\n\n## Dear Haystack, We Repent\n\nThe number of times any single mutex is used drops rapidly from the millions of samples\ndown to thousands and from there, even further. Tens of thousands of the mutexes have\nbeen seen in only a single sample each. This results in a few hundred thousand individual\nmutexes available for further analysis.\n\nWhat quickly becomes apparent is that a large majority of the mutexes provide no obvious\nmeans to automatically classify them as necessarily indicative of good or bad behavior. And,\nunfortunately, the ones, which are reasonably easy for a human to identify, are so for\nsignificantly different reasons. For example,\n\n“autoproto_*” -- More than 20 mutexes share that preface, offering a natural fingerprint.\n\n“global\\setup_028746_mutexitem” -- Associated solely with known malware digital signers.\n\n“defined_setnocandy” -- After reading mutex names for a few hours this just sticks out like a\nsore thumb.\n\nOnly the first of the examples had the mutex associated with a vast majority of malware\nsamples. This implies that any fully automated association of a mutex to either benign or\nmalware samples will itself require complex fingerprinting and confidence models.\n\n## Hybrid Approach\n\nFull automation is always the ideal but it isn’t always necessary. With the appropriate tools\nit’s possible to enable a single researcher to continually review and categorize new mutexes.\nThe initial classifications to be used are “benign”, “malware”, or “statistical”. Meaning that the\nmutex either itself indicates a benign or malware sample, or that the mutex alone is not\nenough to make a determination and the statistical ratio of benign to malware is the best it\ncan offer.\n\n\n-----\n\nThe backlog of already collected mutexes is too great for a small team of researchers to\nmeaningfully tackle without some kind of ranking system. Luckily, the most objective piece of\ndata collected about each mutex, how many samples were classified benign vs. malware,\nhas all the information necessary to ensure that the researchers’ tackle the low hanging fruit\nfirst.\n\n## Case Study: “jhdheruhfrthkgjhtjkghjk5trh”\n\nWith over hundreds of thousands of malware associations, this specific mutex is associated\nexclusively with the Net-worm:W32/Allaple malware family which has been around since\n2006 but continues to propagate and reinvent itself through the years. Though the fact that\nthe malware writer obviously named the mutex by rolling their face on the keyboard made it\nobvious before we'd done any further analysis that we’d found a unique identifier within the\nbinaries.\n\nThis malware is well documented as a powerful polymorphic worm that encrypts itself\ndifferently every time it propagates. The evasive nature of this malware family leads to a\ndifferent file hash, import hash, and only a 20% average SSDeep hash overlap between the\nsamples. But because the mutex name is set at compile time, the mutex itself offers a\ncommon thread between all of the samples we collected and analyzed.\n\nHowever, this particular mutex was associated with only a recent subset of the Allaple family.\n\n## Lessons Learned\n\nUnlike many other avenues of research and classification, mutex name based associations\nprovides an almost trivial means of uniquely identifying common code blocks and thereby\nmalware families.\n\n## Case Study: “jhdgcjhasgdc09890gjasgcjhg2763876uyg3fhg”\n\nThe first thing our researchers noticed was the similarity between this mutex name and the\nprevious one. While programmatic analysis would have a hard time associating the two, it's\nobvious to a human that the same face rolling technique was used to name this mutex. The\nauthor simply rolled around a bit more.\n\nQuick follow up analysis revealed that this mutex was also associated with the Allaple\nmalware family. More interestingly, it was another, non-overlapping, subset of the Allaple\nfamily. Several hypotheses followed directly from this observation.\n\n1. The same author created both variants.\n2. The second mutex was created at some point after the first.\n3. The underlying functionality protected by the first mutex was removed or altered so\n\nsignificantly that a new mutex was required to provide the necessary protection.\n4. This functionality is not available and/or used generally in the malware community.\n\n\n-----\n\n5. Each mutex exists across multiple variants.\n\nAbsolute proof for a few of these hypotheses may never be realized. However, and lucky for\n[us, the malware author was arrested in 2010 so several of the hypothesis can be verified.](http://nakedsecurity.sophos.com/2010/03/12/allaple-worm-author-sentenced-jail/)\n\nThe first is very likely due to the similarities present in the order of keys hit. Both begin with\n“jhd”. “jh” itself is more common than would be expected given that, with fingers on the home\nrow, it requires the right index finger to move and press another key before any other key is\nstruck. And “jh” is always followed by a key from the left side of the keyboard. These unique\nconsistencies make it extremely improbable that two different people named these mutexes.\n\nThe second mutex appears to be a concerted effort to make the mutex seem “more random”\nthan the first. It's immediately obvious that the author didn't move his fingers/hands much\nwhile typing the first. It’s obvious enough that the author likely noticed it when reworking this\nsection of code. It's highly improbable that one would see the second mutex and make a\nconcerted effort to make it appear “less random”. And, as can be quickly verified by\nsearching through standard virus detection logs, the mutexes did in fact appear in the\nhypothesized order.\n\nThe third is likely due to the lack of overlap between mutex names. However, the research\nnecessary to conclusively prove this hypothesis would be very time consuming and provide\nlittle other benefit.\n\nThe fourth is likely due to the mutexes only appearing in a single malware family. If this\nfunctionality were available in some more open source setting, and was of even moderate\nquality, we would expect to see it used in other malware families as well. As this functionality\nhas not migrated outside the Allaple family, either the quality of the code is bad (see: face\nrolling), or it's simply not available to other malware developers.\n\nThe fifth is very likely as a change to the specific functionality these mutexes protect, with\nevery change to any functionality, is simply not a practical method of development. And\nindeed, as with the second hypothesis, standard virus detection logs prove that each of\nthese mutexes do span multiple variants of the worm.\n\n## Lessons Learned\n\nMutex names provide a window into the entire development process and timeline for\nmalware. Idiosyncrasies of the malware author become apparent, the evolution can be\ntraced, the availability or quality of code deduced, and reuse of functionality made clear with\na simple mutex. No other currently used method of analysis offers such a personal view into\nmalware development.\n\n## Conclusion\n\n\n-----\n\nMutex name analysis as a whole offers a unique look into the results of any sample\nclassification system and the malware therein. While the research may never result in a fully\nautomated decision system, it has been proven that researchers employing a hybrid\napproach to analysis will be able to provide critical and timely information to support the\ncontinual improvement of the classification system as a whole.\n\nFrom edge case to systematic misclassifications, mutex usage is even more generally the\n[canary in a coal mine than was previously realized.](http://resources.infosecinstitute.com/mutexes-analysis-part-one/)\n\n## Anecdotes\n\nWhile tedious and time consuming, combing through mutex names did come with more than\na few good laughs. After nearly as much debate as some of the real research, we’ve whittled\nthe list down to our favorites (For the curious, these are all malware mutexes). Enjoy.\n\n**_Pluguin - When penguins and wall sockets mate. Development environments don’t have_**\nspell check but, maybe they should.\n\n**_senna spy rock in rio 2001 virus - Subtlety. Overwhelming. There were many variations on_**\nthis one, Senna’s obviously proud of his work.\n\n**_chinese-hacker-2 - We’re not sure which is worse: that this is a legitimate signature or a sad_**\nframe job. Either way, somebody needs their computer privileges revoked.\n\n**_mutexpolesskayaglush*.*svchost.comexefile\\shell\\open\\command %1 %*@ - Putting_**\nshell code in a mutex name is right on the border of brilliant and insane. We’ll leave that\ndetermination to the reader.\n\n**_mr_coolface - Really, not so much, no._**\n\n**_don't stop me! i need some money! -_** [http://www.monster.com/ - don’t say we never did](http://www.monster.com/)\nanything for you.\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-08-14 - Hunting the Mutex.pdf"
    ],
    "report_names": [
        "2014-08-14 - Hunting the Mutex.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536018,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1653774697,
    "ts_modification_date": 1653774697,
    "files": {
        "pdf": "https://archive.orkl.eu/3b713f7c26f6e5d0a98c85d58667d3747eb3e6a1.pdf",
        "text": "https://archive.orkl.eu/3b713f7c26f6e5d0a98c85d58667d3747eb3e6a1.txt",
        "img": "https://archive.orkl.eu/3b713f7c26f6e5d0a98c85d58667d3747eb3e6a1.jpg"
    }
}