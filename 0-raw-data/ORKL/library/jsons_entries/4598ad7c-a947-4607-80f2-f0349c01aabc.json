{
    "id": "4598ad7c-a947-4607-80f2-f0349c01aabc",
    "created_at": "2022-10-25T16:48:22.759588Z",
    "updated_at": "2025-03-27T02:05:27.361298Z",
    "deleted_at": null,
    "sha1_hash": "1116413c96b35c3c8f3d404bdabbec46b375eaaa",
    "title": "",
    "authors": "",
    "file_creation_date": "2015-10-02T15:07:45Z",
    "file_modification_date": "2015-10-02T15:07:45Z",
    "file_size": 1175174,
    "plain_text": "## Lab Analysis \n\n# Webmail Server APT:\n\n## A New Persistent Attack Methodology Targeting Microsoft\n Outlook Web Application (OWA)\n\n\n#### Written by:  Yonatan Striem Amit CTO Co Founder\n\n\n-----\n\n### A New Approach to APT \n\nThis document analyzes a real and unique APT technique detected by the Cybereason\n\nplatform in one of our customer’s environment. The attack involved a malicious module\n\nthat was loaded onto Microsoft Outlook Web Application (OWA), an internet-facing web\nmail server, which enabled the attackers to record authentication credentials and be\n\nprovided with complete backdoor capabilities. By using this approach, the hackers\n\nmanaged to collect and retain ownership over a large set of credentials, allowing them\n\nto maintain persistent control over the organization's environment.\n\n### Introduction \n\nA Cybereason POC customer suspected that it had an infected server due to several\n\nbehavioral abnormalities spotted by its security team. They reached out to\n\nCybereason and together we decided to deploy our platform across the customer’s\n\nentire environment of 19,000 endpoints.\n\n### Discovering a Suspicious DLL \n\nWithin several hours, the Cybereason platform found a suspicious DLL loaded into the\n\nOutlook Web App (OWA) server (a webmail component of Microsoft Exchange Server),\n\nwith several interesting characteristics. Although it had the same name as another\n\nbenign DLL, the suspicious DLL went unsigned and was loaded from a different\n\n##### 2\n\n\n-----\n\ndirectory. Since OWA servers typically load only legitimately signed DLLs, the\n\nCybereason behavioral engine immediately elevated this event to a suspicion.\n\n### Backdooring a world-accessible server in the Demilitarized Zone \n\nContrary to other web servers that typically have only a web interface, OWA is unique: it is\n\na critical internal infrastructure that also faces the Internet, making it an intermediary\n\nbetween the internal, allegedly protected DMZ, and the web. The customer was using\n\nOWA to enable remote user access to Outlook. This configuration of OWA created an\n\nideal attack platform because the server was exposed both internally and externally.\n\nMoreover, because OWA authentication is based on domain credentials, whoever gains\n\n**_access to the OWA server becomes the owner of the entire organization’s domain_**\n\n**_credentials. Later, we will see how the attacker extracted credentials from the OWA_**\n\nserver using their malicious module.\n\n### Persistence, Hiding and Loading \n\nThe hackers installed a backdoored malicious OWAAUTH.dll which was used by OWA\n\nas part of the authentication mechanism, and was responsible for authenticating users\n\nagainst the Active Directory (A/D) server used in the environment. In addition, the\n\nmalicious OWAAUTH.DLL also installed an ISAPI filter into the IIS server, and was\n\nfiltering HTTP requests.\n\n##### 3\n\n\n-----\n\nThis enabled the hackers to get all requests in cleartext after SSL/TLS decryption. The\n\nmalware replaced the OWAAUTH by installing an IIS filter in the registry, which enabled the\n\nmalware to automatically load and persist on every subsequent server restart.\n\nThe final touch was the hackers choosing the .NET assembly cache. This folder was used to\n\nstore locally compiled native binaries in order to accelerate the loading and execution\n\nof .NET applications. These locally compiled binaries were only used on the computer in\n\nwhich they were generated, and thus had no reputation or digital signatures. It is interesting\n\nto note that the hackers chose this folder exactly for that reason, in order to avoid human\ndriven inspection. The hackers attempted to fool the hunters into thinking that it was simply\n\nanother locally generated file, as if they were Obi-Wan practicing a little Jedi magic,\n\nconvincing the defender to think: these are not the files you’re looking for, move along.\n\n### Hooking the Request Handlers\n\nOnce loaded, the DLL implemented an HTTP Module and registered two request handling\n\nfunction callbacks on its initialization:\n\n- Application_BeginRequest() registered as BeginRequest - Not implemented\n\n- Application_EndRequest() registered as EndRequest - Called at the end of the request\n\nhandling chain. Implements the main malware logic.\n\nAt the end of each HTTP request handling in the OWA server, Application_EndRequest()\n\nwas called, executing the malware backdoor main function.\n\n##### 4\n\n\n-----\n\n### Capturing OWA Authentication Tokens \n\nThe hacker’s first goal was to use the visibility they had gained into the OWA authentication\n\nprocess to steal the passwords of users logging into OWA - namely everyone.\n\nWhile most security professionals understand the sensitivity of data in the A/D server, the\n\nOWA server serves as a focal point for the exact same sensitive data.\n\nWhenever Application_EndRequest() was called, it read the request variables using the\n\nRequest sub-object of the HttpApplication object. It then checked whether there were two\n\nvariables named “username” and “password”. These variables were passed in the request\n\nquery URL whenever a user logged into the OWA service.\n\nIf the function found the username and password, it recorded them together with a\n\ntimestamp, the client host address, and the client user agent to an encrypted file named\n\nlog.txt, stored in C:\\.\n\nThe encryption algorithm was DES, implemented by the DESCryptoServiceProvider class,\n\nwith both a password and IV values of the ASCII string “12345678”. Following this\n\ndiscovery, we wrote a decryption tool for this file, and found more than 11,000(!) user/\n\npassword pairs. This treasure trove essentially gave the hackers complete access to\n\n**every identity and therefore every asset in the organization.**\n\n##### 5\n\n\n-----\n\n### A Complete Backdoor \n\nIn order to get access to the usernames and passwords, and to ensure that the hackers\n\ncould gain more control over the environment, the malware also possessed covert\n\nbackdoor functionalities. The attacker used HTTP request query URL variables in order to\n\nuse the backdoor functionality remotely.\n\nThe malware was searching every incoming request for a special parameter, in our case\n\n“<CustomerName>XXX”. When the parameter was found, the backdoor functionality\n\nwould parse the remainder of the parameters. Naturally, the fact that the hacker\n\n**embedded the customer name in the parameters proves that this malware was tailored**\n\n**for this particular target.**\n\nIf the variable “<CustomerName>XXX” was found in the HTTP query URL, the code also\n\nlooked for the two other variables - Z1 and Z2. Together, they represented a function call\n\nwith specific parameters, as “<CustomerName>XXX” represented a function ID of a\n\nsingle ASCII character with possible values of “A” through “Q,” while Z1/Z2 were\n\nparameters of the function.\n\n##### 6\n\n\n-----\n\nIf the called function returned a value to the client, it would be in the form of a string\n\nformatted as: “->|ResultData|<-”, with ResultData as the returned data. The formatted result\n\nstring would then be returned to the client through the HTTP response data.\n\nAs you can see in the following functionality map (Table-1), some basic backdoor\n\ncapabilities were implemented in the malware. Also, there were several SQL control\n\nfunctions, enabling the attacker to read, write and execute command on SQL servers inside\n\nand outside the targeted organization.\n\nNaturally, the facilities below allowed the hacker to write and execute any code on the OWA\n\nserver, and by using the previously collected passwords, impersonate any user and perform\n\nlateral movement.\n\n##### 7\n\n\n-----\n\n##### 8\n\n\n-----\n\n##### 9\n\n\n-----\n\n### Conclusions \n\nThe hackers in this case managed to gain a foothold into a highly strategic asset: the\n\nOWA server. Almost by definition, OWA requires organizations to define a relatively lax set\n\nof restrictions; and in this case, OWA was configured in a way that allowed internet-facing\n\naccess to the server. This enabled the hackers to establish persistent control over the\n\nentire organization’s environment without being detected for a period of several months.\n\nBy combining endpoint level visibility and the Cybereason Malop hunting engine’s\n\ncontextual analysis, the organization was finally able to visualize the entire attack and\n\npinpoint the root cause of the threat.\n\nOur customer’s instincts were spot on when his “Spidey Sense” told him there was more to\n\nthe OWA server’s odd behavior than what met the eye, but it would have likely taken him\n\nweeks of uninterrupted analysis to investigate the situation manually. Only by automating\n\ndetection and analysis was this clever hack detected, understood, and contained.\n\nHerein lies the magic of Endpoint Detection and Response (EDR). The Cybereason\n\nplatform immediately pinpointed how the OWA server was compromised and provided\n\nclear visibility to the affected machine, enabling our customer to clean and fix it.\n\nCybereason was designed to empower smart people with good instincts to be top-notch\n\ncyber-defenders, and this is a perfect example of what that looks like.\n\n##### 10\n\n\n-----\n\n## Cybereason:  Let the Hunt Begin.\n\n### About Cybereason\n\n\n222 Berkeley Street\n13[th] Floor\nBoston, MA 02116 USA\nwww.cybereason.com\n\n\nCybereason was founded in 2012 by a team of ex-military cybersecurity\nexperts to revolutionize detection and response to cyber attacks. The\nCybereason Malop Hunting Engine identifies signature and non-signature\nbased attacks using big data, behavioral analytics, and machine learning. The\nIncident Response console provides security teams with an at-your-fingertip\nview of the complete attack story, including the attack’s timeline, root cause,\nadversarial activity and tools, inbound and outbound communication used by\nthe hackers, as well as affected endpoints and users. This eliminates the need\nfor manual investigation and radically reduces response time for security\nteams. The platform is available as an on premise solution or a cloud-based\nservice. Cybereason is privately held and headquartered in Boston, MA with\noffices in Tel Aviv, Israel.\n\n© All Rights Reserved. Cybereason 2015\n\n##### 11\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2015/2015.10.03.Webmail_Server_APT/Cybereason-Labs-Analysis-Webmail-Sever-APT.pdf"
    ],
    "report_names": [
        "Cybereason-Labs-Analysis-Webmail-Sever-APT"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716502,
    "ts_updated_at": 1743041127,
    "ts_creation_date": 1443798465,
    "ts_modification_date": 1443798465,
    "files": {
        "pdf": "https://archive.orkl.eu/1116413c96b35c3c8f3d404bdabbec46b375eaaa.pdf",
        "text": "https://archive.orkl.eu/1116413c96b35c3c8f3d404bdabbec46b375eaaa.txt",
        "img": "https://archive.orkl.eu/1116413c96b35c3c8f3d404bdabbec46b375eaaa.jpg"
    }
}