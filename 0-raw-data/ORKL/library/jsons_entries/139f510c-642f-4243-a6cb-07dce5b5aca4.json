{
    "id": "139f510c-642f-4243-a6cb-07dce5b5aca4",
    "created_at": "2023-01-12T15:10:54.689659Z",
    "updated_at": "2025-03-27T02:05:46.289995Z",
    "deleted_at": null,
    "sha1_hash": "d27b9677792c412b783273edc63ee413cc70430a",
    "title": "2022-10-31 - Banking Trojan Techniques- How Financially Motivated Malware Became Infrastructure",
    "authors": "",
    "file_creation_date": "2022-11-28T18:57:17Z",
    "file_modification_date": "2022-11-28T18:57:17Z",
    "file_size": 1790037,
    "plain_text": "# Banking Trojan Techniques: How Financially Motivated Malware Became Infrastructure\n\n**[unit42.paloaltonetworks.com/banking-trojan-techniques/](https://unit42.paloaltonetworks.com/banking-trojan-techniques/)**\n\nOr Chechik October 31, 2022\n\nBy [Or Chechik](https://unit42.paloaltonetworks.com/author/or-chechik/)\n\nOctober 31, 2022 at 6:00 AM\n\n[Category: Malware](https://unit42.paloaltonetworks.com/category/malware-2/)\n\nTags: [Banking Trojan,](https://unit42.paloaltonetworks.com/tag/banking-trojan/) [Cortex,](https://unit42.paloaltonetworks.com/tag/cortex/) [Cortex XDR,](https://unit42.paloaltonetworks.com/tag/cortex-xdr/) [Dridex,](https://unit42.paloaltonetworks.com/tag/dridex/) [Emotet,](https://unit42.paloaltonetworks.com/tag/emotet/) [IcedID,](https://unit42.paloaltonetworks.com/tag/icedid/) [kronos,](https://unit42.paloaltonetworks.com/tag/kronos/) process\ninjection, [Trickbot,](https://unit42.paloaltonetworks.com/tag/trickbot/) [Webinjects,](https://unit42.paloaltonetworks.com/tag/webinjects/) [WildFire,](https://unit42.paloaltonetworks.com/tag/wildfire/) [Zeus](https://unit42.paloaltonetworks.com/tag/zeus/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/banking-trojan-techniques/)\n\n## Executive Summary\n\nWhile advanced persistent threats get the most breathless coverage in the news, many\nthreat actors have money on their mind rather than espionage. You can learn a lot about the\ninnovations used by these financially motivated groups by watching banking Trojans.\n\nBecause attackers constantly create new techniques to evade detection and perform\nmalicious acts, studying monetarily motivated malware can help defenders understand threat\nactor tactics and protect organizations more effectively. Some of the banking Trojans\n\n\n-----\n\ndescribed here are historically known for being financial malware, but now they re primarily\nused as infrastructure to deliver other malware. Which is to say, by preventing techniques\nused by banking Trojans, you can also stop other types of threats.\n\nWe’ll survey techniques used by notorious banking Trojan families to evade detection, steal\nsensitive data and manipulate data. We’ll also describe how those techniques can be\nblocked. These families include Zeus, Kronos, Trickbot, IcedID, Emotet and Dridex.\n\n[Palo Alto Networks customers are protected from such attacks using Cortex XDR and](https://www.paloaltonetworks.com/cortex/cortex-xdr)\n[WildFire.](https://www.paloaltonetworks.com/products/secure-the-network/wildfire)\n\n\nBanking Trojan families' techniques\ndiscussed\n\n## Table of Contents\n\nWhat Are Webinjects?\n\nHow to Detect Webinjects\n\n\n[Zeus,](https://unit42.paloaltonetworks.com/tag/zeus/) [Kronos,](https://unit42.paloaltonetworks.com/tag/kronos/) [Trickbot,](https://unit42.paloaltonetworks.com/tag/trickbot/) [IcedID,](https://unit42.paloaltonetworks.com/tag/icedid/) [Emotet,](https://unit42.paloaltonetworks.com/tag/emotet/)\n[Dridex](https://unit42.paloaltonetworks.com/tag/dridex/)\n\n\nInfecting Web Browsers During Process Creation\n\nHow to Prevent Attempts to Infect Web Browsers During Process Creation\n\nNamed Pipe Communication Between Injected Processes\n\nHow to Prevent Named Pipe Communication Between Injected Processes\n\nHeaven’s Gate Injection Technique\n\nHow to Prevent Heaven's Gate\n\nEvasive Process Hollowing by Entrypoint Patching\n\nHow to Prevent Evasive Process Hollowing by Entrypoint Patching\n\nPE Injection\n\nHow to Prevent PE Injection\n\nProcess Injection via Hooking\n\nHow to Prevent Injection via Hooking\n\nAtomBombing Injection Technique\n\nHow to Prevent AtomBombing and its Variants\n\nConclusion\n\nIndicators of Compromise\n\n## What Are Webinjects?\n\nWebinjects are modules that can inject HTML or JavaScript before a web page is rendered,\nand are often used to trick users. They are known to be abused by banking Trojans, as well\nas being employed to steal credentials and manipulate form data inside web pages. In most\nbanking Trojan families, there is at least one webinjects module.\n\n\n-----\n\nAn early stager of the banking Trojan usually injects the banking Trojan s main bot into a\nWindows process, and that process injects the webinjects module into the machine’s\navailable web browser processes as shown in Figure 1.\n\nFigure 1. Trickbot goes through processes one by one to find browsers to inject with its\nwebinjects module, using a stealthy technique known as reflective injection.\nThe webinjects module hooks the API calls responsible for sending, receiving or encrypting\ndata sent to a web server. By intercepting the data before it is encrypted, the malware can\nread HTTP-POST headers and manipulate them on the fly.\n\n\n-----\n\nFigure 2. Trickbot webinjects module placing hooks based on the browser.\n\n\n-----\n\nFigure 3. Trickbot placing hooks on wininet.dll functions.\nBy fully controlling the HTTP headers just before the webpage is rendered, the malware can\ncompletely modify the forms and fool the user. The malware may inject HTML or JavaScript\ncode to trick the user into inserting sensitive information, such as a PIN code or credit card\nnumber, enabling the malware to collect it. The malware can extract this information and\nsend it to its command and control (C2) server without actually sending the forged headers\nto the targeted web page server.\n\nChrome (chrome.dll) Firefox (nspr3.dll / nspr4.dll) Internet Explorer / Edge (Wininet.dll)\n\nssl_read PR_Read HttpSendRequest\n\nssl_write PR_Connect InternetCloseHandle\n\nPR_Close InternetReadFile\n\nPR_Write InternetQueryDataAvailable\n\nHttpQueryInfo\n\n\n-----\n\nInternetWriteFile\n\nHttpEndRequest\n\nInternetQueryOption\n\nInternetSetOption\n\nHttpOpenRequest\n\nInternetConnect\n\n_Table 1. Frequently hooked API functions._\n\n### How to Detect Webinjects\n\nThis technique can be prevented by detecting an injection into a web browser process. The\ninjected thread calls the NtProtectVirtualMemory function where the NewAccessProtection\nargument is PAGE_EXECUTE_READWRITE and the BaseAddress argument is an address\nto a library function targeted by banking Trojans.\n\nFor example, Trickbot uses both VirtualProtect and VirtualProtectEx in its various versions.\nInspecting NtProtectVirtualMemory calls covers both.\n\nSome banking Trojans opt to avoid code injection. Instead, they suspend the remote process\nthreads and install the hooks remotely. Inspecting remote NtProtectVirtualMemory calls can\ndetect this variant technique.\n\nFigure\n\n4. NtProtectVirtualMemory prototype.\n\n\n-----\n\n## Infecting Web Browsers During Process Creation\n\nSome banking Trojans aim to infect a target process as soon as it is launched, by injecting\ncode into a predicted parent process of the real target. Once the banking Trojan executes in\nthe context of the parent process, it hooks process creation library functions and waits until\nthe real target is created.\n\nInside the hook, the banking Trojan manipulates the process creation flow. Then, for\nexample, it initializes the webinjects module inside the remote process. The explorer.exe and\nruntimebroker.exe parent processes are frequently abused for this goal, as they usually\nlaunch the real targets.\n\nFor instance, the Karius banking Trojan used this technique by injecting code into\nexplorer.exe and hooking CreateProcessInternalW. The Trojan’s hook handler looked for a\nspawned web browser process and injected the malicious webinjects module into it.\n\n### How to Prevent Attempts to Infect Web Browsers During Process Creation\n\nThis technique can be prevented by looking for an injection into explorer.exe or\nruntimebroker.exe, where the injected thread hooks process creation functions like\nNtCreateUserProcess, NtCreateProcessEx, CreateProcessInternalW, CreateProcessA or\nCreateProcessW.\n\n## Named Pipe Communication Between Injected Processes\n\nMany banking Trojans use named pipes to communicate with various processes under the\nthreat actor’s control. To do this, they inject their main bot into a Windows process, and then\ninject their other modules into different processes according to the module’s purpose. They\nthen establish communication between the different processes using named pipes.\n\nFor example, Trickbot injects the main bot into svchost.exe. It creates a named pipe server\n[and reflectively injects the webinjects module into web browsers. This injected module](https://attack.mitre.org/techniques/T1620/)\nconnects to the same named pipe as a client to communicate to the main bot and deliver the\nfetched credentials to the C2 server.\n\n\n-----\n\nFigure 5. Trickbot named pipe server.\n\n### How to Prevent Named Pipe Communication Between Injected Processes\n\nThis technique can be prevented by inspecting named-pipe events. An injected thread\ncreates a named pipe inside a Windows process, and then another injected thread that lives\ninside a web browser attempts to connect to that same named pipe.\n\n## Heaven’s Gate Injection Technique\n\nHeaven's Gate is a technique used by malware, which enables a 32-bit (WoW64) process to\nexecute 64-bit code by performing a far jump/call using segment selector 0x33. Modern\nmalware uses Heaven's Gate to inject into both 64-bit and 32-bit processes from a single 32bit process on x64 systems. This bypasses WoW64 API hooks, it hinders analysis on some\ndebuggers, and it fails emulation on some sandboxes.\n\nEven though this method is old, it is still effective and frequently used.\n\n[Trickbot and Emotet loaders use Heaven's Gate for process hollowing from a WoW64](https://attack.mitre.org/techniques/T1055/012/)\nprocess into a 64-bit svchost.exe (For more about process hollowing, see the section on\nEvasive Process Hollowing By Entrypoint Patching below) The architecture of these two\n\n\n-----\n\nbanking Trojans dictates that their main bot persists inside svchost.exe while the web content\nmanipulation and credential stealing modules live inside the browser processes.\n\nFigure\n\n6. Emotet using Heaven's Gate in its Microsoft Outlook Messaging API (MAPI) module.\n\n### How to Prevent Heaven's Gate\n\nA WoW64 process usually goes through the wow64cpu.dll to perform the transition to x64\nCPU mode. Heaven's Gate does this transition manually.\n\nPrevention methods can find Heaven's Gate by inspecting whether a WoW64 process\nsystem call didn’t go through the wow64cpu.dll. This can be done by placing hooks on critical\nAPIs, generating a stack trace and inspecting the stack trace for wow64cpu.dll.\n\n\n-----\n\nFigure 7. WoW64’s normal syscall flow.\n\n## Evasive Process Hollowing by Entrypoint Patching\n\nProcess hollowing is a process injection technique that creates a new legitimate process in a\nsuspended mode, unmaps its main image and replaces it with malicious code. The malicious\ncode is written into the newly created process and the suspended thread context instruction\npointer is changed using NtGetContextThread/NtSetContextThread.\n\nSecurity product vendors check for main image unmapping combined with the usage of\nNtGetContextThread/NtSetContextThread to detect process hollowing.\n\nA known technique for evading detection is to patch the process entry point with a small\njump that redirects execution to the payload without actually using\nNtGetContextThread/NtSetContextThread functions or unmapping the main image. For\nexample, Trickbot and Kronos have both used this technique.\n\nKronos mapped a suspended svchost.exe into its own process and patched it in its own\nmemory address space. Similar to other banking Trojans, Kronos' main module ran within\nsvchost.exe and orchestrated the whole operation from the remote svchost.exe process.\n\nTrickbot implemented process hollowing by first using VirtualProtectEx on the process\nentrypoint, and then writing the hook stub using WriteProcessMemory.\n\n\n-----\n\nFigure 8. Kronos mapping svchost.exe and patching its entrypoint.\n\n9 Kronos hook stub template – x86 opcodes for push and ret\n\n\nFigure\n\n\n-----\n\n### How to Prevent Evasive Process Hollowing by Entrypoint Patching\n\nThis technique can be prevented either by inspecting whether the address argument\nprovided to the calls of NtWriteVirtualMemory or NtProtectVirtualMemory is a remote process\nentry point or by detecting suspicious remote mapping and reading of svchost.exe memory.\n\n## PE Injection\n\nCommon injection methods used by banking Trojans involve writing a mapped PE into a\nremote process using WriteProcessMemory. Some malware families try to obscure the call\nby wiping artifacts from the buffer, such as wiping the PE header.\n\nFor example, Zeus variants use this technique to inject themselves into other processes,\nallowing them to stay hidden, as well as to perform webinjects and to perpetrate financial\ndata theft.\n\nFigure 10. Zeus injection code from its leaked source code.\n\n### How to Prevent PE Injection\n\n\n-----\n\nThis technique can be prevented by inspecting the buffer sent to NtWriteVirtualMemory for\nexecutable artifacts.\n\n## Process Injection via Hooking\n\nHooking can be used as an injection technique. Injecting a banking Trojan’s main payload\ninto a legitimate-looking process maintains stealth and helps avoid endpoint protection\ndetection.\n\nThis technique utilizes hooking to get code execution, usually by hooking a frequently called\nAPI function with a jump to a payload/shellcode. This avoids calling any suspicious APIs\noften used in code injection techniques like CreateRemoteThread or NtSetContextThread.\n\nFor instance, IcedID injects its main bot into a hollowed instance of svchost.exe using API\n[hooking. This is also known as the ZwClose technique (ZwClose was the hooked API in](https://securityintelligence.com/diving-into-zberps-unconventional-process-injection-technique/)\nZberp, the first to employ this injection technique in the wild).\n\nThe injection flow of IcedID is slightly different than that of Zberp. It first hooks\nNtCreateUserProcess and then calls CreateProcessA to create svchost.exe without any\nspecial parameters or argument. In a regular flow, the newly created svchost.exe should\nterminate right away.\n\nFigure 11. IcedID initiates svchost.exe hooking.\n\n\n-----\n\nFigure 12. IcedID hooks NtCreateUserProcess.\nHowever, because IcedID hooked NtCreateUserProcess, the hook handler is called right\nafter the call to CreateProcessA. In the handler, it performs the following activities:\n\nUnhooks NtCreateUserProcess\nCalls NtCreateUserProcess (which creates svchost.exe)\nDecompresses a local buffer that contains the payload to inject using\nRtlDecompressBuffer\nAllocates memory for the payload at the remote svchost.exe process\nWrites the payload into the remote svchost.exe using NtAllocateVirtualMemory and\nZwWriteVirtualMemory\n\nFor the execution, IcedID hooks RtlExitUserProcess in the newly created svchost.exe with a\njump stub to the payload. As mentioned, svchost.exe was created without any parameters\nand it will try to exit. However, due to the IcedID hook, it will jump to the payload.\n\nFigure 13. IcedID hooks RtlExitUserProcess.\n\n### How to Prevent Injection via Hooking\n\n\n-----\n\nThis technique can be prevented by inspecting calls to NtProtectVirtualMemory and\nNtWriteVirtualMemory. The provided address argument for NtProtectVirtualMemory is an\nexported function from one of the Windows libraries, and the NtWriteVirtualMemory written\nbuffer is a hooking stub. In both cases, the remote process has to be a known injection\ntarget.\n\n## AtomBombing Injection Technique\n\nAtomBombing is a technique that allows malware to inject code while avoiding calling\nsuspicious APIs that security vendors are watching. Dridex uses a slightly modified\nAtomBombing technique that injects one of its stages into a Windows process (usually\nexplorer.exe) and employs various steps to cause financial data theft.\n\nMalware using the AtomBombing technique first writes the payload into the global atom\ntable, which can be accessed by all processes. They then dispatch an asynchronous\nprocedure call (APC) to the APC queue of a target process thread using\nNtQueueApcThread, forcing the target process to call GlobalGetAtomA.\n\nThe target thread then retrieves the payload from the global atom table and inserts it into a\nread/write (RW) region inside the target process memory space (a code cave inside the\nkernelbase.dll data section). The payload has to be split into NULL-terminated strings and an\natom is created for each string.\n\nFor the execution, the injector process dispatches another APC using NtQueueApcThread to\nforce the remote process to execute NtSetContextThread. The injected process then calls\nNtSetContextThread, which invokes a return-oriented programming (ROP) chain that\nallocates execute/read/write (RWX) memory. The ROP chain then copies the payload from\nthe RW region into the newly allocated RWX region, and lastly, executes it.\n\nThe unique idea behind AtomBombing is the write-primitive, which allows writing to the\nremote process using atom tables and APC.\n\nDridex uses a variation of AtomBombing that queues an APC to call memset to clean an RW\nregion in ntdll.dll. Then, it copies the payload and its import table into the target process\nusing the same write technique into the ntdll.dll RW region.\n\nFor the execution, Dridex modifies the copied payload memory into executable memory\nusing NtProtectVirtualMemory. Then it hooks GlobalGetAtomA by calling\nNtProtectVirtualMemory and by using the same write primitive. Finally, it queues an APC into\nthe patched GlobalGetAtomA to get the payload running.\n\n\n-----\n\nFigure 14. AtomBombing proof of concept code.\n\n### How to Prevent AtomBombing and its Variants\n\nThese techniques can be prevented by inspecting whether the arguments provided to\nNtQueueApcThread/NtSetContextThread calls point to a suspicious API – the APC routine\nargument in the case of NtQueueApcThread, or the new instruction pointer in the context\nargument in the case of NtSetContextThread. Both API calls have to be called into a remote\nprocess.\n\n## Conclusion\n\nThreat actors who are in it for the money use a wide range of malware techniques for\ninjection and financial fraud, and they are always looking for new ways to develop evasive\ntechniques. We have explored some of the more interesting banking Trojan techniques and\n\n\n-----\n\nhow they re used to steal victims sensitive data. And finally, we describe how these\ntechniques can be used to detect malicious behavior, so it can be prevented.\n\nPalo Alto Networks customers using Cortex XDR receive protections from such attacks in\ndifferent layers, including the following:\n\nLocal Analysis Machine Learning module\nBehavioral Threat Protection\nBehavioral indicators of compromise (BIOC) and Analytics BIOCs rules\n\nThese layers identify the tactics and techniques that banking Trojans use at different stages\nof their execution.\n\nPalo Alto Networks customers also receive protections against the attacks discussed here\nthrough the WildFire cloud-delivered security subscription for the Next-Generation Firewall.\n\n## Indicators of Compromise\n\nTrickbot\n\ntestnewinj32Dll.dll:\n4becc0d518a97cc31427cd08348958cda4e00487c7ec0ac38fdcd53bbe36b5cc\nWebinjects:\nef6603a7ef46177ecba194148f72d396d0ddae47e3d6e86cf43085e34b3a64d4\nEmotet: dd20506b3c65472d58ccc0a018cb67c65fab6718023fd4b16e148e64e69e5740\nKronos: aad98f57ce0d2d2bb1494d82157d07e1f80fb6ee02dd5f95cd6a1a2dc40141bc\nZeus: 0f409bc42d5cd8d28abf6d950066e991bf9f4c7bd0e234d6af9754af7ad52aa6\nIcedID: 358af26358a436a38d75ac5de22ae07c4d59a8d50241f4fff02c489aa69e462f\nDridex: ffbd79ba40502a1373b8991909739a60a95e745829d2e15c4d312176bbfb5b3e\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-10-31 - Banking Trojan Techniques- How Financially Motivated Malware Became Infrastructure.pdf"
    ],
    "report_names": [
        "2022-10-31 - Banking Trojan Techniques- How Financially Motivated Malware Became Infrastructure.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536254,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1669661837,
    "ts_modification_date": 1669661837,
    "files": {
        "pdf": "https://archive.orkl.eu/d27b9677792c412b783273edc63ee413cc70430a.pdf",
        "text": "https://archive.orkl.eu/d27b9677792c412b783273edc63ee413cc70430a.txt",
        "img": "https://archive.orkl.eu/d27b9677792c412b783273edc63ee413cc70430a.jpg"
    }
}