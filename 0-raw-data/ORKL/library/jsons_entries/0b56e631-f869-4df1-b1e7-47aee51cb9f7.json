{
    "id": "0b56e631-f869-4df1-b1e7-47aee51cb9f7",
    "created_at": "2023-01-12T15:01:41.89863Z",
    "updated_at": "2025-03-27T02:05:58.681853Z",
    "deleted_at": null,
    "sha1_hash": "565bcd0a8549cec21297002ef9dbcbcff39a67b5",
    "title": "2016-07-18 - Third time (un)lucky – improved Petya is out",
    "authors": "",
    "file_creation_date": "2022-05-28T04:55:47Z",
    "file_modification_date": "2022-05-28T04:55:47Z",
    "file_size": 614053,
    "plain_text": "# Third time (un)lucky – improved Petya is out\n\n**[blog.malwarebytes.com/threat-analysis/2016/07/third-time-unlucky-improved-petya-is-out/](https://blog.malwarebytes.com/threat-analysis/2016/07/third-time-unlucky-improved-petya-is-out/)**\n\nMalwarebytes Labs July 18, 2016\n\n[So far we dedicated several articles to the interesting, low-level ransomware called Petya,](https://blog.malwarebytes.com/?s=Petya)\nhijacking the boot sector. You can read about it here:\n\nhttps://blog.malwarebytes.com/threat-analysis/2016/05/petya-and-mischa-ransomwareduet-p1/ – Green Petya (version 2)\n[https://blog.malwarebytes.com/threat-analysis/2016/04/petya-ransomware/ – Red](https://blog.malwarebytes.com/threat-analysis/2016/04/petya-ransomware/)\nPetya (version 1)\n\nEach of those versions was using Salsa20 algorithm to encrypt Master File Table and make\ndisk inaccessible. However, due to the implementation bugs the intended algorithm was\nweakened – giving a chance to recover data.\n\nUnfortunately, as always in such cases, it is just a matter of time when cybercriminals get\ntheir cryptography fixed. Petya’s authors got it right at the third attempt. The currently\n[launched wave of this ransomware finally seems to have the proper Salsa20.](https://www.malwarebytes.com/ransomware)\n\n_[sample: c8623aaa00f82b941122edef3b1852e3](https://www.virustotal.com/en/file/ecc5cc62c8200954079191e586123522f88aa1414ae98908380176d75d2e7eab/analysis/)_\n\n## Behavioral analysis\n\nBehavior of Petya didn’t changed – we can see exactly the same UI like in the previous\ngreen edition:\n\n\n-----\n\n## Inside\n\nLet’s take a look at differences in the code. Using BinDiff we can spot, that not many\nfunctions have changed. However, those that were giving weak points to the previous edition\nare modified.\n\n### Salsa20\n\nFirst of all, let’s take a look the function s20_littleendian that was causing the major bug in\nthe last release. Due to it’s invalid implementation, only 8 out of 16 characters of the key\nwere meaningful and brutforcing the key was easier (working solution has been implemented\nby [procrash). Detailed explanation of this bug you can find in the updated post about the](https://twitter.com/procrash)\nprevious Petya – under the section “New Petya, new bug”.\n\nOn the left – you can see the implementation of the buggy function (from the previous\nedition). On the right – current, fixed implementation:\n\n\n-----\n\n**Explanation**\n\nThe old implementation was truncated – it didn’t used 32 bit values as it should – only added\na sign bit expansion to the 16 bit value:\n```\nstatic int16_t s20_littleendian(uint8_t *b)\n{\n return b[0] +\n     (b[1] << 8);\n}\n\n```\nNow, authors got the proper implementation, using 32 bits. So, the last bug in Salsa20 got\nfinally fixed, making implementation complete.\n\n### Key\n\nIn the first (red) version of Petya authors used 32 byte long Salsa key – that was, however,\ngenerated from the 16 byte long key, using a custom function to pre-process it and extend.\n\nIn the second – green edition, they gave up this idea and applied the original 16 byte long\nkey, without any modification.\n\nThis time, they changed mind and went back to the first solution of using 32 byte long key,\nyet with some improvements. Again we can see expand32 in the code (instead of expand16\nknown from the previous edition):\n\n\n-----\n\nWhen the victim insert the key for the verification, before using it as a Salsa20 key, it is\npreprocessed by a new algorithm (more complex than in case of Red Petya):\n\n## Conclusion\n\nNew edition shows that the project is reaching maturity – however, as we can read on the\nassociated onion page – it is still a beta version and we can expect that it will keep evolving.\nBelow – fragment of Petya’s RaaS website:\n\n\n-----\n\nWe are not yet sure about the distribution method, but probability is high, that also this time it\nis spam with a link leading to cloud storage. We strongly advise to be extra vigilant for the job\napplications coming this days – it proven to be a common cover for Petya/Mischa dropper.\nMore information about it you can find in our previous articles about Petya.\n\n## Appendix\n\n[Petya and Mischa – Ransomware Duet (Part 1)](https://blog.malwarebytes.com/threat-analysis/2016/05/petya-and-mischa-ransomware-duet-p1/)\n\nThis video cannot be displayed because your Functional Cookies are currently disabled.\n[To enable them, please visit our privacy policy and search for the Cookies section. Select](https://www.malwarebytes.com/privacy/#how-we-collect-information)\n_“Click Here” to open the Privacy Preference Center and select “Functional Cookies” in the_\nmenu. You can switch the tab back to “Active” or disable by moving the tab to “Inactive.”\nClick “Save Settings.”\n\n_This was a guest post written by Hasherezade, an independent researcher and programmer_\n_with a strong interest in InfoSec. She loves going in details about malware and sharing threat_\n_[information with the community. Check her out on Twitter @hasherezade and her personal](https://twitter.com/hasherezade)_\n_[blog: https://hshrzd.wordpress.com.](https://hshrzd.wordpress.com/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-07-18 - Third time (un)lucky – improved Petya is out.pdf"
    ],
    "report_names": [
        "2016-07-18 - Third time (un)lucky – improved Petya is out.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535701,
    "ts_updated_at": 1743041158,
    "ts_creation_date": 1653713747,
    "ts_modification_date": 1653713747,
    "files": {
        "pdf": "https://archive.orkl.eu/565bcd0a8549cec21297002ef9dbcbcff39a67b5.pdf",
        "text": "https://archive.orkl.eu/565bcd0a8549cec21297002ef9dbcbcff39a67b5.txt",
        "img": "https://archive.orkl.eu/565bcd0a8549cec21297002ef9dbcbcff39a67b5.jpg"
    }
}