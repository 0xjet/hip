{
    "id": "ecb59d57-0b5f-4047-a347-c15ab7ee9f64",
    "created_at": "2023-01-12T15:05:51.635915Z",
    "updated_at": "2025-03-27T02:15:46.129902Z",
    "deleted_at": null,
    "sha1_hash": "eaee202000cbeb7c493d2b55d367ae8e61116183",
    "title": "2021-06-30 - SMB Worm “Indexsinas” Uses Lateral Movement to Infect Whole Networks",
    "authors": "",
    "file_creation_date": "2022-05-28T16:13:22Z",
    "file_modification_date": "2022-05-28T16:13:22Z",
    "file_size": 375104,
    "plain_text": "# SMB Worm “Indexsinas” Uses Lateral Movement to Infect Whole Networks\n\n**guardicore.com/labs/smb-worm-indexsinas/**\n\n## Executive Summary\n\nGuardicore reveals new details in the Indexsinas SMB worm, also dubbed\nNSABuffMiner.\nThe attack campaign has been active since 2019 and is still under operation and\nmaintenance today.\n[Targeted devices are SMB servers vulnerable to EternalBlue (MS17-010). According to](https://en.wikipedia.org/wiki/EternalBlue)\nShodan, there are more than 1.2 million internet-facing SMB servers today.\nThe attack makes vast use of the Equation Group exploit kit, which includes\nEternalBlue exploit as well as the DoublePulsar backdoor.\nVictims include organizations in the healthcare, hospitality, education and\ntelecommunications sectors.\n\n[Guardicore Labs published a Github repository with all IOCs for this campaign as well as a](https://github.com/guardicore/labs_campaigns/tree/master/Indexsinas)\ndetection tool in Powershell.\n\nGuardicore Labs exposes new details of a massive attack campaign dubbed Indexsinas\n(also known as “NSABuffMiner”) which breaches networks through SMB servers and makes\n[aggressive use of lateral movement to propagate. The attack campaign targets Windows](https://www.guardicore.com/solutions/prevent-lateral-movement/)\nservers vulnerable to EternalBlue (MS17-010) and still infects machines worldwide.\n\n\n-----\n\nPropagation is achieved through the combination of an open source port scanner and three\nEquation Group exploits – EternalBlue, DoublePulsar and EternalRomance. These exploits\nare used to breach new victim machines, obtain privileged access, and install backdoors.\nThese exploits appear to still be highly successful despite being made public four years ago\nafter their first occurrence in the WannaCry and NotPetya cyberattacks. Indexsinas proves\nthat networks today are vulnerable to even non-targeted, opportunistic attack campaigns.\n\n## Attack Scope\n\nThe Indexsinas campaign started attacking Guardicore Global Sensors Network (GGSN) at\nthe beginning of 2019 and is still active today. Guardicore’s sensors have recorded over\n2,000 attacks since we began tracking the campaign.\n\nThe attacks originated from over 1,300 different sources, with each machine responsible for\nonly a few attack incidents. Source IPs – which are likely to be victims of the attacks\nthemselves – are mostly located in the U.S., Vietnam and India. Analysis of these IPs\ndemonstrate that various sectors were infected by Indexsinas including hotels, universities,\nmedical centers, government agencies and telecommunication companies.\n\n\n-----\n\nDark areas represent a higher number of source IPs\nThe Indexsinas attackers are careful and calculated. The campaign has been running for\nyears with the same command-and-control domain, hosted in South Korea. The C2 server is\nhighly protected, patched and exposes no redundant ports to the internet. The attackers use\na private mining pool for their cryptomining operations, which prevents anyone from\naccessing their wallets’ statistics.\n\n## Attack Flow\n\nThe attack flow consists of many batch scripts, executable payloads, downloaders, services\nand scheduled tasks. A prominent characteristic of the campaign is its competitiveness; it\nterminates processes related to other attack campaigns, deletes their file system residues\nand stops services created by other attack groups. It also attempts to evade detection by\nkilling programs related to process monitoring and analysis. In addition, it makes sure to\ndelete its own files immediately after execution.\n\n### Breach and the 1st Stage Downloader\n\nThe attack begins when a machine is breached through RPC or SMB servers, using the\nNSA’s exploitation tools. These exploits run code in the victim’s kernel and are capable of\ninjecting payloads to user-mode processes using asynchronous procedure calls (APCs).\nIndexsinas uses the exploits to inject code to either explorer.exe or lsass.exe. The injected\npayloads – EternalBlue.dll for 32-bit and DoublePulsar.dll for 64-bit – download three\nexecutable files from the main C2 server, as detailed in the table below.\n\n\n-----\n\n**Files Downloaded at Stage #1**\n\n**32-bit** **64-bit**\n\nc64.exe\n\niexplore.exe services.exe\n\n86.exe 64.exe\n\n### Persistence, Remote Access & C2 Reporting [86.exe, 64.exe]\n\nThe 86.exe and 64.exe files contain a whole, reversed DLL, a Portable Executable file turned\nupside down, with “ZM” at the end (instead of “MZ” at the beginning). This DLL is a remote\naccess tool (RAT), a version of [Gh0stCringe. It is dropped to a random path and loaded into](https://www.binarydefense.com/gh0stcringeformerly-cirenegrat/)\nmemory. Then, two of its exported functions are called – Install and MainThread. The first\ninstalls the RAT by creating a service under svchost, namely, it creates a registry key for the\nnew service with svchost.exe as its executable and uses the path to the DLL as the\n_ServiceDLL parameter. The second function performs the core functionality. It waits for_\ncommands from the C2 and reports machine information to it – computer name, malware\ngroup ID, installation date and CPU technical specs. The tool has various capabilities; it can\ndownload and execute additional modules, install them as services, and interact with the\nuser by opening message boxes and presenting URLs in Internet Explorer.\n\n**Remote Access Tool (DLL)**\n**Exported Functions**\n\nExport Name Description\n\n_Install_ Installs a service whose image is the DLL itself. The\nservice runs under svchost.\n\n_MainThread_ Performs C2 communication; sends machine\ninformation and receives C2 commands.\n\n_ServiceMain_ Gain elevated privileges by obtaining the SYSTEM\nuser’s token.\n\n_Uninstall_ Remove the malware from the system completely.\n\n_DllUpdate_ Updates the DLL to a newer version.\n\n\n-----\n\n### Cryptominer [iexplore.exe, services.exe]\n\nThe iexplore.exe and services.exe files install two services using a tool masqueraded as\n_svchost.exe. The first service – MicrosotMaims – is responsible for dropping a cryptominer_\nthrough an additional file named conhost.exe.\n\nGuardicore Centra shows the creation of a new service MicrosotMais\nThe second – MicrosotMaim – simply runs the cryptominer module. The miner process is\nnamed d1lhots.exe; it is compiled from XMRig, mines Monero and is executed via the\ncommand line below.\n\nd1lhots -o stratum+tcp://a.ccmd.website:1188 -u Bing1 -k –max-cpu-usage=50 –donatelevel=1 -r3 –asm=AUTO –print-time=3 –nicehash\n\n_iexplore.exe drops two additional scripts. The first – chosts.bat – is a batch script which_\nmodifies the local firewall rules using ipsec and blocks any incoming traffic to SMB and RPC\nports (135, 137, 138, 139 and 445). The second script – tem.vbs – is used to delete both\n_iexplore.exe and itself._\n\n### Propagation [c64.exe]\n\nAnother payload which is downloaded as part of the 1st stage is c64.exe, which in turn drops\ntwo files. The first is xfsxdel~.exe and is only used to delete c64.exe from disk. The second is\n_ctfmon.exe – the propagation tool._\n\n_ctfmon.exe is responsible for finding potential victims and exploiting them using Equation_\nGroup’s tools – and it does that extremely thoroughly. It uses exploits for both 32-bit and 64bit machines and scans both RPC (TCP 139) and SMB (TCP 445) ports. Moreover, it tries to\nmove laterally within the organizational network as well as spread across the internet.\n\n_ctfmon.exe executes a batch script same.bat. This script initiates two flows: one for lateral_\nmovement within the network, and the other for spreading on the internet. The two flows are\nsimilar in their sequence: A daily scheduled task runs a batch script, which installs a service.\nThe service runs another batch script which performs the port scanning and exploitation. The\nbatch scripts in these flows also uninstall competitors’ services, terminate their processes\nand delete their files. In addition, they clean old Indexsinas traces.\n\n\n-----\n\nGeneral Propagation Scheme\n\n1. Lateral Movement. The scheduled task At2 runs daily. It executes a batch script –\n\n_wai.bat – which installs a service called MicrosoftMssql. The service runs bat.bat,_\nwhich scans known private IP ranges.\n2. Internet Worm. The scheduled task At1 runs daily. It executes a batch script – nei.bat\n\n– which installs a service called MicrosoftMysql. The service runs cmd.bat, which\nscans the class C subnet of the victim’s public IP address.\n\n[Indexsinas makes use of an open-source port scanner called s that is compiled into an](https://github.com/kingron/s)\nexecutable file titled taskhost.exe. The scanner outputs a list of servers whose SMB ports\nare open in a file called Results.txt. Then, each IP in that list is attacked using Equation\nGroup’s exploits.\n\nUpon successful exploitation, DoublePulsar.dll (for 64-bit) or EternalBlue.dll (for 32-bit) are\ninjected into the victim machine’s kernel and the attack flow starts all over again on the\nnewly-infected machine.\n\n## Detection and Prevention\n\n### Detection\n\nGuardicore Labs publishes a detection tool in PowerShell which identifies malicious\nindicators of compromise on a Windows machine. Execute this script from a command line\nprompt to see whether the system is infected or not. Detailed instructions can be found in\n[Guardicore Labs’ Github repository.](https://github.com/guardicore/labs_campaigns/tree/master/Indexsinas)\n\n\n-----\n\nGuardicore Labs detection tool for Indexsinas executed and reports infection\n\n### Prevention with Visibility and Segmentation\n\nIndexsinas and other attack campaigns leverage vulnerable SMB servers to breach networks\nand move laterally inside them. There are more than 1 million SMB servers accessible to\nanyone on the internet, and many of them still vulnerable to MS-17010; this is exactly what\nmakes Indexsinas and similar attack campaigns profitable.\n\nThe keys to recognizing vulnerable entry points with your organization and preventing\nattacks from propagating within the network are visibility and segmentation.\n\nIt is crucial that network administrators, IT teams and security personnel be able to easily\nidentify assets and the services they run. Specifically, it should be easy to spot internetfacing servers, SMB included.\n\n\n-----\n\nGuardicore Centra visibility map shows internet-facing SMB servers and connections they\nreceive\nWith visibility in place, network admins would want to limit the access from and to different\nassets and the network services they expose.\n\nThe following are examples of policy rules which can protect your organization’s SMB\nservers:\n\nAccess from the internet over SMB is not allowed, except from certain authorized IP\naddresses to a file server in the DMZ\n\nGuardicore Centra rule to allow only certain IP addresses to access internet-facing file\nservers in the organization\n\nSMB traffic inside the network is blocked, except for Domain Controllers and SMB file\nservers\n\nGuardicore Centra rule to allow SMB traffic inside the network only to file servers and domain\n\n\n-----\n\ncontrollers\n\n## The threat of lateral movement is as worrying as the threat of ransomware\n\n[On June 2nd, the U.S. White House sent an open letter to corporate executives and](https://www.privacyanddatasecurityinsight.com/files/2021/06/Memo-What-We-Urge-You-To-Do-To-Protect-Against-The-Threat-of-Ransomware.pdf)\nbusiness leaders in the private sector, urging them to take action and defend their\norganizations from ransomware. One paragraph stands out in this memo as it addresses the\ndata center’s network itself, clearly stating the importance of segmenting corporate networks.\nNetwork segmentation not only prevents an attacker from moving laterally and reaching\nstrategic assets and crown jewels in the network; it also helps minimize damage (reduce the\nblast radius) by creating boundaries between servers in the network and limiting the network\ntraffic between them.\n\n**Segment your networks: There’s been a recent shift in ransomware attacks – from**\nstealing data to disrupting operations. It’s critically important that your corporate business\nfunctions and manufacturing/production operations are separated and that you carefully\nfilter and limit internet access to operational networks, identify links between these\nnetworks and develop workarounds or manual controls to ensure ICS networks can be\nisolated and continue operating if your corporate network is compromised. Regularly test\ncontingency plans such as manual controls so that safety critical functions can be\nmaintained during a cyber incident.\n\nBut don’t be misled by the title mentioning only the “threat of ransomware”. Lateral\nmovement inside a compromised network can be used to drop any type of payload – be it\nransomware, remote access tools, backdoors and cryptominers. Lateral movement is the\nreal threat whereas ransomware is only one motive implementing it. In the case of\nIndexsinas, lateral movement is used to infect as many machines as possible with a remote\naccess tool and a cryptominer. Network segmentation is crucial in preventing such\ncampaigns from spreading and disrupting business operations.\n\n## Indicators of Compromise\n\n[Please see the full lists of IOCs in our Github repository.](https://github.com/guardicore/labs_campaigns/tree/master/Indexsinas)\n\n### Domains\n\n1.indexsinas.me\n2.indexsinas.me\na.ccmd.website\n\n### Mutexes\n\nipip.website\n\n\n-----\n\ndllhost.website\n\n### Service Names\n\nMicrosotMaims\nMicrosotMaim\nMicrosoftMysql\nMicrosoftMssql\nServices\n\n### Scheduled Tasks\n\nAt1\nAt2\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-30 - SMB Worm “Indexsinas” Uses Lateral Movement to Infect Whole Networks.pdf"
    ],
    "report_names": [
        "2021-06-30 - SMB Worm “Indexsinas” Uses Lateral Movement to Infect Whole Networks.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "08623296-52be-4977-8622-50efda44e9cc",
            "created_at": "2023-01-06T13:46:38.549387Z",
            "updated_at": "2025-03-27T02:00:02.859535Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "Tilded Team",
                "EQGRP",
                "G0020"
            ],
            "source_name": "MISPGALAXY:Equation Group",
            "tools": [
                "EquationLaser",
                "EquationDrug",
                "DoubleFantasy",
                "TripleFantasy",
                "GrayFish"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2d9fbbd7-e4c3-40e5-b751-27af27c8610b",
            "created_at": "2024-05-01T02:03:08.144214Z",
            "updated_at": "2025-03-27T02:05:17.419705Z",
            "deleted_at": null,
            "main_name": "PLATINUM COLONY",
            "aliases": [
                "Equation Group "
            ],
            "source_name": "Secureworks:PLATINUM COLONY",
            "tools": [
                " EquationDrug",
                " EquationLaser",
                " Fanny",
                " GrayFish",
                " TripleFantasy",
                "DoubleFantasy"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e0fed6e6-a593-4041-80ef-694261825937",
            "created_at": "2022-10-25T16:07:23.593572Z",
            "updated_at": "2025-03-27T02:02:09.879892Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "APT-C-40",
                "Platinum Colony",
                "Tilded Team"
            ],
            "source_name": "ETDA:Equation Group",
            "tools": [
                "Bvp47",
                "DEMENTIAWHEEL",
                "DOUBLEFANTASY",
                "DanderSpritz",
                "DarkPulsar",
                "DoubleFantasy",
                "DoubleFeature",
                "DoublePulsar",
                "Duqu",
                "EQUATIONDRUG",
                "EQUATIONLASER",
                "EQUESTRE",
                "Flamer",
                "GRAYFISH",
                "GROK",
                "OddJob",
                "Plexor",
                "Prax",
                "Regin",
                "Skywiper",
                "TRIPLEFANTASY",
                "Tilded",
                "UNITEDRAKE",
                "WarriorPride",
                "sKyWIper"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535951,
    "ts_updated_at": 1743041746,
    "ts_creation_date": 1653754402,
    "ts_modification_date": 1653754402,
    "files": {
        "pdf": "https://archive.orkl.eu/eaee202000cbeb7c493d2b55d367ae8e61116183.pdf",
        "text": "https://archive.orkl.eu/eaee202000cbeb7c493d2b55d367ae8e61116183.txt",
        "img": "https://archive.orkl.eu/eaee202000cbeb7c493d2b55d367ae8e61116183.jpg"
    }
}