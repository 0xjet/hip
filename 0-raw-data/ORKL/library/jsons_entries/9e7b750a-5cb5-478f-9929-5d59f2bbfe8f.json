{
    "id": "9e7b750a-5cb5-478f-9929-5d59f2bbfe8f",
    "created_at": "2023-01-12T15:06:18.66435Z",
    "updated_at": "2025-03-27T02:17:02.24358Z",
    "deleted_at": null,
    "sha1_hash": "658b927e6dc890733eee9ff687e4375ddd5cce9d",
    "title": "2018-11-12 - Bug in Malware “TSCookie” - Fails to Read Configuration",
    "authors": "",
    "file_creation_date": "2022-05-28T23:44:18Z",
    "file_modification_date": "2022-05-28T23:44:18Z",
    "file_size": 3278289,
    "plain_text": "# Bug in Malware “TSCookie” - Fails to Read Configuration \n**blogs.jpcert.or.jp/en/2018/11/tscookie2.html**\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/en/shu_tom/)\n\nNovember 12, 2018\n\n[BlackTech](https://blogs.jpcert.or.jp/en/tags/blacktech/)\n\n[Email](http://10.10.0.46/mailto:?subject=Bug%20in%20Malware%20%E2%80%9CTSCookie%E2%80%9D%20-%20Fails%20to%20Read%20Configuration%20-&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2018%2F11%2Ftscookie2.html)\n\nIn [a previous article we have introduced malware ‘TSCookie’, which is assumedly used by an](https://blogs.jpcert.or.jp/en/2018/03/malware-tscooki-7aa0.html)\nattacker group BlackTech. We have been observing continuous attack activities using the\nmalware until now. In the investigation of an attack observed around August 2018, we have\nconfirmed that there was an update in the malware. There are two points meriting attention in\nthis update:\n\nCommunication with C&C server\nDecoding configuration information\n\nThis article will introduce the details of the update.\n\n## Communication with C&C server\n\nIn the previous version, TSCookie included encrypted contents in the Cookie header to\ncommunicate to a C&C server.\n```\nGET /Default.aspx HTTP/1.1\nCache-Control: no-cache\nConnection: Keep-Alive\nDate: Thu, 18 Jan 2018 10:20:55 GMT\nPragma: no-cache\nAccept: */*\nCookie:\n1405D7CD01C6978E54E86DA9525E1395C4DD2F276DD28EABCC3F6201ADAA66F55C15352D29D0FFE51BC9D4\nUser-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Win32)\nHost:[host name]:443\n\n```\nIn the new version, Cookie header is no longer used. Instead, encrypted contents are placed\nwithin the URL parameter as below:\n\n\n-----\n\n```\nGET /t3328483620.aspx?m 4132641264&i 44D6CF457ADC27B2AFAAEAA&p EF4D5069C30D6CAC9\nHTTP/1.1\nCache-Control: no-cache\nConnection: Keep-Alive\nPragma: no-cache\nUser-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Win32)\nHost: [host name]:443\n\n```\nIf received an ack from the server to this HTTP GET request, an HTTP POST request will be\nsent as a next step. The communication feature is the same as the previous TSCookie.\nFor encryption, RC4 is still used, but the key is generated differently. Here is an example\ncode for decoding HTTP GET request parameter.\n```\ndata = \"&\" + sys.argv[1] # sys.argv[1] = URL path\nconf_key = sys.argv[2].decode(\"hex\") # sys.argv[2] = Configuration key\nfield = data.split(\"&\")\nurl_key = field[1]\ni=2\nencdata = \"\"\nwhile i<len(field):\n  value = field[i].split(\"=\")\n  encdata += value[1]\n  i+=1\nkey1 = 0\nfor i in range(len(url_key)):\n  key1 = ord(url_key[i]) + ROR(key1, 13)\n  key1 = key1 & 0xFFFFFFFF\nkey2 = 0\nfor i in range(len(conf_key)):\n  key2 = ord(conf_key[i]) + ROR(key2, 13)\n  key2 = key2 & 0xFFFFFFFF\nkey = pack(\"I\", key1) + pack(\"I\", key2)\ndecode_data = rc4(encdata.decode('hex'), key)\n\n## Decoding configuration information\n\n```\nTSCookie possesses its own configuration information and operates accordingly. The details\nof the configuration remain the same in the new version. The difference is the decoding\nmethod of the configuration. Previously, TSCookie had its 4-byte RC4 key in the beginning of\nthe configuration, which was used for decoding. In the new version, the size is expanded to\n0x80 bytes (Figure 1).\n\n\n-----\n\nFigure 1: RC4 key and encrypted\n\nconfiguration\nWe have confirmed that this update made TSCookie fail to read part of the configuration.\nFigure 2 shows the code copying encrypted configuration (0x8D0 bytes) and RC4 key (0x80\nbytes).\n\nFigure 2: Code copying RC4 Key and encrypted configuration\n\nThe code copies data sized 0x8D4 (0x8D0 + 4 bytes), which ignores the updated RC4 key\nsize. To copy the updated RC4 key and configuration correctly, it needs to be set to 0x950\n(0x8D0 + 0x80 bytes). With this fault, configuration cannot be decoded properly. Figure 3\ndescribes how TSCookie configuration is decoded.\n\n\n-----\n\nFigure 3: Decoded TSCookie\n\nconfiguration\n\n(Left: Copy size 0x8D4, Right: Copy size 0x950)\nDecoded results differ in the left figure (with the wrong, smaller copy size) and right figure\n(with correct, expanded copy size). Data at 0x89C byte (4 bytes) specifies the waiting time\n(seconds) before reconnecting to a C&C server. The attackers initially set this to 99 (0x63)\nseconds (as in the right figure), however, it will not be reconnected for few days since it is not\nread properly (left figure).\n\n## In closing\n\nIt is often the case that attackers give an update to their malware based on analysis reports\nprovided from security vendors. We assume that this bug will be fixed sooner or later. We will\nupdate when we confirm new malware features.\n\nThe malware sample’s hash value is available in Appendix A, and we also list some C&C\nservers in Appendix B. We hope this is helpful in identifying signs of infection.\n\n(Translated by Yukako Uchida)\n\n## Appendix A SHA-256 Hash Value of a sample\n\na5c75f4d882336c670f48f15bf3b3cc3dfe73dba7df36510db0a7c1826d29161\n\n## Appendix B C&C server\n\nmediaplayer.dnset.com\nmediaplayers.ssl443.org\nfashion.androiddatacenter.com\nsakurings.flnet.org\n\n[Email](http://10.10.0.46/mailto:?subject=Bug%20in%20Malware%20%E2%80%9CTSCookie%E2%80%9D%20-%20Fails%20to%20Read%20Configuration%20-&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2018%2F11%2Ftscookie2.html)\n\nAuthor\n\n\n-----\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/en/shu_tom/)\n\nSince December 2012, he has been engaged in malware analysis and forensics\ninvestigation, and is especially involved in analyzing incidents of targeted attacks. Prior to\njoining JPCERT/CC, he was engaged in security monitoring and analysis operations at a\nforeign-affiliated IT vendor. He presented at CODE BLUE, BsidesLV, BlackHat USA Arsenal,\nBotconf, PacSec and FIRST Conference. JSAC organizer.\n\nWas this page helpful?\n\n0 people found this content helpful.\n\nIf you wish to make comments or ask questions, please use this form.\n\nThis form is for comments and inquiries. For any questions regarding specific commercial\nproducts, please contact the vendor.\n\nplease change the setting of your browser to set JavaScript valid. Thank you!\n\n## Related articles\n\nAnalysis of HUI Loader\n\nAnti-UPX Unpacking Technique\n\n\n-----\n\nFAQ: Malware that Targets Mobile Devices and How to Protect Them\n\nMalware WinDealer used by LuoYu Attack Group\n\nMalware Gh0stTimes Used by BlackTech\n\n[Back](https://blogs.jpcert.or.jp/en/2018/10/welcome-to-new-jpcertcc-blog-site.html)\n[Top](https://blogs.jpcert.or.jp/en/)\n[Next](https://blogs.jpcert.or.jp/en/2018/11/mejiro-a-bird-of-passage-over-10000km-from-mongolia-to-bali.html)\n\n## Authors\n\n\n-----\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-11-12 - Bug in Malware “TSCookie” - Fails to Read Configuration.pdf"
    ],
    "report_names": [
        "2018-11-12 - Bug in Malware “TSCookie” - Fails to Read Configuration.pdf"
    ],
    "threat_actors": [
        {
            "id": "2646f776-792a-4498-967b-ec0d3498fdf1",
            "created_at": "2022-10-25T15:50:23.475784Z",
            "updated_at": "2025-03-27T02:00:55.479958Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Palmerworm"
            ],
            "source_name": "MITRE:BlackTech",
            "tools": [
                "Kivars",
                "PsExec",
                "TSCookie",
                "Flagpro",
                "Waterbear"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d3a7123c-f519-49a0-a234-de24a1ef052a",
            "created_at": "2022-10-25T16:47:55.545211Z",
            "updated_at": "2025-03-27T02:05:17.254744Z",
            "deleted_at": null,
            "main_name": "BRONZE CANAL",
            "aliases": [
                "CTG-6177 ",
                "Circuit Panda ",
                "Palmerworm ",
                "Shrouded Crossbow ",
                "BlackTech"
            ],
            "source_name": "Secureworks:BRONZE CANAL",
            "tools": [
                " DRIGO",
                " Flagpro",
                " Gh0stTimes",
                " PLEAD",
                " Spiderpig",
                " Waterbear",
                "Bifrose"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75024aad-424b-449a-b286-352fe9226bcb",
            "created_at": "2023-01-06T13:46:38.962724Z",
            "updated_at": "2025-03-27T02:00:02.964002Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "CIRCUIT PANDA",
                "Temp.Overboard",
                "G0098",
                "Red Djinn",
                "HUAPI",
                "Palmerworm",
                "T-APT-03",
                "Manga Taurus",
                "Earth Hundun"
            ],
            "source_name": "MISPGALAXY:BlackTech",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "efa7c047-b61c-4598-96d5-e00d01dec96b",
            "created_at": "2022-10-25T16:07:23.404442Z",
            "updated_at": "2025-03-27T02:02:09.781478Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Circuit Panda",
                "Earth Hundun",
                "Manga Taurus",
                "Operation PLEAD",
                "Operation Shrouded Crossbow",
                "Operation Waterbear",
                "Palmerworm",
                "Radio Panda",
                "Red Djinn",
                "T-APT-03",
                "TEMP.Overboard"
            ],
            "source_name": "ETDA:BlackTech",
            "tools": [
                "BIFROST",
                "BUSYICE",
                "BendyBear",
                "Bluether",
                "CAPGELD",
                "DRIGO",
                "Deuterbear",
                "Flagpro",
                "GOODTIMES",
                "Gh0stTimes",
                "IconDown",
                "KIVARS",
                "LOLBAS",
                "LOLBins",
                "Linopid",
                "Living off the Land",
                "TSCookie",
                "Waterbear",
                "XBOW",
                "elf.bifrose"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b72c2616-cc7c-4c47-a83d-6b7866b94746",
            "created_at": "2023-01-06T13:46:39.425297Z",
            "updated_at": "2025-03-27T02:00:03.08718Z",
            "deleted_at": null,
            "main_name": "Red Nue",
            "aliases": [
                "LuoYu"
            ],
            "source_name": "MISPGALAXY:Red Nue",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535978,
    "ts_updated_at": 1743041822,
    "ts_creation_date": 1653781458,
    "ts_modification_date": 1653781458,
    "files": {
        "pdf": "https://archive.orkl.eu/658b927e6dc890733eee9ff687e4375ddd5cce9d.pdf",
        "text": "https://archive.orkl.eu/658b927e6dc890733eee9ff687e4375ddd5cce9d.txt",
        "img": "https://archive.orkl.eu/658b927e6dc890733eee9ff687e4375ddd5cce9d.jpg"
    }
}