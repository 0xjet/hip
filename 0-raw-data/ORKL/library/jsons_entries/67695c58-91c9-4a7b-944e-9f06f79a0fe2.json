{
    "id": "67695c58-91c9-4a7b-944e-9f06f79a0fe2",
    "created_at": "2023-01-12T15:01:17.31445Z",
    "updated_at": "2025-03-27T02:06:03.057087Z",
    "deleted_at": null,
    "sha1_hash": "d831287d49afb328fe2a4a195aee4ec5aeab805d",
    "title": "2022-05-19 - Weaponization of Excel Add-Ins Part 2- Dridex Infection Chain Case Studies",
    "authors": "",
    "file_creation_date": "2022-05-28T03:53:08Z",
    "file_modification_date": "2022-05-28T03:53:08Z",
    "file_size": 2253253,
    "plain_text": "# Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies\n\n**[unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain](https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain)**\n\nSaqib Khanzada May 19, 2022\n\nBy [Saqib Khanzada](https://unit42.paloaltonetworks.com/author/saqib-khanzada/)\n\nMay 19, 2022 at 12:00 PM\n\n[Category: Malware](https://unit42.paloaltonetworks.com/category/malware-2/)\n\nTags: [AgentTesla,](https://unit42.paloaltonetworks.com/tag/agenttesla/) [Dridex,](https://unit42.paloaltonetworks.com/tag/dridex/) [Macros,](https://unit42.paloaltonetworks.com/tag/macros/) [Microsoft Excel,](https://unit42.paloaltonetworks.com/tag/microsoft-excel/) [next-generation firewall,](https://unit42.paloaltonetworks.com/tag/next-generation-firewall/) [WildFire](https://unit42.paloaltonetworks.com/tag/wildfire/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/excel-add-ins-dridex-infection-chain/)\n\n## Executive Summary\n\nIn [Part 1 of this two-part blog series, we discussed briefly how XLL files are exploited to](https://unit42.paloaltonetworks.com/excel-add-ins-malicious-xll-files-agent-tesla/)\ndeploy Agent Tesla. During December 2021, we continued to observe Dridex and Agent\nTesla exploiting XLL in different ways for initial payload delivery. A more in-depth look at the\nDridex infection chain follows.\n\nThreat actors behind Dridex have been using various delivery mechanisms over the years. In\nearly 2017, we observed plain VBScript and JavaScript were being used. In later years, we\nobserved many variations, including Microsoft Office files (DOC, XLS) compressed in zip. In\n2020, we found the malware using Discord and other legitimate services to download the\n\n\n-----\n\nfinal payload. More recently, during December 2021, we received various Dridex samples,\nwhich were exploiting XLL and XLM 4.0 in combination with Discord and OneDrive to\ndownload the final payload.\n\n[In our previous blog focused on XLL files and Agent Tesla, we saw the abuse of the](https://unit42.paloaltonetworks.com/excel-add-ins-malicious-xll-files-agent-tesla/)\nlegitimate Excel-DNA framework. In this blog post, we will look into other infection chains.\nWe will discuss different stages of the XLL and Excel 4 (XLM) droppers that deliver Dridex\nsamples. We will also briefly look at the Dridex Loader.\n\nPalo Alto Networks customers receive protections against the attacks discussed here\nthrough [Cortex XDR or the](https://www.paloaltonetworks.com/cortex/cortex-xdr) [WildFire cloud-delivered security subscription for the Next-](https://www.paloaltonetworks.com/products/secure-the-network/wildfire)\nGeneration Firewall.\n\nTypes of Attacks Covered [Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Dridex](https://unit42.paloaltonetworks.com/tag/dridex/)\n\nRelated Unit 42 Topics [Agent Tesla,](https://unit42.paloaltonetworks.com/tag/agenttesla/) [Macros](https://unit42.paloaltonetworks.com/tag/macros/)\n\n## Table of Contents\n\nXLM Dropper\n\nXLL Dropper\n\nActive Directory Check\n\nDiscord URLs\n\nBrief Loader Analysis\n\nUnpacking Stages\n\nFirst Stage\n\nSecond Stage\n\nFinal Dridex Loader\n\nMicro VM\n\nAPI Hashing\n\nConclusion\n\nIndicators of Compromise\n\n## XLM Dropper\n\nWhile XLM 4.0 is not new, there has been a lot of evolution in how malware has abused it\nsince early 2020 Threat actors have gone from using simple, non-obfuscated macro formulas\nto creating complex hidden variants which finally utilize native services such as rundll32 to\nrun a payload.\n\nAs the malicious usage of XLM 4.0 macros is quite new, vendors are striving hard to provide\ncoverage in such cases.\n\n\n-----\n\nThe XLM document in this case comprises two spreadsheets – one contains formulae and\nthe other simply contains some random data. See Figures 1-2 below.\n\nFigure 1. The red “1” in the right side of the screenshot shows the macro 4.0 responsible for\ndumping an HTML application file (HTA). The red “2” at the top shows the output of\nhighlighted formulae.\n\nFigure 2. The red box indicated by the number 1 shows an HTA script stored in ASCII values.\n\n\n-----\n\nIt can be seen that one of the formulae in the spreadsheet shown in Figure 1 tries to run with\nMshta, so we can assume it is not really an RTF. Upon further analysis, we found that indeed\nit is an HTA. XLM 4.0 code in Sheet1 is responsible for reading ASCII values from Sheet2\n(Figure 2) and generating the HTA file that downloads Dridex from Discord.\n\nFigure 3. VBScript to download Dridex from Discord.\n\nFigure 4. Encoded Discord URL in HTA file.\nIt is difficult to say anything about the XLS itself until it finally downloads a malicious payload.\nFurthermore, the HTA is being dropped as RTF. This might confuse some security products\nbecause they could analyze the HTA as an RTF file and might lose detection. Additionally,\nthe usage of Discord URLs makes the samples more evasive. (Though the examples given\nhere involve Discord URLs, we have also observed similar usage of OneDrive URLs. See\nthe GitHub link in the Indicators of Compromise section for specific examples of OneDrive\nURLs.)\n\n## XLL Dropper\n\n[In comparison to the malicious XLL files that we discussed in Part 1 of this blog series, this](https://unit42.paloaltonetworks.com/excel-add-ins-malicious-xll-files-agent-tesla/)\ndropper is rather simple. An XLL file is just a DLL, but it must be executed using Excel. The\nproper detonation is important for detection.\n\n\n-----\n\nFigure 5. Discord URLs found in XLL.\n\nFigure 6. XLL running Dridex Loader.\n\n## Active Directory Check\n\nWe think that both the XLL and VBScript downloaders are associated with the same actor\nbecause, as we can see, both perform a check to see whether the LOGONSERVER and\nUSERDOMAIN environment variables are set. This would mean a system is on Active\n\n\n-----\n\nDirectory.\n\nFigure 7. HTA dropper checking for the environment variables LOGONSERVER and\nUSERDOMAIN.\n\nFigure 8. XLL dropper checking for the environment variables LOGONSERVER and\nUSERDOMAIN.\n\n## Discord URLs\n\nWe extracted around 1,400 URLs (see Indicators of Compromise section at the end of this\npost) from XLM and XLL files, however, at the time of analysis, only a few of them were still\nup and were found downloading only Dridex. An interesting thing to note is that DLL files are\nbeing downloaded as MKV. We saw that at the start of the infection chain that HTA was\nbeing dropped as RTF.\n\n## Brief Loader Analysis\n\nAs can be seen in Figure 6, the downloaded payload is being run with the command\n\nrundll32.exe * DirSyncScheduleDialog. However, as we opened the file for further analysis,\nthe method DirSyncScheduleDialog is not found in the export directory. It is interesting to\nnote that that function name belongs to a legitimate Windows DLL.\n\n\n-----\n\nFigure 9. The missing method(left) is shown, compared to the legitimate Windows\nloghours.dll with exported function DirSyncScheduleDialog (right).\n\n### Unpacking Stages\n\n1. Decrypt and Load second-stage DLL from rdata section.\n2. Second DLL further unpacks the final Dridex Loader.\n3. Jumps to DirSyncScheduleDialog.\n\n### First Stage\n\nThe first stage is fairly simple in terms of functionality; its only job is to decrypt a small DLL\nfrom the rdata section and move it to allocated memory and run it.\n\nHowever, there are a few anti-analysis tricks.\n\n1. Usage of junk code.\n2. A Large Loop with INT3 instructions.\n3. Usage of undocumented functions such as ldrgetprocedureaddress and LdrLoadDll to\n\navoid common hooks.\n\nWhile junk code might hinder manual analysis, large loops containing INT3 breakpoints\nmight delay the execution in some cases.\n\nThe first stage has a handful of functions. We renamed them to reflect trivial loader behavior.\n\n\n-----\n\nFigure 10. Renamed functions (left); jump to allocated memory (center); anti-VM function,\nCC bytes replaced with NOP (right).\n\n### Second Stage\n\nOnce the first stage passes control to the in-memory DLL (Figure 8), it further unpacks the\nfinal payload and transfers control to it. The second stage is also trivial. However, the stage\ndoes include a few interesting anti-analysis tricks to note.\n\n1. Calls Disablethreadlibrarycalls to increase invisibility of final DLL.\n2. Checks LdrLoadDll for hooks.\n\nFigure 11. Renamed functions (left), check for LdrLoadDll hook (center),\ndisableThreadLibraryCalls in imports (right).\n\n### Final Dridex Loader\n\nFinally, we are able to see a call to DirSyncScheduleDialog. It is interesting to note that\nDridex Loader is not performing DLL side loading. However, the final payload is loaded as\nloghours.dll, a legitimate windows DLL.\n\n\n-----\n\nFigure 12. A side-by-side comparison of the Export table from the Dridex Loader (left) and\nthe legitimate loghours.dll (right).\n\nFigure 13. Dridex Loader EP; anti-VM loop can be noticed in start.\n\n### Micro VM\n\nDridex implements a micro VM, which adds an exception handler using\nAddVectoredExceptionHandler to emulate the call eax instruction.\n\n\n-----\n\nFigure 14. Call to get_proc_address_by_hash function and CC CC bytes (call eax).\n\nFigure 15. Exception handler emulating call eax.\n\n\n-----\n\nAs can be seen in Figure 15, in the case of EXCEPTION_BREAKPOINT, the call eax\ninstruction is being emulated. For the sandbox, this should not be a problem; however, it can\nhinder manual analysis. As can be seen, the exception handler only emulates one\ninstruction. Patching these two INT3 instructions with call eax should not be a big deal. A\nsimple IDA script to patch all CC CC instructions with FF D0 should do the trick.\n\nFigure 16. Patched INT3 instruction with “call eax”.\n\n### API Hashing\n\nAPI Hashing is trivial, however, we observed a few obfuscations and variations in this Dridex\nLoader.\n\n1. Multiple hashing functions.\n2. Masqueraded Prolog for hashing function.\n\nWe observed that, in order to hinder analysis further, this Dridex Loader is using multiple\nhashing functions. We observed at least two hashing functions and one masqueraded Prolog\nfunction, as can be seen below.\n\n\n-----\n\nFigure 17. API hashing function sub_744102D4\n\n\n-----\n\nFigure 18. Masqueraded Prolog function.\nIt can be seen that the Prolog of the get_proc_address_1 function is not normal. The\nregisters eax and edx are being used to pass module hash and API hash to the\nget_proc_address_1_mas function. It is possible to call get_proc_address_1 to set eax and\nedx. Alternatively, they can be set before calling get_proc_address_1_mas. If a researcher is\nwriting an automation for resolving APIs – such as using AppCall – it is important to watch\nout for this trick.\n\nWe used the IDA AppCall feature to extract all APIs used in the loader. Based on extracted\nAPIs, this Dridex Loader is not different from the Dridex Loader that was observed in early\n2021.\n\nKey functions of the Dridex Loader:\n\n1. Check process privileges.\n2. AdjustToken privileges.\n3. GetSystemInfo\n4. Uses the “Atomic Bombing” injection technique to load core payload downloaded from\n\ncommand and control server.\n\nThe Dridex Loader has been extensively analyzed. Here, we focused mainly on small tricks\nused across the infection chain to avoid detection and slow down analysis.\n\n## Conclusion\n\n\n-----\n\nWe observed a continued evolution of the infection chain. We saw how malware authors can\nevade detection engines using legitimate services such as Discord and OneDrive. We\nanalyzed how malware authors continue to add more stages in the infection chain.\n\nLastly, we briefly looked into the Dridex payload. Although the final payload was similar to the\nprevious Dridex version in terms of behaviour, we noticed an additional unpacking stage and\na couple of new changes in the API hashing function. These simple yet powerful tricks that\ncan be challenging for malware analysts, helping the malware avoid detection and slow\ndown analysis.\n\nPalo Alto Networks customers receive protections against the attacks discussed here\nthrough [Cortex XDR or the](https://www.paloaltonetworks.com/cortex/cortex-xdr) [WildFire cloud-delivered security subscription for the Next-](https://www.paloaltonetworks.com/products/secure-the-network/wildfire)\nGeneration Firewall.\n\nIf you think you may have been compromised or have an urgent matter, get in touch with the\n[Unit 42 Incident Response team or call:](http://start.paloaltonetworks.com/contact-unit42.html)\n\nNorth America Toll-Free: 866.486.4842 (866.4.UNIT42)\nEMEA: +31.20.299.3130\nAPAC: +65.6983.8730\nJapan: +81.50.1790.0200\n\n### Indicators of Compromise\n\n[Indicators of compromise related to the malware discussed here can be found on GitHub.](https://github.com/pan-unit42/iocs/blob/master/Dridex%20Infection%20Chain%20Case%20Studies)\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-19 - Weaponization of Excel Add-Ins Part 2- Dridex Infection Chain Case Studies.pdf"
    ],
    "report_names": [
        "2022-05-19 - Weaponization of Excel Add-Ins Part 2- Dridex Infection Chain Case Studies.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535677,
    "ts_updated_at": 1743041163,
    "ts_creation_date": 1653709988,
    "ts_modification_date": 1653709988,
    "files": {
        "pdf": "https://archive.orkl.eu/d831287d49afb328fe2a4a195aee4ec5aeab805d.pdf",
        "text": "https://archive.orkl.eu/d831287d49afb328fe2a4a195aee4ec5aeab805d.txt",
        "img": "https://archive.orkl.eu/d831287d49afb328fe2a4a195aee4ec5aeab805d.jpg"
    }
}