{
    "id": "605c7a11-3646-4da5-add8-c323bbf7d16f",
    "created_at": "2023-01-12T15:04:50.246047Z",
    "updated_at": "2025-03-27T02:05:40.980932Z",
    "deleted_at": null,
    "sha1_hash": "a19f817b42e6fe6627ac5a96128d75d6cdc3f2ff",
    "title": "2016-05-23 - DMA Locker 4.0- Known ransomware preparing for a massive distribution",
    "authors": "",
    "file_creation_date": "2022-05-28T02:30:40Z",
    "file_modification_date": "2022-05-28T02:30:40Z",
    "file_size": 762550,
    "plain_text": "# DMA Locker 4.0: Known ransomware preparing for a massive distribution\n\n**blog.malwarebytes.com/threat-analysis/2016/05/dma-locker-4-0-known-ransomware-preparing-for-a-massive-**\ndistribution/\n\nhasherezade May 23, 2016\n\nFrom the beginning of this year, we are observing rapid development of DMA Locker. First,\nthe threat was too primitive to even treat it seriously. Then it evolved to more complex but still\n[decryptable ransomware.](https://www.malwarebytes.com/ransomware)\n\nThe 3.0 edition was very similar to the previous one that we described, so we skipped\nposting about its details (the only change was to fix the bug making it decryptable). Now we\nare facing an outbreak of version 4.0, coming with various changes.\n\nIn the past, DMA Locker was known from being installed on hacked Remote Desktops. New\n[release has been found distributed via exploit kit (Neutrino). This change is another step](http://www.broadanalysis.com/2016/05/22/neutrino-from-104-238-185-187-sends-dma-locker-4-0/)\ntowards maturity of the malware, showing that now this threat will be spreading on a bigger\nscale.\n\n## DMA Locker development timeline\n\n\n-----\n\ndiscovered: January 2016\nversion: 1.0\ncrypto:\n\n**files encrypted by AES-256 in ECB mode.**\n**AES key is the same for each attacked file, stored in the binary and erased after**\n**use.**\n\ndecryptable: yes, if we have the original sample\nworks offline: yes\nprefix: ABCXYZ11\n_[read more: here](https://blog.malwarebytes.org/threat-analysis/2016/02/dma-locker-a-new-ransomware-but-no-reason-to-panic/)_\n\ndiscovered: 8 February 2016\nversion: 2.0\ncrypto:\n\nfiles encrypted by AES-256 in ECB mode\n**AES key is randomly generated for each attacked file. After use, it is encrypted**\n**by RSA and stored in the file**\n**RSA public key comes hardcoded in the binary.**\n\ndecryptable: Yes. Due to the weak random generator AES key can be guessed.\nworks offline: yes\nprefix: !DMALOCK\n_[read more: here](https://blog.malwarebytes.org/threat-analysis/2016/02/dma-locker-strikes-back/)_\n\ndiscovered: 22 February 2016\nversion: 3.0\ncrypto:\n\nfiles encrypted by AES-256 in ECB mode\nAES key is randomly generated for each attacked file. After use, it is encrypted by RSA\nand stored in the file\nRSA public key comes hardcoded in the binary.\n\ndecryptable: No, the previous bug has been fixed. However, RSA key is the same for\n**full campaign and once we buy the private key, it can be reused for several victims.**\nworks offline: yes\nprefix: !DMALOCK3.0\n\n\n-----\n\ndiscovered: 19 May 2016\nversion: 4.0\ncrypto:\n\nfiles encrypted by AES-256 in ECB mode, key is randomly generated for each file.\neach random AES key is encrypted by RSA and stored in the file\n**RSA key pair is generated on the server (per client). The public key is**\n**downloaded.**\n\ndecryptable: No. **Neither RSA key can be reused.**\nworks offline: no\nprefix: !DMALOCK4.0\n_read more: in the current article_\n\n## Analyzed sample\n\n Behavioral analysis\n\nIn contrast to the previous versions, DMA Locker 4.0 cannot encrypt files offline. It needs to\ndownload the public RSA key from its C&C. That’s why, if the file has been opened on the\ncomputer without the internet connection, it will just install itself and wait. If the machine is\nconnected – it runs silently until it finish encrypting the files.\n\nThis time DMA Locker comes with a deception layer added – packed sample have an icon\npretending a PDF document:\n\nAfter being run, it moves itself to the same location like it’s previous editions –\n**_C:\\ProgramData under the name svchosd.exe:_**\n\n\n-----\n\nIn addition to the main sample, we can see two additional files: select.bat and cryptinfo.txt.\n\n_cryptinfo.txt is a ransom note, analogical to those that we know from the previous editions –_\nonly the content changed. Now it is much shorter and contains a link to the individual website\nfor the victim:\n\nScript select.bat is used to display this note just in case if the original executable has been\nremoved:\n\nIt also adds registry keys for the persistence. This time the main sample – svchosd.exe – is\nsaved under the name Windows Firewall and the script select.bat – under Windows\n**_Update :_**\n\n\n-----\n\nAfter it finishes the encryption process, a red window, similar to the one known form the\nprevious editions pops up:\n\nIn addition to the incremented version number, visible in the corner, we can see some slight\nusability improvements. Following current trends, the option to decrypt a test file has been\nadded. Also, there is a link to a tutorial.\n\nAs it was in the previous editions, extensions of the encrypted files are unchanged. We can\nrecognize that they have been attacked by this ransomware only by the prefix of the content.\nThis time it is “!DMALOCK4.0”:\n\n\n-----\n\n## Experiment\n\nIn the last editions, DMA Locker was using two algorithms for the encryption: AES – to\nencrypt the file content and RSA – to encrypt the randomly generated AES key. Let’s see if\nthe patterns of the encrypted content are similar to those found before:\n\nLeft – raw bytes of original BMP, right – the same BMP encrypted by DMA Locker 4.0:\n\nIndeed, again we can see patterns of original content reflected in the encrypted content, that\nsuggest that some block cipher has been used. We can suspect, that also in this case it is\nAES in ECB mode.\n\nAlso this time, every file is encrypted with a different key.\n\n## Network communication\n\nThe feature that is new in this edition of DMA Locker is the communication with the C&C\n(Command and Control) server. The generated traffic is not encrypted and we can easily see\nwhat for the C&C is used.\n\nThe victim ID is generated server side (not like in some other cases of malware, where the\ngenerated locally ID is sent and registered to the C&C). During the beaconing, bot receives it\nand stores in the registry as dma_id.\n\n\n-----\n\nThe role of the C&C is crucial, because the public key is not hardcoded this time, but\ngenerated per victim* and downloaded:\n\n_*logic of the application suggests, that keys are unique for each victim, but we don’t know_\n_what really happens on the server side and if the keys are not being reused for some pool of_\n_victims_\n\nBefore the windows pops up, it asks the C&C about the individual data of the victim, that has\nto be displayed:\n\n\n-----\n\n## Website for the victim\n\nMost of the ransomware provide a website for the victim, but what is surprising in case of\n**_DMA Locker 4.0 is the fact that the website is not on the Tor-based, but on a normal hosting._**\nThe same IP is used as the C&C server.\n\nContent of the website is clean, but very simple – that may suggest early stage of\ndevelopment:\n\n\n-----\n\nThe same site is supposed to offer the service of decrypting the test file (opened by the\nbutton in GUI):\n\nHowever, during our tests this service was not working properly and we didn’t got any file\nback, although it has been successfully submitted:\n\n## Inside\n\nIn the past, DMA Locker was distributed without any packing. The reason behind it was\nprobably the chosen distribution method – samples were deployed manually by attackers,\nwho accessed machines via hacked Remote Desktops. Attacker didn’t bothered much about\nadding any deception layer.\n\nIn this edition it has changed. DMA Locker comes packed in some underground crypter, that\nis used to protect the payload and deceive tools used for the detection.\n\n\n-----\n\nWhen we open the original executable under the debugger, we will see the code of the\ncrypter’s stub, that doesn’t make much sense. The real payload is revealed after unpacking.\nIt has similar structure to the previous editions of DMA Locker, but several new features are\nadded.\n\n### How does the encryption work?\n\nEncryption follows similar steps like in the previous versions.\n\nThe main difference comes in the method of delivering the public RSA key. In the previous\neditions, the key was one per campaign and it was stored hardcoded in the binary. Now it\nchanged. The key is downloaded from the server – along with the unique bot ID. Both are\nstored in the registry and fetched when needed.\n\nIndividual AES key is generated for each and every file just before encryption. Since version\n3.0 of DMA Locker, a weak random generator has been fixed. Now it uses a function\nCryptGenRandom from Windows Crypto API to fetch 32 random bytes that are used as a\nkey:\n\n\n-----\n\nJust like it was before, a file is read and divided into chunks. Then, the random key along\nwith the buffer containing a single chunk is passed as a parameter to a new encrypting\nthread. For the content encryption, the same AES implementation like in the previous\nversions has been used.\n\n\n-----\n\nAfter the full content is processed, the RSA key is imported and used to encrypt the random\nAES key. The encrypted key is saved at the beginning of the file, just after the\n**!DMALOCK4.0 tag.**\n\nThen, the AES encrypted content is appended to the file. At the end, the random key is\ndestroyed.\n\nLike in the previous edition, the same application can be used for decryption when the victim\nmanaged to get the appropriate RSA private key. Previously, the only way to communicate\nwith the attacker and to purchase the key was via e-mail. Now the payment is managed\nautomatically and the private key is released on the server after completing the payment. Bot\ncan automatically download it and perform the decryption.\n\n### What is attacked?\n\n[This part remained unchanged. Like the previously described version (2.0) it attacks local](https://blog.malwarebytes.org/threat-analysis/2016/02/dma-locker-strikes-back/)\ndrives as well as unmapped network shares. Instead of list of attacked extensions, DMA\nLocker comes with list of blacklisted extensions and paths, that are excluded from the\nencryption process.\n\n### Communication protocol\n\nDMA Locker communicates with it’s C&C server by a simple, HTTP based protocol. Bot\nsends GET requests and server responds in JSON. There are 6 actions, for which URLs are\nhardcoded in the bot:\n\n\n-----\n\nJSON responses are then parsed with another dedicated function. Every status change is\nreflected in the red window. Example, showing setting appropriate string accordingly to the\nupdate received from the server:\n\n\n-----\n\nIn case if accessing the C&C was not possible, the bot sets in window the hardcoded bitcon\naddress:\n\n…also, a hardcoded sum of 4 BTC:\n\n\n-----\n\nOld style communication via e-mail is still offered as a failsafe.\n\n**Actions**\n\nParticular actions are recognized by their numerical identifiers. Below – action numbers and\ntheir meaning:\n\n**0: get a unique id for the bot**\n\nsample request:\n```\nGET /crypto/gate?action=0\n\n```\nsample response:\n```\n{\"status\":0,\"id\":\"7D6FB84840584C6484EEAD3DB377409B\"}\n\n```\n**1: get the public RSA key**\n\nsample request:\n```\nGET /crypto/gate?action=1&botId=7D6FB84840584C6484EEAD3DB377409B\n\n```\nsample response (giving RSA public key):\n```\n{\"status\":0,\"rsa_public_key\":\"-----BEGIN PUBLIC KEY----MIIBCgKCAQEAxPaoqNvUn8T52DtCr80OEJOa4bIXRDIRnVdCYxPQZ4rrNniBNnM+uEb2AUmSHTgZvlH1s3g0TD\n----END PUBLIC KEY-----\"}\n\n```\n**2: report saving the public key**\n\nsample request:\n```\naction=2&botId=7D6FB84840584C6484EEAD3DB377409B\n\n```\nsample response:\n```\n{\"status\":0}\n\n```\n**3: get information about the payment specific to the client:**\n\n\n-----\n\n```\nGET /crypto/gate?action 3&botId 7D6FB84840584C6484EEAD3DB377409B\n\n```\nsample response:\n```\n{\"status\":0,\"minimum_btc_confirmations\":3,\"bitcoin_address\":\"1C8yA7wJuKD4D2giTEpUNcdd7\n05-31 15.02.39\",\"ransom_amount_increase_timestamp\":\"2016-05-27\n15.03.58\",\"ransom_amount_increase_amount\":\"1.5\"}\n\n```\n**4: check the transaction status**\n```\nGET /crypto/gate?\naction=4&botId=7D6FB84840584C6484EEAD3DB377409B&transactionId=66614538ca4e50f44c06cf87\n\n```\nsample response:\n```\n{\"status\":7}\n\n```\n**5: get the private key (if released)**\n\nsample request:\n```\nGET /crypto/gate?action=5&botId=070F39D8E01A4B71B8414352CDB186E9\n\n```\nsample response:\n```\n{\"status\":0,\"rsa_private_key\":\"[the key content goes here]\"}\n\n```\n**6: check bot status**\nsample request:\n```\nGET /crypto/gate?action=6&botId=070F39D8E01A4B71B8414352CDB186E9\n\n```\nsample response:\n```\n{\"status\":0,\"bot_status\":1}\n\n```\npossible bot statuses and their meanings:\n```\n0: fresh\n1: public key saved\n3: \"Transaction and payment are confirmed. Getting decryption key...\"\n\n```\nIf this action receives bot status 3 it directly execute the action 5, fetching the private key.\n\n**Statuses**\n\nEach action return some status. Most common is status 0 that is a standard “OK” response.\nSome of the statuses are translated to the displayed strings:\n\n\n-----\n\n```\n2 Transaction ID confirmed! Confirming your payment, please be patient, it can\ntake 15-20 minutes...\"\n4 - \"Your private key is currently deleted. You are late with payment.\"\n7 - \"Your transaction need to be confirmed by server. It can take few hours. Check\nagain for 1 hour.\"\n8 - \"Invalid transaction ID.\"\n9 - \"You have to wait 15 minutes to check again.\"\n\n## Conclusion\n\n```\nDMA Locker started being seen at the beginning of this year and drew our attention by the\nfast quality improvements. However, after a few months of seeing unchanged version 3.0, we\ngot the impression that development of this ransomware got frozen.\n\nThe current edition shows that it is not true. This threat is still evolving and catching up with\nthe features, known from other ransomware. So far it didn’t shown any novelty in the used\ntechniques and we can rather expect a conventional attack from this side.\n\nThe recently observed changes suggest that the product is preparing to be distributed on a\nmassive scale. Few important things got automated. Distribution is now exploit kit based –\nthat makes it reach much more targets. Purchasing a key and managing payment is\nsupported via dedicated panel – no longer human interaction is required.\n\n## Appendix\n\nhttp://www.broadanalysis.com/2016/05/22/neutrino-from-104-238-185-187-sends-dmalocker-4-0/ – Neutrino EK sending DMA Locker 4.0\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-05-23 - DMA Locker 4.0- Known ransomware preparing for a massive distribution.pdf"
    ],
    "report_names": [
        "2016-05-23 - DMA Locker 4.0- Known ransomware preparing for a massive distribution.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535890,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1653705040,
    "ts_modification_date": 1653705040,
    "files": {
        "pdf": "https://archive.orkl.eu/a19f817b42e6fe6627ac5a96128d75d6cdc3f2ff.pdf",
        "text": "https://archive.orkl.eu/a19f817b42e6fe6627ac5a96128d75d6cdc3f2ff.txt",
        "img": "https://archive.orkl.eu/a19f817b42e6fe6627ac5a96128d75d6cdc3f2ff.jpg"
    }
}