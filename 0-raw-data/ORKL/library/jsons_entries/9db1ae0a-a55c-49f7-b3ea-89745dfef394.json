{
    "id": "9db1ae0a-a55c-49f7-b3ea-89745dfef394",
    "created_at": "2023-01-12T15:03:58.41412Z",
    "updated_at": "2025-03-27T02:09:18.430661Z",
    "deleted_at": null,
    "sha1_hash": "5f5800ff1a179a35fefe28a38b57f55f2b161d82",
    "title": "2021-09-18 - “Squirrelwaffle” Maldoc Analysis",
    "authors": "",
    "file_creation_date": "2022-05-27T22:12:40Z",
    "file_modification_date": "2022-05-27T22:12:40Z",
    "file_size": 1677329,
    "plain_text": "# “Squirrelwaffle” Maldoc Analysis\n\n**security-soup.net/squirrelwaffle-maldoc-analysis/**\n\nadmin September 18, 2021\n\n## Summary\n\nSquirrelwaffle is an emerging malware threat noted by several security researchers\n[beginning around September 13th. TheAnalyst, @ffforward noted a new payload delivered](https://twitter.com/ffforward/status/1437473409542262795?s=20)\non the “TR” botnet.\n\n[Brad Duncan at Malware Traffic Analysis also observed that this new loader was being](https://www.malware-traffic-analysis.net/index.html)\ndelivered by the same “TR” infrastructure that historically delivered the Qakbot banking\ntrojan. He also noted the name came from a tag in Proofpoint’s ruleset.\n\nAccording to Duncan,\n\n\n-----\n\nThe name Squirrelwaffle loader was used in Proofpoint s Emerging Threats ruleset to\nidentify traffic from this malware.\n\n_https://www.malware-traffic-analysis.net/2021/09/17/index.html_\n\nIn this blog, we will take a quick look at a recent Squrrelwaffle maldoc in order to gain some\ninsights into the operators’ TTPs and the malware’s infection chain that I hope will help other\nresearchers and responders in their efforts to identify and combat this new threat.\n\n## Delivery and Execution\n\nThe recent downloader maldocs appear to be delivered via email campaigns with embedded\nURLs. Reports also seem to suggest that the campaigns leverage reply chain threadjacking\ntechnique that has been commonly deployed in historical Emotet and Qakbot campaigns. If a\nuser clicks on the URL, a ZIP archive containing a Microsoft Word document is served.\n\nSquirrelwaffle Execution Chain\nThe documents appear to follow the naming convention of “diagram-[0-9]{2,3}/.doc”. These\ndocuments are weaponized with macros per usual (more detail on the scheme below). The\nmacro leverages a cscript process to extract an embedded VBS script file, writes it to disk,\nand executes it via a wscript process. That VBS script contains an obfuscated PowerShell\ndownload cradle that attempts to download the Squirrelwaffel payload from a series of five\nlocations.\n\nThe loader is written to the C:\\ProgramData directory with a naming convention “www[1-5]\n{1}/.dll”, depending on the C2 from which it is retrieved. The DLL is then executed via a\n_rundll32 process with an argument to export the “ldr” function. Predictably, a follow on_\npayload has been reported to be CobaltStrike.\n\n\n-----\n\nCobalt\n\nStrike Payload you say?\n\n## The Maldoc\n\nThe Word document is weaponized with VBA macros and leverages a series of scripts to\nkick off the execution chain and download the Squirrelwaffle payload. If you are following\n[along at home, the document can be found here on VirusTotal:](https://www.virustotal.com/gui/file/195eba46828b9dfde47ffecdf61d9672db1a8bf13cd9ff03b71074db458b6cdf)\n\nfilename: inquiry diagram-74.doc\nSHA256:\n195EBA46828B9DFDE47FFECDF61D9672DB1A8BF13CD9FF03B71074DB458B6CDF\n\nThe document uses a common DocuSign style template, presumably to enhance the\nperception of security and build a sense of trust with he user. However, the DOC also\nappears to be composed in Russian, which would hopefully be a red flag for the end user.\n\nDocuSign Template\n\n\n-----\n\nStepping into the VBA editor in Word, we can clearly see multiple modules that contain the\nVBA code that will kick off the execution chain. The VBA itself is lightly obfuscated, with\nsome variable assignments and string reversals, but on the whole, it is not difficult to identify\nthe code’s purposes.\n\nThe smoking gun with these malicious macros is always the “Sub AutoOpen()” function,\nwhich is the part of the code executed immediately when the user enables the macro\ncontent. In this case, this function serves as a pointer to another function called “eFile” in the\n“bxh” module.\n\nThere is also a UserForm object that has the VBS file (pin.vbs) hidden and embedded as the\ncaption of the DocuSign image presented in the main DOC file. This UserForm labeled “t2”\nhas a Caption field where the VBS file is hidden. The VBS file is then extracted from the\nCaption field of the Label and subsequently written to disk in C:\\ProgramData\\pin.vbs.\n\nVBA Modules and UserForm object\nApologies, I realized too late that my love for the red arrow knows no bounds.\n\n\n-----\n\nMe marking up a VBA project\nThe VBS file is written with a Loop function that cycles through five different URLs that are\neach hosting Squirrelwaffle payloads. It attempts to download these and writes them to disk\nin C:\\ProgramData and executes them via rundll32. The command line is a variation of the\nbelow:\n\ncmd/c rundll32.exe C:\\ProgramData\\ww1.dll,ldr\n\nThe script itself is obfuscated fairly simply with just some split variable assignments designed\nto break up the strings such as:\n\nIEX (alias for the Invoke-Expression cmdlet)\n(New-Object Net.WebClient).Download\nand powershell\n\n\n-----\n\npin.vbs\nMany static detections are based on these particular strings so this indicates at least some\nminimal attempt at evasion. However the the URLs hosting the payloads and the commands\ndesigned to execute the DLL are clearly visible, and could easily be isolated here by running\nstrings or grep from the command line without ever opening the DOC itself. The threat actors\nare likely to change this up in the future in order to frustrate automated analysis efforts.\n\n## Conclusion\n\nAnyways, that’s it, my take on a quick analysis of a recent “Squirrelwaffle” maldoc. It will be\ninteresting to track these campaigns if they become more prevalent in the future. It is always\nworthwhile to take a look at adversary TTPs, and I hope this information will be helpful to\ninvestigators that may be looking to extract IOCs and better understand an emerging threat.\nAs more information becomes available I will need to take a deeper dive into the payload’s\ncapabilities, but will need to save that post for another time.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-18 - “Squirrelwaffle” Maldoc Analysis.pdf"
    ],
    "report_names": [
        "2021-09-18 - “Squirrelwaffle” Maldoc Analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535838,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653689560,
    "ts_modification_date": 1653689560,
    "files": {
        "pdf": "https://archive.orkl.eu/5f5800ff1a179a35fefe28a38b57f55f2b161d82.pdf",
        "text": "https://archive.orkl.eu/5f5800ff1a179a35fefe28a38b57f55f2b161d82.txt",
        "img": "https://archive.orkl.eu/5f5800ff1a179a35fefe28a38b57f55f2b161d82.jpg"
    }
}