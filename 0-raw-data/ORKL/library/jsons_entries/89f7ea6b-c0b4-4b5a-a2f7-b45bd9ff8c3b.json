{
    "id": "89f7ea6b-c0b4-4b5a-a2f7-b45bd9ff8c3b",
    "created_at": "2023-02-18T02:07:37.032249Z",
    "updated_at": "2025-03-27T02:16:59.163162Z",
    "deleted_at": null,
    "sha1_hash": "5c98044dcde42756b411a621a74acd3eec89a2c9",
    "title": "2021-07-01 - Evasive Techniques Used By Malicious Linux Shell Scripts",
    "authors": "",
    "file_creation_date": "2023-02-17T01:41:50Z",
    "file_modification_date": "2023-02-17T01:41:50Z",
    "file_size": 896975,
    "plain_text": "# Evasive Techniques Used By Malicious Linux Shell Scripts\n\n**[uptycs.com/blog/evasive-techniques-used-by-malicious-linux-shell-scripts](https://www.uptycs.com/blog/evasive-techniques-used-by-malicious-linux-shell-scripts)**\n\n_Research by: Siddartha Sharma and Adhokshaj Mishra_\n\n[In our previous blog, we discussed the common utilities in Linux which are generally used by](https://www.uptycs.com/blog/linux-commands-and-utilities-commonly-used-by-attackers)\nthreat actors in the attack chain. This blog discusses the common defense evasion techniques\nwhich are mostly used in malicious shell scripts and how Uptycs detects them.\n\n## Background\n\nAttackers use malicious shell scripts as an initial vector to download malicious payloads to\nthe victim system. In the earlier days, base64 and other common encoding schemes were\nused to evade defensive parameters. But nowadays, threat actors are adopting newer\ntechniques that include commands to disable firewalls, monitoring agents etc.\n\nThe common evasive techniques which we identified in the malicious shell scripts are as\nfollows:\n\n**Technique 1: Uninstalling monitoring Agents**\n**Technique 2: Disabling Firewalls and Interrupts**\n**Technique 3: Disabling Linux Security Modules(LSMs)**\n**Technique 4: Modifying ACLs**\n**Technique 5: Changing Attributes**\n**Technique 6: Renaming common Utilities**\n\nWe will be using the hash\n(39ac019520a278e350065d12ebc0c24201584390724f3d8e0dc828664fee6cae) to\ndemonstrate and explain in brief about these techniques.\n\n## Technique 1: Uninstalling monitoring Agents\n\nMonitoring agents are the softwares that regularly monitors the activities going on in the\nsystem related to process and network. Various logs are also created by the monitoring\nagents which helps as an aid during any incident investigation.\n\nThe malicious script, we found in our inhouse osquery based sandbox tries to:\n\nUninstall Cloud related monitoring agent Aegis(Alibaba cloud threat detection agent),\nstopping the aliyun service.\nUninstall YunJing which is a host security agent from Tencent.\n\n\n-----\n\nUninstall BCM client management agent which is generally installed on Endpoints for risk\nmitigation.\n\n**Figure 1: Script Uninstalling monitoring agents**\n\n## Technique 2: Disabling Firewalls and Interrupts\n\nMost of the systems and servers deploy firewalls as a defense mechanism.In the malicious\nscript, attackers try to disable the firewall i.e., uninterrupted firewall (ufw) as a defense\nevasive tactic.. Along with that attackers also remove iptables rules (iptables -F) because it\nis widely used for managing the firewall rules on linux systems and servers.(see figure 2)\n\n**Figure 2: Script Disabling Firewall**\n\n\n-----\n\nAttackers also used the commands to disable non-maskable Interrupt(nmi).Watchdog is\nbasically a configurable timer mechanism which generates interrupt at a particular given\ncondition and time.In case of the system freeze, the nmi watchdog interrupt handler would\nkill the task which is responsible for the system freeze.To evade this defense mechanism,\nattackers disable watchdog feature using sysctl command or temporarily disabling it by\nsetting the value to ‘0’.(see figure 3)\n\n**Figure 3: Script Disabling kernel watchdog**\n\n## Technique 3: Disabling Linux Security Modules (LSMs)\n\nThe malicious shell script also disables Linux security modules like SElinux, Apparmor.\nThese modules are designed to implement mandatory access control(MAC) policies. A server\nadministrator could simply configure these modules to provide the users restricted access to\nthe installed or running applications in the system.\n\n### AppArmour\n\nAppArmour is a security feature in linux which is used to lock down applications like firefox\nfor increased security. A user can restrict an application in Ubuntu’s default configuration by\ngiving limited permission to a certain application.\n\n**Figure 4: Commands disabling AppArmour**\n\n### SElinux\n\nSElinux is another security feature in linux systems by which a security administrator could\napply security context on certain applications and utilities. On some web servers the shell is\ndisabled or restricted so for RCE(Remote Code Execution) adversaries usually bypass/disable\nthis:\n\n\n-----\n\n**Figure 5: Commands disabling SElinux**\n\n## Technique 4: Modifying ACLs\n\nACLs or Access control Lists contain the rules by which permissions on files and utilities are\nbeing granted. Filesystem ACLs tell operating systems which users can access the system,\nand what privileges the users are allowed. Setfacl utility in linux is used to modify, remove\nthe ACL, in the script we can see the usage of setfacl which sets permissions of chmod for the\nuser:\n\n**Figure 6: ACL modification**\n\n## Technique 5: Changing Attributes\n\n**_[Chattr in linux is used to set/unset certain attributes of a file, more on chattr utility here .](https://man7.org/linux/man-pages/man1/chattr.1.html)_**\nAdversaries use this for their own dropped files or to make their files immutable so that a\nuser cannot delete it:\n\n**Figure 7.1: Chattr usage for dropped malicious file**\n\nAnother scenario:\n\n\n-----\n\n**Figure 7.2:** **Making the keys file immutable**\n\n## Technique 6: Renaming common Utilities\n\nOne of the malicious scripts\n(d7c4693f4c36d8c06a52d8981827245b9ab4f63283907ef8c3947499a37eedc8)\nalso contained common utilities like wget,curl used with different names. These utilities are\ngenerally used to download files from the remote IP. Attackers use these utilities to download\nmalicious files from C2.Some of the security solutions whose detection rules monitor the\nexact names of the utilities might not trigger the download event if wget,curl are used under\ndifferent names.\n\n**Figure 8: Utilities getting renamed in the script**\n\n**Figure 9: Usage of renamed common utilities**\n\n## Uptycs EDR Detections\n\nUptycs EDR armed with YARA process scanning detected these malicious scripts with a\nthreat score of 10/10.\n\n\n-----\n\n**Figure 10: chattr and setfacl usage**\n\n**Figure 11:Toolkit data showing attribution**\n\n\n-----\n\n## Uptycs EDR queries\n\nAlongside the detections, Uptycs EDR also records all the events we mentioned above in the\n**process_events table. Using the queries below, incident response analysts can easily**\nidentify such malicious events:\n\n**_Firewall disabling_**\n\nselect * from process_events where exe_name = 'ufw';\n**_ACL modification_**\n\nselect * from process_events where exe_name = 'setfacl';\n**_Chattr utility usage_**\n\nselect * from process_events where exe_name = 'chattr' and cmdline = 'chattr\n**+ia /home/hilde/.ssh/authorized_keys2';**\n**_Checking renamed common utilities (wget,curl)_**\n\nselect * from process_events where exe_name = 'mv';\n\n## Conclusion\n\nAs attackers are using more sophisticated and novel methods for evasion, it becomes\nincreasingly important to monitor and record the activities happening in the system. Uptycs\nEDR offers the added benefit of taking a deep dive into the events logged, providing more\ninsights of an attack. The reactive nature of Uptycs’ EDR helps to log everything whatever\ngoes on in the system.\n\nWe recommend the following measures:\n\nRegularly monitor the suspicious processes, events, and network traffic spawned on the\nexecution of any untrusted binary.\nKeep systems and firmware updated with the latest releases and patches.\n\n## Hashes\n\n**_39ac019520a278e350065d12ebc0c24201584390724f3d8e0dc828664fee6cae_**\n**_1ad0104478301e73e3f49cdeb10f8c1a1d54bccf9248e34ff81352598f112e6b_**\n**_b60ffcc7153650d6a232b1cb249924b0c6384c27681860eb13b12f4705bc0a05_**\n**_3b280a4017ef2c2aef4b3ed8bb47516b816166998462899935afb39b533890ad_**\n**_7b6f7c48256a8df2041e8726c3490ccb6987e1a76fee947e148ea68eee036889_**\n**_d7c4693f4c36d8c06a52d8981827245b9ab4f63283907ef8c3947499a37eedc8_**\n\n## Want to Learn More About How Uptycs Can Help Secure Your Linux Environments?\n\n**[Watch A 15-Minute Demo!](https://www.uptycs.com/cs/c/?cta_guid=b83d9083-ff8f-47ab-a3cc-68f969c14c24&signature=AAH58kHZJ0c_0bqf-3RMGQ8NQsNywo669g&pageId=49916566605&placement_guid=5cd7b494-d0e1-4507-86ac-9b0bcf761125&click=acfccdff-3de9-4da7-b61d-8a5fdf928106&hsutk=&canon=https%3A%2F%2Fwww.uptycs.com%2Fblog%2Fevasive-techniques-used-by-malicious-linux-shell-scripts&portal_id=2617658&redirect_url=APefjpFTlZQw23olJkQExJPgHN1240Krz4Pk-r70ebjS04AKXoKRq_jU_E8sWRGEg4uC6plUUNJiVFIBocKyrslUYCELqLcw6qR0xtphjuFhKHO71D5OIaITslzpSTUCddvTXUli57U22XK6JW587JM-4Djmw2g0cw)**\n\n\n-----\n\n[Tag(s): Threat Hunting,](https://www.uptycs.com/blog/tag/threat-hunting) [Endpoint Security](https://www.uptycs.com/blog/tag/endpoint-security)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Linux/Evasion/2021-07-01 - Evasive Techniques Used By Malicious Linux Shell Scripts.pdf"
    ],
    "report_names": [
        "2021-07-01 - Evasive Techniques Used By Malicious Linux Shell Scripts.pdf"
    ],
    "threat_actors": [
        {
            "id": "1f6ae238-765f-4495-9d54-6a7883d7a319",
            "created_at": "2022-10-25T16:07:24.573456Z",
            "updated_at": "2025-03-27T02:02:10.284644Z",
            "deleted_at": null,
            "main_name": "TA511",
            "aliases": [
                "MAN1",
                "Moskalvzapoe"
            ],
            "source_name": "ETDA:TA511",
            "tools": [
                "Agentemis",
                "Chanitor",
                "Cobalt Strike",
                "CobaltStrike",
                "Ficker Stealer",
                "Hancitor",
                "NetSupport",
                "NetSupport Manager",
                "NetSupport Manager RAT",
                "NetSupport RAT",
                "NetSupportManager RAT",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "542cf9d0-9c68-428c-aff8-81b6f59dc985",
            "created_at": "2023-02-15T02:01:49.554105Z",
            "updated_at": "2025-03-27T02:00:03.110991Z",
            "deleted_at": null,
            "main_name": "Moskalvzapoe",
            "aliases": [
                "MAN1",
                "TA511"
            ],
            "source_name": "MISPGALAXY:Moskalvzapoe",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3fff98c9-ad02-401d-9d4b-f78b5b634f31",
            "created_at": "2023-01-06T13:46:38.376868Z",
            "updated_at": "2025-03-27T02:00:02.818071Z",
            "deleted_at": null,
            "main_name": "Cleaver",
            "aliases": [
                "Cobalt Gypsy",
                "G0003",
                "Operation Cleaver",
                "Op Cleaver",
                "Tarh Andishan",
                "Alibaba",
                "TG-2889"
            ],
            "source_name": "MISPGALAXY:Cleaver",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1676686057,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1676598110,
    "ts_modification_date": 1676598110,
    "files": {
        "pdf": "https://archive.orkl.eu/5c98044dcde42756b411a621a74acd3eec89a2c9.pdf",
        "text": "https://archive.orkl.eu/5c98044dcde42756b411a621a74acd3eec89a2c9.txt",
        "img": "https://archive.orkl.eu/5c98044dcde42756b411a621a74acd3eec89a2c9.jpg"
    }
}