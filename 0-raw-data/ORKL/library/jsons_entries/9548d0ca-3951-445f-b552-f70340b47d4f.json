{
    "id": "9548d0ca-3951-445f-b552-f70340b47d4f",
    "created_at": "2023-06-05T02:06:46.992311Z",
    "updated_at": "2025-03-27T02:06:06.341089Z",
    "deleted_at": null,
    "sha1_hash": "ca2b43e9b0d8aa052353302450b3c803690e889f",
    "title": "2023-04-06 - PhotoLoader ICEDID",
    "authors": "",
    "file_creation_date": "2023-06-04T12:24:10Z",
    "file_modification_date": "2023-06-04T12:24:10Z",
    "file_size": 375033,
    "plain_text": "# PhotoLoader ICEDID\n\n**[research.openanalysis.net/icedid/bokbot/photoloader/config/2023/04/06/photoloader.html](https://research.openanalysis.net/icedid/bokbot/photoloader/config/2023/04/06/photoloader.html)**\n\nOALABS Research April 6, 2023\n\n## Overview\n\n#### Photoloader is the initial loader stage used to load ICEDID,\n\n ICEDID was originally used for banking credential theft with a later pivot as a reconnaissance tool for pre-ransomware intrusions. The webinjects used for credential theft are still active though this malware is most often associated with ransomware incidents.\n\n According to Proofpoint there is a fork of ICEDID that does not have webinject capability and is possibly developed by three separate actors...\n\n Standard IcedID Variant – The variant most commonly observed in the threat landscape and used by a variety of threat actors.\n\n Lite IcedID Variant – New variant observed as a follow-on payload in November Emotet infections that does not exfiltrate host data in the loader checkin and a bot with minimal functionality.\n\n Forked IcedID Variant – New variant observed by Proofpoint researchers in February 2023 used by a small number of threat actors which also delivers the bot with minimal functionality.\n\n### References\n\n#### DFIRReport:ICEDID -> Quantum ransomware- ICEDIDs network infrastructure is alive and well ICEDID Configuration Extractor Fork in the Ice: The New Era of IcedID icedid_peloader.py New version of IcedID Trojan uses steganographic payloads\n\n### Samples\n\n#### new loader sample (dfir report)2db4fadfb2565fd9474e4d5303f953e96ac248de3267014c32e8a669e7e600e0 UnpacMe older sample\n```\n   963397cec08790b25ff273cbe4b133634ae045d5ff8a4492e6f585f2ad14db65UnpacMe\n\n```\n\n-----\n\n#### old unpacked 32bit photoloader\n\n`1b01700425c30c2c498718966aee96cfdebacc2f6167576f7aa56e3f43ec3282` [malpedia](https://malshare.com/sample.php?action=detail&hash=1b01700425c30c2c498718966aee96cfdebacc2f6167576f7aa56e3f43ec3282)\n\n## Analysis\n\n#### It looks like the Malpedia photoloader yara rules are a bit too loose and match the newer \"gzip\" variant of the loader. The config location/encryption is different between these two loaders and photoloader has not been used in a few years. We are going to create a new rule that will be used to only match the newer variants.\n\n### Rule\n\n#### This rule is heavily influenced by the elastic rules in their config extractor\n```\nrule icedid_loader {    \n\n  strings:\n\n    $a1 = \"; _gat=\" wide fullword\n\n    $a2 = \"; _ga=\" wide fullword\n\n    $a3 = \"; _u=\" wide fullword\n\n    $a4 = \"; __io=\" wide fullword\n\n    $a5 = \"; _gid=\" wide fullword\n\n    $a6 = \"loader_dll_64.dll\" ascii fullword\n\n    $config_decryption1 = {45 33 C0 4C 8D 0D ?? ?? ?? ?? 49 2B C9 4B 8D 14 08 49\nFF C0 8A 42 ?? 32 02 88 44 11 ?? 49 83 F8 }\n\n    $config_decryption2 = { 00 42 8A 44 01 ?? 42 32 04 01 88 44 0D ?? 48 FF C1 48\n83 F9 }\n\n    condition:\n\n      filesize < 60000 and\n\n      (\n\n        (3 of ($a*) and $config_decryption1) or\n\n        $config_decryption2\n\n      )\n\n}\n\n\n### Config Extractor\n\n#### This is a modified version of the elastic config extractor\nimport pefile\n\nimport re\n\nimport struct\n\nfile_data =\nopen('/tmp/samples/963397cec08790b25ff273cbe4b133634ae045d5ff8a4492e6f585f2ad14db65',\n'rb').read()\n\npe = pefile.PE(data = file_data)\n\n```\n\n-----\n\n```\nIMAGE_SCN_CNT_CODE 0x00000020\n\ndef xor(data, key):\n\n  out = []\n\n  for i in range(len(data)):\n\n    out.append(data[i] ^ key[i % len(key)])\n\n  return bytes(out)\n\ndef is_ascii(s):\n\n  return all((c < 128 and c > 39) or c == 0 for c in s)\n\n\nkey = None\n\ndomain = None\n\ncampaign_id = None\n\n\nmapped = False\n\nif pe.sections[0].get_data()[:100] == b'\\x00'*100:\n\n  print(\"Mapped!\")\n\n  mapped = True\n\nfor s in pe.sections:\n\n  if (s.Characteristics & IMAGE_SCN_CNT_CODE) == 0:\n\n    if mapped:\n\n      section_data = file_data[s.VirtualAddress:s.VirtualAddress +256]\n\n    else:\n\n      section_data = s.get_data()\n\n    if len(section_data) < 250:\n\n      print(\"Section too small\")\n\n      continue\n\n    # This is a hack to skip stuff that doesn't look like a key\n\n    tmp_key = section_data[:32]\n\n    if b'\\x00'*10 in tmp_key:\n\n      print(\"Too many nulls in key\")\n\n      continue\n\n    data = section_data[64:96]\n\n    tmp_config = xor(data, tmp_key)\n\n    domain = None\n\n    try:\n\n      domains = tmp_config[4:]\n\n      domains = domains.split(b\"\\x00\")\n\n      if not is_ascii(domains[0]):\n\n            continue\n\n      domain = domains[0].decode(\"UTF-8\")\n\n    except:\n\n      print(\"Domain decode error\")\n\n      continue\n\n    if len(domain) < 5:\n\n      print(\"Domain too small\")\n\n      continue\n\n    # If we are here we have a config!\n\n```\n\n-----\n\n```\n    campaign_id struct.unpack( <I, tmp_config[:4])[0]\n\n    key = tmp_key.hex()\n\n    break\n\nassert key is not None\n\nassert domain is not None\n\nassert campaign_id is not None\n\nconfig = {\n\n      \"campaign_id\": campaign_id,\n\n      \"domains\": domain,\n\n      \"key\": key,\n\n     } \n\nprint(config)\n\nMapped!\n\nToo many nulls in key\n\n{'campaign_id': 3581911946, 'domains': 'smockalifatori.com', 'key':\n'5e845c90daccb7f15a824ddf17ebccb65094b386fa909bf6c802f42a295e5dc1'}\n\n```\n\n-----\n\n```\ndef is_ascii(s):\n\n  return all((c < 128 and c > 39) or c == 0 for c in s)\n\ndef extract_config(file_path):\n\n  file_data = open(file_path, 'rb').read()\n\n  pe = pefile.PE(data = file_data)\n\n  mapped = False\n\n  if pe.sections[0].get_data()[:100] == b'\\x00'*100:\n\n    #print(\"Mapped!\")\n\n    mapped = True\n\n  key = None\n\n  domain = None\n\n  campaign_id = None\n\n  try:\n\n    for s in pe.sections:\n\n      if (s.Characteristics & IMAGE_SCN_CNT_CODE) == 0:\n\n        if mapped:\n\n          section_data = file_data[s.VirtualAddress:s.VirtualAddress +256]\n\n        else:\n\n          section_data = s.get_data()\n\n        if len(section_data) < 250:\n\n          #print(\"Section too small\")\n\n          continue\n\n        # This is a hack to skip stuff that doesn't look like a key\n\n        tmp_key = section_data[:32]\n\n        if b'\\x00'*10 in tmp_key:\n\n          #print(\"Too many nulls in key\")\n\n          continue\n\n        data = section_data[64:96]\n\n        tmp_config = xor(data, tmp_key)\n\n        domain = None\n\n        try:\n\n          domains = tmp_config[4:]\n\n          domains = domains.split(b\"\\x00\")\n\n          if not is_ascii(domains[0]):\n\n            continue\n\n          domain = domains[0].decode(\"UTF-8\")\n\n        except:\n\n          #print(\"Domain decode error\")\n\n          continue\n\n        if len(domain) < 5:\n\n          #print(\"Domain too small\")\n\n          continue\n\n        # If we are here we have a config!\n\n        campaign_id = struct.unpack('<I', tmp_config[:4])[0]\n\n        key = tmp_key.hex()\n\n        break\n\n    assert key is not None\n\n```\n\n-----\n\n```\n    assert domain is not None\n\n    assert campaign_id is not None\n\n    config = {\n\n          \"campaign_id\": campaign_id,\n\n          \"domains\": domain,\n\n          \"key\": key,\n\n         } \n\n  except:\n\n    return {}\n\n  return config\n\n\n\n# import required module\n\nimport os\n\n# assign directory\n\ndirectory = '/tmp/samples/'\n\n# iterate over files in\n\n# that directory\n\nfor filename in os.listdir(directory):\n\n  f = os.path.join(directory, filename)\n\n  # checking if it is a file\n\n  if os.path.isfile(f):\n\n    print(f)\n\n    config = extract_config(f)\n\n    print(config)\n\n```\n\n-----\n\n```\n/tmp/samples/884cdf248d0235d77adc1d88603d460d64c88c517d5e571b75749be42364d6a8\n\n{'campaign_id': 3248465841, 'domains': 'qsertopinajil.com', 'key':\n'e999037e2b4084f0c1284ac991eca172030d99a0fd13ad6061af36c0d26bd1c0'}\n\n/tmp/samples/a2158fb6574d9d8f473eee19b6cba91f2d5c0fc5289e9245bb4d290380e22226\n\n{'campaign_id': 2615141838, 'domains': 'olifamagaznov.com', 'key':\n'287130e4e0b4080bf367a2a3aaede31b5d652977f5e8a702b1c25b1afc7c2368'}\n\n/tmp/samples/056de2c7a57fb4022d19398c6fc2676565afcda5e1f05ba0d91e58284e36d682\n\n{'campaign_id': 133894510, 'domains': 'restorahlith.com', 'key':\n'aa677c588cb603932a4965e66ca04fbfb85784e26eb18cb73555537c554a0568'}\n\n/tmp/samples/f1a6325da85adcae0b21cd02592dfc4747fbe5b4eb428dd515000e35cc4e7f47\n\n{'campaign_id': 3278418257, 'domains': 'ariopolanetyoa.com', 'key':\n'7bbf03f22f1a464224f55dd9c01de97d218f26e8058e48b749ba1892293b99b1'}\n\n/tmp/samples/4cda20be09dd99ab0ccf618a6c1c62122f0c484fb5925031b6ab3e7ce2f016ae\n\n{}\n/tmp/samples/98984bc4bd9af65911d9102bde5cae341ffb9bcc913aca1fe69093466176a058\n\n{'campaign_id': 3248465841, 'domains': 'qsertopinajil.com', 'key':\n'e999037e2b4084f0c1284ac991eca172030d99a0fd13ad6061af36c0d26bd1c0'}\n\n/tmp/samples/6391cf53ec2894915b2fe913913212ee074b28e8c52b2cd1039a6a1ba0b7efc0\n\n{}\n/tmp/samples/963397cec08790b25ff273cbe4b133634ae045d5ff8a4492e6f585f2ad14db65_rebase.e\n\n{'campaign_id': 3581911946, 'domains': 'smockalifatori.com', 'key':\n'5e845c90daccb7f15a824ddf17ebccb65094b386fa909bf6c802f42a295e5dc1'}\n\n/tmp/samples/963397cec08790b25ff273cbe4b133634ae045d5ff8a4492e6f585f2ad14db65\n\n{'campaign_id': 3581911946, 'domains': 'smockalifatori.com', 'key':\n'5e845c90daccb7f15a824ddf17ebccb65094b386fa909bf6c802f42a295e5dc1'}\n\n/tmp/samples/e6648ec933fc75d78621f4be11b2391949c65e1822316a4d56d5ebd9a008a544\n\n{'campaign_id': 1228806356, 'domains': 'klepdrafooip.com', 'key':\n'c7876ea3c330edfc2acf9d6ba61cccf08411ff1cbf69783738b072af97fe35ee'}\n\n/tmp/samples/866011c18e7db2ad7203600a59f050654787aef69741b718a8f6d938260245b5\n\n{'campaign_id': 1348756909, 'domains': 'utorsabegot.com', 'key':\n'5abb51b1624cf8d72e7396508290289506e3ae86106a05777692136daa1fb254'}\n\n/tmp/samples/2c41811701b287107fe0e0218652eba7621988b9ee7aa1090d34679d7c62d4d0\n\n{'campaign_id': 2076641214, 'domains': 'alishabrindeader.com', 'key':\n'7eca10dee216a6911fc9010b144bd46467042d0e5a8d9529ab0d3f09c94555f0'}\n\n/tmp/samples/e0c14b14c0715225f710b77ed50bba269549d7bde9bf058fc30e47fe8bbe2a85\n\n{'campaign_id': 3954321778, 'domains': 'ehonlionetodo.com', 'key':\n'ffe77b49c0284a4eb902e8dd15d56c910e58c78664408be3b255ff13c1c322d9'}\n\n/tmp/samples/1df8dce6c6807fa52d3e655d3d29cdceff3b4e7f5c2354947e973f8174439639\n\n{'campaign_id': 3324185820, 'domains': 'druidfenixis.com', 'key':\n'03b0f4ecb82527644b80fbe33f3c3c686d75a37567b5742f51ae69e0cf6b2815'}\n\n/tmp/samples/244781cba0c9e5cc3763a9a8b450d0b567698ff76541bad100da2f985f115376\n\n{'campaign_id': 1228806356, 'domains': 'klepdrafooip.com', 'key':\n'c7876ea3c330edfc2acf9d6ba61cccf08411ff1cbf69783738b072af97fe35ee'}\n\n/tmp/samples/20d215358269e71b4f37714b209c0b2042cd2275f75ba95cc3918aabf4b004a6\n\n{'campaign_id': 2492795688, 'domains': 'greenfairsaid.com', 'key':\n'02d91b9c520f7a80db3eaf20bffec772ea2de8c18d6d77b42ea46da40f5f5ebb'}\n\n/tmp/samples/5179c4c9efedcb05458b624397c957608a92a4327860e913cc82fe64c5e8012e\n\n{'campaign_id': 3131022508, 'domains': 'wagringamuk.com', 'key':\n'ade2a8e94a5e9d004347aca5b19c7a2a07678a91fb8ed8bdad397354a999270b'}\n\n/tmp/samples/966c0e03cf32173367ef2249877ccb6f9b8b549534841e435e6f2aebb047c8c8\n\n{'campaign_id': 3195585424, 'domains': 'afrodizajoy.com', 'key':\n\n```\n\n-----\n\n```\n 8c0d72d85b4e23a9b62f9a0b7011c948ee20fdc7bdf3a62ef078698af877128d }\n\n/tmp/samples/1cada6c3166a8db10461cc53ac55985d646422a4c69665c2b6952719b4fc4a7f\n\n{'campaign_id': 2611621973, 'domains': 'aproillionsgif.com', 'key':\n'60706bb5637cf64d92711de022fdb2c6950b2f2eeedbbab35720eeadd3e9113e'}\n\n/tmp/samples/17edc5bee30e951fb612f78902153189a355854aa54a2d46f14665e7dcf542cd\n\n{'campaign_id': 176945684, 'domains': 'ilioskajyzi.com', 'key':\n'a0298811c76505a04a34d2e43cdd95a6d0c8f5ba6276987c1f95be052cf72dea'}\n\n/tmp/samples/e52d056d08d9eb9b4683e6bead0a87d13009e2602f829c4a137722e660d5397e\n\n{'campaign_id': 109932505, 'domains': 'ilekvoyn.com', 'key':\n'ae5c00d7b56528d2c82705a49c6511673553142bfc62fd816d35e4dd95364617'}\n\n/tmp/samples/a4934907f560be76607b543bbbe18eb143a10e810d07ccf39a22717967f22da8\n\n{'campaign_id': 2611621973, 'domains': 'aproillionsgif.com', 'key':\n'60706bb5637cf64d92711de022fdb2c6950b2f2eeedbbab35720eeadd3e9113e'}\n\n/tmp/samples/2db4fadfb2565fd9474e4d5303f953e96ac248de3267014c32e8a669e7e600e0\n\n{'campaign_id': 2220668032, 'domains': 'alockajilly.com', 'key':\n'9c721d32ebaef948d97b5c598d5d245b01f1da2eba9e034139344192534bd8a6'}\n\n/tmp/samples/93fae86b3d23aeee26731a04ccac78b127000cd6d51c2f5096fb230996c8a910\n\n{'campaign_id': 1392658338, 'domains': 'nrncipalmoonw.com', 'key':\n'80b33f829e0b667861e6e5efac3825b7751a6e27e326796e62c8f4147176e064'}\n\n/tmp/samples/c139cc51b09e6a0c0415b665c3cec704299cca185f5f7c9e239bdf82e3911245\n\n{'campaign_id': 1732687004, 'domains': 'keepfootbal.com', 'key':\n'9c8f084e492b44179c83e50fb2ec25d644429ea9f67060fa0d4962c3a85c3808'}\n\n/tmp/samples/b44eb70fc9830829c73d92b510756df55e0fe0f1be15ec6a12f18517a3147603\n\n{'campaign_id': 2546188793, 'domains': 'anisiderblomm.com', 'key':\n'40811aaff35e3c0330a698ed3c0b353e1395ae6301b3edaf4a99a09953580fef'}\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-06 - PhotoLoader ICEDID.pdf"
    ],
    "report_names": [
        "2023-04-06 - PhotoLoader ICEDID.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1685930806,
    "ts_updated_at": 1743041166,
    "ts_creation_date": 1685881450,
    "ts_modification_date": 1685881450,
    "files": {
        "pdf": "https://archive.orkl.eu/ca2b43e9b0d8aa052353302450b3c803690e889f.pdf",
        "text": "https://archive.orkl.eu/ca2b43e9b0d8aa052353302450b3c803690e889f.txt",
        "img": "https://archive.orkl.eu/ca2b43e9b0d8aa052353302450b3c803690e889f.jpg"
    }
}