{
    "id": "c8c21c4a-1d32-4e0d-a456-8550d67e6849",
    "created_at": "2023-01-12T15:04:59.078696Z",
    "updated_at": "2025-03-27T02:05:58.354909Z",
    "deleted_at": null,
    "sha1_hash": "36044bdedc6dfd1273067721ee727ffcdcd25aa4",
    "title": "2021-08-19 - How to proactively defend against Mozi IoT botnet",
    "authors": "",
    "file_creation_date": "2022-05-27T20:59:28Z",
    "file_modification_date": "2022-05-27T20:59:28Z",
    "file_size": 233910,
    "plain_text": "# How to proactively defend against Mozi IoT botnet\n\n**[microsoft.com/security/blog/2021/08/19/how-to-proactively-defend-against-mozi-iot-botnet/](https://www.microsoft.com/security/blog/2021/08/19/how-to-proactively-defend-against-mozi-iot-botnet/)**\n\nAugust 19, 2021\n\nMozi is a peer-to-peer (P2P) botnet that uses a BitTorrent-like network to infect IoT devices\nsuch as network gateways and digital video records (DVRs). It works by exploiting weak\ntelnet passwords and nearly a dozen unpatched IoT vulnerabilities and it’s been used to1 2\nconduct distributed denial-of-service (DDoS) attacks, data exfiltration, and command or\npayload execution .3\n\n\nWhile the botnet itself is not new, Microsoft’s IoT security researchers recently discovered\nthat Mozi has evolved to achieve persistence on network gateways manufactured by\nNetgear, Huawei, and ZTE. It does this using clever persistence techniques that are\nspecifically adapted to each gateway’s particular architecture.\n\nNetwork gateways are a particularly juicy target for adversaries because they are ideal as\ninitial access points to corporate networks. Adversaries can search the internet for vulnerable\ndevices via scanning tools like Shodan, infect them, perform reconnaissance, and then move\nlaterally to compromise higher value targets—including information systems and critical\nindustrial control system (ICS) devices in the operational technology (OT) networks.\n\nBy infecting routers, they can perform man-in-the-middle (MITM) attacks—via HTTP\nhijacking and DNS spoofing—to compromise endpoints and deploy ransomware or cause\nsafety incidents in OT facilities. In the diagram below we show just one example of how the\nvulnerabilities and newly discovered persistence techniques could be used together. Of\ncourse, there are many more possibilities.\n\n\n-----\n\n_Figure 1: Attack flow for Mozi botnet._\n\n## Guidance: Proactive defense\n\nBusinesses and individuals that are using impacted network gateways (Netgear, Huawei,\nand ZTE) should take the following steps immediately to ensure they are resistant to the\nattacks described in this blog:\n\n1. Ensure all passwords used on the device are created using strong password best\n\npractices.\n2. Ensure devices are patched and up-to-date.\n\nDoing so will reduce the attack surfaces leveraged by the botnet and prevent attackers from\ngetting into a position where they can use the newly discovered persistence and other exploit\ntechniques described in more detail below.\n\nThe intelligence of our security cloud and all of our Microsoft Defender products, including\n[Microsoft 365 Defender (XDR),](https://www.microsoft.com/en-us/security/business/threat-protection/microsoft-365-defender) [Azure Sentinel (cloud-native SIEM/SOAR), as well as Azure](https://azure.microsoft.com/en-us/services/azure-sentinel/)\nDefender for IoT also provide protection from this malware and are continuously updated\nwith the latest threat intelligence as the threat landscape continues to evolve. The recent\n[acquisition of ReFirm Labs will further enhance Azure Defender for IoT’s ability to protect](https://www.microsoft.com/security/blog/2021/07/12/microsoft-to-acquire-riskiq-to-strengthen-cybersecurity-of-digital-transformation-and-hybrid-work/)\ncustomers with its upcoming deep firmware scanning, analysis capabilities which will be\n[integrated with Device Update for Azure IoT Hub’s patching capabilities.](https://docs.microsoft.com/en-us/azure/iot-hub-device-update/understand-device-update)\n\n## Technical description of new persistence capabilities\n\n\n-----\n\nApart from its known extensive P2P and DDoS abilities, we have recently observed several\nnew and unique capabilities of the Mozi botnet.\n\nTargeting Netgear, Huawei, and ZTE gateways, the malware now takes specific actions to\nincrease its chances of survival upon reboot or any other attempt by other malware or\nresponders to interfere with its operation. Here are some examples:\n\n### Achieving privileged persistence\n\nA specific check is conducted for the existence of the /overlay folder, and whether the\nmalware does not have write permissions to the folder /etc. In this case, it will try to exploit\n**[CVE-2015-1328.](https://nvd.nist.gov/vuln/detail/CVE-2015-1328)**\n\nSuccessful exploitation of the vulnerability will grant the malware access to the following\nfolders:\n\n/etc/rc.d\n/etc/init.d\n\nThen the following actions are taken:\n\nIt places the script file named S95Baby.sh in these folders.\nThe script runs the files /usr/networks or /user/networktmp. These are copies of the\nexecutable.\nIt adds the script to /etc/rcS.d and /etc/rc.local in case it lacks privileges.\n\n### ZTE devices\n\nA specific check is conducted for the existence of the /usr/local/ct folder; this serves as an\nindicator of the device being a ZTE modem/router device.\n\nThe following actions are taken:\n\nIt copies its other instance (/usr/networks) to /usr/local/ct/ctadmin0; this provides\npersistency for the malware.\nIt deletes the file /home/httpd/web_shell_cmd.gch. This file can be used to gain\n[access through exploitation of the vulnerability CVE-2014-2321; deleting it prevents](https://nvd.nist.gov/vuln/detail/CVE-2014-2321)\nfuture attacks.\nIt executes the following commands. These disable Tr-069 and its ability to connect to\nauto-configuration server (ACS). Tr-069 is a protocol for remote configuration of\nnetwork devices; it’s usually utilized by service providers to configure customers’\nequipment.\n\n\n-----\n\n```\nsendcmd 1 DB set MgtServer 0 Tr069Enable 1 \nsendcmd 1 DB set PdtMiddleWare 0 Tr069Enable 0 \nsendcmd 1 DB set MgtServer 0 URL http://127.0.0.1 \nsendcmd 1 DB set MgtServer 0 UserName notitms \nsendcmd 1 DB set MgtServer 0 ConnectionRequestUsername notitms \nsendcmd 1 DB set MgtServer 0 PeriodicInformEnable 0 \nsendcmd 1 DB save\n\n### Huawei devices\n\n```\nExecution of the following commands changes the password and disables the management\nserver for Huawei modem/router devices. It also prevents others from gaining access to the\ndevice through the management server.\n```\ncfgtool set /mnt/jffs2/hw_ctree.xml \nInternetGatewayDevice.ManagementServer URL http://127.0.0.1\ncfgtool set /mnt/jffs2/hw_ctree.xml \nInternetGatewayDevice.ManagementServer ConnectionRequestPassword acsMozi\n\n```\nTo provide an additional level of persistence it also creates the following files if needed and\nappends an instruction to run its copy from /usr/networks.\n```\n/mnt/jffs2/Equip.sh\n/mnt/jffs2/wifi.sh\n/mnt/jffs2/WifiPerformance.sh\n\n### Preventing remote access\n\n```\nThe malware blocks the following TCP ports:\n\n23—Telnet\n2323—Telnet alternate port\n7547—Tr-069 port\n35000—Tr-069 port on Netgear devices\n50023—Management port on Huawei devices\n58000—Unknown usage\n\nThese ports are used to gain remote access to the device. Shutting them increases the\nmalware’s chances of survival.\n\n### Script infector\n\nIt scans for .sh files in the filesystem, excluding the following paths:\n```\n/tmp /dev /var /lib /haha /proc /sys\n\n```\nIt also appends a line to each file. The line instructs the script to run a copy of the malware\nfrom /usr/networks. This increases its chances of survival on various devices.\n\n\n-----\n\n### Traffic injection and DNS spoofing capabilities\n\nThe malware receives commands from its distributed hash table (DHT) network. The latter is\na P2P protocol for decentralized communications. The commands are received and stored in\na file, of which parts are encrypted. This module works only on devices capable of IPv4\nforwarding. It checks whether /proc/sys/net/ipv4/ip_forward is set to 1; such positive\nvalidation is characteristic of routers and gateways. This module works on ports UDP 53\n(DNS) and TCP 80 (HTTP).\n\n### Configuration commands\n\nApart from the previously documented commands in Table 1—for more information, read A\nNew Botnet Attack Just Mozied Into Town—we also discovered these commands:\n```\n[hi] – Presence of the command indicates it needs to use the MiTM module.\n[set] – Contains encrypted portion which describes how to use the MiTM module.\n\n```\n**Command** **Description**\n\n**[ss]** Bot role\n\n**[ssx]** enable/disable tag [ss]\n\n**[cpu]** CPU architecture\n\n**[cpux]** enable/disable tag [cpu]\n\n**[nd]** new DHT node\n\n**[hp]** DHT node hash prefix\n\n**[atk]** DDoS attack type\n\n**[ver]** Value in V section in DHT protocol\n\n**[sv]** Update config\n\n**[ud]** Update bot\n\n**[dr]** Download and execute payload from the specified URL\n\n**[rn]** Execute specified command\n\n**[dip]** ip:port to download Mozi bot\n\n**[idp]** report bot\n\n**[count]** URL that used to report bot\n\n_Table 1. Previously documented Mozi commands._\n\n\n-----\n\n### DNS spoofing\n\nMozi receives a very simple list of DNS names which are then spoofed. Its structure is as\nfollows:\n```\n<DNS to spoof>:<IP to spoof>\n\n```\nEach DNS request is answered with the spoofed IP. This is an efficient technique to redirect\ntraffic to the attackers’ infrastructure.\n\n### HTTP session hijacking\n\nThis part of the MITM functionality is responsible for hijacking HTTP sessions. Not every\nHTTP request is processed. There are several conditions for it to be qualified for hijacking,\nmost of which are meant to restrict the module’s “level of noise” to lower the chances of it\nbeing discovered by network defenders.\n\nThe following are some of the rules:\n\nIt works only for HTTP GET requests. This means forms and more complex requests\nare ignored.\nA random number in the configuration states how many queries it would inject. This\nshows the attackers understand the importance of hiding this functionality. In other\nwords, they are lowering its footprint in order to avoid alerting the user of the hijacking.\nSome domains are ignored, most likely to avoid interference with the normal operation\nof certain types of equipment or to avoid detection by various security\ncountermeasures.\nIt only spoofs external traffic; HTTP requests inside the LAN are ignored.\nA test is conducted to validate that the URL doesn’t contain the string\n**“veri=20190909”—this is done to prevent injecting the already-injected pages.**\nIt returns a random HTTP response derived from a predefined list of responses. It has\nnine different types of hijacking; the specific type of hijacking and its parameters are\nderived from the configuration file. Below are a few examples of these hijacking\ntechniques.\nSome of the spoofing occurs via redirection using the HTTP Location header, as seen\nbelow.\n\n\n-----\n\n_Example 1: Spoofing via redirection using the HTTP Location header. This should_\n_automatically redirect without any user interaction._\n\n_Example 2: A hijacking method that only injects JavaScript; it is designed for ajax calls that_\n_evaluate the response, so this hijack method will inject a new script into the page._\n\n## Protecting from Mozi Malware\n\nIt is important to note that Microsoft Security solutions have already been updated to protect,\ndetect, and respond to Mozi and its enhanced capabilities.\n\nCustomers can use the network device discovery capabilities found in Microsoft Defender for\nEndpoint to discover impacted internet gateways on their IT networks and run vulnerability\n[assessments. Additionally, the agentless network-layer capabilities of Azure Defender for IoT](https://azure.microsoft.com/en-us/services/azure-defender-for-iot/)\ncan be used to perform continuous asset discovery, vulnerability management, and threat\ndetection for IoT and OT devices on their OT networks. This solution can be rapidly deployed\n(typically less than one day per site), and it is available for both on-premises and cloudconnected environments.\n\n\n-----\n\n[Defender for IoT is also tightly integrated with Azure Sentinel, which provides a bird s eye](https://azure.microsoft.com/en-in/services/azure-sentinel/)\nview across your entire enterprise—leveraging AI and automated playbooks to detect and\nrespond to multi-stage attacks that often cross IT and OT boundaries.\n\nIn addition to detecting targeted attacks and living-off-the-land (LOTL) tactics via IoT/OTaware behavioral analytics, Defender for IoT incorporates threat information derived from\ntrillions of signals analyzed daily by Microsoft’s global team of security experts using AI and\nmachine learning. This helps ensure our customers are continuously protected against both\nnew and existing threats.\n\nWhile we offer many solutions, it remains critical that each of the recommendations in the\n“Guidance: Proactive defense” section above be implemented on the impacted internet\ngateways to prevent them from becoming a vector of attack.\n\nTo learn more about how our integrated SIEM/XDR solutions, combined with Azure Defender\nfor IoT, can help secure your organization, please refer to the following resources:\n\n[To learn more about Microsoft Security solutions, visit our website. Bookmark the](https://www.microsoft.com/en-us/security/business/solutions) Security\nblog to keep up with our expert coverage on security matters. Also, follow us\nat [@MSFTSecurity for the latest news and updates on cybersecurity.](https://twitter.com/@MSFTSecurity)\n\n[1Mozi, Another Botnet Using DHT, Alex Turing, Hui Wang, NetLab 360, 23 December 2019.](https://blog.netlab.360.com/mozi-another-botnet-using-dht/)\n\n\n[2Mozi IoT Botnet, CERT-In, Ministry of Electronics and Information Technology Government](https://www.cyberswachhtakendra.gov.in/alerts/MoziIoTBotnet.html)\n\nof India, 12 November 2020.\n\n[3New Mozi Malware Family Quietly Amasses IoT Bots, Black Lotus Labs, Lumen, 13 April](https://blog.lumen.com/new-mozi-malware-family-quietly-amasses-iot-bots/)\n\n2020.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-19 - How to proactively defend against Mozi IoT botnet.pdf"
    ],
    "report_names": [
        "2021-08-19 - How to proactively defend against Mozi IoT botnet.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535899,
    "ts_updated_at": 1743041158,
    "ts_creation_date": 1653685168,
    "ts_modification_date": 1653685168,
    "files": {
        "pdf": "https://archive.orkl.eu/36044bdedc6dfd1273067721ee727ffcdcd25aa4.pdf",
        "text": "https://archive.orkl.eu/36044bdedc6dfd1273067721ee727ffcdcd25aa4.txt",
        "img": "https://archive.orkl.eu/36044bdedc6dfd1273067721ee727ffcdcd25aa4.jpg"
    }
}