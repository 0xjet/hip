{
    "id": "c445a3f8-a611-46c3-bf83-318e6d7ad4f2",
    "created_at": "2023-01-12T15:07:12.559355Z",
    "updated_at": "2025-03-27T02:05:18.048655Z",
    "deleted_at": null,
    "sha1_hash": "c787624d835f59ae20ed2c77d939186cd927d83c",
    "title": "2014-10-05 - Dissecting SmokeLoader (or Yulia's sweet ass proposition)",
    "authors": "",
    "file_creation_date": "2022-05-28T00:29:06Z",
    "file_modification_date": "2022-05-28T00:29:06Z",
    "file_size": 662371,
    "plain_text": "# Dissecting SmokeLoader (or Yulia's sweet ass proposition)\n\n**eternal-todo.com/blog/smokeloader-analysis-yulia-photo**\n\n[Analysis](https://eternal-todo.com/category/analysis)\n[Dofoil](https://eternal-todo.com/category/dofoil)\n[Malware](https://eternal-todo.com/category/malware)\n[Reversing](https://eternal-todo.com/category/reversing)\n[SmokeLoader](https://eternal-todo.com/category/smokeloader)\n[Spam](https://eternal-todo.com/category/spam)\n\nIn mid-August I started receiving some emails from Yulia. She wanted me to take a look at\nher sweet ass:\n\nI was not sure about it, but after receiving some more emails like this I took a look (I\nreceived the last one on the 10th of September). Then I found out that this was the\nbeginning of a SmokeLoader campaign, I was really disappointed :( Out of spite, I started\nanalyzing it ;p\n\nThese are some of the headers and the message body:\n```\n Date:  Wed, 13 Aug 2014 12:55:56 -0400\n From:  \"Yulia\" <negligentjsd185@dialectologic.in>\n Subject: My new photo\n Hi it is Yulia fuck me ass at night. Look at my sweet ass on a photo I wait for you\n\n```\n\n-----\n\nI don't want to duplicate the information already published about this loader, so you can\ncheck the [post published in July by StopMalvertising and](http://stopmalvertising.com/rootkits/analysis-of-smoke-loader.html) what my colleague Michael\nSandee said about it in 2012. Since then, SmokeLoader (known as Dofoil too) has\nmodified the encryption to communicate with the C&C, added some extra plugins, etc.\n\nAfter executing the binary you can easily spot that something is happening in your\ncomputer because you can see some strange POST requests to some known URLs.\nThese URLs are extracted from the registry, opening the key\n_Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall and looking at the values of_\n_HelpLink and URLInfoAbout for the installed programs._\n\nReally, first you see a GET request to http://www.msn.com/, then a “random” number of\nPOST requests with encoded data sent to familiar sites for you, the malware\ncommunication and, finally, a “random” number of POST requests again. I guess this is\njust to hide the real communication but sending strange POST requests is not really a\ngood way to hide it...\n\nIt is possible that you don't see any request. If this is the case then you have been\ndetected by our friend ;) The binary includes an anti-analysis function and you will end up\nin an endless loop if you are not able to pass all the checks.\n\n\n-----\n\n[SmokeLoader performs the following checks (some of them are mentioned here):](http://research.zscaler.com/2014/01/the-story-of-trojan-dropper-iii.html)\n\nChecks if the module filename contains “sample”.\nChecks if the C: volume serial number is 0xCD1A40 (ThreatExpert) or 0x70144646\n(Malwr).\nChecks if the modules “sbiedll” (Sandboxie) and “dbghelp” are loaded.\nChecks the disk enum key (System\\CurrentControlSet\\Services\\Disk\\Enum) looking\nfor:\n\nqemu\nvirtual\nvmware\nxen\nChecks if AutoItv3, CCleaner and WIC are installed looking in the registry\n(Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall). It seems that **this is a**\n**fingerprint for Joe Sandbox.**\n\nIn order to know if it is being running in a 64-bits operating system it checks the segment\nregister GS:\n```\nmov   ax, gs\ntest  ax, ax\njz   short loc_2934D0\ninc   ds:is64Bits\n\n```\nDepending on that it will use a different way to inject in explorer.exe and then to create an\nadditional svchost.exe process. This is well explained in the third step of this AVG blog\npost talking about ZeuS (one of these techniques uses the functions FindWindow,\n_GetWindowLongA and SetWindowLongA). It seems that this part of the code was_\ncopy/pasted too...\n\nAfter these steps, the malware is initialized, setting up the User-Agent (by default,\n_Mozilla/4.0), sending the GET request to MSN, creating the botid, the mutex, etc. Then is_\nwhen the fun starts, sending these fake POST requests and finally communicating with the\n\n\n-----\n\nC&C.\n\nThe server URLs are hardcoded in the binary, using some basic XOR operations to\nencode the data. There are at least two blocks with the following format:\n```\n[XOR_BYTE_KEY][BYTE2][BYTE3][BYTE3][SIZE][DATA]\n\n```\nOne block could be the main URL and the other the backup URL, but in the samples that I\nhave analyzed both blocks contain the same URLs. Every 10 minutes a POST request is\nsent to the SmokeLoader C&C, looking for new tasks. The request data has this format:\n```\ncmd=getload&login=$BOTID&sel=jopa1&ver=5.1&bits=0&admin=1&hash=&r=$GARBAGE\n\n```\n_cmd: Command sent to the panel._\n_login: botid with format %08X%08X%08X%08X%08X._\n_sel: seller id. It is hardcoded in the binary and identifies the user related to the_\ncampaign.\n_ver: OS version._\n_bits: If the OS is 64-bits or not._\n_admin: If the malware is running with Admin privileges or not._\n_hash: Disk binary hash (in the case it is a persistent version)._\n_r: Just garbage data. This is the only parameter included in the fake requests_\nmentioned above.\n\nThis data is encrypted with a modified version of RC4, resulting in a block like this:\n```\n[SIZE][KEY][ENCRYPTED_DATA]\n\n```\n\n-----\n\nThen a 404 response is received, but containing interesting data. This data is divided in a\nfirst block of digits, terminated with a null byte, and an encrypted block. The block of digits\ncan be easily decoded taking 3-digits groups and converting them to their corresponding\nbytes (“214”=0xD6). The first resultant byte is the XOR key to be used with the rest.\n\nAfter decoding the response we obtain something like this:\n```\nSmk0|:|socks_rules=127.0.0.1|:||:|hosts_rules=127.0.0.1\nlocalhost|:||:|plugin_size=60500\n\n```\nDepending on the character located in the 4th position (“0” in this case) the loader will\nperform a different action, asking for additional binaries to be installed, updating itself,\nremoving itself from the system, etc. The second block received in the 404 response\ncontains some plugins encrypted with the same modified RC4 algorithm. There is a 21byte header and then another 21-byte header per plugin. The plugin header has the\nfollowing format:\n```\n[PLUGIN_SIZE(4)][PLUGIN_TYPE(1)][KEY(16)]\n\n```\nBesides being encrypted, the plugins are also compressed with UPX and all of them are\nexporting the function \"Work\". These are the plugins that I have seen so far:\n\n\n-----\n\n_AVInfo.dll: It is a Delphi plugin which uses the Windows Management_\n**Instrumentation (WMI) to obtain the installed Antivirus and Firewall products. If**\nthe Antivirus product is not detected that way, it checks the running processes to find\nAntivirus processes:\n\navp.exe (Kaspersky)\nccsvchst.exe (Norton)\ndwservice.exe (DrWeb)\ndwengine.exe (DrWeb)\navgnt.exe (Avira)\navguard.exe (Avira)\nmalwaredefender.exe (Malware Defender)\n\nAfter gathering this information, it is reported to the control panel using this format:\n“cmd=avinfo&login=%s&info=%s777%s”. The Antivirus and Firewall product names are\nseparated by “777”.\n\n_FTPGrab.dll: This module injects code in every process in execution, decoding_\nanother plugin called Grabber.dll. This new plugin will hook the functions “send” and\n“WSASend” to collect users/passwords for the FTP, POP3, SMTP and IMAP\nprotocols. Then it will include this information in the request\n“cmd=ftpgrab&login=%s&grab=” and adding the following lines:\n\npop3://%s:%s@%s:%d\n[ftp://%s:%s@%s:%d](http://10.10.0.46/ftp://%s:%s@%s:%d)\nimap://%s:%s@%s:%d\nsmtp://%s:%s@%s:%d\n\n\n-----\n\n_shell.dll: If the server response includes the “shell_rules” parameter, then the_\ncommand specified is executed and the result is sent to the panel, encoded with\nBase64. The request used for this will be\n“cmd=getshell&login=%s&shell=$RESULT&run=ok”.\n\nThese plugins are stored on disk encrypted with the same modified RC4 algorithm, using\nthe botid as key. Besides these, there is another plugin, called Rootkit.dll, used to hook the\nfunctions ZwQuerySystemInformation, ZwQueryDirectoryFile and ZwEnumerateValueKey\nto try to hide the malware process, files and registry keys.\n\nThese are some of the samples used to write this blog post:\n\n\n-----\n\n```\n4fe5f69ca1ab813e829479004f262ccd\ndb3745ec149818567de5d2dfc3477d25\na4b7e8bf966ee5c6e2c731e9047968d4\ne1ee0990ffd0da3df13c1206a6bb9a4b\n86ca12376ab5e27534029d23b2952a28\n\n```\nThe C&C URLs related to these binaries are:\n```\nhxxp://joppwer.in/\nhxxp://offnamerty.ru/\nhxxp://jtp888888.ru/\n\n```\nSubmitted by jesparza on Sun, 2014/10/05 - 22:03\n\n[Español](https://eternal-todo.com/es/blog/analisis-smokeloader-yulia-ass-photo)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-10-05 - Dissecting SmokeLoader (or Yulia's sweet ass proposition).pdf"
    ],
    "report_names": [
        "2014-10-05 - Dissecting SmokeLoader (or Yulia's sweet ass proposition).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536032,
    "ts_updated_at": 1743041118,
    "ts_creation_date": 1653697746,
    "ts_modification_date": 1653697746,
    "files": {
        "pdf": "https://archive.orkl.eu/c787624d835f59ae20ed2c77d939186cd927d83c.pdf",
        "text": "https://archive.orkl.eu/c787624d835f59ae20ed2c77d939186cd927d83c.txt",
        "img": "https://archive.orkl.eu/c787624d835f59ae20ed2c77d939186cd927d83c.jpg"
    }
}