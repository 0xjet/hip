{
    "id": "c5590679-a71f-4d7d-b2f0-83551c7a16d4",
    "created_at": "2023-01-12T15:04:49.381986Z",
    "updated_at": "2025-03-27T02:05:23.876358Z",
    "deleted_at": null,
    "sha1_hash": "19f368d864a9a9225061ec95785d887a6d98a2db",
    "title": "2017-06-28 - Why NotPetya Kept Me Awake (& You Should Worry Too)",
    "authors": "",
    "file_creation_date": "2022-05-28T02:18:37Z",
    "file_modification_date": "2022-05-28T02:18:37Z",
    "file_size": 539902,
    "plain_text": "# Why NotPetya Kept Me Awake (& You Should Worry Too)\n\n**[tisiphone.net/2017/06/28/why-notpetya-kept-me-awake-you-should-worry-too/](https://tisiphone.net/2017/06/28/why-notpetya-kept-me-awake-you-should-worry-too/)**\n\nJune 28, 2017\n\nNotPetya may not have been the most sophisticated malware ever written. However, it was\nexceptionally effective due to the authors’ savvy exploitation of common security\nmisconceptions and their deep understanding of poor security architecture. I want to briefly\nexpress my personal thoughts on why I found NotPetya particularly concerning and a bad\nomen for things to come for the digital world.\n\n## Living Off The Land\n\nA lot of the news coverage on NotPetya is focusing heavily on the use of the stolen\n[EternalBlue (MS17-010) exploit. In my opinion, this distracts from something more sinister,](https://technet.microsoft.com/en-us/library/security/ms17-010.aspx)\nbecause patching Windows is in many cases a relatively clear and simple fix.\n\n[NotPetya has a choice of several means to move across a LAN once it is inside a perimeter.](https://www.theregister.co.uk/2017/06/28/petya_notpetya_ransomware/)\n[As well as exploiting MS17-010, it can also use PsExec and WMIC to move from system to](https://technet.microsoft.com/en-us/sysinternals/bb897553.aspx)\n[system after using a stripped down version of the Mimikatz tool to steal passwords from the](https://www.fireeye.com/blog/threat-research/2017/06/petya-ransomware-spreading-via-eternalblue-exploit.html)\nsystem it is on. PsExec and WMI are common methods of administering Windows systems\nand are provided by Microsoft.\n\nI’m honestly a little surprised we haven’t seen worms taking advantage of these mechanisms\nso elegantly on a large scale until now. They are [very popular tools in modern hacking. A](https://www.carbonblack.com/2016/04/06/who-needs-malware-powershell-and-wmi-are-already-there/)\ngood hacker avoids the use of malware and code exploits whenever possible. He or she may\nuse them occasionally where no other practical option exists – for instance, exploits might be\nneeded to escalate privileges on a system, or malware for initial phishing compromise – but\nevery use of malicious code is one more potential detection point for traditional signature\n\n-----\n\nbased antivirus and Intrusion Prevention Systems (which are relied on exclusively far too\noften). There’s no sense in using malicious code when simpler and quieter means are\n**available.**\n\nThe use of WMI to move laterally across a network is increasingly trendy, and the use of\n[PsExec to do so is nigh archaic now. Both methods remain stunningly effective, because](https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/)\nthey are popular avenues for systems administration and often inadequately monitored.\nLogging of WMI lateral movement was quite tricky until Windows 8, and with large swathes\nof Windows 7 (and older) still in use in business it’s still frequently neglected.\n\nThe use of these propagation methods alone is not likely to fire any built-in attack signature\nin traditional, signature-based security tools. There’s nothing to sandbox nor an unusual\nunique file hash to scan for. On the surface, this activity will look like administration, and\nmight only be detected by more detailed behavioral analysis. With the speed that NotPetya\nwas able to spread, this isn’t particularly practical.\n\n## Abusing Mandatory Software\n\nOne of the primary initial infection vectors of NotPetya was the compromise of the update\npackage for a piece of Ukrainian financial software, M.E.Doc. According to [reports, this](https://medium.com/@thegrugq/pnyetya-yet-another-ransomware-outbreak-59afd1ee89d4)\nsoftware is one of only two software options Ukrainian businesses have to pay their taxes.\nThis was a clever choice for three reasons:\n\n1. Attacks were constrained somewhat to Ukraine (and companies that have interests\n\nthere).\n2. The distribution base within the country was extremely comprehensive. Ukrainian\n\nbusinesses would have a high chance to have this software on a computer.\n[3. The software company was relatively small and may potentially have been](https://www.youtube.com/watch?v=TY5f2fmwcDE)\n\n[compromised previously, indicating it was potentially under-equipped to rapidly](https://t.co/OK4hGBv101)\nrespond to a sophisticated attack on this scale.\n\nThis is obviously not a new thought pattern – attackers have leveraged popular, commonly\ndeployed software for exploitation for decades. Adobe Flash and Java were two of the more\nabused programs in recent history because they had extremely wide installation bases.\nHowever, that was within the context of commodity malware and crimeware which typically\ninfect victims fairly indiscriminately. NotPetya delivery combined elements of a targeted\n[watering hole attack we’ve traditionally seen used by nation states with traditional software](https://en.wikipedia.org/wiki/Watering_hole_attack)\nexploitation to devastate a specific user base. Obviously, the potential of this avenue of\nattack can be explored further in the context of nearly any country or demographic.\n\n## Masquerading as Ransomware?\n\n\n-----\n\nIn both the case of WannaCry and NotPetya, we saw malware that was ostensibly\nransomware end up not looking as much like it after a deep dive under the hood and into\nattacker behavior. WannaCry had lackluster response to handling actual payments, and\n[NotPetya looked deceptively identical to the older ransomware Petya on the surface while](https://medium.com/@thegrugq/pnyetya-yet-another-ransomware-outbreak-59afd1ee89d4)\nfunctioning quite fundamentally differently (and not being particularly well designed to make\nmoney). This sowed confusion for responders, and eager security companies posted early\nmisleading reports. Masking targeted attacks as crimeware is an interesting strategic choice\nwhich could indicate a number of very troubling things. I will leave further speculation on\nthose to my natsec and threat intelligence colleagues.\n\n[Ransomware is loud. Until Cryptolocker in 2013, the majority of crimeware tended to be](https://en.wikipedia.org/wiki/CryptoLocker)\npurposefully quiet – stealing data and performing other nefarious tasks without its victim’s\nknowledge. Ransomware is intentionally disruptive. Independent of anything “cyber” it is also\na tremendously effective criminal enterprise model, so it has become increasingly popular.\nThere is plenty of clear evidence in the form of money and news stories that demonstrates\nhow much ransomware can impact victim organizations and individuals’ lives. This means\nransomware is also a great pretense for groups with other motives. They know their attack\nwill cause misery and lost money, and news organizations cover ransomware attacks\nenthusiastically (often without much further digging).\n\n## Abuse of Poor Network Security Architecture\n\nBeyond the use of native tools, NotPetya’s lateral movement mechanisms were extremely\neffective because they exploited common weaknesses in many big networks. Of course,\nunpatched (or not recently rebooted) Windows hosts were vulnerable to MS17-010\nexploitation. Beyond that, lateral movement with WMI and PsExec is very effective in\nenvironments with poor network security architecture and implementation. Flat networks\nwithout segmentation were vulnerable. Networks where their use was permitted were\nvulnerable. Networks where desktop users commonly had workstation admin or domain\nadmin permissions were vulnerable, and networks where these privileges were not restricted\n[or tightly controlled were more so. Windows 10 credential guard was a potential mitigation](http://www.thewindowsclub.com/credential-guard-windows-10)\nagainst the theft of passwords from system memory, but it is infrequently deployed and not\nbackwards compatible (or indeed, even compatible with every computer running Windows\n10).\n\nAll of these design and implementation problems are woefully common, repeatedly\nbemoaned by security professionals auditing and consulting on those networks. They are not\neasy or cheap problems to fix in many cases, and this is likely not going to be the case that\npushes a lot of vulnerable organizations over the edge in mitigation.\n\n## Yes, I’m Concerned\n\n\n-----\n\n**If you work outside Ukraine, you probably got really lucky, yesterday. Many enterprises**\nwere tremendously vulnerable to this type of attack, had they merely been targeted by the\ninitial attack vector one time.\n\n**Blood is in the water. Not only have criminals found that ransomware is a great money-**\nmaking scheme, but nation states and terrorist organizations have realized pseudoransomware makes a misleading and effective weapon. A weapon that can cause collateral\ndamage, globally.\n\n**Things are going to get worse, and the attack landscape is going to deteriorate. Malware**\nrelying more on legitimate credentials and native tools may easily render signature-based\nand hash-based solutions fundamentally less effective defenses. Organizations must no\nlonger rely on black boxes with good sales pitches to band-aid fundamental architectural\nfailures and neglected security best practices like out of date operating systems, liberal\nadministration policies, legacy protocols, or flat networks. Defense in depth, including human\nthreat hunting and effective detection and prevention at many points, is key. This will involve\npolicy and financial buy-in from many lagging organizations at a new level.\n\n[https://twitter.com/HackingDave/status/879864060392742913](https://twitter.com/HackingDave/status/879864060392742913)\n\nThe fact security guidance is labeled as 'Best Practices' and not 'Standard Operating\nProcedures' is what attackers count on for success.\n\n[— Jessica Payne (@jepayneMSFT) June 29, 2017](https://twitter.com/jepayneMSFT/status/880490299348238336?ref_src=twsrc%5Etfw)\n\n**_Edit: 6/28 10PM – Minor technical corrections to clarify the purpose of M.E. Doc, the debate_**\n_[over encryption issues in NotPetya, and grammatical errors. Thanks to MalwareTech,](https://twitter.com/MalwareTechBlog)_ _[grugq,](https://twitter.com/thegrugq)_\n_[and Jim Moore for pointing out my omissions, and duplicate words!](https://twitter.com/JimMoor70058163)_\n\n**_7/5 3PM – A video was posted of the seizure of M.E.Doc’s equipment which shows the_**\n_equipment and approximate number of employees at the firm._\n_[https://www.youtube.com/watch?v=TY5f2fmwcDE](https://www.youtube.com/watch?v=TY5f2fmwcDE)_\n\nThis blog will be updated as further information is available.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-06-28 - Why NotPetya Kept Me Awake (& You Should Worry Too).pdf"
    ],
    "report_names": [
        "2017-06-28 - Why NotPetya Kept Me Awake (& You Should Worry Too).pdf"
    ],
    "threat_actors": [
        {
            "id": "99cb4e5b-8071-4f9e-aa1d-45bfbb6197e3",
            "created_at": "2023-01-06T13:46:38.860754Z",
            "updated_at": "2025-03-27T02:00:02.937438Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "SectorJ04 Group",
                "Dudear",
                "G0092",
                "ATK103",
                "Hive0065",
                "Spandex Tempest",
                "GRACEFUL SPIDER",
                "GOLD TAHOE",
                "CHIMBORAZO",
                "SectorJ04"
            ],
            "source_name": "MISPGALAXY:TA505",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75d4d6a9-b5d1-4087-a7a0-e4a9587c45f4",
            "created_at": "2022-10-25T15:50:23.5188Z",
            "updated_at": "2025-03-27T02:00:55.489882Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "TA505",
                "Hive0065",
                "Spandex Tempest",
                "CHIMBORAZO"
            ],
            "source_name": "MITRE:TA505",
            "tools": [
                "AdFind",
                "Azorult",
                "FlawedAmmyy",
                "Mimikatz",
                "Dridex",
                "TrickBot",
                "Get2",
                "FlawedGrace",
                "Cobalt Strike",
                "ServHelper",
                "Amadey",
                "SDBbot",
                "PowerSploit"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e447d393-c259-46e2-9932-19be2ba67149",
            "created_at": "2022-10-25T16:07:24.28282Z",
            "updated_at": "2025-03-27T02:02:10.159466Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "ATK 103",
                "Chimborazo",
                "Gold Evergreen",
                "Gold Tahoe",
                "Graceful Spider",
                "Hive0065",
                "Operation Tovar",
                "Operation Trident Breach",
                "SectorJ04",
                "Spandex Tempest",
                "TA505",
                "TEMP.Warlock"
            ],
            "source_name": "ETDA:TA505",
            "tools": [
                "Amadey",
                "AmmyyRAT",
                "AndroMut",
                "Azer",
                "Bart",
                "Bugat v5",
                "CryptFile2",
                "CryptoLocker",
                "CryptoMix",
                "CryptoShield",
                "Dridex",
                "Dudear",
                "EmailStealer",
                "FRIENDSPEAK",
                "Fake Globe",
                "Fareit",
                "FlawedAmmyy",
                "FlawedGrace",
                "FlowerPippi",
                "GOZ",
                "GameOver Zeus",
                "GazGolder",
                "Gelup",
                "Get2",
                "GetandGo",
                "GlobeImposter",
                "Gorhax",
                "GraceWire",
                "Gussdoor",
                "Jaff",
                "Kasidet",
                "Kegotip",
                "Kneber",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Locky",
                "MINEBRIDGE",
                "MINEBRIDGE RAT",
                "MirrorBlast",
                "Neutrino Bot",
                "Neutrino Exploit Kit",
                "P2P Zeus",
                "Peer-to-Peer Zeus",
                "Philadelphia",
                "Philadephia Ransom",
                "Pony Loader",
                "Rakhni",
                "ReflectiveGnome",
                "Remote Manipulator System",
                "RockLoader",
                "RuRAT",
                "SDBbot",
                "ServHelper",
                "Shifu",
                "Siplog",
                "TeslaGun",
                "TiniMet",
                "TinyMet",
                "Trojan.Zbot",
                "Wsnpoem",
                "Zbot",
                "Zeta",
                "ZeuS",
                "Zeus"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535889,
    "ts_updated_at": 1743041123,
    "ts_creation_date": 1653704317,
    "ts_modification_date": 1653704317,
    "files": {
        "pdf": "https://archive.orkl.eu/19f368d864a9a9225061ec95785d887a6d98a2db.pdf",
        "text": "https://archive.orkl.eu/19f368d864a9a9225061ec95785d887a6d98a2db.txt",
        "img": "https://archive.orkl.eu/19f368d864a9a9225061ec95785d887a6d98a2db.jpg"
    }
}