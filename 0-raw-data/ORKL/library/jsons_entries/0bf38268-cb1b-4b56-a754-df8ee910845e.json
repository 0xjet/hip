{
    "id": "0bf38268-cb1b-4b56-a754-df8ee910845e",
    "created_at": "2023-01-12T15:06:07.852623Z",
    "updated_at": "2025-03-27T02:06:02.967714Z",
    "deleted_at": null,
    "sha1_hash": "c7404cd78d966b640a28f09a50469ac757194115",
    "title": "2022-02-16 - Playing with AsyncRAT",
    "authors": "",
    "file_creation_date": "2022-05-28T00:26:44Z",
    "file_modification_date": "2022-05-28T00:26:44Z",
    "file_size": 99065,
    "plain_text": "# Playing with AsyncRAT\n\n**eln0ty.github.io/malware analysis/asyncRAT/**\n\n6 minute read\n\n\nFebruary 16, 2022\n\n\nAsyncRAT is a Remote Access Tool (RAT) designed to remotely monitor and control other\ncomputers through a secure encrypted connection. It is an open source remote\nadministration tool, however, it could also be used maliciously because it provides\nfunctionality such as keylogger, remote desktop control, and many other functions that may\ncause harm to the victim’s computer. In addition, AsyncRAT can be delivered via various\nmethods such as spear-phishing, malvertising, exploit kit and other techniques.\n\nWe will discuss .NET code with dnSpy to learn how it works.\n\n## Sample overview\n\nsha256: `8021f8aa674ce3a2ccb2e8f917ebaf5b638607447f0df0e405e837dd2e7a7ccd`\n\n[This sample is packed and I unpacked it automatically with unpac.me (online unpacker) and](https://www.unpac.me/results/81742aea-53b2-43ef-be7f-ca66a3197038)\ngot this.\n\nThis is one sand box process flow\n\n## Initialization\n\nFirst, Malware sleeps for 3 seconds. I don’t know why but it’s okay.\n\nSecond, tries to initialize all settings depending on hardcoded configurations.\n\n(/assets\\images\\malware-analysis\\asyncRAT\\init.jpg)\n\n## Settings Details\n\nMalware decrypts all configurations from `AES256 encryption algorithm here.`\n\nThen verifies the integrity of these configurations and returns result. If false, exits from\nprocess. You can extract values with using debugger.\n\n\n-----\n\nThen malware checks if any of these configurations changed using `Serversignature and`\n```\nServerCertificate with VerifyHash function and returns the result. It’s something like\n\n```\na water mark in coding :)\n\n## Config Decryption\n\nI’m not an encryption nerd but I will try to explain as I can and we don’t need to understand\nhow it works to continue our analysis but I would love to give some help to learn some useful\nthings. If you don’t care just scroll the whole topic and go to Mutex creation. Let’s start with\n```\nKey = ejFjc0p0QWtudENHVTdsakhjTExYbm1KM1RqbTVUMlA= .\n\n```\nIt converts `key from Base64 then encoding to UTF8 so now` `Key =`\n```\nz1csJtAkntCGU7ljHcLLXnmJ3Tjm5T2P .\n\n### Deriving keys\n\n```\nThis [link gives you a complete definition about this encryption algorithm. The usage of it is to](https://en.wikipedia.org/wiki/PBKDF2)\nderive a new key in run time from our previous key.\n\nTo solve it, we have to focus with its parameters `dec_key = PBKDF2(key, Salt,`\n```\niterations)\n\n### AES256\n\n```\nThen use this dec_key with aes256 algorithm to decrypt all configurations.\n\nThis method divides the given config, like `ports into 3 sections:`\n\nData[:32] -> HMAC-SHA256 value\n\nData[32:48] -> IV\n\nData[48:] -> Encrypted bytes\n\n### Script\n\nThis python script automates all decoding components.\n\n\n-----\n\n```\n# 1) use PBKDF2 to derive the decryption key and initialization key used for sha\n# 2) calculate sha256 of data[32:] and compare it to the embedded sha256 hash\n(data[:32]) (We don't care here)\n# 3) iv = data[32:48]\n# 4) aes_dec(key, iv, data[48:])\n# pip install backports.pbkdf2\n# pip install malduck\nfrom backports.pbkdf2 import pbkdf2_hmac\nfrom base64 import b64decode\nfrom malduck import aes, unpad\nsalt =\nb\"\\xbf\\xeb\\x1e\\x56\\xfb\\xcd\\x97\\x3b\\xb2\\x19\\x02\\x24\\x30\\xa5\\x78\\x43\\x00\\x3d\\x56\\x44\\xd2\nkey = b\"ejFjc0p0QWtudENHVTdsakhjTExYbm1KM1RqbTVUMlA=\"\nconfig = {\n  \"Ports\":\n\"UGCInR8TOWCBkQI6fVXrRZ4Yj+b4OvMqcvbx3n2pTLIpcwWtvmX+PX6uN7uIsx65cuUHbVopkDdPuRbLHd6jf\n  \"Hosts\":\n\"k/33hCqQ1vnvaz3j8VvjdZRXF/poiYruJfX1WbFuFhwXYuNriBFrqyi0fQfk4xN0LS85PC6oOtCuLYarjJSnL\n  \"Version\":\n\"WG0EkFzynw3wCeMtt128RLUZgT6BSNw7pqLDg9XUMRmpx5WpQw1ZN64GLHYrP/h47iM2KImVVeY0wAT1RqMVV\n  \"Install\":\n\"3/TL2kdA5ptdHUR1gfeiPmkurKrJsw3BjJ7njALFi+ouT64Tx5oE1P7U7NktNpWfBZVmmjxeR/xSyR14NdEPc\n  \"MTX\":\n\"7vyshlirEg6SwhKPRttI85LoRXYLoFWLzaDM4h57MqKcy9iihijskYVbiDhhZu5qzqRxMBX5DpJ6dAfancdQ8\n  \"Anti\":\n\"fvHzWJyCKwkBHk/dOoyPPC5w+F3GyNg0t7NAj8VXjA2b0ntbSqH11xvQACf2jGX7VSLAd6BjykqqQIJAb98Ve\n  \"Pastebin\":\n\"B52OeJUAfsMHW3Ea2wBUni41OckwUyCtHz3yHsDSn9XjE4U+ncvS0Kmik61ZnDWTm+oNBPoQaDb5PHqfInPGX\n  \"BDOS\":\n\"++zHWqz0o5rkma5tjGrmNMSXzvLTZVOFmlOz4lhTPTPejjFLjqH/rhhciAYgm+Mq5bOazkPYeFGYC8q5I47wV\n  \"Group\":\n\"fwbqIWwfsG6vrljdbLznhYHm5g+qylXiJVparVYZ5s61hXK84/sQMNn6fTH09rZ+MeWdbYV1AhcKtEpQzJ6I5\n}\nkey = b64decode(key)\ndec_key = pbkdf2_hmac(\"sha1\", key, salt, 50000, 32)\nfor k, v in config.items():\n  data = b64decode(v)\n  iv = data[32:48]\n\n```\n\n-----\n\n```\n  decrypted unpad(aes.cbc.decrypt(dec_key, iv, data[48:]))\n  print(\"{}: {}\".format(k, decrypted.decode(\"utf-8\")))\n\n```\nAfter running the script, we have a clean config.\n```\nkey  <- \"z1csJtAkntCGU7ljHcLLXnmJ3Tjm5T2P\"\nports <- \"6606,7707,8808\"\nHost <- \"jeazerlog.duckdns.org\"\nversion  <- \"0.5.7B\"\nInstall  <- \"false\"\nMTX      <- \"AsyncMutex_6SI8OkPnk\"\nPastebin <- \"null\"\nAnti <- \"false\"\nBDOS <- \"fasle\"\nGroup <- \"gta\"\n\n```\nI want to note that the malware is also extracted Hwid while execution, and I got its value\nusing the debugger `Hwid = 1021C7B642607CE65116`\n\n## Mutex\n\nThe bad boy tries to make Mutex handle with MTX value which extracted from Settings to\nprevent the duplication of the process `MTX = \"AsyncMutex_6SI8OkPnk\" and tells windows`\n“end the duplicated process”.\n\n## Anti Analysis\n\nWe are lucky because malware doesn’t use any anti-analysis technique according to `Anti`\n```\n= fasle in Settings class.\n\n```\nbut I will explain what if a malware developer chooses a difficult path with analysis `Anti =`\n```\ntrue . The malware developer would have used five methods to make it difficult for the\n\n```\nmalware analyst to use.\n\n1. VM detection: malware searching in Manufacture Model for keywords like `VIRTUAL`\n\nor `vmware or` `VirtualBox .`\n\n2. Debugger detection: Check if the debugger is present to stop the process.\n\n3. SandBox detection: Tring to get a handle from SbieDll.dll that belongs to every\n\nsandbox.\n\n\n-----\n\n4. Small Disk detection: Most secure labs for malware analyzers such as virtual machines\n\ncontain a small disk.\n\n5. XP windows detection: You know, Nobody uses XP today except for malware analysis\n\nor something.\n\nLet’s move on to the next step in our main function.\n\n## Install\n\nOnce again, we are in luck, the malware author decided not to use any persistence\nmechanism according to `Install = fasle .`\n\nBut I will explain the hard path again, What if `Install = true in Settings? Let’s go…`\n\nThe first thing is that the malware checks the path it is running on, and if it is not the same as\nthe path in the settings, the running process is erased.\n\nThe malware creates a `.bat file in the` `%temp% to run a new process, created in the hard`\ncoded path `%AppData%, then deletes itself.`\n\n### Persistence\n\nThe malware checks if a process has administrator privilege to perform a schedule task\nevery time a user logs on to run or has a normal user privilege to modify the\n```\nSoftware\\Microsoft\\Windows\\CurrentVersion\\Run subkey to be added in the list of\n\n```\nstartup processes.\n\n## BSOD\n\nMalware passes this step in the main function because `BDOS = false .`\n\notherwise it would have verified that the user is an administrator and the operating system\nhas been switched to the critical state.\n\nTo learn more about `RtlSetProcessIsCritical and what its risks are, this` [link explains](https://www.codeproject.com/Articles/43405/Protecting-Your-Process-with-RtlSetProcessIsCriti)\nin-depth.\n\n## Finishing configurations\n\n\n-----\n\nSo far, the configuration has been done and the malware will run almost forever.\n\nThe next step will stablish the connection with C2 server.\n\n## Connection with C2\n\nI won’t explain the code too much at this level of analysis because it’s a development\nproblem, I’m just explaining what’s going on.\n\nThe malware creates an infinite loop to connect to C2 and the first thing it does is check if it’s\nalready connected or not, then sleeps for 5 seconds to free up resources so windows won’t\ncrash.\n\nI’ll explain a little bit what happens when malware disconnect.\n\nFirst, It calls a Reconnect function to dispose any packets between each other.\n\nThen it initializes a new tcp client connection through the TLS protocol for secure connection.\nYou can check the code by yourself. -_^\n\n## Server side operations\n\nWhen the victim runs the malware in any way, whether by phishing mail or otherwise\npersuaded by another method, it appears to the hacker that he has run the program, and\nhere the victim is completely controlled in a terrifying way, some of which are shown in below.\n\n## Conclusion\n\nMalware declares all settings AES256 then trying to connect victim machine to C2 server.\nFrom this point, all commands come from the other end of the world through the C2 server\nwhich were not embedded in the code.\n\nFinally, I hope you had fun and learned something new. See you in another analysis report.\n\n## IOCs\n\n**Hashes**\n\nPacked: 8021f8aa674ce3a2ccb2e8f917ebaf5b638607447f0df0e405e837dd2e7a7ccd\n\nUnpacked: bc61724d50bff04833ef13ae13445cd43a660acf9d085a9418b6f48201524329\n\n\n-----\n\n**C2s**\n\njeazerlog.duckdns.org:6606\n\njeazerlog.duckdns.org:7707\n\njeazerlog.duckdns.org:8808\n\n**MUTEXs**\n\nAsyncMutex_6SI8OkPnk\n\n**REGs**\n\nHKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-16 - Playing with AsyncRAT.pdf"
    ],
    "report_names": [
        "2022-02-16 - Playing with AsyncRAT.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535967,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653697604,
    "ts_modification_date": 1653697604,
    "files": {
        "pdf": "https://archive.orkl.eu/c7404cd78d966b640a28f09a50469ac757194115.pdf",
        "text": "https://archive.orkl.eu/c7404cd78d966b640a28f09a50469ac757194115.txt",
        "img": "https://archive.orkl.eu/c7404cd78d966b640a28f09a50469ac757194115.jpg"
    }
}