{
    "id": "e4495f05-e033-4e1d-8487-d05458357547",
    "created_at": "2023-01-12T15:05:26.925323Z",
    "updated_at": "2025-03-27T02:08:33.334494Z",
    "deleted_at": null,
    "sha1_hash": "9b5d6b88ee1cf2462bd0826acbb9d097935282f9",
    "title": "2021-07-06 - Mars-Deimos- SolarMarker-Jupyter Infostealer (Part 1)",
    "authors": "",
    "file_creation_date": "2022-05-27T23:16:32Z",
    "file_modification_date": "2022-05-27T23:16:32Z",
    "file_size": 1126279,
    "plain_text": "# Mars-Deimos: SolarMarker/Jupyter Infostealer (Part 1)\n\n**binarydefense.com/mars-deimos-solarmarker-jupyter-infostealer-part-1/**\n\nJuly 6, 2021\n\n_[Note: this post was originally shared on https://squiblydoo.blog/ by a member of the Binary Defense Team. In order to ensure this research](https://squiblydoo.blog/)_\n_is visible to a broader audience, this employee agreed to let us share it here._\n\n_Since the original post, the threat actor has been updating their malware and their tactics weekly. Some information in this post does not_\n_reflect the current version of the malware. However, the information is still important for defenders as there are still old infections that_\n_resemble the documented behavior, and the tactics can be used by other actors._\n\n## Part One: Persistence Script Analysis\n\nMars-Deimos-RS-2.MD5: 88E60DFE5045E7157D71D1CB4170C073\n\nMars-Deimos-RS-2:SHA256: 8A57BD2598057EE784711B47B9B61B4ECBA5311FAC800B55070D560480F86EAC\n\n## Mars Deimos Overview\n\n[Mars-Deimos-RS-2 is .NET binary injected into memory. It has also been documented as Solarmarker by CrowdStrike. It shares Indicators](https://www.crowdstrike.com/blog/solarmarker-backdoor-technical-analysis/)\n[of Compromise (IOC) with a directly related malware which has been documented as Jupyter Infostealer by Morphisec. The particular](https://blog.morphisec.com/jupyter-infostealer-backdoor-introduction)\nbinary studied here appears to be tracked internally by the author as “Mars Deimos AppVersion RS-2”. Mars Deimos is a C2 client and the\nbinary under analysis is the backdoor stage of the malware. The Jupyter variant shares functionality with Mars Deimos but can also steal\ncookies from browsers.\n\n_Note on naming: Though it can be confusing if there are too many names for the same malware, I want to maintain calling it “Mars_\n_Deimos” in order to assist defenders. In the original script, you can see it called “Mars Deimos” but I could not find any information about it_\n_under that name. In the Solarwinds analysis, it is called “D:M” by the malware author, so it seems like the name “Mars Deimos” is_\n_appropriate to maintain. Jupyter shares some IOC with Mars Deimos, which can complicate things, but they are maintained independently_\n_by the malware authors and have different functionality._\n\nMy goal in this post is provide analysis of the persistence script. Because Mars Deimos is a present-day threat, it is important for\nadministrators and analysts to recognize and understand the scripts if they are found.\n\n## How the Mars Deimos malware is delivered\n\nAccording to the analysis by CrowdStrike and Morphisec, Mars Deimos normally has several stages. The binary for this analysis appears\nto be the fourth or fifth stage (according to CrowdStrike) and is the persistent backdoor. My analysis began at this stage and I do not have\naccess to the earlier stages, but it appears that a user downloaded an executable that was disguised as a Word document. The\n\n\n-----\n\nexecutable then dropped two files: a .bat script and an unreadable file without an extension. For persistence, shortcuts on the desktop\nwere modified to call the .bat script.\n\n## Beginning Analysis of Mars Deimos\n\nAs is common when PowerShell is being executed maliciously, the .bat script is written in a way to be confusing as follows:\n\nThe script was named “DZWhBTixXsCjSOuNobQfpImvelygwUznrLHGPtkFAaMKVYcJ.cMd”,\nthe script is all one line\nthe variable names are complicated (such as “$ab13e4b80f240fb13f8a62c3a6db5”).\n\n_Image of the Script before alterations_\nTo be honest, looking at a script like this, it can boggle the mind quite easily.\n\nFirst, we will break up the commands into separate lines. Looking at the beginning, we can see that it is using PowerShell (spelled\n“poWeRsHEll” to avoid detection methods that look for the word “PowerShell”) so we will break it at some of the semi-colons to make it\neasier to read. (Some of the semicolons appear to be in a For-Loop, so we won’t break those up just yet.)\n\n_Image of the Script broken into sections to improve readibility_\nThe script is still hard to read because of the variable names. At this point, the purpose of the variable in line 1 is unclear… but in line 3, a\nvariable is assigned a value from [system.io.file], and it appears to be getting the file from a “base64string” that it is converting.\n\n[The easiest way we can convert that string from Base64 is using CyberChef: we can copy and paste that string into the Input section of](https://gchq.github.io/CyberChef/)\nCyberChef, drag-and-drop “From Base64” into the Recipe section and then, see the decoded string in the Output. In our instance, we\nreceive a file path to a second file:\n“C:\\Users\\UserName\\AppData\\Roaming\\bYtNoKkvyXglTMfAEaPreQVG\\bHpIFdzCjsfklSGPyQVrJqUXvMBuanNcODhwmxgLKiYWRtAETeZo”\n\n_Image of CyberChef output after decoding Base64 input_\nWith this information, we can conclude that a second file is being read into the variable on line 3, $a6eb2a91b614769b847e6964de33d. In\nthe original incident response, a file was indeed found at that location and I have that file. Let’s rename every instance of the variable\nname to $fileTwo since we don’t have much more information at this point.\n\n\n-----\n\n_Image of script with the variable renamed to $fileTwo_\nHaving renamed the variable, we see that after it is assigned the bytes of our second file in line 3, the variable is used a few times in the\nFor-Loop and after the For-Loop, $fileTwo is loaded using [system.reflection.assembly]::load($filetwo).\n\nNext, we clean up the For-Loop to make it more readable. For Loops usually initialize a variable for use in the loop (an iterator variable),\ncreate a condition that that is checked to see if the variable should continue, and then (optionally) a call to increment the iterator variable.\nTypically when writing a program, one uses “$i” for the iterator variable in a For-Loop; if there are multiple loops, the programmer names\nthe next iterator “$j”. Since we appear to have two For-Loops, we’ll rename the variable in the first For-Loop,\n“$ad066d1ff554189be1555e5c01765”, to “$i” and the variable initialized in the second For-Loop, “$ac07982da3749c86bd16117fb94f0”, to\n“$j”. Also, while we are at it, we will format it to look like a normal For-Loop.\n\n_For-_\n\n_Loop variables renamed and formatted for structure._\nFor someone familiar with For-Loops, that is much more readable now. The remaining obfuscated variable matches the variable from Line\n1 in the script. In the For-Loop, we appear to be indexing into and manipulating $fileTwo using “-bxor” and indexes of the obfuscated\nvariable. (To use “bxor” is to use the XOR operator on the individual bytes. Explaining XOR is beyond my goal here. However, “bxor” is\ncommon in malicious PowerShell so the reader should take note.) So it appears that the variable, $ab13e4b80f240fb13f8a62c3a6db5, is a\nkey for decoding $fileTwo before loading it in line 7. So let’s rename the variable to “$key”. Having made those changes, the script is much\nmore readable.\n\n_Image of the Script with obfuscation removed_\nLooking at the script now, we can see:\n\nThe script uses “CMD /c” to execute a PowerShell command with the Window option of “hidden”. (Line 1)\nIt sets a variable as a key (Line 1)\nIt sets a variable for a second file (Line 3)\nIt decodes the file using the key and two For-Loops (Lines 5-11)\nIt uses [system.reflection.assembly] to load the file (Line 13)\nAnd then “interacts” with the file it now calls “[mars.deimos]” (Line 13).\n\nHaving deobfuscated the script, let’s understand better what it is doing.\n\nUsing Google and searching for things such as “System.Reflection.Assembly used in malware” returns many results explaining that this is\na method of loading .NET executable into memory.\n\nPutting what we’ve learned together: the binary gets loaded into memory whenever this script is called. In order to make sure the script is\ncalled, an earlier stage modified desktop shortcuts to call this script. Great. Now let us find out what the executable does in order to\nunderstand risks and possible damages.\n\n\n-----\n\n## Writing the binary to file\n\nInitially, I struggled finding a method of writing this binary to disk. While [system.reflection.assembly] has a load function, it didn’t have any\nobvious method to save the assembly as a file rather than loading it into memory. The articles I found discussed how to load assemblies\ninto memory and did not focus on analyzing assemblies that were loaded into memory. So, I want to document my solution here as well.\n\nIn this situation, we have access to the script that loads it into memory, additionally, the script itself does the decoding of the second file in\nthe For-Loops. With the second file decoded, we can actually write the file to disk with one line of PowerShell; that is, after the For-Loops,\nwe can remove the remaining commands that load it into memory and use the following command to write it to disk:\n\nSet-Content .\\backdoor.bin -Value $fileTwo -Encoding Byte\n\nWith that, we save the decoded file as “backdoor.bin” in our current working directory. As a Malware Analyst our remaining task is to\ninvestigate the functionality of the binary. That will be in the second part of this blog post.\n\n## Alternative Analysis Tips\n\nIn addition to what is written above, I completed additional analysis before writing the binary to file. I want to document those activities as\nthey may result in a quicker analysis than full script and binary analysis when a quicker analysis is needed by administrators or analysts.\n\nAs mentioned above, the binary is injected into memory by the script and is not written to file. These are the implications of this:\n\nIf you do not have a method of flagging PowerShell execution or Memory Injection, the injected binary will go undetected,\nNo binary will be written to disk for static analysis. You will not have anything to upload to a service such as VirusTotal for quick\nverification and the scripts will not match anything on VirusTotal as they are custom in order to point to your host’s user directory.\nYou will need to preform some type of dynamic analysis in order to identify the malware and activity that the malware is performing.\n\n## Dynamic Analysis\n\nFor anyone unfamiliar, dynamic analysis refers to analyzing malware by running it. We will run the script in a virtual machine disconnected\nfrom the internet and see what happens when it runs.\n\n[Two easy tools for this are included in the Sysinternals Suite: Process Monitor (hereafter Procmon) and Process Explorer. Procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite)\nmonitors and logs registry, file, process, and thread activity. Process Explorer displays information on open Processes and what threads\nand processes are opened by each process.\n\nFor running the malware, we are simply going to use the files provided for us by the Threat Actor: we will drop the script and encoded file\nonto our virtual machine and modify the Base64 in the script to point to the encoded file on our virtual machine. (We can do that by\ndecoding the Base64 in CyberChef, modifying the path, encoding the path to Base64 with CyberChef, and then putting the encoded path\nback into the script.).\n\nWith ProcessExplorer open and Procmon capturing events, we can run the script and identify what process ID it runs with. I ran the script\nand saw a new “cmd.exe” process with a child process of “powershell.exe”. By hovering my mouse over it, I confirmed that the command\nline to start this process was our malicious script. I can then see that the Process ID was 3888.\n\n\n-----\n\n_An image of Process Explorer with the malicious script executed and the mouse hovering over the PowerShell process._\nI stopped Procmon capturing events and filtered Procmon to only include entries for Process ID 3888. After a few seconds and it still\nlogged 13,000 events related to process. A majority of the events are common PowerShell events that aren’t important to analyzing our\nmalware. To be honest, sifting through it is not an easy task.\n\nIn this instance, we are actually able to use the “Find” feature (Ctrl+F) to look for the name of the 2nd file. I’ve filtered out some other\noperations, but what we find is that shortly after it access that second file, the process writes a file to disk called “solarmarker.dat”.\n\n_An image with Procmon filtered and the solarmarker.dat WriteFile operation revealed._\nThe file is not intelligible if we open it, but this file a high value finding. It is a high value finding because the malware is not using random\nstrings anymore: the malware created a file with a static name “solarmarker.dat”.\n\n\n-----\n\n_An image of the contents of solarmarker.dat_\n\nWith that name, we are able to Google and find anything that has been published about the malware. With that, I was able to identify\nquickly what the malware was and the possible behaviors that may have been executed on the system. From this published information,\nas an administrator, I have the most important information I need:\n\nThe solarmarker.dat is documented as a Host Identifier sent to the threat actor\nAny hosts with this file in that directory have been compromised with this malware and this malware may steal passwords\n\nWe can then take the appropriate action for our organization: removing the malware on compromised hosts and resetting passwords as\ndeemed necessary.\n\n## Conclusion\n\nIn this Part 1, we’ve analyzed the malware script to understand what the script does, we have also done dynamic analysis in the event that\nwe cannot understand the script. The dynamic analysis gave us an important string allowing us to act fast on confirming an infection and\ngave us a direction for remediating the malware.\n\nIn Part 2, we will look at the binary that was injected into memory and analyze what we saved to disk.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-06 - Mars-Deimos- SolarMarker-Jupyter Infostealer (Part 1).pdf"
    ],
    "report_names": [
        "2021-07-06 - Mars-Deimos- SolarMarker-Jupyter Infostealer (Part 1).pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b43e5ea9-d8c8-4efa-b5bf-f1efb37174ba",
            "created_at": "2022-10-25T16:07:24.36191Z",
            "updated_at": "2025-03-27T02:02:10.1909Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "Dark Halo",
                "Nobelium",
                "SolarStorm",
                "StellarParticle",
                "UNC2452"
            ],
            "source_name": "ETDA:UNC2452",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "70872c3a-e788-4b55-a7d6-b2df52001ad0",
            "created_at": "2023-01-06T13:46:39.18401Z",
            "updated_at": "2025-03-27T02:00:03.01553Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "DarkHalo",
                "StellarParticle",
                "NOBELIUM",
                "Solar Phoenix",
                "Midnight Blizzard"
            ],
            "source_name": "MISPGALAXY:UNC2452",
            "tools": [
                "SNOWYAMBER",
                "HALFRIG",
                "QUARTERRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1d3f9dec-b033-48a5-8b1e-f67a29429e89",
            "created_at": "2022-10-25T15:50:23.739197Z",
            "updated_at": "2025-03-27T02:00:55.536417Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "UNC2452",
                "NOBELIUM",
                "StellarParticle",
                "Dark Halo"
            ],
            "source_name": "MITRE:UNC2452",
            "tools": [
                "Sibot",
                "Mimikatz",
                "Cobalt Strike",
                "AdFind",
                "GoldMax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535926,
    "ts_updated_at": 1743041313,
    "ts_creation_date": 1653693392,
    "ts_modification_date": 1653693392,
    "files": {
        "pdf": "https://archive.orkl.eu/9b5d6b88ee1cf2462bd0826acbb9d097935282f9.pdf",
        "text": "https://archive.orkl.eu/9b5d6b88ee1cf2462bd0826acbb9d097935282f9.txt",
        "img": "https://archive.orkl.eu/9b5d6b88ee1cf2462bd0826acbb9d097935282f9.jpg"
    }
}