{
    "id": "0fd7da83-7843-440a-bdae-fcb2558d6194",
    "created_at": "2023-01-12T15:07:31.37989Z",
    "updated_at": "2025-03-27T02:06:06.490801Z",
    "deleted_at": null,
    "sha1_hash": "45dbeb67f82373af0b93829461d1f7cb504d54b0",
    "title": "2013-09-01 - Yet another Andromeda - Gamarue analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T00:29:03Z",
    "file_modification_date": "2022-05-28T00:29:03Z",
    "file_size": 784006,
    "plain_text": "# Yet another Andromeda / Gamarue analysis\n\n**[eternal-todo.com/blog/yet-another-andromeda-gamarue-analysis](https://eternal-todo.com/blog/yet-another-andromeda-gamarue-analysis)**\n\n[Analysis](https://eternal-todo.com/category/analysis)\n[Andromeda](https://eternal-todo.com/category/andromeda)\n[Banks](https://eternal-todo.com/category/banks)\n[Botnets](https://eternal-todo.com/category/botnets)\n[Citadel](https://eternal-todo.com/category/citadel)\n[Fraud](https://eternal-todo.com/category/fraud)\n[Malware](https://eternal-todo.com/category/malware)\n[Pony Loader](https://eternal-todo.com/category/pony-loader)\n[Reversing](https://eternal-todo.com/category/reversing)\n\nSome days ago I read the post about Joe Security's error when they analyzed an\nAndromeda sample and I also found new samples of this Trojan. Then I decided that I\nshould write something about it. At least, just to remember some tricks of Andromeda for\nthe next time and not starting from scratch. [I'm Dory, I forget things ;)](http://www.youtube.com/watch?v=NOnPbNfKcds)\n\nWhen I analyzed this malware some months ago I thought that it was quite interesting due\nto the Anti-debugging and Anti-VM tricks it uses. You can also find references to the same\nmalware with the name of Gamarue. It seems it is cool to rename the same malware with\ndifferent names. Then you can find some families with three different names, like Cridex /\nFeodo / Bugat. Anyway, I also found these two links with very good and detailed\ninformation about analyzing Andromeda:\n\nI have mostly seen using Andromeda to install banking malware, like Ice-IX, Citadel and\n**Sinowal / Torpig (if it doesn't have more than one name it is not cool). But as you can see**\n[in this post on Malware don't need Coffee it can be bought with different plugins too. If](http://malware.dontneedcoffee.com/2012/07/inside-andromeda-bot-v206-webpanel-aka.html)\nthe main objective is just stealing credentials then maybe with the Keylogger or\n_Formgrabber plugins plus the Rootkit one (\"r.pack\") to stay stealth can be ok. I also saw_\nAndromeda downloading a plugin called \"pony\". It was nothing but the infamous Trojan\n**Pony Loader / Fareit, which I mentioned when I talked about the Boston Marathon**\nbombings malware campaign. However, if the objective of the cybercriminals is spread\nanother malware then the function of Andromeda will be as a simple downloader. It is also\npossible using it for both objectives, of course.\n\nThe infection vector that I have seen is just SPAM. It comes zipped and attached to an\nemail message with different subjects like discounts, hotel offers or post mail messages:\n\n\n-----\n\nThe generated traffic of Andromeda can be easily spotted:\n\nIt is just an HTTP POST request using the User-Agent “Mozilla/4.0” and sending a\nBase64-encoded string. After decoding it it is also necessary decrypt it with RC4 using a\nspecific key. In the first case, it was using a default installation key,\n\n\n-----\n\n**_[d40e75961383124949436f37f45a8cb6 . The information which the Trojan sends has the](https://www.google.com/search?q=d40e75961383124949436f37f45a8cb6+andromeda)_**\nformat “id:%lu|bid:%lu|bv:%lu|sv:%lu|pa:%lu|la:%lu|ar:%lu”. This is an example of that:\n```\nid:753485172|bid:3|bv:518|sv:1281|pa:0|la:2196749529|ar:1\n\n```\nThe meaning of the different parameters is the following:\n\n**_id: Bot ID_**\n**_bid: Build number_**\n**_bv: Bot version_**\n**_sv: OS version_**\n**_pa: Boolean to say if it is a x64 platform_**\n**_la: IP (long)_**\n**_ar: Boolean to say if it is executed with the Administrator account_**\n\nThe response is encrypted with RC4 too. However, in this case the key is the Bot ID sent\npreviously. Just before the encrypted data four more bytes are added, they are the CRC32\nof the content. Depending on the Trojan version an additional Base64 codification can be\nadded before encrypting with RC4. The response content are the tasks to be executed by\nthe bot (if there is any). For instance, updating the bot binary, installing new plugins,\nexecuting an additional executable/DLL, kill the bot, etc. This would be an example of a\nresponse:\n```\n 00000000 0f 00 00 00 02 01 00 00 00 68 74 74 70 3a 2f 2f |.........http://|\n 00000010 63 6c 6f 74 68 65 73 73 68 6f 70 75 70 70 79 2e |clothesshopuppy.|\n 00000020 63 6f 6d 2f 70 6c 75 67 2f 72 2e 70 61 63 6b 00 |com/plug/r.pack.|\n 00000030 02 02 00 00 00 68 74 74 70 3a 2f 2f 63 6c 6f 74 |.....http://clot|\n 00000040 68 65 73 73 68 6f 70 75 70 70 79 2e 63 6f 6d 2f |hesshopuppy.com/|\n 00000050 70 6c 75 67 2f 70 6f 6e 79 00 02 03 00 00 00 68 |plug/pony......h|\n 00000060 74 74 70 3a 2f 2f 63 6c 6f 74 68 65 73 73 68 6f |ttp://clothessho|\n 00000070 70 75 70 70 79 2e 63 6f 6d 2f 70 6c 75 67 2f 70 |puppy.com/plug/p|\n 00000080 63 62 00 01 14 00 00 00 68 74 74 70 3a 2f 2f 75 |cb......http://u|\n 00000090 74 61 68 62 6c 69 6e 64 73 2e 69 65 2f 63 69 74 |tahblinds.ie/cit|\n 000000a0 61 2e 65 78 65 00 00 0a              |a.exe...|\n\n```\nThe first four bytes are the request rate and then there is an array of tasks to execute. The\nformat of each task is “Command ID (1 byte) – Task ID (4 bytes) – Parameter (X bytes)”. In\nthis example we can see that the command to install a new plugin is 0x02 and to execute\na new binary is 0x01. In both cases the parameter is a URL.\n\nIf you have a clean sample of Andromeda (after unpacking/decrypting), then you can use\nIDA Pro and the [IDAPython script created by](https://github.com/0xEBFE/Andromeda-payload) [0xEBFE to](https://twitter.com/0x0000EBFE) decrypt and decompress the\npayloads. This way you can find the RC4 key used to encrypt the communications and the\npotential plugins:\n\n\n-----\n\nAnother way to find the RC4 key is taking a look at the memory of the processes created\nby Andromeda. Although the URL that you can see in the following screenshot is not the\ngood one, the key is valid.\n\nIt was funny to see a really nice C&C domain being used in one of the analyzed samples,\n“thisshitismoresafethanpentagonfuckyoufedsbecausethisisaf.com/image.php”:\n\n\n-----\n\nHowever, it was nothing but a cool message, because this domain was modified later\nusing XOR to obtain the real C&C endpoint.\n\nOne thing that is not mentioned in the other analyses is that this Trojan also creates hooks\nin the functions NtQueryInformationProcess, NtOpenProcess and RtlRaiseException of\nthe new process (wuauclt.exe, in this case):\n\n\n-----\n\nYou can find below the summary of the techniques used to difficult the analysis:\n\nBreakpoint detection\nCustom exception handler to load the real payload\nCheck if certain DLLs are loaded in the system: guard32.dll (Comodo Firewall) and\n_sbiedll.dll (Sandboxie)._\nCheck if some forbidden processes are running: vmwareuser.exe, vboxservice.exe,\n_procmon.exe, wireshark.exe, etc._\nComparison between the main disk ID\n(system\\currentcontrolset\\services\\disk\\enum@0) and the strings “vmwa”, “vbox” and\n“qemu”.\n[Time execution check using the instruction RDTSC.](http://faydoc.tripod.com/cpu/rdtsc.htm)\n\nMost of these checks can be bypassed if the CRC32 checksum of the system drive\nvolume is 0x20C7DD84. It seems that the bad guy was using a test environment and this\nwas the way he was checking that the Trojan was running correctly. However, modifying\nthe system drive volume name is not the only way to get Andromeda running as Joe\n[Security's guys were suggesting (“The real payload is only shown if the volumn name of](http://joe4security.blogspot.ch/2013/08/anti-vm-gone-wrong.html)\n_the system drive equals a specific checksum”). If the environment can be able to bypass_\nall the checks mentioned above, then the real payload will be executed as well.\nSometimes the malware was not executing correctly in my virtual machine, as Joe\nSecurity's post says, but I think the cause is that probably it was overloaded and it was not\nbypassing the time check.\n\nSubmitted by jesparza on Sun, 2013/09/01 - 19:56\n\n[Español](https://eternal-todo.com/es/blog/an%C3%A1lisis-del-troyano-andromeda-gamarue)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2013/2013-09-01 - Yet another Andromeda - Gamarue analysis.pdf"
    ],
    "report_names": [
        "2013-09-01 - Yet another Andromeda - Gamarue analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536051,
    "ts_updated_at": 1743041166,
    "ts_creation_date": 1653697743,
    "ts_modification_date": 1653697743,
    "files": {
        "pdf": "https://archive.orkl.eu/45dbeb67f82373af0b93829461d1f7cb504d54b0.pdf",
        "text": "https://archive.orkl.eu/45dbeb67f82373af0b93829461d1f7cb504d54b0.txt",
        "img": "https://archive.orkl.eu/45dbeb67f82373af0b93829461d1f7cb504d54b0.jpg"
    }
}