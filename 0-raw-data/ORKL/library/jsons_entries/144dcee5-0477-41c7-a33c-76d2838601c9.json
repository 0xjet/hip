{
    "id": "144dcee5-0477-41c7-a33c-76d2838601c9",
    "created_at": "2023-01-12T15:08:00.28504Z",
    "updated_at": "2025-03-27T02:13:12.211084Z",
    "deleted_at": null,
    "sha1_hash": "655f50d451967b399c644a56500c5cc790b4fadd",
    "title": "2021-09-02 - A deep-dive into the SolarWinds Serv-U SSH vulnerability (DEV-0322)",
    "authors": "",
    "file_creation_date": "2022-05-28T23:15:23Z",
    "file_modification_date": "2022-05-28T23:15:23Z",
    "file_size": 1339439,
    "plain_text": "# A deep-dive into the SolarWinds Serv-U SSH vulnerability\n\n**[microsoft.com/security/blog/2021/09/02/a-deep-dive-into-the-solarwinds-serv-u-ssh-vulnerability/](https://www.microsoft.com/security/blog/2021/09/02/a-deep-dive-into-the-solarwinds-serv-u-ssh-vulnerability/)**\n\nSeptember 2, 2021\n\nSeveral weeks ago, Microsoft detected a 0-day remote code execution exploit being used to\nattack the SolarWinds Serv-U FTP software in limited and targeted attacks. The Microsoft\n[Threat Intelligence Center (MSTIC) attributed the attack with high confidence to DEV-0322, a](https://www.microsoft.com/security/blog/2021/07/13/microsoft-discovers-threat-actor-targeting-solarwinds-serv-u-software-with-0-day-exploit/)\ngroup operating out of China, based on observed victimology, tactics, and procedures. In this\nblog, we share technical information about the vulnerability, tracked as [CVE-2021-35211,](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-35211)\n[that we shared with SolarWinds, who promptly released security updates to fix the](https://www.solarwinds.com/trust-center/security-advisories/cve-2021-35211)\nvulnerability and mitigate the attacks.\n\nThis analysis was conducted by the Microsoft Offensive Research & Security Engineering\nteam, a focused group tasked with supporting teams like MSTIC with exploit development\nexpertise. Our team’s remit is to make computing safer. We do this by leveraging our\nknowledge of attacker techniques and processes to build and improve protections in\nWindows and Azure through reverse engineering, attack creation and replication,\nvulnerability research, and intelligence sharing.\n\nIn early July, MSTIC provided our team with data that seemed to indicate exploit behavior\nagainst a newly-discovered vulnerability in the SolarWinds Serv-U FTP server’s SSH\ncomponent. Although the intel contained useful indicators, it lacked the exploit in question, so\nour team set out to reconstruct the exploit, which required to first find and understand the\nnew vulnerability in the Serv-U SSH-related code.\n\nAs we knew this was a remote, pre-auth vulnerability, we quickly constructed a fuzzer\nfocused on the pre-auth portions of the SSH handshake and noticed that the service\ncaptured and passed all access violations without terminating the process. It immediately\nbecame evident that the Serv-U process would make stealthy, reliable exploitation attempts\nsimple to accomplish. We concluded that the exploited vulnerability was caused by the way\nServ-U initially created an OpenSSL AES128-CTR context. This, in turn, could allow the use\nof uninitialized data as a function pointer during the decryption of successive SSH\nmessages. Therefore, an attacker could exploit this vulnerability by connecting to the open\nSSH port and sending a malformed pre-auth connection request. We also discovered that\nthe attackers were likely using DLLs compiled without address space layout randomization\n(ASLR) loaded by the Serv-U process to facilitate exploitation.\n\nWe shared these findings, as well as the fuzzer we created, with SolarWinds through\n[Coordinated Vulnerability Disclosure (CVD) via](https://www.microsoft.com/en-us/msrc/cvd?rtc=1) [Microsoft Security Vulnerability Research](https://www.microsoft.com/en-us/msrc/msvr)\n(MSVR), and worked with them to fix the issue. This is an example of intelligence sharing\n\n\n-----\n\nand industry collaboration that result in comprehensive protection for the broader community\nthrough detection of attacks through products and fixing vulnerabilities through security\nupdates.\n\n## Vulnerability in Serv-U’s implementation of SSH\n\nSecure Shell (SSH) is a widely adopted protocol for secure communications over an\nuntrusted network. The protocol behavior is defined in multiple requests for comment\n(RFCs), and existing implementations are available in open-source code; we primarily used\n[RFC 4253,](https://datatracker.ietf.org/doc/html/rfc4253) [RFC 4252, and](https://datatracker.ietf.org/doc/html/rfc4252) [libssh as references for this analysis.](https://git.libssh.org/projects/libssh.git/tree/)\n\nThe implementation of SSH in Serv-U was found by enumerating references to the “SSH-“\nstring, which must be present in the first data sent to the server. The most likely instance of\nsuch code was the following:\n\n_Figure 1. Promising instance of “SSH-” string_\n\nPutting a breakpoint on the above code and attempting to connect to Serv-U with an SSH\nclient confirmed our hypothesis and resulted in the breakpoint being hit with the following call\nstack:\n\n_Figure 2. The call stack resulting from a break point set on code in Figure 1._\n\nAt this point, we noticed that Serv-U.dll and RhinoNET.dll both have ASLR support disabled,\nmaking them prime locations for ROP gadgets, as any addresses within them will be\nconstant across any server instances running on the internet for a given Serv-U version.\n\nAfter reversing related code in the RhinoNET and Serv-U DLLs, we could track SSH\nmessages’ paths as Serv-U processes them. To handle an incoming SSH connection, Serv_U.dll creates a CSUSSHSocket object, which is derived from the RhinoNET!CRhinoSocket_\n_class. The CSUSSHSocket object lifetime is the length of the TCP connection—it persists_\nacross possibly many individual TCP packets. The underlying CRhinoSocket provides a\nbuffered interface to the socket such that a single TCP packet may contain any number of\n\n\n-----\n\nbytes. This implies a single packet may include any number of SSH messages (provided\nthey fit in the maximum buffer size), as well as partial SSH messages. The\n_CSUSSHSocket::ProcessRecvBuffer function is then responsible for parsing the SSH_\nmessages from the buffered socket data.\n\n_CSUSSHSocket::ProcessRecvBuffer begins by checking for the SSH version with_\n_ParseBanner. If ParseBanner successfully parses the SSH version from the banner,_\n_ProcessRecvBuffer then loops over ParseMessage, which obtains a pointer to the current_\nmessage in the socket data and extracts the msg_id and length fields from the message\n(more on the ParseMessage function later).\n\n_Figure 3. Selection of code from CSUSSHSocket::ProcessRecvBuffer processing loop_\n\nThe socket data being iterated over is conceptually an array of the pseudo-C structure\n_ssh_msg_t, as seen below. The message data is contained within the payload buffer, the first_\nbyte of which is considered the msg_id:\n\n\n-----\n\n_ProcessRecvBuffer then dispatches handling of the message based on the msg_id. Some_\nmessages are handled directly from the message parsing loop, while others get passed to\n_ssh_pkt_others, which posts the message to a queue for another thread to pick up and_\nprocess.\n\n_Figure 4.Pre-auth reachable handlers in CSUSSHSocket::ProcessRecvBuffer_\n\nIf the msg_id is deferred to the alternate thread, CSSHSession::OnSSHMessage processes\nit. This function mainly deals with messages that need to interact with Serv-U managed user\nprofile data (e.g., authentication against per-user credentials) and UI updates.\n_CSSHSession::OnSSHMessage turned out to be uninteresting in terms of vulnerability_\nhunting as most message handlers within it require successful user authentication (initial\ntelemetry indicated this was a pre-authentication vulnerability), and no vulnerabilities were\nfound in the remaining handlers.\n\n\n-----\n\nWhen initially running fuzzers against Serv-U with a debugger attached, it was evident that\nthe application was catching exceptions which would normally crash a process (such as\naccess violations), logging the error, modifying state just enough to avoid termination of the\nprocess, and then continuing as if there had been no problem. This behavior improves\nuptime of the file server application but also results in possible memory corruption lingering\naround in the process and building up over time. As an attacker, this grants opportunities like\nbrute-forcing addresses of code or data with dynamic addresses.\n\nThis squashing of access violations assists with exploitation, but for fuzzing, we filtered out\n“uninteresting” exceptions generated by read/write access violations and let the fuzzer run\nuntil hitting a fault wherein RIP had been corrupted. This quickly resulted in the following\ncrashing context:\n\n_Figure 5. WinDbg showing crashing context from fuzzer-generated SSH messages_\n\n\n-----\n\nAs seen above, CRYPTO_ctr128_encrypt in libeay32.dll (part of OpenSSL) attempted to call\n[an invalid address. The version of OpenSSL used is 1.0.2u, so we obtained the sources to](https://www.openssl.org/source/old/1.0.2/openssl-1.0.2u.tar.gz)\nperuse. The following shows the relevant OpenSSL function:\n\nMeanwhile, the following shows the structure that is passed:\n\nThe crashing function was reached from the OpenSSL API boundary via the following path:\n_EVP_EncryptUpdate -> evp_EncryptDecryptUpdate -> aes_ctr_cipher ->_\n_CRYPTO_ctr128_encrypt._\n\n\n-----\n\nLooking further up the call stack, it is evident that Serv-U calls EVP_EncryptUpdate from\n_CSUSSHSocket::ParseMessage, as seen below:_\n\n_Figure 6. Location of call into OpenSSL, wherein attacker-controlled function pointer may be_\n_invoked_\n\nAt this point, we manually minimized the TCP packet buffer produced by the fuzzer until only\nthe SSH messages required to trigger the crash remained. In notation like that used in the\nRFCs, the required SSH messages were:\n\n\n-----\n\nNote that the following description references encrypt functions being called when the\ncrashing code path is clearly attempting to decrypt a buffer. This is not an error: Serv-U uses\nthe encrypt OpenSSL API and, while not optimal for code clarity, it is behaviorally correct\nsince Advanced Encryption Standard (AES) is operating in counter (CTR) mode.\n\nAfter taking a Time Travel Debugging trace and debugging through the message processing\nsequence, we found that the root cause of the issue was that Serv-U initially creates the\nOpenSSL AES128-CTR context with code like the following:\n\n[Calling EVP_EncryptInit_ex with NULL key and/or IV is valid, and Serv-U does so in this](https://www.openssl.org/docs/man1.0.2/man3/EVP_EncryptInit_ex.html)\ncase because the context is created while handling the KEXINIT message, which is before\nkey material is ready. However, AES key expansion is not performed until the key is set, and\nthe data in the ctx->cipher_data structure remains uninitialized until the key expansion is\nperformed. We can (correctly) surmise that our sequence of messages to hit the crash has\ncaused enc_algo_client_to_server->decrypt to be called before the key material is initialized.\nThe Serv-U KEXINIT handler creates objects for all parameters given in the message.\nHowever, the corresponding objects currently active for the connection are not replaced with\nthe newly created ones until the following NEWKEYS message is processed. The client\nalways completes the key exchange process In a normal SSH connection before issuing a\nNEWKEYS message. Serv-U processed NEWKEYS (thus setting the m_bCipherActive flag\nand replacing the cipher objects) no matter the connection state or key exchange. From this,\nwe can see that the last message type in our fuzzed sequence does not matter—there only\nneeds to be some data remaining to be processed in the socket buffer to trigger decryption\nafter the partially initialized AES CTR cipher object has been activated.\n\n## Exploitation\n\nAs the vulnerability allows loading RIP from uninitialized memory and as there are some\nmodules without ASLR in the process, exploitation is not so complicated: we can find a way\nto control the content of the uninitialized cipher_data structure, point the cipher_data->block\nfunction pointer at some initial ROP gadget, and start a ROP chain. Because of the\nexception handler causing any fault to be ignored, we do not necessarily need to attain\nreliable code execution upon the first packet. It is possible to retry exploitation until code\nexecution is successful, however this will leave traces in log files and as such it may be\nworthwhile to invest more effort into a different technique which would avoid logging.The first\nstep is to find the size of the cipher_data allocation, as the most direct avenue to prefill the\nbuffer is to spray allocations of the target allocation size and free them before attempting to\nreclaim the address as cipher_data. ctx->cipher_data is allocated and assigned in\nEVP_CipherInit_ex with the following line:\n\n\n-----\n\nWith a debugger, we can see the ctx_size in our case is 0x108, and that this allocator winds\nup calling ucrtbase!_malloc_base. From previous reversing, we know that both\n_CRhinoSocket and CSUSSHSocket levels of packet parsing call operator new[] to allocate_\nspace to hold the packets we send. Luckily, that also winds up in ucrtbase!_malloc_base,\nusing the same heap. Therefore, prefilling the target allocation is as simple as sending a\nproperly sized TCP packet or SSH message and then closing the connection to ensure it is\nfreed. Using this path to spray does not trigger other allocations of the same size, so we\ndon’t have to worry about polluting the heap.\n\nAnother important value to pull out of the debugger/disassembly is offsetof(EVP_AES_KEY,\n_block), as that offset in the sprayed data needs to be set to the initial ROP gadget. This value_\nis 0xf8. Conveniently, most of the rest of the EVP_AES_KEY structure can be used for the\nROP chain contents itself, and a pointer to the base of this structure exists in registers rbx,\n_r8, and r10 at the time of the controlled function pointer call._\n\nAs a simple proof of concept, consider the following python code:\n\nThe above results in the following context in the debugger:\n\n_Figure 7. Machine context showing rcx, rdx, and rip controlled by attacker_\n\n## Conclusion: Responsible disclosure and industry collaboration improves security for all\n\nOur research shows that the Serv-U SSH server is subject to a pre-auth remote code\nexecution vulnerability that can be easily and reliably exploited in the default configuration.\nAn attacker can exploit this vulnerability by connecting to the open SSH port and sending a\n\n\n-----\n\nmalformed pre-auth connection request. When successfully exploited, the vulnerability could\nthen allow the attacker to install or run programs, such as in the case of the targeted attack\nwe previously reported.\n\n[We shared our findings to SolarWinds through Coordinated Vulnerability Disclosure (CVD).](https://www.microsoft.com/en-us/msrc/cvd?rtc=1)\n[We also shared the fuzzer we created. SolarWinds released an advisory and security patch,](https://www.solarwinds.com/trust-center/security-advisories/cve-2021-35211)\nwhich we strongly encourage customers to apply. If you are not sure if your system is\n[affected, open a support case in the SolarWinds Customer Portal.](https://customerportal.solarwinds.com/support/submit-a-ticket?sid=satsn)\n\nIn addition to sharing vulnerability details and fuzzing tooling with SolarWinds, we also\n[recommended enabling ASLR compatibility for all binaries loaded in the Serv-U process.](https://docs.microsoft.com/en-us/cpp/build/reference/dynamicbase-use-address-space-layout-randomization?view=msvc-160)\nEnabling ASLR is a simple compile-time flag which is enabled by default and has been\navailable since Windows Vista. ASLR is a critical security mitigation for services which are\nexposed to untrusted remote inputs, and requires that all binaries in the process are\ncompatible in order to be effective at preventing attackers from using hardcoded addresses\nin their exploits, as was possible in Serv-U.\n\nWe would like to thank SolarWinds for their prompt response. This case further underscores\nthe need for constant collaboration among software vendors, security researchers, and other\nplayers to ensure the safety and security of users’ computing experience.\n\n**_Microsoft Offensive Research & Security Engineering team_**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-02 - A deep-dive into the SolarWinds Serv-U SSH vulnerability (DEV-0322).pdf"
    ],
    "report_names": [
        "2021-09-02 - A deep-dive into the SolarWinds Serv-U SSH vulnerability (DEV-0322).pdf"
    ],
    "threat_actors": [
        {
            "id": "1f6ae238-765f-4495-9d54-6a7883d7a319",
            "created_at": "2022-10-25T16:07:24.573456Z",
            "updated_at": "2025-03-27T02:02:10.284644Z",
            "deleted_at": null,
            "main_name": "TA511",
            "aliases": [
                "MAN1",
                "Moskalvzapoe"
            ],
            "source_name": "ETDA:TA511",
            "tools": [
                "Agentemis",
                "Chanitor",
                "Cobalt Strike",
                "CobaltStrike",
                "Ficker Stealer",
                "Hancitor",
                "NetSupport",
                "NetSupport Manager",
                "NetSupport Manager RAT",
                "NetSupport RAT",
                "NetSupportManager RAT",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "0a80df4d-5ab7-4ca3-809d-8ef7b5a54f1f",
            "created_at": "2023-11-21T02:00:07.386886Z",
            "updated_at": "2025-03-27T02:00:03.248375Z",
            "deleted_at": null,
            "main_name": "TiltedTemple",
            "aliases": [
                "DEV-0322",
                "Circle Typhoon"
            ],
            "source_name": "MISPGALAXY:TiltedTemple",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "542cf9d0-9c68-428c-aff8-81b6f59dc985",
            "created_at": "2023-02-15T02:01:49.554105Z",
            "updated_at": "2025-03-27T02:00:03.110991Z",
            "deleted_at": null,
            "main_name": "Moskalvzapoe",
            "aliases": [
                "MAN1",
                "TA511"
            ],
            "source_name": "MISPGALAXY:Moskalvzapoe",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "760f2827-1718-4eed-8234-4027c1346145",
            "created_at": "2023-01-06T13:46:38.670947Z",
            "updated_at": "2025-03-27T02:00:02.888195Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "Thallium",
                "G0086",
                "APT43",
                "Springtail",
                "Sparkling Pisces",
                "Velvet Chollima",
                "Black Banshee",
                "Operation Stolen Pencil",
                "Emerald Sleet",
                "THALLIUM"
            ],
            "source_name": "MISPGALAXY:Kimsuky",
            "tools": [
                "RevClient",
                "xrat",
                "QUASARRAT",
                "RDP Wrapper",
                "TightVNC",
                "BabyShark"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "191d7f9a-8c3c-442a-9f13-debe259d4cc2",
            "created_at": "2022-10-25T15:50:23.280374Z",
            "updated_at": "2025-03-27T02:00:55.423485Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "Kimsuky",
                "Black Banshee",
                "Velvet Chollima",
                "Emerald Sleet",
                "THALLIUM",
                "APT43",
                "TA427"
            ],
            "source_name": "MITRE:Kimsuky",
            "tools": [
                "schtasks",
                "Amadey",
                "Brave Prince",
                "CSPY Downloader",
                "gh0st RAT",
                "AppleSeed",
                "NOKKI",
                "QuasarRAT",
                "Gold Dragon",
                "PsExec",
                "KGH_SPY",
                "Mimikatz",
                "BabyShark"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "71a1e16c-3ba6-4193-be62-be53527817bc",
            "created_at": "2022-10-25T16:07:23.753455Z",
            "updated_at": "2025-03-27T02:02:09.963016Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "APT 43",
                "Black Banshee",
                "Emerald Sleet",
                "ITG16",
                "KTA082",
                "Kimsuky",
                "Larva-24005",
                "Operation Baby Coin",
                "Operation Covert Stalker",
                "Operation DEEP#DRIVE",
                "Operation DEEP#GOSU",
                "Operation Kabar Cobra",
                "Operation Mystery Baby",
                "Operation Red Salt",
                "Operation Smoke Screen",
                "Operation Stealth Power",
                "Operation Stolen Pencil",
                "SharpTongue",
                "Sparkling Pisces",
                "Springtail",
                "TA406",
                "TA427",
                "Thallium",
                "UAT-5394",
                "Velvet Chollima"
            ],
            "source_name": "ETDA:Kimsuky",
            "tools": [
                "AngryRebel",
                "AppleSeed",
                "BITTERSWEET",
                "BabyShark",
                "BoBoStealer",
                "CSPY Downloader",
                "Farfli",
                "FlowerPower",
                "Gh0st RAT",
                "Ghost RAT",
                "Gold Dragon",
                "GoldDragon",
                "GoldStamp",
                "JamBog",
                "KGH Spyware Suite",
                "KGH_SPY",
                "KPortScan",
                "KimJongRAT",
                "Kimsuky",
                "LATEOP",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Lovexxx",
                "MailPassView",
                "Mechanical",
                "Mimikatz",
                "MoonPeak",
                "Moudour",
                "MyDogs",
                "Mydoor",
                "Network Password Recovery",
                "PCRat",
                "ProcDump",
                "PsExec",
                "ReconShark",
                "Remote Desktop PassView",
                "SHARPEXT",
                "SWEETDROP",
                "SmallTiger",
                "SniffPass",
                "TODDLERSHARK",
                "TRANSLATEXT",
                "Troll Stealer",
                "TrollAgent",
                "VENOMBITE",
                "WebBrowserPassView",
                "xRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536080,
    "ts_updated_at": 1743041592,
    "ts_creation_date": 1653779723,
    "ts_modification_date": 1653779723,
    "files": {
        "pdf": "https://archive.orkl.eu/655f50d451967b399c644a56500c5cc790b4fadd.pdf",
        "text": "https://archive.orkl.eu/655f50d451967b399c644a56500c5cc790b4fadd.txt",
        "img": "https://archive.orkl.eu/655f50d451967b399c644a56500c5cc790b4fadd.jpg"
    }
}