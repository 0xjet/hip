{
    "id": "6aebabdd-9ae5-4f01-ad81-9097b165c291",
    "created_at": "2023-01-12T15:06:41.177755Z",
    "updated_at": "2025-03-27T02:09:18.44901Z",
    "deleted_at": null,
    "sha1_hash": "306a52c582098d9f92a8533758b4f09db7b1a0d3",
    "title": "2021-04-09 - Detecting Exposed Cobalt Strike DNS Redirectors",
    "authors": "",
    "file_creation_date": "2022-05-27T19:05:59Z",
    "file_modification_date": "2022-05-27T19:05:59Z",
    "file_size": 250670,
    "plain_text": "# Detecting Exposed Cobalt Strike DNS Redirectors\n\n**[labs.f-secure.com/blog/detecting-exposed-cobalt-strike-dns-redirectors](https://labs.f-secure.com/blog/detecting-exposed-cobalt-strike-dns-redirectors)**\n\n## Intro\n\nCobalt Strike is a well known framework used to perform adversary simulation exercises by\noffensive security professionals. Its flexibility and broad feature set have made it the de facto\nframework for red team operations.\n\nCobalt Strike's implant, known as \"beacon\", has the ability to communicate back to a\nCommand & Control (C2) server using different protocols:\n\n**HTTP/HTTPs - where the data exchanged between the implant and the C2 server is**\npackaged inside an HTTP request.\n**SMB - used mostly for peer-to-peer communication, this channel uses the SMB**\nprotocol to blend in with the regular traffic you might see on an internal Windows-based\nnetwork.\n**TCP - with a similar purpose to the SMB channel, but using plain TCP sockets. Useful**\nfor lateral movement in situations where SMB is restricted or heavily monitored. Can\nalso be used for privilege escalation purposes.\n**DNS - using a variety of DNS queries, Cobalt Strike's beacons can communicate back**\nto the C2 server using only DNS. The advantage is that name resolution is almost\nalways allowed and no direct communication takes place between the implant and the\nC2 server, since the DNS resolution will happen using the default nameservers.\n**Custom - using the** [well-documented External C2 protocol it is possible to develop](https://www.cobaltstrike.com/downloads/externalc2spec.pdf)\ncustom communication mechanisms that will allow an operator to rely on Cobalt\nStrike's post exploitation capabilities but not being bounded by the existing channels. A\n[popular example of this is F-Secure's C3 framework.](https://labs.f-secure.com/tools/c3/)\n\nThis research will focus on some of the active detections that can be used to fingerprint\nexposed Cobalt Strike servers that are using DNS as a communication channel. Although\n[the research approach will be a bit different, the outcome will be similar to what JARM did for](https://engineering.salesforce.com/easily-identify-malicious-servers-on-the-internet-with-jarm-e095edac525a)\nHTTP/HTTPs restricted to the scope of Cobalt Strike.\n\n## DNS Redirectors\n\nBefore jumping in the actual detection logic, it is important to understand how the standard\nDNS server within Cobalt Strike is deployed for an operation. The concept of a \"redirector\" is\nsomething that was introduced to further harden the attack infrastructure and decouple what\nis exposed by the attacked component and the actual C2 servers. This grants the operator\n\n\n-----\n\ngreater flexibility in case any of their internet-facing endpoints get burned during the attack;\nin fact, spinning up a new redirector can take hours if not minutes whilst rebuilding a new C2\nserver might have a greater impact on the operations.\n\nTypically, the standard Cobalt Strike DNS redirector is created using either socat or iptables.\nThe [official documentation, in fact, suggests those as the go-to tools for creating DNS based](https://blog.cobaltstrike.com/2021/03/11/simple-dns-redirectors-for-cobalt-strike/)\nredirectors.\n\nAs an example, the following commands can be used to create a simple redirector for DNS:\n```\n# socat will listen on TCP 5353 and redirect to cobalt strike's DNS server\nsocat tcp4-listen:5353,reuseaddr,fork UDP:127.0.0.1:53\n# port 5353 will be exposed via an SSH tunnel on the external redirector\nssh ubuntu@redir.c2 -R 5353:127.0.0.1:5353\n# on the redirector, socat will listen on 53 and forward the data to the SSH tunnel,\nthat eventually will reach the C2 server\nsocat udp4-listen:53,reuseaddr,fork tcp:localhost:53535\n\n```\nThe creation of a DNS listener within Cobalt Strike will not be covered as it is outside the\nscope of this research. For more details it is recommended to check out Steve Borosh's\n\nThe resulting communication flow will look like the one schematised below:\n\nThe setup can be validated by querying the hostname that was initially configured for DNS\nC2. If the setup is working properly, the DNS response should be the one configured in the\ndns_idle malleable profile option, and by default it's equal to \"0.0.0.0\":\n```\nnslookup malware.c2\nNon-authoritative answer:\nName:  malware.c2\nAddress: 0.0.0.0\n\n```\nThe \"0.0.0.0\" reply, as previously said, is the Cobalt Strike's default and as every default\nvalue, should be changed.\n\n\n-----\n\n## The Detection\n\nThe research that F-Secure conducted is based on the following statement:\n\nCobalt Strike's DNS listeners will reply using the value defined in the dns_idle field\nregardless of the query received, as long as it is not part of a C2 communication\n\nIn fact, the dns_idle field is used by the beacon as a heartbeat to check in for new tasks. The\n\"problem\" is that the default DNS server will reply using that value to all the other queries for\nother domains as well.\n\nThe hypothesis is that if a DNS server replies to all the queries with always the same IP\naddress, it might be an indicator of the presence of Cobalt Strike. Of course this approach is\nnot free of false-positives, and part of the research was to quantify the fidelity of this\nmechanism,\n\nIt was possible to validate our hypothesis using a live Cobalt Strike server:\n```\ndig @70.35.206.199 +short amazon.com\n0.0.0.0\ndig @70.35.206.199 +short google.com\n0.0.0.0\ndig @70.35.206.199 +short nonexistent.domain\n0.0.0.0\ndig @70.35.206.199 +short -t TXT google.com\n0.0.0.0\n\n```\nAs it is possible to see, the server replied to all the queries with \"0.0.0.0\", the default dns_idle\nvalue. This approach would have worked even if the default value was changed, since all the\nqueries would still return the same value. The interesting aspect was that even for queries\ndifferent than \"A\", Cobalt Strike still returned an \"A\" record. This broke the parsing logic of\nmost of the common libraries for name resolution. The snippet below shows an example of\nthat:\n\n\n-----\n\n```\ndig TXT test @35.178.76.239\n; <<>> DiG 9.10.6 <<>> TXT test @35.178.76.239\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45988\n;; flags: qr rd ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n;; WARNING: recursion requested but not available\n;; QUESTION SECTION:\n;test.        IN  TXT\n;; ANSWER SECTION:\ntest.      1  IN  A  8.8.8.8\n;; Query time: 97 msec\n;; SERVER: 35.178.76.239#53(35.178.76.239)\n;; WHEN: Tue Mar 23 10:11:00 CET 2021\n;; MSG SIZE rcvd: 42\n\n```\nIn order to avoid higher level parsing logic, the Scapy library was used to forge raw DNS\npackets and build an automated scanner.\n\nThe snippet below shows the core function where the packers are sent and the responses\nare compared:\n```\ndef checkDNS(name):\n  ip = name\n  try:\n    ans = sr1(IP(dst=ip)/UDP(sport=RandShort(),\ndport=53)/DNS(rd=1,qd=DNSQR(qname=\"google.com\",qtype=\"TXT\")), verbose=False,\ntimeout=0.5)\n    ansTXT = ans[DNSRR][0].rdata\n    ans = sr1(IP(dst=ip)/UDP(sport=RandShort(),\ndport=53)/DNS(rd=1,qd=DNSQR(qname=\"amazon.com\",qtype=\"A\")), verbose=False,\ntimeout=0.5)\n    ansA1 = ans[DNSRR][0].rdata\n    ans = sr1(IP(dst=ip)/UDP(sport=RandShort(),\ndport=53)/DNS(rd=1,qd=DNSQR(qname=\"google.com\",qtype=\"A\")), verbose=False,\ntimeout=0.5)\n    ansA2 = ans[DNSRR][0].rdata\n    if ansTXT == ansA1 and ansA1 == ansA2 and ansA2 != '' and valid_ip(ansA1):\n      print(\"[+] Cs Detected: \" + ip + \" replied with: \" + ansTXT)\n  except Exception as e:\n    pass\n\n```\n\n-----\n\nThe code is quite self-explanatory and simply translates the initial hypothesis into actual\nPython code. The rest of the script's functionalities only added multi threading and better\noutput formats, but the main logic is the one shown above.\n\nThe scanner was tested against a small subset of data, specifically using all the HTTP\nservers exposed on the internet that had a JARM signature equals to the default Cobalt\n[Strike C2 server. The data was gathered using the beta version of Shodan:](https://beta.shodan.io/search?query=http+ssl.jarm%3A%2207d14d16d21d21d07c42d41d00041d24a458a375eef0c576d23a7bab9a9fb1%22)\n\nAll the resulting data was downloaded and subsequently parsed via the Shodan CLI in order\nto extract the IP addresses:\n```\n# add shodan query\nshodan parse --fields ip_str e5a2e2e7-e029-4b10-a5f8-63687aa7a09c.json.gz >\ncobalt.txt\n\n```\nThe results against the initial dataset were positive, with multiple matches:\n```\npython scan.py ~/Downloads/cs-dns.txt\n[+] Cs Detected: 24.252.133.75 replied with: 10.0.0.1\n[+] Cs Detected: 193.202.92.36 replied with: 193.202.92.36\n[+] Cs Detected: 194.204.33.130 replied with: 127.53.53.53\n[+] Cs Detected: 194.62.33.31 replied with: 192.168.33.31\n[+] Cs Detected: 5.8.16.29 replied with: 72.5.65.111\n[+] Cs Detected: 37.191.180.47 replied with: 37.191.180.47\n[+] Cs Detected: 35.178.76.239 replied with: 8.8.8.8\n[+] Cs Detected: 85.27.174.244 replied with: 85.27.174.244\n[+] Cs Detected: 70.35.206.199 replied with: 0.0.0.0\n[+] Cs Detected: 209.9.227.212 replied with: 209.9.227.212\n[+] Cs Detected: 175.176.185.229 replied with: 103.60.101.170\n[+] Cs Detected: 179.191.84.68 replied with: 10.0.0.1\n\n```\n\n-----\n\n## Internet Wide Survey\n\nScanning what is already known to be bad is funny, but only to a certain extent. The next\nstep of the research was to expand the scope of our analysis to the whole internet.\n\nIn order to obtain the needed results, it was necessary to perform an internet wide scan of all\nthe hosts that exposed the port 53/UDP. Instead of manually doing the scan, it was decided\nto use Project Sonar's dataset, which already collected the information needed. This allowed\nus to reduce the scope of the scan from billions of IPs to something around 7 million records.\nThis was found to be particularly useful considering that the detection used a UDP-based\nprotocol, which in general is slower and not as reliable as TCP.\n\nRunning our scanner against the dataset produced approximately 1400 results, a number\nthat we believed to be too high and needed further validation and false positive checks. We\nstarted the result sanitisation by filtering out the hosts that presented additional Cobalt Strike\nspecific behaviour, such as:\n\nHaving port 50050 open\nReplying with a 404 status code on HTTP/S and 0 as content length, a distinct sign of\nthe Cobalt Strike's default malleable profile\nHaving a matching JARM signature\nHaving staging enabled, and it was possible to retrieve the Beacon configuration from\nan open HTTP port\nReplying with \"0.0.0.0\", the default \"dns_idle\" value\n\nThe results of the process were the following:\n\n24 IPs also exposed port 50050\n49 presented the default Cobalt Strike's HTTP response\n27 Cobalt Strike servers had staging enabled, that allowed F-Secure to retrieve the\nbeacon's config\n91 servers replied with \"0.0.0.0\"\n16 servers had the\n\"07d14d16d21d21d07c42d41d00041d24a458a375eef0c576d23a7bab9a9fb1\" JARM\nsignature, indicative of Cobalt Strike\n\nAmongst the 1400 results, 122 had high probability of being Cobalt Strike servers, due to the\npresence of one or more of the signatures above. Upon further investigation of the beacon\n[configurations extracted using this extremely useful Nmap script, a recurring pattern using](https://github.com/whickey-r7/grab_beacon_config)\n8.8.8.8 as dns_idle was noticed:\n\n\n-----\n\n```\n{\n  \"x64\":{\n   \"md5\":\"26dca1f00735af2e11d856cdbc239a72\",\n   \"sha1\":\"0f964782e58ac43ab0433b7cbb007295eed1bcd1\",\n   \"time\":1616664618025.3,\n   \"config\":{\n     \"Port\":80,\n     \"Beacon Type\":\"0 (HTTP)\",\n     \"Polling\":50000,\n     \"Pipe Name\":\"\",\n     \"User Agent\":\"Mozilla\\\\/5.0 (compatible; MSIE 9.0; Windows Phone OS 7.5;\nTrident\\\\/5.0; IEMobile\\\\/9.0; LG; LG-E906)\",\n     \"Jitter\":15,\n     \"Header 1\":\"\",\n     \"Method 2\":\"POST\",\n     \"Spawn To x86\":\"%windir%\\\\\\\\syswow64\\\\\\\\rundll32.exe\",\n     \"C2 Server\":\"[REDACTED],\\\\/_\\\\/scs\\\\/mail-static\\\\/_\\\\/js\\\\/\",\n     \"Method 1\":\"GET\",\n     \"Spawn To x64\":\"%windir%\\\\\\\\sysnative\\\\\\\\rundll32.exe\",\n     \"Max DNS\":255,\n     \"Header 2\":\"\",\n     \"HTTP Method Path 2\":\"\\\\/mail\\\\/u\\\\/0\\\\/\",\n     \"DNS Sleep\":0,\n     \"DNS Idle\":\"8.8.8.8\"\n   },\n   \"sha256\":\"ce4d2de8d28423bc975b7792b69722e8b8e01c01c723f43e494709062fcdb550\"\n  },\n  \"x86\":{\n   \"md5\":\"d836ddfcb06c1959d002fabd70aff8fd\",\n   \"sha1\":\"7d8c5d34da8a0ece4fcda322a1c814b285d4b8f8\",\n   \"time\":1616664587530.2,\n   \"config\":{\n     \"Port\":80,\n     \"Beacon Type\":\"0 (HTTP)\",\n     \"Polling\":50000,\n     \"Pipe Name\":\"\",\n     \"User Agent\":\"Mozilla\\\\/4.0 (compatible; MSIE 8.0; Windows NT 5.1;\nTrident\\\\/4.0; BTRS125526)\",\n     \"Jitter\":15,\n     \"Header 1\":\"\",\n     \"Method 2\":\"POST\",\n     \"Spawn To x86\":\"%windir%\\\\\\\\syswow64\\\\\\\\rundll32.exe\",\n     \"C2 Server\":\"[REDACTED],\\\\/_\\\\/scs\\\\/mail-static\\\\/_\\\\/js\\\\/\",\n     \"Method 1\":\"GET\",\n     \"Spawn To x64\":\"%windir%\\\\\\\\sysnative\\\\\\\\rundll32.exe\",\n     \"Max DNS\":255,\n     \"Header 2\":\"\",\n     \"HTTP Method Path 2\":\"\\\\/mail\\\\/u\\\\/0\\\\/\",\n     \"DNS Sleep\":0,\n     \"DNS Idle\":\"8.8.8.8\"\n   },\n   \"sha256\":\"52029626c23dc2cd60f65e0bfa087021f0ee4d96ed0259a6e03cd7ff2fd471ac\"\n  }\n}\n\n```\n\n-----\n\nIt was decided to include that value as another possible indicator, that brought the total\nnumber of Cobalt Strike servers to 135. The remaining number of servers were split in the\nfollowing categories:\n\nFalse positives, we identified that some home router versions acted in a similar way as\nCobalt Strike's DNS server. Those could be false positives or actual CS servers.\nCobalt Strike DNS servers that changed the default \"dns_idle\" value and did not host\nan HTTP server on the same IP address.\nDNS sinkholes and honeypots. Despite efforts were made to avoid this, it is possible\nthat some DNS servers acted in a similar way to Cobalt Strike.\n\nThe complete scan results will be posted after the release of this blog post, alongside with\nthe source code of the scanner.\n\n## Hardening for Red Teamers\n\nThe root cause that allowed us to perform this research is that the DNS redirector is \"dumb\",\nmeaning that it forwards DNS requests to Cobalt Strike without any logic. If, for example, we\nexamine the evolution of HTTP based redirectors we see that using socat or iptables was\nquickly abandoned in favour of better alternatives such as Apache with mod_rewrite or\nNginx.\n\nThe problem is that we haven't seen the same approach applied to DNS redirectors. A\npossible solution would be to create a \"smart\" redirector capable of proxying DNS requests\nto specific DNS servers based on the domain name that is being requested:\n\nWe found that using open source DNS servers, such as CoreDNS, solved the issue. In fact,\nusing a \"Corefile\" such as the one shown below, it would be possible to avoid this trivial\ndetection:\n\n\n-----\n\n```\n. {\n forward . 9.9.9.9\n}\nmalware.c2 {\n  forward . malware.c2:5353\n}\n\n```\nCoreDNS can then be deployed on an internet exposed VPS and act as a \"smart\" redirector.\nThis configuration will proxy to Cobalt Strike only the requests made for the \"malware.c2\"\ndomain, everything else will be resolved using the \"9.9.9.9\" public resolver.\n\n## Conclusions\n\nThe research showed one of the many approaches that can be used to track Cobalt Strike\nservers exposed on the internet. Whilst not perfect, this can certainly be used to enrich threat\nintelligence data to achieve better detections.\n\nFor red teamers and penetration testers that use either Cobalt Strike or any other C2\nframework that supports DNS, we provided an approach that can be used to build better and\nsmarter DNS redirectors using open source tools.\n\n## References\n\n[Bluescreenofjeff - Red Team Infrastructure Wiki](http://10.10.0.46/**%5BRed-Team-Infrastructure-Wiki%5D(https:/github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki)**)\n\n[Steve Borosh - Redirecting Cobalt Strike DNS Beacons](https://medium.com/rvrsh3ll/redirecting-cobalt-strike-dns-beacons-e3dcdb5a8b9b)\n\n[Cobalt Strike - Simple DNS Redirectors for Cobalt Strike](https://blog.cobaltstrike.com/2021/03/11/simple-dns-redirectors-for-cobalt-strike/)\n\n[Whiskey-r7 - grab_beacon_config](https://github.com/whickey-r7/grab_beacon_config)\n\n[Salesforce - JARM](https://engineering.salesforce.com/easily-identify-malicious-servers-on-the-internet-with-jarm-e095edac525a)\n\n[CoreDNS](https://coredns.io/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-09 - Detecting Exposed Cobalt Strike DNS Redirectors.pdf"
    ],
    "report_names": [
        "2021-04-09 - Detecting Exposed Cobalt Strike DNS Redirectors.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536001,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653678359,
    "ts_modification_date": 1653678359,
    "files": {
        "pdf": "https://archive.orkl.eu/306a52c582098d9f92a8533758b4f09db7b1a0d3.pdf",
        "text": "https://archive.orkl.eu/306a52c582098d9f92a8533758b4f09db7b1a0d3.txt",
        "img": "https://archive.orkl.eu/306a52c582098d9f92a8533758b4f09db7b1a0d3.jpg"
    }
}