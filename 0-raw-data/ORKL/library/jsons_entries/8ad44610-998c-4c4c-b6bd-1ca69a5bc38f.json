{
    "id": "8ad44610-998c-4c4c-b6bd-1ca69a5bc38f",
    "created_at": "2023-01-12T15:03:55.116569Z",
    "updated_at": "2025-03-27T02:16:55.533626Z",
    "deleted_at": null,
    "sha1_hash": "a281ea2bb6b94fa97b9b92df555c1cc0ff8a6812",
    "title": "2022-01-26 - KONNI evolves into stealthier RAT",
    "authors": "",
    "file_creation_date": "2022-05-28T19:06:01Z",
    "file_modification_date": "2022-05-28T19:06:01Z",
    "file_size": 370420,
    "plain_text": "# KONNI evolves into stealthier RAT\n\n**[blog.malwarebytes.com/threat-intelligence/2022/01/konni-evolves-into-stealthier-rat/](https://blog.malwarebytes.com/threat-intelligence/2022/01/konni-evolves-into-stealthier-rat/)**\n\nThreat Intelligence Team January 26, 2022\n\n_This blog post was authored by Roberto Santos_\n\nKONNI is a Remote Administration Tool that has being used for at least 8 years. The North\nKorean threat actor that is using this piece of malware has being identified under the\nKimsuky umbrella. This group has been very busy, attacking political institutions located in\nRussia and South Korea. The last known attack where KONNI Rat was used was described\n[here.](https://blog.lumen.com/new-konni-campaign-targeting-russian-ministry-of-foreign-affairs)\n\nWe found that KONNI Rat is being actively developed, and new samples are now including\nsignificant updates. In this blog post, we will cover some of the major changes and explain\nwhy the security community should keep a close eye on it.\n\n## Simplified Attack Chain\n\nThe attack usually starts leveraging a malicious Office document. When this document is\nopened by the victim, a multistage attack is started, involving various steps. But these steps\nare just the way that the attackers manage to accomplish tasks to elevate privileges, evade\n[detection and deploy required files. As we described in a previous blog post, the attack chain](https://blog.malwarebytes.com/threat-intelligence/2021/08/new-variant-of-konni-malware-used-in-campaign-targetting-russia/)\ncould be summarized in the following diagram:\n\n\n-----\n\nSimplified attack chain\nThe attack usually starts leveraging a malicious Office document. When this document is\nopened by the victim, a multistage attack is started, involving various steps. But these steps\nare just the way that the attackers manage to accomplish tasks to elevate privileges, evade\ndetection and deploy required files.\n\nThe final goal of the attack is installing what is called KONNI Rat, which is a .dll file\nsupported by an .ini file. In a nutshell, the .dll file contains the functionality of the RAT, and\nthe .ini file contains the address of the first C&C server. KONNI Rat’s general behavior\nremains almost the same as previous versions, but there are changes we will cover below.\n\n## Rundll no longer supported\n\nIn previous KONNI Rat samples there were two branches. One handles if the malware was\nlaunched using a Windows service, and the other handles the execution through rundll. The\nnext image shows these two old branches, with the strings svchost.exe and rundll32.exe\nvisible:\n\nOld main function showing svchost.exe and rundll32.exe strings\n\n\n-----\n\nHowever, new samples will not show these strings. In fact, rundll is no longer a valid way\n**to execute the sample. Instead, when an execution attempt occurs using rundll, an**\nexception is thrown in the early stages.\n\nException produced by a rundll execution\nIn early stages of our analysis, we thought that they were using the classic process name\ncheck, or any other usual technique. The reality is far simpler and brilliant; the actual export\njust implements the SvcMain prototype so the program will break at some point when\naccessing one of the arguments.\n\nIn the previous image we see the state of the machine at the moment that this exception is\nthrown. RDI at that point should contain a pointer to the service name. The exception\nhappens because the Service Main function meets one prototype and rundll32 will expect\nanother different prototype:\n\nVOID WINAPI SvcMain( DWORD dwArgc, LPTSTR *lpszArgv )\n\nVOID WINAPI runnableExport(HWND hwnd, HINSTANCE hinst, LPSTR lpszCmdLine, int\nnCmdShow)\n\nBasically, at some point of the execution, hinst will be treated as lspzArgv, causing the\nexception. But why did the attackers delete that functionality? There are multiple benefits.\n\nFirst of all, we have not seen any recent attack that used rundll. In fact, the only way that the\nattackers launched KONNI Rat in recent campaigns involves registering a Windows service.\nSo the rundll32 branch wasn’t being used in real world attacks.\n\n\n-----\n\nBut there is another big reason in how sandboxes will fail in collecting the real behavior of\nthe sample, as it just cannot execute that way.\n\n## Strings are now protected using AES\n\nMultiple malware families protect their strings in order to defeat most basic string analysis.\nKONNI wasn’t an exception, and also used this technique. Old samples were using base64\nfor obfuscation means. Also, they were using a custom alphabet. This custom alphabet was\nchanged from time to time in order to make the decoding task more difficult:\n\nOld Konni samples included their custom base64 alphabet followed by the obfuscated strings\nNow, the attackers made a major change in that regard by protecting the strings using AES\nencryption. The algorithm followed by new Konni RAT samples could be represented as\nfollows:\n\n\n-----\n\nNew KONNI samples now uses AES encryption for string protection\nThe reason behind that change is clear. As the key used for decryption is the service name,\nsamples run by different service names will not work properly. Moreover, having only the\nsample without knowing the service name becomes useless, as these strings contain\ncore information about the sample behavior.\n\n## Files are also protected using AES\n\nKONNI Rat makes use of various support files when it is executed. One of these files is the\n.ini file, which contains the primary C&C server, but there are others like the .dat file that is\nsupposed to be dropped eventually, and temporal files that are used to send some basic\ninformation about the computer.\n\nOur tests reveal that all of these files are dropped and protected using AES. Cleverly, they\nreused the algorithm used for string protection, making the file layout identical to the\nprotected strings layout, as they appear in raw memory:\n\nNew\n\nKONNI samples now uses AES encryption also for file protection\nAs can be seen from the diagram, the file itself contains the IV and the encrypted data. The\nkey used is extracted from its original filename. In some cases, the names match with the\nservice name, so the keys used in the .ini and the .dat files are the result of applying a\n\n\n-----\n\nSHA256 to the service name as well.\n\nAlso, files sent to the C&C server are protected using AES. The IV is generated using a\nQueryPerformanceCounter API CALL. Filenames are generated concatenating 2 letters that\nrepresent the data with the current timestamp, followed by the extension. Furthermore, they\nwill use this newly generated name as AES key, so they send this name through the request\nto the C&C server.\n\nFragment of request about to be sent to the server\nIn that regard, as the filename is generated automatically using the timestamp, identical files\nwill produce different request contents, as they were encrypted using that filename. Network\n**signatures could also fail to detect the malicious activity, due to that.**\n\n## Other obfuscation techniques\n\nAs we found some samples that were protected just by the means that we described before,\nwe also have found others that were making use of an unidentified packer (UPDATE: There\n_is a strong correlation between this packer and VMPROTECT v3, as you would see in the_\n_following paragraphs. Later deeper analysis tasks suggest that this is probably the packer_\n_that was used in this ocasion). We would like to share some of our notes regarding that_\npacker, as others could find it useful in identification and attribution tasks.\n\n### Contiguous instruction obfuscation\n\nThe flow of the obfuscated program will make use of series of push-call pairs of instructions,\nwhere the pushed values will indicate the actions that the program will take. An image can\nbetter explain that:\n\n\n-----\n\nPush – Call series\nIn particular, we find it interesting that the attackers have placed random bytes between\nthese pairs. This silly trick causes wrong code interpretation for decompilers that will assume\nthat bytes after the push instruction are part of the next instruction. The image below shows\nhow IDA fails in analyzing the code:\n\nSame code as before, showing how IDA won’t represent the real code\n\n### Obfuscated program flow\n\nThe used packer will obfuscate the original program flow. This is accomplished in various\nsteps. The first required step is to find the Image Base value, placed in a fixed location and\nthe RIP (Instruction Pointer) value.\n\n\n-----\n\nEBX will save the RIP value\nOnce the packer knows these two values, it will start jumping from one place to another,\nmaking analysis harder. For that, it will store in some register value of the next address to\njump in registers. The value of these registers is calculated right after the jmp instruction,\nusing structures like POP [reg] – JMP [reg] or ADD [reg1, reg2] – JMP [reg1]. Note that\ndecompilers will fail in displaying the real flow, as the jumping address is determined by a\nsomehow undefined register.\n\nObfuscated code showing a final jmp to RBX\n\nThe combination of these simple techniques ends in the packer being now in control of the\nflow, but statically the decompiler cannot represent the path that the code will follow. Finally,\nthe packer will execute a big amount of junk instructions and eventually will execute the real\ninteresting code. For instance, the original code will take no more than 20 instructions\nbetween GetProcAddress calls in IAT building tasks. but the packed code executes more\nthan 30,000 instructions.\n\nAccording to our threat intel data, most recent attacks are not making use of that packer\nanymore.\n\n\n-----\n\n## Conclusion\n\nAs we have seen, KONNI Rat is far from being abandoned. The authors are constantly\nmaking code improvements. In our point of view, their efforts are aimed at breaking the\ntypical flow recorded by sandboxes and making detection harder, especially via regular\nsignatures as critical parts of the executable are now encrypted.\n\nMalwarebytes users are protected against this attack.\n\n## IOCs\n\nA3CD08AFD7317D1619FBA83C109F268B4B60429B4EB7C97FC274F92FF4FE17A2\n\nF702DFDDBC5B4F1D5A5A9DB0A2C013900D30515E69A09420A7C3F6EAAC901B12\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-26 - KONNI evolves into stealthier RAT.pdf"
    ],
    "report_names": [
        "2022-01-26 - KONNI evolves into stealthier RAT.pdf"
    ],
    "threat_actors": [
        {
            "id": "b43c8747-c898-448a-88a9-76bff88e91b5",
            "created_at": "2024-02-02T02:00:04.058535Z",
            "updated_at": "2025-03-27T02:00:03.302832Z",
            "deleted_at": null,
            "main_name": "Opal Sleet",
            "aliases": [
                "OSMIUM",
                "Konni",
                "Vedalia"
            ],
            "source_name": "MISPGALAXY:Opal Sleet",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b9458777-d970-4e89-b2d2-e532140a390f",
            "created_at": "2024-05-01T02:03:08.140328Z",
            "updated_at": "2025-03-27T02:05:17.41728Z",
            "deleted_at": null,
            "main_name": "NICKEL JUNIPER",
            "aliases": [
                "OSMIUM ",
                "Opal Sleet ",
                "Konni"
            ],
            "source_name": "Secureworks:NICKEL JUNIPER",
            "tools": [
                "KONNI"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "dc78f675-b309-431d-8160-b8dcff037d4f",
            "created_at": "2024-05-01T02:03:08.142224Z",
            "updated_at": "2025-03-27T02:05:17.417972Z",
            "deleted_at": null,
            "main_name": "NICKEL KIMBALL",
            "aliases": [
                "Black Banshee ",
                "Crooked Pisces ",
                "Emerald Sleet ",
                "Kimsuky ",
                "Opal Sleet ",
                "SharpTongue ",
                "TA427 ",
                "THALLIUM ",
                "Velvet Chollima ",
                "APT43 "
            ],
            "source_name": "Secureworks:NICKEL KIMBALL",
            "tools": [
                " KONNI",
                " KimJongRAT",
                " Kimsuky",
                "BabyShark"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "760f2827-1718-4eed-8234-4027c1346145",
            "created_at": "2023-01-06T13:46:38.670947Z",
            "updated_at": "2025-03-27T02:00:02.888195Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "Thallium",
                "G0086",
                "APT43",
                "Springtail",
                "Sparkling Pisces",
                "Velvet Chollima",
                "Black Banshee",
                "Operation Stolen Pencil",
                "Emerald Sleet",
                "THALLIUM"
            ],
            "source_name": "MISPGALAXY:Kimsuky",
            "tools": [
                "RevClient",
                "xrat",
                "QUASARRAT",
                "RDP Wrapper",
                "TightVNC",
                "BabyShark"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "191d7f9a-8c3c-442a-9f13-debe259d4cc2",
            "created_at": "2022-10-25T15:50:23.280374Z",
            "updated_at": "2025-03-27T02:00:55.423485Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "Kimsuky",
                "Black Banshee",
                "Velvet Chollima",
                "Emerald Sleet",
                "THALLIUM",
                "APT43",
                "TA427"
            ],
            "source_name": "MITRE:Kimsuky",
            "tools": [
                "schtasks",
                "Amadey",
                "Brave Prince",
                "CSPY Downloader",
                "gh0st RAT",
                "AppleSeed",
                "NOKKI",
                "QuasarRAT",
                "Gold Dragon",
                "PsExec",
                "KGH_SPY",
                "Mimikatz",
                "BabyShark"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "71a1e16c-3ba6-4193-be62-be53527817bc",
            "created_at": "2022-10-25T16:07:23.753455Z",
            "updated_at": "2025-03-27T02:02:09.963016Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "APT 43",
                "Black Banshee",
                "Emerald Sleet",
                "ITG16",
                "KTA082",
                "Kimsuky",
                "Larva-24005",
                "Operation Baby Coin",
                "Operation Covert Stalker",
                "Operation DEEP#DRIVE",
                "Operation DEEP#GOSU",
                "Operation Kabar Cobra",
                "Operation Mystery Baby",
                "Operation Red Salt",
                "Operation Smoke Screen",
                "Operation Stealth Power",
                "Operation Stolen Pencil",
                "SharpTongue",
                "Sparkling Pisces",
                "Springtail",
                "TA406",
                "TA427",
                "Thallium",
                "UAT-5394",
                "Velvet Chollima"
            ],
            "source_name": "ETDA:Kimsuky",
            "tools": [
                "AngryRebel",
                "AppleSeed",
                "BITTERSWEET",
                "BabyShark",
                "BoBoStealer",
                "CSPY Downloader",
                "Farfli",
                "FlowerPower",
                "Gh0st RAT",
                "Ghost RAT",
                "Gold Dragon",
                "GoldDragon",
                "GoldStamp",
                "JamBog",
                "KGH Spyware Suite",
                "KGH_SPY",
                "KPortScan",
                "KimJongRAT",
                "Kimsuky",
                "LATEOP",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Lovexxx",
                "MailPassView",
                "Mechanical",
                "Mimikatz",
                "MoonPeak",
                "Moudour",
                "MyDogs",
                "Mydoor",
                "Network Password Recovery",
                "PCRat",
                "ProcDump",
                "PsExec",
                "ReconShark",
                "Remote Desktop PassView",
                "SHARPEXT",
                "SWEETDROP",
                "SmallTiger",
                "SniffPass",
                "TODDLERSHARK",
                "TRANSLATEXT",
                "Troll Stealer",
                "TrollAgent",
                "VENOMBITE",
                "WebBrowserPassView",
                "xRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535835,
    "ts_updated_at": 1743041815,
    "ts_creation_date": 1653764761,
    "ts_modification_date": 1653764761,
    "files": {
        "pdf": "https://archive.orkl.eu/a281ea2bb6b94fa97b9b92df555c1cc0ff8a6812.pdf",
        "text": "https://archive.orkl.eu/a281ea2bb6b94fa97b9b92df555c1cc0ff8a6812.txt",
        "img": "https://archive.orkl.eu/a281ea2bb6b94fa97b9b92df555c1cc0ff8a6812.jpg"
    }
}