{
    "id": "17c65952-bea0-4efd-9384-edbdc10d83b3",
    "created_at": "2023-03-03T02:05:47.045769Z",
    "updated_at": "2025-03-27T02:16:22.892308Z",
    "deleted_at": null,
    "sha1_hash": "ac31db60e59bf1e6b896c8d0fe1ab788c14d964d",
    "title": "2022-10-12 - IcedID BackConnect Protocol",
    "authors": "",
    "file_creation_date": "2023-03-01T09:19:46Z",
    "file_modification_date": "2023-03-01T09:19:46Z",
    "file_size": 473156,
    "plain_text": "# IcedID BackConnect Protocol\n\n**netresec.com/**\n\nErik Hjelmvik\n\n,\n\nWednesday, 12 October 2022 18:24:00 (UTC/GMT)\n\n\nOctober 12, 2022\n\n\nThis is a follow-up to my [Hunting for C2 Traffic video.\nBut I didn't have time to record a short](https://netresec.com/?b=2296553)\nvideo this time, so I wrote a long blog post instead.\n\n_UPDATE 2022-11-02_\n\n[Brad Duncan has released a new pcap file on malware-traffic-analysis.net, which contains an](https://www.malware-traffic-analysis.net/2022/10/31/index.html)\nadditional C2 command (0x12).\nOur analysis indicates that this command launches a file\nmanager. This blog post has now been updated with details about this finding.\n\n_UPDATE 2022-11-09_\n\nLenny Hansson has released IDS signatures that detect IcedID BackConnect traffic. More\ndetails further down in this blog post.\n\n_UPDATE 2022-12-05_\n\nLenny has updated his IDS signatures to alert on IcedID C2 traffic from port 443 in addition\nto 8080. The signatures in this blog post have now been updated to Lenny's new rev:2\nsignatures.\n\n**IcedID BackConnect C2 Packet Structure**\n\nThe IcedID BackConnect (BC) module uses a proprietary command-and-control (C2)\nprotocol that is pretty straight forward. Both client (bot) and the C2 server typically send\ncommands and responses as 13 byte packets using the following structure:\n\nAuth: 4 bytes\nCommand: 1 byte\nParams: 4 bytes\nID: 4 bytes\n\n**Auth Field**\n\n\n-----\n\nThe Auth field is presumably used by the bot and C2 server to verify that the other party is\ncommunicating using the same protocol and version.\n\n[As mentioned by Group-IB and](https://blog.group-ib.com/icedid) [xors the Auth field is typically 0x974F014A (little endian), but](https://nikpx.github.io/malware/analysis/2022/03/09/BokBot)\nwe prefer to use the network byte order representation \"4a 01 4f 97\".\n\nIn their [IcedID blog post from 2020 Group-IB say:](https://blog.group-ib.com/icedid)\n\nthe auth field that has not changed since at least version 5 of the IcedID core is the\nconstant 0x974F014A\n\nNevertheless, we recently noticed another IcedID Auth field being used in the wild. But more\non that later.\n\n**Commands**\n\nThe following list of IcedID BackConnect C2 commands has been compiled by combining\nthose mentioned by Group-IB with our own analysis of the IcedID BackConnect protocol:\n\n0x00 = Bot queries for a task\n0x01 = Set sleep timer\n0x02 = Bot error\n0x03 = Reconnect\n0x04 = Start SOCKS\n0x05 = Start VNC\n\nWe've also discovered these additional commands in IcedID BackConnect C2 traffic that\nuses the Auth value \"1f 8b 08 08\":\n\n0x11 = Start VNC\n0x12 = Start file manager\n0x13 = Start reverse shell\n\nCommands 0x04, 0x05, 0x11, 0x12 and 0x13 all cause the bot to connect back to the C2\nserver using a new BackConnect session, which will be used to wrap either SOCKS, VNC,\nfile manager or reverse shell traffic.\n\n**Command 0x01: Set Sleep Timer**\n\nThe set sleep timer command is issued by the C2 server to instruct the bot to sleep for a\ncertain amount of time before requesting a new task from the C2 server again.\nThe sleep\ntime is defined in the four bytes following directly after the 0x01 command.\nThis value is a\n32-bit little endian value indicating the number of seconds the bot should sleep, i.e. \"3c 00 00\n00\" = 0x0000003c = 60 seconds. The most common sleep value seems to be 60 seconds,\nwhich is why you'll often see byte sequences like this in IcedID C2 sessions:\n\n\n-----\n\nzz zz zz zz 01 3c 00 00 00 xx xx xx xx\n\nThe following Wireshark display filter will show IcedID C2 packets, where the bot is\nconfigured to sleep for 60 seconds before querying the C2 server for a new command:\n\ntcp.len == 13 and tcp.payload[4:5] == 01:3c:00:00:00\n\n**Command 0x04: Start SOCKS**\n\nThe SOCKS command (0x04) instructs the bot to start the SOCKS module.\nAs an example,\nthe following byte sequence was sent by the IcedID C2 server 91.238.50.80:8080 in Brad\n[Duncan's 2022-06-28 TA578 IcedID pcap on malware-traffic-analysis.net (see frame](https://www.malware-traffic-analysis.net/2022/06/28/index.html)\n#10231):\n\n4a 01 4f 97 04 09 00 00 00 8c a2 b1 09\n\nThe first four bytes are the auth value, followed by the Start SOCKS command (04).\n\nAfter receiving this command the bot established a new TCP connection back to the C2\nserver, where it echoed back the server's \"Start SOCKS\" command and then started acting\nlike a SOCKS server.\n\nExcept for initially echoing the IcedID Start SOCKS command the SOCKS module actually\n[seems to be compliant with RFC1928, which defines the SOCKS5 protocol.\nThis means that](https://www.rfc-editor.org/rfc/rfc1928)\nthe C2 server can supply an IP address and port number to the bot's SOCKS proxy in order\nto relay a connection to that host through the bot.\n\n\n-----\n\n_Image: C2 server instructs bot to relay a connection to 188.40.30.100:80_\n\nAfter receiving a Start SOCKS command an IcedID bot immediately establishes a new TCP\nconnection to the specified IP and port, and relays the application layer data back to the C2\nserver through the SOCKS connection.\n\n\n-----\n\n_Image: Update check of Advanced Port Scanner relayed through the infected machine_\n\nIn the [2022-06-28 TA578 IcedID pcap the attacker used multiple SOCKS connections to](https://www.malware-traffic-analysis.net/2022/06/28/index.html)\nscan the 10.6.21.0/24 network for services running on TCP ports 21, 80, 445 and 4899. That\nlast port (TCP 4899) is typically used by Radmin VPN, which just so happens to be created\nby the outfit \"Famatech\" who also develop the \"Advanced Port Scanner\". The attacker also\nused the SOCKS module to make several HTTPS connections to servers like 18.204.62.252\n(tlx.3lift[.]com), 23.94.138.115 (cmd5[.]org) and 74.119.118.137 (cat.da.us.criteo[.]com). The\nattacker also proxied connections to 40.97.120.242 and 52.96.182.162 (outlook.live.com)\nthrough the infected bot.\n\n\n-----\n\n_NetworkMiner showing hosts that the bot proxied TLS traffic to_\n\n**JA3 Fingerprints from Proxied Traffic**\n\nSince the SOCKS proxy doesn't touch the application layer data we know that the client TLS\nhandshake packets are coming from the C2 server rather than from the bot that's running the\nSOCKS proxy. This means that we can fingerprint the actual TLS client using JA3.\n\n\n-----\n\nAs you can see in the CapLoader screenshot above, most proxied TLS sessions use the\ncd08e31494f9531f560d64c695473da9 JA3 hash, but two of them use the rare JA3 hash\n598872011444709307b861ae817a4b60. That rare JA3 hash was used only when\nconnecting to outlook.live.com.\n\n**Command 0x05 or 0x11: VNC**\n\n[Brad Duncan's 2022-06-28 TA578 IcedID pcap also contains the \"Start VNC\" command](https://www.malware-traffic-analysis.net/2022/06/28/index.html)\n0x05.\n\n\n-----\n\n_Image: Flow transcript of Start VNC command_\n\nAs can be seen in the CapLoader screenshot above, Start VNC commands were sent at\n16:33:33 and 16:34:06 UTC. And just like the SOCKS command, this caused the bot to\nestablish a new connection back to the C2 server, echo the \"Start VNC\" command and then\nproceed with the VNC traffic.\n\n_Image: Flow transcript of IcedID VNC traffic in ASCII encoding_\n\n\n-----\n\n**Command 0x13: Reverse Shell**\n\nBrad posted a [new capture file with network traffic from another IcedID infection last week](https://malware-traffic-analysis.net/2022/10/04/index.html)\n(2022-10-04).\nHe also [noted that the traffic to 51.89.201.236:8080 was different from normal](https://twitter.com/malware_traffic/status/1577780925210959882)\nIcedID post-infection traffic.\n\nAfter looking at this C2 traffic I discovered that it was in fact using the IcedID BackConnect\nprotocol outlined in this blog post, but the Auth field \"4a 01 4f 97\" had been replaced with \"1f\n8b 08 08\".\n\n[That exact byte sequence is a common file header for gzip compressed files (RFC1952),](https://www.rfc-editor.org/rfc/rfc1952)\nwhere\n\n1f 8b = GZIP magic\n08 = DEFLATE compression\n08 = Original file name header present\n\n[IcedID has previously been seen using fake gzip file headers in payloads, but this time even](https://www.binarydefense.com/icedid-gziploader-analysis/)\nthe C2 packets include the gzip header!\n\n\n-----\n\n_Image: Transcript of TCP session to 51.89.201.236:8080_\n\nThe C2 traffic also contained the command 0x13, which I hadn't seen before.\nJust like the\nSOCKS and VNC commands, this one triggered the bot to establish a new connection back\nto the C2 server. But the bot sent a task query command (00) this time, instead of echoing\nthe C2 server's command (0x13). The new TCP session then transitioned into what looks like\na reverse shell session.\n\n\n-----\n\n_Image: Transcript of reverse shell traffic from IcedID BackConnect session_\n\nThe reverse shell traffic reveals that the attackers retrieved a list of domain admin users and\n[then executed a PowerShell script from aicsoftware[.]com. This PowerShell script was used](https://www.virustotal.com/gui/file/eb88412c9a0f78dfd515e3c602548aea1aee4e91847289eb58214841350aa12f/detection)\nto install CobaltStrike beacon on the victim's PC.\n\n**Command 0x12: File Manager**\n\n_We discovered the file manager command after this blog post was published.\nThis section_\n_has therefore been added after the original publication of this blog post._\n\nThe following Wireshark display filter can be used to find file manager commands (0x12) in\nIcedID C2 traffic that uses the \"1f 8b 08 08\" auth value:\n\ntcp.len == 13 and tcp.payload[0:5] == 1f:8b:08:08:12\n\n\n-----\n\n_Image: File manager commands in IcedID BackConnect C2_\n\nThe screenshot above shows that the file manager command was issued three times in\n[2022-10-31-IcedID-with-DarkVNC-and-Cobalt-Strike-full-pcap-raw.pcap.](https://www.malware-traffic-analysis.net/2022/10/31/index.html)\n\n_Image: IcedID TCP sessions in CapLoader's Flows view_\n\nAs you can see in the two screenshots above, each time a file manager command was\nissued in the C2 session (Wireshark screenshot) the bot established a new TCP connection\nback to the C2 server (CapLoader screenshot).\n\nThe file manager sessions use a proprietary protocol to perform tasks such as listing disks,\nchanging directory and uploading files.\n\n\n-----\n\nWe've identified the following file manager commands:\n\n\n-----\n\nDISK = List drives\nCDDIR <path> = Change directory\nPWD = Show current directory\nDIR = List current directory\nPUT <path> = Upload file\n\n**IDS Signatures**\n\nLenny Hansson has released IDS signatures that can detect IcedID BackConnect traffic.\nI'd\nlike to highlight four of Lenny's signatures here.\n\nAlert on \"sleep 60 seconds\" C2 command, regardless of Auth value:\n\nalert tcp $EXTERNAL_NET [443,8080] -> $HOME_NET 1024: (msg:\"NF - Malware\nIcedID BackConnect - Wait Command\"; flow:established; flags:AP; dsize:13;\ncontent:\"|01 3c 00 00 00|\"; offset:4; depth:5; reference:url,networkforensic.dk;\nmetadata:02112022; classtype:trojan-activity; sid:5006006; rev:3;)\n\nAlert on \"start VNC\" C2 command with \"4a 01 4f 97\" Auth:\n\nalert tcp $EXTERNAL_NET [443,8080] -> $HOME_NET 1024: (msg:\"NF - Malware\nIcedID BackConnect - Start VNC command\"; flow:established; flags:AP; dsize:13;\ncontent:\"|4a 01 4f 97 05|\"; offset:0; depth:5; reference:url,networkforensic.dk;\nmetadata:03112022; classtype:trojan-activity; sid:5006007; rev:2;)\n\nAlert on \"start VNC\" C2 command with \"1f 8b 08 08\" Auth:\n\nalert tcp $EXTERNAL_NET [443,8080] -> $HOME_NET 1024: (msg:\"NF - Malware\nIcedID BackConnect - Start VNC command - 11\"; flow:established; flags:AP; dsize:13;\ncontent:\"|1f 8b 08 08 11|\"; offset:0; depth:5; reference:url,networkforensic.dk;\nmetadata:03112022; classtype:trojan-activity; sid:5006011; rev:2;)\n\nAlert on \"start file manager\" C2 command with \"1f 8b 08 08\" Auth:\n\nalert tcp $EXTERNAL_NET [443,8080] -> $HOME_NET 1024: (msg:\"NF - Malware\nIcedID BackConnect - Start file manager command\"; flow:established; flags:AP;\ndsize:13; content:\"|1f 8b 08 08 12|\"; offset:0; depth:5; reference:url,networkforensic.dk;\nmetadata:03112022; classtype:trojan-activity; sid:5006008; rev:2;)\n\n[A zip file containing Lenny's Snort rules can be downloaded from networkforensic.dk.](https://networkforensic.dk/)\n\n**Questions and Answers**\n\nAllright, that's all I had to say about the IcedID BackConnect C2 protocol. I'm now ready to\ntake your questions.\n\n\n-----\n\nQ: Is IcedID s BackConnect VNC traffic the same thing as DarkVNC?\n\nNo, DarkVNC traffic doesn't use the IcedID BackConnect C2 Packet Structure described in\nthis blog post. Also, one characteristic behavior DarkVNC is that the first C2 packet contains\na string that looks like one of these:\n\n(COMPUTERNAME)_ADDITIONAL_ID-DARKVNC\nBOT-COMPUTERNAME(USERNAME)_ID-REFnnn\nUSR-COMPUTERNAME(USERNAME)_ID-REFnnn\n\nAdditionally, the first four bytes in the DarkVNC packets containing one of the strings above\nis a 32 bit little endian length field.\nFor more details on DarkVNC, see the archived blog post\n[A short journey into DarkVNC attack chain from REAQTA.](https://web.archive.org/web/20200530034502/https://reaqta.com/2017/11/short-journey-darkvnc/)\nQ: Is IcedID's BackConnect VNC traffic the same thing as hVNC?\n\nAlmost. hVNC means \"hidden VNC\" and includes any type of malicious VNC server running\non a victim's PC, including IcedID's VNC module as well as DarkVNC.\n\nQ: How did you get Wireshark to decode the SOCKS traffic from IcedID BackConnect?\n\n1. Open the pcap file from [2022-06-28 TA578 IcedID](https://www.malware-traffic-analysis.net/2022/06/28/index.html)\n2. Apply display filter: tcp.port eq 8080\n3. Right-click, Decode As, TCP port 8080 = SOCKS\n4. Display filter: tcp.dstport eq 8080 and tcp.len eq 13 and tcp.payload[0:5] eq\n\n4a:01:4f:97:04\n5. Select all packets (Ctrl+A)\n6. Edit, Ignore Packets (Ctrl+D)\n7. Display filter: socks.dst\n\nQ: Can CapLoader's Protocol Identification feature detect the IcedID BackConnect protocol?\n\nThe current version (1.9.4) doesn't have a protocol model for the BackConnect protocol, but\nthe next [CapLoader release will be able to identify this type if IcedID C2 traffic.](https://www.netresec.com/?page=CapLoader)\n\nPosted by Erik Hjelmvik on Wednesday, 12 October 2022 18:24:00 (UTC/GMT)\n\n[Tags: #IcedID​\n#TA578​\n#SOCKS​\n#SOCKS5​\n#JA3​\n#gzip​\n#PowerShell​](https://www.netresec.com/?page=Blog&tag=IcedID)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-10-12 - IcedID BackConnect Protocol.pdf"
    ],
    "report_names": [
        "2022-10-12 - IcedID BackConnect Protocol.pdf"
    ],
    "threat_actors": [
        {
            "id": "62585174-b1f8-47b1-9165-19b594160b01",
            "created_at": "2023-01-06T13:46:39.369991Z",
            "updated_at": "2025-03-27T02:00:03.065156Z",
            "deleted_at": null,
            "main_name": "TA578",
            "aliases": [],
            "source_name": "MISPGALAXY:TA578",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "52eb5fb6-706b-49c0-9ba5-43bea03940d0",
            "created_at": "2024-11-01T02:00:52.694476Z",
            "updated_at": "2025-03-27T02:00:55.51014Z",
            "deleted_at": null,
            "main_name": "TA578",
            "aliases": [
                "TA578"
            ],
            "source_name": "MITRE:TA578",
            "tools": [
                "Latrodectus",
                "IcedID"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1677809147,
    "ts_updated_at": 1743041782,
    "ts_creation_date": 1677662386,
    "ts_modification_date": 1677662386,
    "files": {
        "pdf": "https://archive.orkl.eu/ac31db60e59bf1e6b896c8d0fe1ab788c14d964d.pdf",
        "text": "https://archive.orkl.eu/ac31db60e59bf1e6b896c8d0fe1ab788c14d964d.txt",
        "img": "https://archive.orkl.eu/ac31db60e59bf1e6b896c8d0fe1ab788c14d964d.jpg"
    }
}