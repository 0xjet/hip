{
    "id": "c3daeb83-a701-40f0-b007-7bf6b85602a2",
    "created_at": "2022-10-25T16:48:12.078435Z",
    "updated_at": "2025-03-27T02:06:10.633912Z",
    "deleted_at": null,
    "sha1_hash": "d2e17e228e02df878f807b112f78afdc13cc6bca",
    "title": "Analysis Of A Recent Plugx Variant - P2P Plugx",
    "authors": "JPCERT",
    "file_creation_date": "2015-01-30T13:41:29Z",
    "file_modification_date": "2015-01-30T13:41:29Z",
    "file_size": 87495,
    "plain_text": "This is Shusei Tomonaga at Analysis Center.\n\nPlugX, a Remote Access Tool (RAT) often seen in many APT cases, has been in the wild for some years.\n\nVarious sectors in Japan have been suffering from this type of attack from 2012, and Analysis Center has\n\nbeen working to catch up on the evolution of the PlugX family since then.\n\nIn this blog post, I will write about a recent PlugX variant which we first encountered in October 2014. The\n\nvariant has interesting new aspects and the most significant one, in my view, is the P2P function - so let\n\nme tentatively name it “P2P PlugX”.\n\n**Size Expansion of Configuration Information**\n\nPlugX is designed to run based on its configuration information stored in itself. Our analysis revealed that\n\nthe size of the configuration information has been expanded for the recent variant. While the former ones\n\nhave either 0x2540 bytes (Observed since August 2013) or 0x2d58 bytes (Observed since June 2014), the\n\nrecent one has 0x36a4 bytes, roughly 20% larger in size. This has led it to do more, such as:\n\n-  Communication with more C&C servers – up to 16\n\n-  P2P communication between infected nodes\n\n-  MAC address check - PlugX runs if the MAC address of an infected   host coincides with configuration\n\ninformation in itself (If not specified in the   configuration, PlugX runs on any host).\n\n-  (To bypass UAC) configurable setting for the process to abuse\n\nOther than these, new coding algorithm has been introduced.\n\nI will pick up some of the interesting features for more description. For details of the configuration file,\n\nyou can refer to Appendix A in the bottom of this post.\n\n**Additional Communication Protocol for C&C Servers**\n\nFormer versions of PlugX used to set four C&C Server addresses to communicate with. With the P2P\n\nPlugX, attackers can set up to 16 C&C servers. Communication protocol with C&C servers has also been\n\nimproved.\n\nFormer PlugX could only configure four communication protocols, but for P2P PlugX, protocol number\n\n255 became available. This protocol is reserved by IANA, but no specific application is assigned.\n\n\n-----\n\n|Configuration No.|Protocol Number (In IP header)|Data Format|\n|---|---|---|\n|1|6 (TCP)|Binary|\n|2|6 (TCP)|HTTP|\n|3|17 (UDP)|DNS|\n|4|1 (ICMP)|Binary|\n|5|255|Binary|\n\n\n**P2P Function Enabled**\n\nP2P PlugX can communicate with other similarly-infected hosts. When one PlugX succeeds to infect a\n\nhost, it then accesses to every IP address in the local network one-by-one and communicate with any\n\nconnectable nodes, using one of the following protocols listed in Table 2.\n\nTable 2: Configurations and Communication Protocols which\n\nP2P PlugX uses to communicate by P2P\n\n**Protocol Number**\n**Configuration No.** **Data Format**\n\n**(In IP header)**\n\n1 6 (TCP) Binary\n\n2 17 (UDP) DNS\n\n3 1 (ICMP) Binary\n\n4 255 Binary\n\nWith P2P protocol, even if a PlugX exists in an environment with no direct access to the Internet, it may\n\ncommunicate with C&C server through other infected hosts. We have also seen some P2P-disabled\n\nsamples.\n\nNote that this P2P communication theoretically can be applied to any other TCP/UDP ports. But in cases\n\nwhich JPCERT/CC haｓ observed, P2P PlugX only uses either TCP/1357 or UDP/1357 for P2P\n\ncommunication. If you see any scanning activity to TCP/1357 or UDP/1357, we highly recommend that\n\nyou conduct further investigation.\n\n**New Encoding Algorithm**\n\nPlugX uses a single encoding algorithm for inbound/outbound data, configuration, key logging data and\n\nstrings used internally. Its encoding method has been modified from time to time, aligned with major\n\nupgrade of PlugX itself.\n\nLikewise, P2P PlugX has a new encoding algorithm. Here’s a python code to decode.\n\n|Configuration No.|Protocol Number (In IP header)|Data Format|\n|---|---|---|\n|1|6 (TCP)|Binary|\n|2|17 (UDP)|DNS|\n|3|1 (ICMP)|Binary|\n|4|255|Binary|\n\n\n-----\n\ndecode_key struct.unpack_from( <I, data, 0)[0]\n\nout = ''\n\n# XOR Values might possibly be varied.\n\nkey1 = decode_key ^ 20140918\n\nkey2 = decode_key ^ 353\n\nfor c in data[4:]:\n\n# ADD/SUB Values might possibly be varied.\n\nkey1 += 3373\n\nkey2 -= 39779\n\ndec = int(c) ^ (((key2 >> 16) & 0xff ^ ((key2 & 0xff ^ (((key1 >> 16)\n\n& 0xff ^ (key1 - (key1 >> 8) & 0xff)) - (key1 >> 24) & 0xff)) - (key2 >> 8) &\n\n0xff)) - (key2 >> 24) & 0xff)\n\nout = out + chr(dec)\n\nreturn out\n\n**What’s Next?**\n\nP2P PlugX introduced several new features which surely made attackers to manage their attack\n\ninfrastructure efficiently. We are sure that PlugX will keep evolving, and continuous analysis will be\n\nnecessary for preventing/mitigating possible incident. We will keep you updated on any new findings.\n\nThank you very much for reading.\n\n_- Shusei Tomonaga_\n\n(For any inquiry or incident report regarding PlugX, please contact info[at]jpcert.or.jp)\n\n**Appendix A: Entire Configuration of P2P PlugX**\n\nTable 3: Entire Configuration of P2P PlugX\n**Offset** **Length** **Description**\n\n0x0000 20 Not used\n\n0x0014 4 Flag if remove own DLL from list of modules\n\n0x0018 4 Flag enable/disable key logger\n\n0x001c 12 Not used\n\n|Offset|Length|Description|\n|---|---|---|\n|0x0000|20|Not used|\n|0x0014|4|Flag if remove own DLL from list of modules|\n|0x0018|4|Flag enable/disable key logger|\n\n\n-----\n\n|0x002c|4|Duration of suspend activity|\n|---|---|---|\n|0x0030|672|Network Access Flag (for a week with 15min interval)|\n|0x02d0|4 * 4|DNS Server IP Address x 4|\n|0x02e0|68 * 16|control Server Information x 16|\n|0x0720|128 * 16|HTTP Access URL x 16|\n|0x0f20|196 * 4|Proxy/authentication config x 4|\n|0x1230|4|Method to make it resident (e.g. Create Service. Create Run Key)|\n|0x1234|512|Folder to Install|\n|0x1434|512|Service Name|\n|0x1634|512|Service Display Name|\n|0x1834|512|Service Description|\n|0x1a34|4|Registry Root Key Value for Run Registry Key Configuration|\n|0x1a38|512|Run Registry Key Name|\n|0x1c38|512|Run Registry Key Value|\n|0x1e38|4|Enable/Disable Code injection|\n|0x1e3c|512 * 4|Program Name for Code Injection x 4|\n|0x263c|4|Enable/Disable Code injection for UAC Bypass|\n|0x2640|512 * 4|Program Name to inject code for UAC Bypass x 4|\n|0x2e40|512|Authentication Character String for PlugX|\n|0x3040|512|Authentication Character String for C&C Server|\n|0x3240|512|Mutex Name|\n|0x3440|4|Enable/Disable Screen Capture|\n|0x3444|4 * 5|Screen Capture Configuration Value|\n|0x3458|528|Folder to Store Screen Captures|\n|0x3658|4|Enable/Disable P2P(TCP)|\n|0x365c|4|P2P(TCP) Port Number|\n|0x3660|4|Enable/Disable P2P(UDP)|\n|0x3664|4|P2P(UDP) Port Number|\n|0x3668|4|Enable/Disable P2P(ICMP)|\n|0x366c|4|P2P(ICMP) Port Number|\n|0x3670|4|Enable/Disable P2P(IP Protocol Number 255)|\n|0x3674|4|P2P(IP Protocol Number 255) Port Number|\n|0x3678|4|Enable/Disable P2P Scanning|\n|0x367c|4 * 4|P2P Scanning Beginning Address x 4|\n|0x368c|4 * 4|P2P Scanning End Address x 4|\n|0x369c|6|Run program if this MAC Address is used|\n|0x36a2|2|Not used|\n\n\n**Appendix B: SHA-256 hash value of P2P PlugX**\n\n\n-----\n\n93c85a8dd0becc4e396eea2dc15c0010ff58d2b873d44fd7e45711a27cfe613b\n\n0ff134057a8b2e31b148fedfdd185f5b1a512149499a8c5c0915cf10b10a613e\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/outg1oalwwfvd86eopmgv2pskekzmr4t",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2015/2015.01.29.P2P_PlugX/P2P_PlugX_Analysis.pdf"
    ],
    "report_names": [
        "P2P_PlugX_Analysis"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716492,
    "ts_updated_at": 1743041170,
    "ts_creation_date": 1422625289,
    "ts_modification_date": 1422625289,
    "files": {
        "pdf": "https://archive.orkl.eu/d2e17e228e02df878f807b112f78afdc13cc6bca.pdf",
        "text": "https://archive.orkl.eu/d2e17e228e02df878f807b112f78afdc13cc6bca.txt",
        "img": "https://archive.orkl.eu/d2e17e228e02df878f807b112f78afdc13cc6bca.jpg"
    }
}