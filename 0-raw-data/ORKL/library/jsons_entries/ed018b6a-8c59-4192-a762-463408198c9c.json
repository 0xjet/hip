{
    "id": "ed018b6a-8c59-4192-a762-463408198c9c",
    "created_at": "2023-01-12T15:10:20.535658Z",
    "updated_at": "2025-03-27T02:13:34.688585Z",
    "deleted_at": null,
    "sha1_hash": "557e3d59ea05c3a23ecbcabf22e272ad6e16ebc7",
    "title": "2022-01-12 - NightSky Ransomware – just a Rook RW fork in VMProtect suit",
    "authors": "",
    "file_creation_date": "2022-05-29T01:16:02Z",
    "file_modification_date": "2022-05-29T01:16:02Z",
    "file_size": 1414568,
    "plain_text": "# NightSky Ransomware – just a Rook RW fork in VMProtect suit\n\n**github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/NightSky_Ransomware–**\njust_a_Rook_RW_fork_in_VMProtect_suit/NightSky_Ransomware–just_a_Rook_RW_fork_in_VMProtect_suit.md\n\nDump-GUY\n\nThe main subject of this analysis is to explain Cryptographic functions used in\nNightSky and Rook ransomwares and compare their similarities and\ndifferences. This is not just some kind of show-off report but the main purpose\nof this, is to share some knowledge, ideas, work-flow and problems which\ncould occur during this kind of research.\n\nBefore we jump in, both of these ransomwares are using the same version of\nstatically linked OpenSource library Mbed TLS (2.23.0 – 2.24.0) to implement\nCrypto functions. Because of minor changes in Mbed TLS between versions\n2.23.0 and 2.24.0 (ransomware code is not affected by these changes), there is\nno way to specify which one of these version was used, but more important is\nthat both ransomwares are using the same version of Mbed TLS.\n\nFinding out the exact version was a pitty work, involving compilation of different\nversion of Mbed TLS (last 20 versions) with exact same version of Visual\nStudio (2015) and same version of compiler tools (19.00.24245 – obtained from\nRook RW). Because of shredded Rich Header in NightSky ransomware\n\n\n-----\n\n(caused by used VMProtect), we can only presume that both of these RW were\nbuilt with compiler tools 19.00.????? probably Visual Studio 2015 but not\nnecessary. In the Rook case, we also know the exact version of compiler tools\n(19.00.24245) – Rich Header presented.\n\nReal hard work started with many attempts to find the correct C\\C++ compiler\nand linker configuration which was used in both of these ransomwares\n(involving reversing of Mbed TLS functions in ransomwares and produced .dll\nand .obj (in .lib file) files). Fortunately, and not surprising, the best configuration\nwas the same for both of these ransomwares. Built .lib files served for\ngenerating FLIRT signatures and .dll files with pdb symbols were used for fuzzy\nmatching with Rizzo signatures, fingermatch signatures, diaphora... Big\ndifferences between matched functions, using different versions of Mbed TLS,\nlet to exact version of Mbed TLS (2.23.0 – 2.24.0) which was used in both\ncases. These facts could be just an interesting coincidence but after I introduce\nthe code similarity it will be obvious that NightSky Ransomware is just a fork of\nRook and there is possibility that same TA is behind the creation of these\nRansomwares. (another possibility is leaked src code etc..).\n\n## NightSky RW vs Rook RW brief crypto summary\n\n Let´s do some reversing\n\n\n-----\n\nAfter this brief introduction we can jump to the main function of these\nransomwares. We can see main function of Rook and NighSky RW in the\npicture below. NightSky omitted some functionality of Rook (processing cmdline\narguments, debug mode…) and some were just moved to different functions\nbut code similarity related to multi-threading and synchronization remains.\n\nOne of the first function in “main” in both of these ransomwares “setPRNG_generate_VictimRSAKeys_encryptVictimPrivateKEY” is responsible\nfor generating Victim RSA2048 key pair where Victim RSA2048 private KEY is\nencrypted by TAs embedded RSA2048 public key. The encryption of victim\nRSA private key is performed in loop of 200 bytes as you can see in the picture\nbelow. Again the similarity of code is obvious.\n\nWe can move on to function which is start routine of newly spawned threads.\nThis NightSky routine is handled by literally copy-paste code from Rook RW\nand serves as synchronization which leads to function responsible for file\nencryption “encrypt_file”.\n\n\n-----\n\nIn “encrypt_file” function code below we can see that both of these\nransomwares are using Mbed TLS random module to generate for each file\nunique 16 bytes random AES key. This AES key is later used but also gets\nencrypted by previously generated victim RSA2048 public key and saved to\nstructure which will be later part of encrypted file footer.\n\nUsage of the randomly generated AES key is different in NightSky and Rook\nransomware. Rook ransomware encryption is a combination of AES128 ECB\nmode with intermitten encryption -> looping 32 bytes chunks where only first 16\nis encrypted. Max encrypted size is 524288*3.\n\nNightSky ransomware encryption is AES128 CBC mode with hardcoded IV\nwhere max encrypted size is the same as in Rook case - 524288*3.\n\n\n-----\n\nYou can see NightSky AES128 CBC mode with hardcoded IV below.\n\nOur final stage of analysis is comparing of encrypted file structure.\n\nRook Ransomware encrypted file structure (only something I named\nQuadpart_presented tag is in addition to NightSky – this tag has no meaning\nand because of that was probably omitted):\n\n\n-----\n\nNightSky Ransomware encrypted file structure:\n\n## Conclusion:\n\nAs we could see, the similarity between Rook and NightSky ransomware looks\nsometimes like copy-paste of code.\n\nWhat could be quite tricky thing for analysts is that NightSky is delivered as\nVMProtected and with combination of statically linked Mbed TLS crypto library\nit could be let´s say “unpleasant”.\n\nSome functionality from Rook Ransomware (not part of crypto process) is not\npresented in code of NightSky. Only one difference in encryption is that\nNightSky RW replaced intermitten AES-ECB encryption for more secured AESCBC.\n\n## Recommendation:\n\n\n-----\n\nIf possible always try to perform decryption on your own (spoofing public key,\ngrabbing session keys, hooking etc…) to confirm your analytical assumptions.\n\nIf you were able to read it to this part, you can also check my steps without\ncorrection [[HERE]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/NightSky_Ransomware%E2%80%93just_a_Rook_RW_fork_in_VMProtect_suit/TrueStory_notes.txt)\n\n## Download:\n\nUnpacked, repaired and debuggable sample of NightSky RW is available\n\n[[HERE-pass:infected]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/NightSky_Ransomware%E2%80%93just_a_Rook_RW_fork_in_VMProtect_suit/files/Repaired_debuggable_NightSkyRW.7z)\n\nGenerated FLIRT, Rizzo and Fingermatch signatures for Mbed TLS 2.24.0\n\n[[HERE]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/tree/main/NightSky_Ransomware%E2%80%93just_a_Rook_RW_fork_in_VMProtect_suit/files/Signatures_MbedTLS2.24)\n\n## IOCs:\n\nNightSky Ransomware MD5: 9608c8b6c8d80fdc67b99edd3c53d3d2\nRook Ransomware MD5: 6d87be9212a1a0e92e58e1ed94c589f9\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-12 - NightSky Ransomware – just a Rook RW fork in VMProtect suit.pdf"
    ],
    "report_names": [
        "2022-01-12 - NightSky Ransomware – just a Rook RW fork in VMProtect suit.pdf"
    ],
    "threat_actors": [
        {
            "id": "08c8f238-1df5-4e75-b4d8-276ebead502d",
            "created_at": "2023-01-06T13:46:39.344081Z",
            "updated_at": "2025-03-27T02:00:03.056208Z",
            "deleted_at": null,
            "main_name": "Copy-Paste",
            "aliases": [],
            "source_name": "MISPGALAXY:Copy-Paste",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536220,
    "ts_updated_at": 1743041614,
    "ts_creation_date": 1653786962,
    "ts_modification_date": 1653786962,
    "files": {
        "pdf": "https://archive.orkl.eu/557e3d59ea05c3a23ecbcabf22e272ad6e16ebc7.pdf",
        "text": "https://archive.orkl.eu/557e3d59ea05c3a23ecbcabf22e272ad6e16ebc7.txt",
        "img": "https://archive.orkl.eu/557e3d59ea05c3a23ecbcabf22e272ad6e16ebc7.jpg"
    }
}