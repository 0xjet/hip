{
    "id": "bfb365a1-2fda-4a6e-8c73-609ee410daa8",
    "created_at": "2023-01-12T15:06:17.79797Z",
    "updated_at": "2025-03-27T02:05:29.155623Z",
    "deleted_at": null,
    "sha1_hash": "17d3823407e53b32462a37e3f5ab156075d5a2c4",
    "title": "2016-07-01 - KeyBase - A New Keylogger on the Block",
    "authors": "",
    "file_creation_date": "2022-11-21T22:05:29Z",
    "file_modification_date": "2022-11-21T22:05:29Z",
    "file_size": 9568762,
    "plain_text": "### claroty.com /team82/research/an-oil-and-gas-weak-spot-flow-computers\n\n# An Oil and Gas Weak Spot: Flow Computers\n\n## Executive Summary\n\nFlow computers calculate oil and gas volume and flow rates; these measurements are critical not only to\n\nprocess safety, but are also used as inputs in other areas, including billing.\n\nTeam82 is disclosing details on a path-traversal vulnerability in ABB TotalFlow flow computers and controllers.\n\nAn attacker could exploit a vulnerable system to inject and execute arbitrary code.\n\n[CVE-2022-0902 (CVSS v3: 8.1) was addressed in a firmware update.](https://claroty.com/team82/disclosure-dashboard/cve-2022-0902)\n\nAffected products include:\n\nABB’s RMC-100 (Standard)\n\nRMC-100-LITE\n\nXIO\n\nXFCG5\n\nXRCG5\n\nuFLOG5\n\nUDC products.\n\n[ABB’s security advisory can be found here.](https://library.e.abb.com/public/b17396142a3d4d14ae29e351ccc974ec/Cyber%20Security%20Advisory%20CVE-2022-0902%20-%20Path%20Traversal%20Vulnerability%20in%20Totalflow%20TCP%20protocol.pdf)\n\n## Introduction\n\nFlow computers are specialized computers that calculate volume and flow rates for oil and gas that are critical to\nelectric power manufacturing and distribution. These machines take liquid or gas measurements that are not only vital\n\nto process safety, but are also used as inputs by other processes—alarms, logs, configurations—and therefore\nrequire accuracy to ensure reliability. These capabilities are described in the American Gas Association’s AGA Report\n\nNo. 9.\n\nOne other important aspect to the role of flow computers within a utility is billing. The most noteworthy and related\n\n[security incident was the ransomware attack against Colonial Pipeline, which impacted enterprise systems, and](https://claroty.com/blog/lessons-from-the-colonial-pipeline-attack)\nforced the company to shut down production because it could not bill customers. Disrupting the operation of flow\n\ncomputers is a subtle attack vector that could similarly impact not only IT, but also OT systems; this led us to research\nthe security of these machines.\n\nTeam82 focused on ABB flow computers because of their use within many large oil and gas utilities worldwide. We\nlooked for vulnerabilities that could give an attacker the ability to influence measurements by remotely running code\n\nof their choice on the device.\n\n\n-----\n\ns a esu t, ea 8 ou d a g se e ty pat t a e sa u e ab ty (C 0 090 ) s ota o o\n\nComputers and Remote Controllers. Attackers can exploit this flaw to gain root access on an ABB flow computer,\nread and write files, and remotely execute code.\n\nABB has made a firmware update available that resolves the vulnerability in a number of product versions; it also\nrecommends network segmentation as a mitigation. More information, including affected product versions, is found in\n\n[ABB’s advisory.](https://library.e.abb.com/public/b17396142a3d4d14ae29e351ccc974ec/Cyber%20Security%20Advisory%20CVE-2022-0902%20-%20Path%20Traversal%20Vulnerability%20in%20Totalflow%20TCP%20protocol.pdf)\n\n## How Flow Computers Work\n\nFlow measurement computations, especially gas flow, demand a substantial amount of processing power and thus\n\nare often calculated by a low-power CPU rather than a microcontroller.\n\nExamples of different flow computers.\n\n\n-----\n\nFlow meters read raw data from attached sensors that measure the volume of a substance in a number of ways,\n\ndepending on what’s being measured (gas or a liquid). Different examples of flow meters include: electromagnetic,\nvortex, differential pressure, thermal, coriolis, and others.\n\nExamples of different types of flow meters (Source: ABB)\n\nThe following diagram describes how a flow computer usually measures gas flow:\n\n\n-----\n\nThree types of sensors are used to calculate gas flow using a differential pressure technique: absolute pressure\n\ntransmitters, differential pressure transmitters, and absolute temperature transmitters. Raw data is sent to the flow\ncomputer, which measures gas flow.\n\n## Researching ABB’s µFLO G5 Flow Computer\n\n[The target of our research was ABB’s µFLO G5 flow computers. This device can receive raw sensor data from other](https://library.e.abb.com/public/c2799eebc2a9475583abf752731c0f09/DS_2102800-EN_C.pdf)\n\n[flow meters, perform flow calculations (following the AGA and ISO standards) and show/propagate the output.](https://www.aga.org/research/reports/orifice-metering-of-natural-gas-and-other-related-hydrocarbon-fluids/)\n\nµFLOG5 in its enclosure. (Source: ABB)\n\n\n-----\n\ne µ O G5 s a s g e boa d co pute t O po ts ( t e et, US,etc ), C U, a d ot e pe p e a s e C U s\n\nan ARMv8 processor, which is a 32-bit architecture. The device runs Linux as an operating system, which was good\nnews for us, because this increased our chances to emulate the device in the lab.\n\nFrom a security perspective, the µFLO G5 features three main mechanisms:\n\n1. Security switch: A physical switch attached to the board that will enable/disable the use of the security\n\npasscode.\n\n2. Security passcode: Two four-digit passcodes; one for reading data, and another authorizing writing of data.\n\n3. RBAC: Role-based access control which assigns roles and permission to read and write specific attributes; this\n\noption is implemented only on the client side.\n\n**Client Application**\n\nThe flow computer can be remotely configured with a designated configuration program, below.\n\nInterface of ABB’s PCCU Client showing measurement data.\n\nThe interesting thing to note is that configuration is done via a proprietary protocol designed by the ABB called\n\nTotalFlow. This protocol can be used on top of a serial or Ethernet (TCP) connection. Most of the communication\nbetween the client and the device—retrieval of the gas flow calculations, set and get device settings, import and\n\nexport of the configuration files—is done over the TotalFlow protocol (TCP/9999).\n\nOur goal in this research is to achieve remote code execution on the device. The proprietary protocol seemed to be a\n\ngood attack vector to start with because undocumented protocols are usually less reviewed by security researchers.\n\n**Understanding ABB’s TotalFlow Protocol**\n\nAs we began our examination of the proprietary TotalFlow protocol, we knew two things: TotalFlow is 1) used to\nconfigure the device and send the flow measurements to the client, and 2), it listens on TCP port 9999.\n\nOur goal is to be able to send and receive messages of our choice to test the implementation of the protocol. For this,\nwe need to understand the protocol structure and build a simple client that constructs the payload. Luckily for us, the\n\nfirmware is available online and is not encrypted, therefore we could easily extract it in order to analyze the\napplication.\n\nFirst, we wanted to find the binary that implements the protocol. Often the implementation of the protocol will reside at\nthe main executable file or one that is directly linked to it.\n\nBecause our target is a Linux-based embedded device, the main binary will be executed at system’s init. The good\nplace to search for this is the init.d/inittab:\n\n\n-----\n\ninittab content.\n\nThe init revealed the name of the binary: devLoader.exe (exe is a probably legacy name from when the device ran on\nWindows CE), which allowed us to reverse engineer it. The binaries within the firmware were stripped, but we had a\n\nlot of error-related logging strings, below, which was great for our research because it makes our life easier in finding\ninteresting functions.\n\nA sample of error strings found within TotalFlow binaries.\n\nThere are few techniques we can start with to search for the relevant code for incoming packet handling.\n\n1. Look for matching strings from the client application and the firmware, below:\n\nSince there was a lot of memory initialization, it was likely we had found a constructor, which gave us a place to start.\n\n1. Another good place is CRC checks. Embedded devices, especially ones that receive data from serial ports, use\n\na CRC checksum to validate the accuracy of the received payload. Finding the place where CRC checks are\nvalidated is interesting because this will point to the payload that was received from the client. CRC checksum\n\noften uses hardcoded lookup tables which are easy to find within the binary.\n\n2. Last but not least are the error strings; if you are fortunate, you will be able to find the relevant code just by\n\nlooking at those. Sadly, in this case, we weren’t so fortunate.\n\nNow that we have a basic understanding of what we need to look for and where to find it, our next step is to create a\n\nsetup of the device so we can dynamically debug it.\n\n**Emulating a Flow Computer on RaspberryPI**\n\nAlthough quite often we purchase devices we research, this time it was not an option. When the application of interest\n\nis within the user space and the device runs a familiar operating system on familiar architecture, it is often possible to\n\n\n-----\n\ne u ate t e e e a t pa t\n\nTherefore, we took one of our Raspberry Pis, copied the firmware’s file system to it, and chrooted the directory.\n\nTeam82 used a Raspberry Pi to load ABB firmware and emulate a flow computer\n\nThe main disadvantage of emulating the device is that at some point the application will want to communicate with\nperipherals. Unfortunately, our Raspberry Pi doesn’t have orifice plates attached to it, so any communication with\n\nthem needs to be patched (changed within the binary).\n\nThe procedure to patch the application is straightforward:\n\n1. Run the binary\n\n2. Wait for the binary to crash (due to emulation/setup issues)\n\n3. Patch the function that causes the problem (e.g. skip a check)\n\n4. Back to Step No. 1\n\nIn this research, seven functions were patched across two binaries; these functions communicate with the sensors\nand other hardware peripherals, which obviously do not exist in our simulated Raspberry Pi environment. Four hours\n\nlater, we were good to go to the next step.\n\n**Debugging the TotalFlow Protocol**\n\nNow that we have a working setup, we were ready to analyze communication between the device and the client\n\napplication. With a debugger, we can stop at the interesting functions that we have found by reverse engineering the\nbinary and completing our understanding of the protocol.\n\nWe downloaded the client application (PCCU) from the ABB website and installed it on a Windows machine. We\nconnected the application to the flow computer by providing the IP address of the Raspberry Pi:\n\n\n-----\n\nThe user interface for ABB’s client application, PCCU.\n\nA packet sent from client to device when first connected.\n\nTotalFlow is a relatively simple protocol: Every setting within the device has its own TAG that is defined by a tuple\ncalled Registers (APP, ARRAY, INDEX).\n\nFor example, in the image below we see that the “SSH Service” setting is accessible by the (0.7.27) Register.\n\nA sample of network settings from the PCCU client application.\n\nThe RegisterGet and RegisterSet functions, below, are responsible for changing/returning the Register’s value:\n\nThe following is the payload that will enable SSH - as we set the triple tuple of the SSH settings to be enabled - app:\n0 array: 07 index: 0x1b (27).\n\n\n-----\n\nNow that we understood the protocol structure, we could write a simple python client with interesting functionalities\n\nsuch as read-write Registers, enable SSH, and more:\n\nIn order to do this, we need to be authenticated by providing the correct security code.\n\n**Authentication Bypass**\n\nNote the security code (the red rectangle) is a CRC-16 of the four-digit security passcode. Since the device sends an\n\nerror message on incorrect code and there is no rate limit mitigation available on the device, we can easily bypass\nthe authentication mechanism by enumerating all possibilities.\n\nCRC-16 is a two-byte value, which has a maximum of 2[16] possibilities. We can brute force all of the possible values\n\nin a range 0-65,535, which can take about four minutes. We can also optimize it by calculating, prior to the attack, the\nvalues from CRC-16 (0000) to CRC-16 (9999) and thus reducing the number of possibilities to 10,000.\n\n**Finding a Vulnerability**\n\nNow that we have an authentication bypass, it is time to look at functionalities available to authenticated users.\nRemember we said the configuration can be uploaded and downloaded? This is a good place to look for bugs\n\nbecause file operations are not always done securely.\n\nThis is what the file download procedure looks like in Wireshark:\n\n\n-----\n\nWe can see that the request contains a file name in the tfData directory. Lets check for a path traversal vulnerability\n\nby requesting the /etc/shadow file.\n\n/etc/shadow content\n\nNice. It works.\n\n**Remote Code Execution**\n\nNow that we have an arbitrary read and write, it is simple to get code execution.\n\n\n-----\n\ne c ose t e s p est app oac, ead g /etc/s ado a d us g as cat c ac g t e oot accou t pass o d ( c\n\nturned out to be root:root). Then we changed the SSH configuration file to enable root to connect using password.\nThen all that was left to do was to turn on the SSH daemon (using the TotalFlow protocol) and to connect to it.\n\n0:00 / 0:57\n\nTeam82's proof of concept in action.\n\n**The Vulnerability**\n\n[CVE-2022-0902](https://claroty.com/team82/disclosure-dashboard/cve-2022-0902)\n\n**CWE-22 Path Traversal Vulnerability**\n\n**Affected Products: ABB Flow Computers and Remote Controllers’ Totalflow TCP protocol**\n\n**CVSS v3 score: 8.1**\n\nThis path traversal vulnerability can enable an attacker to take over flow computers and remotely disrupt the flow\n\ncomputers’ ability to accurately measure oil and gas flow. These specialized computers calculate these\nmeasurements that are used as inputs in a number of functions, including configurations and customer billing.\n\n\n0:00 / 0:57\n\n\n-----\n\nsuccess u e p o t o t s ssue cou d pede a co pa y s ab ty to b custo e s, o c g a d s upt o o se ces,\n\nsimilar to the consequences suffered by Colonial Pipeline following its 2021 ransomware attack.\n\nTeam82 disclosed this vulnerability to ABB, which issued an update that addresses the issue. ABB also advises\n\nnetwork segmentation as a mitigation strategy; further information is available in ABB’s advisory.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/ICS SCADA/ICS Vulnerabilities/Claroty - An Oil and Gas Weak Spot Flow Computers.pdf"
    ],
    "report_names": [
        "Claroty - An Oil and Gas Weak Spot Flow Computers.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535977,
    "ts_updated_at": 1743041129,
    "ts_creation_date": 1669068329,
    "ts_modification_date": 1669068329,
    "files": {
        "pdf": "https://archive.orkl.eu/17d3823407e53b32462a37e3f5ab156075d5a2c4.pdf",
        "text": "https://archive.orkl.eu/17d3823407e53b32462a37e3f5ab156075d5a2c4.txt",
        "img": "https://archive.orkl.eu/17d3823407e53b32462a37e3f5ab156075d5a2c4.jpg"
    }
}