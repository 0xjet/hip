{
    "id": "cfb7f3b2-f5b2-4b41-a8a8-391cff4101c6",
    "created_at": "2023-01-12T15:10:44.161717Z",
    "updated_at": "2025-03-27T02:06:01.529604Z",
    "deleted_at": null,
    "sha1_hash": "52188e93377ff67b5c05e96657b2b3d448f17cfd",
    "title": "2017-11-08 - Overlay RAT Malware Uses AutoIt Scripting to Bypass Antivirus Detection",
    "authors": "",
    "file_creation_date": "2022-05-28T17:10:03Z",
    "file_modification_date": "2022-05-28T17:10:03Z",
    "file_size": 1167055,
    "plain_text": "# Overlay RAT Malware Uses AutoIt Scripting to Bypass Antivirus Detection\n\n**[securityintelligence.com/overlay-rat-malware-uses-autoit-scripting-to-bypass-antivirus-detection/](https://securityintelligence.com/overlay-rat-malware-uses-autoit-scripting-to-bypass-antivirus-detection/)**\n\nNovember 8, 2017\n\n[Home&nbsp/](https://securityintelligence.com/) [Malware](https://securityintelligence.com/category/x-force/malware-threat/)\nOverlay RAT Malware Uses AutoIt Scripting to Bypass Antivirus Detection\n\n\n-----\n\n[Malware November 8, 2017](https://securityintelligence.com/category/x-force/malware-threat/)\nBy [Gadi Ostrovsky co-authored by Limor Kessem 6 min read](https://securityintelligence.com/author/gadi-ostrovsky/)\nIBM X-Force Research follows the cybercrime arena across the globe to map the trends that\n[shape online crime in each region. Brazil is a thriving region for financial malware, where](https://securityintelligence.com/the-brazilian-malware-landscape-a-dime-a-dozen-and-going-strong/)\nmalicious developers create various malware types to target local users with identity theft\nand online banking fraud.\n\n[In the past year, we have observed the rise of malware, such as Client Maximus and similar](https://securityintelligence.com/client-maximus-new-remote-overlay-malware-highlights-rising-malcode-sophistication-in-brazil/)\ncodes, that uses remote access with overlay screens for bank fraud operations in Brazil.\nRecently, we detected a remote access Trojan (RAT) malware that uses the same overall\ntechnique, but with an added twist to its antivirus evasion method.\n\n[Read the white paper: Shifting the balance of power with cognitive fraud prevention](https://www-01.ibm.com/marketing/iwm/dre/signup?source=mrs-form-9451&S_PKG=ov54550)\n\n## A Delphi-Based RAT Pulling AutoIt Tricks\n\nMalware developers that target Brazilian banks are often concerned with evading antivirus\n[(AV) software. To evade detection, they commonly attempt to disable the running AV or find](https://securityintelligence.com/exposing-av-disabling-drivers-just-in-time-for-lunch/)\nanother workaround to avoid it.\n\nX-Force Research recently observed an overlay RAT malware using the AutoIt framework to\nbypass AV detection in attacks against Brazilian bank targets. The AutoIt framework is an\nopen source tool. It’s a BASIC-like scripting language designed to automate functions in the\nWindows user interface as well as general scripting tasks. AutoIt runs on all versions of\nWindows.\n\n\n-----\n\nWithin this context, the malware s developer uses AutoIt to prevent static AV detection from\nrecognizing the malware’s hash signature. To accomplish that, the malware’s developer\ncompiled the malicious code with an AutoIt script and runs it as a valid AutoIt framework\nprocess where the malicious payload is loaded into an AutoIt process memory address\nspace.\n\n_Figure 1: Valid AutoIt process running malicious AutoIt code, viewed in ProcessExplorer_\n\n_Figure 2: A hex view of the compiled AutoIt code_\n\nAfter its decompilation, the script executes a certain flow of events:\n\n1. The script loads a dynamic link library (DLL) from disk and decrypts it with a hardcoded\n\nkey implemented by the DESDecryptFile function.\n2. It then loads the DLL into memory using the dllFromMemory function.\n3. Finally, the script calls the DLL’s entry point via a DLLCALL function\n\n_Figure 3: The script’s execution flow_\n\n## The Decryption Process\n\nThe decryption of the DLL runs first. The encryption selected by the malware’s developer is\nbased on the Advanced Encryption Standard algorithm in Cipher Block Chaining mode\n(AES-CBC). It was implemented in AutoIt for use by this RAT malware.\n\n_Figure 4: The decryption function implements the AES-CBC algorithm (Source: IBM X-Force)_\n\n## Loading the DLL Into Memory\n\nThe DLL loading process happens in a few stages. The malware will use each stage to\nallocate memory space, protect it and then relocate it.\n\n### 1. Loading the Library\n\nTo begin, the malware loads the DLL in an operation that it executes by calling the\nLoadLibraryEx application program interface (API) with\nDON’T_RESOLVE_DLL_REFERENCES, indicating that the Windows kernel should not load\nDLL dependencies.\n\nDuring this process, the operating system loads the DLL into memory and adjusts code\nsections without resolving imports. This simplifies the operation of copying sections later.\n\n\n-----\n\n### 2. Memory Allocation\n\nTo allocate memory space, the malware calls the VirtualAlloc API with a PAGE_READWRITE\nflag to enable read-only or read/write access to the committed region of pages. Additionally,\nmemory allocation flags MEM_RESERVE and MEM_COMMIT are required to reserve virtual\nmemory pages.\n\n### 3. Copy Sections\n\nOnce memory has been reserved, the file’s contents can be copied to the system.\n\n### 4. Protect Memory\n\nAt this point, the code section tasked with running the code must be allowed to execute it. To\ndo this, the malware’s developer calls the VirtualProtect API with\nPAGE_EXECUTE_READWRITE rights. This API changes the protection on a region of\ncommitted pages in the virtual address space of the calling process, which means it can\ncontrol whether an application is allowed to access the memory. In this case, the malware\naims to hide its malicious code.\n\n### 5. Base Relocation\n\nSince all memory addresses in the code/data sections of a library are stored in locations\nrelative to the base address defined by ImageBase in the OptionalHeader, a conflict arises if\nthe library can’t be imported to a given memory address. This means the references must all\nbe [adjusted or relocated. To modify the list accordingly, this malware uses the FixReloc](https://blogs.msdn.microsoft.com/oldnewthing/20170119-00/?p=95215)\nfunction, followed by some defining parameters.\n\n_Figure 5: Using the FixReloc function to relocate addresses in memory_\n\n### 6. Resolving the Imports Table\n\nThe malware’s file further contains a list of functions it will need to import for each DLL.\nBecause function addresses are not static, new location values are needed for each\naddress. These can be deduced by loading all the DLLs that were not yet loaded into\nmemory and mapping them into the process address space.\n\nTo fix the import address table, the malware uses the FixImports function, as shows in the\nimage below.\n\n_Figure 6: Using the FixImports function to calibrate the import address table_\n\n### 7. Notifying the Library\n\n\n-----\n\nTo finalize loading the malware s DLL into the virtual address space, the developer calls\nDllMain as an entry point.\n\n### 8. Freeing Up the Library and Wiping Traces\n\nAt the end of this routine, the malware releases the DLL that was loaded to memory during\nthe first stage, calling the [FreeLibrary API. This frees the loaded DLL module and, if](https://msdn.microsoft.com/en-us/library/windows/desktop/ms683152%28v=vs.85%29.aspx)\nnecessary, decrements its reference count, a step taken by the malware’s developer to wipe\ntraces of the malicious code.\n\nTo hide its internal strings, the malware uses a primitive asymmetric algorithm and a\nhardcoded key to decrypt it, which makes it easier for researchers to break once that key is\nlocated.\n\n_[Figure 7: Implementation of the decryption algorithm as viewed in the IDA-Pro tool](https://www.hex-rays.com/products/ida/index.shtml)_\n\nThe RAT code itself is written in Delphi, which is a programming language that has become\nsynonymous with malicious codes written in Brazil. It is packed with an Ultimate Packer for\nExecutables (UPX) obfuscator.\n\n## Overlay RAT Malware: Still the Preferred Attack in Brazil\n\nAfter running the malware in our labs, we recreated the attack flow and discovered that it is\nyet another remote overlay malware designed to target online banking users in Brazil. XForce Research does not see many classic banking Trojans operating in Brazil. If any such\nTrojans are operating in the region, they are entirely Zeus-based with a local twist, such as\nZeus Panda. It’s worth noting that Zeus Panda has not been active in Brazil since it was\n[discovered in August 2016. Most cybercriminals attacking Brazilian banking customers stick](https://securityintelligence.com/panda-is-one-hungry-bear-a-heavyweight-banking-trojan-rolls-into-brazil/)\nwith RATs. As long as those types of attacks continue to serve them, threat actors are\nunlikely to see a need for change.\n\nOverlay RAT malware has a typical flow of events on user endpoints. After its deployment, it\nmonitors the user’s browser activity by checking the browser window’s title for bank names. If\na targeted tab is found, the malware launches two elements:\n\nA full-screen image or webpage to block the victim from the real bank’s page; and\nA RAT to take control of the victim’s endpoint and the banking session he or she may\nhave already authenticated.\n\n[The malware’s operator remotely initiates a fraudulent transaction from the victim’s endpoint](https://www.ibm.com/security/fraud-protection/)\nand may prompt the user to provide additional details by using the fake overlay screen.\n\n\n-----\n\nThis is only the latest of many similar codes that have long plagued Brazilian users. Like\nothers of its kind, such as Malfies and Dybuk, one of this RAT’s goals is to evade antivirus\ndetection and go unnoticed until the user is under its operator’s control.\n\nIBM X-Force analyzed the following samples for this research.\n\nMD5: EFB42A37102E377F030E98ADA65420EF (RAT)\nMD5: 8CF2318A99C3157E11645226F1626235 (AutoIt compiled script)\nMD5: B06E67F9767E5023892D9698703AD098 (AutoIt framework)\n\n[Read the white paper: Shifting the balance of power with cognitive fraud prevention](https://www-01.ibm.com/marketing/iwm/dre/signup?source=mrs-form-9451&S_PKG=ov54550)\n\n[Gadi Ostrovsky](https://securityintelligence.com/author/gadi-ostrovsky/)\nMalware Researcher, IBM\n\nGadi Ostrovsky is one of the top security researchers at IBM Security’s Trusteer group. He\njoined the company in 2014, coming from a deep technical backgro...\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-11-08 - Overlay RAT Malware Uses AutoIt Scripting to Bypass Antivirus Detection.pdf"
    ],
    "report_names": [
        "2017-11-08 - Overlay RAT Malware Uses AutoIt Scripting to Bypass Antivirus Detection.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536244,
    "ts_updated_at": 1743041161,
    "ts_creation_date": 1653757803,
    "ts_modification_date": 1653757803,
    "files": {
        "pdf": "https://archive.orkl.eu/52188e93377ff67b5c05e96657b2b3d448f17cfd.pdf",
        "text": "https://archive.orkl.eu/52188e93377ff67b5c05e96657b2b3d448f17cfd.txt",
        "img": "https://archive.orkl.eu/52188e93377ff67b5c05e96657b2b3d448f17cfd.jpg"
    }
}