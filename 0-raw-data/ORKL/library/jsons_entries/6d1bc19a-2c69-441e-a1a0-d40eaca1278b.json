{
    "id": "6d1bc19a-2c69-441e-a1a0-d40eaca1278b",
    "created_at": "2023-01-12T15:05:34.032446Z",
    "updated_at": "2025-03-27T02:09:18.008912Z",
    "deleted_at": null,
    "sha1_hash": "acda27ee4b21b4ac4114be180acadad106102036",
    "title": "2021-12-13 - Return of Emotet- Malware Analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T19:11:50Z",
    "file_modification_date": "2022-05-28T19:11:50Z",
    "file_size": 642038,
    "plain_text": "# Return of Emotet: Malware Analysis\n\n**zscaler.com/blogs/security-research/return-emotet-malware-analysis**\n\n**Key Points**\n\nEmotet is a downloader malware used to download and execute additional modules and payloads.\nIn January 2021, a law enforcement action disrupted the malware, its infrastructure, and some of its threat actors.\nAfter almost a year-long hiatus, Emotet returned to the threat landscape in November 2021.\nEmotet modules focus on credential theft, email theft, and spamming.\nSecondary Emotet payloads have reportedly been Cobalt Strike.\n\n[Threatlabz has continued its analysis of the return of the prolific Emotet malware. In January 2021, a law enforcement action disrupted the](https://www.zscaler.com/blogs/security-research/return-emotet-malware)\nEmotet malware and its infrastructure. This included the arrest of some of the threat actors involved with Emotet. Emotet has returned to the\nthreat landscape as of November 14, 2021 and picked up where it left off after almost a year-long hiatus.\n\n[This blog is a follow up to our November 16, 2021 “Return of Emotet malware” post and focuses on the technical aspects of the new version](https://www.zscaler.com/blogs/security-research/return-emotet-malware)\nof the Emotet malware.\n\n**Anti-Analysis Techniques**\n\nTo make malware analysis and reverse engineering more difficult, Emotet uses a number of anti-analysis techniques. One of the first ones\nthat stands out is control flow flattening where the structure of the program’s control flow is removed, making it difficult to trace its execution.\nFigure 1 shows an example function where a randomized “control_flow_state” variable is used along with various while loops, if-else, switch,\nand other statements to confuse the analysis:\n\n\n-----\n\n_Figure 1: Example function using control flow flattening_\n\nAnother technique that stands out is Windows API function call hashing with randomized function argument ordering. The Open Analysis\nHashDB IDA Plugin supports Emotet’s hashing algorithm which helps defeat this anti-analysis mechanism.\n\nEmotet encrypts all its important strings using an XOR-based algorithm and a per-string key. Figure 2 is an example IDA Python function that\ncan be used to decrypt strings:\n\n\n-----\n\nimport struct\n\ndef decrypt_str(addr):\n\ntmp = get_bytes(addr, 8)\n\nxor_key = struct.unpack(\"I\", tmp[0:4])[0]\n\nenc_len = struct.unpack(\"I\", tmp[4:8])[0]\n\nstr_len = xor_key ^ enc_len\n\nplain_buf = b\"\"\n\nenc_buf = get_bytes(addr+8, str_len)\n\nnum_dwords = int(str_len / 4)\n\nfor i in range(num_dwords):\n\nenc_dword = struct.unpack(\"I\", enc_buf[i*4:i*4+4])[0]\n\nplain_dword = xor_key ^ enc_dword\n\nplain_buf += struct.pack(\"I\", plain_dword)\n\nremaining_bytes = str_len % 4\n\nif remaining_bytes:\n\nlast_enc_dword = struct.unpack(\"I\", enc_buf[-remaining_bytes:] + b\"\\x00\"*(4-remaining_bytes))[0]\n\nlast_plain_dword = xor_key ^ last_enc_dword\n\nplain_buf += struct.pack(\"I\", last_plain_dword)[:remaining_bytes]\n\nreturn plain_buf\n\n_Figure 2: IDA Python function to decrypt strings_\n\n**Configuration**\n\nUsing the same encryption algorithm as for strings, Emotet stores three encrypted configuration items:\n\nCommand and Control (C2) IP addresses, ports, and “use TLS” flags\nAn Elliptic Curve Diffie Hellman (ECDH) public key used in C2 communications\nAn Elliptic Curve Digital Signature Algorithm (ECDSA) public key used to verify responses from a C2\n\n**Command and Control**\n\nC2 communications is via HTTP requests. An example request looks like Figure 3:\n\n_Figure 3: Example C2 request_\n\nThe URI is randomly generated and data is encrypted in the Cookie header (a POST request is used for larger amounts of data). The Cookie\nheader contains a randomly generated key name and base64 encoded key value. Once decoded, the key value contains:\n\nA generated ECDH public key\nAES encrypted request data\nRandom bytes\n\nThe AES key used to encrypt request data is generated via the following method:\n\n[The generated ECDH private key and embedded ECDH public key are used with the BCryptSecretAgreement function to generate a](https://docs.microsoft.com/en-us/windows/win32/api/bcrypt/nf-bcrypt-bcryptsecretagreement)\nshared secret between the malware and C2\nTh AES k i d i d f th h d t i th BC tD i K f ti\n\n\n-----\n\na te t equest data, co a d data, a d espo se data use a bas c data e cod g to e code O s a d a ab e e gt data equest\ndata contains the following:\n\nCommand number\nCommand data SHA256 hash\nCommand data\n\nAs an example, a “command poll” (command number 1) contains the following command data:\n\nBot ID (computer name and volume serial number)\nHash of malware process path\nBuild date (e.g. 20211114)\nMalware version (e.g. 10000)\nEncoded Windows version and architecture\nMalware process session ID\nOptional module acknowledgement\n\nResponse data is encrypted similarly to requests and once decrypted, the data is verified using the embedded ECDSA public key. Once\nverified, the data contains a command number and optional arguments.\n\n**Commands**\n\nEmotet has three broad commands:\n\nRemove self\nNo operation / sleep\nProcess subcommand\n\nMost of the functionality is implemented in seven subcommands:\n\n**Subcommand** **Notes**\n\n1 Update self\n\n2 Load and execute Emotet module\n\n3 Download and execute an EXE\n\n4 Download and execute an EXE (as console user)\n\n5 Download and inject a DLL (DllRegisterServer export)\n\n6 Download and execute a DLL with regsvr32.exe\n\n7 Download and execute a DLL with rundll32.exe (Control_RunDLL export)\n\n[The core component of Emotet is a downloader used to download and execute additional modules and payloads (e.g. likely Cobalt Strike).](https://twitter.com/Max_Mal_/status/1467590775307386885)\n\n**Modules**\n\nModules are DLL executables but require data from the Emotet core component and the received C2 command to run:\n\nBot ID\nEmbedded elliptic curve public keys\nModule ID (from C2 command)\nModule hash (from C2 command)\nModule argument (from C2 command)\n\nThey use the same set of anti-analysis features as the core component and contain their own list of C2s to send and receive additional data\nand responses. Analysis of the modules is ongoing, but at the time of research, Threatlabz has observed the following Emotet modules and\nfunctionality:\n\n**Module ID** **Notes**\n\n\n-----\n\n2 Process listing module\n\n19 [Mail PassView module](https://www.nirsoft.net/utils/mailpv.html)\n\n20 [WebBrowserPassView module](https://www.nirsoft.net/utils/web_browser_password.html)\n\n21 Outlook account stealer module\n\n22 Outlook email stealer module\n\n23 Thunderbird account stealer module\n\n24 Thunderbird email stealer module\n\n28 Email reply chain spam module\n\n29 Typical spam module\n\n36 Possibly a network proxy module\n\nMost of the observed modules focus on mail and web browser credential theft, stealing emails, and spamming. The stolen mail credentials\nand emails are most likely used to fuel the spam modules.\n\n**Spam Module Analysis**\n\nAs a deeper dive into one of the modules, let’s look at module ID 29. It is used to send typical spam messages (not reply chain spam). To\ndownload data for a spam campaign, the module sends command number “1007” with the following command data to its module specific C2\nlist:\n\nModule ID\nModule hash\nBot ID\nHardcoded 0\nOptional SMTP account identifier and status\nOptional spam message identifier\n\nThe C2 responds with encoded data in three lists:\n\nPresumably stolen SMTP account information used to send the spam (Figure 4)\nTo and from email addresses for the spam (Figure 5)\nSpam message details and attachment (Figure 6)\n\n_Figure 4: Example of post-processed stolen SMTP account list_\n\n\n-----\n\n_Figure 5: Example of post-processed To/From email list_\n\n_Figure 6: Example of post-processed spam message template_\n\nThe lists are used to create and execute a spam campaign. In the example above, the attachment was a maldoc with the SHA256 hash of\n[eb8107b9e3162bd5b746d1270433cc26c961331c24fd4c9e90b2bf27902a7bc3.](https://www.virustotal.com/gui/file/eb8107b9e3162bd5b746d1270433cc26c961331c24fd4c9e90b2bf27902a7bc3)\n\n**Reply Chain Spam Module Analysis**\n\nThe reply chain spam module (module ID 28) works similarly to the module just described. Let’s take a closer look at an example spam\ncampaign generated by this module.\n\nThe victim is tricked with a malspam using a reply-chain attack where an email thread has been stolen and pretends to be an original reply of\nthe ongoing conversation (Figure 7):\n\n_Figure 7: Stolen mail used in the campaign_\n\nThe attached malicious document uses social engineering to get the victim to enable macros (Figure 8):\n\n_Figure 8: Document with legitimate looking content to trick the user_\n\nThe malicious macros are obfuscated (Figure 9):\n\n_Figure 9: Macro code to deobfuscate HTML code_\n\nThe deobfuscated macros show that Emotet is downloaded and executed (Figure 10):\n\n_Figure 10: Partially deobfuscated HTML code to download and execute the Emotet payload_\n\n**Conclusion**\n\nAfter a law enforcement disruption and almost a year long hiatus, it seems Emotet is picking up where it left off. The malware’s core\nfunctionality is downloading additional modules and payloads. Emotet modules focus on credential theft, email theft, and spamming. Stolen\ncredentials and emails are most likely used with the spamming modules to further the spread of Emotet. Stolen credentials along with\nEmotet’s secondary payloads (reportedly Cobalt Strike) are most likely used to provide initial access to ransomware operators and affiliates.\n\n**Cloud Sandbox Detection**\n\n\n-----\n\n**Indicators of Compromise**\n\nIOC\n\nc7574aac7583a5bdc446f813b8e347a768a9f4af858404371eae82ad2d136a01\n\n81.0.236[.]93:443\n\n94.177.248[.]64:443\n\n66.42.55[.]5:7080\n\n103.8.26[.]103:8080\n\n185.184.25[.]237:8080\n\n45.76.176[.]10:8080\n\n188.93.125[.]116:8080\n\n103.8.26[.]102:8080\n\n178.79.147[.]66:8080\n\n58.227.42[.]236:80\n\n45.118.135[.]203:7080\n\n103.75.201[.]2:443\n\n195.154.133[.]20:443\n\n45.142.114[.]231:8080\n\n212.237.5[.]209:443\n\n207.38.84[.]195:8080\n\n104.251.214[.]46:8080\n\n138.185.72[.]26:8080\n\n51.68.175[.]8:8080\n\n210.57.217[.]132:8080\n\n\n-----\n\n-----BEGIN PUBLIC KEY----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEQF90tsTY3Aw9HwZ6N9y5+be9Xoov\n\npqHyD6F5DRTl9THosAoePIs/e5AdJiYxhmV8Gq3Zw1ysSPBghxjZdDxY+Q==\n\n-----END PUBLIC KEY----\n-----BEGIN PUBLIC KEY----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE86M1tQ4uK/Q1Vs0KTCk+fPEQ3cuw\n\nTyCz+gIgzky2DB5Elr60DubJW5q9Tr2dj8/gEFs0TIIEJgLTuqzx+58sdg==\n\n-----END PUBLIC KEY----\n8f683e032dd715da7fb470b0fb7976db35548139d91f4a1a3ad5d64f1ce8daad\n\n3c755a3a4bc5a4d229b98563262227d64ac18f5ff97d3b1f8fa37cfd30148142\n\n6f998e7f3aea5f5100e352135b089e585a7f95257d59a6c7b79a2fe3ae1445f4\n\nbc0c8796411e71eb962909b0db3b281a2eb68facd402cc88768867cdd1848431\n\n0ea7d56ea6cc2d838964dda792e148d872ebaab769a0d29abaf29009d6766ce7\n\nfe5c53781c3ea6def61f69f78ec92eb7a711f898190443bb67ff266494bf2a35\n\n8ea4c69f707693b58cac94842f88e63f49b893adf95cf5a9ba0adbe61ee0a0a9\n\ne730fb1b7466975558b9e22732c84c88ef6c447261f94bbb8b6d4cbc17fc95fd\n\n461648507a0ea26c886f1aeab55206a63457f1842106cb48533eb991cdf7d2d6\n\n40148daea1d5e04b0a756b827bd83a1e0f3c0bad3cd77361c52b96019eb7d1cc\n\n5b5fa30bf12f13f881708222824517d662f410b212a0f7f7ce5c611fd809f809\n\n\n-----\n\n{\n\"BeaconType\": [\n\n\"HTTPS\"\n\n],\n\n\"Port\": 443,\n\n\"SleepTime\": 5000,\n\n\"MaxGetSize\": 1403644,\n\n\"Jitter\": 10,\n\n\"MaxDNS\": \"Not Found\",\n\n\"PublicKey\": \"MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCbcI0B4jpE0I6Ioj0qYRjoDYlN52X78HX2BZ1bBLV60oOeXcvOGi7Rxcz/n0\nmSpsw9M4x0dnUWFYPL2HUxzufEfchGPyxEnH6ASasVbS0OWqIkUsuri/5vJUvisrcKT9Ebodon8Z2AUqOaZZ8s37VUxJhSm4IxsLJ6WRgFkwID\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n==\",\n\n\"C2Server\": \"lartmana\\.com,/jquery-3.3.1.min.js\",\n\n\"UserAgent\": \"Not Found\",\n\n\"HttpPostUri\": \"/jquery-3.3.2.min.js\",\n\n\"HttpGet_Metadata\": \"Not Found\",\n\n\"HttpPost_Metadata\": \"Not Found\",\n\n\"SpawnTo\": \"AAAAAAAAAAAAAAAAAAAAAA==\",\n\n\"PipeName\": \"Not Found\",\n\n\"DNS_Idle\": \"Not Found\",\n\n\"DNS_Sleep\": \"Not Found\",\n\n\"SSH_Host\": \"Not Found\",\n\n\"SSH_Port\": \"Not Found\",\n\n\"SSH_Username\": \"Not Found\",\n\n\"SSH_Password_Plaintext\": \"Not Found\",\n\n\"SSH_Password_Pubkey\": \"Not Found\",\n\n\"HttpGet_Verb\": \"GET\",\n\n\"HttpPost_Verb\": \"POST\",\n\n\"HttpPostChunk\": 0,\n\n\"Spawnto_x86\": \"%windir%\\\\syswow64\\\\dllhost.exe\",\n\n\"Spawnto_x64\": \"%windir%\\\\sysnative\\\\dllhost.exe\",\n\n\"CryptoScheme\": 0,\n\n\"Proxy_Config\": \"Not Found\",\n\n\"Proxy_User\": \"Not Found\",\n\n\"Proxy_Password\": \"Not Found\",\n\n\"Proxy_Behavior\": \"Use IE settings\",\n\n\"Watermark\": 0,\n\n\"bStageCleanup\": \"True\",\n\n\"bCFGCaution\": \"False\",\n\n\"KillDate\": 0,\n\n\"bProcInject_StartRWX\": \"False\",\n\n\"bProcInject_UseRWX\": \"False\",\n\n\"bProcInject_MinAllocSize\": 17500,\n\n\"ProcInject_PrependAppend_x86\": [\n\n\"kJA=\",\n\n\"Empty\"\n\n],\n\n\"ProcInject_PrependAppend_x64\": [\n\n\"kJA=\",\n\n\"Empty\"\n\n],\n\n\"ProcInject_Execute\": [\n\n\"ntdll:RtlUserThreadStart\",\n\n\"CreateThread\",\n\n\"NtQueueApcThread-s\",\n\n\"CreateRemoteThread\",\n\n\"RtlCreateUserThread\"\n\n],\n\n\"ProcInject_AllocationMethod\": \"NtMapViewOfSection\",\n\n\"bUsesCookies\": \"True\",\n\n\"HostHeader\": \"\",\n\n\"version\": 4\n\n}\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-13 - Return of Emotet- Malware Analysis.pdf"
    ],
    "report_names": [
        "2021-12-13 - Return of Emotet- Malware Analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535934,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653765110,
    "ts_modification_date": 1653765110,
    "files": {
        "pdf": "https://archive.orkl.eu/acda27ee4b21b4ac4114be180acadad106102036.pdf",
        "text": "https://archive.orkl.eu/acda27ee4b21b4ac4114be180acadad106102036.txt",
        "img": "https://archive.orkl.eu/acda27ee4b21b4ac4114be180acadad106102036.jpg"
    }
}