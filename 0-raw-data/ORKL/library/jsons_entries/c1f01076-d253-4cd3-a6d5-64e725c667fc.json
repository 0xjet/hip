{
    "id": "c1f01076-d253-4cd3-a6d5-64e725c667fc",
    "created_at": "2023-01-12T15:04:26.14851Z",
    "updated_at": "2025-03-27T02:16:39.935834Z",
    "deleted_at": null,
    "sha1_hash": "fe9b9ab9bcfa9d2b9956342c2a1bd91bfca6bcbc",
    "title": "2018-06-19 - Backswap malware analysis",
    "authors": "",
    "file_creation_date": "2022-05-27T21:14:09Z",
    "file_modification_date": "2022-05-27T21:14:09Z",
    "file_size": 1385084,
    "plain_text": "# Summary\n\n**cert.pl/en/news/single/backswap-malware-analysis/**\n\nBackswap is a banker, which we first observed around March 2018. It’s a variant of old,\nwell-known malware TinBa (which stands for “tiny banker”). As the name suggests, it’s\nmain characteristic is small size (very often in the 10-50kB range). In the summary, we\npresent reasoning for assuming it’s the same malware.\n\nWe were writing about TinBa in 2015, since then, it was using various techniques:\n\n[DGA for communication with C&C](https://en.wikipedia.org/wiki/Domain_generation_algorithm)\n[Form grabbing to steal users credentials](https://en.wikipedia.org/wiki/Form_grabbing)\ninjecting in different processes\nYou can read more about those variants here:\n\nThere are multiple versions of Backswap. We are going to focus on the newer samples,\nand their commons parts for readability purposes. Malware targets mostly Polish\nbanks, sometimes cryptocurrency wallets. It swaps the account number of the money\n\n\n-----\n\ntransfer recipient using injected JavaScript code. You can find few years old source\ncode.\n\nFeatures:\n\ncan run from arbitrary address in the process memory\nresolves import table, using simple hashes of functions names\nswaps the contents of the clipboard, when bank/cryptocurrency account number\nis found\ninjects WebInjects, replacing bank numbers and stealing credentials\nMalware recognize its attack targets using ‘*’ as a wildcard:\n\nSometimes substring search is used:\n\n## Technical analysis\n\nWe can retrieve many information just from reading the source code. It can be helpful\nfor revealing general behaviour. Unfortunately, due to large amount of varieties and the\nfact that the source code is pretty old, it’s not enough to understand how the newer\nsamples operate.\n\n### 1. Position Independent\n\nBackswap very often hides in another program. List of executables used for this\npurpose involve programs like 7zip, ollydbg, dbgview. For what we know, it’s not a\nstealth technique in a sense that it’s purpose is to not alarm the user. We assume it’s\nused just to misdirect the heuristics of antivirus software. Execution of Backswap starts\nthanks to additional entry added to the initterm table. Table that is used for the\ninitialization of the C++ enviroment.\n\nIn order to be executed, Backswap code is copied into different area of memory.\n\nTo make the malware work in such conditions, it must be able to run from any place in\n[memory, this feature is called Position Independent Code(PIC). In short, it means that](https://en.wikipedia.org/wiki/Position-independent_code)\nall of the offsets are calculated relatively.\n\nBackswap accomplishes that by this distinctive combination of instructions:\n\nAbove instructions calculate the offset relative to the 0x401000 address. Then this\nvalue is added to every jump or any instruction involving memory access.\n\n\n-----\n\nOne specific thing we faced during analysis was technique called call-over-string . The\nidea is to store strings inside the code and make calls over the strings. This results in a\nstring address pushed on the stack, while execution continues. It saves space and\nmakes writing Position Independent Code easier. This technique is tricky for\ndisassemblers to get right. IDA Pro is not able to automatically disassemble it correctly.\n\nIn the automatically generated IDA code, we can see that instructions following\nthe call are disassembled before the ones pointed by call destination. This is\nincorrect and have to be adjusted manually\n\nAfter manual adjustments, we can see how the code should look like\n\n\n-----\n\n### 2. Windows API\n\nDue to Backswap being Position Independent and fully self-contained, it does not know\nwhere Windows libraries are loaded. It does that by itself. First step in that process is to\nfind kernel32.dll library. TIB/PEB are used to do exactly that.\n\nRemaining libraries are loaded with function LoadLibraryA exported from the library\nmentioned above.\n\nBackswap loads functions from libraries by comparing simple hash of the name of the\nfunction with table of hashes stored inside the binary. Algorithm expressed in Python:\n\nLoaded libraries\n\n### 3. Harmful activity\n\nBackswap carries out multiple harmful activities. Big ones are: injecting Webinjects and\nstealing credentials. Supported browsers involve Internet Explorer, Mozilla Firefox,\nGoogle Chrome. Some variants also swap the contents of the clipboard when\nbank/cryptocurrency account number is found.\n\n\n-----\n\n**WebInjects**\n\nWebInjects are injected with rather innovative method, successfuly avoiding antivirus\nheuristics.\n\nCode to be injected is stored inside .rsrc section of the PE file. Content is xored with a\nconstant value, most of the time with 0x8. It’s achieved with a series of xors instead of\nsingle xor. In the newer samples we observed different constants, and the xoring code\nmodified a bit.\n\nBackswap uses keyboard shortcuts for injection. Whole process looks as follows:\n\nIn case of Mozilla Firefox: disable protection from pasting code inside JavaScript\nconsole, it’s achieved with the following command: /V:ON /C dir /S/B/A-D\n“%APPDATA%\\Mozilla\\prefs.js” > “%TEMP%\\edit” && SETLOCAL\nEnableDelayedExpansion && set /p v=<“%TEMP%\\edit” && echo\n^user_pref(“devtools.selfxss.count”, 100); >> “!v!”\nGet WebInjects from .rsrc section\nInsert WebInject into clipboard. In the first frame you can see\n[SetClipboardData.aspx) function, used for that purpose](https://msdn.microsoft.com/en-us/library/windows/desktop/ms649051(v=vs.85)\n\n\n-----\n\n[Hide browser window. To perform this operation, first GetWindowLong.aspx) is](https://msdn.microsoft.com/en-us/library/windows/desktop/ms633584(v=vs.85)\ncalled to get GWL_EXSTYLE – extended window styles. Those are extended\nwith attribute WS_EX_LAYERED(or eax, 80000h), and set on the window with\n[SetWindowLong.aspx) This results in window being transparent, not visible to the](https://msdn.microsoft.com/en-us/library/windows/desktop/ms633591(v=vs.85)\nuser\n\n\n-----\n\nSend CTRL+SHIT+J keyboard combination to the browser process for Internet\nExplorer/Google Chrome, and CTRL+SHIFT+K for Firefox. This results in\n[developer console popping up. SendInput.aspx) is used](https://msdn.microsoft.com/en-us/library/windows/desktop/ms646310(v=vs.85)\n\nIn a very similar fashion, malware sends CTRL+V, then ENTER\n\n\n-----\n\nFinally, console is closed with the same keyboard shortcuts. Transparency of the\nwindow is turned off\n\n\n-----\n\nNewer samples changed injecting technique a bit. Steps involve:\n\nSending CTRL+L to the browser window with SendInput function\nTyping javascript: string, character by character, using SendMessage with\nargument WM_CHAR in a loop\n\n**Stealing credentials**\n\nSome of the samples steal credentials in a very interesting fashion. With the help of\n[SetWinEventHook.aspx) following events are hooked:](https://msdn.microsoft.com/en-us/library/windows/desktop/dd373640(v=vs.85)\n\nConfigured callback function for those events saves window title text to the log file\nlocated in %TEMP%/<nazwa>.log. Example names involve dero, niko, gobi, abc.\n\nIn the same time, WebInjects put the credentials into browser window title. Background\nthread periodically sends log file contents to the C&C server.\n\nSome of the WebInjects involved in the process are presented below.\n\nSome of the older C&C used:\n\nThose are mostly websites with legit services, which means that they have been\ncompromised.\n\n\n-----\n\nSamples that does not contain C&C server, are using URL suggesting that authors are\ncounting number of infections http://counter.yadro.ru/hit?\nrhttp://sexy.com/;uhttp://sexy.com/;h.\n\nBackswap and TinBa are very alike. They share: call $+5; pop ebx instructions for\nPosition Independent Code, functions for reconstructing Windows API table, storing\nWebInjects inside .rsrc xored with constant key, call-over-string and strings contained in\nthe sample.\n\nMain difference is in the harmful activity performed by the malware.\n\n### YARA Rules\n\n Hashes\n\n Other analyses\n\n[https://www.welivesecurity.com/2018/05/25/backswap-malware-empty-bank-accounts/](https://www.welivesecurity.com/2018/05/25/backswap-malware-empty-bank-accounts/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-06-19 - Backswap malware analysis.pdf"
    ],
    "report_names": [
        "2018-06-19 - Backswap malware analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "2864e40a-f233-4618-ac61-b03760a41cbb",
            "created_at": "2023-12-01T02:02:34.272108Z",
            "updated_at": "2025-03-27T02:02:10.209072Z",
            "deleted_at": null,
            "main_name": "WildCard",
            "aliases": [],
            "source_name": "ETDA:WildCard",
            "tools": [
                "RustDown",
                "SysJoker"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "99cb4e5b-8071-4f9e-aa1d-45bfbb6197e3",
            "created_at": "2023-01-06T13:46:38.860754Z",
            "updated_at": "2025-03-27T02:00:02.937438Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "SectorJ04 Group",
                "Dudear",
                "G0092",
                "ATK103",
                "Hive0065",
                "Spandex Tempest",
                "GRACEFUL SPIDER",
                "GOLD TAHOE",
                "CHIMBORAZO",
                "SectorJ04"
            ],
            "source_name": "MISPGALAXY:TA505",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75d4d6a9-b5d1-4087-a7a0-e4a9587c45f4",
            "created_at": "2022-10-25T15:50:23.5188Z",
            "updated_at": "2025-03-27T02:00:55.489882Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "TA505",
                "Hive0065",
                "Spandex Tempest",
                "CHIMBORAZO"
            ],
            "source_name": "MITRE:TA505",
            "tools": [
                "AdFind",
                "Azorult",
                "FlawedAmmyy",
                "Mimikatz",
                "Dridex",
                "TrickBot",
                "Get2",
                "FlawedGrace",
                "Cobalt Strike",
                "ServHelper",
                "Amadey",
                "SDBbot",
                "PowerSploit"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "e447d393-c259-46e2-9932-19be2ba67149",
            "created_at": "2022-10-25T16:07:24.28282Z",
            "updated_at": "2025-03-27T02:02:10.159466Z",
            "deleted_at": null,
            "main_name": "TA505",
            "aliases": [
                "ATK 103",
                "Chimborazo",
                "Gold Evergreen",
                "Gold Tahoe",
                "Graceful Spider",
                "Hive0065",
                "Operation Tovar",
                "Operation Trident Breach",
                "SectorJ04",
                "Spandex Tempest",
                "TA505",
                "TEMP.Warlock"
            ],
            "source_name": "ETDA:TA505",
            "tools": [
                "Amadey",
                "AmmyyRAT",
                "AndroMut",
                "Azer",
                "Bart",
                "Bugat v5",
                "CryptFile2",
                "CryptoLocker",
                "CryptoMix",
                "CryptoShield",
                "Dridex",
                "Dudear",
                "EmailStealer",
                "FRIENDSPEAK",
                "Fake Globe",
                "Fareit",
                "FlawedAmmyy",
                "FlawedGrace",
                "FlowerPippi",
                "GOZ",
                "GameOver Zeus",
                "GazGolder",
                "Gelup",
                "Get2",
                "GetandGo",
                "GlobeImposter",
                "Gorhax",
                "GraceWire",
                "Gussdoor",
                "Jaff",
                "Kasidet",
                "Kegotip",
                "Kneber",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Locky",
                "MINEBRIDGE",
                "MINEBRIDGE RAT",
                "MirrorBlast",
                "Neutrino Bot",
                "Neutrino Exploit Kit",
                "P2P Zeus",
                "Peer-to-Peer Zeus",
                "Philadelphia",
                "Philadephia Ransom",
                "Pony Loader",
                "Rakhni",
                "ReflectiveGnome",
                "Remote Manipulator System",
                "RockLoader",
                "RuRAT",
                "SDBbot",
                "ServHelper",
                "Shifu",
                "Siplog",
                "TeslaGun",
                "TiniMet",
                "TinyMet",
                "Trojan.Zbot",
                "Wsnpoem",
                "Zbot",
                "Zeta",
                "ZeuS",
                "Zeus"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "256a6a2d-e8a2-4497-b399-628a7fad4b3e",
            "created_at": "2023-11-30T02:00:07.299845Z",
            "updated_at": "2025-03-27T02:00:03.257794Z",
            "deleted_at": null,
            "main_name": "WildCard",
            "aliases": [],
            "source_name": "MISPGALAXY:WildCard",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535866,
    "ts_updated_at": 1743041799,
    "ts_creation_date": 1653686049,
    "ts_modification_date": 1653686049,
    "files": {
        "pdf": "https://archive.orkl.eu/fe9b9ab9bcfa9d2b9956342c2a1bd91bfca6bcbc.pdf",
        "text": "https://archive.orkl.eu/fe9b9ab9bcfa9d2b9956342c2a1bd91bfca6bcbc.txt",
        "img": "https://archive.orkl.eu/fe9b9ab9bcfa9d2b9956342c2a1bd91bfca6bcbc.jpg"
    }
}