{
    "id": "a256d22f-bce8-48ea-b330-1dd4e6fce246",
    "created_at": "2023-01-12T15:10:38.835546Z",
    "updated_at": "2025-03-27T02:06:12.341482Z",
    "deleted_at": null,
    "sha1_hash": "12d9f9c23d21079c94dd5fba2f5942584a2a1af4",
    "title": "2020-03-19 - Phân tích mã độc lợi dụng dịch Covid-19 để phát tán giả mạo “Chỉ thị của thủ tướng Nguyễn Xuân Phúc” - Phần 2",
    "authors": "",
    "file_creation_date": "2022-05-28T15:23:20Z",
    "file_modification_date": "2022-05-28T15:23:20Z",
    "file_size": 1460635,
    "plain_text": "# [RE012-2] Phân tích mã độc lợi dụng dịch Covid-19 để phát tán giả mạo “Chỉ thị của thủ tướng Nguyễn Xuân Phúc” - Phần 2\n\n**blog.vincss.net/2020/03/re012-phan-tich-ma-doc-loi-dung-dich-COVID-19-de-phat-tan-gia-mao-chi-thi-cua-thu-tuong-**\nNguyen-Xuan-Phuc-phan2.html\n\n[Như đã đề cập ở phần trước, unsecapp.exe sẽ nạp http_dll.dll, code tại http_dll.dll đọc](https://blog.vincss.net/2020/03/re012-phan-tich-ma-doc-loi-dung-dich-COVID-19-de-phat-tan-gia-mao-chi-thi-cua-thu-tuong-Nguyen-Xuan-Phuc.html)\ndữ liệu đã mã hóa trong http_dll.dat và tiến hành giải mã payload cuối vào bộ nhớ, sau đó\n[gọi thẳng tới payload này để thực thi. Có thể nói với kĩ thuật fileless malware này, payload](https://en.wikipedia.org/wiki/Fileless_malware)\ncuối cùng sẽ không hề để lại dấu vết trên ổ đĩa.\n\nPayload nói trên bản chất là một dll (name: HT.dll), trong quá trình phân tích chúng tôi nhận\nthấy đây là một biến thể của dòng PlugX. Trong bài viết này, chúng tôi sẽ mô tả một số hoạt\nđộng cơ bản của biến thể này.\n\n## 1. Mô phỏng hoạt động Windows Loader\n\nCách thức thực thi payload này khá giống kiểu thực thi shellcode. Nó được gọi thẳng tới\n\n\n-----\n\n**ImageBase, từ đây sẽ gọi tới hàm được export là Loader (0x10001710).**\n\nHình 1: Thực thi code từ ImageBase để gọi tới hàm Loader\n\nHàm Loader làm nhiệm vụ:\n\nTruy xuất PEB lấy tên các module, tính toán hash tương ứng.\nNếu tên module trùng với hash đã tính toán trước, lấy tên các hàm thuộc module đó.\nTính toán hash của các hàm.\nNếu tên hàm trùng với hash đã tính toán trước, thực hiện lấy ra địa chỉ của hàm.\nThực hiện các bước tương tự nhiệm vụ của Windows Loader để nạp chính xác dll và\nsau đó nhảy thẳng tới DllEntryPoint.\n\nDanh sách các hash tương ứng với module và tên hàm mà mã độc sử dụng:\n\n**Hash** **Module / Function**\n\n0x6A4ABC5B kernel32.dll\n\n0x3CFA685D ntdll.dll\n\n0xEC0E4E8E LoadLibraryA\n\n0x7C0DFCAA GetProcAddress\n\n0x91AFCA54 VirtualAlloc\n\n\n-----\n\n0x534C0AB8 NtFlushInstructionCache\n\nHình 2: Nhảy tới DllEntryPoint\n\n## 2. Các cách thực thi chính\n\nTừ DllEntryPoint sẽ gọi tới chức năng chính của mã độc. Tại đây, thực hiện giải mã cấu\nhình của mã độc (chứa thông tin thư mục, C2, ports), sau đó sẽ có hai hướng thực thi chính\nnhư sau:\n\n\n**Hướng**\n**thực**\n**thi**\n\nKhông\ncó\ntham\nsố\n\nCó\ntham\nsố\n\n\n**Mục đích**\n\nTạo thư mục để lưu mã độc, ghi các files vào thư mục đã tạo, thiết lập\npersistence key trong registry để chạy malware với tham số ngẫu nhiên và thực\nthi lại mã độc với tham số là “6”.\n\nTạo mutex, kết nối, giao tiếp với địa chỉ C2 và thực hiện các lệnh.\n\n\n-----\n\nHình 3: Các hình thức thực thi của mã độc\n\nTrong quá trình phân tích, chúng tôi thấy payload này gọi tới các hàm APIs thông qua các\n[hàm wrapper nhằm mục đích làm rối. Các hàm wrapper sử dụng kĩ thuật stackstrings để xây](https://www.fireeye.com/blog/threat-research/2014/08/flare-ida-pro-script-series-automatic-recovery-of-constructed-strings-in-malware.html)\ndựng tên API, gọi hàm GetProcAddress để lấy địa chỉ thật, sau đó thực thi hàm chính.\n\n## 3. Giải mã cấu hình\n\nNhư mô tả ở trên, trước khi thực thi chức năng chính, mã độc sẽ thực hiện giải mã cấu hình\nliên quan tới tên thư mục dùng để lưu các files, địa chỉ C2, port sử dụng (80, 443, 8080,\n8000). Hàm giải mã tại 0x1000AD10 thực hiện nhiệm vụ:\n\nCopy toàn bộ vùng dữ liệu đã mã hóa vào bộ nhớ (Nếu có file payload như ở phần\n_trước thì vùng dữ liệu này nằm tại offset 0x1D000)._\nSử dụng XOR để thực hiện vòng lặp giải mã toàn bộ dữ liệu có kích thước 0x724\n**bytes với khóa giải mã là “123456789”.**\n\n\n-----\n\nHình 4: Giải mã cấu hình của mã độc\n\nHình ảnh trước và sau khi giải mã:\n\n\n-----\n\nHình 5: Kết quả trước và sau khi giải mã thành công\n\n## 4. Tạo files và thiết lập persistence key\n\nNhư đã phân tích trong phần trước, ban đầu mã độc tạo các files trong thư mục\n**%LocalAppData%\\Temp và khởi chạy file 3.exe. Ở lần thực thi đầu tiên, do không truyền**\ntham số nên mã độc sẽ thực hiện mã ứng với hướng “không có tham số”. Tóm lược nhiệm\nvụ của hướng này:\n\nLấy thông tin tên thư mục từ cấu hình đã giải mã, cấu thành các chuỗi\n**%userprofile%\\; %allusersprofile%\\, tạo thư mục “Microsoft Malware**\n**Protectionydy” và xây dựng đường dẫn để lưu files:**\n\n\n-----\n\nHình 6: Cấu thành đường dẫn phục vụ lưu mã độc\n\nLấy thông tin các files đã tạo ở thư mục %LocalAppData%\\Temp, tạo các files mới ở\nthư mục đã chỉ định:\n\nHình 7: Tạo files tại thư mục do mã độc chỉ định\n\nCấu thành chuỗi gồm đường dẫn tới %AllUsersProfile%\\Microsoft Malware\n**Protectionydy\\ unsecapp.exe kèm theo một tham số ngẫu nhiên để lưu vào**\nRegistry:\n\nHình 8: Cấu thành đường dẫn tới file thực thi kèm tham số ngẫu nhiên\n\nTạo các registry run key tại\n**HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run và**\n**HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run:**\n\n\n-----\n\nHình 9: Tạo persistence run key\n\nHình 10: Key tạo thành công tại HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n\nHình 11: Key tạo thành công tại HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n\nCuối cùng, thực thi malware một lần nữa với tham số mặc định là “6”:\n\nHình 12: Thực thi lại mã độc với tham số mặc định\n\n\n-----\n\nHình 13: Mã độc thực thi với tham số mặc định\n\n## 5. Kết nối và giao tiếp với C2\n\nBằng cách thực thi lại kèm theo tham số, mã độc sẽ thực hiện lệnh tại hướng “có tham số”.\nHướng này tạo mutex, kết nối tới địa chỉ C2 và thực hiện các lệnh. Mã độc sẽ khởi tạo để sử\ndụng Winsock thông qua hàm WSAStartup, bật các quyền liên quan tới “Privilege\n_Escalation”: SeDebugPrivilege, SeTcbPrivilege, SeTcpPrivilege._\n\nMã độc xây dựng các TLS (Thread Local Storage) cho phép nhiều luồng của tiến trình\ncùng sử dụng chung một giá trị index được cấp phát bởi hàm TlsAlloc. Các giá trị TLS mà\nmã độc sử dụng trong biến thể này bao gồm:\n\n**Tên** **Mục đích**\n\nCXOnline::OlStartProc Thực thi thread CXOnline::OlStartProcPipe\nKhởi tạo giao tiếp với C2\n\nCXOnline::OlStartProcPipe Khởi tạo pipe, phân tích và thực hiện các C2 commands.\n\nCXSoHttp::SoWorkProc Gửi yêu cầu tới C2. Mỗi kết nối thực hiện 03 lần.\n\n\n-----\n\nCXFuncShell::ShellT1 Thực hiện shell, liên quan tới ReadFile\n\nCXFuncShell::ShellT2 Thực hiện shell, liên quan tới WriteFile\n\nMã độc kết hợp nhiều cách khác nhau để kết nối tới C2, sử dụng HTTP POST request hoặc\nthông qua raw TCP. Luồng code sử dụng HTTP POST request để khởi tạo kết nối tới C2\nnhư sau:\n\nHình 14: Luồng thực thi sử dụng HTTP POST request\n\nĐể giao tiếp với C2, mã độc xây dựng các thông tin sau trong Request Headers:\n\n\n-----\n\nUser-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1;\nThiết lập “Pragma: no-cache” thông qua việc bật cờ\nINTERNET_FLAG_PRAGMA_NOCACHE|INTERNET_FLAG_KEEP_CONNECTION\nBổ sung các tham số:\n\n- x-debug\n\n- x-request\n- x-content\n- x-storage\n\nURL sử dụng để gửi yêu cầu tới C2 có dạng: /update?wd=%8.8x (%8.8x là 8 số ngẫu\nnhiên).\n\nMã độc thực hiện gửi tối thiểu 03 request tới C2, nếu không thành công sẽ sử dụng port\nkhác để kết nối. Các port sử dụng gồm: 80, 443, 8080, 8000.\n\nHình 15: Tối thiểu 03 lần cho mỗi request tới C2\n\nHình 16: Minh họa 03 kết nối với URL ngẫu nhiên thông qua port 80\n\n\n-----\n\nHình 17: Request Headers gửi tới C2 từ máy nạn nhân\n\nTrong trường hợp kết nối thành công tới C2, quá trình tương tác với nạn nhân sẽ được điều\nkhiển bởi C2. Với biến thể mà chúng tôi phân tích, khi nhận được thông tin từ C2, nó sẽ thực\nhiện lệnh theo hai nhóm lệnh khác nhau phụ thuộc vào quá trình giao tiếp. Các nhóm lệnh\ncó id lần lượt là 0x1001 và 0x1002.\n\n\n-----\n\nHình 18: Các nhóm lệnh sẽ thực hiện nếu giao tiếp thành công với C2\n\nCác lệnh ứng với nhóm lệnh có id 0x1001:\n\n**Lệnh** **Mục đích**\n\n0x1001 Lấy thông tin hệ thống của nạn nhân: thông tin tình trạng sử dụng bộ nhớ; thông\n_tin phiên bản về hệ điều hành đang hoạt động; thông tin về tên máy, tên người_\n_dùng; thông tin về CPU; thông tin về kích thước màn hình; tạo CSLID của mã_\n_độc (HKLM\\Software\\CLASSES\\ms-pu / HKCU\\Software\\CLASSES\\ms-pu)_\n\n0x1002 Tạo thread liên quan tới giao tiếp Pipe (CXOnline::OlStartProcPipe)\n\n0x1003 Unknown\n\n0x1004 ExitProcess\n\n\n-----\n\nHình 19: Nhóm lệnh ứng với id 0x1001\n\nCác lệnh ứng với nhóm lệnh có id 0x1002:\n\n**Lệnh** **Mục đích**\n\n0x7002 Tạo pipe name, khởi chạy cmd.exe dưới pipe name, thực hiện remote shell với\ncác thread CXFuncShell::ShellT1 & CXFuncShell::ShellT2\n\n0x3000 Lấy thông tin ổ đĩa, dung lượng.\n\n0x3001 Tìm kiếm file.\n\n0x3004 Mở file, lấy thông tin ngày tháng, kích thước và đọc nội dung file.\n\n0x3007 Ghi file.\n\n0x300A Tạo thư mục.\n\n0x300B Kiểm tra tồn tại file.\n\n0x300C Khởi chạy tiến trình mới dưới một Desktop ẩn.\n\n0x300D Gọi hàm SHFileOperationW nhằm thực hiện copy, move, rename, hoặc delete\nmột file.\n\n\n-----\n\n0x300E Mở rộng biến môi trường và thay thế bằng các giá trị mà kẻ tấn công mong\nmuốn.\n\n0x300F Lấy thư mục chứa mã độc.\n\nHình 20: Nhóm lệnh ứng với id 0x1002\n\nQuá trình thực hiện các nhóm lệnh nói trên, mã độc sẽ trao đổi nội dung thông qua việc mã\nhóa/giải mã (sử dụng XOR) và nén/giải nén dữ liệu (sử dụng thuật toán nén LZ):\n\n\n-----\n\nHình 21: Nhóm lệnh sử dụng mã hóa/giải mã trong quá trình giao tiếp\n\nHình 22: Nhóm lệnh sử dụng mã hóa/giải mã trong quá trình giao tiếp\n\n\n-----\n\nThuật toán mã hóa/giải mã dữ liệu sử dụng ở biến thế này để giao tiếp giữa nạn nhân và C2\nlà XOR, kèm theo một giá trị cố định là '6666' (0x36363636):\n\nHình 23: Thuật toán XOR sử dụng để mã hóa/giải mã\n\n## 6. Ghi log\n\nTrong quá trình thực hiện, nếu có exception xảy ra, mã độc sẽ sử dụng thread\n**CXSalvation::SalExceptionHandler để ghi log vào file có tên là SS.log với các thông tin cơ**\nbản gồm:\n\n**\"EName: %s\": tên của exception**\n**\"EAddr: 0x%p\": địa chỉ gây ra exception**\n**\"ECode: 0x%p\": mã của exception**\n\nĐoạn code được mã độc sử dụng để thực hiện ghi log như sau:\n\n\n-----\n\nHình 24: Mã độc ghi log vào file SS.log\n\n_Bài phân tích xin được dừng lại tại đây, qua đây có thể thấy đây là một dòng mã độc phức_\n_tạp với nhiều chức năng. Mã độc thông qua nhiều bước để có thể khởi chạy được payload_\n_cuối cùng, đồng thời dữ liệu trao đổi với C2 đều được nén và mã hóa, giúp cho mã độc có_\n_thể vượt qua được các giải pháp phòng vệ một cách khá hiệu quả._\n\n_---------------------_\n\n**Để tiện theo dõi, chúng tôi cung cấp bài phân tích đầy đủ dưới dạng PDF:**\n\n**File Name: CSS-RD-ADV-200319-012_Phân tích mã độc lợi dụng dịch Covid-19 để phát tán**\ngiả mạo “Chỉ thị của thủ tướng Nguyễn Xuân Phúc” v1.0 Final\n\n**File Hash (SHA-**\n**256): 3b0af20f01e2a543cdd43e47e57553bd42d6103e670de2ef75fe5383a2cccda6**\n\n**R&D Center - VinCSS (a member of Vingroup)**\n\n\n-----",
    "language": "VI",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-19 - Phân tích mã độc lợi dụng dịch Covid-19 để phát tán giả mạo “Chỉ thị của thủ tướng Nguyễn Xuân Phúc” - Phần 2.pdf"
    ],
    "report_names": [
        "2020-03-19 - Phân tích mã độc lợi dụng dịch Covid-19 để phát tán giả mạo “Chỉ thị của thủ tướng Nguyễn Xuân Phúc” - Phần 2.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536238,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1653751400,
    "ts_modification_date": 1653751400,
    "files": {
        "pdf": "https://archive.orkl.eu/12d9f9c23d21079c94dd5fba2f5942584a2a1af4.pdf",
        "text": "https://archive.orkl.eu/12d9f9c23d21079c94dd5fba2f5942584a2a1af4.txt",
        "img": "https://archive.orkl.eu/12d9f9c23d21079c94dd5fba2f5942584a2a1af4.jpg"
    }
}