{
    "id": "1a26a2ec-ec28-4f49-9bf7-5f5021d2ea3d",
    "created_at": "2023-01-12T15:07:28.029271Z",
    "updated_at": "2025-03-27T02:15:13.888681Z",
    "deleted_at": null,
    "sha1_hash": "d1b14e22fed179bbf70592c4840f9f7e553463ac",
    "title": "2019-05-01 - FrameworkPOS and the adequate persistent threat",
    "authors": "",
    "file_creation_date": "2022-05-28T05:06:17Z",
    "file_modification_date": "2022-05-28T05:06:17Z",
    "file_size": 403137,
    "plain_text": "# See what it's like to have a partner in the fight.\n\n**[redcanary.com/blog/frameworkpos-and-the-adequate-persistent-threat/](https://redcanary.com/blog/frameworkpos-and-the-adequate-persistent-threat/)**\n\nAll too often the information security community focuses on a category of adversary known\nas an Advanced Persistent Threat (APT). Marketing and sales departments all around this\nindustry have focused their messaging on the premise that their product or service will\nprotect you against APT-level adversaries, and this sometimes causes us to lose sight of a\nsimpler truth. Most adversaries do not need to be advanced or sophisticated to execute\ncode or persist in an organization. More often than not, they can simply settle to be an\nadequate persistent threat, using techniques and artifacts that anyone can find within their\norganization.\n\nIn this threat detection post, we’ll look at FrameworkPOS, a point-of-sale malware family\nthat has been tied to an organized APT group in the past. In doing so, we’ll show that an\nadversary doesn’t need advanced techniques to execute and persist; they simply need to\nbe good enough.\n\n\n-----\n\n## Point of sale and compromise\n\nOur first indication of trouble for one particular endpoint was the execution of an encoded\nPowerShell command spawning from the Windows Service Controller, `services.exe .`\n\n[This kind of event typically suggests that there is a Windows Service (T1035,](https://attack.mitre.org/techniques/T1035/) [T1050) on the](https://attack.mitre.org/techniques/T1050/)\nhost that will issue this `cmd.exe and` `powershell.exe command when started. We`\nsometimes see this functionality used legitimately in the maintenance of systems, but those\ninstances almost always use scripts with names and paths. PowerShell is almost always\nevil when we see it encoded in this context.\n\nIn this case, the malicious PowerShell code deobfuscated partially to reveal some telling\nstrings:\n\n```\n$s=New-Object IO.MemoryStream(,[Convert]::FromBase64String(\"H4sI\n\n```\n\nThe base64 encoded PowerShell decoded into the above, showing that a second payload\nhad been compressed using gzip and encoded using base64. We can make this assertion\nbased partially on the FromBase64String function, and partially on the H4sI value at the\nstart of the second payload. Whenever we see this base64 value in the wild, it indicates that\nthere is a gzipped payload within the encoding.\n\n\n-----\n\nThe PowerShell code went on to download and execute `installer_8.exe, a malicious`\npayload that hadn’t been observed by antivirus (AV) vendors at that point. This is an\nimportant distinction because it shows how adversaries can evade AV detection just by\nusing tools that are new. In fact, a dynamic-link library (DLL) written by this binary also\nevaded detection by AV due to a misclassification. AV tools thought the DLL was not\nmalware, which turned out to be false.\n```\nInstaller_8.exe proceeded to establish persistence using two methods:\n\n```\na Windows Registry autorun key\n\n\n-----\n\na Scheduled Task\n\nNeither of these methods are particularly sophisticated; the adversary used a well-known\nautorun key when they could’ve used far more obscure ones. The task is also relatively\nsimple: it’s just trying to blend in under the guise of a Windows Help tool.\n\n_Something to note: both of these persistence mechanisms are relatively easy to enumerate_\nand hunt at scale across an enterprise using several solutions.\n\nTo execute its final payload, `installer_8.exe spawned` `rundll32.exe to load the`\n```\nworkerInstance function from assistant32.dll . Once this ran, it created a file named\nbtid.dat . When the persistence mechanisms executed, we observed the same\nrundll32.exe behavior again.\n\n```\nAt this point, we can tell the behaviors observed are most likely malicious due to\nPowerShell activity, but we don’t have a lot of information around this particular DLL. Some\n[quick Google searches unearthed this research from Morphisec, suggesting that we](https://blog.morphisec.com/new-global-attack-on-point-of-sale-systems)\napparently found FrameworkPOS malware!\n\n## Finding patient zero\n\nA concerning part of this detection within the Red Canary Cyber Incident Response Team\n(CIRT) was that the earlier PowerShell communication did not establish an external network\nconnection. Instead we observed a network connection to another host on the internal\nnetwork. This spawned a lateral movement hypothesis for us: there was likely another host\non the network that was patient zero.\n\nAfter hopping around hosts to find the original source of activity, we found another\nPowerShell command executing as a service that did establish an external network\nconnection.\n\n\n-----\n\nAfter consulting the Morphisec research again, we found the external network connection\nwas consistent with the same campaign they observed in the wild.\n\n## Adequate adversaries still exist\n\nLooking into Morphisec’s research, there is a possibility that this campaign could be tied to\ncybercriminal group known commonly as FIN6. This group has targeted POS systems in\nthe past, and [recent reports indicate they may be involved with ransomware attacks.](https://www.fireeye.com/blog/threat-research/2019/04/pick-six-intercepting-a-fin6-intrusion.html)\nFrameworkPOS is very much a tool used by groups considered to be APTs. Even with this\nqualification, we can see a tendency to use “good enough” persistence and execution.\n\nThis provides a good starting point for defenders. We can start simple and grow to have\nmore complex detection capabilities as we mature. To begin hunting for malicious\npersistence mechanisms, we can search for Registry key values that shouldn’t exist in\n```\nMicrosoft\\Windows\\CurrentVersion\\Run before hunting for every key referenced in\n\n```\n[the infamous “Beyond good ol’ Run key” blog series.](http://www.hexacorn.com/blog/2012/07/23/beyond-good-ol-run-key/)\n\nIn addition to the Registry key, we can start simple with event logging by focusing on just\nevents for Scheduled Task execution and new service creation. By the time we become\nproficient at collecting and hunting through these artifacts, we’ll be ready to tackle more\nadvanced techniques.\n\n## Behaviors from this detection\n\nHere are some of the search queries that contributed to this post.\n\n### FrameworkPOS DLL execution\n\n_High confidence_\n\nProcess is ‘rundll32.exe` AND command line contains ‘workerInstance’\n\n### Shell execution as a service\n\n_Medium confidence, needs tuning for your products and admin tools_\n\n\n-----\n\nParent process is services.exe AND process is cmd.exe or powershell.exe\n\n### Privileged Scheduled Task execution\n\n_Low/medium confidence, tune out administrative activity._\n\nParent process is ‘taskeng.exe’ AND username is ‘SYSTEM’\n\n### Windows Registry Autorun Key modification\n\n_Low/medium confidence, tune out new installations and software updates_\n\nModification to Registry Key ‘Microsoft\\Windows\\CurrentVersion\\Run’\n\n## Conclusion\n\nDon’t be intimidated by adversaries. More often than not, you’ll find they don’t have to use\nsophisticated techniques during attacks. If you start simple and work toward becoming more\nmature as you grow, you’ll be ready for the small stuff and able to hunt down the more\ncomplex challenges when they come to you.\n\nRelated Articles\n\nDetection and response\n\n### ChromeLoader: a pushy malvertiser\n\nDetection and response\n\n### Intelligence Insights: May 2022\n\nDetection and response\n\n### The Goot cause: Detecting Gootloader and its follow-on activity\n\nDetection and response\n\n### Marshmallows & Kerberoasting\n\n**Subscribe to our blog**\n\n\n-----\n\nOur website uses cookies to provide you with a better browsing experience. More\n[information can be found in our Privacy Policy.](https://redcanary.com/privacy-policy)\nX\n\n**Privacy Overview**\n\nThis website uses cookies to improve your experience while you navigate through the\nwebsite. Out of these cookies, the cookies that are categorized as necessary are stored on\nyour browser as they are essential for the working of basic functionalities of the website. We\nalso use third-party cookies that help us analyze and understand how you use this website.\nThese cookies will be stored in your browser only with your consent. You also have the\noption to opt-out of these cookies. But opting out of some of these cookies may have an\neffect on your browsing experience.\n\nNecessary cookies are absolutely essential for the website to function properly. This category\nonly includes cookies that ensures basic functionalities and security features of the website.\nThese cookies do not store any personal information.\n\nAny cookies that may not be particularly necessary for the website to function and is used\nspecifically to collect user personal data via analytics, ads, other embedded contents are\ntermed as non-necessary cookies. It is mandatory to procure user consent prior to running\nthese cookies on your website.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-05-01 - FrameworkPOS and the adequate persistent threat.pdf"
    ],
    "report_names": [
        "2019-05-01 - FrameworkPOS and the adequate persistent threat.pdf"
    ],
    "threat_actors": [
        {
            "id": "ee3363a4-e807-4f95-97d8-b603c31b9de1",
            "created_at": "2023-01-06T13:46:38.485884Z",
            "updated_at": "2025-03-27T02:00:02.845851Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "Camouflage Tempest",
                "MageCart Group 6",
                "G0037",
                "TA4557",
                "SKELETON SPIDER",
                "ITG08",
                "White Giant",
                "GOLD FRANKLIN",
                "ATK88"
            ],
            "source_name": "MISPGALAXY:FIN6",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "12517c87-040a-4627-a3df-86ca95e5c13f",
            "created_at": "2022-10-25T16:07:23.61665Z",
            "updated_at": "2025-03-27T02:02:09.889471Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "ATK 88",
                "Camouflage Tempest",
                "FIN6",
                "Gold Franklin",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "TAG-CR2",
                "White Giant"
            ],
            "source_name": "ETDA:FIN6",
            "tools": [
                "AbaddonPOS",
                "Agentemis",
                "AmmyyRAT",
                "Anchor_DNS",
                "BlackPOS",
                "CmdSQL",
                "Cobalt Strike",
                "CobaltStrike",
                "FlawedAmmyy",
                "FrameworkPOS",
                "Grateful POS",
                "JSPSPY",
                "Kaptoxa",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LockerGoga",
                "MMon",
                "Magecart",
                "Meterpreter",
                "Mimikatz",
                "More_eggs",
                "NeverQuest",
                "POSWDS",
                "Reedum",
                "Ryuk",
                "SCRAPMINT",
                "SONE",
                "SpicyOmelette",
                "StealerOne",
                "Taurus Loader Stealer Module",
                "Terra Loader",
                "TerraStealer",
                "Vawtrak",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "cobeacon",
                "grabnew"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b3acfb48-b04d-4d3d-88a8-836d7376fa2e",
            "created_at": "2024-06-19T02:03:08.052814Z",
            "updated_at": "2025-03-27T02:05:17.368029Z",
            "deleted_at": null,
            "main_name": "GOLD FRANKLIN",
            "aliases": [
                "ITG08 ",
                "MageCart Group 6 ",
                "Skeleton Spider ",
                "White Giant ",
                "FIN6 "
            ],
            "source_name": "Secureworks:GOLD FRANKLIN",
            "tools": [
                " Metasploit",
                " Meterpreter",
                " Mimikatz",
                " PowerSploit",
                " PowerUpSQL",
                " RemCom",
                "FrameWorkPOS"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "ea7bfe06-7c23-481d-b8ba-eafa6cda3bc9",
            "created_at": "2022-10-25T15:50:23.317961Z",
            "updated_at": "2025-03-27T02:00:55.440858Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "FIN6",
                "Magecart Group 6",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "Camouflage Tempest"
            ],
            "source_name": "MITRE:FIN6",
            "tools": [
                "FlawedAmmyy",
                "GrimAgent",
                "FrameworkPOS",
                "More_eggs",
                "Cobalt Strike",
                "Windows Credential Editor",
                "AdFind",
                "PsExec",
                "LockerGoga",
                "Ryuk",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536048,
    "ts_updated_at": 1743041713,
    "ts_creation_date": 1653714377,
    "ts_modification_date": 1653714377,
    "files": {
        "pdf": "https://archive.orkl.eu/d1b14e22fed179bbf70592c4840f9f7e553463ac.pdf",
        "text": "https://archive.orkl.eu/d1b14e22fed179bbf70592c4840f9f7e553463ac.txt",
        "img": "https://archive.orkl.eu/d1b14e22fed179bbf70592c4840f9f7e553463ac.jpg"
    }
}