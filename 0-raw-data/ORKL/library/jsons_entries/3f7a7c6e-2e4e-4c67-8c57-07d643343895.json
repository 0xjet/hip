{
    "id": "3f7a7c6e-2e4e-4c67-8c57-07d643343895",
    "created_at": "2023-01-12T15:03:45.627796Z",
    "updated_at": "2025-03-27T02:05:56.043409Z",
    "deleted_at": null,
    "sha1_hash": "2c3e910b77f6ac0b21827b3ee9817fc54745356a",
    "title": "2020-02-26 - Revealing the Trick - A Deep Dive into TrickLoader Obfuscation",
    "authors": "",
    "file_creation_date": "2022-05-28T17:57:38Z",
    "file_modification_date": "2022-05-28T17:57:38Z",
    "file_size": 996929,
    "plain_text": "# Revealing the Trick | A Deep Dive into TrickLoader Obfuscation\n\n**[labs.sentinelone.com/revealing-the-trick-a-deep-dive-into-trickloader-obfuscation/](https://labs.sentinelone.com/revealing-the-trick-a-deep-dive-into-trickloader-obfuscation/)**\n\nJason Reaves\n\nWithin the TrickBot framework, there has historically been a loader component. This loader\nhas had continued development over the years since TrickBot’s first release where the ECS\nkey and bot binary were stored in the resource section of the loader [1]. However, the\nfunction obfuscation has received relatively little treatment until now.\n\n## Executive Summary\n\nTrickBot developers have continued to be active over the years.\nLoader used by TrickBot has had continued development related to obfuscation for\nanti-analysis.\nThe TrickLoader leverages ‘minilzo’ compression, which comes from the LZO library\nand its usage by these developers dates back to Dyre/Upatre timeframe.\nThe goal is to detail the loader and aid additional automation efforts to process the\nTrickLoader.\n\n## Research Insight\n\nTrickLoader obfuscation development timeline:\n\n\n-----\n\n2017 – Started obfuscating the resource section name\n2017 – Custom base64 of strings\n2018 – Adds user account control (UAC) bypass [5], Heaven’s Gate [2], function obfuscation\nand further hiding the configuration\n\nMost of these have been reported on in detail with the exception of the function obfuscation,\nwhich has been mentioned but not really detailed. Researchers who write scripts for config\nretrieval have stopped putting them out as frequently as in the past, possibly due to the\nincreased focus by TrickBot to obfuscate and hide the data.\n\nLet’s dive into the obfuscation. The function offsets are stored in a table. The first thing the\nloader does is execute a call over that table that will push the address of the table onto the\nstack for the next block of code to use.\n\nFigure 1: Call over offset table\nThe next section will then process the word values from the table in sequence by adding\nthem to a value which is initially the start address of the table and then being pushed onto\nthe stack.\n\n\n-----\n\nFigure 2: Overview of rebuilding addresses from table\nReconstructing this process into Python code allows us to create the same table as long as\nwe can recover certain values from the binary.\n\n\n-----\n\nFigure\n\n3: Python code to demonstrate rebuilding the table manually\nAfter the function table is rebuilt, a call is made to one of the functions that is responsible for\ndecoding out the other functions and data blobs.\n\n\n-----\n\nFigure 4: Decode function after rebuilding table\n\nFigure 5: Decode function\n\nThe function decodes the next function. The key is the last value in the rebuilt table address\nwith 0x18 added to it, and the length of the key is 0x327 bytes. Using this we should be able\nto decode out all the addresses in the rebuilt table.\n\n\n-----\n\nFigure 6: Decode all the objects from the table\nAfter decoding all the objects, we can check the sizes of each by printing out the size of\nevery element of the decoded_data list.\n\nFigure 7: Check decoded object sizes\nMost of them look normal; however, there are a few that seem larger than what you would\nnormally observe in the size of a single function.\n\nFigure 8: Compressed objects\nThese larger decoded objects are actually compressed data. It turns out there are at least 3\ncompressed objects: a 32 bit TrickBot binary, a large blob of 64-bit bytecode which is the 64\nbit TrickBot binary, and a smaller 64-bit EXE file which is a loader for the 64-bit bytecode\nblob.\n\nThe compression is ‘minilzo’, which comes from the LZO library, and its usage by these\ndevelopers dates back to Dyre/Upatre timeframe. After decompressing the 32-bit binary and\nfixing the missing ‘MZ’, we have the 32-bit TrickBot binary.\n\n\n-----\n\nNow that we have the normal TrickBot binary, we can decode out the onboard configuration\ndata which is hidden and XOR encoded inside the bot now. Taking an existing decoder from\nCAPE [4] and adjusting it a bit while adding in our deobfuscation works well!\n\n## Indicators of Compromise (IOCs)\n```\nSHA-256: ac27e0944ce794ebbb7e5fb8a851b9b0586b3b674dfa39e196a8cd47e9ee72b2\n\n```\n\n-----\n\n```\n<mcconf>\n<ver>1000480</ver>\n<gtag>tot598</gtag>\n<servs>\n<srv>144.91.79.9:443</srv>\n<srv>172.245.97.148:443</srv>\n<srv>85.204.116.139:443</srv>\n<srv>185.62.188.117:443</srv>\n<srv>185.222.202.76:443</srv>\n<srv>144.91.79.12:443</srv>\n<srv>185.68.93.43:443</srv>\n<srv>195.123.238.191:443</srv>\n<srv>146.185.219.29:443</srv>\n<srv>195.133.196.151:443</srv>\n<srv>91.235.129.60:443</srv>\n<srv>23.227.206.170:443</srv>\n<srv>185.222.202.192:443</srv>\n<srv>190.154.203.218:449</srv>\n<srv>178.183.150.169:449</srv>\n<srv>200.116.199.10:449</srv>\n<srv>187.58.56.26:449</srv>\n<srv>177.103.240.149:449</srv>\n<srv>81.190.160.139:449</srv>\n<srv>200.21.51.38:449</srv>\n<srv>181.49.61.237:449</srv>\n<srv>46.174.235.36:449</srv>\n<srv>36.89.85.103:449</srv>\n<srv>170.233.120.53:449</srv>\n<srv>89.228.243.148:449</srv>\n<srv>31.214.138.207:449</srv>\n<srv>186.42.98.254:449</srv>\n<srv>195.93.223.100:449</srv>\n<srv>181.112.52.26:449</srv>\n<srv>190.13.160.19:449</srv>\n<srv>186.71.150.23:449</srv>\n<srv>190.152.4.98:449</srv>\n<srv>170.82.156.53:449</srv>\n<srv>131.161.253.190:449</srv>\n<srv>200.127.121.99:449</srv>\n<srv>45.235.213.126:449</srv>\n<srv>31.128.13.45:449</srv>\n<srv>181.10.207.234:449</srv>\n<srv>201.187.105.123:449</srv>\n<srv>201.210.120.239:449</srv>\n<srv>190.152.125.22:449</srv>\n<srv>103.69.216.86:449</srv>\n<srv>128.201.174.107:449</srv>\n<srv>101.108.92.111:449</srv>\n<srv>190.111.255.219:449</srv>\n</servs>\n\n```\n\n-----\n\n```\n<autorun>\n<module name=\"systeminfo\" ctl=\"GetSystemInfo\"/>\n<module name=\"pwgrab\"/>\n</autorun>\n</mcconf>\n\n## References\n\n```\n1: [https://www.fidelissecurity.com/threatgeek/archive/trickbot-we-missed-you-dyre/](https://www.fidelissecurity.com/threatgeek/archive/trickbot-we-missed-you-dyre/)\n\n2: [http://www.hexacorn.com/blog/2015/10/26/heavens-gate-and-a-chameleon-code-x8664/](http://www.hexacorn.com/blog/2015/10/26/heavens-gate-and-a-chameleon-code-x8664/)\n\n3: [http://www.oberhumer.com/opensource/lzo/](http://www.oberhumer.com/opensource/lzo/)\n\n4: [https://github.com/ctxis/CAPE](https://github.com/ctxis/CAPE)\n\n5: [https://sysopfb.github.io/malware/2018/04/16/trickbot-uacme.html](https://sysopfb.github.io/malware/2018/04/16/trickbot-uacme.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-26 - Revealing the Trick - A Deep Dive into TrickLoader Obfuscation.pdf"
    ],
    "report_names": [
        "2020-02-26 - Revealing the Trick - A Deep Dive into TrickLoader Obfuscation.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535825,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653760658,
    "ts_modification_date": 1653760658,
    "files": {
        "pdf": "https://archive.orkl.eu/2c3e910b77f6ac0b21827b3ee9817fc54745356a.pdf",
        "text": "https://archive.orkl.eu/2c3e910b77f6ac0b21827b3ee9817fc54745356a.txt",
        "img": "https://archive.orkl.eu/2c3e910b77f6ac0b21827b3ee9817fc54745356a.jpg"
    }
}