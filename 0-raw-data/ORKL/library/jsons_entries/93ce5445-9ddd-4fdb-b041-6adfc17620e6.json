{
    "id": "93ce5445-9ddd-4fdb-b041-6adfc17620e6",
    "created_at": "2023-01-12T15:05:12.060717Z",
    "updated_at": "2025-03-27T02:09:59.176932Z",
    "deleted_at": null,
    "sha1_hash": "e331764df9373626a7a6a9d3bc4bfa56c99a363f",
    "title": "2020-10-01 - Duck Hunting with Falcon Complete- Analyzing a Fowl Banking Trojan, Part 1",
    "authors": "",
    "file_creation_date": "2022-05-27T21:14:22Z",
    "file_modification_date": "2022-05-27T21:14:22Z",
    "file_size": 1805467,
    "plain_text": "# Duck Hunting w/Falcon Complete Pt. 1: QakBot Malware Overview\n\n**[crowdstrike.com/blog/duck-hunting-with-falcon-complete-analyzing-a-fowl-banking-trojan-part-1/](https://www.crowdstrike.com/blog/duck-hunting-with-falcon-complete-analyzing-a-fowl-banking-trojan-part-1/)**\n\nDylan Barker - Quinten Bowen - Ryan Campbell October 1, 2020\n\n[Adversaries constantly develop new tactics that enhance their capabilities to deploy malware](https://www.crowdstrike.com/epp-101/malware/)\nacross networked environments and monetize infected systems. This blog is Part 1 of a threepart series detailing research and observations by the CrowdStrike® Falcon Complete™\nmanaged services team regarding one such malware variant, QakBot (aka QBot), and its\nbehavior in recent campaigns.\n\n[In this blog we provide an overview of a recent QakBot campaign observed in the wild. Part 2](https://www.crowdstrike.com/blog/duck-hunting-with-falcon-complete-qakbot-zip-based-campaign/)\nwill feature an in-depth analysis of the evolution of QakBot tactics, techniques and procedures\n[(TTPs) through June 2020. We will culminate the series in Part 3 by outlining the Falcon](https://www.crowdstrike.com/blog/duck-hunting-with-falcon-complete-qakbot-countermeasures/)\nComplete team’s strategy for the remote remediation of a QakBot-infected host.\n\n## Threat Background and Context\n\nQakBot is an eCrime banking trojan that has the potential to severely impact an organization’s\n[ability to operate. QakBot can spread laterally throughout a network utilizing a worm-like](https://www.crowdstrike.com/epp-101/lateral-movement/)\nfunctionality through brute-forcing network shares and Active Directory user group accounts, or\nvia server message block (SMB) exploitation.\n\n\n-----\n\nQakBot also employs a robust set of anti-analysis features to evade detection and frustrate\nanalysis. Despite these evasion techniques, CrowdStrike Falcon® detects and prevents this\nmalware from completing its execution chain.\n\nQakBot has been observed for nearly a decade, and historically, it included traditional features\nof banking trojans and information stealers. However, it has since evolved and expanded its\ncapabilities.\n\nQakBot also shows no signs of slowing down — in fact, Falcon Complete observed a notable\nresurgence in its delivery volume, beginning in April 2020, with regular updates through the\nsummer months. Recent campaigns have been delivered primarily via email, with attached ZIP\narchives containing a Visual Basic Script (VBS) downloader. In contrast, there have also been\nseveral tactical outliers, such as Microsoft Word DOC-based deliveries along with campaigns\nthat included secondary malware payloads like Zloader.\n\nThe following section covers static and dynamic analysis of the QakBot DOC-based delivery\ncampaign. This analysis includes an overview of techniques used by the threat actor to\nobfuscate, hinder and attempt to prevent analysis of malicious documents delivered by QakBot\nto ensure a successful infection of the victim.\n\nFigure 1. Timeline of QakBot Campaigns (click image to enlarge)\n\n## QakBot Introduces DOC-based Delivery\n\nAs QakBot surged in early April 2020, the operators leveraged a new tactic for delivery: a\nMicrosoft Word document delivered via malspam that was weaponized with macros containing a\nmalicious VB script. While operators shifted delivery tactics several times throughout the\nsummer, the overall TTPs related to QakBot’s execution chain remained largely the same, and\nanalysis of this DOC file provides useful insights into the capabilities of QakBot’s authors\n\n\n-----\n\n### Static Analysis of Downloader DOC\n\n**Document Features**\n\nIn early April, the team observed a document that was detected and blocked within a client\nenvironment.\n\nFilename: AGRMT_06052020_519.doc\nSHA256: b1e8b724380e6e041e3c2b4dfe5d4827fe0ae1bb0816b47d14d21d6f94194797\n\nThis was a typical phishing document that attempts to lure intended victims to enable macros\nthat execute malicious code.\n\nFigure 2. User Prompt (click image to enlarge)\n\nThe malicious macro included in the document is locked — an example of the many antianalysis and sandbox-evasion features included in these campaigns.\n\nFigure 3. Locked Macro Modules (click image to enlarge)\n\nThe locked macros prevent sandboxes from inspecting the macro content and also impede\nmanual analysis. Once this protection is bypassed, the contents of the Visual Basic for\nApplications (VBA) project are then available.\n\n\n-----\n\nFigure 4. Macros Now Accessible\n\n[The macros are highly obfuscated and broken down into either UserForm objects or modules](https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/userform-object)\ncontaining more typical Functions and Subs. The UserForm objects are structured in a variety of\ndifferent text boxes, buttons and label objects that don’t actually execute code themselves, but\nhold string data in their tags that is called by Functions in the macros code.\n\nFigure 5. Modules and Objects (click image to enlarge)\n\n**Macro De-obfuscation**\n\nThe macro contents are extracted to a text editor for continued static analysis and easier deobfuscation. The macros are extensively obfuscated with a variety of anti-analysis techniques.\nThis includes using several lines of garbage code, along with confusing variable assignments,\nstring reversals and an interesting string encoding technique that leverages nested conversions.\n\n\n-----\n\nThe two components of greatest interest are the functions that include an encoding algorithm\nand a block of strings that contain the encoded URLs, from which the code will attempt to\ndownload the next-stage payload.\n\nFigure 6. Encoding Algorithm (click image to enlarge)\n\n[The encoding algorithm leverages the VBA Mid function to perform operations on URL strings.](https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/mid-function)\nThe $Mid function sets the text block, sets the starting position of the text’s index, and then\ninstructs it to select the number of characters (in this case, 1). It is also wrapped in a For Loop\nthat instructs the Function to loop over the length of the string in reverse order. Finally, it\nincludes a series of string conversions following the loop operation. Each character is converted\nto ASCII and then subtracted by a value of 1, then converted back into a character. This new\ncharacter string is actually Base64 encoded and must then be decoded to reveal the actual\nURL.\n\nFigure 7. Obfuscated URLs (click image to enlarge)\n\nFor example, the URLs are decoded by taking the last character in each string, converting it to\nASCII, subtracting by 1 and then looping backward the length of the string. Finally, the Base64\nstring is decoded. The first variable in Figure 9, “dkekr(1),” which holds the string\n\n“o6HdvhEP5hEP5h{M5iHdkS4Mu:3Zv1H[ieIciO4MwpEd1SIb,” decodes into the string\n“aHR0cDovL3NhbHdhZG0uY29tL3RjcGh4Lzg4ODg4ODgucG5n.”\n\n\n-----\n\nFigure 8. Decoded URL (click image to enlarge)\n\nThe VB code contains a total of six URLs that it will loop through until it receives a valid\nresponse to download the next stage payload. It is necessary to break down this obfuscation to\nsuccessfully identify all six of these indicators of compromise (IOCs). If only network log data or\nsandbox results are used, the infection chain may stop at the first valid response and not loop\nthrough all six URLs. The complete list of IOCs may then be implemented in the appropriate\nnetwork control such as a web proxy or firewall.\n\nWhen executed, the final macro code as interpreted by CMD decodes into a classic PowerShell\ndownload cradle that fetches the initial QakBot payload. There is one last bit of obfuscation here\nas the script does contain two more encoded strings. One is the URL as seen above in Figure 8,\nand another is the full path to which the payload will initially be written:\n“C:\\Users\\Public\\tmpdir\\file”.\n\nFigure 9. Download Cradle (click image to enlarge)\n\nThe cradle appends “1.exe” to the file named “file” and eventually writes itself to\n“C:\\Users\\Public” before continuing with the remainder of the execution chain if the appropriate\nanti-analysis checks are met. The execution chain for this delivery style is shown below in\nFigure 10. Please note that the examples in the following scenarios have CrowdStrike Falcon\nconfigured with DETECTIONS ONLY and PREVENTIONS OFF for illustrative purposes. A\nproperly configured Falcon instance would prevent the activity presented here.\n\n\n-----\n\nFigure 10. Process Tree as Displayed in Falcon (click image to enlarge)\n\nThe Falcon Complete team frequently responds to detections where Falcon has prevented a\nsuccessful QakBot phishing attempt. In these cases that have proper implementation of\npreventions, the remediation simply consists of removing the original attachment written to the\ndisk and any associated residual script artifacts. In these cases, Falcon interrupts the infection\nbefore binaries are executed or persistence is established.\n\n## Conclusion\n\nQakBot has the potential to severely impact an organization due to its capability for lateral\nmovement and data theft. As we have seen, QakBot employs a robust set of anti-analysis\nfeatures and has recently surged in its operational volume within the threat landscape.\n\nIn this blog, we presented an analysis of a DOC-based QakBot downloader. The threat actors\nbehind QakBot, tracked by CrowdStrike Intelligence as MALLARD SPIDER, have demonstrated\nthe ability to rapidly re-tool, implement anti-analysis techniques and develop methods of\nadvanced obfuscation in a short period.\n\nStay tuned for Parts 2 and 3 where we delve deeper into our analysis and offer\nrecommendations for improving your defenses against QakBot and similar threats.\n\nAs QakBot evolves, so does the Falcon Complete team’s ability to adapt, react to and remediate\nthis threat to protect our client environments. The team provides the expertise to identify and\nremediate infections to help organizations recover from potentially devastating incidents. The\nFalcon Complete team focuses on stopping breaches so CrowdStrike clients can focus on their\nbusiness goals and operations.\n\n## Appendix\n\n\n-----\n\nTable 1 below contains a mapping of QakBot tactics to the MITRE ATT&CK® framework.\n\n**Tactic** **Technique** **Sub-Technique** **ID**\n\n\nInitial Access [Phishing](https://www.crowdstrike.com/epp-101/what-is-phishing/) Spear-Phishing\nAttachment\n\nExecution User Execution Malicious Link, Malicious\nFile\n\n\n[T1566.001](https://attack.mitre.org/techniques/T1566/001/)\n\n[T1204.001,](https://attack.mitre.org/techniques/T1204/001) [T1204.002](https://attack.mitre.org/techniques/T1204/002)\n\n[T1059.001,](https://attack.mitre.org/techniques/T1059/001) [T1059.003,](https://attack.mitre.org/techniques/T1059/003)\n[T1059.005](https://attack.mitre.org/techniques/T1059/005)\n\n\nExecution Command and\nScripting Interpreter\n\nExecution Signed Binary Proxy\nExecution\n\nPersistence Boot or Logon\nAutostart Execution\n\n\nPowerShell, CMD Shell,\nVisual Basic\n\n\nRegistry Run Keys /\nStartup Folder\n\n\nMsiexec, Rundll32 [T1218.007,](https://attack.mitre.org/techniques/T1218/007/) [T1218.011](https://attack.mitre.org/techniques/T1218/011/)\n\n\n[T1547.001](https://attack.mitre.org/techniques/T1547/001)\n\n\nPersistence Scheduled Task/Job Scheduled Task [T1053.005](https://attack.mitre.org/techniques/T1053/005)\n\n\nDefense\nEvasion\n\nDefense\nEvasion\n\nDefense\nEvasion\n\n\nObfuscated Files or\nInformation\n\n\nVirtualization/Sandbox\nEvasion\n\n\nNone [T1027](https://attack.mitre.org/techniques/T1027/)\n\n\nProcess Injection Dynamic-link Library\nInjection\n\n\n[T1055.001](https://attack.mitre.org/techniques/T1055/001)\n\n\nSystem Checks [T1497.001](https://attack.mitre.org/techniques/T1497/001)\n\n\nDiscovery Virtualization/Sandbox\nEvasion\n\nDiscovery Network Share\nDiscovery\n\n\nUser Activity Based\nChecks\n\n\n[T1497.002](https://attack.mitre.org/techniques/T1497/002/)\n\n\nNone [T1135](https://attack.mitre.org/techniques/T1135/)\n\n\nCredential\nAccess\n\nLateral\nMovement\n\nCommand and\nControl\n\n\nBrute Force Password Guessing [T1110.001](https://attack.mitre.org/techniques/T1110/001/)\n\n\nApplication Layer\nProtocol\n\n\nRemote Services SMB/Windows Admin\nShares\n\n\n[T1021.002](https://attack.mitre.org/techniques/T1021/002/)\n\n\nWeb Protocols [T1071.001](https://attack.mitre.org/techniques/T1071/001/)\n\n\nTable 1. MITRE ATT&CK Mapping\n\nIOCs associated with QakBot analyses are shown in Table 2.\n\n**Indicator** **Purpose**\n\n\nPicturesViewer.dll, PicturesViewer.exe, PaintHelper.dll, PaintHelper.exe,\nfile1.exe\n\n\nQakBot binary\nnames\n\n\n-----\n\n“[0-9]{6,9}\\.zip”, “NUM_[0-9]{4,6}\\.vbs” Regular\nexpression of\nobserved\nfilename\nconvention of\nzip archives\ncontaining vbs\nto that\nlaunches\nQakBot\ndownloader\n\n“dfPEZd”, “ezQVN”, “wCdZgXH” Scheduled\nTask\ntasknames\n\n\n“””C:\\windows\\System32\\WScript.exe””\n“”C:\\Users\\*\\AppData\\Local\\Temp\\Temp1_*.zip\\NUM_*.vbs””\n\n\nCommand line\nexample of\ninitial\nexecution\n\n\nC:\\Users\\*\\Downloads\\“[0-9]{6,9}\\.zip” Initial QakBot\ndownload path.\nObserved as\nan 8 or 9character\nnumeric\nname.\n\nC:\\Users\\*\\AppData\\Local\\Temp\\Temp1_“[0-9]{6,9}\\.zip\\NUM_[0-9]{4,6}\\.vbs Execution path\nof VB\ndownloader\nscript\n\n\n%AppData%\\lwob\\esexydry.dll\n%AppData%\\PicturesViewer.dll\n\n%APPDATA%\\dasfdsfsdf.exe\n\n%APPDATA%\\Iwhoq\\pozypua.dll\n\n%APPDATA%\\IE\\GGYJG27Z\\dasfdsfs.df[1].exe\n\nC:\\Users\\Public\\tmpdir\n\n\nQakBot binary\npaths in home\ndirectories,\nobserved as an\nalphabetical\nname under an\nalphabetical\nfolder in\n%AppData%,\nor pre-named\nPicturesViewer,\nPaintHelper\n\n\nHKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run Registry run\nkey\npersistence\n\nTable 2. IOCs Associated with QakBot\n\n\n-----\n\n**Additional Resources**\n\nRead [Part 2 and](https://www.crowdstrike.com/blog/duck-hunting-with-falcon-complete-qakbot-zip-based-campaign/) [Part 3 of the Duck Hunting with Falcon Complete blog series.](https://www.crowdstrike.com/blog/duck-hunting-with-falcon-complete-qakbot-countermeasures/)\n_Find out how CrowdStrike can help your organization answer its most important security_\n_questions:_ _[Visit the CrowdStrike Services webpage.](https://www.crowdstrike.com/services/)_\n_Learn how any size organization can achieve optimal security with Falcon Complete by_\n_visiting the product webpage._\n_[Learn more about Falcon X™ threat intelligence by visiting the webpage.](https://www.crowdstrike.com/endpoint-security-products/falcon-x-threat-intelligence/)_\n_Learn about CrowdStrike’s comprehensive next-gen endpoint protection platform by_\n_visiting_ _[the Falcon products webpage.](https://www.crowdstrike.com/endpoint-security-products/)_\n_Test CrowdStrike next-gen AV for yourself:_ _[Start your free trial of Falcon Prevent™.](https://go.crowdstrike.com/try-falcon-prevent.html)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-10-01 - Duck Hunting with Falcon Complete- Analyzing a Fowl Banking Trojan, Part 1.pdf"
    ],
    "report_names": [
        "2020-10-01 - Duck Hunting with Falcon Complete- Analyzing a Fowl Banking Trojan, Part 1.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa5b200f-a6c6-4d17-bc65-911d9a7bf4ef",
            "created_at": "2022-10-25T16:07:23.866039Z",
            "updated_at": "2025-03-27T02:02:10.002227Z",
            "deleted_at": null,
            "main_name": "Mallard Spider",
            "aliases": [
                "Gold Lagoon"
            ],
            "source_name": "ETDA:Mallard Spider",
            "tools": [
                "Egregor",
                "Mimikatz",
                "Oakboat",
                "PinkSlip",
                "Pinkslipbot",
                "ProLock",
                "PwndLocker",
                "QakBot",
                "Qbot",
                "QuackBot",
                "QuakBot"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d5cb8d20-b5b9-4ec6-9660-3dded9bd3c89",
            "created_at": "2023-01-06T13:46:39.204681Z",
            "updated_at": "2025-03-27T02:00:03.020862Z",
            "deleted_at": null,
            "main_name": "MALLARD SPIDER",
            "aliases": [
                "GOLD LAGOON"
            ],
            "source_name": "MISPGALAXY:MALLARD SPIDER",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535912,
    "ts_updated_at": 1743041399,
    "ts_creation_date": 1653686062,
    "ts_modification_date": 1653686062,
    "files": {
        "pdf": "https://archive.orkl.eu/e331764df9373626a7a6a9d3bc4bfa56c99a363f.pdf",
        "text": "https://archive.orkl.eu/e331764df9373626a7a6a9d3bc4bfa56c99a363f.txt",
        "img": "https://archive.orkl.eu/e331764df9373626a7a6a9d3bc4bfa56c99a363f.jpg"
    }
}