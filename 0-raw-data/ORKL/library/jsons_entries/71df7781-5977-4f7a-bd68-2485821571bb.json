{
    "id": "71df7781-5977-4f7a-bd68-2485821571bb",
    "created_at": "2023-01-12T15:02:22.803541Z",
    "updated_at": "2025-03-27T02:12:03.952535Z",
    "deleted_at": null,
    "sha1_hash": "f95efa761324056067bd4c7886f2af42ee86556c",
    "title": "2022-04-12 - Tarrask malware uses scheduled tasks for defense evasion",
    "authors": "",
    "file_creation_date": "2022-05-27T23:12:48Z",
    "file_modification_date": "2022-05-27T23:12:48Z",
    "file_size": 985842,
    "plain_text": "# Tarrask malware uses scheduled tasks for defense evasion\n\n**[microsoft.com/security/blog/2022/04/12/tarrask-malware-uses-scheduled-tasks-for-defense-evasion/](https://www.microsoft.com/security/blog/2022/04/12/tarrask-malware-uses-scheduled-tasks-for-defense-evasion/)**\n\nApril 12, 2022\n\n[As Microsoft continues to track the high-priority state-sponsored threat actor HAFNIUM, new activity has been](https://blogs.microsoft.com/on-the-issues/2021/03/02/new-nation-state-cyberattacks/)\nuncovered that leverages unpatched zero-day vulnerabilities as initial vectors. The Microsoft Detection and Response\nTeam (DART) in collaboration with the Microsoft Threat Intelligence Center (MSTIC) identified a multi-stage attack\ntargeting the Zoho Manage Engine Rest API authentication bypass vulnerability to initially implant a Godzilla web shell\n[with similar properties detailed by the Unit42 team in a previous blog.](https://unit42.paloaltonetworks.com/manageengine-godzilla-nglite-kdcsponge/)\n\nMicrosoft observed HAFNIUM from August 2021 to February 2022, target those in the telecommunication, internet\nservice provider and data services sector, expanding on targeted sectors observed from their earlier operations\n[conducted in Spring 2021.](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)\n\nFurther investigation reveals forensic artifacts of the usage of Impacket tooling for lateral movement and execution and\nthe discovery of a defense evasion malware called Tarrask that creates “hidden” scheduled tasks, and subsequent\nactions to remove the task attributes, to conceal the scheduled tasks from traditional means of identification.\n\nThe blog outlines the simplicity of the malware technique Tarrask uses, while highlighting that scheduled task abuse is a\nvery common method of persistence and defense evasion—and an enticing one, at that. In this post, we will\ndemonstrate how threat actors create scheduled tasks, how they cover their tracks, how the malware’s evasion\ntechniques are used to maintain and ensure persistence on systems, and how to protect against this tactic.\n\n## Right on schedule: Maintaining persistence via scheduled tasks\n\nWindows Task Scheduler is a service that allows users to perform automated tasks (scheduled tasks) on a chosen\ncomputer for legitimate administrative purposes (e.g., scheduled updates for browsers and other applications).\n\nThroughout the course of our research, we’ve found that threat actors commonly make use of this service to maintain\npersistence within a Windows environment.\n\nWe’ve noted that the Tarrask malware generates several artifacts upon the creation of a scheduled task, whether using\nthe Task Scheduler GUI or the [schtasks command line utility. Profiling the use of either of these tools can aid](https://docs.microsoft.com/windows-server/administration/windows-commands/schtasks)\ninvestigators in tracking this persistence mechanism.\n\n\n-----\n\nThe following registry keys are created upon creation of a new task:\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\TASK_NAME\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\\n**{GUID}**\n\nFigure\n\n1. Tarrask malware creates new registry keys along with the creation of new scheduled tasks\nThe first subkey, created within the Tree path, matches the name of the scheduled task. The values created within it (Id,\nIndex, and SD) contain metadata for task registration within the system. The second subkey, created within the Tasks\npath, is a GUID mapping to the Id value found in the Tree key. The values created within (Actions, Path, Triggers, etc.)\ncontain the basic parameters necessary to facilitate execution of the task.\n\nTo demonstrate the value in the artifacts generated, shown in the following figures, we have created “My Special Task”\nwhich is set to execute the binary “C:\\Windows\\System32\\calc.exe” on a regular interval.\n\n\n-----\n\nFigure\n\n2. XML file matches name of the task\nSimilar information is also stored within an extensionless XML file created within C:\\Windows\\System32\\Tasks, where\nthe name of the file matches the name of the task. This is displayed in Figure 2, where we name the task “My Special\nTask” as an example.\n\n\n-----\n\nFigure\n\n3. Extensionless XML file\nNote that the “Actions” value stored within the Tasks\\{GUID} key points to the command line associated with the task. In\nFigure 2, there is a reference to “C:\\Windows\\System32\\calc.exe” within the “Edit Binary Value” dialog, and there is a\npath referenced within the “<Command>” section in the extensionless XML file in Figure 3. The fact that this value is\nstored within two different locations can prove useful in recovering information regarding the task’s purpose in the event\nthe threat actor has taken steps to cover their tracks.\n\nFinally, there are two Windows event logs that record actions related to the creation and operation of Scheduled Tasks –\nEvent ID 4698 within the Security.evtx log, and the Microsoft-Windows-TaskScheduler/Operational.evtx log.\n\nNeither of these are audited by default and must be explicitly turned on by an administrator. Microsoft-WindowsTaskScheduler/Maintenance.evtx will exist by default, but only contains maintenance-related information for the Task\nScheduler engine.\n\n\n-----\n\n## Effectively hiding scheduled tasks\n\nIn this scenario, the threat actor created a scheduled task named “WinUpdate” via HackTool:Win64/Tarrask in order to\nre-establish any dropped connections to their command and control (C&C) infrastructure. This resulted in the creation of\nthe registry keys and values described in the earlier section, however, the threat actor deleted the SD value within the\nTree registry path.\n\nFigure\n\n4. Deletion of the security descriptor (SD) value\nIn this context, SD refers to the Security Descriptor, which determines the users allowed to run the task. Interestingly,\nremoval of this value results in the task “disappearing” from “schtasks /query” and Task Scheduler. The task is\neffectively hidden unless an examiner manually inspects the aforementioned registry paths.\n\nIssuing a “reg delete” command to delete the SD value will result in an “Access Denied” error even when run from an\nelevated command prompt. Deletion must occur within the context of the SYSTEM user. It is for this reason that the\nTarrask malware utilized token theft to obtain the security permissions associated with the lsass.exe process. Upon\nexecution of the token theft, the malware could operate with the same privileges as LSASS, making the deletion\npossible.\n\nFigure\n\n5. Successful deletion of SD in Command Prompt\nIt is also important to note that the threat actor could have chosen to completely remove the two registry keys within\nTree and Tasks, and the XML file created within C:\\Windows\\System32\\Tasks. This would effectively remove the on-disk\nartifacts associated with the scheduled task, but the task would continue to run according to the defined triggers until the\nsystem rebooted, or until the associated svchost.exe process responsible for executing the task was terminated.\n\nIt’s possible the threat actor wanted to ensure persistence across reboots and therefore chose not to perform those\nsteps, instead deleting only the SD value; however, we also speculate that the threat actor was unaware that the task\nwould continue to run even after these components were removed.\n\n## Recommendations and cyber resilience guidance\n\nJob or task schedulers are services that have been present in the Windows operating system for many years. The\nattacks we described signify how the threat actor HAFNIUM displays a unique understanding of the Windows\nsubsystem and uses this expertise to mask activities on targeted endpoints to maintain persistence on affected systems\nand hide in plain sight.\n\nAs such, we recognize that scheduled tasks are an effective tool for adversaries to automate certain tasks while\nachieving persistence, which brings us to raising awareness about this oft-overlooked technique. We also want to bring\nattention to the fact that threat actors may utilize this method of evasion to maintain access to high value targets in a\n\n\n-----\n\nmanner that will likely remain undetected. This could be especially problematic for systems that are infrequently\nrebooted (e.g., critical systems such as domain controllers, database servers, etc.).\n\nThe techniques used by the actor and described in this post can be mitigated or detected by adopting the following\nrecommendations and security guidelines :1\n\nEnumerate your Windows environment registry hives looking in the\n_HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree registry_\nhive and identify any scheduled tasks without SD (security descriptor) Value within the Task Key. Perform analysis\non these tasks as needed.\nModify your audit policy to identify Scheduled Tasks actions by enabling logging “TaskOperational” within\n[Microsoft-Windows-TaskScheduler/Operational. Apply the recommended Microsoft audit policy settings suitable to](https://docs.microsoft.com/windows-server/identity/ad-ds/plan/security-best-practices/audit-policy-recommendations)\nyour environment.\nEnable and centralize the following Task Scheduler logs. Even if the tasks are ‘hidden’, these logs track key\nevents relating to them that could lead you to discovering a well-hidden persistence mechanism\n\nEvent ID 4698 within the Security.evtx log\nMicrosoft-Windows-TaskScheduler/Operational.evtx log\nThe threat actors in this campaign used hidden scheduled tasks to maintain access to critical assets exposed to\nthe internet by regularly re-establishing outbound communications with C&C infrastructure. Remain vigilant and\nmonitor uncommon behavior of your outbound communications by ensuring that monitoring and alerting for these\n[connections from these critical Tier 0 and Tier 1 assets is in place.](https://docs.microsoft.com/security/compass/privileged-access-access-model?msclkid=cd775d3ba56111eca958db4059cdf03d)\n\n## Indicators of compromise (IOCs)\n\nThe following list provides IOCs observed during our investigation. We encourage customers to investigate these\nindicators in their environments and implement detections and protections to identify past related activity and prevent\nfuture attacks against their systems.\n\n**SHA256** **File Name** **Details**\n\n\n54660bd327c9b9d60a5b45cc59477c75b4a8e2266d988da8ed9956bcc95e6795 winupdate.exe, date.exe,\nwin.exe\n\na3baacffb7c74dc43bd4624a6abcd1c311e70a46b40dcc695b180556a9aa3bb2 windowsvc.exe, winsrv.exe,\nWinSvc.exe, ScriptRun.exe,\nUnique.exe, ngcsvc.exe,\nligolo_windows_amd64.exe,\nproxy.zip, wshqos.exe,\ncert.exe, ldaputility.exe\n\n\nTarrask\n\nLigolo\n\n\n7e0f350864fb919917914b380da8d9b218139f61ab5e9b28b41ab94c2477b16d CertCert.jsp, Cert0365.jsp Godzilla\nweb\nshell\n\n## Microsoft 365 Defender Detections\n\nHow customers can identify this in Microsoft 365 Defender:\n\n### Microsoft Defender Antivirus\n\nMicrosoft Defender for Endpoint on detects implants and components as the following:\n\nHackTool:Win64/Tarrask!MSR\nHackTool:Win64/Ligolo!MSR\n\nMicrosoft Defender for Endpoint detects malicious behavior observed as the following:\n\nBehavior:Win32/ScheduledTaskHide.A\n\n\n-----\n\n## Microsoft Sentinel Detections\n\nMicrosoft Sentinel customers can use the following detection queries to look for this activity:\n\n[Tarrask malware hash IOC: This query identifies a hash match related to Tarrask malware across various data](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/TarraskHashIoC.yaml)\nsources.\n[Scheduled Task Hide: This query uses Windows Security Events to detect attempts by malware to hide the](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityEvent/ScheduleTaskHide.yaml)\nscheduled task by deleting the SD (Security Descriptor) value. Removal of SD value results in the scheduled task\n“disappearing” from “schtasks /query” and Task Scheduler.\n[Microsoft Defender AV Hits: This query looks for Microsoft Defender AV detections related to Tarrask malware](https://github.com/Azure/Azure-Sentinel/blob/master/Detections/SecurityAlert/AVTarrask.yaml)\nusing SecurityAlerts table. In Microsoft Sentinel the SecurityAlerts table includes only the Device Name of the\naffected device, this query joins the DeviceInfo table to clearly connect other information such as Device group, IP,\nlogged on users etc. This way, the Microsoft Sentinel user can have all the pertinent device info in one view for the\nalerts.\n\n1 The technical information contained in this article is provided for general informational and educational purposes only\n\nand is not a substitute for professional advice. Accordingly, before taking any action based upon such information, we\nencourage you to consult with the appropriate professionals. We do not provide any kind of guarantee of a certain\noutcome or result based on the information provided. Therefore, the use or reliance of any information contained in this\narticle is solely at your own risk.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-12 - Tarrask malware uses scheduled tasks for defense evasion.pdf"
    ],
    "report_names": [
        "2022-04-12 - Tarrask malware uses scheduled tasks for defense evasion.pdf"
    ],
    "threat_actors": [
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535742,
    "ts_updated_at": 1743041523,
    "ts_creation_date": 1653693168,
    "ts_modification_date": 1653693168,
    "files": {
        "pdf": "https://archive.orkl.eu/f95efa761324056067bd4c7886f2af42ee86556c.pdf",
        "text": "https://archive.orkl.eu/f95efa761324056067bd4c7886f2af42ee86556c.txt",
        "img": "https://archive.orkl.eu/f95efa761324056067bd4c7886f2af42ee86556c.jpg"
    }
}