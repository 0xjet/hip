{
    "id": "8238aad1-928c-4243-b0f8-48efbadd54ba",
    "created_at": "2023-01-12T15:07:37.887957Z",
    "updated_at": "2025-03-27T02:13:58.350994Z",
    "deleted_at": null,
    "sha1_hash": "1b74d1ba653966364b8d4b0e1d0d4370e78aef72",
    "title": "2021-10-18 - Case Study- From BazarLoader to Network Reconnaissance",
    "authors": "",
    "file_creation_date": "2022-05-28T00:22:49Z",
    "file_modification_date": "2022-05-28T00:22:49Z",
    "file_size": 3490030,
    "plain_text": "# Case Study: From BazarLoader to Network Reconnaissance\n\n**[unit42.paloaltonetworks.com/bazarloader-network-reconnaissance/](https://unit42.paloaltonetworks.com/bazarloader-network-reconnaissance/)**\n\nBrad Duncan October 18, 2021\n\nBy [Brad Duncan](https://unit42.paloaltonetworks.com/author/bduncan/)\n\nOctober 18, 2021 at 6:00 AM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit-42/)\n\nTags: [BazaLoader,](https://unit42.paloaltonetworks.com/tag/bazaloader/) [BazarLoader,](https://unit42.paloaltonetworks.com/tag/bazarloader/) [Cobalt Strike,](https://unit42.paloaltonetworks.com/tag/cobalt-strike/) [CobaltStrike macros](https://unit42.paloaltonetworks.com/tag/cobaltstrike-macros/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/case-study-from-bazarloader-to-network-reconnaissance/)\n\n## Executive Summary\n\nBazarLoader is Windows-based malware spread through various methods involving email.\nThese infections provide backdoor access that criminals use to determine whether the host\nis part of an Active Directory (AD) environment. If so, criminals deploy Cobalt Strike and\nperform reconnaissance to map the network. If the results indicate a high-value target,\ncriminals attempt lateral movement and will often deploy ransomware like Conti or Ryuk.\n\nThis blog reviews a recent BazarLoader infection, how it led to Cobalt Strike, and how Cobalt\nStrike led to network reconnaissance. If you discover similar activity within your network, you\ncould be a target for ransomware\n\n\n-----\n\nOrganizations with decent spam filtering, proper system administration and up-to-date\nWindows hosts have a much lower risk of infection. Palo Alto Networks customers are further\nprotected from this threat. Our [Threat Prevention security subscription for the Next-](https://www.paloaltonetworks.com/products/secure-the-network/subscriptions/threat-prevention)\nGeneration Firewall detects the BazarLoader sample from this infection and similar samples.\n[Endpoint detection like Cortex XDR can prevent Cobalt Strike activity and criminal access to](https://www.paloaltonetworks.com/cortex/10-must-have-for-detection-and-response-forbes)\nyour network.\n\n## Distribution Methods for BazarLoader\n\nDuring summer 2021, different campaigns distributed BazarLoader malware using emails.\nFrom late July through mid-August 2021, the majority of BazarLoader samples were spread\nthrough three campaigns.\n\nThe [BazarCall campaign pushed BazarLoader using emails for initial contact and call centers](https://unit42.paloaltonetworks.com/bazarloader-malware/)\nto guide potential victims to infect their computers. By early July, a copyright violation-themed\ncampaign using ZIP archives named Stolen Images Evidence.zip also began pushing\n[BazarLoader. By late July, a long-running campaign known as TA551 (Shathak) started](https://attack.mitre.org/groups/G0127/)\n[pushing BazarLoader through English-language emails.](https://isc.sans.edu/forums/diary/TA551+Shathak+continues+pushing+BazarLoader+infections+lead+to+Cobalt+Strike/27738/)\n\nIn addition to those three major campaigns, we discovered at least one example of\nBazarLoader distributed through an Excel spreadsheet of undetermined origin. Our case\nstudy reviews an infection generated using this example on Aug. 19, 2021.\n\nFigure 1. Chain of events from BazarLoader infection on Aug. 19, 2021.\n\n## Malicious Excel Spreadsheet\n\n\n-----\n\nThe malicious Excel spreadsheet was discovered on Wednesday, Aug. 18, 2021, and it has\na last modified date of Tuesday, Aug. 17. The filename had an .xlsb file extension. This file\nhas macros designed to infect a vulnerable Windows host with BazarLoader. Figure 2 shows\na screenshot of the Excel file.\n\nThough the DocuSign logo appears in Figure 2, this Excel template was created by a threat\nactor trying to instill confidence by taking advantage of the DocuSign brand name and image.\nVarious threat actors use this and other DocuSign-themed images on a near-daily basis.\nDocuSign is aware of this ongoing threat and provides guidelines on how to handle these\ntypes of malicious files.\n\nFigure 2. Screenshot of the malicious Excel spreadsheet.\nAfter enabling malicious macros on a vulnerable Windows host, the spreadsheet presented a\nnew tab for a page with fake invoice information, as shown below in Figure 3.\n\n\n-----\n\nFigure 3. Excel spreadsheet presented a fake invoice after enabling macros.\nAs it presented the fake invoice page, the spreadsheet’s macro code had already retrieved a\nmalicious binary for BazarLoader.\n\n## BazarLoader Binary\n\nThe spreadsheet’s macro code retrieved a malicious Dynamic Link Library (DLL) file for\nBazarLoader from the following URL:\n\nhxxps://pawevi[.]com/lch5.dll\n\nAs shown below in Figure 4, the DLL was saved to the victim’s home directory at C:\\Users\\\n\n[username]\\tru.dll. It ran using regsvr32.exe.\n\nFigure 4. BazarLoader DLL saved to the infected user’s home directory.\n\n\n-----\n\nThe BazarLoader DLL was immediately copied to another location and made persistent\nthrough the Windows registry, as shown below in Figure 5.\n\nFigure 5. Location and Windows registry update for persistent BazarLoader DLL.\nAs seen in Figure 5, the filename changed from tru.dll to kibuyuink.exe, even though it\nremained a DLL and still required regsvr32.exe to run. Changing the filename extension is a\ncommon tactic seen in various malware infections.\n\n## Bazar C2 Traffic\n\nThis example of BazarLoader generated command and control (C2) activity, retrieving\nBazarBackdoor using HTTPS traffic from 104.248.174[.]225 over TCP port 443. Then\nBazarBackdoor generated C2 activity using HTTPS traffic to 104.248.166[.]170 over TCP\nport 443. In Figure 6, we refer to this combined C2 activity as Bazar C2 traffic.\n\n\n-----\n\nFigure 6. Traffic from the infection filtered in Wireshark.\nThis example of Bazar C2 activity generates traffic to legitimate domains. This activity is not\ninherently malicious on its own. Various malware families generate similar traffic as a\nconnectivity check or to ensure an infected Windows host has continued internet access.\n\n## Cobalt Strike Activity\n\nApproximately 41 minutes after the initial BazarLoader infection, our infected Windows host\nstarted generating Cobalt Strike activity using HTTPS traffic to gojihu[.]com and yuxicu[.]com,\nas shown below in Figure 7.\n\n\n-----\n\nFigure 7. Wireshark showing when the Cobalt Strike activity began.\nIn this case, a Cobalt Strike DLL file was sent through Bazar C2 traffic and saved to the\ninfected Windows host under the user’s AppData\\Roaming directory. Figure 8 shows the\nCobalt Strike DLL running on the infected machine.\n\nFigure 8. Cobalt Strike activity shown in Process Hacker.\n\n\n-----\n\nCobalt Strike leads to reconnaissance of an infected host s environment. In our lab\nenvironments, this reconnaissance activity can start within a few minutes after Cobalt Strike\ntraffic first appears.\n\n## Reconnaissance Activity\n\nIn our case study, approximately two minutes after Cobalt Strike activity started, a tool to\nenumerate an AD environment appeared on the infected host at\nC:\\ProgramData\\AdFind.exe. This tool has been used by criminal groups to gather\ninformation from an AD environment. AdFind is a command line tool, and an associated\nbatch file was used to run the tool in our case study.\n\nFigure 9 shows the location of AdFind, the associated batch file adf.bat and the results of its\nsearch saved in seven text files.\n\nFigure 9. AdFind.exe, the batch file and search results saved to text files.\nFigure 10 shows commands used in the adf.bat file that run AdFind.exe.\n\nFigure 10. Commands used for AdFind.exe.\n\n\n-----\n\nThese commands reveal the users, computers, file shares and other information from a\ntargeted AD environment.\n\nOur example did not involve a high-value target, and the environment was wiped within two\nor three hours after the initial infection. In this example, no follow-up ransomware was sent\nafter the reconnaissance.\n\n## Conclusion\n\nThis case study reveals one example of an initial malware infection moving to Cobalt Strike,\nfollowed by reconnaissance activity. When attackers use Cobalt Strike, they can also perform\nother types of reconnaissance in an AD environment.\n\nIf the AD environment is a high-value target, the attacker’s next step is lateral movement and\ngaining access to the domain controller and other servers within the network.\n\nThis is a common pattern seen before attackers hit an organization with ransomware.\n\nOrganizations with decent spam filtering, proper system administration and up-to-date\nWindows hosts have a much lower risk of infection. Palo Alto Networks customers are further\nprotected from this threat. Our Threat Prevention security subscription for the NextGeneration Firewall detects this and similar BazarLoader samples. Endpoint detection like\n[Cortex XDR can prevent Cobalt Strike activity and criminal access to your network.](https://www.paloaltonetworks.com/cortex/10-must-have-for-detection-and-response-forbes)\n\nPalo Alto Networks has shared these findings, including file samples and indicators of\ncompromise, with our fellow Cyber Threat Alliance members. CTA members use this\nintelligence to rapidly deploy protections to their customers and to systematically disrupt\n[malicious cyber actors. Learn more about the Cyber Threat Alliance.](http://www.cyberthreatalliance.org/)\n\n### Indicators of Compromise\n\nExcel file with macros for BazarLoader, SHA256 hash:\n\n8662d511c7f1bef3a6e4f6d72965760345b57ddf0de5d3e6eae4e610216a39c1\n\nFile size: 332,087 bytes\n\nFile name: Documents new.xlsb\n\nMalicious DLL for BazarLoader retrieved by above Excel macro, SHA256 hash:\ncaa03c25583ea24f566c2800986def73ca13458da6f9e888658f393d1d340ba1\n\nFile size: 459,776 bytes\n\nOnline location: hxxps://pawevi[.]com/lch5.dll\n\nInitial saved location: C:\\Users\\[username]\\tru.dll\n\nFinal location: C:\\Users\\[username]\\AppData\\Local\\Temp\\Damp\\kibuyuink.exe\n\nRun method: regsvr32.exe /s [filename]\n\n\n-----\n\nMalicious DLL for Cobalt Strike, SHA256 hash:\n73b9d1f8e2234ef0902fca1b2427cbef756f2725f288f19edbdedf03c4cadab0\nFile size: 443,904 bytes\nFile location: C:\\Users\\[username]\\AppData\\Roaming\\nubqabmlkp.iowd\nRun method: rundll32.exe [filename],Entrypoint\n\nADfind command-line tool for enumerating AD environment, SHA256 hash:\nb1102ed4bca6dae6f2f498ade2f73f76af527fa803f0e0b46e100d4cf5150682\nFile size: 1,394,176 bytes\nFile location: C:\\ProgramData\\AdFind.exe\n\nBatch file to run ADfind, SHA256 hash:\n1e7737a57552b0b32356f5e54dd84a9ae85bb3acff05ef5d52aabaa996282dfb\nFile size: 385 bytes\nFile location: C:\\ProgramData\\adf.bat\n\nContents of adf.bat:\n\nadfind.exe -f \"(objectcategory=person)\" > ad_users.txt\nadfind.exe -f \"objectcategory=computer\" > ad_computers.txt\nadfind.exe -f \"(objectcategory=organizationalUnit)\" > ad_ous.txt\nadfind.exe -sc trustdmp > trustdmp.txt\nadfind.exe -subnets -f (objectCategory=subnet)> subnets.txt\nadfind.exe -f \"(objectcategory=group)\" > ad_group.txt\nadfind.exe -gcb -sc trustdmp > trustdmp.txt\n\n### Additional Resources\n\n[BazarCall Method: Call Centers Help Spread BazarLoader Malware – Unit 42, Palo Alto](https://unit42.paloaltonetworks.com/bazarloader-malware/)\nNetworks\n\n[TA551 BazarLoader to Cobalt Strike – Internet Storm Center](https://isc.sans.edu/forums/diary/TA551+Shathak+continues+pushing+BazarLoader+infections+lead+to+Cobalt+Strike/27738/)\n\n[“Stolen Images Evidence” BazarLoader to Cobalt Strike – @Unit42_Intel](https://twitter.com/Unit42_Intel/status/1424829355704922114)\n\n[“Stolen Images Evidence”](https://twitter.com/Unit42_Intel/status/1424829355704922114) [BazarLoader to Cobalt Strike – malware-traffic-analysis.net](https://www.malware-traffic-analysis.net/2021/08/12/index.html)\n\n[Stolen Images Evidence” BazarLoader to Cobalt Strike to PrintNightmare – @Unit42_Intel](https://twitter.com/Unit42_Intel/status/1421117403644186629/photo/1)\n\n[BazarLoader to Cobalt Strike – @Unit42_Intel](https://twitter.com/Unit42_Intel/status/1379875382699167752)\n\n[BazarLoader to Cobalt Strike to Anchor malware – Internet Storm Center](https://isc.sans.edu/forums/diary/April+2021+Forensic+Quiz+Answers+and+Analysis/27308/)\n\n[TA551 BazarLoader to Cobalt Strike – malware-traffic-analysis.net](https://www.malware-traffic-analysis.net/2021/07/21/index.html)\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n\n-----\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-18 - Case Study- From BazarLoader to Network Reconnaissance.pdf"
    ],
    "report_names": [
        "2021-10-18 - Case Study- From BazarLoader to Network Reconnaissance.pdf"
    ],
    "threat_actors": [
        {
            "id": "26a04131-2b8c-4e5d-8f38-5c58b86f5e7f",
            "created_at": "2022-10-25T15:50:23.579601Z",
            "updated_at": "2025-03-27T02:00:55.50292Z",
            "deleted_at": null,
            "main_name": "TA551",
            "aliases": [
                "TA551",
                "GOLD CABIN",
                "Shathak"
            ],
            "source_name": "MITRE:TA551",
            "tools": [
                "QakBot",
                "IcedID",
                "Valak",
                "Ursnif"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "04e34cab-3ee4-4f06-a6f6-5cdd7eccfd68",
            "created_at": "2022-10-25T16:07:24.578896Z",
            "updated_at": "2025-03-27T02:02:10.286803Z",
            "deleted_at": null,
            "main_name": "TA551",
            "aliases": [
                "Gold Cabin",
                "Monster Libra",
                "Shathak",
                "TA551"
            ],
            "source_name": "ETDA:TA551",
            "tools": [
                "BokBot",
                "CRM",
                "Gozi",
                "Gozi CRM",
                "IceID",
                "IcedID",
                "Papras",
                "Snifula",
                "Ursnif",
                "Valak",
                "Valek"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "90f216f2-4897-46fc-bb76-3acae9d112ca",
            "created_at": "2023-01-06T13:46:39.248936Z",
            "updated_at": "2025-03-27T02:00:03.031127Z",
            "deleted_at": null,
            "main_name": "GOLD CABIN",
            "aliases": [
                "Shakthak",
                "TA551",
                "ATK236",
                "G0127",
                "Monster Libra"
            ],
            "source_name": "MISPGALAXY:GOLD CABIN",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d1f8bd4e-bcd4-4101-9158-6158f1806b38",
            "created_at": "2023-01-06T13:46:39.487358Z",
            "updated_at": "2025-03-27T02:00:03.107568Z",
            "deleted_at": null,
            "main_name": "BazarCall",
            "aliases": [
                "BazaCall",
                "BazzarCall"
            ],
            "source_name": "MISPGALAXY:BazarCall",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "40b623c7-b621-48db-b55b-dd4f6746fbc6",
            "created_at": "2024-06-19T02:03:08.017681Z",
            "updated_at": "2025-03-27T02:05:17.342829Z",
            "deleted_at": null,
            "main_name": "GOLD CABIN",
            "aliases": [
                "TA551 ",
                "Shathak"
            ],
            "source_name": "Secureworks:GOLD CABIN",
            "tools": [
                ""
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536057,
    "ts_updated_at": 1743041638,
    "ts_creation_date": 1653697369,
    "ts_modification_date": 1653697369,
    "files": {
        "pdf": "https://archive.orkl.eu/1b74d1ba653966364b8d4b0e1d0d4370e78aef72.pdf",
        "text": "https://archive.orkl.eu/1b74d1ba653966364b8d4b0e1d0d4370e78aef72.txt",
        "img": "https://archive.orkl.eu/1b74d1ba653966364b8d4b0e1d0d4370e78aef72.jpg"
    }
}