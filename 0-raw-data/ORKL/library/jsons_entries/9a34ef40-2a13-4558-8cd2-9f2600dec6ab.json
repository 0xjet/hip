{
    "id": "9a34ef40-2a13-4558-8cd2-9f2600dec6ab",
    "created_at": "2023-01-12T15:08:32.280234Z",
    "updated_at": "2025-03-27T02:05:27.090027Z",
    "deleted_at": null,
    "sha1_hash": "81692294d1e510e8306071079be64218877b6202",
    "title": "2020-06-28 - Interesting tactic by Ratty & Adwind for distribution of JAR appended to signed MSI",
    "authors": "",
    "file_creation_date": "2022-05-28T19:20:44Z",
    "file_modification_date": "2022-05-28T19:20:44Z",
    "file_size": 1160139,
    "plain_text": "# Interesting tactic by Ratty & Adwind for distribution of JAR appended to signed MSI â€“ CVE-2020-1464\n\n**[securityinbits.com/malware-analysis/interesting-tactic-by-ratty-adwind-distribution-of-jar-appended-to-signed-msi/](https://www.securityinbits.com/malware-analysis/interesting-tactic-by-ratty-adwind-distribution-of-jar-appended-to-signed-msi/)**\n\nJune 28, 2020\n\nThis article discusses an interesting tactic actively used by different Java RAT malware\nauthors like Ratty & Adwind to distribute malicious JAR appended to signed MSI files. This\ntechnique was discovered by VT Team in Aug 2018[9] but that time it was not used by\nmalware authors to distribute malicious JAR files. Thanks to EKTracker tweet[1], where I\nfound this interesting Ratty hashes using this technique.\n\n\nOur goal is to understand the unique technique instead of analysing the Java RAT.\n\n[1/ Interesting technique used by #Ratty sample for distribution of malicious JAR(zip)](https://twitter.com/hashtag/Ratty?src=hash&ref_src=twsrc%5Etfw)\nappended to MSI\n\nSo when the OS sees jar ext it executes jre to handle the file, but unique about zip files\nare read from bottom to top so jar is executed instead of msi file, details below\n[https://t.co/3u7487kUZy](https://t.co/3u7487kUZy) [pic.twitter.com/jZw9s07X5z](https://t.co/jZw9s07X5z)\n\n[â€” Securityinbits (@Securityinbits) June 12, 2020](https://twitter.com/Securityinbits/status/1271406138588708866?ref_src=twsrc%5Etfw)\n\n\n-----\n\n## CONTENTS\n\n 1. Overview of ZIP, JAR & MSI file format\n\nBefore we discuss the technique we need to understand some concepts regarding ZIP, JAR\nand Windows Installer MSI files. If you already know this, please skip to the next section.\n\nZIP\n\nPE files are read from top to bottom but ZIP files are read from bottom to top due to their\ndesign. Some more details from Wikipedia[2]\n\nA directory is placed at the end of a ZIP file. This identifies what files are in the ZIP and\nidentifies where in the ZIP that file is located. This allows ZIP readers to load the list of\nfiles without reading the entire ZIP archive. A ZIP file is correctly identified by the\npresence of an end of central directory record(EOCD) which is located at the end of\nthe archive structure in order to allow the easy appending of new files.\n\n\nZip format from Wikipedia [2]\n\nJAR\n\nJAR files follow the zip format. Some more details from Wikipedia\n\n\n\n[3]\n\n\nA JAR (Java ARchive) is a package file format typically used to aggregate many Java\nclass files and associated metadata and resources (text, images, etc.) into one file for\ndistribution.\n\nJAR files are archive files that include a Java-specific manifest file. They are built on\nthe ZIP format and typically have a .jar file extension.\n\nMSI or Windows Installer\n\n\n-----\n\nMSI file follows Compound File/Composite Document File V2 Document/Object Linking and\nEmbedding (OLE). A compound file is a structure that is used to store a hierarchy of storage\nobjects and stream objects into a single file or memory buffer. oletools and oledump can be\nused to browse the structure of MSI files[5]. We will not go in so much detail of OLE file.\n\n## 2. How does it work?\n\nMalware author takes two files, one is a clean digital signed MSI file let say with filename\n**_clean_signed.msi and other is malicious JAVA RAT malware filename malicious.jar._**\n\n\n-----\n\nMalicious JAR appended to signed MSI\n\n**Steps:**\n\n1. Malware author select a clean clean_signed.msi MSI file which is digitally code\n\nsigned from Microsoft, Google etc. So maybe security control will not not scan the file\ndue to itâ€™s digital signature. The OS reads the file from top to bottom and see the digital\nsignature, so everything is good till now.\n\n\n-----\n\n2. Other malicious.jar is essentially a zip file which is read from bottom to top as\n\ndiscussed above.\n3. On Microsoft Windows systems, the Java Runtime Environmentâ€™s installation program\n\nwill register a default association for JAR files so that double-clicking a JAR file on the\ndesktop will automatically run it.\n4. Now, attackers just need to append the jar file to the MSI file and change the extension\n\nto jar.\n5. Attackers can use this command `copy /b clean_signed.msi + malicious.jar`\n```\n   signed_malicious.jar to generate malicious signed file.\n\n```\n6. When the user executes the `signed_malicious.jar, it will execute the malicious jar`\n\nfile as itâ€™s read from bottom to top.\n\nWhy is digital signature still valid?\n\nAfter the attacker creates the signed_malicious.jar the digital signature is still valid due to the\n[reason mentioned in the VirusTotal blog post.](https://blog.virustotal.com/2019/01/distribution-of-malicious-jar-appended.html)\n\nCode signing is the method of using a certificate-based digital signature to sign\nexecutables and scripts in order to verify the authorâ€™s identity and ensure that the code\nhas not been changed or corrupted since it was signed by the author. This way, for\nexample, if you modify the content or append any data to a signed Windows PE (.EXE)\nfile the signature of the resulting file will not be valid for Microsoft Windows, as\nexpected. This behaviour changes when you append any data to the end of a signed\nWindows Installer (.MSI), the resulting file will pass the verification process of Microsoft\nWindows and will show just the original signature as valid without any other warning.\n\n## 3. Analysis of JAR appended to signed MSI files using Ratty RAT\n\n\nWe will analyse this Ratty 06-01-20.jar (MD5: 13a4072d8d0eba59712bb4ec251e0593)\nbut the same process is applicable for the Adwind sample.\n\n\n\n[10]\n\n\n1. Letâ€™s start with checking the magic byte or file header of this file using file cmd and xxd.\nPlease feel free to use any other hex viewer.\n\n\n-----\n\nMSI header using file and xxd for Ratty\n\nBased on the extension jar this file should have magic bytes for zip but the above figure\nshows the standard MSI file header with magic bytes D0 CF 11 E0 A1 B1 1A E1.\n\n_grade_\n\nNote: This anomaly for extension not matching header is a good indicator to detect this and\nother kinds of attack.\n\n2. Now if you check the digital signature using properties it looks ok.\n\n\n-----\n\nRatty Digital Signature\n\nSigcheck on Ratty\n\nBut using Sigcheck will say â€œSigned but the filesize is invalid (the file is too large)â€œ. This\nis another good detection point.\n\n3. Investigating further using binwalk on this 06-01-20.jar file you will see it matches\ndifferent zip signatures starting from offset 0xc600 as shown in the figure below.\n\n\n-----\n\nbinwalk Ratty output\n\nBased on the output, you can easily guess there is a JAR appended to this MSI file.\n\n4. If you dump some bytes at offset using xxd you will see a zip header.\n\n```\nxxd -s 0xc600 -l 0x100 06-01-20.jar\n\n```\n\nHexdump at 0xc600\n\n5. Letâ€™s extract the JAR file from offset 0xc600 then use [Bytecode Viewer to analyze the jar](https://bytecodeviewer.com/)\nfile. I am using dd for this but you can use any hex editor.\n\n\n-----\n\n```\ndd skip=0xc600 if=06-01-20.jar of=extracted_ratty.jar bs=1\n\n```\n[If you are new to Java reversing or Bytecode Viewer, you may want to check](https://bytecodeviewer.com/)\nthis [Pyrogenic/Qealler Infostealer static analysis â€“ Part 0x1.](https://www.securityinbits.com/malware-analysis/pyrogenic-infostealer-static-analysis-part-0x1/)\n\ndd cmd for extracting Ratty jar\n\n6. The extracted file is not packed so if you open the extracted_ratty.jar in Bytecode Viewer,\nyou can see the decompiled Java Code.\n\nBased on the package and folder structure this extracted_ratty.jar is based on this GitHub\nRatty repo. I will not dig any further in this Ratty malware and decompiled Java code can be\neasily analysed.\n\nDecompiled Ratty Code & Github repo\n\n## 4. Timeline\n\n\n-----\n\nThis technique was discovered by VirusTotal team\n\n\n\n[ ]\n\n\nVirusTotal posted a blog post[6] about this technique and mentioned that itâ€™s not being used\nmassively to distribute malware.\n\nThere were two other notable blog posts[7] [8] discussing VirusTotal blog.\n\nAll three blog posts gives a great explanation of this technique.\n\nMalware author started using this technique for distribution of malicious Java RATs like\nAdwind and Ratty.\n\nAt last, Microsoft decided to fix this [CVE-2020-1464 | Windows Spoofing Vulnerability. I](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1464)\nsuspect as malware authors started using this old bug which was discovered in Aug 2018, so\nMicrosoft decided to fix it.\n\n**Aug 2018**\n\n\nThis technique was discovered by VirusTotal team\n\n**Jan 2019**\n\n\n\n[9]\n\n\nVirusTotal posted a blog post[6] about this technique and mentioned that itâ€™s not being used\nmassively to distribute malware.\n\nThere were two other notable blog posts[7] [8] discussing VirusTotal blog.\n\nAll three blog posts gives a great explanation of this technique.\n\n**May-Jun 2020**\n\nMalware author started using this technique for distribution of malicious Java RATs like\nAdwind and Ratty.\n\n**Aug 2020**\n\nAt last, Microsoft decided to fix this [CVE-2020-1464 | Windows Spoofing Vulnerability. I](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1464)\nsuspect as malware authors started using this old bug which was discovered in Aug 2018, so\nMicrosoft decided to fix it.\n\n## 5. Conclusion\n\nWhen I saw this interesting technique, I was puzzled.Hopefully, I have explained this\ntechnique detailed enough in this post.\n\nDetection\n\n\n-----\n\nAnomaly for extension not matching header is a good indicator to detect this technique\nand below yara rule can be used.\nCheck Sigcheck output â€œSigned but the filesize is invalid (the file is too large)â€ for\ndigital signed files\nAV may detect this suspicious behaviour of malicious JAR\n\nSharing Yara signature to detect this technique and IoCs below.\n\n**Update 17 Aug, 2020**\n\nMicrosoft fixed this [CVE-2020-1464 (Windows Spoofing Vulnerability) as malware](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1464)\nauthors started actively exploiting this old bug which was discovered in Aug 2018. If\nyou are interested to also learn about technical analysis about GlueBall CVE-20201464, please check out the awesome article [13] by @TalBeerySec.\nBrian Krebs posted an article [14] about this CVE-2020-1464 (GlueBall).\n\n\n## 6. Yara Signature\n\nNote: I havenâ€™t checked this yara signature on a clean set of files so it may cause FP.\n\n## 7. Indicator of Compromise(IOCs)\n\nMD5\n\n**Ratty**\n```\n13a4072d8d0eba59712bb4ec251e0593 -> This hash analysed in this post\n63bed40e369b76379b47818ba912ee43\nfa8118a9fa20a17018cb2f60fd28a5b7\n4a3d69c28c4742177d6238bc16486f0d\n48a5714147ee85374ab74174a82ab77a\n\n```\n**Adwind**\n```\n85eb931d0d27179ae7c13085fb050b11\n\n```\nThanks to [@c_APT_ure for sharing following hashes related to this technique](https://twitter.com/c_APT_ure)\n\nRatty\n```\n800fbf461f13facf4799e96f5026fd47 shipment.label.jar\nf3ea296ad35eec33ea436febd97ff0e2 Shipment-label.jar\n80908e5e21c3aff7e8bcaccdbb99e02e 21-04-2020.jar\n83aaba8a3cd871441d2c386aaa3ee0e0 TrackingOrder.jar\nc50b8615b8d6613f92586224b15bc9ac tracking.update.jar\n1eb30fec5a58dc7a6af2c17d7e8327d0 ups-label.jar\n85e8e4e814c29ce8779772fca4df64d7 21-05-2020.jar\na49c0e0d1ca8a829a8175a3931e5cba1 a49c0e0d1ca8a829a8175a3931e5cba1.jar\n4a2d5424f87d1d4cdcd8a9bea81d2e2a shipment.delivery.label.06-03.jar\n\n```\n\n-----\n\nAdwind, Thanks to [@c_APT_ure for sharing the hashes](https://twitter.com/c_APT_ure)\n```\n0559defe2122020a2733fafbd6443fd6 2.jar\n7239fb81b1771e2aa38edbe0b68e40d5 CONFIRMATION_SWIFT.pdf.jar\n\n```\n[Hope you enjoyed this post, please Follow @Securityinbits me on Twitter to get the latest](https://twitter.com/Securityinbits?ref_src=twsrc%5Etfw)\nupdate about my malware analysis & DFIR journey. Happy Reversing ðŸ˜Š\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-28 - Interesting tactic by Ratty & Adwind for distribution of JAR appended to signed MSI.pdf"
    ],
    "report_names": [
        "2020-06-28 - Interesting tactic by Ratty & Adwind for distribution of JAR appended to signed MSI.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536112,
    "ts_updated_at": 1743041127,
    "ts_creation_date": 1653765644,
    "ts_modification_date": 1653765644,
    "files": {
        "pdf": "https://archive.orkl.eu/81692294d1e510e8306071079be64218877b6202.pdf",
        "text": "https://archive.orkl.eu/81692294d1e510e8306071079be64218877b6202.txt",
        "img": "https://archive.orkl.eu/81692294d1e510e8306071079be64218877b6202.jpg"
    }
}