{
    "id": "0143f65b-e271-4899-9676-3f983597baf9",
    "created_at": "2023-01-12T14:59:28.262589Z",
    "updated_at": "2025-03-27T02:14:04.107099Z",
    "deleted_at": null,
    "sha1_hash": "c7f241b321dded308f49ebcb3028c2f4ed00061e",
    "title": "2020-11-06 - Quick Post- Spooky New PowerShell Obfuscation in Emotet Maldocs",
    "authors": "",
    "file_creation_date": "2022-05-27T22:12:26Z",
    "file_modification_date": "2022-05-27T22:12:26Z",
    "file_size": 409287,
    "plain_text": "# Quick Post: Spooky New PowerShell Obfuscation in Emotet Maldocs\n\n**[security-soup.net/quick-post-spooky-new-powershell-obfuscation-in-emotet-maldocs/](https://security-soup.net/quick-post-spooky-new-powershell-obfuscation-in-emotet-maldocs/)**\n\nadmin November 6, 2020\n\n[Emotet is a modular malware delivery platform that has consistently dominated the](https://malpedia.caad.fkie.fraunhofer.de/details/win.emotet)\ncommodity malware threat landscape over the past couple of years. It has evolved from a\nstraightforward banking trojan into a full-fledged malware distribution service, delivering a\nvariety of payloads for other threat actor groups. The U.S. Department of Homeland\nSecurity [states that Emotet infections cost state and local governments up to $1 million to](https://www.us-cert.gov/ncas/alerts/TA18-201A)\n[remediate. Emotet is operated by the threat group tracked as Mummy Spider.](https://www.crowdstrike.com/blog/meet-crowdstrikes-adversary-of-the-month-for-february-mummy-spider/)\n\nEmotet is commonly delivered in phishing campaigns via a macro-enabled Word document. I\nrecently had a newer Emotet maldoc, come across my desk. The part that interested my\nabout this document was that the PowerShell obfuscation scheme had changed significantly\n\n\n-----\n\nfor the first time in a few months. I thought it would be worthwhile to write a quick post with a\n[few details about this new PowerShell script and provide a handy CyberChef recipe so that](https://gchq.github.io/CyberChef/)\nanalysts and responders could quickly decode these PowerShell Scripts.\n\nI won’t dig as deep as I usually do here as Brad Duncan has already done a nice writeup on\nthis campaign over at the SANS ISC blog. If readers are interested in seeing more details\n[regarding dynamic analysis, I highly recommend checking it out here.](https://isc.sans.edu/forums/diary/Emotet+Qakbot+more+Emotet/26750/)\n\nThe overall infection chain in this case remains pretty much the same: a malicious Word\ndocument that is weaponized with macros is opened, which invokes a WMI process call that\nspawns a PowerShell script. That script attempts to download the core binary from a septet\nof URL resources.\n\n## The Document\n\nThis document was related to the spam runs from 10/29/20 and leveraged a Halloween\nParty-themed social engineering lure.\n\nfilename: Party Invitation.doc\nSHA256: ed51269c3602786ff6ddef3a808d8178d26e4e5960f4ac7af765e4bd642128dd\n\n[I pulled the document down from VirusTotal. These campaigns still appear to using the](https://www.virustotal.com/gui/file/ed51269c3602786ff6ddef3a808d8178d26e4e5960f4ac7af765e4bd642128dd/detection)\n“upgrade your edition of Microsoft Word” template in order to induce the victim into enabling\nmacros. Much more about related campaigns is available thanks to the incredible work of the\n[Cryptolaemus team here.](https://paste.cryptolaemus.com/emotet/2020/10/29/emotet-malware-IoCs_10-29-20.html)\n\nEmotet doc downloader template\nThe PowerShell script that is executed when macros are enabled is base64 encoded per\nusual. Peeling back the first layer of obfuscation reveals the following:\n\n\n-----\n\nThe URLs that are hosting the next stage payload, which is the Emotet loader are\nobfuscated with a string replacement operation. This is slightly more complex that in the\nrecent techniques, but still leverages an empty string replacement for ‘[]w’ and ‘ jjkgS []’,\nwhile a character replacement is used to swap ‘][ 1’ for the slash ‘/’ character. At that point,\nan analyst would just need to split the the string at the “@” delimeter, use a regular\nexpression to isolate URL patterns, and then defang for sharing.\n```\nhxxps[://]enjoymylifecheryl[.]com/wp-includes/FPNxoUiCz3/\nhxxps[://]homewatchamelia[.]com/wp-admin/qmK/\nhxxps[://]seramporemunicipality[.]org/replacement-vin/Ql4R/\nhxxps[://]imperfectdream[.]com/wp-content/xb2csjPW6/\nhxxps[://]mayxaycafe[.]net/wp-includes/UxdWFzYQj/\nhxxps[://]420extracts[.]ca/cgi-bin/Ecv/\nhxxps[://]casinopalacett[.]com/wp-admin/voZDArg/\n\n```\n[Here is the code for the recipe in Chef format, which I also have on my GitHub:](https://github.com/Sec-Soup/CyberChef-Recipes/blob/master/Emotet-Recipe_20201029)\n```\nFrom_Base64('A-Za-z0-9+/=',true)\nRemove_null_bytes()\nFind_/_Replace({'option':'Simple string','string':'+'},'',true,false,true,false)\nFind_/_Replace({'option':'Simple string','string':'('},'',true,false,true,false)\nFind_/_Replace({'option':'Simple string','string':')'},'',true,false,true,false)\nFind_/_Replace({'option':'Simple string','string':'\\''},'',true,false,true,false)\nFind_/_Replace({'option':'Simple string','string':'[]w'},'',true,false,true,false)\nFind_/_Replace({'option':'Simple string','string':' jjkgS\n[]'},'',true,false,true,false)\nFind_/_Replace({'option':'Simple string','string':'][ 1'},'/',true,false,true,false)\nSplit('@','\\\\n')\nRemove_whitespace(true,false,false,false,false,false)\nRegular_expression('URL','([A-Za-z]+://)([-\\\\w]+(?:\\\\.\\\\w[-\\\\w]*)+)(:\\\\d+)?(/[^.!,?\"\n<>\\\\[\\\\]{}\\\\s\\\\x7F-\\\\xFF]*(?:[.!,?]+[^.!,?\"<>\\\\[\\\\]{}\\\\s\\\\x7F\\\\xFF]+)*)?',true,true,false,false,false,false,'List matches')\nDefang URL(true,true,true,'Valid domains and full URLs')\n\n```\n\n-----\n\nThis [Direct Link has the recipe already preloaded in CyberChef.](https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true)Remove_null_bytes()Find_/_Replace(%7B'option':'Simple%20string','string':'%2B'%7D,'',true,false,true,false)Find_/_Replace(%7B'option':'Simple%20string','string':'('%7D,'',true,false,true,false)Find_/_Replace(%7B'option':'Simple%20string','string':')'%7D,'',true,false,true,false)Find_/_Replace(%7B'option':'Simple%20string','string':'%5C''%7D,'',true,false,true,false)Find_/_Replace(%7B'option':'Simple%20string','string':'%5B%5Dw'%7D,'',true,false,true,false)Find_/_Replace(%7B'option':'Simple%20string','string':'%20jjkgS%20%5B%5D'%7D,'',true,false,true,false)Find_/_Replace(%7B'option':'Simple%20string','string':'%5D%5B%201'%7D,'/',true,false,true,false)Split('@','%5C%5Cn')Remove_whitespace(true,false,false,false,false,false)Regular_expression('URL','(%5BA-Za-z%5D%2B://)(%5B-%5C%5Cw%5D%2B(?:%5C%5C.%5C%5Cw%5B-%5C%5Cw%5D*)%2B)(:%5C%5Cd%2B)?(/%5B%5E.!,?%22%3C%3E%5C%5C%5B%5C%5C%5D%7B%7D%5C%5Cs%5C%5Cx7F-%5C%5CxFF%5D*(?:%5B.!,?%5D%2B%5B%5E.!,?%22%3C%3E%5C%5C%5B%5C%5C%5D%7B%7D%5C%5Cs%5C%5Cx7F-%5C%5CxFF%5D%2B)*)?',true,true,false,false,false,false,'List%20matches')Defang_URL(true,true,true,'Valid%20domains%20and%20full%20URLs'))\n\n## Summary\n\nSo that’s it. Just a quick look at some new PowerShell obfuscation used by Mummy Spider in\nrecent campaigns. These tactics used to change quite frequently but the cadence of updates\nhas slowed considerably as of late. As always, CyberChef is my preferred tool for deobfuscating these scripts to quickly extract the network indicators of compromise in order to\nincrease velocity during and Incident Response investigation.\n\n## References\n```\nhttps://malpedia.caad.fkie.fraunhofer.de/details/win.emotet\nhttps://www.us-cert.gov/ncas/alerts/TA18-201A\nhttps://www.crowdstrike.com/blog/meet-crowdstrikes-adversary-of-the-month-forfebruary-mummy-spider/\nhttps://gchq.github.io/CyberChef/\nhttps://isc.sans.edu/forums/diary/Emotet+Qakbot+more+Emotet/26750/\nhttps://www.virustotal.com/gui/file/ed51269c3602786ff6ddef3a808d8178d26e4e5960f4ac7af7\nhttps://paste.cryptolaemus.com/emotet/2020/10/29/emotet-malware-IoCs_10-29-20.html\nhttps://github.com/Sec-Soup/CyberChef-Recipes/blob/master/Emotet-Recipe_20200826\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-06 - Quick Post- Spooky New PowerShell Obfuscation in Emotet Maldocs.pdf"
    ],
    "report_names": [
        "2020-11-06 - Quick Post- Spooky New PowerShell Obfuscation in Emotet Maldocs.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e8e18067-f64b-4e54-9493-6d450b7d40df",
            "created_at": "2022-10-25T16:07:24.515213Z",
            "updated_at": "2025-03-27T02:02:10.267637Z",
            "deleted_at": null,
            "main_name": "Mummy Spider",
            "aliases": [
                "ATK 104",
                "Gold Crestwood",
                "Mummy Spider",
                "TA542"
            ],
            "source_name": "ETDA:Mummy Spider",
            "tools": [
                "Emotet",
                "Geodo",
                "Heodo"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "506404b2-82fb-4b7e-b40d-57c2e9b59f40",
            "created_at": "2023-01-06T13:46:38.870883Z",
            "updated_at": "2025-03-27T02:00:02.939775Z",
            "deleted_at": null,
            "main_name": "MUMMY SPIDER",
            "aliases": [
                "TA542",
                "GOLD CRESTWOOD"
            ],
            "source_name": "MISPGALAXY:MUMMY SPIDER",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2ac83159-1d9d-4db4-a176-97be6b7b07c9",
            "created_at": "2024-06-19T02:03:08.024653Z",
            "updated_at": "2025-03-27T02:05:17.348806Z",
            "deleted_at": null,
            "main_name": "GOLD CRESTWOOD",
            "aliases": [
                "TA542 ",
                "Mummy Spider "
            ],
            "source_name": "Secureworks:GOLD CRESTWOOD",
            "tools": [
                "Emotet"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535568,
    "ts_updated_at": 1743041644,
    "ts_creation_date": 1653689546,
    "ts_modification_date": 1653689546,
    "files": {
        "pdf": "https://archive.orkl.eu/c7f241b321dded308f49ebcb3028c2f4ed00061e.pdf",
        "text": "https://archive.orkl.eu/c7f241b321dded308f49ebcb3028c2f4ed00061e.txt",
        "img": "https://archive.orkl.eu/c7f241b321dded308f49ebcb3028c2f4ed00061e.jpg"
    }
}