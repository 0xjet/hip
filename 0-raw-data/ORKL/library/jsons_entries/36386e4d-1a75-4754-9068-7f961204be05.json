{
    "id": "36386e4d-1a75-4754-9068-7f961204be05",
    "created_at": "2023-01-12T15:02:33.075111Z",
    "updated_at": "2025-03-27T02:09:18.769291Z",
    "deleted_at": null,
    "sha1_hash": "7973249b22ac531c82245e92abc7c303a56e13a9",
    "title": "2021-10-07 - SquirrelWaffle- New Malware Loader Delivering Cobalt Strike and QakBot",
    "authors": "",
    "file_creation_date": "2022-05-28T17:12:57Z",
    "file_modification_date": "2022-05-28T17:12:57Z",
    "file_size": 1219297,
    "plain_text": "# SquirrelWaffle: New Malware Loader Delivering Cobalt Strike and QakBot\n\n**[netskope.com/blog/squirrelwaffle-new-malware-loader-delivering-cobalt-strike-and-qakbot](https://www.netskope.com/blog/squirrelwaffle-new-malware-loader-delivering-cobalt-strike-and-qakbot)**\n\nGustavo Palazolo October 7, 2021\n\n[Co-authored by Gustavo Palazolo and Ghanashyam Satpathy](https://www.netskope.com/blog/author/gsatpathy)\n\n## Summary\n\n[In September of 2021, a new malware family named SquirrelWaffle joined the threat](https://malpedia.caad.fkie.fraunhofer.de/details/win.squirrelwaffle)\n[landscape. It spread through malicious Microsoft Office documents attached in spam emails.](https://www.malware-traffic-analysis.net/2021/09/17/index.html)\n\nThe infection flow starts with a ZIP file that contains the malicious Office document. When the\nfile is opened by the victim, the malicious VBA macros download SquirrelWaffle DLL, which\n[eventually leads to deploying another threat, such as](https://www.malware-traffic-analysis.net/2021/09/24/index.html) [CobaltStrike or](https://malpedia.caad.fkie.fraunhofer.de/details/win.cobalt_strike) [QakBot.](https://malpedia.caad.fkie.fraunhofer.de/details/win.qakbot)\n\nIn this blog post, we will analyze two variants of the malicious Office documents that deliver\nSquirrelWaffle. We will also analyze the final SquirrelWaffle payload and how the last stage\nURLs are being protected inside the binary.\n\n## SquirrelWaffle Office Documents\n\nWe have identified two variants used to deliver SquirrelWaffle, a Microsoft Word document\nand a Microsoft Excel spreadsheet.\n\n\n-----\n\nSquirrelWaffle malicious documents\n\n### Malicious Word Document\n\nThe first variant is a malicious Microsoft Word file that mimics a DocuSign document, asking\nthe victim to click “Enable Editing” and “Enable Content” to view the content.\n\nSquirrelWaffle malicious Word document\nThe file contains several VBA macros, including junk code. The main routine lies in a function\nnamed “eFile”, which is executed by the “AutoOpen” functionality.\n\nMalicious VBA function\n\n\n-----\n\nAside from all the junk added by the developer, we can see two important pieces of data\nwhen we open the VBA editor: a PowerShell script and a batch script that executes the\nPowerShell script.\n\nThese routines are kept inside the text property of Visual Basic Control instead of in a regular\nVBA module. The purpose is to evade AV detection.\n\nMalicious code inside the Word file\nLooking at the “eFile” function, we can see that both PowerShell and the batch script are\ncreated in the user’s AppData directory, respectively named “www.ps1” and “www.txt”.\n\n\n-----\n\npayloads in disk\nThis behavior can be observed with Procmon.\n\n\nVBA function creating\n\nVBA function dropping payloads\n\n\nin disk.\nLater, the VBA code executes the batch script, using the Windows “cscript.exe” binary.\n\nMalicious batch script executed by the malicious document.\nLooking at those files closely, we can see that the PowerShell script is responsible for\ndownloading SquirrelWaffle DLL using five distinct URLs, likely to add more resilience to the\nprocess.\n\nThe downloaded DLLs are saved into “C:\\ProgramData\\” and named “www[N].dll” where [N]\nis a number from 1 to 5.\n\n\n-----\n\nPowerShell script that downloads SquirrelWaffle DLL.\nAnd the batch script, which is executed by the malicious document, is responsible for\nexecuting the PowerShell script and the SquirrelWaffe payload DLL.\n\nBatch script that is\n\nexecuted by the malicious document.\nOnce downloaded, the DLL is executed through “rundll32.exe”, which calls an exported\nfunction named “ldr”.\n\n\n-----\n\nBoth **cscript.exe and** **rundll32.exe are legitimate files from Windows, used by this sample**\nto connect to the C&C servers and to download and execute the next stage payloads. This\ntechnique is known as Living-off-the-Land (LoL), which consists of using legitimate binaries to\nperform malicious activities. We have already covered other malware families that employ\n[this technique, such as BazarLoader.](https://www.netskope.com/blog/bazarloader-using-lolbins-through-office-documents-to-deliver-payloads)\n\nBatch script executing SquirrelWaffle DLL.\n\n### Malicious Excel Document\n\nThe second variant identified by Netskope is a malicious Microsoft Excel file, containing a\nfake message that also tries to deceive the victim into clicking the “Enable Editing” and\n“Enable Content” buttons.\n\nMalicious Microsoft Excel document, delivering SquirrelWaffle.\nThe file uses Excel 4.0 (XML) macros that are obfuscated and spread across many hidden\nsheets in the document.\n\n\n-----\n\nHidden sheets inside the malicious Excel file.\n\nThe developer also changed the font color to hide the code, which can be revealed when we\nchange the font property as shown below.\n\nHidden code inside the hidden sheet.\nWhen the Macros are executed, the obfuscated code is written into seven different cells,\ncontaining many calls to Windows APIs.\n\nMalicious code inside the malicious Excel document.\nSimply put, this code contacts three different URLs to download SquirrelWaffle DLL, which is\nsaved into “C:\\Datop\\test[N].test”, where [N] is null or a number (1 and 2). The DLL is then\n[executed through Windows “ShellExecuteA” API.](https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea)\n\n\n-----\n\n## SquirrelWaffle DLL\n\nRegardless of the variants we described, the goal is to download and execute SquirrelWaffle\n[DLL. In this section, we will analyze a payload identified on September 17, 2021, named](https://www.malware-traffic-analysis.net/2021/09/17/index.html)\n“www2.dll”.\n\nThe file uses a custom packer to hide the main payload. The unpacking process is not very\ncomplex: The first step the code does is load and execute a shellcode.\n\nSquirrelWaffle packer loading a shellcode in memory.\n[Once running, the shellcode unpacks the payload compressed with aPlib, which is commonly](https://ibsensoftware.com/products_aPLib.html)\n[used by malware to compress files or configurations. The data is then decompressed into a](https://www.netskope.com/blog/netskope-threat-coverage-blackmatter)\nnew memory location, and the unpacked DLL is eventually executed.\n\nSquirrelWaffle payload DLL being decompressed.\nOnce unpacked and decompressed, we can dump the bytes into the disk to analyze the file\nin a disassembler. The payload is a 32-bit DLL likely compiled on September 17, 2021,\nalthough this information can’t be 100% reliable.\n\n\n-----\n\nUnpacked SquirrelWaffle DLL.\nLooking at the DLL exports, we can see the function (“ldr”) that is called by the batch script\nwe’ve shown earlier in this post.\n\nSquirrelWaffle “ldr” export function.\n\nThe main goal of SquirrelWaffle is to download and execute additional malware. The\ndevelopers included a feature that hides important strings in the binary, like the C2 server\nlist.\n\nBy looking at the PE “.rdata” section, we can find the encrypted information, along with the\ndecryption key.\n\nSquirrelWaffle encrypted data.\nTo decrypt the data, the malware uses a simple rolling XOR algorithm.\n\nSquirrelWaffle data decryption block.\n\nWe created a simple Python script that is able to decrypt the data from SquirrelWaffle\n[samples, by implementing the same logic. The script can be found in our Github repository.](https://github.com/netskopeoss/NetskopeThreatLabsIOCs/tree/main/SquirrelWaffle)\n\n\n-----\n\nThere are two major blocks of encrypted data. The first one is a large list of IP addresses, as\nshown below.\n\nPart of decrypted data from the analyzed SquirrelWaffle\n\npayload.\nThis list is used by the malware as a blocklist, likely to avoid the malware from being\n[analyzed by sandboxes. The second list contains the payload URLs, which SquirrelWaffle](https://hatching.io/blog/2021-09-23-triage-thursday/)\nuses to download additional malware.\n\n\n-----\n\nSquirrelWaffle payload URLs.\n\nThe SquirrelWaffle sample from this campaign was downloading a CobaltStrike beacon,\nusing “.txt” as an extension.\n\nCobaltStrike beacon downloaded by SquirrelWaffle.\n\n[Aside from CobaltStrike, SquirrelWaffle was also found delivering QakBot, which is a modular](https://www.malware-traffic-analysis.net/2021/09/24/index.html)\nbanking trojan and information stealer, [active since 2007.](https://malpedia.caad.fkie.fraunhofer.de/details/win.qakbot)\n\n## Conclusion\n\nSquirrelWaffle is a new malware loader that is being used to deliver Cobalt Strike and\nQakBot. The infection vector occurs through spam emails with malicious Office documents\nthat eventually downloads SquirrelWaffle DLL.\n\nAlthough this malware was spotted delivering Cobalt Strike and QakBot so far, we are\ncontinuously monitoring this threat as it can be used by more malware families. Netskope\n**Advanced Threat Protection provides proactive coverage against zero-day samples**\nincluding APT and other malicious Office documents using both our ML and heuristic-based\nstatic analysis engines, as well as our cloud sandbox. The following screenshot shows the\ndetection for\n```\nfb41f8ce9d34f5ceb42b3d59065f63533d4a93557f9353333cbc861e3aff1f09, indicating it\n\n```\nwas detected by Netskope Advanced Heuristic Analysis.\n\n\n-----\n\n## Protection\n\nNetskope Threat Labs is actively monitoring this campaign and has ensured coverage for all\nknown threat indicators and payloads.\n\n**Netskope Threat Protection**\n\nVB:Trojan.Valyria.5292\n**Netskope Advanced Threat Protection provides proactive coverage against this**\nthreat.\n\nGen.Malware.Detect.By.StHeur indicates a sample that was detected using static\nanalysis\nGen.Malware.Detect.By.Sandbox indicates a sample that was detected by our\ncloud sandbox\n\n## IOCs\n\n**SHA256 Hashes**\n\n\nInfected\n“.doc”\n\n\nfb41f8ce9d34f5ceb42b3d59065f63533d4a93557f9353333cbc861e3aff1f09\n\n\nInfected “.xls” 2f3371880117f0f8ff9b2778cc9ce57c96ce400afa8af8bfabbf09cb138e8a28\n\n\nSquirrelWaffle\nDLL\n\nCobaltStrike\nBeacon\n\n\n00d045c89934c776a70318a36655dcdd77e1fedae0d33c98e301723f323f234c\n\n3c280f4b81ca4773f89dc4882c1c1e50ab1255e1975372109b37cf782974e96f\n\n\nThe full list of IOCs, the script that decrypts SquirrelWaffle configuration, and a Yara rule can\n[be found in our Github repository.](https://github.com/netskopeoss/NetskopeThreatLabsIOCs/tree/main/SquirrelWaffle)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-07 - SquirrelWaffle- New Malware Loader Delivering Cobalt Strike and QakBot.pdf"
    ],
    "report_names": [
        "2021-10-07 - SquirrelWaffle- New Malware Loader Delivering Cobalt Strike and QakBot.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535753,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653757977,
    "ts_modification_date": 1653757977,
    "files": {
        "pdf": "https://archive.orkl.eu/7973249b22ac531c82245e92abc7c303a56e13a9.pdf",
        "text": "https://archive.orkl.eu/7973249b22ac531c82245e92abc7c303a56e13a9.txt",
        "img": "https://archive.orkl.eu/7973249b22ac531c82245e92abc7c303a56e13a9.jpg"
    }
}