{
    "id": "ffd7f07c-3716-4f8e-ab9a-bf94655b9efd",
    "created_at": "2023-01-12T15:02:55.074082Z",
    "updated_at": "2025-03-27T02:16:59.254359Z",
    "deleted_at": null,
    "sha1_hash": "f4fe55ce1b5441d8a25095a740c365c4d089d0e6",
    "title": "2019-04-09 - OceanLotus- macOS malware update",
    "authors": "",
    "file_creation_date": "2022-05-27T23:27:54Z",
    "file_modification_date": "2022-05-27T23:27:54Z",
    "file_size": 608768,
    "plain_text": "# OceanLotus: macOS malware update\n\n**[welivesecurity.com/2019/04/09/oceanlotus-macos-malware-update/](https://www.welivesecurity.com/2019/04/09/oceanlotus-macos-malware-update/)**\n\nLatest ESET research describes the inner workings of a recently found addition to\nOceanLotus’s toolset for targeting Mac users\n\n[Romain Dumont](https://www.welivesecurity.com/author/romaindupont/)\n9 Apr 2019 - 11:30AM\n\nLatest ESET research describes the inner workings of a recently found addition to\nOceanLotus’s toolset for targeting Mac users\n\n\nApril 9, 2019\n\n\n-----\n\nEarly in March 2019, a new macOS malware sample from the OceanLotus group was\nuploaded to VirusTotal, a popular online multi-scanner service. This backdoor executable\nbears the same features as the previous macOS variant we looked at, but its structure has\nchanged and its detection was made harder. Unfortunately, we couldn’t find the dropper\nassociated with this sample so we do not know the initial compromise vector.\n\nWe [recently published a detailed update about OceanLotus and how its operators employ a](https://www.welivesecurity.com/2019/03/20/fake-or-fake-keeping-up-with-oceanlotus-decoys/)\nwide range of techniques to gain code execution, achieve persistence, and leave as little\ntrace as possible on a Windows system. OceanLotus is also known to have a malicious\nmacOS component. This article details what has changed from the previous macOS version\nanalyzed by Trend Micro and describes how, while analyzing this variant’s code, you can\nautomate string decryption using the IDA Hex-Rays API.\n\n## Analysis\n\nThe following three sections of this blogpost describe the analysis of the sample with the\nSHA-1 hash E615632C9998E4D3E5ACD8851864ED09B02C77D2. The file is named\nflashlightd and is detected by ESET products as OSX/OceanLotus.D.\n\n## Anti-debug and anti-sandbox\n\nAs usual for OceanLotus macOS binaries, the sample is packed with UPX, but most packer\nidentification tools do not recognize it as such, probably because they mostly include a\nsignature that relies on the presence of a “UPX” string, and further, Mach-O signatures are\nless common and not as regularly updated. This particular characteristic makes static\ndetection more difficult. Once unpacked, one interesting thing is that the entry point is\nlocated at the beginning of the __cfstring section in the .TEXT segment. This section has\nthe flag attributes seen in Figure 1.\n\n\n-----\n\n_Figure 1. MACH-O __cfstring section attributes_\n\nAs seen in Figure 2, the fact that the code is in the __cfstring section tricks some\ndisassembly tools to display the code as strings.\n\n_Figure 2. The backdoor code is defined as data by IDA_\n\nWhen run, the binary first creates a thread as an anti-debugging watchdog whose sole\npurpose is to continuously check if a debugger is present. In order to do that, this thread:\n\nTries to detach any debugger by calling ptrace with PT_DENY_ATTACH as a request\nparameter\nChecks if some exception ports are open by calling the task_get_exception_ports\nfunction\nChecks if a debugger is attached, as seen in Figure 3, by verifying if the P_TRACED\nflag is set in the current process\n\n_Figure 3. Check if a debugger is attached via sysctl function_\n\nIf the watchdog detects that a debugger is present the exit function is called. Moreover, the\nsample then checks its environment by issuing the following two commands:\n\nioreg -l | grep -e “Manufacturer” and sysctl hw.model\n\nand checks the return value against a hardcoded list of known virtualization system strings:\noracle, vmware, virtualbox or parallels. Finally, the command:\n\nsystem_profiler SPHardwareDataType 2>/dev/null | awk ‘/Boot ROM Version/ {split($0, line,\n“:”);printf(“%s”, line[2]);}\n\nchecks if the machine is one of the following: “MBP”, “MBA”, “MB”, “MM”, “IM”, “MP” and\n“XS”. These codes represent the model of the system. For instance, “MBP” stands for\nMacBook Pro, “MBA” stands for MacBook Air and so on…\n\n## Major updates\n\n\n-----\n\nEven though the backdoor commands have not changed since the Trend Micro article, we\nnoticed a few other modifications. The C&C servers used for this sample are quite recent as\ntheir creation date is 2018-10-22.\n\ndaff.faybilodeau[.]com\nsarc.onteagleroad[.]com\nau.charlineopkesston[.]com\n\nThe URL resource used has changed to /dp/B074WC4NHW/ref=gbps_img_m9_62c3_750e6b35.\n\nThe first packet that is sent to the C&C server contains more information regarding the host\nmachine. All data gathered by the commands in the following table are included.\n\n**Commands** **Description**\n\n\nsystem_profiler SPHardwareDataType 2>/dev/null | awk\n'/Processor / {split($0,line,\":\"); printf(\"%s\",line[2]);}'\nmachdep.cpu.brand_string\n\nsystem_profiler SPHardwareDataType 2>/dev/null | awk\n'/Memory/ {split($0,line, \":\"); printf(\"%s\", line[2]);}'\n\n\nGather processor\ninformation\n\nGather memory\ninformation\n\n\nifconfig -l Gather network\ninterface MAC\naddresses\n\n\nioreg -rd1 -c IOPlatformExpertDevice | awk\n'/IOPlatformSerialNumber/ { split($0, line, \"\\\"\"); printf(\"%s\",\nline[4]); }'\n\n\nRetrieves the serial\nnumber of the device\n\n\n[On top of this configuration change, this sample does not use the libcurl library for network](https://curl.haxx.se/libcurl/)\nexfiltration. Instead, it uses an external library. To locate it, the backdoor tries to decrypt\neach file in the current directory using AES-256-CBC with the key\ngFjMXBgyXWULmVVVzyxy padded with zeroes. Each file is “decrypted” and saved as\n[/tmp/store and an attempt to load it as a library made using the dlopen function. When a](https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/dlopen.3.html)\ndecryption attempt results in a successful call to dlopen, the backdoor then retrieves the\nexported functions Boriry and ChadylonV, which seem to be responsible for the network\ncommunication with the server. As we do not have the dropper or other files from the\noriginal sample’s location, we could not analyse this library. Moreover, since the component\nis encrypted, a YARA rule based on these strings would not match the file found on disk.\n\nAs described in the analysis of the group’s previous macOS backdoor, a clientID is created.\nThis identifier is the MD5 hash of the return value of one of the following commands:\n\nioreg -rd1 -c IOPlatformExpertDevice | awk ‘/IOPlatformSerialNumber/ { split($0, line,\n“\\””); printf(“%s”, line[4]); }’\n\n\n-----\n\nioreg -rd1 -c IOPlatformExpertDevice | awk /IOPlatformUUID/ { split($0, line, \\ );\nprintf(“%s”, line[4]); }’\nifconfig en0 | awk \\’/ether /{print $2}\\’ (obtain the MAC address)\nan unknown command (“\\x1e\\x72\\x0a“) which used to be “uuidgen” in the previous\nsamples\n\nBefore being hashed, the character “0” or “1” is appended to the return value indicating root\nprivileges. This clientID is stored in /Library/Storage/File System/HFS/25cf5d02-e50b-4288870a-528d56c3cf6e/pivtoken.appex if the code runs as root, or in\n~/Library/SmartCardsServices/Technology/PlugIns/drivers/snippets.ecgML otherwise. This\n[file is normally hidden via the _chflags function and its timestamp is modified using the](https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/chflags.2.html)\n“touch –t” command with a random value.\n\n## String decryption\n\nLike previous variants, the strings are encrypted using AES-256-CBC (hex-encoded key:\n9D7274AD7BCEF0DED29BDBB428C251DF8B350B92 padded with zeroes and the IV is\n[filled with zeroes) using the CCCrypt function. The key has changed from previous versions](https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/CCCrypt.3cc.html)\nbut since the group is still using the same algorithm to encrypt strings, decryption could be\nautomated. Along with this article, we are releasing an IDA script leveraging the Hex-Rays\nAPI to decrypt the strings present in the binary. This script may help future analysis of\nOceanLotus and the analysis of existing samples that we have not yet been able to obtain.\nAt the core of this script lies a generic method to obtain the arguments passed to a function.\nMoreover, it looks for the parameter assignments in order to find their values. This method\ncould be reused to retrieve the list of arguments of a function and then pass them to a\ncallback.\n\nKnowing the prototype of the decrypt function, the script first finds all cross-references to\nthis function, finds all the arguments, decrypts the data and puts the plaintext inside a\ncomment at the address of the cross-reference. In order for the script to work correctly, the\ncustom alphabet used by the base64 decode function must be set in the script and the\nglobal variable containing the length of the key must be defined (as a DWORD in this case;\nsee Figure 4).\n\n_Figure 4. Defining the global variable key_len_\n\nIn the Function window, you can right-click the decryption function and click “Extract and\ndecrypt arguments”. The script should put the decrypted strings in comments, much as in\nFigure 5.\n\n\n-----\n\n_Figure 5. Decrypted text is put into comments_\n\nThis conveniently lists the decrypted strings together in IDA’s xrefs to window for that\nfunction, as seen in Figure 6.\n\n_Figure 6. Xrefs to of f_decrypt function_\n\n[The final script can be found on our Github repository.](https://github.com/eset/malware-research/tree/master/oceanlotus/)\n\n## Conclusion\n\n\n-----\n\n[As recently documented in another of our articles, the OceanLotus group keeps improving](https://www.welivesecurity.com/2019/03/20/fake-or-fake-keeping-up-with-oceanlotus-decoys/)\nand updating its toolset, and once again, it has improved its tools for targeting Mac users.\nThe code has not changed that much, but because many Mac users don’t run security\nsoftware on their machines, the need to evade detection is of less importance. ESET\nproducts already detected this file when we found it. Since the network library used for the\nC&C communication is now encrypted on the disk, the exact network protocol used remains\nunknown.\n\n## Indicators of Compromise (IoCs)\n\nThe IoCs in this blogpost, as well as the MITRE ATT&CK attributes, are also available in our\n[GitHub repository.](https://github.com/eset/malware-ioc/tree/master/oceanlotus)\n\n## Domain names\n\ndaff.faybilodeau[.]com\nsarc.onteagleroad[.]com\nau.charlineopkesston[.]com\n\n## URL resource\n\n/dp/B074WC4NHW/ref=gbps_img_m-9_62c3_750e6b35\n\n## File paths\n\n~/Library/SmartCardsServices/Technology/PlugIns/drivers/snippets.ecgML\n/Library/Storage/File System/HFS/25cf5d02-e50b-4288-870a528d56c3cf6e/pivtoken.appex\n/tmp/store\n\n\n**Sample**\n**analyzed** **SHA-1 hash**\n\n\n**ESET detection**\n**name**\n\n\nfleshlightd E615632C9998E4D3E5ACD8851864ED09B02C77D2 OSX/OceanLotus.D\n\n## MITRE ATT&CK techniques\n\n**Tactic** **ID** **Name** **Description**\n\n\nDefense\nEvasion\n\n\n**[T1158](https://attack.mitre.org/techniques/T1158/)** Hidden Files and\nDirectories\n\n\nThe backdoor hides the clientID\nfile via chflags function.\n\n\n-----\n\n**Tactic** **ID** **Name** **Description**\n\n\n**[T1107](https://attack.mitre.org/techniques/T1107/)** File\nDeletion\n\n**[T1222](https://attack.mitre.org/techniques/T1222/)** File\nPermissions\nModification\n\n**[T1027](https://attack.mitre.org/techniques/T1027/)** Obfuscated\nFiles or\nInformation\n\n\nThe backdoor can\nreceive a “delete”\ncommand.\n\nThe backdoor changes\nthe permission of the file\nit wants to execute to\n755.\n\nThe library used for\nnetwork exfiltration is\nencrypted with AES-256\nin CBC mode.\n\n\n**[T1099](https://attack.mitre.org/techniques/T1099/)**\n(macOS)\n\n\nTimestomp The timestamp of the file\nstoring the clientID is\nmodified with a random\nvalue.\n\n\nDiscovery **[T1082](https://attack.mitre.org/techniques/T1082/)** System Information\nDiscovery\n\n\nThe backdoor performs a\nfingerprint of the machine on its\nfirst connection to the C&C server.\n\n\nExfiltration **[T1022](https://attack.mitre.org/techniques/T1022/)** Data Encrypted The backdoor encrypts the data\nbefore exfiltration.\n\n\nCommand\nand\nControl\n\n\n**[T1094](https://attack.mitre.org/techniques/T1094/)** Custom Command and\nControl Protocol\n\n\nThe backdoor implements a\nspecific format for the packet\ninvolving random values. See\n[Trend Micro article.](https://blog.trendmicro.com/trendlabs-security-intelligence/new-macos-backdoor-linked-to-oceanlotus-found/)\n\n\n9 Apr 2019 - 11:30AM\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-04-09 - OceanLotus- macOS malware update.pdf"
    ],
    "report_names": [
        "2019-04-09 - OceanLotus- macOS malware update.pdf"
    ],
    "threat_actors": [
        {
            "id": "870f6f62-84f5-48ca-a18e-cf2902cd6924",
            "created_at": "2022-10-25T15:50:23.303818Z",
            "updated_at": "2025-03-27T02:00:55.435309Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "APT32",
                "SeaLotus",
                "OceanLotus",
                "APT-C-00",
                "Canvas Cyclone"
            ],
            "source_name": "MITRE:APT32",
            "tools": [
                "Mimikatz",
                "ipconfig",
                "Kerrdown",
                "Cobalt Strike",
                "SOUNDBITE",
                "OSX_OCEANLOTUS.D",
                "KOMPROGO",
                "netsh",
                "RotaJakiro",
                "PHOREAL",
                "Arp",
                "Denis",
                "Goopy"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "af509bbb-8d18-4903-a9bd-9e94099c6b30",
            "created_at": "2023-01-06T13:46:38.585525Z",
            "updated_at": "2025-03-27T02:00:02.866727Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "TIN WOODLAWN",
                "OceanLotus Group",
                "OceanLotus",
                "Sea Lotus",
                "G0050",
                "Cobalt Kitty",
                "SeaLotus",
                "ATK17",
                "Ocean Lotus",
                "Ocean Buffalo",
                "POND LOACH",
                "Canvas Cyclone",
                "APT-C-00",
                "APT-32",
                "APT 32"
            ],
            "source_name": "MISPGALAXY:APT32",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f1518ac1-4710-4dd1-a422-e3801e4806cb",
            "created_at": "2024-05-01T02:03:08.147856Z",
            "updated_at": "2025-03-27T02:05:17.421275Z",
            "deleted_at": null,
            "main_name": "TIN WOODLAWN",
            "aliases": [
                "Cobalt Kitty",
                "OceanLotus",
                "WOODLAWN ",
                "APT32 "
            ],
            "source_name": "Secureworks:TIN WOODLAWN",
            "tools": [
                " Denis",
                " Goopy",
                " JEShell",
                " KerrDown",
                " Mimikatz",
                " Ratsnif",
                " Remy",
                " Rizzo",
                " RolandRAT",
                "Cobalt Strike"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2439ad53-39cc-4fff-8fdf-4028d65803c0",
            "created_at": "2022-10-25T16:07:23.353204Z",
            "updated_at": "2025-03-27T02:02:09.749502Z",
            "deleted_at": null,
            "main_name": "APT 32",
            "aliases": [
                "APT 32",
                "APT-C-00",
                "APT-LY-100",
                "ATK 17",
                "Lotus Bane",
                "Ocean Buffalo",
                "OceanLotus",
                "Operation Cobalt Kitty",
                "Operation PhantomLance",
                "Pond Loach",
                "SeaLotus",
                "SectorF01",
                "Tin Woodlawn"
            ],
            "source_name": "ETDA:APT 32",
            "tools": [
                "Agentemis",
                "Android.Backdoor.736.origin",
                "AtNow",
                "Backdoor.MacOS.OCEANLOTUS.F",
                "BadCake",
                "CACTUSTORCH",
                "CamCapture Plugin",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "Cuegoe",
                "DKMC",
                "Denis",
                "Goopy",
                "HiddenLotus",
                "KOMPROGO",
                "KerrDown",
                "METALJACK",
                "MSFvenom",
                "Mimikatz",
                "Nishang",
                "OSX_OCEANLOTUS.D",
                "OceanLotus",
                "PHOREAL",
                "PWNDROID1",
                "PhantomLance",
                "PowerSploit",
                "Quasar RAT",
                "QuasarRAT",
                "RatSnif",
                "Remy",
                "Remy RAT",
                "Rizzo",
                "Roland",
                "Roland RAT",
                "SOUNDBITE",
                "Salgorea",
                "Splinter RAT",
                "Terracotta VPN",
                "Yggdrasil",
                "cobeacon",
                "denesRAT",
                "fingerprintjs2"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535775,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1653694074,
    "ts_modification_date": 1653694074,
    "files": {
        "pdf": "https://archive.orkl.eu/f4fe55ce1b5441d8a25095a740c365c4d089d0e6.pdf",
        "text": "https://archive.orkl.eu/f4fe55ce1b5441d8a25095a740c365c4d089d0e6.txt",
        "img": "https://archive.orkl.eu/f4fe55ce1b5441d8a25095a740c365c4d089d0e6.jpg"
    }
}