{
    "id": "3351155e-ae02-49a6-a6f1-cf7c5ef2ed15",
    "created_at": "2023-01-12T15:04:04.059283Z",
    "updated_at": "2025-03-27T02:05:39.174518Z",
    "deleted_at": null,
    "sha1_hash": "efc092a78fc16cace0a23c7bbd650c073323a7b3",
    "title": "2017-02-16 - Nefarious Macro Malware drops ‚ÄúLoki Bot‚Äù to steal sensitive information across GCC countries!",
    "authors": "",
    "file_creation_date": "2022-05-28T15:24:24Z",
    "file_modification_date": "2022-05-28T15:24:24Z",
    "file_size": 2797328,
    "plain_text": "# Nefarious Macro Malware drops ‚ÄúLoki Bot‚Äù to steal sensitive information across GCC countries!\n\n**[cysinfo.com/nefarious-macro-malware-drops-loki-bot-across-gcc-countries/](https://cysinfo.com/nefarious-macro-malware-drops-loki-bot-across-gcc-countries/)**\n\n5 years ago\n\nMacro malware are still playing its atrocious activities in the wild, frightening all the sectors\naround the globe. Latest Spam campaign which flew around GCC countries created a ‚Äúscary\nrain‚Äù across multiple entities.\n\nThis spam mail was not targeted only for a particular entity, but extensively across multiple\nfirms in Middle east, anticipating huge number of victims. On the other hand, the recipients in\nthese mails (BCC) were clearly social engineered.\n\n_NB:_\n\n_The malware and associated files were analyzed within private secured environment,_\n_without actually allowing it to communicate to its command and control_\n\n_While analyzing, we may come across with unhygienic words or phrases. Keep in mind_\n_that, malware are built by ‚ÄúBad Boys‚Äù._\n\n## Let‚Äôs Get Serious:\n\nThe spam mail which landed on one of the victim‚Äôs Mailbox looks like this:\n\nThe sender Address could be spoofed, which is the contact email ID of the Cambodia based\nBusiness software provider firm ‚Äútztechnology‚Äù. The reputation of the sender IP address is\npoor:\n\n\n-----\n\nThe attachment was a document file and once it is opened, the prompt for enabling the\nmacro starts blinking:\n\nStill end users are falling for these.. sad truth!!\n\nThe word document properties shows, revamped or created date as ‚ÄúJan 19 2017‚Äùth\n\n\n-----\n\nJumping into the Document Macro, starts with ‚ÄúDocument_Open()‚Äù, meaning, the code will\nbe right away executed whenever the document is opened.\n\nThe VBscript contains lot of junk and unwanted parameters, which would make static\nanalysis to choke. Also parameters inside the code seems to be encoded heavily. So at this\npoint a mixture of static analysis and debugging needs to be done.\n\nWhen we statically analyze, we can see two modules of codes present in document. Both of\nthe module works together to build a command script and then to run this script via windows\nscript object.\n\n\n-----\n\nFurther debugging and static analysis, found that one of the variable ‚ÄúCatcustom‚Äù stores\ncommand script which was built by the macro on the fly.\n\nThe generated code looks like this (after enumeration of temp folder):\n\nThe below snippet of code reference is the ‚Äúbridge of relationship‚Äù between two modules of\nscripts. The earlier mentioned variable ‚ÄúCatcustom‚Äù which contained the commands where\nused as a parameter of another function, which is then referenced to the second module\n‚ÄúModule1‚Äù. The referenced Function parameters ‚Äúgfsdhwawcbenlte()‚Äùnow contains the\nvalue of ‚Äúcatcustom‚Äù variable and ‚Äú0‚Äù .\n\n\n-----\n\nFurthermore coming down to the script at second module‚ÄúModule1‚Äù, we can see malicious\nscript was invoked by calling the windows script shell object:\n\nNow the question is how we understood from this code above, that it invoked windows\nscript shell (with hidden window) to run the malicious code which earlier generated.\n\n\n-----\n\nIf we closely look the above snippet of code,\n\nThe function is getting the ‚Äúnew object‚Äù by joining flathazard(0), flathazard(1) and\n**flathazard(2) to get :**\n\n**new:{72C24DD5-D70A-438 B-8A42-98424B88A FB8}, Now if we go to the registry**\n**‚ÄúHKEY_CLASSES_ROOT\\CLSID\\{72C24DD5-D70A-438B-8A42-98424B88AFB8} ‚Äú, this**\nID refers to the windows script shell object.\n\nMeaning, the function is calling a new windows script shell object instance to run the\nmalicious commands in ‚Äúwhjrdrumawmwul‚Äù.\n\nWe can also see ‚Äúwhjrdrumawmwul‚Äù contains the value of generated script. The\n**‚Äúezwrelgtrpuwlj‚Äù contains the value ‚Äú0‚Äù.**\n\nThat said, Let‚Äôs see the syntax for .Run command in VB:\n\n**_Objshell.Run (strCommand, [intWindoStyle], [bWaitOnReturn])_**\n\n**‚ÄúObjshell‚Äù, We already found how shell object was invoked and we saw ‚ÄústrCommand‚Äù**\nvalue in variable ‚Äúwhjrdrumawmwul‚Äù. Now ‚Äúezwrelgtrpuwlj‚Äù holds the value ‚Äú0‚Äù which\nmeans the ‚Äúhide window‚Äù. The ‚ÄúbWaitOnReturn‚Äù if left blank immediately returns to script\nexecution.\n\nHence we found that the below code was executed by invoking windows script shell object\nand being executed in hidden window:\n\n\n-----\n\nWe can also see that the PowerShell is invoked in hidden mode, bypassing execution policy\nto download a malicious executable from a remote host, which is then renamed to\n‚Äúputtyx86‚Äù. The addition of this temp path of malicious executable to the above registry and\nthen invoking the ‚Äúeventvwr.exe‚Äù is a technique to bypass the UAC feature inorder to acquire\nhighest integrity for executing the malware.\n\nThe above fileless technique of bypassing UAC has already been explained in my post of a\nreal-life scenario::\n\nhttps://www.linkedin.com/pulse/newborn-macro-malware-generates-powershell-scriptwinston?trk=pulse_spock-articles\n\nReal-life usage of the technique and similar code generated by Macro is drafted in below\narticle:\n\n[https://cysinfo.com/cyber-attack-targeting-indian-navys-submarine-warship-manufacturer/](https://cysinfo.com/cyber-attack-targeting-indian-navys-submarine-warship-manufacturer/)\n\nAnd the mechanism of UAC bypass technique drafted in the blog:\n\nhttps://enigma0x3.net/2016/08/15/fileless-uac-bypass-using-eventvwr-exe-and-registryhijacking/\n\n## Let‚Äôs find whether the above findings are true by doing a dynamic analysis:\n\nAs we discussed earlier the windows script shell object is invoked via registry with Class ID\n\nNext the ‚Äúcmd.exe‚Äù has the entire script running under it.\n\n\n-----\n\nAs it step by step runs the commands in cmd.exe,\n\nPowerShell is invoked with the script to download the malware from remote host and save to\ntemp folder as ‚Äúputtyx86.exe‚Äù\n\n## Glitch while Acquiring Highest Integrity via Eventvwr.exe\n\nIn our sample, there happened a small glitch while script was trying to write the malware path\nto ‚ÄúHKCU\\\\Software\\\\Classes\\\\mscfile\\\\shell\\\\open\\\\command‚Äù registry to be executed via\n**eventvwr.exe. It may be due to extra slashes, because when I tweaked commands from ‚Äú\\\\‚Äù**\nto ‚Äú\\‚Äù the Registry write was successful.\n\nDue to the glitch, original eventvwr.msc popped up instead of malware when the macro was\nexecuted, quiet unlucky.\n\nIf you see in the below picture the ‚Äúmmc.exe‚Äù initiated the eventvwr.msc normally.\n\n\n-----\n\nHowever, even though the script couldn‚Äôt invoke malware via ‚Äúeventvwr‚Äù technique, after a\n15 PING-sleep (Using Ping command 15 times redirecting to nul), the malware at temp\nfolder was directly invoked. Which made the malware to run with medium integrity.\n\nOnce the ‚Äúputtyx86.exe‚Äù is executed normally, it spawns a child of its own and kills the\nparent process. Also managed to delete the executable from the path.\n\nThen if we see the handles for the child process, it acquired full access for each thread. The\nMalware must have its own elevation feature.\n\n\n-----\n\nThe dropped malware seems to be protected by the infamous ‚ÄúASprotect‚Äù executable\nprotection, header of the file also throws the acknowledgment with bogus section names.\n\nAfter a tug of war between the malware using static code analysis and debugging, found that\nthe piece of malware was piece of infamous ‚ÄúLoki Bot‚Äù.\n\n\n-----\n\n_Loki Bot is resident loader and password and cryptocoin-wallet stealer. It comes with_\n_wallet checker (coin inspector, read below). It can steal passwords from browsers,_\n_ftp/ssh, e-mail and poker clients. Written in C++. Works on Windows XP, Vista, 7, 8,_\n_8.1. and Linux. UAC Bypass‚Äù_\n\nBelow shown pictures are snips from the actual interface of main Loki Bot and\n\n\n-----\n\nThe dropped Malware had most of the Anti-analysis capabilities like VMawareness,\nDebugger detection, System time check and more. Carefully tweaking these will make\nmalware into running as if in a physical machine.\n\nIf we try to see the strings of malware without unpacking from the ASProtect protection\nmechanism, we will not get any ‚Äúsweet fruit‚Äù. But after debugging and disassembling, we will\nget good amount of data about of the malware which is obviously fruitful.\n\nThat said, I was able to retrieve and filter very useful data about the malware which gives\nenough evidence about the above said malware.\n\nThe capability of this malware is enormous and even have capability of receiving the Bot\ncommands from ‚ÄúBOT Boss‚Äù.\n\nThe malware have capabilities for luring all the FTP flavored credentials, SMTP, Browser\ndata, DBs information, have inbuilt Key logger features and much more. The portions of\nretrieved strings are below:\n\n\n-----\n\nIn addition to that, malware gets the details about the current user, Machine name, FQDN,\nMachineGuid and so on\n\nA hardcoded URL was very promising though, suspecting the above collected details and\nthis URL must have some connection.\n\n\n-----\n\nIf we see the network traffic generated by the malware, we can see a promising ‚ÄúPost‚Äù traffic\nto the above found hardcoded URL:\n\nAll the communication and analysis were done completely isolated environment without\nactually allowing malware to communicate actual CNC servers and DNS.\n\nThe malware after acquiring enough details such as Username, Machinename, FQDN, and\nlots of stolen data from the victim machine would then try communicate with the command\nand control server as we can see in the above stream of packet.\n\nThe user agent ‚ÄúMozilla/4.08 (Charon; Inferno)‚Äù used has been infamous as it was used in\nother Fareit Trojan or PonyLoader. At this point the Loki exhibits similar kind of behavior\nthough.\n\n\n-----\n\nThe host name seems to be parked at **185.29.10.252 which is a Latvia based IP which is**\nmalicious.\n\nThe relation between the IP address, host with hash can be seen below:\n\nEmerging threats have already written rule comprising the malicious user agent:\n\n[http://doc.emergingthreats.net/bin/view/Main/2021641](http://doc.emergingthreats.net/bin/view/Main/2021641)\n\nLet‚Äôs move the spot light to the string ‚Äúckav.ru‚Äù in the stream above shown. From initial\nglance, we can suspect it might be Russian based malicious website. Even though the\ndomain exists privately, could not find any clear context with the sample we are analyzing.\n\n\n-----\n\nAnticipating if I can get any clue from the unpacked sample strings, I was able to find the\nmissing characters and confirmed it was the URL of a Russian underground forum:\n\nWhen we do a blind search with this URL and suspecting Loki Bot, we will get very promising\nresult:\n\nThis Bot is being sold in a Russia underground Forum. If we see into this website, there\nare lot other tools which one can register and join the group. After successfully registering we\nshould connect with an already registered account with Jabber and then have to link. Once\nthis is completed anyone can download or share any tools or techniques\n\nReally Scary!!\n\n\n-----\n\nSome more deep search gives more result about the Bot. Even advertisement about the\nsame. The features described in this Russian forum matches with our finding earlier:\n\n\n-----\n\n**Even the features, payment details and contact details are published with it!**\n\n\n-----\n\n## With an embarrassed mind let me conclude..\n\nAre we in a digitally connected world? If the answer is yes, then Obviously Malware is the\nbiggest nightmare for all the entities, irrespective of its geographical location or nature of\nbusiness. In this Era of Cyber War, Phishing e-mails with targeted macro malware are\nexponentially circulated by the Offenders across the Globe. Of course, the easiest weakness\nspotted by offenders is ‚ÄúHuman Weakness‚Äù. Anyways offenders will stay fingers crossed,\nwhether the end user ‚Äúallows‚Äù himself to respond these malicious attachments or simply\n‚Äúdrops‚Äù the plan.\n\nAs a cautionary note, as we saw in this article, hack advises, hire a hacker, malware, hack\ntools and anything is now easily available everywhere in the Internet and abundant in the\ndeepest corners of the web. This is very scary right?, so a rigid security posture should be\nmaintained by all the entities to defend these types of threats.\n\nWe should be in a position to tell boldly,\n\n**‚ÄúIf the Offenders are finding new techniques and tactics, so are we‚Äù!!!**\n\n## Funny Note üôÇ\n\nThe malware author of the above malware must be a fan of cartoon characters from the\nbelow file properties comments:\n\n\n-----\n\n**Comments =** **_‚ÄúBilly the goat ate all the autorun.inf files‚Ä¶because Old McDonald_**\n**_was sick of all the viruses and worms on his farm‚Äù_**\n\n## References\n\nhttps://blog.sensecy.com/tag/loki-bot/\n\n[https://hackforums.net/showthread.php?tid=5456831](https://hackforums.net/showthread.php?tid=5456831)\n\nhttps://www.scmagazine.com/floki-bot‚Äìa-zeus-wannabe-with-delusions-ofgrandeur/article/569329/\n\nhttps://digital-forensics.sans.org/blog/2009/11/23/extracting-vb-macros-from-maliciousdocuments/\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-02-16 - Nefarious Macro Malware drops ‚ÄúLoki Bot‚Äù to steal sensitive information across GCC countries!.pdf"
    ],
    "report_names": [
        "2017-02-16 - Nefarious Macro Malware drops ‚ÄúLoki Bot‚Äù to steal sensitive information across GCC countries!.pdf"
    ],
    "threat_actors": [
        {
            "id": "2c7ecb0e-337c-478f-95d4-7dbe9ba44c39",
            "created_at": "2022-10-25T16:07:23.690871Z",
            "updated_at": "2025-03-27T02:02:09.921431Z",
            "deleted_at": null,
            "main_name": "Goblin Panda",
            "aliases": [
                "1937CN",
                "Conimes",
                "Cycldek",
                "Goblin Panda"
            ],
            "source_name": "ETDA:Goblin Panda",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Agent.dhwf",
                "BackDoor-FBZT!52D84425CDF2",
                "BlueCore",
                "BrowsingHistoryView",
                "ChromePass",
                "CoreLoader",
                "Custom HDoor",
                "Destroy RAT",
                "DestroyRAT",
                "DropPhone",
                "FoundCore",
                "HDoor",
                "HTTPTunnel",
                "JsonCookies",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "NBTscan",
                "NewCore RAT",
                "PlugX",
                "ProcDump",
                "PsExec",
                "QCRat",
                "RainyDay",
                "RedCore",
                "RedDelta",
                "RoyalRoad",
                "Sisfader",
                "Sisfader RAT",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Trojan.Win32.Staser.ytq",
                "USBCulprit",
                "Win32/Zegost.BW",
                "Xamtrav",
                "ZeGhost",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7d553b83-a7b2-431f-9bc9-08da59f3c4ea",
            "created_at": "2023-01-06T13:46:39.444946Z",
            "updated_at": "2025-03-27T02:00:03.093712Z",
            "deleted_at": null,
            "main_name": "GOBLIN PANDA",
            "aliases": [
                "Conimes",
                "Cycldek"
            ],
            "source_name": "MISPGALAXY:GOBLIN PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535844,
    "ts_updated_at": 1743041139,
    "ts_creation_date": 1653751464,
    "ts_modification_date": 1653751464,
    "files": {
        "pdf": "https://archive.orkl.eu/efc092a78fc16cace0a23c7bbd650c073323a7b3.pdf",
        "text": "https://archive.orkl.eu/efc092a78fc16cace0a23c7bbd650c073323a7b3.txt",
        "img": "https://archive.orkl.eu/efc092a78fc16cace0a23c7bbd650c073323a7b3.jpg"
    }
}