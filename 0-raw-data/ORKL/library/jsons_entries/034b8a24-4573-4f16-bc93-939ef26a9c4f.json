{
    "id": "034b8a24-4573-4f16-bc93-939ef26a9c4f",
    "created_at": "2022-10-25T16:48:23.362748Z",
    "updated_at": "2025-03-27T02:06:02.477882Z",
    "deleted_at": null,
    "sha1_hash": "ac22f468a5b095a78445cbf05a7a20b17c2bc6e7",
    "title": "Microsoft Word - Microcin_Technical_4PDF_eng_final.docx",
    "authors": "",
    "file_creation_date": "2017-09-27T13:10:09Z",
    "file_modification_date": "2017-09-27T13:10:09Z",
    "file_size": 2404019,
    "plain_text": "# MICROCIN MALWARE:\n\n TECHNICAL DETAILS AND INDICATORS OF COMPROMISE\n\n#### Vasily Berdnikov, Dmitry Karasovsky, Alexey Shulmin\n### Version 1.2 (September 25, 2017)\n\n\n-----\n\n## Contents\n\nContents .................................................................................................................................................. 2\n\nAppendix 1. Technical details of the attack ............................................................................................ 3\n\nWatering hole attack ........................................................................................................................... 3\n\nFirst stage of infection ......................................................................................................................... 3\n\nThe dropper ..................................................................................................................................... 3\n\nThe installer: main shellcode and DLL ............................................................................................. 3\n\nDLL hijacking .................................................................................................................................... 6\n\nEstablishing persistence ...................................................................................................................... 6\n\nThe main shellcode .......................................................................................................................... 6\n\nThe additional module .................................................................................................................... 9\n\nEstablishing persistence: other malicious tools ................................................................................ 11\n\nCompleting the mission – PowerATK ................................................................................................ 12\n\nAppendix 2. Indicators of compromise ................................................................................................. 14\n\nMD5 (malicious documents) ............................................................................................................. 14\n\nMD5 (backdoors) ............................................................................................................................... 14\n\n\n-----\n\n## Appendix 1. Technical details of the attack\n\n### Watering hole attack\n\n##### We detected a malicious source file (exploit) while we were investigating a watering hole attack. The file details are as follows:\n\n**md5** **a50b6ec77276cf235eaf2d14665bdb5c**\n\nfile name КакПриниматьКвартиру-1.rtf\n\nsource traffic\n\n### First stage of infection\n\n#### The dropper\n\nWhen the exploit becomes active, an executable file with a dropper program is launched on the\nattacked PC. It contains the malicious program’s encrypted installers intended for 32-bit and 64-bit\noperating systems:\n\n_Encrypted installers in the dropper’s resources_\n\nThe dropper determines whether it is running in a 32-bit or 64-bit environment, decrypts the\nappropriate installer, places it in the %temp% folder with a name that uses the format kb[set of random\n_characters].tmp, and launches it for execution. After this, the dropper’s process terminates._\n\n#### The installer: main shellcode and DLL\n\nFor any inquiries contact intelreports@kaspersky com Page 3 of 14\n\n|md5 a50b6ec77276cf235eaf2d14665bdb5c|Col2|\n|---|---|\n|file name КакПриниматьКвартиру-1.rtf||\n|source|traffic|\n\n\n-----\n\nThe installer then starts infecting the system. In order to establish a foothold, it displays non-typical\nbehavior:\n\n1. Writes its main module to the registry – a shellcode that is stored in a registry parameter of\n\nthe type REG_BINARY in a key with a random name starting with “M”, such as\n‘HKCU\\Software\\Mbaccbbg’. The shellcode is stored in XOR-encrypted format with the last\ncharacter in the key name used as the argument for XOR.\n\n2. Modifies the parameter ‘Path’ (which is the user environment variable) in the key\n\n‘hkcu\\environment’, writing the path to the temporary folder %temp%.\n\n3. Reads the memory of the explorer.exe process and searches for a suitable string that will be\n\nused to force the loading of a malicious DLL into this system process.\n\n4. Creates a DLL in the temporary folder %temp%; the DLL name consists of the string found in\n\nthe memory of the explorer.exe process (for example, the DLL name rer.pdb is from the\nappropriate string explorer.pdb found in the explorer.exe memory).\n\n5. Injects the DLL into the running explorer.exe process with the help of the QueueUserAPC\n\nfunction. The address of kernel32.LoadLibraryA is sent as the first parameter, and the address\nof the string obtained in step 3 is sent as the third parameter for the QueueUserAPC function.\nAfter the malicious DLL is successfully injected into the explorer.exe process, the installer\ndeletes the path to %temp% from the environment variable ‘Path’. If the function LoadLibraryA\nis called in the context of the explorer.exe process, and the string provided on entry is not a\ncomplete valid path to the DLL that is to be injected, the function will search for that path in\nthe %temp% folder, and if found, the DLL will be loaded into the memory. This way, the\nmalicious code is loaded into the explorer.exe process without being written to the process\nmemory.\n\n6. The installer copies one of the system libraries to %temp% with the name format kb[set of\n\n_random characters].ini_ and modifies it by extending the resource section and changing the\nentry point to the beginning of the injected malicious code. This means the malicious code is\ngiven control the moment the library is loaded to the process’s memory.\n\n_List of sections of the original system library_\n\nFor any inquiries contact intelreports@kaspersky com Page 4 of 14\n\n\n-----\n\n_Entry point to the original system library_\n\n_The modified system library_\n\n_The modified library entry point, ensuring control is handed over to the malicious code_\n\nThe libraries modified by the malicious program vary for different versions of Windows:\n\nFor any inquiries contact intelreports@kaspersky com Page 5 of 14\n\n\n-----\n\n|Windows 10 dwmapi.dll|Col2|\n|---|---|\n|Windows 8 (.1) \\ Windows Server 2012 d3d11.dll (x86)\\ dwmapi.dll (x64)||\n|Windows 7 \\ Windows Server 2008 R2 propsys.dll||\n|Windows 2000 \\ Windows Server 2003 lpk.dll||\n|Windows XP|shimeng.dll|\n\n\n_Table of system libraries that are modified in each version of Windows_\n\n7. The installer then sends a command to the library injected earlier into the explorer.exe process\n\nto place the modified system library in the folder %WINDIR%.\n\n#### DLL hijacking\n\nThe method this malicious program employs to establish a foothold within the system is DLL hijacking\nin respect to the explorer.exe process. Each time the system boots, the explorer.exe process loads the\nmodified malicious program into the memory; the malicious program is located in the same folder as\nthe file explorer.exe. Once loaded into the memory of the explorer.exe process, the malicious library\nreads the parameter with the shellcode from the registry, decrypts it and launches for execution. This\nis the principal payload of the malicious program.\n\nIf the installer Microcin detects any running anti-malware processes before it establishes itself in the\nsystem, then the malicious library is not force-loaded into the context of the explorer.exe process\nduring installation. If User Access Control is enabled, the installer places the modified system library\ninto the folder %WINDIR% using the system app wusa.exe, a standalone Windows update installer, with\nthe parameter “/extract”. This is an auto-elevated application, and User Access Control in standard\nsettings does not require user involvement to place the modified library in the required location\n(%WINDIR%).\n\nIt should be noted that this method will not work under Windows 10, as Microsoft has removed the\nparameter “/extract” from the parameters list of the wusa.exe utility.\n\n### Establishing persistence\n\n#### The main shellcode\n\nAfter launching, the main shellcode, which contains the necessary addresses, contacts its C&C servers:\n\n#####  hand.wid******lay[.]com –> 127.0.0.1\n\n  foot.bac******ike[.]com –> 45.**.***.192\n\nThe first is likely the fallback C&C server, it corresponds to the loopback IP address 127.0.0.1.\n\nThe second C&C is only intermittently active, it goes online to receive information from infected\ncomputers or send commands to the shellcode.\n\nTo contact the C&C, the malicious program sends a request to a link in the format\n‘/index.asp?ID=hhhtjqmrspjnQ’, where the red string is generated depending on the parameters of the\n\nFor any inquiries contact intelreports@kaspersky com Page 6 of 14\n\n\n-----\n\ninfected operating system. The malicious program sends this request (a ping) every minute to the C&C\nand analyses the response.\n\nIn most cases, the response is empty, a simple pong:\n\nHowever, while we were monitoring the C&C we saw the response ‘hj1000198377=’ being sent. The\nbot recognized this as a task to download the file ‘\\0001.jpg’ from the C&C domain, which it did:\n\n_The main shellcode downloads a JPEG image_\n\nThe main shellcode can process three commands. The first two involve the decryption and launching\nof an MZPE file or a shellcode (with or without saving to disk), and the third command relates to the\ndeleting of a parameter with an additional shellcode (module) in the registry.\n\nThe file 0001.jpg which the malicious program downloads from the server is a JPEG image.\n\nFor any inquiries contact intelreports@kaspersky com Page 7 of 14\n\n\n-----\n\n_The image downloaded by the malicious program_\n\nThis image exists in an online gallery where its file name is ‘kariminal_rider’.\n\nThe malicious code searches for the special marker ‘ABCD’ in the downloaded image and decrypts data\nusing the following algorithm:\n\n_Procedure for decrypting the additional shellcode from the image_\n\nAfter decrypting the image’s contents located at displacement 0x0D from the marker ‘ABCD’, the\nfollowing code becomes visible:\n\nFor any inquiries contact intelreports@kaspersky com Page 8 of 14\n\n\n-----\n\n_Decrypted code contained in the image_\n\nThis is the second shellcode – the additional module that is downloaded and installed by the main\nshellcode.\n\n#### The additional module\n\nThe additional module is also saved in the registry in a parameter of the type REG_BINARY within the\nkey ‘hkcu\\software\\microini’. When the primary shellcode starts operating, it checks if this key is\npresent; if it is, the parameter’s content is read, decrypted and launched.\n\n_The additional module stored within the registry parameter_\n\nThe additional module also contains the C&C address:\n\nbird.sin******oll[.]com --> 45.**.***.192\nThis same IP address also corresponds to foot.bac******ike[.]com, one of the main module’s C&Cs.\n\nThe additional malicious module was named ‘DiskSearch.dll’ by its developer. It enables the attackers\nto gain access to the file system: receive information about the partitions existing in the system, search\nfor the necessary files, move and delete them and send them to a remote server. However, this is only\na fraction of what the module does; it is a full-fledged backdoor that can gain control over the infected\nsystem, i.e. work with the registry and services, launch applications, obtain a list of processes,\n\nFor any inquiries contact intelreports@kaspersky com Page 9 of 14\n\n\n-----\n\nterminate an arbitrary process, launch a console (cmd.exe) for remote execution of commands, re-boot\nand switch off the system. It can also take screenshots and send them to the malicious server.\n\n_Processing a command from the C&C_\n\n_The additional module launches a console to execute the cybercriminals’ remote commands_\n\nFor any inquiries contact intelreports@kaspersky com Page 10 of 14\n\n\n-----\n\n_The search procedure for files in the folder_\n\n### Establishing persistence: other malicious tools\n\nWe searched Kaspersky Lab’s cloud technologies for the domain names used by Microcin and found\nthat other malicious modules had also been downloaded from the URL address\nfoot.bac******ike[.]com. These modules were used not only in Microcin attacks but also in other\ncyberespionage campaigns, some of which are still active.\n\n  - foot.bac******ike[.]com/whale32.jpg (and its 64-bit version whale64.jpg in the same\nlocation), despite its extension, is an MZPE file. This backdoor is designed to execute a\ncybercriminal’s commands, send data from infected computers, execute files, obtain\ninformation about the system, etc. The C&C URL is whale.dee******ave[.]com (IP:\n104.207.130.19). It works via HTTPS.\n\nfoot.bac******ike[.]com/ocean.jpg is also an MZPE file and also a backdoor. However, its C&C\nis located at vodxe.k*****c[.]com (IP: 45.**.**.65). Using this malicious program, the\ncybercriminal can execute commands on the infected computer, delete files, receive files,\ncollect information about the system, recursively delete folders, install and launch services,\ncreate screenshots, terminate processes, etc.\n\n  - This backdoor is launched using the DLL hijacking method, using a legitimate, digitally signed\napplication to conceal the malicious activity, and has the internal name RingDllWM.dll\nassigned by the module’s developer.\n\n  - foot.bac******ike[.]com/updater.jpg is a component of the malicious program Microcin,\ndesigned to update the main shellcode in the registry.\n\nFor any inquiries contact intelreports@kaspersky com Page 11 of 14\n\n\n-----\n\n### Completing the mission – PowerATK\n\nWhen we obtained the URL address of the backdoor’s C&C named ‘whale’ (whale.dee******ave.com),\nwe found an open folder that was essentially a git-clone of PowerSploit – a ready-to-use toolkit of\nPowershell modules used in penetration tests. Those behind Microcin added a number of extra\nmalicious programs to the standard PowerSploit toolkit and used it to steal information from infected\nPCs:\n\n_Contents of the root folder on the backdoor’s C&C_\n\n_Contents of the folder PowerATK_PS on the backdoor’s C&C_\n\nFor any inquiries contact intelreports@kaspersky com Page 12 of 14\n\n\n-----\n\n_Contents of the payload folder on the backdoor’s C&C_\n\n_Function within one of the Powershell modules that was launched on the victim PC under the_\n\n_name update.vbs with the help of a special VBS file_\n\nThe cybercriminals behind the Microcin attack also have other malicious programs in their arsenal.\nThese include a utility that secretly sends collected data to a malicious server with the help of the\nsystem program bitsadmin.exe, various utilities to obtain login credentials from browsers, a keylogger,\nas well as batch files to collect and create password-protected archives of isolated data collected by\nthe above utilities, and save them to a specific place so they can later be sent to cybercriminals.\n\nFor any inquiries contact intelreports@kaspersky com Page 13 of 14\n\n\n-----\n\n## Appendix 2. Indicators of compromise\n\n### MD5 (malicious documents)\n\n##### 371bae0fc70563c7fa1ec0e3a0f037f4\n\n a50b6ec77276cf235eaf2d14665bdb5c\n\n f4deeb3db67bae6cc224802fbad1f3f6\n\n 3f288e450a375a26bd9c4de7f2bcfd66\n\n 7bcf447a93fd37d068ec27dd04c301cb\n\n 873105f03ae425101ea206dcd6bc539f\n\n ab6544e1eba3af3f5236d99b755c701c\n\n 6e006124678ffc18458d1322de6232a7\n\n### MD5 (backdoors)\n\n##### 056f811ef41c213b037008300b0daf0d\n\n 3ebcacb207b33bd5376d00b24cb3386c\n\n 4644ce606ab4b62622e4a9e6a80d792d\n\n 4ba4346984a380e22afaccff78688a54\n\n 60cb9e553884085700e359e5367d5fb4\n\n 7771e1738fc2e4de210ac06a5e62c534\n\n 7a290a29ea0d84e4475e021fa87ec466\n\n 7d8ee0e91cd88bb36d84d52d1d796dea\n\n a54966098b2281e4b75b747dbb52f431\n\n a5c7b7a26fa0f15cbf7bdd3db597fbe6\n\n dc6c8bae242c43dad76970329270155e\n\n 335cb36cc21c47b849d370a892d759b8  \n\n 948fecf6a044b79de79dc69e09d9979b \n\nFor any inquiries contact intelreports@kaspersky com Page 14 of 14\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "99593a68-7f6e-400e-9a9f-a707f66d2e72",
            "created_at": "2022-11-23T11:07:14.353321Z",
            "updated_at": "2022-11-23T11:07:14.353321Z",
            "deleted_at": null,
            "name": "AGRO",
            "url": "https://apt.threattracking.com",
            "description": "APT Groups and Operations Spreadsheet",
            "reports": null
        },
        {
            "id": "6825b8cb-7d82-43d2-b0b0-d51c7e255b42",
            "created_at": "2023-01-06T13:46:37.642134Z",
            "updated_at": "2023-01-06T13:46:37.642134Z",
            "deleted_at": null,
            "name": "MISPGALAXY",
            "url": "https://www.misp-project.org/galaxy.html",
            "description": "MISP Galaxy Clusters",
            "reports": null
        }
    ],
    "references": [
        "https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/07170759/Microcin_Technical_4PDF_eng_final_s.pdf"
    ],
    "report_names": [
        "Microcin_Technical_4PDF_eng_final_s.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1506517809,
    "ts_modification_date": 1506517809,
    "files": {
        "pdf": "https://archive.orkl.eu/ac22f468a5b095a78445cbf05a7a20b17c2bc6e7.pdf",
        "text": "https://archive.orkl.eu/ac22f468a5b095a78445cbf05a7a20b17c2bc6e7.txt",
        "img": "https://archive.orkl.eu/ac22f468a5b095a78445cbf05a7a20b17c2bc6e7.jpg"
    }
}