{
    "id": "c97176af-56af-41d2-a22b-10f4cf5e9dc7",
    "created_at": "2023-01-12T15:05:05.574737Z",
    "updated_at": "2025-03-27T02:06:12.832373Z",
    "deleted_at": null,
    "sha1_hash": "b87dfe50d4751644382f4e80dd00d7ab61c5bfff",
    "title": "2022-03-16 - Uncovering Trickbot’s use of IoT devices in command-and-control infrastructure",
    "authors": "",
    "file_creation_date": "2022-05-28T23:23:26Z",
    "file_modification_date": "2022-05-28T23:23:26Z",
    "file_size": 288567,
    "plain_text": "# Uncovering Trickbot’s use of IoT devices in command- and-control infrastructure\n\n**[microsoft.com/security/blog/2022/03/16/uncovering-trickbots-use-of-iot-devices-in-command-and-control-infrastructure/](https://www.microsoft.com/security/blog/2022/03/16/uncovering-trickbots-use-of-iot-devices-in-command-and-control-infrastructure/)**\n\nMarch 16, 2022\n\nTrickbot, a sophisticated trojan that has evolved significantly since its discovery in 2016, has\n[continually expanded its capabilities and, even with disruption efforts and news of its](https://www.microsoft.com/security/blog/2020/10/12/trickbot-disrupted/)\ninfrastructure going offline, it has managed to remain one of the most persistent threats in\nrecent years. The malware’s modular nature has allowed it to be increasingly adaptable to\ndifferent networks, environments, and devices. In addition, it has grown to include numerous\nplug-ins, access-as-a-service backdoors for other malware like Ryuk ransomware, and\nmining capabilities. A significant part of its evolution also includes making its attacks and\ninfrastructure more durable against detection, including continuously improving its\n[persistence capabilities, evading researchers and reverse engineering, and finding new ways](https://securityintelligence.com/posts/trickbot-bolsters-layered-defenses-prevent-injection/)\nto maintain the stability of its command-and-control (C2) framework.\n\nThis continuous evolution has seen Trickbot expand its reach from computers to Internet of\nThings (IoT) devices such as routers, with the malware updating its C2 infrastructure to\n[utilize MikroTik devices and modules.](https://orangecyberdefense.com/uk/blog/cyberdefense/the-trickbot-and-mikrotik-connection/) [MikroTik routers are widely used around the world](https://mikrotik.com/)\nacross different industries. By using MikroTik routers as proxy servers for its C2 servers and\nredirecting the traffic through non-standard ports, Trickbot adds another persistence layer\nthat helps malicious IPs evade detection by standard security systems.\n\n\n-----\n\nThe Microsoft Defender for IoT research team has recently discovered the exact method\nthrough which MikroTik devices are used in Trickbot’s C2 infrastructure. In this blog, we will\nshare our analysis of the said method and provide insights on how attackers gain access to\nMikroTik devices and use compromised IoT devices in Trickbot attacks.\n\nThis analysis has enabled us to develop a forensic tool to identify Trickbot-related\ncompromise and other suspicious indicators on MikroTik devices. We [published this tool to](https://github.com/microsoft/routeros-scanner)\nhelp customers ensure these IoT devices are not susceptible to these attacks. We’re also\nsharing recommended steps for detection and remediating compromise if found, as well as\ngeneral prevention steps to protect against future attacks.\n\n_Figure 1. Trickbot attack diagram_\n\n## How attackers compromise MikroTik devices for Trickbot C2\n\nThe purpose of Trickbot for using MikroTik devices is to create a line of communication\nbetween the Trickbot-affected device and the C2 server that standard defense systems in the\nnetwork are not able to detect. The attackers begin by hacking into a MikroTik router. They\ndo this by acquiring credentials using several methods, which we will discuss in detail in the\nfollowing section.\n\nThe attackers then issue a unique command that redirects traffic between two ports in the\nrouter, establishing the line of communication between Trickbot-affected devices and the C2.\nMikroTik devices have unique hardware and software, RouterBOARD and RouterOS. This\n\n\n-----\n\nmeans that to run such a command, the attackers need expertise in RouterOS SSH shell\ncommands. We uncovered this attacker method by tracking traffic containing these SSH\nshell commands.\n\n_Figure 2. Direct line of communication between the Trickbot infected device and the Trickbot_\n_C2_\n\n### Accessing the MikroTik device and maintaining access\n\nAttackers first need to access the MikroTik shell to run the routing commands. To do so, they\nneed to acquire credentials. As mentioned earlier, based on our analysis, there are several\nmethods that attackers use to access a target router:\n\n**Using default MikroTik passwords.**\n**Launching brute force attacks. We have seen attackers use some unique passwords**\nthat probably were harvested from other MikroTik devices.\n**Exploiting CVE-2018-14847 on devices with RouterOS versions older than 6.42.**\nThis vulnerability gives the attacker the ability to read arbitrary files like user.dat, which\ncontains passwords.\n\nTo maintain access, the attackers then change the affected router’s password.\n\n### Redirecting traffic\n\nMikroTik devices have a unique Linux-based OS called RouterOS with a unique SSH shell\nthat can be accessed through SSH protocol using a restricted set of commands. These\ncommands can be easily identified by the prefix “/”. For example:\n```\n/ip\n/system\n/tool\n\n```\nThese commands usually won’t have any meaning on regular Linux-based shells and are\nsolely intended for MikroTik devices. We observed through Microsoft threat data the use of\nthese types of commands. Understanding that these are MikroTik-specific commands, we\nwere able to track their source and intent. For example, we observed attackers issuing the\nfollowing commands:\n```\n/ip firewall nat add chain=dstnat proto=tcp dst-port=449  to-port=80 action=dst-nat\nto-addresses=<infected device> dst-address=<real C2 address>\n\n```\n\n-----\n\nFrom the command, we can understand the following:\n\nA new rule, similar to iptables, is created\nThe rule redirects traffic from the device to a server\nThe redirected traffic is received from port 449 and redirected to port 80\n\nThe said command is a legitimate network address translation (NAT) command that allows\nthe NAT router to perform IP address rewriting. In this case, it is being used for malicious\nactivity. Trickbot is known for using ports 443 and 449, and we were able to verify that some\ntarget servers were identified as TrickBot C2 servers in the past.\n\nThis analysis highlights the importance of keeping IoT devices secure in today’s ever\nevolving threat environment. Using Microsoft threat data, Microsoft’s IoT and operational\ntechnology (OT) security experts established the exact methods that attackers use to\nleverage compromised IoT devices and gained knowledge that can help us better protect\ncustomers from threats.\n\n## Defending IoT devices against Trickbot attacks\n\nAs security solutions for conventional computing devices continue to evolve and improve,\nattackers will explore alternative ways to compromise target networks. Attack attempts\nagainst routers and other IoT devices are not new, and being unmanaged, they can easily be\nthe weakest links in the network. Therefore, organizations should also consider these\ndevices when implementing security policies and best practices.\n\n### An open-source tool for MikroTik forensics\n\nWhile investigating MikroTik and attacks in the wild, we observed several methods of\nattacking these devices in addition to the method we described in this blog. We aggregated\nour knowledge of these methods and known CVEs into an open-source tool that can extract\nthe forensic artifacts related to these attacks.\n\nSome of this tool’s functionalities include the following:\n\nGet the version of the device and map it to CVEs\nCheck for scheduled tasks\nLook for traffic redirection rules (NAT and other rules)\nLook for DNS cache poisoning\nLook for default ports change\nLook for non-default users\n\n[We have published the tool in GitHub and are sharing this tool with the broader community to](https://github.com/microsoft/routeros-scanner)\nencourage better intelligence-sharing in the field of IoT security and to help build better\nprotections against threat actors abusing IoT devices.\n\n\n-----\n\n### How to detect, remediate, and prevent infections\n\nOrganizations with potentially at-risk MikroTik devices can perform the following detection\nand remediation steps:\n\nRun the following command to detect if the NAT rule was applied to the device\n(completed by the tool as well):\n```\n/ip firewall nat print\n\n```\nIf the following data exists, it might indicate infection:\n```\nchain=dstnat action=dst-nat to-addresses=<public IP address>\nto-ports=80 protocol=tcp dst-address=<your MikroTik IP> dst-port=449\nchain=srcnat action=masquerade src-address=<your MikroTik IP>\n\n```\nRun the following command to remove the potentially malicious NAT rule:\n```\n/ip firewall nat remove numbers=<rule number to remove>\n\n```\nTo prevent future infections, perform the following steps:\n\nChange the default password to a strong one\nBlock port 8291 from external access\nChange SSH port to something other than default (22)\nMake sure routers are up to date with the latest firmware and patches\nUse a secure virtual private network (VPN) service for remote access and restrict\nremote access to the router\n\n### Protect IoT devices and IT networks with Microsoft Defender\n\nTo harden IoT devices and IT networks against threats like Trickbot, organizations must\nimplement solutions that detect malicious attempts to access devices and raises alerts on\nanomalous network behavior. [Microsoft Defender for IoT provides agentless, network-layer](https://azure.microsoft.com/services/iot-defender/)\nsecurity that lets organizations deploy continuous asset discovery, vulnerability management,\nand threat detection for IoT, OT devices, and Industrial Control Systems (ICS) on-premises\nor in Azure-connected environments. It is updated regularly with indicators of compromise\n(IoCs) from threat research like the one described on this blog, and rules to detect malicious\nactivity.\n\n[Meanwhile, Microsoft 365 Defender protects against attacks related to highly modular, multi-](https://www.microsoft.com/security/business/threat-protection/microsoft-365-defender)\nstage malware like Trickbot by coordinating threat data across identities, endpoints, cloud\napps, email, and documents. Such cross-domain visibility allows Microsoft 365 Defender to\ncomprehensively detect and remediate Trickbot’s end-to-end attack chain—from malicious\nattachments and links it sends via emails to its follow-on activities in endpoints. Its rich set of\ntools like [advanced hunting also lets defenders surface threats and gain insights for](https://docs.microsoft.com/microsoft-365/security/defender-endpoint/advanced-hunting-overview?view=o365-worldwide)\nhardening networks from compromise.\n\n\n-----\n\nIn addition, working with the Microsoft Defender for IoT Research Team, RiskIQ identified\ncompromised MikroTik routers acting as communication channels for Trickbot C2 and\n[created detection logic to flag devices under threat actor control. See RiskIQ’s article.](https://community.riskiq.com/article/111d6005)\n\n[To learn more about securing your IoT and OT devices, explore Microsoft Defender for IoT.](https://azure.microsoft.com/services/iot-defender/)\n\n**_David Atch, Section 52 at Microsoft Defender for IoT_**\n**_Noa Frumovich, Section 52 at Microsoft Defender for IoT_**\n**_Ross Bevington, Microsoft Threat Intelligence Center (MSTIC)_**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-16 - Uncovering Trickbot’s use of IoT devices in command-and-control infrastructure.pdf"
    ],
    "report_names": [
        "2022-03-16 - Uncovering Trickbot’s use of IoT devices in command-and-control infrastructure.pdf"
    ],
    "threat_actors": [
        {
            "id": "4d5f939b-aea9-4a0e-8bff-003079a261ea",
            "created_at": "2023-01-06T13:46:39.04841Z",
            "updated_at": "2025-03-27T02:00:02.985296Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "G0096",
                "Grayfly",
                "BARIUM",
                "BRONZE ATLAS",
                "BRONZE EXPORT",
                "Red Kelpie",
                "HOODOO",
                "Brass Typhoon",
                "TA415",
                "WICKED SPIDER",
                "WICKED PANDA",
                "G0044",
                "Earth Baku"
            ],
            "source_name": "MISPGALAXY:APT41",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e698860d-57e8-4780-b7c3-41e5a8314ec0",
            "created_at": "2022-10-25T15:50:23.287929Z",
            "updated_at": "2025-03-27T02:00:55.43005Z",
            "deleted_at": null,
            "main_name": "APT41",
            "aliases": [
                "APT41",
                "Wicked Panda",
                "Brass Typhoon",
                "BARIUM"
            ],
            "source_name": "MITRE:APT41",
            "tools": [
                "ASPXSpy",
                "BITSAdmin",
                "PlugX",
                "Impacket",
                "gh0st RAT",
                "netstat",
                "PowerSploit",
                "ZxShell",
                "KEYPLUG",
                "ipconfig",
                "sqlmap",
                "China Chopper",
                "ShadowPad",
                "MESSAGETAP",
                "Mimikatz",
                "certutil",
                "njRAT",
                "Cobalt Strike",
                "pwdump",
                "BLACKCOFFEE",
                "ROCKBOOT",
                "dsquery",
                "Winnti for Linux",
                "DUSTTRAP",
                "Derusbi",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535905,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1653780206,
    "ts_modification_date": 1653780206,
    "files": {
        "pdf": "https://archive.orkl.eu/b87dfe50d4751644382f4e80dd00d7ab61c5bfff.pdf",
        "text": "https://archive.orkl.eu/b87dfe50d4751644382f4e80dd00d7ab61c5bfff.txt",
        "img": "https://archive.orkl.eu/b87dfe50d4751644382f4e80dd00d7ab61c5bfff.jpg"
    }
}