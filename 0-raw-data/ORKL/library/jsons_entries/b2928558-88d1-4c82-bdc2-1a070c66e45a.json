{
    "id": "b2928558-88d1-4c82-bdc2-1a070c66e45a",
    "created_at": "2023-01-12T15:01:44.122705Z",
    "updated_at": "2025-03-27T02:17:27.760958Z",
    "deleted_at": null,
    "sha1_hash": "393b16faa2b89f9c017b51640dcb4a09e8186584",
    "title": "2019-04-23 - APT34- webmask project",
    "authors": "",
    "file_creation_date": "2022-05-28T17:54:11Z",
    "file_modification_date": "2022-05-28T17:54:11Z",
    "file_size": 463811,
    "plain_text": "# APT34: webmask project\n\n**marcoramilli.com/2019/04/23/apt34-webmask-project/**\n\nView all posts by marcoramilli April 23, 2019\n\nToday I’d like to share a quick analysis on the `webmask project standing behind the DNS`\n[attacks implemented by APT34. Thanks to the leaked source code is now possible to check](https://github.com/marcoramilli/APT34)\nAPT34 implementations and techniques.\n\n**Context:**\n\n[Since at least 2014, an Iranian threat group tracked by FireEye as APT34 has conducted](https://www.fireeye.com/blog/threat-research/2017/12/targeted-attack-in-middle-east-by-apt34.html)\nreconnaissance aligned with the strategic interests of Iran. The group conducts operations\nprimarily in the Middle East, targeting financial, government, energy, chemical,\ntelecommunications and other industries. Repeated targeting of Middle Eastern financial,\nenergy and government organisations leads FireEye to assess that those sectors are a\nprimary concern of APT34. The use of infrastructure tied to Iranian operations, timing and\nalignment with the national interests of Iran also lead FireEye to assess that APT34 acts on\n[behalf of the Iranian government. (Source: MISP Project).](https://github.com/MISP/misp-galaxy/blob/master/clusters/threat-actor.json)\n\nOn April 19 2019 researchers at Chronicle, a security company owned by Google’s parent\ncompany, Alphabet, have examined the leaked tools, exfiltrated the past week on a Telegram\nchannel, and confirmed that they are indeed the same ones used by the OilRig attackers.\n[OilRig has been connected to a number of intrusions at companies and government](https://attack.mitre.org/groups/G0049/)\nagencies across the Middle East and Asia, including technology firms, telecom companies,\n\n\n-----\n\nand even gaming companies. Whoever is leaking the toolset also has been dumping\ninformation about the victims OilRig has targeted, as well as data identifying some of the\nservers the group uses in its attacks.\n\nAccording to [Duo, “OilRig delivered Trojans that use DNS tunneling for command and](https://duo.com/decipher/someone-is-leaking-an-iranian-hacking-group-s-arsenal)\n**control in attacks since at least May 2016. Since May 2016, the threat group has**\n**introduced new tools using different tunneling protocols to their tool set” Robert**\nFalcone of Palo Alto Networks’ Unit 42 research team wrote in an analysis of the group’s\nactivities.\n\n“Regardless of the tool, all of the DNS tunneling protocols use DNS queries to resolve\nspecially crafted subdomains to transmit data to the C2 and the answers to these\nqueries to receive data from the C2.”\n\n**Leaked Source code**\n\n[The initial leaked source code sees three main folders:](https://github.com/marcoramilli/APT34) `webmask,` `poisonfrog and`\n```\nWebshells_and_Panel . While webmask and poisonfrog seems to be single projects,\n\n```\nthe folder `Webshells_and_Panel looks like wrapping more projects into a single bucket.`\nBut, for today, let’s focus on `webmask .`\n\n**WEBMask Focus**\n\nThe `webmask project, in my personal opinion, is an APT34 distinction since implementing`\ntheir DNS attack core. APT34 is well-known to widely use DNS Hijacking in order to redirect\nvictims to attackers websites. So let’s see what they’ve implemented so far on this direction.\n\nThe `webmask project comes with both: a guide ( guide.txt ) and an installation script`\n( install.sh ). From the latter we might appreciate the NodeJS installed version which\nhappens to be 6.X. This version was released on 2016-04-26 for the first time. Nowadays is\nstill on development track as the name of “Boron”. According to the NodeJS historic\nversioning that project could not be dated before April 2016 since Nodejs_6.x was not\nexisting before that date. The guide.txt file suggests two solutions (this is the used term) both\nof them base their ‘core engine’ on a developed DNS server, used as authoritative name\nservers to respond crafted ‘A’ records to specific requests. The attackers suggest to use\nsolution2 (they write “use this” directly on configuration file), the one who implements DNS\nserver in NodeJS language. On the other side the Solution1 uses python as DNS server. The\nfollowing image shows the suggested Solution.\n\n\n-----\n\nAPT34: WebMask Project Suggested Solution\nSome domain names and some IPs are used as configuration example. Personally I always\nfind interesting to see the attacker suggested examples, since they lets a marked flavour of\nher. That time the attacker used some target artefacts (IP and DNS) belonging to ‘Arab\nEmirates’ net space while she used as a responsive artefact (the one used to attack) an IP\n[address belonging to a NovinVPS service.](https://www.novinvps.com/)\n\nThe guide follows on describing the setup of ICAP proxy server, used to proxy the victims to\nthe real destination but trapping the entire connections. The attacker suggests Squid3 and\nguides the operator to install and to configure it. She uses as ICAP handler a simple python\nscript placed into `icap/icap.py folder. This script has been developed in order to log and`\n[to modify the ICAP/connection flow coming from squid3 proxy. Then a well-known Haproxy is](http://www.haproxy.org/)\nused as High Availability service for assuring connections and finally certbot (Let’s Encrypt)\nis used to give valid certificate to squid3 (but it’s not a mandatory neither a suggested step).\n\n**DNS Server scripts**\n\nIn the folder `dns-redir 3 files are placed. A configuration file called` `config.json is`\nused by `dnsd.py . The python script implements a class named` `MyUDPHandler which is`\ngiven to the native `SocketServer.UDPServer and used as UDP handler. The script`\noverrides only DNS `A records if included into the` `overrides object (variable at the`\nbeginning of source code). In other words if the DNS request is an `A record and if the`\nrequested name belongs to specific domain name, the script responds with the attacker IP\naddress. The following image shows the main 3 steps of the override chain.\n\n\n-----\n\nDNSD.py: Three steps DNS overriding chain\nAccording to the guide.txt the suggested solution wont be the dnsd.py, but the attacker would\nprefer the dnsd.js script. This script appears not externally configurable (it does not import\nconfig.json) so if you want to configure it you need to manually edit the script source code.\nThe source is written in an classic style ECMAScript without any fancy or new\noperators/features introduced in ECMAScript6 and ECMAScript7. The dnsd.js performs the\nsame tasks performed by dnsd.py without any specific change.\n\n**ICAP script**\n\nIn the `icap folder a python script called` `icap.py is placed. This script handles ICAP`\nflows coming from squid3, extracts desired informations and injects tracking pixels. The\npython script implements a `ThreadingSimpleServer as an implementation of`\n```\nSocketServer.ThreadingMixIn which is a native framework for multi-threading Network\n\n```\nservers. `SocketServer.ThreadingMixIn needs a local address and local port to be`\nspawned and a `BaseICAPRequestHandler class as second parameter in order to handle`\nICAP flows. The attacker specialised that class by referring to the general `ICAPHandler .`\nAims of the script is to log into separated files the following information: credentials, cookies,\ninjected files and headers. It silently injects a tracking pixel into communications by adding\nthe following javascript to HTML body.\n```\nscript = ';$(document).ready(function(){$(\\'<img src=\"file://[ip]/resource/logo.jpg\">\n<img src=\"http://WPAD/avatar.jpg\">\\');});'\n\n```\nIf the parsed request is a HTTP POST the `ICAPHandler tries to extract credentials through`\nspecial function called: `extract_login_password . The following image shows the process`\nflow of the credential extraction.\n\n\n-----\n\nICAP.py: Credential Extraction Process\nIt would be interesting, at least in my point of view, to check the used patterns as login\ndetection. For example the parsing function looks for the following “form names”:\n```\nlogins = ['login', 'log-in', 'log_in', 'signin', 'sign-in', 'logon', 'log-on']\n\n```\nIt also looks for the following user field names:\n```\nuserfields = ['log','login', 'wpname', 'ahd_username', 'unickname', 'nickname',\n'user', 'user_name','alias', 'pseudo', 'email', 'username', '_username', 'userid',\n'form_loginname', 'loginname',\n 'login_id', 'loginid', 'session_key', 'sessionkey', 'pop_login', 'uid', 'id',\n'user_id', 'screename', 'uname', 'ulogin', 'acctname', 'account', 'member',\n'mailaddress', 'membername', 'login_username', 'login_email', 'loginusername',\n'loginemail', 'uin', 'sign-in', 'usuario']\n\n```\nand finally it also looks for the following password fields names:\n```\npassfields = ['ahd_password', 'pass', 'password', '_password', 'passwd',\n'session_password', 'sessionpassword', 'login_password', 'loginpassword', 'form_pw',\n'pw', 'userpassword', 'pwd', 'upassword', 'login_password','passwort', 'passwrd',\n'wppassword', 'upasswd','senha','contrasena', 'secret']\n\n```\nInteresting to see specific string patterns such as (but not limited to): form_pw,\nahd_password, upassword, senha, contrasena, which are quite indicative to victim\nscenarios. For example strings such as: `senha,` `contrasena, usuario, and so on`\nseems to be related to”Spanish” / “Portuguese” words. So if it’s true (and google translate\n\n\n-----\n\nagrees with me) it looks like APT34 are proxying some connections that might have those\nusername and password fields, which might refer to “Spanish”/”Portuguese” targets. But this\nis only a Hypothesis.\n\nThe `icap.py is able to intercept basic authentication headers, cookies and general`\nheaders as well, implementing similar functions able to extract interesting information and\neventually to modify them if needed. I wont describe every single functions but one of the\nmost interesting function that is worth of being showed is the `inject_RESPMOD which`\ninjects a tracking image into the ICAP flow. The following image shows the attacker’s\nimplementation of the `Injection_RESPMOD function.`\n\nICAP.py: script injection function\nThe injected script is added to the HTML body and eventually is GZipped and shipped back.\nIn such a way the attacker tracks who is landing to the target domain.\n\n**Interesting points**\n\n\n-----\n\nWebMask is >= April 2016 (From Installed Dependencies)\nAPT34 might target ‘Arab Emirate’ (From examples into config files)\nAPT34 might target Spanish/Portuguese (From code into the\n```\nextract_login_password function )\n\n```\nAPT34 might use NovinVPS (From examples into config files)\nAPT34 needs credentials for change Authoritative DNS (From guide.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-04-23 - APT34- webmask project.pdf"
    ],
    "report_names": [
        "2019-04-23 - APT34- webmask project.pdf"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "761d1fb2-60e3-46f0-9f1c-c8a9715967d4",
            "created_at": "2023-01-06T13:46:38.269054Z",
            "updated_at": "2025-03-27T02:00:02.789278Z",
            "deleted_at": null,
            "main_name": "APT3",
            "aliases": [
                "TG-0110",
                "Group 6",
                "Buckeye",
                "Boyusec",
                "BORON",
                "BRONZE MAYFAIR",
                "Red Sylvan",
                "GOTHIC PANDA"
            ],
            "source_name": "MISPGALAXY:APT3",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535704,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653760451,
    "ts_modification_date": 1653760451,
    "files": {
        "pdf": "https://archive.orkl.eu/393b16faa2b89f9c017b51640dcb4a09e8186584.pdf",
        "text": "https://archive.orkl.eu/393b16faa2b89f9c017b51640dcb4a09e8186584.txt",
        "img": "https://archive.orkl.eu/393b16faa2b89f9c017b51640dcb4a09e8186584.jpg"
    }
}