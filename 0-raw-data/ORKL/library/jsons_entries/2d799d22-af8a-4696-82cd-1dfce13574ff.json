{
    "id": "2d799d22-af8a-4696-82cd-1dfce13574ff",
    "created_at": "2023-01-12T15:04:58.954098Z",
    "updated_at": "2025-03-27T02:05:29.812961Z",
    "deleted_at": null,
    "sha1_hash": "6e15f7a29af409fd10d43046a957ef3d2730bcfb",
    "title": "2018-07-31 - Scanner for CobaltStrike",
    "authors": "",
    "file_creation_date": "2022-05-28T03:37:59Z",
    "file_modification_date": "2022-05-28T03:37:59Z",
    "file_size": 117408,
    "plain_text": "# aa-tools/cobaltstrikescan.py at master · JPCERTCC/aa- tools · GitHub\n\n**[github.com/JPCERTCC/aa-tools/blob/master/cobaltstrikescan.py](https://github.com/JPCERTCC/aa-tools/blob/master/cobaltstrikescan.py)**\n\nJPCERTCC\n\n# Detecting CobaltStrike for Volatility\n\n#\n\n# How to use:\n\n# 1. locate \"cobaltstrikescan.py\" in [Volatility_Plugins_Directory]\n\n# ex) mv cobaltstrikescan.py /usr/lib/python2.7/dist-packages/volatility/plugins/malware\n\n# 2. python vol.py [cobaltstrikescan | cobaltstrikeconfig ] -f images.mem -profile=Win7SP1x64\n\nimport volatility.plugins.taskmods as taskmods\n\nimport volatility.win32.tasks as tasks\n\nimport volatility.utils as utils\n\nimport volatility.debug as debug\n\nimport volatility.plugins.malware.malfind as malfind\n\n\n-----\n\nimport volatility.plugins.malware as malware\n\nimport re\n\nfrom struct import pack, unpack, unpack_from, calcsize\n\nfrom socket import inet_ntoa\n\ntry:\n\nimport yara\n\nhas_yara = True\n\nexcept ImportError:\n\nhas_yara = False\n\ncobaltstrike_sig = {\n\n'namespace1' : 'rule CobaltStrike { \\\n\nstrings: \\\n\n$v1 = { 73 70 72 6E 67 00} \\\n\n$v2 = { 69 69 69 69 69 69 69 69} \\\n\ncondition: $v1 and $v2}'\n\n}\n\nCONF_PATTERNS = [{\n\n'pattern': '\\x69\\x68\\x69\\x68\\x69',\n\n'cfg_size': 0x1000,\n\n'cfg_info': [['\\x00\\x01\\x00\\x01\\x00\\x02', 'BeaconType\\t\\t:', 0x2],\n\n['\\x00\\x02\\x00\\x01\\x00\\x02', 'Port\\t\\t\\t:', 0x2], ['\\x00\\x03\\x00\\x02\\x00\\x04',\n'Polling(ms)\\t\\t:', 0x4],\n\n['\\x00\\x04\\x00\\x02\\x00\\x04', 'Unknown1\\t\\t:', 0x4], ['\\x00\\x05\\x00\\x01\\x00\\x02',\n'Jitter\\t\\t\\t:', 0x2], ['\\x00\\x06\\x00\\x01\\x00\\x02', 'Maxdns\\t\\t\\t:', 0x2],\n\n['\\x00\\x07\\x00\\x03\\x01\\x00', 'Unknown2\\t\\t:', 0x100], ['\\x00\\x08\\x00\\x03\\x01\\x00',\n'C2Server\\t\\t:', 0x100], ['\\x00\\x09\\x00\\x03\\x00\\x80', 'UserAgent\\t\\t:', 0x80],\n\n\n-----\n\n['\\x00\\x0a\\x00\\x03\\x00\\x40', 'HTTP_Method2_Path\\t:', 0x40],\n\n['\\x00\\x0b\\x00\\x03\\x01\\x00', 'Unknown3\\t\\t:', 0x100], ['\\x00\\x0c\\x00\\x03\\x01\\x00',\n'Header1\\t\\t\\t:', 0x100],\n\n['\\x00\\x0d\\x00\\x03\\x01\\x00', 'Header2\\t\\t\\t:', 0x100], ['\\x00\\x0e\\x00\\x03\\x00\\x40',\n'Injection_Process\\t:', 0x40], ['\\x00\\x0f\\x00\\x03\\x00\\x80', 'PipeName\\t\\t:', 0x80],\n\n['\\x00\\x10\\x00\\x01\\x00\\x02', 'Year\\t\\t\\t:', 0x2], ['\\x00\\x11\\x00\\x01\\x00\\x02', 'Month\\t\\t\\t:',\n0x2], ['\\x00\\x12\\x00\\x01\\x00\\x02', 'Day\\t\\t\\t:', 0x2],\n\n['\\x00\\x13\\x00\\x02\\x00\\x04', 'DNS_idle\\t\\t:', 0x4], ['\\x00\\x14\\x00\\x02\\x00\\x04',\n'DNS_sleep(ms)\\t\\t:', 0x2], ['\\x00\\x1a\\x00\\x03\\x00\\x10', 'Method1\\t\\t\\t:', 0x10],\n\n['\\x00\\x1b\\x00\\x03\\x00\\x10', 'Method2\\t\\t\\t:', 0x10], ['\\x00\\x1c\\x00\\x02\\x00\\x04',\n'Unknown4\\t\\t:', 0x4], ['\\x00\\x1d\\x00\\x03\\x00\\x40', 'Spawnto_x86\\t\\t:', 0x40],\n\n['\\x00\\x1e\\x00\\x03\\x00\\x40', 'Spawnto_x64\\t\\t:', 0x40], ['\\x00\\x1f\\x00\\x01\\x00\\x02',\n'Unknown5\\t\\t:', 0x2], ['\\x00\\x20\\x00\\x03\\x00\\x80', 'Proxy_HostName\\t\\t:', 0x80],\n\n['\\x00\\x21\\x00\\x03\\x00\\x40', 'Proxy_UserName\\t\\t:', 0x40], ['\\x00\\x22\\x00\\x03\\x00\\x40',\n'Proxy_Password\\t\\t:', 0x40], ['\\x00\\x23\\x00\\x01\\x00\\x02', 'Proxy_AccessType\\t:', 0x2],\n\n['\\x00\\x24\\x00\\x01\\x00\\x02', 'create_remote_thread\\t:', 0x2]]\n\n}]\n\nBEACONTYPE = {0x0: \"0 (HTTP)\", 0x1: \"1 (Hybrid HTTP and DNS)\", 0x8: \"8 (HTTPS)\"}\n\nACCESSTYPE = {0x1: \"1 (use direct connection)\", 0x2: \"2 (use IE settings)\", 0x4: \"4\n(use proxy server)\"}\n\nclass cobaltstrikeScan(taskmods.DllList):\n\n\"\"\"Detect processes infected with CobaltStrike malware\"\"\"\n\n@staticmethod\n\ndef is_valid_profile(profile):\n\nreturn (profile.metadata.get('os', 'unknown') == 'windows')\n\ndef get_vad_base(self, task, address):\n\nfor vad in task.VadRoot.traverse():\n\nif address >= vad.Start and address < vad.End:\n\n\n-----\n\nreturn vad.Start\n\nreturn None\n\ndef calculate(self):\n\nif not has_yara:\n\ndebug.error(\"Yara must be installed for this plugin\")\n\naddr_space = utils.load_as(self._config)\n\nos = self.is_valid_profile(addr_space.profile)\n\nif not os:\n\ndebug.error(\"This command does not support the selected profile.\")\n\nrules = yara.compile(sources=cobaltstrike_sig)\n\nfor task in self.filter_tasks(tasks.pslist(addr_space)):\n\nscanner = malfind.VadYaraScanner(task=task, rules=rules)\n\nfor hit, address in scanner.scan():\n\nvad_base_addr = self.get_vad_base(task, address)\n\nyield task, vad_base_addr\n\nbreak\n\ndef render_text(self, outfd, data):\n\nself.table_header(outfd, [(\"Name\", \"20\"),\n\n(\"PID\", \"8\"),\n\n(\"Data VA\", \"[addrpad]\")])\n\n\n-----\n\nfor task, start in data:\n\nself.table_row(\n\noutfd, task.ImageFileName, task.UniqueProcessId, start)\n\nclass cobaltstrikeConfig(cobaltstrikeScan):\n\n\"\"\"Parse the CobaltStrike configuration\"\"\"\n\ndef get_vad_end(self, task, address):\n\nfor vad in task.VadRoot.traverse():\n\nif address == vad.Start:\n\nreturn vad.End + 1\n\nreturn None\n\ndef decode_config(self, cfg_blob):\n\nreturn \"\".join(chr(ord(cfg_offset) ^ 0x69) for cfg_offset in cfg_blob)\n\ndef parse_config(self, cfg_blob, nw, outfd):\n\noutfd.write(\"[CobaltStrike Config Info]\\n\")\n\nfor pattern, name, size in nw['cfg_info']:\n\nif name.count('Port'):\n\nport = unpack_from('>H', cfg_blob, 0xE)[0]\n\noutfd.write(\"%s %d\\n\" % (name, port))\n\ncontinue\n\noffset = cfg_blob.find(pattern)\n\nif offset == -1:\n\noutfd.write(\"%s\\n\" % name)\n\ncontinue\n\n\n-----\n\nconfig_data = cfg_blob[offset + 6:offset + 6 + size]\n\nif name.count('Unknown'):\n\noutfd.write(\"%s %s\\n\" % (name, repr(config_data)))\n\ncontinue\n\nif size == 2:\n\nif name.count('BeaconType'):\n\noutfd.write(\"%s %s\\n\" %\n\n(name, BEACONTYPE[unpack('>H', config_data)[0]]))\n\nelif name.count('AccessType'):\n\noutfd.write(\n\n\"%s %s\\n\" % (name, ACCESSTYPE[unpack('>H', config_data)[0]]))\n\nelif name.count('create_remote_thread'):\n\nif unpack('>H', config_data)[0] != 0:\n\noutfd.write(\"%s Enable\\n\" % name)\n\nelse:\n\noutfd.write(\"%s Disable\\n\" % name)\n\nelse:\n\noutfd.write(\n\n\"%s %d\\n\" % (name, unpack('>H', config_data)[0]))\n\nelif size == 4:\n\nif name.count('DNS_idle'):\n\noutfd.write(\"%s %s\\n\" % (name, inet_ntoa(config_data)))\n\nelse:\n\noutfd.write(\"%s %d\\n\" %\n\n(name, unpack('>I', config_data)[0]))\n\nelse:\n\n\n-----\n\nif name.count('Header'):\n\noutfd.write(\"%s \" % name)\n\ncfg_offset = 3\n\nflag = 0\n\nwhile 1:\n\nif cfg_offset > 255:\n\nbreak\n\nelse:\n\nif config_data[cfg_offset] != '\\x00':\n\nif config_data[cfg_offset + 1] != '\\x00':\n\nif flag:\n\noutfd.write(\"\\t\\t\\t: \")\n\noutfd.write(\"%s\\n\" % config_data[\n\n(cfg_offset + 1):].split('\\x00')[0])\n\ncfg_offset = config_data[cfg_offset:].find(\n\n'\\x00\\x00\\x00') + cfg_offset - 1\n\nflag += 1\n\nelse:\n\ncfg_offset += 4\n\ncontinue\n\nelse:\n\ncfg_offset += 4\n\ncontinue\n\nelse:\n\noutfd.write(\"%s %s\\n\" % (name, config_data))\n\ndef render_text(self, outfd, data):\n\n\n-----\n\ndelim = '-' * 70\n\nfor task, start in data:\n\nproc_addr_space = task.get_process_address_space()\n\ndata = proc_addr_space.zread(\n\nstart, self.get_vad_end(task, start) - start)\n\nfor nw in CONF_PATTERNS:\n\ncfg_addr = data.find(nw['pattern'])\n\nif cfg_addr != -1:\n\nbreak\n\nelse:\n\ncontinue\n\noutfd.write(\"config addr: %08X\\n\\n\" % cfg_addr)\n\noutfd.write(\"{0}\\n\".format(delim))\n\ncfg_blob = data[cfg_addr:cfg_addr + nw['cfg_size']]\n\noutfd.write(\"Process: %s (%d)\\n\\n\" %\n\n(task.ImageFileName, task.UniqueProcessId))\n\nself.parse_config(self.decode_config(cfg_blob), nw, outfd)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-07-31 - Scanner for CobaltStrike.pdf"
    ],
    "report_names": [
        "2018-07-31 - Scanner for CobaltStrike.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535898,
    "ts_updated_at": 1743041129,
    "ts_creation_date": 1653709079,
    "ts_modification_date": 1653709079,
    "files": {
        "pdf": "https://archive.orkl.eu/6e15f7a29af409fd10d43046a957ef3d2730bcfb.pdf",
        "text": "https://archive.orkl.eu/6e15f7a29af409fd10d43046a957ef3d2730bcfb.txt",
        "img": "https://archive.orkl.eu/6e15f7a29af409fd10d43046a957ef3d2730bcfb.jpg"
    }
}