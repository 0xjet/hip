{
    "id": "1dae6afc-ed51-4dcb-9d04-e78ed79dbbd8",
    "created_at": "2022-10-25T16:48:22.613867Z",
    "updated_at": "2025-03-27T02:12:03.969097Z",
    "deleted_at": null,
    "sha1_hash": "ecc7718e285eba15ee5c9d610dc10fed75227bf3",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-03-12T03:23:26Z",
    "file_modification_date": "2021-03-12T03:23:26Z",
    "file_size": 502856,
    "plain_text": "# HAFNIUM targeting Exchange Servers with 0-day exploits\n\n**[microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)**\n\nMarch 2, 2021\n\n**_Update [03/08/2021]: Microsoft continues to see multiple actors taking advantage of_**\n_unpatched systems to attack organizations with on-premises Exchange Server. To aid_\n_defenders in investigating these attacks where Microsoft security products and tooling_\n_may not be deployed, we are releasing a feed of observed indicators of compromise_\n_(IOCs). The feed of malware hashes and known malicious file paths observed in related_\n_attacks is available in both JSON and CSV formats at the below GitHub links. This_\n_information is being shared as TLP:WHITE._\n\n[CSV format](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/MSTICIoCs-ExchangeServerVulnerabilitiesDisclosedMarch2021.csv)\n[JSON format](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/MSTICIoCs-ExchangeServerVulnerabilitiesDisclosedMarch2021.json)\n\n**_Update [03/05/2021]: Microsoft sees increased use of these vulnerabilities in attacks_**\n_targeting unpatched systems by multiple malicious actors beyond HAFNIUM. To aid_\n_customers in investigating these attacks, Microsoft Security Response Center (MSRC)_\n_has provided additional resources, including new mitigation guidance: Microsoft_\n_Exchange Server Vulnerabilities Mitigations – March 2021_\n\n**_Update [03/04/2021]: The Exchange Server team released a script for checking_**\n_HAFNIUM indicators of compromise (IOCs). See Scan Exchange log files for indicators_\n_of compromise._\n\nMicrosoft has detected multiple 0-day exploits being used to attack on-premises versions\nof Microsoft Exchange Server in limited and targeted attacks. In the attacks observed, the\nthreat actor used these vulnerabilities to access on-premises Exchange servers which\nenabled access to email accounts, and allowed installation of additional malware to\nfacilitate long-term access to victim environments. Microsoft Threat Intelligence Center\n[(MSTIC) attributes this campaign with high confidence to HAFNIUM, a group assessed to](https://blogs.microsoft.com/on-the-issues/?p=64505)\nbe state-sponsored and operating out of China, based on observed victimology, tactics\nand procedures.\n\nThe vulnerabilities recently being exploited were CVE-2021-26855, CVE-2021-26857,\nCVE-2021-26858, and CVE-2021-27065, all of which were addressed in today’s Microsoft\n[Security Response Center (MSRC) release – Multiple Security Updates Released for](https://msrc-blog.microsoft.com/2021/03/02/multiple-security-updates-released-for-exchange-server)\nExchange Server. We strongly urge customers to update on-premises systems\nimmediately. Exchange Online is not affected.\n\nWe are sharing this information with our customers and the security community to\nemphasize the critical nature of these vulnerabilities and the importance of patching all\naffected systems immediately to protect against these exploits and prevent future abuse\nacross the ecosystem. This blog also continues our mission to shine a light on malicious\n\n\n-----\n\nactors and elevate awareness of the sophisticated tactics and techniques used to target our\n[customers. The related IOCs, Azure Sentinel advanced hunting queries, and Microsoft](https://azure.microsoft.com/en-us/services/azure-sentinel/)\nDefender for Endpoint product detections and queries shared in this blog will help SOCs\nproactively hunt for related activity in their environments and elevate any alerts for\nremediation.\n\nMicrosoft would like to thank our industry colleagues at Volexity and Dubex for reporting\ndifferent parts of the attack chain and their collaboration in the investigation. Volexity\n[has also published a blog post with their analysis. It is this level of proactive](https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities)\ncommunication and intelligence sharing that allows the community to come together to\nget ahead of attacks before they spread and improve security for all.\n\n## Who is HAFNIUM?\n\nHAFNIUM primarily targets entities in the United States across a number of industry\nsectors, including infectious disease researchers, law firms, higher education institutions,\ndefense contractors, policy think tanks, and NGOs.\n\nHAFNIUM has previously compromised victims by exploiting vulnerabilities in internet[facing servers, and has used legitimate open-source frameworks, like Covenant, for](https://github.com/cobbr/Covenant)\ncommand and control. Once they’ve gained access to a victim network, HAFNIUM\n[typically exfiltrates data to file sharing sites like MEGA.](https://mega.nz/)\n\nIn campaigns unrelated to these vulnerabilities, Microsoft has observed HAFNIUM\ninteracting with victim Office 365 tenants. While they are often unsuccessful in\ncompromising customer accounts, this reconnaissance activity helps the adversary\nidentify more details about their targets’ environments.\n\nHAFNIUM operates primarily from leased virtual private servers (VPS) in the United\nStates.\n\n## Technical details\n\nMicrosoft is providing the following details to help our customers understand the\ntechniques used by HAFNIUM to exploit these vulnerabilities and enable more effective\ndefense against any future attacks against unpatched systems.\n\n[CVE-2021-26855 is a server-side request forgery (SSRF) vulnerability in Exchange which](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26855)\nallowed the attacker to send arbitrary HTTP requests and authenticate as the Exchange\nserver.\n\n[CVE-2021-26857 is an insecure deserialization vulnerability in the Unified Messaging](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26857)\nservice. Insecure deserialization is where untrusted user-controllable data is deserialized\nby a program. Exploiting this vulnerability gave HAFNIUM the ability to run code as\nSYSTEM on the Exchange server. This requires administrator permission or another\nvulnerability to exploit.\n\n\n-----\n\n[CVE-2021-26858 is a post-authentication arbitrary file write vulnerability in Exchange. If](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26858)\nHAFNIUM could authenticate with the Exchange server then they could use this\nvulnerability to write a file to any path on the server. They could authenticate by\nexploiting the CVE-2021-26855 SSRF vulnerability or by compromising a legitimate\nadmin’s credentials.\n\n[CVE-2021-27065 is a post-authentication arbitrary file write vulnerability in Exchange. If](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-27065)\nHAFNIUM could authenticate with the Exchange server then they could use this\nvulnerability to write a file to any path on the server. They could authenticate by\nexploiting the CVE-2021-26855 SSRF vulnerability or by compromising a legitimate\nadmin’s credentials.\n\n## Attack details\n\nAfter exploiting these vulnerabilities to gain initial access, HAFNIUM operators deployed\nweb shells on the compromised server. Web shells potentially allow attackers to steal data\nand perform additional malicious actions that lead to further compromise. One example\nof a web shell deployed by HAFNIUM, written in ASP, is below:\n\nFollowing web shell deployment, HAFNIUM operators performed the following postexploitation activity:\n\nUsing Procdump to dump the LSASS process memory:\n\nUsing 7-Zip to compress stolen data into ZIP files for exfiltration:\n\nAdding and using Exchange PowerShell snap-ins to export mailbox data:\n\n[Using the Nishang Invoke-PowerShellTcpOneLine reverse shell:](https://github.com/samratashok/nishang)\n\n\n-----\n\nDownloading PowerCat from GitHub, then using it to open a connection to a remote\nserver:\n\nHAFNIUM operators were also able to download the Exchange offline address book from\ncompromised systems, which contains information about an organization and its users.\n\n[Our blog, Defending Exchange servers under attack, offers advice for improving defenses](https://www.microsoft.com/security/blog/2020/06/24/defending-exchange-servers-under-attack/)\nagainst Exchange server compromise. Customers can also find additional guidance about\n[web shell attacks in our blog Web shell attacks continue to rise.](https://www.microsoft.com/security/blog/2021/02/11/web-shell-attacks-continue-to-rise/)\n\n## Can I determine if I have been compromised by this activity?\n\nThe below sections provide indicators of compromise (IOCs), detection guidance, and\nadvanced hunting queries to help customers investigate this activity using Exchange\nserver logs, Azure Sentinel, Microsoft Defender for Endpoint, and Microsoft 365\nDefender. We encourage our customers to conduct investigations and implement\nproactive detections to identify possible prior campaigns and prevent future campaigns\nthat may target their systems.\n\n### Check patch levels of Exchange Server\n\nThe Microsoft Exchange Server team has published a blog post on these new Security\nUpdates providing a script to get a quick inventory of the patch-level status of onpremises Exchange servers and answer some basic questions around installation of these\npatches.\n\n### Scan Exchange log files for indicators of compromise\n\nThe Exchange Server team has created a script to run a check for HAFNIUM IOCs to\naddress performance and memory concerns. That script is available here:\n[https://github.com/microsoft/CSS-Exchange/tree/main/Security.](https://github.com/microsoft/CSS-Exchange/tree/main/Security)\n\nCVE-2021-26855 exploitation can be detected via the following Exchange\nHttpProxy logs:\n\nThese logs are located in the following directory:\n%PROGRAMFILES%\\Microsoft\\Exchange Server\\V15\\Logging\\HttpProxy\nExploitation can be identified by searching for log entries where the\nAuthenticatedUser is empty and the AnchorMailbox contains the pattern of\nServerInfo~*/*\n\nHere is an example PowerShell command to find these log entries:\n```\nImport-Csv -Path (Get-ChildItem -Recurse -Path\n\"$env:PROGRAMFILES\\Microsoft\\Exchange Server\\V15\\Logging\\HttpProxy\" Filter '*.log').FullName | Where-Object { $_.AnchorMailbox -like\n\n```\n\n-----\n\n```\n'ServerInfo~*/*' -or $_.BackEndCookie -like 'Server~*/*~*'} | select\nDateTime, AnchorMailbox, UrlStem, RoutingHint, ErrorCode,\nTargetServerVersion, BackEndCookie, GenericInfo, GenericErrors, UrlHost,\nProtocol, Method, RoutingType, AuthenticationType, ServerHostName,\nHttpStatus, BackEndStatus, UserAgent\n\n```\nIf activity is detected, the logs specific to the application specified in the\nAnchorMailbox path can be used to help determine what actions were taken.\n\nThese logs are located in the %PROGRAMFILES%\\Microsoft\\Exchange\nServer\\V15\\Logging directory.\nCVE-2021-26858 exploitation can be detected via the Exchange log files:\n\nC:\\Program Files\\Microsoft\\Exchange\nServer\\V15\\Logging\\OABGeneratorLog\nFiles should only be downloaded to the\n%PROGRAMFILES%\\Microsoft\\Exchange\nServer\\V15\\ClientAccess\\OAB\\Temp directory\n\nIn case of exploitation, files are downloaded to other directories (UNC or\nlocal paths)\nWindows command to search for potential exploitation:\n```\nfindstr /snip /c:\"Download failed and temporary file\"\n\"%PROGRAMFILES%\\Microsoft\\Exchange\nServer\\V15\\Logging\\OABGeneratorLog\\*.log\"\n\n```\nCVE-2021-26857 exploitation can be detected via the Windows Application event\nlogs\n\nExploitation of this deserialization bug will create Application events with the\nfollowing properties:\n\nSource: MSExchange Unified Messaging\nEntryType: Error\nEvent Message Contains: System.InvalidCastException\nFollowing is PowerShell command to query the Application Event Log for\nthese log entries:\n```\nGet-EventLog -LogName Application -Source \"MSExchange Unified Messaging\"\n-EntryType Error | Where-Object { $_.Message -like\n\"*System.InvalidCastException*\" }\n\n```\nCVE-2021-27065 exploitation can be detected via the following Exchange log files:\n\nC:\\Program Files\\Microsoft\\Exchange Server\\V15\\Logging\\ECP\\Server\n\nAll Set-<AppName>VirtualDirectory properties should never contain script. InternalUrl\nand ExternalUrl should only be valid Uris.\n\nFollowing is a PowerShell command to search for potential exploitation:\n```\nSelect-String -Path \"$env:PROGRAMFILES\\Microsoft\\Exchange\nServer\\V15\\Logging\\ECP\\Server\\*.log\" -Pattern 'Set-.+VirtualDirectory'\n\n```\n\n-----\n\n## Host IOCs\n\nMicrosoft is releasing a feed of observed indicators of compromise (IOCs) in related\n[attacks. This feed is available in both CSV and JSON formats. This information is being](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/MSTICIoCs-ExchangeServerVulnerabilitiesDisclosedMarch2021.csv)\nshared as TLP:WHITE.\n\n### Hashes\n\nWeb shell hashes\n\nb75f163ca9b9240bf4b37ad92bc7556b40a17e27c2b8ed5c8991385fe07d17d0\n097549cf7d0f76f0d99edf8b2d91c60977fd6a96e4b8c3c94b0b1733dc026d3e\n2b6f1ebb2208e93ade4a6424555d6a8341fd6d9f60c25e44afe11008f5c1aad1\n65149e036fff06026d80ac9ad4d156332822dc93142cf1a122b1841ec8de34b5\n511df0e2df9bfa5521b588cc4bb5f8c5a321801b803394ebc493db1ef3c78fa1\n4edc7770464a14f54d17f36dc9d0fe854f68b346b27b35a6f5839adf1f13f8ea\n811157f9c7003ba8d17b45eb3cf09bef2cecd2701cedb675274949296a6a183d\n1631a90eb5395c4e19c7dbcbf611bbe6444ff312eb7937e286e4637cb9e72944\n\n### Paths\n\nWe observed web shells in the following paths:\n\n_C:\\inetpub\\wwwroot\\aspnet_client\\_\n_C:\\inetpub\\wwwroot\\aspnet_client\\system_web\\_\n_In Microsoft Exchange Server installation paths such as:_\n\n_%PROGRAMFILES%\\Microsoft\\Exchange_\n_Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\_\n_C:\\Exchange\\FrontEnd\\HttpProxy\\owa\\auth\\_\n\nThe web shells we detected had the following file names:\n\n_web.aspx_\n_help.aspx_\n_document.aspx_\n_errorEE.aspx_\n_errorEEE.aspx_\n_errorEW.aspx_\n_errorFF.aspx_\n_healthcheck.aspx_\n_aspnet_www.aspx_\n_aspnet_client.aspx_\n_xx.aspx_\n_shell.aspx_\n_aspnet_iisstart.aspx_\n_one.aspx_\n\n\n-----\n\nCheck for suspicious .zip, .rar, and .7z files in C:\\ProgramData\\, which may indicate\npossible data exfiltration.\n\nCustomers should monitor these paths for LSASS dumps:\n\n_C:\\windows\\temp\\_\n_C:\\root\\_\n\n### Tools\n\n[Procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump)\n[Nishang](https://github.com/samratashok/nishang)\n[PowerCat](https://github.com/besimorhino/powercat)\n\nMany of the following detections are for post-breach techniques used by HAFNIUM. So\nwhile these help detect some of the specific current attacks that Microsoft has observed it\nremains very important to apply the recently released updates for CVE-2021-26855, CVE2021-26857, CVE-2021-27065 and CVE-2021-26858.\n\n## Microsoft Defender Antivirus detections\n\nPlease note that some of these detections are generic detections and not unique to this\ncampaign or these exploits.\n\nExploit:Script/Exmann.A!dha\nBehavior:Win32/Exmann.A\nBackdoor:ASP/SecChecker.A\nBackdoor:JS/Webshell (not unique)\nTrojan:JS/Chopper!dha (not unique)\nBehavior:Win32/DumpLsass.A!attk (not unique)\nBackdoor:HTML/TwoFaceVar.B (not unique)\n\n## Microsoft Defender for Endpoint detections\n\nSuspicious Exchange UM process creation\nSuspicious Exchange UM file creation\nPossible web shell installation (not unique)\nProcess memory dump (not unique)\n\n## Azure Sentinel detections\n\n Advanced hunting queries\n\nTo locate possible exploitation activity related to the contents of this blog, you can run the\n[following advanced hunting queries via Microsoft Defender for Endpoint and Azure](https://securitycenter.windows.com/hunting)\nSentinel:\n\n\n-----\n\n### Microsoft Defender for Endpoint advanced hunting queries\n\nMicrosoft 365 Defender customers can find related hunting queries below or at this\nGitHub location: https://github.com/microsoft/Microsoft-365-Defender-HuntingQueries/\n\n[Additional queries and information are available via Threat Analytics portal for](https://securitycenter.windows.com/threatanalytics3/)\nMicrosoft Defender customers.\n\n**UMWorkerProcess.exe in Exchange creating abnormal content**\n\nLook for Microsoft Exchange Server’s Unified Messaging service creating non-standard\ncontent on disk, which could indicate web shells or other malicious content, suggesting\nexploitation of CVE-2021-26858 vulnerability:\n```\nDeviceFileEvents | where InitiatingProcessFileName ==\n\"UMWorkerProcess.exe\" | where FileName != \"CacheCleanup.bin\" | where\nFileName !endswith \".txt\" | where FileName !endswith \".LOG\" | where\nFileName !endswith \".cfg\" | where FileName != \"cleanup.bin\"\n\n```\n**UMWorkerProcess.exe spawning**\n\nLook for Microsoft Exchange Server’s Unified Messaging service spawning abnormal\nsubprocesses, suggesting exploitation of CVE-2021-26857 vulnerability:\n```\nDeviceProcessEvents | where InitiatingProcessFileName ==\n\"UMWorkerProcess.exe\" | where FileName != \"wermgr.exe\" | where FileName\n!= \"WerFault.exe\"\n\n```\nPlease note excessive spawning of wermgr.exe and WerFault.exe could be an indicator of\ncompromise due to the service crashing during deserialization.\n\n### Azure Sentinel advanced hunting queries\n\nAzure Sentinel customers can find a Sentinel query containing these indicators in the\nAzure Sentinel Portal or at this GitHub location: https://github.com/Azure/AzureSentinel/tree/master/Detections/MultipleDataSources/.\n\nLook for Nishang Invoke-PowerShellTcpOneLine in Windows Event Logging:\n```\nSecurityEvent | where EventID == 4688 | where Process has_any\n(\"powershell.exe\", \"PowerShell_ISE.exe\") | where CommandLine has\n\"$client = New-Object System.Net.Sockets.TCPClient\"\n\n```\nLook for downloads of PowerCat in cmd and Powershell command line logging in\nWindows Event Logs:\n```\nSecurityEvent | where EventID == 4688 | where Process has_any\n(\"cmd.exe\", \"powershell.exe\", \"PowerShell_ISE.exe\") | where CommandLine\nhas\n\n```\n\n-----\n\n```\n\"https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1\"\n\n```\nLook for Exchange PowerShell Snapin being loaded. This can be used to export mailbox\ndata, subsequent command lines should be inspected to verify usage:\n```\nSecurityEvent | where EventID == 4688 | where Process has_any\n(\"cmd.exe\", \"powershell.exe\", \"PowerShell_ISE.exe\") | where\nisnotempty(CommandLine) | where CommandLine contains \"Add-PSSnapin\nMicrosoft.Exchange.Powershell.Snapin\" | summarize FirstSeen =\nmin(TimeGenerated), LastSeen = max(TimeGenerated) by Computer, Account,\nCommandLine\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.03.02.HAFNIUM_APT/HAFNIUM%20targeting%20Exchange%20Servers%20with%200-day%20exploits%20-%20Microsoft%20Security.pdf"
    ],
    "report_names": [
        "HAFNIUM targeting Exchange Servers with 0-day exploits - Microsoft Security"
    ],
    "threat_actors": [
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716502,
    "ts_updated_at": 1743041523,
    "ts_creation_date": 1615519406,
    "ts_modification_date": 1615519406,
    "files": {
        "pdf": "https://archive.orkl.eu/ecc7718e285eba15ee5c9d610dc10fed75227bf3.pdf",
        "text": "https://archive.orkl.eu/ecc7718e285eba15ee5c9d610dc10fed75227bf3.txt",
        "img": "https://archive.orkl.eu/ecc7718e285eba15ee5c9d610dc10fed75227bf3.jpg"
    }
}