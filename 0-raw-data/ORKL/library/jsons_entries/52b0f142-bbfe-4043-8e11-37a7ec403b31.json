{
    "id": "52b0f142-bbfe-4043-8e11-37a7ec403b31",
    "created_at": "2023-01-12T15:07:06.260191Z",
    "updated_at": "2025-03-27T02:05:44.303916Z",
    "deleted_at": null,
    "sha1_hash": "fa1ca75aa8dc66129058d876fca49a4f2586a3d0",
    "title": "2019-01-24 - Cisco AMP tracks new campaign that delivers Ursnif",
    "authors": "",
    "file_creation_date": "2022-05-27T19:59:02Z",
    "file_modification_date": "2022-05-27T19:59:02Z",
    "file_size": 644359,
    "plain_text": "# Cisco AMP tracks new campaign that delivers Ursnif\n\n**blog.talosintelligence.com/2019/01/amp-tracks-ursnif.html**\n\n_This blog post was authored by John Arneson of Cisco Talos_\n\n## Executive Summary\n\nCisco Talos once again spotted the Ursnif malware in the wild. We tracked this information\nstealer after [Cisco's Advanced Malware Protection (AMP) Exploit Prevention engine alerted us](https://www.cisco.com/c/en/us/products/security/amp-for-endpoints/index.html)\nto these Ursnif infections. Thanks to AMP, we were able to prevent Ursnif from infecting any of\nits targets. The alert piqued our curiosity, so we began to dig a bit deeper and provide some\nrecent IoCs related to this threat, which traditionally attempts to steal users' banking login\ncredentials and other login information. Talos has covered Ursnif in the past, as it is one of the\nmost popular malware that attackers have deployed recently. In April, we detected that Ursnif\n[was being delivered via malicious emails along with the IceID banking trojan.](https://blog.talosintelligence.com/2018/04/icedid-banking-trojan.html)\n\n### Malicious Office document\n\nThe Ursnif sample from the alert comes from a Microsoft Word document containing a malicious\nVBA macro. The document is straightforward, simply displaying an image that asks the user to\nenable macros. If macros are already permitted, the macro is executed automatically when\nopening the document via the AutoOpen function.\n\n\n-----\n\nThe macro is mostly obfuscated code that executes math functions on data that does not relate\nto the next stage. There is only one line in the macro that is important to executing the next\nstage, ultimately executing PowerShell.\n```\nInteraction@.Shell RTrim(LTrim(Shapes(\"j6h1cf\").AlternativeText)), 84 * 2 + -168\n\n```\nThis line accesses the AlternativeText property of the Shapes object \"j6h1cf.\" The value of this\nproperty is the malicious PowerShell command, which is subsequently executed by the Shell\nfunction. The PowerShell command is base64 encoded, and is another PowerShell command\nthat downloads Ursnif. Specifically, it downloads an executable from its C2 to the AppData\ndirectory and executes it. Note, this is where the Exploit Prevention engine stops executing the\ndownloaded file and provides us with alerts to investigate.\n\n### Infection\n\nAfter the Ursnif executable is downloaded and executed, registry data is created that is\nimportant for the next stage of execution.\n\nThe PowerShell command for the next stage of execution resides in the value of the APHohema\n\n\n-----\n\nkey, as shown in the image above.\n\nThis command uses Windows Management Instrumentation Command-line (WMIC) to execute\nPowerShell, which extracts the value of the Authicap key to execute it. The value of the\nAuthicap key is a hexadecimal-encoded PowerShell command. The WMIC command makes\nuse of /output:clipboard as a way to hide the normal output of process creation that is printed\nwhen creating a process with WMIC.\n```\nC:\\WINDOWS\\system32\\wbem\\wmic.exe /output:clipboard process call create \"powershell -w\nhidden iex([System.Text.Encoding]::ASCII.GetString((get-itemproperty\n'HKCU:\\Software\\AppDataLow\\Software\\Microsoft\\236FF8AB-268A-4D1B-4807BAD1FC2B8E95').Authicap))\"\n\n```\nThe hexadecimal-encoded PowerShell command executed from Authicap decodes to a large\nPowerShell command, of which the most interesting part is base64-encoded. There are three\nparts to the command. The first part creates a function that is later used to decode base64\nencoded PowerShell. The second part creates a byte array containing a malicious DLL. The\nthird part executes the base64 decode function created in the first part, with a base64 encoded\nstring as the parameter to the function. The returned decoded PowerShell is subsequently\nexecuted by the shorthand Invoke-Expression (iex) function.\n\nThe decoded base64 PowerShell that is executed by iex is used to execute an Asynchronous\nProcedure Call (APC) Injection.\n\nThe first part of the command creates two variables that import kernel32.dll. In this case, the\nvariables are $igaoctlsc and $gdopgtvl, as seen being established by the Add-Type cmdlet.\n\nThe APIs imported from kernel32 are:\n\nGetCurrentProcess\nVirtualAllocEx\nGetCurrentThreadID\nQueueUserAPC\nOpenThread\nSleepEx\n\n\n-----\n\nAfter the imports are established, the last portion is a single line that performs the APC Injection\nvia the QueueUserAPC API. Here is the simplified form of that single line, with more readable\nformatting and normalized variable names.\n\nThe injection starts by allocating memory for the malicious DLL with VirtualAllocEx, targeting the\ncurrent process. If the allocation is successful, it then copies the malicious DLL into the newly\nallocated memory with Copy. Once that is completed, QueueUserAPC is executed, specifying\nthe current thread within its process. This creates a user-mode APC and queues it within the\nthread. To execute the malicious DLL from the APC queue, the thread needs to enter an\nalertable state. SleepEx is used to trigger an alertable state completing the APC injection, by\nspecifying 1 (True) for its second parameter which is bAlertable.\n\n### C2 Traffic\n\nAfter infection, the C2 requests are made over HTTPS. Intercepting the traffic, we are able to\nsee the contents of the requests. The most interesting part of the requests is that the data is put\ninto a CAB file format, prior to exfiltration.\n\n\n-----\n\n### URI Format Strings\n\nsoft=%u&version=%u&user=%08x%08x%08x%08x&server=%u&id=%u&crc=%x\nversion=%u&soft=%u&user=%08x%08x%08x%08x&server=%u&id=%u&type=%u&name=%s\n/data.php?\nversion=%u&user=%08x%08x%08x%08x&server=%u&id=%u&type=%u&name=%s\ntype=%S, name=%s, address=%s, server=%s, port=%u, ssl=%s, user=%s,\npassword=%s\\\n\n### User-Agent Format String\n\nMozilla/4.0 (compatible; MSIE 8.0; Windows NT %u.%u%s)\n\nThe CAB files containing the data to be exfiltrated are stored in %TEMP%, with the filename\nformat being four hexadecimal characters and a .bin extension. As Ursnif logs data to be\nexfiltrated, it creates CAB files to store the data with the built-in makecab.exe command. The\ncommand targets a created MakeCab directive file in the %TEMP% directory. The images\nbelow shows the created CAB files in %TEMP% and the MakeCab directives.\n\nInside the created CAB files are plaintext data in the format:\n```\n<Current Date and Time>\n<Process Path>\n<Window Text>\n<Keystrokes Logged>\n\n```\n\n-----\n\n## Conclusion\n\nTalos continues to monitor these threats as they evolve to ensure that defenses protect our\ncustomers. We strongly encourage users and organizations to follow recommended security\npractices, such as installing security patches as they become available, exercising caution when\nreceiving messages from unknown third parties, and ensuring that a robust offline backup\nsolution is in place. Ursnif uses CAB files to compress its data prior to exfiltration, so being\naware of what challenges that will present will assist you in protecting and monitoring your\nenvironment. To help with the detection of this malware, we are providing readers with a list of\nIOCs below that can help you identify and stop Ursnif before it infects your network.\n\n## Indicators of Compromise (IOCS)\n\nHere are some recent IOCs from our tracking of Ursnif.\n\n### Malicious documents:\n\ndb7f0dab70e1da8ef7a6a6d938531f2a6773c0c5f925f19874fd3e764aa45833\n\ne58827967cba544cc1db3d751095878115f4247982fb514bbd7b98bced8de6c0\n\n3846fe442df0175461081dd63299144a233debbd2453deeeb405126042ef72d1\n\n982cf7af71d0fe54cbdfac74fd2985c48a011e6ffffe65012ee4496bb669b321\n\ncbc10db9d7609e548e550e79f45940125895374b9a97e133020d5585bfd183ed\n\n2dbd942ac2f0b92d497fa6595f638cbddc24eab8beffb7cc648a91d65b45fa09\n\n38c459e56997e759ca680f88aae4428d9c76e9fae323b4d2238adf203036007c\n\n153c191ef4afd3eba9df89150ac728757efcba1293716c23f019e35270a388c4\n\n95f5f2ecdce872f5b96739f548e4b73bb8b7a2c11c46cfddf3e20fd04abfc091\n\n1cf5de71d51d2769079a8cb64e05f80e72e88846987602ad7302478c0d574caa\n\nc9f42b866fc203b4cd9d09cfcb0f8fca41097548393c15adb0557652526d818a\n\nba332017cbf16842170788f5688e3b8a79c821ef1331e428d77af238c379be4f\n\nb278b0e63acbbb92396da41bffb99b9ef09dff1b1b838f69e29245c6731269f7\n\nb6837f46124a360ffff235824cc1decda2b97d6daf73e80f3615bce7781a86aa\n\n12e3140656d7df63a1c444b0ebdae75039a18799e2ebd03a80eeb26ce5dbb66c\nd3383c7ee9704b51b302d7e611214a78050fcc7ad0969682355894af58f63cdf\n\n3eff10af3f2afbcf59d5cf77f470abe3cfafbe48255e7f6ea56a22608e332824\n\nad87dcc617e9914e28f76d071b586ac2cca9454078f3141c17e0102c9e2eebaa\n\n65f81148184a7ec71a43e9cd50e1267ab3fc64f3ef5f41f9da8bd74000baad30\n\nf7cc1b8f93831f7170e5317b5b79aaa9ceb2bc6724f21bc4e2c6cccb71655624\n\nd08e92af78cbf7049e8a9ca7b6ab61e8dc42729848e73b980b7cf5ac74d505af\n\n1b0b9cfaa78fac0875d10d087b8354d52bffb1f576eec7d49acab9d3394ccd9a\n\nd48f2cb5cc595f5cea29b7fd2bd8463fdfaf980c48792294ebb4c798516a7eae\n\n\n-----\n\n5a739f018675094baf0b61ff8462b1c946410f4776be877719cb20f9a9c16dfd\nd53ace589ad1a39487f36dd3e516ac2a5af0aec521f28c5b78b3a47636cfb068\n0778ef085fdebd39856ebfa4bf1203dcb7ee59fa4fc82a71a2ef3a949143c543\n4ffe626708fa6a2d76366a962359658e0d919544260aa2179727964c34e12080\n4dedf0b96b253b8fc15b007e4f61eb85d0345ef19f5a1fc6ea0772614375f606\nf3c7d7c0e71d15dc03614964c887a2459bd0ae4a97a324018a97dff27608e4b2\n8b73b12aad16a58d07048a307a7a558755d0f5ca369dbee8b808a9d9c941a25d\na2ae329bf70c24e4380d6133a4c02127e09597111e4edfd7808aa471450d2332\n001f52a0fa8d4abe34bfff6c96b423435c0ad3e06d40ece228fe2db3bc0d1067\nb4b56db2ce95d52b018edee05f996a1b5ae11a289979e984157a0efb7bbbc9b9\n617f1260e18929704c0ef45dae5eee7b9690b7a95f66e76ac00cf9dd2fca465b\nc283c26a991fd3599e8fd91bf059c2dbb07d3d630caf699531c48737faedc325\n447f249e60df0324f74a40a4b35f432b2e19f801ce2d4d6efa126a6841836b11\nd7aeacb2b12cef81315a64670a27575d84ac1af4541000d0093fdb3676afc515\nd200cbc2b28811bf4762d664a4b3f9f58f6b20af03981910dc2317751f91027d\nb409ee2691e7b2d2598cd01ac28a0914d4778da8d8b7a62d2f78492b14790917\ne95af1012346ab3edbb365f3463bd060bfa7f194b7c68c8e680dfbde43c57eb7\n015e2b8de525789f551abb4af169ad914f218fb07df2496c6f23d51d6a711688\n\n### C2 Server Domains:\n\nlevocumbut[.]com\n\nrapworeepa[.]com\n\nwegatamata[.]com\n\nroevinguef[.]com\n\npivactubmi[.]com\n\nbiesbetiop[.]com\n\nnavectrece[.]com\n\nyancommato[.]com\n\ndewirasute[.]com\n\nptyptossen[.]com\n\nmochigokat[.]com\n\ntubpariang[.]com\n\nzardinglog[.]com\n\nabregeousn[.]com\n\naplatmesse[.]com\n\nabeelepach[.]com\n\nteomengura[.]com\n\nallooalel[.]club\n\nnublatoste[.]com\n\nledibermen[.]com\n\nlootototic[.]com\n\nacnessempo[.]com\n\n\n-----\n\nusteouraph[.]com\nizzlebutas[.]com\nsfernacrif[.]com\nisatawatag[.]com\nduenexacch[.]com\nkyllborena[.]com\nbawknogeni[.]com\nkicensinfa[.]com\nuvuladitur[.]com\n\n### Files Dropped:\n\nNote, that filenames are hardcoded in the first PowerShell command executed, and vary by\nsample. This means that these indicators aren't necessarily malicious on their own as filenames\nmight collide with benign ones. If found with other indicators, its likely a Ursnif infection.\n\n%AppData%/137d1dc1.exe\n\n%AppData%/1688e8b.exe\n\n%AppData%/1bdf65af.exe\n\n%AppData%/1cf8f7bb.exe\n\n%AppData%/2662438a.exe\n\n%AppData%/284ca7b3.exe\n\n%AppData%/31d073c1.exe\n\n%AppData%/3209f93c.exe\n\n%AppData%/3d4480c4.exe\n\n%AppData%/3fabbd27.exe\n\n%AppData%/40dc969c.exe\n\n%AppData%/4d46c42f.exe\n\n%AppData%/530ddba6.exe\n\n%AppData%/56ef205c.exe\n\n%AppData%/58b00f30.exe\n\n%AppData%/58f9603c.exe\n\n%AppData%/60404124.exe\n\n%AppData%/62574d8.exe\n\n%AppData%/6420f61f.exe\n\n%AppData%/6aad9e36.exe\n\n%AppData%/6ed4c1be.exe\n\n%AppData%/71bdcc14.exe\n\n%AppData%/75e1d341.exe\n\n%AppData%/7bc0a512.exe\n\n%AppData%/7df15b.exe\n%AppData%/8428791f.exe\n\n%AppData%/8c1d4ca.exe\n\n%AppData%/8d04e64a.exe\n\n\n-----\n\n%AppData%/97729da0.exe\n%AppData%/97979225.exe\n%AppData%/9835041d.exe\n%AppData%/9eb826ef.exe\n%AppData%/a54ab0bc.exe\n%AppData%/a9f1df84.exe\n%AppData%/aa5cc687.exe\n%AppData%/af74ae98.exe\n%AppData%/b034a4.exe\n%AppData%/bb5144e8.exe\n%AppData%/c1a17119.exe\n%AppData%/cbd42398.exe\n%AppData%/cf63b795.exe\n%AppData%/d5e1b91a.exe\n%AppData%/da0170a9.exe\n%AppData%/def4b6bf.exe\n%AppData%/e199be3d.exe\n%AppData%/e5920466.exe\n%AppData%/e7972c72.exe\n%AppData%/f005cb48.exe\n%AppData%/f0107edb.exe\n%AppData%/f2134754.exe\n%AppData%/fa408793.exe\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-01-24 - Cisco AMP tracks new campaign that delivers Ursnif.pdf"
    ],
    "report_names": [
        "2019-01-24 - Cisco AMP tracks new campaign that delivers Ursnif.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536026,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653681542,
    "ts_modification_date": 1653681542,
    "files": {
        "pdf": "https://archive.orkl.eu/fa1ca75aa8dc66129058d876fca49a4f2586a3d0.pdf",
        "text": "https://archive.orkl.eu/fa1ca75aa8dc66129058d876fca49a4f2586a3d0.txt",
        "img": "https://archive.orkl.eu/fa1ca75aa8dc66129058d876fca49a4f2586a3d0.jpg"
    }
}