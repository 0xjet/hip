{
    "id": "aa4e1939-dff7-49cf-8f66-eb937594eace",
    "created_at": "2023-01-12T15:07:18.105327Z",
    "updated_at": "2025-03-27T02:05:38.650612Z",
    "deleted_at": null,
    "sha1_hash": "0f871a1b84f470eccc2bc564b24a603a3710d3ac",
    "title": "2019-07-01 - An Analysis of Godlua Backdoor",
    "authors": "",
    "file_creation_date": "2022-05-29T00:55:08Z",
    "file_modification_date": "2022-05-29T00:55:08Z",
    "file_size": 700017,
    "plain_text": "# An Analysis of Godlua Backdoor\n\n**blog.netlab.360.com/an-analysis-of-godlua-backdoor-en/**\n\nAlex.Turing July 1, 2019\n\n1 July 2019 / [Botnet](https://blog.netlab.360.com/tag/botnet/)\n\n### Background\n\nOn April 24, 2019, our Unknown Threat Detection System highlighted a suspicious ELF file which was marked by a few vendors as mining\nrelated trojan on VT. We cannot confirm it has mining related module, but we do see it starts to perform DDoS function recently.\n\nThe file itself is a Lua-based Backdoor, we named it Godlua Backdoor as the Lua byte-code file loaded by this sample has a magic number of\n“God”.\n\nGodlua Backdoor has a redundant communication mechanism for C2 connection, a combination of hardcoded dns name, Pastebin.com,\nGitHub.com as well as DNS TXT are used to store the C2 address, which is not something we see often. At the same time, it uses HTTPS to\ndownload Lua byte-code files, and uses DNS over HTTPS to get the C2 name to ensure secure communication between the bots, the Web\nServer and the C2.\n\nWe noticed that there are already 2 versions of Godlua Backdoor and there are ongoing updates. We also observed that attackers has been\nusing Lua command to run Lua code dynamically and initiate HTTP Flood attacks targeting some websites.\n\n### Overview\n\nAt present, we see that there are two versions of Godlua. Version 201811051556 is obtained by traversing Godlua download servers and there\nhas been no update on it. Version 20190415103713 ~ 2019062117473 is active and is actively being updated. They are all written in C, but the\nactive one supports more computer platforms and more features. The following is a comparison.\n\n### Godlua Backdoor Reverse Analysis\n\n version 201811051556\n\nThis is the version we found earlier (201811051556). It focuses on the Linux platform and supports two kinds of C2 instructions, to execute\nLinux system commands and to run custom files.\n\n**Sample information**\n\nMD5: 870319967dba4bd02c7a7f8be8ece94f\n\nELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), for GNU/Linux 2.6.32, dynamically linked (uses shared libs), for GNU/Linux\n2.6.32, stripped\n\n**C2 redundant mechanism**\n\n\n-----\n\ns e s o pe o C co u cat o s t o ays, a dcoded do a a e a d G t ub\n\nIts hardcoded C2 domain is: d.heheda.tk\n\n\n-----\n\nt a so as a G t ub page a d t e ea C add ess s t e p oject desc pt o\n\n**C2 instruction**\n\ncmd_call, execute Linux system commands\n\n\n-----\n\nc d_s e, e ecute custo e\n\n**C2 protocol analysis**\n\nPacket format\n\n**Length** **Type** **Data**\n\nLittle endian,2 bytes 1 bytes (Length -3) bytes\n\nEncryption Algorithm\n\nXOR’s Key is randomly generated of 16 bytes of data, the algorithm is as follow:\n\n**Packet Overview**\n\ncmd_handshake\n```\npacket[0:31]:\n24 00 02 ec 86 a3 23 fb d0 d1 e9 e8 5f 23 6f 6d\n70 b5 95 24 44 e0 fc 2e 00 00 00 6c 69 6e 75 78\n2d 78 38 36\nLength: packet[0:1]        --->0x0024\nType: packet[2]         --->0x02,handshake\nData: packet[3:31]\n      Data\n      Data[0:15]         ---->xor key\n      Data[16:23]         ---->version,hardcoded,little endian.\n      Data[24:31]         ---->arch,hardcoded.\n\n```\ncmd_heartbeat\n```\npacket[0:10]:\n0b 00 03 87 19 45 cb 91 d1 d1 a9\nLength:   packet[0:1]         --->0x000b\nType:  packet[2]          --->0x03,heartbeat\nData:  packet[3:10]        --->xored clock64()\n\n### version 20190415103713 ~ 20190621174731\n\n```\n\n-----\n\ns act e e s o u s o bot do s a d u\nThe control module is implemented in Lua and five C2 commands are supported\n\n**Sample information**\n\nversion 20190415103713\n\nMD5: c9b712f6c347edde22836fb43b927633\n\nELF 64-bit LSB executable, AMD x86-64, version 1 (SYSV), statically linked, stripped\n\nversion 20190621174731\n\nMD5: 75902cf93397d2e2d1797cd115f8347a\n\nELF 64-bit LSB executable, AMD x86-64, version 1 (SYSV), statically linked, stripped\n\n**C2 redundant mechanism**\n\n**Stage-1 URL**\n\nThe backdoor uses 3 different ways to store the Stage-1 URL. hardcoded ciphertext, Github project description, and Pastebin text.\n\nAfter the Stage-1 URL is retrieved and decrypted, a start.png file will be downloaded, which is actually a Lua bytecode.\n\nThe Bot then loads it into memory and executes it to get the Stage-2 URL.\n\nEncryption Algorithm\n\nAES，CBC Mode\nkey：13 21 02 00 31 21 94 E2 F2 F1 35 61 93 4C 4D 6A\niv：2B 7E 15 16 28 AE D2 01 AB F7 15 02 00 CF 4F 3C\n\nHard coded ciphertext\n\n**version 20190415103713**\n\nAES ciphertext：03 13 84 29 CC 8B A5 CA AB 05 9E 2F CB AF 5E E6 02 5A 5F 17 74 34 64 EA 5B F1 38 5B 8D B9 A5 3E\nSt 1 URL l i t t `htt` `//d h h d` `tk/%`\n\n\n-----\n\n**e s o** **0 906** **3**\n\nAES ciphertext：F1 40 DB B4 E1 29 D9 DC 8D 78 45 B9 37 2F 83 47 F1 32 3A 11 01 41 07 CD DB A3 7B 1F 44 A7 DE 6C 2C 81 0E 10\nE9 D8 E1 03 38 68 FC 51 81 62 11 DD\nStage-1 URL plaintext： `https://img0.cloudappconfig.com/%s.png`\n\nGithub project description\n\nAES ciphertext：EC 76 44 29 59 3D F7 EE B3 01 90 A9 9C 47 C8 96 53 DE 86 CB DF 36 68 41 60 5C FA F5 64 60 5A E4 AE 95 C3 F5\nA6 04 47 CB 26 47 A2 23 80 C6 5F 92\nGithub URL plaintext： `https://api.github.com/repos/helegedada/heihei`\nDecryption Process:\n\nProject description ciphertext: oTre1RVbmjqRn2kRrv4SF/l2WfMRn2gEHpqJz77btaDPlO0R9CdQtMM82uAes+Fb\nStage-1 URL plaintext： `https://img1.cloudappconfig.com/%s.png`\n\nPastebin text\n\nAES ciphertext：19 31 21 32 BF E8 29 A8 92 F7 7C 0B DF DC 06 8E 8E 49 F0 50 9A 45 6C 53 77 69 2F 68 48\n\nDC 7F 28 16 EB 86 B3 50 20 D3 01 9D 23 6C A1 33 62 EC 15\nPastebin URL plaintext： `https://pastebin.com/raw/vSDzq3Md`\nDecryption Process:\n\nPastebin Ciphertext: G/tbLY0TsMUnC+iO9aYm9yS2eayKlKLQyFPOaNxSCnZpBw4RLGnJOPcZXHaf/aoj\nStage-1 URL plaintext： `https://img2.cloudappconfig.com/%s.png`\n\n**Stage-2 URL**\n\nHere at stage-2, two mechanisms are being used for storing the Stage-2 URL, Github project file and DNS over HTTPS.\n\nAfter the Stage-2 URL is retrieved and decrypted, a run.png file, also a Lua bytecode, will be downloaded.\n\nBot will load this file into memory and run it to get Stage-3 C2.\n\nEncryption Algorithm\n\nAES，CBC Mode\nkey：22 85 16 13 57 2d 17 90 2f 00 49 18 5f 17 2b 0a\niv：0d 43 36 41 86 41 21 d2 41 4e 62 00 41 19 4a 5c\n\nGithub project file\n\n\n-----\n\nG t ub U s sto ed t e ua byte code e (sta t p g) p a te t e get t e o o g o at o by d sasse b g t\n\nGithub project file ciphertext:\nkI7xf+Q/fXC0UT6hCUNimtcH45gPgG9i+YbNnuDyHyh2HJqzBFQStPvHGCZH8Yoz9w02njr41wdl5VNlPCq18qTZUVco5WrA1EIg3zVOcY8=\nStage-2 URL plaintext： `{\"u\":\"https:\\/\\/dd.heheda.tk\\/%s.png\",\"c\":\"dd.heheda.tk::198.204.231.250:\"}`\n\nDNS TXT\n\nDNS TXT is stored in the Lua byte-code file (start.png) in plaintext. We get the following information by disassembling it：\n\nDNS over HTTPS Request：\n\nDNS TXT ciphertext:\n6TmRMwDw5R/sNSEhjCByEw0Vb44nZhEUyUpUR4LcijfIukjdAv+vqqMuYOFAoOpC7Ktyyr6nUOqO9XnDpudVmbGoTeJD6hYrw72YmiOS9d\nStage-2 URL plaintext：\n\n```\n{\"u\":\"http:\\/\\/img1.cloudappconfig.com\\/%s.png\",\"c\":\"img1.cloudappconfig.com::43.224.225.220:\"}\n\n```\n\n**Stage-3 C2**\n\nStage-3 C2 is hardcoded in the Lua byte-code file (run.png). We disassembled it to get the following information.\n\n**version 20190415103713**\n\n**version 20190621174731**\n\nDNS Over HTTPS Request\n\nC2 instruction\n\n\n-----\n\n```\n| --------- | ---- |\n| HANDSHAKE | 1  |\n| HEARTBEAT | 2  |\n| LUA    | 3  |\n| SHELL   | 4  |\n| UPGRADE  | 5  |\n| QUIT   | 6  |\n| SHELL2  | 7  |\n| PROXY   | 8  |\n\n```\nC2 protocol analysis\n\nPacket format\n\n**Type** **Length** **Data**\n\n1byte Big endian,2 bytes Length bytes\n\nPacket overview\n\nHANDSHAKE\n```\nType: packet[0] --->0x01,HANDSHAKE\nLENGTH: packet[1:2] --->0x0010\nData: packet[3:end]\n      data[0:7] --->Session\n      data[8:end]  --->version,0x00125cfecd8bcb->20190621174731\n\n```\nHEARTBEAT\n```\n   Send:\n        Type:  packet[0]    --->0x02,HEARTBEAT\n        Length:  packet[1:2]   --->0x4\n        Data: packet[3:end]  --->time,0x5d13779b,1561556891\n   Replay:\n        Type: packet[0]    --->0x02,HEARTBEAT\n        Length:  packet[1:2]   --->0x4\n        Data: packet[3:end]  --->1561556891\n\n```\nLUA Payload\n```\n   Type:   packet[0]      --->0x03,LUA\n   Length:  packet[1:2]     --->0x00ab\n   Data:   packet[3:end]    --->Lua script\n\n```\n\n-----\n\ne obse e t e attac e pe o g a ood attac aga st u aobe co\n\n**Lua script analysis**\n\nThe Bot sample downloads many Lua scripts when executing, and the scripts can be broken down to three categories: execute, auxiliary, and\nattack.\n\nexecute: start.png,run.png,quit.png,watch.png,upgrade.png,proxy.png\nauxiliary: packet.png,curl.png,util.png,utils.png\nattack: VM.png,CC.png\n\nEncryption Algorithm\n\nAES，CBC Mode\nkey：13 21 02 00 31 21 94 E2 F2 F1 35 61 93 4C 4D 6A\niv：2B 7E 15 16 28 AE D2 01 AB F7 15 02 00 CF 4F 3C\n\nLua magic number\n\nThe decrypted files are all pre-compiled, take upgrade.png as an example, note the highlighted part is the file header.\n\nYou can see that the magic number has changed from “Lua” to “God”.\n\nThe malware author also seems to set a trap for researcher here by manually changing the LuaVerion number in the sample to 5.1.4\n($LuaVersion: God 5.1.4 C$$LuaAuthors: R. $). We think the real version should be definitely newer than 5.2.\n\nDecompile\n\nIn order to decompile the above script, we have to know what changes have been made to Lua. After some analysis, we concluded that the\nmodification can be divided into two major sections: Lua Header and Lua Opcode.\n\n\n-----\n\neco p ed by [uadec[ ]](https://github.com/viruscamp/luadec)\n\n## Suggestions\n\nWe have yet to see the whole picture of how exactly the Godlua backdoor infects the targets, at this point we know at least some linux users\nwere infected via the Confluence exploit(CVE-2019-3396), if our readers have more information, feel free to contact us.\n\nWe suggest that at least to monitor and block the relevant IP, URL and domain name of Godlua Backdoor on your network.\n\n**Contact us**\n\n[Readers are always welcomed to reach us on twitter, WeChat 360Netlab or email to netlab at 360 dot cn.](https://twitter.com/360Netlab)\n\n**IoC list**\n\nSample MD5\n```\n870319967dba4bd02c7a7f8be8ece94f\nc9b712f6c347edde22836fb43b927633\n75902cf93397d2e2d1797cd115f8347a\n\n```\nURL\n```\nhttps://helegedada.github.io/test/test\nhttps://api.github.com/repos/helegedada/heihei\nhttp://198.204.231.250/linux-x64\nhttp://198.204.231.250/linux-x86\nhttps://dd.heheda.tk/i.jpg\nhttps://dd.heheda.tk/i.sh\nhttps://dd.heheda.tk/x86_64-static-linux-uclibc.jpg\nhttps://dd.heheda.tk/i686-static-linux-uclibc.jpg\nhttps://dd.cloudappconfig.com/i.jpg\nhttps://dd.cloudappconfig.com/i.sh\nhttps://dd.cloudappconfig.com/x86_64-static-linux-uclibc.jpg\nhttps://dd.cloudappconfig.com/arm-static-linux-uclibcgnueabi.jpg\nhttps://dd.cloudappconfig.com/i686-static-linux-uclibc.jpg\nhttp://d.cloudappconfig.com/i686-w64-mingw32/Satan.exe\nhttp://d.cloudappconfig.com/x86_64-static-linux-uclibc/Satan\nhttp://d.cloudappconfig.com/i686-static-linux-uclibc/Satan\nhttp://d.cloudappconfig.com/arm-static-linux-uclibcgnueabi/Satan\nhttps://d.cloudappconfig.com/mipsel-static-linux-uclibc/Satan\n\n```\nC2 Domain\n\n\n-----\n\n```\ndd.heheda.tk\nc.heheda.tk\nd.cloudappconfig.com\ndd.cloudappconfig.com\nc.cloudappconfig.com\nf.cloudappconfig.com\nt.cloudappconfig.com\nv.cloudappconfig.com\nimg0.cloudappconfig.com\nimg1.cloudappconfig.com\nimg2.cloudappconfig.com\n\n```\nIP\n```\n198.204.231.250    United States     ASN 33387       DataShack, LC    \n104.238.151.101    Japan         ASN 20473       Choopa, LLC     \n43.224.225.220    Hong Kong       ASN 22769       DDOSING NETWORK   \n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-01 - An Analysis of Godlua Backdoor.pdf"
    ],
    "report_names": [
        "2019-07-01 - An Analysis of Godlua Backdoor.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536038,
    "ts_updated_at": 1743041138,
    "ts_creation_date": 1653785708,
    "ts_modification_date": 1653785708,
    "files": {
        "pdf": "https://archive.orkl.eu/0f871a1b84f470eccc2bc564b24a603a3710d3ac.pdf",
        "text": "https://archive.orkl.eu/0f871a1b84f470eccc2bc564b24a603a3710d3ac.txt",
        "img": "https://archive.orkl.eu/0f871a1b84f470eccc2bc564b24a603a3710d3ac.jpg"
    }
}