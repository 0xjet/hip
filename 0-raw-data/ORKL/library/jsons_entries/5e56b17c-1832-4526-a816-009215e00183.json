{
    "id": "5e56b17c-1832-4526-a816-009215e00183",
    "created_at": "2023-01-12T15:05:50.044932Z",
    "updated_at": "2025-03-27T02:06:03.062674Z",
    "deleted_at": null,
    "sha1_hash": "97b20b8fe4b4c53fbc7e930e4c9522b8a6e8b373",
    "title": "2022-08-15 - A Deep Dive Into Black Basta Ransomware",
    "authors": "",
    "file_creation_date": "2022-09-01T10:08:04Z",
    "file_modification_date": "2022-09-01T10:08:04Z",
    "file_size": 14493949,
    "plain_text": "# A Deep Dive Into Black Basta Ransomware\n\n**[securityscorecard.com/research/a-deep-dive-into-black-basta-ransomware](https://securityscorecard.com/research/a-deep-dive-into-black-basta-ransomware)**\n\nSkip to main content\n\n[Support](https://support.securityscorecard.com/hc/en-us)\n[Login](https://platform.securityscorecard.io/#/start)\n[Contact](https://securityscorecard.com/company/contact-us)\n[Blog](https://securityscorecard.com/blog)\n[Languages](https://securityscorecard.com/research/a-deep-dive-into-black-basta-ransomware)\n\n[English](https://securityscorecard.com/)\n[Français](https://securityscorecard.com/fr)\n[日本語](https://securityscorecard.com/jp)\n[Request a Demo](https://securityscorecard.com/request-a-demo)\n\nInterested in reading the report later? Download it.\n\n[Download Now](https://securityscorecard.pathfactory.com/all/a-deep-dive-into-bla)\n**Prepared by: Vlad Pasca, Senior Malware & Threat Analyst**\n\n## Executive summary\n\nBlack Basta ransomware is a recent threat that compiled its first malware samples in\nFebruary 2022. The ransomware deletes all Volume Shadow Copies, creates a new JPG\nimage set as the Desktop Wallpaper and an ICO file representing the encrypted files. Unlike\n\n\n-----\n\nother ransomware families, the malware doesn t skip files based on their extensions.\nHowever, it doesn’t encrypt critical folders that would make the system inoperable.\n\nThe files are encrypted using the ChaCha20 algorithm, with the key and nonce being\nencrypted using the RSA public key that is hard-coded in the sample. The malware can fully\nor partially encrypt a file depending on its size. The extension of the encrypted files is\nchanged to .basta by the ransomware.\n\n## Analysis and findings\n\nSHA256: ae7c868713e1d02b4db60128c651eb1e3f6a33c02544cc4cb57c3aa6c6581b6e\n\nThe process displays \"ENCRYPTION\" in the program window using WriteFile:\n\nFigure 1\n\nFigure 2\n\nThe binary retrieves the process ID via a function call to GetCurrentProcessId:\n\nFigure 3\n\nThe malicious process detaches itself from its console by calling the FreeConsole API:\n\nFigure 4\n\nThe executable obtains the \"COMSPEC\" environment variable value, which points to the\ncommand line:\n\nFigure 5\n\n\n-----\n\nThe ransomware deletes all Volume Shadow Copies by running the\n“C:\\Windows\\SysNative\\vssadmin.exe delete shadows /all /quiet” command, as highlighted\nbelow:\n\nFigure 6\n\nThe sample waits until the spawned process finishes using the WaitForSingleObject routine:\n\nFigure 7\n\nA similar process as above that deletes the Volume Shadow Copies is spawned:\n\nFigure 8\n\nThe binary extracts the path of the executable of the current process via a call to\nGetModuleFileNameW:\n\nFigure 9\n\nThe GetTempPathW API is utilized to retrieve the path of the Temp directory:\n\n\n-----\n\nFigure 10\n\nA file called “dlaksjdoiwq.jpg” is created in the Temp directory (0x40 = _SH_DENYNO):\n\nFigure 11\n\nThe process moves the file position indicator to the beginning of the file using the fsetpos\nfunction:\n\nFigure 12\n\nThe WriteFile routine is used to populate the JPG file, which contains instructions from the\nthreat actor:\n\nFigure 13\n\nFigure 14\n\n\n-----\n\nThe newly created image is set as the Desktop Wallpaper using SystemParametersInfoW\n(0x14 = SPI_SETDESKWALLPAPER, 0x1 = SPIF_UPDATEINIFILE):\n\nFigure 15\n\nThe executable creates an ICO file called “fkdjsadasd.ico” in the Temp directory:\n\nFigure 16\n\nThe ransomware writes content to the ICO file, which will represent the icon of the encrypted\nfiles:\n\nFigure 17\n\nFigure 18\n\nBlack Basta ransomware creates the \".basta\\DefaultIcon\" registry key using\nRegCreateKeyExW (0x80000000 = HKEY_CLASSES_ROOT, 0x103 =\n**KEY_WOW64_64KEY | KEY_SET_VALUE | KEY_QUERY_VALUE):**\n\n\n-----\n\nFigure 19\n\nThe “(Default)” value of the above key is set to the path of the ICO file:\n\nFigure 20\n\nFigure 21\n\nThe malicious binary notifies the system that the icon has been changed by calling the\nSHChangeNotify function (0x08000000 = SHCNE_ASSOCCHANGED, 0x3000 =\n**SHCNF_FLUSHNOWAIT):**\n\nFigure 22\n\nThe malware starts scanning for volumes on the system using FindFirstVolumeW:\n\nFigure 23\n\nGetVolumePathNamesForVolumeNameW is utilized to obtain the list of drive letters and\nmounted folder paths for the volume:\n\n\n-----\n\nFigure 24\n\nFor each drive found, the process performs a call to the GetVolumeInformationW API (see\nfigure 25). As opposed to other ransomware families, Black Basta only targets the mounted\nvolumes and doesn’t mount the hidden volumes.\n\nFigure 25\n\nThe volume’s enumeration continues by calling the FindNextVolumeW routine:\n\nFigure 26\n\nThe ransomware extracts a standard set of attribute information from the drives found via a\nfunction call to GetFileAttributesExW (0x0 = GetFileExInfoStandard):\n\nFigure 27\n\nThe ransomware creates a ransom note called “readme.txt” in every directory that is\ntraversed, as highlighted in figure 28:\n\nFigure 28\n\nWriteFile is used to populate the ransom note:\n\n\n-----\n\nFigure 29\n\nFigure 30\n\nThe binary retrieves information about the current system by calling the\nGetNativeSystemInfo function:\n\nFigure 31\n\nThe malware creates multiple threads that will handle the file encryption. The function\nresponsible for encryption is sub_F33DA0 and not the starting address of the thread:\n\nFigure 32\n\nFigure 33\n\nThe malicious process starts enumerating the files on the drive using FindFirstFileW:\n\nFigure 34\n\n\n-----\n\nAs shown in figure 35, the following files/directories will be skipped:\n\n$Recycle.Bin\n\nWindows\n\nboot\n\nreadme.txt\n\ndlaksjdoiwq.jpg\n\nNTUSER.DAT\n\nfkdjsadasd.ico\n\nFigure 35\n\nThe FindNextFileW routine is utilized to continue the files enumeration:\n\nFigure 36\n\nBlack Basta ransomware calls the GetFullPathNameW API with a targeted file as a\nparameter:\n\nFigure 37\n\nThe process obtains a standard set of attribute information for the file via a call to\nGetFileAttributesExW:\n\n\n-----\n\nFigure 38\n\nThe ransomware has embedded a list of extensions (.exe, .cmd, .bat, and .com) in a section;\nhowever, it still encrypts these file extensions.\n\nThe executable retrieves the thread identifier of the calling thread using GetCurrentThreadId:\n\nFigure 39\n\nThe malicious process blocks the main thread until all encryption threads finish execution\n(see figure 40).\n\nFigure 40\n\n## Thread activity – sub_F33DA0 function\n\nThe GetFileAttributesW API is utilized to retrieve file system attributes for a targeted file:\n\nFigure 41\n\nThe malicious process opens a file for reading using wfsopen:\n\nFigure 42\n\nThe ransomware moves the file pointer to the position of the last 4 bytes. Whether the file\nwould be encrypted, these would represent the length of the encrypted ChaCha20 key and\nnonce, as we’ll see later on:\n\n\n-----\n\nFigure 43\n\nBlack Basta ransomware generates 32 random bytes representing the ChaCha20 key and\nthen 8 bytes representing the nonce using rand_s:\n\nFigure 44\n\nFigure 45\n\nThe binary implements the RSA algorithm using the Mini-GMP library, which is fully available\non [Github:](https://github.com/idris-lang/Idris-dev/blob/master/rts/mini-gmp.c)\n\nFigure 46\n\n\n-----\n\nFigure 47\n\nThe RSA public key used to encrypt the randomly generated ChaCha20 key and the nonce\nis presented in the figure below:\n\nFigure 48\n\nThe process constructs the initial state of ChaCha20 using the key, the nonce, and some\nconstant values:\n\nFigure 49\n\nFigure 50\n\nThe sample obtains the current position in the targeted file by calling the fgetpos function:\n\n\n-----\n\nFigure 51\n\nThe file content is read by the process via a call to the _read function:\n\nFigure 52\n\nThe content is encrypted by the ChaCha20 algorithm 64 bytes at a time:\n\nFigure 53\n\nFigure 54\n\nThe encrypted data is written back to the file using the WriteFile API:\n\n\n-----\n\nFigure 55\n\nThe buffer containing the RSA encrypted ChaCha20 key and nonce is appended to the\nencrypted file. The length of the encrypted information (0x200 = 512) is added as well:\n\nFigure 56\n\nThe encrypted file extension is changed to “.basta” using MoveFileW:\n\nFigure 57\n\n## Case 1 – File size < 704 bytes\n\nIn this case, the entire file content is encrypted by the ransomware:\n\n\n-----\n\nFigure 58\n\n## Case 2 – File size < 4KB\n\nIn this case, the file is partially encrypted. The ransomware encrypts 64 bytes, skips 192\nbytes, encrypts 64 bytes again, and so on.\n\n\n-----\n\nFigure 59\n\n## Case 3 – File size > 4KB\n\nIn this case, the file is partially encrypted. The ransomware encrypts 64 bytes, skips 128\nbytes, encrypts 64 bytes again, and so on.\n\n\n-----\n\nFigure 60\n\nFinally, the ransomware tries to write the time spent during the execution and the total size of\nencrypted files to the console; however, it raises an error because the process was detached\nfrom its console:\n\n\n-----\n\nFigure 61\n\n## Indicators of Compromise\n\n**Black Basta Ransom Note**\n\nreadme.txt\n\n**Files created**\n\n%Temp%\\fkdjsadasd.ico\n\n%Temp%\\dlaksjdoiwq.jpg\n\n**Processes spawned**\n\ncmd.exe /c “C:\\Windows\\SysNative\\vssadmin.exe delete shadows /all /quiet”\n\ncmd.exe /c “C:\\Windows\\System32\\vssadmin.exe delete shadows /all /quiet”\n\n**Registry key created**\n\nHKEY_CLASSES_ROOT\\.basta\n\nJoin us in making the world a safer place.\n\n[Free Account Sign Up](https://securityscorecard.com/free-account)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-08-15 - A Deep Dive Into Black Basta Ransomware.pdf"
    ],
    "report_names": [
        "2022-08-15 - A Deep Dive Into Black Basta Ransomware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535950,
    "ts_updated_at": 1743041163,
    "ts_creation_date": 1662026884,
    "ts_modification_date": 1662026884,
    "files": {
        "pdf": "https://archive.orkl.eu/97b20b8fe4b4c53fbc7e930e4c9522b8a6e8b373.pdf",
        "text": "https://archive.orkl.eu/97b20b8fe4b4c53fbc7e930e4c9522b8a6e8b373.txt",
        "img": "https://archive.orkl.eu/97b20b8fe4b4c53fbc7e930e4c9522b8a6e8b373.jpg"
    }
}