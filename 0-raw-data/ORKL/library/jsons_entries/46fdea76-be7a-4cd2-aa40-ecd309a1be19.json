{
    "id": "46fdea76-be7a-4cd2-aa40-ecd309a1be19",
    "created_at": "2023-01-12T15:08:28.410234Z",
    "updated_at": "2025-03-27T02:05:19.293579Z",
    "deleted_at": null,
    "sha1_hash": "aec11fd64749fef034c32a743106c7e703c7446c",
    "title": "2017-11-08 - A short journey into DarkVNC attack chain",
    "authors": "",
    "file_creation_date": "2022-05-28T17:57:06Z",
    "file_modification_date": "2022-05-28T17:57:06Z",
    "file_size": 453700,
    "plain_text": "# A short journey into DarkVNC attack chain\n\n**reaqta.com/2017/11/short-journey-darkvnc/**\n\nDuring an analysis of different [remote desktop trojans we came across an interesting attack-chain](https://twitter.com/ReaQta/status/926055917610815488)\nwhich leverages an RTF that exploits CVE-2017-8759 to deliver DarkVNC, a malicious version of\nthe well-known VNC, designed to silently remote-control a victim.\n\n**DarkVNC Attack Chain**\n\n[The DarkVNC chain as reconstructed by ReaQta-Hive can be seen below:](https://upstream.rqt.io/hive/)\n\nAfter opening the RTF document, one of the first processes to start is csc.exe which is a CommandLine build tool used to invoke the C# compiler, even though csc.exe is a perfectly legit, tool it can be\nabused for malicious purposes. The first step is to inspect the command-line of csc.exe to discover\nwhat is going to be compiled on-the-fly:\n\n\n-----\n\n_cam0snfh.cmdline should raise some suspicion: beside the “weird” name it also run from the user’s_\ndirectory:\n```\n/t:library /utf8output /R:\"System.dll\" /R:\"System.Runtime.Remoting.dll\"\n/R:\"System.Data.dll\" /R:\"System.Xml.dll\" /R:\"System.Web.Services.dll\"\n/out:\"[EDITED].dll\" /D:DEBUG /debug+ /optimize- \n\"C:\\Users\\User\\AppData\\Local\\Temp\\xyzlw5gj.0.cs\"\n\n```\nThe compilation will produce [EDITED].dll (we redacted the name of the DLL for safety reasons\nsince it’s in the form: www.maliciousdomain.com). To understand what this DLL does, we have to\ninspect the source-code located in the file xyzlw5gj.0.cs:\n\n[This block of code takes advantage of the CVE-2017-8759 (WSDL Parser Code Injection) that](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-8759)\nallows an attacker to inject and execute arbitrary code. Specifically the csc.exe generated DLL will\n[be executed by Office. The same technique has been used in the wild to distribute FinSpy.](https://www.fireeye.com/blog/threat-research/2017/09/zero-day-used-to-distribute-finspy.html)\nIn our case winword.exe will finally execute mshta.exe that launches an hta script which invokes a\n_powershell. The main purpose of powershell is to drop and execute result.exe whose scope is to_\ndeliver DarkVNC which we can consider the final payload. The convoluted process described above\ncan be summarized with a simple image that gives us an immediate insight on what is happening on\nthe victim’s endpoint:\n\n\n-----\n\n**The Injector**\n\nAs previously stated, result.exe acts as a loader, its goal is to decrypt and inject the malicious DLL\nthat contains DarkVNC. From a static analysis point of view we have the following characteristics:\n\nSHA256: 1D6F4CAC33FFF1B744DCE13BDF003B15D8EABCE53B0578E3B4BDBC5CBF001D78\n\nSHA1: 2BB1BE823ED569EF3DAC008B2FEC4A8D04E46922\n\nMD5: 22E2B492108F9D5517EE52C37912F24D\n\nFile size: 551.50 KB (564736 bytes)\n\n\nFile\nname:\n\n\nresult.exe\n\n\nFile type: Win32 EXE\n\nThe executable does not have a Version Information and from an initial inspection it’s encrypted\nwith some private PE cryptor. We will skip the detailed analysis of the packer and subsequent\nunpacking steps because we are more interested in the overall behavior. result.exe uses several\nlayers of encryption but does not implement complex anti-reverse engineering countermeasures, so\nthe fastest way track the core behavior by setting a breakpoint on VirtualAlloc() and following the\nvarious layers.\n\n\n-----\n\nExecution will jump from layer to layer until we reach the last one where it’s possible to get the most\nimportant aspects of the injector.\n\n\n-----\n\n_The svchost.exe process is created as a suspended process so the malicious code will be executed_\nwhen the process is finally resumed. At this point we can extract DarkVNC from memory.\n\n**The DarkVNC Module**\n\nThe static inspection of the module’s PE shows the following:\n\nThere are two exports whose meaning is self-explanatory, they are used to manage the VNC\nServer.\n\nThe first step is to convert from string to address the attacker’s address, which in this case is in the\nform IP:443.\n\n\n-----\n\nObtains the ComputerName and an additional identifier in order to assemble the string that will\nidentify the victim’s endpoint, the final string will be: (COMPUTER_NAME)_ADDITIONAL_ID**DARKVNC. Immediately after, the VNC Server is started. We will not go through the analysis of the**\nwhole module for the sake of brevity, but from the inspection of strings we can speed-up the initial\nassessment.\n\nThe string #hvnc is pretty indicative, this core shares many similarities with HVNC (HiddenVNC) a\n[well-known Remote-Control Module whose source-code can be found in the carberp leak. This](https://github.com/hzeroo/Carberp/tree/6d449afaa5fd0d0935255d2fac7c7f6689e8486b/source%20-%20absource/pro/all%20source/RemoteCtl/hvnc)\nmodule shares with it a large amount of similarities like:\n\nHidden VNC capabilities: The module will create a new Window Desktop to keep hidden the\n_malicious VNC instance. This technique is usually adopted to bypass anti-fraud engines on_\npersonal banking websites by impersonating the victim’s computer and logging in with stolen\ncredentials without raising alerts on the bank’s side. Here’s a quick representation of the\nabove behavior taken from ReaQta-Hive’s process-tree point of view:\n\n\n-----\n\nWe have a new explorer.exe instance and one of the child processes is Chrome!\nWhile there are also some basic differences between DarkVNC and HVNC, one of the most\ninteresting is represented by the following:\n```\nSetEnvironmentVariableW(\"MOZ_DISABLE_CONTENT_SANDBOX\", \"1\")\n\n```\nAccording to the [documentation MOZ_DISABLE_CONTENT_SANDBOX disables content process](https://wiki.mozilla.org/Security/Sandbox)\nsandboxing.\n\n**The threat from a higher perspective**\n\nSo far we have identified the following DarkVNC samples:\n\nCollected samples:\n\n1. deb02b28605a2b9c80b25c5fa1fa43ac8c71b10961f7517c1a0394531d3b0b40\n2. 9a57cefbfcdf1b18cc31a2784a2ed3e0e11dd4a3c4608b1243b4141a475b182f\n3. a67e96b01520183babfae285b5d692b5b3dda7edff7378b281ace7fd381d3c93\n4. e0a73dd11f0f2c41859bf01cf8a5b7a2a9946303d6e7898f696037323d038f56\n5. Delivered via Terror EK: [http://www.malware-traffic-analysis.net/2017/10/17/index.html](http://www.malware-traffic-analysis.net/2017/10/17/index.html)\n\n\n-----\n\nHashes of the sample analyzed in this post:\n\n1. RTF: 7a641c8fa1b7a428bfb66d235064407ab56d119411fbaca6268c8e69696e6729\n2. result.exe: 1d6f4cac33fff1b744dce13bdf003b15d8eabce53b0578e3b4bdbc5cbf001d78\n\n**Detection & Protection**\n\nVisibility over the endpoints is essential to quickly detect new threats as they’re deployed by the\nattackers. Real-time behavioral analysis creates a window of opportunity to detect behaviors that\nare unusual, running VNC or Teamviewer is not a malicious activity by itself but those same tools\ncan be abused to get control over an endpoint. Being capable of detecting such anomalies allows\nfor a timely analysis and response before the severity of the incident escalates.\n\n[Check out ReaQta-Hive to understand how an Endpoint Threat Response platform can help your](https://upstream.rqt.io/hive/)\norganization to secure the infrastructure from threats like the one just analyzed, track incidents and\nrespond in real-time. Anomalous behaviors can be hard to understand manually and the help\noffered by the algorithms greatly increase the chances of detection and consequently the reaction\ntime.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-11-08 - A short journey into DarkVNC attack chain.pdf"
    ],
    "report_names": [
        "2017-11-08 - A short journey into DarkVNC attack chain.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536108,
    "ts_updated_at": 1743041119,
    "ts_creation_date": 1653760626,
    "ts_modification_date": 1653760626,
    "files": {
        "pdf": "https://archive.orkl.eu/aec11fd64749fef034c32a743106c7e703c7446c.pdf",
        "text": "https://archive.orkl.eu/aec11fd64749fef034c32a743106c7e703c7446c.txt",
        "img": "https://archive.orkl.eu/aec11fd64749fef034c32a743106c7e703c7446c.jpg"
    }
}