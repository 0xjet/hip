{
    "id": "69d7cdba-5ad3-4370-88e1-81e9cd71d970",
    "created_at": "2023-01-12T15:04:00.513613Z",
    "updated_at": "2025-03-27T02:06:07.459118Z",
    "deleted_at": null,
    "sha1_hash": "04bb9fc31260deaa03b2460ff0b30d5701b9a969",
    "title": "2018-03-29 - ChessMaster Adds Updated Tools to Its Arsenal",
    "authors": "",
    "file_creation_date": "2022-05-28T03:58:09Z",
    "file_modification_date": "2022-05-28T03:58:09Z",
    "file_size": 587080,
    "plain_text": "# ChessMaster Adds Updated Tools to Its Arsenal\n\n**[blog.trendmicro.com/trendlabs-security-intelligence/chessmaster-adds-updated-tools-to-its-arsenal/](https://blog.trendmicro.com/trendlabs-security-intelligence/chessmaster-adds-updated-tools-to-its-arsenal/)**\n\nMarch 29, 2018\n\n[Trend Micro discovered the ChessMaster campaign back in July 2017 as part of our](https://blog.trendmicro.com/trendlabs-security-intelligence/chessmaster-cyber-espionage-campaign/)\nmonitoring efforts to protect our customers. At the time, we found ChessMaster targeting\ndifferent sectors from the academe to media and government agencies in Japan. The threat\ngroup used a variety of attack tools and techniques to spy on their target organizations.\n\nBack then, we noted that ChessMaster's sophisticated nature implied that the campaign\n[could evolve, before finding changes in the tools and tactics used in the campaign a few](https://blog.trendmicro.com/trendlabs-security-intelligence/chessmasters-new-strategy-evolving-tools-tactics/)\nmonths later. While the original campaign was comprehensive and used remote access\nTrojans (RATs) such as ChChes and RedLeaves, this new campaign used a new backdoor\n(Detected by Trend Micro as BKDR_ANEL.ZKEI) that leverages the CVE-20178759 vulnerability for its cyberespionage activities.\n\nIn this blog post, we analyze ChessMaster's current status, including the updated tools in its\narsenal — with a particular focus on the evolution of ANEL and how it is used in the\ncampaign.\n\n\n**July**\n**ChessMaster**\n**Campaign**\n\n\n**November**\n**ChessMaster**\n**Campaign**\n\n\n**Current ChessMaster Campaign**\n\n\n-----\n\nPoint of\nEntry\n\nNotable\nTools\n\n\nSpearphishing\nemails\ncontaining\ndecoy\ndocuments\nMalicious\nshortcut\n(LNK) files\nand\nPowerShell\nSelfextracting\narchive\n(SFX)\nRuntime\npackers\n\nHacking\nTools\nSecondstage\npayloads\n\n\nSpearphishing\nemails\ncontaining\ndecoy\ndocuments\nexploiting\nCVE-20178759\n\nKoadic\nHacking Tools\nSecond-stage\npayloads\n\n\nSpear-phishing emails\ncontaining decoy documents\nexploiting CVE-2017-11882,\nDDEAUTO, Microsoft Office\nFrameset and Link auto\nupdate\n\nKoadic\nHacking Tools\nSecond-stage payloads\n\n\nBackdoor ChChes ANEL ANEL\n\n**Technical Analysis**\n\n[Figure 1. Infection Chain for the current ChessMaster campaign](https://blog.trendmicro.com/content/dam/trendmicro/global/en/migrated/security-intelligence-migration-spreadsheet/trendlabs-security-intelligence/2018/03/ChessMaster0.jpg)\n\nFigure 1. Infection Chain for the current ChessMaster campaign\n\nChessMaster’s current iteration starts off with the familiar phishing attacks seen in the earlier\ncampaigns that involved the use of an email with an attached malicious document using the\ndoc, docx, rtf, csv and msg formats. The email title and attached file name were written in\nJapanese and contain general business, political, and economy-themed phrases such as\n\n世界経済(World economy)\n経済政策(economic policy)\n予算概算要求(budget estimation request)\n日米対話(Japan-US dialogue)\n安倍再任(re-appointment of Prime Minister Abe)\n連絡網(contact network)\n職員採用案(staff recruitment plan)\n会議(meeting)\n\n\n-----\n\nHowever, there is a change in the exploit document. When we tracked ChessMaster back in\n[November, we noted that it exploited the SOAP WSDL parser vulnerability CVE-2017-8759](https://blog.trendmicro.com/trendlabs-security-intelligence/microsoft-office-zero-day-vulnerability-addressed-september-patch-tuesday/)\n(patched in September 2017) within the Microsoft .NET framework to download additional\nmalware. While ChessMaster still uses the previous exploit, it also added more methods to\nits arsenal: one exploits another vulnerability, [CVE-2017-11882 (patched in November 2017),](https://www.trendmicro.com/vinfo/us/security/news/vulnerabilities-and-exploits/17-year-old-ms-office-flaw-cve-2017-11882-actively-exploited-in-the-wild)\n[which was also exploited to deliver illegal versions of the Loki infostealer.](https://blog.trendmicro.com/trendlabs-security-intelligence/cve-2017-11882-exploited-deliver-cracked-version-loki-infostealer/)\n\n[Figure 2. Exploitation of CVE-2017-11882](https://blog.trendmicro.com/content/dam/trendmicro/global/en/migrated/security-intelligence-migration-spreadsheet/trendlabs-security-intelligence/2018/03/ChessMaster1.png)\n\nFigure 2. Exploitation of CVE-2017-11882\n\nIt also abuses three legitimate MS Office functions:\n\n**Function** **Purpose** **Affected MS Office**\n**Formats we found in**\n**the wild**\n\n\n**Automatic Dynamic**\n**Data Exchange**\n**(DDEAUTO)**\n\n\nA legitimate Microsoft Office function used\nin an Office file to retrieve data from\nanother Office file\n\n\n**.doc**\n**.rtf**\n**.msg**\n\n**.csv**\n\n**.docx**\n\n\n**Link Auto Update** An Office function used for automatic and\nuser-free updates for embedded links\nupon opening.\n\n\n**Microsoft Word's**\n**\"Frames/Frameset\"**\n\n\nA feature that allows HTML or Text pages\nto be loaded in a frame within Microsoft\nWord.\n\n\n[Figure 2. Exploitation of DDEAUTO](https://blog.trendmicro.com/content/dam/trendmicro/global/en/migrated/security-intelligence-migration-spreadsheet/trendlabs-security-intelligence/2018/03/ChessMaster2.png)\n\nFigure 3. Exploitation of DDEAUTO\n\n[Figure 3. Abusing Microsoft Word's](https://blog.trendmicro.com/content/dam/trendmicro/global/en/migrated/security-intelligence-migration-spreadsheet/trendlabs-security-intelligence/2018/03/ChessMaster3.png)\n\nFigure 4. Abusing Microsoft Word's \"Frames/Frameset\"\n\n[Figure 4. Exploitation of Link Auto Update](https://blog.trendmicro.com/content/dam/trendmicro/global/en/migrated/security-intelligence-migration-spreadsheet/trendlabs-security-intelligence/2018/03/ChessMaster4.png)\n\nFigure 5. Exploitation of Link Auto Update\n\nChessMaster can utilize any of these methods to download the next malware in the chain,\nthe open source post-exploitation tool known as “Koadic,” which the previous campaign also\nused. This tool is responsible for stealing information — specifically the environment\ninformation — within the target system. Koadic executes the following command:\n\n%comspec% /q /c <cmd> 1> <Output> 2>&1\n\n\n-----\n\nThe commands and output of Koadic will change according to the ANEL version used in the\nattack. The table below lists examples of the commands and outputs for ANEL versions 5.1.1\nrc and 5.1.2 rc1. Note that if ANEL 5.1.2 rc1 was downloaded, the attacker would use\nHTTPS to avoid the downloaded data being captured as clear text.\n\n[Figure 5. Koadic commands and output when ANEL 5.1.1 rc is used](https://blog.trendmicro.com/trendlabs-security-intelligence/files/2018/03/ChessMaster15-1.jpg)\n\nFigure 6. Koadic commands and output when ANEL 5.1.1 rc is used\n\n[Figure 6. Koadic commands and output when ANEL 5.1.1 rc1 is used](https://blog.trendmicro.com/trendlabs-security-intelligence/files/2018/03/ChessMaster16-1.jpg)\n\nFigure 7. Koadic commands and output when ANEL 5.1.2 rc1 is used\n\nThe table below lists all of Koadic's functions:\n\n{Variable}.user User-related functions\n\n{Variable}.user.isElevated Check Privilege\n\n{Variable}.user.OS Get OS Version\n\n{Variable}.user.DC Get DCName from Registry\n\n{Variable}.user.Arch Get Architecture\n\n{Variable}.user.info Get User Information\n\n{Variable}.work Main Routine functions\n\n{Variable}.work.report Reports to server\n\n{Variable}.work.error Returns error\n\n{Variable}.work.make_url Alters/Modifies URL (C&C)\n\n{Variable}.work.get Get the return of POST Header\n\n{Variable}.work.fork Creates rundll32.exe process\n\n{Variable}.http HTTP Connection functions\n\n{Variable}.http.create Creates initial HTTP objects\n\n{Variable}.http.post POST header\n\n{Variable}.http.addHeaders Adds HTTP Headers\n\n{Variable}.http.get GET Header\n\n{Variable}.http.upload Uploads binaries/data\n\n\n-----\n\n{Variable}.http.bin2str String manipulation\n\n{Variable}.http.downloadEx Downloads response\n\n{Variable}.http.download Additional download function\n\n{Variable}.process Process-related functions\n\n{Variable}.process.currentPID Get Current Process ID\n\n{Variable}.process.list Enumerates Process\n\n{Variable}.process.kill Terminates Process\n\n{Variable}.registry Registry-related functions\n\n{Variable}.registry.HKCR Set HKEY_CLASSES_ROOT\n\n{Variable}.registry.HKCU Set HKEY_CURRENT_USER\n\n{Variable}.registry.HKLM Set HKEY_LOCAL_MACHINE\n\n{Variable}.registry.STRING Set String Value\n\n{Variable}.registry.BINARY Set Binary Value\n\n{Variable}.registry.DWORD Set DWORD Value\n\n{Variable}.registry.QWORD Set QWORD Value\n\n{Variable}.registry.write Write/Add Registry\n\n{Variable}.registry.provider Create Registry Handle\n\n{Variable}.registry.destroy Deletes Registry Key\n\n{Variable}.registry.read Get/Read Registry Entries\n\n{Variable}.WMI WMI-related functions\n\n{Variable}.WMI.createProcess Creates specified process\n\n{Variable}.shell File/Process Execution functions\n\n{Variable}.shell.run Run commands\n\n{Variable}.shell.exec Executes process\n\n{Variable}.file File-related functions\n\n{Variable}.file.getPath Get specified file path\n\n\n-----\n\n{Variable}.file.readText Reads specified text file\n\n{Variable}.file.get32BitFolder Get System Folder (32/64-bit)\n\n{Variable}.file.writol Writes on specified file\n\n{Variable}.file.deleteFile Deletes specified file\n\n{Variable}.file.readBinary Reads specified binary file.\n\nFigure 8. Command added when the Koadic RAT is downloaded (use of {Variable}.shell.exec\ncommand)\n\nIf Koadic finds that the system is conducive to the attacker’s interests, it downloads a\nbase64-encrypted version of the ANEL malware from the Command-and-Control (C&C)\nserver and executes it. Encrypted ANEL is decrypted using the “certutil -docode” command.\nWhen ANEL executes, a decrypted DLL file with the filename “lena_http_dll.dll” is expanded\nin memory. This file contains one export function — either “crt_main” or “lena_main”\n\nFigure 9. Base64 encoded ANEL downloaded by Koadic\n\nANEL will send the infected environment’s information to the C&C server. When sending the\ninformation, ANEL encrypts the data using blowfish, XOR, and Base64-based encryption\nmethods. The format ANEL uses to send data is similar to ChChes, but ANEL's encryption\nmethod is easier to use.\n\nFigure 10. Encryption key using blowfish\n\nWe initially discovered the malware known as ANEL back in September 2017. At that time,\nChessMaster was using ANEL as a backdoor into the target system then injects code into\nsvchost.exe, which then decrypts and activates the embedded backdoor. This initial version\nof ANEL had a hardcoded version labeled “5.0.0 beta1” that contained incomplete code. We\nnoted that this might signify the release of a future variant. Instead of just one new variant,\nwe discovered four different versions of ANEL:\n\n5.0.0 beta1\n5.1.1 rc\n5.1.2 rc1\n5.2.0 rev1\n\n\n-----\n\nThe different versions contain changes in the ANEL loader and the main ANEL DLL. The\nfigure below shows a summary of the changes between each version:\n\n[Figure 10. Summary of the changes between each version of ANEL](https://blog.trendmicro.com/trendlabs-security-intelligence/files/2018/03/ChessMaster17-1.jpg)\n\nFigure 11. Summary of the changes between each version of ANEL\n\nDifferences with regards to Backdoor commands:\n\nCMD ID 5.0.0 beta1/5.1.1 rc/5.1.2 rc1 5.2.0 rev1\n\n0x97A168D9697D40DD Save File\n\n0x7CF812296CCC68D5 Upload File\n\n0x652CB1CEFF1C0A00 NA Load New PE file\n\n0x27595F1F74B55278 Save File and Execute\n\nIf no match above Execute Command or File\n\nThe differences shown in the table above are subtle but present. For example, the initial\nANEL version, “5.0.0 beta1,” uses a different C&C server compared to the other versions.\nOnce ANEL evolved to “5.1.1 rc,” it changed its file type to an executable, while also\nchanging the C&C server. The third version we found (5.1.2 rc1) reverts to a DLL file type but\nretains the C&C server. The fourth version of ANEL (5.2.0 rev1) changes both the export\nfunction in the expanded main ANEL DLL and uses a different C&C server. Overall, we can\nsee subtle changes, which indicate that the threat actors behind ANEL are making\nincremental improvements to the malware to refine it.\n\nFigure 12. Backdoor function differences between ANEL 5.0.0 beta1/5.1.1 rc/5.1.2 rc1 (left)\nand ANEL 5.2.0 rev1 (right)\n\nOnce ANEL enters the user’s system, it will download various tools that could be used for\nmalicious purposes, including password retrieval tools as well as malicious mail services and\naccessibility tools that will allow it to gather information about the system. These include\nGetpass.exe and Mail.exe, which are password and information stealers. It also downloads\nthe following:\n\nAccevent.exe <-> Microsoft Accessible Event Watcher 7.2.0.0\nevent.dll <-> the loader of ssssss.ddd, (Detected as TROJ_ANELLDR)\nssssss.ddd (lena_http.bin) <-> encrypted BKDR_ANEL (Detected as\nBKDR_ANELENC)\n\n\n-----\n\nThese three files work together using a common technique call DLL Side-Loading or DLL\nHijacking. In this scenario, accevent.exe is the primary executable, which is usually\nlegitimate.\n\nAfter the execution of accevent.exe, it loads event.dll, which will be placed in the same folder\n(so it takes loading priority), after which event.dll decrypts and loads the encrypted backdoor\n_ssssss.ddd, which is BKDR_ANEL. When we analyzed ANEL 5.1.1 rc, encrypted ANEL 5.1.2_\nrc1 was downloaded and executed.\n\n**Short-term mitigation**\n\nWhen the user opens the document DDEAUTO or Link Auto Update, Office will display a\nmessage. If the user clicks on the “No” button, malicious activity will not initiate.\n\nFigure 13: Popup message when users open the document that abuses DDEAUTO\n\nFigure 13. Popup message when the user opens the document that abuses Link Auto\nUpdate\n\nFigure 14. Popup message when the user opens the document that abuses Link Auto\nUpdate\n\nKoadic sends its own JavaScript code as plain text. The suspect communication allows us to\ndetect the traffic.\n\nFigure 15. Koadic’s communication traffic\n\n**Medium- to long-term mitigation**\n\nAt first glance, it seems ChessMaster’s evolution over the past few months involves subtle\nchanges. However, the constant addition and changing of features and attack vectors\nindicate that the attackers behind the campaign are unlikely to stop and are constantly\nlooking to evolve their tools and tactics.\n\nOrganizations can implement various techniques and best practices to defend against\ntargeted attacks, such as regular patching to prevent vulnerability exploitation and using\ntools that provide protection across different network levels. Solutions that feature behavior\n[monitoring, application control, email gateway monitoring, and intrusion/detection systems](https://blog.trendmicro.com/en_us/business/products/user-protection/sps/endpoint.html)\ncan help with this.\n\nGiven how cybercriminal tools, tactics and procedures are evolving, organizations will have\nto go beyond their typical day-to-day security requirements and find a way to preempt\nattacks. Thus, there is a pressing need to detect and address threats via a proactive incident\n\n\n-----\n\nresponse strategy. Essentially, this involves creating a remediation plan for effectively\ncombating the threat and using round-the-clock intrusion detection and threat analysis to\nprevent attacks from entering the system. A proactive strategy can be much more effective\nfor targeted attacks, as these kinds of attacks are often designed to be elusive and difficult to\ndetect, thus the need to scope them out. A comprehensive security strategy that involves\nproactive incident response will need the input of both decision makers and tech-savvy\npersonnel, as they will need to be on the same page for it to be effective.\n\nIn addition to implementing both mitigation techniques and proactive strategies,\norganizations can also strengthen their security by employing solutions such Trend Micro™\nDeep Security™ and TippingPoint, which protects endpoints from threats that abuse\nvulnerabilities.\n\nIn addition, comprehensive security solutions can be used to protect organizations from\nattacks. These include Trend Micro endpoint solutions such as Trend Micro™ Smart\nProtection Suites and [Worry-Free™ Business Security, which can protect users and](https://blog.trendmicro.com/en_us/small-business/worry-free.html)\nbusinesses from these threats by detecting malicious files, well as blocking all related\n[malicious URLs. Trend Micro Deep Discovery™ can protect enterprises by detecting](https://blog.trendmicro.com/en_us/business/products/network/advanced-threat-protection/deep-discovery-threat-intelligence-network-analytics.html)\nmalicious attachment and URLs.\n\nTrend Micro OfficeScan™ with XGen™ endpoint security infuses high-fidelity machine\nlearning with other detection technologies and global threat intelligence for comprehensive\nprotection against all kinds of threats. A more detailed analysis of the Command-and-Control\n[communication flow of ANEL can be found in this technical brief.](https://documents.trendmicro.com/assets/technical-brief-chessmaster-adds-updated-tools-to-its-arsenal.pdf)\n\n**Indicators of Compromise**\n\nHash Downloader used in the campaign:\n\n**76b1f75ee15273d1226392db3d8f1b2aed467c2875e11d9c14fd18120afc223a**\n**4edcff56f586bd69585e0c9d1d7ff4bfb1a2dac6e2a9588f155015ececbe1275**\n**1b5a1751960b2c08631601b07e3294e4c84dfd71896453b65a45e4396a6377cc**\n\nHashes detected as part of the BKDR_ANEL Family: 5.0.0 beta1\n\naf1b2cd8580650d826f48ad824deef3749a7db6fde1c7e1dc115c6b0a7dfa0dd\n\n_5.1.1 rc_\n\n2371f5b63b1e44ca52ce8140840f3a8b01b7e3002f0a7f0d61aecf539566e6a1\n\n_5.1.2 rc1_\n\n05dd407018bd316090adaea0855bd7f7c72d9ce4380dd4bc0feadc6566a36170\n\n_5.2.0 rev1_\n\n\n-----\n\n00030ec8cce1f21120ebf5b90ec408b59166bbc3fba17ebae0fc23b3ca27bf4f\n\n_lena_http.bin_\n\n303f9c00edb4c6082542e456a30a2446a259b8bb9fb6b0f76ff318d5905e429c\n\nTools used in the campaign:\n\n_Getpass.exe_\n\n52a8557c8cdd5d925453383934cb10a85b117522b95c6d28ca097632ac8bc10d\n\n_event.dll_\n\n6c3224dbf6bbabe058b0ab46233c9d35c970aa83e8c4bdffb85d78e31159d489\n\n_mail.exe_\n\n2f76c9242d5ad2b1f941fb47c94c80c1ce647df4d2d37ca2351864286b0bb3d8\n\nURLs and IP Addresses related to the campaign:\n\nwww[.]nasnnones[.]com\ntrems[.]rvenee[.]com\ncontacts[.]rvenee[.]com\n91[.]207[.]7[.]91\n89[.]18[.]27[.]159\n89[.]37[.]226[.]108\n185[.]25[.]51[.]116\n185[.]81[.]113[.]95\n185[.]144[.]83[.]82\n185[.]153[.]198[.]58\n185[.]159[.]129[.]226\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-03-29 - ChessMaster Adds Updated Tools to Its Arsenal.pdf"
    ],
    "report_names": [
        "2018-03-29 - ChessMaster Adds Updated Tools to Its Arsenal.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535840,
    "ts_updated_at": 1743041167,
    "ts_creation_date": 1653710289,
    "ts_modification_date": 1653710289,
    "files": {
        "pdf": "https://archive.orkl.eu/04bb9fc31260deaa03b2460ff0b30d5701b9a969.pdf",
        "text": "https://archive.orkl.eu/04bb9fc31260deaa03b2460ff0b30d5701b9a969.txt",
        "img": "https://archive.orkl.eu/04bb9fc31260deaa03b2460ff0b30d5701b9a969.jpg"
    }
}