{
    "id": "d5b263df-6d77-4a71-8899-05f50e462727",
    "created_at": "2023-01-12T15:03:43.126825Z",
    "updated_at": "2025-03-27T02:05:48.522108Z",
    "deleted_at": null,
    "sha1_hash": "ddb23fcb486ed66e217944cca4c52cf0c1487b9e",
    "title": "2021-05-19 - Colonial Pipeline Ransomware Attack- Revealing How DarkSide Works",
    "authors": "",
    "file_creation_date": "2022-05-28T03:58:43Z",
    "file_modification_date": "2022-05-28T03:58:43Z",
    "file_size": 4149113,
    "plain_text": "# Colonial Pipeline Ransomware Attack: Revealing How DarkSide Works\n\n**[nozominetworks.com/blog/colonial-pipeline-ransomware-attack-revealing-how-darkside-works/](https://www.nozominetworks.com/blog/colonial-pipeline-ransomware-attack-revealing-how-darkside-works/)**\n\nBy May 19, 2021\n\nThroughout the last two weeks, the entire cybersecurity community has been riveted by the\nColonial Pipeline ransomware attack. It is one of the most notable attacks on critical\ninfrastructure of the past few years and has directly and indirectly impacted multiple\nindustries in the U.S economy. Thankfully, operations are up and running after an\napproximately week-long outage and reported payment of a $5 million ransom.1\n\nDarkSide, the Ransomware as a Service (RaaS) deployed against Colonial Pipeline, is a\ngood example of similar malware attacking organizations around the globe. Carefully\nprepared and deployed, it uses a combination of techniques to successfully extort its victims.\n\nNozomi Networks Labs has studied the internals of the DarkSide executable and today we’re\nsharing our findings to reveal the techniques used by its machine code in three areas: the\nselection of victims and files, ensuring anonymity and anti-detection, and preventing data\nrestoration. We also provide IoCs and a decryption script to help you detect DarkSide.\n\nIt’s important to remember that the sum of Darkside’s code translates to devastating\nconsequences in the physical world. We encourage you to understand DarkSide’s\ntechniques to help you assess both your own defenses and your incident response\ncapabilities.\n\n\n-----\n\nNozomi Networks Labs’ technical analysis of the DarkSide ransomware’s main executable\nreveals the techniques it uses – helping you assess your own defenses.\n\n### DarkSide Ransomware: Technical Analysis\n\n**Victim Validation**\n\nThe malware first collects basic information about its victim’s computer systems to learn the\ndetails of the technical environment.\n\nThe malware obtains the affected computer’s name.\n\n\n-----\n\nDarkSide collects the victim’s basic system information.\n\nIn addition, it skips victims from certain geographical regions by checking the language used\nby their systems. (Notably, DarkSide does not attack systems that use Russian or other\nEastern European languages. )2\n\nThe ransomware checks if the system language is the one used in CIS countries.\n\n**Selection of Files for Encryption**\n\nNext, DarkSide determines what files to encrypt. If malware attempts to encrypt all the files\navailable on the system, it quickly makes the system unusable – and leaves the victim\nwithout information on how contact the attackers. In addition, it takes significantly more time\n\n\n-----\n\nto do the encryption than is needed for the purposes of executing the attack. DarkSide is\nparticularly selective about what files it encrypts, selecting them mainly by examining their\nfile directories, file names and file extensions.\n\nThe list of directories, file names and file extensions skipped during the encryption.\n\n**Anonymity**\n\nTo remain anonymous and prevent prompt shutdown, websites for contacting ransomware\nthreat actors are hosted in the Tor network.\n\nA section of DarkSide’s instructions describing how to access the Tor-based website.\n\n### Anti-Detection Techniques\n\nTo stay under the radar until the victim’s systems are impacted, DarkSide incorporates\nvarious commonly used techniques.\n\n**Self-Encryption**\n\nMost of the Darkside’s critical strings are encrypted to avoid triggering detection.\n\nThe XOR-based decryption algorithm.\n\n\n-----\n\nFor the same reason, the malware s main configuration is also encrypted. It is compressed\nwith aPLib, with individual configuration values encoded with a Base64 algorithm.\n\nDecryption and decompression of the configuration block.\n\n\n-----\n\nBase64-encoded configuration values in the malware.\n\n**Dynamic API Resolution**\n\nWinAPIs are the standard way programs interact with the Windows operating system to\naccess certain functionality, including file and network operations. Therefore, use of these\ninterfaces quickly reveals the actual purpose of the malware to security systems.\n\nTo prevent detection, DarkSide does not immediately have all the APIs used available in the\nimport table, as legitimate executables do. Instead, it resolves them dynamically before using\nthem, some by hashed names and some by encrypted names.\n\nThe dynamic WinAPI resolution used by DarkSide.\n\n## Preventing Data Restoration\n\nIf system administrators could quickly and easily restore the affected data without paying\nmoney to criminals, ransomware attacks would not succeed. The authors of DarkSide\nincorporate multiple techniques to ensure ransom is paid.\n\n\n-----\n\n**Dealing with Backups**\n\nRansomware makes sure that standard backup solutions are unusable on the targeted\nmachines. Windows has a feature called Shadow Copy aimed at dealing with such\nsituations. It allows the creation of backup copies of computer files so they can be restored\nwhen needed. The main limitation of this approach is that the backup files are stored on the\nsame system as the original files. If malware compromises the system, the backup files are\nreadily deleted.\n\nThe commands used to get a list of Shadow Copy backups.\n\nIn addition, the malware can search for backups by name:\n\nThe ransomware’s search for and deletion of backups.\n\nFinally, DarkSide attempts to disable various backup solutions, searching for them by name.\n\nThe list of services to terminate from the embedded configuration\n\n\n-----\n\nThe process DarkSide uses to stop and delete backup-related services.\n\n### Correct Use of Symmetric and Asymmetric Encryption\n\nMany first generations of ransomware lacked proper encryption, which made it possible for\nvictims to recover files on their systems for free. Unfortunately, those days are long gone,\nand modern malware families do not repeat this mistake.\n\n\n-----\n\nThe main difference now is that symmetric encryption has been enhanced with focused use\nof asymmetric encryption. The former uses the same secret key for both encrypting and\ndecrypting the data, therefore intercepting it is enough to restore access to the data.\n\nOn the other hand, asymmetric encryption uses a notion of private and public keys. While the\nencryption is done using a public key, the decryption is impossible without a private key.\nDarkSide malware implements this functionality properly by only embedding the public key in\nthe malware and keeping the private key confidential.\n\nThe main disadvantage of asymmetric encryption over symmetric is the encryption speed.\nTo get the best of both worlds, the authors of DarkSide encrypt victims’ files using a\nsymmetric encryption algorithm (Salsa20 with a custom matrix) and then encrypt the\ncorresponding symmetric keys with their asymmetric public key (RSA-1024).\n\n\n-----\n\nThe symmetric Salsa20 encryption algorithm with a custom matrix.\n\n### DarkSide Demonstrates Modern Ransomware Techniques\n\nDarkSide is just one example of a modern ransomware family that combines multiple timetested techniques to achieve its goal. It also highlights the effectiveness of the RaaS model,\nwhich is gaining in popularity. With this model, multiple parties are involved in each attack,\nwith a division of effort that plays to the strengths of each party.\n\nWith RaaS, experienced malware writers focus on the development of the core ransomware\ncode, leaving deployment to affiliates who specialize in gaining access to the networks of\ntargeted organizations. In the case of DarkSide, it is estimated that their more than 40\n\n\n-----\n\nvictims have paid $90 million in total bitcoin, with $15.5 million going to the development\ngroup and $74.7 million going to its affiliates.3\n\nWe hope that this technical analysis of DarkSide helps you better understand ransomware\ntechniques and evaluate your own defenses and incident response capabilities. And, to help\nyou detect DarkSide, IoCs and a script for decrypting embedded strings is provided at the\nend of this article.\n\nIt goes without saying that using network monitoring tools that help you detect unusual\nbehavior and activity early in the malware kill chain gives you the best chance to contain\nransomware before the final payload is executed. Such tools also provide actionable forensic\ninformation, as well as logs and pcaps, to assist with a timely response.\n\nFor more information on ransomware, don’t miss our 20-minute webinar “Demystifying the\n[Colonial Pipeline Attack & How Ransomware Works” and our latest “OT/IoT Security Report.”](https://www.nozominetworks.com/ot-iot-security-report/)\n\n**Related Content**\n\nON-DEMAND WEBINAR\n\n### Demystifying the Colonial Pipeline Attack & How Ransomware Works\n\n**Learn about:**\n\nHow the attack happened and who was responsible\nWho DarkSide is, and what cybersecurity professionals should understand about them\n\n\n-----\n\nWhat security practices you should put in place to counter ransomware\nWhat recommended actions you can take to prevent future ransomware incidents\n\n[Watch Now](https://event.on24.com/wcc/r/3184490/7222E654E4562790448263B8016A84AC?partnerref=blog)\n\nRESEARCH REPORT\n\n### OT/IoT Security Report\n\n**What You Need to Know to Fight Ransomware and IoT Vulnerabilities**\n\n**July 2021**\n\nWhy ransomware is a formidable threat\nAnalysis of DarkSide, the malware that attacked Colonial Pipeline\nLatest ICS and medical device vulnerability trends\nWhy P2P security camera architecture threatens confidentiality\nHow security cameras are vulnerable\nTen measures to take immediately to defend your systems\n\n[Download](https://www.nozominetworks.com/ot-iot-security-report/)\n\n### IOCs\n```\n   0a0c225f0e5ee941a79f2b7701f1285e4975a2859eb4d025d96d9e366e81abb9\n   baroquetees[.]com\n\n```\n\n-----\n\n```\n   rumahsia[.]com\n\n### Script\n\n```\nHere is an IDAPython script to decrypt embedded strings, it requires the cursor to stay at the\ndecryption routine:\n```\n# Author: Nozomi Networks Labs\nimport idautils\nimport idaapi\nimport idc\nimport struct\ndef is_utf16_heur(string):\n  counter = 0\n  for val in string:\n    if val == '\\x00':\n      counter += 1\n  if counter/float(len(string)) > 0.4:\n    return True\n  return False\ndef chunks(lst, n):\n  for i in range(0, len(lst), n):\n    yield lst[i:i + n]\ndef decrypt_block(enc_string, key_matrix):\n  dec_string = []\n  for enc_block in chunks(list(enc_string), 255):\n    temp_key_matrix = key_matrix.copy()\n    bl = 0\n    for i in range(len(enc_block)):\n      bl = (bl + temp_key_matrix[i+1]) & 0xFF\n      al = temp_key_matrix[i+1]\n      ch = temp_key_matrix[bl]\n      temp_key_matrix[bl] = al\n      temp_key_matrix[i+1] = ch\n      al = (al + ch) & 0xFF\n      al = temp_key_matrix[al]\n      enc_block[i] = enc_block[i] ^ al\n    dec_string += enc_block\n  dec_string = ''.join(map(lambda x: chr(x), dec_string))\n  return dec_string\ndef guess_encoding(dec_string):\n  utf16_flag = False\n  if is_utf16_heur(dec_string):\n    try:\n      dec_string_print = dec_string.encode('latin-1').decode('utf16le')\n\n```\n\n-----\n\n```\n      idc.set_inf_attr(INF_STRTYPE, STRTYPE_C_16)\n      utf16_flag = True\n    except Exception as e:\n      pass\n  if not utf16_flag:\n    dec_string_print = dec_string\n    idc.set_inf_attr(INF_STRTYPE, STRTYPE_C)\n  # dec_string_print = dec_string_print.replace('\\r',\n'\\\\r').replace('\\n', '\\\\n')\n  return dec_string_print\ndef decrypt_all(enc_func, key_matrix):\n  for ref in idautils.CodeRefsTo(enc_func, True):\n    arg_addr = idc.prev_head(ref)\n    if idc.print_insn_mnem(arg_addr) == 'push':\n      enc_string_addr = idc.get_operand_value(arg_addr, 0)\n      if enc_string_addr == 0:\n        print('Warning: wrong address of the encrypted string at\n%x: %x' % (arg_addr, enc_string_addr))\n        continue\n      enc_string_size = struct.unpack('<I',\nidc.get_bytes(enc_string_addr-4, 4))[0]\n      if enc_string_size < 0xFFFF:\n        enc_string = idc.get_bytes(enc_string_addr,\nenc_string_size)\n      else:\n        print('Warning: excessively long encrypted string at %x %x' % (arg_addr, enc_string_addr))\n        exit(1)\n      dec_string = decrypt_block(enc_string, key_matrix)\n      dec_string_print = guess_encoding(dec_string)\n      print('%x: %s' % (enc_string_addr, dec_string_print))\n      idaapi.patch_bytes(enc_string_addr, dec_string.encode('latin1'))\n      idc.create_strlit(enc_string_addr,\nenc_string_addr+enc_string_size)\n    else:\n      print('Warning: non-standard argument at %x: %x' % (ref,\narg_addr))\n\n```\n\n-----\n\n[Alexey Kleymenov](https://www.nozominetworks.com/author/alexey-kleymenov/)\n**Sr. Cyber Threat Analyst**\nAlexey Kleymenov performs in-depth research for emerging threats and designs and\ndevelops threat intelligence infrastructure in his role at Nozomi Networks. He is passionate\nabout reverse engineering, prototyping, process automation and research. His background\nincludes 12+ years of practical experience with several anti-virus companies and he is a\nmember of the (ISC)² organization.\n\nAlexey is the author of the book “Mastering Malware Analysis: The complete malware\nanalyst’s guide to combating [malicious software, APT, cybercrime, and IoT attacks.”](https://www.amazon.com/gp/product/B07SSK5HLT/ref=dbs_a_def_rwt_hsch_vapi_tkin_p1_i0)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-19 - Colonial Pipeline Ransomware Attack- Revealing How DarkSide Works.pdf"
    ],
    "report_names": [
        "2021-05-19 - Colonial Pipeline Ransomware Attack- Revealing How DarkSide Works.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535823,
    "ts_updated_at": 1743041148,
    "ts_creation_date": 1653710323,
    "ts_modification_date": 1653710323,
    "files": {
        "pdf": "https://archive.orkl.eu/ddb23fcb486ed66e217944cca4c52cf0c1487b9e.pdf",
        "text": "https://archive.orkl.eu/ddb23fcb486ed66e217944cca4c52cf0c1487b9e.txt",
        "img": "https://archive.orkl.eu/ddb23fcb486ed66e217944cca4c52cf0c1487b9e.jpg"
    }
}