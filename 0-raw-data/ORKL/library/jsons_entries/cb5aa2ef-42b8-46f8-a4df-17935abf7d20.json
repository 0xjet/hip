{
    "id": "cb5aa2ef-42b8-46f8-a4df-17935abf7d20",
    "created_at": "2023-01-12T15:06:39.557867Z",
    "updated_at": "2025-03-27T02:15:24.60152Z",
    "deleted_at": null,
    "sha1_hash": "5486b6b583108342e12a7368d11d50a8490ef88d",
    "title": "2015-04-18 - Operation RussianDoll- Adobe & Windows Zero-Day Exploits Likely Leveraged by Russia’s APT28 in Highly-Targeted Attack",
    "authors": "",
    "file_creation_date": "2022-05-27T22:15:47Z",
    "file_modification_date": "2022-05-27T22:15:47Z",
    "file_size": 89198,
    "plain_text": "# Operation RussianDoll: Adobe & Windows Zero-Day Exploits Likely Leveraged by Russia’s APT28 in Highly- Targeted Attack\n\n**[fireeye.com/blog/threat-research/2015/04/probable_apt28_useo.html](https://www.fireeye.com/blog/threat-research/2015/04/probable_apt28_useo.html)**\n\n## Breadcrumb\n\nThreat Research\n\nFireeye Labs\n\nApr 18, 2015\n\n7 mins read\n\n\n-----\n\nFireEye Labs recently detected a limited APT campaign exploiting zero-day vulnerabilities in\nAdobe Flash and a brand-new one in Microsoft Windows. Using the Dynamic Threat\nIntelligence Cloud (DTI), FireEye researchers detected a pattern of attacks beginning on\nApril 13, 2015. Adobe independently patched the vulnerability (CVE-2015-3043) inth\n[APSB15-06. Through correlation of technical indicators and command and control](https://helpx.adobe.com/security/products/flash-player/apsb15-06.html)\ninfrastructure, FireEye assess that APT28 is probably responsible for this activity.\n\nMicrosoft is aware of the outstanding local privilege escalation vulnerability in Windows\n(CVE-2015-1701). While there is not yet a patch available for the Windows vulnerability,\nupdating Adobe Flash to the latest version will render this in-the-wild exploit innocuous. We\nhave only seen CVE-2015-1701 in use in conjunction with the Adobe Flash exploit for CVE2015-3043. The Microsoft Security Team is working on a fix for CVE-2015-1701.\n\n## Exploit Overview\n\nThe high level flow of the exploit is as follows:\n\n1.    User clicks link to attacker controlled website\n\n2.    HTML/JS launcher page serves Flash exploit\n\n3.    Flash exploit triggers CVE-2015-3043, executes shellcode\n\n4.    Shellcode downloads and runs executable payload\n\n5.    Executable payload exploits local privilege escalation (CVE-2015-1701) to steal\nSystem token\n\nThe Flash exploit is served from unobfuscated HTML/JS. The launcher page picks one of\ntwo Flash files to deliver depending upon the target’s platform (Windows 32 versus 64bits).\n\nThe Flash exploit is mostly unobfuscated with only some light variable name mangling. The\nattackers relied heavily on the CVE-2014-0515 Metasploit module, which is well\ndocumented. It is ROPless, and instead constructs a fake vtable for a FileReference object\nthat is modified for each call to a Windows API.\n\nThe payload exploits a local privilege escalation vulnerability in the Windows kernel if it\ndetects that it is running with limited privileges. It uses the vulnerability to run code from\nuserspace in the context of the kernel, which modifies the attacker’s process token to have\nthe same privileges as that of the System process.\n\n## CVE-2015-3043 Exploit\n\nThe primary difference between the CVE-2014-0515 metasploit module and this exploit is,\nobviously, the vulnerability. CVE-2014-0515 exploits a vulnerability in Flash’s Shader\nprocessing, whereas CVE-2015-3043 exploits a vulnerability in Flash’s FLV processing. The\nculprit FLV file is embedded within AS3 in two chunks, and is reassembled at runtime.\n\n\n-----\n\n### Vulnerability\n\nA buffer overflow vulnerability exists in Adobe Flash Player (<=17.0.0.134) when parsing\nmalformed FLV objects. Attackers exploiting the vulnerability can corrupt memory and gain\nremote code execution.\n\nIn the exploit, the attacker embeds the FLV object directly in the ActionScript code, and plays\nthe video using NetStream class. In memory, it looks like the following:\n\n0000000: 46 4c 56 01 05 00 00 00 09 00 00 00 00 12 00 00 FLV.............\n\n0000010: f4 00 00 00 00 00 00 00 02 00 0a 6f 6e 4d 65 74 ...........onMet\n\n0000020: 61 44 61 74 61 08 00 00 00 0b 00 08 64 75 72 61 aData.......dura\n\n0000030: 74 69 6f 6e 00 40 47 ca 3d 70 a3 d7 0a 00 05 77 tion.@G.=p.....w\n\n0000040: 69 64 74 68 00 40 74 00 00 00 00 00 00 00 06 68 idth.@t........h\n\n0000050: 65 69 67 68 74 00 40 6e 00 00 00 00 00 00 00 0d eight.@n........\n0000060: 76 69 64 65 6f 64 61 74 61 72 61 74 65 00 00 00 videodatarate...\n…..\n\n0003b20: 27 6e ee 72 87 1b 47 f7 41 a0 00 00 00 3a 1b 08 'n.r..G.A....:..\n\n0003b30: 00 04 41 00 00 0f 00 00 00 00 68 ee ee ee ee ee ..A.......h.....\n\n0003b40: ee ee ee ee ee ee ee ee ee ee ee ee ee ee ee ee ................\n\n0003b50: ee ee ee ee ee ee ee ee ee ee ee ee ee ee ee ee ................\n\n0003b60: ee ee ee ee ee ee ee ee ee ee ee ee ee ee ee ee ................\n\nFiles of the FLV file format contain a sequence of Tag structures. In Flash, these objects are\ncreated when parsing FLV Tags:\n\n.text:1018ACE9 sub_1018ACE9  proc near        ; CODE XREF: sub_1018BBAC+2Bp\n\n.text:1018ACE9                     ; sub_10192797+1A1p ...\n\n.text:1018ACE9\n\n.text:1018ACE9 arg_0      = dword ptr 4\n\n.text:1018ACE9\n\n.text:1018ACE9         mov   eax, ecx\n\n.text:1018ACEB         mov   ecx, [esp+arg_0]\n\n.text:1018ACEF         mov   dword ptr [eax], offset off_10BA771C\n\n.text:1018ACF5         mov   dword ptr [eax+24h], 1\n\n.text:1018ACFC         and   dword ptr [eax+14h], 0\n\n.text:1018AD00         mov   [eax+28h], ecx\n\n.text:1018AD03         mov   byte ptr [eax+20h], 0\n\n.text:1018AD07         retn  4\n\n.text:1018AD07 sub_1018ACE9  endp\n\nIn the case of this exploit, a Tag structure begins at offset 0x3b2f into the FLV stream that,\nwhen parsed, populates the Tag structure as follows:\n\n\n-----\n\nTag 2:\nUINT_8 type: 8\nUINT_24 datasize: 1089\nUINT_24 timestamp: 15\nUINT_8 timestamphi: 0\nUINT_24 streamid: 0\nUINT_4 fmt: 6\nUINT_2 sr: 2\nUINT_1 bits: 0\nUINT_1 channels: 0\nUBYTE data[1088]: \\xee\\xee\\xee\\xee…\nUINT_32 lastsize: 0xeeeeeeee\n\nBeginning within the data field, all contents of the FLV stream become 0xEE. Consequently,\nthe data and lastsize fields are mangled, and one final tag technically exists consisting\nexclusively of 0xEE:\n\nTag 3:\nUINT_8 type: 0xEE\nUINT_24 datasize: 0xEEEEEE\n…\n\nOne can see the datasize field of Tag2 populated from the attacker's FLV stream below:\n\n.text:10192943         mov   eax, [ebx+24h]\n.text:10192946         mov   [esi+14h], eax\n.text:10192949         movzx  eax, byte ptr [ebx+19h] ; 00\n.text:1019294D         movzx  ecx, byte ptr [ebx+1Ah] ; 04\n.text:10192951         shl   eax, 8\n.text:10192954         or   eax, ecx\n.text:10192956         movzx  ecx, byte ptr [ebx+1Bh] ; 41\n.text:1019295A         shl   eax, 8\n.text:1019295D         or   eax, ecx\n.text:1019295F         mov   ecx, ebx\n.text:10192961         mov   [esi+0Ch], eax ; 0x441\n.text:10192964         call  sub_1002E2B3\n\nThe buffer is allocated with fixed size 0x2000:\n\n.text:101A647E         push  2000h\n.text:101A6483         mov   ecx, esi\n.text:101A6485         call  sub_101A6257  ; alloc 0x2000 buffer, store in esi+0xDC\n……\n\n\n-----\n\n.text:101A627F         push  0\n.text:101A6281         push  edi       ; 0x2000\n.text:101A6282         call  sub_105EBEB0\n.text:101A6287         pop   ecx\n.text:101A6288         pop   ecx\n.text:101A6289         mov   [esi+0DCh], eax\n\nSince the size is controlled by the attacker, it’s possible to overflow the fixed size buffer with\ncertain data.\n\n\nrussian doll 1\n\n\nA datasize of 0x441 results in a value here of 0x1100 passed to sub_100F88F8, which\nmemcopies 0x2200 bytes in 0x11 chunks of 0x200. The last memcpy overflows the fixed size\n0x2000 buffer into a adjacent heap memory.\n\nAttackers spray the heap with array of Vector, 0x7fe * 4 + 8 == 0x2000, and create holes of\nsuch size, which will be allocated by the said object.\n\nwhile (_local_2 < this._bp35) // _bp35 == 0x2000\n{\nthis._ok47[_local_2] = new Vector.<uint>(this._lb60); // _lb60 == 0x07FE\nlocal 3 = 0x00;\n\n\n-----\n\nwhile (_local_3 < this._lb60)\n{\nthis._ok47[_local_2][_local_3] = 0x41414141;\n_local_3++;\n};\n_local_2 = (_local_2 + 0x01);\n};\n_local_2 = 0x00;\nwhile (_local_2 < this._bp35)\n{\nthis._ok47[_local_2] = null;\n_local_2 = (_local_2 + 0x02);\n};\n\n\n-----\n\nrussia doll 2\n\n\nAs the previous picture demonstrated, the followed Vector object’s length field being\noverflowed as 0x80007fff, which enables the attacker to read/write arbitrary data within user\nspace.\n\n## Shellcode\n\nShellcode is passed to the exploit from HTML in flashvars. The shellcode downloads the next\nstage payload, which is an executable passed in plaintext, to the temp directory with\nUrlDownloadToFileA, which it then runs with WinExec.\n\n## Payload & C2\n\n\n-----\n\nThis exploit delivers a malware variant that shares characteristics with the APT28 backdoors\n[CHOPSTICK and CORESHELL malware families, both described in our APT28 whitepaper.](https://www.fireeye.com/resources/report-apt28-a-window-into-russias-cyber-espionage-operations)\nThe malware uses an RC4 encryption key that was previously used by the CHOPSTICK\nbackdoor. And the C2 messages include a checksum algorithm that resembles those used\nin CHOPSTICK backdoor communications. In addition, the network beacon traffic for the\nnew malware resembles those used by the CORESHELL backdoor. Like CORESHELL, one\nof the beacons includes a process listing from the victim host. And like CORESHELL, the\nnew malware attempts to download a second-stage executable.\n\nOne of the C2 locations for the new payload, 87.236.215[.]246, also hosts a suspected\nAPT28 domain ssl-icloud[.]com. The same subnet (87.236.215.0/24) also hosts several\nknown or suspected APT28 domains, as seen in Table 1.\n\n\nrussian doll table\n\n\n-----\n\nThe target firm is an international government entity in an industry vertical that aligns with\nknown APT28 targeting.\n\n## CVE-2015-1701 Exploit\n\nThe payload contains an exploit for the unpatched local privilege escalation vulnerability\nCVE-2015-1701 in Microsoft Windows. The exploit uses CVE-2015-1701 to execute a\ncallback in userspace. The callback gets the EPROCESS structures of the current process\nand the System process, and copies data from the System token into the token of the current\nprocess. Upon completion, the payload continues execution in usermode with the privileges\nof the System process.\n\nBecause CVE-2015-3043 is already patched, this remote exploit will not succeed on a fully\npatched system. If an attacker wanted to exploit CVE-2015-1701, they would first have to be\nexecuting code on the victim’s machine. Barring authorized access to the victim’s machine,\nthe attacker would have to find some other means, such as crafting a new Flash exploit, to\ndeliver a CVE-2015-1701 payload.\n\nMicrosoft is aware of CVE-2015-1701 and is working on a fix. CVE-2015-1701 does not\naffect Windows 8 and later.\n\n## Acknowledgements\n\nThank you to all of the contributors to this blog!\n\nThe following people in FireEye: Dan Caselden, Yasir Khalid, James “Tom” Bennett,\nGenWei Jiang, Corbin Souffrant, Joshua Homan, Jonathan Wrolstad, Chris Phillips,\nDarien Kindlund\nMicrosoft & Adobe security teams\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-04-18 - Operation RussianDoll- Adobe & Windows Zero-Day Exploits Likely Leveraged by Russia’s APT28 in Highly-Targeted Attack.pdf"
    ],
    "report_names": [
        "2015-04-18 - Operation RussianDoll- Adobe & Windows Zero-Day Exploits Likely Leveraged by Russia’s APT28 in Highly-Targeted Attack.pdf"
    ],
    "threat_actors": [
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535999,
    "ts_updated_at": 1743041724,
    "ts_creation_date": 1653689747,
    "ts_modification_date": 1653689747,
    "files": {
        "pdf": "https://archive.orkl.eu/5486b6b583108342e12a7368d11d50a8490ef88d.pdf",
        "text": "https://archive.orkl.eu/5486b6b583108342e12a7368d11d50a8490ef88d.txt",
        "img": "https://archive.orkl.eu/5486b6b583108342e12a7368d11d50a8490ef88d.jpg"
    }
}