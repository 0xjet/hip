{
    "id": "c16e8831-967c-4e45-b467-b291146b8bee",
    "created_at": "2023-01-12T15:03:40.143138Z",
    "updated_at": "2025-03-27T02:16:01.237729Z",
    "deleted_at": null,
    "sha1_hash": "07801e3c388359f844da45cbaacc13bb484787fb",
    "title": "2020-12-16 - Next Version of the Bazar Loader DGA",
    "authors": "",
    "file_creation_date": "2022-05-27T21:08:46Z",
    "file_modification_date": "2022-05-27T21:08:46Z",
    "file_size": 1656028,
    "plain_text": "# Next Version of the Bazar Loader DGA\n\n**[johannesbader.ch/blog/next-version-of-the-bazarloader-dga/](https://johannesbader.ch/blog/next-version-of-the-bazarloader-dga/)**\n\nLast week, a new version of the Bazar Loader Domain Generation Algorithm (DGA)\n[appeared. I already analyzed two previous](https://johannesbader.ch/blog/the-dga-of-bazarbackdoor/) [versions, so I’m keeping this post short.](https://johannesbader.ch/blog/the-buggy-dga-of-bazarbackdoor/)\n\nThe DGA still uses the eponymous .bazar top level domain, but the second level domains\nare shorter with 8 characters instead of 12 for the previous versions:\n\n\n-----\n\n```\nliybelac.bazar\nizryudew.bazar\nbiymudqe.bazar\nfuicibem.bazar\nbiykonem.bazar\naqtielew.bazar\nyptaonem.bazar\nexyxtoca.bazar\niqfisoew.bazar\naguponew.bazar\nexogelqe.bazar\nexybonyw.bazar\netymonac.bazar\n\n```\nI analysed the following sample without much obfuscation. There are many other samples\nthat have additional reverse engineering counter measures such as junk code, but a quick\ncomparison revealed no functional differences.\n\n**MD5**\nc6502d4dd27a434167686bfa4d183e89\n\n**SHA1**\nbddbceefe4185693ef9015d0a535eb7e034b9ec3\n\n**SHA256**\n35683ac5bbcc63eb33d552878d02ff44582161d1ea1ff969b14ea326083ea780\n\n**Size**\n336 KB (344576 Bytes)\n\n**Compile Timestamp**\n2020-12-10 13:05:18 UTC\n\n**Links**\n[MalwareBazaar,](https://bazaar.abuse.ch/sample/35683ac5bbcc63eb33d552878d02ff44582161d1ea1ff969b14ea326083ea780/) [Malpedia,](https://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor) [Cape,](https://www.capesandbox.com/analysis/108231/) [VirusTotal](https://www.virustotal.com/gui/file/35683ac5bbcc63eb33d552878d02ff44582161d1ea1ff969b14ea326083ea780)\n\n**Filenames**\n1ld.3.v1.exe, 35683ac5bbcc63eb33d552878d02ff44582161d1ea1ff969b14ea326083ea780\n(VirusTotal)\n\n**Detections**\n**Virustotal: 8/72 as of 2020-12-11 02:58:32 - Win64/Bazar.Y (ESET-NOD32),**\nBackdoor.Win32.Bazdor.co (Kaspersky), Trojan.Win64.BAZALOADER.SMYAAJ-A\n(TrendMicro), Trojan.Win64.BAZALOADER.SMYAAJ-A (TrendMicro-HouseCall)\n\nUnpacking the sample leads to this:\n\n**MD5**\ne44cfd6ecc1ea0015c28a75964d19799\n\n**SHA1**\ncb294c79b5d48840382a06c4021bc2772fdbcf63\n\n\n-----\n\n**SHA256**\n52e72513fe2a38707aa63fbc52dabd7c7d2c5809ed7e27f384315375426f57bf\n\n**Size**\n96 KB (98816 Bytes)\n\n**Compile Timestamp**\n2020-12-09 10:16:56 UTC\n\n**Links**\n[MalwareBazaar,](https://bazaar.abuse.ch/sample/52e72513fe2a38707aa63fbc52dabd7c7d2c5809ed7e27f384315375426f57bf/) [Malpedia,](https://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor) [Cape,](https://www.capesandbox.com/analysis/108232/) [VirusTotal](https://www.virustotal.com/gui/file/52e72513fe2a38707aa63fbc52dabd7c7d2c5809ed7e27f384315375426f57bf)\n\n**Filenames**\ncontent.28641.20903.13470.9122.7127 (VirusTotal)\n\n**Detections**\n**Virustotal: 4/75 as of 2020-12-15 21:30:37**\n\n## Reverse Engineering\n\nApart from the common dynamic loading of Windows API functions and encrypted strings,\nBazar Loader relies on arithmetic substitution via identities to obfuscate the code. The\nfollowing relationship is particularly often used:\n\n$$ a \\oplus b = (\\sim a \\cdot b) + (a \\cdot \\sim b) $$\n\n[The same obfuscation is also used by Zloader. It makes the code very hard to read. Here is](https://johannesbader.ch/blog/the-dga-of-zloader/)\na small snippet from the DGA:\n\n\n-----\n\nHex Ray’s decompiler also produces really messy code because the arithmetic identities are\nnot simplified:\n\nThe DGA uses the current month and year as the seed. The seed is stored as a string, and\nits four ASCII characters are the basis for picking four character pairs. These four pairs are\njoined to form the 8 second level characters.\n\nThe list of character pairs is generated by calculating the cartesian product of the consonants\n“bcdfghklmnpqrstvwxz” and vowels (with y) “aeiouy”. The product is calculated both ways,\nleading to 19·6·2 character pairs. These pairs are then concatenated into a large string of\n456 characters by using a hardcoded sequence of random numbers:\n\n\n-----\n\n```\nqeewcaacywemomedekwyuhidontoibeludsocuexvuuftyliaqydhuizuctuiqow\nagypetehfubitiaziceblaogolryykosuptaymodisahfiybyxcoleafkudarapu\nqoawyluxqagenanyoxcygyqugiutlyvegahepovyigqyqibaeqynyfkiobpeepby\nxaciyvusocaripfyoftesaysozureginalifkazaadytwuubzuvoothymivazyyz\nhoevmeburedeviihiravygkemywaerdonoyryqloammoseweesuvfopiriboikuz\norruzemuulimyhceukoqiwfexuefgoycwiokitnuneroxepyanbekyixxiuqsias \n\n```\nThe string is then encrypted using a random xor key of the same length.\n\nApart from the date-based seed, the DGA also uses a standard linear congruential generator\n(LCG) to pick the four character pairs. The LCG is seeded with the current processor tick\ncount and thus unpredictable. For the first two character pairs, the random number is taken\nmod 19, and for the remaining two pairs mod 6. These numbers correspond to the length of\nthe consonants and vowels array, but make no sense in this context. Because the random\nnumbers are unpredictable, any combination of the 19·19·6·6 = 12996 character pairs could\nbe picked. Bazar Loader generates 10'000 domains per run, but does not guarantee they are\nunique. On average, 6975 unique domains are expected:\n\n$$ \\mathbb{E} = 12996\\left( 1 - \\left(\\frac{12996-1}{12966}\\right)^{10000} \\right) = 6975 $$\n\nEven with the short waiting time between resolving domains, the malware will need to run a\nlong time to get through the list of domains.\n\n## Reimplementation in Python\n\nThe following Python code shows how the domains are generated:\n\n\n-----\n\n```\nfrom itertools import product\nfrom datetime import datetime\nimport argparse\nfrom collections import namedtuple\nParam = namedtuple('Param', 'mul mod idx')\npool = (\n  \"qeewcaacywemomedekwyuhidontoibeludsocuexvuuftyliaqydhuizuctuiqow\"\n  \"agypetehfubitiaziceblaogolryykosuptaymodisahfiybyxcoleafkudarapu\"\n  \"qoawyluxqagenanyoxcygyqugiutlyvegahepovyigqyqibaeqynyfkiobpeepby\"\n  \"xaciyvusocaripfyoftesaysozureginalifkazaadytwuubzuvoothymivazyyz\"\n  \"hoevmeburedeviihiravygkemywaerdonoyryqloammoseweesuvfopiriboikuz\"\n  \"orruzemuulimyhceukoqiwfexuefgoycwiokitnuneroxepyanbekyixxiuqsias\"\n  \"xoapaxmaohezwoildifaluzihipanizoecxyopguakdudyovhaumunuwsusyenko\"\n  \"atugabiv\"\n)\ndef dga(date):\n  seed = date.strftime(\"%m%Y\")\n  params = [\n    Param(19, 19, 0),\n    Param(19, 19, 1),\n    Param(6, 6, 4),\n    Param(6, 6, 5)\n  ]\n  ranges = []\n  for p in params:\n    s = int(seed[p.idx])\n    lower = p.mul*s\n    upper = lower + p.mod\n    ranges.append(list(range(lower, upper)))\n  for indices in product(*ranges):\n    domain = \"\"\n    for index in indices:\n      domain += pool[index*2:index*2 + 2]\n    domain += \".bazar\"\n    yield domain\nif __name__ == \"__main__\":\n  parser = argparse.ArgumentParser()\n  parser.add_argument(\n    \"-d\", \"--date\", help=\"date used for seeding, e.g., 2020-06-28\",\n    default=datetime.now().strftime('%Y-%m-%d'))\n  args = parser.parse_args()\n  d = datetime.strptime(args.date, \"%Y-%m-%d\")\n  for domain in dga(d):\n    print(domain)\n\n```\n[Here are all the domains for December 2020,](https://johannesbader.ch/blog/next-version-of-the-bazarloader-dga/assets/december-2020.txt) [January 2021,](https://johannesbader.ch/blog/next-version-of-the-bazarloader-dga/assets/january-2021.txt) [February 2021, and](https://johannesbader.ch/blog/next-version-of-the-bazarloader-dga/assets/february-2021.txt) March\n2021.\n\n\n-----\n\n## Characteristics\n\nThe following table summarizes the properties of the new Bazar Loader DGA.\n\n**property** **value**\n\ntype TDD (time-dependent-deterministic)\n\ngeneration scheme arithmetic\n\nseed current date\n\ndomain change frequency every month\n\nunique domains per month 12996\n\nsequence random selection, might pick domains multiple times\n\nwait time between domains 10 seconds\n\ntop level domain `.bazar`\n\nsecond level characters a-z, without j\n\nregex `[a-ik-z]{8}\\.bazar`\n\nsecond level domain length 8\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-16 - Next Version of the Bazar Loader DGA.pdf"
    ],
    "report_names": [
        "2020-12-16 - Next Version of the Bazar Loader DGA.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535820,
    "ts_updated_at": 1743041761,
    "ts_creation_date": 1653685726,
    "ts_modification_date": 1653685726,
    "files": {
        "pdf": "https://archive.orkl.eu/07801e3c388359f844da45cbaacc13bb484787fb.pdf",
        "text": "https://archive.orkl.eu/07801e3c388359f844da45cbaacc13bb484787fb.txt",
        "img": "https://archive.orkl.eu/07801e3c388359f844da45cbaacc13bb484787fb.jpg"
    }
}