{
    "id": "90cfe776-7542-4abf-b41f-f8d460b389c7",
    "created_at": "2023-01-12T14:59:40.058333Z",
    "updated_at": "2025-03-27T02:06:13.443622Z",
    "deleted_at": null,
    "sha1_hash": "82292dde6a973e93b1bd665079c11091c123f195",
    "title": "2016-07-12 - Malware Discovered – SFG- Furtim Malware Analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T05:08:08Z",
    "file_modification_date": "2022-05-28T05:08:08Z",
    "file_size": 1004883,
    "plain_text": "# Malware Discovered – SFG: Furtim Malware Analysis\n\n**sentinelone.com/blogs/sfg-furtims-parent/**\n\nBy Joseph Landry and Udi Shamir\n\n\nJuly 12, 2016\n\n\n**Update, 14-July: There have been a number of stories published since the posting of this blog that have suggested this attack is**\nspecifically targeting SCADA energy management systems. We want to emphasize that we do not have any evidence that this is in fact\nthe case. The focus of our analysis was on the characteristics of the malware, not the attribution or target.\n\nThe Labs team at SentinelOne recently discovered a sophisticated malware campaign specifically targeting at least one energy\ncompany. Upon discovery, the team reverse engineered the code and believes that based on the nature, behavior and sophistication of\nthe malware and the extreme measures it takes to evade detection, it likely points to a nation-state sponsored initiative, potentially\n\ni i ti i E t E\n\n\n-----\n\nThe malware is most likely a dropper tool being used to gain access to carefully targeted network users, which is then used either to\nintroduce the payload, which could either work to extract data or insert the malware to potentially shut down an energy grid. The exploit\naffects all versions of Microsoft Windows and has been developed to bypass traditional antivirus solutions, next-generation firewalls,\n[and even more recent endpoint solutions that use sandboxing techniques to detect advanced malware. (biometric readers are non-](https://www.sentinelone.com/cybersecurity-101/endpoint-security/)\nrelevant to the bypass / detection techniques, the malware will stop executing if it detects the presence of specific biometric vendor\nsoftware).\n\nWe believe the malware was released in May of this year and is still active. It exhibits traits seen in previous nation-state Rootkits, and\nappears to have been designed by multiple developers with high-level skills and access to considerable resources.\n\nWe validated this malware campaign against SentinelOne and confirmed the steps outlined below were detected by our Dynamic\nBehavior Tracking (DBT) engine.\n\n## Malware Synopsis\n\nThis sample was written in a manner to evade static and behavioral detection. Many anti-sandboxing techniques are utilized. Analysts\nrelying solely on sandbox solutions may miss the full functionality of the sample.\n\n**Update: JoeSandbox contacted us and said their sandbox will run this sample.**\n\nTwo known exploits (CVE-2014-4113 and CVE-2015-1701) were found in the sample, as well as one UAC bypass.\n\nThe sample appears to be targeting facilities that not only have software security in place, but physical security as well. ZKTeco\n[(http://www.zkteco.com/) is a global manufacturer of access control systems including facial recognition, fingerprint scanners, and](http://www.zkteco.com/)\nRFID. If the sample is run on a workstation with ZKTeco’s ZKAccess software installed, the process will prematurely terminate. These\nsystems would be heavily scrutinized by their administrators, and an infection on one of these machines would likely not go unnoticed.\n\nTwo hard coded MAC addresses are checked for by the sample. A MAC address is unique 6-byte number that is burned into the chips\nof all network cards. The sample will prematurely terminate if the machine it is running on has one of these two MAC addresses.\n\nUse of low-level API ( Nt* and Rtl* ) and direct system calls ( INT 2Eh and `CALL ntdll!KiFastSystemCall )`\n\n[were used to bypass user-space hooks used by antivirus software and sandboxes. This also demonstrates the expertise of the author.](https://sentinelone.com/blogs/colossal-irony-popular-av-programs-vulnerable-breach/)\nMany of these low-level APIs and system calls are undocumented/under-documented and can change between different versions of\nWindows. To gain an understanding of these functions, one has to be familiar with the Windows Driver Development Kit (DDK), and\nalso reverse-engineered portions of the Windows operating system.\n\nThe use of indirect subroutine calls make manual static analysis nearly impossible, and manual dynamic analysis painful and slow. The\nauthor took special care to keep this sample undetected for as long as possible.\n\nThe main goal of the sample analyzed is to run its final payload after silently removing a number of antivirus products.\n\n## Overview of Execution\n\nThe sample starts by rigorously checking its environment. If in a sandbox or under manual inspection by an analyst, the sample will\nprematurely terminate. If the sample finds specific antivirus software installed, it will carefully enable and disable specific functionality to\nevade behavioral detection.\n\nIn many situations, the sample will distance itself from malicious behaviors by\ninvoking cmd.exe to do its dirty work. For example, modifying sensitive registry values are done by invoking cmd.exe /c reg.exe ….\nUnfortunately for this sample, SentinelOne tracks the full context of processes to determine the root cause of malicious behavior.\n\nZKAccess\n\nFrom this point on, the sample’s goal is to remove any antivirus software before running its final payload. To accomplish this goal, the\nsample must be run as administrator. Two known local privilege escalation exploits are included in the sample (CVE-2014- 4113 and\nCVE-2015-1701), as well as one UAC bypass, which are used to acquire administrator access. As a last resort, the sample will use a\nUAC prompt to try and elevate itself to administrator. Once the sample is running as administrator, it will add the current user to the\nlocal Administrator group, allowing it to maintain administrator access in the future.\n\nThe sample now writes its Native Application binary to disk. Unlike regular application code, this binary can only link to `ntdll.dll . It`\nwill run at a point in the boot-up process where some Windows subsystems are not yet initialized, and therefore can not call into normal\ndlls like `kernel32.dll and` `user32.dll . This Native Application is hidden in an NTFS Alternative Data Stream (ADS) at the`\n\n\n-----\n\npath `C:\\Windows\\Temp:1 . By using ADS, the file will not be visible by normal file browsers, like` `explorer.exe . The Native`\nApplication is registered to run on boot-up altering the values `SetupExecute and` `BootExecute in the registry`\nkey `HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\\\ .`\n\nTo ensure the success of the Native Application, the sample will remove all filter drivers from running after reboot by removing their\nassociated registry entries. Filter drivers are use by anti-virus software to intercept file and network access to run static detection on the\ncontents of the traffic. These drivers are loaded early in the boot process, and could interfere with the execution of the Native\nApplication.\n\nThe system is now forced to reboot, allowing the Native Application to run. The Native Application also has similar checks to tell if it is\nrunning in a sandbox, and will terminate prematurely when one is detected.\n\nThe Native Application’s goal is to remove any anti-virus software that is installed on the system and drop its final payload. By running\nduring the boot process, and after the preperation that was done in the previous stage, the Native Application has full control over the\nsystem. Removing any anti-virus is trivial at this point because the anti-virus software is not running. The Native Binary writes the final\npayload of the sample to disk under the filename `rdpinst.exe and registers it to be run later in the boot process by creating a`\nregistry value in \\Registry\\Machine\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce .\n\n## Architecture\n\nThere is one large structure that is allocated on the heap. This structure contains mostly function pointers to external libraries and\ninternal function pointers. This creates a problem for static analysis. There are many indirect calls (e.g. CALL EAX) obscuring the\nprogram flow for static analysis. This structure is passed as the first parameter to almost every function in the binary.\n\nA large chunk of the .data region is encrypted using RC4. This encrypted region contains the string literals for the sample, creating\nanother problem for static analysis and static detection. Before the process is terminated, this region is re-encrypted, possibly to deter\nan analyst from recovering the unencrypted contents by using memory dumps.\n\nIncluded in this encrypted region are three binary blobs that are also encrypted and compressed: final payload, a Windows Native API\napplication; A DLL with a UAC bypass; and a 64-bit executable an exploit for CVE-2014-4113.\n\n## Reversing Techniques Used\n\nTo reverse the main sample, I developed a python script to patch out the blacklist and NOP out some test code. By placing a breakpoint\non the function that gets called to prematurely terminate the process, we were able to identify checks that failed by inspecting the return\naddress on the call stack.\n\nZeroing out the relocation size in the PE Data Directory also made jumping between IDA and OllyDBG easier because the base\naddress of the executable was not randomized.\n\nNoting the destination address of indirect jumps in IDA comments made reviewing after debugging much simpler.\n\nTo debug the Native Application binary, I patched the PE Optional Header field `Subsystem field from 1 to 2. This changed the`\nsubsystem used by the binary from `Native to` `WindowsGUI . This will let the binary run after bootup is finished, instead of getting this`\nerror message:\n\ndouble clicking on the Native Application\n\n## “Packing”\n\nThe code of the main executable (.text segment) isn’t packed, but a region in the .data section is encrypted using RC4 with the\npassword “dqrChZonUF”. The RC4 implementation looks like a direct copy of the code found in the FreeBSD and XNU kernel:\n\nThe only modification to the BSD RC4 implementation is the pointer to the global struct containing the function pointers to the RC4\nsubroutines.\n\nAfter decrypting this large section, all the string literals are uncovered.\n\n\n-----\n\nimage of rc4 decrypt\n\n\nAlso, there are other regions inside of this decrypted region containing more encrypted blobs, like a Matryoshka doll. These contain a\nNative executable, the UAC bypass DLL, and the 64-bit implementation of the exploit for CVE-2014-4113. Furthermore, the Native\nbinary contains another binary blob, that is the compressed and encrypted final payload.\n\n[Team member, Caleb Fenton, correctly identified the compressed stream format used for these blobs as aPLib.](http://ibsensoftware.com/products_aPLib.html)\n\n\n-----\n\naPLib decompress\n\n\nAlthough RC4 isn’t an esoteric stream cipher, the decision by the author to use such a cipher shows a level of sophistication not seen in\ntypical crimeware.\n\n## Anti-Debug, Anti-Sandbox, Anti-AV\n\nThe sample has an overwhelming number of checks to determine if it is in a sandbox, or if an antivirus application is installed. But why\nwould the author go through so much trouble to evade sandboxes and AV products?\n\nThe strategy used by the author seems to be this:\n\nIf we are running in a virtual machine, sandbox, or under manual inspection by an analyst, encrypt the .data section and terminate\nprematurely.\nIf we are in an environment with Anti-Virus products installed, carefully enable and disable behaviors of the infection to avoid\nbehavioral detection.\n\nThe following is a list of checks the sample performs in the order that they are executed.\n\n### CPUID Check\n\nThis test is the least invasive of all the tests performed. It also would be hard for a virtualization-based sandbox to detect, because the\nCPUID instruction would be run on the physical CPU, and can’t be hooked.By running this test first, it will insure that the sandbox log\nwould not show any evidence of the process trying to inspect its environment. An analyst might dismiss the sample, because it doesn’t\nappear to be trying to detect the sandbox or virtual machine.The x86 instruction CPUID will report back features of the CPU. This\ninstruction is normally used to check what features are supported by the CPU to avoid an “Invalid Instruction” exception before\nexecuting feature specific code. The sample uses this instruction to find artifacts of a virtual machine.When the CPUID instruction is\nexecuted and the register EAX set to 0x80000002, 0x80000003, or 0x80000004, the CPU fills registers EAX, EBX, ECX, and EDX with\nthe “Product Brand String.” If the brand string is found in the sample’s blacklist, the process will prematurely terminate.\n\nStrings check by CPUID where EAX=0x8000000x:\n\n\n-----\n\n```\nCommon KVM processor\nCommon 32-bit KVM\nVirtual CPU\nIntel Celeron_4x0 (Conroe/Merom Class Core 2)\nWestmere E56xx/L56xx/X56xx (Nehalem-C)\nIntel Core 2 Duo P9xxx (Penryn Class Core 2)\nIntel Core i7 9xx (Nehalem Class Core i7)\nIntel Xeon E312xx (Sandy Bridge)\nAMD Opteron 240 (Gen 1 Class Opteron)\nAMD Opteron 22xx (Gen 2 Class Opteron)\nAMD Opteron 23xx (Gen 3 Class Opteron)\nAMD Opteron 62xx class CPU\nIntel CPU version\n\n```\nMany of these CPU strings look legitimate, but are the exact strings used by KVM and QEMU.\n```\n# kvm -cpu ?\nx86      qemu64 QEMU Virtual CPU version 2.4.0\nx86      phenom AMD Phenom(tm) 9550 Quad-Core Processor\nx86     core2duo Intel(R) Core(TM)2 Duo CPU   T7700 @ 2.40GHz\nx86      kvm64 Common KVM processor\nx86      qemu32 QEMU Virtual CPU version 2.4.0\nx86      kvm32 Common 32-bit KVM processor\nx86     coreduo Genuine Intel(R) CPU      T2600 @ 2.16GHz\nx86       486\nx86     pentium\nx86     pentium2\nx86     pentium3\nx86      athlon QEMU Virtual CPU version 2.4.0\nx86       n270 Intel(R) Atom(TM) CPU N270  @ 1.60GHz\nx86      Conroe Intel Celeron_4x0 (Conroe/Merom Class Core 2)\nx86      Penryn Intel Core 2 Duo P9xxx (Penryn Class Core 2)\nx86     Nehalem Intel Core i7 9xx (Nehalem Class Core i7)\nx86     Westmere Westmere E56xx/L56xx/X56xx (Nehalem-C)\nx86   SandyBridge Intel Xeon E312xx (Sandy Bridge)\nx86    IvyBridge Intel Xeon E3-12xx v2 (Ivy Bridge)\nx86  Haswell-noTSX Intel Core Processor (Haswell, no TSX)\nx86     Haswell Intel Core Processor (Haswell)\nx86 Broadwell-noTSX Intel Core Processor (Broadwell, no TSX)\nx86    Broadwell Intel Core Processor (Broadwell)\nx86    Opteron_G1 AMD Opteron 240 (Gen 1 Class Opteron)\nx86    Opteron_G2 AMD Opteron 22xx (Gen 2 Class Opteron)\nx86    Opteron_G3 AMD Opteron 23xx (Gen 3 Class Opteron)\nx86    Opteron_G4 AMD Opteron 62xx class CPU\nx86    Opteron_G5 AMD Opteron 63xx class CPU\nx86       host KVM processor with all supported host features (only available in KVM mode)\n\n```\nIf the check passes, the string is stored in the global struct for later testing.\n\nFurthermore, the CPUID instruction can be executed with the register EAX set to 0x40000000. This will return a string that can be set\nby a hypervisor.\n\nBlacklist for CPUID where EAX=0x40000000:\n```\nVMwareVMware\nXenVMMXenVMM\nKVMKVMKVM\nprl hyperv\nMicrosoft Hv\n\n```\nMore about the CPUID can be found in the Intel Instruction Set Reference starting on page 3179: http://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-instruction-setreference-manual-325383.pdf\n\n### Hostname Check\n\nThe sample contains a blacklist of hostnames. In the event the result of `GetComputerNameW() is found in the blacklist, again, the`\nprocess terminates.\n```\nbrbrb-d8fb22af1\njonathan-c561e0\navreview1-VMXP\nvwinxp-maltest\navreview-VMSunbox\ninfected-system\n\n```\n\n-----\n\nGoogling these strings brings results that suggest that they are hostnames for sandboxes and honeypots. These hostnames are also\nused in other malware samples as hostname blacklists.\n\n### Filename Check\n\nBy a call to `GetModuleFileNameW() the sample check its filename to see if it is in a location commonly used by sandboxes:`\n\nFull string case insensitive compare:\n```\nC:\\xxx\\sample.exe\nC:\\sample.exe\nC:\\Shared\\dum._vxe\nC:\\SniferFiles\\sample.exe\nC:\\virus\\virus.exe\nC:\\virus.exe\nc:\\sampel.exe\nC:\\setup.exe\nC:\\runme.exe\nc:\\VMRun\\Zample.exe\nc:\\FILE.EXE\nC:\\run\\temp.exe\nc:\\taskrun\\samples\\rtktst.exe.exe\nc:\\artifact.exe\nC:\\manual\\sunbox.exe\nC:\\1.exe\n\n```\nString find:\n```\nmalware.exe\n\\virus\\\nadmin\\downloads\\samp1e_\nsample_execution\nmlwr_smpl.exe\n\n```\nAny file in this format where ‘x’ is any character.\n```\n'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\\\\xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxxxxx'\n\n```\n[This format apears to be a GUID string. There must be some sandboxing technology that uses this format that the author was aware of.](https://en.wikipedia.org/wiki/Globally_unique_identifier)\n\nFinally, it checks if a ‘Z:\\’ drive is present, then checks for the file ‘Z:\\VxStream’. This will detect if it is being run in the VxStream\nSandbox\n\n### Look for DLLs associated with function hooking\n\nUser-space hooking is a technique used by anti-virus to detect what could be considered malicious behavior. The technique is also\nused by sandboxes to record a log of runtime behaviors of a process. The most common way of hooking a process is to inject a DLL\ninto the process. This hooking DLL will patch system DLLs like kernel32.dll and ntdll.dll in memory. When the process being hooked\nmakes a call into these system DLLs, it will be redirected to a “detour” function inside of the injected hooking dll. If the function call is\ndetermined to be benign, the control flow is allowed to continue into the system DLLs.\n\nAnti-Virus products that utilize this technique tend to prefer hooking system DLLs like `kernel32.dll over` `ntdll.dll . This is`\nbecause hooking `ntdll.dll is less reliable and requires more labor to write. The interface to` `ntdll.dll could change on the whim`\nof Microsoft, and isn’t documented well. `kernel32.dll has a more predictable and constant interface and is well documented on`\nMSDN.\n\nA malicious program wanting to avoid detection at runtime by a user-space hook might have some success calling directly\ninto `ntdll.dll instead of` `kernel32.dll because the underlying` `ntdll.dll functions may not be hooked.`\n\nThe sample will look for injected DLLs associated with user-space hooks in its process space by making a call\nto `ntdll!LdrGetDllHandle() instead of the more common` `kernel32!GetModuleHandle() . By calling directly into the ntdll`\nimplementation, hooks on the kernel32 layer can be avoided. If a DLL associated with hooking is discovered, the programs behavior\ncan be altered to specifically avoid detection by these products.\n\nIf a DLL is found, the result is stored so that future malicious functionality can be suppressed, or specific techniques to avoid detection\ncan be utilized.\n\nThe hooking DLL black-list:\n\n**DLL File Name** **Vendor**\n\n\n-----\n\n**DLL File Name** **Vendor**\n\navcuf32.dll BitDefender\n\nBgAgent.dll BullGuard\n\nguard32.dll COMODO\n\nwl_hook.dll Agnitum\n\nQOEHook.dll Qurb\n\na2hooks32.dll Emsisoft\n\n### Looking for Sandbox Artifacts on the File System\n\nIf any of this files or directories are found, the process terminates prematurely. These files appear to be associated with sandbox\nsoftware.\n```\nC:\\agent\\agent.pyw\nC:\\sandbox\\starter.exe\nc:\\ipf\\BDCore_U.dll\nC:\\cwsandbox_manager\nC:\\cwsandbox\nC:\\Stuff\\odbg110\nC:\\gfisandbox\nC:\\Virus Analysis\nC:\\iDEFENSE\\SysAnalyzer\nc:\\gnu\\bin\nC:\\SandCastle\\tools\nC:\\cuckoo\\dll\nC:\\MDS\\WinDump.exe\nC:\\tsl\\Raptorclient.exe\nC:\\guest_tools\\start.bat\nC:\\tools\\aswsnx\\snxcmd.exe\nC:\\Winap\\ckmon.pyw\nc:\\tools\\decodezeus\nc:\\tools\\aswsnx\nC:\\sandbox\\starter.exe\nC:\\Kit\\procexp.exe\nc:\\tracer\\mdare32_0.sys\nC:\\tool\\malmon\nC:\\Samples\\102114\\Completed\nc:\\vmremote\\VmRemoteGuest.exe\nd:\\sandbox_svc.exe\n\n### Checking Number of CPU Cores\n\n```\nRemember how the CPUID “Product Brand String” was stored for later use? Here’s why. If the CPU should have more than 1 core, but\nthe operating system only reports 1 core, it’s likely running inside a virtual machine.\n\nA call is made to `RtlGetNativeSystemInformation(SystemBasicInformation, ...) . This call will fill the contents of a` `struct`\n```\nSYSTEM\\_BASIC\\_INFORMATION struct. The sample checks the field \\_SYSTEM\\_BASIC\\_INFORMATION.NumberOfProcessors and if\n\n```\nthe value is 1 and the CPU Product Brand String reported should have more than one core, the process is terminated.\n\nCPU brand strings that are checked:\n```\n'Intel(R) Core(TM) i7'\n'Intel(R) Core(TM) i5'\n'Intel(R) Core(TM) i3'\n'Intel(R) Core(TM)2 Duo CPU'\n\n```\nNtQuerySystemInformation() _SYSTEM_INFORMATION_CLASS enum in ReactOS\nsource `RtlGetNativeSystemInformation() seems to be similar to` `NtQuerySystemInformation() documented on MSDN here.`\n\nI found an unofficial source of the `struct SYSTEM_BASIC_INFORMATION here:` [http://masm32.com/board/index.php?topic=3400.0](http://masm32.com/board/index.php?topic=3400.0)\n\n[ReactOS struct _SYSTEM_BASIC_INFORMATION](https://github.com/reactos/reactos/blob/b470751018d5658dd3c24c5050bd711b5776800b/reactos/sdk/include/psdk/winternl.h#L484)\n\n### Yet Another DLL hooking blacklist\n\nThese DLLs are associated with software used to manually analyze samples.\n\n\n-----\n\n```\ntracer.dll\nSbieDll.dll\nAPIOverride.dll\nNtHookEngine.dll\napi_log.dll\nLOG_API.DLL\nLOG_API32.DLL\n\n```\n```\nntdll!LdrGetDllHandle()\n\n```\n\nIf any of these DLLs are loaded, the process terminates.\n\n### Kernel Driver Check\n\n[ReactOS RtlGetNativeSystemInformation is just NtQuerySystemInformation](https://github.com/reactos/reactos/blob/0d677ac9e42ccad043debc212ed21d26e6f6af2b/reactos/dll/ntdll/def/ntdll.spec#L668)\n\n[ReactOS SystemModuleInformation](https://github.com/reactos/reactos/blob/0d677ac9e42ccad043debc212ed21d26e6f6af2b/reactos/drivers/filesystems/udfs/Include/ntddk_ex.h#L22)\n\nA call to `ntdll!RtlGetNativeSystemInformation(SystemModuleInformation, ...) is made. This returns a list of all loaded`\nkernel drivers.\n\nEach kernel module is compared to a blacklist that is organized by vendor.\n\nIf any of these drivers are found, the process will terminate.\n\n???\n\ntaskrun\\bruta\\kbruta.sys\ntaskrun\\bruta\\TBM.sys\nSandbox, VM, and SysInternals drivers\n\nvmx_svga.sys\nvmmouse.sys\nxennet.sys\nCaptureProcessMonitor.sys\nCaptureRegistryMonitor.sys\nCaptureFileMonitor.sys\nCWSandboxWatchdogDri (sic)\nVBoxVideo.sys\n\nIf any of the following drivers are found, it is noted in the global struct, for later evasion techniques.\n\n[Quick Heal (Indian)](http://www.quickheal.com/)\n\nbdsnm.sys\nbdsflt.sys\nggc.sys\ncatflt.sys\nwsnf.sys\nllio.sys\nmscank.sys\nEMLTDI.SYS\n[ZoneAlarm](http://www.zonealarm.com/)\n\nvsdatant.sys\n[Qihoo 360 (Chinese)](https://www.360totalsecurity.com/)\n\n360Box.sys\n360Box64.sys\n360Camera.sys\n360Camera64.sys\n360SelfProtection.sys\n360AntiHacker.sys\n360AntiHacker64.sys\n360AvFlt.sys\n[PC Tools (now part of Norton Security)](http://www.pctools.com/)\n\npctNdis.sys\npctNdisLW64.sys\n\n\n-----\n\n[Norton 360](https://us.norton.com/360)\n\n360AvFlt.sys\n360FsFlt.sys\n[K7 Computing (Indian)](https://www.k7computing.com/)\n\nK7Sentry.sys\nK7FWFilt.sys\nK7TdiHlp.sys\n[Trust Port (Czech Republic)](http://www.trustport.com/)\n\ntpsec.sys\n[Privacyware (US)](http://www.privacyware.com/)\n\npwipf6.sys\n[MicroWorld escan (US, India)](http://www.escanav.com/)\n\nmwfsmflt.sys\nProcObsrvesx.sys\nbdfsfltr.sys\neconceal.sys\n[Filseclab (Chinese)](http://www.filseclab.com/)\n\nffsmon.sys\nfildds.sys\nfilmfd.sys\nfilppd.sys\n[Kaspersky](http://kaspersky.com/)\n\nkl1.sys\nklif.sys\nkltdi.sys\nkneps.sys\nklkbdflt.sys\nklmouflt.sys\n[G Data (German)](https://www.gdata-software.com/)\n\nGDBehave.sys\nGDNdisIc.sys\ngdwfpcd64.sys\ngdwfpcd32.sys\n[Arcabit (Polish)](https://www.arcabit.pl/)\n\nABFLT.sys\n[Avast (Czech Republic)](https://www.avast.com/)\n\naswMonFlt.sys\naswRvrt.sys\naswRdr2.sys\naswVmm.sys\naswNdisFlt.sys\naswSnx.sys\naswSP.sys\naswStm.sys\n[Avira (German)](https://www.avira.com/)\n\navnetflt.sys\navkmgr.sys\navipbb.sys\navgntflt.sys\n[ESET (Slovakia)](https://www.eset.com/)\n\nEpfwLWF.sys\nepfwwfp.sys\neamonm.sys\nehdrv.sys\nepfw.sys\neelam.sys\n[Baidu (Chinese)](http://antivirus.baidu.com/)\n\nBfilter.sys\nBfmon.sys\nBhbase.sys\n\n\n-----\n\n[AVG (Czech Republic)](http://www.avg.com/)\n\navgdiskx.sys\navgidsdriverlx.sys\navgtdix.sys\navgunivx.sys\n\n### Anti-Process\n\nThis will only execute if something was found in the kernel module check. (???)\n\nThe process list is enumerated by calling RtlGetNativeSystemInformation(5)\n\n[ReactOS 5 == proc info](https://github.com/reactos/reactos/blob/0d677ac9e42ccad043debc212ed21d26e6f6af2b/reactos/drivers/filesystems/udfs/Include/ntddk_ex.h#L16)\n\n[MSDN SYSTEM_PROCESS_INFORMATION](https://msdn.microsoft.com/en-us/library/ms725506.aspx)\n\nIf a process with this filename is found, its process id is recorded, and later terminated.\n\nThis is where the author prepares an attack on the analyst’s psyche. So far, the process only detects sandbox, VM, and antivirus, but\nthis list of tools are usually run manually by an analyst. By detecting their presence but not immediately terminating them, instead\ndelaying the termination until a later part of the process, can give some analyst nightmares.\n\napispy.exe\nautoruns.exe\nautorunsc.exe\ndumpcap.exe\nemul.exe\nfortitracer.exe\nhookanaapp.exe\nhookexplorer.exe\nidag.exe\nidaq.exe\nimportrec.exe\nimul.exe\njoeboxcontrol.exe\njoeboxserver.exe\nmulti_pot.exe\nollydbg.exe\npeid.exe\npetools.exe\nproc_analyzer.exe\nprocexp.exe\nprocmon.exe\nregmon.exe\nscktool.exe\nsniff_hit.exe\nsysanalyzer.exe\nvmsrvc.exe\nvmtoolsd.exe\nvmusrvc.exe\nvmwaretray.exe\n\nFor each process, a call to `QueryFullProcessImageNameW() is made and compared against a second blacklist. If any string in the`\nblacklist occurs in the full image name, the process terminates.\n\nTHESE AREN’T SANDBOXES OR A/V, ARE THEY????\n\n\\oracle\\product\\\n\\OraHome_1\\perl\\\n\\dbhome_1\\perl\\bin\n\\ZKTeco\\ZKAccess\\\n\\oracle\\FRHome_1\\perl\\\n\\Oracle\\Middleware\\\n\n\n-----\n\n### Is File Name [hash].exe Check\n\nIn the Anti-Virus industry, it is extreamly common to rename a sample’s filename to its [hash value. This is done to easily identify a](https://www.sentinelone.com/blog/what-is-hash-how-does-it-work/)\nsample, and to store it with a unique filename. Typical hash algorithms that are used are MD5, SHA-1, and SHA-256.\n\nThis sample will read itself off of the disk, then calculate its checksum. Then it will see if the hex-string of the checksum is found in its\nfilename.\n\n\nCheck filename contains hex hash\n\n\n### Is VMware Tools Installed Check\n\nNext, the sample checks if these two directories exist. If either exist, the process is terminated.\n\nC:\\Program Files\\VMware\\VMware Tools\nC:\\Program Files (x86)\\VMware\\VMware Tools\n\n### Hard Disk Vendor Check\n\nThe children of these two registry keys are enumerated:\n\n\n-----\n\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\IDE\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\SCSI\n\nThe values are check against a blacklist containing virtualized hard disk vendors.\n\nQEMU_\nVMware\nVen_Red_Hat&Prod_VirtIO\nDiskVBOX\nDiskVirtual\n\nIf a value is found in the blacklist, the process is terminated.\n\n### Misc Hardware Vendors and BIOS Checks\n\nThese hardware specific registry keys are check. If they exist, the process terminates.\n\n\\Registry\\Machine\\HARDWARE\\ACPI\\DSDT\\VBOX__\\VBOXBIOS\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\ACPI\\Hyper_V_Gen_Counter_V1\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\ACPI\\XEN0000\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\XENBUS\\CLASS_VBD&REV_02\n\nIn the same function, `\\Registry\\Machine\\HARDWARE\\DESCRIPTION\\System\\ is queried and checked against this blacklist:`\n\nSystemBiosVersion\n\n‘BOCHS – 1’\n‘VBOX – 1’\n‘PRLS – 1’\nVideoBiosVersion\n\n‘VirtualBox’\n\nIf any of these registry keys match, the process is terminated.\n\n### Anti Network Interface Card (NIC) Check\n\nThis check is skipped if kernel modules associated with “Privacyware” where detected. I’m assuming “Privacyware” detects the API\ncalls in this check as malicious.\n\nThis function check the NICs that are installed, and calls to `IPHLPAPI!GetAdaptersInfo()`\n\nMeeting these condition will cause a premature termination.\n\nRealtek RTL8139 Family PCI Fast Ethernet NIC\n\nalso username is ‘antonie’\nalso ‘c:\\downloads\\’ exists\nRealtek RTL8139C+ Fast Ethernet NIC\n\nalso username is ‘Antony’\nalso ‘c:\\downloads\\’ exists\n\nThese network cards will get terminated out-right:\n\nVMware Accelerated AMD PCNet Adapter\nMicrosoft Virtual Machine Bus Network Adapter\nMicrosoft Hyper-V Network Adapter\nAdaptador de red de bus de m?quina virtual de Microsoft\n\nIf the network card is NOT one of these, it will check the MAC address:\n\nVMware Virtual Ethernet Adapter for VMnet8\nVMware Virtual Ethernet Adapter for VMnet1\nVirtualBox Host-Only Ethernet Adapter\n\nThese MAC addresses will result in a premature termination:\n\n**MAC address** **OUI Information** **Notes**\n\n\n-----\n\n**MAC address** **OUI Information** **Notes**\n\n`00:01:02:03:04:xx` 3COM defunt, obvious bogus mac address\n\n`00:03:FF:xx:xx:xx` Microsoft Corporation doesn’t make physical hardware?\n\n`00:0C:29:xx:xx:xx` VMware, Inc.\n\n`08:00:27:xx:xx:xx` Cadmus Computer Systems [VirtualBox](http://comments.gmane.org/gmane.comp.emulators.virtualbox.devel/2199)\n\n`00:07:e9:e4:ce:4d` Intel 0 results on google\n\n`00:30:18:ab:d7:f2` Jetway Information Co., Ltd. 0 results on google\n\n`00:ff:f2:f8:30:xx` Dell?? VirtualBox??\n\n`00:50:56:xx:xx:xx` VMware, Inc.\n\n`52:54:00:12:34:56` Realtek copypasta QEMU startup script?\n\n`00:1c:42:xx:xx:xx` Parallels, Inc. VMware product\n\n`00:15:5d:xx:xx:xx` Microsoft Corporation\n\n`00:1d:d8:xx:xx:xx` Microsoft Corporation\n\nI would like to know who owns the “00:07:e9:e4:ce:4d” and “00:30:18:ab:d7:f2”. If they are burnt onto a physical device, it’s either a\ndevelopment machine, or a targeted machine to be specifically avoided.\n\n### Window Title Check\n\nPairs of window class names and titles are check for, and if one is found, the samples’s process is terminated prematurely. These tools\nare used by analysts and some are used by sandboxes.\n\n**Window Class** **Window Title**\n\nPROCEXPL sysinternals\n\nPROCMON_WINDOW_CLASS sysinternals\n\nAutoruns sysinternals\n\nTCPViewClass sysinternals\n\n0 TCPView – Sysinternals: www.sysinternals.com\n\n0 File Monitor – Sysinternals: www.sysinternals.com\n\n0 Registry Monitor – Sysinternals: www.sysinternals.com\n\n0 Process Monitor – Sysinternals: www.sysinternals.com\n\ngdkWindowToplevel Wireshark\n\nAPI_TRACE_MAIN 0\n\n0 Wget [100%%] http://tristan.ssdcorp.net/guid\n\n0 C:\\Program Files\\Wireshark\\dumpcap.exe\n\n0 C:\\wireshark\\dumpcap.exe\n\n0 C:\\SandCastle\\tools\\FakeServer.exe\n\n0 C:\\Python27\\python.exe\n\n0 start.bat – C:\\Manual\\auto.bat\n\n0 Fortinet Sunbox\n\n0 PEiD v0.95\n\n0 Total Commander 7.0 – Ahnlab Inc.\n\n\n-----\n\n**Window Class** **Window Title**\n\n0 Total Commander 6.53 – GRISOFT, s.r.o.\n\n0 Total Commander 7.56a – Avira Soft\n\n0 Total Commander 7.56a – ROKURA SRL\n\n0 C:\\strawberry\\perl\\bin\\perl.exe\n\nThunderRT6FormDC SysAnalyzer\n\nTfrmMain All-Seeing Eye\n\nAfx:400000:b:10011:6:350167 Malicious Code Monitor v1.7.6 For NT(x86) – ([email protected])\n\nTApplication Mouse Move – by RJL Software, Inc.\n\nSmartSniff SmartSniff\n\nConsoleWindowClass VxStream Kernel Service Manager\n\n**Registry Key** **Notes**\n\n\\Registry\\Machine\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Iris Network Traffic Analyzer\n\n\\Registry\\Machine\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\InstallWatch Pro 2.5\n\n\\Registry\\Machine\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\SysAnalyzer_is1\n\n\n\\Registry\\Machine\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall{13BE68B1-7498-48AB-9D22AD3AB6532531}\n\n\\Registry\\Machine\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Oracle VM VirtualBox Guest Additions\n\n\\Registry\\Machine\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Oracle VM VirtualBox\nGuest Additions\n\n\nAPI Monitor v2\nAlpha\n\n\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\PCI\\VEN_80EE&DEV_BEEF&SUBSYS_00000000&REV_00 VirtualBox\nGraphics Device\nDrivers\n\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\PCI\\VEN_80EE&DEV_CAFE&SUBSYS_00000000&REV_00 VirtualBox Guest\nService Device\nDrivers\n\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\PCI\\VEN_5333&DEV_8811&SUBSYS_00000000&REV_00 S3 Video Card\n(used by virtual\nmachines)\n\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\PCI\\VEN_1AB8&DEV_4005&SUBSYS_04001AB8&REV_00 Parallels Display\nWDDM Device\nDrivers\n\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\PCI\\VEN_1AB8&DEV_4000&SUBSYS_04001AB8&REV_00 Parallels Tool\nDevice Drivers\n\n\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Enum\\PCI\\VEN_1AB8&DEV_4006&SUBSYS_04061AB8&REV_00 Parallels Memory\nController\n\n\n\\Registry\\Machine\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall{25AD16E5-F48B-4455-83D7849D600475A4}\n\n\\Registry\\Machine\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Iris Network Traffic\nAnalyzer\n\n\\Registry\\Machine\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\SysAnalyzer_is1\n\n\\Registry\\Machine\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\InstallWatch Pro 2.5\n\n\\Registry\\Machine\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall{13BE68B1-749848AB-9D22-AD3AB6532531}\n\n\nWinalysis\nWindowexeAllkiller\n?\n\nAPI Monitor v2\nAlpha\n\n\n-----\n\n**Registry Key** **Notes**\n\n\n\\Registry\\Machine\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall{25AD16E5-F48B4455-83D7-849D600475A4}\n\n### VMXh VMWare Check\n\n\nWinalysis\nWindowexeAllkiller\n?\n\n\nThe sample checks for the presence of VMware, by trying to execute a Intel `IN instruction with EAX set to the value ‘VMXh’.`\nThe `IN instruction is a privileged instruction, and outside of the VMware guest, would result in a General Protection Fault exception.`\nBut inside a VMWare guest, the fault is not generated. VMWare uses this as a way for its guest software to communicate to the host. It\n[is documented here.](https://sites.google.com/site/chitchatvmback/backdoor)\n\n[The specific technique to detect VMWare is here.](https://www.aldeid.com/wiki/VMXh-Magic-Value)\n\nThis is how the sample implements the check:\n\nVMXh\n\nBecause this portion must be written in assembly, I assume the NOPs are to thwart any static detection on the opcodes.\n\n### Direct3D Video Card Check\n\nUsing the Direct3D interface, the sample is able to enumerate information about the installed video adapters. If the video cards are\nvendors are in the blacklist, the process prematurely terminates.\n\nVendor Blacklist:\n\n**VendorID** **Vendor Name** **Notes**\n\n0x15ad VMWare Inc.\n\n0x80ee Oracle Corp. Virtual Box\n\n0x1013 Cirrus Logic Bochs and QEMU\n\nVendor Whitelist:\n\n**VendorID** **Vendor Name**\n\n0x8086 Intel\n\n0x10de Nvidia\n\n0x1002 AMD\n\nNow, because there is a whitelist and a blacklist, there exists a possibility that the device was not in either list. In the event of this case,\nthe tie is settled by calling `GetCursorPosition() . If there are 15 mouse movements, then the sample assumes that it is not in a`\nsandbox, and continues execution. If there isn’t 15 mouse movements, the sample just blocks, waiting for the movements to occur.\nDuring this waiting period, the .data section is re-encrypted. If the sample where in a sandbox, it would be stuck in this loop, waiting.\nWhen the sandbox times-out, it might dump the contents of memory. By re-encrypting the .data section, it will be encrypted in the data\ndump.\n\nA common feature of sandboxes is a “mouse mover.” The mouse mouse mover will make an application think there is a user on the\nworkspace by moving the mouse cursor around.\n\nThe sample also utilizes direct system calls to make the call to `GetCursorPosition() . This technique will bypass any user-space`\nhooks that might try to move the mouse automatically.\n\nAvoiding userspace hooks by doing manual syscall\n\n## Native Application Binary\n\nThe beginning of this binary has many anti-VM and anti-sandboxing techniques. just like the previous binary. It also allocates a large\nstruct containing function pointers like the previous binary.\n\n\n-----\n\nThis portion of the sample is encrypted and compressed in the .data segment. As mentioned before, it written to disk in a NTFS ADS\nand at boot time before all the windows subsystems are loaded. If you have ever upgraded to windows 2000, you will remember that\nthe installation could upgrade the filesystem from FAT 32 to NTFS. This portion of the sample runs at the same point as the file system\nupgrade code would run.\n\n[An example project using this technique can be found on codeproject.com](http://www.codeproject.com/KB/threads/NativeThreadInjection.aspx?fid=1540562&df=90&mpp=25&noise=3&sort=Position&view=Quick&select=3038600%20target=)\n\nThe Native binary is written in the same style as the parent. A large struct is allocated on the heap that stores function pointers. It also\nuses RC4 to encrypt its string literals, and contains the final payload compressed using aplib.\n\nThe goal of this portion of the sample is to remove a large number of anti-virus software. It will also modify the `host used by the DNS`\nclient. There are many records for anti-virus update servers that get set to `0.0.0.0, effectively stoping any view anti-virus installed`\nfrom being able to update its definitions.\n\nhostfile\n\nIt finishes by dropping the final payload to `%SystemRoot%\\rdpinst.exe and ensuring that it runs later in boot-up by setting a registry`\nvalue in \\Registry\\Machine\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce .\n\n## Final Payload\n\nThe payload shares some similarities with the other binaries, but unlike the past two, it doesn’t allocate a large struct and fill it with\nfunction pointers.\n\nThe final payload collects recon from the infected machine and reports back to its C2 server over HTTP.\n\npcap showing http connection\n\nOne unique feature of all the traffic collected is that the HTTP host field is always `nullptr .`\n\n## Sample Information\n\n**Sha-256: 766e49811c0bb7cce217e72e73a6aa866c15de0ba11d7dda3bd7e9ec33ed6963**\n\n- `638d549a24bb0a28e462c70880bf3f979f137cc6`: Main Sample\n\n- `ce0633d8be65202870e7b916e7bec5a0218cbbbb`: Packed Native API Application binary\n\n- 14598af84ee2dbd88d3fff0b60aba829a412dfbe3`: Packed rdpinst.exe (payload)\n\n- `643b295ee6985251d771b7962f2b2fc69e36f5c2`: Packed UAC bypass dll\n\n- `c803eb5e8a4a4e31e8168557d82ff54d68f3832d`: Packed 64-bit CVE-2014-4113 exploit\n[If you would like to learn more about this specific attack and how you can prevent it, contact us and we’d be happy to advise on a one-](https://sentinelone.com/contact/)\nto-one basis.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-07-12 - Malware Discovered – SFG- Furtim Malware Analysis.pdf"
    ],
    "report_names": [
        "2016-07-12 - Malware Discovered – SFG- Furtim Malware Analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "1a76ed30-4daf-4817-98ae-87c667364464",
            "created_at": "2022-10-25T16:47:55.891029Z",
            "updated_at": "2025-03-27T02:05:17.408867Z",
            "deleted_at": null,
            "main_name": "IRON LIBERTY",
            "aliases": [
                "ATK6 ",
                "BROMINE ",
                "CASTLE ",
                "Crouching Yeti ",
                "DYMALLOY ",
                "Dragonfly ",
                "Energetic Bear / Berserk Bear ",
                "Ghost Blizzard ",
                "TEMP.Isotope ",
                "TG-4192 ",
                "ALLANITE "
            ],
            "source_name": "Secureworks:IRON LIBERTY",
            "tools": [
                " Ddex Loader",
                " Havex",
                " Karagany",
                " Loek",
                " MCMD",
                " Sysmain",
                " xfrost",
                "ClientX"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535580,
    "ts_updated_at": 1743041173,
    "ts_creation_date": 1653714488,
    "ts_modification_date": 1653714488,
    "files": {
        "pdf": "https://archive.orkl.eu/82292dde6a973e93b1bd665079c11091c123f195.pdf",
        "text": "https://archive.orkl.eu/82292dde6a973e93b1bd665079c11091c123f195.txt",
        "img": "https://archive.orkl.eu/82292dde6a973e93b1bd665079c11091c123f195.jpg"
    }
}