{
    "id": "0c24b81d-0079-4807-b827-7498ab63d1ae",
    "created_at": "2023-03-03T02:06:34.829966Z",
    "updated_at": "2025-03-27T02:17:15.064994Z",
    "deleted_at": null,
    "sha1_hash": "faacee55f39a56594cc8b12f4a197e226193ee2d",
    "title": "2023-02-17 - Earth Kitsune Delivers New WhiskerSpy Backdoor via Watering Hole Attack",
    "authors": "",
    "file_creation_date": "2023-03-01T09:36:30Z",
    "file_modification_date": "2023-03-01T09:36:30Z",
    "file_size": 1656245,
    "plain_text": "# Earth Kitsune Delivers New WhiskerSpy Backdoor via Watering Hole Attack\n\n**[trendmicro.com/en_us/research/23/b/earth-kitsune-delivers-new-whiskerspy-backdoor.html](https://www.trendmicro.com/en_us/research/23/b/earth-kitsune-delivers-new-whiskerspy-backdoor.html)**\n\nFebruary 17, 2023\n\nAPT & Targeted Attacks\n\nWe discovered a new backdoor which we have attributed to the advanced persistent threat\nactor known as Earth Kitsune, which we have covered before. Since 2019, Earth Kitsune has\nbeen distributing variants of self-developed backdoors to targets, primarily individuals who\nare interested in North Korea.\n\nBy: Joseph C Chen, Jaromir Horejsi\nFebruary 17, 2023\nRead time: ( words)\n\n## Introduction\n\nWe discovered a new backdoor which we have attributed to the advanced persistent threat\nactor known as Earth Kitsune, which we have covered before. Since 2019, Earth Kitsune has\nbeen distributing variants of self-developed backdoors to targets, primarily individuals who\nare interested in North Korea. In many of the cases, we have investigated in the past, the\nthreat actor used watering hole tactics by compromising websites related to North Korea and\n\n\n-----\n\ninjecting browser exploits into them. In the latest activity we analyze here, Earth Kitsune\nused a similar tactic but instead of using browser exploits, employed social engineering\ninstead.\n\nAt the end of 2022, we discovered that the website of a pro-North Korean organization was\ncompromised and modified to distribute malware. When a targeted visitor tries to watch\nvideos on the website, a malicious script injected by the attacker displays a message prompt\nnotifying the victims with a video codec error to entice them to download and install a\ntrojanized codec installer. The installer was patched to load a previously unseen backdoor,\nthat we dubbed “WhiskerSpy.” In addition, we also found the threat actor adopting an\ninteresting persistence technique that abuses Google Chrome’s native messaging host.\n\nFigure 1. The WhiskerSpy infection chain\nIn this blog post, we are going to reveal the infection chain and technical details of the\nWhiskerSpy backdoor employed by Earth Kitsune.\n\n## Delivery analysis\n\nAt the end of 2022, we noticed that a pro-North Korean website had a malicious script\ninjected in their video pages. The script showed a popup window with a fake error message,\ndesigned to entice victims to install a malicious package disguised as an Advanced Video\nCodec - AVC1.\n\n\n-----\n\nFigure 2. Social engineering attack prompt on a compromised pro-North Korean website\nThe webpages were configured to deliver the malicious script only to visitors from a list of\ntargeted IP addresses (visitors that did not have these IP addresses would not receive the\nmalicious payload). This configuration makes the attack difficult to discover. Fortunately, we\nmanaged to find a text file on the threat actor’s server containing a regular expression\nmatching the targeted IP addresses. These include:\n\n1. An IP address subnet located in Shenyang, China\n2. A specific IP address located in Nagoya, Japan\n3. An IP address subnet located in Brazil\n\nThe IP addresses in Shenyang and Nagoya are likely to be their real targets. However, we\nfound the targeted IP addresses in Brazil mostly belonged to a commercial VPN service. We\nbelieve that the threat actor used this VPN service to test the deployment of their watering\nhole attacks. It also provided us with an opportunity to verify the watering hole attack by\nusing the same VPN service to successfully receive the malicious script.\n\nFigure 3. A comparison of the webpage content between the original page (left) and the page\nwith the injected script (right)\nThe website loads a malicious JavaScript (popup.js) with the following redirection code:\n\n\n-----\n\nFigure 4. Embedded JavaScript redirecting to a malicious installer download\n\n## The patched installer\n\n[The installer file is an MSI installer that wraps another](https://en.wikipedia.org/wiki/Windows_Installer) [NSIS installer. The threat actor](https://nsis.sourceforge.io/Download)\nabused a legitimate installer (windows.10.codec.pack.v2.1.8.setup.exe –\ne82e1fb775a0181686ad0d345455451c87033cafde3bd84512b6e617ace3338e) and patched\nit to include malicious shellcode. The patch includes an increased number of sections, from 5\nto 6 (red brackets in Figure 5) and increased image size to create extra room for the\nmalicious shellcode (green brackets in Figure 5).\n\nFigure 5. Original\n\n(above) and patched (below) installer. Sizes for certain parameters are increased and one\nmore section is added in the patched version\n\n\n-----\n\nFigure 6. Newly added\n\n.odata section in the patched installer\nThe entry point of the patched installer is changed to immediately jump to the shellcode. The\nshellcode is encrypted with a simple key (XOR 0x01).\n\nFigure 7. The\n\nentry point of the patched installer jumps into the code in the .odata section\nAfter decryption, the shellcode runs several PowerShell commands to download additional\nstages of malware. These files are executable files with a few hundred bytes from the\nbeginning XORed with  one-byte key.\n\nFigure 8. Shellcode in the .odata section calls several PowerShell commands to download\nadditional loaders\nIt then restores the original entry point (15 bytes in total) to ensure that the original installer\nruns as expected.\n\nFigure 9. Shellcode\n\nin the .odata section restores the original entry point of the installer\n\n\n-----\n\n## Downloaded binaries: loaders\n\n Path for persistence via OneDrive (Icon.jpg)\n\nThis contains the path \\microsoft\\onedrive\\vcruntime140.dll, which is the location where\nanother downloaded file (bg.jpg) gets dropped under the name vcruntime140.dll.\n\n## Persistence and loader abusing OneDrive side-loading vulnerabilities (Bg.jpg)\n\nThis is a patched version of vcruntime140.dll (Microsoft C Runtime library). In this instance,\nthe function memset was patched, as seen in Figures 10 and 11. The return from function\n(retn) was replaced with a jump to overlay (in the newly adde .odata section), where an\ninjected code reads bytes from the overlay, XORs them with a 1-byte key and injects the\nembedded payload into the werfautl.exe process. The shellcode in the overlay is a loader of\nthe main backdoor.\n\nFigure 10. The original memset function. Note that the instruction at address 0x18000C7D1\nis return (retn)\n\n\n-----\n\nFigure 11. The patched memset function. Note that the instruction at address 0x18000C7D1\nis jump (jmp) to overlay with the shellcode\nThe file is placed into the %LOCALAPPDATA%\\microsoft\\onedrive\\ directory, which is a\n[default per-user installation location for the OneDrive application. It was previously reported](https://www.bitdefender.com/blog/labs/side-loading-onedrive-for-profit-cryptojacking-campaign-detected-in-the-wild/)\n[that the threat actors exploited OneDrive side-loading vulnerabilities by placing fake DLLs](https://www.bitdefender.com/files/News/CaseStudies/study/424/Bitdefender-PR-Whitepaper-SLOneDriveCyberJack-creat6318-en-EN.pdf)\ninto this OneDrive directory to achieve persistence in a compromised machine.\n\n## Persistence and loader employing malicious Google Chrome extensions (Favicon.jpg)\n\nThis is an installer package that contains Installer.exe (a Google Chrome extension installer),\nNativeApp.exe (a native messaging host) and Chrome extension files (background.js,\nmanifest.json, and icon.png).\n\n[NativeApp.exe is a native messaging host that communicates with Chrome extensions using](https://developer.chrome.com/docs/apps/nativeMessaging/)\n[standard input (stdin) and standard output (stdout). Note the type = “stdio” in the extension](https://learn.microsoft.com/en-us/cpp/c-runtime-library/stdin-stdout-stderr?view=msvc-170)\nmanifest.\n\nFigure 12. The extension manifest. Note the extension ID (allowed_origins) path leading to\nthe dropped executable and the type = standard input/output.\n\n\n-----\n\nFigure\n\n13. Malicious extension as viewed in a Google Chrome extension tab\nThe [Background.js extension script adds a listener to the onStartup message. This listener](https://developer.chrome.com/docs/extensions/mv2/background_pages/)\nsends the “inject” command to the native messaging host, effectively acting as a somewhat\nunique method of persistence, since the malicious payload is executed every time the\nChrome browser is started.\n\nFigure 14. The handler of the\n\nonStartup event (the startup of the Chrome browser)\n[NativeApp uses messages in JSON format to exchange data with Chrome extensions, and](https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/JSON)\nimplements three commands: execute, load, and inject.\n\nThe format of the message is as follows: xx xx xx xx {“cmd”:””,”data”:””}, where xx xx xx xx is\nlength of the message in bytes. The “cmd” key must contain one of the implemented\ncommand values (execute, load, and inject), while the “data” key may contain additional\nparameters like path and the program to be executed.\n\nThe following are examples of valid JSON messages:\n\n_{\"cmd\":\"execute\",\"data\":[\"c:\\\\windows\\\\system32\\\\notepad.exe\"]}_\n\n_{\"cmd\":\"load\",\"data\":[\"c:\\\\temp\\\\hello-world-x64.dll\",\"MessageBoxThread\"]}_\n\n_{\"cmd\":\"inject\",\"data\":[\"\"]}_\n\nNote that each message must be preceded with a 4-byte little-endian length value. Passing\nnon-printable characters (0x00 as shown in Figure 15) can be achieved by using PowerShell\nand its [Get-Content cmdlet with the -raw parameter, then redirecting this content via pipe “|”](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-content?view=powershell-7.3)\n\n\n-----\n\nto the NativeApp. If the cmd.bin file contains the same content as shown in Figure 15,\nNativeApp.exe will run notepad.exe.\n\n_powershell Get-Content .\\cmd.bin -raw | NativeApp.exe_\n\nFigure 15.\n\nMessage instructing the execution of notepad.exe. The first DWORD 0x0000003f is the\nlength of the following JSON message\nIn the current implementation, the inject command has no parameters. Instead, it connects to\nthe hardcoded URL address http://<delivery server>/help[.]jpg, downloads, decodes and runs\nthe main payload, which is a backdoor.\n\n## Main backdoor loader (Help.jpg )\n\nThis is a shellcode that loads another embedded executable — the main backdoor payload\nwhich we named WhiskerSpy.\n\n## The main payload: WhiskerSpy\n\nWhiskerSpy uses elliptic-curve cryptography (ECC) to exchange encryption keys between\nthe client and server. The following are the implemented backdoor commands:\n\ninteractive shell\ndownload file\nupload file\ndelete file\nlist files\ntake screenshot\nload executable and call its export\ninject shellcode into process\n\n[The machine ID is computed as a 32-bit Fowler-Noll-Vo hash (FNV-1) of the 16-byte UUID](https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function)\n[located in the System Information Table of the System Management Bios (SMBIOS). For](https://www.dmtf.org/standards/smbios)\n[more details about the UUID value, see page 33 of the SMBIOS Specification. The function](https://www.dmtf.org/sites/default/files/standards/documents/DSP0134_3.0.0.pdf)\n[GetSystemFirmwareTable is called with the parameter “RSMB” to retrieve the raw SMBIOS](https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemfirmwaretable)\ntable, It is then parsed to locate the 16-byte UUID, which has its FNV-1 hash computed.\n\nFor communication with the command-and-control (C&C) server, the backdoor generates a\nrandom 16-byte AES key. It computes the session ID from this key as a 32-bit [Murmur3](https://en.wikipedia.org/wiki/MurmurHash)\nhash.\n\n\n-----\n\nAs mentioned, the backdoor uses Elliptic-curve cryptography (ECC). We can determine the\n[Elliptic-curve domain parameters from hardcoded values stored in the “.data” section. In](https://en.wikipedia.org/wiki/Elliptic-curve_cryptography)\nfigure 16, you can see the prime (p, yellow color), the first coefficient a (red color), the\nsecond coefficient b (green color), generator (base point, blue color), and the cofactor (h,\norange color). Knowing these parameters helps us determine that \"secp256r1\" is the used\ncurve, as we can see all the important constants for most popular elliptic curves listed, for\n[example, in tinyec project.](https://github.com/alexmgr/tinyec/blob/master/tinyec/registry.py)\n\nFigure 16. The\n\nhardcoded parameters of the “secp256r1” curve\nThere is one more value shown in Figure 16 (brown color) which represents the hardcoded\nserver’s public key.\n\n[Then a series of computations (Elliptic-curve Diffie–Hellman or ECDH key exchange) follows:](https://wizardforcel.gitbooks.io/practical-cryptography-for-developers-book/content/asymmetric-key-ciphers/elliptic-curve-cryptography-ecc.html)\n\n1. Generate random 32-byte client private key (clientPrivKey)\n2. Compute client public key by multiplying the client private key by the curve generator\n\n(clientPubKey = clientPrivKey * curve.g)\n3. Compute sharedKey by multiplying the client private key by the server public key\n\n(sharedKey = clientPrivKey * serverPubKey)\n\nThe result of these computations are uploaded to the C&C server as a 64-byte binary blob,\nwhere the first 32 bytes are the x-coordinate of the client public key, since a a commonly\nused shared function f(P) is to take the x-coordinate of the point P. The second 32 bytes are\n\n\n-----\n\nderived from a random 16-byte AES key.\n\nC&C communication begins by registering the machine ID (function number = 3; POST\nrequest with “l<machineID>*”).\n\nFigure 17. Registering a new machine\n\nThe uploading of the 64-byte file with the x-coordinate of the client public key and the\nencrypted AES key follows (function number = 1; POST request with “l<machineID>\n<sessionID>”.\n\nFigure 18. Registering a new\n\nsession key and uploading it\nWhiskerSpy then periodically requests the C&C server for any tasks it should perform\n(function number = 2; POST request with “h<machineID>*”.\n\nFigure 19. WhiskerSpy\n\nrequesting for tasks to be performed\nReceived packets (the content of the file h<machineID>) can either be encrypted or in plain\ntext, depending on the packet’s purpose. For example, the alive packet has 0x14 bytes,\n[starts with the 0x104B070D magic value, and is not encrypted. Its Murmur hash must be](https://en.wikipedia.org/wiki/MurmurHash)\nequal to the hardcoded value 0x89EECD7C. Other packets are listed in Table 1.\n\n\n**Encrypted with**\n**AES**\n\n\n**Packet type** **Magic** **Length**\n\n\n**Murmur**\n**hash**\n\n\nDo nothing . 1 No\n\nAlive 0x104B070D 0x14 0x89EECD7C No\n\n\nGenerate new session\nkey\n\n\n0xC8C9427E 0x20 0xDA348CF2 No\n\n\nCommand packet 0xF829EA31 Yes\n\nTable 1. Special types of messages\n\nWhiskerSpy implements standard functions. While analyzing the code, we noticed a few\nstatus codes designed to report the state of the task, with the first words (two bytes) of the\nreceived message being the command ID. Note that, in the case of the command packet, the\n\n\n-----\n\nmagic value is the same for all commands: it is found before the command ID and is not\ndisplayed in Table 2. In the case of the alive packet, the first word (2 bytes) of the magic\nvalue is used as the command ID, therefore the 0x70D value can be found in the table.\n\n**Command**\n**ID** **Function** **Status codes**\n\n\n1 Interactive shell\n(run command line\ntask)\n\n2 Download file to\nthe client\n\n3 Upload file to the\nserver\n\n4,8 List files\n\n\nCPF           CommandLine Process Fail\n\nCPS           CommandLine Process Success\n\n[empty]\n\nUTOF          Open File\n\nFWS           File Write Success\n\nUTWF         Write File\n\nBAD           error\n\nUTOF         Open File\n\nUTRF          Read File\n\nFIB            File Input Big (>200MB)\n\nFIE            File Input Empty (zero length)\n\nBAD           error\n\n\n5 Delete file OK\n\nBAD\n\n6 Not supported\n\n7 Exit process\n\n9 Encrypt file and\nupload it to the\nC&C server\n\n10 Take screenshot IPS            Incorrect Pixel Specification\n\n(!=24 and !=32)\n\nDIBF           Device-Independent bitmap (DIB)\nFail\n\n\n11 Load module and\nrun export\n\n12 Inject shellcode to\nanother process\n\n\nBAD           unable to load module\n\nOK\n\nBAD\n\nOK\n\n\n0x70D Checks if it is alive [Responds to server with the bytes „e7 94 9f“, which is](https://unicode-table.com/en/751F/)\nalso the UTF-8 encoding of the Chinese character 生\n(shēng = life)\n\nTable 2. Backdoor commands of WhiskerSpy\n\n\n-----\n\n## Similar backdoors\n\nOlder versions of WhiskerSpy are 32-bit executables and implement only subsets of the\npreviously mentioned functions ( 1-5,8,0x70D are the same, 6 = exit process; 7 = drop file to\ntemp and execute it). The remaining functions are missing.\n\nThe communication is not via HTTP protocol, but via FTP protocol. This means that the FTP\nname and password must be hardcoded in the binary to enable communication. This\napproach leaks the current number of victims as l<machineID><sessionID> and\nh<machineID> files that are visible to anyone who knows the login credentials.\n\nThe FTP version of the backdoor also checks for the presence of the debugger. If present,\nthe status code „HELO>“ is sent to the C&C server.\n\n## Attribution\n\nOur findings allow us to attribute this attack to the Earth Kitsune threat actor with medium\nconfidence. Injecting malicious scripts into North Korean-related websites shows a similar\nmodus operandi and victimology to the previous activities of the group. Furthermore, the\ndelivery server and the C&C server of WhiskerSpy used in this attack have two infrastructure\n[overlaps with our previous research on Operation Earth Kitsune.](https://documents.trendmicro.com/assets/white_papers/wp-operation-earth-kitsune.pdf)\n\n1. The first overlap we noticed is that both WhiskerSpy's C&C domain\n\nlondoncity[.]hopto[.]org and Earth Kitsune’s domain rs[.]myftp[.]biz were resolved to the\nsame IP address 45[.]76[.]62[.]198.\n2. The second overlap is that WhiskerSpy’s C&C domains londoncity[.]hopto[.]org and\n\nupdategoogle[.]servehttp[.]com, plus the domain of the delivery server\nmicrosoftwindow[.]sytes[.]net were all resolved to 172[.]93[.]201[.]172. This IP address\nwas also mapped from the domain selectorioi[.]ddns[.]net which was used by Earth\nKitsune’s agfSpy backdoor.\n\nFigure 20 The infrastructure overlap with Earth Kitsune (click the image for a larger version)\n\n\n-----\n\n## Conclusion\n\nThis threat is very interesting from a technical perspective. It patches the legitimate installers\nto hide its activities, uses lesser-known hashing algorithms to compute machine IDs and\nsession IDs and employs ECC to protect encryption keys. In addition, the presented methods\nof persistence are also quite unique and rare. This shows that Earth Kitsune are proficient\nwith their technical abilities and are continuously evolving their tools, tactics, and procedures\nTTPs.\n\nTo help organizations defend themselves from advanced threats, We recommend using a\nmultilayered security approach and technologies that can detect and block these types of\n[threats from infiltrating the system through endpoints,](https://www.trendmicro.com/en_ph/business/products/user-protection/sps/endpoint.html) [servers,](https://www.trendmicro.com/en_ph/business/products/hybrid-cloud/deep-security.html) [networks, and](https://www.trendmicro.com/en_ph/business/products/network/advanced-threat-protection/inspector.html) [emails.](https://www.trendmicro.com/en_ph/business/products/user-protection/sps/email-and-collaboration/email-security.html)\n\n## Indicators of Compromise\n\n[The indicators of compromise for this entry can be found here.](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/23/b/earth-kitsune-delivers-new-whiskerspy-backdoor-via-watering-hole-attack/Earth_Kitsune_WhiskerSpy_ioc.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-02-17 - Earth Kitsune Delivers New WhiskerSpy Backdoor via Watering Hole Attack.pdf"
    ],
    "report_names": [
        "2023-02-17 - Earth Kitsune Delivers New WhiskerSpy Backdoor via Watering Hole Attack.pdf"
    ],
    "threat_actors": [
        {
            "id": "6158a31d-091c-4a5a-a82b-938e3d0b0e87",
            "created_at": "2023-11-17T02:00:07.61151Z",
            "updated_at": "2025-03-27T02:00:03.235865Z",
            "deleted_at": null,
            "main_name": "Earth Kitsune",
            "aliases": [],
            "source_name": "MISPGALAXY:Earth Kitsune",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3f6650a3-9f50-47c4-bd7a-008b63bde191",
            "created_at": "2022-10-25T16:07:23.949232Z",
            "updated_at": "2025-03-27T02:02:10.044899Z",
            "deleted_at": null,
            "main_name": "Operation Earth Kitsune",
            "aliases": [],
            "source_name": "ETDA:Operation Earth Kitsune",
            "tools": [
                "SLUB",
                "WhiskerSpy",
                "agfSpy",
                "dneSpy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1677809194,
    "ts_updated_at": 1743041835,
    "ts_creation_date": 1677663390,
    "ts_modification_date": 1677663390,
    "files": {
        "pdf": "https://archive.orkl.eu/faacee55f39a56594cc8b12f4a197e226193ee2d.pdf",
        "text": "https://archive.orkl.eu/faacee55f39a56594cc8b12f4a197e226193ee2d.txt",
        "img": "https://archive.orkl.eu/faacee55f39a56594cc8b12f4a197e226193ee2d.jpg"
    }
}