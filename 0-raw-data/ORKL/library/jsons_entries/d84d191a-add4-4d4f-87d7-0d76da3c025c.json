{
    "id": "d84d191a-add4-4d4f-87d7-0d76da3c025c",
    "created_at": "2023-01-12T15:05:18.824066Z",
    "updated_at": "2025-03-27T02:16:25.554908Z",
    "deleted_at": null,
    "sha1_hash": "70deff7e92069c4e53c66370fda393b42589fb2d",
    "title": "Minifilters for detection of Malware",
    "authors": "",
    "file_creation_date": "2010-08-03T15:29:21Z",
    "file_modification_date": "2016-10-04T08:53:11Z",
    "file_size": 727410,
    "plain_text": "### ABSTRACT\n\nMalicious code detection and removal is very important to the security of the\n\ncomputer system. This project presents methodologies and tools to detect any malicious\n\ncode present in the system and can be used as a preventive measure to protect the system\n\nfrom being infected. Malicious code analysis can be static or dynamic.\n\nStatic code analysis performs control flow and data flow analysis of the programs\n\nto detect malware. Dynamic code analysis has a greater edge over static code analysis. In\n\nthis technique the instructions are analyzed as the code is being executed. Thus\n\npolymorphic malware can also be detected. The dynamic code technique makes use of a\n\nvirtual environment to perform the analysis. Some malware can also detect the virtual\n\nenvironment and change behavior accordingly to hide itself from the defensive system.\n\nThus dynamic analysis in a virtual environment is not an effective tool until it is used\n\nwith some other tool that can detect the obfuscation of malware. The proposed tool\n\nexamines the code in a virtual environment along with a minifilter driver and detects any\n\nmalicious code present. The minifilter driver is used to monitor the windows API calls,\n\nregistry changes and is used to generate reports. These reports can be analyzed to\n\ncategorize a program as a malware or a normal program.\n\nii\n\n\n-----\n\n### TABLE OF CONTENTS\n\nAbstract …………………………………………………………………………………ii\n\nTable of Contents ………………………………………………………………………iii\n\nList of Tables……………………………………………………………………………vi\n\nList of Figures…………………………………………………………………………..vii\n\n1. Background and Rationale ……………………………………………………..1\n\n1.1 Malicious Code……………………………………………………...1\n\n1.2 Categories of Malware….……………………………………………1\n\n1.2.1 Viruses……………………………………………………..2\n\n1.2.2 Worms……………………………………………………...2\n\n1.2.3 Trojan Horse……………………………………………….2\n\n1.2.4 Attacker Tools….…………………………………………..2\n\n1.2.4.1 Backdoors………………………………………..3\n\n1.2.4.2 Keystroke Loggers……………………………….3\n\n1.2.4.3 Root kits…………………………………………3\n\n1.2.4.4 Email Generators………………………………..3\n\n1.2.4.5 Attacker Toolkits………………………………..4\n\n1.3 Vulnerability to Malware……………………………………………4\n\n1.4 Malicious Code Analysis……………………………………………5\n\n1.4.1 Static Analysis…………………………………………..7\n\n1.4.2 Dynamic Analysis………………………………………8\n\n2. Minifilter Driver……….………………………………………………………11\n\n2.1 Analyzing a Executable……………………………………………11\n\niii\n\n\n-----\n\n2.2 Malicious Code Detection…………………………………………11\n\n2.3 Minifilter Driver……………………………………………………13\n\n2.3.1 Minifilter………………………………………………….13\n\n2.3.2 Filter Manager Concepts…………………………………14\n\n2.3.2.1 Load Order Groups…………………………….14\n\n2.3.2.2 Altitude of a Minifilter…………………………15\n\n2.3.2.3 Instance of a Minifilter…………………………15\n\n2.3.2.4 Callback Routines of a Minifilter………………16\n\n2.4 Advantages of Minifilter Drivers…………………………………..19\n\n2.5 Analyzing the reports and decision making……………………….19\n\n3. System Design………………………………………………………………...22\n\n3.1 Overview of the System…………………………………………...22\n\n3.2 Information Analyzed…..…………………………………………23\n\n3.3 Testing Environment………………………………………………24\n\n3.3.1 Redirection using the tool……………………………..26\n\n3.4 Installing a Minifilter Driver………………………………………27\n\n3.4.1 Creating an INF File for a Minifilter Driver…………….27\n\n3.4.1.1 Version Section (required).................................28\n\n3.4.1.2 DestinationDirs Section…………………….....29\n\n3.4.1.3 DefaultInstall Section…………………………29\n\n3.4.1.3 Strings Section………………………………...29\n\n3.5 Analysis Process……………...........................................................30\n\n4. Evaluation and Results ……………………………………………………….32\n\niv\n\n\n-----\n\n4.1 Sample Reports……………………………………………………37\n\n5. Conclusion and Future Work……………...………………………………….57\n\nBIBLIOGRAPHY AND REFERENCES……………………………………………59\n\nAPPENDIX A. STARTING A VIRTUAL OPERATING SYSTEM………………..61\n\nAPPENDIX B. INSTALLING MINIFILTER …….………………………………...63\n\nAPPENDIX C. STARTING THE TOOL…………………………………………….64\n\nAPPENDIX D. TESTING A SAMPLE PROGRAM………………………………..65\n\nAPPENDIX E. INF FILE FOR THE MINIFILTER………………………………...66\n\nv\n\n\n-----\n\n### LIST OF TABLES\n\nTable 1.1 Differentiating Malware Categories…………………………………..4\n\nTable 3.1 Table describing the contents of the version section in a INF file……28\n\nTable 4.1 MalProber Test Results……………………………………………….33\n\nvi\n\n\n-----\n\n### LIST OF FIGURES\n\nFigure 1.1 A Static Analyzer……………………………………………………….7\n\nFigure 1.2 A Dynamic Analyzer…………………………………………………...9\n\nFigure 2.1 I/O Stack with filter manager and three minifilter drivers………..……16\n\nFigure 2.2 I/O Stack with two filter manager frames, minifilter driver instances, and\n\na legacy filter driver…………………………………………….………18\n\nFigure 3.1 Architecture of the Malicious Code Detection Tool……...……………25\n\nFigure 3.2 Overview of the Malicious Code Analysis Tool…………………..…...31\n\nFigure 4.1 Installing Malprober Driver…………….………………….…………..34\n\nFigure 4.2 Starting the Malprober Service……………………………….………..35\n\nFigure 4.3 Testing usbview.exe with Malprober Tool….…………………………36\n\nFigure A.1 Starting Virtual Operating System………….…………………………61\n\nFigure A.2 Selecting a Virtual Disk…………………….…………………………62\n\nFigure B.1 Installing Minifilter Driver………………….…………………………63\n\nFigure C.1 Starting the Malprober Service………………..……………………….64\n\nvii\n\n\n-----\n\n### 1. BACKGROUND AND RATIONALE\n\n 1.1 Malicious code \n\nMalicious code is a term used to refer to any code that can cause undesired\n\neffects, security breaches and potential damages to the software system without the users\n\nconsent. Software is classified as malware based on the users intent rather than the\n\nfeatures of the software. Any harmful software is not a malware. For example, defective\n\nsoftware can be legitimate and can still cause potential damage due to the presence of\n\nharmful bugs. Malware includes trojans, viruses, worms, spyware and any kind of\n\nsoftware with intention to cause damage to the system. [Andreas, Ulrich 2006]\n\nDestructive malware generally spreads by using popular communication tools to\n\nspread them. For example, worms can be spread using an email tool. They usually exploit\n\nthe vulnerabilities on the target system to make their entry easy and unknown to the\n\nsystem.\n\nA special category of malware called data-stealing malware exists. This malware\n\nintends to steal personal and confidential information of a person or an organization. The\n\nsecurity threats of this kind are created using software like key loggers, adware, spyware\n\nand bots. This malware is typically stored in the cache memory which is frequently\n\nflushed. Once this kind of malware gets successfully installed on the target machine, they\n\ncan take-over the IDS or anti-virus programs protecting the system.\n\n### 1.2 Categories of Malware\n\nMalware has become the greatest external threat to organizations causing resource\n\ndamage and restoration overhead. Malware can be categorized into the following:\n\n1\n\n\n-----\n\n**1.2.1  Viruses**\n\nA virus is a self-replicating program that inserts copies of itself into the target\n\nprogram or target machine. Generally viruses are initiated by user interaction. This\n\nhappens whenever a user opens a file or runs a program.\n\n**1.2.2  Worms**\n\nA worm is a self-replicating program that requires no user interaction. It replicates\n\nitself based on some conditions. Worms are further categorized into: Network Service\n\nWorms and Mass mailing worms.\n\nNetwork Service Worms replicate themselves and infect the target machines by\n\nmaking use of the vulnerabilities in the network.\n\nMass mailing worms are similar to email viruses except that they are self\n\ncontained and do not infect other files [Kent K, Mell P, Nusbaum J].\n\n**1.2.3** **Trojan Horse**\n\nA Trojan horse is a non-replicating and self contained program that looks like\n\na useful program but has hidden code that has a malicious purpose and can cause\n\ndamage to the system. Generally Trojan horses are used as aiding tools for others\n\nattacker tools [Kent K, Mell P, Nusbaum J].\n\n**1.2.4** **Attacker Tools**\n\nAttacker tools are generally delivered to a target system as part of a malware\n\ninfection. There is a large variety of attacker tools. Generally these tools help\n\n2\n\n\n-----\n\nattackers in gaining unauthorized access to infected systems and their data. They can\n\nalso be used to launch additional attacks. The most common attacker tools are:\n\n**1.2.4.1 Backdoors**\n\nA Backdoor is a tool that can be used to bypass the normal authentication\n\nand remain undetected. Generally a backdoor is a malicious program that listens\n\nto the commands being executed on certain TCP or UDP port. There is type of\n\nbackdoor known as bot, which when installed allows the attacker to gain remote\n\ncontrol over the infected system.\n\n**1.2.4.2 Keystroke Loggers**\n\nA keystroke logger is a malicious program that is used to record and\n\nmonitor the keyboard usage. These tools can be used to log confidential\n\ninformation of the user, like user names and passwords and send them to the\n\nattacker.\n\n**1.2.4.3 Root kits**\n\nA root kit is a collection of malicious files that are deployed on a target\n\nmachine and then they alter the functionality of the target systems in a stealthy\n\nway. Generally root kits make many changes to the target machine making itself\n\ndifficult to detect.\n\n**1.2.4.4** **E-Mail Generators**\n\nAn Email Generator is a program that is used by the attacker to send large\n\nnumber of emails that contain malware, spyware, and other infections to target\n\nsystems without user’s knowledge.\n\n3\n\n\n-----\n\n**1.2.4.5** **Attacker Toolkits**\n\nAttackers make use of attacker toolkits which consists of wide variety of\n\ntools and utilities that can be used to probe and attack target systems. The tools\n\ninclude packet sniffers, port scanners, vulnerability scanners, password crackers\n\nand other scripts. The following table shows different malware categories.\n\n**Characteristic** **Virus** **Worm** **Trojan** **Tracking** **Attacker**\n\n**Horse** **Cookie** **Tools**\n\n**Is it self-contained?** No Yes Yes Yes Yes\n\n**Is it self-replicating?** Yes Yes No No No\n\n**What is its method of** User- Self- N/A N/A N/A\n\n**propagation?** interaction Propagation\n\nTable 1.1 Differentiating Malware Categories [Kent K, Mell P, Nusbaum J]\n\n### 1.3 Vulnerability to Malware\n\nMany factors may leave a system vulnerable to attacks. The most common being\n\nthe exploits of the bugs in the operating system design, existence of over- privileged\n\nusers (who can leave the system vulnerable to the malware by making wrong decisions).\n\nOnce a potential weakness is determined in an operating system, it can be used to launch\n\nattacks against all the machines that have the same operating system. Once a machine is\n\ncompromised the malware can act intelligently hiding itself from the anti-malware and\n\nanti-virus programs, at the same time performing its intended task.\n\n4\n\n|Characteristic|Virus|Worm|Trojan Horse|Tracking Cookie|Attacker Tools|\n|---|---|---|---|---|---|\n|Is it self-contained?|No|Yes|Yes|Yes|Yes|\n|Is it self-replicating?|Yes|Yes|No|No|No|\n|What is its method of propagation?|User- interaction|Self- Propagation|N/A|N/A|N/A|\n\n\n-----\n\nThe user should always install the patches for the design weaknesses to protect\n\nitself from being prone to malware attack. Most of the web-sites on the World Wide Web\n\nare infected by malware. For example, the social networking site Twitter had a\n\nvulnerability called XSS security issue. This vulnerability allowed the malicious program\n\ndevelopers to inject malicious code into the HTML pages, thus all the systems that visited\n\nthis Web-site and had a lack of malware protection were infected by the malware. The\n\nXSS vulnerability allows the malware owners to hi-jack user accounts and also with the\n\nhelp of knowledge of other vulnerabilities, they could compromise the systems [Wiki\n\n2009].\n\nAnother example of vulnerability is the Microsoft Office PowerPoint\n\nvulnerability. This unpatched vulnerability could allow the hackers to get arbitrary code\n\nexecuted with the privileges of the log-on user.\n\n### 1.4 Malicious Code Analysis\n\nMalicious code analysis is used to refer to the process of determining the intent\n\nand nature of the malware sample. This is very important to the process of developing the\n\ndetection techniques for the malware. Also it is very important for developing tools that\n\ncan be used to remove the malware from the system. For a long time the malicious code\n\nanalysis was a manual, time consuming and tedious task. Thus there was need for\n\nautomated systems which could detect the presence of the malware and automatically act\n\nto prevent the malware from achieving its intended task.\n\nThe most important preventive measures for malware are the virus scanner, but\n\nthese scanners rely on a database of known signatures for virus. Thus they are restricted\n\nto only known viruses and malware, but many new types of malware and viruses attack\n\n5\n\n\n-----\n\nthe computer systems every day. So there is a need for a better malware tracking solution.\n\nWhenever a new malware is found, its signature is written to the database of signatures,\n\nso that all systems infected with this malware can be easily fixed.\n\nIn addition it is very important to understand the functionality of the malware. In\n\norder to remove the malware, it is not sufficient to remove the binary from the Windows\n\nenvironment; all the registry settings affected by the malware should be restored.\n\nGenerally the malware analysis is conducted by allowing the malware program to\n\nbe executed in a restricted environment and observe the actions. Then the actions of the\n\nprogram are analyzed (usually a debugger is used). This manual analysis is a time taking\n\nand tedious process. Thus there is a need for automated analysis programs. This\n\nautomation is generally achieved by executing the affected program in a virtual\n\nenvironment and recording the actions of the programs and finally sending the recorded\n\nactions to the human analyst [Andreas, Ulrich 2006].\n\nThe existing automated malicious code analyzers have shortcomings. One of the\n\nvery important aspect among them being the failure of the analyzers due to the presence\n\nof detection routines within the malware. The detection routines allow the malware to\n\ndetect if the program is running in a virtual environment. If so, the malware program acts\n\nin a different way, thus hiding its existence. Some malware have the capability to check\n\nthe existence of both hardware and software breakpoints, which can be used to detect the\n\nexistence of a malware.\n\nOther problems with the automated malware analysis include the incapability of\n\nthe tool to detect the complete interaction of the program with the system.\n\n6\n\n\n-----\n\n**1.4.1. Static Analysis**\n\nStatic analysis is the process of analyzing the malware without actually executing\n\nit. In this technique the binary code is converted into corresponding assembler level\n\ninstructions. After the transformation, control flow and data flow analysis techniques are\n\nimplemented to draw a conclusion about the programs functionality. The following figure\n\nshows a static analyzer. [Feng M, Gupta R]\n\nMalicious Unpacker\nCode\n\nYes Unpacked Binary Code\n\n|Ye|s|\n|---|---|\n\n|Col1|Unpacked Binary Code|\n|---|---|\n\n\nVirtual OS Is No\npacked?\n\nFigure 1.1 A Static Analyzer\n\n\nPattern\nAnalyzer\n\n|Col1|Unpacker|\n|---|---|\n|Yes No Is packed?||\n\n\nStatic analysis is faster in performance than dynamic analysis. One of the major\n\ndisadvantages of static analysis is the ability of the malware to make use of binary\n\nobfuscation, which can be used to safely play with the control flow and data flow\n\nanalysis. The binary obfuscation preserves the programs functionality while at the same\n\ntime making the parsing of the program difficult. The malware can also make use of code\n\n7\n\n\n-----\n\nobfuscation which makes it difficult to perform the data flow and control flow analysis.\n\nThese obfuscation techniques are implemented with the help of opaque predicates and\n\nopaque constants. Opaque predicates are defined as “Boolean valued expressions whose\n\nvalues are known to the obfuscator but difficult to determine for an automatic\n\ndeobfuscator”. Opaque constants are similar to Opaque predicates but they hold integer\n\nvalues [Christodorescu,M., Jha, S].\n\nIt’s not necessary that the code analyzed by the static analyzer is the code that will\n\nbe actually executed. This is true in particular for the self-modifying programs that make\n\nuse of polymorphism to hide their actual form.\n\n**1.4.2. Dynamic Analysis**\n\nIn contrast to static analysis, the dynamic analyzers analyze the code when it is\n\nbeing executed. The most important advantage of dynamic analyzer is that the\n\ninstructions that are analyzed are the ones that are executed. These tools provide security\n\nagainst the obfuscation techniques. The following figure shows a dynamic analyzer.\n\n8\n\n\n-----\n\n|Col1|System Service Calls|\n|---|---|\n|User Mode||\n\n\nFigure 1.2 A Dynamic Analyzer\n\nGenerally the analysis is conducted in a virtual environment. Thus the risk of\n\nsystem being damaged is reduced, because the virtual environment image could be\n\nreplaced with a new one. [Feng M, Gupta R]\n\nOne of the significant drawbacks of conducting the analysis in a virtual\n\nenvironment is that the malware could determine that it is running in a virtual\n\nenvironment and may change its behavior accordingly.\n\nVirtual environment detection tools are easily available. These tools make use of\n\nCPU instructions to determine the existence of a virtual environment. For example the\n\nfollowing sample code can be used to test the existence of a virtual environment:\n```\nint swallow_redpill () {\n    unsigned char m[2+4], rpill[] =       \n    \"\\x0f\\x01\\x0d\\x00\\x00\\x00\\x00\\xc3\";\n    *(unsigned*)&rpill[3]) = (unsigned)m;\n    ((void(*)())&rpill)();\n    return (m[5]>0xd0) ? 1 : 0;\n   }\n\n```\n9\n\n\n-----\n\nThe heart of this code is actually the SIDT (store interrupt descriptor table)\n\ninstruction (encoded as 0F010D [addr]), which stores the contents of the interrupt\n\ndescriptor table register (IDTR) in the destination operand, which is actually a memory\n\nlocation. One very interesting thing about the SIDT instruction is that, it can be executed\n\nin non privileged mode but it returns the contents of the sensitive register, used internally\n\nby the operating system.\n\nBecause there is only one IDTR register, but there are at least two OS running\n\nconcurrently (i.e. the host and the guest OS), VMM needs to relocate the guest's IDTR in\n\na safe place, so that it will not conflict with a host's one. Unfortunately, VMM cannot\n\nknow if (and when) the process running in guest OS executes SIDT instruction, since it is\n\nnot privileged (and it doesn't generate an exception). Thus the process gets the relocated\n\naddress of the IDT table. It was observed that on VMWare, the relocated address of IDT\n\nis at address 0xffXXXXXX, whereas on Virtual PC it is 0xe8XXXXXX. This was tested on\n\nVMWare Workstation 4 and Virtual PC 2004, both running on Windows XP host OS\n\n[Quist D, Val Smith].\n\n10\n\n\n-----\n\n### 2. Minifilter Driver\n\n 2.1 Analyzing a Executable\n\nThe ultimate goal of this project is to analyze a given executable and generate a\n\nreport of the changes made to the system by the executable. Then analysis of the report is\n\nperformed to decide if the executable is a malware or a normal program.\n\nThe executable is tested in a virtual environment. The analysis tool has two main\n\ncomponents. They are:\n\n**1.** **Minifilter Driver: The minifilter driver is used to dynamically monitor the**\n\nactivities of the program that is being tested. This driver can track the\n\nWindows API calls made by the program.\n\n**2.** **Analysis Tool: This tool works along with the driver. It makes use of the**\n\ntrack report of the Windows API calls made by the program and generates a\n\nreport that is understandable by an analyst. The report includes all the file and\n\nregistry operations made by the program.\n\nThe minifilter driver is created using Windows programming with Windows\n\nDriver Kit (WDK) [Microsoft-7]. The analysis component is developed using C and C++\n\nprogramming with Visual C++. Based on the reports generated by the analysis tool, the\n\nchanges made by the program are taken into consideration, analysis is performed and a\n\ndecision is made as malicious or normal program.\n\n### 2.2 Malicious Code Detection\n\nMalicious code detection is the process of detecting various malware that can\n\ncause potential damage to the system. Any defense technology can be separated into two\n\ncomponents – a technical component and an analytical component. In reality, these\n\n11\n\n\n-----\n\ncomponents may not be clearly separable at the module or algorithm level within every\n\nmalicious program. However, in terms of function, their differences are significant and\n\nimportant. The technical component is a collection of program functions and algorithms\n\nthat selects the data that will be analyzed by the analytical component. This data may be\n\nanything – from text strings within a file, to a specific action the program performs, to a\n\nfull sequence of actions that the program performs, and more.\n\nThe analytical component serves as the decision-making system. It assesses the\n\ndata provided by the technical component using one or more algorithms and then issues a\n\nverdict about the data. The security program will then use the verdict to take action on the\n\nmalicious program according to the security policy that has been set in the security\n\nprogram. For example, a few of the possible actions that could occur based upon the\n\nverdict might be –\n\na. Notifying the user\n\nb. Requesting further instructions from the user\n\nc. Placing a file in the quarantine\n\nd. Blocking unauthorized program actions\n\nConsider the following example, which is extracted from the assembly code of\n\nBagle, which is a widespread email-based virus. For ease of presentation and\n\nunderstanding, some simplifications of the original code have been performed.\n```\n   1 lea edi, ptr [ebp+0x4025] // edi = mem[ebp+...]\n   2 mov edx, 0xef4013a0  // edx = 0xef4013a0\n   3 mov ecx, 0x3ec5  // ecx = 0x3ec5\n     loop:\n   4 mov al, byte ptr ds[edi]  // al = mem[ds+edi] \n   5 sub al, dl  // al = al - dl\n   6 sub al, dh  // al = al - dh\n\n```\n12\n\n\n-----\n\n```\n   7 xor al, cl  // al = al . cl\n   8 rol edx, cl  // rotate edx by cl bits\n   9 mov byte ptr ds[edi], al  // mem[ds+edi] = al\n   10 inc edi\n   11 dec ecx\n   12 jnz loop  // jump\n   13 push edi  // push args into stack\n   14 call 0x7c92a950  // call a lib function\n\n```\nThe key part of the sample code is a loop formed by instructions 4 through 12.\n\nThe instructions preceding the loop (i.e., instructions 1 through 3) initialize the loop\n\ncounter (ecx), starting address (edi), and another variable (edx). During each iteration, the\n\nloop fetches a value from the data segment, performs a calculation based upon that value,\n\nand then finally puts the new computed value back into the data segment. Following the\n\nloop, the program calls a library function that uses the newly computed values. The use\n\nof these values triggers the actions of the virus. Many different kinds of obfuscation\n\ntransformations can be applied to this piece of code to affect mutations of the Bagle virus\n\n[Feng M, Gupta R].\n\n### 2.3 Minifilter Driver\n\n**2.3.1 Minifilter**\n\nThe filter manager is a kernel-mode driver that performs in accordance to\n\na standard file system filter model. The ultimate goal of a filter manager is to\n\nprovide the generic functionality that is required by file system filter drivers. This\n\nfunctionality is very useful for the third party driver developer to develop and\n\nwrite minifilters for the user applications [Microsoft-3].\n\n13\n\n\n-----\n\nThe minifilter technique is very simple and easy to develop than the\n\ncorresponding file system filter drivers. By taking advantage of this functionality,\n\nthird-party developers can write minifilter drivers, which are simpler to develop\n\nthan legacy file system filter drivers. This process shortens the driver production\n\nprocess with far superior quality. The applications developed by minifilters are\n\nmore robust and versatile [Microsoft-1].\n\n**2.3.2** **Filter Manager Concepts**\n\nAll Windows operating systems have a Filter manager installed on them.\n\nBut the filter manager is turned into active mode only when a minifilter driver is\n\nloaded. The filter manager works by attaching itself to the file system stack and\n\nthus acquiring a place in the target volume. On the other hand minifilter driver has\n\nan indirect attachment to the target volume by registering itself with the filter\n\nmanager. The minifilter driver can register itself with the filter manager to\n\nperform filtering of a chosen set of I/O operations.\n\n**2.3.2.1** **Load Order Groups**\n\nThe “load order group” determines the position of a legacy filter driver\n\nposition in the file system I/O stack relative to other filter drivers. This can be\n\nbetter explained by the following example. An antivirus filter driver should\n\nalways be at a higher position in a file system I/O stack than replication filter\n\ndriver. This position of antivirus filter driver is required in order to detect\n\nviruses and disinfect files before they can cause further damage to the other\n\nmachines. Thus, filter drivers located in the FSFilter Anti-Virus load order\n\ngroup are higher in position and are loaded before filter drivers located in the\n\n14\n\n\n-----\n\nFSFilter Replication group. Every filter driver in the file system has a\n\ncorresponding system-defined class. There is also a GUID specified in the .inf\n\nfile for the filter driver [Microsoft-4].\n\n**2.3.2.2** **Altitude of a Minifilter**\n\nSimilar to the legacy filter drivers, all the minifilter drivers attach to\n\nthe file system stack in a particular order. A unique identifier called altitude\n\ndetermines the order of attachment of a minifilter driver. The altitude of a\n\nminifilter is the characteristic that identifies the position of a minifilter relative\n\nto other minifilters in the I/O stack when the minifilters are loaded. The\n\naltitude is an infinite-precision string interpreted as a decimal number. Lower\n\nthe altitude value, earlier the filter loaded. It means a minifilter that has a low\n\nnumerical altitude is loaded below a minifilter that has a higher numerical\n\nvalue in the I/O stack [Microsoft-4].\n\n**2.3.2.3** **Instance of a Minifilter**\n\nThe attachment of a minifilter driver at a particular altitude on the file\n\nsystem stack is called an instance of the minifilter driver. The altitude of a\n\nminifilter driver ensures the order of loading instances of minifilter drivers is\n\nappropriate. The altitude also determines the order in which the minifilter\n\ndrivers are called by the filter manager to handle I/O. The allocation of\n\naltitudes to the instance of minifilter drivers is managed by Microsoft. The\n\nfollowing figure shows a simplified I/O stack with the filter manager and three\n\nminifilter drivers. The following figure shows a single filter manager on a I/O\n\nstack.\n\n15\n\n\n-----\n\nFigure 2.1 I/O stack with single filter manager and three minifilter drivers\n\n[Microsoft-2].\n\n**2.3.2.4** **Callback Routines of a Minifilter**\n\nA minifilter has the capability to filter all the three major I/O based\n\noperations. The three I/O operations are IRP-based I/O operations; fast I/O\n\nand file system filter (FSFilter) callback operations. The minifilter can register\n\nwith a preoperation call back routine, a post operation callback routine, or\n\nboth for filtering each of the above three I/O operations. The filter manager\n\nmakes a call to the appropriate callback routine for each minifilter driver\n\nwhenever they need to handle an I/O operation. It can call a callback routine\n\nonly when it is registered. When the callback routine returns, the filter\n\n16\n\n\n-----\n\nmanager makes a call to other callback routine registered for other minifilter\n\ndrivers for the same I/O operation [Microsoft-2].\n\nThe call to the callback routines by the filter manager are in order of\n\naltitude from highest to lowest (A, B, C). The I/O request is then forwarded to\n\nthe next-lower driver for further processing. Once a request for I/O operation\n\ncomplete is receive by the filter manager, a call to post operation callback\n\nroutines of each of the minifilter driver is made in reverse order, from lowest\n\nto highest (C, B, A) [Microsoft-5].\n\nGenerally there is a need for interoperability between the minifilter\n\ndrivers and the legacy filter drivers. To achieve this interoperability the filter\n\nmanager attaches filter device objects to a file system I/O stack in multiple\n\nlocation. Each of the filter manager's filter device objects is called a frame.\n\nThe legacy filter driver perceives each filter manager frame as just another\n\nlegacy filter driver.\n\nEvery filter manager frame makes use of band of altitudes. The filter\n\nmanager is robust enough, so that it can create a new frame or modify an\n\nexisting frame to attach to the file system at the correct location.\n\nIt’s always important to verify the interoperability among the legacy\n\nfilter drivers and the minifilter drivers. If there are issues with the\n\ninteroperability, there is a need to replace legacy filters with minifilters. If a\n\nminifilter driver is unload operation is performed and then a reload operation\n\nis called, the minifilter is reloaded at the same altitude in the same frame from\n\nwhich it was unloaded.\n\n17\n\n\n-----\n\nThe following figure shows a simplified I/O stack with a two filter\n\nmanager frames, minifilter driver instances, and a legacy filter driver. The\n\nfollowing figure shows multiple filter managers on a I/O stack.\n\nFigure 2.2 I/O stack with two filter manager frames, minifilter driver instances, and a\n\nlegacy filter driver [Microsoft-2]\n\n18\n\n\n-----\n\n### 2.4 Advantages of Minifilter Drivers\n\nThe minifilter model offers the following advantages over the existing\n\nlegacy filter driver model:\n\n1. Filter load order control is easy\n\n2. Unloading a minifilter while a system running is possible\n\n3. Ability to process only necessary operations\n\n4. Kernel stack is used more efficiently\n\n5. Code redundancy is reduced\n\n6. Less complexity\n\n7. New operations can be easily added\n\n8. Can support multiple platforms easily\n\n9. Better support for user-mode applications\n\n### 2.5 Analyzing the reports and decision making\n\nOnce a report is generated by the tool, analysis can be performed by the analyst.\n\nBased on the operations performed by the program as listed in report, the analyst can\n\nclassify a program as a malicious program or a normal program. For example, the\n\nfollowing is the analysis of a sample report. The report is from Symantec Antivirus:\n\n**Name:** _Auraax.c_\n\n**Type: Worm**\n\n**Infection Length: 27,136 bytes**\n\n**Systems Affected: Windows 98, Windows 95, Windows XP, Windows Me, Windows**\n\nVista, Windows NT, Windows Server 2003, and Windows 2000.\n\n19\n\n\n-----\n\nWhenever the worm executes, it replicates itself and infects all the machines that\n\nare prone to it. It copies into the system files of a machine as follows:\n\n**_%ProgramFiles%\\Microsoft Common\\wuauclt.exe_**\n\nOnce a machine is infected, it then creates several files on the infected machine.\n\nFor example the following files are created:\n\n**_1._** **_%Windir%\\Temp\\rld[SINGLE NUMBER].tmp_**\n\n**_2._** **_%System%\\config\\systemprofile\\Local Settings\\History\\desktop.ini_**\n\n**_3._** **_%System%\\config\\systemprofile\\Cookies\\index.dat_**\n\n**_4._** **_%System%config\\systemprofile\\Local Settings\\Temporary Internet_**\n\n**_Files\\desktop.ini_**\n\nAfter the creation of files, the worm alters the following system processes:\n\n**_1._** **_svchost.exe_**\n\n**_2._** **_explorer.exe_**\n\nThen the worm makes few new entries into the windows registry. These entries\n\nrun every time the system boots.\n\nThe entries are as follows:\n\n**_HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\WindowsNT\\_**\n\n**_CurrentVersion\\Image File Execution Options\\explorer.exe\\\"Debugger\" =_**\n\n**_\"%ProgramFiles%\\Microsoft Common\\wuauclt.exe\"_**\n\nThe worm also modifies few existing registry entries, which are loaded every time\n\nthe system boots. The entries are as follows:\n\n20\n\n\n-----\n\n**_HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\WindowsNT\\CurrentVersi_**\n\n**_on\\Winlogon\\\"Userinit\" = \"%System%\\userinit.exe, ProgramFiles%\\Microsoft_**\n\n**_Common\\wuauclt.exe\"_**\n\nThe worm also creates registry entries that have the capability to bypass the\n\nWindows firewall. They are:\n\n**_HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAcce_**\n\n**_ss\\Parameters\\FirewallPolicy\\StandardProfile\\AuthorizedApplications\\List\\\"%_**\n\n**_ProgramFiles%\\MicrosoftCommon\\wuauclt.exe\"=\"%ProgramFiles%\\Microsof_**\n\n**_t Common\\wuauclt.exe:*:Enabled:EMOTIONS_EXECUTABLE\"_**\n\nThe worm also searches the kernel drivers for .sys extension files in the\n\n%System%\\DRIVERS\\ folder so that it can overwrite these files. These files are\n\ngenerally overwritten with a root kit so that the worm can hide itself.\n\nThe worm also modifies the host machine files, so that the host machine is\n\nprevented from accessing the following websites.\n\n**1.** 127.0.0.1 downloads.microsoft.com\n\n**2.** 127.0.0.1 downloads1.kaspersky-labs.com\n\n**3.** 127.0.0.1 downloads1.kaspersky-labs.com\n\n**4.** 127.0.0.1 downloads1.kaspersky-labs.com\n\n**5.** 127.0.0.1 downloads2.kaspersky-labs.com\n\n**6.** 127.0.0.1 downloads3.kaspersky-labs.com [Symantec 2008].\n\n21\n\n\n-----\n\n### 3. SYSTEM DESIGN\n\n 3.1 Overview of the system\n\nThe use of a dedicated standalone system for testing the malware is not an\n\nefficient solution. The dedicated system can be reinstalled after each dynamic test run is\n\nperformed, but this induces very high cost. In order to overcome the disadvantages of a\n\nstandalone system, the tool run the tests in a virtual environment, thus limiting the effect\n\nof the malware only to the virtual machine but not the real system.\n\nIn case of a virtual system, the infected virtual image is replaced with a new one.\n\nThus there is no need to reinstall software on the machine, thereby reducing the overhead.\n\nVirtual machines are very fast and similar to the real one in-term’s of the execution\n\nspeed. A major drawback of the virtual solution is that the malware may detect that the\n\nenvironment in which it is running is the virtual environment and may change its\n\nbehavior accordingly.\n\nThe alternative solution to the above problem is the use of an emulator. A PC\n\nemulator is a piece of software that emulates the functionality of a real system including\n\nall the real time resources of a system. There is a subtle difference between an emulator\n\nand a virtual machine. Virtual system executes a statically dominant set of instructions\n\ndirectly on a real system, whereas an emulator simulates all the instructions in software\n\n[Duan H, Guan Y, Zhang J].\n\nBut there is a problem with software emulators. They are not easily available for\n\nWindows based Operating System. Hence there is a need for a tool that can work with a\n\nvirtual Operating system and still detect malware.\n\n22\n\n\n-----\n\nAlso there is a very important difference between the speed of execution on a real\n\ntime system and the speed of execution on a virtual Operating System. This difference\n\ncan be used by the malware to judge whether it is being run on a virtual Operating\n\nSystem or a real system. This disadvantage can be overcome by using a minifilter driver\n\nwhich can redirect operations and makes a malware believe that it is not being run in a\n\ntest environment.\n\n### 3.2 Information Analyzed\n\nIt is possible to classify the types of information that is captured during the\n\nanalysis phase of the system. Many systems concentrate on the communication between\n\nthe application and the operating system. This includes intercepting system calls and\n\nhooking API calls.\n\nThere are tools that can be used to list all the windows processes running in a\n\nsystem. Also it is possible to log the windows registry and the file system activity.\n\nGenerally these tools are implemented as operating system drivers that can intercept the\n\nnative windows calls. Thus they are invisible to the application that is currently on\n\nanalysis. There are also tools that can intercept arbitrary user functions, including all\n\nwindows API calls. This requires some rewriting of the target function. This rewriting\n\ncould be detected by a malware and thus it may act differently to overcome the detection.\n\nIn order to overcome the above problem, virtual Operating System is used along\n\nwith a minifilter tool. The minifilter tool has complete control over the system. It has the\n\ncapability of analyzing both the native windows calls as well as the windows API calls, at\n\nthe same time being unidentified by the malicious code. Because of the use of the\n\nminifilter which has complete control over the system, the analysis being performed is\n\n23\n\n\n-----\n\nmore fine grain. This functionality is similar to the debugger but the technique does not\n\nmake use of break points, which are known to create problems when used for analyzing\n\nmalicious code. The reason being the software break points can be detected using code\n\nintegrity checks and the malware could act accordingly [Kirda E, Ulrich 2006].\n\nThe minifilter tool is used for analyzing windows executables especially the files\n\ncorresponding to the PE file format. In this technique the program is tested in a virtual\n\nenvironment and the valid native windows calls and windows API are logged for\n\nanalysis.\n\n### 3.3 Testing Environment\n\nThe testing environment is very simple. The tool has two major parts. They are:\n\n**1.** **Minifilter Driver**\n\n**2.** **Analysis Tool**\n\nThe whole testing is performed on a Virtual System. First the minifilter is\n\ninstalled on the virtual operating system using Windows Installer. Then the analysis tool\n\nservice is started. The service can be started using the windows executable sc.exe which\n\nis used to start, suspend and stop services on the windows operating system. The tool is\n\nstarted using a command prompt. Once the minifilter is installed and the service is\n\nrunning, the program can be tested [OSR 2010]. The following chart shows the designed\n\ntool architecture.\n\n24\n\n\n-----\n\nFigure 3.1 Architecture of the Malicious Code Detection Tool\n\nThe testing is performed in the following steps:\n\n1. The detection tool is supplied with a program to be analyzed.\n\n2. The program name is sent to the driver\n\n3. Driver monitoring process operations\n\na. driver monitors the process creation\n\nb. drivers monitors the activity and redirect any operation\n\n4. Driver monitor the exit of the process\n\n5. Detection tool receives notification from the driver and performs analysis\n\n6. After analyzing, the tool generates the report and displays it.\n\n25\n\n\n-----\n\n**3.3.1 Redirection using the detection tool**\n\nRedirection explains how the detection tool controls the malware by having\n\ngreater control over the system. The following redirection schemes are used:\n\n**1. Suppose program wants to read an existing registry key:**\n\n**_HKLM\\Software\\Microsoft\\Windows\\TaskManager\\_**\n\nAnalyzer will let the program read the value and return to malware program.\n\n**2. Suppose malware wants to create a registry key**\n\n**_HKLM\\Software\\Microsoft\\Windows\\MalwareXXX\\_**\n\nAnalyzer will create a registry key as:\n\n**_HKLM\\Software\\Analyzer Sandbox\\Malware\\_**\n\n– > Sub Key will be:\n\n**_HKLM\\Software\\Microsoft\\Windows\\MalwareXXX\\_**\n\nThe tool makes the malware believe that it is not detected by sending wrong\n\nregistry keys. It monitors the creation and deletion of registry keys.\n\n**3. Whenever malware tries to read a registry key, Analyzer will first check the**\n\nsandboxed key and if found will return the value from there, otherwise will let\n\nthe operation go as usual.\n\n**4. What happens if malware modifies any registry key?**\n\nThis operation will be considered as same to creation of key\n\n**5. What happens when file operation is requested?**\n\nIt treats as if registry names are some file names and file paths.\n\n26\n\n\n-----\n\n# 3.4 Installing a Minifilter Driver\n\nAll the Windows Operating systems including Windows XP and latter, minifilter\n\ndrivers are installed by using an INF (Setup Information file) and an installation\n\napplication. In all the previous operating systems, minifilter drivers were installed by the\n\nService Control Manager [Microsoft-5].\n\nThe \"INF-based installation\" means that the use of INF file is to copy files and to\n\nstore information in the registry. The system does not depend on a single INF file for the\n\nwhole installation.\n\n**3.4.1 Creating an INF File for a Minifilter Driver**\n\nAn INF file for a file system minifilter driver is very important for installing\n\nthe minifilter drivers. An INF file generally contains the following sections:\n\n1. Version (required)\n\n2. DestinationDirs (optional but recommended)\n\n3. DefaultInstall (required)\n\n4. DefaultInstall.Services (required)\n\n5. ServiceInstall (required)\n\n6. AddRegistry (required)\n\n7. DefaultUninstall (optional)\n\n8. DefaultUninstall.Services (optional)\n\n9. Strings (required)\n\n27\n\n\n-----\n\n**3.4.1.1 Version Section (required)**\n\nThe Version section specifies a class and GUID. These class and GUID\n\ncharacteristics are used to determine the type of minifilter driver. This can be\n\nshown in the following code example.\n\n**[Version]**\n**Signature** = \"$WINDOWS NT$\"\n**Class** = \"ActivityMonitor\"\n**ClassGuid** = {b86dff51-a31e-4bac-b3cf-e8cfe75c9fc2}\n**Provider** = %v@t%\n**DriverVer** = 10/09/2001,1.0.0.0\n\nEntry Value\n\n**Signature** \"$WINDOWS NT$\"\n\n**Class** Specifies the class name for the minifilter driver\n\n**ClassGuid** Specifies the GUID for the minifilter driver\n\n**Provider** The name of the software company which is developing the drivers\n\n**DriverVer** Specifies the driver version\n\n**CatalogFile This field is empty for non-antivirus minifilter drivers.**\n\nThis filed contains the name of a WHQL-supplied catalog file for Antivirus\nminifilter drivers which are signed.\n\nTable 3.1 Table describing the contents of the version section in a INF file [Microsoft-3].\n\nTable 3.1 describes the version section of a INF file.\n\n28\n\n|Entry|Value|\n|---|---|\n|Signature|\"$WINDOWS NT$\"|\n|Class|Specifies the class name for the minifilter driver|\n|ClassGuid|Specifies the GUID for the minifilter driver|\n|Provider|The name of the software company which is developing the drivers|\n|DriverVer|Specifies the driver version|\n|CatalogFile|This field is empty for non-antivirus minifilter drivers. This filed contains the name of a WHQL-supplied catalog file for Antivirus minifilter drivers which are signed.|\n\n\n-----\n\n**3.4.1.2 DestinationDirs Section (optional but recommended)**\n\nThis section specifies the directories where minifilter driver and\n\napplication files will be copied.\n\nIn both DestinationDirs Section and ServiceInstall section, well-known\n\nsystem directories can be specified by system-defined numeric values. In the\n\nfollowing code example, the value 12 refers to the Drivers directory\n\n(%windir%\\system32\\drivers on Windows NT-based platforms), and the value\n\n10 refers to the Windows directory (%windir%) [Microsoft-3].\n\n**[DestinationDirs]**\n**DefaultDestDir** = 12\n**Mafiltertool.DriverFiles** = 12\n**Mafiltertool.UserFiles** = 10,FltMgr\n\n**3.4.1.3 DefaultInstall Section (required)**\n\nThe DefaultInstall section makes use of a CopyFiles directive. This\n\ndirective can be used to copy the minifilter driver's driver files and user\napplication files to the targets directories that are enlisted in the\n\n_DestinationDirs section [Microsoft-3]._\n\n**3.4.1.4 Strings Section (required)**\n\nThe Strings section defines each %strkey% token that is used in\n\nthe INF file. The following code example shows a typical Strings section\n\n[Microsoft-3].\n\n**[Strings]**\n**V@t** = \"Vinay@TAMUCC\"\n**ServiceDescription       = \"Malprober Mini-Filter Driver\"**\n**ServiceName             = \"Malprober\"**\n**DriverName** = \"Malprober\"\n**DiskId1** = \"PassThrough Device Installation Disk\"\n\n29\n\n\n-----\n\n**RegInstancesSubkeyName  = \"Instances\"**\n**RegAltitudeValueName    = \"Altitude\"**\n**RegFlagsValueName       = \"Flags\"**\n**DefaultInstance** = \" Mafiltertool - Top Instance\"\n**Instance1.Name** = \" Mafiltertool - Middle Instance\"\n**Instance1.Altitude** = \"370000\"\n**Instance1.Flags** = 0x1 ; Suppress automatic attachments\n**Instance2.Name** = \" Mafiltertool - Bottom Instance\"\n**Instance2.Altitude** = \"365000\"\n**Instance2.Flags** = 0x1 ; Suppress automatic attachments\n**Instance3.Name** = \" Mafiltertool - Top Instance\"\n**Instance3.Altitude** = \"385000\"\n**Instance3.Flags** = 0x1 ; Suppress automatic attachments\n\n### 3.5 Analysis Process\n\nThe analysis process is started by allowing the given program to execute in an\n\nemulated environment. When the program executes, all the operating system services that\n\nare requested by the program are noted. Every action that involves communication with\n\nthe environment, requires some operating system services, it cannot directly interact with\n\nthe hardware.\n\nIn a windows operating system environment, the application cannot directly\n\ninteract with the windows native API. They are supposed to make use of the functions\n\nprovided by the operating system to interact with the operating system services.\n\nMalware writers make direct use of these native API to avoid any kind of DLL\n\ndependencies or confuse the virus scanners. This tool takes care of both Windows API\n\nfunction calls by an application and native API calls of an application, thus making the\n\nprobability of a malware escaping the analysis very low.\n\nThe tool is supposed to track which operating system services are used by a program.\n\nThis tracking requires us to solve two problems:\n\n30\n\n\n-----\n\n1. We must be able to track the execution of a malware process and also distinguish\n\nbetween the instructions executed by a malware process and the instructions\n\nexecuted by a normal process. This is very important because the emulated\n\nenvironment does not only run the instructions of the malware process, but also\n\nthe native operating system instructions and instructions of the other supporting\n\nprocesses.\n\n2. We need to make sure that the native API call or a windows API call is invoked\n\nwithout any kind of modification to the malware sample.\n\nThe PDBR (Page Directory Base Register) can be used to track the execution of the\n\ninstructions. This project creates a tool that makes use of virtual OS and minifilter drivers\n\nto detect malicious code. The following figure shows the overview of the malicious code\n\ndetection tool.\n\nresults from\n\nMalicious runs in Virtual OS with filter tool Detection\nCode Minifilter drivers Tool\n\nInstalled\n\ngenerate reports\n\nReport\n\nFigure 3.2 Overview of the Malicious Code Detection Tool\n\n31\n\n\n-----\n\n### 4. EVALUATION AND RESULTS\n\nTo demonstrate the capability of the malware tool in successfully monitoring the\n\nactions of malicious code, the tool runs dynamic tests on current malware samples. Then\n\nthe results of the tool are compared to the solutions provided by various anti-virus\n\nproviders. The ultimate goal of the evaluation is to determine till what extent our analysis\n\nresults match the characterizations provided by this well-known anti-virus vendor.\n\nFor the selection of our test subjects, we make use of Symantec’s list of the most\n\nprevalent malware samples that are published. Unfortunately, it is not possible to obtain\n\nsamples for all entries on these lists. However, we select some set of different malware\n\nprograms that represent a good mix of different malicious code variants currently popular\n\non the Internet. Some of these samples may be packed using different executable packer\n\nprograms; others may not be recognized as valid Windows PE executables. From this\n\npool, we choose one working sample for each malware type. Then, we scan all samples\n\nfor our experiments by the online virus scanner provided by Symantec and make sure that\n\nthey were all recognized correctly. There can be differences between the results of our\n\ntool and the virus descriptions of the various anti-virus providers [Kirda E, Ulrich 2006].\n\nThe detection tool was also able to recognize many viruses that are enlisted\n\nneither on Symantec’s anti-virus list nor on Kaspersky’s anti-virus list. The technical\n\ndetail of malware includes the files, registry, processes and services affected by the\n\nmalware. Generally these changes by a particular virus are not the same on different\n\ncomputers. The probable reason can be that the malicious code chooses random file\n\nnames or a name from a list of options that are not exhaustively covered by the malware\n\ndescription. Another possible reason for the variation in output can be analysis of a\n\n32\n\n\n-----\n\nmalware variant rather than the malware about which the virus scanner has published the\n\ntechnical details.\n\nThe following table shows some malwares that were analyzed by the tool and\n\ncompared to the results of the Symantec anti-virus list.\n\n**Malware Name** **File** **Registry** **Process** **Service**\n\n**W32.Storm.Worm** Yes P P P\n\n**W32.HLLW.Doomsjuice** Yes P P P\n\n**W32.Sality.AE** Yes P P P\n\n**W32.Qquzlzb.exe** No No No No\n\n**W32.Srvcp.exe** No No No No\n\nTable 4.1 MalProber Test Results\n\nIn the above figure ‘P’ refers to partial matches. The partial matches occur due to\n\nthe malware dependency on the target system. This dependency occurs due to the systems\n\nexecution environment. Generally files are also dependent on the target system but the\n\ncore files that are created or affected by the malware are always the same.\n\nAlso there are few malware samples listed above whose virus definitions were not\n\nfound on the Symantec’s anti-virus list. These viruses were detected by our tool.\n\nWhenever some normal process is analyzed, the tool displays the changes made\n\nby the program to the system. This tool can also be handy for people who want to study\n\nthe nature of their processes.\n\nThe following steps describe the process of analyzing a malware or a normal\nprocess.\n\n33\n\n|Malware Name|File|Registry|Process|Service|\n|---|---|---|---|---|\n|W32.Storm.Worm|Yes|P|P|P|\n|W32.HLLW.Doomsjuice|Yes|P|P|P|\n|W32.Sality.AE|Yes|P|P|P|\n|W32.Qquzlzb.exe|No|No|No|No|\n|W32.Srvcp.exe|No|No|No|No|\n\n\n-----\n\nStep 1: Installing the Malprober Driver\n\n**1.** Go to the project folder\n\n**2.** Open the directory /Malware Analyzer/Driver\n\n**3.** Install the minifilter drivers by right clicking the Malprober.inf and selecting\n\n“install”.\n\nFigure 4.1 Installing Malprober Driver\n\nThe above figure shows how to install the Malprober Minifilter Driver.\n\n34\n\n\n-----\n\nStep 2: Starting the Malprober Service\n\n**1.** Open a command prompt on the virtual Operating System.\n\n**2.** Type the following command to start the tool\n\nCommand: sc start malprober\n\nFigure 4.2 Starting the Malprober service\n\nThe above figure shows how to start the Malprober Service.\n\n35\n\n\n-----\n\nStep 3: Testing a program with Malprober\n\n**1.** Type the following command for testing the sample program and generating reports.\n\nCommand: u_malanalyze.exe usbview.exe\n\nFigure 4.3 Testing usbview.exe with Malprober Tool\n\nThe above figure shows how a program named “usbview.exe” is tested with the\n\nMalprober. Once we run the tool, the tool generates a report for the binary. The generic\n\nreport contains all the file operations, registry and timestamp changes made by the binary\n\nunder analysis. At the end of the report, there is an automated analysis of the program\n\nbehavior.\n\n36\n\n\n-----\n\n#### 4.1 Sample Reports\n\n**Sample#1**\n\n**A genuine program. The following is the report for usbview.exe.**\n\n1. The program created the following new files\n--------------------------------------------------/*========================================*/\n\n2. The program opened the following files\n--------------------------------------------------/*========================================*/\n\n3. These files are read by the program\n--------------------------------------------------/*========================================*/\n\n4. These files are written into by the program\n--------------------------------------------------/*========================================*/\n\n5. The following files security permissions are changed\n--------------------------------------------------/*========================================*/\n\n6. These files are deleted by the program\n--------------------------------------------------/*========================================*/\n\n7. These files are sent ioctl command\n--------------------------------------------------/*========================================*/\n\n8. The timestamps are changed for the following files\n--------------------------------------------------/*========================================*/\n\n37\n\n\n-----\n\n9. The following registry keys are created\n--------------------------------------------------\\Registry\\Machine\\SOFTWARE\\Microsoft\\Cryptography\\RNG\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\SystemCertificates\\My\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330-500\\Software\\Microsoft\\Windows\nNT\\CurrentVersion\\Winlogon\n\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Control\\DeviceClasses\n/*========================================*/\n\n10. The following registry key values set\n--------------------------------------------------\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\RNG Seed\n/*========================================*/\n\n11. The following registry keys are deleted\n--------------------------------------------------/*========================================*/\n\n12. The following processes are created\n--------------------------------------------------/*========================================*/\n\n/*===========================================*/\n\nAutomated analysis of the program behavior\n\n/*===========================================*/\n\n*********\n##### The program seems to be a genuine program#####\n****************\n\n38\n\n\n-----\n\n**Sample#2**\n\n**A little suspicious program. The following is the report for msrll.exe.**\n\n1. The program created the following new files\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\mfm\\msrll.exe\n/*========================================*/\n\n2. The program opened the following files\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\ws2_32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\ws2help.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\shell32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\WinSxS\\x86_Microsoft.Windows.CommonControls_6595b64144ccf1df_6.0.2600.2180_x-ww_a84f1ff9\\comctl32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\WindowsShell.Manifest\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\wininet.dll\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Desktop\\freemalwares\\msrll.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\mfm\\msrll.exe\n/*========================================*/\n\n3. These files are read by the program\n--------------------------------------------------/*========================================*/\n\n4. These files are written into by the program\n--------------------------------------------------/*========================================*/\n\n5. The following files security permissions are changed\n--------------------------------------------------/*========================================*/\n\n6. These files are deleted by the program\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\mfm\\msrll.exe\n/*========================================*/\n\n7. These files are sent ioctl command\n--------------------------------------------------/*========================================*/\n\n39\n\n\n-----\n\n8. The timestamps are changed for the following files\n--------------------------------------------------/*========================================*/\n\n9. The following registry keys are created\n--------------------------------------------------\\Registry\\Machine\\SOFTWARE\\Microsoft\\Cryptography\\RNG\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\n/*========================================*/\n\n10. The following registry key values set\n--------------------------------------------------\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\RNG Seed\n/*========================================*/\n\n11. The following registry keys are deleted\n--------------------------------------------------/*========================================*/\n\n12. The following processes are created\n--------------------------------------------------/*========================================*/\n\n/*===========================================*/\n\nAutomated analysis of the program behavior\n\n/*===========================================*/\n\nThe program deletes itself\n\n*********\n##### The program is a little suspicious program#####\n****************\n\n40\n\n\n-----\n\n**Sample#3**\n\n**A quite suspicious program. The following is the report for DoomJuice2.exe.**\n\n1. The program created the following new files\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\intrenat.exe\n\\Device\\HarddiskVolume1\\sync-src-1.00.tbz\n\\Device\\HarddiskVolume1\\WINDOWS\\sync-src-1.00.tbz\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\sync-src-1.00.tbz\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temp\\sync-src-1.00.tbz\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\sync-src-1.00.tbz\n/*========================================*/\n\n2. The program opened the following files\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\ws2_32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\ws2help.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\intrenat.exe\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Desktop\\freemalwares\\DoomJuice2.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\wininet.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\WinSxS\\x86_Microsoft.Windows.CommonControls_6595b64144ccf1df_6.0.2600.2180_x-ww_a84f1ff9\\comctl32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\WindowsShell.Manifest\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\shell32.dll\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet Files\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\History\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet\nFiles\\Content.IE5\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet\nFiles\\Content.IE5\\index.dat\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Cookies\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Cookies\\index.dat\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\History\\History.IE5\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local\nSettings\\History\\History.IE5\\index.dat\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rasapi32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rasman.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\tapi32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rtutils.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\winmm.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\sensapi.dll\n\\Device\\HarddiskVolume1\\AUTOEXEC.BAT\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\mswsock.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\dnsapi.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\winrnr.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rasadhlp.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\hnetcfg.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\wshtcpip.dll\n/*========================================*/\n\n41\n\n\n-----\n\n3. These files are read by the program\n--------------------------------------------------\\Device\\HarddiskVolume1\\AUTOEXEC.BAT\n/*========================================*/\n\n4. These files are written into by the program\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\intrenat.exe\n\\Device\\HarddiskVolume1\\sync-src-1.00.tbz\n\\Device\\HarddiskVolume1\\WINDOWS\\sync-src-1.00.tbz\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\sync-src-1.00.tbz\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temp\\sync-src-1.00.tbz\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\sync-src-1.00.tbz\n/*========================================*/\n\n5. The following files security permissions are changed\n--------------------------------------------------/*========================================*/\n\n6. These files are deleted by the program\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\intrenat.exe\n/*========================================*/\n\n7. These files are sent ioctl command\n--------------------------------------------------/*========================================*/\n\n8. The timestamps are changed for the following files\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\intrenat.exe\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet Files\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\History\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet\nFiles\\Content.IE5\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet\nFiles\\Content.IE5\\index.dat\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Cookies\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Cookies\\index.dat\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\History\\History.IE5\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local\nSettings\\History\\History.IE5\\index.dat\n/*========================================*/\n\n42\n\n\n-----\n\n9. The following registry keys are created\n--------------------------------------------------\\Registry\\Machine\\SOFTWARE\\Microsoft\\Cryptography\\RNG\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Tracing\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330-500\\Software\\Microsoft\\Windows\nNT\\CurrentVersion\\Winlogon\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Connections\n\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Hardware\nProfiles\\0001\\Software\\Microsoft\\windows\\CurrentVersion\\Internet Settings\n\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Services\\Tcpip\\Parameters\n/*========================================*/\n\n10. The following registry key values set\n--------------------------------------------------\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run Gremlin\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\RNG Seed\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders Cache\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Cache\\Paths\nDirectory\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Cache\\Paths\nPaths\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path1 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path2 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path3 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path4 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path1 CacheLimit\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path2 CacheLimit\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path3 CacheLimit\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path4 CacheLimit\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders Cookies\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders History\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\nCommon AppData\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders AppData\n\n43\n\n\n-----\n\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings MigrateProxy\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings ProxyEnable\n\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Hardware\nProfiles\\0001\\Software\\Microsoft\\windows\\CurrentVersion\\Internet Settings ProxyEnable\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Connections SavedLegacySettings\n/*========================================*/\n\n11. The following registry keys are deleted\n--------------------------------------------------\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings  ProxyServer\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings  ProxyOverride\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings  AutoConfigURL\n/*========================================*/\n\n12. The following processes are created\n--------------------------------------------------/*========================================*/\n\n/*===========================================*/\n\nAutomated analysis of the program behavior\n\n/*===========================================*/\n\nThe program adds a program which will run automatically on next login\n\nThe program changes the internet settings\n\nThe program writes to executables\n\n*********\n##### The program is a quite suspicious program#####\n****************\n\n44\n\n\n-----\n\n**Sample#4**\n\n**A very very suspicious program. The following is the report for qquzlzb.exe**\n\n1. The program created the following new files\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\qquzlzb.exe\n/*========================================*/\n\n2. The program opened the following files\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\crtdll.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\wsock32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\ws2_32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\ws2help.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\wininet.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\WinSxS\\x86_Microsoft.Windows.CommonControls_6595b64144ccf1df_6.0.2600.2180_x-ww_a84f1ff9\\comctl32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\WindowsShell.Manifest\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Desktop\\freemalwares\\qquzlzb.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\qquzlzb.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\Prefetch\\QQUZLZB.EXE-1E41BD18.pf\n\\Device\\HarddiskVolume1\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\ntdll.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\kernel32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\unicode.nls\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\locale.nls\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\sorttbls.nls\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\advapi32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rpcrt4.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\secur32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\user32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\gdi32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\crypt32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\msvcrt.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\msasn1.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\oleaut32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\ole32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\shlwapi.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\sortkey.nls\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\ctype.nls\n\\Device\\HarddiskVolume1\\WINDOWS\\WINDOWSSHELL.MANIFEST\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\shell32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\comctl32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\mswsock.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\hnetcfg.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\wshtcpip.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\dnsapi.dll\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet\nFiles\\Content.IE5\\index.dat\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\winrnr.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\wldap32.dll\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Cookies\\index.dat\n\n45\n\n\n-----\n\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local\nSettings\\History\\History.IE5\\index.dat\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\urlmon.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\version.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rasapi32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rasman.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\netapi32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\tapi32.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rtutils.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\winmm.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\sensapi.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\userenv.dll\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet Files\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\History\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet\nFiles\\Content.IE5\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Cookies\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\History\\History.IE5\n\\Device\\HarddiskVolume1\\AUTOEXEC.BAT\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rasadhlp.dll\n/*========================================*/\n\n3. These files are read by the program\n--------------------------------------------------\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Desktop\\freemalwares\\qquzlzb.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\Prefetch\\QQUZLZB.EXE-1E41BD18.pf\n\\Device\\HarddiskVolume1\\WINDOWS\\qquzlzb.exe\n\\Device\\HarddiskVolume1\\AUTOEXEC.BAT\n/*========================================*/\n\n4. These files are written into by the program\n--------------------------------------------------/*========================================*/\n\n5. The following files security permissions are changed\n--------------------------------------------------/*========================================*/\n\n6. These files are deleted by the program\n--------------------------------------------------/*========================================*/\n\n7. These files are sent ioctl command\n--------------------------------------------------/*========================================*/\n\n46\n\n\n-----\n\n8. The timestamps are changed for the following files\n--------------------------------------------------\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet Files\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\History\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet\nFiles\\Content.IE5\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temporary Internet\nFiles\\Content.IE5\\index.dat\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Cookies\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Cookies\\index.dat\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\History\\History.IE5\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local\nSettings\\History\\History.IE5\\index.dat\n/*========================================*/\n\n9. The following registry keys are created\n--------------------------------------------------\\Registry\\Machine\\SOFTWARE\\Microsoft\\Cryptography\\RNG\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Tracing\n\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Services\\Tcpip\\Parameters\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330-500\\Software\\Microsoft\\Windows\nNT\\CurrentVersion\\Winlogon\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Connections\n\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Hardware\nProfiles\\0001\\Software\\Microsoft\\windows\\CurrentVersion\\Internet Settings\n/*========================================*/\n\n10. The following registry key values set\n--------------------------------------------------\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\RNG Seed\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run Update\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders Cache\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Cache\\Paths\nDirectory\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Cache\\Paths\nPaths\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path1 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path2 CachePath\n\n47\n\n\n-----\n\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path3 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path4 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path1 CacheLimit\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path2 CacheLimit\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path3 CacheLimit\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path4 CacheLimit\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders Cookies\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders History\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\nCommon AppData\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders AppData\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings MigrateProxy\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings ProxyEnable\n\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Hardware\nProfiles\\0001\\Software\\Microsoft\\windows\\CurrentVersion\\Internet Settings ProxyEnable\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Connections SavedLegacySettings\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap ProxyBypass\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap IntranetName\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap UNCAsIntranet\n/*========================================*/\n\n11. The following registry keys are deleted\n--------------------------------------------------\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings  ProxyServer\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings  ProxyOverride\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings  AutoConfigURL\n/*========================================*/\n\n12. The following processes are created\n--------------------------------------------------most probably creates a short lived or hidden process: pid = 1464\n/*========================================*/\n\n48\n\n\n-----\n\n/*===========================================*/\n\nAutomated analysis of the program behavior\n\n/*===========================================*/\n\nThe program adds a program which will run automatically on next login\n\nThe program changes the internet settings\n\n*********\n##### The program is a very very suspicious program#####\n****************\n\n49\n\n\n-----\n\n**Sample#5**\n\n**A quite suspicious program. The following is the report for msnbot.exe**\n\n1. The program created the following new files\n--------------------------------------------------/*========================================*/\n\n2. The program opened the following files\n--------------------------------------------------/*========================================*/\n\n3. These files are read by the program\n--------------------------------------------------/*========================================*/\n\n4. These files are written into by the program\n--------------------------------------------------/*========================================*/\n\n5. The following files security permissions are changed\n--------------------------------------------------/*========================================*/\n\n6. These files are deleted by the program\n--------------------------------------------------/*========================================*/\n\n7. These files are sent ioctl command\n--------------------------------------------------/*========================================*/\n\n8. The timestamps are changed for the following files\n--------------------------------------------------/*========================================*/\n\n9. The following registry keys are created\n--------------------------------------------------\\Registry\\Machine\\SOFTWARE\\Microsoft\\Cryptography\\RNG\n\n50\n\n\n-----\n\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\n\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet001\\Services\\Tcpip\\Parameters\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MountPoints2\\{edcc221d-ac40-11de-a14b806d6172696f}\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MountPoints2\\{2b820c76-8d25-11df-80c4000c29f8a390}\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MountPoints2\\{9bca3804-8d21-11df-80c3806d6172696f}\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MountPoints2\\{edcc221a-ac40-11de-a14b806d6172696f}\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\WinTrust\\Trust Providers\\Software Publishing\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\n/*========================================*/\n\n10. The following registry key values set\n--------------------------------------------------\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\RNG Seed\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders Cache\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Cache\\Paths\nDirectory\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Cache\\Paths\nPaths\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path1 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path2 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path3 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path4 CachePath\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path1 CacheLimit\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path2 CacheLimit\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path3 CacheLimit\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\\Cache\\Paths\\path4 CacheLimit\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders Cookies\n\n51\n\n\n-----\n\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders History\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders Personal\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MountPoints2\\{edcc221d-ac40-11de-a14b806d6172696f} BaseClass\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MountPoints2\\{2b820c76-8d25-11df-80c4000c29f8a390} BaseClass\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MountPoints2\\{9bca3804-8d21-11df-80c3806d6172696f} BaseClass\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MountPoints2\\{edcc221a-ac40-11de-a14b806d6172696f} BaseClass\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\nCommon Documents\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders Desktop\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\nCommon Desktop\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap ProxyBypass\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap IntranetName\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap UNCAsIntranet\n\\REGISTRY\\USER\\S-1-5-21-854245398-113007714-682003330500\\Software\\Microsoft\\Windows\\ShellNoRoam\\MUICache c:\\a.bat\n\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run Windows Taskmanager\n/*========================================*/\n\n11. The following registry keys are deleted\n--------------------------------------------------/*========================================*/\n\n12. The following processes are created\n--------------------------------------------------most probably creates a short lived process: pid = 4864\nmost probably creates a short lived process: pid = 4872\n/*========================================*/\n\n/*===========================================*/\n\nAutomated analysis of the program behavior\n\n52\n\n\n-----\n\n/*===========================================*/\n\nThe program changes the internet settings\n\nThe program adds a program which will run automatically on next login\n\n*********\n##### The program is a quite suspicious program#####\n****************\n\n53\n\n\n-----\n\n**Sample#6**\n\nA quite suspicious program. The following is the report for 440acfc139f1ea0b8e879\nbf8990a0f92.exe\n\n1. The program created the following new files\n--------------------------------------------------\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temp\\~DF2FEF.tmp\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\csrss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\smss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\lsass.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\services.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\winlogon.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\Paraysutki_VM_Communit\ny\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\msvbvm60.dll\n\\Device\\HarddiskVolume1\\Documents and Settings\\Administrator\\Local Settings\\Temp\\~DF3B27.tmp\n/*========================================*/\n\n2. The program opened the following files\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\msvbvm60.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\rpcss.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\uxtheme.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\clbcatq.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\comres.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\scrrun.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\mfc42.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\sxs.dll\n\\Device\\HarddiskVolume1\\Documents and\nSettings\\Administrator\\Desktop\\malwares\\440acfc139f1ea0b8e879bf8990a0f92.exe\\malware.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\csrss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\smss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\lsass.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\services.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\winlogon.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\Paraysutki_VM_Communit\ny\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\msvbvm60.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\apphelp.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\AppPatch\\sysmain.sdb\n/*========================================*/\n\n3. These files are read by the program\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\scrrun.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\csrss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\smss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\lsass.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\services.exe\n\n54\n\n\n-----\n\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\winlogon.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\Paraysutki_VM_Communit\ny\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\msvbvm60.dll\n/*========================================*/\n\n4. These files are written into by the program\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\csrss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\smss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\lsass.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\services.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\winlogon.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\Paraysutki_VM_Communit\ny\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\msvbvm60.dll\n/*========================================*/\n\n5. The following files security permissions are changed\n--------------------------------------------------/*========================================*/\n\n6. These files are deleted by the program\n--------------------------------------------------/*========================================*/\n\n7. These files are sent ioctl command\n--------------------------------------------------/*========================================*/\n\n8. The timestamps are changed for the following files\n--------------------------------------------------\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\csrss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\smss.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\lsass.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\services.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\winlogon.exe\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\Paraysutki_VM_Communit\ny\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\\msvbvm60.dll\n\\Device\\HarddiskVolume1\\WINDOWS\\system32\\~A~m~B~u~R~a~D~u~L~\n/*========================================*/\n\n9. The following registry keys are created\n\n55\n\n\n-----\n\n--------------------------------------------------\\Registry\\Machine\\SOFTWARE\\Microsoft\\Cryptography\\RNG\n/*========================================*/\n\n10. The following registry key values set\n--------------------------------------------------\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Cryptography\\RNG Seed\n/*========================================*/\n\n11. The following registry keys are deleted\n--------------------------------------------------/*========================================*/\n\n12. The following processes are created\n--------------------------------------------------most probably creates a short lived or hidden process: pid = 400\n/*========================================*/\n\n/*===========================================*/\n\nAutomated analysis of the program behavior\n\n/*===========================================*/\n\nThe program writes to executables\n\n*********\n##### The program is a quite suspicious program#####\n****************\n\n56\n\n\n-----\n\n## 5. CONCLUSION AND FUTUREWORK\n\nBecause of the time gap between the vulnerability that comes into existence due\n\nto the appearance of new malware and the point where a solution for the new malware is\n\ngenerated by the anti-virus provider, every new malware poses a serious threat to\n\ncomputer systems. This dynamic tool analyzes the behavior of an unknown program by\n\nexecuting the code in a virtual environment.\n\nThe ultimate goal of the dynamic analysis tool is to gain a quick understanding of\n\nthe malicious activity performed by malicious code with the central target of minimizing\n\nthe time frame between the creation of the vulnerability and generation of solution to the\n\nmalware attack. This dynamic tool has many advantages. One of the main advantage is\n\nthe report generated by the tool is simple and easy to understand by an analyst. All the\n\nevents are listed in separate paragraph, which makes it easy to understand. Because the\n\nanalysis is performed in a virtual environment, the overhead is less.\n\nSome sophisticated malware can detect the presence of a virtual environment. In\n\norder to overcome this disadvantage, thwarting virtual environment detection techniques\n\nare implemented. These techniques work by hiding the VME (Virtual Machine\n\nEnvironment) artifacts in memory and VME specific processor instructions from\n\nmalware.\n\nThis dynamic tool makes use of a minifilter driver for tracking the security related\n\noperating system events including Windows API functions and native kernel calls. Once\n\na minifilter driver is provided with a program name, it notifies the tool about the activities\n\nof the program.\n\n57\n\n\n-----\n\nThis dynamic tool generates reports for the program tested based on the input\n\nparameters and the execution environment. Generally all programs have some decision\n\nmaking branches in it, so there can be many ways a program can be executed. The path of\n\nexecution depends on the input parameters and the execution environment. This tool\n\nanalyses the input program for a specific path of execution. But the program can be\n\nexecuted in many different ways, so there is a need for extending this tool to analyze all\n\nthe paths of execution. This thing can be achieved by making copies of the binaries of the\n\nprogram that is analyzed.\n\nIn the future this tool can be improved to include more classified and detailed\n\nreports. The tool is run on windows command prompt, it can be improved to a GUI\n\n(Graphical User Interface) based tool. Also there is a scope of creating a database to store\n\nthe signatures of detected viruses and use this database whenever necessary.\n\n58\n\n\n-----\n\n**BIBLIOGRAPHY AND REFERENCES**\n\n[Andreas, Ulrich 2006] _Dynamic analysis of malicious code. Journal of Computer_\nViruses, (2006) 2:67–77.\n\n[Bellard, F] Qemu,a fast and portable dynamic translator. In: Usenix Annual Technical\nConference, 2005.\n\n[Christodorescu,M., Jha, S] Static analysis of executables to detect malicious patterns. In:\nUsenix Security Symposium, 2003.\n\n[Duan H, Guan Y, Zhang J] AMCAS: An Automatic Malicious Code Analysis System. The\nNinth International Conference on Web-Age Information Management.\n\n[Feng M, Gupta R] _Detecting Virus Mutations Via Dynamic Matching._ ICSM 2009,\nEdmonton, Canada.\n\n[Kent K, Mell P, Nusbaum J] _Guide to Malware Incident Prevention and Handling._\nSpecial Publication 800-83, NIST.\n\n[Kirda E, Ulrich 2006] _TTAnalyze: A Tool for Analyzing Malware._ Ikarus Software &\nTechnical University of Vienna.\n\n[Microsoft-1] Microsoft Filter Drivers, Available from\nhttp://www.microsoft.com/whdc/driver/filterdrv/default.mspx\n\n[Microsoft-2] Microsoft Filter Manager, Available from\n\n[Microsoft-3] Microsoft INF file, Available from http://msdn.microsoft.com/enus/library/ms924764.aspx\n\n[Microsoft-4] Microsoft Load Order Groups, Available from\nhttp://www.microsoft.com/whdc/driver/filterdrv/alt-range.mspx\n\n[Microsoft-5] Microsoft Minifilter Architecture, Available from\nhttp://msdn.microsoft.com/en-us/library/ff541613(v=VS.85).aspx\n\n[Microsoft-6] MSDN Simrep Filters, Available from http://msdn.microsoft.com/enus/library/ff556746(VS.85).aspx\n\n[Microsoft-7] Microsoft WDK, Available from\nhttp://www.microsoft.com/whdc/DevTools/WDK/WDKpkg.mspx\n\n[Microsoft-8] Microsoft Windows Service, Available from\nhttp://support.microsoft.com/kb/251192\n\n59\n\n\n-----\n\n[OSR 2010] OSR Driver Development, Available from\nhttp://www.osronline.com/custom.cfm?name=login_joinok.cfm\n\n[Offensive Computing 2009] Offensive Computing. http://www.offensivecomputing.net\n\n[Quist D, Val Smith] Detecting the Presence of Virtual Machines Using the Local Data\n_Table. Offensive Computing http://www.offensivecomputing.net/_\n\n[Redpill] Redpill Available from http://www.invisiblethings.org/papers/redpill.html\n\n[Rothman M, Zimmer V] Virus Scanning of Input/Output Traffic of a Computer System.\nUnites States Patent Application Publication, Pub No. US 2005/0216759 A1.\n\n[Symantec 2008] Symantec Auraax, Available from\nhttp://www.symantec.com/security_response/writeup.jsp?docid=2008-092409-470499&tabid=2\n\n[Wiki 2009] Wikipedia, Available from www.wikipedia.com/\n\n60\n\n\n-----\n\n### APPENDIX A. STARTING A VIRTUAL OPERATING SYSTEM\n\n1. Start All Programs    VMWare    VMWare    Workstation\n\nThe figure below shows how to start a virtual operating system.\n\nFigure A.1 Starting Virtual Operating System\n\n2. File    Open and then select a virtual operating system which is to be loaded\n\n61\n\n\n-----\n\n3. Select “Power on this Virtual Machine”\n\nThe figure below shows how to select a particular virtual machine.\n\nFigure A.2 Selecting a Virtual Disk\n\n4. This start the Virtual Machine after the login credentials are specified\n\n62\n\n\n-----\n\n**APPENDIX B. INSTALLING MINIFILTER**\n\n**1.** Go to the project folder\n\n**2.** Open the directory /Malware Analyzer/Driver\n\n**3.** Install the minifilter drivers by right clicking the matool.inf and selecting “install”\n\nThis step installs the drivers and places files required by the project in the correct\n\ndestinations. The figure below shows how to install a mini filter driver.\n\nFigure B.1 Installing Minifilter Driver\n\n63\n\n\n-----\n\n**APPENDIX C. STARTING THE TOOL**\n\n**1.** Open a command prompt on the virtual Operating System.\n\n**2.** Type the following command to start the tool\n\nCommand: sc start malprober\n\nThis command makes use of the sc service of Windows. This service can be used\n\nto start services on the Windows Operating System [Microsoft-8]. The figure\n\nbelow shows that a minifilter service is started.\n\nFigure C.1 Starting the Malprober Service\n\n64\n\n\n-----\n\n**APPENDIX D. TESTING A SAMPLE PROGRAM**\n\n**1.** After starting the tool, navigate to the project folder that has the\n\nu_malanalyze.exe file. This is the main executable of the tool.\n\n**2.** Place the sample program to be tested in the same folder as u_malanalyze.exe\n\nis in.\n\n**3.** Type the following command for testing the sample program and generating\n\nreports.\n\nCommand: u_malanalyze.exe <sample program executable>\n\nSample program is the executable that is to be analyzed.\n\nThese reports can be analyzed to classify the nature of the given sample program\n\nas malicious or a normal program\n\n65\n\n\n-----\n\n**APPENDIX E. INF FILE FOR THE MINIFILTER**\n```\n;;;\n;;; PassThrough\n;;;\n;;;\n;;; Copyright (c) 1999 - 2001, Microsoft Corporation\n;;;\n[Version]\nSignature = \"$Windows NT$\"\nClass = \"ActivityMonitor\"           \n;This is determined by the work this filter driver does\nClassGuid = {b86dff51-a31e-4bac-b3cf-e8cfe75c9fc2}  \n;This value is determined by the Class\nProvider = %vat%\nDriverVer = 06/16/2007,1.0.0.1\nCatalogFile = passthrough.cat\n[DestinationDirs]\nDefaultDestDir     = 12\nMiniFilter.DriverFiles = 12      ;%windir%\\system32\\drivers\n;;\n;; Default install sections\n;;\n\n```\n66\n\n\n-----\n\n```\n[DefaultInstall]\nOptionDesc     = %ServiceDescription%\nCopyFiles      = MiniFilter.DriverFiles\n[DefaultInstall.Services]\nAddService     = %ServiceName%,,MiniFilter.Service\n;;\n;; Default uninstall sections\n;;\n[DefaultUninstall]\nDelFiles  = MiniFilter.DriverFiles\n[DefaultUninstall.Services]\nDelService = %ServiceName%,0x200   \n;Ensure service is stopped before deleting\n;\n; Services Section\n;\n[MiniFilter.Service]\nDisplayName = %ServiceName%\nDescription = %ServiceDescription%\nServiceBinary =%12%\\%DriverName%.sys          \n;%windir%\\system32\\drivers\\\nDependencies = \"FltMgr\"\n\n```\n67\n\n\n-----\n\n```\nServiceType = 2         ;SERVICE_FILE_SYSTEM_DRIVER\nStartType = 3         ;SERVICE_DEMAND_START\nErrorControl   = 1         ;SERVICE_ERROR_NORMAL\nLoadOrderGroup = \"FSFilter Activity Monitor\"\nAddReg = MiniFilter.AddRegistry\n;\n; Registry Modifications\n;\n[MiniFilter.AddRegistry]\nHKR,,\"DebugFlags\",0x00010001,0x0\nHKR,\"Instances\",\"DefaultInstance\",0x00000000,%DefaultInstance%\nHKR,\"Instances\\\"%Instance1.Name%,\"Altitude\",0x00000000,%Instance1\n.Altitude%\nHKR,\"Instances\\\"%Instance1.Name%,\"Flags\",0x00010001,%Instance1.Fl\nags%\n;\n; Copy Files\n;\n[MiniFilter.DriverFiles]\n%DriverName%.sys\n\n```\n68\n\n\n-----\n\n```\n[SourceDisksFiles]\npassthrough.sys = 1,,\n[SourceDisksNames]\n1 = %DiskId1%,,,\n;;\n;; String Section\n;;\n[Strings]\nvat           = \"Vinay@TAMUCC\"\nServiceDescription   = \"Malprober Mini-Filter Driver\"\nServiceName       = \"Malprober\"\nDriverName       = \"Malprober\"\nDiskId1         = \"PassThrough Device Installation Disk\"\n;Instances specific information.\nDefaultInstance     = \"PassThrough Instance\"\nInstance1.Name     = \"PassThrough Instance\"\nInstance1.Altitude   = \"370030\"\nInstance1.Flags     = 0x0      ; Allow all attachments\n\n```\n69\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/AV Tech/Minifilters for detection of Malware.pdf"
    ],
    "report_names": [
        "Minifilters for detection of Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5ffe400c-6025-44c2-9aa1-7c34a7a192b0",
            "created_at": "2023-01-06T13:46:38.469688Z",
            "updated_at": "2025-03-27T02:00:02.84172Z",
            "deleted_at": null,
            "main_name": "DragonOK",
            "aliases": [
                "Moafee",
                "BRONZE OVERBROOK",
                "G0017",
                "G0002",
                "Shallow Taurus"
            ],
            "source_name": "MISPGALAXY:DragonOK",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "7ebda3c6-1789-4d84-97cf-47fb18a0cb28",
            "created_at": "2022-10-25T15:50:23.78829Z",
            "updated_at": "2025-03-27T02:00:55.547275Z",
            "deleted_at": null,
            "main_name": "DragonOK",
            "aliases": [
                "DragonOK"
            ],
            "source_name": "MITRE:DragonOK",
            "tools": [
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "60d9c778-488b-459e-a2f6-9e48c607ba45",
            "created_at": "2022-10-25T16:47:55.606462Z",
            "updated_at": "2025-03-27T02:05:17.281676Z",
            "deleted_at": null,
            "main_name": "BRONZE OVERBROOK",
            "aliases": [
                "DragonOK ",
                "Samurai Panda ",
                "Temp.DragonOK ",
                "Danti "
            ],
            "source_name": "Secureworks:BRONZE OVERBROOK",
            "tools": [
                " DDKONG",
                " HelloBridge",
                " IsSpace",
                " NFLog Trojan",
                " PLAINTEE",
                " PlugX",
                " Rambo",
                "Aveo"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "340d1673-0678-4e1f-8b75-30da2f65cc80",
            "created_at": "2022-10-25T16:07:23.552036Z",
            "updated_at": "2025-03-27T02:02:09.85925Z",
            "deleted_at": null,
            "main_name": "DragonOK",
            "aliases": [
                "Bronze Overbrook",
                "Shallow Taurus"
            ],
            "source_name": "ETDA:DragonOK",
            "tools": [
                "Agent.dhwf",
                "CT",
                "Chymine",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "FF-RAT",
                "FormerFirstRAT",
                "Gen:Trojan.Heur.PT",
                "HTran",
                "HUC Packet Transmit Tool",
                "HelloBridge",
                "IsSpace",
                "KHRAT",
                "Kaba",
                "Korplug",
                "Mongall",
                "NFlog",
                "NewCT",
                "NfLog RAT",
                "PlugX",
                "Poison Ivy",
                "Rambo",
                "RedDelta",
                "SPIVY",
                "Sogu",
                "SysGet",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "TidePool",
                "Xamtrav",
                "brebsd",
                "ffrat",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535918,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1280849361,
    "ts_modification_date": 1475571191,
    "files": {
        "pdf": "https://archive.orkl.eu/70deff7e92069c4e53c66370fda393b42589fb2d.pdf",
        "text": "https://archive.orkl.eu/70deff7e92069c4e53c66370fda393b42589fb2d.txt",
        "img": "https://archive.orkl.eu/70deff7e92069c4e53c66370fda393b42589fb2d.jpg"
    }
}