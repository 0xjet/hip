{
    "id": "d9f34244-3de3-4ab0-b593-c73bedc09f49",
    "created_at": "2022-10-25T16:48:14.421089Z",
    "updated_at": "2025-03-27T02:11:55.137998Z",
    "deleted_at": null,
    "sha1_hash": "3f92bfbfdb0fee7eda8613fc3a6ff515ffceb972",
    "title": "Prince of Persia Game Over",
    "authors": "Palo Alto",
    "file_creation_date": "2016-06-29T03:47:34Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 236187,
    "plain_text": "**researchcenter.paloaltonetworks.com/2016/06/unit42-prince-of-persia-game-over/**\n\n## Summary\n\n[Unit 42 published a blog at the beginning of May titled “Prince of Persia,” in which we described the discovery of a](http://researchcenter.paloaltonetworks.com/2016/05/prince-of-persia-infy-malware-active-in-decade-of-targeted-attacks/)\ndecade-long campaign using a formerly unknown malware family, Infy, that targeted government and industry\ninterests worldwide.\n\nSubsequent to the publishing of this article, through cooperation with the parties responsible for the C2 domains,\nUnit 42 researchers successfully gained control of multiple C2 domains. This disabled the attacker’s access to their\nvictims in this campaign, provided further insight into the targets currently victimized in this operation, and enabled\nthe notification of affected parties.\n\n## Post Publication\n\nIn the week following the publication of the original blog, we observed no unusual changes to the C2 infrastructure.\nExisting domains did move to new IP addresses, as we had previously seen periodically. Some new install domains\nwere added, adhering to naming conventions of current domains (see appendix for new IOCs).\n\nThe attackers developed a new version (31), and we observed this deployed against a single Canadian target.\n\nThe file descriptions remained essentially the same (“CLMediaLibrary Dynamic Link Library V3”). Most importantly,\nthere was no change to the encoding key (now using offset 20, and offset 11 for second pass against URL\nencoding) that we had observed being used for the entire decade-long campaign, and documented in our previous\nblog. From this we conclude that the attackers were unaware of our initial report.\n\n## Sinkhole\n\nThrough cooperation with the parties responsible for the C2 domains, we took control of all but one of them,\ntransferring the A records to a server we controlled. This prevented the attackers from being able to subsequently\nmake any further changes to the domain configurations, issue commands to victims, or capture any further data for\nthe majority of victims. An analysis of connections after transfer suggests that the attackers may have used a thirdparty service to try to understand why they had suddenly lost almost all of their traffic. Figure 1 shows that tool, a\ngeographic representation of victim-C2 traffic, with all but one at that time now communicating with our sinkhole\nserver.\n\n\n-----\n\n_Figure 1 Graphical representation of victim traffic to C2_\n\n[We have since transferred sinkhole control to Shadowserver, whom we thank for subsequent victim notification &](https://www.shadowserver.org/wiki/)\n[remediation (https://www.shadowserver.org/wiki/pmwiki.php/Involve/GetReportsOnYourNetwork).](https://www.shadowserver.org/wiki/pmwiki.php/Involve/GetReportsOnYourNetwork)\n\n## Victims\n\nWe were able to analyze victim C2 traffic to understand who were victims of the Infy campaign. We identified 456\nmalware agents installed on 326 victim systems, in 35 countries. Figure 2 shows a geographical breakdown of\nvictim locations. We noted in our original blog the large amount of targeting of Iranian citizens in this campaign, we\nobserved almost one-third of all victims to be Iranian. Also of note was the low overall volume of victims, compared\nto, for example, crimeware campaigns.\n\n_Figure 2 Geographic location of victims. Please note that New Zealand has been omitted from this map only_\n_because we observed no victim activity there._\n\n## Versions\n\nIn our original blog, we noted two distinct primary variants of the Infy malware. In addition to the original “Infy”\n\n\n-----\n\nCombined with the low total number of victims, this suggests a great deal of care given to each individual campaign\ntarget. The large number of victims with both variants may relate to their complimentary feature set, or represent an\n“upgrade” path on victims from the original variant infection, later adding the “M” variant as targets appeared more\ncompelling to the attackers.\n\n_Figure 3 Breakdown of Infy vs. Infy “M” infections_\n\nFor the Infy “M” variant, we note that the majority of targets are using the latest version (7.8), and that none are\nusing the older 6.x versions at all (Figure 4). This suggests that these higher-value targets are paid much more\nattention, being kept up-to-date with the latest version.\n\nIn contrast, for the more basic original Infy variant, we note a full spectrum of versions installed (Figure 5), with\nmany victims on older versions – including the original, decade-old V1 – suggesting much less concern is paid to\nthese individual targets (note that we did observe a small number of the older 6.x versions but these do not\nannounce their version when connecting).\n\n\n-----\n\n_Figure 4 Infy “M” Victim versions_\n\n_Figure 5 Infy”Original” Victim versions_\n\n## Game Over\n\n\n-----\n\nbox4035[.]net – box4090[.]net (138.201.0.134). These were not observed in any sample C2 lists however.\nBestwebstat[.]com was sinkholed by another operator.\n\nSome victims infected with Infy versions 15-24 still used the C2 server us1s2[.]strangled[.]net, which remained in the\nhands of the attacker. In early June the attackers used this C2 to issue instructions to download new Infy “M” version\n8.0 from us1s2[.]strangled[.]net/bdc.tmp. This was the first time we had observed an Infy variant being directly\nupdated to Infy “M”. This used camouflage name “Macromedia v4”, changed from “v3” seen in Infy v31. They also\nremoved the voice recording capability in this version.\n\nuvps1[.]cotbm[.]com was used for data exfiltration, previously at 138.201.47.150, after publishing of our original blog\nmoving to 144.76.250.205. It was also hosting malware updates at /themes/u.php.\n\nThey also added a curious C2 entry “hxxp://box” (note: defanged for publishing). It’s unclear how this should\nfunction; possibly a compromised victim intranet device, or the attackers have modified the HOSTS file on the victim\ncomputer.\n\nAfter the take-down, the attackers began to add server IP addresses as well as domain names to their malware C2\nlist. They also slightly modified their ZIP password from “Z8(2000_2001ul” to “Z8(2000_2001uIEr3”. Their new\nmalware version added antivirus checks for Kaspersky Labs, Avast, and Trend Micro. The malware data capture\nnow searches for file extensions:\n\n_.doc, .docx, .xls, .xlsx, .xlr, .pps, .ppt, .pptx, .mdb, .accdb, .db, .dbf, .sql, .jpg, .jpeg, .psd, .tif, .mp4, .3gp, .txt, .rtf,_\n_.odt, .htm, .html, .pdf, .wps, .contact, .csv, .nbu, .vcf, .pst, .zip, .rar, .7z, .zipx, .pgp, .tc, .vhd, .p12, .crt.pem,.key.pfx,_\n_.asc, .cer, .p7b, .sst, .doc, .docx, .xls, .xlsx, .xlr, .pps, .ppt, .pptx._\n\nand folder locations:\n\n_:\\$recycle.bin, :\\documents and settings, :\\msocache, :\\program files, :\\program files (x86), :\\programdata,_\n_:\\recovery, :\\system volume information:\\users, :\\windows, :\\boot, :\\inetpub, :\\i386._\n\nThe malware continued to use the **identical decryption key seen over the entire history of this campaign.**\n\nMid-June, through cooperation with the parties responsible for the C2 domains and law enforcement, we were able\nto get the remaining C2 domains null-routed and the directly-IP-addressed server disabled. This is the end of a\ndecade-long campaign, though we naturally expect to see this actor back in some other guise before long.\n\nThanks to the Malware research team – Yaron Samuel, Artiom Radune, Mashav Sapir, Netanel Rimer – for\nassistance in the takedown.\n\n## Appendix 1 – Exfiltration Algorithm\n\nThe malware uses a different algorithm than that used for encrypting the malware strings to encrypt the exfiltration\ndata, including:\n\n1. Keylogger data + language.\n\n2. Malware logs – installation time, DLL path and name, log path, number of downloads, number of\n\nsuccessful/failed connections.\n\n3. Information about the victim computer: Time zone, list of drives and types, running processes, disk info.\n\nFirst the malware adds 1 to all bytes, then an encryption key is initialized based on the victim computer name (the\noffset in the key is calculated by sum of the computer name letters %key length) Then the key is used to encrypt\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n26\n\n27\n\n28\n\n29\n\n30\n\n\nimport os,sys\n\nimport string\n\nimport base64\n\nimport fileinput\n\nFIRST_PHASE = \"OQTJEqtsK0AUB9YXMwr8idozF7VWRPpnhNCHI6Dlkaubyxf5423jvcZ1LSGmge\"\n\nSECOND_PHASE = \"PqOwI1eUrYtT2yR3p4E5o6WiQu7ASlDkFj8GhHaJ9sKdLfMgNzBx0ZcXvCmVnb\"\n\nglobal FULL_KEY\n\nFULL_KEY= \"\"\n\ndef sub_1_for_hex(str_input):\n\nstr_output = \"\"\n\nfor letter in str_input:\n\ntry:\n\nstr_output += chr(ord(letter)-1)\n\nexcept:\n\nprint \"sub_1_for_hex func problem\"\n\ncontinue\n\nreturn str_output\n\ndef sum_comp_name(comp_name):\n\nsum = 0\n\nfor letter in comp_name:\n\nsum+= ord(letter)\n\nreturn sum\n\ndef init_key(comp):\n\ncomp_name_sum = sum_comp_name(comp)\n\ncarry = divmod(comp_name_sum, 62)\n\nindex = carry[1] -1\n\nend_key = FIRST_PHASE[:index]\n\nkey = FIRST_PHASE[index:]\n\n\n-----\n\n32\n\n33\n\n34\n\n35\n\n36\n\n37\n\n38\n\n39\n\n40\n\n41\n\n42\n\n43\n\n44\n\n45\n\n46\n\n47\n\n48\n\n49\n\n50\n\n51\n\n52\n\n53\n\n54\n\n55\n\n56\n\n57\n\n58\n\n59\n\n60\n\n61\n\n\nkey = key + key\n\nreturn key\n\ndef decrypt(num_list,offset):\n\nglobal FULL_KEY\n\ninput = \"\"\n\nfor num_str in num_list:\n\ntry:\n\ninput += num_str.decode('hex')\n\nexcept:\n\ninput += ')'\n\nresult = \"\"\n\nfor i, c in enumerate(input):\n\ni = i % 62 +1\n\ntry:\n\nindex = FULL_KEY.index(c)-1\n\nexcept ValueError:\n\nresult += c\n\ncontinue\n\ntranslated = SECOND_PHASE[(index - i +offset) % len(SECOND_PHASE)]\n\nresult += translated\n\nreturn result\n\ndef found_infy_enc_data(line):\n\nfound_infy_str = \"show=\\\"---------- Administration Reporting Service \"\n\nfound_infy_index = line.find(found_infy_str)\n\nif not found_infy_index==-1:\n\nreturn True,found_infy_index\n\nelse:\n\nreturn False,found_infy_index\n\n\n-----\n\n64\n\n65\n\n66\n\n67\n\n68\n\n69\n\n70\n\n71\n\n72\n\n73\n\n74\n\n75\n\n76\n\n77\n\n78\n\n79\n\n80\n\n81\n\n82\n\n83\n\n84\n\n85\n\n86\n\n87\n\n88\n\n89\n\n90\n\n91\n\n92\n\n93\n\n\ncomp_index = line.find(comp)\n\ncomp_name = line[comp_index+len(comp):]\n\ncomp_name = comp_name[:comp_name.find(\"-----\")]\n\nprint \"(((=)))\" + comp_name\n\nreturn comp_name\n\ndef extract_enc_data(line):\n\nheader = r\"\\xd\\xa_____\"\n\nstart_index = line.find(header)+len(header)\n\nline = line[start_index:]\n\nendindex = line.index(\"_____\\\" value=\")\n\nline = line[:endindex]\n\nreturn line\n\ndef write_enc_infy_data_to_file(dec_line,comp_name,filename):\n\nfile1 = open(filename + \"\\\\\" + comp_name + \".txt\",'ab')\n\nfile1.writelines(dec_line)\n\nfile1.close()\n\ndef enc_wrapper(enc,comp_name):\n\nglobal FULL_KEY\n\nprint FULL_KEY\n\nFULL_KEY = init_key(comp_name)\n\nenc_final = \"\"\n\nfor letter in enc:\n\nif len(hex(ord(letter))[2:])==1:\n\nenc_final += \"0\" + hex(ord(letter))[2:]\n\nelif len(hex(ord(letter))[2:])==2:\n\nenc_final += hex(ord(letter))[2:]\n\n\n-----\n\n96\n\n97\n\n98\n\n99\n\n100\n\n101\n\n102\n\n103\n\n104\n\n105\n\n106\n\n107\n\n108\n\n109\n\n110\n\n111\n\n112\n\n113\n\n114\n\n115\n\n116\n\n117\n\n118\n\n119\n\n120\n\n121\n\n122\n\n123\n\n124\n\n125\n\n\nexit()\n\nenc = enc_final.upper()\n\nenc = enc.replace(\"2E\",\"21\")\n\nenc = enc.replace(\"C5DC5A\",\"\")\n\nenc = enc.replace(\"D03D00\",\"\")\n\nenc = enc.replace(\"0B0E\",\"2121\")\n\nenc = enc.replace(\"01\",\"21\")\n\nenc_len = len(enc)\n\nenc_rev = \"\"\n\nnum_list = []\n\nenc_print =\"\"\n\nfor i in range(0,enc_len/2):\n\nenc_rev = enc[-2:]\n\nif not enc_rev==\"0B\" and not enc_rev==\"0E\" and not enc_rev==\"00\" and not enc_rev==\"D0\":\n\nenc_print +=enc_rev\n\nnum_list.append(enc_rev)\n\nenc= enc[:-2]\n\n#the first part is always ok\n\ndec_str = decrypt(num_list,0)\n\nfinal = sub_1_for_hex(dec_str)\n\nindex = final.find(\"OK: Sent\")\n\nif index==-1:\n\nprint comp_name + \" - did not found OK: Sent !!!!\\n\\n\\n\\n\"\n\n#exit()\n\n\n-----\n\n128\n\n129\n\n130\n\n131\n\n132\n\n133\n\n134\n\n135\n\n136\n\n137\n\n138\n\n139\n\n140\n\n141\n\n142\n\n143\n\n144\n\n145\n\n146\n\n147\n\n148\n\n149\n\n150\n\n151\n\n152\n\n153\n\n154\n\n155\n\n156\n\n157\n\n\nfinal_start = final[0:500]\n\nif final_start in UNIQUE_DATA:\n\nprint comp_name + \" already have this data\"\n\nreturn\n\nUNIQUE_DATA.append(final_start)\n\nindex = final.find(\"Installed Date:\")\n\nif index==-1:\n\nfor i in range(1,61):\n\ndec_str = decrypt3(num_list,i)\n\nfinal = sub_1_for_hex(dec_str)\n\n##print all 62 options\n\nindex2 = final.find(\"PROGRAM START:\")\n\nindex3 = final.find(\"Installed Date:\")\n\nif not index2 ==-1 or not index3 ==-1:\n\ndecrypt_data += str(i) + \": \" + final + \"\\n\"\n\nwrite_enc_infy_data_to_file(decrypt_data,comp_name,FILE_OUTPUT_NAME)\n\ndef read_enc_data_files():\n\nfor root,dir,files in os.walk(PDML_PATH):\n\nfor file in files:\n\nfilename = root+ \"\\\\\" + file\n\nif os.path.isfile(filename):\n\nprint filename\n\nfor line in fileinput.input([filename]):\n\nline = line.strip()\n\nis_found,found_infy_index= found_infy_enc_data(line)\n\nif not is_found:\n\n\n-----\n\n160\n\n161\n\n162\n\n163\n\n164\n\n165\n\n166\n\n167\n\n168\n\n169\n\n170\n\n171\n\n172\n\n173\n\n174\n\n175\n\n\n#get computer name (for use in init_key() later)\n\ncomp_name = extract_comp_name(line)\n\nUNIQUE_COMP.append(comp_name)\n\n#get the infy encrypted data\n\nline = extract_enc_data(line)\n\n#base64 decode enc_data\n\ndec_line = line.decode('base64')\n\n#append enc_data to file\n\nwrite_enc_infy_data_to_file(dec_line,comp_name,FILE_ENC_OUTPUT_NAME)\n\nenc_wrapper(dec_line,comp_name)\n\ntry:\n\nread_enc_data_files()\n\nexcept:\n\nprint \"exception!!!!\"\n\n\n## Appendix 2 –IoCs\n\nInfy version 31: f07e85143e057ee565c25db2a9f36491102d4e526ffb02c83e580712ec00eb27\n\nInfy “M” version 8.0: 583349B7A2385A1E8DE682A43351798CA113CBBB80686193ECF9A61E6942786A\n\n5.9.94.34\n138.201.0.134\n138.201.47.150\n144.76.250.205\n138.201.47.158\n138.201.47.153\nus1s2[.]strangled[.]net\nuvps1[.]cotbm[.]com\ngstat[.]strangled[.]net\nsecup[.]soon[.]it\np208[.]ige[.]es\nlu[.]ige[.]es\nupdateserver1[.]com\nupdateserver3[.]com\nupdatebox4[.]com\nbestupdateserver[.]com\n\n\n-----\n\nsafehostline[.]com\nyouripinfo[.]com\nbestupser[.]awardspace[.]info\nbox4035[.]net\nbox4036[.]net\nbox4037[.]net\nbox4038[.]net\nbox4039[.]net\nbox4040[.]net\nbox4041[.]net\nbox4042[.]net\nbox4043[.]net\nbox4044[.]net\nbox4045[.]net\nbox4046[.]net\nbox4047[.]net\nbox4048[.]net\nbox4049[.]net\nbox4050[.]net\nbox4051[.]net\nbox4052[.]net\nbox4053[.]net\nbox4054[.]net\nbox4055[.]net\nbox4056[.]net\nbox4057[.]net\nbox4058[.]net\nbox4059[.]net\nbox4060[.]net\nbox4061[.]net\nbox4062[.]net\nbox4063[.]net\nbox4064[.]net\nbox4065[.]net\nbox4066[.]net\nbox4067[.]net\nbox4068[.]net\nbox4069[.]net\nbox4070[.]net\nbox4071[.]net\nbox4072[.]net\nbox4075[.]net\nbox4078[.]net\nbox4079[.]net\nbox4080[.]net\nbox4081[.]net\nbox4082[.]net\nbox4083[.]net\n\n\n-----\n\nbox4086[.]net\nbox4087[.]net\nbox4088[.]net\nbox4089[.]net\nbox4090[.]net\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/drj4vb73cv87ok5wks21rynlq3236793"
    ],
    "report_names": [
        "PaloAlto_PrinceofPersiaGameOver(06-28-2016)"
    ],
    "threat_actors": [
        {
            "id": "59c9f31b-e032-44b9-bf3b-4f2cb3d17e39",
            "created_at": "2022-10-25T16:07:23.734244Z",
            "updated_at": "2025-03-27T02:02:09.952685Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "APT-C-07",
                "Infy",
                "Operation Mermaid",
                "Prince of Persia"
            ],
            "source_name": "ETDA:Infy",
            "tools": [
                "Foudre",
                "Infy",
                "Tonnerre"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f763fd1f-f697-40eb-a082-df6fd3d13cb1",
            "created_at": "2023-01-06T13:46:38.561288Z",
            "updated_at": "2025-03-27T02:00:02.861874Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "Operation Mermaid",
                "Prince of Persia",
                "Foudre"
            ],
            "source_name": "MISPGALAXY:Infy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716494,
    "ts_updated_at": 1743041515,
    "ts_creation_date": 1467172054,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/3f92bfbfdb0fee7eda8613fc3a6ff515ffceb972.pdf",
        "text": "https://archive.orkl.eu/3f92bfbfdb0fee7eda8613fc3a6ff515ffceb972.txt",
        "img": "https://archive.orkl.eu/3f92bfbfdb0fee7eda8613fc3a6ff515ffceb972.jpg"
    }
}