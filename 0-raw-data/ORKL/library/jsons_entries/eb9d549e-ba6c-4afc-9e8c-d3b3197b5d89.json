{
    "id": "eb9d549e-ba6c-4afc-9e8c-d3b3197b5d89",
    "created_at": "2022-10-25T16:48:20.18616Z",
    "updated_at": "2025-03-27T02:05:36.330692Z",
    "deleted_at": null,
    "sha1_hash": "09f34e4bf6d1b7503863ac6ae0c0a010e605a3b0",
    "title": "Targeted Attacks against Banks in the Middle East « Threat Research Blog | FireEye Inc",
    "authors": "",
    "file_creation_date": "2016-07-05T13:11:40Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 941267,
    "plain_text": "**May 22, 2016 | by Sudeep Singh, Yin Hong Chang | Threat Research** **, Targeted Attack**\n\n**In the first week of May 2016,** **FireEye’s DTI identified a wave of emails containing malicious attachments being sent**\n**to multiple banks in the Middle East region. The threat actors appear to be performing initial reconnaissance against**\n**would-be targets, and the attacks caught our attention since they were using unique scripts not commonly seen in**\n**crimeware campaigns.**\n\n**In this blog we discuss in detail the tools, tactics, techniques and procedures (TTPs) used in these targeted attacks.**\n\n**The attackers sent multiple emails containing macro-enabled XLS files to employees working in the banking sector in**\n**the Middle East. The themes of the messages used in the attacks are related to IT Infrastructure such as a log of**\n**Server Status Report or a list of Cisco Iron Port Appliance details. In one case, the content of the email appeared to be**\n**a legitimate email conversation between several employees, even containing contact details of employees from**\n**several banks. This email was then forwarded to several people, with the malicious Excel file attached.**\n\n**The macro first calls an Init() function (shown in Figure 1) that performs the following malicious activities:**\n\n**1. Extracts base64-encoded content from the cells within a worksheet titled \"Incompatible\".**\n**2. Checks for the presence of a file at the path** **%PUBLIC%\\Libraries\\ update.vbs. If the file is not present, the**\n\n**macro creates three different directories under %PUBLIC%\\Libraries, namely** **up, dn, and tp.**\n\n**3. The extracted content from step one is decoded using PowerShell and dropped into two different files:**\n\n\n**%PUBLIC%\\Libraries\\update.vbs and %PUBLIC%\\Libraries\\dns.ps1**\n\n\n**4. The macro then creates a scheduled task with name:** **GoogleUpdateTaskMachineUI, which executes**\n\n**update.vbs every three minutes.**\n\n**Note: Due to the use of a hardcoded environment variable** **%PUBLIC% in the macro code, the macro will only run**\n\n**successfully on Windows Vista and subsequent versions of the operating system.**\n\n\n-----\n\n**Figure 1: Macro Init() subroutine**\n\n**One of the interesting techniques we observed in this attack was the display of additional content after the macro**\n**executed successfully. This was done for the purpose of social engineering – specifically, to convince the victim that**\n**enabling the macro did in fact result in the “unhiding” of additional spreadsheet data.**\n\n**Office documents containing malicious macros are commonly used in crimeware campaigns. Because default Office**\n**settings typically require user action in order for macros to run, attackers may convince victims to enable risky macro**\n**code by telling them that the macro is required to view “protected content.”**\n\n**In crimeware campaigns, we usually observe that no additional content is displayed after enabling the macros.**\n**However, in this case, attackers took the extra step to actually hide and unhide worksheets when the macro is enabled**\n**to allay any suspicion. A screenshot of the worksheet before and after running the macro is shown in Figure 2 and**\n**Figure 3, respectively.**\n\n**Figure 2: Before unhiding of content**\n\n\n-----\n\n**Figure 3: After unhiding of content**\n\n**In the following code section, we can see that the subroutine** **ShowHideSheets() is called after the** **Init()**\n\n**subroutine executes completely:**\n\n\n**Private Sub Workbook_Open()**\n\n\n**Call Init**\n\n**Call ShowHideSheets**\n\n**End Sub**\n\n**The code of subroutine** **ShowHideSheets(), which unhides the content after completion of malicious activities, is**\n\n**shown in Figure 4.**\n\n**Figure 4: Macro used to unhide content at runtime**\n\n**After the macro successfully creates the scheduled task, the dropped VBScript,** **update.vbs (Figure 5), will be**\n\n**launched every three minutes. This VBScript performs the following operations:**\n\n**1. Leverages PowerShell to download content from the URI** **hxxp://go0gIe[.]com/sysupdate.aspx?**\n\n**req=xxx\\dwn&m=d and saves it in the directory %PUBLIC%\\Libraries\\dn.**\n\n**2. Uses PowerShell to download a BAT file from the URI** **hxxp://go0gIe[.]com/sysupdate.aspx?**\n\n**req=xxx\\bat&m=d and saves it in the directory %PUBLIC%\\Libraries\\dn.**\n\n**3. Executes the BAT file and stores the results in a file in the path** **%PUBLIC%\\Libraries\\up.**\n\n\n-----\n\n**5. Finally, it executes the PowerShell script** **dns.ps1, which is used for the purpose of data exfiltration using DNS.**\n\n**Figure 5: Content of update.vbs**\n\n**During our analysis, the VBScript downloaded a customized version of Mimikatz in the previously mentioned step one.**\n**The customized version uses its own default prompt string as well as its own console title, as shown in Figure 6.**\n\n**Figure 6: Custom version of Mimikatz used to extract user password hashes**\n\n**Similarly, the contents of the BAT file downloaded in step two are shown in Figure 7:**\n\n**whoami & hostname & ipconfig /all & net user /domain 2>&1 & net group /domain 2>&1 &**\n\n\n**net group \"domain admins\" /domain 2>&1 & net group \"Exchange Trusted Subsystem\" /domain**\n\n**2>&1 & net accounts /domain 2>&1 & net user 2>&1 & net localgroup administrators 2>&1 &**\n\n**netstat -an 2>&1 & tasklist 2>&1 & sc query 2>&1 & systeminfo 2>&1 & reg query**\n\n\n**\"HKEY_CURRENT_USER\\Software\\Microsoft\\Terminal Server Client\\Default\" 2>&1**\n\n\n**Figure 7: Content of downloaded BAT script**\n\n**This BAT file is used to collect important information from the system, including the currently logged on user, the**\n**hostname, network configuration data, user and group accounts, local and domain administrator accounts, running**\n**processes, and other data.**\n\n**A** **th** **i t** **ti** **t** **h i** **l** **d b thi** **l** **th** **f DNS** **i** **d t** **filt** **ti** **h** **l**\n\n\n-----\n\n**blocked (allowing free communications out of the network) and its use is unlikely to raise suspicion among network**\n**defenders.**\n\n**The script dns.ps1, dropped by the macro, is used for this purpose. In the following section, we describe its**\n\n**functionality in detail.**\n\n**1. The script requests an ID (through the DNS protocol) from** **go0gIe[.]com. This ID will then be saved into the**\n\n**PowerShell script.**\n**2. Next, the script queries the C2 server for additional instructions. If no further actions are requested, the script exits**\n\n**and will be activated again the next time update.vbs is called.**\n\n**3. If an action is required, the DNS server replies with an IP with the pattern** **33.33.xx.yy. The script then**\n\n**proceeds to create a file at %PUBLIC%\\Libraries\\tp\\chr(xx)chr(yy).bat. The script then proceeds to**\n\n**make DNS requests to fetch more data. Each DNS request results in the C2 server returning an IP address. Each**\n**octet of the IP address is interpreted as the decimal representation of an ASCII character; for example, the**\n**decimal number 99 is equivalent to the ASCII character ‘c’. The characters represented by the octets of the IP**\n**address are appended to the batch file to construct a script. The C2 server signals the end of the data stream by**\n**replying to a DNS query with the IP address 35.35.35.35.**\n**4. Once the file has been successfully transferred, the BAT file will be run and its output saved as**\n\n**%PUBLIC%\\Libraries\\tp\\chr(xx)chr(yy).txt.**\n\n**5. The text file containing the results of the BAT script will then be uploaded to the DNS server by embedding file**\n\n**data into part of the subdomain. The format of the DNS query used is shown in Table 1.**\n**6. The BAT file and the text file will then be deleted. The script then quits, to be invoked again upon running the next**\n\n**scheduled task.**\n\n**The DNS communication portion of the script is shown in Figure 8, along with a table showing the various subdomain**\n**formats being generated by the script.**\n\n**Figure 8: Code Snippet of dns.ps1**\n\n\n-----\n\n**Subdomain used to**\n**request for BotID,**\n**used in step 2 above**\n\n**Subdomain used**\n**while performing file**\n**transfers used in step**\n**3 above**\n\n**Subdomain used**\n**while performing file**\n**upload, used in step**\n**5 above**\n\n**Table 1: C2 Protocol Format**\n\n\n\n**[00][botid]00000[base36 random number]30**\n\n|Subdomain used while performing file transfers used in step 3 above|[00] [botid]00000[base36 random number]232A[hex_filename] [i-counter]|\n|---|---|\n|Subdomain used while performing file upload, used in step 5 above|[00][botid][cmdid][partid][base36 random number][48-hex- char-of-file-content]|\n\n\n**Although this attack did not leverage any zero-days or other advanced techniques, it was interesting to see how**\n**attackers used different components to perform reconnaissance activities on a specific target.**\n\n**This attack also demonstrates that macro malware is effective even today. Users can protect themselves from such**\n**attacks by disabling Office macros in their settings and also by being more vigilant when enabling macros (especially**\n**when prompted) in documents, even if such documents are from seemingly trusted sources.**\n\n**This entry was posted on Sun May 22 03:00:00 EDT 2016 and filed under Advanced Targeted Attacks, Advanced**\n**Threat Actor, Advanced Threats, Bank security, Blog, Cybercrime, Cybersecurity, Email Attacks, Email Security,**\n**Latest Blog Posts, Sudeep Singh, Targeted Attack** **, Targeted Attack** **, Targeted Attacks, Threat Intel** **, Threat Research** **,**\n**Yin Hong Chang and targeted attackers.**\n\n\n# First Name\n\n Last Name\n\n Email Address\n\n**Executive Perspective Blog**\n\n**Threat Research Blog**\n\n**Products and Services Blog**\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2016/2016.05.22.Targeted_Attacks_Against_Banks_in_Middle_East/targeted_attacksaga.html.pdf"
    ],
    "report_names": [
        "targeted_attacksaga.html"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "578f8e62-2bb4-4ce4-a8b7-6c868fa29724",
            "created_at": "2022-10-25T16:07:24.344358Z",
            "updated_at": "2025-03-27T02:02:10.182282Z",
            "deleted_at": null,
            "main_name": "Tropic Trooper",
            "aliases": [
                "APT 23",
                "Bronze Hobart",
                "Earth Centaur",
                "KeyBoy",
                "Operation Tropic Trooper",
                "Pirate Panda",
                "Tropic Trooper"
            ],
            "source_name": "ETDA:Tropic Trooper",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "ByPassGodzilla",
                "CHINACHOPPER",
                "CREDRIVER",
                "China Chopper",
                "Chymine",
                "Darkmoon",
                "Gen:Trojan.Heur.PT",
                "KeyBoy",
                "Neo-reGeorg",
                "PCShare",
                "POISONPLUG.SHADOW",
                "Poison Ivy",
                "RoyalRoad",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Swor",
                "TSSL",
                "USBferry",
                "W32/Seeav",
                "Winsloader",
                "XShellGhost",
                "Yahoyah",
                "fscan",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041136,
    "ts_creation_date": 1467724300,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/09f34e4bf6d1b7503863ac6ae0c0a010e605a3b0.pdf",
        "text": "https://archive.orkl.eu/09f34e4bf6d1b7503863ac6ae0c0a010e605a3b0.txt",
        "img": "https://archive.orkl.eu/09f34e4bf6d1b7503863ac6ae0c0a010e605a3b0.jpg"
    }
}