{
    "id": "663234ef-751d-4af6-8a85-7c7e8acfb06f",
    "created_at": "2023-01-12T15:02:37.147297Z",
    "updated_at": "2025-03-27T02:05:43.462686Z",
    "deleted_at": null,
    "sha1_hash": "ac2f9783d05dafb45c191b6eeb5acef00a6e8cff",
    "title": "2021-04-20 - CobaltStrike Stager Utilizing Floating Point Math",
    "authors": "",
    "file_creation_date": "2022-05-28T17:58:27Z",
    "file_modification_date": "2022-05-28T17:58:27Z",
    "file_size": 273394,
    "plain_text": "# CobaltStrike Stager Utilizing Floating Point Math\n\n**[medium.com/walmartglobaltech/cobaltstrike-stager-utilizing-floating-point-math-9bc13f9b9718](https://medium.com/walmartglobaltech/cobaltstrike-stager-utilizing-floating-point-math-9bc13f9b9718)**\n\nJason Reaves April 20, 2021\n\n[Jason Reaves](https://medium.com/@jason.reaves?source=post_page-----9bc13f9b9718--------------------------------)\n\nApr 20, 2021\n\n\n3 min read\n\nBy: Jason Reaves and Joshua Platt\n\n## Executive summary\n\n1. New CobaltStrike stagers utilizing floating point mnemonics[1] to decode out stager\n\nshellcode.\n2. Using raw sockets and date value from Google headers to check overwritten sleep\n\nvalues such as in some sandbox detonations.\n\n## Date checking\n\n\n-----\n\nThe stager employs an interesting technique to check for being detonated in controlled\nenvironments such as sandboxes that might overwrite sleep values, at the same time it also\nchecks for network connectivity.\n\nThe stager utilizes raw sockets to connect to ‘google.com’ over port 80 and send a GET\nrequest.\n\nRaw socket to google.com\nThe request is not parsed as an HTTP request in most utilities including Wireshark[2] and\nSuricata[3] because it is incomplete with just a newline and no carriage return.\n\nIncomplete request\nThe request is enough to retrieve the 404 response from the webserver and then the\nmalware begins parsing the values out of the date, specifically it parses out the day, year and\ntime values.\n\n\n-----\n\nParse values from response\nAfter parsing out the values it converts it to seconds but without accounting for the month.\n\nConvert values to seconds\n\nTime Check\nAbove you can see a sleep call is sandwiched by two of these calls to the function\nresponsible for retrieving the converted value from a google request, the sleep is 30 seconds\nand then it checks if the values differ less than 28. It is checking if the process took less than\n28 seconds or not.\n\n\n-----\n\nError or decode logic\nIf the check fails then a fake DirectX error message is displayed, otherwise the process for\ndecoding the stager shellcode begins.\n\n## Shellcode decode\n\nThe shellcode is decoded by utilizing floating point mnemonics, judging by some of the\nactors testing this appears to be pretty good at bypassing static detection engines.\n\nDecode loop\nThe process involved begins with floating point modulus against a table of data using a key\nvalue that is hardcoded.\n\n\n-----\n\nfpmod\nAfter the modulus the value is rounded to an int value. Example python code for decoding\nthe data can be seen below:\n```\ndef fpmod_decode(key, data, l): out = \"\" for i in range(l): temp =\nstruct.unpack_from('<d', data[i*8:])[0] if temp > int(temp%key):  out +=\nchr((ord(struct.pack('<Q', int(temp%key))[0])+1)&0xff) else:  out +=\nchr((ord(struct.pack('<Q', int(temp%key))[0]))&0xff) return out\n\n```\nUsing our decode code we can quickly enumerate samples for decoding out the shellcode\nand harvesting IOCs.\n\n## Indicators of compromise\n```\ncda7edc9414814ef57c31e473ce87e489bcd6f1ed8d81a504e960e184fce1609abaf70728e6f940195e35e\n tcp $HOME_NET any -> $EXTERNAL_NET 80 (msg:\"CS stager time check 1\"; dsize:8;\ncontent:\"GET drv|0a|\"; offset:0; classtype:trojan-activity; sid:9000009; rev:1;\nmetadata:author Jason Reaves;)alert tcp $HOME_NET any -> $EXTERNAL_NET 80 (msg:\"CS\nstager time check 2\"; dsize:11; content:\"GET driver|0a|\"; offset:0; classtype:trojanactivity; sid:9000010; rev:1; metadata:author Jason Reaves;)\n\n References\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-20 - CobaltStrike Stager Utilizing Floating Point Math.pdf"
    ],
    "report_names": [
        "2021-04-20 - CobaltStrike Stager Utilizing Floating Point Math.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535757,
    "ts_updated_at": 1743041143,
    "ts_creation_date": 1653760707,
    "ts_modification_date": 1653760707,
    "files": {
        "pdf": "https://archive.orkl.eu/ac2f9783d05dafb45c191b6eeb5acef00a6e8cff.pdf",
        "text": "https://archive.orkl.eu/ac2f9783d05dafb45c191b6eeb5acef00a6e8cff.txt",
        "img": "https://archive.orkl.eu/ac2f9783d05dafb45c191b6eeb5acef00a6e8cff.jpg"
    }
}