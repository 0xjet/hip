{
    "id": "bd6f4552-688a-40cf-a6b8-b947bb1cb292",
    "created_at": "2023-01-12T15:09:48.52732Z",
    "updated_at": "2025-03-27T02:08:33.362727Z",
    "deleted_at": null,
    "sha1_hash": "b894b5c55fd3595c7f7d31f4e647325c261aa7af",
    "title": "2021-07-14 - Investigating a Suspicious Service",
    "authors": "",
    "file_creation_date": "2022-05-27T21:16:55Z",
    "file_modification_date": "2022-05-27T21:16:55Z",
    "file_size": 1256723,
    "plain_text": "# Investigating a Suspicious Service\n\n**mdsec.co.uk/2021/07/investigating-a-suspicious-service/**\n\nJuly 14, 2021\n\nThe Incident Response team at MDSec regularly gets queries from our customers, as well as\nour consultants about odd things that they’ve found, either during engagements, or on an adhoc basis.\n\nRecently, during one of our Purple Team exercises, one of our consultants drew our attention\nto a large number of services that had been deployed across the customer network, that\nwere; quite rightly causing a bit of concern.\n\nThese services had all the hallmarks of “probably bad, at least very weird”: seemingly\nrandomly named, with some lumps of PowerShell for good measure.\n\nThe customer, and our consultant had a couple of questions about these services:\n\n1. How do we work out when these were created?\n2. What is it/how much do we need to care?\n\n### 1: How do we work out when these were created?\n\nThere are a couple of simple ways to query information about a service, we prefer using `sc`\n```\nqc <service name> . Which displays information about the type of service, the display\n\n```\nname, the path name etc.\n\nUnfortunately, this doesn’t display information about when a service was created. There are\na number of different ways to obtain this information, some more reliable than others.\n\n**Windows Event Logs**\n\nSystem Log, EventID: 7045\n\n\n-----\n\nYou can also query using PowerShell:\n```\nGet-EventLog -LogName System | Where-Object {$_.EventID -eq 7045 | Select-Object Property TimeGenerated, Message | Format-List\n\n```\nOr, if you’re using [Log-Extractor:](https://github.com/cbasnett/Log-Extractor)\n```\nzgrep '\"EventID\":{\"Qualifiers\":\"7045\"}' *| cut -d ':' -f2- | jq .\n\n```\n\n-----\n\n*Note that the time shown in the Log-Extractor log is UTC whereas the other two are quoted\nin local time (because Windows hates analysts).\n\nThe trouble with using Windows Event Logs for this sort of thing is that if not centralised (as\nwith this customer) these logs typically have a fairly short lifespan resulting in data being\nmissing or inconclusive.\n\n**Registry**\n\nServices are stored within the Windows Registry, which contains written dates for specific\nkeys. Unfortunately, there’s no super simple way of programatically getting this data, and in\nthe backward way of Windows the simplest way is the following:\n\nOpen Registry Editor\nNavigate to appropriate key ( HKLM\\System\\CurrentControlSet\\Services\\<Service\n```\n   Name> )\n\n```\nRight Click, Export as text (not .reg)\n\n\n-----\n\n### 2: What is it/how much do we need to care?\n\nLooking at the code, we can see that there are two separate commands being run, the first of\nwhich is just command prompt being used to start a process:\n```\ncmd.exe /b /c start /b /min <command>\n\n```\nWhat this is effectively doing is running the command minimised to a user. Largely\nunnecessary when running as a service but there we are! Interestingly from a detection\nstandpoint this would generate two `cmd.exe processes with parent child relationships, and`\nthen finally a PowerShell process which would be trivial to signature and unlikely to be\nassociated with legitimate activity.\n\nThe much more interesting command being ran is that of the PowerShell script. Immediately\nwe can observe a couple of things:\n```\npowershell.exe -nop -w hidden -noni -c\n\n```\nThis basically runs the command with no profile (-nop) in a hidden window, in non-interactive\n(-noni) mode. But we don’t really care about this beyond the fact that it exists.\n\nWith a bit of tidying up (and switching to a decent environment), we’re left with some more\ncohesive PowerShell:\n\nWe can see here, quite simply the script is looking to see if we’re running a 32 bit of 64 bit\nsystem, then launching a PowerShell process in the background with a number of arguments\n(in this case the bit we care about). Let’s get rid of all the fluff and focus on the bits we care\nabout:\n\n\n-----\n\nEffectively what this code is doing is Gzip Decompressing some base64 encoded data. We\ncan work with that! A couple of lines of Python is all that’s needed to convert this into\nsomething sensible:\n\nThis code should be fairly self explanatory, but in case it’s not. We can use the python\nbase64 library to decode the data, then the gzip library to decompress. You could achieve\n[something very similar using CyberChef:](https://gchq.github.io/CyberChef/)\n\nThe result of which gives us something like:\n\n\n-----\n\nOh, this looks a bit more complex. This is the point where experience and time optimisation\ncome in. We can see that “$c3F” contains some more base64, we can see that this is\neffectively being copied into “$gB” which is then invoked in a “ CreateThread ” function\nultimately meaning that the base64 content is executed. Beyond this, we don’t really care at\nthis stage. I’m far more interested in what is under the base64.\n\nWith some minor adjustments to our python, we get some gunk out of the Base64, gunk\nbeing the technical word for “file doesn’t know what this is”.\n\nOk, well if only it was easy. Let’s have a look at the hex, and from the age-old cyber security\ntextbook let’s get some Google going:\n```\nFC E8 rang a bell for me before we Googled it, but the search results confirm my\n\n```\nsuspicions.\n\n\n-----\n\nWe always say to analysts, Google everything, sometimes it can save a LOT of time. A long\ntime ago we confirmed that some samples were linked to a known APT group by Googling\nsome strings in a sample we identified. We could have spent significant time and effort\nreverse engineering the binary, but why bother when someone has already done that work\nand published it, we save the customer time and money by working efficiently.\n\nEnter [SCDBG, this awesome tool emulates shellcode and displays what functions are being](http://sandsprite.com/blogs/index.php?uid=7&pid=152)\ncalled. There’s even a pretty GUI to make it utterly fool proof:\n\nSo, what we have here is most likely a Metasploit stager which is attempting to connect to\n10.x.x.x address on port 4444. Given its an internal RFC1918 IP address and a default port\nnumber, it seems like the most likely explanation is that a security assessment or internal test\nhad occurred and been poorly cleaned up in the past. At this point any further analysis with\nthe data in our possession was unlikely to yield any further results so we reported our\nfindings to the customer who were able to confirm our theory.\n\nThis is just one of many possible ways of performing analysis of an unknown, the key\ntakeaways are to focus on the key items rather than getting hung up in the details.\n\n\n-----\n\nMDSec provides a range of proactive and reactive response services, as well as 24/7/365\nretained Emergency Response services. To find out more about how we can help your\n[organisation, please get in touch: response@mdsec.co.uk.](http://10.10.0.46/mailto:response@mdsec.co.uk)\n\n### Yara Rule to detect Metasploit and Cobalt Strike Shellcode\n```\n{  \n  meta:\n    description = \"Detects MSF Shellcode\"\n    author = \"MDSec\"\n    reference = \"https://www.mdsec.co.uk\"\n    date = \"2021-05-04\"\n  strings:\n    $initial = {fc e8 ?? 00 00 00 00}\n  condition:\n    $initial at 0\n}\n\n```\n[This blog post was written by Chris Basnett.](https://twitter.com/chrisbasnett7)\n\nwritten by\n\n**MDSec Research**\n\n## Ready to engage\n with MDSec?\n\n[Get in touch](https://www.mdsec.co.uk/contact)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-14 - Investigating a Suspicious Service.pdf"
    ],
    "report_names": [
        "2021-07-14 - Investigating a Suspicious Service.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536188,
    "ts_updated_at": 1743041313,
    "ts_creation_date": 1653686215,
    "ts_modification_date": 1653686215,
    "files": {
        "pdf": "https://archive.orkl.eu/b894b5c55fd3595c7f7d31f4e647325c261aa7af.pdf",
        "text": "https://archive.orkl.eu/b894b5c55fd3595c7f7d31f4e647325c261aa7af.txt",
        "img": "https://archive.orkl.eu/b894b5c55fd3595c7f7d31f4e647325c261aa7af.jpg"
    }
}