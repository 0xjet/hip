{
    "id": "a6b38b12-a204-4e70-8f56-dbd7f636fa89",
    "created_at": "2023-01-12T15:00:30.703436Z",
    "updated_at": "2025-03-27T02:16:26.872341Z",
    "deleted_at": null,
    "sha1_hash": "52102c62077abee629f07436893a3c5889730d60",
    "title": "2020-05-21 - Asnarök attackers twice modified attack midstream",
    "authors": "",
    "file_creation_date": "2022-05-29T00:59:02Z",
    "file_modification_date": "2022-05-29T00:59:02Z",
    "file_size": 1042836,
    "plain_text": "# Asnarök attackers twice modified attack midstream\n\n**news.sophos.com/en-us/2020/05/21/asnarok2/**\n\nSophos May 21, 2020\n\nIn the hours after Sophos issued hotfixes that secured firewalls targeted by unknown threat\nactors, the attackers pivoted to a new phase of the attack, adding new components—\nincluding files intended to spread ransomware to unpatched Windows machines inside the\nnetwork. Unfortunately for the threat actors, the hotfixes also prevented the subsequent\nattempted attacks.\n\n[Since we published our first report, the attackers first modified their attack to attempt to use](https://news.sophos.com/en-us/2020/04/26/asnarok/)\nwhat we previously described as the “backup channel.” This was a Linux shell script that\nserved as a dead man switch—a portion of the attack intended to trigger only under certain\ncircumstances; in this case, if a specific file the attackers created during the attack gets\ndeleted. For example, this would have happened if a firewall that hadn’t been remediated by\nthe Sophos hotfixes had been rebooted or power-cycled. If the file did get deleted, the new\nuse of the backup channel was intended to initiate a ransomware attack at an indeterminate\ntime in the future.\n\nThe Sophos hotfixes closed off the SQL injection vulnerability to subsequent exploitation,\nand removed the malicious scripts and applications, without having to reboot the firewall.\nPossibly realizing that their ransomware download was not being initiated by the dead man\nswitch, perhaps due to the lack of a reboot, the attackers then appear to have reacted by\nchanging some of the shell scripts delivered during an earlier stage of the attack, including\nreplacing the 2own data-stealing module with the ransomware payload\n\n\n-----\n\nAt that point, the attackers intended to deliver the ransomware without requiring the firewall\nto reboot—but Sophos had already taken additional steps to intervene that disrupted this\nphase of the attack. The following is a description of the threat actors’ attempts to modify\ntheir attack in reaction to Sophos’ response.\n\n## New ELF and shell script malware\n\nDuring our initial analysis of the attack, Sophos identified a web domain that the attackers\nhad registered prior to the earliest phase of the attack. At the time we began our\ninvestigation, the URLs on that domain were not functional and were not serving any\nmalicious code.\n\nThis attack element, characterized as a “backup channel” in the infographic we used in the\nprevious post, was only activated by the attacker after we began to respond to the incident\nby issuing hotfixes to firewalls.\n\nAs [we previously reported, the attack began when the attackers leveraged a previously-](https://news.sophos.com/en-us/2020/04/26/asnarok/)\nunknown SQL injection vulnerability to insert a single line of Linux code into a database; the\neffect being that a shell script named Install.sh was downloaded to, and executed, on the\nfirewall.\n\nThat script, in one of the defining behaviors of the attack, downloaded three additional shell\nscripts, one of which (named .pg.sh) leads to the backup channel. The .pg.sh script then, in\nturn, downloaded a Linux ELF binary that was written to the filesystem as .post_MI, which\nwe know performed two functions.\n\nFirst, .post_MI would check to see whether another file, named .a.PGSQL had been written\nto the /tmp/ directory on the firewall’s internal storage. As a different, earlier fork of the attack\nchain always created that zero-byte file in that location, we observed no additional behavior\n\n\n-----\n\nfrom .post_MI, but we did know that it would have activated its secondary command – to\ndownload and execute another shell script named patch.sh—only if the .a.PGSQL file was\nnot where it was supposed to be.\n\nAnd there was a good explanation for that: The firewall always clears the contents of the\n/tmp/ directory when it reboots or when an administrator power-cycles the firewall. This link\non the attack chain would have activated if an admin triggered the firewall to reboot (or\ncycled the power).\n\nThe patch.sh script was unavailable from the attacker’s infrastructure until it suddenly\nappeared a few days after the attack began.\n\n### patch.sh leads to Ragnarok ransomware\n\n\n-----\n\nIf someone rebooted or power-cycled a successfully-attacked firewall (or happened to delete\nthe .a.PGSQL file from the /tmp directory some other way), .post_MI activated and\ndownloaded patch.sh from the website ragnarokfromasgard[.]com. Again, this website only\nbegan serving content several days after the attack began. Sophos was able to take control\nof this domain through legal process.\n\nThe ragnarokfromasgard domain shared hosting with two other domains. One of those\ndomains (updatefileservercross[.]com, also now in Sophos’ control) had also been hosted\nfrom a second IP address that, in turn, led to other similarly-named domains registered on\nthe same day, with the same registrar, using the same private WHOIS service to mask the\nregistrant’s details.\n\nIn the previous post, we listed several domains we considered suspicious; we were led to\none of them by an alternate “installer” shell script, which pointed at a file named in.sh that\nhad been hosted on the domain filedownloaderservers[.]com, also now in Sophos’ control.\nThis domain was hosted on an IP that was not shared with the other domains\n(23.234.10[.]122), but falls under the jurisdiction of the same company, Internet Keeper\nGlobal out of Hong Kong, on the same /24 subnet range.\n\nThe .post_MI file wrote out the patch.sh file into the /tmp/ directory as .psqlck.sh and\nexecuted it. That script had one job: Download yet another file from a web server and\nexecute it.\n\nRather than use a domain name, the attackers decided to point this at the IP address where\nthe payload file, named s, was hosted (on the nonstandard web server port of 81/tcp). The\nscript wrote out the downloaded file to /tmp/ as a file deceptively named hotfix, and\nexecuted it.\n\n\n-----\n\nThe attacker s hotfix file is an ELF binary application, an executable file for Unix operating\nsystems like Linux. One of its tasks was to parse the contents of the firewall’s ARP cache;\nthe ARP cache keeps track of the (internal) IP and MAC addresses of every host on the local\nnetwork segment. It then uses this list of internal IP addresses to scan port 445/tcp on each\ncomputer to determine if those computers were running Windows, and if they were\nreachable. (An ARP cache may contain the IP address(es) of computer(s) that have been\npowered off or are not available for other reasons.)\n\nThis Linux application contained two embedded Windows DLLs, one built for 32-bit (x86)\narchitecture, one for 64-bit (x64), as well as a series of hardcoded SMB commands.\n\nDuring the attack, the attacker’s hotfix application used those commands to initiate an SMB\ntransaction to each of the computers listed in the ARP cache. Executing this command\ntriggers an error, which the attacker’s hotfix file used to determine if the targeted computer\nwas running 32-bit or 64-bit Windows.\n\nBased on the result of that test, the attacker’s hotfix application would have attempted to\nleverage the EternalBlue network-level remote code execution exploit and DoublePulsar\nkernel- and user-land shellcode, to deliver, inject, and execute the architecture-appropriate\nDLL directly into the memory of the Windows explorer.exe process on the targeted computer.\n\n\n-----\n\nThe DLL, once loaded into explorer.exe, would have used the Windows certutil.exe tool to\ndownload an executable payload from the 9sg[.]me domain (previously hosted on the same\nIP address that hosted the attacker’s hotfix ELF, now controlled by Sophos) to the computer,\nusing the nonstandard HTTP port 81/tcp.\n\n\n-----\n\nThe commands were nearly identical on either platform, and as it turns out, even though\nthere was a unique URL used for each architecture, the payload executable it attempted to\ndownload (named either patch32 or patch64) was identical.\n\nThe script waited for 60 seconds after it had completed the download, executed the payload,\nthen deleted the static payload data off of storage, a common behavior that attackers employ\nto remove evidence and complicate the forensic analysis of affected devices.\n\nThe IP address hosting the 9sg domain was the same location that served the hotfix\npayload, and is implicated in attacks going back to 2018, according to VirusTotal and\n[FireEye, who included the IP in a block list of IoCs the company associates with a threat they](https://github.com/citrix/ioc-scanner-CVE-2019-19781/blob/master/scanners/shell-history.sh)\n\n\n-----\n\n[call NOTROBIN, used to target Citrix servers.](https://www.fireeye.com/blog/threat-research/2020/01/vigilante-deploying-mitigation-for-citrix-netscaler-vulnerability-while-maintaining-backdoor.html)\n\n### Moving ransomware up in the attack sequence\n\nA short time after the attackers enabled the so-called dead man switch, it appears they did\nnot detect the response they were expecting and made other modifications to the killchain.\n\nThe logic the attackers initially built into the attack chain meant the ransomware payload\nwould be delivered if something (or someone) cleaned up the persistence mechanism\nemployed in the generate_curl_ca_bundle.sh file, but also did not clean up the .post_MI\npersistence method. If you cleaned up both, as the Sophos hotfix did, it didn’t run.\n\nAfter both of those channels failed to deliver the desired result, the attackers then replaced\nthe script hosted at /sh_guard/lc so that it pointed at a download link to the ELF that\ndownloads the ransomware, instead of the exfiltration tool 2own.\n\n### Ransomware payload\n\nThe attacker’s so-called “hotfix” is a Windows ransomware called Ragnarok. This\nransomware is now connected to at least two attack campaigns targeting networked devices.\n[The earlier attack targeted Citrix ADC servers.](https://www.bleepingcomputer.com/news/security/ragnarok-ransomware-targets-citrix-adc-disables-windows-defender/)\n\nRagnarok ransomware contains an embedded JSON file that contains configuration data that\ndefines how it will behave; decoding this JSON file reveals virtually everything about the\nmalware’s instructions. The JSON, for example, defines the file extensions of files it will\nencrypt (in this case, .doc, .txt, .xls, .ppt, .sql, and.pdf were the only files it would have\nencrypted), and the file types it will not.\n\n\n-----\n\nThe Ragnarok JSON also contains Windows Registry key paths that indicate the\nransomware may attempt to disable the Windows Defender antimalware tool.\n\nThe ransomware drops a text file ransom note (the content of which also is defined in the\nJSON configuration data) that contains several email addresses.\n\nThe ransom note does not include a bitcoin wallet or make a specific financial demand,\nrequesting that the owner of the infected device contact the attackers to negotiate a ransom.\nThe JSON does, however, include a C2 address (pointing back to the same IP where 9sg\nwas hosted), as well as a folder location on the target system that includes a folder\n(familiarly) named veryhotfix.\n\n\n-----\n\nIt s common for criminals to avoid running malware in countries where they reside,\npresumably to avoid attention from local law enforcement. One way they do that is to use the\nlanguage or localization settings on the target computer to make the decision.\n\nThe Ragnarok JSON contains its localization-based exclusion policy, which includes Russia\nand the CIS countries, but also Israel, Spain, and language settings representing four\nregional dialects used in China (Simplified Chinese, Uyghur, Yi, and Tibetan).\n\nThe following table lists the specific Installed Language ID (LCID) values and their\ncorresponding localization codes and language/country pairs that make up the exclusion list.\n\n**LCID – HEX** **LCID – DEC** **Country code** **Language Name**\n\n0x040A 1034 es-ES_tradnl Spanish – Spain\n\n0x040D 1037 he-IL Hebrew – Israel\n\n0x0419 1049 ru-RU Russian – Russia\n\n0x0422 1058 uk-UA Ukrainian – Ukraine\n\n0x0423 1059 be-BY Belarusian – Belarus\n\n0x0428 1064 tg-Cyrl-TJ Tajik (Cyrillic) – Tajikistan\n\n0x042B 1067 hy-AM Armenian – Armenia\n\n0x042C 1068 az-Latn-AZ Azeri (Latin) – Azerbaijan\n\n0x043F 1087 kk-KZ Kazakh – Kazakhstan\n\n0x0440 1088 ky-KG Kyrgyz – Kyrgyzstan\n\n0x0442 1090 tk-TM Turkmen – Turkmenistan\n\n0x0443 1091 uz-Latn-UZ Uzbek (Latin) – Uzbekistan\n\n0x0451 1105 bo-CN Tibetan – China\n\n0x0478 1144 ii-CN Yi – China\n\n0x0480 1152 ug-CN Uyghur – China\n\n0x0804 2052 zh-CN Chinese (Simplified) – China\n\n0x0819 2073 ru-MO Russian – Moldova\n\n0x082C 2092 az-Cyrl-AZ Azeri (Cyrillic) – Azerbaijan\n\n\n-----\n\nLCID values taken from the\n\nRagnarok JSON configuration file\n\n### Protection available\n\nSophos XG firewall administrators with questions should refer to the guidance from the\nKnowledge Base entry on this topic.\n\n\n-----\n\nThe EternalBlue exploit, as implemented by the attackers in this attack, cannot infect\ncomputers running Windows 8.1 or Windows 10. The attack only succeeds against\ncomputers running older, unpatched versions of Windows 7. As a matter of course, Sophos\nurges everyone to patch any vulnerable machines on their network.\n\nAdditionally, if any infected device attempts to spread the ransomware to a vulnerable (e.g.,\nunpatched) Windows 7 computer that is running a current version of Sophos Antivirus with\nIntercept X, it will display a notification on the lower right corner of the desktop with the\nfollowing message: “Ransomware blocked in C:\\Users\\Public\\hotfix.exe”\n\nIntercept X has two components which will prevent infection:\n\nAPCViolation – prevents process injection from kernel and userland via an\nasynchronous procedure call (APC) or the global atom table\nCryptoGuard – behavior-driven ransomware protection based on zero trust security\nprinciples\n\nUsers who have Sophos Antivirus with Intercept X were and are protected from Ragnarok\nand the Linux-based files used in the attack by the following definitions updates.\n\nLinux/Agnt-G (ELF binaries and bash scripts)\nTroj/DownLd-BU or Troj/DownLd-BT (Windows DLL downloader components)\nTroj/Ransom-FXR or Troj/Ransom-FXQ or HPmal/Ragrok-A (Ragnarok ransomware)\n\n## Conclusion\n\nRagnarok is a less common threat than other ransomware, and it appears that this threat\nactor’s modus operandi – and the tooling they employ to deliver this ransomware—is quite\ndifferent from those of many other threat actors. It was a rare and notable event to observe a\nLinux ELF application being used to try to spread malware across platforms to Windows\ncomputers.\n\nThis incident highlights the necessity of keeping machines inside the firewall perimeter up to\ndate, and serves as a reminder that any IOT device could be abused as a foothold to reach\nWindows machines. It’s also important for the industry and law enforcement to keep an eye\non this group, because of the potentially outsized impact of an attack against always-on\nnetworked devices.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-21 - Asnarök attackers twice modified attack midstream.pdf"
    ],
    "report_names": [
        "2020-05-21 - Asnarök attackers twice modified attack midstream.pdf"
    ],
    "threat_actors": [
        {
            "id": "e16a6567-2b9a-4419-960b-1e03fccc8812",
            "created_at": "2023-01-06T13:46:39.128684Z",
            "updated_at": "2025-03-27T02:00:03.003292Z",
            "deleted_at": null,
            "main_name": "NOTROBIN",
            "aliases": [],
            "source_name": "MISPGALAXY:NOTROBIN",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "685da616-97dd-4c1d-ae05-b84508d2d69c",
            "created_at": "2024-11-03T02:00:03.632184Z",
            "updated_at": "2025-03-27T02:00:03.43976Z",
            "deleted_at": null,
            "main_name": "Asnarök",
            "aliases": [
                "Personal Panda"
            ],
            "source_name": "MISPGALAXY:Asnarök",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535630,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653785942,
    "ts_modification_date": 1653785942,
    "files": {
        "pdf": "https://archive.orkl.eu/52102c62077abee629f07436893a3c5889730d60.pdf",
        "text": "https://archive.orkl.eu/52102c62077abee629f07436893a3c5889730d60.txt",
        "img": "https://archive.orkl.eu/52102c62077abee629f07436893a3c5889730d60.jpg"
    }
}