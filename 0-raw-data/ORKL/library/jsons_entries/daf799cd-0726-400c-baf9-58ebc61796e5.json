{
    "id": "daf799cd-0726-400c-baf9-58ebc61796e5",
    "created_at": "2023-01-12T15:09:37.172386Z",
    "updated_at": "2025-03-27T02:08:36.014426Z",
    "deleted_at": null,
    "sha1_hash": "528b78f6e2f91d88d7c74c3de8a81223f05f1074",
    "title": "2020-03-30 - Fantastic payloads and where we find them",
    "authors": "",
    "file_creation_date": "2022-05-28T03:41:21Z",
    "file_modification_date": "2022-05-28T03:41:21Z",
    "file_size": 3233352,
    "plain_text": "# Fantastic payloads and where we find them\n\n**[intezer.com/blog/intezer-analyze/fantastic-payloads-and-where-we-find-them](https://intezer.com/blog/intezer-analyze/fantastic-payloads-and-where-we-find-them)**\n\nWritten by Michael Kajiloti - 30 March 2020\n\n## Get Free Account\n\nJoin Now\n\n\nMarch 30, 2020\n\n\nAttackers have long used evasion features in their malware to avoid detection by security\nproducts and analysis systems. One of the most common anti-analysis tricks we have seen\nin today’s Windows malware is the use of packers. Packers often complicate the analysis\nand detection of binary files by hiding the malware’s real code and data; often referred to as\nthe payload.\n\nThe most common solution to overcome packing is the use of dynamic analysis\n(sandboxes) and emulation systems. However, as these solutions have become more\nmainstream, packers have started to incorporate new anti-analysis methods to both detect\nand evade these systems.\n\n\n-----\n\nOne such anti-analysis method which is becoming increasingly popular is the malformation\nor complete removal of the Windows PE header from unpacked malicious payloads. This\ncan make both finding the malware payload and properly analyzing its code more\nchallenging.\n\nWhile removal of Windows PE headers from malicious payloads is not an entirely new\nmethod, we are seeing some of the most popular and sophisticated crimeware families fully\nincorporate this approach into their packers. Below we will present some examples that\ndemonstrate this trend through our Genetic Malware Analysis platform, Intezer Analyze.\n\n**On packers and payloads**\nWhen we investigate a packed malware file, the malware (payload) itself is encrypted or\nencoded and therefore we can’t access its real code and data. Typically, in order to analyze\nthe malware’s code, we must execute the file in a sandboxed environment, let it unpack\nitself, and then grab the payload from memory.\n\nWhile various malware and packers operate in different ways, an abstraction of a typical\nunpacking flow looks like this:\n\nIn this flow we can see that the packer will decode and execute a shellcode component that\nwill in turn decode and execute the real payload. This is just a common scenario; some\npackers will not use a shellcode loader and instead they will unpack the payload directly. It’s\nworth noting that unlike the packer’s code, which is designed to be obfuscated and appear\nrandom, we have observed that these shellcode components are often reused. This means\nthat these components generally have more value than the packer itself when investigating\nthem with code reuse analysis. Therefore, detecting and analyzing this component’s code\ncan be worthwhile for us.\n\nWith that said, finding and analyzing the malware module itself is by far the most effective\nway to properly detect and classify packed malware. The most common way to identify\nmalware payloads in memory is to search for PE header artifacts. Knowing this, many\n\n\n-----\n\nattackers try to stay undetected by removing these artifacts from the PE Header of the\npayload, or by using no PE header at all, as we’ll see soon in the examples presented in\nthis article.\n\n**The many faces of Emotet**\n[Emotet is one of the most widespread malware in the crimeware ecosystem which has](https://www.intezer.com/blog/emotet-evolves-but-code-remains-mostly-the-same/)\nundergone a number of updates since its inception. In particular, we have noticed that this\nmalware is constantly evolving and adapting, both in the malware code itself, and in the\npackers it uses. While switching the packer is relatively inexpensive for the attacker and\nhappens frequently, modifying the malware’s code is much more costly and happens rarely.\n\nAn interesting example of this can be seen when we compare the following Emotet\nsamples:\n\nEmotet sample from June 2019:\n[8e5089260064a955819a92ebccc43d05520e32d234dd3c176bed5f6d0665ebdb](https://analyze.intezer.com/#/analyses/f5619f98-3552-440e-b7f9-fdf0a5bc0111)\nEmotet sample from December 2019:\n[3e8a273f80575ab6079d6512008bb6355b59de978fabc2a9a66c0ed148b94fef](https://analyze.intezer.com/#/analyses/5edfe909-6c21-4d7a-badc-c6d95756cfe3)\n\nWhen looking at the code of the packed files themselves, we can see just how different\nthese samples are, showing no apparent connections to one another:\n\nPacker (June 2019) –\n8e5089260064a955819a92ebccc43d05520e32d234dd3c176bed5f6d0665ebdb\n\n\n-----\n\nPacker (December 2019) –\n3e8a273f80575ab6079d6512008bb6355b59de978fabc2a9a66c0ed148b94fef\n\nBut if we look at the unpacked memory module payloads after undergoing dynamic\nanalysis, we can see that they are nearly identical from a binary code perspective:\n\nPayload (June 2019) –\n8e5089260064a955819a92ebccc43d05520e32d234dd3c176bed5f6d0665ebdb\n\n\n-----\n\nPayload (December 2019) –\n3e8a273f80575ab6079d6512008bb6355b59de978fabc2a9a66c0ed148b94fef\n\nThere is one notable exception: in the December 2019 sample, the payload memory\nmodule has a “malformed header” tag. In this case, this indicates that the packer loaded\nthe module with a PE Header that’s missing certain PE artifacts, such as the “MZ” magic or\nother PE Header constants. This is usually done in an attempt to make it more difficult to\nfind these modules in memory, since the most common method of finding PE memory\nmodules is by scanning for these artifacts.\n\nIt is worth mentioning that in Intezer Analyze we repair the malformed header as part of our\nanalysis process. Downloading and examining the memory module will reveal that it has a\nfull PE header.\n\nIt is also important to note that even in the instance of a constantly evolving threat such as\nEmotet, when the attacker modifies the code of the malware itself, there are still parts that\nremain unchanged. Therefore, when Intezer Analyze executes the malware, finds its\npayload, and then analyzes its code, we can still detect those traces to Emotet’s code that\nhave not been modified.\n\nThis can be observed when we investigate a recent sample of Emotet from March 2020.\nLooking at the packer’s code, we can see that it is different yet again, and has no relations\nto any code we have seen previously:\n\n\n-----\n\nPacker (March 2020) –\nC6684aa4af41685ffc584c1b1bb78855c894b3dae7f6fae4fb572bc02525102f\n\nHowever, when we look at the memory module payload itself, we can see that some of the\ncode is new and has been modified from previous versions. Most importantly, a substantial\npart of the code has been reused from previous Emotet variants that we have seen before:\n\nPayload (March 2020) –\nC6684aa4af41685ffc584c1b1bb78855c894b3dae7f6fae4fb572bc02525102f\n\n**When less is more**\n\nWhile using a malformed PE Header is a relatively simple trick, using no PE header at all is\na more sophisticated and complicated affair. It takes more than just removing a few unused\nmagic constants from the header in order to conceal it. This method requires loading and\nexecuting the payload just like shellcode.\n\nWhen malware authors write and compile the malware payload itself, it is usually compiled\nand built into the form of standard PE files, not position independent shellcode. Directly\nconverting a sophisticated malware’s codebase such as Dridex or TrickBot to run like\nshellcode can be complicated.\n\nMost malware authors choose a simpler option, using a packer that unpacks and loads the\npayload module without using its PE Header at load time. These packers typically store the\nrelevant information from the PE header, such as API import and relocations data, in a\ncustom structure during packing time. The packer then uses that structure during the\nunpacking process in order to properly load the malware code.\n\n**Same Dridex, new tricks**\n\nAn example of a popular malware that has recently adopted such a packer is the Dridex\nbanking trojan. Let’s compare two recent Dridex samples from February 2020:\n\n[9b6ffb05ec826b3fbff7db04ebd187e2f956a5730af1d36e10a9f56ee1bb767a](https://analyze.intezer.com/#/analyses/9fdbb152-275f-4cb3-beaa-4acc33a28a52)\n[45e0408d3ae2647cb9be835a5277eb7de41c83d8e473d22d5b3772c2f65305fb](https://analyze.intezer.com/#/analyses/66328685-405d-4445-9437-2942e125aed4)\n\n\n-----\n\nSimilar to Emotet, these packed files are very different from one another at the code level,\nshowing no resemblance:\n\n[Packer – 9b6ffb05ec826b3fbff7db04ebd187e2f956a5730af1d36e10a9f56ee1bb767a](https://analyze.intezer.com/#/analyses/9fdbb152-275f-4cb3-beaa-4acc33a28a52)\n\n[Packer – 45e0408d3ae2647cb9be835a5277eb7de41c83d8e473d22d5b3772c2f65305fb](https://analyze.intezer.com/#/analyses/66328685-405d-4445-9437-2942e125aed4)\n\nHowever, when we look at the payloads themselves, we can see again that they are\nactually very similar:\n\n\n-----\n\n[Payload – 9b6ffb05ec826b3fbff7db04ebd187e2f956a5730af1d36e10a9f56ee1bb767a](https://analyze.intezer.com/#/analyses/9fdbb152-275f-4cb3-beaa-4acc33a28a52/sub/d47a060e-c241-42c5-8f20-ea00a849a042)\n\n[Payload – 45e0408d3ae2647cb9be835a5277eb7de41c83d8e473d22d5b3772c2f65305fb](https://analyze.intezer.com/#/analyses/66328685-405d-4445-9437-2942e125aed4/sub/cd707392-6139-4d9a-bded-253719d943da)\n\nThere is one notable exception here as well, but in this case it is much more substantial. In\nthe second payload we can see the “fileless_code” tag, which indicates this module has\nno PE header. Downloading and examining this module will make it known that it is indeed\na binary file with no structure.\n\nIntezer Analyze detects these modules during dynamic analysis and analyzes their code\neven though no PE Header is present. It will also detect any other shellcode pieces that are\nused by the malware.\n\n**Look ma! No heads!**\n\nTo demonstrate how prevalent this trend is, let’s look at the analyses of recent samples of\nthe [Ursnif and](https://analyze.intezer.com/#/analyses/b166869f-beda-4010-bf28-d50717750df9) [TrickBot malware. When looking at the dynamic analysis modules, we see](https://analyze.intezer.com/#/files/26d61225f07e39d9e35880631c5043626eb8e3846a526a44015d3a5d03642d55)\nseveral different malicious modules that are detected and analyzed:\n\n\n-----\n\nIf we review them more closely, we will see that all of them — minus copies of the original\npacker file — have the “fileless_code” tag, indicating that they are all shellcode-style\nmodules with no PE header:\n\n[TrickBot – 26d61225f07e39d9e35880631c5043626eb8e3846a526a44015d3a5d03642d55](https://analyze.intezer.com/#/files/26d61225f07e39d9e35880631c5043626eb8e3846a526a44015d3a5d03642d55/sub/3d431957-aae3-42b6-8582-0b214f0f824d)\n\n\n-----\n\n**Conclusion**\n\nThe use of pure shellcode and shellcode-style components in modern malware seems to be\na growing trend, one that is being adopted by some of the most successful malware\ndevelopers. At the same time, when we identify and analyze these components using code\nreuse analysis, we can see that they are mostly just a different version of the same thing.\n[We encourage you to analyze your files using the free Intezer Analyze community edition.](https://analyze.intezer.com/#/analyze)\nYou might detect malicious payloads that you didn’t expect to find!\n\n**Michael Kajiloti**\nMichael is a security researcher turned product manager, who previously led the Intezer\nAnalyze product lifecycle. He has presented his malware research at conferences such as\nREcon and the Chaos Communications Congress (CCC).\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-30 - Fantastic payloads and where we find them.pdf"
    ],
    "report_names": [
        "2020-03-30 - Fantastic payloads and where we find them.pdf"
    ],
    "threat_actors": [
        {
            "id": "77b28afd-8187-4917-a453-1d5a279cb5e4",
            "created_at": "2022-10-25T15:50:23.768278Z",
            "updated_at": "2025-03-27T02:00:55.5423Z",
            "deleted_at": null,
            "main_name": "Inception",
            "aliases": [
                "Inception Framework",
                "Cloud Atlas"
            ],
            "source_name": "MITRE:Inception",
            "tools": [
                "PowerShower",
                "VBShower",
                "LaZagne"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536177,
    "ts_updated_at": 1743041316,
    "ts_creation_date": 1653709281,
    "ts_modification_date": 1653709281,
    "files": {
        "pdf": "https://archive.orkl.eu/528b78f6e2f91d88d7c74c3de8a81223f05f1074.pdf",
        "text": "https://archive.orkl.eu/528b78f6e2f91d88d7c74c3de8a81223f05f1074.txt",
        "img": "https://archive.orkl.eu/528b78f6e2f91d88d7c74c3de8a81223f05f1074.jpg"
    }
}