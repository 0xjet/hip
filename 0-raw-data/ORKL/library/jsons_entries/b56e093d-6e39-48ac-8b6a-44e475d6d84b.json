{
    "id": "b56e093d-6e39-48ac-8b6a-44e475d6d84b",
    "created_at": "2023-01-12T15:10:42.878325Z",
    "updated_at": "2025-03-27T02:05:30.390268Z",
    "deleted_at": null,
    "sha1_hash": "d044c4929955a4c8db6de94b861828a955891f6d",
    "title": "2019-10-02 - McAfee ATR Analyzes Sodinokibi aka REvil Ransomware-as-a-Service – What The Code Tells Us",
    "authors": "",
    "file_creation_date": "2022-05-28T04:57:40Z",
    "file_modification_date": "2022-05-28T04:57:40Z",
    "file_size": 1896569,
    "plain_text": "# McAfee ATR Analyzes Sodinokibi aka REvil Ransomware- as-a-Service – What The Code Tells Us\n\n**securingtomorrow.mcafee.com/other-blogs/mcafee-labs/mcafee-atr-analyzes-sodinokibi-aka-revil-ransomware-as-a-**\nservice-what-the-code-tells-us/\n\nOctober 2, 2019\n\n## Episode 1: What the Code Tells Us\n\nMcAfee’s Advanced Threat Research team (ATR) observed a new ransomware family in the\nwild, dubbed Sodinokibi (or REvil), at the end of April 2019. Around this same time, the\nGandCrab ransomware crew announced they would shut down their operations.\nCoincidence? Or is there more to the story?\n\nIn this series of blogs, we share fresh analysis of Sodinokibi and its connections to\nGandCrab, with new insights gleaned exclusively from McAfee ATR’s in-depth and extensive\nresearch.\n\nEpisode 1: [What the Code Tells Us](https://securingtomorrow.mcafee.com/other-blogs/mcafee-labs/mcafee-atr-analyzes-sodinokibi-aka-revil-ransomware-as-a-service-what-the-code-tells-us/)\n\n\n-----\n\nEpisode 2: [The All-Stars](https://securingtomorrow.mcafee.com/other-blogs/mcafee-labs/mcafee-atr-analyzes-sodinokibi-aka-revil-ransomware-as-a-service-the-all-stars/)\nEpisode 3: [Follow the Money](https://securingtomorrow.mcafee.com/other-blogs/mcafee-labs/mcafee-atr-analyzes-sodinokibi-aka-revil-ransomware-as-a-service-follow-the-money/)\nEpisode 4: [Crescendo](https://securingtomorrow.mcafee.com/other-blogs/mcafee-labs/mcafee-atr-analyzes-sodinokibi-aka-revil-ransomware-as-a-service-crescendo/)\n\nIn this first instalment we share our extensive malware and post-infection analysis and\nvisualize exactly how big the Sodinokibi campaign is.\n\n## Background\n\nSince its arrival in April 2019, it has become very clear that the new kid in town, “Sodinokibi”\nor “REvil” is a serious threat. The name Sodinokibi was discovered in the hash\nccfde149220e87e97198c23fb8115d5a where ‘Sodinokibi.exe’ was mentioned as the internal\nfile name; it is also known by the name of REvil.\n\nAt first, Sodinokibi ransomware was observed propagating itself by exploiting a vulnerability\nin Oracle’s WebLogic server. However, similar to some other ransomware families,\nSodinokibi is what we call a Ransomware-as-a-Service (RaaS), where a group of people\nmaintain the code and another group, known as affiliates, spread the ransomware.\n\nThis model allows affiliates to distribute the ransomware any way they like. Some affiliates\nprefer mass-spread attacks using phishing-campaigns and exploit-kits, where other affiliates\nadopt a more targeted approach by brute-forcing RDP access and uploading tools and\nscripts to gain more rights and execute the ransomware in the internal network of a victim.\nWe have investigated several campaigns spreading Sodinokibi, most of which had different\nmodus operandi but we did notice many started with a breach of an RDP server.\n\n## Who and Where is Sodinokibi Hitting?\n\n[Based on visibility from MVISION Insights we were able to generate the below picture of](https://www.mcafee.com/enterprise/en-us/solutions/lp/mvision-insights.html?eid=RBUULBZJ&smcid=BL&utm_campaign=MV_INS_19Q3&utm_source=mcafeeblog&utm_medium=organic)\ninfections observed from May through August 23, 2019:rd\n\n\n-----\n\nWho is the target? Mostly organizations, though it really depends on the skills and expertise\nfrom the different affiliate groups on who, and in which geo, they operate.\n\n## Reversing the Code\n\nIn this first episode, we will dig into the code and explain the inner workings of the\nransomware once it has executed on the victim’s machine.\n\nOverall the code is very well written and designed to execute quickly to encrypt the defined\nfiles in the configuration of the ransomware. The embedded configuration file has some\ninteresting options which we will highlight further in this article.\n\nBased on the code comparison analysis we conducted between GandCrab and Sodinokibi\nwe consider it a likely hypothesis that the people behind the Sodinokibi ransomware may\nhave some type of relationship with the GandCrab crew.\n\n\n-----\n\n-----\n\nFIGURE 1.1. OVERVIEW OF SODINOKIBI S EXECUTION FLAW\n\n## Inside the Code\n\n Sodinokibi Overview\n\nFor this article we researched the sample with the following hash (packed):\n\n**The main goal of this malware, as other ransomware families, is to encrypt your files**\n**and then request a payment in return for a decryption tool from the authors or**\n**affiliates to decrypt them.**\n\nThe malware sample we researched is a 32-bit binary, with an icon in the packed file and\nwithout one in the unpacked file. The packer is programmed in Visual C++ and the malware\nitself is written in pure assembly.\n\n## Technical Details\n\nThe goal of the packer is to decrypt the true malware part and use a RunPE technique to run\nit from memory. To obtain the malware from memory, after the decryption is finished and is\nloaded into the memory, we dumped it to obtain an unpacked version.\n\nThe first action of the malware is to get all functions needed in runtime and make a dynamic\nIAT to try obfuscating the Windows call in a static analysis.\n\n\n-----\n\nFIGURE 2. THE MALWARE GETS ALL FUNCTIONS NEEDED IN RUNTIME\n\nThe next action of the malware is trying to create a mutex with a hardcoded name. It is\nimportant to know that the malware has 95% of the strings encrypted inside. Consider that\neach sample of the malware has different strings in a lot of places; values as keys or seeds\nchange all the time to avoid what we, as an industry do, namely making vaccines or creating\none decryptor without taking the values from the specific malware sample to decrypt the\nstrings.\n\n\n-----\n\nFIGURE 3. CREATION OF A MUTEX AND CHECK TO SEE IF IT ALREADY EXISTS\n\nIf the mutex exists, the malware finishes with a call to “ExitProcess.” This is done to avoid relaunching of the ransomware.\n\nAfter this mutex operation the malware calculates a CRC32 hash of a part of its data using a\nspecial seed that changes per sample too. This CRC32 operation is based on a CRC32\npolynomial operation instead of tables to make it faster and the code-size smaller.\n\nThe next step is decrypting this block of data if the CRC32 check passes with success. If the\ncheck is a failure, the malware will ignore this flow of code and try to use an exploit as will be\nexplained later in the report.\n\nFIGURE 4. CALCULATION OF THE CRC32 HASH OF THE CRYPTED CONFIG AND\nDECRYPTION IF IT PASSES THE CHECK\n\nIn the case that the malware passes the CRC32 check and decrypts correctly with a key that\nchanges per sample, the block of data will get a JSON file in memory that will be parsed.\nThis config file has fields to prepare the keys later to encrypt the victim key and more\ninformation that will alter the behavior of the malware.\n\n\n-----\n\nThe CRC32 check avoids the possibility that somebody can change the crypted data with\nanother config and does not update the CRC32 value in the malware.\n\nAfter decryption of the JSON file, the malware will parse it with a code of a full JSON parser\nand extract all fields and save the values of these fields in the memory.\n\nFIGURE 5. PARTIAL EXAMPLE OF THE CONFIG DECRYPTED AND CLEANED\n\nLet us explain all the fields in the config and their meanings:\n\npk -> This value encoded in base64 is important later for the crypto process; it is the\npublic key of the attacker.\npid -> The affiliate number that belongs to the sample.\nsub -> The subaccount or campaign id for this sample that the affiliate uses to keep\ntrack of its payments.\ndbg -> Debug option. In the final version this is used to check if some things have been\ndone or not; it is a development option that can be true or false. In the samples in the\nwild it is in the false state. If it is set, the keyboard check later will not happen. It is\nuseful for the malware developers to prove the malware works correctly in the critical\npart without detecting his/her own machines based on the language.\n\n\n-----\n\nfast -> If this option is enabled, and by default a lot of samples have it enabled, the\nmalware will crypt the first 1 megabyte of each target file, or all files if it is smaller than\nthis size. In the case that this field is false, it will crypt all files.\nwipe -> If this option is ‘true’, the malware will destroy the target files in the folders that\nare described in the json field “wfld”. This destruction happens in all folders that have\nthe name or names that appear in this field of the config in logic units and network\nshares. The overwriting of the files can be with trash data or null data, depending of the\nsample.\nwht -> This field has some subfields: fld -> Folders that should not be crypted; they are\nwhitelisted to avoid destroying critical files in the system and programs. fls -> List of\nwhitelists of files per name; these files will never be crypted and this is useful to avoid\ndestroying critical files in the system. ext -> List of the target extensions to avoid\nencrypting based on extension.\nwfld -> A list of folders where the files will be destroyed if the wipe option is enabled.\nprc -> List of processes to kill for unlocking files that are locked by this/these\nprogram/s, for example, “mysql.exe”.\ndmn -> List of domains that will be used for the malware if the net option is enabled;\nthis list can change per sample, to send information of the victim.\nnet -> This value can be false or true. By default, it is usually true, meaning that the\nmalware will send information about the victim if they have Internet access to the\ndomain list in the field “dmn” in the config.\nnbody -> A big string encoded in base64 that is the template for the ransom note that\nwill appear in each folder where the malware can create it.\nnname -> The string of the name of the malware for the ransom note file. It is a\ntemplate that will have a part that will be random in the execution.\nexp -> This field is very important in the config. By default it will usually be ‘false’, but if\nit is ‘true’, or if the check of the hash of the config fails, it will use the exploit CVE-20188453. The malware has this value as false by default because this exploit does not\nalways work and can cause a Blue Screen of Death that avoids the malware’s goal to\nencrypt the files and request the ransom. If the exploit works, it will elevate the process\nto SYSTEM user.\nimg -> A string encoded in base64. It is the template for the image that the malware will\ncreate in runtime to change the wallpaper of the desktop with this text.\n\nAfter decrypting the malware config, it parses it and the malware will check the “exp” field\nand if the value is ‘true’, it will detect the type of the operative system using the PEB fields\nthat reports the major and minor version of the OS.\n\n\n-----\n\nFIGURE 6. CHECK OF THE VERSION OF THE OPERATIVE SYSTEM\n\nUsually only one OS can be found but that is enough for the malware. The malware will\ncheck the file-time to verify if the date was before or after a patch was installed to fix the\nexploit. If the file time is before the file time of the patch, it will check if the OS is 64-bit or 32bit using the function “GetSystemNativeInfoW”. When the OS system is 32-bit, it will use a\nshellcode embedded in the malware that is the exploit and, in the case of a 64-bit OS, it will\nuse another shellcode that can use a “Heaven´s Gate” to execute code of 64 bits in a\nprocess of 32 bits.\n\nFIGURE 7. CHECK IF OS IS 32- OR 64-BIT\n\nIn the case that the field was false, or the exploit is patched, the malware will check the OS\nversion again using the PEB. If the OS is Windows Vista, at least it will get from the own\nprocess token the level of execution privilege. When the discovered privilege level is less\nthan 0x3000 (that means that the process is running as a real administrator in the system or\nSYSTEM), it will relaunch the process using the ‘runas’ command to elevate to 0x3000\nprocess from 0x2000 or 0x1000 level of execution. After relaunching itself with the ‘runas’\ncommand the malware instance will finish.\n\n\n-----\n\nFIGURE 8. CHECK IF OS IS WINDOWS VISTA MINIMAL AND CHECK OF EXECUTION\nLEVEL\n\nThe malware’s next action is to check if the execute privilege is SYSTEM. When the execute\nprivilege is SYSTEM, the malware will get the process “Explorer.exe”, get the token of the\nuser that launched the process and impersonate it. It is a downgrade from SYSTEM to\nanother user with less privileges to avoid affecting the desktop of the SYSTEM user later.\n\nAfter this it will parse again the config and get information of the victim’s machine This\ninformation is the user of the machine, the name of the machine, etc. The malware prepares\na victim id to know who is affected based in two 32-bit values concat in one string in\nhexadecimal.\n\nThe first part of these two values is the serial number of the hard disk of the Windows main\nlogic unit, and the second one is the CRC32 hash value that comes from the CRC32 hash of\nthe serial number of the Windows logic main unit with a seed hardcoded that change per\nsample.\n\n\n-----\n\nFIGURE 9. GET DISK SERIAL NUMBER TO MAKE CRC32 HASH\n\nAfter this, the result is used as a seed to make the CRC32 hash of the name of the\nprocessor of the machine. But this name of the processor is not extracted using the Windows\nAPI as GandCrab does; in this case the malware authors use the opcode CPUID to try to\nmake it more obfuscated.\n\nFIGURE 10. GET THE PROCESSOR NAME USING CPUID OPCODE\n\nFinally, it converts these values in a string in a hexadecimal representation and saves it.\n\nLater, during the execution, the malware will write in the Windows registry the next entries in\nthe subkey “SOFTWARE\\recfg” (this subkey can change in some samples but usually does\nnot).\n\nThe key entries are:\n\n0_key -> Type binary; this is the master key (includes the victim’s generated random\nkey to crypt later together with the key of the malware authors).\n\n\n-----\n\nsk_key -> As 0_key entry, it is the victim s private key crypted but with the affiliate\npublic key hardcoded in the sample. It is the key used in the decryptor by the affiliate,\nbut it means that the malware authors can always decrypt any file crypted with any\nsample as a secondary resource to decrypt the files.\npk_key -> Victim public key derivate from the private key.\nsubkey -> Affiliate public key to use.\nstat -> The information gathered from the victim machine and used to put in the ransom\nnote crypted and in the POST send to domains.\nrnd_ext -> The random extension for the encrypted files (can be from 5 to 10\nalphanumeric characters).\n\nThe malware tries to write the subkey and the entries in the HKEY_LOCAL_MACHINE hive\nat first glance and, if it fails, it will write them in the HKEY_CURRENT_USER hive.\n\nFIGURE 11. EXAMPLE OF REGISTRY ENTRIES AND SUBKEY IN THE HKLM HIVE\n\nThe information that the malware gets from the victim machine can be the user name, the\nmachine name, the domain where the machine belongs or, if not, the workgroup, the product\nname (operating system name), etc.\n\nAfter this step is completed, the malware will check the “dbg” option gathered from the config\nand, if that value is ‘true’, it will avoid checking the language of the machine but if the value is\n‘false’ ( by default), it will check the machine language and compare it with a list of\nhardcoded values.\n\n\n-----\n\nFIGURE 12. GET THE KEYBOARD LANGUAGE OF THE SYSTEM\n\nThe malware checks against the next list of blacklisted languages (they can change per\nsample in some cases):\n\n**0x818 – Romanian (Moldova)**\n**0x419 – Russian**\n**0x819 – Russian (Moldova)**\n**0x422 – Ukrainian**\n**0x423 – Belarusian**\n**0x425 – Estonian**\n**0x426 – Latvian**\n**0x427 – Lithuanian**\n**0x428 – Tajik**\n**0x429 – Persian**\n**0x42B – Armenian**\n**0x42C – Azeri**\n**0x437 – Georgian**\n**0x43F – Kazakh**\n**0x440 – Kyrgyz**\n**0x442 –Turkmen**\n**0x443 – Uzbek**\n\n\n-----\n\n**0x444 – Tatar**\n**0x45A – Syrian**\n**0x2801 – Arabic (Syria)**\n\nWe observed that Sodinokibi, like GandCrab and Anatova, are blacklisting the regular Syrian\nlanguage and the Syrian language in Arabic too. If the system contains one of these\nlanguages, it will exit without performing any action. If a different language is detected, it will\ncontinue in the normal flow.\n\nThis is interesting and may hint to an affiliate being involved who has mastery of either one\nof the languages. This insight became especially interesting later in our investigation.\n\nIf the malware continues, it will search all processes in the list in the field “prc” in the config\nand terminate them in a loop to unlock the files locked for this/these process/es.\n\nFIGURE 13. SEARCH FOR TARGET PROCESSES AND TERMINATE THEM\n\nAfter this it will destroy all shadow volumes of the victim machine and disable the protection\nof the recovery boot with this command:\n\nexe /c vssadmin.exe Delete Shadows /All /Quiet & bcdedit /set {default}\nrecoveryenabled No & bcdedit /set {default} bootstatuspolicy ignoreallfailures\n\nIt is executed with the Windows function “ShellExecuteW”.\n\n\n-----\n\nFIGURE 14. LAUNCH COMMAND TO DESTROY SHADOW VOLUMES AND DESTROY\nSECURITY IN THE BOOT\n\nNext it will check the field of the config “wipe” and if it is true will destroy and delete all files\nwith random trash or with NULL values. If the malware destroys the files, it will start\nenumerating all logic units and finally the network shares in the folders with the name that\nappear in the config field “wfld”.\n\n\n-----\n\nFIGURE 15. WIPE FILES IN THE TARGET FOLDERS\n\nIn the case where an affiliate creates a sample that has defined a lot of folders in this field,\nthe ransomware can be a solid wiper of the full machine.\n\nThe next action of the malware is its main function, encrypting the files in all logic units and\nnetwork shares, avoiding the white listed folders and names of files and extensions, and\ndropping the ransom note prepared from the template in each folder.\n\n\n-----\n\nFIGURE 16. CRYPT FILES IN THE LOGIC UNITS AND NETWORK SHARES\n\nAfter finishing this step, it will create the image of the desktop in runtime with the text that\ncomes in the config file prepared with the random extension that affect the machine.\n\nThe next step is checking the field “net” from the config, and, if true, will start sending a\nPOST message to the list of domains in the config file in the field “dmn”.\n\n\n-----\n\nFIGURE 17. PREPARE THE FINAL URL RANDOMLY PER DOMAIN TO MAKE THE POST\nCOMMAND\n\nThis part of the code has similarities to the code of GandCrab, which we will highlight later in\nthis article.\n\nAfter this step the malware cleans its own memory in vars and strings but does not remove\nthe malware code, but it does remove the critical contents to avoid dumps or forensics tools\nthat can gather some information from the RAM.\n\n\n-----\n\nFIGURE 18. CLEAN MEMORY OF VARS\n\nIf the malware was running as SYSTEM after the exploit, it will revert its rights and finally\nfinish its execution.\n\nFIGURE 19. REVERT THE SYSTEM PRIVILEGE EXECUTION LEVEL\n\n## Code Comparison with GandCrab\n\nUsing the unpacked Sodinokibi sample and a v5.03 version of GandCrab, we started to use\nIDA and BinDiff to observe any similarities. Based on the Call-Graph it seems that there is an\noverall 40 percent code overlap between the two:\n\n\n-----\n\nFIGURE 20. CALL-GRAPH COMPARISON\n\nThe most overlap seems to be in the functions of both families. Although values change,\ngoing through the code reveals similar patterns and flows:\n\nAlthough here and there are some differences, the structure is similar:\n\n\n-----\n\nWe already mentioned that the code part responsible for the random URL generation has\nsimilarities with regards to how it is generated in the GandCrab malware. Sodinokibi is using\none function to execute this part where GandCrab is using three functions to generate the\nrandom URL. Where we do see some similar structure is in the parts for the to-be-generated\nURL in both malware codes. We created a visual to explain the comparison better:\n\nFIGURE 21. URL GENERATION COMPARISON\n\nWe observe how even though the way both ransomware families generate the URL might\ndiffer, the URL directories and file extensions used have a similarity that seems to be more\n[than coincidence. This observation was also discovered by Tesorion in one of its blogs.](https://www.tesorion.nl/aconnection-between-the-sodinokibi-and-gandcrab-ransomware-families/)\n\nOverall, looking at the structure and coincidences, either the developers of the GandCrab\ncode used it as a base for creating a new family or, another hypothesis, is that people got\nhold of the leaked GandCrab source code and started the new RaaS Sodinokibi.\n\n## Conclusion\n\nSodinokibi is a serious new ransomware threat that is hitting many victims all over the world.\n\n\n-----\n\nWe executed an in-depth analysis comparing GandCrab and Sodinokibi and discovered a lot\nof similarities, indicating the developer of Sodinokibi had access to GandCrab source-code\nand improvements. The Sodinokibi campaigns are ongoing and differ in skills and tools due\nto the different affiliates operating these campaigns, which begs more questions to be\nanswered. How do they operate? And is the affiliate model working? McAfee ATR has the\n[answers in episode 2, “The All Stars.”](https://securingtomorrow.mcafee.com/other-blogs/mcafee-labs/mcafee-atr-analyzes-sodinokibi-aka-revil-ransomware-as-a-service-the-all-stars/)\n\n## Coverage\n\nMcAfee is detecting this family by the following signatures:\n\n“Ransom-Sodinokibi”\n“Ransom-REvil!”.\n\n## MITRE ATT&CK Techniques\n\nThe malware sample uses the following MITRE ATT&CK™ techniques:\n\nFile and Directory Discovery\nFile Deletion\nModify Registry\nQuery Registry\nRegistry modification\nQuery information of the user\nCrypt Files\nDestroy Files\nMake C2 connections to send information of the victim\nModify system configuration\nElevate privileges\n\n## YARA Rule\n\n\n-----\n\nrule Sodinokobi\n{\n\n/*\n\nThis rule detects Sodinokobi Ransomware in memory in old samples and perhaps future.\n\n*/\n\nmeta:\n\nauthor   = “McAfee ATR team”\n\nversion   = “1.0”\n\ndescription = “This rule detect Sodinokobi Ransomware in memory in old samples and\nperhaps future.”\n\nstrings:\n\n$a = { 40 0F B6 C8 89 4D FC 8A 94 0D FC FE FF FF 0F B6 C2 03 C6 0F B6 F0 8A 84 35\nFC FE FF FF 88 84 0D FC FE FF FF 88 94 35 FC FE FF FF 0F B6 8C 0D FC FE FF FF }\n\n$b = { 0F B6 C2 03 C8 8B 45 14 0F B6 C9 8A 8C 0D FC FE FF FF 32 0C 07 88 08 40 89\n45 14 8B 45 FC 83 EB 01 75 AA }\n\ncondition:\n\nall of them\n\n}\n\n[McAfee Labs Threat Research Team](https://www.mcafee.com/blogs/author/mcafee-labs/)\nMcAfee Labs is one of the leading sources for threat research, threat intelligence, and\ncybersecurity thought leadership. See our blog posts below for more information.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-10-02 - McAfee ATR Analyzes Sodinokibi aka REvil Ransomware-as-a-Service – What The Code Tells Us.pdf"
    ],
    "report_names": [
        "2019-10-02 - McAfee ATR Analyzes Sodinokibi aka REvil Ransomware-as-a-Service – What The Code Tells Us.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536242,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1653713860,
    "ts_modification_date": 1653713860,
    "files": {
        "pdf": "https://archive.orkl.eu/d044c4929955a4c8db6de94b861828a955891f6d.pdf",
        "text": "https://archive.orkl.eu/d044c4929955a4c8db6de94b861828a955891f6d.txt",
        "img": "https://archive.orkl.eu/d044c4929955a4c8db6de94b861828a955891f6d.jpg"
    }
}