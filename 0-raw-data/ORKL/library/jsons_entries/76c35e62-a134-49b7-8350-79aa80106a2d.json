{
    "id": "76c35e62-a134-49b7-8350-79aa80106a2d",
    "created_at": "2023-01-12T15:05:29.443035Z",
    "updated_at": "2025-03-27T02:06:11.958043Z",
    "deleted_at": null,
    "sha1_hash": "b847e80f2a09f2b56ea3b0d422233379ea8efd35",
    "title": "2020-12-07 - Egregor Ransomware - An In-Depth Analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T18:29:45Z",
    "file_modification_date": "2022-05-28T18:29:45Z",
    "file_size": 3540615,
    "plain_text": "# Egregor Ransomware - An In-Depth Analysis\n\n**blog.minerva-labs.com/egregor-ransomware-an-in-depth-analysis**\n\n[Tweet](https://twitter.com/share)\n\n\n-----\n\nMinerva Labs undertook a detailed research of the Egregor ransomware, with the goal of providing an in depth analysis of how it\nworks to infect a target. Better knowledge of threat actor's techniques can help security experts detect and mitigate novel threats,\nwhich is especially important considering the recent evolution of ransomware. In the scope of this research we have tried to\ndetermine what evasive techniques the malware uses.\n\n[The recent surge in Egregor ransomware and the code similarity to Sekhmet and Maze ransomware strains leads us to believe](https://blog.minerva-labs.com/minervalabs-vs-sekhmet?hsLang=en-us)\nthat they probably share the same code base. In addition, similar code obfuscation techniques are used by Maze and Egregor,\nwhich slow the analysis process and hinder researchers.\n\nBlog Posts about Egregor detail varying degrees of obfuscation. In our case both the loader and the actual ransomware were\nhighly obfuscated, which forced us to write deobfuscation scripts that ease the analysis process.\n\n## The Loader\n\nThe ransomware we encountered is a DLL file named b.dll. The file was executed manually using the following command line:\n\nA look at the disassembly of the code indicates that it is highly obfuscated with compiler-based techniques, which makes static\nanalysis of the code quite time consuming.\n\nFor example, see below the function DllRegisterServer, which the attacker uses to launch the ransomware, in IDA's graph view:\n\nThe obfuscation Egregor uses is similar to the one used in Maze ransomware. We were able to modify Blueliv’s Maze\n[deobfuscation script (the blogpost and the original script can be found here) to fit Egregors obfuscation patterns, which allowed for](https://www.blueliv.com/cyber-security-and-cyber-threat-intelligence-blog-blueliv/escape-from-the-maze/)\neasier analysis of the ransomware.\n\nThe loader checks for the command line “--nop” and exits if it exists.\n\nAs for further unpacking, a large blob of data is decrypted with the following steps:\n\nThe blob is xor decoded with a hardcoded key (0x4 in our sample).\nThe xor’ed data is then Base64 decoded using the windows API function CryptStringToBinaryA.\n\n\n-----\n\nA hardcoded key and IV is initialized for the ChaCha20 algorithm, which is then used for the final decryption of the payload.\nThe malware authors decided to change the number of rounds of key rotations from the default of 20 to only 4.\n\nAfter decrypting the second payload, a DLL file, it is copied to a new allocation that is created using VirtualAlloc with the page\npermissions RWX.\n\nThe last stage of the initial loader is the preparation of the payload in memory. The malware reflectively loads the decrypted\npayload and uses the function CreateThread to transfer execution to its next stage.\n\nThe next stage parses the command line, looking specifically for the parameter -p, which contains a password that is used for the\ndecryption of the ransomware binary. The ransomware is decrypted using a stream cipher that shares some of its constants with\nRabbit cipher:\n\n**Ransomware Code:**\nThe ransomware is compiled as a DLL file with only one export named “DllEntryPoint”. The function creates a thread that executes\nthe main subroutine of the ransomware:\n\nBefore starting the ransomware’s malicious procedure, a function is called to determine the locale of the workstation. The\nransomware uses three different Windows API functions to make sure it is not encrypting a computer located in Russia or any\nother CIS country:\n\n\n-----\n\nEgregor will terminate if any of the following locales are found:\n\nLocale Code Country\n\n0x843 Uzbek - Cyrillic\n\n0x819 Russian - Moldova\n\n0x440 Kyrgyz - Cyrillic\n\n0x442 Turkmen\n\n0x82C Azerbaijani\n\n0x423 Belarusian\n\n0x42B Armenian\n\n0x443 Uzbek - Latin\n\n0x43F Kazakh\n\n0x437 Georgian\n\n0x42C Azerbaijani\n\n0x818 Romanian - Moldova\n\n0x444 Tatar\n\n0x428 Tajik\n\n\n-----\n\nAfter the locale check, the ransom configuration will be decrypted from a buffer located in the data section of the executable. The\nfirst 8 bytes of the encrypted configuration starts with a PNG header which is skipped by the parser before its decryption. The\nsubsequent DWORD contains the size of the configuration to decrypt. Starting from offset 12, the configuration will be decrypted\nusing round-modified ChaCha20 and a hardcoded key and IV.\n\nThe encrypted configuration in-memory:\n\nDecompilation of the configuration class initialization function:\n\nThe configuration contains several interesting settings:\n\nThe ransom note.\nList of processes to terminate.\nBlacklisted keywords for the services termination algorithm.\nA hardcoded RSA 2048-bit public key which is used for the file encryption scheme.\nFlags for the presence of remote addresses.\n\nIn order to create a fingerprint of the encrypted workstation Egregor uses several API functions to extract information about the\nmachine:\n\nThe ransomware uses the API functions GetLogicalDriveStrings and GetDiskFreeSpace to identify the names and types of the\nlogical disks connected to the device in addition to the amount of free space available in them.\n\nThe ransomware RSA public key in memory stored in the encrypted configuration:\n\n\n-----\n\nFor each execution, a pair of private and public keys are generated. The public key is used for encrypting the symmetrical keys\nthat would later be used for encrypting each file. A unique symmetrical key is generated for every file to be encrypted.\n\nEgregor’s key generation scheme is as follows:\n\nA 2048-bit RSA key pair is generated using CryptGenKey – this is the session key.\nThe key is then exported using the API CryptExportKey.\nThe exported private key is encrypted with ChaCha using a randomly generated key and IV.\nThe ChaCha keys are encrypted using the function CryptEncrypt and the configuration-embedded RSA public key.\nThe encrypted ChaCha key and the encrypted session key are saved to disk in a hardcoded path, which in our case is\n%ProgramData%\\dtb.dat.\n\nIt is worth noting that the ransomware encrypts the session key with the same protocol that is used to decrypt the ransomware\npayload (Rabbit Cipher).\n\nThe ransomware will stop certain processes and services before encrypting the machine. A list of hardcoded process names is\nstored in the encrypted configuration file and the malware uses NtQuerySystemInformation to enumerate the running processes\nand terminates them using the function NtTerminateProcess.\n\nThe list of processes that will be terminated, in our sample (a list will also be available in the IOCs section):\n\nAs for the service stopping algorithm, the ransomware configuration contains a list of strings that will be used to determine which\nservice should be stopped. Services names will be enumerated using the API function EnumServicesStatus. Any service name\nthat contains the blacklisted strings will be stopped using windows Service Control Manager API.\n\nThe list of services keywords in the configuration:\n\nEgregor has the capability to contact hardcoded HTTP URLs. If the offset 0x3a31e and 0x32fb in the configuration does not\ncontain 0, the ransomware will contact IP address/DNS names (which are also embedded in the configuration), and decode their\ncontent using the same modified-ChaCha20/Base64 combination used before.\n\n[The IDAPython deobfuscation script can be found here.](https://github.com/MinervaLabs/Egregor-Deobfuscation)\n\n### IOCs:\n\n**Hashes:**\n\nb9b71eb04d255b21e3272eef5f4c15d1c208183748dfad3569efd455d87879c6 (Egregor loader)\n\n\n-----\n\n8d5ad342ea9fde48920a926780be432236d074d34f791b5c96ec3a418a1bbbd5\n\n(unpacked ransomware from memory)\n\n**Files:**\n\n%ProgramData%\\dtb.dat\n\nRECOVER-FILES.TXT\n\n**Terminated Processes:**\n\nmsftesql.exe agntsvc.exe tbirdconfig.exe excel.exe thebat.exe procmon.exe procexp.exe\n\nsqlagent.exe isqlplussvc.exe mydesktopqos.exe infopath.exe steam.exe procmon64.exe procexp64.exe\n\nsqlbrowser.exe xfssvccon.exe ocomm.exe msaccess.exe thebat64.exe ipython.exe wpython.exe\n\nsqlwriter.exe sqlservr.exe mysqld.exe mspub.exe thunderbird.exe python.exe dumpcap.exe\n\noracle.exe dbeng50.exe mysqld-nt.exe onenote.exe visio.exe QBW64.exe synctime.exe\n\nocssd.exe ocautoupds.exe mysqld-opt.exe outlook.exe winword.exe firefoxconfig.exe sqlservr.exe\n\ndbsnmp.exe encsvc.exe mydesktopservice.exe powerpnt.exe wordpad.exe sqbcoreservice.exe QBW32.exe\n\n## References:\n\n[ChaCha20 - https://en.wikipedia.org/wiki/Salsa20](https://en.wikipedia.org/wiki/Salsa20)\n[Rabbit Cipher - https://en.wikipedia.org/wiki/Rabbit_(cipher)](https://en.wikipedia.org/wiki/Rabbit_(cipher))\nBlueliv’s maze deobfuscation - https://www.blueliv.com/cyber-security-and-cyber-threat-intelligence-blog-blueliv/escape-fromthe-maze/\n[Minerva Labs Sekhmet - https://blog.minerva-labs.com/minervalabs-vs-sekhmet](https://blog.minerva-labs.com/minervalabs-vs-sekhmet?hsLang=en-us)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-07 - Egregor Ransomware - An In-Depth Analysis.pdf"
    ],
    "report_names": [
        "2020-12-07 - Egregor Ransomware - An In-Depth Analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535929,
    "ts_updated_at": 1743041171,
    "ts_creation_date": 1653762585,
    "ts_modification_date": 1653762585,
    "files": {
        "pdf": "https://archive.orkl.eu/b847e80f2a09f2b56ea3b0d422233379ea8efd35.pdf",
        "text": "https://archive.orkl.eu/b847e80f2a09f2b56ea3b0d422233379ea8efd35.txt",
        "img": "https://archive.orkl.eu/b847e80f2a09f2b56ea3b0d422233379ea8efd35.jpg"
    }
}