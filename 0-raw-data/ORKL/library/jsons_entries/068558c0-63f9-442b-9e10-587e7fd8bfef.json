{
    "id": "068558c0-63f9-442b-9e10-587e7fd8bfef",
    "created_at": "2023-01-12T15:10:00.847636Z",
    "updated_at": "2025-03-27T02:12:03.956274Z",
    "deleted_at": null,
    "sha1_hash": "8ae8d32a520c910bee6606b0d728d3154245eeb0",
    "title": "2021-03-25 - Analyzing attacks taking advantage of the Exchange Server vulnerabilities",
    "authors": "",
    "file_creation_date": "2022-05-28T23:10:48Z",
    "file_modification_date": "2022-05-28T23:10:48Z",
    "file_size": 1038736,
    "plain_text": "# Analyzing attacks taking advantage of the Exchange Server vulnerabilities\n\n**[microsoft.com/security/blog/2021/03/25/analyzing-attacks-taking-advantage-of-the-exchange-server-vulnerabilities/](https://www.microsoft.com/security/blog/2021/03/25/analyzing-attacks-taking-advantage-of-the-exchange-server-vulnerabilities/)**\n\nMarch 25, 2021\n\nMicrosoft continues to monitor and investigate attacks exploiting the recent on-premises Exchange Server vulnerabilities. These\nattacks are now performed by multiple threat actors ranging from financially motivated cybercriminals to state-sponsored groups.\n[To help customers who are not able to immediately install updates, Microsoft released a one-click tool that automatically mitigates](https://msrc-blog.microsoft.com/2021/03/15/one-click-microsoft-exchange-on-premises-mitigation-tool-march-2021/)\n[one of the vulnerabilities and scans servers for known attacks. Microsoft also built this capability into Microsoft Defender Antivirus,](https://www.microsoft.com/security/blog/2021/03/18/automatic-on-premises-exchange-server-mitigation-now-in-microsoft-defender-antivirus/)\nexpanding the reach of the mitigation. As of today, we have seen a significant decrease in the number of still-vulnerable servers –\nmore than 92% of known worldwide Exchange IPs are now patched or mitigated. We continue to work with our customers and\npartners to mitigate the vulnerabilities.\n\nAs organizations recover from this incident, we continue to publish guidance and share threat intelligence to help detect and evict\nthreat actors from affected environments. Today, we are sharing intelligence about what some attackers did after exploiting the\nvulnerable servers, ranging from ransomware to data exfiltration and deployment of various second-stage payloads. This blog\ncovers:\n\nThreat intelligence and technical details about known attacks, including components and attack paths, that defenders can use\nto investigate whether on-premises Exchange servers were compromised before they were patched and to comprehensively\nrespond to and remediate these threats if they see them in their environments.\nDetection and automatic remediation built into Microsoft Defender Antivirus and how investigation and remediation\ncapabilities in solutions like Microsoft Defender for Endpoint can help responders perform additional hunting and remediate\nthreats.\n\nAlthough the overall numbers of ransomware have remained extremely small to this point, it is important to remember that these\nthreats show how quickly attackers can pivot their campaigns to take advantage of newly disclosed vulnerabilities and target\nunpatched systems, demonstrating how critical it is for organizations to apply security updates as soon as possible. We strongly\nurge organizations to identify and update vulnerable on-premises Exchange servers, and to follow mitigation and investigation\n[guidance that we have collected and continue to update here: https://aka.ms/ExchangeVulns.](https://aka.ms/ExchangeVulns)\n\n## Mitigating post-exploitation activities\n\nThe first known attacks leveraging the Exchange Server vulnerabilities were by the nation-state actor HAFNIUM, which we detailed\nin [this blog. In the three weeks after the Exchange server vulnerabilities were disclosed and the security updates were released,](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)\nMicrosoft saw numerous other attackers adopting the exploit into their toolkits. Attackers are known to rapidly work to reverse\n\n\n-----\n\nengineer patches and develop exploits. In the case of a remote code execution (RCE) vulnerability, the rewards are high for\nattackers who can gain access before an organization patches, as patching a system does not necessarily remove the access of\nthe attacker.\n\n_Figure 1. The Exchange Server exploit chain_\n\nIn our investigation of the on-premises Exchange Server attacks, we saw systems being affected by multiple threats. Many of the\n**compromised systems have not yet received a secondary action, such as human-operated ransomware attacks or data**\nexfiltration, indicating attackers could be establishing and keeping their access for potential later actions. These actions might\ninvolve performing follow-on attacks via persistence on Exchange servers they have already compromised, or using credentials\nand data stolen during these attacks to compromise networks through other entry vectors.\n\nAttackers who included the exploit in their toolkits, whether through modifying public proof of concept exploits or their own\nresearch, capitalized on their window of opportunity to gain access to as many systems as they could. Some attackers were\nadvanced enough to remove other attackers from the systems and use multiple persistence points to maintain access to a network.\n\nWe have built protections against these threats into Microsoft security solutions. Refer to the Appendix for a list of indicators of\ncompromise, detection details, and advanced hunting queries. We have also provided additional tools and investigation and\n[remediation guidance here: https://aka.ms/exchange-customer-guidance.](https://aka.ms/exchange-customer-guidance)\n\nWhile performing a full investigation on systems is recommended, the following themes are common in many of the attacks. These\nare prevailing threat trends that Microsoft has been monitoring, and existing solutions and recommendations for prevention and\nmitigation apply:\n\nWeb shells – As of this writing, many of the unpatched systems we observed had multiple web shells on them. Microsoft has\nbeen tracking the rise of web shell attacks for the past few years, ensuring our products detect these threats and providing\n[remediation guidance for customers. For more info on web shells, read Web shell attacks continue to rise. We have also](https://www.microsoft.com/security/blog/2021/02/11/web-shell-attacks-continue-to-rise/)\n[published guidance on web shell threat hunting with Azure Sentinel.](http://aka.ms/exchange-web-shell-investigation)\nHuman-operated ransomware – Ransomware attacks pose some of the biggest security risks for organizations today, and\nattackers behind these attacks were quick to take advantage of the on-premises Exchange Server vulnerabilities.\nSuccessfully exploiting the vulnerabilities gives attackers the ability to launch human-operated ransomware campaigns, a\ntrend that Microsoft has been closely monitoring. For more information about human-operated ransomware attacks, including\n[Microsoft solutions and guidance for improving defenses, read: Human-operated ransomware attacks.](https://www.microsoft.com/security/blog/2020/03/05/human-operated-ransomware-attacks-a-preventable-disaster/)\nCredential theft – While credential theft is not the immediate goal of some of these attacks, access to Exchange servers\nallowed attackers to access and potentially steal credentials present on the system. Attackers can use these stolen\ncredentials for follow-on attacks later, so organizations need to prioritize identifying and remediating impacted identities. For\nmore information, read best practices for building credential hygiene.\n\nIn the following sections, we share our analysis of known post-compromise activities associated with exploitation of the Exchange\nserver vulnerabilities because it is helpful to understand these TTPs, in order to defend against other actors using similar tactics or\ntools. While levels of disruptive post-compromise activity like ransomware may be limited at the time of this writing, Microsoft will\ncontinue to track this space and share information with the community. It’s important to note that with some post-compromise\ntechniques, attackers may gain highly privileged persistent access, but many of the impactful subsequent attacker activities\n**can be mitigated by practicing the principle of least privilege and mitigating lateral movement.**\n\n\n-----\n\n## DoejoCrypt ransomware\n\nDoejoCrypt was the first ransomware to appear to take advantage of the vulnerabilities, starting to encrypt in limited numbers\nshortly after the patches were released. Ransomware attackers often use multiple tools and exploits to gain initial access, including\npurchasing access through a broker or “reseller” who sells access to systems they have already compromised. The DoejoCrypt\nattacks start with a variant of the Chopper web shell being deployed to the Exchange server post-exploitation.\n\nThe web shell writes a batch file to C:\\Windows\\Temp\\xx.bat. Found on all systems that received the DoejoCrypt ransomware\npayload, this batch file performs a backup of the Security Account Manager (SAM) database and the System and Security registry\nhives, allowing the attackers later access to passwords of local users on the system and, more critically, in the LSA Secrets portion\nof the registry, where passwords for services and scheduled tasks are stored.\n\n_Figure 2. xx.bat_\n\nGiven configurations that administrators typically use on Exchange servers, many of the compromised systems are likely to have\nhad at least one service or scheduled task configured with a highly privileged account to perform actions like backups. As service\n**account credentials are not frequently changed, this could provide a great advantage to an attacker even if they lose their**\n**initial web shell access due to an antivirus detection, as the account can be used to elevate privileges later, which is why we**\nstrongly recommend operating under the principle of least privileged access.\n\nThe batch file saves the registry hives to a semi-unique location, C:\\windows\\temp\\debugsms, assembles them into a CAB file for\nexfiltration, and then cleans up the folders from the system. The file also enables Windows Remote Management and sets up an\nHTTP listener, indicating the attacker might take advantage of the internet-facing nature of an Exchange Server and use this\nmethod for later access if other tools are removed.\n\n_Figure 3. xx.bat actions_\n\nThe xx.bat file has been run on many more systems than have been ransomed by the DoejoCrypt attacker, meaning that, while not\nall systems have moved to the ransom stage, the attacker has gained access to multiple credentials. On systems where the\nattacker moved to the ransom stage, we saw reconnaissance commands being run via the same web shell that dopped the xx.bat\nfile (in this instance, a version of Chopper):\n\n_Figure 4. DoejoCrypt recon command_\n\n\n-----\n\nAfter these commands are completed, the web shell drops a new payload to C:\\Windows\\Help which, like in many human operated\nransomware campaigns, leads to the attack framework Cobalt Strike. In observed instances, the downloaded payload is shellcode\nwith the file name new443.exe or Direct_Load.exe. When run, this payload injects itself into notepad.exe and reaches out to a C2\nto download Cobalt Strike shellcode.\n\n_Figure 5. DoejoCrypt ransomware attack chain_\n\nDuring the hands-on-keyboard stage of the attack, a new payload is downloaded to C:\\Windows\\Help with names like s1.exe and\n_s2.exe. This payload is the DoejoCrypt ransomware, which uses a .CRYPT extension for the newly encrypted files and a very basic_\n_readme.txt ransom note. In some instances, the time between xx.bat being dropped and a ransomware payload running was under_\nhalf an hour.\n\n_Figure 6. DoejoCrypt ransom note_\n\nWhile the DoejoCrypt payload is the most visible outcome of the attackers’ actions, the access to credentials they have gained\ncould serve them for future campaigns if organizations do not reset credentials on compromised systems. An additional\noverlapping activity observed on systems where xx.bat was present and the attackers were able to get Domain Administrator rights\nwas the running of scripts to snapshot Active Directory with ntdsutil—an action that, if executed successfully, could give the\nattackers access to all the passwords in Active Directory from a single compromised system.\n\n## Lemon Duck botnet\n\nCryptocurrency miners were some of the first payloads we observed being dropped by attackers from the post-exploit web shells.\nIn the first few days after the security updates were released, we observed multiple cryptocurrency miner campaigns, which had\nbeen previously targeting SharePoint servers, add Exchange Server exploitation to their repertoire. Most of these coin miners were\nvariations on XMRig miners, and many arrived via a multi-featured implant with the capability to download new payloads or even\nmove laterally.\n\nLemon Duck, a known cryptocurrency botnet named for a variable in its code, dove into the Exchange exploit action, adopting\ndifferent exploit styles and choosing to use a fileless/web shell-less option of direct PowerShell commands from w3wp (the IIS\nworker process) for some attacks. While still maintaining their normal email-based campaigns, the Lemon Duck operators\ncompromised numerous Exchange servers and moved in the direction of being more of a malware loader than a simple miner.\n\nUsing a form of the attack that allows direct execution of commands versus dropping a web shell, the Lemon Duck operators ran\nstandard Invoke Expression commands to download a payload. Having used the same C2 and download servers for some time,\nthe operators applied a varied degree of obfuscation to their commands on execution.\n\n_Fig 7. Example executions of Lemon Duck payload downloads_\n\nThe Lemon Duck payload is an encoded and obfuscated PowerShell script. It first removes various security products from the\nsystem, then creates scheduled tasks and WMI Event subscription for persistence. A second script is downloaded to attempt to\nevade Microsoft Defender Antivirus abusing their administrative access to run the Set-MPPreference command to disable real\n\n-----\n\n[time monitoring (a tactic that Microsoft Defender Tamper protection blocks) and add scanning exclusions for the C:\\ drive and the](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-antivirus/prevent-changes-to-security-settings-with-tamper-protection)\nPowerShell process.\n\n_Figure 8. Lemon Duck payloads_\n\nOne randomly named scheduled task connects to a C2 every hour to download a new payload, which includes various lateral\n[movement and credential theft tools. The operators were seen to download RATs and information stealers, including Ramnit](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Win32/Ramnit)\npayloads.\n\n_Figure 9. Lemon Duck post-exploitation activities_\n\nIn some instances, the operators took advantage of having compromised mail servers to access mailboxes and send emails\ncontaining the Lemon Duck payload using various colorful email subjects.\n\n\n-----\n\n_Figure 10. Email subjects of possibly malicious emails_\n\n_Figure 11. Attachment variables_\n\nIn one notable example, the Lemon Duck operators compromised a system that already had xx.bat and a web shell. After\nestablishing persistence on the system in a non-web shell method, the Lemon Duck operators were observed cleaning up other\nattackers’ presence on the system and mitigating the CVE-2021-26855 (SSRF) vulnerability using a legitimate cleanup script that\nthey hosted on their own malicious server. This action prevents further exploitation of the server and removes web shells, giving\nLemon Duck exclusive access to the compromised server. This stresses the need to fully investigate systems that were exposed,\neven if they have been fully patched and mitigated, per traditional incident response process.\n\n## Pydomer ransomware\n\nWhile DoejoCrypt was a new ransomware payload, the access gained by attackers via the on-premises Exchange Server\nvulnerabilities will likely become part of the complex cybercriminal economy where additional ransomware operators and affiliates\ntake advantage of it. The first existing ransomware family to capitalize on the vulnerabilities was Pydomer. This ransomware family\nwas previously seen using vulnerabilities in attacks, notably taking advantage of Pulse Secure VPN vulnerabilities, for which Pulse\nSecure has released security patches, to steal credentials and perform ransomware attacks.\n\nIn this campaign, the operators scanned and mass-compromised unpatched Exchange Servers to drop a web shell. They started\nlater than some other attackers, with many compromises occurring between March 18 and March 20, a window when fewer\nunpatched systems were available. They then dropped a web shell, with a notable file name format: “Chack[Word][Country\nabbreviation]”:\n\n_Figure 12. Example web shell names observed being used by the Pydomer attackers_\n\nThese web shells were observed on around 1,500 systems, not all of which moved to the ransomware stage. The attackers then\nused their web shell to dump a test.bat batch file that performed a similar function in the attack chain to the xx.bat of the\nDoejoCrypt operators and allowed them to perform a dump of the LSASS process.\n\n\n-----\n\n_Figure 13. Pydomer post-exploitation activities_\n\nThis access alone would be valuable to attackers for later attacks, similar to the credentials gained during their use of Pulse Secure\nVPN vulnerabilities. The highly privileged credentials gained from an Exchange system are likely to contain domain administrator\naccounts and service accounts with backup privileges, meaning these attackers could perform ransomware and exfiltration actions\nagainst the networks they compromised long after the Exchange Server is patched and even enter via different means.\n\nOn systems where the attackers did move to second-stage ransomware operations, they utilized a Python script compiled to an\nexecutable and the Python cryptography libraries to encrypt files. The attackers then executed a PowerShell script via their web\nshell that acts as a downloader and distribution mechanism for the ransomware.\n\n_Figure 14. PowerShell downloader and spreader used to get the Pydomer payload_\n\nThe script fetches a payload from a site hosted on a domain generation algorithm (DGA) domain, and attempts to spread the\npayload throughout the network, first attempting to spread the payload over WMI using Invoke-WMIMethod to attempt to connect to\nsystems, and falling back to PowerShell remoting with Enter-PSSession if that fails. The script is run within the context of the web\nshell, which in most instances is Local System, so this lateral movement strategy is unlikely to work except in organizations that are\nrunning highly insecure and unrecommended configurations like having computer objects in highly privileged groups.\n\nThe Pydomer ransomware is a Python script compiled to an executable and uses the Python cryptography libraries to encrypt files.\nThe ransomware encrypts the files and appends a random extension, and then drops a ransom note named decrypt_file.TxT.\n\n\n-----\n\n_Figure 15. Pydomer ransom note_\n\nInterestingly, the attackers seem to have deployed a non-encryption extortion strategy. Following well-known ransomware groups\nlike Maze and Egregor which leaked data for pay, the Pydomer hackers dropped an alternative readme.txt onto systems without\nencrypting files. This option might have been semi-automated on their part or a side effect of a failure in their encryption process,\nas some of the systems they accessed were test systems that showed no data exfiltration. The note should be taken seriously if\nencountered, as the attackers had full access to systems and were likely able to exfiltrate data.\n\n_Figure 16. Pydomer extortion readme.txt_\n\n## Credential theft, turf wars, and dogged persistence\n\nIf a server is not running in a least-privilege configuration, credential theft could provide a significant return on investment for an\nattacker beyond their initial access to email and data. Many organizations have backup agent software and scheduled tasks\nrunning on these systems with domain admin-level permissions. For these organizations, the attackers might be able to harvest\nhighly privileged credentials without lateral movement, for example, using the COM services DLL as a living-off-the-land binary to\nperform a dump of the LSASS process:\n\n_Figure 17. Use of COM services DLL to dump LSASS process_\n\nThe number of observed credential theft attacks, combined with high privilege of accounts often given to Exchange servers, means\nthat these attacks could continue to impact organizations that don’t fully remediate after a compromise even after patches have\nbeen applied. While the observed ransomware attempts were small-scale or had errors, there is still the possibility of more skillful\ngroups utilizing credentials gained in these attacks for later attacks.\n\nAttackers also used their access to perform extensive reconnaissance using built-in Exchange commandlets and dsquery to\nexfiltrate information about network configurations, user information, and email assets.\n\nWhile Lemon Duck operators might have had the boldest method for removing other attackers from the systems they\ncompromised, they were not the only attacker to do so. Others were observed cleaning up .aspx and .bat files to remove other\nattackers, and even rebuilding the WMI database by deleting .mof files and restarting the service. As the window on unpatched\nmachines closes, attackers showed increased interest in maintaining the access to the systems they exploited. By utilizing\n\n\n-----\n\nmalwareless persistence mechanisms like enabling RDP, installing Shadow IT tools, and adding new local administrator\naccounts, the attackers are hoping to evade incident response efforts that might focus exclusively on web shells, AV scans, and\npatching.\n\n## Defending against exploits and post-compromise activities\n\nAttackers exploit the on-premises Exchange Server vulnerabilities in combination to bypass authentication and gain the ability to\nwrite files and run malicious code. The best and most complete remediation for these vulnerabilities is to update to a supported\nCumulative Update and to install all security updates. Comprehensive mitigation guidance can be found here:\n[https://aka.ms/ExchangeVulns.](https://aka.ms/ExchangeVulns)\n\nAs seen in the post-exploitation attacks discussed in this blog, the paths that attackers can take after successfully exploiting the\nvulnerabilities are varied and wide-ranging. If you have determined or have reason to suspect that these threats are present on\nyour network, here are immediate steps you can take:\n\nInvestigate exposed Exchange servers for compromise, regardless of their current patch status.\n[Look for web shells via our guidance and run a full AV scan using the Exchange On-Premises Mitigation Tool.](https://aka.ms/exchange-customer-guidance)\nInvestigate Local Users and Groups, even non-administrative users for changes, and ensure all users require a password for\nsign-in. New user account creations (represented by Event ID 4720) during the time the system was vulnerable might indicate\na malicious user creation.\n[Reset and randomize local administrator passwords with a tool like LAPS if you are not already doing so.](https://aka.ms/laps)\nLook for changes to the RDP, firewall, WMI subscriptions, and Windows Remote Management (WinRM) configuration of the\nsystem that might have been configured by the attacker to allow persistence.\nLook for Event ID 1102 to determine if attackers cleared event logs, an activity that attackers perform with exe in an attempt\nto hide their tracks.\nLook for new persistence mechanisms such as unexpected services, scheduled tasks, and startup items.\nLook for Shadow IT tools that attackers might have installed for persistence, such as non-Microsoft RDP and remote access\nclients.\nCheck mailbox-level email forwarding settings (both ForwardingAddress and ForwardingSMTPAddress attributes), check\nmailbox inbox rules (which might be used to forward email externally), and check Exchange Transport rules that you might\nnot recognize.\n\nWhile our response tools check for and remove known web shells and attack tools, performing a full investigation of these systems\nis recommended. For comprehensive investigation and mitigation guidance and tools, see https://aka.ms/exchange-customerguidance.\n\nAdditionally, here are best practices for building credential hygiene and practicing the principle of least privilege:\n\n[Follow guidance to run Exchange in least-privilege configuration: https://adsecurity.org/?p=4119.](https://adsecurity.org/?p=4119)\nEnsure service accounts and scheduled tasks run with the least privileges they need. Avoid widely privileged groups like\ndomain admins and backup operators and prefer accounts with access to just the systems they need.\n[Randomize local administrator passwords to prevent lateral movement with tools like LAPS.](https://aka.ms/laps)\n[Ensure administrators practice good administration habits like Privileged Admin Workstations.](https://docs.microsoft.com/en-us/security/compass/overview)\nPrevent privileged accounts like domain admins from signing into member servers and workstations using Group Policy to\nlimit credential exposure and lateral movement.\n\n## Appendix\n\n### Microsoft Defender for Endpoint detection details\n\n**Antivirus**\n\nMicrosoft Defender Antivirus detects exploitation behavior with these detections:\n\nBehavior:Win32/Exmann\n[Behavior:Win32/IISExchgSpawnEMS](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Behavior:Win32/IISExchgSpawnEMS.A&threatId=-2147212928)\n[Exploit:ASP/CVE-2021-27065](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Exploit:ASP/CVE-2021-27065)\nExploit:Script/Exmann\nTrojan:Win32/IISExchgSpawnCMD\n[Behavior:Win32/IISExchgDropWebshell](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Behavior:Win32/IISExchgDropWebshell.B&threatId=-2147190469)\n\n\n-----\n\nWeb shells are detected as:\n\n[Backdoor:JS/Webshell](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Backdoor:JS/WebShell&threatId=-2147233581)\n[Backdoor:PHP/Chopper](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Backdoor:PHP/Chopper.B!dha&threatId=-2147231664)\nBackdoor:ASP/Chopper\nBackdoor:MSIL/Chopper\n[Trojan:JS/Chopper](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Trojan:JS/Chopper!dha&threatId=-2147232033)\nTrojan:Win32/Chopper\n[Behavior:Win32/WebShellTerminal](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Behavior:Win32/WebShellTerminal.A&threatId=-2147213299)\n\nRansomware payloads and associated files are detected as:\n\n[Trojan:BAT/Wenam – xx.bat behaviors](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Trojan:BAT/Wenam.A&threatId=-2147188992)\n[Ransom:Win32/DoejoCrypt – DoejoCrypt ransomware](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Ransom:Win32/DoejoCrypt.A&threatId=-2147189904)\n[Trojan:PowerShell/Redearps – PowerShell spreader in Pydomer attacks](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Trojan:PowerShell/Redearps.A&threatId=-2147189091)\n[Ransom:Win64/Pydomer – Pydomer ransomware](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Ransom:Win64/Pydomer.A&threatId=-2147189083)\n\nLemon Duck malware is detected as:\n\n[Trojan:PowerShell/LemonDuck](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Trojan:PowerShell/LemonDuck.A&threatId=-2147189579)\n[Trojan:Win32/LemonDuck](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Trojan:Win32/LemonDuck.A&threatId=-2147189576)\n\nSome of the credential theft techniques highlighted in this report are detected as:\n\n[Behavior:Win32/DumpLsass](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Behavior:Win32/DumpLsass.A!attk&threatId=-2147237471)\nBehavior:Win32/RegistryExfil\n\n**Endpoint detection and response (EDR)**\n\nAlerts with the following titles in the security center can indicate threat activity on your network:\n\nSuspicious Exchange UM process creation\nSuspicious Exchange UM file creation\nSuspicious w3wp.exe activity in Exchange\nPossible exploitation of Exchange Server vulnerabilities\nPossible IIS web shell\nPossible web shell installation\nWeb shells associated with Exchange Server vulnerabilities\nNetwork traffic associated with Exchange Server exploitation\n\nAlerts with the following titles in the security center can indicate threat activity on your network specific to the DoejoCrypt and\nPydomer ransomware campaign:\n\nDoejoCrypt ransomware\nPydomer ransomware\nPydomer download site\n\nAlerts with the following titles in the security center can indicate threat activity on your network specific to the Lemon Duck botnet:\n\nLemonDuck Malware\nLemonDuck botnet C2 domain activity\n\nThe following behavioral alerts might also indicate threat activity associated with this threat:\n\nPossible web shell installation\nA suspicious web script was created\nSuspicious processes indicative of a web shell\nSuspicious file attribute change\nSuspicious PowerShell command line\nPossible IIS Web Shell\nProcess memory dump\nA malicious PowerShell Cmdlet was invoked on the machine\nWDigest configuration change\n\n\n-----\n\nSensitive information lookup\nSuspicious registry export\n\n### Advanced hunting\n\nTo locate possible exploitation activities in Microsoft Defender for Endpoint, run the following queries.\n\n**Processes run by the IIS worker process**\n\nLook for processes executed by the IIS worker process\n```\n// Broadly search for processes executed by the IIS worker process. Further investigation should be\nperformed on any devices where the created process is indicative of reconnaissance\nDeviceProcessEvents\n| where InitiatingProcessFileName == 'w3wp.exe'\n| where InitiatingProcessCommandLine contains \"MSExchange\"\n| where FileName !in~\n(\"csc.exe\",\"cvtres.exe\",\"conhost.exe\",\"OleConverter.exe\",\"wermgr.exe\",\"WerFault.exe\",\"TranscodingService.exe\")\n| project FileName, ProcessCommandLine, InitiatingProcessCommandLine, DeviceId, Timestamp\n\n```\nSearch for PowerShell spawned from the IIS worker process, observed most frequently in Lemon Duck with Base64 encoding to\nobfuscate C2 domains\n```\nDeviceProcessEvents\n| where FileName =~ \"powershell.exe\"\n| where InitiatingProcessFileName =~ \"w3wp.exe\"\n| where InitiatingProcessCommandLine contains \"MSExchange\"\n| project ProcessCommandLine, InitiatingProcessCommandLine, DeviceId, Timestamp\n\n```\n**Tampering**\n\nSearch for Lemon Duck tampering with Microsoft Defender Antivirus\n```\nDeviceProcessEvents\n| where InitiatingProcessCommandLine has_all (\"Set-MpPreference\", \"DisableRealtimeMonitoring\", \"AddMpPreference\", \"ExclusionProcess\")\n| project ProcessCommandLine, InitiatingProcessCommandLine, DeviceId, Timestamp\n\n```\n**Batch script actions**\n\nSearch for batch scripts performing credential theft, as observed in DoejoCrypt infections\n```\nDeviceProcessEvents\n| where InitiatingProcessFileName == \"cmd.exe\"\n| where InitiatingProcessCommandLine has \".bat\" and InitiatingProcessCommandLine has @\"C:\\Windows\\Temp\"\n| where ProcessCommandLine has \"reg save\"\n| project ProcessCommandLine, InitiatingProcessCommandLine, DeviceId, Timestamp\n\n```\nLook for evidence of batch script execution that leads to credential dumping\n```\n// Search for batch script execution, leading to credential dumping using rundll32 and the COM Services\nDLL, dsquery, and makecab use\nDeviceProcessEvents\n| where InitiatingProcessFileName =~ \"cmd.exe\"\n| where InitiatingProcessCommandLine has \".bat\" and InitiatingProcessCommandLine has\n@\"\\inetpub\\wwwroot\\aspnet_client\\\"\n| where InitiatingProcessParentFileName has \"w3wp\"\n| where FileName != \"conhost.exe\"\n| project FileName, ProcessCommandLine, InitiatingProcessCommandLine, DeviceId, Timestamp\n\n```\n**Suspicious files dropped under an aspnet_client folder**\n\nLook for dropped suspicious files like web shells and other components\n```\n// Search for suspicious files, including but not limited to batch scripts and web shells, dropped under\nthe file path C:\\inetpub\\wwwroot\\aspnet_client\\\nDeviceFileEvents\n\n```\n\n-----\n\n```\n| g p\n| where FolderPath has \"\\\\aspnet_client\\\\\"\n| where InitiatingProcessCommandLine contains \"MSExchange\"\n| project FileName, FolderPath, InitiatingProcessCommandLine, DeviceId, Timestamp\n\n```\n**Checking for persistence on systems that have been suspected as compromised**\n\nSearch for creations of new local accounts\n```\nDeviceProcessEvents\n| where FileName == \"net.exe\"\n| where ProcessCommandLine has_all (\"user\", \"add\")\n| project ProcessCommandLine, InitiatingProcessCommandLine, DeviceId, Timestamp\n\n```\n**Search for installation events that were used to download ScreenConnect for persistence**\n\nNote that this query may be noisy and is not necessarily indicative of malicious activity alone.\n```\nDeviceProcessEvents\n| where FileName =~ \"msiexec.exe\"\n| where ProcessCommandLine has @\"C:\\Windows\\Temp\\\"\n| parse-where kind=regex flags=i ProcessCommandLine with @\"C:\\\\Windows\\\\Temp\\\\\" filename:string @\".msi\"\n| project filename, ProcessCommandLine, InitiatingProcessCommandLine, DeviceId, Timestamp\n\n```\n**Hunting for credential theft**\n\nSearch for logon events related to services and scheduled tasks on devices that may be Exchange servers. The results of this\nquery should be used to verify whether any of these users have privileged roles that might have enabled further persistence.\n```\nlet devices =\nDeviceProcessEvents\n| where InitiatingProcessFileName == \"w3wp.exe\" and InitiatingProcessCommandLine contains \"MSExchange\"\n| distinct DeviceId;\n//\nDeviceLogonEvents\n| where DeviceId in (devices)\n| where LogonType in (\"Batch\", \"Service\")\n| project AccountName, AccountDomain, LogonType, DeviceId, Timestamp\n\n```\nSearch for WDigest registry key modification, which allows for the LSASS process to store plaintext passwords.\n```\nDeviceRegistryEvents\n| where RegistryValueName == \"UseLogonCredential\"\n| where RegistryKey has \"WDigest\" and RegistryValueData == \"1\"\n| project PreviousRegistryValueData, RegistryValueData, RegistryKey, RegistryValueName,\nInitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessParentFileName, DeviceId,\nTimestamp\n\n```\nSearch for the COM services DLL being executed by rundll32, which can be used to dump LSASS memory.\n```\nDeviceProcessEvents\n| where InitiatingProcessCommandLine has_all (\"rundll32.exe\", \"comsvcs.dll\")\n| project FileName, ProcessCommandLine, InitiatingProcessFileName, InitiatingProcessCommandLine,\nInitiatingProcessParentFileName, DeviceId, Timestamp\n\n```\nSearch for Security Account Manager (SAM) or SECURITY databases being saved, from which credentials can later be extracted.\n```\nDeviceProcessEvents\n| where FileName == \"reg.exe\"\n| where ProcessCommandLine has \"save\" and ProcessCommandLine has_any (\"hklm\\\\security\", \"hklm\\\\sam\")\n| project InitiatingProcessFileName, InitiatingProcessCommandLine, FileName, ProcessCommandLine,\nInitiatingProcessParentFileName, DeviceId, Timestamp\n\n## Indicators\n\n```\nSelected indicators from attacks are included here, the threats may utilize files and network indicators not represented here.\n\n\n-----\n\n**Files (SHA 256)**\n\nThe following are file hashes for some of the web shells observed during attacks:\n\n201e4e9910dcdc8c4ffad84b60b328978db8848d265c0b9ba8473cf65dcd0c41\n2f0bc81c2ea269643cae307239124d1b6479847867b1adfe9ae712a1d5ef135e\n4edc7770464a14f54d17f36dc9d0fe854f68b346b27b35a6f5839adf1f13f8ea\n511df0e2df9bfa5521b588cc4bb5f8c5a321801b803394ebc493db1ef3c78fa1\n65149e036fff06026d80ac9ad4d156332822dc93142cf1a122b1841ec8de34b5\n811157f9c7003ba8d17b45eb3cf09bef2cecd2701cedb675274949296a6a183d\n8e90ed33c7ee82c0b64078ea36ec95f7420ba435c693b3b3dd728b494abf7dfc\na291305f181e24fe7194154b4cd355ccb039d5765709c80999e392efec69c90a\nb75f163ca9b9240bf4b37ad92bc7556b40a17e27c2b8ed5c8991385fe07d17d0\ndd29e8d47dde124c7d14e614e03ccaab3ecaa50e0a0bef985ed59e98928bc13d\n\nDoejoCrypt associated hashes:\n\n027119161d11ba87acc908a1d284b93a6bcafccc012e52ce390ecb9cd745bf27\n10bce0ff6597f347c3cca8363b7c81a8bff52d2ff81245cd1e66a6e11aeb25da\n2b9838da7edb0decd32b086e47a31e8f5733b5981ad8247a2f9508e232589bff\n904fbea2cd68383f32c5bc630d2227601dc52f94790fe7a6a7b6d44bfd904ff3\nbf53b637683f9cbf92b0dd6c97742787adfbc12497811d458177fdeeae9ec748\ne044d9f2d0f1260c3f4a543a1e67f33fcac265be114a1b135fd575b860d2b8c6\nfdec933ca1dd1387d970eeea32ce5d1f87940dfb6a403ab5fc149813726cbd65\nfeb3e6d30ba573ba23f3bd1291ca173b7879706d1fe039c34d53a4fdcdf33ede\n\nLemon Duck associated hashes:\n\n0993cc228a74381773a3bb0aa36a736f5c41075fa3201bdef4215a8704e582fc\n3df23c003d62c35bd6da90df12826c1d3fdd94029bf52449ba3d89920110d5ec\n4f0b9c0482595eee6d9ece0705867b2aae9e4ff68210f32b7425caca763723b9\n56101ab0881a6a34513a949afb5a204cad06fd1034f37d6791f3ab31486ba56c\n69ce57932c3be3374e8843602df1c93e1af622fc53f3f1d9b0a75b66230a1e2e\n737752588f32e4c1d8d20231d7ec553a1bd4a0a090b06b2a1835efa08f9707c4\n893ddf0de722f345b675fd1ade93ee1de6f1cad034004f9165a696a4a4758c3e\n9cf63310788e97f6e08598309cbbf19960162123e344df017b066ca8fcbed719\n9f2fe33b1c7230ec583d7f6ad3135abcc41b5330fa5b468b1c998380d20916cd\na70931ebb1ce4f4e7d331141ad9eba8f16f98da1b079021eeba875aff4aeaa85\nd8b5eaae03098bead91ff620656b9cfc569e5ac1befd0f55aee4cdb39e832b09\ndb093418921aae00187ae5dc6ed141c83614e6a4ec33b7bd5262b7be0e9df2cd\ndc612f5c0b115b5a13bdb9e86f89c5bfe232e5eb76a07c3c0a6d949f80af89fd\nf517526fc57eb33edb832920b1678d52ad1c5cf9c707859551fe065727587501\nf8d388f502403f63a95c9879c806e6799efff609001701eed409a8d33e55da2f\nfbeefca700f84373509fd729579ad7ea0dabdfe25848f44b2fbf61bf7f909df0\n\nPydomer associated hashes:\n\n7e07b6addf2f0d26eb17f4a1be1cba11ca8779b0677cedc30dbebef77ccba382\n866b1f5c5edd9f01c5ba84d02e94ae7c1f9b2196af380eed1917e8fc21acbbdc\n910fbfa8ef4ad7183c1b5bdd3c9fd1380e617ca0042b428873c48f71ddc857db\na387c3c5776ee1b61018eeb3408fa7fa7490915146078d65b95621315e8b4287\nb9dbdf11da3630f464b8daace88e11c374a642e5082850e9f10a1b09d69ff04f\nc25a5c14269c990c94a4a20443c4eb266318200e4d7927c163e0eaec4ede780a\nc4aa94c73a50b2deca0401f97e4202337e522be3df629b3ef91e706488b64908\n\n**Network indicators**\n\nDomains abused by Lemon Duck:\n\ndown[.]sqlnetcat[.]com\nt[.]sqlnetcat[.]com\nt[ ]netcatkit[ ]com\n\n\n-----\n\nPydomer DGA network indicators:\n\nuiiuui[.]com/search/*\nyuuuuu43[.]com/vpn-service/*\nyuuuuu44[.]com/vpn-service/*\nyuuuuu46[.]com/search/*\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-25 - Analyzing attacks taking advantage of the Exchange Server vulnerabilities.pdf"
    ],
    "report_names": [
        "2021-03-25 - Analyzing attacks taking advantage of the Exchange Server vulnerabilities.pdf"
    ],
    "threat_actors": [
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536200,
    "ts_updated_at": 1743041523,
    "ts_creation_date": 1653779448,
    "ts_modification_date": 1653779448,
    "files": {
        "pdf": "https://archive.orkl.eu/8ae8d32a520c910bee6606b0d728d3154245eeb0.pdf",
        "text": "https://archive.orkl.eu/8ae8d32a520c910bee6606b0d728d3154245eeb0.txt",
        "img": "https://archive.orkl.eu/8ae8d32a520c910bee6606b0d728d3154245eeb0.jpg"
    }
}