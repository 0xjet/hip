{
    "id": "9a8eb9ab-a16a-4bf5-b6eb-1e3899a7b909",
    "created_at": "2023-01-12T15:09:18.368283Z",
    "updated_at": "2025-03-27T02:16:20.825521Z",
    "deleted_at": null,
    "sha1_hash": "59bfa3c50b455dd9207cfebb77de4082f50dd22c",
    "title": "2017-02-02 - KopiLuwak- A New JavaScript Payload from Turla",
    "authors": "",
    "file_creation_date": "2022-05-27T21:16:09Z",
    "file_modification_date": "2022-05-27T21:16:09Z",
    "file_size": 1430191,
    "plain_text": "# KopiLuwak: A New JavaScript Payload from Turla\n\n**[securelist.com/blog/research/77429/kopiluwak-a-new-javascript-payload-from-turla/](https://securelist.com/blog/research/77429/kopiluwak-a-new-javascript-payload-from-turla/)**\n\nAuthors\n\n[Brian Bartholomew](https://securelist.com/author/brian_bartholomew/)\n\nOn 28 January 2017, John Lambert of Microsoft (@JohnLaTwC) tweeted about a malicious document that\n[dropped a “very interesting .JS backdoor“. Since the end of November 2016, Kaspersky Lab has observed](https://twitter.com/JohnLaTwC/status/825371797767938048)\nTurla using this new JavaScript payload and specific macro variant. This is a technique we’ve observed\nbefore with Turla’s ICEDCOFFEE payloads, detailed in a private report from June 2016 (available to\ncustomers of Kaspersky APT Intelligence Services). While the delivery method is somewhat similar to\nICEDCOFFEE, the JavaScript differs greatly and appears to have been created mainly to avoid detection.\n\nTargeting for this new malware is consistent with previous campaigns conducted by Turla, focusing on\nforeign ministries and other governmental organizations throughout Europe. Popularity of the malware,\nhowever, is much lower than ICEDCOFFEE, with victim organizations numbering in the single digits as of\nJanuary 2017. We assess with high confidence this new JavaScript will be used more heavily in the future\nas a stage 1 delivery mechanism and victim profiler.\n\nThe malware is fairly simplistic but flexible in its functionality, running a standard batch of profiling\ncommands on the victim and also allowing the actors to run arbitrary commands via Wscript.\n\n## Actor Profile\n\nTurla, also known as Snake / Uroburos / Venomous Bear and KRYPTON is a Russian-speaking APT group\nthat has been active since at least 2007. Its activity can be traced to many high-profile incidents, including\n[the 2008 attack against the US Central Command, (see Buckshot Yankee incident) or more recently, the](https://en.wikipedia.org/wiki/2008_cyberattack_on_United_States)\n\n\n-----\n\n[attack against RUAG, a Swiss military contractor. The Turla group has been known as an agile, very](https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2017/02/20081149/Report_Ruag-Espionage-Case.pdf)\n[dynamic and innovative APT, leveraging many different families of malware, satellite-based command and](https://securelist.com/satellite-turla-apt-command-and-control-in-the-sky/72081/)\ncontrol servers and malware for non-Windows OSes.\n\nTargeting Ukraine, EU-related institutions, governments of EU countries, Ministries of Foreign Affairs\nglobally, media companies and possibly corruption related targets in Russia, the group intensified their\n[activity in 2014, which we described in our paper Epic Turla. During 2015 and 2016 the group diversified](https://securelist.com/analysis/publications/65545/the-epic-turla-operation/)\ntheir activities, switching from the Epic Turla waterhole framework to the Gloog Turla framework, which is\nstill active. They also expanded their spear phishing activities with the Skipper / WhiteAtlas attacks, which\nleveraged new malware. Recently, the group has intensified their satellite-based C&C registrations ten-fold\ncompared to their 2015 average.\n\n## Technical Details\n\n**Sample MD5: 6e7991f93c53a58ba63a602b277e07f7**\n\n**Name: National Day Reception (Dina Mersine Bosio Ambassador’s Secretary).doc**\n\n**Author: user**\n\n**LastModifiedBy: John**\n\n**CreateDate: 2016:11:16 21:58:00**\n\n**ModifyDate: 2016:11:24 17:42:00**\n\n_Decoy document used in the attack_\n\nThe lure document above shows an official letter from the Qatar Embassy in Cyprus to the Ministry of\nForeign Affairs (MoFA) in Cyprus. Based on the name of the document (National Day Reception (Dina\nMersine Bosio Ambassador’s Secretary).doc, it is presumed it may have been sent from the Qatar\nAmbassador’s secretary to the MoFA, possibly indicating Turla already had control of at least one system\nwithin Qatar’s diplomatic network.\n\nThe document contains a malicious macro, very similar to previous macros used by Turla in the past to\ndeliver Wipbot, Skipper, and ICEDCOFFEE. However, the macro did contain a few modifications to it,\nmainly the XOR routine used to decode the initial JavaScript and the use of a “marker” string to find the\nembedded payload in the document.\n\n### New XOR Routine\n\n\n-----\n\nBelow is a snippet of the new XOR routine used to decode the initial JavaScript payload. Turla has\nconsistently changed the values used in this routine over the last year, presumably to avoid easy detection:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n\nFunction Q7JOhn5pIl648L6V43V(EjqtNRKMRiVtiQbSblq67() As Byte, M5wI32R3VF2g5B21EK4d As\nLong) As Boolean\n\nDim THQNfU76nlSbtJ5nX8LY6 As Byte\n\nTHQNfU76nlSbtJ5nX8LY6 = 45\n\nFor i = 0 To M5wI32R3VF2g5B21EK4d - 1\n\nEjqtNRKMRiVtiQbSblq67(i) = EjqtNRKMRiVtiQbSblq67(i) Xor THQNfU76nlSbtJ5nX8LY6\n\nTHQNfU76nlSbtJ5nX8LY6 = ((THQNfU76nlSbtJ5nX8LY6 Xor 99) Xor (i Mod 254))\n\nNext i\n\nQ7JOhn5pIl648L6V43V = True\n\nEnd Function\n\n\nHere is a function written in Python to assist in decoding of the initial payload:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n\ndef decode(payload, length):\n\nvarbyte = 45\n\ni = 0\n\nfor byte in payload:\n\npayload[i] = byte ^ varbyte\n\nvarbyte = ((varbyte ^ 99) ^ (i % 254))\n\ni += 1\n\n\n### Payload Offset\n\nAnother change in the macro is the use of a “marker” string to find the payload offset in the document.\nInstead of using hard coded offsets at the end of the document as in ICEDCOFFEE, the macro uses the\nbelow snippet to identify the start of the payload:\n\n\n1\n\n2\n\n3\n\n\nSet VUy5oj112fLw51h6S = CreateObject(\"vbscript.regexp\")\n\nVUy5oj112fLw51h6S.Pattern =\n\"MxOH8pcrlepD3SRfF5ffVTy86Xe41L2qLnqTd5d5R7Iq87mWGES55fswgG84hIRdX74dlb1SiFOkR1Hh\"\n\nSet I4j833DS5SFd34L3gwYQD = VUy5oj112fLw51h6S.Execute(KqG31PcgwTc2oL47hjd7Oi)\n\n\n### Second Layer JavaScript\n\n\n-----\n\nOnce the marker is found, the macro will carve out 15387 + 1 bytes (hard coded) from the end of the\nmarker and pass that byte array to the aforementioned decoding routine. The end result is a JavaScript file\n(mailform.js – MD5: 05d07279ed123b3a9170fa2c540d2919) written to “%APPDATA%MicrosoftWindows”.\n\n_mailform.js – malicious obfuscated JavaScript payload_\n\nThis file is then executed using Wscript.Shell.Run() with a parameter of “NPEfpRZ4aqnh1YuGwQd0”. This\nparameter is an RC4 key used in the next iteration of decoding detailed below.\n\nThe only function of mailform.js is to decode the third layer payload stored in the JavaScript file as a\nBase64 string. This string is Base64 decoded, then decrypted using RC4 with the key supplied above as a\nparameter (“NPEfpRZ4aqnh1YuGwQd0”). The end result is yet another JavaScript which is passed to the\neval() function and executed.\n\n### Third Layer JavaScript\n\nThe third layer payload is where the C2 beaconing and system information collection is performed. This JS\nwill begin by copying itself to the appropriate folder location based on the version of Windows running:\n\n1. c:Users<USERNAME>AppDataLocalMicrosoftWindowsmailform.js\n\n2. c:Users<USERNAME>AppDataLocalTempmailform.js\n\n3. c:Documents and Settings<USERNAME>Application DataMicrosoftWindowsmailform.js\n\n**Persistence**\n\nNext, it will establish persistence on the victim by writing to the following registry key:\n\nKey: HKEY_CURRENT_USERsoftwaremicrosoftwindowscurrentversionrunmailform\n\nValue: wscript.exe /b “<PATH_TO_JS> NPEfpRZ4aqnh1YuGwQd0”\n\n**Profiling**\n\nAfter establishing its persistence, it will then execute a series of commands on the victim system using\n“cmd.exe /c” and store them to a file named “~dat.tmp”, in the same folder where “mailform.js” is located:\n\nsysteminfo\n\n\n-----\n\nnet view\nnet view /domain\ntasklist /v\ngpresult /z\nnetstat -nao\nipconfig /all\narp -a\nnet share\nnet use\nnet user\nnet user administrator\nnet user /domain\nnet user administrator /domain\nset\ndir %systemdrive%Users*.*\ndir %userprofile%AppDataRoamingMicrosoftWindowsRecent*.*\ndir %userprofile%Desktop*.*\ntasklist /fi “modules eq wow64.dll”\ntasklist /fi “modules ne wow64.dll”\ndir “%programfiles(x86)%”\ndir “%programfiles%”\ndir %appdata%\n\nOnce the information is collected into the temporary “~dat.tmp” file, the JavaScript reads its contents into\nmemory, RC4 encrypts it with the key “2f532d6baec3d0ec7b1f98aed4774843”, and deletes the file after a\n1 second sleep, virtually eliminating storage of victim information on disk and only having an encrypted\nversion in memory.\n\n**Network Communications**\n\nWith the victim info stored in encrypted form in memory, the JavaScript then will perform the necessary\ncallback(s) to the C2 servers which are hard coded in the payload. The addresses seen in this payload\nwere as follows:\n\nhttp://soligro[.]com/wp-includes/pomo/db.php\nhttp://belcollegium[.]org/wp-admin/includes/class-wp-upload-plugins-list-table.php\n\nIt should be noted that the above domains appear to have been compromised by the actor based on the\nlocations of the PHP scripts.\n\n\n-----\n\n_Belcollegium[.]org – a legitimate website compromised and used for C2_\n\nVictim data is sent to the C2 servers in the form of a POST request. The headers of the POST request\ncontain a unique User-Agent string that will remain the same per victim system. The User-Agent string is\ncreated by performing the following steps:\n\n1. Concatenate the string “KRMLT0G3PHdYjnEm” + <SYSTEM_NAME> + <USER NAME>\n\n\n-----\n\n2. Use the above string as input to the following function (System Name and User Name have been\n\nfilled in with example data ‘Test’ and ‘Admin’):\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n\nfunction EncodeUserAgent() {\n\nvar out = \"\";\n\nvar UserAgent = 'KRMLT0G3PHdYjnEm' + 'Test' + 'Admin';\n\nfor (var i = 0; i < 16; i++) {\n\nvar x = 0\n\nfor (var j = i; j < UserAgent.length - 1; j++) {\n\nx = x ^ UserAgent.charCodeAt(j);\n\n}\n\nx = (x % 10);\n\nout = out + x.toString(10);\n\n}\n\nout = out + 'KRMLT0G3PHdYjnEM';\n\nreturn out;\n\n}\n\n\nThe function above will produce a unique “UID” consisting of a 16-digit number with the string\n“KRMLT0G3PHdYjnEm” appended to the end. In the example above using the System Name “Test”\nand User Name “Admin”, the end result would be “2356406508689132KRMLT0G3PHdYjnEm”\n\n3. Prepend the string “user-agent:”, “Mozilla/5.0 (Windows NT 6.1; Win64; x64); ” to the result from the\n\nlast step. This will now be the unique User-Agent value for the victim callbacks. In this example, the\nfinal result will be “user-agent:”, “Mozilla/5.0 (Windows NT 6.1; Win64; x64);\n2356406508689132KRMLT0G3PHdYjnEm”.\n\nThe POST request will contain the unique User-Agent string above as one of the headers and also the\nBase64 encoded version of the RC4 encrypted victim data collected earlier.\n\nThe C2 will respond in one of four ways after the POST request:\n\n1. “good”\n\n2. “exit”\n\n3. “work”\n\n4. “fail”\n\nIn the case of an answer of “good”, the JavaScript will then sleep for a random amount of time, ranging\nfrom 3600-3900 seconds.\n\n\n-----\n\nThe exit command will cause script to exit gracefully, thus shutting down the communications to the C2\nserver until next startup / login from the user.\n\nThe “fail” command is for uninstalling the JavaScript and its persistence. Both the “mailform.js” file and\nregistry key created for persistence will be deleted upon receipt of this command.\n\nThe “work” command is used to task the victim’s system to run arbitrary commands via Wscript.shell.run().\nIt begins by checking to see if a file “mailform.pif” exists in the same directory as the JavaScript, and if so,\nit will delete it. The victim will then send a POST request to the C2 much in the same way as before with\nthe beacon traffic, but with some slight differences. The User-Agent header will remain the same as in the\nbeacon traffic, but the data sent to the C2 will consist of the 4-byte string “work”. If the response from the\nserver after this acknowledgement is “200 OK”, then the system will proceed to read the response data\ninto memory, RC4 encrypt it using the same key “2f532d6baec3d0ec7b1f98aed4774843”, then write it out\nto the “mailform.pif” file referenced above. The command file is run, the JavaScript will sleep for 30\nseconds, and then the file is subsequently deleted.\n\n## Victims and Sinkholing\n\nOne of the domains involved in this new malware (soligro[.]com) expired in July 2016 and was was\navailable for purchase and sinkhole at the time of the analysis. Sinkhole data shows several potential\nvictims, with one high profile victim (195.251.32.62) located within the Greek Parliament:\n\nThe majority of connections to the sinkhole server have been observed from IP ranges residing within\nGreece. This leads us to believe the main target for the specific document above was Greece, although we\nalso have indications of targeting in Romania and Qatar based on other data.\n\n## Conclusions\n\nIn recent months, the Turla actors have increased their activity significantly. The addition of KopiLuwak to\ntheir already existing ICEDCOFFEE JavaScript payload indicates the group continues to evolve and\ndeliver new tools to avoid detection by known malware signatures.\n\n\n-----\n\nCurrently, it seems the Turla actors continue to rely heavily on embedded macros in Office documents.\nWhile this may appear to be an elementary technique to use for such a sophisticated actor, they are\nrepeatedly successful in compromising high value targets with this method. It is advised that users disable\nmacros in their enterprise and not allow the user to enable said content unless absolutely necessary.\nFurthermore, using the polymorphic obfuscation technique for the macros has caused difficulties in writing\nsignatures for detection.\n\n[APT](https://securelist.com/tag/apt/)\n[JavaScript](https://securelist.com/tag/javascript/)\n[Macros](https://securelist.com/tag/macros/)\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Turla](https://securelist.com/tag/turla/)\n\nAuthors\n\n[Brian Bartholomew](https://securelist.com/author/brian_bartholomew/)\n\nKopiLuwak: A New JavaScript Payload from Turla\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-02-02 - KopiLuwak- A New JavaScript Payload from Turla.pdf"
    ],
    "report_names": [
        "2017-02-02 - KopiLuwak- A New JavaScript Payload from Turla.pdf"
    ],
    "threat_actors": [
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536158,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1653686169,
    "ts_modification_date": 1653686169,
    "files": {
        "pdf": "https://archive.orkl.eu/59bfa3c50b455dd9207cfebb77de4082f50dd22c.pdf",
        "text": "https://archive.orkl.eu/59bfa3c50b455dd9207cfebb77de4082f50dd22c.txt",
        "img": "https://archive.orkl.eu/59bfa3c50b455dd9207cfebb77de4082f50dd22c.jpg"
    }
}