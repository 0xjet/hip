{
    "id": "ec0757e0-8915-45f2-84a6-f12bd0f195e3",
    "created_at": "2022-10-25T16:48:20.050454Z",
    "updated_at": "2025-03-27T02:16:53.096035Z",
    "deleted_at": null,
    "sha1_hash": "13a055fe7be7e55dcce0035eaf1990fbe8406c98",
    "title": "Orcarat - A Whale Of A Tale",
    "authors": "PWC",
    "file_creation_date": "2014-10-20T14:11:05Z",
    "file_modification_date": "2014-10-20T14:11:05Z",
    "file_size": 554485,
    "plain_text": "By Dan Kelly and Tom Lancaster\n\nIt’s every malware analyst’s dream to be handed a sample which is, so far, unnamed by the AV community\n\n- especially when the malware in question may have links to a well-known APT group.\n\nIn my line of work I analyse several ‘unknown’ malware samples a week, but often it turns out that they\n\nare simply new variants of existing malware families. Recently I was fortunate enough to be handed\n\nsomething that not only had a low detection rate but, aside from heuristics, seemed to be relatively\n\nunknown to the top 40 anti-virus companies.\n\nIn this post I will walk you through the malware family we’ve dubbed “OrcaRAT”.\n\nFirst of all, it is worth pointing out that most of the malware I see on a day-to-day basis is espionage\n\norientated, and very rarely do the programmers and operators make much effort to cover their tracks. The\n\nuse of forged HTTP headers is a common occurrence and simple mistakes within these headers are\n\nfrequent.\n\nThe malware in question was handed to me by one of our threat intelligence analysts who was hunting\n\nthrough infrastructure associated with some samples of Comfoo[1] malware and happened across a\n\nmalware sample (253a704acd7952677c70e0c2d787791b8359efe2c92a5e77acea028393a85613) he didn’t\n\nrecognise. He immediately took the malware and passed it through first stage analysis, which involves\n\nrunning the file in a sandbox environment. After this, he handed it over for more in-depth capability\n\nanalysis.\n\n## The structure\n\nI began by looking over the sandbox report. The first thing that drew my attention was the URI structure.\n\n_(A screenshot showing the HTTP headers and URI structure that OrcaRAT produces)_\n\n\n-----\n\nto be a modified version of the Base64 algorithm.\n\nTo understand this structure more, we must reverse engineer the functions that generate and then encode\n\nthe data. Firstly we begin by analysing the routines that produce the data which is later encoded and sent\n\nin the HTTP URI field.\n\nThe very first thing that jumped out when disassembling the malware is the simplicity and cleanliness of\n\nthe code. There are also a significant number of Windows Crypto API[2] functions imported by the\n\nmalware, so we can assume this indicates that it uses encryption.\n\n_(A screenshot showing the functions that are imported by OrcaRAT)_\n\nDelving deeper in to the disassembly, we come across the preamble to the URI generation function:\n\n\n-----\n\n_(A screenshot showing the decoding and generation of a string value)_\n\nThe function above uses Windows crypto API to generate a random number of 6 bytes, then dynamically\n\nbuilds and appends the word “OrcaKiller” on to the end of this number. In one such example the final\n\nproduct was \"\\x61\\xBA\\xF4\\x44\\x52\\xF1OrcaKiller\" (where \\x denotes hexadecimal values).\n\nOnce this value has been produced, the malware begins constructing the URI. With many pieces of\n\nmalware the initial communications that it sends out to its command and control server (known as\n\nbeaconing or phoning home) usually include pieces of information about the victim system. OrcaRAT is no\n\nexception. The randomly generated values noted above are actually used to encrypt several pieces of\n\ninformation that are extracted from the system, and even the key itself is included.\n\n\n-----\n\n_(A screenshot showing an encryption function used by OrcaRAT)_\n\nAll of the values extracted from the system are encrypted using the RC4[3] algorithm and then base64\n\nencoded. The RC4 encryption key is derived from an MD5 hash[4] of the randomly generated bytes\n\nconcatenated with the ‘OrcaKiller’ string. Once the data has been encrypted it is base64 encoded. Any\n\nforward slashes in the base64 string are replaced with a tilde - pseudo code is shown below.\n\nOnce all of the values have been encrypted and formatted the URI has the following structure:\n\n_(A screenshot showing the URI structure of OrcaRAT command and control activity)_\n\n\n-----\n\n_(A screenshot showing the generation of the first hidden string value)_\n\nIt would appear that the authors did not want anybody to be able to easily see this value.\n\nThis now gives us OrcaKiller and wHaLe. It would appear that our adversary has a salty sense of humour.\n\n## Command and control\n\nAs with all malware, the command and control functions reveal the true nature and intent of the\n\noperators. Up until now we have only determined how the malware communicates with the server. We will\n\nnow investigate the mechanisms that the server uses to communicate and interact with the victim.\n\nThe command and control routine in OrcaRAT appears to serve two purposes. Interestingly these routines\n\nare split in to two branches. Each branch of command and control activity is determined by the unique\n\nresponse from the remote server. Command and control takes form of a webpage. Unlike malware\n\ndesigned by the well-known Comment Crew[5], this group does not hide these commands in HTML\n\ncomments, but instead places them in plain view. The first set of commands force the malware to behave\n\nas a simple downloader.\n\n\n-----\n\n_(A screenshot showing OrcaRAT parsing the HTML code behind a webpage)_\n\nUpon downloading the webpage from the server the malware looks for specific sets of HTML tags. The\n\nfirst set are <P> and the terminating tag </P>. Once the malware has found these tags it drops in to the\n\nfirst command and control function. The malware then extracts the payload text between the HTML tags\n\nand runs it through a decryption routine. The same encryption key that is sent in the URI string is used to\n\ndecrypt the text. Once the payload text has been decrypted the malware treats this as a binary executable\n\nfile, which is then written to the disk and executed.\n\nThe second set of HTML tags allows the operator to drop the malware in to a set of remote control\n\nfunctions. This time the malware searches for the <H1> tag that is terminated by </H1>. Once the payload\n\ntext between these tags has been extracted it is then decrypted using the encryption key found in the URI\n\nstring. The payload text from this page is much smaller and ultimately points to the command function\n\nthat the operator has executed.\n\n\n-----\n\n_(A screenshot showing the structure of the command and control routines within OrcaRAT)_\n\nThe command and control structure is fairly simplistic but provides the operator with access to the victim\n\nmachine’s filesystem and command line, and as such allows the attacker to perform various tasks such as\n\nexecuting arbitrary commands or uploading and downloading files from the compromised system.\n\nAfter a command and control message is received, OrcaRAT sends an HTTP POST message back to the\n\ncommand and control server. Each time that the URI is built it generates a new encryption key, showing\n\nthat the command and control server is at least serving dynamic content. Given the command structure\n\nabove, it is logical to assume that the command and control server requires an operator to manually issue\n\nspecific commands to the victim workstation, with the default command likely being ‘sleep’.\n\nGiven the information above we can reasonably assume that this malware was most likely designed as a\n\nfirst stage implant. History has shown that malware designed in this way is usually done so to allow the\n\noperator an initial level of access to the compromised system, usually for surveying the victim and then\n\ndeciding whether to deploy a more capable and valuable second stage malware implant.\n\n## Detection\n\nOnce OrcaRAT has been delivered to a victim system there are a number of ways to detect it.\n\nFirstly we will cover disk detection using Yara. The rule below will detect an OrcaRAT binary executable\n\nthat has been written to a compromised machine’s disk.\n\nrule OrcaRAT\n{\nmeta:\nauthor = “PwC Cyber Threat Operations  :: @tlansec\"\ndistribution = \"TLP WHITE\"\n\nsha1 = \"253a704acd7952677c70e0c2d787791b8359efe2c92a5e77acea028393a85613\"\n\n\n-----\n\n$MZ= MZ\n\n$apptype1=\"application/x-ms-application\"\n\n$apptype2=\"application/x-ms-xbap\"\n\n$apptype3=\"application/vnd.ms-xpsdocument\"\n\n$apptype4=\"application/xaml+xml\"\n\n$apptype5=\"application/x-shockwave-flash\"\n\n$apptype6=\"image/pjpeg\"\n\n$err1=\"Set return time error =  %d!\"\n\n$err2=\"Set return time  success!\"\n\n$err3=\"Quit success!\"\n\ncondition:\n\n$MZ at 0 and filesize < 500KB and  (all of ($apptype*) and 1 of ($err*))\n}\n\nOrcaRAT can also be detected in two separate ways at the network level using a Snort or Suricata IDS rule.\n\nDetecting malware at different stages of connectivity can be important. By creating signatures with a\n\nnexus to the kill chain[6] we can determine which stage the intrusion has reached. The two signatures\n\nbelow will indicate whether the intrusion has reached the command and control or action-on phases.\n\nSnort:\n\nalert tcp any any -> any any (msg:\"::[PwC CTD]:: - OrcaRAT implant check-in\";\nflow:established,from_client; urilen: 67<>170; content:\"User-Agent: Mozilla/4.0 (compatible\\;\nMSIE 8.0\\; Windows NT 5.1\\; Trident/4.0\\; .NET CLR 2.0.50727\\; .NET CLR 3.0.04506.30\\;\n.NET4.0C\\; .NET4.0E)\"; http_header; content:\"GET\"; http_method; pcre:\"/^\\/[A-Za-z0-9+~=]\n{14,18}\\/[A-Za-z0-9+~=]{33,38}\\/[A-Za-z0-9+~=]{6,9}\\/[A-Za-z0-9+~=]{5,50}\\/[A-Za-z09+~=]{5,50}$/U\"; sid:YOUR_SID; rev:1;)\n\nalert tcp any any -> any any (msg:\"::[PwC CTD]:: - OrcaRAT implant C2 confirmation response\";\nflow:established,from_client; urilen: 67<>170; content:\"User-Agent: Mozilla/4.0 (compatible\\;\nMSIE 8.0\\; Windows NT 5.1\\; Trident/4.0\\; .NET CLR 2.0.50727\\; .NET CLR 3.0.04506.30\\;\n.NET4.0C\\; .NET4.0E)\"; http_header; content:\"POST\"; http_method; pcre:\"/^\\/[A-Za-z0-9+~=]\n{14,18}\\/[A-Za-z0-9+~=]{33,38}\\/[A-Za-z0-9+~=]{6,9}\\/[A-Za-z0-9+~=]{5,50}\\/[A-Za-z09+~=]{5,50}$/U\"; sid:YOUR_SID; rev:1;)\n\n\n-----\n\nalert http any any -> any any (msg:\"::[PwC CTD]:: - OrcaRAT implant check-in\";\nflow:established,from_client; urilen: 67<>170; content:\" Mozilla/4.0 (compatible\\; MSIE 8.0\\;\nWindows NT 5.1\\; Trident/4.0\\; .NET CLR 2.0.50727\\; .NET CLR 3.0.04506.30\\; .NET4.0C\\;\n.NET4.0E)\"; http_user_agent; content:\"GET\"; http_method; pcre:\"/^\\/[A-Za-z0-9+~=]\n{14,18}\\/[A-Za-z0-9+~=]{33,38}\\/[A-Za-z0-9+~=]{6,9}\\/[A-Za-z0-9+~=]{5,50}\\/[A-Za-z09+~=]{5,50}$/U\"; sid:YOUR_SID; rev:1;)\n\nalert http any any -> any any (msg:\"::[PwC CTD]:: - OrcaRAT implant C2 confirmation response\";\nflow:established,from_client; urilen: 67<>170; content:\" Mozilla/4.0 (compatible\\; MSIE 8.0\\;\nWindows NT 5.1\\; Trident/4.0\\; .NET CLR 2.0.50727\\; .NET CLR 3.0.04506.30\\; .NET4.0C\\;\n.NET4.0E)\"; http_user_agent; content:\"POST\"; http_method; pcre:\"/^\\/[A-Za-z0-9+~=]\n{14,18}\\/[A-Za-z0-9+~=]{33,38}\\/[A-Za-z0-9+~=]{6,9}\\/[A-Za-z0-9+~=]{5,50}\\/[A-Za-z09+~=]{5,50}$/U\"; sid:YOUR_SID; rev:1;)\n\nAppendix A: Samples of Orca RAT:\n\n**Hash** **C2**\n\n07b40312047f204a2c1fbd94fba6f53b adda.lengendport.com\n\nf6456b115e325b612e0d144c8090720f tsl.gettrials.com\n\n139b8e1b665bb9237ec51ec4bef22f58 auty.organiccrap.com\n\nAppendix B: Related indicators\n\n**Indicator** **Type**\n\n11.38.64.251 IP Address\n\n123.120.115.77 IP Address\n\n123.120.99.228 IP Address\n\n142.0.134.20 IP Address\n\n147.96.68.184 IP Address\n\n176.31.24.182 IP Address\n\n176.31.24.184 IP Address\n\n190.114.241.170 IP Address\n\n200.78.201.24 IP Address\n\n202.124.151.94 IP Address\n\n202.2.108.142 IP Address\n\n203.146.251.11 IP Address\n\n204.152.209.74 IP Address\n\n213.147.54.170 IP Address\n\n23.19.39.19 IP Address\n\n58.71.158.21 IP Address\n\n62.73.174.134 IP Address\n\n71.183.67.163 IP Address\n\n74 116 128 15 IP Address\n\n|Hash|C2|\n|---|---|\n|07b40312047f204a2c1fbd94fba6f53b|adda.lengendport.com|\n|f6456b115e325b612e0d144c8090720f|tsl.gettrials.com|\n|139b8e1b665bb9237ec51ec4bef22f58|auty.organiccrap.com|\n\n|Indicator|Type|\n|---|---|\n|11.38.64.251|IP Address|\n|123.120.115.77|IP Address|\n|123.120.99.228|IP Address|\n|142.0.134.20|IP Address|\n|147.96.68.184|IP Address|\n|176.31.24.182|IP Address|\n|176.31.24.184|IP Address|\n|190.114.241.170|IP Address|\n|200.78.201.24|IP Address|\n|202.124.151.94|IP Address|\n|202.2.108.142|IP Address|\n|203.146.251.11|IP Address|\n|204.152.209.74|IP Address|\n|213.147.54.170|IP Address|\n|23.19.39.19|IP Address|\n|58.71.158.21|IP Address|\n|62.73.174.134|IP Address|\n|71.183.67.163|IP Address|\n\n\n-----\n\n|84c68f2d2dd569c4620dabcecd477e69|Hash|\n|---|---|\n|8fbc8c7d62a41b6513603c4051a3ee7b|Hash|\n|91.198.50.31|IP Address|\n|adda.lengendport.com|Domain|\n|affisensors.com|Domain|\n|analysis.ittecbbs.com|Domain|\n|at.acmetoy.com|Domain|\n|aucy.affisensors.com|Domain|\n|auty.organiccrap.com|Domain|\n|bbs.dynssl.com|Domain|\n|bbs.serveuser.com|Domain|\n|bbslab.acmetoy.com|Domain|\n|bbslab.lflink.com|Domain|\n|cdna.acmetoy.com|Domain|\n|cune.lengendport.com|Domain|\n|cure.yourtrap.com|Domain|\n|dasheng.lonidc.com|Domain|\n|dns.affisensors.com|Domain|\n|edu.authorizeddns.org|Domain|\n|edu.onmypc.org|Domain|\n|fee0e6b8157099ad09380a94b7cbbea4|Hash|\n|ftp.bbs.dynssl.com|Domain|\n|ftp.bbs.serveuser.com|Domain|\n|ftp.bbslab.acmetoy.com|Domain|\n|ftp.edu.authorizeddns.org|Domain|\n|ftp.edu.onmypc.org|Domain|\n|ftp.lucy.justdied.com|Domain|\n|ftp.nuac.jkub.com|Domain|\n|ftp.osk.lflink.com|Domain|\n|ftp.reg.dsmtp.com|Domain|\n|ftp.tt0320.portrelay.com|Domain|\n|home.affisensors.com|Domain|\n|hot.mrface.com|Domain|\n|info.affisensors.com|Domain|\n|jucy.wikaba.com|Domain|\n|jutty.organiccrap.com|Domain|\n|lengendport.com|Domain|\n|lucy.justdied.com|Domain|\n\n\ndd D i\n\n\n-----\n\n|nunok.ninth.biz|Domain|\n|---|---|\n|osk.lflink.com|Domain|\n|philipine.gnway.net|Domain|\n|pure.mypop3.org|Domain|\n|reg.dsmtp.com|Domain|\n|tt0320.portrelay.com|Domain|\n|venus.gr8domain.biz|Domain|\n|www.bbs.dynssl.com|Domain|\n|www.bbs.serveuser.com|Domain|\n|www.bbslab.acmetoy.com|Domain|\n|www.edu.authorizeddns.org|Domain|\n|www.edu.onmypc.org|Domain|\n|www.fgtr.info|Domain|\n|www.hot.mrface.com|Domain|\n|www.ktry.info|Domain|\n|www.lucy.justdied.com|Domain|\n|www.osk.lflink.com|Domain|\n|www.reg.dsmtp.com|Domain|\n|www.tt0320.portrelay.com|Domain|\n\n\n\n[1] http://www.secureworks.com/cyber-threat-intelligence/threats/secrets-of-the-comfoo-masters/\n\n[2] http://msdn.microsoft.com/en-gb/library/windows/desktop/aa380255(v=vs.85).aspx\n\n[3] http://en.wikipedia.org/wiki/RC4\n\n[4] http://en.wikipedia.org/wiki/MD5\n\n[5] http://intelreport.mandiant.com/Mandiant_APT1_Report.pdf\n\n[6] http://www.lockheedmartin.com/content/dam/lockheed/data/corporate/documents/LM-White\nPaper-Intel-Driven-Defense.pdf\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/r3qo159trv793oeqdgsv99swjsxzq8pw",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2014/2014.10.20.OrcaRAT_tale/OrcaRAT.pdf"
    ],
    "report_names": [
        "OrcaRAT"
    ],
    "threat_actors": [
        {
            "id": "dabb6779-f72e-40ca-90b7-1810ef08654d",
            "created_at": "2022-10-25T15:50:23.463113Z",
            "updated_at": "2025-03-27T02:00:55.47619Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "APT1",
                "Comment Crew",
                "Comment Group",
                "Comment Panda"
            ],
            "source_name": "MITRE:APT1",
            "tools": [
                "Seasalt",
                "ipconfig",
                "Cachedump",
                "PsExec",
                "GLOOXMAIL",
                "Lslsass",
                "PoisonIvy",
                "WEBC2",
                "Mimikatz",
                "gsecdump",
                "Pass-The-Hash Toolkit",
                "Tasklist",
                "xCmd",
                "pwdump"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "cf7fc640-acfe-41c4-9f3d-5515d53a3ffb",
            "created_at": "2023-01-06T13:46:38.228042Z",
            "updated_at": "2025-03-27T02:00:02.775905Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "GIF89a",
                "G0006",
                "PLA Unit 61398",
                "Group 3",
                "TG-8223",
                "Comment Group",
                "ShadyRAT",
                "COMMENT PANDA",
                "Comment Crew",
                "Byzantine Candor",
                "Brown Fox"
            ],
            "source_name": "MISPGALAXY:APT1",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3aaf0755-5c9b-4612-9f0e-e266ef1bdb4b",
            "created_at": "2022-10-25T16:07:23.480196Z",
            "updated_at": "2025-03-27T02:02:09.826059Z",
            "deleted_at": null,
            "main_name": "Comment Crew",
            "aliases": [
                "APT 1",
                "BrownFox",
                "Byzantine Candor",
                "Byzantine Hades",
                "Comment Crew",
                "Comment Panda",
                "GIF89a",
                "Group 3",
                "Operation Oceansalt",
                "Operation Seasalt",
                "Operation Siesta",
                "Shanghai Group",
                "TG-8223"
            ],
            "source_name": "ETDA:Comment Crew",
            "tools": [
                "Auriga",
                "Cachedump",
                "Chymine",
                "CookieBag",
                "Darkmoon",
                "GDOCUPLOAD",
                "GLOOXMAIL",
                "GREENCAT",
                "Gen:Trojan.Heur.PT",
                "GetMail",
                "Hackfase",
                "Hacksfase",
                "Helauto",
                "Kurton",
                "LETSGO",
                "LIGHTBOLT",
                "LIGHTDART",
                "LOLBAS",
                "LOLBins",
                "LONGRUN",
                "Living off the Land",
                "Lslsass",
                "MAPIget",
                "ManItsMe",
                "Mimikatz",
                "MiniASP",
                "Oceansalt",
                "Pass-The-Hash Toolkit",
                "Poison Ivy",
                "ProcDump",
                "Riodrv",
                "SPIVY",
                "Seasalt",
                "ShadyRAT",
                "StarsyPound",
                "TROJAN.COOKIES",
                "TROJAN.FOXY",
                "TabMsgSQL",
                "Tarsip",
                "Trojan.GTALK",
                "WebC2",
                "WebC2-AdSpace",
                "WebC2-Ausov",
                "WebC2-Bolid",
                "WebC2-Cson",
                "WebC2-DIV",
                "WebC2-GreenCat",
                "WebC2-Head",
                "WebC2-Kt3",
                "WebC2-Qbp",
                "WebC2-Rave",
                "WebC2-Table",
                "WebC2-UGX",
                "WebC2-Yahoo",
                "Wordpress Bruteforcer",
                "bangat",
                "gsecdump",
                "pivy",
                "poisonivy",
                "pwdump",
                "zxdosml"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041813,
    "ts_creation_date": 1413814265,
    "ts_modification_date": 1413814265,
    "files": {
        "pdf": "https://archive.orkl.eu/13a055fe7be7e55dcce0035eaf1990fbe8406c98.pdf",
        "text": "https://archive.orkl.eu/13a055fe7be7e55dcce0035eaf1990fbe8406c98.txt",
        "img": "https://archive.orkl.eu/13a055fe7be7e55dcce0035eaf1990fbe8406c98.jpg"
    }
}