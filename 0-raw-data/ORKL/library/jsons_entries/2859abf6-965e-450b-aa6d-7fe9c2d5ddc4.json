{
    "id": "2859abf6-965e-450b-aa6d-7fe9c2d5ddc4",
    "created_at": "2023-01-12T15:07:52.781307Z",
    "updated_at": "2025-03-27T02:06:00.244487Z",
    "deleted_at": null,
    "sha1_hash": "f684613165b282577d54c90e298d5f24b29ab733",
    "title": "2022-03-21 - [QuickNote] Analysis of Pandora ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T03:53:50Z",
    "file_modification_date": "2022-05-28T03:53:50Z",
    "file_size": 2078492,
    "plain_text": "# [QuickNote] Analysis of Pandora ransomware\n\n**[kienmanowar.wordpress.com/2022/03/21/quicknote-analysis-of-pandora-ransomware/](https://kienmanowar.wordpress.com/2022/03/21/quicknote-analysis-of-pandora-ransomware/)**\n\n## FOREWORD:\n\n\nMarch 21, 2022\n\n\n## Pandora’s code looks very weird and obfuscate complicated, so this analysis does not cover all its functions. I’m not a crypto expert, so I won’t dive into Pandora’s function like generating encryption key, process of creating threads to do its main task of encrypting files, writing file footer,.. During malware code analysis, I found that Pandora and Rook ransomware (https://chuongdong.com/reverse%20engineering/2022/01/06/RookRansomware) shared a lot of similarities.\n\n 1. Pandora sample\n\n The analyzed sample is a 64-bit executable: 0c4a84b66832a08dccc42b478d9d5e1b\n\n 2. Manual unpacking\n\n Quick check the sample with some tools like ExeInfo PE, DiE, all results show that this sample is packed by UPX.\n\n Checking more information about sections shows that the names of sections have been changed, not UPX0, UPX1, it changed to pppp and cccc.\n\n Additionally, the information behind the 3.00 UPX! strings were stripped by the attacker:\n\n\n-----\n\n## Therefore, we can not use the upx -d command to auto unpack this sample:\n\n For manually unpacking, I used x64dbg to find OEP and Scylla to dump the file and fix the IAT:\n\n\n-----\n\n## Here is the unpacked file that can run normally: 1497ac198a13de8c4e6d1a1e73eaa50f\n\n 3. Pandora Code Obfuscation\n\n Pandora developer makes it very difficult for static analysis, its code uses indirect calls through registers rax, rdx, rbp, etc. Important strings such as Mutex name, Dll Name, PUBLIC KEY info, Ransom note, are already encrypted and decrypted when the malicious code executes.\n\n Related to indirect calls, it can be seen as follows:\n\n The calls to the decrypt string function will take the rdx and rcx registers as parameters. The rdx register will point to the memory area containing the encrypted string. The rcx register will point to the memory area containing the decoded string.\n\n\n-----\n\n## The calls to the API functions or Pandora’s function should look like this:\n\n Besides, Pandora also applies control flow obfuscation technique. For example, the pseudo- code of function that decrypt the string is as follows:\n\n\n-----\n\n## 4. Analyze some of the main functions of Pandora\n\n To be able to analyze, I use IDA in combination with Bochs debugger.\n\n4.1. Create Mutex\n\n## First, Pandora decrypts the mutex name is “ ThisIsMutexa ”, then call the\n\n### OpenMutexA function to check the existence of this mutex.\n\n\n-----\n\n## If the mutex has not been created, call the CreateMutexA function to create the mutex to ensure that only one instance of the malware is running in the system.\n\n4.2. Call NtSetInformationProcess\n\n## Pandora decrypts the string “ NtSetInformationProcess “, calls the GetProcAddress function to retrieve the address. Then call the function NtSetInformationProcess with the ProcessInformationClass parameter passed as “ ProcessInstrumentationCallback ”:\n\n I still do not know the purpose of using this function of Pandora.\n\n4.3. Patching EtwEventWrite function\n\n## To disable ETW logging, Pandora decrypts the string “ EtwEventWrite ” and uses\n\n### GetProcAddress to get the address of the function. Then use WriteProcessMemory to\n## replace the first byte of the EtwEventWrite function with the opcode 0xC3 for the purpose to return immediately stopping the user-mode loggers.\n\n\n-----\n\n4.4. Defeat AmsiScanBuffer function\n\n## Pandora decrypts the string “ amsi.dll ” and calls the GetModuleHandleA function to get the amsi handle.\n\n\n-----\n\n## Decrypts the string AmsiScanBuffer and get the address of the function. Then use\n\n### VirtualProtectEx to change the protection at the AmsiScanBuffer .\n\n4.5. Generate RSA key\n\n## Pandora decrypts the string “ fast_test “, then uses the CryptAcquireContext,\n\n### CryptGenRandom functions to generate a random bytes buffer:\n\n\n-----\n\n## Pandora calls the function to decrypt the RSA public key. Then call the\n\n### mbedtls_pk_parse_public_key function to parse this public key:\n\n## The decrypted content of the Public key is as follows:\n\n\n-----\n\n```\n   BEGIN PUBLIC KEY\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtOGL76JTNo3yXAbjtopL\nbrBpAUvxyCd40aYBq9xWKpHHBHxOC+adOFKIAjJVSu/Bm5JdA9v7efN/RkfFbhKa\nN7ZOn1ueEqUz5cVU52ptduO12YlxnRobq0EMjA0CBpS94j/qkURFlTRktyQNOfJF\nkSPd497k2xqkq5fXqJYftwXky7nJeXyji+mIyhMFQFS9Uq2mI7plnRAVJIE1LASH\nD1tAg9SNIA0SsyuazkWwHRefWo0z3YBBxP1r+7E/gQqMFVX8odLyq+yTIXFY0P9b\nV7WnBRrBimY5KMcPRgKusLzXPTO0xA+RDxWbFkUcPmpnp498MYcfH9wBu83mHpWW\n1wIDAQAB\n-----END PUBLIC KEY--- \n\n## Use the RegCreateKeyExW function to open the “ Software ” subkey in the\nHKEY_CURRENT_USER branch.\n\n Then call the RegQueryValueExW function to check if the registry value “ Public ” exists in there:\n\n If it does not, the malware generates a public-private key pair for the victim.\n\n```\n\n-----\n\n4.6. Update shutdown priority\n\n## Pandora calls the SetProcessShutdownParameters function to sets a shutdown order:\n\n4.7. Empty all Recycle Bins on all drives\n\n## For empty all recycle bins, Pandora calls the function SHEmptyRecycleBinA :\n\n4.8. Deleting Shadow Copies\n\n## By calling IsWow64Process, Pandora checks if its process is running under a 64-bit system. If it is, then it calls Wow64DisableWow64FsRedirection to disable file system redirection for its process. Finally, it calls ShellExecuteW to launch a command for deleting all shadow copies:\n\n The command is:\n\n\n-----\n\n```\ncmd.exe /c vssadmin.exe delete shadows /all /quiet \n\n```\n4.9. Manually mount drives\n\n## Pandora provides a built-in list of drive letters:\n\n The complete list is as follows:\n\n\n-----\n\n```\nUPX1:0000000140047712   str_Q:\nUPX1:0000000140047712       text \"UTF-16LE\", 'Q:\\',0\nUPX1:000000014004771A   str_W:\nUPX1:000000014004771A       text \"UTF-16LE\", 'W:\\',0\nUPX1:0000000140047722   str_E:\nUPX1:0000000140047722       text \"UTF-16LE\", 'E:\\',0\nUPX1:000000014004772A   str_R:\nUPX1:000000014004772A       text \"UTF-16LE\", 'R:\\',0\nUPX1:0000000140047732   str_T:\nUPX1:0000000140047732       text \"UTF-16LE\", 'T:\\',0\nUPX1:000000014004773A   str_Y:\nUPX1:000000014004773A       text \"UTF-16LE\", 'Y:\\',0\nUPX1:0000000140047742   str_U:\nUPX1:0000000140047742       text \"UTF-16LE\", 'U:\\',0\nUPX1:000000014004774A   str_I:\nUPX1:000000014004774A       text \"UTF-16LE\", 'I:\\',0\nUPX1:0000000140047752   str_O_0:\nUPX1:0000000140047752       text \"UTF-16LE\", 'O:\\',0\nUPX1:000000014004775A   str_P_0:\nUPX1:000000014004775A       text \"UTF-16LE\", 'P:\\',0\nUPX1:0000000140047762   str_A:\nUPX1:0000000140047762       text \"UTF-16LE\", 'A:\\',0\nUPX1:000000014004776A   str_S:\nUPX1:000000014004776A       text \"UTF-16LE\", 'S:\\',0\nUPX1:0000000140047772   str_D:\nUPX1:0000000140047772       text \"UTF-16LE\", 'D:\\',0\nUPX1:000000014004777A   str_F:\nUPX1:000000014004777A       text \"UTF-16LE\", 'F:\\',0\nUPX1:0000000140047782   str_G:\nUPX1:0000000140047782       text \"UTF-16LE\", 'G:\\',0\nUPX1:000000014004778A   str_H:\nUPX1:000000014004778A       text \"UTF-16LE\", 'H:\\',0\nUPX1:0000000140047792   str_J:\nUPX1:0000000140047792       text \"UTF-16LE\", 'J:\\',0\nUPX1:000000014004779A   str_K:\nUPX1:000000014004779A       text \"UTF-16LE\", 'K:\\',0\nUPX1:00000001400477A2   str_L_0:\nUPX1:00000001400477A2       text \"UTF-16LE\", 'L:\\',0\nUPX1:00000001400477AA   str_Z:\nUPX1:00000001400477AA       text \"UTF-16LE\", 'Z:\\',0\nUPX1:00000001400477B2   str_X:\nUPX1:00000001400477B2       text \"UTF-16LE\", 'X:\\',0\nUPX1:00000001400477BA   str_C_0:\nUPX1:00000001400477BA       text \"UTF-16LE\", 'C:\\',0\nUPX1:00000001400477C2   str_V:\nUPX1:00000001400477C2       text \"UTF-16LE\", 'V:\\',0\nUPX1:00000001400477CA   str_B:\nUPX1:00000001400477CA       text \"UTF-16LE\", 'B:\\',0\nUPX1:00000001400477D2   str_N:\nUPX1:00000001400477D2       text \"UTF-16LE\", 'N:\\',0\nUPX1:00000001400477DA   str_M_0:\nUPX1:00000001400477DA       text \"UTF-16LE\", 'M:\\',0\n\n## Then it uses the function GetDriveTypeW to find drives with type DRIVE_NO_ROOT_DIR .\n\n```\n\n-----\n\n## Next Pandora calls the FindFirstVolumeW, GetVolumePathNamesForVolumeNameW,\n\n### SetVolumeMountPointW, FindNextVolumeW functions to mount the drives.\n\n4.10. Drop ransom note\n\n## Pandora decrypts the ransom note, then writes it to a file named R estore_My_Files.txt :\n\n The full content of Ransom note is as follows:\n\n\n-----\n\n```\n### What happened?\n#### !!!Your files are encrypted!!!\n*All your files are protected by strong encryption with RSA-2048.*\n*There is no public decryption software.*\n*We have successfully stolen your confidential document data, finances, emails,\nemployee information, customers, research and development products...*\n#### What is the price?\n*The price depends on how fast you can write to us.*\n*After payment, we will send you the decryption tool which will decrypt all your\nfiles.*\n#### What should I do?\n*There is only one way to get your files back -->>Contact us, pay and get decryption\nsoftware.*\n*If you decline payment, we will share your data files with the world.*\n*You can browse your data breach here:\nhttp://vbfqeh5nugm6r2u2qvghsdxm3fotf5wbxb5ltv6vw77vus5frdpuaiid.onion*\n(you should download and install TOR browser first hxxps://torproject.org)\n#### !!!Decryption Guaranteed!!!\n*Free decryption As a guarantee, you can send us up to 3 free decrypted files before\npayment.*\n#### !!!Contact us!!!\nemail:\ncontact@pandoraxyz.xyz\n#### !!!Warning!!!\n*Do not attempt to decrypt your data using third-party software, this may result in\npermanent data loss.*\n*Decrypting your files with the help of a third party may result in a price increase\n(they charge us a fee), or you may fall victim to a scam.*\n*Don't try to delete programs or run antivirus tools. It won't work.*\n*Attempting to self-decrypt the file will result in the loss of your data.*\n\n```\n4.11. List of file extension and directories to avoid\n\n## Before performing encryption, Pandora will check if the filename is not in the list of files and directories to avoid.\n\n Here is the complete avoid list:\n\n\n-----\n\n```\nUPX1:000000014004828C 2E 00 68 00 74 00 61 00+    text UTF 16LE, .hta,0\nUPX1:0000000140048296             str_exe:\nUPX1:0000000140048296 2E 00 65 00 78 00 65 00+    text \"UTF-16LE\", '.exe',0\nUPX1:00000001400482A0             str_dll:\nUPX1:00000001400482A0 2E 00 64 00 6C 00 6C 00+    text \"UTF-16LE\", '.dll',0\nUPX1:00000001400482AA             str_cpl:\nUPX1:00000001400482AA 2E 00 63 00 70 00 6C 00+    text \"UTF-16LE\", '.cpl',0\nUPX1:00000001400482B4             str_ini:\nUPX1:00000001400482B4 2E 00 69 00 6E 00 69 00+    text \"UTF-16LE\", '.ini',0\nUPX1:00000001400482BE             str_cab:\nUPX1:00000001400482BE 2E 00 63 00 61 00 62 00+    text \"UTF-16LE\", '.cab',0\nUPX1:00000001400482C8             str_cur:\nUPX1:00000001400482C8 2E 00 63 00 75 00 72 00+    text \"UTF-16LE\", '.cur',0\nUPX1:00000001400482D2             str_drv:\nUPX1:00000001400482D2 2E 00 64 00 72 00 76 00+    text \"UTF-16LE\", '.drv',0\nUPX1:00000001400482DC             str_hlp:\nUPX1:00000001400482DC 2E 00 68 00 6C 00 70 00+    text \"UTF-16LE\", '.hlp',0\nUPX1:00000001400482E6             str_icl:\nUPX1:00000001400482E6 2E 00 69 00 63 00 6C 00+    text \"UTF-16LE\", '.icl',0\nUPX1:00000001400482F0             str_icns:\nUPX1:00000001400482F0 2E 00 69 00 63 00 6E 00+    text \"UTF-16LE\", '.icns',0\nUPX1:00000001400482FC             str_ico:\nUPX1:00000001400482FC 2E 00 69 00 63 00 6F 00+    text \"UTF-16LE\", '.ico',0\nUPX1:0000000140048306             str_idx:\nUPX1:0000000140048306 2E 00 69 00 64 00 78 00+    text \"UTF-16LE\", '.idx',0\nUPX1:0000000140048310             str_sys:\nUPX1:0000000140048310 2E 00 73 00 79 00 73 00+    text \"UTF-16LE\", '.sys',0\nUPX1:000000014004831A             str_spl:\nUPX1:000000014004831A 2E 00 73 00 70 00 6C 00+    text \"UTF-16LE\", '.spl',0\nUPX1:0000000140048324             str_ocx:\nUPX1:0000000140048324 2E 00 6F 00 63 00 78 00+    text \"UTF-16LE\", '.ocx',0\nUPX1:0000000140048334             str_AppData:\nUPX1:0000000140048334 41 00 70 00 70 00 44 00+    text \"UTF-16LE\", 'AppData',0\nUPX1:0000000140048344             str_Boot:\nUPX1:0000000140048344 42 00 6F 00 6F 00 74 00+    text \"UTF-16LE\", 'Boot',0\nUPX1:000000014004834E             str_Windows:\nUPX1:000000014004834E 57 00 69 00 6E 00 64 00+    text \"UTF-16LE\", 'Windows',0\nUPX1:000000014004835E             str_Windowsold:\nUPX1:000000014004835E 57 00 69 00 6E 00 64 00+    text \"UTF-16LE\",\n'Windows.old',0\nUPX1:0000000140048376             str_TorBrowser:\nUPX1:0000000140048376 54 00 6F 00 72 00 20 00+    text \"UTF-16LE\", 'Tor\nBrowser',0\nUPX1:000000014004838E             str_InternetExplorer:\nUPX1:000000014004838E 49 00 6E 00 74 00 65 00+    text \"UTF-16LE\", 'Internet\nExplorer',0\nUPX1:00000001400483B2             str_Google:\nUPX1:00000001400483B2 47 00 6F 00 6F 00 67 00+    text \"UTF-16LE\", 'Google',0\nUPX1:00000001400483C0             str_Opera:\nUPX1:00000001400483C0 4F 00 70 00 65 00 72 00+    text \"UTF-16LE\", 'Opera',0\nUPX1:00000001400483CC             str_OperaSoftware:\nUPX1:00000001400483CC 4F 00 70 00 65 00 72 00+    text \"UTF-16LE\", 'Opera\nSoftware',0\nUPX1:00000001400483EA             str_Mozilla:\n\n```\n\n-----\n\n```\nUPX1:00000001400483EA 4D 00 6F 00 7A 00 69 00+    text UTF 16LE, Mozilla,0\nUPX1:00000001400483FA             str_MozillaFirefox:\nUPX1:00000001400483FA 4D 00 6F 00 7A 00 69 00+    text \"UTF-16LE\", 'Mozilla\nFirefox',0\nUPX1:000000014004841A             str_RecycleBin:\nUPX1:000000014004841A 24 00 52 00 65 00 63 00+    text \"UTF-16LE\",\n'$Recycle.Bin',0\nUPX1:0000000140048434             str_ProgramData:\nUPX1:0000000140048434 50 00 72 00 6F 00 67 00+    text \"UTF-16LE\",\n'ProgramData',0\nUPX1:000000014004844C             str_AllUsers:\nUPX1:000000014004844C 41 00 6C 00 6C 00 20 00+    text \"UTF-16LE\", 'All Users',0\nUPX1:0000000140048460             str_autoruninf:\nUPX1:0000000140048460 61 00 75 00 74 00 6F 00+    text \"UTF-16LE\",\n'autorun.inf',0\nUPX1:0000000140048478             str_bootini:\nUPX1:0000000140048478 62 00 6F 00 6F 00 74 00+    text \"UTF-16LE\", 'boot.ini',0\nUPX1:000000014004848A             str_bootfontbin:\nUPX1:000000014004848A 62 00 6F 00 6F 00 74 00+    text \"UTF-16LE\",\n'bootfont.bin',0\nUPX1:00000001400484A4             str_bootsectbak:\nUPX1:00000001400484A4 62 00 6F 00 6F 00 74 00+    text \"UTF-16LE\",\n'bootsect.bak',0\nUPX1:00000001400484BE             str_bootmgr:\nUPX1:00000001400484BE 62 00 6F 00 6F 00 74 00+    text \"UTF-16LE\", 'bootmgr',0\nUPX1:00000001400484CE             str_bootmgrefi:\nUPX1:00000001400484CE 62 00 6F 00 6F 00 74 00+    text \"UTF-16LE\",\n'bootmgr.efi',0\nUPX1:00000001400484E6             str_bootmgfwefi:\nUPX1:00000001400484E6 62 00 6F 00 6F 00 74 00+    text \"UTF-16LE\",\n'bootmgfw.efi',0\nUPX1:0000000140048500             str_desktopini:\nUPX1:0000000140048500 64 00 65 00 73 00 6B 00+    text \"UTF-16LE\",\n'desktop.ini',0\nUPX1:0000000140048518             str_iconcachedb:\nUPX1:0000000140048518 69 00 63 00 6F 00 6E 00+    text \"UTF-16LE\",\n'iconcache.db',0\nUPX1:0000000140048532             str_ntldr:\nUPX1:0000000140048532 6E 00 74 00 6C 00 64 00+    text \"UTF-16LE\", 'ntldr',0\nUPX1:000000014004853E             str_ntuserdat:\nUPX1:000000014004853E 6E 00 74 00 75 00 73 00+    text \"UTF-16LE\", 'ntuser.dat',0\nUPX1:0000000140048554             str_ntuserdatlog:\nUPX1:0000000140048554 6E 00 74 00 75 00 73 00+    text \"UTF-16LE\",\n'ntuser.dat.log',0\nUPX1:0000000140048572             str_ntuserini:\nUPX1:0000000140048572 6E 00 74 00 75 00 73 00+    text \"UTF-16LE\", 'ntuser.ini',0\nUPX1:0000000140048588             str_thumbsdb:\nUPX1:0000000140048588 74 00 68 00 75 00 6D 00+    text \"UTF-16LE\", 'thumbs.db',0\nUPX1:000000014004859C             str_ProgramFiles:\nUPX1:000000014004859C 50 00 72 00 6F 00 67 00+    text \"UTF-16LE\", 'Program\nFiles',0\nUPX1:00000001400485B8             str_ProgramFilesx86:\nUPX1:00000001400485B8 50 00 72 00 6F 00 67 00+    text \"UTF-16LE\", 'Program Files\n(x86)',0\nUPX1:00000001400485E0             str_recycle:\n\n```\n\n-----\n\n```\nUPX1:00000001400485E0 23 00 72 00 65 00 63 00+    text UTF 16LE, #recycle,0\nUPX1:00000001400485F2 2E 00 2E 00 00 00        text \"UTF-16LE\", '..',0\nUPX1:00000001400485F8 2E 00 00 00           text \"UTF-16LE\", '.',0\n\n## Source: vx\n underground (@vxunderground) End.\n\n m4n0w4r\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-21 - [QuickNote] Analysis of Pandora ransomware.pdf"
    ],
    "report_names": [
        "2022-03-21 - [QuickNote] Analysis of Pandora ransomware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536072,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1653710030,
    "ts_modification_date": 1653710030,
    "files": {
        "pdf": "https://archive.orkl.eu/f684613165b282577d54c90e298d5f24b29ab733.pdf",
        "text": "https://archive.orkl.eu/f684613165b282577d54c90e298d5f24b29ab733.txt",
        "img": "https://archive.orkl.eu/f684613165b282577d54c90e298d5f24b29ab733.jpg"
    }
}