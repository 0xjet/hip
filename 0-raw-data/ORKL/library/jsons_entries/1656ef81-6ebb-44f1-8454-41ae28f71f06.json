{
    "id": "1656ef81-6ebb-44f1-8454-41ae28f71f06",
    "created_at": "2023-01-12T15:08:27.39371Z",
    "updated_at": "2025-03-27T02:05:26.244916Z",
    "deleted_at": null,
    "sha1_hash": "e16b67f78a22b96a7b207fd3799748421f35032f",
    "title": "2020-06-16 - New Java STRRAT ships with .crimson ransomware module",
    "authors": "",
    "file_creation_date": "2022-05-28T02:21:36Z",
    "file_modification_date": "2022-05-28T02:21:36Z",
    "file_size": 544136,
    "plain_text": "# New Java STRRAT ships with .crimson ransomware module\n\n**gdatasoftware.com/blog/strrat-crimson**\n\n06/16/2020\n\nG DATA Blog\nThis Java based malware installs RDPWrap, steals credentials, logs keystrokes and remote controls Windows\nsystems. It may soon be capable to infect without Java installed.\n\nJava is not commonly used for malware anymore and its runtime environment is not installed on as many\nsystems as it was in the past. The more it seems surprising when new Java based malware families arise.\n\nI am an active member of the forum [MalwareTips.com. A member of this forum,](https://malwaretips.com/) [upnorth, shared a sample[2] to be](https://malwaretips.com/members/upnorth.38832/)\nused for testing Antivirus products. This sample[2] caught my attention. It was a Java archive but described as\nWSHRat. I expected to see either a dropper for a known WSH based RAT or another Adwind variant. I was\nwrong. This sample[2] is a new breed of Java RAT. One that is prepared to not rely on a preinstalled Java Runtime\nEnvironment (JRE).\n\n\n## Infection chain overview\n\nThe following sections will describe the infection chain in detail. Here is an overview involving initial infection,\nintermediate files, unpacking layers and hardcoded downloads by the payload. The numbering of files in the\n[image corresponds to numbers in the IOC listing at the bottom of the article.](https://www.gdatasoftware.com/blog/strrat-crimson#c205508)\n\n\n-----\n\n### Infection chain 1: Spam email with malicious Jar attachment\n\nThe infection starts with a rather ordinary spam email[1] that has a malicious attachment named NEW\n**ORDER.jar[2].**\n\n\nI found this email via VirusTotal graphs which shows a relationship to our Jar file. It is not clear if the uploader of\nthe email redacted the email body or if the threat actors didn't want to take their time to add any content. It should\nbe noted that Outlook prevents access to email attachments with .jar extension. In this case I applied a registry\nhack to have it shown anways.\n\n\n-----\n\nThe NEW ORDER.jar[2] is a simple dropper. It retrieves a VBScript[3] from the resources, saves the script as\n**bqhoonmpho.vbs[3] to the home directory of the user and executes it using wscript.exe.**\n\n\n-----\n\n### Infection chain 2: VBScript downloads and installs Java for the RAT\n\nThe VBScript[3] has a large string in it and uses PowerShell to replace characters in this string. The resulting\nbase64 string is subsequently decoded and executed by PowerShell.\n\nThe unpacked layer is again a VBScript. This script will copy the packed version of itself to\n**%APPDATA%\\edeKbMYRtr.vbs. It will also download a Java Runtime Environment (see picture below) and add**\nit to the registry. That way it may be prepared to infect systems that don't have Java installed. It even has a builtin check that runs javaw.exe with the -version parameter to verify that the JRE has the version 1.6, 1.7 or 1.8.\n\nThe email attachment already requires a Java Runtime Environment (JRE) on the system, which means the\ncurrent infection chain misses the opportunity to work regardless of the JRE installation. If this VBScript is ever\nshipped with a different initial infection step, it may enable the RAT to work on more systems.\n\n\n-----\n\nThe VBScript continues to write the actual payload to %APPDATA%\\ntfsmgr.jar[4] and add a RUN key named\n**ntfsmgr to the registry that will autorun the dropped Jar[4] . The RUN key will use the newly installed JRE if no**\nJRE was present before.\n\n### Infection chain 3: Initial payload analysis\n\nWhat striked me first about the Jar payload is the package name strpayload and one of the dependencies listed\nin the MANIFEST.MF named system-hook-3.5.jar.\n\n[A quick search for the library turns up a GitHub repository by user kristian stating that \"Java (low-level) System](https://github.com/kristian/system-hook)\nHook provides a very light-weight global keyboard and mouse listener for Java\". We can already estimate that the\nmalware may use it to log keystrokes.\n\nWe see immediately that the Jar file is obfuscated by Allatori. Upon opening the Main.class we find a URL\nreference to hxxp://jbfrost.live/strigoi/lib.zip\n\nThe URL provides a ZIP bundle of all the dependencies listed in the MANIFEST.MF. The malware will probably\nnot work correctly if this site is down.\n\nDue to the use of Allatori most of the strings in the Jar file are encrypted with AES. Method arguments and local\nvariables mostly use the name 'a' which creates non-working decompiled Java code. Although Java bytecode\nsaves variable names, it uses indices to reference them. So using the same name several times doesn't cause an\nerror in the bytecode but causes one in decompiled code because it's not clear anymore which variable was\nreferenced by 'a'.\n\nAn example is seen in the image below. The left side shows decompiled Java code with both arguments named\n'a'. The right side shows the same method in Java bytecode. The first argument 'arg0' is later referenced by it's\nindex via 'adload0'.\n\n\n-----\n\nMethod f in class strpayload.r builds a string with information about the infected system. Among others it shows\nname and supposedly version number of the malware, which is \"STRRAT 1.2\".\n\n## Deobfuscating STRRAT and its configuration\n\n[To combat string encryption by Allatori I used 'Deobfuscator' by Github user 'Java Deobfuscator'. Deobfuscator](https://github.com/java-deobfuscator/deobfuscator)\nhas a variety of options to choose from. I applied Allatori.StringEncryptionTransformer which successfully\ndecrypted the strings.\n\nIn a resource of the malware I found an encrypted configuration file. The malware code shows it is encrypted with\nAES using the password \"strgoi\". I made a quick and dirty decrypter by copying the decompiled code for the\ndecryption method and repairing it, so the double names are not causing compile errors. Then I added a few lines\nto read and write the config. My configuration decryption code is listed below.\n\n\n-----\n\n```\n p j ;\nimport java.nio.ByteBuffer;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\nimport javax.crypto.Cipher;\nimport javax.crypto.SecretKey;\nimport javax.crypto.SecretKeyFactory;\nimport javax.crypto.spec.IvParameterSpec;\nimport javax.crypto.spec.PBEKeySpec;\nimport javax.crypto.spec.SecretKeySpec;\npublic class ConfigDecrypter { public static void main(String[] args) throws Exception { File config =\nnew File(\"config.txt\"); byte[] configBytes = Files.readAllBytes(config.toPath()); byte[] decryptedConfig\n= decryptConfig(\"strigoi\", configBytes); Path output = Paths.get(\"config_decrypted.txt\");\nFiles.write(output, decryptedConfig); } public static byte[] decryptConfig(String password, byte[] data)\nthrows Exception { int var2; ByteBuffer a; if ((var2 = (a = ByteBuffer.wrap(data)).getInt()) >= 12 &&\nvar2 <= 16) { byte[] var6 = new byte[var2]; a.get(var6); SecretKey var3 = createKey(password,\nvar6); ByteBuffer var10001 = a; byte[] var8 = new byte[a.remaining()]; data = var8;\nvar10001.get(var8); Cipher var4 = Cipher.getInstance(\"AES/CBC/PKCS5PADDING\"); IvParameterSpec\nvar7 = new IvParameterSpec(var6); var4.init(2, var3, var7); return var4.doFinal(data); }\nelse { throw new IllegalArgumentException(\"Nonce size is incorrect. Make sure that the incoming data is\nan AES encrypted file.\"); } } public static SecretKey createKey(String password, byte[] data) throws\nException { PBEKeySpec a = new PBEKeySpec(password.toCharArray(), data, 65536, 128); byte[] d\n= SecretKeyFactory.getInstance(\"PBKDF2WithHmacSHA1\").generateSecret(a).getEncoded(); return new\nSecretKeySpec(d, \"AES\"); }\n}\n\n```\nThe resulting plain text configuration of our sample is in the picture below. It reveals, among others, the C2C\nserver.\n\n## STRRAT features and command listing\n\nThe RAT has a focus on stealing credentials of browsers and email clients, and passwords via keylogging. It\nsupports the following browsers and email clients: Firefox, Internet Explorer, Chrome, Foxmail, Outlook,\nThunderbird.\n\nSTRRAT also allows installation of RDPWrap. The file is downloaded from\n**hxxp://wshsoft.company/multrdp(.)jpg.** [RDWrap is an open source tool that enables Remote Desktop Host](https://github.com/stascorp/rdpwrap)\nsupport on Windows.\n\n[There is also a ransomware module. It is described in the section below.](https://www.gdatasoftware.com/blog/strrat-crimson#c205537)\n\nThe following table shows a list of all available commands.\n\n**Command** **Description**\n\nreboot Reboots the infected system\n\nshutdown Shuts down the infected system\n\nuninstall Removes persistence of the RAT by deleting the scheduled task and autorun entries in the\nregistry.\n\ndisconnect Closes the connection\n\n\ndown-nexec\n\n\nDownloads a file from a given URL and executes it\n\n\n-----\n\n**Command** **Description**\n\nupdate Disconnects, then executes a given file in the start menu.\n\nup-n-exec Executes a file given by name. Chooses the appropriate runtime environment for files with .jar, .js,\n.vbs or .wsf extension. Every other file is executed with cmd.exe /c.\n\n\nremotecmd\n\npowershell\n\nfilemanager\n\n\nExecutes commands with cmd.exe\n\nExecutes commands with powershell.exe\n\nProvides commands to navigate, upload, download, delete and open files\n\n\nkeylogger Logs keystrokes and sends them immediately\n\n\nokeylogger\n\n\nStarts offline keylogger which saves logged keystrokes to a text file on the infected system\n\n\nprocesses Create a process listing\n\nstartup-list Uses WMI to compile a list of autorun entries\n\n\nremotescreen\n\n\nRemote control the infected computer\n\n\nrev-proxy Reverse proxy\n\nhrdp-new Downloads and installs HRDPInst.exe[5] which stands for \"Hidden RDP Installer\". Download URL\nhxxp://wshsoft.company/multrdp(.)jpg\n\n\nhrdp-res Same as hrdp-new, but takes an argument containing a user name. The session for this user is\nlogged off.\n\n\nchromepass\n\nfoxmailpass\n\noutlookpass\n\n\nExtracts Chrome credentials\n\nExtracts Foxmail credentials\n\nExtracts Outlook credentials\n\n\nfox-pass Extracts Firefox credentials\n\ntb-pass Extracts Thunderbird credentials\n\nie-pass Extracts Internet Explorer credentials\n\nall-pass Extracts all credentials\n\nchk-priv Returns whether it is run as administrator or user\n\nreq-priv Run as administrator\n\nrw-encrypt Appends \".crimson\" extension to files on the system\n\nrw-decrypt Removes \".crimson\" extension from files on the system\n\nshow-msg Display a message with notepad.exe\n\n\n-----\n\n## Rudimentary ransomware module appends .crimson\n\nThe commands used for the ransomware component are rw-encrypt for \"encrypting\" files, rw-decrypt for\n\"decrypting\" files and show-msg for displaying the ransom note.\n\nRansomware \"encrytion\" and \"decryption\" methods are in the class strpayload.l. The \"encryption\" method is\nseen in the screenshot below.\n\nHowever, the so called \"encryption\" only renames files by appending the .crimson extension. This might still work\nfor extortion because such files cannot be opened anymore by double-clicking. Windows associates the correct\nprogram to open files via their extension. If the extension is removed, the files can be opened as usual.\n\nThere is no ransom note template in the client of the RAT. The attacker can display anything they like with the\n**show-msg command. It is possible that the server provides ransom note templates.**\n\n## STRRAT attempts to infect German customers\n\nThe version number \"1.2\" and the fact that this malware doesn't seem to be described before indicates that this\nRAT is a fairly new player in the wild. The infection chain is not well thought out as it makes void certain features\nof the intermediate layers in the chain. I also haven't seen any ransomware reports involving this RAT. Maybe the,\nfor now, badly implemented ransomware module is just the first version of it.\n\nOur telemetry shows infection attempts on German customers. While we hope not to see any more of them, it's\nmost likely not the end of it.\n\nIt should be noted that the number of potentially vulnerable systems is limited by the current infection chain.\n\n1. Even though it is Java based, the RAT only works on Windows\n\n\n-----\n\n2. Even though preparations have been made to overcome this, the current chain still needs a pre installed\n\nJRE\n3. Outlook blocks the email attachment\n\nI expect that the second and third limitation may be removed soon because they are already prepared or easily\nimplemented. The limitation on Windows however would require too many code modifications.\n\n## Indicators of Compromise\n\n**Description** **Filename** **SHA256**\n\n\n\n[1] Spam\nemail\n\n[2] Java\nbased VBS\ndropper\n\n[3] VBScript\nbased JAR\ndropper\n\n[4] Java\nRAT\n\n[5]\nRDPWrap\n\n**Karsten Hahn**\n\n\n1124150.eml e6b0a56662d1f0544257c63e63b2f85ad7215f0df3a7f5a689dee66f27e24db7\n\nNEW ORDER.jar 0f0e25e859bc6f21447ed196d557eb6cdba9737dd3de22a5183a505da0126302\n\n\nbqhoonmpho.vbs\n\nedeKbMYRtr.vbs\n\n\nb76e2eea653b480c8a559215aa08806fad4c83c60f9a5996e89d51709212ee29\n\n\nntfsmgr.jar 7c24d99685623b604aa4b2686e9c1b843a4243eb1b0b7b096d73bcae3d8d5a79\n\nmultrdp.jpg ac92d4c6397eb4451095949ac485ef4ec38501d7bb6f475419529ae67e297753\n\n\nMalware Analyst\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-16 - New Java STRRAT ships with .crimson ransomware module.pdf"
    ],
    "report_names": [
        "2020-06-16 - New Java STRRAT ships with .crimson ransomware module.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536107,
    "ts_updated_at": 1743041126,
    "ts_creation_date": 1653704496,
    "ts_modification_date": 1653704496,
    "files": {
        "pdf": "https://archive.orkl.eu/e16b67f78a22b96a7b207fd3799748421f35032f.pdf",
        "text": "https://archive.orkl.eu/e16b67f78a22b96a7b207fd3799748421f35032f.txt",
        "img": "https://archive.orkl.eu/e16b67f78a22b96a7b207fd3799748421f35032f.jpg"
    }
}