{
    "id": "57120358-1b0c-4042-8ded-4054e6c62c71",
    "created_at": "2023-01-12T15:09:14.068222Z",
    "updated_at": "2025-03-27T02:05:21.966208Z",
    "deleted_at": null,
    "sha1_hash": "31a02d3a2f35dd53a81cdacbbda60acd6ab26a76",
    "title": "2022-03-31 - How to- Detect and prevent common data exfiltration attacks",
    "authors": "",
    "file_creation_date": "2022-05-28T17:12:30Z",
    "file_modification_date": "2022-05-28T17:12:30Z",
    "file_size": 3843104,
    "plain_text": "# How to: Detect and prevent common data exfiltration attacks\n\n**[blog.apnic.net/2022/03/31/how-to-detect-and-prevent-common-data-exfiltration-attacks/](https://blog.apnic.net/2022/03/31/how-to-detect-and-prevent-common-data-exfiltration-attacks/)**\n\nDebashis Pal March 30, 2022\n\n[Photo: No Access by Bob Shand, Flickr](https://www.flickr.com/photos/bobthelomond/1043205025)\nData exfiltration is a technique used by malicious actors to carry out an unauthorized data\ntransfer from a computer resource. Data exfiltration can be done remotely or locally and can\nbe difficult to detect from normal network traffic.\n\nTypes of data that are targeted include: Usernames, associated passwords and other system\nauthentication-related information, cryptographic keys, financial records, information\nassociated with strategic decisions, and mailing addresses with content or what is valuable\ndata for a cyber attacker. The damages can immeasurable when the organization’s most\nvaluable data is in the hand of a cyber attacker.\n\nAdvanced Persistent Threats (APTs) are one form of cyberattack in which data exfiltration is\noften a primary goal. The goal of an APT is to gain access to a network, but remain\nundetected as it stealthily seeks out the most valuable or target data.\n\n\n-----\n\nUsually, [attackers use covert channels for data exfiltration because covert channels are](https://cwe.mitre.org/data/definitions/514.html)\nusually very difficult to detect due to their ability to use existing legitimate connections or\nprotocols. A covert channel is a method of data transfer between two parties (usually a\nmalicious insider and a malicious outsider) over a medium that is not supposed to be allowed\nto communicate by the computer security policy. The Trusted Computer System Evaluation\nCriteria (TCSEC) defines two kinds of covert channels:\n\n[Storage channels, which communicate by modifying a ‘storage location’, such as a](https://cwe.mitre.org/data/definitions/515.html)\nhard drive.\n[Timing channels, which perform operations that affect the ‘real response time](https://cwe.mitre.org/data/definitions/385.html)\nobserved’ by the receiver.\n\nUnfortunately, an attacker does not need to use advanced tools to exfiltrate data. They can\nuse very simple techniques for stealing and transferring data from an internal network to an\nattacker domain such as HTTP/HTTPS, SMTP, DNS, SMTP, P2P, VPN or even the ARP\nmethod for data exfiltration. For example, the MITRE ATT&CK framework exfiltration tactic\n[(TA0010) describes how an attacker can take data collected within a target network and](https://attack.mitre.org/tactics/TA0010/)\nexfiltrate it outside the network to systems under the attacker’s control.\n\nIn this post, I will review a few common data exfiltration techniques in a lab environment. I\nwill also highlight the best practices for detecting and preventing data exfiltration attacks.\n\nNote: All the cases in this post were tested in a sandbox environment for educational\npurposes only. The site owners, publisher and the author cannot be held responsible for any\ndamages caused.\n\nIn the post ‘Target Data’ means malicious actors want to steal, copy and transfer to the\nattacker command and control (C&C) channel or an alternative channel.\n\n## Hypertext Transfer Protocol (HTTP)\n\nAttackers often use HTTP to exfiltrate data because this traffic is very common in enterprise\nnetworks and is always permitted. The high volume of HTTP traffic traversing enterprise\nnetworks can allow attackers to hide their evil motivation and allow data mixing with\nlegitimate traffic.\n\nPOST is an HTTP method designed to send data to the server from an HTTP client. The\nHTTP POST method requests the web server to accept the data enclosed in the body of the\nPOST message. It is often used when uploading a file or when submitting a completed web\nform. Usually, there is no limit to the amount of data that can be transferred using this\nmethod, except the limit imposed by the web server — if the file size is too large for the web\nserver to handle in a single POST request, it can be split up and sent in multiple requests.\n\n\n-----\n\nAttackers can configure the web server to respond to only specific types of requests, which\nallows attackers to remain stealthy. For example, the server only accepts requests from\nspecific user-agents that are only known by the attacker.\n\n[Rising Sun is a modular backdoor malware that can send data gathered from the infected](https://attack.mitre.org/software/S0448/)\nmachine via an HTTP POST request to the command and control (C2) server. This malware\nhas been observed targeting nuclear, defence, energy, and financial service companies\nacross the world.\n\nThe following basic example of data exfiltration (Figures 1-7) relies on HTTP POST. The lab\nenvironment consists of one server as an HTTP web server with logging capabilities, and\nanother that is considered a compromised host, which will send the stolen data using the\ncompromised system’s available tools without installing any additional software. One such\ntool is cURL, which is a library and command-line tool for transferring data using various\nprotocols. When used for data exfiltration processes, cURL can POST a file to an attacker’s\nweb server from a compromised linux host, as shown in Figure 1:\n\nFigure 1 — cURL command for POST file to attacker server.\nThe attacker can then listen and capture the incoming ‘Exfil Data’, as shown in Figure 2:\n\nFigure 2 — Attacker server response with cURL POST command executed from the victim\nhost.\nIf the victim host is a Windows platform, the attacker can use the PowerShell command to\nsend a file using the HTTP POST method over TCP port 80, as shown in Figure 3:\n\n\n-----\n\nFigure 3 — PowerShell code for HTTP POST from the victim host.\nThe attacker server response with the above command is shown in Figure 4:\n\nFigure 4 — HTTP POST received from the victim to the attacker listing server.\nAttackers can even encrypt or compress the target data before sending it to their server\n(Figure 5). Most of the time this is considered as ‘stealth exfiltration’ because it seems to be\nlegitimate traffic and usually raises no alarm to monitoring systems.\n\nFigure 5 — Victim host to attacker control system communication with encrypted Payload\nusing HTTP POST.\n\n\n-----\n\nAfter the PowerShell code is executed, the following HTTP POST, along with encrypted\npayload/data requests, are sent to the attacker’s server (Figure 6).\n\nFigure 6 — HTTP POST along with encrypted payload received from the victim to the\nattacker listing server.\nDecrypting the data is an easy job for an attacker as they know the key (Figure 7).\n\nFigure 7 — Encrypted payload/data decryption.\n\n## The Simple Mail Transfer Protocol (SMTP)\n\nSMTP is one of the most common methods for data exfiltration. Several malware programs\nexfiltrate the stolen information to an attacker-controlled SMTP server. For example Agent\n[Tesla is a Windows-based keylogger and Remote Access Trojan (RAT) commonly uses](https://en.wikipedia.org/wiki/Remote_desktop_software#RAT)\nSMTP to exfiltrate stolen data.\n\nAttackers can use the following PowerShell code (Figure 8) to send an email with an\nattached file (stolen data) to exfiltrate a remote address:\n\nFigure 8 — Victim host sends stolen data to the attacker-controlled email box using SMTP.\nFigure 9 shows the ‘Successful Email Delivered’ to the attacker’s email box:\n\n\n-----\n\nFigure 9 — Exfiltrated data delivered to attacker’s email box.\nThe related SMTP streams are shown in Figure 10:\n\nFigure 10 — SMTP streams.\n\n## Domain Name System (DNS)\n\nThe DNS is the hierarchical and decentralized naming system used to identify computers,\nservices, and other resources reachable through the Internet or other Internet Protocol (IP)\nnetworks. This protocol works through TCP/UDP port 53 by default and is used only to\nexchange specific data.\n\nDuring the exfiltration phase, the attacker makes a DNS query (initiates a domain name\nresolution request) to an external DNS server address. Such requests are not usually\nblocked by security perimeters. Without responding with an A record in response, the\nattacker’s name server will respond with CNAME/MX or a TXT record that allows the data to\nbe sent between them and the victim.\n\nThe attacker can then use the following tools to extract files:\n\n\n-----\n\n[DNSMessenger is a RAT used to conduct malicious PowerShell commands on](https://malpedia.caad.fkie.fraunhofer.de/details/win.dnsmessenger)\n[compromised computers. DNSteal is a tool that creates a fake DNS server that allows](https://github.com/m57/dnsteal)\nattackers to stealthily extract files from a victim machine through DNS requests. This\ntool also supports Gzip file compression.\n\nFigure 11 shows the attacker running the DNSteal tool with a -z parameter (transferred file\nwas compressed/zipped by default in their attacker-controlled name server):\n\nFigure 11 — The DNSteal tool showing the attacker’s name system.\nFrom the victim system (Figure 12), it tries to send the targetdata.txt file over the DNS\nconnection using the following command:\n\nFigure 12 — The victim system sends the targetdata.txt file over the DNS.\nFinally, the attacker’s name server receives the target data (Figure 13).\n\n\n-----\n\nFigure 13 — The attacker’s name server receives the target data using DNS as a\ncommunication protocol.\n\n## Internet Control Message Protocol (ICMP)\n\nICMP is a supporting protocol in the Internet protocol suite and is widely known for its\napplications such as ping or traceroute. Malicious actors can use ICMP to exfiltrate data, by\ntaking advantage of organizations that allow outbound ICMP traffic. A common example of\n[this is the Windows malware Pingback, which uses ICMP for its C2 activities.](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/backdoor-at-the-end-of-the-icmp-tunnel/)\n\n[Metasploit have a module that will receive the exfiltrated data over ICMP from the victim](https://www.rapid7.com/db/modules/auxiliary/server/icmp_exfil/)\nhost. For exfiltrated data, it needs a tool name Nping (Nping comes with Nmap). The\nMetasploit module server-side component receives and stores files exfiltrated over ICMP\necho request packets.\n\nFigure 14 shows the Metasploit listener machine on the attacker’s side, following the load\nand run module:\n\nFigure 14 — Metasploit module load and run for ICMP ping replies from the victim.\nFigure 15 shows an example of the victim host using the following command:\n\n\n-----\n\nFigure 15 — Victim uses the Nping tool to send stolen data using ICMP.\nIn the first command, Nping will send data via ICMP. This will show up as stoleninfo.txt in the\nattacker’s machine. The second command sends the target data and final packets containing\nthe ‘EOF’ string. This tells the Metasploit module that data exfiltration over ICMP is\ncompleted.\n\nIn the attacker Metasploit module (Figure 16) we found the following:\n\nFigure 16 — Exfiltrated data stored in the attacker machine using ICMP.\nThe packet capture shows data is transferred via the ICMP protocol (Figure 17):\n\n\n-----\n\nFigure 17 — ICMP data exfiltration packet capture.\n\n## Address Resolution Protocol (ARP)\n\nARP is a communication protocol used for discovering link-layer addresses, such as a MAC\naddress, associated with a given Internet layer address. The ARP protocol also allows data\nto be transferred in local networks (outside the Local Area Network (LAN) it will not work).\n\n[An attacker can exfiltrate data via the ARP protocol using ARPExfiltrator. This tool has two](https://github.com/nocommentlab/ARPExfiltrator)\nparts:\n\n1. Sender script, which runs on the victim machine.\n2. Receiver script, which runs on the attacker’s machine with root privilege.\n\nThe sender encodes the string buffer using the base64 algorithm and sends each letter of\nthe encoded string as a network IPv4 address. The receiver matches each letter with a\nshared list of IPv4 addresses and decodes the received base64 encoded string.\n\nThe process starts with a ‘receiver script’ on the attacker’s machine (Figure 18):\n\nFigure 18 — ‘Receiver script’ running on\n\nthe attacker’s machine.\nThe victim host then tries to send the /etc/shadow file using the sender script (Figure 19):\n\n\n-----\n\nFigure 19 — Victim sends /etc/shadow content to the attacker host using ARPExfiltrator.\nThe attacker server receives the stolen data from the victim using ARPExfiltrator (Figure 20):\n\nFigure 20 — Attacker server listens for exfiltrated data over ARP.\nThe sender script enables a 1 command in ARP Opcode — the Opcode field in the ARP\nmessage specifies the nature of the ARP message where 1 is for the ARP request and 2 is\nfor the ARP reply. This results in a huge number of ARP request messages being sent in the\nLAN, as can be seen in Figure 21:\n\n\n-----\n\nFigure 21 — ARP request operation code.\n\n## Exfiltration using IPv6\n\n[IPv6teal is a Python 3 tool that exfiltrates data from an internal network using a covert](https://github.com/christophetd/IPv6teal)\n[channel built on top of the IPv6 header flow label field.](https://en.wikipedia.org/wiki/IPv6_packet#Fixed_header)\n\nA flow is a group of packets, for example, a TCP session or a media stream. The special flow\nlabel 0 means the packet does not belong to any flow. The purpose of the flow label is to\nmaintain the sequential flow of the packets belonging to a communication. The source labels\nthe sequence to help the router identify that a particular packet belongs to a specific flow of\ninformation. Basically, it is designed to avoid reordering of data packets.\n\nThe IPv6teal tool can build a covert channel by storing data to exfiltrate in this field. The\nexfiltration script sends one IPv6 packet per 20-bits of data, and the receiver script\nreconstructs the data by reading this field. The payload of every IPv6 packet sent contains a\nmagic value, along with a sequence number, so the receiving end can determine which IPv6\npackets are relevant for it to decode.\n\nFigure 22 shows the IPv6teal ‘sender script’ running on a victim host:\n\nFigure 22 — IPv6teal ‘sender script’ running on a victim host.\n\n\n-----\n\nFigure 23 shows the IPv6teal receiver script running on the attacker-controlled machine; it is\ntrying to listen and capture the targeted data:\n\nFigure 23 — ‘IPv6teal receiver script’ and related streams.\n\n## Best practices for detecting data exfiltration\n\nDetecting data exfiltration can be a difficult task and depends largely on the type of attack\nmethod used. Cyber attackers use various sophisticated techniques, including various\nlegitimate processes that are more difficult to detect. Consequently, analysts can mistakenly\nmark the data exfiltration traffic as regular network traffic.\n\nTo detect the presence of a malicious actor, more and more organizations are using\nautomated tools that detect in real-time malicious or unusual traffic automatically. The\nSecurity Information and Event Management System (SIEM) is one such tool that can\nmonitor network traffic in real-time. Some SIEM solutions can even detect malware being\nused to communicate with C2 servers.\n\nOther best practices include:\n\n**Monitoring for outbound traffic patterns as malware needs to regularly**\ncommunicate with C2 servers to maintain a consistent connection. Continuous\nmonitoring provides opportunities to detect data exfiltration with common protocols\nsuch as HTTP:80 or HTTPS:443. It’s worth keeping in mind that some advanced\nmalware randomize delays between C2 communications.\n**Monitoring the volume and frequency of data transmission by organization users**\n**over email. To do this we first need to calculate the average amount of data that**\ninternal users send per day. If this average data size is exceeded (say by 5 or 10\ntimes), this triggers an alert to be investigated.\n**Keeping an up-to-date log of all approved IP addresses connections to compare**\n**against all new connections. Along with this, it’s advised to keep an eye out for large**\ndata flows to unexpected IP addresses and major spikes in anomalous outbound\ntraffic.\n\n\n-----\n\nMost of these practices require searching for known attack signatures and anomalies. From\nthis information, analysts can also build out the entire sequence of an event and map them to\na known attack framework.\n\n## Best practices for preventing data exfiltration\n\nWe can divide most effective preventive measures into three categories: Preventative,\nDetective, and Investigative.\n\nFor example, we should ensure that only known acceptable services are permitted into the\nnetwork. If suspicious network services are running then effective detective controls can\ntrigger alerts, so analysts can investigate and take the appropriate measures immediately.\n\nPreventative controls include: implementing and maintaining technical controls like ACL;\ndeception techniques; encryption of data in process, transit, and at rest; host-based auditing\nfor identified security weaknesses; and remediation.\n\nInvestigative controls include various forensics actions as well as gathering intelligence\noperations, so security teams can improve their knowledge base and create a custom\ndetection system that meets organizational-unique risk profiles.\n\nThe following are a few easy methods to prevent data exfiltration from occurring in your\nnetwork:\n\n**Employee terminations: The Computer Emergency Response Team (CERT) at the**\nSoftware Engineering Institute of Carnegie Mellon University produced a paper\nshowing that employees were more likely to engage in data exfiltration when they\nanticipated imminent termination. Prohibiting an employee’s access to IT systems\nshould happen immediately whenever an employee’s contract is\nover/ended/terminated. The same is true of business partners or vendors.\n**Block unauthorized communication channels: First, disable all unauthorized**\ncommunication channels, ports and protocols by default, and re-enable on an asneeded basis.\n**Create a baseline of normal data flows: This includes amounts of data accessed or**\ntransferred, and geographical locations of access against which to compare abnormal\nbehaviours.\n**Install proper technical controls to prevent phishing attacks: This also requires**\neducating users about how phishing attacks work, how to detect them, and what to do\nwhen they believe they are facing one.\n**Develop Data Loss Prevention (DLP) solutions: DLP technology can analyse the**\ncontent of all data transfers to check for sensitive information against pre-existing\npolicies to detect suspicious activity. This combined with with logging can increase the\ntransparency of organizational data access and movement.\n\n\n-----\n\n**Implement data encryption and data backup processes: Data encryption is a**\nsecurity method where information is encoded and can only be accessed or decrypted\nby a user with the correct encryption key. Encrypted data, also known as ciphertext,\nappears scrambled or unreadable to a person or entity accessing it without permission.\nWithout a key, attackers have no way of understanding and using the data. Data\nbackups help restore lost data and resume operations while the data exfiltration attack\nis being investigated. Encryption provides some protection by preventing access to\ndata by bad actors.\n**Implement proper technical control: Restrict and monitor ingress and egress to**\nmachines in the organization using networking rules, implement Identity and Access\nManagement (IAM), set up bastion hosts, use granular permissions, and grant access\nto sensitive data only to those whose job function requires it.\n\nIn summary, reviewing common data exfiltration attack techniques can help analyse possible\nattack surfaces and related detection capabilities. It also helps to improve the threat hunting\nposture for an analyst, because detecting any instances of data exfiltration as early as\npossible gives victims a chance to minimize the impact of a breach.\n\n_Debashis Pal is an Information Security Specialist from Bangladesh._\n\nRate this article\n\nThe views expressed by the authors of this blog are their own and do not necessarily reflect\n[the views of APNIC. Please note a Code of Conduct applies to this blog.](https://blog.apnic.net/?p=395)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-31 - How to- Detect and prevent common data exfiltration attacks.pdf"
    ],
    "report_names": [
        "2022-03-31 - How to- Detect and prevent common data exfiltration attacks.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536154,
    "ts_updated_at": 1743041121,
    "ts_creation_date": 1653757950,
    "ts_modification_date": 1653757950,
    "files": {
        "pdf": "https://archive.orkl.eu/31a02d3a2f35dd53a81cdacbbda60acd6ab26a76.pdf",
        "text": "https://archive.orkl.eu/31a02d3a2f35dd53a81cdacbbda60acd6ab26a76.txt",
        "img": "https://archive.orkl.eu/31a02d3a2f35dd53a81cdacbbda60acd6ab26a76.jpg"
    }
}