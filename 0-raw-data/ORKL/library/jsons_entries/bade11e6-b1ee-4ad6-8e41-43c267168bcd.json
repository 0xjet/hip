{
    "id": "bade11e6-b1ee-4ad6-8e41-43c267168bcd",
    "created_at": "2023-01-12T15:10:20.763396Z",
    "updated_at": "2025-03-27T02:15:35.696549Z",
    "deleted_at": null,
    "sha1_hash": "c3eb7bdaa78c612143eb3bca7fce5510bb4e5eb9",
    "title": "2020-02-13 - Wireshark Tutorial- Examining Qakbot Infections",
    "authors": "",
    "file_creation_date": "2022-10-23T12:56:02Z",
    "file_modification_date": "2022-10-23T12:56:02Z",
    "file_size": 3839699,
    "plain_text": "# Wireshark Tutorial: Examining Qakbot Infections\n\n**unit42.paloaltonetworks.com/tutorial-qakbot-infection/**\n\nBrad Duncan February 13, 2020\n\nBy [Brad Duncan](https://unit42.paloaltonetworks.com/author/bduncan/)\n\nFebruary 13, 2020 at 6:00 AM\n\n[Category: Tutorial,](https://unit42.paloaltonetworks.com/category/tutorial/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit-42/)\n\nTags: [Cybercrime,](https://unit42.paloaltonetworks.com/tag/cybercrime/) [pcap,](https://unit42.paloaltonetworks.com/tag/pcap/) [Qakbot,](https://unit42.paloaltonetworks.com/tag/qakbot/) [Wireshark,](https://unit42.paloaltonetworks.com/tag/wireshark/) [Wireshark Tutorial](https://unit42.paloaltonetworks.com/tag/wireshark-tutorial/)\n\n\n-----\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/tutorial-qakbot-infection/)\n\n## Overview\n\n[Qakbot is an information stealer also known as Qbot. This family of malware has been active](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Win32%2FQakbot)\nfor years, and Qakbot generates distinct traffic patterns. This [Wireshark tutorial reviews a](https://www.wireshark.org/)\nrecent packet capture (pcap) from a Qakbot infection. Understanding these traffic patterns\ncan be critical for security professionals when detecting and investigating Qakbot infections.\n\nNote: This tutorial assumes you have a basic knowledge of network traffic and Wireshark.\n[We use a customized column display shown in this tutorial. You should also have experience](https://unit42.paloaltonetworks.com/unit42-customizing-wireshark-changing-column-display/)\n[with Wireshark display filters as described in this additional tutorial.](https://unit42.paloaltonetworks.com/using-wireshark-display-filter-expressions/)\n\nPlease also note that the pcap used for this tutorial contains malware. You should review this\npcap in a non-Windows environment. If you are limited to a Windows computer, we suggest\nreviewing the pcap within a virtual machine (VM) running any of the popular recent Linux\ndistros.\n\nThis tutorial will cover the following:\n\nQakbot distribution methods\nInitial zip archive from link in an malspam\nWindows executable for Qakbot\nPost-infection HTTPS activity\nOther post-infection traffic\n\n\n-----\n\n[The pcap used for this tutorial is located here. Download the zip archive named 2020-01-29-](https://www.malware-traffic-analysis.net/2020/01/29/index.html)\n**_Qbot-infection-traffic.pcap.zip and extract the pcap. Figure 1 shows our pcap open in_**\nWireshark, ready to review.\n\nFigure 1. The pcap for this tutorial.\n\n## Qakbot Distribution Methods\n\nQakbot is most often distributed through malicious spam (malspam), but it also has been\n[distributed through exploit kits as recently as November 2019. In some cases, Qakbot is a](https://www.malware-traffic-analysis.net/2019/11/25/index3.html)\n[follow-up infection caused by different malware like Emotet as reported in](https://www.us-cert.gov/ncas/alerts/TA18-201A) this example from\nMarch 2019.\n\nRecent malspam-based distribution campaigns for Qakbot follow a chain of events shown in\nFigure 2.\n\n\n-----\n\nFigure 2. Flow chart from recent Qakbot distribution campaigns.\n\n### Initial Zip Archive from Link in Malspam\n\nRecent malspam distributing Qakbot uses fake email chains that spoof legitimate email\naddresses. One such example is shown in Figure 3.\n\n\n-----\n\nFigure 3. Recent malspam example pushing Qakbot.\nURLs from these emails end with a short series of numbers followed by .zip. See Table 1 for\n[a few examples of URLs from Qakbot malspam recently reported on URLhaus and](https://urlhaus.abuse.ch/browse/) [Twitter.](https://twitter.com/search?q=Qakbot%20zip&f=live)\n\n\n**First**\n**reported**\n\n\n**URL for initial zip archive**\n\n\n2019-12-27 hxxps://prajoon.000webhostapp[.]com/wpcontent/uploads/2019/12/last/033/033.zip\n\n2019-12-27 hxxps://psi-uae[.]com/wp-content/uploads/2019/12/last/870853.zip\n\n2019-12-27 hxxps://re365[.]com/wpcontent/uploads/2019/12/last/85944289/85944289.zip\n\n2019-12-27 hxxps://liputanforex.web[.]id/wp-content/uploads/2019/12/last/794/794.zip\n\n2020-01-06 hxxp://eps.icothanglong.edu[.]vn/forward/13078.zip\n\n2020-01-22 hxxp://hitechrobo[.]com/wpcontent/uploads/2020/01/ahead/84296848/84296848.zip\n\n\n-----\n\n2020-01-22 hxxp://faithoasis.000webhostapp.com/wpcontent/uploads/2020/01/ahead/550889.zip\n\n2020-01-27 hxxps://madisonclubbar[.]com/fast/invoice049740.zip\n\n2020-01-29 hxxp://zhinengbao[.]wang/wp-content/uploads/2020/01/lane/00571.zip\n\n2020-01-29 hxxp://bhatner[.]com/wp-content/uploads/2020/01/ahead/9312.zip\n\n2020-02-03 hxxp://santedeplus[.]info/wpcontent/uploads/2020/02/ending/1582820/1582820.zip\n\n_Table 1. URLs for the initial zip archive to kick off a Qakbot infection chain._\n\nIn our pcap, you can find the HTTP request for a zip archive using http.request.uri contains\n**_.zip in the Wireshark filter as shown in Figure 4._**\n\nFigure 4. Finding the URL for the initial zip archive.\nFollow the TCP stream to confirm this is a zip archive as shown in Figure 5 and Figure 6,\nthen try to export the zip archive from the pcap as shown in Figure 7.\n\n\n-----\n\nFigure 5. Following the TCP stream for the HTTP request from our filter results.\n\n\n-----\n\nFigure 6. Indicators this URL returned a zip archive.\n\nFigure 7. Exporting objects from HTTP traffic in the pcap.\nIn most cases, the menu for File → Export Objects → HTTP should export a zip archive\nsent over HTTP. Unfortunately, as shown in Figure 8, we cannot export this file named\n**_9312.zip because it is separated into hundreds of smaller parts within the export HTTP_**\nobjects list.\n\n\n-----\n\nFigure 8. 9312.zip is broken up into hundreds of objects within the list, so we cannot export it\nthis way.\nFortunately, we can export data from a TCP stream window and edit the binary in a hex\neditor to remove any hxxP response headers. Use the following steps to extract the zip\narchive from this pcap:\n\n1.\n\n1. Follow TCP stream for the HTTP request for 9312.zip.\n2. Show only the response traffic in the TCP stream Window.\n3. Change “Show and save data as” from ASCII to Raw.\n4. Save the data as a binary (I chose to save it as: 9312.zip.bin)\n5. Open the binary in a hex editor and remove the HTTP request headers before the\n\nfirst two bytes of the zip archive (which show as PK in ASCII).\n6. Save the file as a zip archive (I chose to save it as 9312.zip)\n7. Check the file to make sure it’s a zip archive.\n\nSee Figures 9 through 14 for a visual guide of this process.\n\n\n-----\n\nFigure 9. Step 2 - When viewing the TCP stream, switch from viewing the entire conversation\nto viewing only data returned from the server.\n\n\n-----\n\nFigure 10. Step 3 - Show and save data as Raw instead of ASCII.\n\n\n-----\n\nFigure 11. Step 4 - Save this raw data from the TCP stream as a binary.\n\nFigure 12. Step 5 - Open your saved binary in a hex editor and remove any HTTP response\ndata before the first two bytes of the zip archive (that show as PK in ASCII).\n\nFigure 13. Step 6 - Save your edited binary as a zip archive.\n\n\n-----\n\nFigure 14. Step 7 - Confirm the edited file is a zip archive, then extract the VBS file and\ncheck the file hashes.\nFigure 14 shows how to use a terminal window from a Debian-based Linux distro to check\nthe files. From our pcap, the zip archive should be the same as this file submitted to\nVirusTotal. Our extracted VBS file should be the same as this file also submitted to\nVirusTotal.\n\n[A public sandbox analysis of our extracted VBS file indicates it generates the next Qakbot-](https://app.any.run/tasks/e2c36659-1070-4665-991c-245e900245b7)\nrelated URL in our infection chain: a URL that returned a Windows executable for Qakbot.\n\n## Windows Executable for Qakbot\n\nThese extracted VBS files generate URLs that return Windows executables for Qakbot.\nSince December 2019, URLs for Qakbot executables have ended with 44444.png or\n444444.png. See Table 2 for some recent examples of these Qakbot URLs we found using\nour [AutoFocus Threat Intelligence service.](https://www.paloaltonetworks.com/cortex/autofocus)\n\n\n**First**\n**Seen**\n\n2019-1227\n\n2020-0106\n\n2020-0115\n\n2020-0117\n\n\n**URL for Qakbot executable**\n\nhxxp://centre-de-conduite-roannais[.]com/wpcontent/uploads/2019/12/last/444444.png\n\nhxxp://newsinside[.]info/wp-content/uploads/2020/01/forward/44444.png\n\nhxxp://iike.xolva[.]com/wp-content/themes/keenshot/fast/444444.png\n\nhxxp://deccolab[.]com/fast/444444.png\n\n\n-----\n\n2020-0121\n\n2020-0122\n\n2020-0123\n\n2020-0123\n\n2020-0126\n\n2020-0127\n\n2020-0130\n\n2020-0203\n\n\nhxxp://myrestaurant.coupoly[.]com/wpcontent/uploads/2020/01/along/444444.png\n\nhxxp://alphaenergyeng[.]com/wp-content/uploads/2020/01/ahead/444444.png\n\nhxxp://claramohammedschoolstl[.]org/wpcontent/uploads/2020/01/upwards/444444.png\n\nhxxp://creationzerodechet[.]com/choice/444444.png\n\nhxxp://productsphotostudio[.]com/wpcontent/uploads/2020/01/lane/444444.png\n\nhxxp://sophistproduction[.]com/wpcontent/uploads/2020/01/choice/444444.png\n\nhxxp://uofnpress[.]ch/wp-content/uploads/2020/01/side/444444.png\n\nhxxp://csrkanjiza[.]rs/wp-content/uploads/2020/02/ending/444444.png\n\n\n_Table 2. URLs for Qakbot executables._\n\nIn our pcap, find the HTTP GET request for our Qakbot executable using hxxp.request.uri\n**_contains .png in the Wireshark filter as shown in Figure 15._**\n\nFigure 15. Finding the URL for our Qakbot executable.\nExport this object from the pcap using the File → Export Objects → HTTP menu path as\nshown in Figure 16 and check the results as shown in Figure 17.\n\n\n-----\n\nFigure 16. Exporting our Qakbot executable from the pcap.\n\nFigure 17. Checking the exported file in a Debian-based Linux terminal window.\n[From our pcap, the Qakbot executable should be this file submitted to VirusTotal. A](https://www.virustotal.com/gui/file/56ee803fa903ab477f939b3894af6771aebf0138abe38ae8e3c41cf96bbb0f2a) public\nsandbox analysis of this file generated several Qakbot indicators (identified as Qbot).\n\n## Post-infection HTTPS Activity\n\n[Use your basic filter (covered in this previous WIreshark tutorial) for a quick view of web](https://unit42.paloaltonetworks.com/using-wireshark-display-filter-expressions/)\ntraffic in our pcap. Scroll down to activity after the HTTP GET request to\nalphaenergyeng[.]com that returned our Qakbot executable. You should see several\nindicators of HTTPS or SSL/TLS traffic to 68.1.115[.]106 with no associated domain as noted\nin Figure 18.\n\n\n-----\n\nFigure 18. HTTPS or SSL/TLS traffic caused by Qakbot.\nThis traffic has unusual certificate issuer data commonly noted during Qakbot infections. We\n[reviewed unusual certificate issuer data in our previous WIreshark tutorial about Ursnif, so](https://unit42.paloaltonetworks.com/using-wireshark-display-filter-expressions/)\nthis should be easy to find.\n\nLet’s review our Qakbot certificate issuer data using the following Wireshark filter:\n\n**_Ip.addr eq 68.1.115.186 and ssl.handshake.type eq 11_**\n\nFor Wireshark 3.0 or newer, use tls.handshake.type instead of ssl.handshake.type. Select\nthe first frame in your results and expand the frame details window until you find the\ncertificate issuer data as shown in Figure 19.\n\n\n-----\n\nFigure 19. Reviewing certificate issuer data from Qakbot traffic.\nPatterns for the locality name, organization name, and common name are highly-unusual,\nnot normally found in certificates from legitimate HTTPS, SSL, or TLS traffic. Our example of\nthis issuer data is listed below:\n\nid-at-countryName=ES\nid-at-stateOrProvinceName=IA\nid-at-localityName=Uorh Ofwa\nid-at-organizationName=Coejdut Mavmtko Qxyemk Dxsjie LLC.\nid-at-commonName=gaevietovp.mobi\n\n### Other Post-infection Traffic\n\nOur pcap contains other activity associated with a Qakbot infection. Each activity is not\ninherently malicious on its own, but taken together with our previous findings, we can\nassume a full Qakbot infection.\n\nAnother indicator of a Qakbot infection is HTTPS traffic to cdn.speedof[.]me. The domain\nspeedof[.]me is used by a legitimate Internet speed test service. Although this is not\nmalicious traffic, we frequently see traffic to cdn.speedof[.]me during Qakbot infections.\nFigure 20 shows this activity from our pcap.\n\n\n-----\n\nFigure 20. The domain cdn.speedof[.]me within the Qakbot traffic.Qakbot also opens\nwindows from all browsers on an infected Windows host. At approximately 13 minutes and 5\n[seconds into this sandbox analysis, the video playback shows Qakbot opening Chrome, then](https://app.any.run/tasks/fb9cffb1-7797-4827-8446-05fee3d6a3de)\nFirefox, then Internet Explorer on a Windows 7 host. This analysis shows Qakbot generated\ntraffic to the following URLs:\n\nhxxp://store.nvprivateoffice[.]com/redir_chrome.html\nhxxp://store.nvprivateoffice[.]com/redir_ff.html\nhxxp://store.nvprivateoffice[.]com/redir_ie.html\n\nThe domain nvprivateoffice[.]com has been registered through GoDaddy since 2012, and\nstore.nvprivateoffice[.]com shows a default web page for nginx on a Fedora server.\n\nOur pcap for this tutorial is from a Qakbot infection on a Windows 10 host without Chrome or\nFirefox installed. Our pcap only shows web traffic for Internet Explorer and the new\nChromium-based Microsoft Edge. Both times, the URL generated by Qakbot was\nhxxp://store.nvprivateoffice[.]com/redir_ie.html.\n\nTo find this traffic, use the following Wireshark filter as shown in Figure 21:\n\n**_http.request.full_uri contains store.nvprivateoffice_**\n\n\n-----\n\nFigure 21. Finding Qakbot traffic that opens web browsers on an infected Windows host.\nFollow the TCP stream for each of the two HTTP GET requests ending in redir_ie.html. The\nfirst request has a User-Agent in the HTTP headers for Internet Explorer as shown in Figure\n22. The second request for the same URL has a User-Agent in the HTTP headers for the\nnew Chromium-based Microsoft Edge as noted in Figure 23.\n\nFigure 22. Qakbot traffic to store.nvprivateoffice[.]com using Internet Explorer 11.\n\n\n-----\n\nFigure 23. Qakbot traffic to store.nvprivateoffice[.]com using the new Chromium-based\nMicrosoft Edge.Finally, our pcap from the Qakbot-infected host also has email-related TCP\ntraffic to various ports for various email protocols like SMTP, IMAP, and POP3. To get an idea\nof this non-web-related traffic, use the following Wireshark filter as shown in Figure 25:\n**_tcp.flags eq 0x0002 and !(tcp.port eq 80) and !(tcp.port eq 443)_**\n\n\n-----\n\nFigure 25. Getting an idea of the non-web-related traffic from this Qakbot infection.\nFigure 25 shows TCP connections and attempted TCP connections to various ports like 25,\n110,143, 465, 587, 993, and 995 commonly used by different email protocols. The first two\nlines in the results show traffic to TCP port 65400, but reviewing the associated TCP streams\nindicates this also email-related traffic.\n\nUse the following Wireshark filter to get a better idea of email-related traffic from the infected\nhost as shown in Figure 26:\n\n**_smtp or imap or pop_**\n\n\n-----\n\nFigure 26. Finding email-related traffic caused by Qakbot in this pcap.\nFollow some of the TCP streams to get a better idea for this type of email traffic. We do not\nnormally see such unencrypted email traffic originating from a Windows client to public IP\naddresses. Along with other indicators, this smtp or imap or pop filter may reveal Qakbot\nactivity.\n\n## Conclusion\n\nThis tutorial provided tips for examining Windows infections with Qakbot malware. More\n[pcaps with examples of Qakbot activity can be found at malware-traffic-analysis.net.](https://www.malware-traffic-analysis.net/)\n\nFor more help with Wireshark, see our previous tutorials:\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-13 - Wireshark Tutorial- Examining Qakbot Infections.pdf"
    ],
    "report_names": [
        "2020-02-13 - Wireshark Tutorial- Examining Qakbot Infections.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536220,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1666529762,
    "ts_modification_date": 1666529762,
    "files": {
        "pdf": "https://archive.orkl.eu/c3eb7bdaa78c612143eb3bca7fce5510bb4e5eb9.pdf",
        "text": "https://archive.orkl.eu/c3eb7bdaa78c612143eb3bca7fce5510bb4e5eb9.txt",
        "img": "https://archive.orkl.eu/c3eb7bdaa78c612143eb3bca7fce5510bb4e5eb9.jpg"
    }
}