{
    "id": "0550d4ed-e969-40d3-860f-31195f0692a1",
    "created_at": "2023-01-12T15:01:06.86523Z",
    "updated_at": "2025-03-27T02:14:02.536425Z",
    "deleted_at": null,
    "sha1_hash": "a63d46c43c717a29fe18a6766a155fb475be068e",
    "title": "2017-04-28 - Use of DNS Tunneling for C&C Communications",
    "authors": "",
    "file_creation_date": "2022-05-28T19:31:35Z",
    "file_modification_date": "2022-05-28T19:31:35Z",
    "file_size": 871374,
    "plain_text": "# Use of DNS Tunneling for C&C Communications\n\n**[securelist.com/use-of-dns-tunneling-for-cc-communications/78203/](https://securelist.com/use-of-dns-tunneling-for-cc-communications/78203/)**\n\nAuthors\n\n[Alexey Shulmin](https://securelist.com/author/alexeyshulmin/)\n\n[Sergey Yunakovsky](https://securelist.com/author/sergeyyunakovsky/)\n\n– Say my name.\n\n– 127.0.0.1!\n\n– You are goddamn right.\n\nNetwork communication is a key function for any malicious program. Yes, there are\nexceptions, such as cryptors and ransomware Trojans that can do their job just fine without\nusing the Internet. However, they also require their victims to establish contact with the threat\nactor so they can send the ransom and recover their encrypted data. If we omit these two\nand have a look at the types of malware that have no communication with a C&C and/or\nthreat actor, all that remains are a few outdated or extinct families of malware (such as\nTrojan-ArcBomb), or irrelevant, crudely made prankware that usually does nothing more than\nscare the user with screamers or switches mouse buttons.\n\n\n-----\n\n[Malware has come a long way since the Morris worm, and the authors never stop looking for](https://en.wikipedia.org/wiki/Morris_worm)\nnew ways to maintain communication with their creations. Some create complex, multi-tier\nauthentication and management protocols that can take weeks or even months for analysists\nto decipher. Others go back to the basics and use IRC servers as a management host – as\n[we saw in the recent case of Mirai and its numerous clones.](https://securelist.com/is-mirai-really-as-black-as-its-being-painted/76954/)\n\nOften, virus writers don’t even bother to run encryption or mask their communications:\ninstructions and related information is sent in plain text, which comes in handy for a\nresearcher analyzing the bot. This approach is typical of incompetent cybercriminals or even\nexperienced programmers who don’t have much experience developing malware.\n\nHowever, you do get the occasional off-the-wall approaches that don’t fall into either of the\nabove categories. Take, for instance, the case of a Trojan that Kaspersky Lab researchers\ndiscovered in mid-March and which establishes a DNS tunnel for communication with the\nC&C server.\n\nThe malicious program in question is detected by Kaspersky Lab products as\nBackdoor.Win32.Denis. This Trojan enables an intruder to manipulate the file system, run\narbitrary commands and run loadable modules.\n\n## Encryption\n\nJust like lots of other Trojans before it, Backdoor.Win32.Denis extracts the addresses of the\nfunctions it needs to operate from loaded DLLs. However, instead of calculating the\nchecksums of the names in the export table (which is what normally happens), this Trojan\nsimply compares the names of the API calls against a list. The list of API names is encrypted\nby subtracting 128 from each symbol of the function name.\n\nIt should be noted that the bot uses two versions of encryption: for API call names and the\nstrings required for it to operate, it does the subtraction from every byte; for DLLs, it subtracts\nfrom every other byte. To load DLLs using their names, LoadLibraryW is used, meaning wide\nstrings are required.\n\n_‘Decrypting’ strings in the Trojan_\n\n\n-----\n\n_Names of API functions and libraries in encrypted format_\n\nIt should also be noted that only some of the functions are decrypted like this. In the body of\nthe Trojan, references to extracted functions alternate with references to functions received\nfrom the loader.\n\n## C&C Communication\n\nThe principle behind a DNS tunnel’s operation can be summed up as: “If you don’t know, ask\nsomebody else”. When a DNS server receives a DNS request with an address to be\nresolved, the server starts looking for it in its database. If the record isn’t found, the server\nsends a request to the domain stated in the database.\n\nLet’s see how this works when a request arrives with the URL Y3VyaW9zaXR5.example.com\nto be resolved. The DNS server receives this request and first attempts to find the domain\nextension ‘.com’, then ‘example.com’, but then it fails to find ‘Y3VyaW9zaXR5.example.com’\nin its database. It then forwards the request to example.com and asks it if such a name is\nknown to it. In response, example.com is expected to return the appropriate IP; however, it\ncan return an arbitrary string, including C&C instructions.\n\n\n-----\n\n_Dump of Backdoor.Win32.Denis traffic_\n\nThis is what Backdoor.Win32.Denis does. The DNS request is sent first to 8.8.8.8, then\nforwarded to z.teriava[.]com. Everything that comes before this address is the text of the\nrequest sent to the C&C.\n\nHere is the response:\n\n_DNS packet received in response to the first request_\n\nObviously, the request sent to the C&C is encoded with Base64. The original request is a\nsequence of zeros and the result of GetTickCount at the end. The bot subsequently receives\nits unique ID and uses it for identification at the start of the packet.\n\nThe instruction number is sent in the fifth DWORD, if we count from the start of the section\nhighlighted green in the diagram above. Next comes the size of the data received from C&C.\nThe data, packed using zlib, begins immediately after that.\n\n_The unpacked C&C response_\n\nThe first four bytes are the data size. All that comes next is the data, which may vary\ndepending on the type of instruction. In this case, it’s the unique ID of the bot, as mentioned\nearlier. We should point out that the data in the packet is in big-endian format.\n\n\n-----\n\n_The bot ID (highlighted) is stated at the beginning of each request sent to the C&C_\n\n## C&C Instructions\n\nAltogether, there are 16 instructions the Trojan can handle, although the number of the last\ninstruction is 20. Most of the instructions concern interaction with the file system of the\nattacked computer. Also, there are capabilities to gain info about open windows, call an\narbitrary API or obtain brief info about the system. Let us look into the last of these in more\ndetail, as this instruction is executed first.\n\n_Complete list of C&C instructions_\n\n\n-----\n\n_Information about the infected computer, sent to the C&C_\n\nAs can be seen in the screenshot above, the bot sends the computer name and the user\nname to the C&C, as well as the info stored in the registry branch\nSoftware\\INSUFFICIENT\\INSUFFICIENT.INI:\n\nTime when that specific instruction was last executed. (If executed for the first time,\n‘GetSystemTimeAsFileTime’ is returned, and the variable BounceTime is set, in which\nthe result is written);\nUsageCount from the same registry branch.\n\nInformation about the operating system and the environment is also sent. This info is\nobtained with the help of NetWkstaGetInfo.\n\nThe data is packed using zlib.\n\n_The DNS response prior to Base64 encoding_\n\nThe fields in the response are as follows (only the section highlighted in red with data and\nsize varies depending on the instruction):\n\nBot ID;\nSize of the previous C&C response;\nThe third DWORD in the C&C response;\nAlways equals 1 for a response;\nGetTickCount();\nSize of data after the specified field;\nSize of response;\n\n\n-----\n\nActual response.\n\nAfter the registration stage is complete, the Trojan begins to query the C&C in an infinite\nloop. When no instructions are sent, the communication looks like a series of empty queries\nand responses.\n\n_Sequence of empty queries sent to the C&C_\n\n## Conclusion\n\nThe use of a DNS tunneling for communication, as used by Backdoor.Win32.Denis, is a very\nrare occurrence, albeit not unique. A similar technique was previously used in some POS\n[Trojans and in some APTs (e.g. Backdoor.Win32.Gulpix in the PlugX family). However, this](https://securelist.com/blog/research/66960/winnti-returns-with-plugx/)\nuse of the DNS protocol is new on PCs. We presume this method is likely to become\nincreasingly popular with malware writers. We’ll keep an eye on how this method is\nimplemented in malicious programs in future.\n\n### MD5\n\nfacec411b6d6aa23ff80d1366633ea7a\n\n018433e8e815d9d2065e57b759202edc\n\n1a4d58e281103fea2a4ccbfab93f74d2\n\n5394b09cf2a0b3d1caaecc46c0e502e3\n\n5421781c2c05e64ef20be54e2ee32e37\n\n[Backdoor](https://securelist.com/tag/backdoor/)\n[DNS](https://securelist.com/tag/dns/)\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Trojan](https://securelist.com/tag/trojan/)\n\nAuthors\n\n[Alexey Shulmin](https://securelist.com/author/alexeyshulmin/)\n\n\n-----\n\n[Sergey Yunakovsky](https://securelist.com/author/sergeyyunakovsky/)\n\nUse of DNS Tunneling for C&C Communications\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-04-28 - Use of DNS Tunneling for C&C Communications.pdf"
    ],
    "report_names": [
        "2017-04-28 - Use of DNS Tunneling for C&C Communications.pdf"
    ],
    "threat_actors": [
        {
            "id": "4d9cdc7f-72d6-4e17-89d8-f6323bfcaebb",
            "created_at": "2023-01-06T13:46:38.82716Z",
            "updated_at": "2025-03-27T02:00:02.928984Z",
            "deleted_at": null,
            "main_name": "GreyEnergy",
            "aliases": [],
            "source_name": "MISPGALAXY:GreyEnergy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535666,
    "ts_updated_at": 1743041642,
    "ts_creation_date": 1653766295,
    "ts_modification_date": 1653766295,
    "files": {
        "pdf": "https://archive.orkl.eu/a63d46c43c717a29fe18a6766a155fb475be068e.pdf",
        "text": "https://archive.orkl.eu/a63d46c43c717a29fe18a6766a155fb475be068e.txt",
        "img": "https://archive.orkl.eu/a63d46c43c717a29fe18a6766a155fb475be068e.jpg"
    }
}