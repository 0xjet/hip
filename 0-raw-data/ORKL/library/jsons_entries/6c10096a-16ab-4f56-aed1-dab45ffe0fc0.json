{
    "id": "6c10096a-16ab-4f56-aed1-dab45ffe0fc0",
    "created_at": "2023-01-12T15:07:32.751813Z",
    "updated_at": "2025-03-27T02:16:20.836941Z",
    "deleted_at": null,
    "sha1_hash": "9e7437521629a60326ac81fa9d13670dc7e3e60c",
    "title": "2021-05-06 - Operation TunnelSnake",
    "authors": "",
    "file_creation_date": "2022-05-28T05:12:38Z",
    "file_modification_date": "2022-05-28T05:12:38Z",
    "file_size": 931750,
    "plain_text": "# Operation TunnelSnake\n\n**[securelist.com/operation-tunnelsnake-and-moriya-rootkit/101831/](https://securelist.com/operation-tunnelsnake-and-moriya-rootkit/101831/)**\n\nAuthors\n\n[Mark Lechtik](https://securelist.com/author/marklechtik/)\n\n[Giampaolo Dedola](https://securelist.com/author/giampaolodedola/)\n\n## Formerly unknown rootkit used to secretly control networks of regional organizations\n\nWindows rootkits, especially those operating in kernel space, are pieces of malware\ninfamous for their near absolute power in the operating system. Usually deployed as drivers,\nsuch implants have high privileges in the system, allowing them to intercept and potentially\ntamper with core I/O operations conducted by the underlying OS, like reading or writing to\nfiles or processing incoming and outgoing network packets. The capability to blend into the\nfabric of the operating system itself, much like security products do, is the quality that earns\nrootkits their notoriety for stealth and evasion.\n\nHaving said that, the successful deployment and execution of a rootkit component in\nWindows has become a difficult task over the years. With Microsoft’s introduction of Driver\nSignature Enforcement, it has become harder (though not impossible) to load and run new\ncode in kernel space. Even then, other mechanisms such as Kernel Patch Protection (also\nknown as PatchGuard) make it hard to tamper with the system, with every change in a core\nsystem structure potentially invoking the infamous Blue Screen of Death.\n\n\n-----\n\nConsequently, the number of Windows rootkits in the wild has decreased dramatically, with\nthe bulk of those still active often being leveraged in high profile APT attacks. One such\nexample came to our attention during an investigation last year, in which we uncovered a\nformerly unknown Windows rootkit and its underlying cluster of activity. We observed this\nrootkit and other tools by the threat actor behind it being used as part of a campaign we\ndubbed ‘TunnelSnake’, conducted against several prominent organizations in Asia and\nAfrica.\n\nIn this blog post we will focus on the following key findings that came up in our investigation:\n\nA newly discovered rootkit that we dub ‘Moriya’ is used by an unknown actor to deploy\npassive backdoors on public facing servers, facilitating the creation of a covert C&C\ncommunication channel through which they can be silently controlled;\nThe rootkit was found on networks of regional diplomatic organizations in Asia and\nAfrica, detected on several instances dating back to October 2019 and May 2020,\nwhere the infection persisted in the targeted networks for several months after each\ndeployment of the malware;\nWe observed an additional victim in South Asia, where the threat actor deployed a\nbroad toolset for lateral movement along with the rootkit, including a tool that was\nformerly used by APT1. Based on the detection timestamps of that toolset, we assess\nthat the attacker had a foothold in the network from as early as 2018;\nA couple of other tools that have significant code overlaps with Moriya were found as\nwell. These contain a user mode version of the malware and another driver-based\nutility used to defeat AV software.\n\nWe provided information about this operation in our threat intelligence portal in August 2020.\nMore details and analysis are available to customers of our private APT reporting service.\n[For more details contact: intelreports@kaspersky.com.](http://10.10.0.46/mailto:intelreports@kaspersky.com)\n\n## What is the Moriya rootkit and how does it work?\n\nOur investigation into the TunnelSnake campaign started from a set of alerts from our\nproduct on a detection of a unique rootkit within the targeted networks. Based on string\nartefacts within the malware’s binaries, we named this rootkit Moriya. This tool is a passive\nbackdoor which allows attackers to inspect all incoming traffic to the infected machine, filter\nout packets that are marked as designated for the malware and respond to them. This forms\na covert channel over which attackers are able to issue shell commands and receive back\ntheir outputs.\n\nThe rootkit has two traits that make it particularly evasive. The packet inspection happens in\nkernel mode with the use of a Windows driver, allowing attackers to drop the packets of\ninterest before they are processed by the network stack, thus ensuring they are not detected\nby security solutions. Secondly, the fact that the rootkit waits for incoming traffic rather than\n\n\n-----\n\ninitiating a connection to a server itself, avoids the need to incorporate a C&C address in the\nmalware’s binary or to maintain a steady C&C infrastructure. This hinders analysis and\nmakes it difficult to trace the attacker’s footprints.\n\nThe figure below illustrates the structure of the rootkit’s components. They consist of a kernel\nmode driver and a user mode agent that deploys and controls it. In the following sections we\nwill break down each of these components and describe how they operate to achieve the\ngoal of tapping into the target’s network communication and blending in its traffic.\n\n**Fig. 1. The architecture of the Moriya rootkit**\n\n### User mode agent analysis\n\nThe user mode component of the Moriya rootkit has two purposes. One is to deploy the\nkernel mode component of the malware on the machine and the other is to leverage the\ncovert communication channel created by it to read shell commands sent from the C&C\nserver to the compromised machine and to respond to them. Since Moriya is a passive\nbackdoor intended to be deployed on a server accessible from the internet, it contains no\nhardcoded C&C address and relies solely on the driver to provide it with packets filtered from\nthe machine’s overall incoming traffic.\n\nThe first order of business for the attacker when using Moriya is to gain persistence on the\ntargeted computer. For this purpose, the user mode agent’s DLL contains an export function\nnamed Install, which is intended to create a service named ZzNetSvc with the description\n‘Network Services Manager’ and start it. In turn, the path to the user mode agent’s image is\n\n\n-----\n\nset to the registry key\nHKLM\\System\\CurrentControlSet\\Services\\ZzNetSvc\\Parameters\\ServiceDll so that it will be\ninvoked from its ServiceMain export each time the service is initiated.\n\nNext, after the service is started, the agent will attempt to load the rootkit’s driver into the\nsystem. Its binary is bundled as two driver images within the DLL’s resource section,\ncorresponding to 32- and 64-bit architectures, while in reality only one of them is written to\ndisk. In the cases we analyzed, the agent DLLs were compiled for 64-bit systems, dropping a\n64-bit driver to the drivers directory in the system path, under the name\nMoriyaStreamWatchmen.sys, hence the rootkit’s name.\n\n**Fig. 2. Code that writes the Moriya driver to disk**\n\nThe agent uses a known technique whereby the VirtualBox driver (VBoxDrv.sys) is leveraged\nto bypass the Driver Signature Enforcement mechanism in Windows and load Moriya’s\nunsigned driver. DSE is an integrity mechanism mandating that drivers are properly signed\nwith digital signatures in order for them to be loaded, which was introduced for all versions of\nWindows starting from Vista 64-bit. The technique used to bypass it was seen in use by other\nthreat actors like Turla, Lamberts and Equation.\n\nMoriya’s user mode agent bypasses this protection with the use of an open-source code[1]\nnamed DSEFIX v1.0. The user agent dumps an embedded VBoxDrv.sys image of version\n1.6.2 to disk and loads it, which is then used by the aforementioned code to map Moriya’s\nunsigned driver to kernel memory space and execute it from its entry point. These actions\nare made possible through IOCTLs implemented in VBoxDrv.sys that allow writing to kernel\naddress space and executing code from it. Throughout this process, the bypass code is used\nto locate and modify a flag in kernel space named g_CiOptions, which controls the mode of\nenforcement.\n\nAfter the unsigned driver is loaded, the agent registers a special keyword that is used as a\nmagic value, which will be sought in the first bytes of every incoming packet passed on the\ncovert channel. This allows the rootkit to filter marked packets and block them for any\napplication on the system other than the user mode agent. The registration of the value is\ndone through a special IOCTL with the code 0x222004 sent to the driver, where a typical\nmagic string is pass12.\n\n\n-----\n\n**Fig. 3. Registration of the packet magic value using a designated IOCTL**\n\nExcept for its covert channel communication feature, Moriya is capable of establishing a\nreverse shell session using an overt channel. For this purpose, it waits for a special packet\nthat consists of a message with the structure connect <c2_address> <c2_port>. The address\nand port are parsed and used by the agent to start a new connection to the given server,\nwhile creating a new cmd.exe process and redirecting its I/O to the connection’s socket. The\nhandles for the newly created process and its main thread are destroyed to avoid detection.\n\nIn any other case, the agent attempts to read the incoming TCP payload from the driver,\nwhich will be retrieved as soon as a designated packet with a magic number and shell\ncommand is received. An attempt is made to read the data with a plain ReadFile API function\nas a blocking operation, i.e., reading is accomplished only once the buffer in kernel mode is\npopulated with data from a Moriya-related packet.\n\nUpon an incoming packet event, the agent creates a new cmd.exe process and redirects its\nI/O using named pipes. One pipe is used to read the retrieved shell command from the\ncovert channel and the other is used to write the shell’s output (obtained from the stdout and\nstderr streams) back to it after execution. To write any data back, the agent uses the\nWriteFile API function with the driver’s handle.\n\nAll traffic passed on the channel is encoded with a simple encryption scheme. Every sent\nbyte has its payload, following the magic string, XORed with the value 0x05 and then\nnegated. Following the same logic, to decode the incoming traffic’s payload, every byte of it\nshould be first negated and then XORed with 0x05.\n\n\n-----\n\n**Fig. 4. Code used for packet encoding**\n\n### Kernel mode driver analysis\n\nThe Moriya rootkit’s driver component makes use of the Windows Filtering Platform (WFP) to\nfacilitate the covert channel between the compromised host and the C&C server. WFP\nprovides a kernel space API that allows driver code to intercept packets in transit and\nintervene in their processing by the Windows TCP/IP network stack. This makes it possible\nto write a driver that can filter out distinct packet streams, based on developer-chosen\ncriteria, and designate them for consumption by a specific user mode application, as is the\ncase in Moriya.\n\nThe driver fetches the distinct Moriya-related traffic using a filtering engine. This is the kernel\nmode mechanism used to inspect traffic according to rules that can be applied on various\nfields across several layers of a packet (namely data link, IP and transport), making it\npossible to handle matching packets with unique handlers. Such handlers are referred to as\ncallout functions.\n\nIn the case of Moriya, the filtering engine is configured to intercept TCP packets, sent over\nIPv4 from a remote address. Each packet with these criteria will be inspected by a callout\nfunction that checks if its first six bytes correspond to the previously registered magic value,\nand if so, copies the packet contents into a special buffer that can be later read by the user\nmode agent. The matching packet will then be blocked in order to hide its presence from the\nsystem, while any other packet is permitted to be processed as intended by the network\nstack.\n\n\n-----\n\nTo allow the crafting of a response back to the server, the callout function saves a special\nvalue in a global variable that identifies the received TCP stream. This value is called a\nflowHandle, and is taken from the packet’s corresponding\nFWPS_INCOMING_METADATA_VALUES0 struct. When the user issues a response to the\nserver via the driver, the latter would craft a new packet using the\nFwpsAllocateNetBufferAndNetBufferList0 function and insert the response data and target\nserver based on the saved flowHandle to it, using the function FwpsStreamInjectAsync0.\n\n**Fig. 5. Code that creates a new packet, designates it for the flow of the corresponding**\n**incoming TCP packet and injects data written from user space into it**\n\nAs formerly mentioned, the driver registers several functions that are exposed to the user\nmode agent in order to interact with it:\n\n**IRP_MJ_READ: used to allow the user mode agent to read the body of a Moriya TCP**\npacket from a special buffer to which it is copied upon receipt. The function itself waits\non an event that gets signaled once such a packet is obtained, thus turning the\nReadFile function called by the user mode agent into a blocking operation that will wait\nuntil the packet is picked up by the driver.\n**IRP_MJ_WRITE: injects user-crafted data into a newly created TCP packet that is sent**\nas a response to an incoming Moriya packet from the server.\n**IRP_MJ_DEVICE_CONTROL: used to register the keyword to check the beginning of**\nevery incoming TCP packet in order to identify Moriya-related traffic. The passed magic\nis anticipated to be six characters long.\n\n\n-----\n\n**Fig. 6. Code used for registering the packet magic value from the driver side**\n\n## How were targeted servers initially infected?\n\nInspecting the systems targeted by the rootkit, we tried to understand how they got infected\nin the first place. As previously mentioned, Moriya was seen deployed mostly on publicfacing servers within the victim organizations. In one case, we saw the attacker infect an\norganizational mail server with the China Chopper webshell, using it to map the victim’s\n\nnetwork and then deploy other tools in it. Moriya’s user mode agent was explicitly installed\nusing a command line executed on the targeted server this way. This command and\nexamples of others run on the victim machine via the webshell can be seen below.\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&ipconfig -all\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&reg query\n\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&$public\\acmsetup.exe\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&query user\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&ipconfig/all\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&ping google.com\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&netstat -anp tcp\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&tasklist /v\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&whoami\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&cd $windir\\web\\\n\n\"cmd\" /c cd /d $windir\\Web\\&rundll32 MoriyaServiceX64.dll, Install\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&ipconfig/all\n\n\"cmd\" /c cd /d C:\\inetpub\\wwwroot\\&time /t\n\n...\n\n\nIn general, we assess that the group’s modus-operandi involves infiltrating organizations\n\nthrough vulnerable web servers in their networks. For example, an older variant of Moriya\nnamed IISSpy (described below) targets IIS web servers. Our telemetry shows that it was\nlikely deployed by exploiting CVE-2017-7269 to let the attackers gain an initial foothold on a\nserver prior to running the malware.\n\n## Post exploitation toolset\n\nDuring our investigation we found a target in South Asia that enabled us to get a glimpse into\nsome of the other tools that we assess were in use by the same attacker. The toolset\nincludes programs used to scan hosts in the local network, find new targets, perform lateral\nmovement to spread to them and exfiltrate files. While most of the tools seem custom made\nand tailored for the attackers’ activities, we could also observe some open-source malware\nfrequently leveraged by Chinese-speaking actors. Following is an outline of these tools\nbased on their purpose in the infection chain.\n\n\n-----\n\n**Network Discovery: custom built programs used to scan the internal network and**\ndetect vulnerable services.\n\n**HTTP scanner: command-line tool, found under the name ‘8.tmp’, which**\ndiscovers web servers through banner grabbing. This is done by issuing a\nmalformed HTTP packet to a given address, where no headers are included and\nthe request is succeeded with multiple null bytes.\n\n**Fig. 7. Malformed packet generated by HTTP scanner**\n\nIf the server responds, the output will be displayed in the console, as shown\nbelow.\n\n**Fig. 8. Console output with a server response displayed upon discovery of**\n**a new server in the network**\n\n\n-----\n\n**DCOM Scanner: another command-line utility that attempts to connect to a**\nremote host on TCP port 135 (RPC), and use the DCOM IOxidResolver interface\nto resolve addresses assigned to all network interfaces available on the remote\nsystem.\n\n**Fig. 9. Output of the DCOM scanner utility**\n\n\n-----\n\n**Lateral Movement: tools used to spread to other hosts in the targeted networks.**\n\n\n-----\n\n**BOUNCER: malware that was first described by Mandiant in their 2013[ ]** report\non APT1. This tool is another passive backdoor that waits for incoming\nconnections on a specific port and provides different features, as outlined below,\nthat can be used to control a remote host and facilitate lateral movement from it.\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n\n0x01: Proxy Init Connection\n\n0x02: Proxy Send Packet\n\n0x03: Proxy Close Connection\n\n0x07: Execute Shellcode\n\n0x0A: Kill Bot\n\n0x0C: Reverse Shell CMD\n\n0x0D: Delete File\n\n0x0E: Execute local program\n\n0x0F: Enumerate Servers In Domain and save output in gw.dat\n\n0x10: Enumerate SQL Servers and save output in sql.dat\n\n0x12: Reverse Shell CreateProcess\n\n0x16: Upload File - Write Data\n\n0x17: Download File - Finish\n\n0x1E: Download File - Start\n\n0x1F: Upload File - Start\n\n0x2D: Enumerate Servers\n\n0x2E: Enumerate SQL Server\n\n0x2F: Enumerate Servers Verbose\n\n0x30: Enumerate Users\n\n0x32: Do nothing\n\n\nThe BOUNCER sample that we observed contained a string that indicates which\ncommand-line arguments it anticipates:\n\n1 usage:%s  IP port [proxip] [port] [key]\n\n\n-----\n\nHowever, the backdoor is configured to accept only the port number on which it\nwill listen.\nWe saw two versions of this backdoor, initiated by two different launchers. The\nfirst one is an executable file named nw.tmp that decrypts an embedded payload\nusing the RC4 algorithm and injects it into a newly spawned svchost.exe process.\nThe injected payload is similar to one described by Mandiant in 2013, which is yet\nanother intermediate loader that decrypts and loads an embedded BOUNCER\nDLL. The last stage is started by invoking the DLL’s dump export with the\narguments passed via the command line.\n\nThe other version was stored with the name rasauto.dll in the system directory,\nimpersonating the Windows Remote Access Auto Connection Manager library.\nLike the other version, it decrypts an embedded DLL using RC4, but this time\nuses no intermediate stage, instead directly calling the DLL’s dump export without\narguments. The decrypted library is a slightly modified BOUNCER variant that\nalways listens on the hardcoded port 1437.\n\n**Fig. 10. Code from the second BOUNCER variant that uses the hardcoded**\n**port 1437 to listen for new packets**\n\nBased on compilation timestamps of all BOUNCER-related executables, as\nshown below, we assess that the attacker reused old samples of the malware\nrather than compiled new versions of it:\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n\nnw.tmp – stage 0 - launcher - 08-03-2017 03:56:24\n\nnw.tmp – stage 1 - embedded loader - 26-08-2014 04:49:58\n\nnw.tmp – stage 2 - embedded BOUNCER backdoor - 28-05-2012\n13:44:37\n\nrasauto.dll - stage 0 – loader 26-08-2013 09:37:08\n\nrasauto.dll - stage 1 - embedded BOUNCER backdoor - 26-082013 09:36:27\n\n\n-----\n\n**Custom PSExec: the attacker deployed a tool to execute commands remotely on**\ncompromised machines. Like the original PSExec tool, this one consists of two\ncomponents – a client named tmp and a service named pv.tmp. In order to use\nthe tool, the attacker has to execute it via a command line with the parameters\nspecified below.\n\n1 Usage: psexec <hostname >  psserve_path exefilename\nServerName[option]\\n\n\nThe service component is a tiny program that uses the CreateProcessA API to\nstart a program specified as an argument. The client component uses the Service\nControl Manager (SCM) API to create a service on the target machine. If the\nServerName argument is not specified, the service will be named Server%c%c\nwhere %c is a random lower case character. The exefilename argument is then\npassed to the StartServiceA function in order to initiate the command execution.\n\n**Fig. 11. Code used to create and start the service on targeted host**\n\nIt is worth noting that the program has some limitations. Compared with the\noriginal PSExec, it is not able to copy the service binary (i.e., pv.tmp, which has\nits path specified in the psserve_path argument) to a remote machine, but rather\nassumes it is already present on it. Besides, it cannot handle network credentials,\nlimiting the ability to execute commands as other users, nor does it support pipes,\nwhich means it does not receive the output of the commands it issues.\n\n\n-----\n\n**Exfiltration: multi-platform utilities commonly used to establish connections with**\nremote hosts and conduct file system operations on them, including file upload and\ndownload.\n\n\n-----\n\n**Earthworm and Termite: well-known command-line utilities developed to**\nfacilitate intrusion into intranet networks. These programs are multiplatform and\ncan be deployed on various architectures. Earthworm is used to create tunnels\nbetween compromised hosts and transfer data.\n\n**Fig. 12. Earthworm help message**\n\nTermite provides additional features to download and upload files between the\ncompromised hosts, as well as a way to spawn a remote shell to control the\ntargeted machine.\n\n\n-----\n\n**Fig. 13. Termite help message**\n\n**TRAN: another tool that we detected under the filename tmp that was used to**\ntransfer data between compromised hosts. The binary we saw operated as a\nloader that embodies a tiny web server encrypted with the RC4 algorithm within it.\nThis server is later injected into a newly created legitimate schtask.exe process\nand usually listens on port 49158. It is used for managing files uploaded by the\nattacker into an in-memory virtual file system maintained by the malware.By\ndefault the file system includes a tiny program named client.exe, which can be\ndownloaded by any host using a standard HTTP GET request to the path\n/client.exe. This file is a command-line utility that can be used to control the virtual\nfile system managed by the server, through one of several available commands\noutlined below.\n\n**Fig. 14. Client.exe help message**\n\n## IISSpy: tracing Moriya back to a user-mode rootkit\n\nIISSpy is an older user-mode version of the Moriya rootkit that we were able to pinpoint in\nour telemetry. It is used to target IIS servers for establishing a backdoor in their underlying\nwebsites. It was detected on a machine in 2018, unrelated to any of the attacks in the current\noperation. This suggests the threat actor has been active since at least that year.\n\nThe malware, which comes as a DLL, achieves its goals by enumerating running IIS\nprocesses on the server (i.e., those that are executed from the image w3wp.exe), and\ninjecting the malware’s DLL into them to alter their behavior. The executed code in the IIS\nprocesses will then set inline hooks for several functions, most notably CreateFileW.\n\nThe corresponding CreateFileW hook function checks if the filename argument contains the\ndirectory ‘\\MORIYA\\’ or ‘\\moriya\\’ in its path, and if so, infers that the attacker has sent a\nspecially crafted HTTP request to the web server. In this request, the Moriya path in the URL\nis followed by an encoded command. After the command is decoded and processed, it is\npassed via a mailslot (\\\\.\\mailslot\\slot) to a separate thread, while signaling an event called\nGlobal\\CommandEvent.\n\n\n-----\n\n**Fig. 15. Code of the CreateFileW hook function that looks for the MORIYA \\ moriya**\n**directory in a request path**\n\nShould the currently handled file contain the Moriya path, the very same hook function will\ngenerate a special file on the web server to which command execution output will be written.\nThis file’s path is created by finding the position of the ‘\\MORIYA\\’ or ‘\\moriya\\’ strings in the\ninspected filename argument, and replacing it with the string ‘\\IISINFO.HTM’. This will then\nbe appended to the command data passed on the mailslot, following a ‘ > ‘ character.\n\nThe other thread waiting on the command event mentioned above is in charge of processing\nattacker data fetched from the mailslot. Any such command will be read and parsed to find\nthe ‘ > ‘ character and the file path that follows it, in this case the one corresponding to\n‘IISINFO.HTML’. After executing the command via cmd.exe, the output will be written to the\nfile in this path, allowing the attacker to read it by issuing a corresponding HTTP request\nwhere the URL path leads to this file on the server.\n\nOther functions that are hooked in the IIS process are CreateProcessAsUserW and\nCreateProcessW. These are used to detect if the current process spawns a new server\ninstance, which will in turn be injected with the malware’s DLL. Apart from this, IISSpy will\nalso create a monitoring thread that will periodically look for newly created httpd.exe\nprocesses, corresponding to the Apache server. If detected, the malware will be injected to\nthem as well.\n\nAlthough it is evident from both the functionality and use of the Moriya keyword by the\nmalware that IISSpy and the Moriya rootkit are related, further evidence in the code\nsubstantiates the connection:\n\nThe older variant is capable of creating a reverse shell transmitted through an overt\nchannel in exactly the same way as the more recent version of the malware, i.e., it\nidentifies a connect request followed by a C&C server address and port, connects to it\nand redirects the IO of a new exe process to the underlying socket.\nBoth variants use the same packet encoding and decoding algorithm, whereby each\nclear-text byte is XORed with 0x5 and negated, and vice-versa.\n\n**Fig. 16. Packet decoding loop that follows the same logic as that used in Moriya**\n\nIn both cases the developers left a trail of unique debug messages, issued to the\nOutputDebugString API function. An example of such a string used in identical code in\nthe two variants is shown below\n\n\n-----\n\n**Fig. 17. Code used in both variants to spawn a new shell, while printing unique debug**\n**messages**\n\nBoth implants are deployed by invoking an export function named Install that creates a\nservice that allows persistent execution, with the malware’s logic residing in the\nServiceMain Moreover, the Install functions are highly similar to one another.\n\n\n-----\n\n**Fig. 18. Comparison of Install export function CFGs between IISSpy and Moriya**\n\n## The ProcessKiller rootkit vs. security products\n\nAnother interesting artefact found in our telemetry that could be tied to the developers of\nMoriya is a malware named ProcessKiller. As its name suggests, it is intended to eliminate\nexecution of processes, with the use of a kernel mode driver. Ultimately, this tool is used to\nshut down and block initiation of AV processes from kernel space, thus allowing other attack\ntools to run without being detected.\n\nThis malware operates through the following stages:\n\nAn attacker calls the malware’s DLL from an export named Kill, passing it a list of\nprocess names it would like to shut down and block as a command-line argument.\n\n\n-----\n\nThe malware writes a driver that is embedded as a resource within it, impersonating a\nKaspersky driver under the path %SYSTEM%\\drivers\\kavp.sys.\nThere is an attempt to load the driver using the Service Control Manager. However,\nsince it is not signed and loading is prone to fail on Windows versions above Vista 64bit, the malware uses the same DSEFix code to bypass Digital Signature Enforcement\nas witnessed in Moriya’s user mode agent.\nThe malware parses the process names passed as arguments and creates a vector of\n‘blacklisted processes’ out of them.\nFor each process in the list, the malware detects its PID and issues it through an\nIOCTL with code 0x22200C to the driver which is in charge of shutting it down from\nkernel space. The shutdown is carried out by locating the process object with the\nfunction PsLookupProcessByProcessId and then terminating it with\nZwTerminateProcess.\nThe list of processes is then passed via another IOCTL with the code 0x222004 to the\ndriver, which inserts each member of it to a linked list in kernel space. When the driver\nis bootstrapped, it registers a callback for newly created processes through the\nPsSetCreateProcessNotifyRoutineEx function, which inspects the image name of the\ncreated process and compares it against those found in the linked list. If a match is\nfound, the process creation status in the PPS_CREATE_NOTIFY_INFO structure will\nbe set to STATUS_UNSUCCESSFUL, signaling the user space API function that\nprocess creation failed.\nAt this point any other malware can theoretically operate without being detected.\nIf the attacker wishes to disable blacklisting, it can be done by issuing an IOCTL with\nthe code 0x222008, which would destroy the linked list of blacklisted processes.\n\nOnce again, the connection to Moriya is based on several observations:\n\nDistinct debug error messages, as the one presented below.\n\n**Fig. 19. Unique debug message that appears in ProcessKiller and Moriya**\n\nFilename of the same structure, i.e., Moriya’s agent is internally named\n‘MoriyaServiceX64.dll’, and ProcessKiller’s DLL is named ‘ProcessKillerX64.dll’\nUsage of the exact same DSEFix code to load an unsigned driver.\n\n## What do we know about the threat actor?\n\n\n-----\n\nUnfortunately, we are not able to attribute the attack to any particular known actor, but based\non the TTPs used throughout the campaign, we suppose it is a Chinese-speaking one. We\nbase this on the fact that the targeted entities were attacked in the past by Chinese-speaking\nactors, and are generally located in countries that are usually targeted by such an actor\nprofile. Moreover, the tools leveraged by the attackers, such as China Chopper, BOUNCER,\nTermite and Earthworm, are an additional indicator supporting our hypothesis as they have\npreviously been used in campaigns attributed to well-known Chinese-speaking groups.\n\n## Who were the targets?\n\nBased on our telemetry the attacks were highly targeted and delivered to less than 10 victims\naround the world. The most prominent victims are two large regional diplomatic organizations\nin South-East Asia and Africa, while all the others were victims in South Asia.\n\n## Conclusion\n\nThe TunnelSnake campaign demonstrates the activity of a sophisticated actor that invests\nsignificant resources in designing an evasive toolset and infiltrating networks of high-profile\norganizations. By leveraging Windows drivers, covert communications channels and\nproprietary malware, the group behind it maintains a considerable level of stealth. That said,\nsome of its TTPs, like the usage of a commodity webshell and open-source legacy code for\nloading unsigned drivers, may get detected and in fact were flagged by our product, giving us\nvisibility into the group’s operation.\n\nStill, with activity dating back to at least 2018, the threat actor behind this campaign has\nshown that it is able to evolve and tailor its toolset to target environments. This indicates the\ngroup conducting these attacks may well still be active and retooling for additional operations\nin the area of interest outlined in this publication, as well as other regions. With that in mind,\nwe continue to track this attacker and look for signs of its reappearance in the wild. Any\nfindings and updates will be made available to customers of our Threat Intelligence Portal.\n\nFor more information about operation TunnelSnake and the underlying threat actor, contact\nus at: [intelreports@kaspersky.com.](http://10.10.0.46/mailto:intelreports@kaspersky.com)\nTo learn more on reverse engineering and malware analysis from Kaspersky GReAT experts,\n[check out the website https://xtraining.kaspersky.com.](https://xtraining.kaspersky.com/)\n\n## IOCs\n\n[48307C22A930A2215F7601C78240A5EE](https://opentip.kaspersky.com/48307C22A930A2215F7601C78240A5EE/?utm_source=SL&utm_medium=SL&utm_campaign=SL) Moriya Agent\n\n[A2C4EE84E3A95C8731CA795F53F900D5](https://opentip.kaspersky.com/A2C4EE84E3A95C8731CA795F53F900D5/?utm_source=SL&utm_medium=SL&utm_campaign=SL) Moriya 64-bit Driver\n\n[5F0F1B0A033587DBCD955EDB1CDC24A4](https://opentip.kaspersky.com/5F0F1B0A033587DBCD955EDB1CDC24A4/?utm_source=SL&utm_medium=SL&utm_campaign=SL) IISSpy\n\n\n-----\n\n[C1159FE3193E8B5206006B4C9AFBFE62](https://opentip.kaspersky.com/C1159FE3193E8B5206006B4C9AFBFE62/?utm_source=SL&utm_medium=SL&utm_campaign=SL) ProcessKiller\n\n[DA627AFEE096CDE0B680D39BD5081C41](https://opentip.kaspersky.com/DA627AFEE096CDE0B680D39BD5081C41/?utm_source=SL&utm_medium=SL&utm_campaign=SL) ProcessKiller Driver – 32-bit\n\n[07CF58ABD6CE92D96CFC5ABC5F6CBC9A](https://opentip.kaspersky.com/07CF58ABD6CE92D96CFC5ABC5F6CBC9A/?utm_source=SL&utm_medium=SL&utm_campaign=SL) ProcessKiller Driver – 64-bit\n\n[9A8F39EBCC580AA56D6DDAF5804EAE61](https://opentip.kaspersky.com/9A8F39EBCC580AA56D6DDAF5804EAE61/?utm_source=SL&utm_medium=SL&utm_campaign=SL) pv.tmp (Custom PSExec Server)\n\n[39C361ABB74F9A338EA42A083E6C7DF8](https://opentip.kaspersky.com/39C361ABB74F9A338EA42A083E6C7DF8/?utm_source=SL&utm_medium=SL&utm_campaign=SL) pc.tmp (Custom PsExec Client)\n\n[DE3FB65461EE8A68A3C7D490CDAC296D](https://opentip.kaspersky.com/DE3FB65461EE8A68A3C7D490CDAC296D/?utm_source=SL&utm_medium=SL&utm_campaign=SL) tran.tmp (Exfiltration tool)\n\n[EAC0E57A22936D4C777AA121F799FEE6](https://opentip.kaspersky.com/EAC0E57A22936D4C777AA121F799FEE6/?utm_source=SL&utm_medium=SL&utm_campaign=SL) client.exe (Utility embedded in tran.tmp)\n\n[D745174F5B0EB41D9F764B22A5ECD357](https://opentip.kaspersky.com/D745174F5B0EB41D9F764B22A5ECD357/?utm_source=SL&utm_medium=SL&utm_campaign=SL) rasauto.dll (Bouncer Loader)\n\n[595E43CDF0EDCAA31525D7AAD87B7BE4](https://opentip.kaspersky.com/595E43CDF0EDCAA31525D7AAD87B7BE4/?utm_source=SL&utm_medium=SL&utm_campaign=SL) 8.tmp (HTTP )Scanner\n\n[9D75B50727A8E732DB0ADE7E270A7395](https://opentip.kaspersky.com/9D75B50727A8E732DB0ADE7E270A7395/?utm_source=SL&utm_medium=SL&utm_campaign=SL) ep.tmp DCOM Scanner\n\n[3A4E1F3F7E1BAAB8B02F3A8EE20F98C9](https://opentip.kaspersky.com/3A4E1F3F7E1BAAB8B02F3A8EE20F98C9/?utm_source=SL&utm_medium=SL&utm_campaign=SL) nw.tmp Bouncer Loader\n\n[47F2D06713DAD556F535E523B777C682](https://opentip.kaspersky.com/47F2D06713DAD556F535E523B777C682/?utm_source=SL&utm_medium=SL&utm_campaign=SL) Termite\n\n[45A5D9053BC90ED657FA90DE0B775E8F](https://opentip.kaspersky.com/45A5D9053BC90ED657FA90DE0B775E8F/?utm_source=SL&utm_medium=SL&utm_campaign=SL) Earthworm\n\n[1] Today a copy of the original code can be found here: http://www.m5home.com/bbs/thread\n8043-1-1.html\n\n\n\n[2] [https://www.fireeye.com/content/dam/fireeye-www/services/pdfs/mandiant-apt1-report.pdf](https://www.fireeye.com/content/dam/fireeye-www/services/pdfs/mandiant-apt1-report.pdf)\n\n[APT](https://securelist.com/tag/apt/)\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Rootkits](https://securelist.com/tag/rootkits/)\n[Targeted attacks](https://securelist.com/tag/targeted-attacks/)\n\nAuthors\n\n[Mark Lechtik](https://securelist.com/author/marklechtik/)\n\n[Giampaolo Dedola](https://securelist.com/author/giampaolodedola/)\n\nOperation TunnelSnake\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-06 - Operation TunnelSnake.pdf"
    ],
    "report_names": [
        "2021-05-06 - Operation TunnelSnake.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "7c390b96-8206-4194-81d8-ebbabb9910ff",
            "created_at": "2023-12-03T02:00:05.147496Z",
            "updated_at": "2025-03-27T02:00:03.259538Z",
            "deleted_at": null,
            "main_name": "TunnelSnake",
            "aliases": [],
            "source_name": "MISPGALAXY:TunnelSnake",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "4b48e4b6-09b0-4f4d-a78c-6b455d122e67",
            "created_at": "2022-10-25T16:07:24.020115Z",
            "updated_at": "2025-03-27T02:02:10.08247Z",
            "deleted_at": null,
            "main_name": "Operation TunnelSnake",
            "aliases": [],
            "source_name": "ETDA:Operation TunnelSnake",
            "tools": [
                "Moriya"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "dabb6779-f72e-40ca-90b7-1810ef08654d",
            "created_at": "2022-10-25T15:50:23.463113Z",
            "updated_at": "2025-03-27T02:00:55.47619Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "APT1",
                "Comment Crew",
                "Comment Group",
                "Comment Panda"
            ],
            "source_name": "MITRE:APT1",
            "tools": [
                "Seasalt",
                "ipconfig",
                "Cachedump",
                "PsExec",
                "GLOOXMAIL",
                "Lslsass",
                "PoisonIvy",
                "WEBC2",
                "Mimikatz",
                "gsecdump",
                "Pass-The-Hash Toolkit",
                "Tasklist",
                "xCmd",
                "pwdump"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "cf7fc640-acfe-41c4-9f3d-5515d53a3ffb",
            "created_at": "2023-01-06T13:46:38.228042Z",
            "updated_at": "2025-03-27T02:00:02.775905Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "GIF89a",
                "G0006",
                "PLA Unit 61398",
                "Group 3",
                "TG-8223",
                "Comment Group",
                "ShadyRAT",
                "COMMENT PANDA",
                "Comment Crew",
                "Byzantine Candor",
                "Brown Fox"
            ],
            "source_name": "MISPGALAXY:APT1",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536052,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1653714758,
    "ts_modification_date": 1653714758,
    "files": {
        "pdf": "https://archive.orkl.eu/9e7437521629a60326ac81fa9d13670dc7e3e60c.pdf",
        "text": "https://archive.orkl.eu/9e7437521629a60326ac81fa9d13670dc7e3e60c.txt",
        "img": "https://archive.orkl.eu/9e7437521629a60326ac81fa9d13670dc7e3e60c.jpg"
    }
}