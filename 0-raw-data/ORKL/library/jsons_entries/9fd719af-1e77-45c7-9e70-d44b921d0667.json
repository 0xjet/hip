{
    "id": "9fd719af-1e77-45c7-9e70-d44b921d0667",
    "created_at": "2023-01-12T15:04:16.251676Z",
    "updated_at": "2025-03-27T02:16:58.144211Z",
    "deleted_at": null,
    "sha1_hash": "0f7301a21c25468fd41c4eff0880dbf825b2664f",
    "title": "2017-05-03 - To SDB, Or Not To SDB- FIN7 Leveraging Shim Databases for Persistence",
    "authors": "",
    "file_creation_date": "2022-05-28T15:51:07Z",
    "file_modification_date": "2022-05-28T15:51:07Z",
    "file_size": 82447,
    "plain_text": "# To SDB, Or Not To SDB: FIN7 Leveraging Shim Databases for Persistence\n\n**[fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html](https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html)**\n\n## Breadcrumb\n\nThreat Research\n\nMatthew McWhirt, Jon Erickson, DJ Palombo\n\nMay 03, 2017\n\n4 mins read\n\nIn 2017, Mandiant responded to multiple incidents we attribute to FIN7, a financially\nmotivated threat group associated with malicious operations dating back to 2015.\nThroughout the various environments, FIN7 leveraged the CARBANAK backdoor, which this\ngroup has used in previous operations.\n\n\n-----\n\nA unique aspect of the incidents was how the group installed the CARBANAK backdoor for\npersistent access. Mandiant identified that the group leveraged an application shim database\nto achieve persistence on systems in multiple environments. The shim injected a malicious\nin-memory patch into the Services Control Manager (“services.exe”) process, and then\nspawned a CARBANAK backdoor process.\n\nMandiant identified that FIN7 also used this technique to install a payment card harvesting\nutility for persistent access. This was a departure from FIN7’s previous approach of installing\na malicious Windows service for process injection and persistent access.\n\n**Application Compatibility Shims Background**\n\nAccording to Microsoft, an [application compatibility shim is a small library that transparently](https://technet.microsoft.com/en-us/library/dd837644(v=ws.10).aspx)\n[intercepts an API (via hooking), changes the parameters passed, handles the operation](https://blogs.technet.microsoft.com/askperf/2011/06/17/demystifying-shims-or-using-the-app-compat-toolkit-to-make-your-old-stuff-work-with-your-new-stuff/)\nitself, or redirects the operation elsewhere, such as additional code stored on a\nsystem. Today, shims are mainly used for compatibility purposes for legacy applications.\nWhile shims serve a legitimate purpose, they can also be used in a malicious manner.\n[Mandiant consultants previously discussed shim databases at both BruCon and](http://files.brucon.org/2015/Tomczak_and_Ballenthin_Shims_for_the_Win.pdf) [BlackHat.](https://www.blackhat.com/docs/asia-14/materials/Erickson/Asia-14-Erickson-Persist-It-Using-And-Abusing-Microsofts-Fix-It-Patches.pdf)\n\n**Shim Database Registration**\n\nThere are multiple ways to register a shim database on a system. One technique is to use\n[the built-in “sdbinst.exe” command line tool. Figure 1 displays the two registry keys created](https://technet.microsoft.com/en-us/library/cc749169(v=ws.10).aspx)\nwhen a shim is registered with the “sdbinst.exe” utility.\n\n\n-----\n\nShim database registry keys\n\n\nFigure 1: Shim database registry keys\nOnce a shim database has been registered on a system, the shim database file (“.sdb” file\nextension) will be copied to the “C:\\Windows\\AppPatch\\Custom” directory for 32-bit shims or\n“C:\\Windows\\AppPatch\\Custom\\Custom64” directory for 64-bit shims.\n\n**Malicious Shim Database Installation**\n\nTo install and register the malicious shim database on a system, FIN7 used a custom\nBase64 encoded PowerShell script, which ran the “sdbinst.exe” utility to register a custom\nshim database file containing a patch onto a system. Figure 2 provides a decoded excerpt\nfrom a recovered FIN7 PowerShell script showing the parameters for this command.\n\n\n-----\n\nExcerpt from a FIN7 PowerShell script to install a custom shim\n\n\nFigure 2: Excerpt from a FIN7 PowerShell script to install a custom shim\nFIN7 used various naming conventions for the shim database files that were installed and\nregistered on systems with the “sdbinst.exe” utility. A common observance was the creation\nof a shim database file with a “.tmp” file extension (Figure 3).\n\n\n-----\n\nMalicious shim database example\n\n\nFigure 3: Malicious shim database example\nUpon registering the custom shim database on a system, a file named with a random GUID\nand an “.sdb” extension was written to the 64-bit shim database default directory, as shown\nin Figure 4. The registered shim database file had the same MD5 hash as the file that was\ninitially created in the “C:\\Windows\\Temp” directory.\n\n\n-----\n\nShim database after registration\n\n\nFigure 4: Shim database after registration\nIn addition, specific registry keys were created that correlated to the shim database\nregistration. Figure 5 shows the keys and values related to this shim installation.\n\n\n-----\n\nShim database registry keys\n\n\nFigure 5: Shim database registry keys\nThe database description used for the shim database registration, “Microsoft KB2832077”\nwas interesting because this KB number was not a published Microsoft Knowledge Base\npatch. This description (shown in Figure 6) appeared in the listing of installed programs\nwithin the Windows Control Panel on the compromised system.\n\n\n-----\n\nShim database as an installed application\n\n\nFigure 6: Shim database as an installed application\n\n**Malicious Shim Database Details**\n\nDuring the investigations, Mandiant observed that FIN7 used a custom shim database to\npatch both the 32-bit and 64-bit versions of “services.exe” with their CARBANAK payload.\nThis occurred when the “services.exe” process executed at startup. The shim database file\ncontained shellcode for a first stage loader that obtained an additional shellcode payload\nstored in a registry key. The second stage shellcode launched the CARBANAK DLL (stored\nin a registry key), which spawned an instance of Service Host (“svchost.exe”) and injected\nitself into that process.\n\n[Figure 7 shows a parsed shim database file that was leveraged by FIN7.](https://github.com/williballenthin/python-sdb)\n\n\n-----\n\nParsed shim database file\n\n\nFigure 7: Parsed shim database file\nFor the first stage loader, the patch overwrote the “ScRegisterTCPEndpoint” function at\nrelative virtual address (RVA) “0x0001407c” within the services.exe process with the\nmalicious shellcode from the shim database file.\n\nThe new “ScRegisterTCPEndpoint” function (shellcode) contained a reference to the path of\n“\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\DRM”, which is a registry location where\nadditional malicious shellcode and the CARBANAK DLL payload was stored on the system.\n\nFigure 8 provides an excerpt of the parsed patch structure within the recovered shim\ndatabase file.\n\n\n-----\n\nParsed patch structure from the shim database file\n\n\nFigure 8: Parsed patch structure from the shim database file\nThe shellcode stored within the registry path “HKLM\\SOFTWARE\\Microsoft\\DRM” used the\nAPI function “RtlDecompressBuffer” to decompress the payload. It then slept for four minutes\nbefore calling the CARBANAK DLL payload's entry point on the system. Once loaded in\nmemory, it created a new process named “svchost.exe” that contained the CARBANAK DLL.\n\n**Bringing it Together**\n\nFigure 9 provides a high-level overview of a shim database being leveraged as a persistent\nmechanism for utilizing an in-memory patch, injecting shellcode into the 64-bit version of\n“services.exe”.\n\n\n-----\n\nShim database code injection process\n\n\nFigure 9: Shim database code injection process\n\n**Detection**\n\nMandiant recommends the following to detect malicious application shimming in an\nenvironment:\n\n1. Monitor for new shim database files created in the default shim database directories of\n\n“C:\\Windows\\AppPatch\\Custom” and “C:\\Windows\\AppPatch\\Custom\\Custom64”\n2. Monitor for registry key creation and/or modification events for the keys of\n\n“HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom”\nand “HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\AppCompatFlags\\InstalledSDB”\n3. Monitor process execution events and command line arguments for malicious use of\n\nthe “sdbinst.exe” utility\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-05-03 - To SDB, Or Not To SDB- FIN7 Leveraging Shim Databases for Persistence.pdf"
    ],
    "report_names": [
        "2017-05-03 - To SDB, Or Not To SDB- FIN7 Leveraging Shim Databases for Persistence.pdf"
    ],
    "threat_actors": [
        {
            "id": "c9617bb6-45c8-495e-9759-2177e61a8e91",
            "created_at": "2022-10-25T15:50:23.405039Z",
            "updated_at": "2025-03-27T02:00:55.462193Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Carbanak",
                "Anunak"
            ],
            "source_name": "MITRE:Carbanak",
            "tools": [
                "Carbanak",
                "Mimikatz",
                "PsExec",
                "netsh"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "220e1e99-97ab-440a-8027-b672c5c5df44",
            "created_at": "2022-10-25T16:47:55.773407Z",
            "updated_at": "2025-03-27T02:05:17.379427Z",
            "deleted_at": null,
            "main_name": "GOLD KINGSWOOD",
            "aliases": [
                "Cobalt Spider ",
                "Cobalt Gang "
            ],
            "source_name": "Secureworks:GOLD KINGSWOOD",
            "tools": [
                " Buhtrap",
                " Carbanak",
                " Cobalt Strike",
                " CobtInt",
                " Cyst",
                " Metasploit",
                " Meterpreter",
                " Mimikatz",
                " SpicyOmelette",
                "ATMSpitter"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2dfaa730-7079-494c-b2f0-3ff8f3598a51",
            "created_at": "2022-10-25T16:07:23.474746Z",
            "updated_at": "2025-03-27T02:02:09.822683Z",
            "deleted_at": null,
            "main_name": "Cobalt Group",
            "aliases": [
                "ATK 67",
                "Cobalt Gang",
                "Cobalt Spider",
                "Gold Kingswood",
                "Mule Libra",
                "TAG-CR3"
            ],
            "source_name": "ETDA:Cobalt Group",
            "tools": [
                "ATMRipper",
                "ATMSpitter",
                "Agentemis",
                "AmmyyRAT",
                "AtNow",
                "COOLPANTS",
                "CobInt",
                "Cobalt Strike",
                "CobaltStrike",
                "Cyst Downloader",
                "Fareit",
                "FlawedAmmyy",
                "Formbook",
                "Little Pig",
                "Metasploit Stager",
                "Mimikatz",
                "More_eggs",
                "NSIS",
                "Nullsoft Scriptable Install System",
                "Pony Loader",
                "Ripper ATM",
                "SDelete",
                "Siplog",
                "SoftPerfect Network Scanner",
                "SpicyOmelette",
                "Taurus Builder",
                "Taurus Builder Kit",
                "Taurus Loader",
                "Terra Loader",
                "ThreatKit",
                "VenomKit",
                "cobeacon",
                "win.xloader"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bfded1cf-be73-44f9-a391-0751c9996f9a",
            "created_at": "2022-10-25T15:50:23.337107Z",
            "updated_at": "2025-03-27T02:00:55.445946Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "FIN7",
                "GOLD NIAGARA",
                "ITG14",
                "Carbon Spider",
                "ELBRUS",
                "Sangria Tempest"
            ],
            "source_name": "MITRE:FIN7",
            "tools": [
                "Mimikatz",
                "AdFind",
                "JSS Loader",
                "HALFBAKED",
                "REvil",
                "PowerSploit",
                "CrackMapExec",
                "Carbanak",
                "Pillowmint",
                "Cobalt Strike",
                "POWERSOURCE",
                "RDFSNIFFER",
                "SQLRat",
                "Lizar",
                "TEXTMATE",
                "BOOSTWRITE"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "bb8702c5-52ac-4359-8409-998a7cc3eeaf",
            "created_at": "2023-01-06T13:46:38.405479Z",
            "updated_at": "2025-03-27T02:00:02.82533Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "JokerStash",
                "ATK32",
                "G0046",
                "Coreid",
                "Carbanak",
                "Sangria Tempest",
                "CARBON SPIDER",
                "GOLD NIAGARA",
                "G0008",
                "ELBRUS",
                "Carbon Spider"
            ],
            "source_name": "MISPGALAXY:FIN7",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d85adfe3-e1c3-40b0-b8bb-d1bacadc4d82",
            "created_at": "2022-10-25T16:07:23.619566Z",
            "updated_at": "2025-03-27T02:02:09.890982Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "APT-C-11",
                "ATK 32",
                "Gold Niagara",
                "ITG14",
                "TAG-CR1"
            ],
            "source_name": "ETDA:FIN7",
            "tools": [
                "7Logger",
                "Agentemis",
                "Anunak",
                "Astra",
                "BIOLOAD",
                "BIRDWATCH",
                "Bateleur",
                "Boostwrite",
                "CROWVIEW",
                "Carbanak",
                "Cobalt Strike",
                "CobaltStrike",
                "DICELOADER",
                "DNSMessenger",
                "FOWLGAZE",
                "HALFBAKED",
                "JSSLoader",
                "KillACK",
                "LOADOUT",
                "Lizar",
                "Meterpreter",
                "Mimikatz",
                "POWERPLANT",
                "POWERSOURCE",
                "RDFSNIFFER",
                "SQLRAT",
                "Sekur",
                "Sekur RAT",
                "TEXTMATE",
                "Tirion",
                "VB Flash",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c11abba0-f5e8-4017-a4ee-acb1a7c8c242",
            "created_at": "2022-10-25T15:50:23.744036Z",
            "updated_at": "2025-03-27T02:00:55.537114Z",
            "deleted_at": null,
            "main_name": "Cobalt Group",
            "aliases": [
                "Cobalt Group",
                "GOLD KINGSWOOD",
                "Cobalt Gang",
                "Cobalt Spider"
            ],
            "source_name": "MITRE:Cobalt Group",
            "tools": [
                "Mimikatz",
                "More_eggs",
                "SpicyOmelette",
                "SDelete",
                "Cobalt Strike",
                "PsExec"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "ed3810b7-141a-4ed0-8a01-6a972b80458d",
            "created_at": "2022-10-25T16:07:23.443259Z",
            "updated_at": "2025-03-27T02:02:09.801771Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Anunak",
                "Carbanak",
                "Carbon Spider",
                "ELBRUS",
                "Gold Waterfall",
                "Sangria Tempest"
            ],
            "source_name": "ETDA:Carbanak",
            "tools": [
                "AVE_MARIA",
                "Agentemis",
                "AmmyyRAT",
                "Antak",
                "Anunak",
                "Ave Maria",
                "AveMariaRAT",
                "BABYMETAL",
                "BIRDDOG",
                "Backdoor Batel",
                "Batel",
                "Bateleur",
                "BlackMatter",
                "Boostwrite",
                "Cain & Abel",
                "Carbanak",
                "Cl0p",
                "Cobalt Strike",
                "CobaltStrike",
                "DNSMessenger",
                "DNSRat",
                "DNSbot",
                "DRIFTPIN",
                "DarkSide",
                "FOXGRABBER",
                "FlawedAmmyy",
                "HALFBAKED",
                "JS Flash",
                "KLRD",
                "MBR Eraser",
                "Mimikatz",
                "Nadrac",
                "Odinaff",
                "POWERPIPE",
                "POWERSOURCE",
                "PsExec",
                "SQLRAT",
                "Sekur",
                "Sekur RAT",
                "SocksBot",
                "SoftPerfect Network Scanner",
                "Spy.Agent.ORM",
                "TEXTMATE",
                "TeamViewer",
                "TiniMet",
                "TinyMet",
                "Toshliph",
                "VB Flash",
                "WARPRISM",
                "avemaria",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535856,
    "ts_updated_at": 1743041818,
    "ts_creation_date": 1653753067,
    "ts_modification_date": 1653753067,
    "files": {
        "pdf": "https://archive.orkl.eu/0f7301a21c25468fd41c4eff0880dbf825b2664f.pdf",
        "text": "https://archive.orkl.eu/0f7301a21c25468fd41c4eff0880dbf825b2664f.txt",
        "img": "https://archive.orkl.eu/0f7301a21c25468fd41c4eff0880dbf825b2664f.jpg"
    }
}