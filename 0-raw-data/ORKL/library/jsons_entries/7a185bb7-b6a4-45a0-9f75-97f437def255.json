{
    "id": "7a185bb7-b6a4-45a0-9f75-97f437def255",
    "created_at": "2023-01-12T15:01:02.830723Z",
    "updated_at": "2025-03-27T02:11:55.117525Z",
    "deleted_at": null,
    "sha1_hash": "6bdfec7bd5eeda1401efa671040d9365413f8cbb",
    "title": "2016-06-28 - Prince of Persia – Game Over",
    "authors": "",
    "file_creation_date": "2022-05-27T21:11:58Z",
    "file_modification_date": "2022-05-27T21:11:58Z",
    "file_size": 540487,
    "plain_text": "# Prince of Persia – Game Over\n\n**[researchcenter.paloaltonetworks.com/2016/06/unit42-prince-of-persia-game-over/](http://researchcenter.paloaltonetworks.com/2016/06/unit42-prince-of-persia-game-over/)**\n\nTomer Bar, Lior Efraim, Simon Conant June 28, 2016\n\nBy [Tomer Bar,](https://unit42.paloaltonetworks.com/author/tomer-bar/) [Lior Efraim and](https://unit42.paloaltonetworks.com/author/lior-efraim/) [Simon Conant](https://unit42.paloaltonetworks.com/author/simon-conant/)\n\nJune 28, 2016 at 3:00 PM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Threat Prevention,](https://unit42.paloaltonetworks.com/category/threat-prevention-2/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [C2,](https://unit42.paloaltonetworks.com/tag/c2/) [Infy](https://unit42.paloaltonetworks.com/tag/infy/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/unit42-prince-of-persia-game-over/)\n\n## Summary\n\n[Unit 42 published a blog at the beginning of May titled \"Prince of Persia,\" in which we described](https://blog.paloaltonetworks.com/2016/05/prince-of-persia-infy-malware-active-in-decade-of-targeted-attacks/)\nthe discovery of a decade-long campaign using a formerly unknown malware family, Infy, that\ntargeted government and industry interests worldwide.\n\nSubsequent to the publishing of this article, through cooperation with the parties responsible for\nthe C2 domains, Unit 42 researchers successfully gained control of multiple C2 domains. This\ndisabled the attacker’s access to their victims in this campaign, provided further insight into the\ntargets currently victimized in this operation, and enabled the notification of affected parties.\n\n## Post Publication\n\nIn the week following the publication of the original blog, we observed no unusual changes to the\nC2 infrastructure. Existing domains did move to new IP addresses, as we had previously seen\nperiodically. Some new install domains were added, adhering to naming conventions of current\ndomains (see appendix for new IOCs).\n\nThe attackers developed a new version (31), and we observed this deployed against a single\nCanadian target.\n\nThe file descriptions remained essentially the same (“CLMediaLibrary Dynamic Link Library V3”).\nMost importantly, there was no change to the encoding key (now using offset 20, and offset 11\nfor second pass against URL encoding) that we had observed being used for the entire decadelong campaign, and documented in our previous blog. From this we conclude that the attackers\nwere unaware of our initial report.\n\n## Sinkhole\n\n\n-----\n\nThrough cooperation with the parties responsible for the C2 domains, we took control of all but\none of them, transferring the A records to a server we controlled. This prevented the attackers\nfrom being able to subsequently make any further changes to the domain configurations, issue\ncommands to victims, or capture any further data for the majority of victims. An analysis of\nconnections after transfer suggests that the attackers may have used a third-party service to try to\nunderstand why they had suddenly lost almost all of their traffic. Figure 1 shows that tool, a\ngeographic representation of victim-C2 traffic, with all but one at that time now communicating\nwith our sinkhole server.\n\n_Figure 1 Graphical representation of victim traffic to C2_\n\n[We have since transferred sinkhole control to Shadowserver, whom we thank for subsequent](https://www.shadowserver.org/wiki/)\nvictim notification & remediation\n[(https://www.shadowserver.org/wiki/pmwiki.php/Involve/GetReportsOnYourNetwork).](https://www.shadowserver.org/wiki/pmwiki.php/Involve/GetReportsOnYourNetwork)\n\n## Victims\n\nWe were able to analyze victim C2 traffic to understand who were victims of the Infy campaign.\nWe identified 456 malware agents installed on 326 victim systems, in 35 countries. Figure 2\nshows a geographical breakdown of victim locations. We noted in our original blog the large\namount of targeting of Iranian citizens in this campaign, we observed almost one-third of all\nvictims to be Iranian. Also of note was the low overall volume of victims, compared to, for\nexample, crimeware campaigns.\n\n\n-----\n\n_Figure 2 Geographic location of victims. Please note that New Zealand has been omitted from this_\n_map only because we observed no victim activity there._\n\n## Versions\n\nIn our original blog, we noted two distinct primary variants of the Infy malware. In addition to the\noriginal “Infy” variant, we also see the newer, more sophisticated, interactive, and fuller-featured\n“Infy M” variant deployed against apparently-higher-value targets. Overall, 93% of all victims were\ninfected with Infy, and 60% with Infy “M” (Figure 3). Combined with the low total number of\nvictims, this suggests a great deal of care given to each individual campaign target. The large\nnumber of victims with both variants may relate to their complimentary feature set, or represent an\n“upgrade” path on victims from the original variant infection, later adding the “M” variant as targets\nappeared more compelling to the attackers.\n\n\n-----\n\n_Figure 3 Breakdown of Infy vs. Infy \"M\" infections_\n\nFor the Infy “M” variant, we note that the majority of targets are using the latest version (7.8), and\nthat none are using the older 6.x versions at all (Figure 4). This suggests that these higher-value\ntargets are paid much more attention, being kept up-to-date with the latest version.\n\nIn contrast, for the more basic original Infy variant, we note a full spectrum of versions installed\n(Figure 5), with many victims on older versions – including the original, decade-old V1 suggesting much less concern is paid to these individual targets (note that we did observe a small\nnumber of the older 6.x versions but these do not announce their version when connecting).\n\n\n-----\n\n_Figure 4 Infy \"M\" Victim versions_\n\n_Figure 5 Infy\"Original\" Victim versions_\n\n## Game Over\n\n\n-----\n\nShortly after the takedown, as well as a new Infy version (31), we also observed the registration of\nmultiple domains using a previously-seen pattern, against known campaign IP addresses. Almost\nevery domain in the pattern-range box4035[.]net – box4090[.]net (138.201.0.134). These were not\nobserved in any sample C2 lists however. Bestwebstat[.]com was sinkholed by another operator.\n\nSome victims infected with Infy versions 15-24 still used the C2 server us1s2[.]strangled[.]net,\nwhich remained in the hands of the attacker. In early June the attackers used this C2 to issue\ninstructions to download new Infy “M” version 8.0 from us1s2[.]strangled[.]net/bdc.tmp. This was\nthe first time we had observed an Infy variant being directly updated to Infy “M”. This used\ncamouflage name “Macromedia v4”, changed from “v3” seen in Infy v31. They also removed the\nvoice recording capability in this version.\n\nuvps1[.]cotbm[.]com was used for data exfiltration, previously at 138.201.47.150, after publishing\nof our original blog moving to 144.76.250.205. It was also hosting malware updates at\n/themes/u.php.\n\nThey also added a curious C2 entry “hxxp://box” (note: defanged for publishing). It’s unclear how\nthis should function; possibly a compromised victim intranet device, or the attackers have\nmodified the HOSTS file on the victim computer.\n\nAfter the take-down, the attackers began to add server IP addresses as well as domain names to\ntheir malware C2 list. They also slightly modified their ZIP password from “Z8(2000_2001ul” to\n“Z8(2000_2001uIEr3”. Their new malware version added antivirus checks for Kaspersky Labs,\nAvast, and Trend Micro. The malware data capture now searches for file extensions:\n\n_.doc, .docx, .xls, .xlsx, .xlr, .pps, .ppt, .pptx, .mdb, .accdb, .db, .dbf, .sql, .jpg, .jpeg, .psd, .tif, .mp4,_\n_.3gp, .txt, .rtf, .odt, .htm, .html, .pdf, .wps, .contact, .csv, .nbu, .vcf, .pst, .zip, .rar, .7z, .zipx, .pgp,_\n_.tc, .vhd, .p12, .crt.pem,.key.pfx, .asc, .cer, .p7b, .sst, .doc, .docx, .xls, .xlsx, .xlr, .pps, .ppt, .pptx._\n\nand folder locations:\n\n_:\\$recycle.bin, :\\documents and settings, :\\msocache, :\\program files, :\\program files (x86),_\n_:\\programdata, :\\recovery, :\\system volume information:\\users, :\\windows, :\\boot, :\\inetpub, :\\i386._\n\nThe malware continued to use the identical decryption key seen over the entire history of this\ncampaign.\n\nMid-June, through cooperation with the parties responsible for the C2 domains and law\nenforcement, we were able to get the remaining C2 domains null-routed and the directly-IPaddressed server disabled. This is the end of a decade-long campaign, though we naturally\nexpect to see this actor back in some other guise before long.\n\nThanks to the Malware research team - Yaron Samuel, Artiom Radune, Mashav Sapir, Netanel\nRimer – for assistance in the takedown.\n\n## Appendix 1 – Exfiltration Algorithm\n\n\n-----\n\nThe malware uses a different algorithm than that used for encrypting the malware strings to\nencrypt the exfiltration data, including:\n\n1. Keylogger data + language.\n2. Malware logs - installation time, DLL path and name, log path, number of downloads,\n\nnumber of successful/failed connections.\n3. Information about the victim computer: Time zone, list of drives and types, running\n\nprocesses, disk info.\n\nFirst the malware adds 1 to all bytes, then an encryption key is initialized based on the victim\ncomputer name (the offset in the key is calculated by sum of the computer name letters %key\nlength). Then the key is used to encrypt the data (see decrypt function). The encrypted data is\nthen base64 encoded.\n\nExfiltration data decryption python code:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nimport os,sys\nimport string\nimport base64\nimport fileinput\nFIRST_PHASE =\n\"OQTJEqtsK0AUB9YXMwr8idozF7VWRPpnhNCHI6Dlkaubyxf5423jvcZ1LSGmge\"\nSECOND_PHASE =\n\"PqOwI1eUrYtT2yR3p4E5o6WiQu7ASlDkFj8GhHaJ9sKdLfMgNzBx0ZcXvCmVnb\"\nglobal FULL_KEY\nFULL_KEY= \"\"\ndef sub_1_for_hex(str_input):\nstr_output = \"\"\nfor letter in str_input:\ntry:\nstr_output += chr(ord(letter)-1)\nexcept:\nprint \"sub_1_for_hex func problem\"\ncontinue\nreturn str_output\n\ndef sum_comp_name(comp_name):\nsum = 0\nfor letter in comp_name:\nsum+= ord(letter)\nreturn sum\n\ndef init_key(comp):\ncomp_name_sum = sum_comp_name(comp)\ncarry = divmod(comp_name_sum, 62)\nindex = carry[1] -1\nend_key = FIRST_PHASE[:index]\nkey = FIRST_PHASE[index:]\nkey = key + end_key\nkey = key + key\nreturn key\n\n\n-----\n\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n72\n73\n74\n75\n76\n77\n78\n79\n80\n81\n82\n83\n84\n85\n86\n87\n88\n89\n90\n91\n\n\ndef decrypt(num_list,offset):\nglobal FULL_KEY\ninput = \"\"\nfor num_str in num_list:\ntry:\ninput += num_str.decode('hex')\nexcept:\ninput += ')'\nresult = \"\"\nfor i, c in enumerate(input):\ni = i % 62 +1\ntry:\nindex = FULL_KEY.index(c)-1\nexcept ValueError:\nresult += c\ncontinue\ntranslated = SECOND_PHASE[(index - i +offset) % len(SECOND_PHASE)]\nresult += translated\nreturn result\n\ndef found_infy_enc_data(line):\nfound_infy_str = \"show=\\\"---------- Administration Reporting Service \"\nfound_infy_index = line.find(found_infy_str)\nif not found_infy_index==-1:\nreturn True,found_infy_index\nelse:\nreturn False,found_infy_index\ndef extract_comp_name(line):\ncomp = r\"\\xd\\xa-----\"\ncomp_index = line.find(comp)\ncomp_name = line[comp_index+len(comp):]\ncomp_name = comp_name[:comp_name.find(\"-----\")]\nprint \"(((=)))\" + comp_name\nreturn comp_name\n\ndef extract_enc_data(line):\nheader = r\"\\xd\\xa_____\"\nstart_index = line.find(header)+len(header)\nline = line[start_index:]\nendindex = line.index(\"_____\\\" value=\")\nline = line[:endindex]\nreturn line\n\ndef write_enc_infy_data_to_file(dec_line,comp_name,filename):\nfile1 = open(filename + \"\\\\\" + comp_name + \".txt\",'ab')\nfile1.writelines(dec_line)\nfile1.close()\n\ndef enc_wrapper(enc,comp_name):\nglobal FULL_KEY\nprint FULL_KEY\nFULL_KEY = init_key(comp_name)\n\nenc_final = \"\"\n\nfor letter in enc:\n\n\n-----\n\n92\n93\n94\n95\n96\n97\n98\n99\n100\n101\n102\n103\n104\n105\n106\n107\n108\n109\n110\n111\n112\n113\n114\n115\n116\n117\n118\n119\n120\n121\n122\n123\n124\n125\n126\n127\n128\n129\n130\n131\n132\n133\n134\n135\n136\n137\n138\n139\n140\n141\n142\n143\n144\n145\n146\n\n\nif len(hex(ord(letter))[2:]) 1:\nenc_final += \"0\" + hex(ord(letter))[2:]\nelif len(hex(ord(letter))[2:])==2:\nenc_final += hex(ord(letter))[2:]\nelse:\nprint \"not good hex length\"\nexit()\n\nenc = enc_final.upper()\n\nenc = enc.replace(\"2E\",\"21\")\nenc = enc.replace(\"C5DC5A\",\"\")\nenc = enc.replace(\"D03D00\",\"\")\nenc = enc.replace(\"0B0E\",\"2121\")\n\nenc = enc.replace(\"01\",\"21\")\n\nenc_len = len(enc)\n\nenc_rev = \"\"\nnum_list = []\nenc_print =\"\"\nfor i in range(0,enc_len/2):\nenc_rev = enc[-2:]\nif not enc_rev==\"0B\" and not enc_rev==\"0E\" and not enc_rev==\"00\" and not\nenc_rev==\"D0\":\nenc_print +=enc_rev\nnum_list.append(enc_rev)\nenc= enc[:-2]\n\n#the first part is always ok\ndec_str = decrypt(num_list,0)\nfinal = sub_1_for_hex(dec_str)\nindex = final.find(\"OK: Sent\")\nif index==-1:\nprint comp_name + \" - did not found OK: Sent !!!!\\n\\n\\n\\n\"\n#exit()\ndecrypt_data = comp_name + \" ++==++ \" + str(i) + \": \" + final + \"\\n\"\n\nfinal_start = final[0:500]\nif final_start in UNIQUE_DATA:\nprint comp_name + \" already have this data\"\nreturn\nUNIQUE_DATA.append(final_start)\nindex = final.find(\"Installed Date:\")\n\nif index==-1:\nfor i in range(1,61):\ndec_str = decrypt3(num_list,i)\nfinal = sub_1_for_hex(dec_str)\n\n##print all 62 options\nindex2 = final.find(\"PROGRAM START:\")\nindex3 = final.find(\"Installed Date:\")\n\nif not index2 == 1 or not index3 == 1:\n\n\n-----\n\n147\n148\n149\n150\n151\n152\n153\n154\n155\n156\n157\n158\n159\n160\n161\n162\n163\n164\n165\n166\n167\n168\n169\n170\n171\n172\n173\n174\n175\n\n\ndecrypt_data + str(i) + : + final + \\n\nwrite_enc_infy_data_to_file(decrypt_data,comp_name,FILE_OUTPUT_NAME)\n\ndef read_enc_data_files():\n\nfor root,dir,files in os.walk(PDML_PATH):\nfor file in files:\nfilename = root+ \"\\\\\" + file\nif os.path.isfile(filename):\nprint filename\nfor line in fileinput.input([filename]):\nline = line.strip()\nis_found,found_infy_index= found_infy_enc_data(line)\nif not is_found:\ncontinue\nline = line[found_infy_index:]\n\n#get computer name (for use in init_key() later)\ncomp_name = extract_comp_name(line)\nUNIQUE_COMP.append(comp_name)\n#get the infy encrypted data\nline = extract_enc_data(line)\n#base64 decode enc_data\ndec_line = line.decode('base64')\n#append enc_data to file\nwrite_enc_infy_data_to_file(dec_line,comp_name,FILE_ENC_OUTPUT_NAME)\nenc_wrapper(dec_line,comp_name)\ntry:\nread_enc_data_files()\nexcept:\nprint \"exception!!!!\"\n\n\n## Appendix 2 –IoCs\n\nInfy version 31: f07e85143e057ee565c25db2a9f36491102d4e526ffb02c83e580712ec00eb27\n\nInfy “M” version 8.0:\n583349B7A2385A1E8DE682A43351798CA113CBBB80686193ECF9A61E6942786A\n\n5.9.94.34\n\n138.201.0.134\n\n138.201.47.150\n\n144.76.250.205\n\n138.201.47.158\n\n138.201.47.153\n\nus1s2[.]strangled[.]net\n\nuvps1[.]cotbm[.]com\n\ngstat[.]strangled[.]net\n\nsecup[.]soon[.]it\n\np208[.]ige[.]es\n\nlu[.]ige[.]es\n\n\n-----\n\nupdateserver1[.]com\nupdateserver3[.]com\nupdatebox4[.]com\nbestupdateserver[.]com\nbestupdateserver2[.]com\nbestbox3[.]com\nsafehostline[.]com\nyouripinfo[.]com\nbestupser[.]awardspace[.]info\nbox4035[.]net\nbox4036[.]net\nbox4037[.]net\nbox4038[.]net\nbox4039[.]net\nbox4040[.]net\nbox4041[.]net\nbox4042[.]net\nbox4043[.]net\nbox4044[.]net\nbox4045[.]net\nbox4046[.]net\nbox4047[.]net\nbox4048[.]net\nbox4049[.]net\nbox4050[.]net\nbox4051[.]net\nbox4052[.]net\nbox4053[.]net\nbox4054[.]net\nbox4055[.]net\nbox4056[.]net\nbox4057[.]net\nbox4058[.]net\nbox4059[.]net\nbox4060[.]net\nbox4061[.]net\nbox4062[.]net\nbox4063[.]net\nbox4064[.]net\nbox4065[.]net\nbox4066[.]net\nbox4067[.]net\nbox4068[.]net\nbox4069[.]net\nbox4070[ ]net\n\n\n-----\n\nbox4071[.]net\nbox4072[.]net\nbox4075[.]net\nbox4078[.]net\nbox4079[.]net\nbox4080[.]net\nbox4081[.]net\nbox4082[.]net\nbox4083[.]net\nbox4084[.]net\nbox4085[.]net\nbox4086[.]net\nbox4087[.]net\nbox4088[.]net\nbox4089[.]net\nbox4090[.]net\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-06-28 - Prince of Persia – Game Over.pdf"
    ],
    "report_names": [
        "2016-06-28 - Prince of Persia – Game Over.pdf"
    ],
    "threat_actors": [
        {
            "id": "59c9f31b-e032-44b9-bf3b-4f2cb3d17e39",
            "created_at": "2022-10-25T16:07:23.734244Z",
            "updated_at": "2025-03-27T02:02:09.952685Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "APT-C-07",
                "Infy",
                "Operation Mermaid",
                "Prince of Persia"
            ],
            "source_name": "ETDA:Infy",
            "tools": [
                "Foudre",
                "Infy",
                "Tonnerre"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f763fd1f-f697-40eb-a082-df6fd3d13cb1",
            "created_at": "2023-01-06T13:46:38.561288Z",
            "updated_at": "2025-03-27T02:00:02.861874Z",
            "deleted_at": null,
            "main_name": "Infy",
            "aliases": [
                "Operation Mermaid",
                "Prince of Persia",
                "Foudre"
            ],
            "source_name": "MISPGALAXY:Infy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535662,
    "ts_updated_at": 1743041515,
    "ts_creation_date": 1653685918,
    "ts_modification_date": 1653685918,
    "files": {
        "pdf": "https://archive.orkl.eu/6bdfec7bd5eeda1401efa671040d9365413f8cbb.pdf",
        "text": "https://archive.orkl.eu/6bdfec7bd5eeda1401efa671040d9365413f8cbb.txt",
        "img": "https://archive.orkl.eu/6bdfec7bd5eeda1401efa671040d9365413f8cbb.jpg"
    }
}