{
    "id": "702feb1d-b3b6-47c9-a972-eaf01e54db01",
    "created_at": "2024-06-20T02:03:16.410318Z",
    "updated_at": "2025-03-27T02:14:29.5351Z",
    "deleted_at": null,
    "sha1_hash": "fa72c567fe7851b63fd574d39a509d63d96a19bc",
    "title": "Snowflake Threat Hunting Guide",
    "authors": "",
    "file_creation_date": "0001-01-01T00:00:00Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 386221,
    "plain_text": "#### Mandiant Threat Hunting Guide\n# Snowflake\n\n###### v1.0\n\n\n-----\n\n## Table of Contents\n\n###### Table of Contents.........................................................................................................................2 Background..................................................................................................................................3 General Snowflake Tips & Tricks..............................................................................................4 IAM Review..............................................................................................................................6\n Roles and Permissions Changes...................................................................................................6 Abnormal Table and DB Access....................................................................................................8 User Creation and Deletion................................................................................................... 13 Query Analysis.......................................................................................................................15\n Frequency Analysis...................................................................................................................... 15 Error Rate Analysis.......................................................................................................................19 High Resource Consumption.......................................................................................................26 Long Running Queries..................................................................................................................33 Multi-Day Duplicate Queries..................................................................................................36 Staging/Exfil.......................................................................................................................... 39\n Data Compression........................................................................................................................39 Data Staging................................................................................................................................. 43 Data Streams Outbound.............................................................................................................. 47 Manual Data Retrieval..................................................................................................................50 Network Analysis................................................................................................................... 54\n Network Traffic Spikes.................................................................................................................54 User Analysis.........................................................................................................................56\n Abnormal Application Names..................................................................................................... 56 Average User Sessions................................................................................................................ 60 Query for Temporary Stages and External URLs..................................................................... 64\n\n\n-----\n\n## Background\n\n###### On June 10, 2024, Mandiant released a report on a threat campaign targeting Snowflake customer database instances with the intent of data theft and extortion. Snowflake is a multi-cloud data warehousing platform used to store and analyze large amounts of structured and unstructured data. Mandiant tracks this cluster of activity as UNC5537, a financially motivated threat actor suspected to have stolen a significant volume of records from Snowflake customer environments. UNC5537 is systematically compromising Snowflake customer instances using stolen customer credentials, advertising victim data for sale on cybercrime forums, and attempting to extort many of the victims.\n\n Mandiant's investigation has not found any evidence to suggest that unauthorized access to Snowflake customer accounts stemmed from a breach of Snowflake's enterprise environment. Instead, every incident Mandiant responded to associated with this campaign was traced back to compromised customer credentials.\n\n This guide provides hunting guidance to identify both activity associated with this campaign and other general malicious activity.\n\n Read our incident response investigation blog post for more information.\n\n\n-----\n\n### General Snowflake Tips & Tricks\n\n###### Description\n\n This section contains a few tricks that can help keep your threat hunting queries readable, and avoid some issues with parsing and exporting results.\n\n 1: Common Table Expressions (CTEs)\n\n A CTE takes the results of a query and stores them as a value which can be referenced in your main query. This can help keep the main body of your query cleaner and easier to edit in the future.\n\n Query\n\n\nUnset\n```\nWITH sq AS ( //sub query\n    SELECT <THINGS>\n    FROM <PLACE>\n    WHERE <CONDITION>\n    GROUP BY <THING-1>\n    )\nSELECT //main query\n    <THINGS>\nFROM <PLACE> p\n    JOIN sq ON sq.<THING-1> = p.<THING-1>\nWHERE <CONDITION>\n\n```\n\n###### 2: Timestamp normalization\n\n Timestamps, even when cast to UTC, will only appear normalized in the snowflake UI. Once you export them, they will return to their original timezone. To sidestep this, encapsulate timezones in both CONVERT_TIMEZONE, then TO_VARCHAR, which stores them as immutable string values.\n\n Query\n\n\nUnset\n```\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n\n```\n\n-----\n\n```\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\nTO_VARCHAR(CONVERT_TIMEZONE('UTC', START_TIME),'yyyy-mm-dd hh24:mi:ss') AS\nUTC_STR,\n\n```\n\n###### 3: JSON extraction\n\n Two main methods exist for JSON extraction:\n 1. Conversion of the entire JSON blob 2. Text extraction of single fields within a JSON blob\n\n Query\n\n\nUnset\n```\n//blob conversion\nPARSE_JSON(DB.SCHEMA.TABLE.JSON_BLOB_FIELD) AS PARSED_JSON\n//access nested members\nPARSED_JSON:<NESTED FIELD NAME>::STRING AS NESTED_FIELD\n\n```\n\n###### Query\n\n\nUnset\n```\n//individual path extraction\nJSON_EXTRACT_PATH_TEXT(DB.SCHEMA.TABLE.JSON_BLOB_FIELD, '<NESTED FIELD IN JSON\nBLOB') AS <NEW_FIELD_NAME>\n\n```\n\n-----\n\n### IAM Review\n\n##### Roles and Permissions Changes\n\n###### Description\n\n Hunt for any changes made to roles or permissions that could be associated with attacker activity. This includes abnormal usage of the GRANT statement to:\n\n ● Enumerate resources the current user has access to\n ● Grant additional rights to a user enabling additional access to commands or resources\n\n Observations\n\n During Mandiant’s investigation of UNC5537, the SHOW GRANT command was utilized to enumerate permissions and identify what tables they had access to.\n\n Potential Attacker Trends\n\n We observed multiple instances of exfiltration preceded by a large number of \"SHOW GRANT\" queries, explicitly calling individual usernames. Prior to table selection, the GRANT statement was queried to confirm the current user account had proper access to the table of interest.\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n\n\n-----\n\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|---|---|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\n###### Query 1: Spikes in Admin Permission Changes/Views by User, Application Name, IP, and Operating System per Day\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OP_SYS,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT l.CLIENT_IP) AS UNIQ_IP,\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nWHERE (\n  upper(QUERY_TEXT) LIKE '%CREATE USER%' OR\n  upper(QUERY_TEXT) LIKE '%ALTER USER%' OR\n  upper(QUERY_TEXT) LIKE '%ALTER ACCOUNT%' OR\n  upper(QUERY_TEXT) LIKE '%ALTER PASSWORD POLICY%' OR\n\n```\n\n-----\n\n```\n  upper(QUERY_TEXT) LIKE '%APPLY PASSWORD POLICY%' OR\n  upper(QUERY_TEXT) LIKE '%GRANT USAGE%' OR\n  upper(QUERY_TEXT) LIKE '%GRANT CREATE%' OR\n  upper(QUERY_TEXT) LIKE '%GRANT APPLY%' OR\n  upper(QUERY_TEXT) LIKE '%SHOW GRANT%' OR\n  upper(QUERY_TEXT) LIKE '%GRANT ROLE%'\n  ) OR QUERY_TYPE IN ('CREATE_USER', 'ALTER_ACCOUNT', 'GRANT', 'ALTER_USER')\nGROUP BY\n  QUERY_DATE\n\n```\n\n##### Abnormal Table and DB Access\n\n###### Description\n\n Most accounts regularly access a limited set of databases, schemas, views, and tables, but unless there is prior insight, an attacker needs to enumerate a multitude of sources. These spikes in the number of databases/schemas/views/tables can be indicative of attacker activity.\n\n Observations\n\n We noticed a very distinctive spike in unique views/tables accessed by user accounts impacted by the attacker. Since there are more views/tables than schemas, and more schemas than databases, analysis of views/tables can show more distinctive peaks and valleys.\n\n Warnings about FP/Noise\n\n Normalizing the results as a fraction from the average can be a better way to look for spikes, rather than the raw aggregate numbers. Raw numbers can cause a loud service account to drown out the enumeration of an attacker’s activity. The below aggregation normalizes the daily unique numbers as a percentage of that entry’s average.\n\n\nUnset\n```\nTO_NUMBER(UNIQ_QUERIES/AVG(UNIQ_QUERIES)*100, 10, 2) AS RATE\n\n```\n\n###### Note: The following queries are stacked by username and application name; however, stacking by IP is explicitly excluded. Since most client environments include a very high number of IP hits, and this query when stacked by date/DB/schema/table can get quite lengthy, an additional\n\n\n-----\n\n###### factor of IP causes the number of results to climb to an unmanageable volume. If you want to try it in your own environment, do so at your own risk.\n\n Stacking Field Definition\n\n Field Definition\n\n CLIENT_IP / IP IP address running queries\n\n Name of the user account that ran the query\n\n APPLICATION_NAME The name of the application that ran queries, from CLIENT_ENVIRONMENT\n\n EARLIEST_UTC First time, grouped variation was observed, normalized to UTC as a string\n\n LATEST_UTC Last time, grouped variation was observed, normalized to UTC as a string\n\n UNIQUE_QUERIES Count of unique queries per grouped variation\n\n TOTAL_QUERIES Count of total queries per grouped variation\n\n DAY_COUNT Count of unique days active per grouped variation\n\n Count of unique users per grouped variation\n\n ARR_UNIQ_USER Array of users that ran queries per grouped variation\n\n UNIQ_APP_NAME Count of unique application names per grouped variation\n\n ARR_APP_NAME Array of application names per grouped variation\n\n Count of unique operating systems per grouped variation\n\n ARR_OP_SYS Array of operating systems per grouped variation\n\n Count of unique IPs per grouped variation\n\n Query 1: Spikes in View Access by User, Application Name, IP, and Operating System Across Whole Snowflake Environment Per Day\n\n Query\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\nUnset\n```\nWITH sq AS (\n\n```\n\n-----\n\n```\n    SELECT\n      START_TIME,\n      DATE(START_TIME) AS QUERY_DATE,\n      QUERY_HASH,\n      QUERY_TEXT,\n      SESSION_ID,\n      REGEXP_REPLACE(REGEXP_SUBSTR(QUERY_TEXT,\n$$FROM.*\\W([\\w]+\\.[^\\s]+\\.[\\w]+).*$$,1,1,'mse'),'\"','') as DB_S_TV_STR,\n      CASE\n        WHEN UPPER(QUERY_TEXT) LIKE '%COUNT(%' THEN 'TRUE'\n        ELSE 'FALSE'\n      END as IS_COUNT_Q\n    FROM snowflake.account_usage.query_history q\n    WHERE\n      EXECUTION_STATUS = 'SUCCESS' AND\n      (upper(QUERY_TEXT) LIKE 'SELECT%' OR upper(QUERY_TEXT) LIKE 'COPY\nINTO%') AND\n      upper(QUERY_TEXT) LIKE '%FROM%' AND\n      NOT REGEXP_LIKE(UPPER(QUERY_TEXT),'.*INFORMATION_SCHEMA.*','s')\n   )\nSELECT\n  QUERY_DATE,\n  COUNT(DISTINCT sq.QUERY_HASH) AS UNIQ_QUERIES,\n  COUNT(DISTINCT l.USER_NAME) AS UNIQ_USER,\n  COUNT(DISTINCT l.CLIENT_IP) AS UNIQ_IP,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APPS,\n  COUNT(DISTINCT sq.SESSION_ID) AS UNIQ_SESSION,\n  SPLIT_PART(DB_S_TV_STR, '.', 1) AS target_DB,\n  SPLIT_PART(DB_S_TV_STR, '.', 2) AS target_schema,\n  SPLIT_PART(DB_S_TV_STR, '.', 3) AS target_table,\nFROM sq\n  JOIN snowflake.account_usage.sessions s ON s.session_id = sq.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nWHERE\n  sq.IS_COUNT_Q = 'FALSE' AND\n  DB_S_TV_STR IS NOT NULL\nGROUP BY\n  QUERY_DATE,\n  target_DB,\n  target_schema,\n  target_table\n\n```\n\n-----\n\n###### Query 2: Stacking Table and DB Access Application Name, IP, and Operating System per Unique User and Day\n\n Query\n\n\nUnset\n```\nWITH sq AS (\n    SELECT\n      START_TIME,\n      DATE(START_TIME) AS QUERY_DATE,\n      QUERY_HASH,\n      QUERY_TEXT,\n      SESSION_ID,\n      REGEXP_REPLACE(REGEXP_SUBSTR(QUERY_TEXT,\n$$FROM.*\\W([\\w]+\\.[^\\s]+\\.[\\w]+).*$$,1,1,'mse'),'\"','') as DB_S_TV_STR,\n      CASE\n        WHEN UPPER(QUERY_TEXT) LIKE '%COUNT(%' THEN 'TRUE'\n        ELSE 'FALSE'\n      END as IS_COUNT_Q\n    FROM snowflake.account_usage.query_history q\n    WHERE\n      EXECUTION_STATUS = 'SUCCESS' AND\n      (upper(QUERY_TEXT) LIKE 'SELECT%' OR upper(QUERY_TEXT) LIKE 'COPY\nINTO%') AND\n      upper(QUERY_TEXT) LIKE '%FROM%' AND\n      NOT REGEXP_LIKE(UPPER(QUERY_TEXT),'.*INFORMATION_SCHEMA.*','s')\n   )\nSELECT\n  QUERY_DATE,\n  l.USER_NAME AS USERNAME,\n  COUNT(DISTINCT sq.QUERY_HASH) AS UNIQ_QUERIES,S\n  COUNT(DISTINCT l.CLIENT_IP) AS UNIQ_IP,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APPS,\n  COUNT(DISTINCT sq.SESSION_ID) AS UNIQ_SESSION,\n  SPLIT_PART(DB_S_TV_STR, '.', 1) AS target_DB,\n  SPLIT_PART(DB_S_TV_STR, '.', 2) AS target_schema,\n  SPLIT_PART(DB_S_TV_STR, '.', 3) AS target_table,\n\n```\n\n-----\n\n```\nFROM sq\n  JOIN snowflake.account_usage.sessions s ON s.session_id = sq.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nWHERE\n  sq.IS_COUNT_Q = 'FALSE' AND\n  DB_S_TV_STR IS NOT NULL\nGROUP BY\n  QUERY_DATE,\n  USERNAME,\n  target_DB,\n  target_schema,\n  target_table\n\n```\n\n###### Query 3: Stacking Table and DB Access per User, IP, and Operating System per Unique Application Used and Day\n\n Query\n\n\nUnset\n```\nWITH sq AS (\n    SELECT\n      START_TIME,\n      DATE(START_TIME) AS QUERY_DATE,\n      QUERY_HASH,\n      QUERY_TEXT,\n      SESSION_ID,\n      REGEXP_REPLACE(REGEXP_SUBSTR(QUERY_TEXT,\n$$FROM.*\\W([\\w]+\\.[^\\s]+\\.[\\w]+).*$$,1,1,'mse'),'\"','') as DB_S_TV_STR,\n      CASE\n        WHEN UPPER(QUERY_TEXT) LIKE '%COUNT(%' THEN 'TRUE'\n        ELSE 'FALSE'\n      END as IS_COUNT_Q\n    FROM snowflake.account_usage.query_history q\n    WHERE\n      EXECUTION_STATUS = 'SUCCESS' AND\n      (upper(QUERY_TEXT) LIKE 'SELECT%' OR upper(QUERY_TEXT) LIKE 'COPY\nINTO%') AND\n      upper(QUERY_TEXT) LIKE '%FROM%' AND\n      NOT REGEXP_LIKE(UPPER(QUERY_TEXT),'.*INFORMATION_SCHEMA.*','s')\n   )\n\n```\n\n-----\n\n```\nSELECT\n  QUERY_DATE,\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  COUNT(DISTINCT sq.QUERY_HASH) AS UNIQ_QUERIES,\n  COUNT(DISTINCT l.USER_NAME) AS UNIQ_USER,\n  COUNT(DISTINCT l.CLIENT_IP) AS UNIQ_IP,\n  COUNT(DISTINCT sq.SESSION_ID) AS UNIQ_SESSION,\n  SPLIT_PART(DB_S_TV_STR, '.', 1) AS target_DB,\n  SPLIT_PART(DB_S_TV_STR, '.', 2) AS target_schema,\n  SPLIT_PART(DB_S_TV_STR, '.', 3) AS target_table,\nFROM sq\n  JOIN snowflake.account_usage.sessions s ON s.session_id = sq.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nWHERE\n  sq.IS_COUNT_Q = 'FALSE' AND\n  DB_S_TV_STR IS NOT NULL\nGROUP BY\n  QUERY_DATE,\n  APPLICATION_NAME,\n  target_DB,\n  target_schema,\n  target_table\n\n```\n\n##### User Creation and Deletion\n\n###### Description\n\n The “Snowflake.Account_Usage.Users” view can be utilized to identify all users currently and historically present the target Snowflake account over the past year. In addition to creation, deletion, and last password modification timestamps, other properties surrounding the account such as role, MFA enforcement, and email address are also visible.\n\n Potential Attacker Trends\n\n Depending on the end goal of the attacker, behavior will vary per attack lifecycle. Focusing on anomalies such as\n\n ● Account creations (CREATED_ON) followed by rapid deletions (DELETED_ON)\n ● Invalid or abnormal domains present in email addresses (EMAIL)\n\n\n-----\n\n###### ● Abnormal password reset times (PASSWORD_LAST_SET_TIME)\n ● Disabled MFA (EXT_AUTHN_DUO) in an environment where it is normally required\n\n Field Definition\n\n The field definition for the users view can be found in the following Snowflake documentation:  https://docs.snowflake.com/en/sql-reference/account-usage/users\n\n Query 1: Full export of Users View\n\n Query\n\n\nUnset\n```\nSELECT * FROM snowflake.account_usage.users\n\n```\n\n-----\n\n### Query Analysis\n\n##### Frequency Analysis\n\n###### Description\n\n When performing recon on the environment, the number of queries performed by the attacker were observed as a spike comparatively to those seen across normal days within the environment. The queries below break out different ways of stacking the number of queries based on User, Application Name, IP, and Operating System.\n\n Potential Attacker Trends\n\n Look for abnormal spikes across user accounts and IP addresses (specifically for service accounts with relatively fixed rates of queries day per day due to automations).\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n\n\n-----\n\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|---|---|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\n###### Query 1: Spikes in Query Count per Day (Showing Distinct and Count of Users, Application Names, Operating System, and IP)\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,   \n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS,\n  ARRAY_UNIQUE_AGG(l.CLIENT_IP)AS ARR_IP,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,  \nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nGROUP BY\n  QUERY_DATE\n\n```\n\n-----\n\n###### Query 2: Query Frequency & Behavior per User\n\n Query\n\n\nUnset\n```\nSELECT\n  q.USER_NAME AS USERNAME,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS,\n  ARRAY_UNIQUE_AGG(l.CLIENT_IP)AS ARR_IP,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nGROUP BY\n  USERNAME\n\n```\n\n###### Query 3: Query Frequency & Behavior per IP\n\n Query\n\n\nUnset\n```\nSELECT\n  l.CLIENT_IP AS IP,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n\n```\n\n-----\n\n```\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,   \n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS, \nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nGROUP BY\n  IP\n\n```\n\n###### Query 4: Query Frequency & Behavior per Application Used\n\n Query\n\n\nUnset\n```\nSELECT\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS,\n  ARRAY_UNIQUE_AGG(l.CLIENT_IP)AS ARR_IP,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n\n```\n\n-----\n\n```\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nGROUP BY\n  APPLICATION_NAME\n\n```\n\n##### Error Rate Analysis\n\n###### Description\n\n Similar to query frequency analysis, attackers often have abnormal failure/success rates as compared to service and user account norms. Attacker brute force tools and fuzzers generate failures while enumerating the DB schemas, while on the flipside a misconfigured service account dropping in error % per day for a short span of time without explanation can be indicative of interactive user activity on the account.\n\n Observations\n\n After identifying the error codes of interest (the top 4 with deviations during the time of interest),  failed transactions were filtered by user, date, and code. These can then be post-processed to timechart the errors by user, and filtered by codes.\n\n Warnings About FP/Noise\n\n Error codes are 6 digit, zero padded, but the padded zeros are not visible in the output results. Padded zeros must be explicitly specified if using IN/NOT IN conditions within the WHERE statement.\n\n An initial stack on error codes by DATE only will help identify the noisiest codes, which can then be filtered out.\n\n Since the user count can be very high, it is worth running different filters to check named-user and non-named-user separately. In our case, named users had the format F.L, so NOT USERNAME LIKE ‘%.%’ will remove named users.\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n\n\n-----\n\n|USERNAME|Name of the user account that ran the query|\n|---|---|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n|UNIQ_CODES|Count of unique error codes|\n|UNIQ_MSG|Count of unique error messages|\n|UNIQ_CODE_MSG_RATE|UNIQ_CODES divided by the UNIQ_MSG|\n|UNIQ_MSG_TOTAL_RATE|UNIQ_MSG divided by the ERR_COUNT|\n|Q_ERR_CODE|Query error code|\n|FAIL_COUNT|Count of total \"fail\" results for queries run|\n|SUCCESS_COUNT|Count of total \"success\" results for queries run|\n|FAIL_DAY_COUNT|Count of unique days on which a fail occurred|\n|AVG_QUERY_PER_DAY|Average queries run per day|\n\n\n-----\n\n###### Query 1: Identifying Which Queries Result in the Highest Error Rate\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT( DISTINCT CLIENT_IP) AS UNIQ_IP,\n  COUNT(DISTINCT q.ERROR_CODE) AS UNIQ_CODES,\n  COUNT(DISTINCT q.ERROR_MESSAGE) AS UNIQ_MSG,\n  COUNT(q.ERROR_MESSAGE) AS ERR_COUNT,\n  TO_NUMBER((UNIQ_CODES/UNIQ_MSG)*100, 10, 2) AS UNIQ_CODE_MSG_RATE,\n  TO_NUMBER((UNIQ_MSG/ERR_COUNT)*100, 10, 2) AS UNIQ_MSG_TOTAL_RATE\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  EXECUTION_STATUS = 'FAIL' AND NOT q.ERROR_CODE IN ('090106', '002129')\nGROUP BY\n  QUERY_DATE\nORDER BY\n  QUERY_DATE\n\n```\n\n###### Query 2: Frequency of Errors by Error Reason Type (Codes, etc.)\n\n Query\n\n\nUnset\n```\nSELECT\n  q.ERROR_CODE AS Q_ERR_CODE,\n  COUNT(DISTINCT q.ERROR_MESSAGE) AS UNIQ_ERR_MSG,\n  COUNT(EXECUTION_STATUS) AS HIT_COUNT,\n  COUNT( DISTINCT CLIENT_IP) AS UNIQ_IP,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\n\n```\n\n-----\n\n```\nWHERE\n  EXECUTION_STATUS = 'FAIL'\nGROUP BY\n  Q_ERR_CODE\nORDER BY\n  Q_ERR_CODE\n\n```\n\n###### Query 3: Frequency of Errors per IP\n\n Query\n\n\nUnset\n```\nWITH\n  FAIL_DATES AS (\n    SELECT\n      l.CLIENT_IP AS IP,\n      TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_FAIL_UTC,\n      TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_FAIL_UTC,\n      COUNT( DISTINCT DATE(START_TIME)) AS FAIL_DAY_COUNT,\n    FROM\n      snowflake.account_usage.query_history\n      JOIN snowflake.account_usage.sessions s ON s.session_id =\nq.session_id\n      JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID      \n    WHERE EXECUTION_STATUS = 'FAIL'\n    GROUP BY IP\n  )\nSELECT * FROM\n  (\n  SELECT\n    CLIENT_IP,\n    COUNT( DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n    SUM(FAIL_DAY_COUNT) AS FAIL_DAY_COUNT,\n    COUNT_IF(EXECUTION_STATUS = 'FAIL') AS FAIL_COUNT,\n    COUNT_IF(EXECUTION_STATUS = 'SUCCESS') AS SUCCESS_COUNT,\n    COUNT(EXECUTION_STATUS) AS HIT_COUNT,\n    TO_NUMBER((FAIL_COUNT/HIT_COUNT)*100, 10, 2) AS FAIL_RATE,\n\n```\n\n-----\n\n```\n    TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n    TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n    MIN(EARLIEST_FAIL_UTC) AS EARLIEST_FAIL_UTC,\n    MAX(LATEST_FAIL_UTC) AS LATEST_FAIL_UTC,\n  FROM snowflake.account_usage.query_history q\n    JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n    JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\n    JOIN FAIL_DATES ON FAIL_DATES.IP = l.CLIENT_IP\n  GROUP BY\n    CLIENT_IP\n  )\nORDER BY\n  CLIENT_IP\n\n```\n\n###### Query 4: Frequency of Errors per User\n\n Query\n\n\nUnset\n```\nWITH\n  FAIL_DATES AS (\n    SELECT\n      l.USER_NAME AS USERNAME,\n      TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_FAIL_UTC,\n      TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_FAIL_UTC,\n      COUNT( DISTINCT DATE(START_TIME)) AS FAIL_DAY_COUNT,\n    FROM\n      snowflake.account_usage.query_history\n      JOIN snowflake.account_usage.sessions s ON s.session_id =\nq.session_id\n      JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID      \n    WHERE EXECUTION_STATUS = 'FAIL'\n    GROUP BY USERNAME\n  )\n\n```\n\n-----\n\n```\nSELECT * FROM\n  (\n  SELECT\n    USERNAME,\n    COUNT( DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n    SUM(FAIL_DAY_COUNT) AS FAIL_DAY_COUNT,\n    COUNT_IF(EXECUTION_STATUS = 'FAIL') AS FAIL_COUNT,\n    COUNT_IF(EXECUTION_STATUS = 'SUCCESS') AS SUCCESS_COUNT,\n    COUNT(EXECUTION_STATUS) AS HIT_COUNT,\n    TO_NUMBER((FAIL_COUNT/HIT_COUNT)*100, 10, 2) AS FAIL_RATE,\n    TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n    TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n    MIN(EARLIEST_FAIL_UTC) AS EARLIEST_FAIL_UTC,\n    MAX(LATEST_FAIL_UTC) AS LATEST_FAIL_UTC\n  FROM snowflake.account_usage.query_history q\n    JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n    JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\n    JOIN FAIL_DATES ON FAIL_DATES.USERNAME = l.USER_NAME\n  GROUP BY\n    USERNAME\n  )\nORDER BY\n  USERNAME\n\n```\n\n###### Query 5: Frequency of Errors per Application Name\n\n Query\n\n\nUnset\n```\nWITH\n  FAIL_DATES AS (\n    SELECT\n      JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n      s.CLIENT_ENVIRONMENT AS JSON_BLOB,\n\n```\n\n-----\n\n```\n      TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_FAIL_UTC,\n      TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_FAIL_UTC,\n      COUNT( DISTINCT DATE(START_TIME)) AS FAIL_DAY_COUNT,\n    FROM\n      snowflake.account_usage.query_history\n      JOIN snowflake.account_usage.sessions s ON s.session_id =\nq.session_id\n      JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID      \n    WHERE EXECUTION_STATUS = 'FAIL'\n    GROUP BY APPLICATION_NAME, JSON_BLOB\n  )\nSELECT\n  APPLICATION_NAME,\n  COUNT( DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  SUM(FAIL_DAY_COUNT) AS FAIL_DAY_COUNT,\n  COUNT_IF(EXECUTION_STATUS = 'FAIL') AS FAIL_COUNT,\n  COUNT_IF(EXECUTION_STATUS = 'SUCCESS') AS SUCCESS_COUNT,\n  COUNT(EXECUTION_STATUS) AS HIT_COUNT,\n  TO_NUMBER((FAIL_COUNT/HIT_COUNT)*100, 10, 2) AS FAIL_RATE,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  MIN(EARLIEST_FAIL_UTC) AS EARLIEST_FAIL_UTC,\n  MAX(LATEST_FAIL_UTC) AS LATEST_FAIL_UTC\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\n  JOIN FAIL_DATES ON FAIL_DATES.JSON_BLOB = s.CLIENT_ENVIRONMENT\nGROUP BY\n  APPLICATION_NAME\nORDER BY\n  APPLICATION_NAME\n\n```\n\n-----\n\n###### Query 6: Error Count, Code by User, Date, Select Code Inclusions\n\n Query\n\n\nUnset\n```\nSELECT\n  l.USER_NAME AS USERNAME,\n  DATE(START_TIME) AS QUERY_DATE,\n  q.ERROR_CODE AS Q_ERR_CODE,\n  COUNT( DISTINCT CLIENT_IP) AS UNIQ_IP,\n  COUNT(DISTINCT q.ERROR_CODE) AS UNIQ_CODES,\n  COUNT(DISTINCT q.ERROR_MESSAGE) AS UNIQ_MSG,\n  COUNT(q.ERROR_MESSAGE) AS ERR_COUNT,\n  TO_NUMBER((UNIQ_CODES/UNIQ_MSG)*100, 10, 2) AS UNIQ_CODE_MSG_RATE,\n  TO_NUMBER((UNIQ_MSG/ERR_COUNT)*100, 10, 2) AS UNIQ_MSG_TOTAL_RATE\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  EXECUTION_STATUS = 'FAIL' AND q.ERROR_CODE IN ('<Code 1>','<Code 2>','<Code\n3>','<Code 4>')\nGROUP BY\n  QUERY_DATE,\n  USERNAME,\n  Q_ERR_CODE\n\n```\n\n##### High Resource Consumption\n\n###### Description\n\n Analysis of resources and cloud credits used for queries. When attackers aim to exfiltrate large amounts of data, the resources used to perform the queries/compression/exfil increase the compute resources required above the norm.\n\n Warnings About FP/Noise\n\n Metrics for CREDITS_USED_CLOUD_SERVICES are often directly related to the computational power needed to run a query; however, computational power is not always indicative of attacker queries. Since an attacker is often enumerating and exfiltrating data, ROWS_PRODUCED and ROWS_WRITTEN_TO_RESULT fields are more likely to help identify the latter.\n\n\n-----\n\n###### Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n|QUERY_LOAD_PERCENT|Summation of the query load percent per grouped variation|\n|QUERY_ACCELERATION_BY TES_SCANNED|Summation of the query acceleration bytes scanned per grouped variation|\n|QUERY_ACCELERATION_PA RTITIONS_SCANNED|Summation of the query acceleration partitions scanned per grouped variation|\n|QUERY_ACCELERATION_UP PER_LIMIT_SCALE_FACTOR|Summation of the query acceleration scale factor per grouped variation|\n|ARR_OUTBOUND_DATA_TR ANSFER_CLOUD|Array of unique values for outbound data transfer cloud (AWS, AZURE etc.)|\n\n\n-----\n\n|ARR_OUTBOUND_DATA_TR ANSFER_REGION|Array of unique values for outbound cloud regions (east, west, etc.)|\n|---|---|\n|OUTBOUND_DATA_TRANSF ER_BYTES|Summation of the outbound data transfer bytes|\n|ARR_INBOUND_DATA_TRA NSFER_CLOUD|Array of unique values for inbound data transfer cloud (AWS, AZURE etc.)|\n|ARR_INBOUND_DATA_TRA NSFER_REGION|Array of unique values for inbound cloud regions (east, west, etc.)|\n|INBOUND_DATA_TRANSFE R_BYTES|Summation of the inbound data transfer bytes|\n|CREDITS_USED_CLOUD_SE RVICES|Summation of the cloud credits used|\n|BYTES_WRITTEN|Summation of the bytes written|\n|BYTES_WRITTEN_TO_RESU LT|Summation of the bytes written to result|\n|BYTES_READ_FROM_RESUL T|Summation of the bytes read from result|\n|ROWS_PRODUCED|Summation of the rows produced|\n|ROWS_INSERTED|Summation of the rows inserted|\n|ROWS_UPDATED|Summation of the rows updated|\n|ROWS_DELETED|Summation of the rows deleted|\n|ROWS_UNLOADED|Summation of the rows unloaded|\n|ROWS_WRITTEN_TO_RESU LT|Summation of the rows written to result|\n\n\n-----\n\n###### Query 1: Identifying Count of Queries with High Resource Consumption\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  SUM(QUERY_LOAD_PERCENT) AS QUERY_LOAD_PERCENT,\n  SUM(QUERY_ACCELERATION_BYTES_SCANNED) AS QUERY_ACCELERATION_BYTES_SCANNED,\n  SUM(QUERY_ACCELERATION_PARTITIONS_SCANNED) AS\nQUERY_ACCELERATION_PARTITIONS_SCANNED,\n  SUM(QUERY_ACCELERATION_UPPER_LIMIT_SCALE_FACTOR) AS\nQUERY_ACCELERATION_UPPER_LIMIT_SCALE_FACTOR,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nGROUP BY\n  QUERY_DATE\n\n```\n\n###### Query 2: Identifying High Credit Usage\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n\n```\n\n-----\n\n```\n  ARRAY_UNIQUE_AGG(OUTBOUND_DATA_TRANSFER_CLOUD) AS\nARR_OUTBOUND_DATA_TRANSFER_CLOUD,\n  ARRAY_UNIQUE_AGG(OUTBOUND_DATA_TRANSFER_REGION) AS\nARR_OUTBOUND_DATA_TRANSFER_REGION,\n  SUM(OUTBOUND_DATA_TRANSFER_BYTES) AS OUTBOUND_DATA_TRANSFER_BYTES,\n  ARRAY_UNIQUE_AGG(INBOUND_DATA_TRANSFER_CLOUD) AS\nARR_INBOUND_DATA_TRANSFER_CLOUD,\n  ARRAY_UNIQUE_AGG(INBOUND_DATA_TRANSFER_REGION) AS\nARR_INBOUND_DATA_TRANSFER_REGION,\n  SUM(INBOUND_DATA_TRANSFER_BYTES) AS INBOUND_DATA_TRANSFER_BYTES,\n  SUM(CREDITS_USED_CLOUD_SERVICES) AS CREDITS_USED_CLOUD_SERVICES,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nGROUP BY\n  QUERY_DATE\n\n```\n\n###### Query 3: Identify Resource Consumption per IP\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  l.CLIENT_IP AS IP,\n  SUM(BYTES_WRITTEN) AS BYTES_WRITTEN,\n  SUM(BYTES_WRITTEN_TO_RESULT) AS BYTES_WRITTEN_TO_RESULT,\n\n```\n\n-----\n\n```\n  SUM(BYTES_READ_FROM_RESULT) AS BYTES_READ_FROM_RESULT,\n  SUM(ROWS_PRODUCED) AS ROWS_PRODUCED,\n  SUM(ROWS_INSERTED) AS ROWS_INSERTED,\n  SUM(ROWS_UPDATED) AS ROWS_UPDATED,\n  SUM(ROWS_DELETED) AS ROWS_DELETED,\n  SUM(ROWS_UNLOADED) AS ROWS_UNLOADED,\n  SUM(ROWS_WRITTEN_TO_RESULT) AS ROWS_WRITTEN_TO_RESULT,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nGROUP BY\n  QUERY_DATE,\n  IP \n\n```\n\n###### Query 4: Identify Resource Consumption per User\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  l.USER_NAME AS USERNAME,\n  SUM(BYTES_WRITTEN) AS BYTES_WRITTEN,\n  SUM(BYTES_WRITTEN_TO_RESULT) AS BYTES_WRITTEN_TO_RESULT,\n  SUM(BYTES_READ_FROM_RESULT) AS BYTES_READ_FROM_RESULT,\n  SUM(ROWS_PRODUCED) AS ROWS_PRODUCED,\n\n```\n\n-----\n\n```\n  SUM(ROWS_INSERTED) AS ROWS_INSERTED,\n  SUM(ROWS_UPDATED) AS ROWS_UPDATED,\n  SUM(ROWS_DELETED) AS ROWS_DELETED,\n  SUM(ROWS_UNLOADED) AS ROWS_UNLOADED,\n  SUM(ROWS_WRITTEN_TO_RESULT) AS ROWS_WRITTEN_TO_RESULT,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nGROUP BY\n  QUERY_DATE,\n  USERNAME\n\n```\n\n###### Query 5: Stack by App\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  SUM(BYTES_WRITTEN) AS BYTES_WRITTEN,\n  SUM(BYTES_WRITTEN_TO_RESULT) AS BYTES_WRITTEN_TO_RESULT,\n  SUM(BYTES_READ_FROM_RESULT) AS BYTES_READ_FROM_RESULT,\n  SUM(ROWS_PRODUCED) AS ROWS_PRODUCED,\n  SUM(ROWS_INSERTED) AS ROWS_INSERTED,\n  SUM(ROWS_UPDATED) AS ROWS_UPDATED,\n\n```\n\n-----\n\n```\n  SUM(ROWS_DELETED) AS ROWS_DELETED,\n  SUM(ROWS_UNLOADED) AS ROWS_UNLOADED,\n  SUM(ROWS_WRITTEN_TO_RESULT) AS ROWS_WRITTEN_TO_RESULT,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,  \nARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nGROUP BY\n\n```\n```\n  QUERY_DATE,                                         \n\n```\n```\n  APPLICATION_NAME\n\n```\n\n##### Long Running Queries\n\n###### Description\n\n The following queries were designed to identify queries with abnormally long run times compared to the average run within the snowflake environment. Two separate queries were designed to break out Long Running Query Usage - Large amounts of abnormally long queries from any single user or IP address.\n\n Potential Attacker Trends\n\n Please see the \"Indicators of Compromise (IOCs)\" section of the blog post for an actively updated list of Applications observed by UNC5537.\n\n All Observed Variations (If Relevant)\n\n ● Snowflake logging/app parsing is not bulletproof. In some cases, the application name \"C:\\\\Program\" is seen in the s.CLIENT_ENVIRONMENT JSON blob, potentially caused by\n\n\n-----\n\n###### the space in \"Program Files.\" We have seen situations where the Windows Server 2022 compromised account and bad IP use this application name and believe it might be truncating the DBeaver app name during logging.\n ● For reference, the functions PARSE_JSON() and JSON_EXTRACT_PATH_TEXT can be used to extract/transform these fields.\n\n Warnings About FP/Noise\n\n ● Although SnowSQL was observed linked to TA activity, we saw historic use of SnowSQL for additional uncompromised accounts back in early 2023. This app name alone is not a high-fidelity indicator, but should be paired with other findings.\n ● com.amazonaws.services.glue.ProcessLauncher and PythonConnector were our two noisiest app names, and filtering these out reduced our dataset from 60k down to around 500.\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n\n\n-----\n\n|UNIQ_IP|Count of unique IPs per grouped variation|\n|---|---|\n\n\n###### Query 1: Stack by IP\n\n Query\n\n\nUnset\n```\nSELECT\n  CLIENT_IP,\n  COUNT(DISTINCT QUERY_TEXT) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS, \n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USER,\n  COUNT( DISTINCT l.USER_NAME) AS UNIQ_USER\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  q.total_elapsed_time >\n    (SELECT AVG(TOTAL_ELAPSED_TIME) FROM\nsnowflake.account_usage.query_history q )\nGROUP BY CLIENT_IP\n\n```\n\n-----\n\n###### Query 2: Stack by User\n\n Query\n\n\nUnset\n```\nSELECT\n  q.USER_NAME,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,   \n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS,\n  ARRAY_UNIQUE_AGG(l.CLIENT_IP)AS ARR_IP,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,  \nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  q.total_elapsed_time >\n    (SELECT AVG(TOTAL_ELAPSED_TIME) FROM\nsnowflake.account_usage.query_history q)\nGROUP BY q.USER_NAME\n\n```\n\n##### Multi-Day Duplicate Queries\n\n###### Description\n\n Several engagements have shown the attacker running many of the same queries across a small selection of days. The below query can be run with your known bad IPs to identify if this multi-day repeat pattern of queries exists in a client environment.\n\n\n-----\n\n###### Potential Attacker Trends\n\n We observed the attacker running several thousand duplicate queries across three distinct days. These will clearly stick out from the rest of the attacker’s activity.\n\n Warnings About FP/Noise\n\n Caution should be taken not to stack this query by username. Since the attacker may be using an existing account, which itself may be used to run recurring queries, it will have a tendency to show a high amount of noise.\n\n Query 1: Multi-day repeats\n\n Query\n\n\nUnset\n```\nWITH sq AS (\n  SELECT\n     QUERY_HASH,\n     COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT\n  FROM snowflake.account_usage.query_history q\n     JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n     JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\n  WHERE l.CLIENT_IP IN ('IP-1', 'IP-2', ... 'IP-n')\n  GROUP BY QUERY_HASH\n)\nSELECT // pull queries from 1, dates from 2, stack by 1) date 2) raw\nquery text\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT(DISTINCT q.QUERY_HASH) AS UNIQUE_QUERIES,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  ARRAY_UNIQUE_AGG(l.CLIENT_IP) AS ARR_IP,\n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USERNAME\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\n  JOIN sq ON sq.QUERY_HASH = q.QUERY_HASH\nWHERE\n\n```\n\n-----\n\n```\n  sq.DAY_COUNT > 1\n  AND\n  l.CLIENT_IP IN ('IP-1', 'IP-2', ... 'IP-n')\nGROUP BY\n  QUERY_DATE\nORDER BY\n  QUERY_DATE ASC\n\n```\n\n-----\n\n### Staging/Exfil\n\n##### Data Compression\n\n###### Description\n\n Analysis of queries that use commands associated with compression, often seen prior to exfil.\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\n-----\n\n###### Query 1: Stats on Queries with Data Compression per User\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  l.USER_NAME AS USERNAME,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS, \n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS') AS OP_SYS,\n  COUNT( DISTINCT l.USER_NAME) AS UNIQ_USER,\n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USER,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nWHERE\n  (\n  (upper(QUERY_TEXT) LIKE '%COPY FILE%') OR\n  (upper(QUERY_TEXT) LIKE '%COPY INTO%')\n  )\nGROUP BY\n  QUERY_DATE,\n  USERNAME\n\n```\n\n-----\n\n###### Query 2: Stats on Queries with Data Compression per IP Address\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  l.CLIENT_IP AS IP,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS, \n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS') AS OP_SYS,\n  COUNT( DISTINCT l.USER_NAME) AS UNIQ_USER,\n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USER,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nWHERE\n  (\n  (upper(QUERY_TEXT) LIKE '%COPY FILE%') OR\n  (upper(QUERY_TEXT) LIKE '%COPY INTO%')\n  )\nGROUP BY\n  QUERY_DATE,\n  IP\n\n```\n\n-----\n\n###### Query 3: Stats on Queries with Data Compression per Applications Used\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS, \n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS') AS OP_SYS,\n  COUNT( DISTINCT l.USER_NAME) AS UNIQ_USER,\n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USER,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nWHERE\n  (\n  (upper(QUERY_TEXT) LIKE '%COPY FILE%') OR\n  (upper(QUERY_TEXT) LIKE '%COPY INTO%')\n  )\nGROUP BY\n  QUERY_DATE,\n  APPLICATION_NAME\n\n```\n\n-----\n\n##### Data Staging\n\n###### Description\n\n Analysis of queries with commands that are often associated with data staging prior to exfil.\n\n Warnings About FP/Noise\n\n In-house services and accounts may have back-up tasks associated with the staging commands (also with the compression commands in another section). We had to filter out for QUERY_TEXT LIKE ‘%NOISE%’ for Kafka, spark_connector, S3, and others. Additional useful stacks to help with this can be stacking on date and OUTBOUND_DATA_TRANSFER_CLOUD, and looking for spikes in AWS/AZURE etc. and then pivoting from there.\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\n-----\n\n###### Query 1: Stats on Queries with Data Staging per User\n\n Query\n\n\nUnset\n```\nSELECT\n  l.USER_NAME AS USERNAME,\n  QUERY_TYPE,\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  (\n  upper(QUERY_TEXT) LIKE '%ALTER STAGE%' OR\n  upper(QUERY_TEXT) LIKE '%ALTER VOLUME%' OR\n  upper(QUERY_TEXT) '%CREATE STAGE%' OR\n  upper(QUERY_TEXT) '%CREATE VOLUME%' OR\n  upper(QUERY_TEXT) '%LS %' OR\n  upper(QUERY_TEXT) '%DROP %'\n  )\nGROUP BY\n  USERNAME\n\n```\n\n-----\n\n###### Query 2: Stats on Queries with Data Staging per IP Address\n\n Query\n\n\nUnset\n```\nSELECT\n  l.CLIENT_IP AS IP,\n  QUERY_TYPE,\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\n  COUNT( DISTINCT l.USER_NAME) AS UNIQ_USER,\n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USER,\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  (\n  upper(QUERY_TEXT) LIKE '%ALTER STAGE%' OR\n  upper(QUERY_TEXT) LIKE '%ALTER VOLUME%' OR\n  upper(QUERY_TEXT) '%CREATE STAGE%' OR\n  upper(QUERY_TEXT) '%CREATE VOLUME%' OR\n  upper(QUERY_TEXT) '%LS %' OR\n  upper(QUERY_TEXT) '%DROP %'\n  )\nGROUP BY\n  IP\n\n```\n\n-----\n\n###### Query 3: Stats on Queries with Data Staging per Applications Used\n\n Query\n\n\nUnset\n```\nSELECT\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  QUERY_TYPE,\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\n  COUNT( DISTINCT l.USER_NAME) AS UNIQ_USER,\n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USER,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  (\n  upper(QUERY_TEXT) LIKE '%ALTER STAGE%' OR\n  upper(QUERY_TEXT) LIKE '%ALTER VOLUME%' OR\n  upper(QUERY_TEXT) '%CREATE STAGE%' OR\n  upper(QUERY_TEXT) '%CREATE VOLUME%' OR\n  upper(QUERY_TEXT) '%LS %' OR\n  upper(QUERY_TEXT) '%DROP %'\n  )\nGROUP BY\n  APPLICATION_NAME\n\n```\n\n-----\n\n##### Data Streams Outbound\n\n###### Description\n\n Analysis of queries to identify CREATE or ALTER STREAMS commands to detect the configuration and potential use of outbound data streams.\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\n-----\n\n###### Query 1: Stats on Queries Involving Data Streams per User\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  l.USER_NAME AS USERNAME,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nWHERE\n  ((upper(QUERY_TEXT) LIKE '%CREATE STREAM%') OR (upper(QUERY_TEXT) LIKE\n'%ALTER STREAM%')) OR\n  QUERY_TYPE IN ('CREATE_STREAM', 'ALTER_STREAM')\nGROUP BY\n  QUERY_DATE,\n  USERNAME\n\n```\n\n###### Query 2: Stats on Queries Involving Data Streams per IP Address\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  l.CLIENT_IP AS IP,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n\n```\n\n-----\n\n```\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nWHERE\n  ((upper(QUERY_TEXT) LIKE '%CREATE STREAM%') OR (upper(QUERY_TEXT) LIKE\n'%ALTER STREAM%')) OR\n  QUERY_TYPE IN ('CREATE_STREAM', 'ALTER_STREAM')\nGROUP BY\n  QUERY_DATE,\n  IP\n\n```\n\n###### Query 3: Stats on Queries Involving Data Streams per Applications name\n\n Query\n\n\nUnset\n```\nSELECT\n  DATE(START_TIME) AS QUERY_DATE,\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n\n```\n\n-----\n\n```\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history ON l.EVENT_ID = s.LOGIN_EVENT_ID\nWHERE\n  ((upper(QUERY_TEXT) LIKE '%CREATE STREAM%') OR (upper(QUERY_TEXT) LIKE\n'%ALTER STREAM%')) OR\n  QUERY_TYPE IN ('CREATE_STREAM', 'ALTER_STREAM')\nGROUP BY\n  QUERY_DATE,\n  APPLICATION_NAME\n\n```\n\n##### Manual Data Retrieval\n\n###### Description\n\n Analysis of queries containing commands often associated with manual exfiltration of data or fetching of files that have been compressed/staged.\n\n Warnings About FP/Noise\n\n Check query type by stacking on filtered as GET_FILES to filter out noise, then re-run unstacked.\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n\n\n-----\n\n|DAY_COUNT|Count of unique days active per grouped variation|\n|---|---|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\n###### Query 1: Stats on Queries Involving Data Retrieval per User\n\n Query\n\n\nUnset\n```\nSELECT \n  l.USER_NAME AS USERNAME,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  TO_NUMBER((TOTAL_QUERIES/DAY_COUNT), 10, 2) AS AVG_QUERY_PER_DAY,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n\n```\n\n-----\n\n```\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  (upper(QUERY_TEXT) LIKE '%PUT FILES%')\n  OR upper(QUERY_TEXT) LIKE '%GET FILES%'\n  OR QUERY_TYPE = 'GET_FILES'\nGROUP BY\n  USERNAME\n\n```\n\n###### Query 2: Stats on Queries Involving Data Retrieval per IP Address\n\n Query\n\n\nUnset\n```\nSELECT\n  l.CLIENT_IP AS IP,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  TO_NUMBER((TOTAL_QUERIES/DAY_COUNT), 10, 2) AS AVG_QUERY_PER_DAY,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USER,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  (upper(QUERY_TEXT) LIKE '%PUT FILES%')\n\n```\n\n-----\n\n```\n  OR upper(QUERY_TEXT) LIKE '%GET FILES%'\n  OR QUERY_TYPE = 'GET_FILES'\nGROUP BY\n  IP\n\n```\n\n###### Query 3: Stats on Queries Involving Data Retrieval per Application Name\n\n Query\n\n\nUnset\n```\nSELECT\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  TO_NUMBER((TOTAL_QUERIES/DAY_COUNT), 10, 2) AS AVG_QUERY_PER_DAY,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USER,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nWHERE\n  (upper(QUERY_TEXT) LIKE '%PUT FILES%')\n  OR upper(QUERY_TEXT) LIKE '%GET FILES%'\n  OR QUERY_TYPE = 'GET_FILES'\nGROUP BY\n  APPLICATION_NAME\n\n```\n\n-----\n\n### Network Analysis\n\n##### Network Traffic Spikes\n\n###### Description\n\n Originally set to be various network-based analysis; however, after a few passes it was deemed that brute force and logon fail-rate analysis were the only high-fidelity approaches.\n\n Warnings About FP/Noise\n\n Later evaluation of data and discussion with Snowflake showed that values for BYTES_SENT_OVER_NETWORK and other seemingly network-based metrics are not entirely accurate. For this reason they were omitted from this section. The fields tend to be populated so you can search away as you desire; just know that those metrics should not be used as a basis for byte-count reported to client regarding exfiltration.\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n\n\n-----\n\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|---|---|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\n###### Query 1: Identify Logon Attempts (Failed and Successful)\n\n Query\n\n\nUnset\n```\nWITH FAIL_IPS AS (\n  SELECT l.CLIENT_IP AS IP\n  FROM snowflake.account_usage.login_history\n  WHERE NOT IS_SUCCESS = 'YES'\n  GROUP BY IP\n)\nSELECT\n  DATE(EVENT_TIMESTAMP) AS QUERY_DATE,\n  CLIENT_IP AS IP,\n  COUNT(DISTINCT USER_NAME) AS UNIQ_USERS,\n  COUNT_IF(IS_SUCCESS = 'YES') AS SUCCEED_COUNT,\n  COUNT_IF(IS_SUCCESS = 'NO') AS FAIL_COUNT,\nFROM snowflake.account_usage.login_history l\n  JOIN FAIL_IPS f ON f.IP = l.CLIENT_IP\nGROUP BY\n  QUERY_DATE,\n  IP\n\n```\n\n-----\n\n### User Analysis\n\n##### Abnormal Application Names\n\n###### Description\n\n Frequency analysis of the application names used in running queries.\n\n Potential Attacker Trends\n\n Combined analysis (these methodologies and others in this document) revealed the attacker using multiple applications for different stages of their attack. In our particular engagement, we observed DBeaver being used for the initial enumeration (primarily \"SHOW\" commands), with more fine-tuned queries executed by a .jar file, and finally large exfiltration executed by the SnowSQL app.\n\n Warnings About FP/Noise\n\n Snowflake has some parsing issues with the values stored in their CLIENT_ENVIRONMENT json blob. One value was stored as \"C:\\Program\", which is believed to have resulted from parsing issues with the space in \"program files\". For values that parse wrong for application name, the json blob also includes versions of java/python etc. (as appropriate), and we were able to get the specific version of the jar file used by the attacker.\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n\n\n-----\n\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|---|---|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\n###### Query 1: Pivot on OS\n\n Query\n\n\nUnset\n```\nTH2-A USER, IP, OS by app name, version\nSELECT\n  REPORTED_CLIENT_TYPE,\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  SPLIT_PART(CLIENT_APPLICATION_ID, ' ', 1) AS APP_NAME_TMP,\n  CASE\n     WHEN REGEXP_LIKE(CLIENT_APPLICATION_ID, 'Snowflake UI .+') THEN 'N/A'\n     ELSE CLIENT_APPLICATION_VERSION\n  END AS APP_VERSION,\n  COUNT(CLIENT_APPLICATION_VERSION) AS HIT_COUNT,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS,\n  ARRAY_UNIQUE_AGG(l.CLIENT_IP)AS ARR_IP,\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,\n  ARRAY_UNIQUE_AGG(l.USER_NAME) AS ARR_USER,\n  COUNT( DISTINCT l.USER_NAME) AS UNIQ_USER\nFROM snowflake.account_usage.query_history q\n\n```\n\n-----\n\n```\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nGROUP BY\n  REPORTED_CLIENT_TYPE,\n  APPLICATION_NAME,\n  APP_NAME_TMP,\n  APP_VERSION\nORDER BY\n  REPORTED_CLIENT_TYPE,\n  APPLICATION_NAME,\n  APP_NAME_TMP,\n  APP_VERSION\n\n```\n\n###### Query 2: Identify/Pivot per IP\n\n Query\n\n\nUnset\n```\nSELECT\n  REPORTED_CLIENT_TYPE,\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  SPLIT_PART(CLIENT_APPLICATION_ID, ' ', 1) AS APP_NAME_TMP,\n  CASE\n     WHEN REGEXP_LIKE(CLIENT_APPLICATION_ID, 'Snowflake UI .+') THEN 'N/A'\n     ELSE CLIENT_APPLICATION_VERSION\n  END AS APP_VERSION,\n  l.CLIENT_IP AS IP_ADDR,\n  COUNT(CLIENT_APPLICATION_VERSION) AS HIT_COUNT,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS,\n  ARRAY_UNIQUE_AGG(l.USER_NAME),\n\n```\n\n-----\n\n```\n  COUNT( DISTINCT l.USER_NAME) AS UNIQ_USER\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nGROUP BY\n  REPORTED_CLIENT_TYPE,\n  APPLICATION_NAME,\n  APP_NAME_TMP,\n  APP_VERSION,\n  IP_ADDR\nORDER BY\n  UNIQ_USER DESC\n\n```\n\n###### Query 3: Identify/Pivot per User\n\n Query\n\n\nUnset\n```\nSELECT\n  REPORTED_CLIENT_TYPE,\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  SPLIT_PART(CLIENT_APPLICATION_ID, ' ', 1) AS APP_NAME_TMP,\n  CASE\n     WHEN REGEXP_LIKE(CLIENT_APPLICATION_ID, 'Snowflake UI .+') THEN 'N/A'\n     ELSE CLIENT_APPLICATION_VERSION\n  END AS APP_VERSION,\n  l.USER_NAME AS USERNAME,\n  COUNT(CLIENT_APPLICATION_VERSION) AS HIT_COUNT,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nUNIQ_OS,\n  ARRAY_UNIQUE_AGG(l.CLIENT_IP),\n  COUNT( DISTINCT l.CLIENT_IP) AS UNIQ_IP,\n\n```\n\n-----\n\n```\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\nq.LOGIN_EVENT_ID\nGROUP BY\n  REPORTED_CLIENT_TYPE,\n  APPLICATION_NAME,\n  APP_NAME_TMP,\n  APP_VERSION,\n  USERNAME\nORDER BY\n  UNIQ_IP DESC\n\n```\n\n##### Average User Sessions\n\n###### Description\n\n Sessions are tied to individual user logons, so multiple logins for any given username will generate multiple session IDs. Given that most client services are crafted to login and execute a specific purpose on a recurring basis, an attacker may logon multiple times for various different reasons. Sessions per username spikes may indicate anomalous use.\n\n Warnings About FP/Noise\n\n A count of unique session IDs per IP per day can also show meaningful data for analysis. Care should be taken as to the volume of IPs in your dataset before proceeding.\n\n Running a distinct count of IPs, or distinct IPs per day/week/month, can help identify whether your IP volume will be problematic for an extended query or not. An additional WHERE filter to exclude all IPs where distinct session ID count <2 can also remove high volumes.\n\n Stacking Field Definition\n\n|Field Name|Field Defni ition|\n|---|---|\n|CLIENT_IP / IP|IP address running queries|\n|USERNAME|Name of the user account that ran the query|\n|APPLICATION_NAME|The name of the application that ran queries, from CLIENT_ENVIRONMENT|\n\n\n-----\n\n|EARLIEST_UTC|First time, grouped variation was observed, normalized to UTC as a string|\n|---|---|\n|LATEST_UTC|Last time, grouped variation was observed, normalized to UTC as a string|\n|UNIQUE_QUERIES|Count of unique queries per grouped variation|\n|TOTAL_QUERIES|Count of total queries per grouped variation|\n|DAY_COUNT|Count of unique days active per grouped variation|\n|UNIQ_USER|Count of unique users per grouped variation|\n|ARR_UNIQ_USER|Array of users that ran queries per grouped variation|\n|UNIQ_APP_NAME|Count of unique application names per grouped variation|\n|ARR_APP_NAME|Array of application names per grouped variation|\n|UNIQ_OS|Count of unique operating systems per grouped variation|\n|ARR_OP_SYS|Array of operating systems per grouped variation|\n|UNIQ_IP|Count of unique IPs per grouped variation|\n\n\n###### Query 1: Stack by User\n\n Query\n\n\nUnset\n```\nSELECT\n  l.USER_NAME AS USERNAME,\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT(DISTINCT s.SESSION_ID) AS UNIQ_SESSIONS,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n\n```\n\n-----\n\n```\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nGROUP BY\n  QUERY_DATE,\n  USERNAME\n\n```\n\n###### Query 2: Stack by IP\n\n Query\n\n\nUnset\n```\nSELECT\n  l.CLIENT_IP AS IP,\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT(DISTINCT s.SESSION_ID) AS UNIQ_SESSIONS,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nGROUP BY\n  QUERY_DATE,\n  IP\n\n```\n\n-----\n\n###### Query 3: Stack by App\n\n Query\n\n\nUnset\n```\nSELECT\n  JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION') AS\nAPPLICATION_NAME,\n  DATE(START_TIME) AS QUERY_DATE,\n  COUNT(DISTINCT s.SESSION_ID) AS UNIQ_SESSIONS,\n  COUNT(DISTINCT QUERY_HASH) AS UNIQUE_QUERIES,\n  COUNT(QUERY_TEXT) AS TOTAL_QUERIES,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS EARLIEST_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', START_TIME)),'yyyy-mm-dd\nhh24:mi:ss') AS LATEST_UTC,\n  COUNT(DISTINCT DATE(START_TIME)) AS DAY_COUNT,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT,\n'APPLICATION')) AS ARR_APP_NAME,\n  COUNT(DISTINCT JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'APPLICATION'))\nAS UNIQ_APP_NAME,\n  ARRAY_UNIQUE_AGG(JSON_EXTRACT_PATH_TEXT(s.CLIENT_ENVIRONMENT, 'OS')) AS\nARR_OP_SYS\nFROM snowflake.account_usage.query_history q\n  JOIN snowflake.account_usage.sessions s ON s.session_id = q.session_id\n  JOIN snowflake.account_usage.login_history l ON l.EVENT_ID =\ns.LOGIN_EVENT_ID\nGROUP BY\n  QUERY_DATE,\n  APPLICATION_NAME\n\n```\n\n-----\n\n### Query for Temporary Stages and External URLs\n\n###### Description\n\n Unlike the majority of the tables in “snowflake.account_usage,” the “stages” view will show a table of all stages (Internal and External) historically created in that particular Snowflake instance. Columns include timestamps showing creation date, modification date, and deletion date, but most importantly the URL used to connect to a cloud environment if the stage was external. A review of these distinct stage URLs can quickly identify unauthorized connections previously or currently being made in the Snowflake environment.\n\n The below query pulls out all external URLs used for stages. STAGE_TYPE can include AWS, AZURE, etc. These can then be validated with the client to look for rogue stages.\n\n Note that this table also includes the names of stages that have been deleted. If the attacker creates and deletes a stage, the client will not necessarily be able to recover the stage, but there will be evidence of the creation/deletion of the stage and the URL it was pointed to.\n\n Query 1: Stage Name URL Where URL Is not NULL\n\n Query\n\n\nUnset\n```\nSELECT\n  STAGE_NAME,\n  STAGE_SCHEMA,\n  STAGE_CATALOG,\n  STAGE_URL,\n  STAGE_REGION,\n  STAGE_TYPE,\n  STAGE_OWNER,\n  TO_VARCHAR(MIN(CONVERT_TIMEZONE('UTC', CREATED)),'yyyy-mm-dd hh24:mi:ss')\nAS CREATE_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', LAST_ALTERED)),'yyyy-mm-dd\nhh24:mi:ss') AS LAST_ALTERED_UTC,\n  TO_VARCHAR(MAX(CONVERT_TIMEZONE('UTC', DELETED)),'yyyy-mm-dd hh24:mi:ss')\nAS DELETED_UTC,\n  COUNT(DISTINCT STAGE_ID) AS UNIQ_STAGE_ID,\n  ARRAY_UNIQUE_AGG(STAGE_ID) AS ARR_STAGE_ID\nFROM snowflake.account_usage.stages\nWHERE\n  STAGE_URL IS NOT NULL\nGROUP BY\n\n```\n\n-----\n\n```\n  STAGE_NAME,\n  STAGE_SCHEMA,\n  STAGE_CATALOG,\n  STAGE_URL,\n  STAGE_REGION,\n  STAGE_TYPE,\n  STAGE_OWNER\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        }
    ],
    "references": [
        "https://services.google.com/fh/files/misc/snowflake-threat-hunting-guide.pdf"
    ],
    "report_names": [
        "snowflake-threat-hunting-guide.pdf"
    ],
    "threat_actors": [
        {
            "id": "c3c24777-7c0f-4772-b273-2163ac5a6b67",
            "created_at": "2024-06-19T02:00:04.373472Z",
            "updated_at": "2025-03-27T02:00:03.381658Z",
            "deleted_at": null,
            "main_name": "UNC5537",
            "aliases": [],
            "source_name": "MISPGALAXY:UNC5537",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "358432a9-d927-43c7-9201-b7aa7d184c26",
            "created_at": "2024-06-20T02:02:10.317536Z",
            "updated_at": "2025-03-27T02:02:10.290108Z",
            "deleted_at": null,
            "main_name": "UNC5537",
            "aliases": [],
            "source_name": "ETDA:UNC5537",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1718848996,
    "ts_updated_at": 1743041669,
    "ts_creation_date": 0,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/fa72c567fe7851b63fd574d39a509d63d96a19bc.pdf",
        "text": "https://archive.orkl.eu/fa72c567fe7851b63fd574d39a509d63d96a19bc.txt",
        "img": "https://archive.orkl.eu/fa72c567fe7851b63fd574d39a509d63d96a19bc.jpg"
    }
}