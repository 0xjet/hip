{
    "id": "de998f9c-95c0-4290-9eb8-fdec93c2d5cb",
    "created_at": "2022-10-25T16:48:13.926748Z",
    "updated_at": "2025-03-27T02:06:08.610546Z",
    "deleted_at": null,
    "sha1_hash": "4d36058f8941c4a094989205b55b49c6e5a38d36",
    "title": "End-to-end Botnet Monitoring",
    "authors": "",
    "file_creation_date": "2019-12-07T08:35:14Z",
    "file_modification_date": "2019-12-07T08:35:14Z",
    "file_size": 1331733,
    "plain_text": "## End-to-end Botnet Monitoring…  Botconf 2019\n\n###### Kevin O’Reilly & Keith Jarvis\n\n Counter Threat Unit (CTU) Research Team\n\n\n-----\n\n## …With Automated Config Extraction and Emulated Network Participation \n\n\n-----\n\n##### Agenda\n\n###### What will we be discussing today?\n\n • Two distinct angles:\n\n • Sandbox\n\n • Emulator\n\n#### More than the sum of their parts?\n\n\n-----\n\n##### Emulator – Sandbox Synergy\n\n###### • Emulator inputs:\n Intelligence Requirements • C2 domains/IP addresses\n (IR’s)\n\n • RSA public keys\n • Version numbers\n Priority Intelligence\n Requirements\n\n • …\n (PIR’s)\n\n • Sandbox inputs:\n\nSpecific Intelligence\n\nRequirements (SIR’s) • Fresh samples!\n\n## 1\n\n|Col1|Col2|• Emulator inputs: ence R•e qu Cire 2m de ont ms ains/IP addresses (IR’s) • RSA public keys • Version numbers iority Intelligence Requir• em e…nts (PIR’s) • Sandbox inputs: pecific Intelligence Requir•em enFts resh samples! (SIR’s)|Col4|\n|---|---|---|---|\n|• Emulator inputs: Intelligence R•e qu Cire 2m de ont ms ains/IP add (IR’s) • RSA public keys • Version numbers Priority Intelligence Requir• em e…nts (PIR’s) • Sandbox inputs: Specific Intelligence Requir•em enFts resh samples! (SIR’s) 1||• Emulator inputs: ence R•e qu Cire 2m de ont ms ains/IP add (IR’s) • RSA public keys • Version numbers iority Intelligence Requir• em e…nts (PIR’s) • Sandbox inputs: pecific Intelligence Requir•em enFts resh samples! (SIR’s)||\n||• Emulator inputs: Intelligence R•e qu Cire 2m de ont ms ains/IP (IR’s) • RSA public key • Version numb Priority Intelligence Requir• em e…nts (PIR’s) • Sandbox inputs: Specific Intelligence Requir•em enFts resh samples (SIR’s)|• Emulator inputs: ence R•e qu Cire 2m de ont ms ains/IP (IR’s) • RSA public key • Version numb iority Intelligence Requir• em e…nts (PIR’s) • Sandbox inputs: pecific Intelligence Requir•em enFts resh samples (SIR’s)||\n|||||\n\n\n\n###### • Emulator inputs:\n Intelligence Requirements • C2 domains/IP addresses\n (IR’s)\n\n • RSA public keys\n • Version numbers\n Priority Intelligence\n Requirements\n\n • …\n (PIR’s)\n\n • Sandbox inputs:\n\nSpecific Intelligence\n\nRequirements (SIR’s) • Fresh samples!\n\n\n-----\n\n## Bots in the Sandbox\n\n\n-----\n\n##### Sandbox\n\n###### Essential Capabilities\n\n • Automated Unpacking\n\n • Configuration Decoding/Parsing\n\n\n-----\n\n##### CAPE Sandbox\n\n\n## 1\n\n|Col1|“Config And Pa|Col3|\n|---|---|---|\n||“Config And P||\n|• • • • •|Open Source Project - began 2015 Intelligence Requirements (IR’s) Derived from spender-sandbox • Itself derived from Cuckoo Sandbox (v1.3) Priority Intelligence Requirements (PIR’s) Overlap with Cuckoo today minimal Specific Intelligence https://github.com/kevoreilly/CAPE Requirements (SIR’s) Community version: https://capesandbox.com|in 2014|\n||1||\n\n\n###### Open Source Project - began 2015 Intelligence Requirements\n (IR’s)\n\n Derived from spender-sandbox\n Itself derived from Cuckoo Sandbox (v1.3) in 2014 Priority Intelligence\n Requirements\n (PIR’s)\n Overlap with Cuckoo today minimal\n\nSpecific Intelligence\n\n###### https://github.com/kevoreilly/CAPE Requirements\n\n(SIR’s)\n\n###### Community version: https://capesandbox.com\n\n\n-----\n\n##### Parallels With Manual Approach\n\n###### • Dynamic analysis\n\n • Victim machine/malware lab\n Intelligence Requirements\n\n • API monitor (IR’s)\n • Debugger\n • Dumper\n Priority Intelligence\n\n • Import reconstructor Requirements\n (PIR’s)\n\n • Static analysis\n\n • Disassembler for unpacked payload Specific Intelligence Requirements\n • YARA for detection (SIR’s)\n • Decoder or parser for configuration\n\n## 1\n\n\n\n###### • Dynamic analysis\n\n • Victim machine/malware lab\n Intelligence Requirements\n\n • API monitor (IR’s)\n • Debugger\n • Dumper\n Priority Intelligence\n\n • Import reconstructor Requirements\n (PIR’s)\n\n • Static analysis\n\n • Disassembler for unpacked payload Specific Intelligence Requirements\n • YARA for detection (SIR’s)\n • Decoder or parser for configuration\n\n\n-----\n\n##### The Sharpest Tool in the Sandbox?\n\n###### The Debugger\n\n • Powerful tool allowing instruction-level control\n • Processor (hardware) breakpoints\n\n • 4 breakpoints on read/write/execute\n • Single-step mode\n\n • Instruction traces\n • Trigger Actions:\n\n • Manipulate register/flag values\n • Dump payload or configuration\n • Set/clear further breakpoints\n • Set initial breakpoints via Yara signatures or API hooks\n\n\n-----\n\n##### Debugger-in-a-DLL\n\n###### In-process debugger \n\n • Within monitor DLL\n\n Intelligence Requirements\n (IR’s)\n Processor (hardware) breakpoints\n\n • Debug registers Dr0 – Dr7\n • 4 breakpoints (per-thread)\n Priority Intelligence\n\n • EXCEPTION_SINGLE_STEP\n Requirements\n (PIR’s)\n\n RtlDispatchException hook\n\nSpecific Intelligence\n\nRequirements\n\n###### SetThreadContext API (SIR’s)\n\n • NtGet/SetContextThread hook protection\n\n## 1\n\n\n\n###### • Within monitor DLL\n\n Intelligence Requirements\n\n • Processor (hardware) breakpoints (IR’s)\n\n • Debug registers Dr0 – Dr7\n • 4 breakpoints (per-thread)\n Priority Intelligence\n\n • EXCEPTION_SINGLE_STEP\n Requirements\n (PIR’s)\n\n • RtlDispatchException hook\n\nSpecific Intelligence\n\n###### • SetThreadContext API Requirements (SIR’s)\n\n • NtGet/SetContextThread hook protection\n\n\n-----\n\n##### Debugger demo\n\n###### QakBot Instruction Trace & Anti-VM Bypass\n\n\n-----\n\n## 1\n\n|Family Packages|Col2|\n|---|---|\n|• A whole package devoted to one malware family Intelligence Requirements • Handle specific behaviours (IR’s) • Have to have seen family before Priority Intelligence Requirements (PIR’s) • Future versions of family may break package Specific Intelligence Requirements (SIR’s)||\n|• A whole package devoted to one m Intelligence Requirements • Handle specific behaviours (IR’s) • Have to have seen family before Priority Intelligence Requirements (PIR’s) • Future versions of family may brea Specific Intelligence Requirements (SIR’s)||\n|1||\n\n\n###### A whole package devoted to one malware family\n Intelligence Requirements\n (IR’s)\n\n • Handle specific behaviours\n\n Priority Intelligence\n Have to have seen family before\n Requirements\n (PIR’s)\n\n Future versions of family may break package\n\nSpecific Intelligence\n\nRequirements\n\n(SIR’s)\n\n\n-----\n\n## 1\n\n|Behavioural Packages|Col2|\n|---|---|\n|• Capture payloads for a given behaviour: • Injection into other processes Intelligence Requirements • Extraction of code (IR’s) • Decompression of code Priority Intelligence • Not dependent on signatures or having seen malware before Requirements (PIR’s) • Captured payloads can then be detected by Yara signatures Specific Intelligence Requirements • If the extracted/injected payloads contain configuration data: (SIR’s) • Yara signature triggers configuration parser 1||\n|• Capture payloads for a given behaviour: • Injection into other processes Intelligence Requirements • Extraction of code (IR’s) • Decompression of code Priority Intelligence • Not dependent on signatures or having se Requirements (PIR’s) • Captured payloads can then be detected b Specific Intelligence Requirements • If the extracted/injected payloads contain (SIR’s) • Yara signature triggers configuration p 1||\n|||\n\n\n\n###### • Injection into other processes\n Intelligence Requirements\n\n • Extraction of code\n (IR’s)\n\n • Decompression of code\n\n Priority Intelligence\n Not dependent on signatures or having seen malware before Requirements\n (PIR’s)\n\n Captured payloads can then be detected by Yara signatures\n\nSpecific Intelligence\n\nRequirements\n\n(SIR’s)\n\n###### If the extracted/injected payloads contain configuration data:\n\n • Yara signature triggers configuration parser\n\n\n-----\n\n##### Compression Package\n\n###### • Simplest package\n • Captures PE payload decompressed by RtlDecompressBuffer function:\n\n```\nHOOKDEF(NTSTATUS, WINAPI, RtlDecompressBuffer, CompressionFormat, UncompressedBuffer, UncompressedBufferSize, CompressedBuffer,\nCompressedBufferSize, FinalUncompressedSize) {\n  NTSTATUS ret = Old_RtlDecompressBuffer(CompressionFormat, UncompressedBuffer, UncompressedBufferSize,\n            CompressedBuffer, CompressedBufferSize, FinalUncompressedSize);\n  if (NT_SUCCESS(ret)) {\n    DoOutputDebugString(\"RtlDecompressBuffer hook: scanning region 0x%x size 0x%x for PE image(s).\\n\", UncompressedBuffer,\n      *FinalUncompressedSize);\n      DumpPEsInRange(UncompressedBuffer, *FinalUncompressedSize);\n  }\n  return ret;\n}\n\n```\n\n-----\n\n## 1\n\n|Col1|‘Injection’ Package|Col3|\n|---|---|---|\n||||\n|• • •|Captures payloads injected into other proces Intelligence Requirements Uses API hooks (IR’s) • Track newly created processes and threa • Injected directly Priority Intelligence • WriteProcessMemory, NtWriteVirtu Requirements • Process hollo(P wIR i’ ns) g • NtMapViewOfSection • Transacted hollowing Specific Intelligence Requirements (SIR’s) Dumps prior to execution • NtResumeProcess/NtResumeThread 1|ses ds alMemory, etc|\n||||\n\n\n###### Intelligence Requirements\n Uses API hooks  (IR’s)\n\n • Track newly created processes and threads\n • Injected directly \n Priority Intelligence\n\n • WriteProcessMemory, NtWriteVirtualMemory, etc Requirements\n • Process hollowing (PIR’s)\n\n • NtMapViewOfSection\n • Transacted hollowing Specific Intelligence\n\nRequirements\n\n(SIR’s)\n\n###### Dumps prior to execution\n\n • NtResumeProcess/NtResumeThread\n\n\n-----\n\n## 1\n\n|‘Extraction’ Package|Col2|Col3|\n|---|---|---|\n|• Captures payloads ‘extracted’ inside processes Intelligence Requirements • Tracks executable memory regions (IR’s) • Newly allocated • New executable permissions Priority Intelligence Requirements • Uses debugger br(ePaIRk’sp) oints • Write breakpoints • Capture payloads just after they have been written Specific Intelligence • Execut iR oe nqu i bre rm een ats k points (SIR’s) • Capture payloads before they are executed|||\n||Captures payloads ‘extracted’ inside processe Intelligence Requirements Tracks executable memory regions (IR’s) • Newly allocated • New executable permissions Priority Intelligence Requirements Uses debugger br(ePaIRk’sp) oints • Write breakpoints • Capture payloads just after they Specific Intelligence • Execut iR oe nqu i bre rm een ats k points (SIR’s) • Capture payloads before they ar||\n||1||\n\n\n###### Intelligence Requirements\n Tracks executable memory regions\n (IR’s)\n\n • Newly allocated\n • New executable permissions\n Priority Intelligence\n Requirements\n Uses debugger breakpoints (PIR’s)\n\n • Write breakpoints\n\n •\n\nSpecific Intelligence\n\n###### • Execution breakpoints Requirements (SIR’s)\n\n • Capture payloads before they are executed\n\n\n-----\n\n##### Emotet\n\n\n###### Intelligence Requirements\n (IR’s)\n\n Priority Intelligence\n Requirements\n (PIR’s)\n\nSpecific Intelligence\n\nRequirements\n\n(SIR’s)\n\n\n## 1\n\n|Col1|Col2|Col3|Col4|\n|---|---|---|---|\n|||||\n|||||\n|||||\n\n\n###### Intelligence Requirements\n (IR’s)\n\n Priority Intelligence\n Requirements\n (PIR’s)\n\nSpecific Intelligence\n\nRequirements\n\n(SIR’s)\n\n\n-----\n\n##### Emotet Automated Unpacking\n\n###### Intelligence Requirements\n (IR’s)\n\n Priority Intelligence\n Requirements\n (PIR’s)\n```\nAllocationHandler: Adding allocation to tracked region list: 0x003E0000, size: 0x11000.\n\n```\nSpecific Intelligence\n```\nActivateBreakpoints: TrackedRegion->AllocationBase: 0x003E0000, TrackedRegion->RegionSize: 0x11000, thread 2664 Requirements\n\n```\n(SIR’s)\n```\nSetDebugRegister: Setting breakpoint 0 hThread=0xdc, Size=0x2, Address=0x003E0000 and Type=0x1.\nSetThreadBreakpoint: Set bp 0 thread id 2664 type 1 at address 0x003E0000, size 2 with Callback 0x74af7510.\nActivateBreakpoints: Set write breakpoint on empty protect address: 0x003E0000\n\n## 1\n\n```\n|Col1|Intelligence Requirements (IR’s) Priority Intelligence Requirements (PIR’s)|Col3|Col4|Col5|\n|---|---|---|---|---|\n|||Intelligence Requirements (IR’s) Priority Intelligence Requirements (PIR’s)|||\n|||AllocationHandler: Adding allocation to tracked re Specific Intelligence ActivateBreakpoints: RTerqaucirekmedeRnetsg ion->AllocationBase (SIR’s) SetDebugRegister: Setting breakpoint 0 hThread=0xd SetThreadBreakpoint: Set bp 0 thread id 2664 type ActivateBreakpoints: Set write breakpoint on empty|gion l : 0x00 c, Siz 1 at a prote 1|ist: 0x003E0000, size: 0x11000. 3E0000, TrackedRegion->RegionSize: 0x11000, thread 2664 e=0x2, Address=0x003E0000 and Type=0x1. ddress 0x003E0000, size 2 with Callback 0x74af7510. ct address: 0x003E0000|\n||||||\n\n\n###### Intelligence Requirements\n (IR’s)\n\n Priority Intelligence\n Requirements\n (PIR’s)\n\n\n-----\n\n##### Emotet Automated Unpacking\n```\nCAPEExceptionFilter: breakpoint hit by instruction at 0x75FE9B60 (thread 2664)\nBaseAddressWriteCallback: Breakpoint 0 at Address 0x003E0000.\nContextSetDebugRegister: Setting breakpoint 2 within Context, Size=0x0, Address=0x003E0000 and Type=0x0.\nBaseAddressWriteCallback: byte written to 0x3e0000: 0x1d. Intelligence Requirements\nBaseAddressWriteCallback: Exec bp set on tracked region protect address. (IR’s)\nCAPEExceptionFilter: breakpoint hit by instruction at 0x003E0000 (thread 2664)\nShellcodeExecCallback: Breakpoint 2 at Address 0x003E0000 - about to scan region for a PE image (base 0x003E0000, size 0x11000).\n\n###### Priority Intelligence\nScanForDisguisedPE: PE image located at: 0x3e053f\n Requirements\nDumpImageInCurrentProcess: Attempting to dump 'raw' PE image.\n (PIR’s)\nDumpPE: PE file in memory dumped successfully\n\n```\nSpecific Intelligence\n\nRequirements\n\n(SIR’s)\n\n## 1\n\n|Col1|Col2|Col3|Col4|Col5|\n|---|---|---|---|---|\n|CA Ba Co Ba Ba CA Sh Sc Du|P s n s s P e a m|EExceptionFilter: breakpoint hit by instruction a eAddressWriteCallback: Breakpoint 0 at Address 0x textSetDebugRegister: Setting breakpoint 2 within Intelligence Requirements eAddressWriteCallback: byte written to 0x3e0000: eAddressWriteCallback:( IREx’esc) bp set on tracked reg EExceptionFilter: breakpoint hit by instruction a llcodeExecCallback: Breakpoint 2 at Address 0x003 Priority Intelligence nForDisguisedPE: PE image located at: 0x3e053f Requirements pImageInCurrentProcess: Attempting to dump 'raw' (PIR’s)|t 0x75F 003E000 Contex 0x1d. ion pro t 0x003 E0000 - PE imag|E9B60 (thread 2664) 0. t, Size=0x0, Address=0x003E0000 and Type=0x0. tect address. E0000 (thread 2664) about to scan region for a PE image (base 0x003E0000, size 0x11000). e.|\n||mpPE: PE file in memory dumped successfully Specific Intelligence Requirements (SIR’s) 1|pPE: PE file in memory dumped successfully Specific Intelligence Requirements (SIR’s)|||\n\n\n## 1\n\n\nSpecific Intelligence\n\nRequirements\n\n(SIR’s)\n\n\n-----\n\n##### Emotet Config Extraction\n\n```\nrule Emotet\n{\n  meta:\n    cape_type = \"Emotet Payload\" Intelligence Requirements\n\n```\n`strings:` (IR’s)\n```\n    $snippet = {33 C0 21 05 ?? ?? ?? ?? A3 ?? ?? ?? ?? 39 05 ?? ?? ?? ?? 74 18 40 A3 ?? ?? ?? ?? 83 3C C5 ?? ?? ?? ?? 00 75}\n  condition:\n    uint16(0) == 0x5A4D and ($snippet)\n\n###### Priority Intelligence\n}\n Requirements\n (PIR’s)\nrefc2list = yara_scan(filebuf, '$snippet')\nc2list_va_offset = int(refc2list['$snippet'])\nc2_list_va = struct.unpack('i', filebuf[c2list_va_offset+15:c2list_va_offset+19])[0]\nc2_list_rva = c2_list_va - image_base Specific Intelligence\n\n```\nRequirements\n```\nc2_list_offset = pe.get_offset_from_rva(c2_list_rva)\n\n```\n(SIR’s)\n```\nwhile 1:\n  ip = struct.unpack('<I', filebuf[c2_list_offset:c2_list_offset+4])[0]\n  c2_address = socket.inet_ntoa(struct.pack('!L', ip))\n  port = str(struct.unpack('H', filebuf[c2_list_offset+4:c2_list_offset+6])[0])\n  self.reporter.add_metadata('address', c2_address+':' + port)\n\n```\n`c2_list_offset += 8` **1**\n\n\n-----\n\n## 1\n\n|Col1|QakBot|Col3|\n|---|---|---|\n||||\n|• ru { F8 00 }|Extraction package extracts: • Main executable payload Intelligence Requirements • DLL embedd(eIRd’s i)n resources le QakBot Priority Intelligence meta: Requirements (PIR’s) cape_type = \"QakBot Payload\" strings: $anti_vm = {8D 4D FC 51 E8 ?? ?? ?? ?? 83 C4 04 E8 EB 08 33 C0 74 02 EB FA 33 C0 8B E5 5D C3} Specific Intelligence $decrypt_config = {8B 45 08 8B 88 24 04 00 00 51 8B Requirements } (SIR’s) condition: uint16(0) == 0x5A4D and any of them 1|?? ?? ?? ?? 85 C0 7E 07 C7 45 F8 00 00 00 00 33 D2 74 02 EB FA 8B 45 55 10 83 EA 14 52 8B 45 0C 83 C0 14 50 6A 14 8B 4D 0C 51 E8 6C 08 00|\n\n\n###### Extraction package extracts:\n\n • Main executable payload\n Intelligence Requirements\n\n • DLL embedded in resources (IR’s)\n```\nrule QakBot\n\n Priority Intelligence\n\n```\n`meta:` Requirements\n```\n    cape_type = \"QakBot Payload\" (PIR’s)\n  strings:\nF8 EB 08 33 C0 74 02 EB FA 33 C0 8B E5 5D C3}\n\n```\nSpecific Intelligence\n\nRequirements\n\n(SIR’s)\n```\n  condition:\n    uint16(0) == 0x5A4D and any of them\n\n```\n\n-----\n\n##### QakBot Config Extraction\n\n###### Dedicated family package triggered\n\n • Breakpoints: Intelligence Requirements\n (IR’s)\n\n • Anti-VM bypass\n • Dump 2 x config region\n\n Priority Intelligence\n```\nDumpSize = (SIZE_T)*(DWORD*)((BYTE*)ExceptionInfo->ContextRecord->Esp+4*3); Requirements\n\n (PIR’s)\nDumpAddress = (PVOID)*(DWORD*)((BYTE*)ExceptionInfo->ContextRecord->Esp+4*4);\nCAPEExceptionFilter: breakpoint hit by instruction at 0x004054AF\n0x4054af (05) e86c080000        CALL 0x871 Specific Intelligence\nTrace: CALL detected, grabbing size 0x2b and buffer 0x3bcff10 from stack. Requirements\n\n```\n(SIR’s)\n```\nCAPEExceptionFilter: breakpoint hit by instruction at 0x004054B4\n0x4054b4 (03) 83c414          ADD ESP, 0x14\nDumpMemory: CAPE output file successfully created: C:\\iaDUZcSim\\CAPE\\2580_70260233749341954122019\nAdded new CAPE file to list with path: C:\\iaDUZcSim\\CAPE\\2580_70260233749341954122019\nTrace: dumped QakBot config from 0x3bcff10.\n\n## 1\n\n```\n|Col1|Col2|Col3|\n|---|---|---|\n|• Du Du CA 0x Tr CA 0x Du Ad Tr|Dedicated family package triggered • BreIantkeplloigienntcse: Requirements (IR’s) • Anti-VM bypass • Dump 2 x config region Priority Intelligence Requirements mpSize = (SIZE_T)*(DWORD*)((BYTE*)ExceptionInfo->ContextR (PIR’s) mpAddress = (PVOID)*(DWORD*)((BYTE*)ExceptionInfo->Contex PEExceptionFilter: breakpoint hit by instruction at 0x004 4054af (05) e86c080000 CALL 0x871 Specific Intelligence ace: CALL detected, gRreaqbubirienmge nstsi ze 0x2b and buffer 0x3bcff (SIR’s) PEExceptionFilter: breakpoint hit by instruction at 0x004 4054b4 (03) 83c414 ADD ESP, 0x14 mpMemory: CAPE output file successfully created: C:\\1iaDUZ ded new CAPE file to list with path: C:\\iaDUZcSim\\CAPE\\25 ace: dumped QakBot config from 0x3bcff10.|ecord->Esp+4*3); tRecord->Esp+4*4); 054AF 10 from stack. 054B4 cSim\\CAPE\\2580_70260233749341954122019 80_70260233749341954122019|\n\n\n-----\n\n##### The Future…\n\n###### • CAPE v2 just released\n\n\n## 1\n\n|• CAPE v2 just released • Python 3 • A huge thank you to Andriy Brukhove Intelligence Requirements • https://github.com/kevoreilly/CAPEv2 (IR’s) • (KVM hardended anti-anti-vm: https://github.com/doomedraven/To Priority Intelligence Requirements • Behavioural packages combined (PIR’s) • Enabled by default • Reduce executions to maximum of 2 Specific Intelligence Requirements (SIR’s) • Expanded Debugger options • Family-specific “package” all within Y|Col2|Col3|tskyy (@d00m3dr4v3n) – FireEye ols/blob/master/Virtualization/kvm-qemu.sh) ARA signature|\n|---|---|---|---|\n||• Python 3 • A huge thank you to Andriy Bruk Intelligence Requirements • https://github.com/kevoreilly/C (IR’s) • (KVM hardended anti-anti-vm: https://github.com/doomedra Priority Intelligence Requirements • Behavioural packages combined (PIR’s) • Enabled by default • Reduce executions to maximum Specific Intelligence Requirements (SIR’s) • Expanded Debugger options • Family-specific “package” all wit|||\n|||ven/To||\n|||of 2 hin Y||\n|1||||\n\n\n\n###### •\n Intelligence Requirements\n\n • https://github.com/kevoreilly/CAPEv2\n (IR’s)\n\n • (KVM hardended anti-anti-vm:\n\n Priority Intelligence\n Requirements\n Behavioural packages combined (PIR’s)\n\n • Enabled by default\n • Reduce executions to maximum of 2\n\nSpecific Intelligence\n\nRequirements\n\n(SIR’s)\n\n###### Expanded Debugger options\n\n • Family-specific “package” all within YARA signature\n\n\n-----\n\n## 1\n\n|Col1|Ursnif/ISFB|Col3|\n|---|---|---|\n|rule { m dumpt dump- s E0 01 00} 08 41 }|Ursnif3 Intelligence Requirements eta: (IR’s) cape_type = \"Ursnif Payload\" cape_options = \"dll=Debugger.dll,step-out=$cryp ype0=0x24, base-on-api=RtlAddVectoredExceptionHandle on-api-type=0x25\" Priority Intelligence trings: Requirements $crypto32 = {8B C3 83 EB 01 85 C0 75 0D 0F B6 16 8 (PIR’s) 03 D2 85 C0 0F 84 AB 01 00 00 8B C3 83 EB 01 85 C0 8 $golden_ratio = {8B 70 EC 33 70 F8 33 70 08 33 30 81 F9 84 00 00 0S0p}e cific Intelligence Requirements condition: (SIR’s) uint16(0) == 0x5A4D and (all of them)|to32, dumpsize=eax,action0=dumpebx, r, dump-on-api=RtlAddVectoredExceptionHandler, 3 C6 01 89 74 24 14 8D 58 07 8B C2 C1 E8 07 83 9 5C 24 20 75 13 0F B6 16 83 C6 01 BB 07 00 00 83 C0 04 33 F1 81 F6 B9 79 37 9E C1 C6 0B 89 70|\n||1||\n\n\n-----\n\n## Botnet Emulator Framework\n\n\n-----\n\n###### y\n\n • Botnet participation allows retrieval of artefacts and context\n unavailable from samples\n • Long-term tracking of targeting and operational details\n\n • Vetting indicators with high-fidelity\n\n • Synergy with config extraction for class of malware with features\n unavailable in ordinary sandbox detonation \n\n\n-----\n\n-----\n\n###### • Less data than you think to store years of\n botnet interactions\n • Save everything! verbose logging, HTTP\n sessions, etc.\n • Database is under 100 GB\n\n • Local EBS volume is 100 GB\n\n • S3 storage is 230 GB\n\n\n-----\n\n###### Cost\n\n •• EC2: $30/mo S\n • RDS: $60/mo\n • S3:  $5/mo\n • EBS: $10/mo\n\n • VPS: $30/mo\n • VPN: $20/mo\n\n\n# $255\n\n### per month\n\n\n-----\n\n###### • Make traffic and behaviour near replica of actual bot\n\n • Generate plausible but contrived metadata (e.g., computer and\n domain names)\n • Withstand competent non-state investigation\n\n • Non-attributable infrastructure unless subject to subpoena\n\n • Log timestamps and egress IP addresses for future correlation\n\n\n-----\n\n###### g\n\n • Use a combination of Tor, VPS, and commercial VPNs\n\n • Geographic diversity is great for empirically finding geofencing\n\n • Simple round robin is largely suitable\n\n • VPN microservice allows an emulator to request specific\n regions/countries and capabilities\n\n\n-----\n\n###### g\n\n • Don’t (intentionally) trash someone else’s IP space\n\n • VPNs WILL ban you (no refund)\n\n • Beware the Internet do-gooder\n\n • Few if any allow outbound TCP 25 (necessary for Cutwail)\n\n • By product is good intel source of VPN exit nodes\n\n\n-----\n\n###### • “ChatOps” notifications to analysts\n\n • Email distribution lists (third parties, LE, working groups)\n • Intelligence platforms\n\n • High fidelity blacklists\n\n\n-----\n\n###### y\n\n • OpenSSH SOCKS5 server is unstable during high throughput\n\n • Use Dante, open source SOCKS5 server\n\n • Protect with iptables and configuration-level filters and\n authentication\n\n\n-----\n\n###### y\n\n • Reasons to not use Requests\n\n • Protocol violations ⇉ Uncommon in malware\n • Absent SOCKS support ⇉ Added in 2016\n • Custom header ordering ⇉ Use OrderedDict()\n • Provide IP address for request ⇉ Patch Requests\n • Access to endpoint SSL certificate ⇉ Patch Requests\n\n\n-----\n\n###### g\n\n • Nature of system allows tracking of DNS resolutions over time\n\n • Augment this data with passive DNS (Farsight)\n\n • Useful for C2 with flaky DNS but stable hosting\n\n • Need to be careful with C2 living in fast-flux systems\n\n\n-----\n\n###### g\n\n • Save unique certificates as they appear and associate with IP\n\n • Flowsynth to generate PCAP from X.509, check coverage\n\n • Augment other data sets like Censys, Shodan, or SONAR\n\n\n-----\n\n###### g\n\n • Regularly retrieve sinkhole list from abuse.ch SinkDB\n • Detect common sinkhole-related HTTP features\n • Avoiding sinkholes saves execution times and prevents poisoning other researchers’ data\n • BitSight won’t track us down and try to sell us a report about our emulator being infected with dangerous malware\n\n\n-----\n\n###### g\n\n • Always prune your list of C2 servers\n • General formula: has the C2 accepted connections in two weeks? Given a valid response in past month?\n\n\n-----\n\n###### • Register bot, interrogate C2, dispose of bot\n • Instead, store registered bots and periodically reconnect them to create pool of long-lived “infections”\n • Good way to get additional payloads to “mature” bots\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.botconf.eu/wp-content/uploads/2019/12/B2019-OReilly-Jarvis-End-to-end-Botnet-Monitoring.pdf"
    ],
    "report_names": [
        "B2019-OReilly-Jarvis-End-to-end-Botnet-Monitoring.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716493,
    "ts_updated_at": 1743041168,
    "ts_creation_date": 1575707714,
    "ts_modification_date": 1575707714,
    "files": {
        "pdf": "https://archive.orkl.eu/4d36058f8941c4a094989205b55b49c6e5a38d36.pdf",
        "text": "https://archive.orkl.eu/4d36058f8941c4a094989205b55b49c6e5a38d36.txt",
        "img": "https://archive.orkl.eu/4d36058f8941c4a094989205b55b49c6e5a38d36.jpg"
    }
}