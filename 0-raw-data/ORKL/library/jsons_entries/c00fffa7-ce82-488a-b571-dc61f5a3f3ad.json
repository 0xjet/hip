{
    "id": "c00fffa7-ce82-488a-b571-dc61f5a3f3ad",
    "created_at": "2023-01-12T15:09:03.403963Z",
    "updated_at": "2025-03-27T02:09:29.46324Z",
    "deleted_at": null,
    "sha1_hash": "468c30e1db3ff3443b52bc10931d34e91ab73c9a",
    "title": "2020-12-04 - Inside a .NET Stealer- AgentTesla",
    "authors": "",
    "file_creation_date": "2022-05-27T22:12:30Z",
    "file_modification_date": "2022-05-27T22:12:30Z",
    "file_size": 2758860,
    "plain_text": "# Inside a .NET Stealer: AgentTesla\n\n**inde.nz/blog/inside-agenttesla**\n\n[First seen in 2014, AgentTesla (S0331) is a .NET platformed stealer that has recently](https://attack.mitre.org/software/S0331/)\nsurpassed Emotet and Trickbot to become one of the most prevalent malware threats. At\n[present it is the #2 most submitted malware family submitted to the ANY.RUN sandbox](https://any.run/)\nservice, mostly thanks to the Emotet crew appearing to have taken an early Christmas\nvacation. From pray and spray spam runs through to more resourced campaigns targeting\ncritical infrastructure sectors, AgentTesla appears to have a wide variety of operators. Up\nuntil 2019 it was available through the website of the developer, www.agenttesla[.]com, as\nmoreorless a SaaS subscription that included 24x7 support, web management, delivery and\npacking services, and regular updates:\n\n\n-----\n\nPredictably, the service was sold with the disclaimer “Agent Tesla is a software for monitoring\n_your personal computer. It is not a malware. Please, don’t use for computers which is not_\n_access permission.”, in much the same fashion as open-source RAT’s and ransomware are_\ncautioned on GitHub as being “for educational purposes only”. While cracked and leaked\ncopies of the tool were always available through forums and marketplaces, their availability\nhas naturally exploded following closure of the official service.\n\n## Features\n\n[As a SaaS offering with a reported 6300+ customers (source: Krebs on Security), it was fair](https://krebsonsecurity.com/2018/10/who-is-agent-tesla/)\nto expect that the feature set and reliability of the tool would continually improve to remain\ncompetitive, meet customer requirements and stay ahead of defenses. Current features\ninclude:\n\nKeylogging, clipboard scraping and screenshot capture.\nCredential theft from a wide selection of browsers, VPN, FTP and email clients, and\nWindows credential stores.\nFTP, HTTP and SMTP exfiltration.\nTor proxying.\n\nOccasionally custom modules have been seen in samples, such as the WiFi credential\nstealer.\n\n## Delivery\n\nLike many varieties of malware, delivery is primarily via email. Compromised email\ncredentials are frequently used for sending, and messages utilise your garden variety\nlogistics, financial and current event templates. Most often we observe the AgentTesla\npayload attached to messages in an archive, but maldoc delivery is also commonplace. A full\nspectrum of payload delivery mechanisms are seen being employed by the maldocs,\nincluding links, macros, DDE commands and Office exploits (e.g. CVE-2017-11882 and\nCVE-2017-8570).\n\nLoaders employ obfuscators/crypters for source protection and almost always .NET\nreflection to load the AgentTesla stealer, as will be illustrated in the following samples.\n\n\n-----\n\n## Email\n\nThe sample that we will first investigate in this post begins with a payment themed message\nthat leverages the branding of a Turkish garment company:\n\nAttached to the email is a zip file containing the payload: “swift copy.exe” (sha256:\n9d626bb9d442d3762e5366f0fbefae41708936b9c254141fcf3b0a1b80291ebb). The sample\n[is detected by 44 of 71 engines on VirusTotal (report) – so it’s not exactly low key.](https://www.virustotal.com/gui/file/9d626bb9d442d3762e5366f0fbefae41708936b9c254141fcf3b0a1b80291ebb/detection)\n\n## Test Environment\n\nThe sample is copied to a 64-bit Windows 7 analysis VM that is running a FileZilla FTP\nserver and has a handful of dummy accounts set up, including for CoreFTP:\n\n\n-----\n\nWe know that this is one of the tools that AgentTesla is capable of stealing credentials from,\nso it is expected that this will prompt the sample to attempt exfiltration.\n\n[The debugger used is dnSpy (https://github.com/dnSpy/dnSpy).](https://github.com/dnSpy/dnSpy)\n\n## Loader\n\n“PongGame” may seem like an odd choice of namespace for a loader, but this isn’t at all\nabnormal for the obfuscators used with AgentTesla. Naming conventions of legitimate\nprograms are often adopted and applied across metadata, namespaces, classes, methods\nand objects.\n\n\n-----\n\nThe loader imports System.Reflection, indicating .NET reflection is likely used to load\nadditional modules during unpacking:\n\nBefore stepping through the execution, we review the program resources, of which there are\ntwo that stand out. It is well known that AgentTesla makes heavy use of steganography, so it\nis safe to assume the single image (XDDVe) will at some point be passed through a\ndecoding routine. However, there is no reference to it in the loader:\n\n\n-----\n\nThere is also a long string that is preceded with TVqQ which is base64 for MZ, the magic\nnumber for the MS-DOS EXE format:\n\nA reference to this is seen in method “dddddddddddd”, where the value of this resource\nconverted from a URL string token to a byte array using\nSystem.Web.HttpServerUtility.UrlTokenDecode, and the byte array then loaded as an\nassembly. A breakpoint is set prior to the assembly being invoked and execution is run\nthrough to this:\n\n## Second Stage\n\nThis unpacked assembly is MARCUS.dll and the method that will first be invoked is\nJarico.Buta. The DLL is also obfuscated and has relatively few classes:\n\nA breakpoint is set on Jarico.Buta and execution is continued through to here:\n\n\n-----\n\nShortly after this is an image object is returned by a method that takes a resource name and\nproject name as parameters. Breaking at this point shows that the project and resource are\nthe loader and image:\n\nThe image is run through several decoding methods which produces an additional\nexecutable:\n\nStepping through a little further we see the executable is named “IDvurjJAoNJbsjjolQx” and\nthe entry point is the Main method:\n\n\n-----\n\n## Third Stage\n\nIDvurjJAoNJbsjjolQx is an obfuscated executable with a sizable resource named\n“YMh2sbk1276”:\n\nNo direct reference to this is found, however a method is found where a resource is loaded\ninto a byte array, so a breakpoint is set after the array has been formed:\n\n\n-----\n\nThe value of \\uE00C confirms that the loaded resource is what was expected. Contents of\nthis resource are passed through several decoding routines to produce another executable:\n\n## Unpacked Stealer\n\nThe memory section is dumped to disk and the resulting file – the AgentTesla stealer – is\nopened in a new dnSpy session. While still a little obfuscated, the source is relatively easy to\nread through:\n\n\n-----\n\nIn this sample, configuration items are extracted from a specific position (i.e. offset and\nlength) within a UTF8 byte array and converted to string format:\n\n\n-----\n\nWe can also set a breakpoint prior to HTTP POSTs or email messages being sent to obtain\nthe respective config (i.e. HTTP request or SMTP credentials):\n\nImports are made for the kernel functions required by the keylogger:\n\n\n-----\n\nAnd below these is the method that implements the keylogger:\n\n## Another Loader\n\nThis second sample illustrates a couple of different aspects of .NET malware: anti-tamper\nmeasures and persistence.\n\nUpon loading the sample into dnSpy and jumping to the module initialiser, we are presented\nwith decompiler errors intentionally resulting from the anti-decompiler measures\nimplemented by the obfuscator:\n\n\n-----\n\nAttempting to run the sample also fails and the method at the entry point of the program\nappears to be empty. While it is possible to remove these protections with dnSpy by editing\nthe IL instructions, a much faster method is simply running the payload and dumping the\nunpacked assemblies with a tool such as MegaDumper (https://github.com/CodeCrackerTools/MegaDumper):\n\n[Hollows Hunter (https://github.com/hasherezade/hollows_hunter) is also a useful tool in](https://github.com/hasherezade/hollows_hunter)\nsimilar situations.\n\nThis produced two executables and a handful of DLLs:\n\n\n-----\n\nThe smaller executable is AgentTesla and the larger is a loader.\n\n## Modules\n\nIn this case, the level of obfuscation is much lower than the previous sample, so more insight\ninto the capabilities can be gleamed thanks to cleaner class, method and attribute names\n(e.g. DPAPI, HttpToSocks5Proxy, SafariDecrypter, TorBrowser, VaultCli, etc):\n\n\n-----\n\nWhile the previous sample used the simple method of storing the configuration as plaintext in\na UTF8 byte array, this instead stores an encrypted configuration as a list of unsigned integer\narrays:\n\n\n-----\n\n## Persistence\n\nAmong the functions of the loader is setting up persistence via scheduled task. The bytes of\nthe current assembly are first written to a path under %APPDATA%:\n\nA scheduled task XML configuration is then formed, referencing the path of the dropped\nexecutable, and written out to a temporary text file:\n\n\n-----\n\nThe configuration is passed to schtasks.exe which sets up the scheduled task according to\nthe XML:\n\n\n-----\n\nIn effect, the scheduled task will run gnFZsnV.exe upon logon. Scheduled tasks aren’t a\nparticularly stealthy method of persistence, so should a suspected victim of AgentTesla be\ntriaged, the scheduled task will be highlighted by Sysinternals AutoRuns\n[(https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns):](https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns)\n\n## Detection and Mitigation\n\n**Mail: Given the predominant method of delivery is mail, robust mail filters, external**\nsender warnings and end-user education form a significant part of defense against\nAgentTesla.\n**Network: Depending on the capabilities of your firewall IPS, blocking traffic to known**\nTor nodes or traffic identified as Tor, combined with SMTP whitelisting, will help to\nprevent exfiltration. If your firewall supports TLS inspection, do it. FortiGate, ForcePoint\nand Palo Alto all have signatures for AgentTesla. Public IP lookups using the ipify\nservice are also a potential indicator.\n**Endpoint: Detection of AgentTesla is not difficult. Reputable EDR products, such as**\nDefender ATP and SentinelOne, will have you sleeping easy. There are also a number\nof hardening steps that can be taken to prevent the impact of maldocs, including\n[blocking the execution of macros and](https://www.microsoft.com/security/blog/2016/03/22/new-feature-in-office-2016-can-block-macros-and-help-prevent-infection/) [ASR rules to block Office child processes.](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/attack-surface-reduction)\n\n\n-----\n\n## Samples\n\nswift copy.exe (SHA256:\n2ba9db3110899e60daeecb086d4f53adc1cfab127820db3d230c383e74f7172c):\n[https://tria.ge/201201-lbk71xggyx](https://tria.ge/201201-lbk71xggyx)\nexe (SHA256:\nbd648199b17ff21db3d45cfd10eb3b70fdcbdf42c405061025de6cd1a59c212e):\n[https://tria.ge/201201-3yr3d6cakn](https://tria.ge/201201-3yr3d6cakn)\n\n## Want More?\n\nIf you enjoyed this blog post and want to follow other interesting malware finds that I make, I\nregularly share them on Twitter: [@phage_nz](https://twitter.com/phage_nz)\n\n**_If you'd like to find out more about how Inde can help detect this security threat, you_**\n**_can_** **_[contact us here.](https://www.inde.nz/contact-us)_**\n\nAbout the author\n\n**Chris Campbell**\n\nChris was that notoriously disobedient kid who sat at the back of the class and always\nseemed bored, but somehow still managed to ace all of his exams. Obsessed with the finer\ndetails and mechanics of everything in both the physical and digital realms, Chris serves as\nthe Security Architect within the Inde Security Team. His ventures into computer security\nbegan at an early age and haven't slowed down since. After a decade spent across security\nand operations, and evenings spent diving into the depths of malware and operating\nsystems, he brings a wealth of knowledge to Inde along with a uniquely adversary focused\napproach to defence. Like many others at Inde, Chris likes to unwind by hitting the bike trails\nor pretending to be a BBQ pitmaster.\n\n**COMMENTS**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-04 - Inside a .NET Stealer- AgentTesla.pdf"
    ],
    "report_names": [
        "2020-12-04 - Inside a .NET Stealer- AgentTesla.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536143,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1653689550,
    "ts_modification_date": 1653689550,
    "files": {
        "pdf": "https://archive.orkl.eu/468c30e1db3ff3443b52bc10931d34e91ab73c9a.pdf",
        "text": "https://archive.orkl.eu/468c30e1db3ff3443b52bc10931d34e91ab73c9a.txt",
        "img": "https://archive.orkl.eu/468c30e1db3ff3443b52bc10931d34e91ab73c9a.jpg"
    }
}