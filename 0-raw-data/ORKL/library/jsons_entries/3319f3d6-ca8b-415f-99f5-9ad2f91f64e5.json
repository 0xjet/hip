{
    "id": "3319f3d6-ca8b-415f-99f5-9ad2f91f64e5",
    "created_at": "2023-01-12T15:06:06.176207Z",
    "updated_at": "2025-03-27T02:05:50.462935Z",
    "deleted_at": null,
    "sha1_hash": "421a56a2ba4a2ad565bc7df45346255c9330d00d",
    "title": "2021-02-12 - New Bazar Trojan Variant is Being Spread in Recent Phishing Campaign – Part II",
    "authors": "",
    "file_creation_date": "2022-05-29T10:46:36Z",
    "file_modification_date": "2022-05-29T10:46:36Z",
    "file_size": 284109,
    "plain_text": "# New Bazar Trojan Variant is Being Spread in Recent Phishing Campaign – Part II\n\n**[fortinet.com/blog/threat-research/new-bazar-trojan-variant-is-being-spread-in-recent-phishing-campaign-part-II](https://www.fortinet.com/blog/threat-research/new-bazar-trojan-variant-is-being-spread-in-recent-phishing-campaign-part-II)**\n\nFebruary 12, 2021\n\n**[FortiGuard Labs Threat Research Report](https://www.fortinet.com/fortiguard/labs.html?utm_source=blog&utm_medium=campaign&utm_campaign=FortiGuardLabs)**\n\nAffected platforms: Microsoft Windows\n\nImpacted parties:  Windows Users\n\nImpact:           Control and Collect sensitive information from victim’s device, as well as\ndelivering other malware.\n\nSeverity level:      Critical\n\n[FortiGuard Labs recently detected a suspicious email through the SPAM monitoring system](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_medium=campaign&utm_campaign=FortiGuardLabs)\nthat was designed to trick a victim into opening a web page to download an executable file.\nAdditional research on this executable file found that it is a new variant of the Bazar\nmalware.\n\n\n-----\n\n[My analysis of this variant is being published in two parts. In the first part of the analysis, I](https://www.fortinet.com/blog/threat-research/new-bazar-trojan-variant-is-being-spread-in-recent-phishing-campaign-part-I)\nexplained how the Bazar loader was downloaded onto a victim’s device, how it\ncommunicates with its C2 server to obtain a Bazar file, and how that file is then injected into\na newly-created “cmd.exe” process.\n\nIn this second part, I will focus on the Bazar payload file that runs inside the “cmd.exe”\nprocess. You will learn what new anti-analysis techniques this Bazar uses, how it\ncommunicates with its C2 server, what sensitive data it is able to collect from the victim’s\ndevice, and how it is able to deliver other malware onto the victim’s system.\n\n## Main() function of the Bazar Payload\n\nThis variant of the Bazar payload is a 64-bit executable file written in Microsoft Visual C++\n8.0. It was compiled on Monday, Jan 18, 2021.\n\nIn its Main() function, we can see that it is driven by a “Timer” set by the API SetTimer() and\nthen captured by GetMessageA(). When a condition is matched, the working function is\ncalled once. The pseudocode of how they work together is shown in Figure 1.1, below.\n\nFigure 1.1. Pseudocode of the Main() function of Bazar\n\n## Anti-analysis Techniques\n\nI also observed three primary anti-analysis techniques being used throughout entire Bazar\nexecution. I will explain how each of these work.\n\n### 1. All key APIs are hidden\n\nBazar hides key APIs in the code and only uses them when it needs to call. A function that I\ncall get_api() is used to dynamically get an API address with the API name hash and its\nmodule index. The API address is carried in the RAX register when get_api() returns. More\nthan 600 APIs are obtained in this variant by using get_api(). Analyzing this API is\ncomplicated because nobody is able to read it via its name hash code. This really creates\ntrouble for researchers during both dynamic and static analysis.\n\nThe piece of ASM code shows below when it retrieves the API “TerminateProcess” with the\nname hash 0x9E6FA842 and module index 8. As stated earlier, the address is found in RAX\nwhen the API call returns.\n\nxor   ecx, ecx\n\nmov   edx, 1\n\nmov   r8d, 9E6FA842h ; The hash of API \"TerminateProcess\".\n\n\n-----\n\nmov   r9d, 8     ; An index of the module that contains TerminateProcess .\n\ncall  get_api\n\nmov   [rsp+698h+var_640], rax  ; “TerminateProcess” is in RAX.\n\n### 2. ASM Code Obfuscation\n\nIf you are curious about the code structure, the pseudocode (shown in Figure 1.1) looks so\nweird because Bazar uses a kind of code obfuscation technique. This is another barrier to\nthreat researchers in clearly tracking the code. Here is an example of how the ASM code is\nobfuscated.\n\nThe original code is below:\n\n_mov   [rsp+40h+var_18], rdx_\n\n_mov   rbp, [rsp+40h+var_18]_\n\n_cmp   rbp, 4_\n\n_jae   Lable_1_\n\n_mov   rdx, [rsp+40h+var_18]_\n\n_movzx  ebp, [rsp+rdx+40h+var_10]_\n\n_imul  ebp, -0Bh_\n\n_mov   ebx, ebp_\n\n_add   ebx, 273h_\n\n_[...]_\n\n_Lable_1:_\n\n_lea   rcx, [rsp+40h+arg_40]_\n\n_lea   rdx, [rsp+40h+var_10]_\n\n_call  sub_13F944B2E_\n\nAfter obfuscation, it becomes this (the original code is highlighted):\n\n_mov   ecx, 370A6DACh_\n\n_Label_0:_\n\n\n-----\n\n_mov   [rsp+40h+var_18], rdx_\n\n_mov   rbp, [rsp+40h+var_18]_\n\n_cmp   rbp, 4_\n\n_mov   ebp, 0B03F61D0h_\n\n_cmovb  ebp, ecx_\n\n_jmp   Label_1_\n\n_[…]_\n\n_Label_1:_\n\n_cmp   ebp, 0F7C9568Bh_\n\n_jg   short Label_2_\n\n_cmp   ebp, 0B03F61D0h_\n\n_jz    Label_3_\n\n_cmp   ebp, 0BAE74C5Ch_\n\n_jz   Label_5_\n\n_cmp   ebp, 0EC1D9526h_\n\n_jnz   short Label_1_\n\n_jmp   Label_4_\n\n_[…]_\n\n_Label_2:_\n\n_cmp   ebp, 0F7C9568Ch_\n\n_jz   Label_6_\n\n_cmp   ebp, 2BA792A4h_\n\n_jz   Label_0_\n\n_cmp   ebp, 370A6DACh_\n\n_jnz   short Label_1_\n\n\n-----\n\n_mov   rdx, [rsp+40h+var_18]_\n\n_movzx  ebp, [rsp+rdx+40h+var_10]_\n\n_imul  ebp, -0Bh_\n\n_mov   ebx, ebp_\n\n_add   ebx, 273h_\n\n_[…]_\n\n_Label_3:_\n\n_mov   ebp, 0EC1D9526h_\n\n_jmp   Label_1_\n\n_[…]_\n\n_Label_4:_\n\n_lea   rcx, [rsp+40h+arg_40]_\n\n_lea   rdx, [rsp+40h+var_10]_\n\n_call  sub_13F944B2E_\n\nAs you can see, the obfuscated ASM code was mixed with huge amounts of trash-like code\nwhile also becoming quite sophisticated in its logic. Almost every function in Bazar has had\nthis kind of obfuscation approach applied.\n\n### 3. All constant strings are encoded in Bazar\n\nAnother form of obfuscation affects the use of constant strings. Bazar’s constant strings are\nhidden in encrypted data throughout the code to perform anti-analysis.\n\nFigure 2.1. Just decrypted a constant string “POST”\n\nAccording to Figure 2.1, the encrypted data (“3C 37 4B 50 29”) was copied from the stack\nand decrypted to “POST” before using it.\n\n## Communicating with the C2 Server\n\nIn its working function, after Bazar does some initial work, such as setting environment\nvariables, creating mutex objects, loading APIs and setting global variables, it creates a\nthread to perform its tasks in the thread function.\n\n\n-----\n\nThe thread function connects to the C2 server and sends data to it. The C2 server host\nstrings are decrypted constant strings. They are \"miraclecarwashanddetall[.]com:443\" and a\ngroup of additional hosts: “caexidom[.]bazar”, “ektywyom[.]bazar”, “emliwyyw[.]bazar”,\n“uhymeked[.]bazar”, “ibykwyyw[.]bazar”, and “elicuhem[.]bazar\". Bazar prioritized connecting\nto the first C2 server host. It then attempts to connect to the others if the first one does not\nwork.\n\n### 1. Request\n\nThe traffic between Bazar and its C2 server is encrypted via SSL protocol. The following\nimage, Figure 3.1, was taken when the first request was about to be SSL-encrypted by\ncalling the API EncryptMessage().\n\nFigure 3.1. Bazar encrypts a packet via the SSL protocol\n\nAs you can see, this is a GET request. The URL “/cgi-bin/req5” is a decrypted constant\nstring, and the host is the first C2 server I mentioned above. There are also four “Cookies”:\n“fpzkgo”, “bcfs”, “hky” and “otxe”. Their names are random strings and only the value of\n“fpzkgo” is valid data. The others are random data.\n\nLet’s take a look what the value of “fpzkgo” consists of. According to my analysis, it has two\nparts, the Victim-ID and a command number. The Victim-ID for my testing device is\n“a9aadd987308f3a5b28d5a0c552c4324”. That is an MD5 hash code of a string of\ninformation obtained from my device, such as the computer name, the volume number of the\npartition, and Windows installation information.\n\nThe format of the report command is “/{Victim-ID}/{command number}”. The first “GET”\npacket’s command number is “2”. Therefore, the final command string is\n“/a9aadd987308f3a5b28d5a0c552c4324/2”.\n\nBazar then encrypts the command string in a 100H buffer using a private\nkey encryption technique that uses the RSA algorithm. Figure 3.2 shows both the plaintext\ndata at the top and the cipher text at the bottom.\n\nFigure 3.2. Using the RSA algorithm to encrypt the Victim-ID and command string\n\nFinally, Bazar base64 encodes the RSA encrypted data, which is the value of the “Cookies”\nitem “fpzkgo”, as shown in Figure 3.1.\n\nAll the command packets to the C2 server are enclosed in “Cookies” and use the same steps\nand algorithm to generate.\n\n### 2. Response\n\n\n-----\n\nOnce the C2 server receives and handles the malware request and notification, it replies to\nBazar. So, in this section, we will analyze the response packet. Referring to Figure 3.3, you\ncan see in the memory section that one response packet had just been decrypted from a\nSSL packet using the API, DecryptMessage().\n\nFigure 3.3. Display of received response packet\n\nThis response packet includes the item “Set-Cookies: jklo=…” in the header, whose value is\nbase64 encoded. After base64 decoding the value, Bazar gets an RSA-encrypted 100H long\nset of data. Using the C2 server’s public key, Bazar is able to decrypt this data set to get to\nthe command string from the C2 server. Figure 3.4 shows the RSA decrypted command\nstring, “0 302”, uncovered by calling the API BCryptDecrypt().\n\nThe “0” of “0 302” is the command number, and “302” is the command data.\n\nFigure 3.4. A decrypted C2 command string from the “Set-Cookies” item\n\nThis is pretty much the basic packet structure used for all other communication packets\nbetween Bazar and C2 server. I will talk about more control commands in next section.\n\n## Analyzing the Command and Control (C2)\n\nBazar is able to control the victim’s device with the commands it receives from the C2 server.\nIn the previous section, I identified the C2’s command “0” in the “0 302” string. By going\nthrough Bazar’s code, I have been able to identify that it supports the following C2 command\nnumbers: “0”, “1”, “10”, “11”, “12”, “13”, “14”, “15”, “16”, “17”, “18” and “100”.\n\nIn this section, I explain some of the known commands used in this malware, including what\nthe command packet consists of and the purpose of those commands being used.\n\nWhen Bazar needs to send whichever data the C2 server requests, it sends a “POST”\nrequest with the URL “/cgi-bin/req5”, the command number string enclosed in “Cookies”, and\nthe RAS-encrypted data in the “body” of the request.\n\nAs a reminder, the format of the report command is “/{Victim-ID}/{command number}” and the\nVictim-ID for my test device is “a9aadd987308f3a5b28d5a0c552c4324”.\n\n**Command 0:**\n\nThe C2 server asks Bazar to send the host string and port it is connecting to and the running\ntime of Bazar on the victim’s device. Below is an example of this data.\n\n\"\\r\\nVerBD 205\\r\\nmiraclecarwashanddetall.com:443\\r\\nuptime 232\". Bazar encrypts it\nusing its private key as the data in the “body” of the “POST” it sends to the C2 server.\n\n\n-----\n\n/a9aadd987308f3a5b28d5a0c552c4324/4 is enclosed in Cookies to provide the Victim-ID\nand command number.\n\n**Command 1:**\n\nThis command asks Bazar to collect data from victim’s system, like OS information, domain,\nuser name, public IP address, location and language, all software installed, network\ninformation, shared folders, a list of running processes, time zone, CPU information, hard\ndrive capacity, physical memory capacity, and whether Bazar is running in a VM.\n\nIt calls the APIs GetVersionExA() and GetProductInfo() to obtain the Windows’ Version and\nService Pack information.\n\nTo obtain the public IP address of the victim’s device, Bazar sends a STUN request (UDP\npacket) to one of Google’s STUN servers, such as \"stun2.l.google.com\", to retrieve the public\nIP address. Figure 4.1 is a Wireshark screenshot of the command requesting Bazar to send\nthe STUN packet.\n\nFigure 4.1. Obtaining the victim’s public IP address using the Google STUN service.\n\nBazar executes several commands to obtain network related information and domain trusts\nfrom the victim’s device. The commands are \"net view /all\", \"net view /all /domain\", and\n\"nltest.exe /domain_trusts /all_trusts\".\n\nIt then enumerates the system registry to collect the list of installed software on the victim’s\ndevice. Figure 4.2 is a screenshot of the system registry showing a partial list of installed\nsoftware under the sub-key\n“HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\”.\n\nFigure 4.2. Software information installed on the victim’s device\n\nBazar calls APIs CreateToolhelp32Snapshot(), Process32First(), Process32Next(), and\nOpenProcess() to collect information about the running processes on the victim’s system.\n\nBazar also performs some WMI query strings, such as \"Select * From Win32_Processor\",\n\"Select * From Win32_DiskDrive\", and \"Select * From Win32_PhysicalMemory\" to obtain\ninformation about the CPU, drive, and physical memory.\n\nIt obtains hard disk description from \"HKLM\n\\SYSTEM\\CurrentControlSet\\Services\\Disk\\Enum\" in the system registry. For my\nresearch environment (Oracle VM VirtualBox), it is\n“IDE\\DiskVBOX_HARDDISK___________________________1.0_____\\5&33d1638a&0&0.0.0”.\nBazar then searches for the key words \"VBOX\" and \"VMware\" to determine if Bazar is\nrunning on a VM.\n\n\n-----\n\nWhen this collection is done, it sends all of the gathered information in the body of the\n“POST” request to the C2 server. The report command string\n\"/a9aadd987308f3a5b28d5a0c552c4324/3\" is enclosed in “Cookies”. The image in figure 4.3\nshows the malware when it is about to encrypt the collected data by calling BCryptEncrypt().\n\nFigure 4.3. RSA algorithm used to encrypt the collected sensitive information from the\nvictim’s device.\n\n**Command 10, 11:**\n\nThese commands could contain a link to download other malware, or it could contain the\nmalware directly. Bazar injects this malware into one of the newly-created processes in the\nfollowing list, which are decrypted constant strings.\n\n\"c:\\windows\\system32\\calc.exe\"\n\"c:\\windows\\system32\\cmd.exe\"\n\"c:\\windows\\system32\\notepad.exe\"\n\"c:\\windows\\system32\\svchost.exe\"\n\"c:\\windows\\system32\\explorer.exe\"\n\"c:\\windows\\syswow64\\calc.exe\"\n\"c:\\windows\\syswow64\\explorer.exe\"\n\"c:\\windows\\syswow64\\cmd.exe\"\n\"c:\\windows\\syswow64\\svchost.exe\"\n\"c:\\windows\\syswow64\\notepad.exe\"\n\nIt then gives the C2 server a status update by replying with a message of “file not\ndownloaded”, ”loader started”, ”program is running”, or ”program start error” in a “POST”\nrequest together with a report command string of\n“/a9aadd987308f3a5b28d5a0c552c4324/3”.\n\n**Command 12, 13:**\n\nC2 server replies with a script file to Bazar in a command. Bazar then decrypts the script file\nand saves it to a Windows temporary folder. Finally, Bazar runs it by calling the API\nCreateProcessA().\n\nBazar notifies the C2 server of the status of the script by replying with a message of\n“program is running” or an error message of “program start error”, ”no script”, or ”no memory”\nwhen an error occurs.\n\nThe message is RSA-encrypted and posted as the “body” data of a “POST” request together\nwith a report command string of “/a9aadd987308f3a5b28d5a0c552c4324/3” enclosed in a\n“Cookies” value.\n\n**Command 16:**\n\n\n-----\n\nBazar reads a file path from the C2 server s command and collects the file s contents. It\nsends the collected data as the “body” of a “POST” request to back to the C2 server.\n\nThe report command string is “/a9aadd987308f3a5b28d5a0c552c4324/3”.\n\n**Command 17:**\n\nThe C2 server replies with a piece of native code that has been RSA-encrypted in the\ncommand. Bazar decrypts the native code (ASM code) using the C2 server’s public key and\ndeploys it on a newly-create thread to execute. To achieve this, it needs to call some APIs,\nsuch as VirtualAlloc(), memcpy(), VirtualProtect(), and CreateThread(). Figure 4.4 provices a\npartial view of the relevant ASM code.\n\nFigure 4.4. A code snippet of Bazar handling received native code.\n\nAs with other commands, it also replies with a status to the C2 server in a same way. The\nmessages could be “program is running” or an error status like “no code”, “no memory”, and\n“program start error”, etc.\n\n**Command 100:**\n\nWhen Bazar receives this command, it terminates itself by calling the API\nTerminateProcess().\n\n## Conclusion\n\nThe second part of this analysis is all about the Bazar payload that was downloaded by the\nBazar loader. I have shown the three primary anti-analysis techniques used by this Bazar\nvariant. Furthermore, I also showed how Bazar communicates with the C2 server, what\ncontrol commands Bazar supports, as well as what malicious things Bazar is able to do on a\nvictim’s device with those commands.\n\nAt this moment, this particular Bazar’s [phishing campaign is still active and are frequently](https://www.fortinet.com/resources/cyberglossary/phishing?utm_source=blog&utm_campaign=2020-q4-phishing)\nbeing captured by FortiGuard Labs.\n\n## Fortinet Protections\n\nFortinet customers are already protected from this Bazar variant with FortiGuard’s Web\nFiltering and AntiVirus services as follows:\n\nThe Bazar loader download URLs are rated as \"Malicious Websites\" by the FortiGuard\nWeb Filtering service.\n\nThe downloaded files are detected as \"W64/Bazar.CFI!tr\" and blocked by the FortiGuard\nAntiVirus service.\n\n\n-----\n\n[The FortiGuard AntiVirus service is supported by FortiGate,](https://www.fortinet.com/products/next-generation-firewall.html?utm_source=blog&utm_campaign=2018-q2-fortigate-main-page) [FortiMail, FortiClient](https://www.fortinet.com/products/email-security/fortimail.html?utm_source=blog&utm_campaign=2018-q2-fortimail-main-page)\n[and FortiEDR. The Fortinet AntiVirus engine is a part of each of those solutions. As a result,](https://www.fortinet.com/products/endpoint-security/fortiedr.html?utm_source=blog&utm_campaign=2020-q1-fortiedr)\ncustomers who have these products with up-to-date protections are protected.\n\n[We also suggest our readers to go through the free NSE training --](https://training.fortinet.com/local/staticpage/view.php?page=nse_1&utm_source=blog&utm_campaign=2020-q2-nse-1) NSE 1 – Information\nSecurity Awareness, which has a module on Internet threats designed to help end users\nlearn how to identify and protect themselves from phishing attacks.\n\n## IOCs:\n\n**URLs**\n\nhxxps[:]//miraclecarwashanddetall[.]com:443/cgi-bin/req5\n\nhxxps[:]//caexidom[.]bazar\n\nhxxps[:]//ektywyom[.]bazar\n\nhxxps[:]//emliwyyw[.]bazar\n\nhxxps[:]//uhymeked[.]bazar\n\nhxxps[:]//ibykwyyw[.]bazar\n\nhxxps[:]//elicuhem[.]bazar\n\n**References:**\n\nhttps://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor\n\n_[Learn more about FortiGuard Labs threat research and the FortiGuard Security](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_campaign=fortiguard-labs)_\n_[Subscriptions and Services portfolio.](https://www.fortinet.com/fortiguard/labs?tab=security-bundles&utm_source=blog&utm_campaign=security-bundles)_\n\n_Learn more about Fortinet’s_ _[free cybersecurity training initiative or about the Fortinet](https://www.fortinet.com/blog/business-and-technology/fortinet-offers-free-cybersecurity-training-courses?utm_source=blog&utm_campaign=free-cybersecurity-training-courses)_ _NSE_\n_Training program,_ _[Security Academy program, and](https://training.fortinet.com/local/staticpage/view.php?page=fnsa&utm_source=blog&utm_campaign=fnsa)_ _[Veterans program.](https://www.fortinet.com/corporate/careers/vets.html?utm_source=blog&utm_campaign=fortivet)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-02-12 - New Bazar Trojan Variant is Being Spread in Recent Phishing Campaign – Part II.pdf"
    ],
    "report_names": [
        "2021-02-12 - New Bazar Trojan Variant is Being Spread in Recent Phishing Campaign – Part II.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535966,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1653821196,
    "ts_modification_date": 1653821196,
    "files": {
        "pdf": "https://archive.orkl.eu/421a56a2ba4a2ad565bc7df45346255c9330d00d.pdf",
        "text": "https://archive.orkl.eu/421a56a2ba4a2ad565bc7df45346255c9330d00d.txt",
        "img": "https://archive.orkl.eu/421a56a2ba4a2ad565bc7df45346255c9330d00d.jpg"
    }
}