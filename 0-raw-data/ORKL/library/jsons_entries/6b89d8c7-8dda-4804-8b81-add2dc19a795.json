{
    "id": "6b89d8c7-8dda-4804-8b81-add2dc19a795",
    "created_at": "2022-10-25T16:48:20.911901Z",
    "updated_at": "2025-03-27T02:05:36.541754Z",
    "deleted_at": null,
    "sha1_hash": "91c2cdb099060388dd93b0e440a3ff4dff5fd622",
    "title": "Miniduke Still Duking It Out",
    "authors": "ESET",
    "file_creation_date": "2014-12-27T02:52:08Z",
    "file_modification_date": "2014-12-27T02:52:08Z",
    "file_size": 882069,
    "plain_text": "At the end of April Microsoft announced that a vulnerability in Word was actively being exploited. This\n\n[vulnerability occurred in parsing RTF files and was assigned CVE-2014-1761, a thorough analysis of which](http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2014-1761)\n\n[can be found on the HP Security Research blog. We have since seen multiple cases where this exploit is](http://h30499.www3.hp.com/t5/HP-Security-Research-Blog/Technical-Analysis-of-CVE-2014-1761-RTF-Vulnerability/ba-p/6440048#.U3Dtn_ldWX0)\n\nused to deliver malware and one was particularly interesting as it contained a new variant of MiniDuke\n\n[(also known as Win32/SandyEva).](http://virusradar.com/en/Win32_SandyEva/detail)\n\nMiniDuke was first discussed by Kaspersky in March 2013 in their paper The MiniDuke Mystery: PDF 0\n_[day Government Spy Assembler 0x29A Micro Backdoorand shortly after in a paper by Bitdefender. Some](http://labs.bitdefender.com/wp-content/uploads/downloads/2013/04/MiniDuke_Paper_Final.pdf)_\n\nof the characteristics of MiniDuke — such as its small size (20 KB), its crafty use of assembly\n\nprogramming, and the use of zero-day exploits for distribution — made it an intriguing threat. Although\n\nthe backdoor is still quite similar to its previous versions, some important changes were made since last\n\n[year, the most notable being the introduction of a secondary component written in JScript to contact a](https://en.wikipedia.org/wiki/JScript)\n\n[C&C server via Twitter.](http://www.virusradar.com/en/glossary/command-and-control-server)\n\n\n-----\n\nThe RTF exploit document\n\nThe exploit document was named Proposal-Cover-Sheet-English.rtf and is quite bland when compared to\n\n\n-----\n\nApril 8th, only three days after the compilation of the MiniDuke payload, dated April 5th in the PE header.\n\nThe payload remains quite small at only 24 KB.\n\nThe functionality of the shellcode which is executed by triggering the vulnerability is rather simple and\n\nstraightforward. After decrypting itself and obtaining the addresses of some functions exported by\n\nkernel32.dll, it decrypts and drops the payload in the %TEMP% directory in a file named “a.l” which is\n\nsubsequently loaded by calling kernel32!LoadLibraryA.\n\nAn interesting thing about the shellcode is that before transferring control to any API function it checks\n\nthe first bytes of the function in order to detect hooks and debugger breakpoints which may be set by\n\nsecurity software and monitoring tools. If any of these are found the shellcode skips the first 5 bytes of the\n\nfunction being called by manually executing prologue instructions (mov edi, edi; push ebp; mov ebp, esp)\n\nand then jumping to the function code as illustrated below.\n\nThe next graph presents the execution flow of this malware when the exploitation is successful. As\n\nmentioned previously this version of the MiniDuke payload comes with two modules which we refer to as\n\nthe main module and the TwitterJS module.\n\n\n-----\n\nExecution flow of MiniDuke\n\n## Main Component\n\n### Installation\n\nOnce MiniDuke receives control it checks that the host process is not rundll32.exe and whether the\n\ncurrent directory is %TEMP%. If either of those conditions is met the malware assumes it is run for the\n\nfirst time and it proceeds with its installation onto the system. MiniDuke gathers information about the\n\n[system and encrypts its configuration based on that information, a method also used by OSX/Flashback](http://go.eset.com/us/resources/white-papers/osx_flashback.pdf)\n\n(this process is called watermarking by Bitdefender). The end result is that it is impossible to retrieve the\n\nconfiguration of an encrypted payload if analyzing it on a different computer. The information collected on\n\ninfection has not changed since the previous version and consists of the following values:\n\nvolume serial number (obtained from kernel32!GetVolumeInformationA)\n\nCPU information (obtained with the cpuidinstruction)\n\ncomputer name (obtained from kernel32!GetComputerNameA)\n\nOnce the encrypted version of the malware is created, it is written into a file in the\n\n%ALLUSERSPROFILE%\\Application Data directory. The name of the file is randomly picked from the\n\n[following values (you can find this listing and those of the next screenshots on the VirusRadar description:](http://www.virusradar.com/en/Win32_SandyEva.G/description)\n\nThe filename extension is also picked randomly from the following list:\n\nTo persist on the infected system after reboots, the malware creates a hidden .LNK file in the “Startup”\n\ndirectory pointing to the modified main module. The name of the .LNK file is randomly drawn from the\n\n\n-----\n\nThe .LNKfile is created using a COM object with the IShellLinkA interface and contains the following\n\ncommand: “C:\\Windows\\system32\\rundll32.exe %path_to_main_module%, export_function” Which\n\ngives something like:\n\n_“C:\\Windows\\system32\\rundll32.exe C:\\DOCUME~1\\ALLUSE~1\\APPLIC~1\\data.cat, IlqUenn“._\n\n### Operation\n\nWhen the malware is loaded by rundll32.exe and the current directory isn’t %TEMP%, the malware starts\n\nwith gathering the same system information as described in the “Installation” section to decrypt\n\nconfiguration information. As with the previous version of MiniDuke, it checks for the presence of the\n\nfollowing processes in the system:\n\nIf any of these are found in the system the configuration information will be decrypted incorrectly, i.e. the\n\nmalware will run on the system without any communication to C&C servers. If the configuration data is\n\ndecrypted correctly, MiniDuke retrieves the Twitter page of @FloydLSchwartz in search of URLs by\n\nwhich to reach C&C server. It looks for the tag “X)))” on the page (MiniDuke was searching for “uri!” in\n\nprevious samples) and if the tag is found it decrypts a URL from the data that follows it. The Twitter\n\naccount @FloydLSchwartz does exist but has only retweets and no strings with the special tag.\n\n\n-----\n\nAs the next step, MiniDuke gathers the following information from the infected systems:\n\ncomputer name and user domain name\n\n[country code of the infected host IP address obtained from http://www.geoiptool.com](http://www.geoiptool.com/)\n\nOS version information\n\ndomain controller name, user name, groups a user account belongs to\n\na list of AV products installed onto the system\n\nInternet proxy configuration\n\nversion of MiniDuke\n\nThis information is then sent to the C&C server along with the request to download a payload. The final\n\nURL used to communicate with the C&C server looks like this: <url_start>/create.php?<rnd_param>=\n\n_<system_info> Those tokens are derived as follows:_\n\n_url_start – the URL retrieved from the twitter account_\n\n_rnd_param – randomly generated of lower case alphabet characters parameter name in the query_\n\n\n-----\n\n_system_info_ base64 encoded and encrypted system information\n\nAn example of such a URL is given below:\n\nThe payload is downloaded in the file named “fdbywu” using the urlmon!URLDownloadToFileA API:\n\nThe downloaded payload is a fake GIF8 file containing encrypted executable. The malware processes the\n\ndownloaded file in the same way as previous samples of MiniDuke: it verifies the integrity of the file using\n\nRSA-2048, then decrypts it, stores in a file and finally executes it. The RSA-2048 public key to verify\n\nintegrity of the executable inside the GIF file is the same as in the previous version of MiniDuke.\n\n### Twitter Generation Algorithm\n\nIn the event that MiniDuke is unable to retrieve a C&C URL from this account, it generates a username to\n\nsearch for based on the current date. The search query changes roughly every seven days and is similar to\n\nthe backup mechanism in previous versions that was using Google searches. A Python implementation of\n\nthe algorithm can be found in Appendix B.\n\n### TwitterJS component\n\n\n-----\n\ncode into it and redirecting the exported functions to this code. Here is how the export address table of the\n\npatched binary looks after modifications.\n\n[This file is then stored in an Alternate Data Stream (ADS) in NTUSER.DAT in the %USERPROFILE%](http://msdn.microsoft.com/en-us/library/windows/desktop/aa364404(v=vs.85).aspx)\n\nfolder. Finally this DLL is registered as the Open command when a drive is open, which has the effect of\n\nstarting the bot every time the user opens a disk drive. Below you can find the content of\n\nthe init.cmd script used by MiniDuke to install TwitterJS module onto the system.\n\nWhen loaded, TwitterJS instantiates the JScript COM object and decrypts a JScript file containing the\n\ncore logic of the module.\n\nPrior to executing it, MiniDuke applies a light encoding to the script: The next images show the result of\n\n\n-----\n\nthwart security systems that scan at the entry points of the JScript engine.\n\nResult of first obfuscation\n\nResult of second obfuscation\n\nThe purpose of this script is to use Twitter to find a C&C and retrieve JScript code to execute. It first\n\ngenerates a Twitter user to search for; this search term changes every 7 days and is actually a match to the\n\nreal account name, not the Twitter account name. The bot then visits the Twitter profiles returned by the\n\nsearch and looks for links that end with “.xhtml“. When one is found, it replaces “.xhtml” with “.php” and\n\nfetches that link. Information about the computer is embedded in the Accept HTTP header.\n\nThe first link on the retrieved page should contain base64 data; the name attribute of the link is used as a\n\nrolling XOR key to decrypt the JScript code. Finally, MiniDuke calculates a hash of the fetched script and\n\ncompares it with a hardcoded hash in the TwitterJS script. If they match, the fetched script is executed by\n\ncalling eval().\n\n### The tale of the broken SHA-1\n\nThe code hashing algorithm used by the component looks very much like SHA-1 but outputs different\n\nhashes (you can find the complete implementation in Appendix B. We decided to search for what was\n\n\n-----\n\nto make collisions feasible. We couldn t find an obvious difference; all the constants and the steps of the\n\nalgorithm were as expected. Then we noticed that for short messages only the second 32-bit word was\n\ndifferent when compared to the original SHA-1.\n\nSHA1(‘test’) : a94a8fe5ccb19ba61c4c0873d391e987982fbbd3\n\nTwitterJS_SHA1(‘test’) : a94a8fe5dce4f01c1c4c0873d391e987982fbbd3\n\nBy examining how this 2nd word was generated we finally discovered that this was caused by a scope\n\nissue. As shown below the SHA-1 function used a variable named f: the function Z() is then called which\n\nalso uses a variable named f without the var keyword, causing it to be treated as a global variable rather\n\nthan local to the function. The end result is that the value of f is also changed in the SHA-1 function which\n\naffects the value of the 2nd word for that round and ultimately the whole hash for long messages.\n\nA likely explanation of how this problem came to be is\n\nthat the variable names were changed to single letters\n\nusing an automated tool prior to embedding it in the\n\npayload. The 2 f variables probably had different names\n\nin the original script which avoided the issue. So this\n\nleaves us with two takeaways: 1) The difference in the\n\nhashing algorithm was unintentional and 2) Always\n\ndeclare your local variables with the var keyword. ;-)\n\n### Twitter DGA accounts\n\nWe generated the list of Twitter search terms for 2013-2014 and checked if any of those were registered.\n\nAt the moment only one exists, @AA2ADcAOAA, which is the TwitterJS account that was generated\n\nbetween August 21st and 27th 2013. This account has no tweets. In an effort to discover potential victims,\n\nwe registered the Twitter accounts corresponding to the current week both for the main and TwitterJS\n\ncomponents and set up tweets with encrypted URLs so that an infected computer would reach out to our\n\nserver. So far we have received connections via the TwitterJS accounts from four computers located in\n\nBelgium, France and the UK. We have contacted national CERTs to notify the affected parties. We detect\n\n[the RTF exploit document as Win32/Exploit.CVE-2014-1761.D and the MiniDuke components](http://virusradar.com/en/Win32_Exploit.CVE-2014-1761/detail)\n\n[as Win32/SandyEva.G.](http://www.virusradar.com/en/Win32_SandyEva.G/description)\n\n#### Appendix A: SHA-1 hashes\n\n|SHA-1|Description|\n|---|---|\n|58be4918df7fbf1e12de1a31d4f622e570a81b93|RTF with Word exploit CVE-2014-1761|\n\n\n-----\n\n9 9 9 9 9 j p\n\n**Appendix B &C: DGA algorithms, Twitter DGA accounts**\n\nThe DGA scripts and account lists have been moved to our Github account :\n\n[https://github.com/eset/malware-research/tree/master/miniduke](https://github.com/eset/malware-research/tree/master/miniduke)\n\n[Author ESET Research, ESET](http://www.welivesecurity.com/author/esetresearch/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/dnn3hp5nlwuiwxcqjc9kmsfiodcimi64",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2014/2014.05.20.Miniduke_Twitter_CnC/Miniduke_twitter.pdf"
    ],
    "report_names": [
        "Miniduke_twitter"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041136,
    "ts_creation_date": 1419648728,
    "ts_modification_date": 1419648728,
    "files": {
        "pdf": "https://archive.orkl.eu/91c2cdb099060388dd93b0e440a3ff4dff5fd622.pdf",
        "text": "https://archive.orkl.eu/91c2cdb099060388dd93b0e440a3ff4dff5fd622.txt",
        "img": "https://archive.orkl.eu/91c2cdb099060388dd93b0e440a3ff4dff5fd622.jpg"
    }
}