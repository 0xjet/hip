{
    "id": "2bef5e7c-6c3d-4223-b24b-f04b508790b1",
    "created_at": "2023-01-12T15:03:37.097125Z",
    "updated_at": "2025-03-27T02:06:00.012771Z",
    "deleted_at": null,
    "sha1_hash": "1f94ace10798e184eabc80cad285080b3adb3d9e",
    "title": "2021-11-10 - Use EVTX files on VirusTotal with Timesketch and Sigma (Part 2)",
    "authors": "",
    "file_creation_date": "2022-05-28T03:33:47Z",
    "file_modification_date": "2022-05-28T03:33:47Z",
    "file_size": 725810,
    "plain_text": "# Use EVTX files on VirusTotal with Timesketch and Sigma (Part 2)\n\n**[osdfir.blogspot.com/2021/11/use-evtx-files-on-virustotal-part2.html](https://osdfir.blogspot.com/2021/11/use-evtx-files-on-virustotal-part2.html)**\n\nAlexander Jäger\n\n## Use VirusTotal EVTX files to test / verify Sigma rules (Part 2)\n\n[This is the second part of a blog series. In the first part we covered manual and automated](https://osdfir.blogspot.com/2021/11/use-evtx-files-on-virustotal-part1.html)\nways to download a recently added feature of VirusTotal to download EVTX from Sandbox\nexecution. This second part explores ways to use a VirusTotal EVTX file to test a Sigma rule\nand adjust Sigma config in Timesketch to make the rule work. For this we will use a different\nsample than in part 1 that matches a rule that would not work out of the box in Timesketch.\n\n## Disclaimer\n\nMost of our other blog posts cover open source techniques. The API feature described in this\npost is part of a commercial offering from VirusTotal and is not available to free tier accounts.\nSimilar files could be created with Cuckoo Sandbox, an open source malware analysis\nsystem.\n\n## Sigma rule\n\nThis article assumes the reader is familiar with basic use of Sigma in Timesketch that was\n[covered in Sigma in Timesketch - let's rule the sketch. To get started we will use a Sigma](https://osdfir.blogspot.com/2020/11/sigma-in-timesketch-lets-rule-sketch.html)\n[rule that was developed by Florian Roth and mentioned in a recent talk as the number one](https://www.slideshare.net/FlorianRoth2/sigma-hall-of-fame-eu-attck-user-workshop-october-2021)\n[among his top 5 Sigma rules. The original rule is available on Github and licensed under the](https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/win_office_shell.yml)\n[DRL 1.1 license:](https://github.com/SigmaHQ/sigma/blob/master/LICENSE.Detection.Rules.md)\n\nDetects a Windows command and scripting interpreter executable started from Microsoft\nWord, Excel, Powerpoint, Publisher and Visio\n\nSuch a behavior is considered bad because it should be very rare that such files execute a\ncommand and is often used in phishing and ransomware cases to get the initial foothold.\n\nNow we need a sample, to find a matching one, we go to\n[https://support.virustotal.com/hc/en-us/articles/360017450757-Sigma-Rules-List and select](https://support.virustotal.com/hc/en-us/articles/360017450757-Sigma-Rules-List)\nthe link in the row for \"Microsoft Office Product Spawning Windows Shell\".\n\nIn the following Search field, we see the search for:\n\nsigma_rule:6a6edfdea6536f74ea66bf73682ed52f4b86435793ed76ff38e3ab0523f029f5\n\nTo find even better samples, we will add the following search parameters:\n\n\n-----\n\nhave:evtx p:15+\n\nAs we are only interested in samples that have EVTX to be downloaded and samples that\nare considered bad by more than 15 AV engines.\n\nThis reveals among others:\n[adf82ba6ea693dee892b190999cbbe4b6e70ed8d6a9c3e596457de04775bb396. We copy](https://www.virustotal.com/gui/file/adf82ba6ea693dee892b190999cbbe4b6e70ed8d6a9c3e596457de04775bb396)\nthe SHA-256 hash and go back to our shell and run the following command to download the\nEVTX file and create a new sketch (that was covered in part 1 of the blog series).\n\ndftimewolf vt_evtx_ts\nadf82ba6ea693dee892b190999cbbe4b6e70ed8d6a9c3e596457de04775bb396 /var/tmp/\n\nAfter the successful execution, visit the Timesketch instance and the sketch that was created\nwhich has around 11k events.\n\nUsing an new feature in Timesketch that helps compose new rules, we can copy the rule in a\ntext area:\n\n## Translated Sigma rule\n\nThe Sigma rule translated by Timesketch creates the following Query (from now on referred\nas Q1):\n\n(data_type:\"windows:evtx:record\" AND event_identifier:(\"1\" OR \"4688\") AND source_name:\n(\"Microsoft-Windows-Sysmon\" OR \"Microsoft-Windows-Security-Auditing\" OR \"MicrosoftWindows-Eventlog\") AND ParentImage:( *WINWORD.EXE OR *EXCEL.EXE OR\n*POWERPNT.exe OR *MSPUB.exe OR *VISIO.exe OR *OUTLOOK.EXE OR\n*MSACCESS EXE OR *EQNEDT32 EXE) AND xml string:( *cmd exe OR *powershell exe\n\n\n-----\n\nOR wscript.exe OR cscript.exe OR sh.exe OR bash.exe OR scrcons.exe OR\n*schtasks.exe OR *regsvr32.exe OR *hh.exe OR *wmic.exe OR *mshta.exe OR\n*rundll32.exe OR *msiexec.exe OR *forfiles.exe OR *scriptrunner.exe OR *mftrace.exe OR\n*AppVLP.exe OR *svchost.exe OR *msbuild.exe))\n\nIf we query Timesetch with the translated Sigma rule (Q1) no results (0 events) are returned.\nHowever the rule did yield results on VirusTotal.\n\nLet’s take a closer look at the Sigma rule and and determine why it is returning no results by\nquerying different parts of the rule independently. These parts are highlighted in bold below:\n\n(data_type:\"windows:evtx:record\" AND event_identifier:(\"1\" OR \"4688\") AND source_name:\n(\"Microsoft-Windows-Sysmon\" OR \"Microsoft-Windows-Security-Auditing\" OR \"MicrosoftWindows-Eventlog\") AND ParentImage:( *WINWORD.EXE OR *EXCEL.EXE OR\n*POWERPNT.exe OR *MSPUB.exe OR *VISIO.exe OR *OUTLOOK.EXE OR\n*MSACCESS.EXE OR *EQNEDT32.EXE) AND xml_string:( *cmd.exe OR *powershell.exe\nOR *wscript.exe OR *cscript.exe OR *sh.exe OR *bash.exe OR *scrcons.exe OR\n*schtasks.exe OR *regsvr32.exe OR *hh.exe OR *wmic.exe OR *mshta.exe OR\n*rundll32.exe OR *msiexec.exe OR *forfiles.exe OR *scriptrunner.exe OR *mftrace.exe OR\n*AppVLP.exe OR *svchost.exe OR *msbuild.exe))\n\nWe will start with data_type to see all events that have the field data_type set:\n\ndata_type:*\n\nThat will result in around 11k events. Given the whole sketch has 11 k events it can be\nassumed all events do have a data_type field, so that is not the problem. The next field to\ncheck is:\n\nevent_identifier:*\n\nAgain 11k events, next in the query is:\n\nsource_name:*\n\n10k events are shown, so not all events have a source_name, but that also does not not\nseem the problem. Now search for:\n\nParentImage:*\n\n0 events - now the last one seems problematic. No event has this key as an attribute. But the\ntranslated Sigma rule is checking for that field in an AND clause, so if no event has that field\nset, all the rest of the query could never find any results. Lets search if it exists in any event\nas part of a value and search for:\n\n*ParentImage*\n\n\n-----\n\nThe result is 1276 events which have a value that contains ParentImage. That looks much\nbetter, now open one event and use the Browser Search function to reveal where the term\nParentImage is mentioned - in the xml_string.\n\nTurns out that a lot of values are stored in this xml_string and that is why the\n[sigma_config.yaml has a lot of field mappings towards the xml_string. So what we would](https://github.com/google/timesketch/blob/master/data/sigma_config.yaml)\nneed to do is add the following line to it:\n\nParentImage: xml_string\n\n[Save the file and restart our web server and celery workers. This addition to the](https://timesketch.org/developers/getting-started/)\n[sigma_config_yml has already been added to Timesketch with the following Pull Request.](https://github.com/google/timesketch/pull/1996)\n\nRe-running the compose Sigma rule with the same rule content now gives the following\nquery:\n\n(data_type:\"windows:evtx:record\" AND event_identifier:(\"1\" OR \"4688\") AND source_name:\n(\"Microsoft-Windows-Sysmon\" OR \"Microsoft-Windows-Security-Auditing\" OR \"MicrosoftWindows-Eventlog\") AND xml_string:( *WINWORD.EXE OR *EXCEL.EXE OR\n*POWERPNT.exe OR *MSPUB.exe OR *VISIO.exe OR *OUTLOOK.EXE OR\n*MSACCESS.EXE OR *EQNEDT32.EXE) AND xml_string:( *cmd.exe OR *powershell.exe\nOR *wscript.exe OR *cscript.exe OR *sh.exe OR *bash.exe OR *scrcons.exe OR\n*schtasks.exe OR *regsvr32.exe OR *hh.exe OR *wmic.exe OR *mshta.exe OR\n*rundll32.exe OR *msiexec.exe OR *forfiles.exe OR *scriptrunner.exe OR *mftrace.exe OR\n*AppVLP.exe OR *svchost.exe OR *msbuild.exe))\n\nIf we query Timesketch with the adjusted Sigma rule, we get 4 results.\n\n\n-----\n\nAnd if we look closer into one of the events we can see the following signs of suspicious\ncommand (mixed upper- and lowercase, hidden command):\n\nC:\\Windows\\System32\\cmd.exe\" /C Powershell.exe -noexit -execUtionPoLiCy ByPAsS winDoWStYle hidDen -command $nhqId…\n\nWe could now store the Sigma rule file in the Timesketch folder according to the\n[documentation and run the analyzer and mark the events and future events in other](https://timesketch.org/guides/user/sigma/#sigma-rules)\ninvestigations. As we checked the rule and added mappings, we are also good to add an\n[entry to the central file called sigma_blocklist.csv in the Timesketch project by making a pull](https://github.com/google/timesketch/blob/master/data/sigma_blocklist.csv)\nrequest that keeps track of considered good, problematic and unchecked rules.\n\nYou can repeat the last steps for other rules with other samples, the Timesketch team highly\nappreciates contributions for the community to get more rules checked and validated with\nspecific samples so that they can be re-validated by other people.\n\n## How can this be used on a larger scale?\n\nAnother possibility is to download a larger set of event log files and then push them into our\nexisting SIEM and test our detection and / or log parsing pipeline. The advantage is that the\nprovided data is as diverse in structure, format and content as we could expect from our real\nendpoints.\n\nSaving and re-using the adjusted Sigma rules (the Timesketch team is working on reducing\nthose needs to adjust) will allow analysts to reproduce investigation steps more quickly and\nreliably, as they will not have to remember queries but simply run existing rules over the\nsketch.\n\nLearn more\n\nTo learn more about the VirusTotal EVTX information, visit the [VirusTotal EVTX API page.](https://developers.virustotal.com/v3.0/reference#file-behaviour-evtx)\n\n\n-----\n\n[If you have any questions please reach out on the Open Source DFIR Slack community.](https://github.com/open-source-dfir/slack)\n\n### Incident Response in the Cloud\n\n Parsing the $MFT NTFS metadata file\n\n Forensic Disk Copies in GCP & AWS\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-10 - Use EVTX files on VirusTotal with Timesketch and Sigma (Part 2).pdf"
    ],
    "report_names": [
        "2021-11-10 - Use EVTX files on VirusTotal with Timesketch and Sigma (Part 2).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535817,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1653708827,
    "ts_modification_date": 1653708827,
    "files": {
        "pdf": "https://archive.orkl.eu/1f94ace10798e184eabc80cad285080b3adb3d9e.pdf",
        "text": "https://archive.orkl.eu/1f94ace10798e184eabc80cad285080b3adb3d9e.txt",
        "img": "https://archive.orkl.eu/1f94ace10798e184eabc80cad285080b3adb3d9e.jpg"
    }
}