{
    "id": "e7fbbd4e-66e2-4333-98fd-7ab03b1127ea",
    "created_at": "2023-01-12T15:09:33.735124Z",
    "updated_at": "2025-03-27T02:05:42.011957Z",
    "deleted_at": null,
    "sha1_hash": "f76ba9fe61231f8474199a5a934676dc1ed9f955",
    "title": "2022-05-12 - Harmful Help- Analyzing a Malicious Compiled HTML Help File Delivering Agent Tesla",
    "authors": "",
    "file_creation_date": "2022-05-28T02:23:41Z",
    "file_modification_date": "2022-05-28T02:23:41Z",
    "file_size": 769936,
    "plain_text": "# Malicious Compiled HTML Help File\n\n**[unit42.paloaltonetworks.com/malicious-compiled-html-help-file-agent-tesla/](https://unit42.paloaltonetworks.com/malicious-compiled-html-help-file-agent-tesla/)**\n\nTyler Halfpop May 12, 2022\n\nBy [Tyler Halfpop](https://unit42.paloaltonetworks.com/author/tyler-halfpop/)\n\nMay 12, 2022 at 3:00 PM\n\n[Category: Malware](https://unit42.paloaltonetworks.com/category/malware-2/)\n\nTags: [AgentTesla,](https://unit42.paloaltonetworks.com/tag/agenttesla/) [anti-analysis](https://unit42.paloaltonetworks.com/tag/anti-analysis/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/malicious-compiled-html-help-file-agent-tesla/)\n\n## Executive Summary\n\nThis blog describes an attack that Unit 42 observed utilizing malicious compiled HTML help\nfiles for the initial delivery. We will show how to analyze the malicious compiled HTML help\nfile. We will then follow the chain of attack through JavaScript and multiple stages of\nPowerShell and show how to analyze them up to the final payload.\n\nThe attack is interesting because attackers are often looking for creative ways to deliver their\npayloads. Their purpose in doing so is twofold:\n\nAn attempt to bypass security products.\nAn attempt to bypass security training.\n\n\n-----\n\nPotential victims may have been trained to avoid documents, scripts and executables from\nunknown senders, but it is important to be careful of almost any filetype.\n\nThis particular attack chain delivered Agent Tesla as the final payload. Agent Tesla is wellknown malware that has been around for a while. Agent Tesla focuses on stealing sensitive\ninformation from a victim’s computer and sending that information to the attacker over FTP,\nSMTP or HTTP. It does this primarily via keystroke logging, screen capturing, camera\nrecording and accessing sensitive data.\n\nPalo Alto Networks customers are protected from malware families using similar antianalysis techniques with Cortex XDR or the Next-Generation Firewall with WildFire and\nThreat Prevention security subscriptions.\n\nRelated Unit 42 Topics [Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Agent Tesla,](https://unit42.paloaltonetworks.com/tag/agenttesla/) [anti-analysis](https://unit42.paloaltonetworks.com/tag/anti-analysis/)\n\n## Table of Contents\n\nMalicious Compiled HTML Help File\n\nInitial PowerShell\n\nSecond Stage\n\nFinal Agent Tesla Payload\n\nConclusion\n\nIndicators of Compromise\n\nThe initial attack sent a 7zip compressed file named ORDER OF CONTRACT-pdf.7z, which\ncontained the single malicious compiled HTML help file ORDER OF CONTRACT-pdf.chm\n(SHA256: 081fd54d8d4731bbea9a2588ca53672feef0b835dc9fa9855b020a352819feaa).\nWhen the victim opens the help file, this apparently innocuous window displays.\n\n\n-----\n\nFigure\n\n\n1. Decoy HTML help window.\n\n\n-----\n\nThe help file can be extracted using 7zip to view the contents. The interesting file is the\nkkjhk.htm file, which displays the decoy window and executes the code.\n\nFigure 2. The help file contents.\n\nThe file contains obfuscated JavaScript that is executed when the file is opened.\n\n\n-----\n\nFigure 3. Obfuscated JavaScript code in kkjhk.htm.\nWe can deobfuscate this code by opening the file in Chrome and using the Chrome\nDeveloper Tools. The code above shows that the result that is returned is stored in the r\nvariable. We can use the JavaScript debugger in Chrome Developer Tools to break on the\nreturn statement. After we have halted execution on our breakpoint we can then view the\ncontents of the r variable and copy that for further analysis.\n\n\n-----\n\nFigure 4. Debugging kkjhk.htm in Chrome Developer Tools.\nThe contents of the r variable show the HTML code to display the decoy message and a\ncommand to execute PowerShell.\n\nFigure 5. Deobfuscated contents of kkjhk.htm.\n\n## Initial PowerShell\n\nThe obfuscated PowerShell code is executed in the background when the file is opened.\n\n\n-----\n\nFigure 6. Initial obfuscated PowerShell.\nWe can deobfuscate this code so that we can read it more easily by removing the final\nobfuscated Invoke-Expression cmdlet (I E X()). Attackers often insert backticks into sensitive\ncommands like this to avoid simple string recognition because PowerShell ignores these\ncharacters. We can then see that the sample utilizes the PowerShell Test-Connection cmdlet\nto ping Google to verify connectivity before continuing. The sample then downloads and\nexecutes code from http://pk-consult[.]hr/N2.jpg.\n\nFigure 7. Deobfuscated initial PowerShell.\n\n## Second Stage\n\nThe downloaded content is not actually a jpeg, but rather further PowerShell code that is\nexecuted We can see below that it decompresses and loads several byte arrays in memory\n\n\n-----\n\nFigure 8. Second stage.\nWe can modify the sample simply to output the byte arrays to files by commenting out the\nexecution and writing them to files.\n\nFigure 9. Writing byte arrays to files.\n\n## Final Agent Tesla Payload\n\nWe are left with a loader DLL in $decompressedByteArray (SHA256:\n0fd2e47d373e07488748ac63d9229fdef4fd83d51cf6da79a10628765956de7a) and a gzip\ncompressed Agent Tesla in $vhRo (SHA256:\n\n\n-----\n\nc684f1a6ec49214eba61175303bcaacb91dc0eba75abd0bd0e2407f3e65bce2a). The loader\nDLL loads Agent Tesla into the RegAsm.exe process to execute.\n\nThis Agent Tesla sample uses FTP and connects to ftp.videoalliance[.]ru for data exfiltration.\n\n## Conclusion\n\nMalicious actors are often looking for creative or different ways to deliver their malicious\npayloads. Microsoft Compiled HTML files are another file format that can be abused by\nmalicious actors in addition to the more common document or script delivery methods used.\nIt is important to make sure that users are trained to be careful of any attachments,\nespecially from unknown senders.\n\nPalo Alto Networks customers are protected from malware families using similar anti[analysis techniques with Cortex XDR or the](https://www.paloaltonetworks.com/cortex/cortex-xdr) [Next-Generation Firewall with](https://www.paloaltonetworks.com/network-security/next-generation-firewall) [WildFire and](https://www.paloaltonetworks.com/products/secure-the-network/wildfire)\n[Threat Prevention cloud-delivered security subscriptions.](https://www.paloaltonetworks.com/network-security/threat-prevention)\n\n## Indicators of Compromise\n\n3446ec621506d87d372c596e1d384d9fd2c1637b3655d7ccadf5d9f64678681e ORDER OF\nCONTRACT-pdf.7z\n081fd54d8d4731bbea9a2588ca53672feef0b835dc9fa9855b020a352819feaa ORDER OF\nCONTRACT-pdf.chm\n9ba024231d4aed094757324d8c65c35d605a51cdc1e18ae570f1b059085c2454 N2.jpg\n0fd2e47d373e07488748ac63d9229fdef4fd83d51cf6da79a10628765956de7a GC.dll\nc684f1a6ec49214eba61175303bcaacb91dc0eba75abd0bd0e2407f3e65bce2a Agent Tesla\ndotNet executable\n\nhxxp://pk-consult[.]hr/N2.jpg\nftp.videoalliance[.]ru\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-12 - Harmful Help- Analyzing a Malicious Compiled HTML Help File Delivering Agent Tesla.pdf"
    ],
    "report_names": [
        "2022-05-12 - Harmful Help- Analyzing a Malicious Compiled HTML Help File Delivering Agent Tesla.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536173,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653704621,
    "ts_modification_date": 1653704621,
    "files": {
        "pdf": "https://archive.orkl.eu/f76ba9fe61231f8474199a5a934676dc1ed9f955.pdf",
        "text": "https://archive.orkl.eu/f76ba9fe61231f8474199a5a934676dc1ed9f955.txt",
        "img": "https://archive.orkl.eu/f76ba9fe61231f8474199a5a934676dc1ed9f955.jpg"
    }
}