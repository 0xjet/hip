{
    "id": "a56d0b20-b411-4b50-90bc-cd577685de21",
    "created_at": "2023-01-12T15:02:13.798722Z",
    "updated_at": "2025-03-27T02:15:46.111447Z",
    "deleted_at": null,
    "sha1_hash": "6261cf480e684ffb0355961c3eadffc5724cbafc",
    "title": "2017-03-30 - EquationDrug rootkit analysis (mstcp32.sys)",
    "authors": "",
    "file_creation_date": "2022-05-27T21:13:48Z",
    "file_modification_date": "2022-05-27T21:13:48Z",
    "file_size": 311648,
    "plain_text": "# EquationDrug rootkit analysis (mstcp32.sys)\n\n**[artemonsecurity.blogspot.com/2017/03/equationdrug-rootkit-analysis-mstcp32sys.html](http://artemonsecurity.blogspot.com/2017/03/equationdrug-rootkit-analysis-mstcp32sys.html)**\n\nMalware arsenal that have been used by very sophisticated & so-called state-sponsored\n[cyber group named \"Equation Group\" already was perfectly described by Kaspersky in their](https://securelist.com/files/2015/02/Equation_group_questions_and_answers.pdf)\nreport. As always, it is hard to make an assumption about attribution of this malware as well\nas about origins of such elite cyber group. Anyway, it's obviously that code development and\nthe cost of infrastructure for cyberattacks in such scale took enough human and money\nresources. As regular readers of my blog could notice, now I'm concentrating on research of\nrootkits allegedly belong to sophisticated/state-sponsored cyber actors. It is also interesting to\nassess skills of authors in driver development and compare it with code from another similar\n\"products\".\n\nIn the last year Equation Group group was hacked by another hacking group called Shadow\nBrokers, who claimed that got access to secret sources of NSA cyber toolkits. As we already\nknow, SB released some exploits and backdoors for routers/network devices of some vendors\nthat belong to EG. The last leak from SB was dedicated to set of PE-files, which used by\nEquation Group for cyberespionage and named EquationDrug. Analyzed driver mstcp32.sys\nwas taken from this leak.\n\nThe driver mstcp32.sys\n\n(SHA256:26215BC56DC31D2466D72F1F4E1B6388E62606E9949BC41C28968FCB9A9D60A6)\nmasked as \"Microsoft TCP/IP driver\".\n\n\n-----\n\nAuthors also took some steps to mask malicious purpose of this driver. For example, if you\nlook to its imports or dump strings from file, you can't find something really suspicious. The\ndriver imports API from NDIS kernel mode library called NDIS.SYS to work with network\npackets on physical level (that fully corresponds to its purpose). Actually, authors hid\nmalicious indicators inside driver into encrypted data. Below you can see decrypted strings\nfrom driver's body.\n\n\n-----\n\nAs you can see from dumped strings above, the rootkit attaches itself to Windows network\nstack for capturing packets on NDIS level. Also, it is clear that the rootkit implements injection\nof malicious code into trusted Windows processes - Services.exe (SCM) & Winlogon.\n\nBelow you can see compilation date of this driver, which indicates that it was compiled\nalready almost 10 years ago. This means that cyber espionage group used the rootkit and\nwas active already in 2007. Also authors were interested to make their operations stealthy\nfrom user eyes, putting code into Ring 0.\n\n\n-----\n\nTimestamp from debug directory matches with its analog from IMAGE_FILE_HEADER.\n\nBelow you can see screenshot of start rootkit code.\n\n\n-----\n\nMalicious data decryption is a first step that takes the driver. After that it creates device object\nwith name \\Device\\Mstcp32 and performs initialization steps. The device name doesn't hard\ncoded into driver's body, it forms on base of driver service name (Mstcp32 as original name).\n\nAs you can see from image above, driver dispatches following IRP requests:\n\nIRP_MJ_CREATE\nIRP_MJ_CLOSE\nIRP_MJ_READ\nIRP_MJ_WRITE\nIRP_MJ_DEVICE_CONTROL\nIRP_MJ_CLEANUP.\n\nThe driver registers itself as NDIS filter. It checks interface with GUID {4d36e972-e325-11cebfc1-08002be10318} (that located into encrypted part of data) and gets list of instances that\nalready registered in Windows. It tries to find specific instance with value LowerRange ==\n\"ethernet\" into HKLM\\SYSTEM\\CurrentControlSet\\Control\\Class\\{4d36e972-e325-11ce-bfc108002be10318}\\000X\\Ndi\\Interfaces. After driver code found it, it appends own value to this\nparameter as shown on image below.\n\nAs I already mentioned above, the rootkit was written by authors in 2007, so range of\nsupported Windows versions is extremely small comparing with nowadays malware\n\n\n-----\n\nMoreover, like other rootkits authors in that time, they use a lot of undocumented fields in\nkernel mode objects for retrieving the data they need. Next Windows NT versions are\nsupported by the rootkit.\n\nWindows NT 4.0 (1381)\nWindows 2000 (2195)\nWindows XP (2600)\nWindows Server 2003 (3790)\n\nYou can see that the rootkit uses various undocumented offsets in EPROCESS and\nETHREAD kernel objects for some purposes, including, enumerating running processes and\nthreads, checking thread alertable state, retrieving pointer to PEB and etc.\n\nInjection of malicious code into processes is made in usual for such rootkits manner:\nAttach_To_Process->Allocate_Virtual_Memory->InsertApc.\n\n\n-----\n\n**Conclusion**\n\n\n-----\n\nUnlike authors of other state-sponsored rootkits that were already mentioned in my blog,\nauthors of mstcp32.sys don't rely on Windows native API for performing some operations, for\nexample, for enumeration processes and threads. Instead this, they use undocumented\nkernel objects offsets for retrieving some data mentioned above. A significant portion of code\nin rootkit body is NDIS-oriented and dedicated to communication with network. There are a lot\nof Windows kernel rules for correctly organizing communication between NDIS driver and\nother parts of OS.\n\nThe rootkit driver supports IOCTL for sending data over network on NDIS level. This means\nthat network logic of communicating with remote host is located into user mode part that use\ndriver for this purpose.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-03-30 - EquationDrug rootkit analysis (mstcp32.sys).pdf"
    ],
    "report_names": [
        "2017-03-30 - EquationDrug rootkit analysis (mstcp32.sys).pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "62985c5c-6938-4365-8432-29573e99ecf4",
            "created_at": "2022-10-25T16:07:24.075092Z",
            "updated_at": "2025-03-27T02:02:10.099951Z",
            "deleted_at": null,
            "main_name": "PowerPool",
            "aliases": [],
            "source_name": "ETDA:PowerPool",
            "tools": [
                "ALPC Local PrivEsc",
                "FireMaster",
                "PowerDump",
                "PowerSploit",
                "Quarks PwDump",
                "SMBExec"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "adee5dfb-98d1-488f-969d-48eed28cd7e4",
            "created_at": "2023-01-06T13:46:38.799427Z",
            "updated_at": "2025-03-27T02:00:02.9221Z",
            "deleted_at": null,
            "main_name": "PowerPool",
            "aliases": [
                "IAmTheKing"
            ],
            "source_name": "MISPGALAXY:PowerPool",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "08623296-52be-4977-8622-50efda44e9cc",
            "created_at": "2023-01-06T13:46:38.549387Z",
            "updated_at": "2025-03-27T02:00:02.859535Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "Tilded Team",
                "EQGRP",
                "G0020"
            ],
            "source_name": "MISPGALAXY:Equation Group",
            "tools": [
                "EquationLaser",
                "EquationDrug",
                "DoubleFantasy",
                "TripleFantasy",
                "GrayFish"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2d9fbbd7-e4c3-40e5-b751-27af27c8610b",
            "created_at": "2024-05-01T02:03:08.144214Z",
            "updated_at": "2025-03-27T02:05:17.419705Z",
            "deleted_at": null,
            "main_name": "PLATINUM COLONY",
            "aliases": [
                "Equation Group "
            ],
            "source_name": "Secureworks:PLATINUM COLONY",
            "tools": [
                " EquationDrug",
                " EquationLaser",
                " Fanny",
                " GrayFish",
                " TripleFantasy",
                "DoubleFantasy"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "e0fed6e6-a593-4041-80ef-694261825937",
            "created_at": "2022-10-25T16:07:23.593572Z",
            "updated_at": "2025-03-27T02:02:09.879892Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "APT-C-40",
                "Platinum Colony",
                "Tilded Team"
            ],
            "source_name": "ETDA:Equation Group",
            "tools": [
                "Bvp47",
                "DEMENTIAWHEEL",
                "DOUBLEFANTASY",
                "DanderSpritz",
                "DarkPulsar",
                "DoubleFantasy",
                "DoubleFeature",
                "DoublePulsar",
                "Duqu",
                "EQUATIONDRUG",
                "EQUATIONLASER",
                "EQUESTRE",
                "Flamer",
                "GRAYFISH",
                "GROK",
                "OddJob",
                "Plexor",
                "Prax",
                "Regin",
                "Skywiper",
                "TRIPLEFANTASY",
                "Tilded",
                "UNITEDRAKE",
                "WarriorPride",
                "sKyWIper"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535733,
    "ts_updated_at": 1743041746,
    "ts_creation_date": 1653686028,
    "ts_modification_date": 1653686028,
    "files": {
        "pdf": "https://archive.orkl.eu/6261cf480e684ffb0355961c3eadffc5724cbafc.pdf",
        "text": "https://archive.orkl.eu/6261cf480e684ffb0355961c3eadffc5724cbafc.txt",
        "img": "https://archive.orkl.eu/6261cf480e684ffb0355961c3eadffc5724cbafc.jpg"
    }
}