{
    "id": "13d7e02f-0271-477f-ba57-2756a0d53b58",
    "created_at": "2022-10-25T16:48:11.97522Z",
    "updated_at": "2025-03-27T02:09:17.908978Z",
    "deleted_at": null,
    "sha1_hash": "d3e7473ca3b194b1390474445015023078b834a7",
    "title": "PowerPoint-Präsentation",
    "authors": "",
    "file_creation_date": "2021-10-03T13:21:37Z",
    "file_modification_date": "2021-10-03T13:21:37Z",
    "file_size": 3420986,
    "plain_text": "# SquirrelWaffle\n\n### From Maldoc to Cobalt Strike\n\n\n-----\n\n## Background\n\n####  A new spam mail campaign has been running since mid-September 2021, which delivered a new\n kind of malware loader  SquirrelWaffle\n\n  Similar to other campaigns before, this one sends a mail with a malicious attachment or a link to\n download one.\n\n  Let‘s analyze it!\n\n\n-----\n\n## Virustotal Research\n\n####  Campaign uses similar naming scheme: „diagram-<Number>.doc“\n – Sample Case 1) diagram-721.doc – Sample Case 2) diagram-623.doc\n\n  Search results on VT: 76 files since 10.09.\n  Submissions from DE, FR, HU, IN, US\n\n  In some other cases .xlm files are used for initial compromise,\n but the delivered samples in stage 2 and afterwards are the same\n\n\n-----\n\n## Analysis – Stage 1\n\n####  Word document with obfuscated VBA macro\n  Analysis via olevba --deobf\n – Some decoy code – Dropper & CnC communication\n\n\n-----\n\n## Analysis – Stage 1\n\n\n#### drop\n\n\nhxxps://priyacareers.com/u9hDQN9Yy7g/pt.html\n\nhxxps://perfectdemos.com/Gv1iNAuMKZ/pt.html\n\nhxxps://bussiness-z.ml/ze8pCNTIkrIS/pt.html\n\nhxxps://cablingpoint.com/ByH5NDoE3kQA/pt.html\n\nhxxps://bonus.corporatebusinessmachines.co.in/1Y0qVNce/pt.html\n\n#### download drop\n\n execute\n\n\nC:\\ProgramData\\pin.vbs\n\n\n1) \"cmd /c rundll32.exe C:\\ProgramData\\www1.dll,ldr\"\n\n2) \"cmd /c rundll32.exe C:\\ProgramData\\www2.dll,ldr\"\n\n3) \"cmd /c rundll32.exe C:\\ProgramData\\www3.dll,ldr\"\n\n4) \"cmd /c rundll32.exe C:\\ProgramData\\www4.dll,ldr\"\n\n5) \"cmd /c rundll32.exe C:\\ProgramData\\www5.dll,ldr\"\n\n\nwww1.dll\n\nwww2.dll\n\nwww3.dll\n\nwww4.dll\n\nwww5.dll\n\n\n-----\n\n## Analysis – Stage 2\n\n####  Dropped PE-DLLs www[1-5].dll vary on\n requested dropper URLs\n\n  Code is obfuscated\n\n  The called „ldr“ function is not available…\n\n\n-----\n\n## Analysis – Stage 2 Flow Graph\n\n\n-----\n\n## Analysis – Stage 2\n\n####  Some interesting Imports of this sample are\n not referenced directly…\n\n|not referenced directly…|Col2|\n|---|---|\n|ot referenced directly…||\n|||\n\n\n-----\n\n## Analysis – Stage 2\n\n####  Lets start with the dynamic analysis setting a\n breakpoint at kernel32.dll VirtualAlloc\n\n  1) Call is coming from\n```\n call dword ptr ds:[ebx+2113E4]\n\n  2) Allocated memory is written by\n rep movsb\n\n  3) Jumping into buffer shellcode via\n jmp eax\n\n```\n\n#### 1)\n\n 2)\n\n 3)\n\n\n-----\n\n## Analysis – Stage 2\n\n####  Lets start with the dynamic analysis setting a\n breakpoint at kernel32.dll VirtualAlloc\n\n  1) Call is coming from\n```\n call dword ptr ds:[ebx+2113E4]\n\n  2) Allocated memory is written by\n rep movsb\n\n  3) Jumping into buffer shellcode via\n jmp eax\n E8 00 00 00 00 = shellcode call instruction\n\n```\n\n-----\n\n## Analysis – Stage 2\n\n####  A further call of VirtualAlloc leads to a new\n buffer\n\n  Setting a HW,Write breakpoint on that buffer\n leads to the routine which fills this buffer\n\n  Remove this breakpoint and set another one\n at the end of the filling routine (leave instruction)\n\n  Magic Bytes: M8Z  aPLib compression\n\n\n-----\n\n## Analysis – Stage 2\n\n####  To reveal the aPLib decompression routine\n remove all further breakpoints and set a new one (HW,Access) at the M8Z header bytes  Breakpoint triggerd in the aPLib\n decompression function  The EDI register reveals the destination\n offset for the decompressed content\n\n  Replace the breakpoint with one at the end of\n the decompression routine (ret instruction)\n  Decompressed PE-DLL\n\n  Dump PE-DLL\n\n\n-----\n\n## Analysis – Stage 2\n\n####  „ldr“ function has only one call instruction to\n the main function\n\n  To start „ldr“ function, do the following steps:\n 1) Load PE-DLL in x32dbg 2) Run DllEntryPoint function till returning to\n initial ntdll call (at least function at offset 0x1000) 3) Move EIP manually to „ldr“ entry point\n\n\n-----\n\n## Analysis – Stage 3\n\n#### The interesting parts of that function are mainly the decryption of the CnC server list and the ones which are used to generate the payload for the further communication.\n\n The output from the function calls are concatenated in a string like   \n```\n  <ComputerName><Username><AppDataPath><Domain>\n\n and XORd with the static key „KJKLO“\n\n```\n\nXOR the concatenated string\n\n\n-----\n\n## Analysis – Stage 3\n\n#### To follow the preparation, set breakpoints to the XOR crypt function calls.\n\n The result of the call is returned as a pointer in the EAX register\n\n\n-----\n\n## Analysis – Stage 3\n\n#### After XORing the concatenated string, the result is encoded base64\n\n###### Key\n\n Input XOR B64 Output\n\n\n-----\n\n## Analysis – Stage 3\n\n#### Like mentioned before, the XOR crypt routine is also used to decrypt the embedded CnC server, but using a different key.\nCnC communication function\n\nKey for CnC server list decryption\n\n\n-----\n\n## Analysis – Stage 3\n\n\n-----\n\n## Analysis – Stage 3\n\n#### In the next step the malware does more preparation for a further communication with the CnC server\n\n It concatenates a random string with the the local IP address, XORs and encodes it base64\n\n\n-----\n\n## Analysis – Stage 3\n\n#### Set breakpoints on communication functions (send & recv) to follow the further communication\n\n\n-----\n\n## Analysis – Stage 3\n\n#### Prepared HTTP request sent to the CnC server\n\n\n-----\n\n## Analysis – Stage 3\n\n#### HTTP response received from CnC server\n\n\n-----\n\n## Analysis – Stage 3/4\n\n#### Unfortunately curren‘t requests to the CnC Server doesn‘t result in a further infection...\n\n I got a successful infection in my lab environment in the past resulting in a dropped and executed file <RandomString>.txt in C:\\User\\<User>\\AppData\\Local\\Temp\n\n This file was similar to the one uploaded by malware-traffic-analysis.com\n\n Name: RVOgDko8fnP.txt (MD5 ef799b5261fd69b56c8b70a3d22d5120)\n\n\n-----\n\n## Analysis – Stage 4\n\n####  Don‘t get fooled by .txt ending, actually it‘s a\n PE-DLL\n\n  Interesting Imports\n```\n LoadLibrary\n VirtualAlloc\n\n  Libraries are mostly linked at runtime\n\n  Dynamic Analysis\n Set breakpoints at relevant functions\n  LoadLibrary\n  VirtualAlloc\n\n```\n\n-----\n\n#### VirtualAlloc HW,Write End of loop\n\n  After multiple LoadLibrary calls, a VirtualAlloc follows\n  Set HW,Write breakpoint at the new allocated buffer\n\n\n-----\n\n## Analysis – Stage 4\n\n####  Jump to the new buffer takes place immediately after the end of the loop\n  Shellcode execution\n```\n  EB = jmp 670005\n  03 = add eax, edx\n  C2 = ret C\n\n```\n\n-----\n\n## Analysis – Stage 5\n\n####  Dump the PE-EXE\n\n  Static analysis reveals, that there is\n one „main“ function, which is a shellcode wrapper\n\n  Breakpoint on LoadLibrary shows, that\n wininet.dll is used during runtime\n  Additional Breakpoints on wininet\n functions\n```\n InternetConnectA\n InternetOpenA\n InternetReadFile\n HttpOpenRequestA\n\n```\n\n-----\n\n## Analysis – Stage 5\n\n#### 1) InternetConnectA\n\n 2) HttpOpenRequestA\n\n 3) HttpSendRequestA\n\n\n-----\n\n## Analysis – Stage 5\n\n#### HTTP GET Request\n\n The crafted request looks like a harmless HTTP GET Request to receive a JQuery Javascript file\n\n Setting up a simple request with no additions, results in a blank answer…\n\n To receive the .js file, reproducing the whole GET request including HTTP Header fields is required, e.g.: Referer hxxp://code.jquery.com/\n\n\n-----\n\n## Analysis – Stage 5\n\n#### 4) VirtulAlloc Response of the request is saved into a buffer Size: 4MB\n\n 5) InternetReadFile Buffer is filled in multiple chunks Important offset 0xFAF stored in ECX register\n\n\n-----\n\n## Analysis – Stage 5\n\n#### Breakpoint at the end of the loop  Buffer is filled completely\n\n On the first look, the response looks like a valid JQuery response\n\n Looking more in detail and following the code execution, the buffer contains a shellcode which is called directly afterwards, by jumping to offset 0xFAF\n\n\n-----\n\n#### . . .\n\n . ..\n\n\n#### Pseudo JQuery\n\n Embedded Shellcode\n\n Pseudo JQuery\n\n\n-----\n\n## Analysis – Stage 5/6\n\n#### Dump the memory page\n\n Extract the PE-DLL from dumped page\n\n Offsets for extraction: Begin 0xFAF -- End 0x3440E\n\n Analyze it using Cobalt Strike Parser!\n\n\n-----\n\n## Recap\n\n**Spam mail**\n\n**with link**\n\n\n**CnC-Server**\n\nDownload Drop\n\nExtract Drop Execute\n\n\nDownload\n\n**CnC-Server**\n\nDrop\n\n\n**SquirrelWaffle**\n\n**Loader**\n\n**Stage 3**\n**PE-DLL**\nDll1.dll,ldr\n\nExecute\n\n\nExecute\n\n**CnC-Server**\n\n\naPLib\n\ncompressed\n\nEmbedded\n\nExecute\n\n\n**Encrypted**\n**.zip archive**\n\n\n**Word document**\nwith obfuscated VBA\n\n\n**VBS Loader**\n\n**Stage 6**\n**PE-DLL**\nCobalt Strike\n\nBeacon\n\n\n**Stage 2**\n**PE-DLL**\nwww[1-5].dll\n\n**Stage 5**\n**PE-EXE**\nCobalt Strike\nBeacon Loader\n\n\n**Stage 4**\n**PE-DLL**\nRVOgDko8fnP.txt\n\n\n-----\n\n## YARA\n\n#### To detect the SquirrelWaffle loader i created a YARA rule based on the decryption function used in Stage 3\n\nhttps://github.com/0xjxd/YARA-rules/blob/main/Loader.SquirrelWaffle.yara\n\n\n-----\n\n## IOCs\n\n####  Stage 1 - 2\n\n**Dropper Server**\nhxxps://priyacareers.com\nhxxps://perfectdemos.com\nhxxps://bussiness-z.ml\nhxxps://cablingpoint.com\nhxxps://bonus.corporatebusinessmachines.co.in\n\n####  Stage 3\n\n\n**CnC Server**\nhxxp://celulasmadreenmexico.com.mx\nhxxp://gerencial.institutoacqua.org.br\nhxxp://dashboard.adlytic.ai\nhxxp://bussiness-z.ml\nhxxp://ifiengineers.com\nhxxp://bonusvulkanvegas.srdm.in\nhxxp://ebrouteindia.com\n\n\nhxxp://test.dirigu.ro\nhxxp://cablingpoint.com\nhxxp://perfectdemos.com\nhxxp://afrizam.360cyberlink.com\nhxxp://giasuphire.tddvn.com\nhxxp://priyacareers.com\nhxxp://assurant.360cyberlink.com\nhxxp://sig.institutoacqua.org.br\n\n\n\n####  Stage 4 - 6\n\n**Cobalt Strike Server**\nhxxps://systemmentorsec.com:8080/jquery-3.3.1.min.js\n\n####  Sample Hashes\n\n**Stage 1: f0a3d4e47b098d302ad13bc4e51a03adeb9428e5c34630428222e989792f7a6d**\n**Stage 2: 00d045c89934c776a70318a36655dcdd77e1fedae0d33c98e301723f323f234c**\n**Stage 3: ab05d6335b06a0dbc41386c7c356202b4e07dcf76a4932ed4d4e7dd69b7a3101**\n**Stage 4: 3c280f4b81ca4773f89dc4882c1c1e50ab1255e1975372109b37cf782974e96f**\n**Stage 5: 964c5933844de7ed5a7813cdb36b9974a5a819b046e73a0bc6754d7299374a9f**\n**Stage 6: 804f83a9754cfa2e43f167cc22980b1eca2ff11c05029e7ce0a8c2aae524a8b5**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/0xjxd/SquirrelWaffle-From-Maldoc-to-Cobalt-Strike/raw/main/2021-10-02%20-%20SquirrelWaffle%20-%20From%20Maldoc%20to%20Cobalt%20Strike.pdf"
    ],
    "report_names": [
        "2021-10-02%20-%20SquirrelWaffle%20-%20From%20Maldoc%20to%20Cobalt%20Strike.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716491,
    "ts_updated_at": 1743041357,
    "ts_creation_date": 1633267297,
    "ts_modification_date": 1633267297,
    "files": {
        "pdf": "https://archive.orkl.eu/d3e7473ca3b194b1390474445015023078b834a7.pdf",
        "text": "https://archive.orkl.eu/d3e7473ca3b194b1390474445015023078b834a7.txt",
        "img": "https://archive.orkl.eu/d3e7473ca3b194b1390474445015023078b834a7.jpg"
    }
}