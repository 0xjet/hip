{
    "id": "937bf425-d24d-42e0-b64a-40ea9aff1cef",
    "created_at": "2023-01-12T15:07:30.168672Z",
    "updated_at": "2025-03-27T02:14:57.463232Z",
    "deleted_at": null,
    "sha1_hash": "5732881d303db1ca7c49d1e53ef5a6abbac5cf38",
    "title": "2017-09-06 - Analysing a 10-Year-Old SNOWBALL",
    "authors": "",
    "file_creation_date": "2022-05-28T18:00:53Z",
    "file_modification_date": "2022-05-28T18:00:53Z",
    "file_size": 471746,
    "plain_text": "# Analysing a 10-Year-Old SNOWBALL\n\n**[researchcenter.paloaltonetworks.com/2017/09/unit42-analysing-10-year-old-snowball/](https://researchcenter.paloaltonetworks.com/2017/09/unit42-analysing-10-year-old-snowball/)**\n\nDominik Reichel September 6, 2017\n\nBy [Dominik Reichel](https://unit42.paloaltonetworks.com/author/dominik-reichel/)\n\nSeptember 6, 2017 at 5:00 AM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [Animal Farm,](https://unit42.paloaltonetworks.com/tag/animal-farm/) [Babar,](https://unit42.paloaltonetworks.com/tag/babar/) [Bunny,](https://unit42.paloaltonetworks.com/tag/bunny/) [Casper,](https://unit42.paloaltonetworks.com/tag/casper/) [Dino,](https://unit42.paloaltonetworks.com/tag/dino/) [NBot,](https://unit42.paloaltonetworks.com/tag/nbot/) [Snowball,](https://unit42.paloaltonetworks.com/tag/snowball/) [Snowman](https://unit42.paloaltonetworks.com/tag/snowman/)\n\n[Much has been written about the malware toolkit dubbed Animal Farm which is made up of several implants known as](https://securelist.com/animals-in-the-apt-farm/69114/)\nBabar, Bunny, NBot, Dino, Casper and Tafacalou. Some of these tools have been used in past attacks against\norganizations, companies and individuals.\n\nOne of the first tools believed to be used by this adversary to target a potential victim is Babar, also known as SNOWBALL.\nPrevious samples of SNOWBALL date back to 2011. However, Palo Alto Networks Unit 42 has identified a much older\nversion. This version of the malware dates back to 2007 according to its compilation time stamp which we believe is valid.\n\nWe discovered this sample by coincidence while searching for another unrelated malware in a large malware repository.\nWhile looking at the strings and the structure, we could make a connection to previously published documents and decided\nto do a deeper analysis.\n\n## Why analyse malware from the past?\n\nAnalysing historical malware samples helps us learn about its set of features and technical capabilities. This helps us\ncompare a tool used by one adversary to that used by similarly adversaries at that time.\n\nThis earlier sample of Babar uses many features not present in later versions. The sample also uses a compromised third\nparty website as a C2 server like later versions. We also found a simple bug and a design flaw in the code you wouldn’t\nexpect from malware developed by mature actors.\n\n## Detailed technical breakdown\n\n**The Loader**\n\nThe PE sample comes in form of a loader which has a compilation time stamp of 11/09/2007 11:37:36 PM. The loader\ncontains a resource named MYRES (Figure 1) where the payload DLL is stored.\n\n\n-----\n\n_Figure 1. PE resource named MYRES with main payload DLL_\n\nThe version info resource language ID is 1036 which stands for French.\n\nThe following clear text strings can be found in the loader:\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nHTTP\\SHELL\\open\\command\nSOFTWARE\\Clients\\StartMenuInternet\nSOFTWARE\\Microsoft\\Windows\\CurrentVersion\\App Paths\\\n%APPDATA%\nevent.log\nSoftware\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\n%ALLUSERSPROFILE%\n%ALLUSERSPROFILE%\n%APPDATA%\n%APPDATA%\nAppData\nSeDebugPrivilege\nMYRES\nSoftware\\Microsoft\\Windows\\ShellNoRoam\\MUICache\\\nSoftware\\Classes\\Local Settings\\Software\\Microsoft\\Windows\\Shell\\MuiCache\\\n\\Microsoft\\wmimgnt.dll\n\\Microsoft\\wmimgnt.exe\nExitProcess\nKERNEL32.DLL\n%ProgramFiles%\n\\Internet Explorer\\iexplore.exe -embedding\niexplore.exe\n-embedding\n\n\nAt the beginning, it changes the error mode of the process to handle the following errors:\n\nSEM_NOOPENFILEERRORBOX\nSEM_NOGPFAULTERRORBOX\nSEM_FAILCRITICALERRORS\n\nFor this, it sets up an exception handler with the address to ExitProcess(). Thus, if any of the errors occur the malware just\nexits.\n\nNext, it tries to gain debug privileges and checks if the major OS version is >= Windows Vista and the platform ID is\nVER_PLATFORM_WIN32_NT. If so, if tries to create a file named event.log in the %ALLUSERSPROFILE% folder.\nHowever, the authors forget to append the character \"\\\" before appending the hardcoded string \"event.log\". This results in\nthe creation of the following file:\n\n1 C:\\ProgramDataevent.log\n\nIf the call to CreateFile() fails, it tries to delete this file.\n\nNext, it tries to get the local AppData folder path first by querying the %APPDATA% environment variable and if that fails, it\nlooks in the shell folders in the registry. This data is then used to create the following file paths with the hardcoded file\nnames:\n\n\n1\n2\n\n\nC:\\Users\\_username_\\AppData\\Roaming\\Microsoft\\wmimgnt.dll\nC:\\Users\\_username_\\AppData\\Roaming\\Microsoft\\wmimgnt.exe\n\n\nThe malware also tries to delete any traces it was executed by deleting the corresponding entries in the following registry\nkeys:\n\n\n1\n2\n\n\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\ShellNoRoam\\MUICache\\\nHKEY_CURRENT_USER\\Software\\Classes\\Local Settings\\Software\\Microsoft\\Windows\\Shell\\MuiCache\n\n\nAfter this, the malware checks if its main module is already present on a victim’s system by trying to open the file:\n\n1 C:\\Users\\_username_\\AppData\\Roaming\\Microsoft\\wmimgnt.dll\n\nIf the file is present, the malware checks if the module file name of the process is as follows and exits otherwise:\n\n\n-----\n\n1 C:\\Users\\_username_\\AppData\\Roaming\\Microsoft\\wmimgnt.exe\n\nIf it matches the malware creates a temporary file in the local user’s temp folder and copies the resource\nnamed MYRES into it. This file is the payload DLL which then gets moved as wmimgnt.dll to the AppData folder. The file\nattributes are changed to hidden and the file time is changed to make it look like an old file. The same procedure is done\nwith the initial file which gets copied as wmimngt.exe into the AppData folder.\n\nThereafter, the malware checks again the major OS version and platform ID like previously and opens the following registry\nkey to get the default internet browser:\n\n1 HKEY_CURRENT_USER\\SOFTWARE\\Clients\\StartMenuInternet\n\nThe malware authors assumed the browser string always ends with a \".exe\" extension and calculate the string in the\nfollowing manner:\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nRegOpenKeyExA(HKEY_CURRENT_USER, \"SOFTWARE\\\\Clients\\\\StartMenuInternet\", 0, 1u, phkResult);\nRegQueryValueExA(phkResult, 0, 0, Type, Data, &amp;cbData);\n...\nv3 = strstr((const char *)Data, \".exe\");\n...\nv4 = v3[-v1] - (char *)Data + 4;\nmemcpy(a1, Data[v1], v4);\n\n\nThe calculation of the string length in v4 only works if the default browser is for example Internet Explorer or Firefox, as\nthese browsers have an .exe extension in the registry key:\n\n\n1\n2\n\n\nIEXPLORE.EXE\nFIREFOX.EXE\n\n\nWhile a browser like Chrome uses the following string:\n\n1 Google Chrome\n\nIn this case, the string length gets wrongly calculated and the subsequent call to memcpy() fails with an error so the\nexception handler kicks in to terminate the process. However, as Chrome was first released in 2008 and the malware was\ncoded earlier, this can't be considered as a bug.\n\nAfter retrieving the string of the default browser from registry, it builds the following string to get the application path of it:\n\n1 HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\App Paths\n\nIf this was successful it searches for the string \"iexplore.exe\" in the path and appends the string \" -embedding\" to it. If it\nfailed, the malware retrieves the ProgramFiles path via the environment variable \"%ProgramFiles%\" and appends the string\n\"\\Internet Explorer\\iexplore.exe -embedding\".\n\nThe command line argument \"-embedding\" does the following according to Microsoft:\n\n1 Starts Windows Internet Explorer through OLE embedding (such as the WebBrowser Control).\n\nAt last, it creates a suspended process of Internet Explorer and injects the payload DLL via the infamous\nCreateRemoteThread() method.\n\n**The Payload DLL**\n\nThis sample has a compilation time stamp of 11/09/2007 11:37:46 PM (10 seconds after the loader.) It contains an\nencrypted resource named XML which contains configuration data. The encryption algorithm RC4 is used with the\nkey +37:*$pK#s. Both the version info and the XML resource language IDs have again the value 1036 (French).\n\n\n-----\n\nDecrypted configuration data:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n<HOST>cpcc-rdc.org</HOST>\n<URL>/wp-pagin/outbase.php</URL>\n<PORT>80</PORT>\n<MIN>3000</MIN>\n<MAX>4000</MAX>\n<PREFIX>=#-+ApAcHe_ToMcAt+-#=</PREFIX>\n<ENCODE>1</ENCODE>\n<PASSWORD>TargetRenegade</PASSWORD>\n<CONFIG_KEY>SOFTWARE\\Microsoft\\MSRPC</CONFIG_KEY>\n<RUN_KEY>Windows Management Infrastructure (WMI)</RUN_KEY>\n\n\nAs can be seen, a third-party website was compromised as C2 server to host a script named outbase.php. The domain\n(cpcc-rdc.org) is the official site of Permanent Council of Accounting of the Democratic Republic of the Congo. The script is\nnot online anymore as the attack was most likely carried many years ago.\n\nThe following clear text strings can be found in the DLL:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n\n\nreboot\nshutdown\ndownload\nwget\nfetch\nwput\nshowconfig\ntimeout\ntimeout_main\ntimeout_safe\nnewurl_main\nnewurl_safe\nmovetosite\nlistprocess\nkillprocess\nkitkit\nuninstall\n%s\\%s\n%d-%d\n\n[+] Timeout set successfully\n\n[-] Timeout error\n\n[+] Timeout_main set successfully\n\n[-] Timeout_main error\n\n[+] Timeout_safe set successfully\n\n[-] Timeout_safe error\n! EXECUTION TIME LIMIT EXCEEDED ! You maybe have to kill the process \"%s\" you launched (Use listprocess\nand killprocess...)\ncmd.exe /C %s\ncommand.com /c %s\n\n[-] Unable to go to this unit\n\n[-] Cannot reboot\n\n[-] Cannot shutdown\n\n[-] Download error\n\n[%s] &gt; 500 Ko =&gt; use \"big\"\n\n[-] Download error\nUpload;%s;\n\n[-] fetch error\n\n[-] fetch error\n\n[+] fetch seems to be OK\n\n[-] fetch error\n\n[+] Uninstalled\n\n[-] Uninstall failed\ndata=\nhttp://\n\n[+] wput Ok\n\n[-] wput error\nhttp://\n\n\n-----\n\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n72\n73\n74\n75\n76\n77\n78\n79\n80\n81\n82\n83\n84\n85\n86\n87\n88\n89\n90\n91\n92\n93\n94\n95\n96\n97\n98\n99\n100\n101\n102\n103\n104\n105\n106\n107\n108\n109\n110\n111\n112\n113\n114\n115\n\n\n\n[ ] wget Ok\n\n[-] wget error\n\n[+] movetosite \"%s\" Ok\n\n[-] movetosite failed\n\n[+] change main site url Ok\n\n[-] change main site url failed\n\n[+] change safe site url Ok\n\n[-] change safe site url failed\nBig in progress... Please wait before downloading the file.\n\n[+] Big finished. You can now download the file\nMulti-Part;%d;%s;\nMULTI\n\n[-] big error\n\n[-] Can't list partitions\nDRIVE_TYPE  LETTER  VOLUME_NAME\n--------------------------------------Fixed\nCDRom\nRemovable\nNoRootDir\nRemote\nRamdisk\nUnknown\n%12s   %s   %s\nPROCESS NAME  PID\n-------------------------------%22s  %4d\n\n[-] Unable to kill the process \"%s\" with the PID %d\n\n[-] Unable to kill the process \"%s\" with the PID %d\n\n[+] The process \"%s\" with the PID %d has been killed\n\n[-] The process with the PID %d was not found\n\n[-] killprocess error\n======= CURRENT PARAMS\n\n[+] Url: http://%s%s\n\n[+] Port: %d\n\n[+] Timeout: %d-%d\n======= SAVED PARAMS\n\n[Main Site]\n\n[+] Url: http://%s%s\n\n[+] Port: %d\n\n[+] Timeout: %d-%d\n\n[Safe Site]\n\n[+] Url: http://%s%s\n\n[+] Port: %d\n\n[+] Timeout: %d-%d\nbad allocation\n%APPDATA%\nevent.log\nSoftware\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\n%ALLUSERSPROFILE%\n%APPDATA%\nAppData\nMSFirstUpdate\n%02d\\%02d\\%04d %02d:%02d:%02d\n:strt\ndel /F /A \"%s\"\nif EXIST \"%s\" GOTO strt\ndel /F /A \"%s\"\ndel /F /A %0\n\\Microsoft\\wmimgnt.exe\n\\Microsoft\\wmimgnt.dll\nwupdmgr.bat\nSoftware\\Microsoft\\Windows\\ShellNoRoam\\MUICache\nbad allocation\nuser=%s;%d;%s;\nDefault User ID\nIdentities\nsCountry\n\n\n-----\n\n116\n117\n118\n119\n120\n121\n122\n123\n124\n125\n126\n127\n128\n129\n130\n131\n132\n133\n134\n135\n136\n137\n138\n139\n140\n141\n142\n143\n144\n145\n146\n147\n148\n149\n150\n151\n152\n153\n154\n155\n156\n157\n158\n159\n160\n161\n162\n163\n164\n165\n166\n167\n168\n169\n170\n171\n172\n173\n174\n175\n176\n177\n178\n179\n180\n181\n182\n183\n\n\nControl Panel\\International\nUser Agent\nSoftware\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\nSoftware\\Clients\\StartMenuInternet\nHTTP\\SHELL\\open\\command\nRegisteredOrganization\nSOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\nRegisteredOwner\nSOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\nCSDVersion\nSOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\nCurrentVersion\nSOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\nDefaultUserName\nSOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\\Winlogon\nUSERNAME\nVolatile Environment\nDefaultDomainName\nSOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\\Winlogon\nUSERDOMAIN\nVolatile Environment\nRegisteredOrganization\nSOFTWARE\\MICROSOFT\\WINDOWS\\CurrentVersion\nRegisteredOwner\nSOFTWARE\\MICROSOFT\\WINDOWS\\CurrentVersion\nCSDVersion\nSOFTWARE\\MICROSOFT\\WINDOWS\\CurrentVersion\nCurrentVersion\nSOFTWARE\\MICROSOFT\\WINDOWS\\CurrentVersion\nDefaultUserName\nSOFTWARE\\MICROSOFT\\WINDOWS\\CurrentVersion\\Winlogon\nDefaultDomainName\nSOFTWARE\\MICROSOFT\\WINDOWS\\CurrentVersion\\Winlogon\nDefault\nLogin (owner): %s (%s)\nComputer name: %s\nOrganization (country): %s (%s)\nOS version (SP): %s (%s)\nDefault browser: %s\nIE version: %s\nTimeout: %d(min)\n%d(max)\nFirst launch: %s\nLast launch : %02d\\%02d\\%04d %02d:%02d:%02d\nbad allocation\n\\Microsoft\\wmimgnt.exe\nSeDebugPrivilege\nExitProcess\nKERNEL32.DLL\nRUN_KEY\nCONFIG_KEY\nbad allocation\nafter init\nBefore transform\nAfter transform\nbits: %d %d\nbuf: %x %x %x %x\nbad allocation\nContent-Type: application/x-www-form-urlencoded\nbad allocation\nmsupdate32\nSOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\nMozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0)\n+37:*$pK#s\n\n&lt;%s&gt;%s\n&lt;%s&gt;%d\nPREFIX\n\n\n-----\n\n184\n185\n186\n187\n188\n189\n190\n191\n192\n193\n194\n195\n196\n197\n198\n199\n200\n201\n202\n203\n204\n205\n206\n207\n\n\nENCODE\nPASSWORD\nCONFIG_KEY\nRUN_KEY\nHOST_SAFE\nURL_SAFE\nPORT_SAFE\nMIN_SAFE\nMAX_SAFE\nPREFIX\n=#-+ApAcHe_ToMcAt+-#=\nENCODE\nPASSWORD\nTargetRenegade\nRUN_KEY\nWindows Management Infrastructure (WMI)\n/outbase.php\n127.0.0.1\nURL_SAFE\n/outbase.php\nHOST_SAFE\n127.0.0.1\nPORT_SAFE\nMIN_SAFE\nMAX_SAFE\n\n\nThe sample only executes if the reason code why the DLL entry-point function was being called\nis DLL_PROCESS_ATTACH.\n\nAt first, the malware decrypts the XML configuration data to memory, searches for the XML tags <RUN_KEY> and\n<CONFIG_KEY> and extracts their content. With this data, it checks if the malware's persistency is already present in the\nregistry Run key and creates it if it's not the case:\n\n\n1\n2\n3\n\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\nValue: Windows Management Infrastructure (WMI)\nValue key: C:\\Users\\_username_\\AppData\\Roaming\\Microsoft\\wmimgnt.exe\n\n\nThereafter, it decrypts the data of the following XML tags and stores them in memory:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nPREFIX\nENCODE\nPASSWORD\nRUN_KEY\nURL\nHOST\nPORT\nMIN\nMAX\n\n\nThe implementation of this part of the code is somewhat flawed, since the malware contains the encrypted configuration\ndata, but the same data (except for the C2 domain) is also present as clear text strings. If the decryption didn’t work it uses\nthe clear text strings.\n\n\n-----\n\n_Figure 2. Clear text configuration data_\n\nIt also creates the following new XML tags based on the old ones:\n\n\n1\n2\n3\n4\n5\n\n\n<MAX_SAFE>4800</MAX_SAFE>\n<MIN_SAFE>3600</MIN_SAFE>\n<PORT_SAFE>80</PORT_SAFE>\n<URL_SAFE>/outbase.php</URL_SAFE>\n<HOST_SAFE>127.0.0.1</HOST_SAFE>\n\n\nAll the XML tags are then RC4 encrypted with key +37:*$pK#s and stored in the following registry key:\n\n\n1\n2\n\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\MSRPC\nValue: msupdate32\n\n\nThen, it tries to get system information from the following registry keys:\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nHKEY_CURRENT_USER\\Identities\nValue: Default User ID\nHKEY_CURRENT_USER\\Control Panel\\International\nValue: sCountry\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\nValue: User Agent\nHKEY_CURRENT_USER\\Software\\Clients\\StartMenuInternet\nHKEY_LOCAL_MACHINE\\SOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\nValue: RegisteredOrganization\nHKEY_LOCAL_MACHINE\\SOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\nValue: RegisteredOwner\nHKEY_LOCAL_MACHINE\\SOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\nValue: CSDVersion\nHKEY_LOCAL_MACHINE\\SOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\nValue: CurrentVersion\nHKEY_LOCAL_MACHINE\\SOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\\Winlogon\nValue: DefaultUserName\nHKEY_CURRENT_USER\\Volatile Environment\nValue: USERNAME\nHKEY_LOCAL_MACHINE\\SOFTWARE\\MICROSOFT\\WINDOWS NT\\CurrentVersion\\Winlogon\nValue: DefaultDomainName\n\n\nThe malware also retrieves the current system time, encrypts it with RC4 and the same key and stores it in the following\nregistry key:\n\n\n1\n2\n3\n\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\MSRPC\nValue: MSFirstUpdate\nValue key: <RC4encrypteddatetime>\n\n\nThen, it creates a string with the previously retrieved system information, the configuration data and the following string\ntemplate:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nLogin (owner): %s (%s)\nComputer name: %s\nOrganization (country): %s (%s)\nOS version (SP): %s (%s)\nDefault browser: %s\nIE version: %s\nTimeout: %d(min) %d(max)\nFirst launch: %s\nLast launch : %02d\\%02d\\%04d %02d:%02d:%02d\n\n\nNext, the MD5 hash of this string is calculated and encrypted with RC4 and the same key again. This encrypted string gets\nthen stored in the following registry key:\n\n\n1\n2\n3\n\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\MSRPC\nValue: MSID\nValue key: <MD5hashedandRC4encryptedsysteminformation>\n\n\nTo send victim information to the C2 server, it prepares a URL query string by entering the \"INFO\" branch. The other query\nbranch named \"CMD\" is entered to send back the result of a command sent by the C2 server.\n\n\n-----\n\n_Figure 3. URL query string creation branches_\n\nAt first, the checks if the <ENCODE> XML tag is set to 0x1 and if so it encrypts the previously created string with the\nvictim’s information with the password contained in the <PASSWORD> XML tag. It does this by bytewise adding 0x80 to\nthe password string and then using an encoded byte to bytewise XOR the information string. The encrypted string gets then\nBase64 encoded and the characters \"+\", \"/\" and \"=\" URL encoded (\"%2B\", \"%2F\", \"%3D\"). The following string template is\nthen used together with the encrypted data to form the final URL query string:\n\n1 user=%s;%d;%s;\n\nThe first string is the previously calculated MD5 hash, the decimal number is made of a random number between\n3000/3600 ( XML tag) and 4000/4800 ( XML tag). The last string is made of the hardcoded \"INFO\" string along with the\nBase64 encoded victim data. For example:\n\n1 user=52ac9e4b389c5b2f8a63af4a126c1c80;3046;INFO;mI7BkjovU%2BoqZi4KTzd%2F0wdqqjJegip2KgYXN6N6inYqV...\n\nTo test if the computer is connected to the internet it uses InternetGetConnectedState() API function. Next, it enters either\nthe \"main\" or the \"safe\" branch referring to the XML tags. The main branch is the usual execution path, while the safe\nbranch only gets used for a specific malware command. If there is no internet connection it sleeps for a certain time,\notherwise it contacts the C2 server present in the <HOST> XML tag together with the URL query string. The malware has\nthe ability to send data with both HTTP request methods, GET and POST. However, this sample only uses the POST\nrequest method along with the following content type field:\n\n1 Content-Type: application/x-www-form-urlencoded\n\nAfter contacting the C2 server, the malware copies the response into memory and scans for the marker =#**+ApAcHe_ToMcAt+-#= taken from the <PREFIX> XML tag. If successful, the response gets Base64 decoded and**\ndecrypted with the same algorithm used to encrypt the victim information string. The PHP script outbase.php can respond\nwith one of the commands listed below, which the malware then executes.\n\nTo process some commands, the malware creates an anonymous pipe and a hidden instance of cmd.exe or\ncommand.com, depending on the platform ID. The command line output gets redirected to the pipe, read into memory and\nlater send back encrypted and encoded via the \"CMD\" URL query branch.\n\n**Possible malware commands:**\n\n\n-----\n\n**1. pwd**\nGet current working directory\n\n**2. cd**\nchange directory to delivered string\n\n**3. part**\nGet list and type of partitions\n\n**4. reboot**\nReboot system\n\n**5. shutdown**\nShutdown system\n\n**6. download**\nDownload file < 512,000 bytes delivered in form of a URL (\"500 Ko\") to disk\n\n**7. big**\nDownload file > 512,000 bytes delivered in form of a URL (\"500 Ko\") to disk\n\n**8. wget**\nDownload file with predefined HTTP query string\n\n**9. fetch**\nDownload file via URLDownloadToFile()\n\n**10. wput**\nDownload data from internet via download command and sent data back via \"data=\" query\n\n**11. info**\nSend back victim system information (see above)\n\n**12. showconfig**\nSend back current config data with following string template:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\n======= CURRENT PARAMS\n\n[+] Url: http://%s%s\n\n[+] Port: %d\n\n[+] Timeout: %d-%d\n\n======= SAVED PARAMS\n\n[Main Site]\n\n[+] Url: http://%s%s\n\n[+] Port: %d\n\n[+] Timeout: %d-%d\n\n[Safe Site]\n\n[+] Url: http://%s%s\n\n[+] Port: %d\n\n[+] Timeout: %d-%d\n\n\n**13. timeout**\nChange current timeout interval variables\n\n**14. timeout_main**\nChange timeout intervals in main XML configuration\n\n**15. timeout_safe**\nChange timeout intervals in safe XML configuration\n\n\n-----\n\n**16. newurl_main**\nChange host URL in main XML configuration\n\n**17. newurl_safe**\nChange host URL in safe XML configuration\n\n**18. movetosite**\nChange current host URL variable\n\n**19. listprocess**\nGet list of current processes with PID\n\n**20. killprocess**\nTerminate process delivered via string\n\n**21. kitkit**\nTerminate itself\n\n**22. uninstall**\nDelete malware files on disk and registry entries\n\n## Conclusion\n\nThis malware has a small set of features ranging from retrieving system information, to downloading files or killing\nprocesses on a victim’s system. Technically, it is not outstanding and can be considered only average compared to alleged\nstate sponsored malware written at that time (e.g. Careto or Regin). The code and structure is similar to the Casper implant\nwhich is most likely based on this implant. The malware contains an obvious design flaw leaving the main part of the\nconfiguration data visible in clear text.\n\n[AutoFocus customers can identify this, and other samples related to it using the Snowball](https://autofocus.paloaltonetworks.com/)\nWildFire and Traps properly classify Snowball samples as malicious.\n\nThanks to Esmid Idrizovic for his assistance in this analysis.\n\n## Indicators of Compromise:\n\n**Hashes (SHA-256)**\n\nLoader: c71b1a31bdf3a08fa99ed1f6a1c5ded61e66f3d41e4ed88a12430d1c14ed10ca\n\nPayload DLL: a9220590d3c35fe22df9d38a066ca8d112b83764b39fea98b38761daa64c77b8\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-09-06 - Analysing a 10-Year-Old SNOWBALL.pdf"
    ],
    "report_names": [
        "2017-09-06 - Analysing a 10-Year-Old SNOWBALL.pdf"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f5bf6853-3f6e-452c-a7b7-8f81c9a27476",
            "created_at": "2023-01-06T13:46:38.677391Z",
            "updated_at": "2025-03-27T02:00:02.889755Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "MISPGALAXY:Careto",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e09a7338-fb16-4e39-b579-c3bfc3140c47",
            "created_at": "2022-10-25T16:07:24.207294Z",
            "updated_at": "2025-03-27T02:02:10.140203Z",
            "deleted_at": null,
            "main_name": "Snowglobe",
            "aliases": [
                "ATK 8",
                "Animal Farm",
                "SIG20",
                "Snowglobe"
            ],
            "source_name": "ETDA:Snowglobe",
            "tools": [
                "Babar",
                "Casper",
                "Chocopop",
                "Dino",
                "EvilBunny",
                "Nbot",
                "TFC",
                "Tafacalou"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "548a4081-aa8f-4e2a-bcb3-0c9dfa61944f",
            "created_at": "2023-01-06T13:46:38.443779Z",
            "updated_at": "2025-03-27T02:00:02.835042Z",
            "deleted_at": null,
            "main_name": "SNOWGLOBE",
            "aliases": [
                "Snowglobe",
                "ATK8",
                "Animal Farm"
            ],
            "source_name": "MISPGALAXY:SNOWGLOBE",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536050,
    "ts_updated_at": 1743041697,
    "ts_creation_date": 1653760853,
    "ts_modification_date": 1653760853,
    "files": {
        "pdf": "https://archive.orkl.eu/5732881d303db1ca7c49d1e53ef5a6abbac5cf38.pdf",
        "text": "https://archive.orkl.eu/5732881d303db1ca7c49d1e53ef5a6abbac5cf38.txt",
        "img": "https://archive.orkl.eu/5732881d303db1ca7c49d1e53ef5a6abbac5cf38.jpg"
    }
}