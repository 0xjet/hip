{
    "id": "d72f9b2d-a39a-4832-850d-932f76a10af6",
    "created_at": "2023-01-12T15:03:58.018138Z",
    "updated_at": "2025-03-27T02:05:44.436514Z",
    "deleted_at": null,
    "sha1_hash": "9db9a5b377c09542c2f9f3d6abbbe36e021165db",
    "title": "2021-03-27 - Malware Analysis with elastic-agent and Microsoft Sandbox",
    "authors": "",
    "file_creation_date": "2022-05-27T21:58:54Z",
    "file_modification_date": "2022-05-27T21:58:54Z",
    "file_size": 328260,
    "plain_text": "# SANS ISC: Malware Analysis with elastic-agent and Microsoft Sandbox - SANS Internet Storm Center SANS Site Network Current Site SANS Internet Storm Center Other SANS Sites Help Graduate Degree Programs Security Training Security Certification Security Awareness Training Penetration Testing Industrial Control Systems Cyber Defense Foundations DFIR Software Security Government OnSite Training SANS ISC InfoSec Forums\n\n**[isc.sans.edu/forums/diary/Malware+Analysis+with+elasticagent+and+Microsoft+Sandbox/27248/](https://isc.sans.edu/forums/diary/Malware+Analysis+with+elasticagent+and+Microsoft+Sandbox/27248/)**\n\nMalware Analysis with elastic-agent and Microsoft Sandbox\n\n\nMicrosoft describes the \"Windows Sandbox supports simple configuration files, which provide a minimal set of\ncustomization parameters for Sandbox. [...] Windows Sandbox configuration files are formatted as XML and are\n[associated with Sandbox via the .wsb file extension.\"[6]](http://windows%20sandbox%20supports%20simple%20configuration%20files%2C%20which%20provide%20a%20minimal%20set%20of%20customization%20parameters%20for%20sandbox.%20this%20feature%20can%20be%20used%20with%20windows%2010%20build%2018342%20or%20later./)\n\n[Since both, the latest version elastic-agent (7.11+) support antivirus detection, I followed the instructions listed here [1] to](https://www.elastic.co/blog/how-to-build-a-malware-analysis-sandbox-with-elastic-security)\nconfigure an agent to test its detection capabilities. For my workstation, I used VMware with a fully patched Windows 10\nand saved the current configuration with a snapshot. I wanted to combine both of these features; the elastic-agent and the\n[Microsoft sandbox feature [4][5][6] to analyze my malware sample. Since the Microsoft sandbox doesn't retain anything](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-sandbox/windows-sandbox-overview)\nafter it is shutdown, I figure this would be a good alternative vs. restoring my previous VMware snapshot every time I\ntested a suspicious filename.\n\nOne minor inconvenient, if I want to use the agent, I need to add it every time to Elasticsearch to use it. If the elastic-agent\nisn't installed, Microsoft Defender is enabled. Here is a list of tools to either install or consider installing in the sandbox\nwhen it starts:\n\nElastic-agent with malware policy (in VMware client and Sandbox client)\nMS [SysMon](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)\nMS [TCPView](https://docs.microsoft.com/en-us/sysinternals/downloads/tcpview)\n[Consider adding: PowerShell Script Block Logging, example here](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows?view=powershell-7.1)\nWireshark to capture traffic from host\nOther browsers: Chrome & Firefox\n[PeStudio](https://www.winitor.com/features)\nPython\n[Internet Services Simulation Suite: INetSim](https://www.inetsim.org/documentation.html)\n[Didier Stevens suite of tools](https://blog.didierstevens.com/didier-stevens-suite/)\nProxy setup on VMware client to monitor traffic\n[Any other tools you might find useful during the analysis such as this package by](https://github.com/mentebinaria/retoolkit?s=09) [@mentebinaria](https://twitter.com/mentebinaria)\n\nWhen starting the sandbox, using a script configured for this purpose, it can automatically load the tools needed with a\nbatch file (MalwareAnalysis.wsb). Here is my example:\n\n<Configuration>\n\n<vGPU>Enable</vGPU>\n\n<AudioInput>Enable</AudioInput>\n\n<VideoInput>Enable</VideoInput>\n\n<ProtectedClient>Enable</ProtectedClient>\n\n<MappedFolders>\n\n<MappedFolder>\n\n<HostFolder>C:\\Sandbox</HostFolder>\n\n<ReadOnly>true</ReadOnly>\n\n</MappedFolder>\n\n</MappedFolders>\n\n<LogonCommand>\n\n<Command>C:\\users\\WDAGUtilityAccount\\Desktop\\Sandbox\\SBConfig.bat</Command>\n\n</LogonCommand>\n\n</Configuration>\n\nBecause everything is deleted when you shutdown the sandbox (including the browser, it must be reloaded with the\ncurrent version every time), I needed a way to automatically start/add/load/update what I needed to perform some basic\nanalysis. I use a batch file I preconfigured with everything I needed to accomplish this task. Here is what I have\n(C:\\Sandbox\\SBConfig.bat):\n\nREM Copy elastic-agent to C:\\Program Files\n\nC:\\Windows\\System32\\xcopy.exe /i /s C:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\elastic-agent \"C:\\Program\nFiles\\elastic-agent\"\n\n\nGuy\n\n522\nPosts\n\nISC\nHandler\nMar\n27th\n2021\n\n\n-----\n\ny, _\nC:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\Sysmon64.exe -i -accepteula\nC:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\vcredist_x86.exe /q\n\nREM Add Elastic certificate authority to Sandbox\nC:\\Windows\\System32\\certutil.exe -addstore root C:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\ca.crt\nC:\\Windows\\System32\\certutil.exe -addstore root C:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\stargate.crt\n\nREM Install new Microsoft Edge\nstart /wait C:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\MicrosoftEdgeEnterpriseX64.msi /quiet /norestart\n\nREM Install Python\nC:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\python-3.9.2-amd64.exe /quiet InstallAllUsers=1 PrependPath=1\nInclude_test=0\n\nREM Execute PowerShell scripts\nPowershell.exe -executionpolicy remotesigned -File\nC:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\ChangeExecutionPolicy.ps1\nPowershell.exe -executionpolicy remotesigned -File\nC:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\ScriptBlockLogging.ps1\n\nREM Install Wireshark\nREM Install npcap manually. Silent only supported with OEM\nC:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\Wireshark-win64-3.4.4.exe /S /D /desktopicon=yes\nC:\\Users\\WDAGUtilityAccount\\Desktop\\Sandbox\\npcap-1.20.exe\n\nThe file npcap is last because I'm using the free edition vs. the OEM which will ask to finish the installation after it starts\n[the installer. Before you can enable ScriptBlockLogging in the Sandbox, I need to enable the PowerShell ExecutionPolicy](https://go.microsoft.com/fwlink/?LinkID=135170)\nto allow RemoteSigned. This is the command in my script to make that change (ChangeExecutionPolicy.ps1):\n\nSet-ExecutionPolicy -ExecutionPolicy RemoteSigned -Force\n\nTo verify the change was applied, as PowerShell admin, execute the following command:\n\nGet-ExecutionPolicy -List\n\nProducing the following result:\n\n[Following the example listed here in this Elastic blog, it is time to create a policy, add the](https://www.elastic.co/blog/how-to-build-a-malware-analysis-sandbox-with-elastic-security) [elastic-agent to Elasticsearch](https://www.elastic.co/downloads/elastic-agent)\n(pre-copied with the batch file SBConfig.bat) to run the sample file and monitor its activity. This is the four application part\nof the policy I configured for my agent:\n\nAfter launching the script MalwareAnalysis.wsb to start the Sandbox, load, copy and install all the applications from the\nbatch file, it is time to add the elastic-agent to the server, I am ready to launch the suspected malware file for analysis.\nLast month, my honeypot was uploaded a crypto miner file photo.scr and I'm going to use this file to submit the elasticagent for analysis.\n\n\n-----\n\nâ†’ To view the results in Kibana, navigate Security -> Overview -> Detection alert trend\n\nI look for activity that would indicate an alert triggered by malware and filter for the value, then View alerts to examine the\nflow of the activity. I can then select Analyze the content as to what this photo.scr file accessed or installed on the client.\nThe agent captured 3 alerts:\n\nNext is to expand one of those alerts and analyze the activity, the elastic-agent identified: 1 library, 53 networks and 7\nregistry:\n\n**Network Activty**\n\n\n-----\n\n**Registry Activity**\n\nEach one of the can be expanded to drill further into what happened on the host.\n\n**Indicator of Compromise**\n\nSHA256\n807126cbae47c03c99590d081b82d5761e0b9c57a92736fc8516cf41bc564a7d Photo.scr\n\n[2021-02-08 07:06:36] [1693] [ftp_21_tcp 29914] [103.232.236.239:64149] info: Stored 1578496 bytes of data\n\nDomains\n\nstafftest[.]ru\niqtesti[.]ru\njobtests[.]ru\nprtests[.]ru\nqptest[.]ru\npstests[.]ru\ntestpsy[.]ru\nprofetest[.]ru\nhrtests[.]ru\n\nThis is one of many tasks Windows Sandbox could be used such as accessing suspicious sites, running untrusted\nsoftware and scripts starting with Windows network or vGPU disable, without the fear of impacting your normal Windows\ninstallation. These various tasks can be accomplished by creating separate .wsb Sanbox script.\n\n[1] https://www.elastic.co/blog/how-to-build-a-malware-analysis-sandbox-with-elastic-security\n\n[2] https://www.elastic.co/endpoint-security/\n\n[3] https://www.elastic.co/guide/en/security/current/install-endpoint.html\n\n[4] https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-sandbox/windows-sandbox-overview\n\n[5] https://techcommunity.microsoft.com/t5/windows-kernel-internals/windows-sandbox/ba-p/301849\n\n\n-----\n\n[ ] p y p g\nusing-wsb-file\n\n[7] https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon\n\n[8] https://docs.microsoft.com/en-us/sysinternals/downloads/tcpview\n\n[9] https://github.com/mentebinaria/retoolkit?s=09\n\n[10]\nhttps://www.virustotal.com/gui/file/807126cbae47c03c99590d081b82d5761e0b9c57a92736fc8516cf41bc564a7d/detection\n\n[11] https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows?\nview=powershell-7.1\n\n----------Guy Bruneau [IPSS Inc.](http://www.ipss.ca/)\n[My Handler Page](https://handlers.sans.org/gbruneau/)\nTwitter: [GuyBruneau](https://twitter.com/guybruneau)\ngbruneau at isc dot sans dot edu\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-27 - Malware Analysis with elastic-agent and Microsoft Sandbox.pdf"
    ],
    "report_names": [
        "2021-03-27 - Malware Analysis with elastic-agent and Microsoft Sandbox.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535838,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653688734,
    "ts_modification_date": 1653688734,
    "files": {
        "pdf": "https://archive.orkl.eu/9db9a5b377c09542c2f9f3d6abbbe36e021165db.pdf",
        "text": "https://archive.orkl.eu/9db9a5b377c09542c2f9f3d6abbbe36e021165db.txt",
        "img": "https://archive.orkl.eu/9db9a5b377c09542c2f9f3d6abbbe36e021165db.jpg"
    }
}