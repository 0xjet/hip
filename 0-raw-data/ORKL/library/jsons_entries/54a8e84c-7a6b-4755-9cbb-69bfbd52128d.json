{
    "id": "54a8e84c-7a6b-4755-9cbb-69bfbd52128d",
    "created_at": "2024-11-01T02:05:45.571079Z",
    "updated_at": "2025-03-27T02:09:18.123794Z",
    "deleted_at": null,
    "sha1_hash": "e490dcd318801b540bcbcfdcca66132175a1990d",
    "title": "ClickOnce and Youre In - BH Final",
    "authors": "",
    "file_creation_date": "2019-07-28T23:56:57Z",
    "file_modification_date": "2019-07-28T23:56:57Z",
    "file_size": 19132656,
    "plain_text": "## CLICKONCE AND YOU’RE IN:\n\n### When .appref-ms abuse is operating as intended\n\n\n-----\n\n# ClickOnce and you re in\n\n##### § Speaker Introduction\n\n § The End of the Golden Age\n\n § Compendium of ClickOnce\n\n § Aquaman, King of the Phish\n\n § Sleeper Cells: C2 Management\n\n § A Little Help for my Friends\n\n § Closing Questions\n\n\n-----\n\n## SPEAKER INTRODUCTION\n\n\n-----\n\n# Speaker Introduction – @0xF4B0\n\n##### § William Joseph Burke IV\n\n § CISA Red Team Lead\n\n###### § Provide red team ops for whole federal sector\n\n##### § 15 Years across intelligence & cyber fields\n\n###### § Military, Private, and Public sectors\n\n##### § Linguistics, NetAdmin, SysAdmin, Operations\n\n § Adjunct Graduate Professor, Marymount University\n\n § OSCP, GXPN, GPEN, GCIH, GWAPT, eCPPT, CORIII, CNDA,\n CEH, Sec+, CISSP\n\n\n-----\n\n## THE END OF THE GOLDEN AGE\n\n\n-----\n\n# The End of the Golden Age\n\n##### § Initial access via phishing used to be simple\n\n###### § Batch script Object Linking & Embedding (OLE) in Word documents\n\n § Basic scripts delivered via HTTP Application (HTA)\n\n § …Pretty much everything Windows 7\n\n##### § As time ticked through the hourglass, difficulty increased\n\n###### § Windows Defender / Antimalware Scan Interface (AMSI)\n\n § Permitted filetypes for execution via OLE’s are increasingly limited\n\n § Additional layers of barriers preventing entry\n\n § …Pretty much everything Windows 10\n\n\n-----\n\n# The End of the Golden Age\n\n##### § The resulting operational need:\n\n###### § Additional methods of code execution\n\n § Delivery as either an attachment, hyperlink, or OLE\n\n##### § Capabilities needed to work in the following environments:\n\n###### § Native, fully patched Windows 10 with Defender enabled\n\n § Native, fully patched Windows 7 with third party anti-virus enabled\n\n § Cooperate with the Cobalt Strike Command & Control (C2) platform\n\n##### § Focus of research was on delivery and execution of code\n\n\n-----\n\n# The End of the Golden Age\n\n##### § So, where to begin? Let’s take a journey…\n\n § OLE delivery was the first item of interest\n\n###### § Inspired by .SettingContent-ms research by Matt Nelson (@enigma0x3)\n\n § Cross-referenced native Win 10 executable formats to the OLE blacklist\n\n § Research available executable formats for delivery potential\n\n § This resulted in a preliminary list which was narrowed down to:\n\n .appref-ms .appx .cat .webpnp .wcx\n\n § These filetypes were individually researched for potential manipulation\n\n|.appref-ms|.appx|.cat|.webpnp|.wcx|\n|---|---|---|---|---|\n\n\n-----\n\n# The End of the Golden Age\n\n\n-----\n\n# The End of the Golden Age\n\n##### § So, where to begin? Let’s take a journey…\n\n § OLE delivery was the first item of interest\n\n###### § Inspired by .SettingContent-ms research by Matt Nelson (@enigma0x3)\n\n § Cross-referenced native Win 10 executable formats to the OLE blacklist\n\n § Research available executable formats for delivery potential\n\n § This resulted in a preliminary list which was narrowed down to:\n\n .appref-ms .appx .cat .webpnp .wcx\n\n § These filetypes were further researched for potential manipulation\n\n|.appref-ms|.appx|.cat|.webpnp|.wcx|\n|---|---|---|---|---|\n\n\n-----\n\n# A New Light Arises\n\n##### § While researching the extension formats, this caught my eye\n\n You had my curiosity, but now you have my attention\n\n\n-----\n\n# A New Light Arises\n\n##### § No prior research on .appref-ms abuse was discovered\n\n § ClickOnce is the application that runs the .appref-ms filetype\n\n § Now, some great prior research on ClickOnce was discovered\n\n###### § Ryan Gandrud, NETSPI 2015\n\n § Justin Warner (@sixdub), 2015 \n\n § @Bohops, 2018\n\n##### § However, their research focused on a very different aspect\n\n § Ultimately obtained execution while “operating as intended”\n\n\n-----\n\n## COMPENDIUM OF CLICKONCE\n\n\n-----\n\n# A ClickOnce Summary\n\n##### § Intended use of ClickOnce follows this type of path:\n\n###### § An application is developed in C# within Visual Studio\n\n § The application is published either to a share or remote server\n\n (Your average developer) (Your average share)\n\n##### Published as “Online only” or “Online or Offline” access\n\n###### (This becomes important later)\n\n\n-----\n\n# A ClickOnce Summary\n\n##### § The root folder of the published directory could contain:\n\n###### § publish.htm - landing page for the application\n\n § .application file – Initiates web installation for the application\n\n § setup.exe, raw installer for the program\n\n § ”Application Files” folder – Stores the app version, manifest, & deploy files\n\n\n-----\n\n# A ClickOnce Summary\n\n##### § It’s incredibly simple for the end user to install the program:\n\n###### § Launch the .application link through a web browser, execution is automated\n\n § Launch or install the application from the publish.htm page and run it\n\n (Your average share) (Your average end user)\n\n##### These methods will always install the latest version of the app\n\n\n-----\n\n# A ClickOnce Summary\n\n##### § Installation differs between ”Online only” and “Online & Offline”\n\n###### § Established when the application is deployed\n\n##### § Online Only: Drops files to temp directory and runs\n\n\n-----\n\n# A ClickOnce Summary\n\n##### § And that’s it! Simple way for a dev to get their app deployed\n\n###### (So simple Google uses ClickOnce to install chrome via IE)\n\n\n-----\n\n# But what about .appref-ms?\n\n##### § In both “Online only” and “Online or Offline” availability:\n\n###### § Files are dropped to the following directory  C:\\Users\\<username>\\AppData\\Local\\Apps\\2.0\\<Random String>\n\n##### § In Online Only deployment the application is ran a single time\n\n § In ”Online or Offline” availability some additional work is done\n\n###### § Two major actions are performed as the “installation”\n\n § A registry key is added under\n HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\n\n § An application reference file (!) is installed under the user’s start menu\n\n\n-----\n\n# But what about .appref-ms?\n\n##### § The application reference (.appref-ms) file runs the application\n\n § If the .appref-ms file is executed, it will:\n\n###### § Check the deployment site to see if there is an update\n\n § Will download any required or missing files and run the application\n\n § If the developer mandates the latest version, it will force an update\n\n § So if we send an .appref-ms file in an e-mail…\n\n\n-----\n\n## AQUAMAN, KING OF THE PHISH\n\n\n-----\n\n# Application Deployment\n\n##### § Pre-Deployment requirements\n\n###### § C# code that bypasses your defensive mechanism of choice upon execution\n\n § Code signing certificate (if deploying externally)\n\n § A method to clean up files / stop the IOC’s below:\n\n##### § Methods for removing the following should be in your C# code:\n\n###### § Reg Key:\n\n HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\<key>\n\n § Directory & Files:\n\n C:\\Users\\<username>\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\<Application name>\\<Application Files>\n\n § Example code is provided in the white paper\n\n\n-----\n\n# Application Deployment\n\n##### § With the code in place, it’s time to deploy\n\n § Publishing options sets your deployment configurations\n\n###### § For .appref-ms use, “available offline as well” must be selected\n\n § Any version number can be arbitrarily set\n\n\n-----\n\n# Application Deployment\n\n##### § The options section opens up some additional configurations\n\n###### § Here you can mandate when and how the application checks for updates\n\n § You can also specify a minimum required version\n\n § If the current version does not match the required minimum, it will force install\n\n\n-----\n\n# Application Deployment\n\n##### § Two ways to generate your own .appref-ms file:\n\n###### § Test on a host you own and copy the .appref-ms from the startup folder\n\n § A better option would be to create your own!\n\n § Saves time on continuous testing\n\n (Especially if using self-cleaning deployment)\n\n##### § An .appref-ms file consists of the following in a single line\n\n###### § URL_to_App#<name>, Culture, Public Key Token, Processor Architecture\n\n § This information is in the “Assembly Identity” section of the .application file\n\n Name Token Culture Arch\n\n\n-----\n\n# Application Deployment\n\n##### § You can put the information into a text file as a single line\n\n § The file must be saved with UTF-16 LE encoding\n\n###### § Shout out to Alex Feinberg’s blog post from 2014\n\n##### § Save as an .appref-ms file and it is ready to go!\n\n § At this point we are ready to move to delivery\n\n\n-----\n\n# You re .appref-ms ing with me\n\n##### § Lazy mode: It could be attached directly to an e-mail\n\n###### § the .appref-ms file isn’t flagged as malicious once attached or on download\n\n\n-----\n\n# You re .appref-ms ing with me\n\n#### Totally innocuous OLE\n\n\n-----\n\n# You re .appref-ms ing with me\n\n##### 1) Word document delivered\n\n 2) .appref-ms opened\n\n\n-----\n\n# You re .appref-ms ing with me\n\n##### 3) Once install is clicked…\n\n 4) Gondor calls for aid! We’ve got beacons\n\n\n-----\n\n# You re .appref-ms ing with me\n\n\n-----\n\n# Lateral Movement Rundown\n\n##### § Lateral movement could be obtained by combining .appref-ms\n deployment with other capabilities\n\n § Example 1: If you can move files remotely you could push the\n .appref-ms file to the remote user’s startup folder\n\n § Example 2: Run the application with psexec\n\n###### § Call the .application deployment link by invoking dfshim.dll with rundll32\n\n § Not appref-ms specific - can also be used in online only deployments\n\n##### § The user will still need to approve the initial installation\n\n###### § Social engineering still at play – name your application accordingly\n\n § Once installed the user will no longer be prompted for execution or updates\n\n\n-----\n\n## SLEEPER CELLS: C2 MGMT\n\n\n-----\n\n# C2 Management\n\n###### = C2 Communication\n\n = Periodic .appref-ms execution\n\n (Your average operator)\n\n\n-----\n\n# C2 Management\n\n###### = C2 Denied\n\n = Periodic .appref-ms execution\n\n (Your average operator)\n\n\n-----\n\n# C2 Management\n\n###### = C2 has ceased to be, it is no more\n\n = Periodic .appref-ms execution\n\n = Update pushed to server\n\n (Your average operator)\n\n\n-----\n\n# C2 Management\n\n###### = Update pulled from server on next Ex\n\n (Your average operator)\n\n\n-----\n\n# C2 Management\n\n###### = C2 communication reestablished!\n\n (Your average operator)\n\n\n-----\n\n# C2 Management\n\n##### § Operational requirements may necessitate “lifelines”\n\n###### § Compromised hosts in an environment that can be utilized as backdoors\n\n##### § By using ClickOnce’s update management capability, you can:\n\n###### § Have non-malicious code running on a remote host\n\n § Use an .appref-ms file to run on a schedule, startup, etc.\n\n § When it runs it will check for an update\n\n § If you lose access to your environment - push a malicious update!\n\n § The next time it checks in, if updates are forced it will run your malicious code\n\n § Can also be used to create logic bombs – Maybe a future talk?\n\n\n-----\n\n# C2 Management - Demo\n\n\n-----\n\n## A LITTLE HELP (FOR MY FRIENDS)\n\n\n-----\n\n# IOCs & Defensive actions\n\n###### § Can be difficult to detect .appref-ms as it is “Living off the Land”\n\n § Blocking .appref-ms execution may or may not be an option\n\n § Activity within the AppData folder is not atypical\n\n##### § Monitor registry key modification\n\n###### § Addition and potential deletion of keys in the Uninstall tree\n\n##### § Train end users to report odd activity\n\n###### § Odd installation prompts\n\n § ClickOnce execution sequence\n\n##### § Continued efforts on post-execution detection\n\n\n-----\n\n## BLACKHAT TAKEAWAYS\n\n\n-----\n\n# 3 Takeaways:\n\n##### § .appref-ms is a versatile addition to any offensive toolbelt\n\n § Tinker - Be curious about “outside the box” applicability\n\n § Defender awareness of .appref-ms malicious activity\n\n\n-----\n\n## CLOSING QUESTIONS?\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://i.blackhat.com/USA-19/Wednesday/us-19-Burke-ClickOnce-And-Youre-In-When-Appref-Ms-Abuse-Is-Operating-As-Intended.pdf?_gl=1*16njas6*_gcl_au*NjAyMzkzMjc3LjE3MjQ4MDk4OTQ.*_ga*MTk5OTA3ODkwMC4xNzI0ODA5ODk0*_ga_K4JK67TFYV*MTcyNDgwOTg5NC4xLjEuMTcyNDgwOTk1Ny4wLjAuMA..&_ga=2.253743689.1512103758.1724809895-1999078900.1724809894"
    ],
    "report_names": [
        "us-19-Burke-ClickOnce-And-Youre-In-When-Appref-Ms-Abuse-Is-Operating-As-Intended.pdf?_gl=1*16njas6*_gcl_au*NjAyMzkzMjc3LjE3MjQ4MDk4OTQ.*_ga*MTk5OTA3ODkwMC4xNzI0ODA5ODk0*_ga_K4JK67TFYV*MTcyNDgwOTg5NC4xLjEuMTcyNDgwOTk1Ny4wLjAuMA..&_ga=2.253743689.1512103758.1724809895-1999078900.1724809894"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1730426745,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1564358217,
    "ts_modification_date": 1564358217,
    "files": {
        "pdf": "https://archive.orkl.eu/e490dcd318801b540bcbcfdcca66132175a1990d.pdf",
        "text": "https://archive.orkl.eu/e490dcd318801b540bcbcfdcca66132175a1990d.txt",
        "img": "https://archive.orkl.eu/e490dcd318801b540bcbcfdcca66132175a1990d.jpg"
    }
}