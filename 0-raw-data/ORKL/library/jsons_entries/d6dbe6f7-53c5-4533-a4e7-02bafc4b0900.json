{
    "id": "d6dbe6f7-53c5-4533-a4e7-02bafc4b0900",
    "created_at": "2023-01-12T15:08:03.670408Z",
    "updated_at": "2025-03-27T02:09:29.829674Z",
    "deleted_at": null,
    "sha1_hash": "7f54c1adbf696259ef2dd85c47d766794b4ea668",
    "title": "2021-09-17 - DirtyMoe- Code Signing Certificate",
    "authors": "",
    "file_creation_date": "2022-05-27T22:37:32Z",
    "file_modification_date": "2022-05-27T22:37:32Z",
    "file_size": 641825,
    "plain_text": "# DirtyMoe: Code Signing Certificate\n\n**decoded.avast.io/martinchlumecky/dirtymoe-3/**\n\nby [Martin ChlumeckýSeptember 17, 202126 min read](https://decoded.avast.io/author/martinchlumecky/)\n\n**Abstract**\n\n\nSeptember 17, 2021\n\n\nThe DirtyMoe malware uses a driver signed with a revoked certificate that can be\nseamlessly loaded into the Windows kernel. Therefore, one of the goals is to analyze how\nWindows works with a code signature of Windows drivers. Similarly, we will be also\ninterested in the code signature verification of user-mode applications since the user\naccount control (UAC) does not block the application execution even if this one is also\nsigned with a revoked certificate. The second goal is a statistical analysis of certificates that\nsign the DirtyMoe driver because the certificates are also used to sign other malicious\nsoftware. We focus on the determination of the certificate’s origin, prevalence, and a quick\nanalysis of the top 10 software signed with these certificates.\n\nContrary to what often has been assumed, Windows loads a driver signed with a revoked\ncertificate. Moreover, the results indicate that the UAC does not verify revocation online but\nonly via the system local storage which is updated by a user manually. DirtyMoe certificates\nare used to sign many other software, and the number of incidents is still growing.\nFurthermore, Taiwan and Russia seem to be the most affected by these faux signatures.\n\nOverall, the analyzed certificates can be declared as malicious, and they should be\nmonitored. The UAC contains a significant vulnerability in its code signature verification\nroutine. Therefore, in addition to the usual avoidance of downloading from usual sources,\nWindows users should also not fully rely on inbuilt protections only. Due to the flawed\ncertificate verification, manual verification of the certificate is recommended for executables\nrequiring elevated privileges.\n\n## 1. Introduction\n\n\n-----\n\nThe DirtyMoe malware is a complex malicious backdoor designed to be modularized,\nundetectable, and untrackable. The main aim of DirtyMoe is cryptojacking and DDoS\nattacks. Basically, it can do anything that attackers want. The previous study, published at\n[DirtyMoe: Introduction and General Overview, has shown that DirtyMoe also employs](https://decoded.avast.io/martinchlumecky/dirtymoe-1)\nvarious self-protection and anti-forensics mechanisms. One of the more significant\nsafeguards, defending DirtyMoe, is a rootkit. What is significant about the rootkit using is\nthat it offers advanced techniques to hide malicious activity on the kernel layer. Since\nDirtyMoe is complex malware and has undergone long-term development, therefore, the\nmalware authors have also implemented various rootkit mechanisms. The DirtyMoe: Rootkit\nDriver post examines the DirtyMoe driver functionality in detail.\n\nHowever, another important aspect of the rootkit driver is a digital signature. The rootkits\ngenerally exploit the system using a Windows driver. Microsoft has begun requiring the\ncode signing with certificates that a driver vendor is trusted and verified by a certification\nauthority (CA) that Microsoft trusts. Nonetheless, Windows does not allow the loading of\nunsigned drivers since 64-bit Windows Vista and later versions. Although the principle of\nthe code signing is correct and safe, Windows allows loading a driver that a certificate\nissuer has explicitly revoked the used certificate. The reasons for this behavior are various,\nwhether in terms of performance or backward compatibility. The weak point of this certificate\nmanagement is if malware authors steal any certificate that has been verified by Microsoft\nand revoked by CA in the past. Then the malware authors can use this certificate for\nmalicious purposes. It is precisely the case of DirtyMoe, which still signs its driver with\nstolen certificates. Moreover, users cannot affect the codesign verification via the user\naccount control (UAC) since drivers are loaded in the kernel mode.\n\nMotivated by the loading of drivers with revoked certificates, the main issues addressed in\nthis paper are analysis of mechanism how Windows operates with code signature in the\nkernel and user mode; and detailed analysis of certificates used for code signing of the\nDirtyMoe driver.\n\nThis paper first gives a brief overview of UAC and code signing of Windows drivers. There\nare also several observations about the principle of UAC, and how Windows manages the\ncertificate revocation list (CRL). The remaining part of the paper aims to review in detail the\navailable information about certificates that have been used to code signatures of the\nDirtyMoe driver.\n\nThus far, three different certificates have been discovered and confirmed by our research\ngroup as malicious. Drivers signed with these certificates can be loaded notwithstanding\ntheir revocation into the 64-bit Windows kernel. An initial objective of the last part is an\nanalysis of the suspicious certificates from a statistical point of view. There are three\nviewpoints that we studied. The first one is the geological origin of captured samples signed\nwith the malicious certificate. The second aspect is the number of captured samples,\nincluding a prediction factor for each certificate. The last selected frame of reference is a\nstatistical overview about a type of the signed software because the malware authors use\n\n\n-----\n\nthe certificates to sign various software, e.g., cracked software or other popular user\napplications that have been patched with a malicious payload. We have selected the top 10\nsoftware signed with revoked certificates and performed a quick analysis. Categories of this\nsoftware help us to ascertain the primarily targeted type of software that malware authors\nsigned. Another significant scope of this research is looking for information about\ncompanies that certificates have probably been leaked or stolen.\n\n## 2. Background\n\nDigital signatures are able to provide evidence of the identity, origin, and status of electronic\ndocuments, including software. The user can verify the validity of signatures with the\ncertification authority. Software developers use digital signatures to a code signing of their\nproducts. The software authors guarantee via the signature that executables or scripts have\nnot been corrupted or altered since the products have been digitally signed. Software users\ncan verify the credibility of software developers before run or installation.\n\nEach code-signed software provides information about its issuer, and an URL points to the\ncurrent certificate revocation list (CRL) known as the CRL Distribution Point. Windows can\nfollow the URL and check the validity of the used certificate. If the verification fails, the User\nAccount Control (UAC) blocks software execution that code-signature is not valid. Equally\nimportant is the code-signature of Windows drivers that use a different approach to digital\nsignature verification. Whereas user-mode software signatures are optional, the Windows\ndriver must be signed by a CA that Windows trusts. Driver signing is mandatory since 64-bit\nWindows Vista.\n\n2.1 User Account Control and Digital Signature\n\nWindows 10 prompts the user for confirmation if the user wants to run software with high\npermission. User Account Control (UAC) should help to prevent users from inadvertently\nrunning malicious software or other types of changes that might destabilize the Windows\nsystem. Additionally, UAC uses color coding for different scenarios – blue for a verified\nsignature, yellow for an unverified, and red for a rejected certificate; see Figure 1.\n\n**Figure 1: UAC of verified, unverified, and rejected software requiring the highest privileges**\n\n\n-----\n\nUnfortunately, users are the weakest link in the safety chain and often willingly choose to\nignore such warnings. Windows itself does not provide 100% protection against unknown\npublishers and even revoked certificates. So, user’s ignorance and inattention assist\nmalware authors.\n\n2.2 Windows Drivers and Digital Signature\n\nCertificate policy is diametrically different for Windows drivers in comparison to other usermode software. While user-mode software does not require code signing, code signing is\nmandatory for a Windows driver; moreover, a certificate authority trusted by Microsoft must\nbe used. Nonetheless, the certificate policy for the windows drivers is quite complicated as\nMSDN demonstrates [1].\n\n**2.2.1 Driver Signing**\n\nHistorically, 32-bit drivers of all types were unsigned, e.g., drivers for printers, scanners, and\nother specific hardware. Windows Vista has brought a new signature policy, but Microsoft\ncould not stop supporting the legacy drivers due to backward compatibility. However, 64-bit\nWindows Vista and later has to require digitally signed drivers according to the new policy.\nHence, 32-bit drivers do not have to be signed since these drivers cannot be loaded into the\n64-bit kernels. The code signing of 32-bit drivers is a good practice although the certificate\npolicy does not require it.\n\nMicrosoft has no capacity to sign each driver, more precisely file, provided by third-party\nvendors. Therefore, a cross-certificate policy is used to provide an instrument to create a\nchain of trust. This policy allows the release of a subordinate certificate that builds the chain\nof trust from the Microsoft root certification authority to multiple other CAs that Microsoft\naccredited. The current cross-certificate list is documented in [2]. In fact, the final driver\nsignature is done with a certificate that has been issued by the subordinate CA, which\nMicrosoft authorized.\n\nThe examples of the certificate chain illustrates Figure 2 and the following output of\n```\nsigntool ;\n\n```\nsee Figure 3.\n\n**Figure 2: Certification chain of**\n\none Avast driver\n\n\n-----\n\n**Figure 3:**\n\nOutput of signtool.exe for one Avast driver\n2.2.2 Driver Signature Verification\n\nFor user-mode software, digital signatures are verified remotely via the CRL list obtained\nfrom certificate issuers. The signature verification of Windows drivers cannot be performed\nonline compared with user-mode software because of the absence of network connection\nduring the kernel bootup. Moreover, the kernel boot must be fast and a reasonable\napproach to tackle the signature verification is to implement a light version of the verification\nalgorithm.\n\nThe Windows system has hardcoded root certificates of several CAs and therefore can\nverify the signing certificate chain offline. However, the kernel has no chance to\nauthenticate signatures against CRLs. The same is applied to expired certificates. Taken\ntogether, this approach is implemented due to kernel performance and backward driver\ncompatibility. Thus, leaked and compromised certificates of a trusted driver vendor causes a\nsevere problem for Windows security.\n\n## 3. CRL, UAC, and Drivers\n\nAs was pointed out in the previous section, CRL contains a list of revoked certificates. UAC\nshould verify the chain of trust of run software that requires higher permission. The UAC\ndialog then shows the status of the certificate verification. It can end with two statuses, e.g.,\nverified publisher or unknown publisher [3], see Figure 1.\n\n\n-----\n\nHowever, we have a scenario where software is signed with a revoked certificate and run is\nnot blocked by UAC. Moreover, the code signature is marked as the unknown publisher\n(yellow titled UAC), although the certificate is in CRL.\n\n3.1 Cryptographic Services and CRL Storage\n\nCryptographic Services confirms the signatures of Windows files and stores file information\ninto the `C:\\Users\\<user>\\AppData\\LocalLow\\Microsoft\\CryptnetUrlCache folder,`\nincluding the CRL of the verified file. The `CryptnetUrlCache folder (cache) is updated,`\nfor instance, if users manually check digital signatures via “Properties -> Digital Signature”\nor via the `signtool tools, as Figure 3 and Figure 4 illustrate. The certificate verification`\nprocesses the whole chain of trust, including CRL and possible revocations deposits in the\ncache folder.\n\n**Figure 4: List of digital signature**\n\nvia Explorer\nAnother storage of CRLs is `Certificate Storage accessible via the Certificate Manager`\nTool; see\n**Figure 5. This storage can be managed by local admin or domain.**\n\n\n-----\n\n**Figure 5: Certificate Manager Tool**\n3.2 CRL Verification by UAC\n\nUAC itself does not verify code signature, or more precisely chain of trust, online; it is\nprobably because of system performance. The UAC codesign verification checks the\nsignature and CRL via `CryptnetUrlCache and the system` `Certificate storage .`\nTherefore, UAC marks malicious software, signed with the revoked certificate, as the\nunknown publisher because `CryptnetUrlCache is not up-to-date initially.`\n\nSuppose the user adds appropriate CRL into `Certificate Storage manually using this`\ncommand:\n\n```\ncertutil -addstore -f Root CSC3-2010.crl\n\n```\n\nIn that case, UAC will successfully detect the software as suspicious, and UAC displays this\nmessage: “An administrator has blocked you from running this app.” without assistance\nfrom Cryptographic Services and therefore offline.\n\nThe Windows update does not include CRLs of cross-certificate authorities that Microsoft\nauthorized to codesign of Windows files. This fact has been verified via Windows updates\nand version as follow:\n\nWindows Malicious Software Removal Tool x64 – v5.91 (KB890830)\n2021-06 Cumulative update for Windows 10 Version 20H2 for x64-based System\n(KB5003690)\nWindows version: 21H1 (OB Build 19043.1110)\n\n\n-----\n\nIn summary, UAC checks digital signatures via the system local storage of CRL and does\nnot verify code signature online.\n\n3.3 Windows Driver and CRL\n\nReturning briefly to the codesign of the Windows driver that is required by the kernel. The\nkernel can verify the signature offline, but it cannot check CRL since Cryptographic Services\nand network access are not available at boot time.\n\nTurning now to the experimental evidence on the offline CRL verification of drivers. It is\nevident in the case described in Section 3.2 that UAC can verify CRL offline. So, the tested\nhypothesis is that the Windows kernel could verify the CRL of a loaded driver offline if an\nappropriate CRL is stored in `Certificate Storage . We used the DirtyMoe malware to`\ndeploy the malicious driver that is signed with the revocated certificate. The corresponding\nCRL of the revoked certificate has been imported into `Certificate Storage . However,`\nthe driver was still active after the system restart. It indicates that the rootkit was\nsuccessfully loaded into the kernel, although the driver certificate has been revoked and the\ncurrent CRL was imported into `Certificate Storage . There is a high probability that the`\nkernel avoids the CRL verification even from local storage.\n\n## 4. Certificate Analysis\n\nThe scope of this research are three certificates as follow:\n\n**Beijing Kate Zhanhong Technology Co.,Ltd.**\n\nValid From: 28-Nov-2013 (2:00:00)\n\nValid To: 29-Nov-2014 (1:59:59)\n\nSN: `3c5883bd1dbcd582ad41c8778e4f56d9`\n\nThumbprint: `02a8dc8b4aead80e77b333d61e35b40fbbb010a0`\n\nRevocation Status: Revoked on 22-May- 2014 (9:28:59)\n\nCRL Distribution Point: http://cs-g2-crl.thawte.com/ThawteCSG2.crl\n\nIoCs:\n```\n88D3B404E5295CF8C83CD204C7D79F75B915D84016473DFD82C0F1D3C375F968\n376F4691A80EE97447A66B1AF18F4E0BAFB1C185FBD37644E1713AD91004C7B3\n937BF06798AF9C811296A5FC1A5253E5A03341A760A50CAC67AEFEDC0E13227C\n\n```\n**Beijing Founder Apabi Technology Limited**\n\nValid From: 22-May-2018 (2:00:00)\n\nValid To: 29-May-2019 (14:00:00)\n\nSN: `06b7aa2c37c0876ccb0378d895d71041`\n\nThumbprint: `8564928aa4fbc4bbecf65b402503b2be3dc60d4d`\n\nRevocation Status: Revoked on 22-May- 2018 (2:00:01)\n\nCRL Distribution Point: http://crl3.digicert.com/sha2-assured-cs-g1.crl\n\nIoCs:\n\n\n-----\n\n```\nB0214B8DFCB1CC7927C5E313B5A323A211642E9EB9B9F081612AC168F45BF8C2\n5A4AC6B7AAB067B66BF3D2BAACEE300F7EDB641142B907D800C7CB5FCCF3FA2A\nDA720CCAFE572438E415B426033DACAFBA93AC9BD355EBDB62F2FF01128996F7\n\n```\n**Shanghai Yulian Software Technology Co., Ltd. (上海域联软件技术有限公司)**\nValid From: 23-Mar-2011 (2:00:00)\nValid To: 23-Mar-2012 (1:59:59)\nSN: `5f78149eb4f75eb17404a8143aaeaed7`\nThumbprint: `31e5380e1e0e1dd841f0c1741b38556b252e6231`\nRevocation Status: Revoked on 18-Apr- 2011 (10:42:04)\nCRL Distribution Point: http://csc3-2010-crl.verisign.com/CSC3-2010.crl\nIoCs:\n```\n15FE970F1BE27333A839A873C4DE0EF6916BD69284FE89F2235E4A99BC7092EE\n32484F4FBBECD6DD57A6077AA3B6CCC1D61A97B33790091423A4307F93669C66\nC93A9B3D943ED44D06B348F388605701DBD591DAB03CA361EFEC3719D35E9887\n\n```\n4.1 Beijing Kate Zhanhong Technology Co.,Ltd.\n\nWe did not find any relevant information about Beijing Kate Zhanhong Technology\ncompany. Avast captured 124 hits signed with the Beijing Kate certificates from 2015 to\n2021. However, prediction to 2021 indicates a downward trend; see Figure 6. Only 19 hits\nhave been captured in the first 7 months of this year, so the prediction for this year (2021) is\napprox. 30 hits signed with this certificate.\n\n**Figure 6: Number of hits and prediction of Beijing Kate**\nNinety-five percent of total hits have been located in Asia; see Table 1 for detailed GeoIP\ndistribution of the last significant years.\n\n\n-----\n\n**Year / Country** **CN** **TW** **UA** **MY** **KR** **HK**\n\n2015 15 1 3\n\n2018 3 1 2\n\n2019 19 2\n\n2020 12 46 1\n\n2021 11 8\n\n**Total** 60 48 3 3 8 2\n\n**Table 1: Geological distribution of Beijing Kate certificates**\nThe malware authors use this certificate to sign Windows system drivers in 61 % of\nmonitored hits, and Windows executables are signed in 16 % of occurrences. Overall, it\nseems that the malware authors focus on Windows drivers, which must be signed with any\nverified certificates.\n\n4.2 Beijing Founder Apabi Technology Limited\n\nThe Beijing Founder Apabi Technology Co., Ltd. was founded in 2001, and it is a\nprofessional digital publishing technology and service provider under Peking University\nFounder Credit Group. The company also develops software for e-book reading like Apabi\nReader [4].\n\nThe Beijing Founder certificate has been observed, as malicious, in 166 hits with 18 unique\nSHAs. The most represented sample is an executable called “Linking.exe” which was hit in\n8 countries, most in China; exactly 71 cases. The first occurrence and peak of the hits were\nobserved in 2018. The incidence of hits was an order of magnitude lower in the previous\nfew years, and we predict an increase in the order of tens of hits, as Figure 7 illustrates.\n\n\n-----\n\n**Figure**\n\n**7: Number of hits and prediction of Beijing Founder**\n4.3 Shanghai Yulian Software Technology Co., Ltd.\n\nThe Shanghai Yulian Software Technology Co. was founded in 2005, which provides\nnetwork security guarantees for network operators. Its portfolio covers services in the\ninformation security field, namely e-commerce, enterprise information security, security\nservices, and system integration [5].\n\nThe Shanghai Yulian Software certificate is the most widespread compared to others. Avast\ncaptured this certificate in 10,500 cases in the last eight years. Moreover, the prevalence of\nsamples signed with this certificate is on the rise, although the certificate was revoked by its\nissuer in 2011. In addition, the occurrence peak was in 2017 and 2020. We assume a linear\nincrease of the incidence and a prediction for 2021 is based on the first months of 2021.\nAnd therefore, the prediction for 2021 indicates that this revoked certificate will also\ndominate in 2021; see the trend in Figure 8. We have no record of what caused the\nsignificant decline in 2018 and 2019.\n\n\n-----\n\n**Figure 8: Number of hits and prediction of Shanghai Yulian Software**\nThe previous certificates dominate only in Asia, but the Shanghai Yulian Software certificate\nprevails in Asia and Europe, as Figure 9 illustrates. The dominant countries are Taiwan and\nRussia. China and Thailand are on a close hinge; see Table 2 for detailed country\ndistribution, several countries selected.\n\n**Figure 9:**\n\nDistribution of hits in point of continent view for Shanghai Yulian Software\n\n\n-----\n\n**Year / Country** **TW** **RU** **CN** **TH** **UA** **BR** **EG** **HK** **IN** **CZ**\n\n2016 6 18 2\n\n2017 925 28 57 4 1\n\n2018 265 31 79 4 3 26 4 1 2\n\n2019 180 54 56 10 9 98 162 5 45 1\n\n2020 131 1355 431 278 232 112 17 168 86 24\n\nTotal 1507 1468 641 292 244 242 183 174 131 28\n\n**Table 2: Geological distribution of Shanghai Yulian Software certificate**\nAs in previous cases, the malware authors have been using Shanghai Yulian Software\ncertificates to sign Windows drivers in 75 % of hits. Another 16 % has been used for EXE\nand DLL executable; see Figure 10 for detailed distribution.\n\n**Figure 10: Distribution of file types for**\n\nShanghai Yulian Software\n4.3.1 Analysis of Top 10 Captured Files\n\nWe summarize the most frequent files in this subchapter. Table 3 shows the occurrence of\nthe top 10 executables that are related to user applications. We do not focus on DirtyMoe\n[drivers because this topic is recorded at DirtyMoe: Rootkit Driver.](https://decoded.avast.io/martinchlumecky/dirtymoe-rootkit-driver)\n\n**Hit File Name** **Number of Hits** **Hit File Name** **Number of Countries**\n\nWFP_Drive.sys 1056 Denuvo64.sys 81\n\nLoginDrvS.sys 1046 WsAP-Filmora.dll 73\n\nDenuvo64.sys 718 SlipDrv7.sys 20\n\n\n-----\n\nWsAP-Filmora.dll 703 uTorrent.exe 47\n\nuTorrent.exe 417 RTDriver.sys 41\n\nSlipDrv7.sys 323 SlipDrv10.sys 42\n\nLoginNpDriveX64.sys 271 SbieDrv.sys 22\n\nRTDriver.sys 251 SlipDrv81.sys 16\n\nSlipDrv10.sys 238 ONETAP V4.EXE 16\n\nSbieDrv.sys 189 ECDM.sys 13\n\n**Table 3: The most common occurrence of the file names: hit count and number of countries**\nWe have identified the five most executables signed with Shanghai Yulian Software\ncertificate. The malware authors target popular and commonly used user applications such\nas video editors, communication applications, and video games.\n\n**1) WFP_Drive.sys**\n\nThe WFP driver was hit in a folder of App-V (Application Virtualization) in\n```\nC:\\ProgramData . The driver can filter network traffic similar to a firewall [6]. So, malware\n\n```\ncan block and monitor arbitrary connections, including transferred data. The malware does\nnot need special rights to write into the `ProgramData folder. The driver and App-V’s file`\nnames are not suspicious at first glance since App-V uses Hyper-V Virtual Switch based on\nthe WFP platform [7].\n\nNaturally, the driver has to be loaded with a process with administrator permission.\nSubsequently, the process must apply for a specific privilege called\n```\nSeLoadDriverPrivilege (load and unload device drivers) to successful driver loading.\n\n```\nThe process requests the privilege via API call `EnablePriviliges that can be monitored`\nwith AVs. Unfortunately, Windows loads drivers with revoked certificates, so the whole\nsecurity mechanism is inherently flawed.\n\n**2) LoginDrvS.sys**\n\nFurther, the `LoginDrvS driver uses a similar principle as the WFP driver. The malware`\ncamouflages its driver in a commonly used application folder. It uses the `LineageLogin`\napplication folder that is used as a launcher for various applications, predominantly video\ngames. `LineageLogin is implemented in Pascal [8]. The` `LineageLogin itself contains a`\nsuspicious embedded DLL. However, it is out of this topic. Both drivers (WFP_Drive.sys and\nLoginDrvS.sys) are presumably from the same malware author as their PDB paths indicate:\n```\n   f:\\projects\\c++\\win7pgkill\\amd64\\LoginDrvS.pdb (10 unique samples)\n\n```\n\n-----\n\n```\n   f:\\projects\\c++\\wfp\\objfre_win7_amd64\\amd64\\WFP_Drive.pdb (8 unique\n\n```\nsamples)\n\nSimilar behavior is described in Trojan.MulDrop16.18994, see [9].\n\n**3) Denuvo64.sys**\n\nDenuvo is an anti-piracy protection technique used by hundreds of programming companies\naround the world [10]. This solution is a legal rootkit that can also detect cheat mode and\nother unwanted activity. Therefore, Denuvo has to use a kernel driver.\n\nThe easy way to deploy a malicious driver is via cracks that users still download abundantly.\nThe malware author packs up the malicious driver into the cracks, and users prepare a\nrootkit backdoor within each crack run. The malicious driver performs the function that users\nexpect, e.g., anti-anti cheating or patching of executable, but it also services a backdoor\nvery often.\n\nWe have revealed 8 unique samples of Denuvo malicious drivers within 1046 cases. The\nmost occurrence is in Russia; see Figure 11. The most hits are related to video game\ncracks as follows: Constructor, Injustice 2, Prey, Puyo Puyo Tetris, TEKKEN 7 – Ultimate\n_Edition, Total War – Warhammer 2, Total.War – Saga Thrones of Britannia._\n\n**Figure 11: Distribution of**\n\nDenuvo driver across the countries\n**4) WsAP-Filmora.dll**\n\nWondershare Filmora is a simple video editor which has free and paid versions [11]. So,\nthere is a place for cracks and malware activities. All hit paths point to crack activity where\nusers tried to bypass the trial version of the Filmora editor. No PDB path has been captured;\ntherefore, we cannot determine the malware authors given other samples signed with the\nsame certificates. WsAP-Filmora.dll is widespread throughout the world (73 countries); see\nthe detailed country distribution in Figure 12.\n\n\n-----\n\n**Figure 12: Filmora DLL**\n\ndistribution across the countries\n**5) μTorrent.exe**\n\nμTorrent is a freeware P2P client for the BitTorrent network [12]. Avast has detected 417\nhits of malicious μTorrent applications. The malicious application is based on the original\nμTorrent client with the same functionality, GUI, and icon. If a user downloads and runs this\nupdated μTorrent client, the application’s behavior and design are not suspicious for the\nuser.\n\nThe original application is signed with Bit Torrent, Inc. certificate, and the malicious version\nwas signed with Shanghai Yulian Software certificate. Everyday users, who want to check\nthe digital signature, see that the executable is signed. However, information about the\nsignature’s suspiciousness is located in details that are not visible at first glance, Figure 13.\n\n**Figure 13: Digital signatures of original and malicious μTorrent client**\nThe malicious signature contains Chinese characters, although the sample’s prevalence\npoints to Russia. Moreover, China has no hits. Figure 14 illustrates a detailed country\ndistribution of the malicious μTorrent application.\n\n\n-----\n\n**Figure 14: Distribution of**\n\nμTorrent client across the countries\n4.3.2 YDArk Rootkit\n\n[We have found one Github repository which contains a YDArk tool that monitors system](https://github.com/ClownQq/YDArk)\nactivities via a driver signed with the compromised certificate. The last sign was done in\nMay 2021; hence it seems that the stolen certificate is still in use despite the fact that it was\nrevoked 10 years ago. The repository is managed by two users, both located in China. The\n[YDArk driver has been signed with the compromise certificates by ScriptBoy2077, who](https://github.com/ClownQq/YDArk/pull/6)\nadmitted that the certificate is compromised and expired by this note:\n\n“I have signed the .sys file with a compromised, expired certificate, may it is helpful to those\n_my friends who don’t know how to load an unsigned driver.”_\n\nThe private key of the compromised certificate is not available on the clearnet. We looked\nfor by the certificate name, serial number, hashes, etc.; hence we can assume that the\ncertificate and private key can be located in the darknet and shared within a narrow group\nof malware authors. Consequently, the relationship between YDArk, more precisely\nScriptBoy2077, and the DirtyMoe driver is compelling. Additionally, C&C DirtyMoe servers\nare also located in most cases in China, as we described in DirtyMoe: Introduction and\nGeneral Overview.\n\n## 5. Discussion\n\nThe most interesting finding of this research was that Windows allows loading drivers\nsigned with revoked certificates even if an appropriate CRL is locally stored. Windows\nsuccessfully verifies the signature revocation offline for user-mode applications via UAC.\nHowever, if Windows loads drivers with the revoked certificate into the kernel despite the\nup-to-date CRL, it is evident that the Windows kernel avoids the CRL check. Therefore, it is\nlikely that the missing implementation of CRL verification is omitted due to the performance\nat boot time. It is a hypothesis, so further research will need to be undertaken to fully\nunderstand the process and implementation of driver loading and CRL verification.\n\nAnother important finding was that the online CRL is not queried by UAC in digital\nsignatures verification for user-mode applications, which require higher permission. It is\nsomewhat surprising that UAC blocks the applications only if the user manually checks the\nchain of trust before the application is run; in other words, if the current CRL is downloaded\n\n\n-----\n\nand is up-to-date before the UAC run. So, the evidence suggests that neither UAC does not\nfully protect users against malicious software that has been signed with revoked certificates.\nConsequently, the users should be careful when UAC appears.\n\nThe DirtyMoe’s driver has been signing with three certificates that we analyzed in this\nresearch. Evidence suggests that DirtyMoe’s certificates are used for the code signing of\nother potentially malicious software. It is hard to determine how many malware authors use\nthe revoked certificates precisely. We classified a few clusters of unique SHA samples that\npoint to the same malware authors via PDB paths. However, many other groups cannot be\nunequivocally identified. There is a probability that the malware authors who use the\nrevoked certificates may be a narrow group; however, further work which compares the\ncode similarities of signed software is required to confirm this assumption. This hypothesis\nis supported by the fact that samples are dominantly concentrated in Taiwan and Russia in\nsuch a long time horizon. Moreover, leaked private keys are often available on the internet,\nbut the revoked certificates have no record. It could mean that the private keys are passed\non within a particular malware author community.\n\nAccording to these data, we can infer that the Shanghai Yulian Software Technology\ncertificate is the most common use in the wild and is on the rise, although the certificate\nwas revoked 10 years ago. Geological data demonstrates that the malware authors target\nthe Asian and European continents primarily, but the reason for this is not apparent;\ntherefore, questions still remain. Regarding types of misused software, the analysis of\nsamples signed with the Shanghai Yulian Software certificate confirmed that most samples\nare rootkits deployed together with cracked or patched software. Other types of misused\nsoftware are popular user applications, such as video games, communication software,\nvideo editors, etc. One of the issues is that the users observe the correct behavior of\nsuspicious software, but malicious mechanisms or backdoors are also deployed.\n\nIn summary, the DirtyMoe’s certificates are still used for code signing of other software than\nthe DirtyMoe malware, although the certificates were revoked many years ago.\n\n## 6. Conclusion\n\nThe malware analysis of the DirtyMoe driver (rootkit) discovered three certificates used for\ncodesign of suspicious executables. The certificates have been revoked in the middle of\ntheir validity period. However, the certificates are still widely used for codesign of other\nmalicious software.\n\nThe revoked certificates are principally misused for the code signature of malicious\nWindows drivers (rootkits) because the 64bit Windows system has begun requiring the\ndriver signatures for greater security. On the other hand, Windows does not implement the\nverification of signatures via CRL. In addition, the malware authors abuse the certificates to\nsign popular software to increase credibility, whereas the software is patched with malicious\npayloads. Another essential point is that UAC verifies the signatures against the local CRL,\n\n\n-----\n\nwhich may not be up-to-date. UAC does not download the current version of CRL when\nusers want to run software with the highest permission. Consequently, it can be a serious\nweakness.\n\nOne source of uncertainty is the origin of the malware authors who misused the revoked\ncertificates. Everything points to a narrow group of the author primarily located in China.\nFurther investigation of signed samples are needed to confirm that the samples contain\npayloads with similar functionality or code similarities.\n\nOverall, these results and statistics suggest that Windows users are still careless when\nrunning programs downloaded from strange sources, including various cracks and keygens.\nMoreover, Windows has a weak and ineffective mechanism that would strongly warn users\nthat they try to run software with revoked certificates, although there are techniques to verify\nthe validity of digital signatures.\n\n## References\n\n[1] [Driver Signing](https://docs.microsoft.com/en-us/windows-hardware/drivers/install/driver-signing)\n\n[2] [Cross-Certificates for Kernel Mode Code Signing](https://docs.microsoft.com/en-us/windows-hardware/drivers/install/cross-certificates-for-kernel-mode-code-signing)\n\n[3] How Windows Handles Running Files Whose Publisher’s Certificate(s) Have Been\nRevoked\n\n[4] [Beijing Founder Apabi Technology Limited](http://www.apabi.com/lcsd?pid=about&cult=US)\n\n[5] [Shanghai Yulian Software Technology Co., Ltd.](https://m.kanzhun.com/company/gsxy/3nB739-_.html)\n\n[6] [WFP network monitoring driver (firewall)](https://blog.csdn.net/weixin_39898550/article/details/111741695)\n\n[7] [Hyper-V Virtual Switch](https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v-virtual-switch/hyper-v-virtual-switch)\n\n[8] [Lineage Login](https://github.com/smx06/l1login/tree/master/%20l1login/l1loginproject/Login)\n\n[9] [Dr. Web: Trojan.MulDrop16.18994](https://vms.dataprotection.com.ua/virus/?i=23866112&lng=uk)\n\n[10] [Denuvo](https://irdeto.com/denuvo/)\n\n[11] [Filmora](https://filmora.wondershare.net/video-editor)\n\n[12] [μTorrent](https://www.utorrent.com/)\n\n[Tagged asCertificate,](https://decoded.avast.io/tag/certificate/) [DirtyMoe,](https://decoded.avast.io/tag/dirtymoe/) [Rootkit,](https://decoded.avast.io/tag/rootkit/) [series](https://decoded.avast.io/tag/series/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-17 - DirtyMoe- Code Signing Certificate.pdf"
    ],
    "report_names": [
        "2021-09-17 - DirtyMoe- Code Signing Certificate.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536083,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1653691052,
    "ts_modification_date": 1653691052,
    "files": {
        "pdf": "https://archive.orkl.eu/7f54c1adbf696259ef2dd85c47d766794b4ea668.pdf",
        "text": "https://archive.orkl.eu/7f54c1adbf696259ef2dd85c47d766794b4ea668.txt",
        "img": "https://archive.orkl.eu/7f54c1adbf696259ef2dd85c47d766794b4ea668.jpg"
    }
}