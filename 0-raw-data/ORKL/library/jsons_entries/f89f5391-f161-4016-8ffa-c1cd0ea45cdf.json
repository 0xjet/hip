{
    "id": "f89f5391-f161-4016-8ffa-c1cd0ea45cdf",
    "created_at": "2022-10-25T16:48:23.761744Z",
    "updated_at": "2025-03-27T02:16:59.161864Z",
    "deleted_at": null,
    "sha1_hash": "ca2fca09fe4df5eced75d49dca36239dba71df16",
    "title": "Carberp - A modular information stealing trojan",
    "authors": "",
    "file_creation_date": "2011-02-28T18:27:27Z",
    "file_modification_date": "2011-02-28T18:27:27Z",
    "file_size": 1007620,
    "plain_text": "# Carberp - a modular information stealing trojan\n\n**Marco Giuliani**\nHead of Prevx Advanced Malware Research Team\n\n**Andrea Allievi**\nPrevx Malware Analyst\n\n\n-----\n\n# PREFACE\n\n## Nowadays most banking operations and payments are done on the web, through e-banking services and online payment solutions, like MoneyBookers or Paypal. Since online transactions are increasing their volume, malware authors are focusing more and more on the development of malicious software able to steal sensitive data from the infected computers. \n\n Today there are several kits sold online, botnet solutions available to everyone, developed to build up in a couple of minutes a brand new version of a specific Trojan able to hide itself from antivirus scanners and armored by some interesting features like remote control and sensitive data stealing routines. \n\n With an expense of just 700/800 dollars – such kits are not expensive - a potential attacker could gain several thousands of dollars and he could build up his own botnet that can be then sold or rent, or yet used to attack sensitive websites.\n\n The two most infamous botnet kits available online were ZeuS and SpyEye, and we already talked about them in our blog posts here and here.\n\n It looks like that between Q3/Q4 2010 ZeuS author decided to stop the development of his trojan and chose to sell the source code to the authors of SpyEye, giving to it the leadership of info stealing trojans.\n\n We have already analyzed the last variant of SpyEye with ZeuS enhancements here in our Prevx blog. \n\n During the second half of 2010 we have monitored the growth of a new trojans available on the underground market: it is called Carberp.\n\n After some cycles of hard development, today Carberp has probably become the second worst threat to customers data, following SpyEye.\n\n In this paper we are going to analyze this trojan in depth, looking at how it is evolved and what we can expect in the future from the team behind this trojan.\n\n 2\n\n\n-----\n\n# DROPPER ANALYSIS\n\nThis trojan is usually dropped by fake webpages containing exploit codes or spread through social engineering. The file itself\nchanged many times during the last few months.The dropper is crypted by a strong encryption layer. While the encryption itself is\nnot really complicated, a manual analysis approach is not trivial because of several tricks implemented by the developer during the\nlayer development.\n\nBy analyzing droppers caught during past few months, we have seen a wide range of tricks implemented in the decryption layer to\nmake the unpacking job a challenge. In some variants the code was totally messed up. Usually this kind of spaghetti code is enough\nto stop most reversers from manually analyzing the code.\n\nThe dropper implements a number of fake API system calls, using invalid parameters. This trick is used to fool antivirus emulators,\nto stop them from emulating the trojan code. Antivirus emulators usually try to statically or dynamically emulate Windows\nbehavior so that the malicious code can be executed in a controlled environment and it can be checked by the antivirus engine.\nSystem emulation is often far from being perfect, and the emulation of system calls doesn’t really emulate all possible situations.\nBy implementing several fake API calls with invalid parameters, the trojan tries to stop antivirus emulators from working correctly.\n\nIt tries to call uncommon and more rare Windows APIs, those APIs that are sometimes not emulated by antivirus emulators.\n\nCarberp doesn’t import API functions by using documented ways. Instead it manually parses system libraries to import needed API\naddresses. It implements a hashing routine to hide the API names that it’s going to import so that it slows down the analysis of the\nmalicious code. Instead of passing the name of the API that needs to be imported, the trojan uses a hash that is calculated from the\nname of the function. The hashing routine used by the dropper we have analyzed is the one showed in the image below:\n\nEAX register stores the hash. It is rotated left by 7 on every loop and it is then xor’d with the string character pointed by the ESI\nindex. It is a common technique used by malware. Carberp will use this technique again in the unpacked code – however it will\nimplement a different hashing algorithm.\n\nThe encryption layer is divided into two parts: the first part tries to fool manual analysis and automated emulators analysis – as\ndescribed above.\n\nThe second part is the actual decryption layer, which is based on mathematical instructions obfuscated by junk code. After the\ndecryption is finished, the real trojan code is executed.\n\n## 3\n\n\n-----\n\n# FIRST STAGE TROJAN EXECUTION\n\nHere we are at the real trojan code. PE static analysis shows that there isn’t any import table directory. The trojan manually imports\nall needed APIs by parsing the needed system libraries. This is the technique already used in the decryption loader code, it just\nchanges the hashing algorithm. The new one is showed below:\n\nThe trojan imports all needed APIs every time they are needed.\n\nCarberp will place itself inside current logged in account startup folder, to make sure it will start at next startup. The used file name\nis arbitrarily chosen by the attacker during the trojan build up procedure through the Carberp creation kit. It usually uses one of\nWindows system file names.\n\nTo hide itself in the system the trojan will use user mode rootkit techniques. We’ll analyze them later in this paper.\n\nCarberp is a fully modular trojan, able to download and execute new plugins from the command and control server. Indeed the\ntrojan already contains two plugins embedded in its code.\n\nEvery plugin is encrypted by using another encryption algorithm. This is the reason why the embedded plugins are well hidden from\nthe user.\n\nCarberp plugins have a common file format, which is based on a 14 bytes header followed by the encrypted code. The 14 bytes\nheader contains the encryption key and a string used to identify new downloaded plugins: ‘BJB’.\n\nThe encryption algorithm is almost trivial, yet it is quite effective. It is a xor algorithm based on the encryption key and index\npositions of the involved bytes. The algorithm is showed below:\n\n## 4\n\n\n-----\n\nWith the help of the reversed algorithm, we can extract the two embedded plugins and analyze them.\n\nThe first plugin is r00f_dll.dll and it is extracted at the trojan startup.\n\nCarberp trojan is a pure user mode trojan, which means it is able to run completely in user mode, even inside limited accounts. It\ntries to run some specific code in kernel mode, to restore SSDT hooks, if they are present.\n\nr00f_dll.dll’s job is executing code in kernel mode to restore original System Service Descriptor Table. It tries to unhook following\nnative APIs:\n\n\n_NtSetContextThread_\n_NTGetContextThread_\n_NtCreateThread_\n_NtOpenThread_\n_NtTerminateThread_\n_NtQueueApcThread_\n\n## 5\n\n\n_NtResumeThread_\n_NtUnmapViewOfSection_\n_NtCreateKey_\n_NtSetValueKey_\n_NtAllocateVirtualMemory_\n_NtWriteVirtualMemory_\n\n\n_NtProtectVirtualMemory_\n_NtAdjustPrivilegesToken_\n_NtOpenProcess_\n_NtTerminateProcess_\n\n\n-----\n\nThis technique would allow the Trojan to evade from security software that monitor the system by hooking the above kernel\nfunctions.\n\nThe trojan maps the original kernel file in memory and gets original kernel pointers, then it prepares the code to be executed in\nkernel mode. Here the plugin tries to use two different methods to execute code in kernel mode.\n\nFirst attempt is done by using an old Windows vulnerability - MS08-025 - already patched by Microsoft. If the system has not been\npatched, the vulnerability allows the trojan to gain system privileges and run code in ring0.\n\nIf the exploit has been patched, the trojan tries to get debug privileges by calling RtlAdjustPrivilege and then tries to write inside\nthe kernel memory by invoking ZwSystemDebugControl API with SysDbgWriteVirtualMemory parameter.\n\nThese attacks are executed only on Windows 2000, Windows XP and Windows 2003 operating systems. If the trojan is running in a\nlimited account and the system is fully patched, these attacks won’t go succeed.\n\nThe second embedded plugin, screens_dll.dll, is used to capture display screenshots.\n\nAfter the r00f plugin has been executed, Carberp starts its infection routine. To better hide its behavior, Carberp does not execute\nits payload from its process, but instead it spawns a new explorer.exe process in a suspended state. This process will host the\nmalicious code.\n\nAfter the explorer.exe process has been created, Carberp creates a new section object and maps itself inside this newly created\nsection. Then, this section is mapped into the explorer.exe process through a call to ZwMapViewOfSection.\n\nThe malicious code has been injected inside the explorer.exe process. To start it, Carberp has been observed using two different\ntechniques. The first technique is hijacking explorer.exe entry point in memory, patching it with a PUSH/RET instruction to redirect\nthe flow code to the injected malicious code.\n\n## 6\n\n\n-----\n\n**Original Entrypoint**\n\n**Hijacked Entrypoint**\n\nThe second technique used is queuing an APC routine to the main explorer.exe thread by calling ZwQueueApcThread. Then both\ntechniques start the suspended explorer.exe process by calling ZwResumeThread.\n\nThe original Carberp dropper terminates, it is now running inside its child explorer.exe. It will then inject its code inside the original\nsystem’s explorer.exe process through a CreateRemoteThread call. To find out the original explorer.exe process, the trojan looks\nfor the Shell_TrayWnd class name.\n\nThe trojan creates a new instance of svchost.exe process, where it will inject the code able to communicate with the command and\ncontrol server.\n\n# USER MODE HOOKS\n\nCarberp acts as an information stealing trojan and a user mode rootkit. To hide itself inside the system, it’ll inject a copy of itself in\nevery running process and it will hook ntdll.dll NtQueryDirectoryFile API. By hooking this system function, the trojan is able to hide\nits file from the user.\n\nFrom a technical perspective, the hook replaces the standard SystemCallStub address with its own routine:\n\n**Original ZwQueryDirectoryFile**\n\n**Hijacked ZwQueryDirectoryFile**\n\nThe call dword ptr [edx] instruction will invoke the trojan routine, able to filter out the trojan file from file enumeration.\n\nWhile this technique is easy to be bypassed in several ways – direct sysenter call, direct file opening, unhooking – it is actually quite\neffective and it does its job.\n\n## 7\n\n\n-----\n\nThe trojan hooks ntdll.dll NtResumeThread in the same way.\n\nCarberp uses a a Man-In-The-Browser approach to steal information data. It hooks following APIs:\n\n\n_HttpSendRequestA_\n_HttpSendRequestW_\n_HttpSendRequestExA_\n_HttpSendRequestExW_\n\n_InternetReadFile_\n\n\n_InternetWriteFile_\n_InternetReadFileExA_\n_InternetReadFileExW_\n_InternetQueryDataAvailable_\n\n_InternetCloseHandle_\n\n\n_CreateFileW_\n_TranslateMessage_\n\n\n_InternetWriteFile, TranslateMessage and CreateFileW hooks are set on the fly if one of the following strings are found in the URL:_\n\n_*cyberplat*_\n_*/ibc/*_\n_*bsi.dll*_\n\nPrevious variants of the trojan hooked only HttpSendRequestA/W and HttpSendRequestExA/ExW APIs – still TranslateMessage and\nCreateFileW were set on the fly. Moreover those previous versions tried to steal information data only if *cyberplat* or *bsi.dll*\nstrings were found in the URL. Current Carberp releases upload every relevant data to the collector server, with\nparticular attention to the strings listed above.\n\nThere isn’t any watchdog thread monitoring the presence of the malware hooks, so a trivial code restore can help in fixing the\nmalware.\n\n# C&C COMMUNICATION\n\nCarberp is not just an information stealing trojan, it is a remote controlled malware that turns the infected PC in a zombie. Carberp\ncan communicate with a list of servers, usually embedded inside the binary.\n\nIn previous variants of the trojan, those servers were not encrypted, and they could be read in plain text.\n\nMore updated variants of Carberp encrypt them with a trivial xor-based encryption algorithm.\n\n## 8\n\n\n-----\n\nThe algorithm –and relative decoded string – are showed below:\n\nCarberp can be configured to contact even more servers.\n\nWhen the infected computer contacts the C&C for the first time, the trojan will send back to the server some information about the\nvictim machine – operating system version, process lis, along with a unique ID calculated from the infected computer.\n\nThe trojan could download a specific configuration file from the server. The file name of the configuration file is stored inside the\ntrojan binary and it’s encrypted using the same algorithm described in the previous page. This configuration file name will be even\nused when generating the unique name of the infected machine used by the C&C server.\n\nThen the trojan will contact a specific webpage of the C&C server - <domain>/set/task.html – looking for specific commands from\nthe server.\n\nThe version of Carberp we have analyzed can receive the following commands:\n\n _Download_\n _update_\n _grabber_\n _loaddll_\n _startsb_\n _getwm_\n\nIt can update itself, download and execute new executable files or load dll, and even start a remote VNC session by downloading a\nspecific Carberp plugin (vnc.plug).\n\nAs written before in the paper, Carberp is a fully modular trojan, able to download and execute specific plugins written by Carberp\ndevelopers.\n\nWe have been able to download and analyze three of most used plugins. They are passw.plug, stopav.plug, miniav.plug. All these\nplugins are encrypted with the encryption algorithm described earlier in this paper.\n\nStopav.plug is a plugin used to disable a number of specific antivirus software. Currently it tries to disable following security\nsoftware:\n\n _Arcavir Antivirus_\n _Avast4 Antivirus_\n _Avast5 Antivirus_\n _AVG Antivirus_\n\n## 9\n\n\n-----\n\n _Avira Antivirus_\n _BitDefender Antivirus_\n _Dr.Web Antivirus_\n _McAfee Antivirus_\n _Microsoft Security Essentials_\n _Eset Antivirus_\n _Eset Smart Security_\n _Sophos Antivirus_\n\nThe plugin looks into the Windows registry looking for specific registry keys related to these antivirus products. If found, the\ncommon procedure is to try to disable the security software by creating a specific antivirus process in a suspended state and then\ninjecting there the payload to delete one or more antivirus core files. Process is then resumed.\n\n**Security software** **Newly created process** **Files attempted to be deleted**\n**Arcavir Antivirus** arcavir.exe adc.%#^.462\nupdate_tmp.exe (killed)\n**Avast4 Antivirus** ashDisp.exe \\Setup\\setiface.ovr\n\n\\Setup\\setiface.dll\n**Avast5 Antivirus** AvastUI.exe \\Setup\\setiface.ovr\n\n\\Setup\\setiface.dll\n**AVG Antivirus** avgtray.exe avgupd.exe\n**Avira Antivirus** avconfig.exe updaterc.dll\n**BitDefender Antivirus** livesrv.exe upgrepl.exe\nv_live_s.xml\n**Dr.Web Antivirus** SpIDerAgent.exe DrWebUpW.exe\n\nupdate.drl\n**McAfee Antivirus** mcshell.exe mcupdmgr.exe\n**Microsoft Security Essentials** msseces.exe MsMpLics.dll\n**Eset Antivirus**        - \\updfiles\\upd.ver\n**Eset Smart Security**      - \\updfiles\\upd.ver\n**Sophos Antivirus** AlMon.exe scf.dat\n**stopav plugin screenshot**\n\nThis plugin has been written in Borland Delphi.\n\n## 10\n\n|Security software|Newly created process|Files attempted to be deleted|\n|---|---|---|\n|Arcavir Antivirus|arcavir.exe|adc.%#^.462 update_tmp.exe (killed)|\n|Avast4 Antivirus|ashDisp.exe|\\Setup\\setiface.ovr \\Setup\\setiface.dll|\n|Avast5 Antivirus|AvastUI.exe|\\Setup\\setiface.ovr \\Setup\\setiface.dll|\n|AVG Antivirus|avgtray.exe|avgupd.exe|\n|Avira Antivirus|avconfig.exe|updaterc.dll|\n|BitDefender Antivirus|livesrv.exe|upgrepl.exe v_live_s.xml|\n|Dr.Web Antivirus|SpIDerAgent.exe|DrWebUpW.exe update.drl|\n|McAfee Antivirus|mcshell.exe|mcupdmgr.exe|\n|Microsoft Security Essentials|msseces.exe|MsMpLics.dll|\n|Eset Antivirus|-|\\updfiles\\upd.ver|\n|Eset Smart Security|-|\\updfiles\\upd.ver|\n|Sophos Antivirus|AlMon.exe|scf.dat|\n\n\n-----\n\nThe second plugin, written in Borland Delphi too, is miniav.plug. This plugin is responsible of scanning the system looking for other\n**trojan infections. It looks for – and try to clean – following trojans:**\n\n\n _Adrenalin_\n _Barracuda_\n _BlackEnergy_\n _Generetic_\n _Limbo_\n _MyLoader_\n _ZeuS_\n\n\n**miniav plugin screenshot**\n\n\nThe plugin also checks the Image File Execution Options registry key, looking for “Debugger” value inside every subkey. This is a\ncommon technique used by malware to deny the creation of specified processes or to get their code to be executed when the\nspecified process is run.\n\nThe third plugin, passw.plug, is a grabber able to scan the infected PC looking for passwords and user accounts. It can grab a lot of\ninformation from an infected PC, for example:\n\n Live Messenger, Yahoo, Trillian, Pidgin, MySpace, Gaim, QIP, Odigo, ICQ, GTalk, Gizmo, Jabber, Gadu-Gadu, AOL, Miranda\n\naccounts;\n\n Password and forms data saved in most common browsers (Opera, Internet Explorer, Safari, Firefox, Chrome);\n\n Mail accounts and relative passwords from most common e-mail clients (Outlook, Windows Live Mail, The Bat!, Becky,\n\n_Eudora, Mail.Ru, IncrediMail, PocoMail, ForteAgent, Scribe, POP Peeper, MailCommander etc…);_\n\n User accounts and passwords from most common FTP clients (CuteFTP, WS_FTP, FileZilla, FTPCommander, BProofFTP,\n\n_SmartFTP, CoffeeCup, CoreFTP, Frigate3, UltraFXP, FlashFXP, FTPRush, WebSitePublisher, BitKinex, FreeFTP, WinSCP,_\n_TotalCommander etc…);_\n\n System Information along with credential passwords for desktop remote control, VNC passwords, Cisco VPN accounts;\n\nAll stolen information are stored in a database and uploaded to the remote server.\n\n## 11\n\n\n-----\n\n# CONCLUSIONS\n\nWhile SpyEye leads the world of infostealing trojans after ZeuS code has been sold, Carberp silently appeared on the underground\nmarket and showed the world a lot of potential.\n\nIts modular structure along with the ability to run even in limited accounts and the active development team behind it make this\ntrojan a very dangerous threat.\n\nIts encryption layer looks very effective in bypassing classic antivirus scanners, showing the need of a multi-layered security\napproach to fight against today’s threats.\n\n**Prevx SafeOnline has been able to proactively protect our customers' navigation sessions from Carberp infostealing hooks –**\nsuccessfully preventing it from stealing bank accounts and passwords put in the browser while surfing on the online banking\nwebpage.\n\nWe expect to see Carberp to be much more widespread during 2011, quickly becoming one of the top infostealing threats.\n\n## ABOUT PREVX\n\n### Prevx provides cloud-based products with unparalleled capabilities for protecting consumers, SMEs and enterprises, banks, and government organizations from the latest malware threats.\n The entire Prevx suite is underpinned by its award-winning flagship security agent, Prevx 3.0, and connects to the world's largest cloud-based threat database. Prevx 3.0 is the world's smallest, fastest, and lightest endpoint security agent yet its detection, protection and removal capabilities rival the largest antivirus solutions. Prevx specializes in detecting zero day attacks, reducing the time exposed to danger and providing real-time protection against the latest and the most malicious forms of malware, including keyloggers, Trojans, and rootkits - catching the threats that are missed by traditional antivirus providers.\n Prevx is a division of Internet security service company Webroot. With its main operations in the United Kingdom, Prevx products are also sold and supported across Europe and in the United States. Before acquisition by Webroot in 2010, Prevx was formed by IT entrepreneur Mel Morris who acquired Immunify Ltd in 2005 and re-launched it as Prevx. Now vice president and general manager of the Prevx division at Webroot, Morris named Prevx to reflect the organization's mission to help customers - from consumers and small businesses to the largest financial institutes and global organizations - to best protect themselves against the evolving and unknown nature of malicious software. Prevx: preventing the unknown.\n Prevx's family of security software is deployed by leading banks, enterprises, and government agencies and supports over 15 million users worldwide.\n\n## 12\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "http://pxnow.prevx.com/content/blog/carberp-a_modular_information_stealing_trojan.pdf"
    ],
    "report_names": [
        "carberp-a_modular_information_stealing_trojan.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1298917647,
    "ts_modification_date": 1298917647,
    "files": {
        "pdf": "https://archive.orkl.eu/ca2fca09fe4df5eced75d49dca36239dba71df16.pdf",
        "text": "https://archive.orkl.eu/ca2fca09fe4df5eced75d49dca36239dba71df16.txt",
        "img": "https://archive.orkl.eu/ca2fca09fe4df5eced75d49dca36239dba71df16.jpg"
    }
}