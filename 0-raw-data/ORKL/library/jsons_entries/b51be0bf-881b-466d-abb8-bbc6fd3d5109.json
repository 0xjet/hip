{
    "id": "b51be0bf-881b-466d-abb8-bbc6fd3d5109",
    "created_at": "2023-01-12T15:08:05.298459Z",
    "updated_at": "2025-03-27T02:05:40.722543Z",
    "deleted_at": null,
    "sha1_hash": "99bd56a505594dfb04f2bbc96b78fd6e88e26617",
    "title": "2020-05-19 - Netwalker Ransomware - From Static Reverse Engineering to Automatic Extraction",
    "authors": "",
    "file_creation_date": "2022-05-28T04:42:59Z",
    "file_modification_date": "2022-05-28T04:42:59Z",
    "file_size": 236662,
    "plain_text": "# Netwalker Ransomware – From Static Reverse Engineering to Automatic Extraction\n\n**zero2auto.com/2020/05/19/netwalker-re/**\n\nvkz2a May 19, 2020\n\n_Author: Zero2Automated Course Team (preview from courses.zero2auto.com)_\n\nNetwalker ransomware has been around since at least 2019* and has recently been in the news from a TrendMicro report detailing it being\nleveraged embedded in a PowerShell script[1].\n\nWe will briefly go over how to recover the DLL files from the first script, it contains a large Base64 chunk of data that is base64 decoded and\nexecuted:\n\nInVokE-ExPRESSIoN -COMmand $([StrinG]([SySTEM.TexT.ENcOdInG]::ASCII.GETStRiNG([SysTEM.CoNVErT]:\n\n:FRomBAsE64StRiNG(“ICA <..snip..>\n\nThe next script layer then has an array of bytes which will be XOR decoded:\n\n[bYTE[]]   $eFGCSjWKKPqLGPIYp   =\n@(0x67,0x67,0x1C,0x25,0x3e,0x33,0x22,0x1c,0x1A,0x1A,0x67,0x67,0x67,0x67,0x67,0x67,0x67,0x67,0x67,0x63,0x37,0x33,0x01,0x31,0x0C,0x\nfor ( $qTOJScZVUn =  0;  $QTOjsCZvUn   -lt  $eFGCSjWKKPQLGpIYP.LeNgth;  $qtOJscZvUN++ ) {\n\n$EFGCSjWKKPqlGpIYP[$qtOJscZVUN] = $EFGCSJWkkPqLGPIYP[$QtOJscZvUN]  -BxOr 0x47\n\n<..snip..>\n\nFinally we are left with the main script layer that will load the DLL into memory:\n\n[bYTE[]]   $eFGCSjWKKPqLGPIYp   =\n@(0x67,0x67,0x1C,0x25,0x3e,0x33,0x22,0x1c,0x1A,0x1A,0x67,0x67,0x67,0x67,0x67,0x67,0x67,0x67,0x67,0x63,0x37,0x33,0x01,0x31,0x0C,0x\nfor ( $qTOJScZVUn =  0;\n\n$QTOjsCZvUn   -lt  $eFGCSjWKKPQLGpIYP.LeNgth;  $qtOJscZvUN++ ) {\n\n$EFGCSjWKKPqlGpIYP[$qtOJscZVUN] = $EFGCSJWkkPqLGPIYP[$QtOJscZvUN]  -BxOr 0x47\n\n<..snip..>\n\nFinally we are left with the main script layer that will load the DLL into memory:\n\n[byte[]]   $ptFvKdtq\n=  @(0xad,0xde,0x90,0x00,0x03,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0xff,0xff,0x00,0x00,0xb8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x\n\n**Netwalker DLL**\n\nThe first thing the DLL does is resolve all of its needed functions.\n\nDynamic function resolution such as this normally involves some form of string hashing, in this case it is CRC32.\n\nIn the picture above you can see the hash value for FindResourceA being passed to a function that will resolve it and then store it in an array.\n\n>>> hex(zlib.crc32(‘FindResourceA’) % (1<<32))’0x3e006b7a’\n\nAfter resolving there is a function responsible for simply getting the beginning address of the previous table. Shortly after resolving the needed\nfunctions the DLL gets its resource section.\n\n\n-----\n\nA little ways down this data is passed off to another function which has a noticeable loop inside of it that is RC4 KSA[2]. If you are wanting to\nbe able to identify some of these common routines I frequently recommend that people compile some files themselves and then take a look at\nthem in a debugger or a disassembler. Routines I would recommend becoming familiar with will be included at the end of this blog.\n\nSo since the the resource section appears to be RC4 decrypted, let’s take a look at the data.\n\n>>> r = get_rsrc(pe)\n>>> data = r[0][1]\n>>> data[:100]”\\x07\\x00\\x00\\x00cZu-H!<\\x9b\\xc5E\\xder\\x88&D\\xf0\\xd7{@\\x00\\xa9m\\xa1\\x1e\\x8b\\xac\\xf7Z\\xb4|\\xc9&\n\n[\\x03\\x1cY\\xde\\xf5\\x8dA\\x97C:8y\\xb5&\\x07\\xb8q\\xed\\xe1^\\xfd<\\x98\\x92\\x95\\x1a\\xa6\\xf7\\xea\n\\x07\\xea\\x18v\\xe1\\x0f\\xa1\\xdcmR\\x8c\\x85’I\\t\\xc9\\x12\\x8e\\xe5\\x9d+\\xc2\\x7f\\x00G\\x01-Jp\\xd48 “\n\nThe first 4 bytes appear to be a DWORD value stored as little endian, since I didn’t see a reference to any hardcoded data being used as a\nRC4 key from the DLL and a small dword value is the first thing in this resource section I’m going to assume it is some sort of a length value.\nPerhaps a key length?\n\n>>> import struct\n>>> from Crypto.Cipher import ARC4\n>>> import struct\n>>> struct.unpack_from(‘<I’, data)(7,)\n>>> key = data[4:4+7]\n>>> rc4 = ARC4.new(key)\n>>> t = rc4.decrypt(data[4+7:])\n>>> t[:100]'{“mpk”:”+1KtL9ibbeqaChhoz4iEHeTtRtw8pNA5yC034\\\\/3klSA=”,”mode”:0,”spsz”:15360,”thr”:1500,”namesz”:8,”‘\n\nIt’s always nice when your hypothesis turns out to be correct on the first try, definitely isn’t the norm though.\n\nNow that we have decrypted the config we need to find more samples and see if we can decode more configs, I use VirusTotal sometimes and\nI understand it’s not something everyone has access to so I will upload all the samples I end up going through onto MalwareBazaar.\n\nFor pivoting in order to find more samples I will normally turn to YARA and use a service that allows for scanning malware repositories, most of\nthese services are either paid or private so you will normally obtain access to them as you progress into the world of malware research.\nVirusTotal has a convenient way to quickly search for hex strings using content searching so I pick a string that looks like it will remain static in\nthis malware stub or template but will not give me a bunch of false positives. Sometimes this is harder than not and in this case the string I\nwent with was actually my 3rd attempt.\n\n\n-----\n\nHere we have two constant strings associated with SALSA20 or CHACHA20 encryption and following it is a dword value associated with\nhashing, kind of odd to see them back to back that way in the binary.\n\nWe can convert this to a hexlified string for doing VT content searching:\n\ncontent:”{657870616e642033322d62797465206b657870616e642031362d62797465206b982f8a42}”\n\nSearching in VirusTotal shows this to be a pretty good string for finding Netwalker related samples! Surprisingly enough it turns up lots of\nsamples as well.\n\nSo now we need a decoder, or a way to automate decoding the config data from the files.\n\nLet’s build out a decoder, we need to:\n\nRead a file in\nFix up MZ stomping\nRetrieve the resources\nFind the key length\nRC4 decode\nPrint config\n\nLet’s setup for the first part for retrieving the resources:\n\n_[The full script can be found as part of the Zero2Automated Advanced Malware Analysis Course](http://courses.zero2auto.com/)_\n\nTaking our script and the files from our content pivoting we will check the first 25 files and find that our script seems to work, we found a\nnumber of samples with new ‘mpk’ values but also one of the mailto samples instead of using onion domains:\n\n{“mpk”:”ESw9E\\/AaTiQ9oZfLKNquj2dHV3TqTFU8c4zjg7HLHRc=”,”mode”:0,”spsz”:15360,”thr”:1500,”namesz”:8,”idsz”:6,”pers”:false,”onion1″:”pb3\nReadme.txt”,<..snip..>\n\n{“mpk”:”9WMeeC/lNogGtJPPRqQRzty2DMwgPRBWyU7mLzp992E=”,”mode”:0,”thr”:1500,”spsz”:51200,”namesz”:8,”idsz”:5,\n“crmask”:”.mailto[{mail1}].{id}”,”mail”:[“priparipri@tuta.io”,”praparapra@cock.li”],”lfile”:”{ID}-Readme.txt”,<..snip..>\n\nSo now we just need to decode more files, after decoding a larger data set I found that they all seemed to be using the same onion domains\nbut managed to find a number of samples using email addresses as well:\n\n2Hamlampampom@cock.liGalgalgalgalk@tutanota.comHariliuios@tutanota.comkavariusing@tutanota.comkazkavkovkiz@cock.likokbiglock@coc\n\n\n-----\n\nqu c eb sea c o o e o t e e a s, o t to @tuta o, eads to a a so ed ebs te ed ate y\n\nGoing through the files that didn’t decode out configs shows that we have found a number of decryptors that were uploaded to VirusTotal:\n\n346fdff8d24cbb7ebd56f60933beca37a4437b5e1eb6e64f7ab21d48c862b5b744b5d24e5e8fd8e8ee7141f970f76a13c89dd26c44b336dc9d6b61fda\n\nAlso a DLL file that left the name embedded of ‘Netwalker_dll.dll’:\n\n55870437ee97984ef461438777635b53eb52f8d83048ce3a825d95cabc2065f2\n\n**Mine the data**\n\nNow that we have a bunch of decoded configs we can do a bit of data mining as well.\n\nWe can use some bash magic to dump out the counts for ‘mpk’ values:\n\n\n-----\n\n1 0OQuf4tSKXtXERycfxzsWvcWPE2xayXH1rBpyAwyhVw=  1 1B+hUSlP+KcLFtZn5q0ND6WzFyQPIHxtM1vv1zlm4TE=  4\n+1KtL9ibbeqaChhoz4iEHeTtRtw8pNA5yC034\\/3klSA=  1 2ofyizDC65TzCiTW6SHYlP0mHF8VHklx5\\/FFlECTOWE=  1\n3ZVt8Qrdiimm/8OxCtmqUBZhZJ6DxqheQQ0wf9dIvU4=  1 7gkgNrgVvnSdnUifXmoRclyQU1tmmH9uLXZQ+mrJq1Y=  1\n8kQrJzFg\\/OugByxLk1JyT1cstH0gAQa6EmbRTJYIPyA=  1 9m56vLIZOlxhDtqMpZBLLOB21rKNaqnfMZmAICgbHB8=  1\n9qQgCpjzg9Gg4R4QntJaXdyqbeK7tBKkyatX6U809B8=  1 9rekeP1eSTG+1alJX084XEnZkNZbMI2i7f7xMARuYG0=  1\n9WMeeC/lNogGtJPPRqQRzty2DMwgPRBWyU7mLzp992E=  1 AopcQZuT8iGQsDBOQ5vum9rCosprWR4HAtyoDLBe2jk=  1\nB1zaW+rgS4zOpn9MVHL0SXpAgmPx9992cw/zrjTStUQ=  1 bd9dpX2CspQ65wRiTP1TjN1cqwk8dSdJehbmYTNMxEY=  1\ncePAiKEieIEsWYzINEJe7\\/M7yXm+i6y\\/Y+fjupgPdhc=  1 cT9cjcSYKMZMSxEObt0H0djsPtEVOW6Pfy0IU20uCEc=  1\nEsvRQAFnerbfU8Z+27XyeJD82IPjl7PL62KSSzYOVUM=  2 ESw9E\\/AaTiQ9oZfLKNquj2dHV3TqTFU8c4zjg7HLHRc=  1\nEXgCIpycIJzspm07Loi9L5uOcxC+VZ/NjxWfOn7UqVE=  1 fXe6IoRs263eE42xnNF\\/L5vYmC81qAS5F08zqHShBnE=  1\ni3XpDekYmaDR5/C8gssEfc4BdgWSoKrU/RLtK10V4x8=  1 IrZwVI2HoRerwgd99xkmdIL3g0tfJOU1GoXMIPq5gkA=  1\nizndhmDBfqQMxnbJX3rwRXETOO7hXuPRUrw91jUeuCE=  4 JgQzhhhjdTmwJuFlSWQ99dolV6sNRQWfNdqTbxulxCc=  1\nJgRipXGeK7D6diXrdsBTdT\\/o4ps0NS+6uUQ2K+lrmns=  1 JXrdFkPUAEVVROz8EN45wkOUGupEphGPQz4GoMLXwAk=  1\njZOEXL4Vyq413gNYUVSUuiJyvFvII63YSv3LMTm6YSQ=  1 kRmTz3GjStQDqVIO35VbP2DX5HzhQKd5bZJ5fkuQp2o=  1\nLCiJ44QQcMh5P1jJtpV7XaJoMezvQc0D8bxdK97oWHM=  1 lxd4WwFEl80nASzXFosZNWY0+M3\\/ljFwqXGcQ7C3Jmg=  1\nO7iv5p+9M2xSENzUqbH2q4hEPiIShKQON7UQJZ\\/qhxs=  1 pLcj6adbJHIyhEWwUd+Wht4pAXQMi4MhYXb1DmSE5Uc=  1\np+V4T581H2IJPowJP7b9Laa4P0cAfDgyREsFNhpETDw=  2 qGFBYhyYzmg5jkJh0giXpwDfUdbopaCdj4Zcxsdab0c=  1\nRQfrkb+zP4wEDw4UerO5Xqwm/5R3zHSuTHD12cRuBTM=  4 srj15Yy9UFP\\/jvwiLyCiEWXRb\\/8RwnuHqGtdJCQzWk0=  1\nsVMyZQe7xbAMYsKdX7B\\/RmV92sc+Qd9YL7EmRVCZDnI=  1 TPeyvEhWusttXBNAkbii\\/6tocN5IWcOl+O2JCMyXtWA=  2\nuHbQk+xn3zyr9HAJIbR6wDKpszDZC2Dri\\/D8cdZCPBU=  2 uMDlH\\/VVLunARbKVQ4kKse+8Mdxbk00Pf+NSkoDASW0=  1\nU+P1u\\/vlAgiFK\\/NnScZbuLtNbohxu\\/65\\/XiNMHzV82E=  1 usVG0ZPeGZRvG5clAh81RbrG7Whq9b3dtQ2tmoYf2iI=  1\nvWdriuVFhHBNk87xEzAlkZNfVRnPIIn1PsCx8s/+Uj8=  1 w2nejMQFYibyk97OISK8vcRcoUeJz2c024P98feVuXs=  2\nXfwHXZw5ITJ/PB4tTJaJCa9cbigLKwS1hlNyMvT3CnQ=  1 XQixjtCbv3GHOcOGAAnHAO2rJFTbq8jr4j6bkajSWjU=  1\nYisAjypwt6EuV8PeHBflq\\/sQwAWgo+Y6CI9NKu3Fu10=  1 z2qgNTBTz6Ff6XQROdTvmEiBJn+b+HV3+Gw97n0rZxk=  1\nzxbaxrewir3mRzNnoTP5NYvdhQNmFKwczCHzih9Kig0=\n\nThe ‘lend’ value usually contains the ransom message so we can dump out the values and see how often it has changed. When doing this I\nnoticed that most of the samples contained a generic message but there were lots of samples that had slightly custom messages including\nvictim names.\n\nc21ecd18f0bbb28112240013ad42dad5c01d20927791239ada5b61e1c6f5f010\n\nHello, O2MICRO.\nYour files are encrypted by Netwalker.All encrypted files for this computer has extension: .{id}\n\n3ba905e1cda7307163d4c8fe3fd03c2fbce7eda030522084e33d0604c204630e\n\nHi University of Seattle,\nYour files are encrypted.All encrypted files for this computer has extension: .{id}\n\n0d7ee7ce88e790ad66aa53589f5a2638207bc3adf2eb4f8a813fd52b5b22ba27\n\nHi Stellar,\nYour files are encrypted.All encrypted files for this computer has extension: .{id}\n\nb2d68a79a621c3f9e46f9df52ed19b8fec22c3cf5f4e3d8630a2bc68fd43d2ee\n\nHi InventUsPower,\nYour files are encrypted by Netwalker.All encrypted files for this computer has extension: .{id}\n\n29aef790399029029e0443455d72a8b928854a0706f2e211ae7a03bba0e3d4f4\n\nHi Bolloré,\nYour files are encrypted.All encrypted files for this computer has extension: .{id}\n\nAlso a version that warns of releasing stolen data:\n\n26dfa8512e892dc8397c4ccbbe10efbcf85029bc2ad7b6b6fe17d26f946a01bb\n\n\n-----\n\nHi!Your files are encrypted.All encrypted files for this computer has extension: .{id}\n–If for some reason you read this text before the encryption ended,this can be understood by the fact that the computer slows down,and\nyour heart rate has increased due to the ability to turn it off,then we recommend that you move away from the computer and accept that you\nhave been compromised.Rebooting/shutdown will cause you to lose files without the possibility of recovery.\n–Our encryption algorithms are very strong and your files are very well protected,the only way to get your files back is to cooperate with us\nand get the decrypter program.\nDo not try to recover your files without a decrypter program, you may damage them and then they will be impossible to recover.\nFor us this is just business and to prove to you our seriousness, we will decrypt you one file for free.Just open our website, upload the\nencrypted file and get the decrypted file for free.\nAdditionally, your data may have been stolen and if you do not cooperate with us, it will become publicly available on our blog.\n—\nSteps to get access on our website:\n[1.Download and install tor-browser: https://torproject.org/](https://torproject.org/)\n2.Open our website: {onion1}If the website is not available, open another one: {onion2}\n3.Put your personal code in the input form:\n{code}\n\n**Routines**\n\nThis is not an exhaustive list by any means but is listed in the most common to least common order and are probably the algorithms I find most\noften inside of malware.\n\nEncoding:\n\nBase64\n\nEncryption:\n\nRC4\nXTEA\nAES\nRC6\n\nHashing:\n\nCRC32\nMD5\nSHA256\nSHA512\n\nCompression:\n\nAPLIB\nFLATE\nGZIP\nZLIB\nLZ\n\n**References**\n\n1: [https://blog.trendmicro.com/trendlabs-security-intelligence/netwalker-fileless-ransomware-injected-via-reflective-loading/](https://blog.trendmicro.com/trendlabs-security-intelligence/netwalker-fileless-ransomware-injected-via-reflective-loading/)\n\n2: [https://en.wikipedia.org/wiki/RC4](https://en.wikipedia.org/wiki/RC4)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-19 - Netwalker Ransomware - From Static Reverse Engineering to Automatic Extraction.pdf"
    ],
    "report_names": [
        "2020-05-19 - Netwalker Ransomware - From Static Reverse Engineering to Automatic Extraction.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536085,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1653712979,
    "ts_modification_date": 1653712979,
    "files": {
        "pdf": "https://archive.orkl.eu/99bd56a505594dfb04f2bbc96b78fd6e88e26617.pdf",
        "text": "https://archive.orkl.eu/99bd56a505594dfb04f2bbc96b78fd6e88e26617.txt",
        "img": "https://archive.orkl.eu/99bd56a505594dfb04f2bbc96b78fd6e88e26617.jpg"
    }
}