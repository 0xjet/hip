{
    "id": "0369cd14-c819-44e5-b5cb-b58518f4b931",
    "created_at": "2023-01-12T15:02:47.03943Z",
    "updated_at": "2025-03-27T02:08:40.246029Z",
    "deleted_at": null,
    "sha1_hash": "cade46859117a66fa11b444dce752e03b98eb280",
    "title": "2016-08-25 - Unpacking the spyware disguised as antivirus",
    "authors": "",
    "file_creation_date": "2016-07-19T14:05:09Z",
    "file_modification_date": "2016-07-19T14:05:09Z",
    "file_size": 3010759,
    "plain_text": "# � �\n\n\nJune 02, 2016 | by Josh Homan, Sean McBride, Rob Caldwell | Threat Research, Advanced Malware\n\nIn the latter half of 2015, the FireEye Labs Advanced Reverse Engineering (FLARE) team identified several versions of an\nICS­focused malware crafted to manipulate a specific industrial process running within a simulated Siemens control system\nenvironment. We named this family of malware IRONGATE.\n\nFLARE found the samples on VirusTotal while researching droppers compiled with PyInstaller — an approach used by\nnumerous malicious actors. The IRONGATE samples stood out based on their references to SCADA and associated\nfunctionality. Two samples of the malware payload were uploaded by different sources in 2014, but none of the antivirus\nvendors featured on VirusTotal flagged them as malicious.\n\nSiemens Product Computer Emergency Readiness Team (ProductCERT) confirmed that IRONGATE is not viable against\noperational Siemens control systems and determined that IRONGATE does not exploit any vulnerabilities in Siemens\nproducts. We are unable to associate IRONGATE with any campaigns or threat actors. We acknowledge that IRONGATE\ncould be a test case, proof of concept, or research activity for ICS attack techniques.\n\nOur analysis finds that IRONGATE invokes ICS attack concepts first seen in Stuxnet, but in a simulation environment.\nBecause the body of industrial control systems (ICS) and supervisory control and data acquisition (SCADA) malware is\nlimited, we are sharing details with the broader community.\n\n**Deceptive Man­in­the­Middle**\n\nIRONGATE's key feature is a man­in­the­middle (MitM) attack against process input­output (IO) and process operator\nsoftware within industrial process simulation. The malware replaces a Dynamic Link Library (DLL) with a malicious DLL,\nwhich then acts as a broker between a PLC and the legitimate monitoring software. This malicious DLL records five seconds\nof 'normal' traffic from a PLC to the user interface and replays it, while sending different data back to the PLC. This could\nallow an attacker to alter a controlled process unbeknownst to process operators.\n\n**Sandbox Evasion**\n\nIRONGATE's second notable feature involves sandbox evasion. Some droppers for the IRONGATE malware would not run if\nVMware or Cuckoo Sandbox environments were employed. The malware uses these techniques to avoid detection and resist\nanalysis, and developing these anti­sandbox techniques indicates that the author wanted the code to resist casual analysis\nattempts. It also implies that IRONGATE’s purpose was malicious, as opposed to a tool written for other legitimate purposes.\n\n**Dropper Observables**\n\nWe first identified IRONGATE when investigating droppers compiled with PyInstaller — an approach used by numerous\nmalicious actors. In addition, strings found in the dropper include the word “payload”, which is commonly associated with\nmalware.\n\n\n-----\n\n# � �\n\n\nWhile IRONGATE malware does not compare to Stuxnet in terms of complexity, ability to propagate, or geopolitical\nimplications, IRONGATE leverages some of the same features and techniques Stuxtnet used to attack centrifuge rotor\n\n**Menu**\n\nspeeds at the Natanz uranium enrichment facility; it also demonstrates new features for ICS malware.\n\nBoth pieces of malware look for a single, highly specific process.\nBoth replace DLLs to achieve process manipulation.\nIRONGATE detects malware detonation/observation environments, whereas Stuxnet looked for the presence of antivirus\nsoftware.\nIRONGATE actively records and plays back process data to hide manipulations, whereas Stuxnet did not attempt to hide\nits process manipulation, but suspended normal operation of the S7­315 so even if rotor speed had been displayed on\nthe HMI, the data would have been static.\n\nIRONGATE’s characteristics lead us to conclude that it is a test, proof of concept, or research activity.\n\nThe code is specifically crafted to look for a user­created DLL communicating with the Siemens PLCSIM environment.\nPLCSIM is used to test PLC program functionality prior to in­field deployment. The DLLs that IRONGATE seeks and\nreplaces are not part of the Siemens standard product set, but communicate with the S7ProSim COM object. Malware\nauthors test concepts using commercial simulation software.\nCode in the malicious software closely matched usage on a control engineering blog dealing with PLCSIM\n(https://alexsentcha.wordpress.com/using­s7­prosim­with­siemens­s7­plcsim/ and\nhttps://pcplcdemos.googlecode.com/hg/S7PROSIM/BioGas/S7%20v5.5/).\nWhile we have identified and analyzed several droppers for the IRONGATE malware, we have yet to identify the code’s\ninfection vector.\nIn addition, our analysis did not identify what triggers the MitM payload to install; the scada.exe binary that deploys the\n\nIRONGATE DLL payload appears to require manual execution.\nWe have not identified any other instances of the ICS­specific IRONGATE components (scada.exe and\n\nStep7ProSim.dll), despite their having been compiled in September of 2014.\n\nSiemens ProductCERT has confirmed that the code would not work against a standard Siemens control system\nenvironment.\n\nEven though process operators face no increased risk from the currently identified members of the IRONGATE malware\nfamily, IRONGATE provides valuable insight into adversary mindset.\n\nNetwork security monitoring, indicator of compromise (IoC) matching, and good practice guidance from vendors and other\nstakeholders represent important defensive techniques for ICS networks.\n\nTo specifically counter IRONGATE’s process attack techniques, ICS asset owners may, over the longer term, implement\nsolutions that:\n\nRequire integrity checks and code signing for vendor and user generated code. Lacking cryptographic verification\nfacilitates file replacement and MitM attacks against controlled industrial processes.\nDevelop mechanisms for sanity checking IO data, such as independent sensing and backhaul, and comparison with\nexpected process state information. Ignorance of expected process state facilitates an attacker’s ability to achieve\nphysical consequence without alarming operators.\n\n\n-----\n\nupdate_no_pipe.exe2, update_no_pipe.exe2, update.exe3. All but one of these Python­based droppers first� �\n\n\nupdate_no_pipe.exe\n\n\nchecks for execution in a VMware or Cuckoo Sandbox environment. If found, the malware exits.\n\n**Menu**\n\nIf not found, the IRONGATE dropper extracts a UPX­packed, publicly available utility (NirSoft NetResView version 1.27) to\naudiodg.exe in the same directory as the dropper. The dropper then executes the utility using the command audiodg.exe\n\n/scomma scxrt2.ini. This command populates the file scxrt2.ini with a comma­separated list of network resources\n\nidentified by the host system.\n\nThe dropper iterates through each entry in scxrt2.ini, looking for paths named move­to­operational or move­to­\n\noperational.lnk. If a path is found, the dropper first extracts the Base64­encoded .NET executable scada.exe to the\n\ncurrent directory and then moves the file to the path containing move­to­operational or move­to­\n\noperational.lnk. The path move­to­operational is interesting as well, perhaps implying that IRONGATE was not\n\nseeking the actual running process, but rather a staging area for code promotion. The dropper does not execute the\nscada.exe payload after moving it.\n\n**Anti­Analysis Techniques**\n\nEach IRONGATE dropper currently identified deploys the same .NET payload, scada.exe. All but one of the droppers\n\nincorporated anti­detection/analysis techniques to identify execution in VMware or the Cuckoo Sandbox. If such\nenvironments are detected, the dropper will not deploy the .NET executable (scada.exe) to the host.\n\nFour of the droppers (update.exe1, update_no_pipe.exe1, update_no_pipe.exe2, and update.exe3) detect\n\nCuckoo environments by scanning subdirectories of the %SystemDrive%. Directories with names greater than five, but\n\nfewer than ten characters are inspected for the subdirectories drop, files, logs, memory, and shots. If a matching\n\ndirectory is found, the dropper does not attempt to deploy the scada.exe payload.\n\nThe update.exe1 and update.exe3 droppers contain code for an additional Cuckoo check using the SysInternals pipelist\n\nprogram, install.exe, but the code is disabled in each.\n\nThe update.exe2 dropper includes a check for VMware instead of Cuckoo. The VMWare check looks for the registry key\n\nHKLM\\SOFTWARE\\VMware, Inc.\\VMware Tools and the files %WINDIR%\\system32\\drivers\\vmmouse.sys and\n\n%WINDIR%\\system32\\drivers\\vmhgfs.sys. If any of these are found, the dropper does not attempt to deploy the\n\nscada.exe payload.\n\nThe dropper bla.exe does not include an environment check for either Cuckoo or VMware.\n\n**scada.exe Payload**\n\nWe surmise that scada.exe is a user­created payload used for testing the malware. First, our analysis did not indicate what\n\ntriggers scada.exe to run. Second, Siemens ProductCERT informed us that scada.exe is not a default file name\n\nassociated with Siemens industrial control software.\n\nWhen scada.exe executes, it scans drives attached to the system for filenames ending in Step7ProSim.dll. According\n\nto the Siemens ProductCERT, Step7ProSim.dll is not part of the Siemens PLCSIM software. We were unable to\n\ndetermine whether this DLL was created specifically by the malware author, or if it was from another source, such as\nexample code or a particular custom ICS implementation. We surmise this DLL simulates generation of IO values, which\nwould normally be provided by an S7­based controller, since the functions it includes appear derived from the Siemens\nPLCSIM environment.\n\nIf scada.exe finds a matching DLL file name, it kills all running processes with the name biogas.exe. The malware then\n\n\n-----\n\n# � �\n\n\nreturn the recorded data.\n\nSimultaneously, the malicious DLL discards all calls to WriteDataBlockValue and instead calls\n\nWriteInputPoint(0x110, 0, 0x7763) and WriteInputPoint(0x114, 0, 0x7763) every millisecond. All of these\n\nfunctions are named similarly to Siemens S7ProSim v5.4 COM interface. It appears that other calls to API functions are\npassed through the malicious DLL to the legitimate DLL with no other modification.\n\n**Biogas.exe**\n\nAs mentioned previously, IRONGATE seeks to manipulate code similar to that found on a blog dealing with simulating PLC\ncommunications using PLCSIM, including the use of an executable named biogas.exe.\n\nExamination of the executable from that blog’s demo code shows that the WriteInputPoint function calls with byte\n\nindices 0x110 and 0x114 set pressure and temperature values, respectively:\n\nIRONGATE:\n\nWriteInputPoint(0x110, 0, 0x7763)\n\nWriteInputPoint(0x114, 0, 0x7763)\n\nEquivalent pseudo code from Biogas.exe:\n\nS7ProSim.WriteInputPoint(0x110, 0, (short)this.Pressure.Value)\n\nS7ProSim.WriteInputPoint(0x114, 0, (short)this.Temperature.Value)\n\nWe have been unable to determine the significance of the hardcoded value 0x7763, which is passed in both instances of the\n\nwrite function.\n\nBecause of the noted indications that IRONGATE is a proof of concept, we cannot conclude IRONGATE’s author intends to\nmanipulate specific temperature or pressure values associated with the specific biogas.exe process, but find the similarities\nto this example code striking.\n\nThe IRONGATE droppers are Python scripts converted to executables using PyInstaller. The compiled droppers contain\nPyInstaller artifacts from the system the executables were created on. These artifacts may link other samples compiled on\nthe same system. Five of the six file droppers (bla.exe, update.exe1, update_no_pipe.exe1,\n\nupdate_no_pipe.exe2 and update.exe3) all share the same PyInstaller artifacts listed in Table 1.\n\n\n-----\n\n**Menu**\n\n\nTable 1: Pyinstaller Artifacts\n\nThe remaining dropper, update.exe2, contains the artifacts listed in Table 2.\n\nTable 2: Pyinstaller Artifacts for update.exe2\n\nFigure 1 and 2 list the unique strings discovered in the scada.exe and Step7ProSim.dll binaries.\n\n\n-----\n\n**Menu**\n\n\nFigure 1: Scada.exe Unique Strings\n\nFigure 2: Step7ProSim.dll Unique Strings\n\nTable 3 contains the MD5 hashes, file and architecture type, and compile times for the malware analyzed in this report.\n\n\n-----\n\n**Menu**\n\n\nTable 3: File MD5 Hashes and Compile Times\n\nFireEye detects IRONGATE. A list of indicators can be found here.\n\nSpecial thanks to the Siemens ProductCERT for providing support and context to this investigation.\n\nThis entry was posted on Thu Jun 02 08:00:00 EDT 2016 and filed under Advanced Malware, Blog, ICS Security, Ics, Josh\nHoman, Latest Blog Posts, Rob Caldwell, Scada, Scada System Security, Sean McBride and Threat Research.\n\n\nFirst Name Last Name\n\n\nEmail Address\n\n\nLast Name\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/ICS SCADA/Other/Irongate ICS Malware.pdf"
    ],
    "report_names": [
        "Irongate ICS Malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535767,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1468937109,
    "ts_modification_date": 1468937109,
    "files": {
        "pdf": "https://archive.orkl.eu/cade46859117a66fa11b444dce752e03b98eb280.pdf",
        "text": "https://archive.orkl.eu/cade46859117a66fa11b444dce752e03b98eb280.txt",
        "img": "https://archive.orkl.eu/cade46859117a66fa11b444dce752e03b98eb280.jpg"
    }
}