{
    "id": "35ba3ae3-4792-45e8-bbc2-32afe9b60034",
    "created_at": "2023-01-12T15:10:18.961286Z",
    "updated_at": "2025-03-27T02:05:37.539537Z",
    "deleted_at": null,
    "sha1_hash": "0ec4ff4a09d7c128ba774f824d9b9f1f8e24b6d3",
    "title": "2014-07-31 - Poweliks- the persistent malware without a file",
    "authors": "",
    "file_creation_date": "2022-05-27T23:13:02Z",
    "file_modification_date": "2022-05-27T23:13:02Z",
    "file_size": 217081,
    "plain_text": "# Poweliks: the persistent malware without a file\n\n**[gdatasoftware.com/blog/2014/07/23947-poweliks-the-persistent-malware-without-a-file](https://www.gdatasoftware.com/blog/2014/07/23947-poweliks-the-persistent-malware-without-a-file)**\n\nWhen security researchers talk about malware, they usually refer to files stored on a\ncomputer system, which intends to damage a device or steal sensitive data from it. Those\nfiles can be scanned by AV engines and can be handled in a classic way. The following\nanalysis is an example of malware which resides in the registry only, is persistent and is not\npresent as a file which can be scanned easily.\n\n## Executive Summary\n\nWhen security researchers talk about malware, they usually refer to files stored on a\ncomputer system, which intends to damage a device or steal sensitive data from it. Those\nfiles can be scanned by AV engines and can be handled in a classic way. The following\nanalysis is an example of malware which resides in the registry only, is persistent and is not\npresent as a file which can be scanned easily.\n\nThis technique is something rarely put into focus. The initial file, which starts all malicious\nactivity on the computer system, holds all code necessary for the attack, crypted and hidden,\nwaiting to be called and executed. To unfold the harmful actions, the attackers work step-bystep deeper into the code. Executing these steps one after the other reminds of the stacking\nprinciples of Matryoshka dolls:\n\nAs the entry point, they exploit a vulnerability in Microsoft Word with the help of a\ncrafted Word document they spread via email. The same approach would work with\nany other exploit.\nAfter that, they make sure that the malicious activities survive system re-boot by\ncreating an encoded autostart registry key. To remain undetected, this key is\ndisguised/hidden.\nDecoding this key shows two new aspects: Code which makes sure the affected\nsystem has Microsoft PowerShell installed and additional code.\nThe additional code is a Base64-encoded PowerShell script, which calls and executes\nthe shellcode (assembly).\nAs a final step, this shellcode executes a Windows binary, the payload. In the case\nanalyzed, the binary tried to connect to hard coded IP addresses to receive further\ncommands, but the attackers could have triggered any other action at this point.\nAll activities are stored in the registry. No file is ever created.\n\nSo, attackers are able to circumvent classic anti-malware file scan techniques with such an\napproach and are able to carry out any desired action “when they reach the innermost layer\nof the Matryoshka doll” – even after a system re-boot!\n\n\n-----\n\nTo prevent attacks like this, AV solutions have to either catch the file (the initial Word\ndocument) before it is executed (if there is one), preferably before it reached the customer’s\nemail inbox. Or, as a next line of defense, they need to detect the software exploit after the\nfile’s execution, or, as a last step, in-registry surveillance has to detect unusual behavior,\nblock the corresponding processes and alert the user.\n\n## The analysis\n\nThe G DATA SecurityLabs have analyzed persistent malware which resides in the registry\nonly and therefore does not create any file on the infected system. An overview of this\n[mechanism was firstly described quite recently in the KernelMode.info forum. The analyzed](http://www.kernelmode.info/forum/viewtopic.php?f=16&t=3377)\nsample is dropped by a Microsoft Word document which exploits the vulnerability described\nin [CVE-2012-0158. The document](http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0158) [was reported to be found as an attachment of fake](http://techhelplist.com/index.php/spam-list/483-scheduled-package-delivery-failed-date-multi-malware)\nCanada Post and/or USPS email which claims to hold information about ordered items for\nthe recipient of the spam.\n\n## Autostart feature\n\nTo start at every boot-up of the system, the malware must create an autostart mechanism. In\nthis case, the malware creates the following registry key:\n\nNote that the character used for the key’s name is not an ASCII character. We will come\nback to this fact, later. The mentioned entry contains:\n\nThe purpose of this command is to open and execute the encoded content (the tag\n“jscript.encode” indicates the encoding) of the key:\n\n\\\\HKCU\\software\\microsoft\\windows\\currentversion\\run\\(default)\n\n## Hide the autostart from the administrator’s tools\n\nAs mentioned, the name of the registry key to start the malware is not an ASCII character.\nThe purpose is to hide the entry from system tools. The following screenshot reveals the\nregistry key’s content, opened with the common Windows tool reged\n\n\n-----\n\nRegedit cannot read the non-ASCII character and therefore cannot open the key, as the error\nmessage shows. Furthermore, the user cannot see the key either.\n\n## Malware in a registry value – like Matryoshka dolls\n\nThe developer uses a technique which resembles the stacking principle of Matryoshka dolls:\ninitially used code embeds and executes further code and this code then leads to even more\n[code used and so on and so on. The initial code executed is JScript code and then a](http://en.wikipedia.org/wiki/JScript)\nPowerShell script which finally executes shellcode that contains the malicious code of\nPoweliks.\n\n## Step 1 (JScript code)\n\nIt is no surprise that the content of the executed registry key mentioned above is encod\n\nThis [encoding technique was initially created by Microsoft in order to protect source code](http://en.wikipedia.org/wiki/JScript.Encode)\nfrom being copied or tampered with. However, a security researcher had found a way to\ndecode this kind of data which we can use now. Looking at the decoded key, the following\ntasks can be identified:\n\n\n-----\n\nThe script checks if Windows PowerShell is installed on the system. If it is not installed,\nthe script downloads and installs it;\nIt executes further code, stored in base64; examined in the next paragraph.\n\nOnce decoded, the stored code is a PowerShell script, which perfectly explains why the\nmalware searched for/installed the software during the previous step. By default, Microsoft\nWindows has protection to avoid the execution of unknown PowerShell scripts. If we try to\nexecute a PowerShell script, we have the following error message:\nPS C:\\Users\\User> .\\script.ps1\n\nFile script.ps1 cannot be loaded because the execution of scripts is disabled on this system.\n\nThe attackers circumvent this limitation by making Windows believe that the script runs in\ninteractive mode of PowerShell. Therefore, the script can be executed without a user\nnotification.\n\n## Step 2 (PowerShell script and its purpose)\n\nThe PowerShell script contains a variable $p, which contains Base64-encoded shellcode. It\nuses VirtualProtect() to render the memory executable and CallWindowProcA() to execute\nthe shellcode in $p.\n\n## Step 3 (ASM shellcode)\n\nThe shellcode realizes several actions:\n\nIt allocates memory, using VirtualAlloc();\nit copies data, including itself (at the offset 0x1104);\nIt executes the copied code.\n\nHave a look at the data copied to the offset 0x11\n\n\n-----\n\nWe can identify a Microsoft Windows binary (starting with MZ). Furthermore, we can see two\nother significant strings: MPRESS1 and MPRESS2. Theses strings are added by a packer\ncalled MPress, but we will not go into detail about the unpacking at this point. This last\npayload, the entire MZ, is the actual malicious part; it performs connections to two IPs\nlocated in Kazakhstan to receive commands. At the time of analyzing this case, the two IPs\nwere already offline, so we cannot state what attack the authors wanted to launch.\n\nAs the malware is very powerful and can download any payload; the amount of possible\ndamage is not really measurable. It might install spyware on the infected computer to harvest\npersonal information or business documents. It might also install banking Trojans to steal\nmoney or it might install any other form of harmful software that can suit the needs of the\nattackers. Fellow researchers have suggested that Poweliks is used in botnet structures and\nto generate immense revenue through ad-fraud.\n\n## Conclusion\n\nThe analysis of this piece of code was uncommon and rather time consuming, with several\ncode layers which were created to prolong the analysts’ work and certainly to hide the\nmalware and to blend it into the usual system use without the user noticing the infection.\n\nPoweliks is malware that does survive without any file creation, which is a rather rare and\nnew technique, barely focused on – everything is performed within the memory. It only\nresides in the registry and executes programs from there. Furthermore, the developers hid\nthe autostart registry key by using a non-ASCII character as the name of the key. This trick\n\n\n-----\n\nprevents a lot of tools from processing this malicious entry at all and it could generate a lot of\ntrouble for incident response teams during the analysis. The mechanism can be used to start\nany program on the infected system and this makes it very powerful!\n\n## For fellow researchers:\n\nOffice documents using CVE-2012-0158:\n\n74e0d21fe9edf7baf489e29697fff8bc4a6af811e6fe3027842fe96f6a00a2d9\n\n88bc64e5717a856b01a04684c7e69114d309d52a885de9fc759e5a99ac20afd5\n\nThe Poweliks installer (creates the registry keys):\n\n4727b7ea70d0fc00f96a28de7fa3d97fa9d0b253bd63ae54fbbf0bd0c8b766bb\n\ne8d6943742663401e5c44a5fa9cfdd8fad6a9a0dc0f886dc77c065a86c0e10aa\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-07-31 - Poweliks- the persistent malware without a file.pdf"
    ],
    "report_names": [
        "2014-07-31 - Poweliks- the persistent malware without a file.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536218,
    "ts_updated_at": 1743041137,
    "ts_creation_date": 1653693182,
    "ts_modification_date": 1653693182,
    "files": {
        "pdf": "https://archive.orkl.eu/0ec4ff4a09d7c128ba774f824d9b9f1f8e24b6d3.pdf",
        "text": "https://archive.orkl.eu/0ec4ff4a09d7c128ba774f824d9b9f1f8e24b6d3.txt",
        "img": "https://archive.orkl.eu/0ec4ff4a09d7c128ba774f824d9b9f1f8e24b6d3.jpg"
    }
}