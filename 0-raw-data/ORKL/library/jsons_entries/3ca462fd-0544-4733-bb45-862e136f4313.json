{
    "id": "3ca462fd-0544-4733-bb45-862e136f4313",
    "created_at": "2023-01-12T15:07:36.969855Z",
    "updated_at": "2025-03-27T02:13:34.602398Z",
    "deleted_at": null,
    "sha1_hash": "40fd2f14095683934480bb47c9e0c61900809048",
    "title": "2014-09-29 - MMD-0028-2014 - Linux-XOR.DDoS- Fuzzy reversing a new China ELF",
    "authors": "",
    "file_creation_date": "2022-05-29T01:00:53Z",
    "file_modification_date": "2022-05-29T01:00:53Z",
    "file_size": 1389139,
    "plain_text": "# MMD-0028-2014 - Linux/XOR.DDoS : Fuzzy reversing a new China ELF\n\n**[blog.malwaremustdie.org/2014/09/mmd-0028-2014-fuzzy-reversing-new-china.html](http://blog.malwaremustdie.org/2014/09/mmd-0028-2014-fuzzy-reversing-new-china.html)**\n\n### Sticky note: The latest incident (MMD-0033-2015) we disclosed on ELF Linux/XOR.DDoS malware is here -->[LINK] This research is detected & solved by a hard work of MMD members. Credits are in the bottom of the post.\n The case is on and malware infrastructure is mostly up & alive, we don't want to be too details in writing because of that reason, we don't want to teach this crook of what they're lacking of by this post, yet this post necessary to raise awareness of this new emerged threat. Feel free to follow the process at will.\n\n## The infection\n\n### During the rush of #shellshock we saw another new threat emerged. We saw an attack log of one-liner shell script being injected via ssh connection. By the attack source+CNC IP and the payload, this looks like a China crook's new hack scheme to spread new ELF DDoS'er threat. This is spotted silently spread during the # shellshock waves, noted: it was NOT using #shellshock exploit itself.\n\n\n-----\n\n### The details of the attacker s trace in one-liner shell command is as per shown below:\n\n If we beautified it as per below we will see the obfuscation this shell script:\n\n â†‘the marked mark is the point of all these code, to download the file 3502.rar from some defined host addresses.\n\n\n-----\n\n### The mentioned RAR file itself is actually a shell script too:\n\n You can read the codes here, no free ride copy/paste this time, since we have hard times with those false positives from antiviruses\n\n\n-----\n\n### The main() function is explaining how this script works, read the comments we made (in purple colored words):\n\n Shortly. The blue color explaining the obfuscation strings saved in some variables. The yellow marked color words are functions to be executed, and the red color area is the main function of this script, to download and install a payload.\n\n The obfuscation used is in the enc() and dec() function (see that big pic codes) for encryption and decryption, by using the below code (I picked this one, the one used for decrypting)\n```\ntr \"[.0-9a-zA-Z\\/\\/\\:]\" \"[a-zA-Z0-9\\;-=+*\\/]\";\n\n They called it encryption, but is just a mere obfuscator using the character map translation in \"tr\". Below is the easy shell script I made to decode them:\n\n```\n\n-----\n\n### Below is the result:\n\n We'll see another 3502 file. And a bunch of the CNC used. Noted the username and password they use ;)\n\n\n-----\n\n### If you permutated the URL with the payload name you will some ALIVE malware URLs like\n\n these:\n\n What is this thing? In short: It's a sophisticated & well-thought ELF malware infection scheme, aiming Linux in multiple platform. It downloads, detect all parameter need to download the payload or source code of payload. It detected infected host's architecture, compiler. libraries together with sending sensitive information of the host, sent request to CNC to download the certain bins or to download resources to hack and then install the ELF binary.\n\n The POC of this hack is the payload below:\n\n## The payload\n\n### The header looks very \"fine\":\n```\nELF Header:\n Magic:  7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00\n Class:               ELF32\n Data:               2's complement, little endian\n Version:              1 (current)\n OS/ABI:              UNIX - System V\n ABI Version:            0\n Type:               EXEC (Executable file)\n Machine:              Intel 80386\n Version:              0x1\n Entry point address:        0x8048110\n\n```\n\n-----\n\n### First block:\n\n Various analysis can resulted to the payload was coded in C, hmm..a quality up, we have a challenger here :) A new DDoS'er made in China. Here's the codes (for future reference):\n```\n'crtstuff.c'\n'autorun.c'\n'crc32.c'\n'encrypt.c'\n'execpacket.c'\n'buildnet.c'\n'hide.c'\n'http.c'\n'kill.c'\n'main.c'\n'proc.c'\n'socket.c'\n'tcp.c'\n'thread.c'\n'findip.c'\n'dns.c' \n\n Some pointers for characteristic: Self copy:\n\n```\n\n-----\n\n```\n// create file for self copy\nopen(\"/boot/[a-z]{10}\", O_WRONLY|O_CREAT, 0400)\nopen(\"/boot/[a-z]{10}\", O_WRONLY)\n//chmod 755\nchmod(\"/boot/[a-z]{10}\", 0750)\n// start to write..\nopen(\"/boot/[a-z]{10}\", O_RDONLY)\n\n### Auto start:\n\n```\n\n-----\n\n```\n// install SYS\n.text:0x8048B2E  mov   dword ptr [esp], offset aSbinInsmod <== \"/sbin/insmod\"\n.text:0x8048B35  call  LinuxExec_Argv\n.text:0x8048B3A  mov   dword ptr [esp], 2\n.text:0x8048B41  call  sleep\n// xinetd setup..\n.text:0x8048852  call  abstract_file_name\n.text:0x8048857  mov   [ebp+var_8], eax\n.text:0x804885A  mov   eax, [ebp+arg_0]\n.text:0x804885D  mov   [esp+0Ch], eax\n.text:0x8048861  mov   dword ptr [esp+8], offset aBinShS <== \"#!/bin/sh\\n%s\\n\"\n.text:0x8048869  mov   dword ptr [esp+4], 400h\n.text:0x8048871  lea   eax, [ebp+newpath]\n.text:0x8048877  mov   [esp], eax\n.text:0x804887A  call  snprintf\n  :\n.text:0x804887F  mov   eax, [ebp+var_8]\n.text:0x8048882  mov   [esp+0Ch], eax\n.text:0x8048886  mov   dword ptr [esp+8], offset aEtcInit_dS <== \"/etc/init.d/%s\"\n.text:0x804888E  mov   dword ptr [esp+4], 400h\n.text:0x8048896  lea   eax, [ebp+filename]\n.text:0x804889C  mov   [esp], eax\n.text:0x804889F  call  snprintf\n.text:0x80488A4  mov   dword ptr [esp+4], offset aW <== \"w\"\n.text:0x80488AC  lea   eax, [ebp+filename]\n.text:0x80488B2  mov   [esp], eax\n.text:0x80488B5  call  fopen\n  :\n.text:0x8048980  mov   dword ptr [esp+8], offset aEtcRcD_dS90S <==\n\"/etc/rc%d.d/S90%s\"\n.text:0x8048988  mov   dword ptr [esp+4], 400h\n.text:0x8048990  lea   eax, [ebp+newpath]\n.text:0x8048996  mov   [esp], eax\n.text:0x8048999  call  \"snprintf\"\n.text:0x804899E  lea   eax, [ebp+newpath] // assemble flag component for file\nattribs\n.text:0x80489A4  mov   [esp], eax   <== \"filename\"\n.text:0x80489A7  call  \"unlink\"\n.text:0x80489AC  lea   eax, [ebp+newpath]\n.text:0x80489B2  mov   [esp+4], eax  <== \"newpath\"\n.text:0x80489B6  lea   eax, [ebp+filename]\n.text:0x80489BC  mov   [esp], eax   <== \"oldpath\"\n.text:0x80489BF  call  \"symlink\"\n.text:0x80489C4  cmp   [ebp+var_C], 0\n.text:0x80489C8  jnz   short loc_80489E8\n.text:0x80489CA  mov   dword ptr [esp+8], 0AD1473B8h <== \"group\"\n.text:0x80489D2  mov   dword ptr [esp+4], 0AD1473B8h <== \"owner\"\n.text:0x80489DA  lea   eax, [ebp+filename]\n.text:0x80489E0  mov   [esp], eax   <== \"filename\"\n.text:0x80489E3  call  \"lchown\"\n\n### Malicious environment setup (i.e. export cmd):\n\n```\n\n-----\n\n```\n0x06988C  HOME /\n0x069893  HISTFILE=/dev/null\n0x0698A6  MYSQL_HISTFILE=/dev/null\n0x0698C0  PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin\n\n### Encryption:\n\n There are some encryption to be decrypted in this malware, that I tested as per below, that looks having xor pattern:\n// checking decryptor...\n.text:0x804CB63  mov  dword ptr [esp+4], offset aM_Nfr7nlqqgf_0\n.text:0x804CB6B  lea  eax, [ebp+filename]\n.text:0x804CB71  mov  [esp], eax\n.text:0x804CB74  call dec_conf      // decrypting function..\n.text:0x804CB79  mov  dword ptr [esp+8], 0Ch // <== break it here..\nBreakpoint 1, 0x0804cb79 in main ()\nquery offset aM_Nfr7nlqqgf_0: \"m.[$nFR$7nLQQGF\"\nquery register: $esp\n0xffffa1b0: \"[\\305\\377\\377\\343\\033\\v\\b\\020\"\n;----------------------.text:0x804CB81  mov  dword ptr [esp+4], offset aM_Nfr7n9_0\n.text:0x804CB89  lea  eax, [ebp+var_114D]\n.text:0x804CB8F  mov  [esp], eax\n.text:0x804CB92  call  dec_conf\nBreakpoint 2, 0x0804cb9 in main ()\nquery offset aM_Nfr7n9_0: \"m.[$nFR$7n9\"\nquery register: $esp\n0xffffa1b0: \"[\\304\\377\\377\\363\\033\\v\\b\\f\"\n;----------------------.text:0x804CBBD  mov  dword ptr [esp+4], offset aM4s4nacNa ; \"m4S4nAC/nA\"\n.text:0x804CBC5  lea  eax, [ebp+var_E4D]\n.text:0x804CBCB  mov  [esp], eax\n.text:0x804CBCE  call  dec_conf\n.text:0x804CBD3  mov  [ebp+var_34], 0\nBreakpoint 3, 0x0804cbd3 in main ()\nquery offset aM4s4nacNa ; \"m4S4nAC/nA\"\nquery register: $esp\n0xffffa1b0: \"[\\307\\377\\377#\\034\\v\\b\\v\"\n\n```\n\n-----\n\n### Here is the xor used as the component logic for the decryption function:\n\n With the key that lead to this address:\n\n It \"looks like\" the author is having \"interesting\" way to remind him the XOR key itself, I don't\n\n\n-----\n\n### investigate this further since I had the goal..\n\n A hard-coded callback IP address\n\n And look what I got next to the xor key :))\n\n So now we know the CNC is too ;)\n```\nIP: 103.25.9.228||59270 | 103.25.9.0/24 | CLOUD \nCountry: \"HK | CLOUDRELY.COM\" |CLOUD RELY LIMITED\n\n The bummer part of this malware is it crashed itself when run under limited permission\n\n```\n\n-----\n\n```\n msec  calls \n----------------------------------------------------------------------(120): execve(\"./SAMPLE-MALWARE\", [\"./SAMPLE-MALWARE\"], [\"SHELL=etc..])\n(125): set_thread_area(0xffc8373c)\n(126): set_tid_address(0x92e6888)\n(127): set_robust_list(0x92e6890, 0xc)\n(128): futex(0xffc83a04, FUTEX_WAKE_PRIVATE, 1)\n(129): rt_sigaction(SIGRTMIN, {0x8053860, [], SA_SIGINFO}, NULL, 8)\n(130): rt_sigaction(SIGRT_1, {0x8053780, [], SA_RESTART|SA_SIGINFO}, NULL, 8)\n(131): rt_sigprocmask(SIG_UNBLOCK, [RTMIN RT_1], NULL, 8)\n(132): getrlimit(RLIMIT_STACK,etc)\n(133): uname({sysname=\"Linux\", nodename=\"mmd\", release=\"mmd-amd64\", \n       version=\"#1 SMP mmd-7u1\", machine=\"saever-momma\"})\n(142): readlink(\"/proc/self/exe\", \"/home/mmd/test/SAMPLE-MALWARE\", 1023)\n(143): clone(Process)\n(145): exit_group(0)\n(146): [pid new] setsid()\n(147): open(\"/dev/null\", O_RDWR)\n(148): fstat64(3, {st_dev=makedev] etc) \n(149): dup2(3, 0)\n(150): dup2(3, 1)\n(151): dup2(3, 2)\n(152): close(3)\n(153): readlink(\"/proc/self/exe\", \"/home/mmd/test/SAMPLE-MALWARE\", 1023) = 20\n(154): stat64(\"/boot\" etc)\n(155): stat64(\"/lib\", etc)\n(156): stat64(\"/lib/udev\" etc)\n(157): stat64(\"/var\", etc)\n(158): stat64(\"/var/run\", etc)\n(159): gettimeofday({1411989055, 135168}, NULL) \n(160): readlink(\"/proc/self/exe\", \"/home/mmd/test/SAMPLE-MALWARE\", 1023) \n(161): unlink(\"/lib/udev/udev\") \n(162): open(\"/home/mmd/test/SAMPLE-MALWARE\", O_RDONLY)\n(163): open(\"/lib/udev/udev\", O_WRONLY|O_CREAT, 0400)\n(165): open(\"/home/mmd/test/SAMPLE-MALWARE\", O_RDONLY)\n(166): open(\"/boot/[a-z]{10}\", O_WRONLY|O_CREAT, 0400)\n(168): open(\"/boot/[a-z]{10}\", O_WRONLY)\n(169): clone(Process attached\n(171): waitpid(Process suspended\n(173): clone(Process attached\n(175): exit_group(0)\n(179): rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8)\n(180): rt_sigaction(SIGCHLD, NULL, {SIG_IGN, [CHLD], SA_RESTART}, 8)\n(181): nanosleep({1, 0},..\n(192): chmod(\"/boot/[a-z]{10}\", 0750)\n(193): open(\"/boot/[a-z]{10}\", O_RDONLY)\n(194): \"--- SIGSEGV (Segmentation fault) @ 0 (0)\" --- ref: [a-z]{10}\n(197): \"rt_sigprocmask(SIG_SETMASK, [], NULL, 8)\"\n\n### It saves the file in /boot with this regex: [a-z]{10}\n\n## What is the purpose of this malware?\n\n```\n\n-----\n\n### The first is backdoor, and then, obviously DoS (SYN, UDP, TCP flood), using encrypted (temporary) config. Below is the PoC of the DDoS function names:\n```\n0x09305E  build_syn // SYN Flood\n0x0950D0  build_tcphdr // TCP Flood\n0x097101  build_udphdr // UDP FLood\n\n And below is part of backdoor operation using HTTP/1.1 GET (to download / update) and callback in HTTP/1.1 POST:\n.text:0x804A917  mov  dword ptr [esp+8], offset aPostSHttp1_1Sh\n            value: \"POST %s HTTP/1.1\\r\\n%sHost: %s\\r\\nContent-T\"\n.text:0x804AB1D  mov  dword ptr [esp+8], offset aGetSHttp1_1Sho\n            value: \"GET %s HTTP/1.1\\r\\n%sHost: %s\\r\\n%s\"\n\n Based on the code it looks like using AES.DDoS'er and IptabLes strategy to install, but the source are different. So, this is another new China DDoS'er, I call this as Linux/XOR.DDoS.\n\n## Virus Total and sample\n\n### Virus total detection is below (click the image to access..) One of 55 is a bad detection..\n\n Sample is shared in kernel mode-->[here]\n\n## Conclusion & Credits\n\n### This threat is the first time we see using complicated installer/builder. I and other team mates start to feel like playing CTF with this crook. They (China actors) are improving in steps, we must be aware. Please stay safe folks..\n\n Credit: @shibumi (threat sensoring), @wirehack7 (formulation), and others who doesn't want to be mentioned.\n\n## Additional\n\n### (A reserved section for additional and updates)\n\n #MalwareMustDie!!\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-09-29 - MMD-0028-2014 - Linux-XOR.DDoS- Fuzzy reversing a new China ELF.pdf"
    ],
    "report_names": [
        "2014-09-29 - MMD-0028-2014 - Linux-XOR.DDoS- Fuzzy reversing a new China ELF.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "08c8f238-1df5-4e75-b4d8-276ebead502d",
            "created_at": "2023-01-06T13:46:39.344081Z",
            "updated_at": "2025-03-27T02:00:03.056208Z",
            "deleted_at": null,
            "main_name": "Copy-Paste",
            "aliases": [],
            "source_name": "MISPGALAXY:Copy-Paste",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536056,
    "ts_updated_at": 1743041614,
    "ts_creation_date": 1653786053,
    "ts_modification_date": 1653786053,
    "files": {
        "pdf": "https://archive.orkl.eu/40fd2f14095683934480bb47c9e0c61900809048.pdf",
        "text": "https://archive.orkl.eu/40fd2f14095683934480bb47c9e0c61900809048.txt",
        "img": "https://archive.orkl.eu/40fd2f14095683934480bb47c9e0c61900809048.jpg"
    }
}