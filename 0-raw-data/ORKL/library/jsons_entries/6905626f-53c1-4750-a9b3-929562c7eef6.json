{
    "id": "6905626f-53c1-4750-a9b3-929562c7eef6",
    "created_at": "2023-01-12T15:05:21.814783Z",
    "updated_at": "2025-03-27T02:05:42.951046Z",
    "deleted_at": null,
    "sha1_hash": "461941f7bf15269867d5224e6a1289911eb7c117",
    "title": "2018-01-06 - Ostap malware analysis (Backswap dropper)",
    "authors": "",
    "file_creation_date": "2022-05-28T19:49:24Z",
    "file_modification_date": "2022-05-28T19:49:24Z",
    "file_size": 254381,
    "plain_text": "# Dropper evolves to botnet (2017)\n\n**[cert.pl/en/news/single/ostap-malware-analysis-backswap-dropper/](https://www.cert.pl/en/news/single/ostap-malware-analysis-backswap-dropper/)**\n\nMalicious scripts, distributed via spam e-mails, have been getting more complex for\nsome time. Usually, if you got an e-mail with .js attachment, you could safely assume\nit’s just a simple dropper, which is limited to downloading and executing malware.\nUnfortunately, there is a growing number of campaigns these days, where script\ndoesn’t exit after downloading sample. Instead of ending its life – it remains active,\nwaiting for additional commands or more samples to fetch. Some of the examples are:\nvjw0rm used in Vortex ransomware campaigns and Ostap – the main protagonist of\nour story.\n\n**This article is an introduction to Backswap malware analysis, which is a second-**\n**stage malware downloaded by Ostap. Our analysis of Backswap malware will be**\n**published soon!**\n\nOstap has became a very popular malware worldwide, but the most interesting\ncampaigns observed by CERT.pl occured in Poland. It is mostly used for banking\nmalware distribution. Currently it distributes two banker families simultaneously:\n[Nymaim and Backswap, which is actually slightly modified Tinba. Because both](https://www.cert.pl/news/single/nymaim-atakuje-ponownie/)\nmalware families are dropped at the same time, there is specific correlation between\nthem – noticed by [ESET in their Backswap analysis. Analysis of both banker families](https://www.welivesecurity.com/2018/05/25/backswap-malware-empty-bank-accounts/)\ncan be also found on our webpage.\n\n\n-----\n\nScript is delivered as a compressed attachment (fake invoice). It has an .rar extension,\nbut don’t be fooled – actually it’s an ACE archive. This is a very usual technique, used\nto mislead some automatic analyzers, which identify a file type by its extension.\nDespite that, WinRAR is able to recognize the real archive format, so victims don’t\nhave any problems to execute the Ostap script using that software.\n\nThe archive contains a JSE file, which is an encoded JScript. Because of the\nobfuscation method used (characteristic for this malware), file is rather large, and can\nexceed several hundred kilobytes in size.\n\n## First Ostap campaigns (2016)\n\nFirst campaigns were observed by CERT.pl in May 2016. In the first versions, Ostap\nwas just a simple dropper, which uninstalls itself after completing its mission. The\ncharacteristic part was the obfuscation method mentioned before – strings were\ncompleted char-by-char using complex expressions evaluated by JScript interpreter.\n\nAfter deobfuscation:\n\nDuring execution – script was performing few actions:\n\nShows message The document is corrupted and cannot be opened\nAdds itself to the Startup folder oShell[‘NameSpace’](7), which ensured automatic\nexecution on logon (in case the file was not available immediately)\nTries to download and execute EXE file from URL\nhttps://217.28.218.217/YOP634EFARRR/q64.php?\nadd=gtyhbncdfewpnjm9oklmnfdrtqdczdfgrt&<random number>. In case of failure\n– it tries again every 80 seconds.\nAfter successful download and instalation – removes itself from Startup and\ndeletes downloaded file, ending its existence on compromised host.\n\n\n-----\n\nSo, at first, Ostap was just simple dropper, but pretty characteristic (e.g. because of\nadd= argument containing campaign identifier, obfuscation, URL format). Samples\ndownloaded by Ostap weren’t usually available immediately after the beginning of the\ncampaign and they were distributed only for a short period of time. Downloaded\n[malware samples were usually bankers: KBot and](https://www.cert.pl/news/single/newest-addition-a-happy-family-kbot/) [Gozi ISFB](https://lokalhost.pl/talks/botconf2016/)\n\nA month later – in June 2016, we found next version of Ostap, sending additional\ninformation about victim environment.\n\nC&C address was slightly different and contained more fields:\n\nMeaning of each field is described below:\n\nhash from the Startup path and computer name (uid)\noperating system version (based on Users substring existence in\n%HOMEPATH%) – ver\nadditional request was sent after successful download (out=1)\nC&C was delivering malware encoded in Base64. Ostap was perfoming some\ndecoding using the built-in certutil command. Also, new version contained some failsafe methods of malware execution:\n\nCriminals were showing their (kind of) creativity, sometimes adding a bitmap file to ACE\narchives.\n\nA few months later, script started to deliver various types of banking malware such as\nTinba, Ramnit or ISFB. Since then, Ostap (named after ostap.php script name) was\nslowly becoming serious piece of malware.\n\n\n-----\n\nBecause of the variety of samples and number of parallel campaigns, we began to\nsuspect that Ostap is used as distribution service and delivered software is not\nassociated with single actor. From 2016, Ostap was getting more and more active.\n\nFrom the half of 2017, Ostap became more powerful. The first thing developed in 2017\nversion were several anti-analysis techniques.\n\n## Gathering information about execution environment\n\nBefore Ostap launches – malware executes WMI query, requesting for active\nprocesses list, user name, domain name, version of operating system etc.\n\nOutput from sysInfo and procInfo is then concatenated:\n\nThen, Ostap looks for occurences of several names characteristic for analysis tools\nand sandbox environments:\n\nIf a characteristic name is found, Ostap calls document.alert method. Object document\ndoesn’t exist in Windows Script Host context (it is seen only in web browsers) which\nraises an unhandled exception, stopping the execution.\n\nAfter gathering information from WMI – script copies itself to Startup and goes to the\nmain part.\n\n## Communication with C&C (downloading malicious samples)\n\nURL pattern used by Ostap from 2017 was very similar. However, few communication\naspects changed from the 2016 version.\n\nRequest method changed from GET to POST\nOstap sends fetched sysInfo+procInfo as request body\nArgument names were shortened (uid becomes u)\nC&C server sends additional information about blob format and method of sample\nexecution:\n\nFile could be sent raw or Base64-encoded (Content-Transfer-Encoding was set to\nbinary or base64)\nThere were few methods of execution, based on you_god_damn_right HTTP\nresponse header value (actual name differs depending on the malware version)\nYup, Ostap is full of “Breaking bad” quotes.\n\n\n-----\n\nPossible values of you_god_damn_right are:\n\n0 – file is an update (replace the original script and execute, closing itself)\n1 – run DLL file (with secretFunction as entrypoint)\n2 – install software silently with Administrator privileges (MSI installer)\nBy default, fetched file was run using cmd /c start <file path>\n\nAfter successful installation – script removes all files from TEMP folder which were\npotentially associated with fetched sample (.exe, .gop – base64 encoded, .txt, .log,\n*.jse – update)\n\n## Destructive propagation on removable media and network shares\n\nIf creation of file after download was unsuccessful (file still doesn’t exist under expected\nlocation) – Ostap becomes more nasty than usual.\n\nAt the beginning, script was preparing a list of files with specified extensions, which are\nlocated on removable media and mounted network shares. List of files found was\nwritten to temporary file saymyname.txt.\n\nThen, based on that list – all files were deleted and replaced by Ostap copy (with\npreserved name and added .jse extension). The purpose was probably to “punish”\nincautious analysts, which can accidentally trigger that code by script modifications.\n\n\n-----\n\n## Persistence\n\nStarting from 2017, Ostap doesn’t erase itself after successful download anymore.\nUsing self-update capabilities, malware persists on infected machine, serving banking\nmalware from various families. The victim becomes a part of distribution botnet.\n\n## Current version (2018)\n\nCurrently, Ostap is one of the most active families targeting the online banking\ncustomers in Poland. Malware code is being constantly developed and improved.\n\nVersion from 2018 has added few more methods of sandbox detection:\n\nMalware doesn’t execute on Windows XP\nOstap verifies length of process list (>1500 characters is needed, which was\n[efective against emulation using tools like box-js)](https://github.com/CapacitorSet/box-js)\n\n\n-----\n\nFew strings were added to blacklist:\nIf a sandbox substring was detected:\n\nMalware executes ploha[‘show’](‘No more half-measures.’); which triggers\nundefined variable exception (ploha doesn’t exist in the code)\nIf exception is not raised (or handled externally) – Ostap tries to terminate script\nusing WScript.Quit()\nIf script is still working – “destructive propagation” is activated\nDestructive propagation has additional condition now – if file creation was unsuccessful\nand sandbox was detected without script termination, malware starts removing files.\n\nThe URL address was also slightly changed:\n\nNow, the add parameter isn’t the campaign identifier – that role is taken over by\nDeretghrttLolookest75=awsedrftgyhujiko, which changes depending on the sample.\n\nIn latest version – HTTP execution method header is also different:\nWe_are_done_when_I_say_we_are_done, as well as message displayed after\nexecuting script first time, which changed to PDF Error: The document could not be\nprinted..\n\n## Summary\n\nOstap shows how simple dropper script can evolve into real botnet malware. In\nsummary, here is the listing of characteristic elements for Ostap malware:\n\nDistribution via large-sized JSE files, delivered as ACE archives with .rar\nextension\n\n\n-----\n\nMessage showed after first execution of script (PDF Error: The document could\nnot be printed.)\nCharacteristic script obfuscation method\nPersistence (self-update capabilities, adding itself to Startup folder)\nUnusual URL pattern https://<ip[:port]>/<path>.php?<campaign_id1>=\n<campaign_id2>&add=james&(arguments…)\n## Additional information\n\nExample samples:\n\nSamples after deobfuscation:\n\n[2016-q64](https://gist.github.com/CERT-Polska-Blog/302eb36d70ac6ec083f182b3a761174c)\n[2016-ostap](https://gist.github.com/CERT-Polska-Blog/0c207535d877847e29a80d8a43ed04e1)\n[2017](https://gist.github.com/CERT-Polska-Blog/1860e08244da2de35e658cfb4b4ceedc)\n[2018](https://gist.github.com/CERT-Polska-Blog/4f0d36e104afa1e1eeca186d5945daac)\nOstap was mentioned frequently in various articles (as “interesting dropper” or\n“JS/Nemucod”):\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-01-06 - Ostap malware analysis (Backswap dropper).pdf"
    ],
    "report_names": [
        "2018-01-06 - Ostap malware analysis (Backswap dropper).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535921,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653767364,
    "ts_modification_date": 1653767364,
    "files": {
        "pdf": "https://archive.orkl.eu/461941f7bf15269867d5224e6a1289911eb7c117.pdf",
        "text": "https://archive.orkl.eu/461941f7bf15269867d5224e6a1289911eb7c117.txt",
        "img": "https://archive.orkl.eu/461941f7bf15269867d5224e6a1289911eb7c117.jpg"
    }
}