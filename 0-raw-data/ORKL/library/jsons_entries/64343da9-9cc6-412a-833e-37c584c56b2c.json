{
    "id": "64343da9-9cc6-412a-833e-37c584c56b2c",
    "created_at": "2023-01-12T15:04:17.755666Z",
    "updated_at": "2025-03-27T02:16:26.360402Z",
    "deleted_at": null,
    "sha1_hash": "0dccf48b400e9f5bf65d3ccbe810fef5e214e4b9",
    "title": "2021-01-19 - VPNFilter Two Years Later- Routers Still Compromised",
    "authors": "",
    "file_creation_date": "2022-05-28T02:38:09Z",
    "file_modification_date": "2022-05-28T02:38:09Z",
    "file_size": 1853617,
    "plain_text": "# VPNFilter Two Years Later: Routers Still Compromised\n\n**[trendmicro.com/en_us/research/21/a/vpnfilter-two-years-later-routers-still-compromised-.html](https://www.trendmicro.com/en_us/research/21/a/vpnfilter-two-years-later-routers-still-compromised-.html)**\n\nJanuary 19, 2021\n\nIoT\n\nWe look into VPNFilter, an IoT botnet discovered over two years ago, to see why there are\nstill routers infected by the malware and what else can be done to minimize its potential\nrisks.\n\nBy: Stephen Hilt, Fernando Merces January 19, 2021 Read time: ( words)\n\nWith the [internet of things (IoT) gaining more popularity, common IoT devices such as](https://www.trendmicro.com/vinfo/tmr/?/us/security/definition/internet-of-things)\nrouters, printers, cameras, and network-attached storage (NAS) devices, are becoming more\nfrequent targets for cybercriminals. Unlike typical operating systems such as Windows and\nmacOS, users are less likely to patch IoT devices. This is because users find the task more\ndifficult and inconvenient since, in comparison, the operating systems of these devices have\nno auto-update feature and some manufacturers rarely even issue security updates at all.\nThese are the kinds of systems that users log on to once in order to set them up and then\nnever to do so again, unless they encounter a big problem. It also is not rare to find an\noutdated router — one that has been running for as long as the system has.\n\n\n-----\n\nAs a result, many systems are left wide open to known vulnerabilities, which can lead to\nsuccessful attacks even years after the first infection. While looking at these types of\ninfections by known malware families, we found that one of the biggest reported malware\nfamilies was from 2018’s VPNFilter.\n\nVPNFilter is a malware type that affects routers and storage devices by using backdoor\n[accounts and exploits of several known vendors. In May 2018, Cisco Talos released the first](https://blog.talosintelligence.com/2018/06/vpnfilter-update.html)\nreport on the malware, which showed how VPNFilter was designed to gain a foothold into\nnetworks and look for Modbus traffic. However, it should be noted that this was not the only\n[plug-in but rather merely one of the plug-ins that could be deployed. Modbus is a popular](https://modbus.org/)\nindustrial control system (ICS) communication protocol that is specific to these types of\nsystems. While the malware tends to focus on compromising consumer-grade IoT devices, it\nis also true that consumer devices are often found as part of ICS systems for various\nreasons. Some reasons include the fact that these devices are easy to deploy, provide\nremote vendor access, or simply because they are mistakenly added by the administrator.\nThat the malware potentially targets control systems could be the reason that the FBI has\n[attributed the first reported attack to the work of nation-state actors.](https://www.thedailybeast.com/exclusive-fbi-seizes-control-of-russian-botnet)\n\nVPNFilter operates in multiple stages that include initial infection, command-and-control\n(C&C) communications, and the third stage, in which the payloads are deployed. These\npayloads perform the tasks that the malware has been intended to do. This is also where the\nModbus portion of the malware is found. The first stage of the malware involves gaining\naccess to specific devices from over 12 vendors. Once this is done, the second stage of the\nmalware involves an attempt to connect to Photobucket, an image-hosting site, to download\nan image that has the IP address of the C&C server embedded in the GPS coordinates of\nthe exchangeable image file format, also known as Exif. If this fails, then it will try to reach\nout to the domain toknowall[.]com to download an image with the C&C server also\nembedded in the file. Finally, if both these two attempts fail, it will open a listener to monitor\nall incoming packets for a specially crafted TCP packet that would contain the IP address of\nthe C&C server.\n\n\n-----\n\nFigure 1. VPNFilter’s operation and stages based on Cisco Talos’ report\nWhile VPNFilter gained considerable attention and became a threat when it was first\ndiscovered, this happened back in 2018. This means that several mitigation tactics have\nalready been used to render VPNFilter essentially offline. With domain seizures and every\naction taken to stop the malware, therefore, it is worth asking why there are still infections out\nthere. The FBI’s [statement at the time of the malware’s discovery advised users to restart](https://www.justice.gov/opa/pr/justice-department-announces-actions-disrupt-advanced-persistent-threat-28-botnet-infected)\npotentially affected devices to temporarily disrupt the malware. The statement also meant\nthat by restarting the router users would essentially remove any current first-stage and third[stage malware based on the initial findings from Cisco Talos. However, this leaves leftover](https://blog.talosintelligence.com/2018/05/VPNFilter.html)\ninfections, which is the original listener setup by the first-stage malware.\n\n[In our recent paper titled “Worm War: The Botnet Battle for IoT Territory,” we covered the](https://www.trendmicro.com/vinfo/tmr/?/us/security/news/internet-of-things/caught-in-the-crossfire-defending-devices-from-battling-botnets)\naspect of botnets removing the infections of other botnets and the ease with which these IoT\ndevices can be compromised. At times, it seems that threat actors are the few people who\nhave access to some of these systems and are the ones removing malware types like\nVPNFilter. It’s worth noting that this kind of access might not be available to all users in the\nfirst place. As an example, when the FBI took down part of the botnet’s network\ninfrastructure, they recommended end users to restart their devices. However, many users\nhave routers that were provided by their ISP. Often, this type of end users would therefore\nnot have login access to the router. As a result, without their ISP’s permission, they cannot\nupdate the firmware to get the latest vulnerability fixes. As we will discuss here, this is\nprecisely the reason that the FBI worked with Shadowserver to add the extra safeguard of\nsinkholing the botnet.\n\nStill, we did find examples where vendors published updates and guidance to remediate the\n[infection. Netgear and](https://kb.netgear.com/000058814/Security-Advisory-for-VPNFilter-Malware-on-Some-NETGEAR-Devices) [MikroTik, for instance, have stated that upgrading the firmware would](https://forum.mikrotik.com/viewtopic.php?t=134776)\nremediate the malware’s effects and prevent further infections\n\n\n-----\n\nAs of writing, however, we have not encountered any one organization in the IoT space that\nhas committed to clean up vulnerabilities and infections. Due to the lack of a standard group\nor mechanism for updates, the owners of these IoT devices often need to manually go to\ntheir vendor’s website, download a firmware file, then upload it to the device. Very few seem\nto have automatic firmware update procedures in place. These observations have spurred us\nto ask the following questions with regard to the remaining VPNFIlter infections:\n\nHow many victims have updated their router’s firmware?\nHow many victims have had their infected routers replaced in the last two years?\nWas VPNFilter one of the infections that was being removed by other malware\nactors?\nAre there any infected devices still out there?\n\n## Shadowserver Sinkhole\n\n[The Shadowserver Foundation is a nonprofit security organization whose mission is to “...](https://www.shadowserver.org/who-we-are/)\nmake the Internet more secure by bringing to light vulnerabilities, malicious activity and\n[emerging threats.\" Recently, Trend Micro has partnered with Shadowserver to provide](https://blog.trendmicro.com/securing-the-connected-world-with-support-for-the-shadowserver-foundation/)\nfunding for their cause over the next three years. Given this partnership and the work that\nCisco Talos, the FBI, and the US Department of Justice (with the support of Shadowserver)\n[had already done in the past to sinkhole VPNFilter’s second domain (toknowall[.]com), we](https://www.shadowserver.org/news/vpnfilter-fbi-sinkholing/)\nwanted to work with Shadowserver to collect data from any available stats that they might\nhave, such as how many infections are still out there. We also wanted to suggest ways to\nclean up any leftover VPNFilter infections. This is of particular importance, as cleaning these\ndevices is far from trivial for end users. This is precisely the reason that it was so important\nfor these organizations to carry out the sinkhole in the first place.\n\nFirst, we needed to get a better understanding of the malware, find out how it worked, and\nfrom there determine if anything else could be added to the takedown processes that were\nalready being done.\n\nFigure 2. The number of requests since the sinkhole of toknowall[.]com started, as provided\nby Shadowserver\nAs shown in the image above, when Shadowserver started the sinkhole, they saw an initial\nspike of over 14,000 networks infected in the first two months; over time, that has been\nreduced to 5,447. This shows that even after over two years, there is still a sizeable number\nof infections left. Most notably, at this rate, the infections will likely still be around for years to\n\n\n-----\n\ncome, until perhaps these devices are physically swapped out — a common trend in IoT\nbotnets. Not only does this tie to our main point that IoT botnets are to some degree nearly\n“uncleanable,” it also makes VPNFilter a botnet that is ripe for taking over by another threat\nactor for them to utilize, as we will explain later on.\n\nFigure 3. Breakdown of the remaining infections by country\nTechnical details\n\nAs stated in the original publication by Cisco Talos, the first stage seeks to download the\nsecond-stage malware from an IP address received using the following scheme:\n\n1. Get the second-stage malware from an image file uploaded to Photobucket[.]com.\n2. If the above fails, it tries to download the image from the domain toknowall[.]com.\n3. If both fail, it starts listening to all TCP packets on the affected device to receive the IP\n\naddress from a specific TCP packet sent by the attacker.\n\nThis logic is presented in Figure 4.\n\n\n-----\n\nFigure 4. The order of VPNFilter’s first stage to get the second stage server\nWe wanted to verify the effectivity of the solutions against the first and second phases of the\nfirst stage. Mainly, this means that to see the effectivity of the sinkhole, it is necessary to\ncheck for victims that are still infected. In case there are still infected victims, it is necessary\nto try to think of a solution to permanently clean up these devices.\n\nOne key thing that we discovered from the outset was that even though the first phase (the\nimage in Photobucket) was already taken down and the second phase (alternative domain)\nsinkholed, unless the malware receives a valid Image file from the sinkhole, it would still\nenter its third phase where attackers could potentially regain control. Ironically, while this\nmight seem like bad news, this showed us an opening for a solution, as we will discuss later\non. Here we detail our findings on the first and second phases for this initial stage.\n\n**Photobucket[.]com C&C**\n\nAll the URLs pointing to Photobucket[.]com were already taken down, which means that the\npictures hosted there were also removed. Therefore, the only two possible options for\ncurrently infected devices would be to reach out to toknowall[.]com or to start listening to\nTCP packets while expecting a specially crafted packet containing the IP address of the\n\n\n-----\n\nsecond stage server. For our next step, we verified how many real victim devices were left\ncommunicating with the sinkhole and how many of these had already moved to listening\nmode.\n\n**toknowall[.]com C&C**\n\nWe then verified if it would be possible to inject our own image with a C&C IP address\ncontrolled by us, to see how many hosts would respond. For this, we had to dig deeper in the\nmalware logic to extract the C&C IP address from the image downloaded from either\nPhotobucket[.]com or toknowall[.]com. The algorithm calculates each of the four octets of an\nIPv4 address out of the GPS information contained in the Exif header of the downloaded\nimage file. The two values used are GPSLatitude and GPSLongitude. Each of these consists\nof three values (degrees, minutes, and seconds) stored as rationals (64-bit numbers split into\ntwo 32-bit integers). The first 32-bit number is called a numerator and the second is called a\ndenominator. The theory behind this is better explained Soufiane Tahiri’s book, “Mastering\nMobile Forensics.” In the case of VPNFilter, these coordinates are used like this:\n\nFigure 5. How the IPv4 address of the second stage C&C is formed based on the GPS\ncoordinates of an image file\nAs can be seen from Figure 5, the denominator part of all coordinates is ignored by the\nmalware. The numerator, however, is used to generate the values of all octets.\n\nWe wrote a program to replace these bytes in the image that we created. The code that does\nthe job can be seen in Figure 6.\n\n\n-----\n\nFigure 6. The source code for our program to write at a specific position of an image file\nIn the preceding code, the first coordinate is located at position 4500 (decimal) in the image.\nWe could have parsed the whole Exif header, but we needed something quicker. Also, in\nlines 48 and 51, we set the numerator part of the degree value for both latitude and longitude\nto zero so that we could leverage the negative integer values in C to write the exact bytes\nthat we needed.\n\n\n-----\n\nBy using our program, we were able to inject an IP address that points back to the sinkhole\nowned by Shadowserver to see how many infected devices are still actively looking for a\nsecond stage download server and more importantly, to prevent the still-infected networks\nfrom moving to stage one’s third phase (listening to all TCP packets) in the future.\n\nFigure 7. The image\n\ndeveloped containing the C&C that we controlled.\nFigure 7 shows the resulting image that we used. This image was then supplied to\nShadowserver who are in the process of deploying it. While this is being done, we went to\nlook for victims in a specific stage of the infection.\n\n**Listening mode**\n\nIf the malware does not get a valid image from previous stages, it will then enter into listening\nmode. This allows the attackers to regain control over infected victims if the sinkholed\nalternative domain does not serve a valid image.\n\nFigure 8 shows the source code that makes this third option possible.\n\n\n-----\n\nFigure 8. VPNFilter’s listener from the first stage of the malware\nThe above code lets the malware listen to all packets and expects one TCP packet with the\nSYN flag that is at least 8-bytes long. The magic sequence expected is a hexadecimal 0C 15\n22 2b.\n\nFigure 9. A magic byte sequence in hexadecimal.\nAfter verifying the logic, our next step was to generate the packet. The easiest way that we\ncould think of doing this was to use hping3 since this tool is capable of sending any type of\nnetwork packet. We used the code seen in Figure 10.\n\n\n-----\n\nFigure 10. A Bash script that sends a specially crafted packet to a host\nWe then asked Shadowserver to scan the infected devices that they have logged throughout\nthe years to see how many would respond. Here are the results for the unique 5,447 devices\nthat were found still connecting to the sinkhole on a single day. It is important to remember\nthat because these are routers and other similar types of devices, this number also\nrepresents thousands of infected networks, not simply individual machines. This means that\nthe reach and visibility for attackers with a botnet like this can be substantial. Also, the\nnumber of infected hosts might be higher than what Shadowserver sees on their sinkhole, as\nthe domain toknowall[.]com is a well-known C&C and can be blocked at the DNS level by\nDNS providers or other security products.\n\nHere we summarize our main findings and show the geolocation data.\n\n1,801 (33.1%) networks responded to our packet sent by hping3 on TCP port 80.\n363 (6.7%) networks reached back to our sinkhole on port TCP 443.\n\nInfections seem to be led by USA, followed by Russia, according to geolocation data from\nthe hosts that reached back to our sinkholed server.\n\n\n-----\n\nFigure 11. Hosts that parsed the packet and reached out to our sinkholed C&C.\nAlthough only 363 networks connected back to our sinkhole, we cannot assume that the\n1,801 networks that gave us an initial positive response are clean. They might still be\ninfected by VPNFilter, but the connection to our sinkhole could have been blocked if they are\nbehind a firewall. These 363 networks can be taken over by anyone with an understanding of\nhow the malware works. From a technical perspective, there was nothing to prevent the\ntakeover of these devices. Additionally, at any point in time the original actors could take\ncontrol of the devices that are already infected.\n\nConclusion and recommendations\n\nEven though solutions have been deployed to lower the effectivity of VPNFilter (which has\nbeen known for over two years), for end users restarting is still not enough to protect their\ndevices from reinfection. To reiterate, this is why the initial sinkhole was so important. While\nit's not likely to have the malicious actor still on infected systems, the malware can still have\na potential negative impact. With just a bit of understanding, another malicious actor can\nhave the botnet reactivated. This is exactly why we worked with Shadowserver to upgrade\nthe second stage sinkhole with a valid image to prevent the malware from moving forward to\nits listening mode, which occurs in the third phase of the first stage.\n\n\n-----\n\nA firmware update would also remediate this problem. However, as mentioned earlier,\nfirmware updates become problematic and in most cases, are not as easy as in PC\necosystems. The major hurdles involve verifying that the firmware file is legitimate and\nunderstanding how to apply the updates to the system. This would be assuming, however,\nthat users even have access to the router to perform upgrades in the first place, as well as\nthat their device’s vendor has an upgrade available for their model. In many cases, someone\nelse was responsible for setting up the device for the user, such as the company that they\nbought it from, or their ISP. To compound all of this, getting a new router might also be\nproblematic if users don’t own the router, so they might have to wait for their ISP to provide a\nnew router.\n\nThese limitations and challenges that are faced by the users on their side bring us to where\nwe are and why the numbers of VPNFilter infections are still at the levels that are being seen\non the internet. Moving forward, the approach would be to keep the sinkhole running with the\nfixes that we have implemented. This limits the ability of this specific malware to become\nactive again. It also gives time for devices to naturally go offline with a normal life span. The\nneed for such an approach emphasizes the importance for the existence and operations of\norganizations like Shadowserver, as they serve as custodians of the internet. This is\nprecisely why Trend Micro made the commitment earlier this year to support Shadowserver.\n\nOrdinary end users can also do their part in making sure that the IoT remains safe from the\nhands of cybercriminals thereby preventing the success of their future campaigns. One of the\nbest ways to minimize potential infection from IoT-malware is to limit the number of\nexposures one has to the internet. This means, in most cases, disabling any remote\nmanagement options in the configuration. Also, disabling Universal Plug-and-Play (UPnP) if\nthe option is available, as this setting might expose services to the internet without the\nawareness of their users. Updating devices as regularly as needed to the latest firmware\nalso provides the latest security features and bug fixes that might be used in attacks against\nsystems.\n\n[Applying general security practices can also minimize the chances of IoT-malware infecting](https://www.trendmicro.com/vinfo/tmr/?/us/security/news/internet-of-things/the-first-steps-in-effective-iot-device-security)\nrouters and other devices. At present, given the prolonged work-from-home (WFH) setups,\n[users should reexamine their current security measures as home devices and systems now](https://www.trendmicro.com/vinfo/tmr/?/us/security/news/cybercrime-and-digital-threats/working-from-home-here-s-what-you-need-for-a-secure-setup)\nhave a heavier influence on corporate networks.\n\nIn our paper “Worm War: The Botnet Battle for IoT Territory,” we show how these devices are\nboth actively attacked and are relatively simple to compromise. We would now like to extend\nour messaging to say that these router infections are never cleaned and can be active even\nyears after a botnet has supposedly been offline. Although we have used VPNFilter to\nelaborate, it’s important to emphasize that this is true of any other IoT botnet. Indeed, this will\nkeep happening unless users take care of their router frequently and router manufacturers\nstart adding auto-update features to their devices’ operating systems. In the meantime, the\nsecurity industry faces an uphill battle against infections that cease to be a threat only when\nthe router is finally replaced\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-19 - VPNFilter Two Years Later- Routers Still Compromised.pdf"
    ],
    "report_names": [
        "2021-01-19 - VPNFilter Two Years Later- Routers Still Compromised.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535857,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653705489,
    "ts_modification_date": 1653705489,
    "files": {
        "pdf": "https://archive.orkl.eu/0dccf48b400e9f5bf65d3ccbe810fef5e214e4b9.pdf",
        "text": "https://archive.orkl.eu/0dccf48b400e9f5bf65d3ccbe810fef5e214e4b9.txt",
        "img": "https://archive.orkl.eu/0dccf48b400e9f5bf65d3ccbe810fef5e214e4b9.jpg"
    }
}