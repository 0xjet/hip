{
    "id": "f11c3e21-4c12-4d42-97c1-eb0e71aa3d6c",
    "created_at": "2023-01-12T15:06:55.241737Z",
    "updated_at": "2025-03-27T02:08:00.164667Z",
    "deleted_at": null,
    "sha1_hash": "4d54ce0824b0f7a9a4fce3985dedcdbed254fe04",
    "title": "2020-03-31 - LokiBot- Getting Equation Editor Shellcode",
    "authors": "",
    "file_creation_date": "2022-05-28T03:31:46Z",
    "file_modification_date": "2022-05-28T03:31:46Z",
    "file_size": 202956,
    "plain_text": "# LokiBot: Getting Equation Editor Shellcode\n\n**[clickallthethings.wordpress.com/2020/03/31/lokibot-getting-equation-editor-shellcode/](https://clickallthethings.wordpress.com/2020/03/31/lokibot-getting-equation-editor-shellcode/)**\n\nView all posts by Jamie March 31, 2020\n\n[While today’s analysis will be similar to one we’ve done before, it will be almost exactly the](https://clickallthethings.wordpress.com/2020/02/27/crimson-rat-02-24-2020-velvetsweatshop-and-shellcode/)\n[same as this one from SANS. Although it’s been done by others, it never hurts to practice](https://isc.sans.edu/forums/diary/VelvetSweatshop+Maldocs+Shellcode+Analysis/24776/)\nusing these tools and get that muscle memory down. We’ll be working off of this document\n[right here: https://app.any.run/tasks/db864efd-35b3-4e91-9e84-c6149dbfd4d7.](https://app.any.run/tasks/db864efd-35b3-4e91-9e84-c6149dbfd4d7)\n\n## OLEDUMP\n\nUsing [oledump, we see a big chunk of data called ‘EncryptedPackage’.](https://blog.didierstevens.com/programs/oledump-py/)\n\nIn this case, it means that one or more sheets in the workbook have been locked to protect\nchanges to the data.\n\n[But there are tools to get around this. By simply pointing msoffcrypto-crack.py at the](https://blog.didierstevens.com/2018/12/31/new-tool-msoffcrypto-crack-py/)\ndocument, we will see a familiar password pop up.\n\nAt this point, we could do one of two things. We could use msoffcrypto-crack.py to crack the\npassword and output a new unprotected file of the same name…\n\n\n-----\n\n… or we could just pipe the output directly into oledump.py. Doing so, we see that there are\nno macros or anything like that. Instead, we see ‘eQUaTiON naTIvE’.\n\nLet’s dump that part of the object to another file where we can work on that.\n\n[We can use XORSearch.exe to search that binary file for various signatures of 32-bit](https://blog.didierstevens.com/programs/xorsearch/)\nshellcode. We see that GetEIP was found in two locations.\n\n## scDbg.exe\n\n[We then move to a shellcode emulator called scDbg.exe. We can load the dumped binary in](http://sandsprite.com/blogs/index.php?uid=7&pid=152)\nthere and feed it the offset position and to see if any sort of decoded shellcode appears.\n\n\n-----\n\nAnd it does! Note that it dumped it to a file called oledump.unpack. However, notice how the\nunpacked information isn’t very informative. But that last line says, “Change found at\n[402438…”. We can use another tool called to cut-bytes.py to look at the oledump.unpack](https://blog.didierstevens.com/2015/10/14/cut-bytes-py/)\nfrom that point. Notice strings such as LoadLibraryW… ExpandEnvironmentStringsW…\nAPPDATA\\vbc.exe… htp://frndgreen and so on.\n\n\n-----\n\nBut can we get this output in a little more… readable form? Yes, we can do with scDbg.exe\nagain. First, let’s cut out only the bytes necessary.\n\nUsing oledump-cut.unpack, we do run into a problem when we toss it into scDbg.exe. We\ndon’t see anything beyond ExpandEnvironmentStringsW.\n\nThe **[SANS blog post referenced at the beginning shows how to deal with this. It turns out](https://isc.sans.edu/forums/diary/VelvetSweatshop+Maldocs+Shellcode+Analysis/24776/)**\nthat scDbg.exe does not hook ExpandEnvironmentStringsW. But it does hook\nExpandEnvironmentStringsA. We can then try patching the .unpack file by overwriting the\nStringsW with StringsA. Save your change and then toss it back into scDbg.exe like we tried\nabove.\n\n\n-----\n\nAnother option is to overwrite that character directly from the command line. Looking at the\nhex editor above, we can see that we are at offset 0x77. We can add that to the starting point\nin scDbg.exe like so:\n\nWe can now see everything in a much clearer format and it looks like it’s downloading\nLokibot.\n\nThanks for reading!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-31 - LokiBot- Getting Equation Editor Shellcode.pdf"
    ],
    "report_names": [
        "2020-03-31 - LokiBot- Getting Equation Editor Shellcode.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536015,
    "ts_updated_at": 1743041280,
    "ts_creation_date": 1653708706,
    "ts_modification_date": 1653708706,
    "files": {
        "pdf": "https://archive.orkl.eu/4d54ce0824b0f7a9a4fce3985dedcdbed254fe04.pdf",
        "text": "https://archive.orkl.eu/4d54ce0824b0f7a9a4fce3985dedcdbed254fe04.txt",
        "img": "https://archive.orkl.eu/4d54ce0824b0f7a9a4fce3985dedcdbed254fe04.jpg"
    }
}