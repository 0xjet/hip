{
    "id": "159c0f1e-a2bf-407c-b10e-38bd2ea81185",
    "created_at": "2023-01-12T15:08:14.999989Z",
    "updated_at": "2025-03-27T02:11:47.812422Z",
    "deleted_at": null,
    "sha1_hash": "39b0dfb7acd227f5b3355645c236d91bed5d1d54",
    "title": "2017-10-24 - Threat Spotlight- Follow the Bad Rabbit",
    "authors": "",
    "file_creation_date": "2022-05-27T21:31:34Z",
    "file_modification_date": "2022-05-27T21:31:34Z",
    "file_size": 882405,
    "plain_text": "# Threat Spotlight: Follow the Bad Rabbit\n\n**blog.talosintelligence.com/2017/10/bad-rabbit.html**\n\n**_Note: This blog post discusses active research by Talos into a new threat. This_**\n**_information should be considered preliminary and will be updated as research_**\n**_continues._**\n\n**_Update 2017-10-26 16:10 EDT: added additional information regarding the links between_**\n_Nyetya and BadRabbit_\n\n**_Update 2017-10-26 09:20 EDT: added additional information regarding the EternalRomance_**\n_exploit_\n\n**_Update 2017-10-25: added additional information regarding encryption and propagation_**\n_methods_\n\n\n-----\n\nOn October 24, 2017, Cisco Talos was alerted to a widescale ransomware campaign\naffecting organizations across eastern Europe and Russia. As was the case in previous\nsituations, we quickly mobilized to assess the situation and ensure that customers remain\nprotected from this and other threats as they emerge across the threat landscape.\n\nThere have been several large scale ransomware campaigns over the last several months.\nThis appears to have some similarities to Nyetya in that it is also based on Petya\nransomware. Major portions of the code appear to have been rewritten. The distribution does\nnot appear to have the sophistication of the supply chain attacks we have seen recently.\n\n## Distribution\n\nTalos assesses with high confidence that a fake Flash Player update is being delivered via a\ndrive-by-download and compromising systems. The sites that were seen redirecting to\nBadRabbit were a variety of sites that are based in Russia, Bulgaria, and Turkey.\n\nWhen users visited one of the compromised websites, they were redirected to\n1dnscontrol[.]com, the site which was hosting the malicious file. Before the actual malicious\nfile was downloaded a POST request was observed to a static IP address (185.149.120[.]3).\nThis request was found to be posting to a static path of \"/scholasgoogle\" and provided the\nuser agent, referring site, cookie, and domain name of the session. After the POST the\ndropper was downloaded from two different paths from 1dnscontrol[.]com, /index.php and\n/flash_install.php. Despite two paths being utilized only a single file was downloaded. Based\n\n\n-----\n\non current information, the malware appears to have been active for approximately six hours\nbefore the server 1dnscontrol[.]com was taken down. The initial download was observed\naround 2017-10-24 08:22 UTC.\n\nThe dropper (630325cac09ac3fab908f903e3b00d0dadd5fdaa0875ed8496fcbb97a558d0da)\nrequires a user to facilitate the infection and does not use any exploit to compromise the\nsystem directly. This dropper contains the BadRabbit ransomware. Once installed there is an\nSMB component used for lateral movement and further infection. This appears to use a\ncombination of an included list of weak credentials and a version of mimikatz similar to that\nwhich was used in Nyetya. Below is a list of the username/password combinations that we\n[have observed. Note there is overlap with the 1995 cult classic \"Hackers\".](https://www.imdb.com/title/tt0113243/quotes/qt0448608)\n\n\n-----\n\nObserved Password List\n\nDespite initial reports, we currently have no evidence that the EternalBlue exploit is being\nleveraged. However, we identified the usage of the EternalRomance exploit to propagate in\nthe network. This exploit takes advantage of a vulnerability described in the Microsoft MS17010 security bulletin. The vulnerability was also exploited during the Nyetya campaign. Our\nresearch continues and we will update as we learn more.\n\n## Technical Details\n\nThe malware contains a dropper which is responsible for extracting and executing the worm\npayload. This payload contains additional binaries stored in the resources (compressed with\nzlib):\n\nlegitimate binaries associated with DiskCryptor (2 drivers x86/x64 and 1 client);\n\n2 mimikatz-like binaries (x86/x64) similar to the sample seen during Nyetya. A popular\nopen source tool used for recovery of user credentials from computer memory using\nseveral different techniques.\n\nIt drops files into the C:\\Windows\\ directory. The mimikatz-like binaries are executed using\nthe same technique that was leveraged in the Nyetya campaign. The communication\n\n\n-----\n\nbetween the payload and the stealer will be performed by a named pipe, for example:\n```\nC:\\WINDOWS\\561D.tmp \\\\.\\pipe\\{C1F0BF2D-8C17-4550-AF5A-65A22C61739C}\n\n```\nThe malware then uses RunDLL32.exe to execute the malware and continue the malicious\noperations. The malware then creates a scheduled task with the parameters shown in the\nscreenshot below:\n\nEncryption is performed with 2 techniques:\n\nFull disk encryption with DiskCryptor (an open source disk encryption solution)\nIndividual file encryption\n\nHere is the list of the targeted extensions: .3ds .7z .accdb .ai .asm .asp .aspx .avhd .back\n.bak .bmp .brw .c .cab .cc .cer .cfg .conf .cpp .crt .cs .ctl .cxx .dbf .der .dib .disk .djvu .doc\n.docx .dwg .eml .fdb .gz .h .hdd .hpp .hxx .iso .java .jfif .jpe .jpeg .jpg .js .kdbx .key .mail .mdb\n.msg .nrg .odc .odf .odg .odi .odm .odp .ods .odt .ora .ost .ova .ovf .p12 .p7b .p7c .pdf .pem\n.pfx .php .pmf .png .ppt .pptx .ps1 .pst .pvi .py .pyc .pyw .qcow .qcow2 .rar .rb .rtf .scm .sln\n.sql .tar .tib .tif .tiff .vb .vbox .vbs .vcb .vdi .vfd .vhd .vhdx .vmc .vmdk .vmsd .vmtm .vmx .vsdx\n.vsv .work .xls .xlsx .xml .xvd .zip\n\nIn addition to the aforementioned scheduled task, the malware creates a second scheduled\ntask that is responsible for rebooting the system. This second task does not occur\ninstantaneously but is scheduled to occur later.\n\n\n-----\n\nIf the names for these scheduled tasks look familiar they appear to be a reference to Game\nof Thrones, specifically they match the names of the dragons.\n\nThen the malware propagates itself in the network, the technique to enumerate the network\nsystems is exactly the same than Nyetya. It is performed by Microsoft Windows legitimate\nfeatures, via:\n\nSVCCTL: the remote service management\nSMB2\nSMB\nNTLMSSP authentication brute force\nWMI\n\nAnd an exploit:\n\nEternalRomance\n\nThe malware also creates a file on the infected user's desktop called DECRYPT. Executing\nthis file causes the following ransom note to be displayed to victims.\n\nTo demonstrate how quickly these sorts of threats can propagate globally, the below graphic\nreflects the DNS related activity associated with one of the domains that were being used to\ndistribute the fake Adobe Flash update that was used to drop the malware on victims'\nsystems.\n\n\n-----\n\nThe malware modifies the Master Boot Record (MBR) of the infected system's hard drive to\nredirect the boot process into the malware authors code for the purposes of displaying a\nransom note. The ransom note that is displayed following the system reboot is below, and is\nvery similar to the ransom notes displayed by other ransomware variants, namely Petya, that\nwe have observed in other notable attacks this year.\n\nThis is the payment page from the Tor site:\n\n\n-----\n\n## EternalRomance Exploit\n\nCisco Talos has identified an exploit in the BadRabbit sample. It is very similar to the publicly\navailable Python implementation of the EternalRomance exploit that is also exploited by\nNyetya. However, the BadRabbit exploit implementation is different than the one in Nyetya,\nalthough it is still largely based on the EternalRomance exploit published in the\nShadowBrokers leak.\n\nThe following screenshot shows that BadRabbit is building modified security context\nstructures for various operating system versions:\n\n\n-----\n\nThe structures are obfuscated using an NOT operation. For example, here is the original\nvalue of WIN7_32_SESSION_INFO in the sample:\n```\n\"\\xD5\\xFD\\xE3\\xFF\\xFE\\xFF\\xFF\\xFF\\xFF\\xFF\\xFF\\xFF\\xFF\\xFF\\xFF\\xFF\\xFD\\xFF\\xFF\\xFF\\xFF\\\n\n```\nOnce decoded, the value of the buffer is:\n```\n“2a\\x02\\x1c\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x00\\x0\n\n```\nAfter updating the endian byte order and formatting to match a field in the\nWIN7_32_SESSION_INFO structure, the value is\n```\n0x001C022A, 0x00000001, 0x00000000, 0x00000000, 0x00000002, 0x00000000, 0x00000001\n\n```\nThe extracted value matches the FAKE_SECCTX data in the publicly available\nEternalRomance exploit mentioned earlier:\n\n\n-----\n\nThe sample then parses an SMB response containing the kernel leak of the Frag pool\nstructure:\n\n\n-----\n\nOnce again, the BadRabbit code matches the leak_frag_size() function in the public exploit.\n\n\n-----\n\nThe sample also checks the NT status code on an NT_Trans request after attempting to\nmodify the data in another Transaction structure:\n\nThe same action is performed in the public exploit:\n\nAfter the NT Trans check, the sample sends multiple NT_TRANSACT_SECONDARY\ncommands using different MultiplexID values.\n\n\n-----\n\nThe equivalent is also performed by the public exploit Python script implementation in the\nfunction write_data(). Finally, we can confirm the findings of the static analysis by looking at\nthe traffic generated by a pcap capture.\n\n\n-----\n\nThe sample first gets a FileID of 0x4000 and then the same value is used as a MultiplexID in\nan NT_Trans request:\n\nOnce again, this demonstrates a type confusion attempt similar to the one attempted by the\nEternalRomance exploit (the “Matched Pairs” technique). It matches the following Python\ncode:\n\n\n-----\n\nWith all this in mind, we can be fairly confident that BadRabbit includes an EternalRomance\nimplementation used to overwrite a kernel’s session security context to enable it to launch\nremote services, while in Nyetya it was used to install the DoublePulsar backdoor. Both\nactions are possible due to the fact that EternalRomance allows the attacker to read/write\narbitrary data into the kernel memory space.\n\n## Links Between Nyetya and BadRabbit\n\nWe assess with high confidence:\n\nthat BadRabbit is built on the same core codebase as Nyetya.\nthat the build tool chain for BadRabbit is highly similar to the build tool chain for Nyetya.\n\nThe evasion techniques present in the modifications to the DoublePulsar backdoor in Nyetya\nand EternalRomance in BadRabbit demonstrate similar, advanced, levels of understanding\nof the exploits involved, the network detections in place at the time of deployment, and\ngeneral Windows kernel exploitation.\n\nThe shared codebase was modified for the BadRabbit build. Instead of leveraging PSEXEC,\nthe remote file placement and remote Windows Service management was directly\nimplemented. A second export was added to the dll that allows the remote execution to\nrestart itself in a new rundll32 process, possibly to avoid having the parent process be clearly\nstarted as a service. The SMB implementation that Nyetya contained for leveraging SMB\nexploits has been replaced with an entirely different SMB implementation as well as a\ndifferent exploitation technique. The post-reboot drive encryption with Petya has been\nreplaced with drive encryption with the open source DiskCryptor.\n\nUnmodified functionality from Nyetya includes the self-relocation of the malicious dll, process\nand thread token manipulations, network peer identification, and thread-safe collections for\nmanaging credentials and target information. Lightly modified functionality which\ndemonstrates source level modifications are found in the flow of the malicious entrypoint, the\ninteraction with the embedded and modified mimikatz, and in aspects of the system\ninitialization and bitflag based feature control.\n\nWhile these links are not absolute proof, based on these findings Talos assesses with low\nconfidence that the authors of Nyetya and BadRabbit are the same.\n\n## Conclusion\n\nThis is yet another example of how effective ransomware can be delivered leveraging\nsecondary propagation methods such as SMB to proliferate. In this example the initial vector\nwasn't a sophisticated supply chain attack. Instead it was a basic drive-by-download\n\n\n-----\n\nleveraging compromised websites. This is quickly becoming the new normal for the threat\nlandscape. Threats spreading quickly, for a short window, to inflict maximum damage.\nRansomware is the threat of choice for both its monetary gain as well as destructive nature.\nAs long as there is money to be made or destruction to be had these threats are going to\ncontinue.\n\nThis threat also amplifies another key area that needs to be addressed, user education. In\nthis attack the user needs to facilitate the initial infection. If a user doesn't help the process\nalong by installing the flash update it would be benign and not wreak the devastation it has\nacross the region. Once a user facilitates the initial infection the malware leverages existing\nmethods, such as SMB, to propagate around the network without user interaction.\n\n## Coverage\n\n[Advanced Malware Protection (AMP) is ideally suited to prevent the execution of the](https://www.cisco.com/c/en/us/products/security/advanced-malware-protection)\nmalware used by these threat actors.\n\n[CWS or](https://www.cisco.com/c/en/us/products/security/cloud-web-security/index.html) [WSA web scanning prevents access to malicious websites and detects malware](https://www.cisco.com/c/en/us/products/security/web-security-appliance/index.html)\nused in these attacks.\n\n[Network Security appliances such as NGFW,](https://www.cisco.com/c/en/us/products/security/firewalls/index.html) [NGIPS, and](https://www.cisco.com/c/en/us/products/security/intrusion-prevention-system-ips/index.html) [Meraki MX can detect malicious](https://meraki.cisco.com/products/appliances)\nactivity associated with this threat.\n\n[AMP Threat Grid helps identify malicious binaries and build protection into all Cisco Security](https://www.cisco.com/c/en/us/solutions/enterprise-networks/amp-threat-grid/index.html)\nproducts.\n\n[Umbrella, our secure internet gateway (SIG), blocks users from connecting to malicious](https://umbrella.cisco.com/)\ndomains, IPs, and URLs, whether users are on or off the corporate network.\n\n\n-----\n\nEmail has not been identified as an attack vector at this time. The malware, if transferred\nacross these systems on your networks, will be blocked.\n\n## Indicators of Compromise\n\n### Hashes (SHA256)\n\nDropper:\n\n630325cac09ac3fab908f903e3b00d0dadd5fdaa0875ed8496fcbb97a558d0da\n\nPayload:\n\n8ebc97e05c8e1073bda2efb6f4d00ad7e789260afa2c276f0c72740b838a0a93\nC:\\Windows\\dispci.exe (diskcryptor client)\n682ADCB55FE4649F7B22505A54A9DBC454B4090FC2BB84AF7DB5B0908F3B7806\nC:\\Windows\\cscc.dat (x32 diskcryptor drv)\n0b2f863f4119dc88a22cc97c0a136c88a0127cb026751303b045f7322a8972f6\nC:\\Windows\\cscc.dat (x64 diskcryptor drv)\n579FD8A0385482FB4C789561A30B09F25671E86422F40EF5CCA2036B28F99648\nC:\\Windows\\infpub.dat\n2f8c54f9fa8e47596a3beff0031f85360e56840c77f71c6a573ace6f46412035 (mimikatzlike x86)\n301b905eb98d8d6bb559c04bbda26628a942b2c4107c07a02e8f753bdcfe347c\n(mimikatz-like x64)\n\n### Scheduled Tasks names\n\nviserion_\nrhaegal\ndrogon\n\n### Domains\n\nDistribution domain:\n\n1dnscontrol[.]com\n\nDistribution Paths:\n\n/flash_install.php\n/index.php\n\nIntermediary Server:\n\n\n-----\n\n185.149.120[.]3\n\nReferrer Sites:\n\nArgumentiru[.]com\nFontanka[.]ru\nAdblibri[.]ro\nSpbvoditel[.]ru\nGrupovo[.]bg\nwww.sinematurk[.]com\n\nHidden service:\n\ncaforssztxqzf2nm[.]onion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-10-24 - Threat Spotlight- Follow the Bad Rabbit.pdf"
    ],
    "report_names": [
        "2017-10-24 - Threat Spotlight- Follow the Bad Rabbit.pdf"
    ],
    "threat_actors": [
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536094,
    "ts_updated_at": 1743041507,
    "ts_creation_date": 1653687094,
    "ts_modification_date": 1653687094,
    "files": {
        "pdf": "https://archive.orkl.eu/39b0dfb7acd227f5b3355645c236d91bed5d1d54.pdf",
        "text": "https://archive.orkl.eu/39b0dfb7acd227f5b3355645c236d91bed5d1d54.txt",
        "img": "https://archive.orkl.eu/39b0dfb7acd227f5b3355645c236d91bed5d1d54.jpg"
    }
}