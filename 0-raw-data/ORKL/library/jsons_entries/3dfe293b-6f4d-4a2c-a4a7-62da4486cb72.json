{
    "id": "3dfe293b-6f4d-4a2c-a4a7-62da4486cb72",
    "created_at": "2023-01-12T15:10:11.099599Z",
    "updated_at": "2025-03-27T02:05:53.720923Z",
    "deleted_at": null,
    "sha1_hash": "3d6664f8368ea465fefe9dd50ba20c1536641709",
    "title": "2022-04-06 - Cado Discovers Denonia- The First Malware Specifically Targeting Lambda",
    "authors": "",
    "file_creation_date": "2022-08-18T03:55:30Z",
    "file_modification_date": "2022-08-18T03:55:30Z",
    "file_size": 1079050,
    "plain_text": "# Cado Discovers Denonia: The First Malware Specifically Targeting Lambda\n\n**[cadosecurity.com/cado-discovers-denonia-the-first-malware-specifically-targeting-lambda/](https://www.cadosecurity.com/cado-discovers-denonia-the-first-malware-specifically-targeting-lambda/)**\n\nApril 6, 2022\n\nBlog\n\nApril 6, 2022\n\n**By Matt Muir, with thanks to Chris Doman, Al Carchrie and Paul Scott.**\n\nOrganisations – both large and small – are increasingly leveraging Lambda serverless\nfunctions. From a business agility perspective, serverless has significant benefits. Lambda\nalso brings security benefits – the managed runtime environment reduces the attack surface\ncompared to a more traditional server environment. However, short runtime durations, the\nsheer volume of executions, and the dynamic and ephemeral nature of Lambda functions\ncan make it difficult to detect, investigate and respond to a potential compromise. Under the\nAWS Shared Responsibility model, AWS secures the underlying Lambda execution\nenvironment but it is up to the customer to secure functions themselves.\n\nCado Labs routinely analyses cloud environments to look for the latest threats. As part of\nongoing research, we found the first publicly-known case of malware specifically designed to\nexecute in an AWS Lambda environment We named this malware Denonia after the name\n\n\n-----\n\nthe attackers gave the domain it communicates with. The malware uses newer address\nresolution techniques for command and control traffic to evade typical detection measures\nand virtual network access controls. Although this first sample is fairly innocuous in that it\nonly runs crypto-mining software, it demonstrates how attackers are using advanced cloudspecific knowledge to exploit complex cloud infrastructure, and is indicative of potential\nfuture, more nefarious attacks. From the telemetry we have seen, the distribution of Denonia\nso far has been limited.\n\n**Technical Analysis**\n\nWe initially came across a sample of Denonia with the following SHA-256 hash:\n\n[a31ae5b7968056d8d99b1b720a66a9a1aeee3637b97050d95d96ef3a265cbbca](https://www.virustotal.com/gui/file/a31ae5b7968056d8d99b1b720a66a9a1aeee3637b97050d95d96ef3a265cbbca)\n\n[Whilst it has the filename “python” – the malware is actually written in Go and seems to](https://go.dev/)\ncontain a customised variant of the XMRig mining software, along with other unknown\nfunctions. We decided to investigate further.\n\nDuring dynamic analysis, the malware quickly halted execution and logged the following\nerror:\n\nThis piqued our interest as these environment variables are specific to Lambda, giving us\nsome hints about the environment in which this malware is expected to execute. Reviewing\nthe binary further, we could see that it was a 64-bit ELF executable targeting the x86-64\n[architecture and that it uses a number of third-party libraries, including one specifically to](https://github.com/aws/aws-lambda-go)\nenable execution inside AWS Lambda environments.\n\n**A Note on Go Malware**\n\n[Malware written in Google’s Go programming language has become increasingly prevalent](https://www.zdnet.com/article/go-malware-is-now-common-having-been-adopted-by-both-apts-and-e-crime-groups/)\nin recent years. The language is attractive to malware developers for a number of reasons,\nincluding the ease in which it can produce cross-compatible executables and the efficient\ndeployment that statically-linked binaries bring. However, these characteristics of the\nlanguage can pose some challenges to malware researchers analysing binaries compiled\nfrom Go.\n\nFirstly, statically-linked binaries are typically much larger than dynamically-linked equivalents\n– this makes static analysis slightly more laborious. Go also handles strings in an unusual\nway. Strings are not null-terminated, as they are in C-like languages, instead they are stored\n\n\n-----\n\nin a large blob and a struct which includes both a pointer to the string in the blob and an\ninteger defining its length is created upon declaration. This can confuse some static analysis\ntools.\n\n**Analysing Lambda Malware**\n\nAnalysing a binary designed to run in AWS Lambda poses some interesting challenges.\n\nWhilst Denonia is clearly designed to execute inside of Lambda environments – we haven’t\nyet identified how it is deployed. It may simply be a matter of compromising AWS Access and\nSecret Keys then manually deploying into compromised Lambda environments, as we’ve\nseen before with more simple Python scripts.\n\nUsing the [redress tool we identified some interesting third-party Go libraries that the malware](https://github.com/goretk/redress)\nembeds. This gave us some clues about its functionality:\n\n**github.com/aws/aws-lambda-go/lambda – libraries, samples and tools for writing**\nLambda functions in Go\n**github.com/aws/aws-lambda-go/lambdacontext – helpers for retrieving contextual**\ninformation from a Lambda invoke request\n**github.com/aws/aws-sdk-go/aws – general AWS SDK for Golang**\n**github.com/likexian/doh-go – DNS over HTTPS in Go, supports providers such as**\nQuad9, Cloudflare etc\n\nWe can see a snippet of the Lambda function handler below, which expects certain data to\nbe set:\n\n\n-----\n\nDespite the presence of this, we discovered during dynamic analysis that the sample will\nhappily continue execution outside a Lambda environment (i.e. on a vanilla Amazon Linux\nbox). We suspect this is likely due to Lambda “serverless” environments using Linux under\nthe hood, so the malware believed it was being run in Lambda (after we manually set the\nrequired environment variables) despite being run in our sandbox.\n\n**DNS over HTTPS**\n\nNormally when you request a domain name such as google.com, you send out an\nunencrypted DNS request to find the IP Address the domain resolves to – so your machine\ncan connect to the domain. A relatively modern replacement for traditional DNS is DNS over\nHTTPS (DoH). DoH encrypts DNS queries, and sends the requests out as regular HTTPS\ntraffic to DoH resolvers.\n\nUsing DoH is a fairly unusual choice for the Denonia authors, but provides two advantages\nhere:\n\nAWS cannot see the dns lookups for the malicious domain, reducing the likelihood of\ntriggering a detection\nSome Lambda environments may be unable to perform DNS lookups, depending on\nVPC settings.\n\nWe can see the malware sending these requests using the “doh-go” library to URLs such as:\n\n\n-----\n\nhttps://cloudflare-dns.com/dns-query?name=gw.denonia.xyz&type=A\nhttps://dns.google.com/resolve?name=gw.denonia.xyz&type=A\n\n_The HTTPS Request to the Google DoH Server_\n\nAnd the DoH server (in this case from Google) responds with the IP the domain resolves to\nin a JSON format:\n\n**Writing this to /tmp/.xmrig.json for XMRig**\n\nThe attacker controlled domain gw.denonia[.]xyz resolves to 116.203.4[.]0 – which is then\nwritten into a config file for xmrig at /tmp/.xmrig.json:\n\nNote that on AWS Lambda, the only directory that you can write to is /tmp. The binary also\nsets the HOME directory to /tmp with “HOME=/tmp”. XMRig itself is executed from memory.\n\n\n-----\n\n**Communication with the Monero server at 116.203.4[.]0**\n\nDenonia then starts XMRig from memory, and communicates with the attacker controlled\nMining pool at 116.203.4[.]0:3333:\n\nWhich replies with the status of the mining job:\n\nXMRig also writes to the console as it executes:\n\n**More Malware Samples**\n\nInterestingly – this isn’t the only sample of Denonia. Whilst the first sample we looked at\ndates from the end of February, we also found a [second sample that was uploaded to](https://www.virustotal.com/gui/file/739fe13697bc55870ceb35003c4ee01a335f9c1f6549acb6472c5c3078417eed)\nVirusTotal in January 2022:\n\n739fe13697bc55870ceb35003c4ee01a335f9c1f6549acb6472c5c3078417eed\n\nStay tuned for additional blogs on Lambda malware!\n\n**Investigating AWS Lambda Environments**\n\n\n-----\n\nThis week we added the ability to investigate and remediate both AWS ECS and AWS\nLambda environments to Cado Response. You can get a free playbook on how to investigate\nand respond to compromises in ECS here, and a [free trial of the platform itself here.](https://www.cadosecurity.com/free-investigation/)\n\n[For more on securing AWS Lambda environments, see the Whitepaper from AWS.](https://docs.aws.amazon.com/whitepapers/latest/security-overview-aws-lambda/security-overview-aws-lambda.pdf)\n\n**Indicators of Compromise**\n```\nrule lambda_malware\n\n{\n\n  meta:\n\n    description = \"Detects AWS Lambda Malware\"\n\n    author = \"[email protected]\"\n\n    license = \"Apache License 2.0\"\n\n    date = \"2022-04-03\"\n\n    hash1 = \"739fe13697bc55870ceb35003c4ee01a335f9c1f6549acb6472c5c3078417eed\"\n\n    hash2 = \"a31ae5b7968056d8d99b1b720a66a9a1aeee3637b97050d95d96ef3a265cbbca\"\n\n  strings:\n\n    $a = \"github.com/likexian/doh-go/provider/\"\n\n    $b = \"Mozilla/5.0 (compatible; Ezooms/1.0; [email protected])\"\n\n    $c = \"username:password pair for mining server\"\n\n  condition:\n\n    filesize < 30000KB and all of them\n\n}\n\n\n```\n**IOCs**\n\n**SHA256**\n\n739fe13697bc55870ceb35003c4ee01a335f9c1f6549acb6472c5c3078417eed\n\na31ae5b7968056d8d99b1b720a66a9a1aeee3637b97050d95d96ef3a265cbbca\n\n**Domains**\n\ndenonia[.]xyz\n\nctrl.denonia[.]xyz\n\ngw.denonia[.]xyz\n\n1.gw.denonia[.]xyz\n\nwww.denonia[.]xyz\n\nxyz.denonia[.]xyz\n\nmlcpugw.denonia[.]xyz\n\n\n-----\n\n**IP Addresses**\n\nAbout The Author\n\nMatt Muir\n\n\n116.203.4[.]0\n\n162.55.241[.]99\n\n148.251.77[.]55\n\n\nMatt is a security researcher with a passion for UNIX and UNIX-like operating systems. He\npreviously worked as a macOS malware analyst and his background includes experience in\nthe areas of digital forensics, DevOps, and operational cyber security. Matt enjoys technical\nwriting and has published research including pieces on TOR browser forensics, an emerging\ncloud-focused botnet, and the exploitation of the Log4Shell vulnerability.\n\n**About Cado Security**\n\nCado Security provides the cloud investigation platform that empowers security teams to\nrespond to threats at cloud speed. By automating data capture and processing across cloud\nand container environments, Cado Response effortlessly delivers forensic-level detail and\nunprecedented context to simplify cloud investigation and response. Backed by Blossom\nCapital and Ten Eleven Ventures, Cado Security has offices in the United States and United\n[Kingdom. For more information, please visit https://www.cadosecurity.com/ or follow us on](https://www.cadosecurity.com/)\nTwitter [@cadosecurity.](https://twitter.com/CadoSecurity)\n\n[Prev Post](https://www.cadosecurity.com/cado-security-extends-support-to-serverless-environments/) [Next Post](https://www.cadosecurity.com/top-9-best-practices-for-aws-ecs-security/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-06 - Cado Discovers Denonia- The First Malware Specifically Targeting Lambda.pdf"
    ],
    "report_names": [
        "2022-04-06 - Cado Discovers Denonia- The First Malware Specifically Targeting Lambda.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536211,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1660794930,
    "ts_modification_date": 1660794930,
    "files": {
        "pdf": "https://archive.orkl.eu/3d6664f8368ea465fefe9dd50ba20c1536641709.pdf",
        "text": "https://archive.orkl.eu/3d6664f8368ea465fefe9dd50ba20c1536641709.txt",
        "img": "https://archive.orkl.eu/3d6664f8368ea465fefe9dd50ba20c1536641709.jpg"
    }
}