{
    "id": "8fa60d63-9af0-404e-a568-3483f879e7df",
    "created_at": "2023-01-12T15:10:35.122638Z",
    "updated_at": "2025-03-27T02:05:47.018187Z",
    "deleted_at": null,
    "sha1_hash": "3c56ee72c72c9370f1d067728b78cdc41442ed30",
    "title": "2020-05-11 - ProLock malware analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T19:45:50Z",
    "file_modification_date": "2022-05-28T19:45:50Z",
    "file_size": 1110944,
    "plain_text": "# ProLock malware analysis\n\n**[soolidsnake.github.io/2020/05/11/Prolock_ransomware.html](https://soolidsnake.github.io/2020/05/11/Prolock_ransomware.html)**\n\nHOME May 11, 2020\n\n#### May 11, 2020\n\n## Please read the disclaimer\n\n#### Prolock caught my attention after reading the blogpost of bleepingcomputer, so I fired up my malware analysis box for some fun.\n\n Quick note: for your information, I did not analyse the crypto part of this ransomware.\n\n### Samples\n\n#### The sample can be downloaded from app.any.run.\n\n### C++ Loader\n\n#### Reading the following powershell script\n\n we can see that the shellcode starts at address 0xD7A0, using dd skip=55200\n```\nof=shellcode if=Winmgr.bmp bs=1 we can extract the shellcode and load it in memory to\n\n execute it, I wrote a simple C++ loader.\n\n```\n\n-----\n\n```\n#include <Windows.h>\n#include <stdio.h>\n#include <conio.h>\n#include <tchar.h>\n#include <psapi.h>\n#define BUF_SIZE 256\nTCHAR szName[] = TEXT(\"Global\\\\MyFileMappingObject\");\nint main()\n{\n  char filename[] = \"shellcode\";\n  HANDLE fileh = CreateFileA(filename,\nGENERIC_EXECUTE|GENERIC_READ|GENERIC_WRITE, FILE_SHARE_READ, 0, OPEN_EXISTING, 0,\n0);\n  if (fileh == NULL){\n    printf(\"CreatedFile failed\\n\");\n    return -1;\n  }\n  HANDLE hMapFile = CreateFileMapping(fileh, 0, PAGE_EXECUTE_READWRITE, 0, 0,\n0);\n  if (hMapFile == NULL){\n    printf(\"CreateFileMapping failed\\n\");\n    return -1;\n  }\n  LPVOID ptr = MapViewOfFile(\n    hMapFile,\n    FILE_MAP_READ|FILE_MAP_EXECUTE| FILE_MAP_WRITE,\n    0,\n    0,\n    0\n  );\n     if(ptr == NULL){\n    printf(\"CreateFileMapping failed\\n\");\n    return -1;\n  }\n     HMODULE hmodule = GetModuleHandleA(\"ntdll.dll\");\n     MODULEINFO info;\n     DWORD old;\n     auto status = GetModuleInformation(GetCurrentProcess(), hmodule, &info,\nsizeof(MODULEINFO));\n     if (!status)\n          printf(\"GetModuleInformation failed\\n\");\n     status = VirtualProtect(info.lpBaseOfDll, info.SizeOfImage,\nPAGE_EXECUTE_READWRITE, &old);\n     if (!status)\n          printf(\"VirtualProtect failed\\n\");\n  ((void (*)(LPVOID))ptr)(ptr);\n}\n\n```\n\n-----\n\n-----\n\n### Dynamic analyses\n\n#### The ransomware code starts with a loop that decrypts the rest of the code, we can just set a hardware breakpoint at offset 0x36 and let the loop do the job.\n\n Then with IDA we can use the key p to analyse the code starting from offset 0x6B.\n\n\n-----\n\n#### Reading the first assembly instructions we can see that the malware is parsing kernel32 to find some functions which are:\n\n LoadLibraryA GetProcAddress VirtualAlloc\n\n Then it loads libraries shell32.dll and netapi32.dll. After that, the malware populates an array of function at an address allocated earlier. from there all library functions calls will be made using the array of function, example call qword ptr [r15 +\n```\noffset_of_function] .\n\n```\n\n-----\n\n#### I wrote a simple IDA python to comment each call instruction with the name of the function that will be called:\n\n\n-----\n\n```\n  import idautils\n  import re\n  def comm():\n   start = GetFunctionAttr(get_reg_value('rip'), FUNCATTR_START) # Get the start\n  address of the current function were are single stepping\n   for ins in idautils.FuncItems(start): # Looping on the assembly line\n    if idaapi.isCode(idaapi.getFlags(ins)): \n     cmd = idc.GetDisasm(ins)\n     m = re.search(\"call.*?\\[.*?(.*)\\+(.*)h]\", cmd) # Regex to extract the\n  offset and the register pointing to the array\n     if m:\n      reg = get_reg_value(m.group(1))\n      val = int(m.group(2), 16)\n      Fname = get_name(Qword(reg + val))\n      MakeComm(ins, Fname)\n\n#### The malware will proceed on deleting the following files:\n\n```\n\n-----\n\n#### Notice the comments added to each call instruction.\n\n Two other functions at offset 0x8E4 and 0x8F1 are called.\n\n### Deleting share connections\n\n#### The role of the first one is to enumerate the shares of the local machine and delete all the connections except hidden shares.\n\n\n-----\n\n### Killing processes and services\n\n#### The second function is responsible for killing the processes that starts with the following strings:\n```\n   aagntsv, cntaos, dbeng5, dbsnmp, encsvc, excel., firefo, infopa,\n   isqlpl, mbamtr, msacce, msftes, mspub., mydesk, mysqld, ntrtsc, ocauto,\n   ocomm., ocssd., onenot, oracle, outloo, pccntm, powerp, sqbcor, sqlage,\n   sqlbro, sqlser, sqlwri, steam., syncti, tbirdc, thebat, thunde, tmlist,\n   visio., winwor, wordpa, xfssvc, zoolz\n\n command used: taskkill.exe /IM \"name_of_process\" .\n\n And stopping the following services:\n\n```\n\n-----\n\n```\nMcAfeeFramework, Alerter, AcronisAgent, Acronis VSS Provider,\nBackupExecAgentAccelerator, BackupExecDeviceMediaService,\nBackupExecJobEngine, BackupExecManagementService, BackupExecRPCService,\nBackupExecVSSProvider, DFSR, EPIntegrationService, EPProtectedService,\nEPSecurityService, EPUpdateService, MB3Service, MBAMService,\nMBEndpointAgent, MSExchangeES, MSExchangeMGMT, MSExchangeMTA,\nMSExchangeSA, MSExchangeSRS, MSExchangeADTopology, MSExchangeDelivery,\nMSExchangeDiagnostics, MSExchangeEdgeSync, MSExchangeHM,\nMSExchangeHMRecovery, MSExchangeIS, MSExchangeMailboxReplication,\nMSExchangeRPC, MSExchangeRepl, MSExchangeServiceHost,\nMSExchangeTransport, MSExchangeUM, MSExchangeUMCR, MSOLAP$*,\nMSSQLSERVER, MsDtsServer, MySQL57, OSearch15, OracleClientCache80,\nQuickBooksDB25, SPAdminV4, SPSearchHostController, SPTraceV4,\nSPUserCodeV4, SPWriterV4, SQLBrowser, SQLSafeOLRService, SQLsafe Backup\nService, SQLSERVERAGENT, SQLTELEMETRY, SQLBackups, SQLAgent$*, MSSQL$*,\nMSMQ, ReportServer, ReportServer$*, SQLWriter, SQLBackupAgent, Symantec\nSystem Recovery, SyncoveryVSSService, VeeamBackupSvc, VeeamCatalogSvc,\nVeeamCloudSvc, VeeamEndpointBackupSvc, VeeamEnterpriseManagerSvc,\nVeeamMountSvc, VeeamNFSSvc, VeeamRESTSvc, VeeamTransportSvc',0, Veeam\nBackup Catalog Data Service, epag, epredline, mozyprobackup, masvc,\nmacmnsvc, mfemms, McAfeeDLPAgentService, psqlWGE, swprv, wsbexchange,\nWinVNC4, TMBMServer, tmccsf, tmlisten, VSNAPVSS, stc_endpt_svc,\nwbengine, bbagent, NasPmService,\nBASupportExpressStandaloneService_N_Central,\nBASupportExpressSrvcUpdater_N_Central, hasplms, EqlVss, EqlReqService,\nRapidRecoveryAgent, YTBackup, vhdsvc, TeamViewer, MSOLAP$SQL_2008,\nMSOLAP$SYSTEM_BGC, MSOLAP$TPS, MSOLAP$TPSAMA, MSSQL$BKUPEXEC,\nMSSQL$ECWDB2, MSSQL$PRACTICEMGT, MSSQL$PRACTTICEBGC, MSSQL$PROD,\nMSSQL$PROFXENGAGEMENT, MSSQL$SBSMONITORING, MSSQL$SHAREPOINT,\nMSSQL$SOPHOS, MSSQL$SQL_2008, MSSQL$SQLEXPRESS, MSSQL$SYSTEM_BGC,\nMSSQL$TPS, MSSQL$TPSAMA, MSSQL$VEEAMSQL2008R2, MSSQL$VEEAMSQL2012,\nMSSQLFDLauncher, MSSQLFDLauncher$PROFXENGAGEMENT,\nMSSQLFDLauncher$SBSMONITORING, MSSQLFDLauncher$SHAREPOINT,\nMSSQLFDLauncher$SQL_2008, MSSQLFDLauncher$SYSTEM_BGC,\nMSSQLFDLauncher$TPS, MSSQLFDLauncher$TPSAMA, MSSQLSERVER,\nMSSQLServerADHelper, MSSQLServerADHelper100, MSSQLServerOLAPService,\nSQLAgent$BKUPEXEC, SQLAgent$CITRIX_METAFRAME, SQLAgent$CXDB,\nSQLAgent$ECWDB2, SQLAgent$PRACTTICEBGC, SQLAgent$PRACTTICEMGT,\nSQLAgent$PROD, SQLAgent$PROFXENGAGEMENT, SQLAgent$SBSMONITORING,\nSQLAgent$SHAREPOINT, SQLAgent$SOPHOS, SQLAgent$SQL_2008,\nSQLAgent$SQLEXPRESS, SQLAgent$SYSTEM_BGC, SQLAgent$TPS,\nSQLAgent$TPSAMA, SQLAgent$VEEAMSQL2008R2, SQLAgent$VEEAMSQL2012,\n\n```\n\n-----\n\n```\n   ReportServer$SQL_2008, ReportServer$SYSTEM_BGC, ReportServer$TPS,\n   ReportServer$TPSAMA\n\n#### Command used: net stop \"name_of_service\" /y host.exe\n\n### Deleting shadow copies\n\n#### Other commands will be executed continuously by the malware which are:\n   vssadmin.exe delete shadows /all /quiet\n   vssadmin.exe resize shadowstorage /for=C:\\ /on=C:\\ /maxsize=401MB\n   vssadmin.exe resize shadowstorage /for=C:\\ /on=C:\\ /maxsize=unbounded\n\n For the last 2 commands, the malware loops on every partition starting from C:\\ etc…\n\n### Encryption\n\n#### A first thread is tasked to run a function at offset 0x1E17, the main role of this thread is to loop through the directories recursively, in each directory a ransom note file will be created called [HOW TO RECOVER FILES].TXT .\n\n```\n\n-----\n\n#### When a file is found, a second thread is started to execute the function at offset 0x33DF.\n\n It’s main role is to encrypt files of size greater than 8kb avoiding the following file extensions:\n```\n   .exe, .dll, .lnk, .ico, .ini, .msi, .chm, .sys, .hlf, .lng, .inf,\n   .ttf, .cmd, .bat, .vhd, .bac, .bak, .wbc, .bkf, .set, .win, .dsk\n\n```\n\n-----\n\n#### Note: the malware avoid the following directories:\n```\n   $ Recycle.Bin, All Users, Boot, Common Files, DVD Maker, Internet\n   Explorer, Kaspersky Lab, Kaspersky Lab Setup Files, Microsoft,\n   Microsoft.NET, Microsoft_Corporation, Mozilla Firefox, PerfLog, System\n   Volume Information, Uninstall Information, Windows, Windows Defender,\n   Windows Mail, Windows Media Player, Windows NT, Windows Photo Viewer,\n   Windows Portable Devices, Windows Sidebar, WindowsApps,\n   WindowsPowerShell\n\n## Collected IOCs\n\n#### Hahes\n   WinMgr.bmp:\n   a6ded68af5a6e5cc8c1adee029347ec72da3b10a439d98f79f4b15801abd7af0\n\n Filenames\n   C:\\\\Programdata\\\\WinMgr.xml\n   C:\\\\Programdata\\\\WinMgr.bmp\n   C:\\\\Programdata\\\\clean.bat\n   C:\\\\Programdata\\\\run.bat\n\n Commands\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-11 - ProLock malware analysis.pdf"
    ],
    "report_names": [
        "2020-05-11 - ProLock malware analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536235,
    "ts_updated_at": 1743041147,
    "ts_creation_date": 1653767150,
    "ts_modification_date": 1653767150,
    "files": {
        "pdf": "https://archive.orkl.eu/3c56ee72c72c9370f1d067728b78cdc41442ed30.pdf",
        "text": "https://archive.orkl.eu/3c56ee72c72c9370f1d067728b78cdc41442ed30.txt",
        "img": "https://archive.orkl.eu/3c56ee72c72c9370f1d067728b78cdc41442ed30.jpg"
    }
}