{
    "id": "1b24e7d9-580a-4d17-99d3-aa6653e6625b",
    "created_at": "2023-01-12T15:07:33.664106Z",
    "updated_at": "2025-03-27T02:06:10.719407Z",
    "deleted_at": null,
    "sha1_hash": "a00661b1744a165d419a351a3b44366413b05433",
    "title": "2017-05-09 - Deep Analysis of New Emotet Variant – Part 2",
    "authors": "",
    "file_creation_date": "2022-05-29T10:40:34Z",
    "file_modification_date": "2022-05-29T10:40:34Z",
    "file_size": 1416895,
    "plain_text": "# Deep Analysis of New Emotet Variant – Part 2\n\n**[fortinet.com/blog/threat-research/deep-analysis-of-new-emotet-variant-part-2.html](https://www.fortinet.com/blog/threat-research/deep-analysis-of-new-emotet-variant-part-2.html)**\n\nThreat Research\n\nBy [Xiaopeng Zhang | May 09, 2017](https://www.fortinet.com/blog/search?author=Xiaopeng+Zhang)\n\n## Background\n\n\nMay 9, 2017\n\n\nThis is the second part of FortiGuard Labs’ deep analysis of the new Emotet variant. In the\nfirst part of the analysis we demonstrated that by bypassing the server-side Anti-Debug or\n**Anti-Analysis technique we could download three or four modules (.dll files) from the C&C**\nserver. In that first blog we only analyzed one module (I named it ‘module2’). In this blog,\nwe’ll review how the other modules work. Here we go.\n\n## Stealing email addresses from MS Outlook PST files\n\nAs I detailed in Part 1 of this blog, the first module we’re looking at here (I’ve named it\n‘module1’) is loaded in a ThreadFunction, whose main function is to go through all Outlook\naccounts by reading the PST files. A PST file is a personal folder file in Microsoft Outlook\nthat stores your email messages, calendar, tasks, and other items. PST files are usually\nlocated in the “Documents\\Outlook Files” folder on your computer. See Figure 1.\n\n\n-----\n\nFigure 1. PST files\n\nMicrosoft has provided a group of APIs called MAPI (Microsoft Outlook Messaging API),\nwhich is the messaging architecture for Microsoft Outlook. Using the MAPIs you can operate\nPST files. The MAPIs are used in the module1 file.\n\nOnce module1 file is executed it creates a temporary file that is used to store the stolen\nOutlook version information and email addresses that have been collected. Loading MAPI\nfunctions is the next step. Figure 2 shows how, along with what it loads.\n\n\n-----\n\nFigure 2. Loading MAPI functions\n\nIt then starts reading all PST files according to the Outlook accounts on the computer, going\nthrough all email messages with an unread status in every folder (Inbox, Deleted Items, Junk\nE-mail, Sent Items, etc.) under one email account. It steals the sender name and the email\naddress from each unread email. Figure 3 shows a sample unread email about a Facebook\nnotification that was sent to me.\n\nFigure 3. Sample unread email message\n\nFigure 4 shows what module1 has stolen from the unread email message shown in Figure 3.\n“Facebook” is the sender name, and “notification+kr4yxeragnmn@facebookmail.com” is the\nsender’s email address.\n\n\n-----\n\nFigure 4. The stolen email information in the memory buffer\n\nAs I mentioned before, the stolen data is saved in a temporary file. In this case, it’s\n“AE74.tmp.” It will be read when module1 prepares to encrypt and send the stolen\ninformation to its C&C server. Figure 5 shows the data before encryption, which is read from\n“AE74.tmp.”\n\nFigure 5. Data before encryption\n\nAs you can see, it contains the Outlook version and stolen email information. Once\nencrypted, the data will be sent to the C&C server through a “POST” request. Figure 6 is the\npacket screenshot from WireShark.\n\n\n-----\n\nFigure 6. Sending the encrypted data to the C&C server\n\n## Sending spam using the C&C server template\n\nThis is the largest Emotet module (I have named it ‘module4’) of the malware’s four modules.\nIts main function is to send spam to the email addresses which were stolen and sent to the\nC&C server. When it is executed in a thread it generates a GUID by calling the\nCoCreateGuid function. It then base64-encodes the GUID and sends it as a cookie to the\nC&C server. The response provides the encrypted spam message, as well as the email\naddresses that the spam will be sent to. The two figures below show the packet from the\nC&C server, as well as the content after decryption.\n\n\n-----\n\nFigure 7. Sent GUID and response from the C&C server\n\nFigure 8. Decrypted spam template and email addresses\n\n\n-----\n\nOnce module4 receives the decrypted data, it reads out the spam template and the email\naddresses the spam message is being sent to. In module4, it supports SMTP protocol over\nboth port 25 (regular) and port 587 (SSL). The figures below show how it uses the SMTP\nprotocol to spread this spam, and what the spam looks like in an email client.\n\nFigure 9. Related code and data generating SMTP packets\n\n\n-----\n\nFigure 10. Spam shown in Wireshark\n\nFigure 11. Spam shown in email client\n\nAs you can see in Figure 11, the spam attempts to trick the email recipients into opening a\nURL, that points to a malicious Word file. Figure 12 shows its Antivirus detection rating on\nVirusTotal.\n\n\n-----\n\nFigure 12. Antivirus detection rate on VirusTotal\n\n## Conclusion\n\nFrom this deep analysis of the new Emotet variant we can see that it focuses on stealing\nemail-related data from a victim’s device, and then uses that device and the email addresses\nit has collected from it to send spam that can spread other malware.\n\nNOTE: at the end of my analysis, I noticed that the Anti-Debug technique on the server side\nsometimes worked, and sometimes didn’t.\n\nThe URL attached to the spam generated by this malware has been detected as Malicious\n**Websites by the FortiGuard Webfilter service, and the downloaded Word file has been**\ndetected as WM/Agent.DEA!tr.dldr by the FortiGuard Antivirus service.\n\n## Summary of the four Received Modules\n\nModule1 (size 1c000H): steals email addresses and the recipients’ names from Outlook PST\nfiles.\n\n\n-----\n\nModule2 (size 32000h): steals credentials from installed Office Outlook, IncrediMail, Group\nMail, MSN Messenger, Mozilla ThunderBird, etc. The analysis of this module was provided in\nthe first blog.\n\nModule3 (size 70000h): steals saved information in browsers. Since it’s simple, I chose to not\nprovide any analysis.\n\nModule4 (size 0F0000h): sends spams to spread other malware.\n\n## IoC\n\n**URL:**\n\n\"hxxp:// hand-ip.com/Cust-Document-5777177439/\"\n\n**Sample SHA256:**\n\nORDER.-Document-7023299286.doc\n\nD8CFE351DAA5276A277664630F18FE1E61351CBF3B0A17B6A8EF725263C0CAB4\n\n## Reference\n\nhttps://support.office.com/en-us/article/Introduction-to-Outlook-Data-Files-pst-and-ost6d4197ec-1304-4b81-a17d-66d4eef30b78\n\nhttps://support.microsoft.com/en-us/help/287070/how-to-manage-.pst-files-in-microsoftoutlook\n\n[https://msdn.microsoft.com/en-us/library/office/cc765775(v=office.14).aspx](https://msdn.microsoft.com/en-us/library/office/cc765775(v=office.14).aspx)\n\n### Related Posts\n\nCopyright © 2022 Fortinet, Inc. All Rights Reserved\n\n[Terms of ServicesPrivacy Policy](https://www.fortinet.com/corporate/about-us/legal.html)\n| Cookie Settings\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-05-09 - Deep Analysis of New Emotet Variant – Part 2.pdf"
    ],
    "report_names": [
        "2017-05-09 - Deep Analysis of New Emotet Variant – Part 2.pdf"
    ],
    "threat_actors": [
        {
            "id": "870f6f62-84f5-48ca-a18e-cf2902cd6924",
            "created_at": "2022-10-25T15:50:23.303818Z",
            "updated_at": "2025-03-27T02:00:55.435309Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "APT32",
                "SeaLotus",
                "OceanLotus",
                "APT-C-00",
                "Canvas Cyclone"
            ],
            "source_name": "MITRE:APT32",
            "tools": [
                "Mimikatz",
                "ipconfig",
                "Kerrdown",
                "Cobalt Strike",
                "SOUNDBITE",
                "OSX_OCEANLOTUS.D",
                "KOMPROGO",
                "netsh",
                "RotaJakiro",
                "PHOREAL",
                "Arp",
                "Denis",
                "Goopy"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "af509bbb-8d18-4903-a9bd-9e94099c6b30",
            "created_at": "2023-01-06T13:46:38.585525Z",
            "updated_at": "2025-03-27T02:00:02.866727Z",
            "deleted_at": null,
            "main_name": "APT32",
            "aliases": [
                "TIN WOODLAWN",
                "OceanLotus Group",
                "OceanLotus",
                "Sea Lotus",
                "G0050",
                "Cobalt Kitty",
                "SeaLotus",
                "ATK17",
                "Ocean Lotus",
                "Ocean Buffalo",
                "POND LOACH",
                "Canvas Cyclone",
                "APT-C-00",
                "APT-32",
                "APT 32"
            ],
            "source_name": "MISPGALAXY:APT32",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2439ad53-39cc-4fff-8fdf-4028d65803c0",
            "created_at": "2022-10-25T16:07:23.353204Z",
            "updated_at": "2025-03-27T02:02:09.749502Z",
            "deleted_at": null,
            "main_name": "APT 32",
            "aliases": [
                "APT 32",
                "APT-C-00",
                "APT-LY-100",
                "ATK 17",
                "Lotus Bane",
                "Ocean Buffalo",
                "OceanLotus",
                "Operation Cobalt Kitty",
                "Operation PhantomLance",
                "Pond Loach",
                "SeaLotus",
                "SectorF01",
                "Tin Woodlawn"
            ],
            "source_name": "ETDA:APT 32",
            "tools": [
                "Agentemis",
                "Android.Backdoor.736.origin",
                "AtNow",
                "Backdoor.MacOS.OCEANLOTUS.F",
                "BadCake",
                "CACTUSTORCH",
                "CamCapture Plugin",
                "CinaRAT",
                "Cobalt Strike",
                "CobaltStrike",
                "Cuegoe",
                "DKMC",
                "Denis",
                "Goopy",
                "HiddenLotus",
                "KOMPROGO",
                "KerrDown",
                "METALJACK",
                "MSFvenom",
                "Mimikatz",
                "Nishang",
                "OSX_OCEANLOTUS.D",
                "OceanLotus",
                "PHOREAL",
                "PWNDROID1",
                "PhantomLance",
                "PowerSploit",
                "Quasar RAT",
                "QuasarRAT",
                "RatSnif",
                "Remy",
                "Remy RAT",
                "Rizzo",
                "Roland",
                "Roland RAT",
                "SOUNDBITE",
                "Salgorea",
                "Splinter RAT",
                "Terracotta VPN",
                "Yggdrasil",
                "cobeacon",
                "denesRAT",
                "fingerprintjs2"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536053,
    "ts_updated_at": 1743041170,
    "ts_creation_date": 1653820834,
    "ts_modification_date": 1653820834,
    "files": {
        "pdf": "https://archive.orkl.eu/a00661b1744a165d419a351a3b44366413b05433.pdf",
        "text": "https://archive.orkl.eu/a00661b1744a165d419a351a3b44366413b05433.txt",
        "img": "https://archive.orkl.eu/a00661b1744a165d419a351a3b44366413b05433.jpg"
    }
}