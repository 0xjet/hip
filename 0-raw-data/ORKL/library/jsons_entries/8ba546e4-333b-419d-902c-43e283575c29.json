{
    "id": "8ba546e4-333b-419d-902c-43e283575c29",
    "created_at": "2023-01-12T15:08:18.504667Z",
    "updated_at": "2025-03-27T02:05:43.921953Z",
    "deleted_at": null,
    "sha1_hash": "e7fb2b251f69047ec4f7338c2b19e7472ad92e75",
    "title": "2020-11-05 - Resourceful macOS Malware Hides in Named Fork",
    "authors": "",
    "file_creation_date": "2022-05-28T19:55:56Z",
    "file_modification_date": "2022-05-28T19:55:56Z",
    "file_size": 2913683,
    "plain_text": "# Resourceful macOS Malware Hides in Named Fork\n\n**[labs.sentinelone.com/resourceful-macos-malware-hides-in-named-fork/](https://labs.sentinelone.com/resourceful-macos-malware-hides-in-named-fork/)**\n\nPhil Stokes\n\nThroughout 2020, we’ve seen a number of developments in macOS threat actor tactics.\n[These have included shifts to shell scripts, making use of alternative programming](https://www.sentinelone.com/blog/coming-out-of-your-shell-from-shlayer-to-zshlayer/)\n[languages like Rust and Go, packaging malware in Electron apps, and notably,](https://www.hybrid-analysis.com/sample/d511e44ee6ae06228170aef1bef567e059596d259e205295b99e85de8c966354) beating\n[Apple’s notarization security checks through the use of steganography. Many of these](https://www.sentinelone.com/blog/hiding-code-inside-images-malware-steganography/)\ntechniques have exploited new or recent changes or developments, but one technique we\nhave observed takes the opposite tack and leverages a legacy technology that’s been\naround since Mac OS 9 in order to hide its malware payload from both users and file\nscanning tools on macOS 10.15 and beyond. In this post, we look at how a new variant of\n[what appears to be Bundlore adware hides its payload in a named resource fork.](https://assets.sentinelone.com/evilquest/sentinelone-vs-bundl)\n\n## Malware Distribution\n\nThe malware can be found in the wild being distributed on sites that offer “free” versions of\npopular software. In this case, we found the malware being distributed by a site called\n“mysoftwarefree”, promising users a free copy of Office 365.\n\n\n-----\n\nUsers are instructed to remove any current installation of Office, to download the legitimate\nfree trial from Microsoft and then to download the “required files” from a button on the\nmalicious site in order to obtain “a full version of Office 365 ProPlus, without any limitations”.\n\n\n-----\n\nOnce the user takes the bait, a file called simply “dmg” is downloaded to the user’s device.\n\n## The Extended Attributes of a Named Resource Fork\n\nInside the mounted disk image, things are far from what the malware site promised the user.\n[No copy of MS Office, but what looks pretty much like a typical “Bundlore/Shlayer” dropper.](https://www.sentinelone.com/blog/coming-out-of-your-shell-from-shlayer-to-zshlayer/)\n\n\n-----\n\nAs is common with these disk images, there are graphical instructions to help the user\n[bypass the built in macOS security checks offered by Gatekeeper and](https://www.sentinelone.com/blog/why-apple-macos-isnt-secure-without-next-gen-av/) [Notarization. On](https://www.sentinelone.com/blog/maco-notarization-security-hardening-or-security-theater/)\n[macOS Catalina, this bypass will not prevent XProtect from scanning the code on execution,](https://www.sentinelone.com/blog/macos-malware-researchers-how-to-bypass-xprotect-on-catalina/)\nbut this particular code isn’t known to XProtect at the current time.\n\nIf we take a trip to the Terminal to inspect more closely what’s on the disk image, surprisingly\nit seems like not much.\n\n\n-----\n\nNote, however, the `@ on the permissions listing for the tiny 203 byte Install.command file.`\nThat indicates that the file has some extended attributes, and that’s where things get\ninteresting.\n\nWe can list the extended attributes using `xattr -l . It seems that there is a`\n```\ncom.apple.ResourceFork attribute, which at least at the beginning seems like an icon file.\n\n```\nThis is not unusual. Resource forks like this have been historically used to store things like\nthumbnail images, for example.\n\n\n-----\n\nHowever, this resource fork is pretty large. If we scroll down to the bottom, we see it s about\n141744 bytes of added data.\n\nMore tellingly, if we inspect the Install.command file itself, we’ll see it’s a simple shell script\nthat gives away the game as to what’s really packed inside the resource fork.\n\nStarting at offset 9092, the script pipes the data in the fork through the `funzip utility with`\n[the password “oZwb” to decrypt the data, dropping it in the Darwin User TMPDIR with a](https://www.sentinelone.com/blog/malware-hunting-macos-practical-guide/)\nrandom name prefixed with “Installer”.\n\nThe file turns out to be a Mach-O with the SHA256 of\n\n```\n43b9157a4ad42da1692cfb5b571598fcde775c7d1f9c7d56e6d6c13da5b35537\n\n```\n\nA quick look on VirusTotal shows that SentinelOne’s Static AI engine recognizes this as a\nmalicious file, tagged by some vendors as a Bundlore variant.\n\n\n-----\n\n## So What’s a Resource Fork and Why Use It?\n\n[A resource fork is a kind of named fork, a legacy filesystem technology used to store](https://jonsview.com/mac-os-x-resource-forks)\nstructured data such as image thumbnails, window data and even code. Instead of storing\ninformation in a series of bytes at particular offsets, a resource fork keeps data in a\nstructured record, similar to a database. Interestingly, the resource fork does not have a size\nlimit beyond the size of the file system itself, and – as we’ve seen here – the fork is not\nvisible directly in either the Finder or the Terminal, unless we list the file’s extended attributes\nvia either `ls` `[email protected] or` `xattr -l .`\n\nUsing a resource fork to hide malware is a pretty novel trick that we haven’t seen before, but\nit leaves open a few questions as to the actor’s purpose in using this technique. Although the\ncompressed binary file is hidden from the Finder and from the Terminal in this way, as we\nsaw, it is easily found by anyone looking for it simply by reading the Install.command shell\nscript.\n\nHowever, many traditional file scanners will not pick up this technique. Other Bundlore\nvariants have used encrypted text files within Disk Image containers and application bundles,\nbut scanners can quickly be taught to find these. One of the things that gives such files away\n[is the extreme length of obfuscated or encrypted code, typically base64, which is anomalous](https://www.sentinelone.com/blog/guide-encode-decoded-base64/)\nfor legitimate software.\n\n\n-----\n\nBy hiding the encrypted and compressed file in the named resource fork, the actors are\nclearly hoping to evade certain kinds of scanning engines. Although this sample in the wild\nwas not code signed and, therefore, not subjected to Apple’s notarization check, in light of\nthe steganography trick used by recent Bundlore variants that did bypass Apple’s automated\nchecks, it remains an open-question whether using a resource fork in this way could also\nhelp threat actors sidestep Notarization checks in future.\n\n## Conclusion\n\nHiding malware in a file’s resource fork is just the latest trick that we’ve seen macOS\nmalware authors use to try and evade defensive tools. While not particularly sophisticated\nand easy to spot manually, it’s a clever way to evade certain tools that are not supported by\ndynamic and static AI detection engines.\n\n**[Addendum: post-publication, we learned that macOS malware researcher @gutterchurl had](https://twitter.com/gutterchurl)**\nalso previously written up a very similar campaign using a file’s resource fork [here.](https://www.carbonblack.com/blog/tau-threat-analysis-bundlore-macos-mm-install-macos/)\n\n## Sample Hashes\n\n**Disk Image**\nSHA1: 06842f098ba7e695a21b6a1a9bd6aee6daeb8746\nSHA256: 5673ace10a07905503486f5f4eeb8d45a4d56a2168b0274084750f68eb7a1362\n\n**Mach-O**\nSHA1: e978fbcb9002b7dace469f00da485a8885946371\nSHA256: 43b9157a4ad42da1692cfb5b571598fcde775c7d1f9c7d56e6d6c13da5b35537\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-05 - Resourceful macOS Malware Hides in Named Fork.pdf"
    ],
    "report_names": [
        "2020-11-05 - Resourceful macOS Malware Hides in Named Fork.pdf"
    ],
    "threat_actors": [
        {
            "id": "8670f370-1865-4264-9a1b-0dfe7617c329",
            "created_at": "2022-10-25T16:07:23.69953Z",
            "updated_at": "2025-03-27T02:02:09.929725Z",
            "deleted_at": null,
            "main_name": "Hades",
            "aliases": [
                "Operation TrickyMouse"
            ],
            "source_name": "ETDA:Hades",
            "tools": [
                "Brave Prince",
                "Gold Dragon",
                "GoldDragon",
                "Lovexxx",
                "Olympic Destroyer",
                "Running RAT",
                "RunningRAT",
                "SOURGRAPE",
                "running_rat"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536098,
    "ts_updated_at": 1743041143,
    "ts_creation_date": 1653767756,
    "ts_modification_date": 1653767756,
    "files": {
        "pdf": "https://archive.orkl.eu/e7fb2b251f69047ec4f7338c2b19e7472ad92e75.pdf",
        "text": "https://archive.orkl.eu/e7fb2b251f69047ec4f7338c2b19e7472ad92e75.txt",
        "img": "https://archive.orkl.eu/e7fb2b251f69047ec4f7338c2b19e7472ad92e75.jpg"
    }
}