{
    "id": "8197210d-e5bc-4acc-8369-ffbedf2c8f2c",
    "created_at": "2022-10-25T16:48:11.10657Z",
    "updated_at": "2025-03-27T02:16:44.290454Z",
    "deleted_at": null,
    "sha1_hash": "98742dcad26eb4051bba977be4fe8bd6c6b140b1",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-02-23T03:55:25Z",
    "file_modification_date": "2021-02-23T03:55:25Z",
    "file_size": 1770865,
    "plain_text": "# The Story of Jian – How APT31 Stole and Used an Unknown Equation Group 0-Day\n\n**research.checkpoint.com/2021/the-story-of-jian**\n\nFebruary 22, 2021\n\nFebruary 22, 2021\n**Research by: Eyal Itkin and Itay Cohen**\n\nThere is a theory which states that if anyone will ever manage to steal and use nationgrade cyber tools, any network would become untrusted, and the world would become a\nvery dangerous place to live in.\n\nThere is another theory which states that this has already happened.\n\nWhat would you say if we told you that a foreign group managed to steal an American\nnuclear submarine? That would definitely be a bad thing, and would quickly reach every\nheadline.\n\nHowever, for cyber weapons – although their impact could be just as devastating – it`s\nusually a different story.\n\nCyber weapons are digital and volatile by nature. Stealing them and transferring from one\ncontinent to another, can be as simple as sending an email. They are also very obscure,\nand their mere existence is a closely guarded secret. That is exactly why, as opposed to a\nnuclear submarine, stealing a cyber-weapon can easily go under the radar and become a\nfact known only to a selected few.\n\n\n-----\n\nThe implications of such a scenario can be devastating, as the world have already\nexperienced with the case of the Shadow Brokers leak, in which a mysterious group have\ndecided to publicly publish a wide range of cyber weapons allegedly developed by the\nTailored Access Operations (TAO) unit of the NSA – also referred to as the ‘Equation\nGroup’.\nThe Shadow Brokers leak lead to some of the biggest cyber outbreaks in history – the\nmost famous of which was the WannaCry attack causing hundreds of millions of dollars in\ndamages to organizations across the globe – and which its implications are still relevant\neven 3 years after it happened.\n\nThe Shadow brokers leak however, just gave us a taste of some of the possible\nimplications such a cyber-theft can cause. Many important questions still remain – could\nthis have also happened before? And if so, who is behind it and what did they use it for?\n\nOur recent research aims to shed more light on this topic, and reveal conclusive evidence\nthat such a leak did actually take place years before the Shadow Brokers leak, resulting in\nUS developed cyber tools reaching the hands of a Chinese group which repurposed them\nin order to attack US targets.\n\n### Key Findings\n\nThe caught-in-the-wild exploit of CVE-2017-0005, a 0-Day attributed by Microsoft\nto the Chinese APT31 (Zirconium), is in fact a replica of an Equation Group\n**exploit code-named “EpMe.”**\nAPT31 had access to EpMe’s files, both their 32-bits and 64-bits versions, more than\n2 years before the Shadow Brokers leak.\nThe exploit was replicated by the APT during 2014 to form “Jian”, and used since at\nleast 2015, until finally caught and patched in March 2017.\nThe APT31 exploit was reported to Microsoft by Lockheed Martin’s Computer\nIncident Response Team, hinting at a possible attack against an American target.\nThe framework containing the EpMe exploit is dated to 2013, and contains 4\nWindows Privilege Escalation exploits overall, two of which were 0-Days at the time\nof the framework’s development.\nOne of the 0-Days in the framework, code-named “EpMo”, was never publicly\ndiscussed, and was patched by Microsoft with no apparent CVE-ID in May 2017.\nThis was seemingly in response to the Shadow Brokers leak.\n\n\n-----\n\n**Figure 1: Timeline of the events detailing the story of EpMe / Jian / CVE-2017-0005.**\n\n## Introduction\n\nIn the last few months, our malware and vulnerability researchers focused on recent\nWindows Privilege Escalation exploits attributed to Chinese actors. During this\ninvestigation, we managed to unravel the hidden story behind “Jian”, a 0-Day exploit that\nwas previously attributed to APT31 (Zirconium), and show its true origins.\n\nIn this blog we show that CVE-2017-0005, a Windows Local-Privilege-Escalation (LPE)\nvulnerability that was attributed to a Chinese APT, was replicated based on an\n**Equation Group exploit for the same vulnerability that the APT was able to access.**\n“EpMe”, the Equation Group exploit for CVE-2017-0005, is one of 4 different LPE\nexploits included in the DanderSpritz attack framework. EpMe dates back to at least 2013\n– four years before APT31 was caught exploiting this vulnerability in the wild.\n\nThis isn’t the first documented case of a Chinese APT repurposing an Equation Group\n[exploit. In the Bemstour case, discussed by both Symantec and our own research team,](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/buckeye-windows-zero-day-exploit)\nthe main assumption was that APT3 (Buckeye) sniffed the EternalRomance exploit from\nnetwork traffic, and later upgraded it to the equivalent of EternalSynergy using an\nadditional APT3 vulnerability. In the present case, however, we have strong evidence that\n**APT31 had access to the actual exploit files of Equation Group, in both their 32-**\nbits and 64-bits versions.\n\nIn the following sections we introduce the 4 different Windows LPE exploits included in\nthe DanderSpritz framework, and reveal an additional exploit code named “EpMo.” This\nexploit was patched in May 2017, probably as part of the follow-up fixes for the Shadow\n\n\n-----\n\nBrokers Lost in Translation leak of Equation Group tools. While the vulnerability was\nfixed, we failed to identify the associated CVE-ID. To our knowledge, this is the first\npublic mention of the existence of this additional Equation Group vulnerability.\n\n## Background\n\n[As part of our ongoing research on Windows LPE exploits, and tracking exploit authors,](https://research.checkpoint.com/2020/graphology-of-an-exploit-volodya/)\nwe started analyzing exploits attributed to Chinese APTs. As CVE-2019-0803 was recently\nmentioned in the NSA list of top 25 vulnerabilities used by Chinese actors, we decided this\nwas a good place to start. After we finished documenting all the information we gathered\non this unique exploit, originally a 0-Day attributed to Chinese actors, we went on to the\nnext Chinese-attributed exploit in our list: CVE-2017-0005.\n\n[In our review of Microsoft’s report on the vulnerability that was caught exploited in the](https://www.microsoft.com/security/blog/2017/03/27/detecting-and-mitigating-elevation-of-privilege-exploit-for-cve-2017-0005/)\nwild and was attributed to Zirconium (APT31), we found a few interesting details:\n\nThe exploit was caught and reported to Microsoft by Lockheed Martin’s Computer\nIncident Response Team.\nThe exploit uses a multi-staged packer, which appears identical to the one we saw\nused by CVE-2019-0803.\n\n**Figure 2: Comparison between the packer of CVE-2017-0005 (left) and that of CVE-**\n2019-0803 (right).\n\nArmed with these two leads, and already familiar with the packer used by these exploits,\nwe set out to find the described exploit of CVE-2017-0005.\n\nAfter we obtained a 64-bit sample of the CVE-2017-0005 exploit, we verified it against the\ninformation described by Microsoft in their blog. Not only did it match, when ignoring the\nrandom page allocation, both samples use the same addresses (same lower 3 nibbles).\n\n\n-----\n\n**Figure 3: Comparison between Microsoft’s sample (left) and ours (right).**\n\n## Comparing CVE-2017-0005 and CVE-2019-0803\n\nIn the following section, we describe in detail some of the characteristics of the packer and\nthe loader used in CVE-2017-0005 and CVE-2019-0803, and highlight their\ncommonalities and differences.\n\nJian, the exploit of CVE-2017-0005, was shipped in a DLL named `Add.dll . It contained`\nan interesting PDB path suggesting that it was written in 2015 under a project named\n“rundll32_getadmin”.\n\nF:\\\\code\\\\2015\\\\rundll32_getadmin\\\\Add\\\\x64\\\\Release\\\\Add.pdb\n\nWhen we checked the Time Date Stamp of the binary in the file header, we saw that the\nDLL was compiled on `Wed May 06 02:08:24 2015, which fits nicely with the folder`\nname from the PDB. An additional timestamp on the export directory points to the exact\nsame date. Speaking of the export directory, the DLL has a single exported function\nnamed “AddByGod”, which, as we will learn soon, is the entry function of the packer.\n\nThe decryption routine is very straightforward. The packer starts by allocating memory\nfor the encrypted code and copies it to the newly allocated buffer. It then allocates a buffer\nwith `PAGE_EXECUTE_READWRITE protection to store the decrypted code. After the buffers`\nare allocated, the packer checks if a string argument, which will be used as a decryption\nkey, was passed to the `AddByGod function. Next, the packer uses the AES256 algorithm`\nwith a SHA1 derived key of the passed argument to decrypt the encrypted code. If the\ndecryption is successful, the decrypted code is executed and a second stage payload runs.\nLuckily, we managed to obtain the password that was needed to execute the binary and\ndecrypt the encrypted payload.\n\nrundll32.exe Add.dll AddByGod [password]\n\nThe second stage begins with a typical shellcode technique, searching the module’s header\nfor the address of `kernel32.dll and dynamically retrieving a pointer to the`\n```\nGetProcAddress export function. Next, the program decompresses another Portable\n\n```\nExecutable (PE) and jumps to its entry point. The decompressed PE, which is the 3rd\nstage in the loading sequence, has intentionally corrupted headers. It does basic loading\n\n\n-----\n\noperations and then begins with a reflective loading of an embedded executable (yes,\nanother one). The loaded PE is the last stage in the loading sequence and is responsible\nfor executing the exploit.\n\nIt’s interesting to mention that the compilation time of the embedded binary — the exploit\nitself — goes back to October 2014. This suggests that the attackers used this 0-day in\n2014, almost three years before it became publicly available in the Shadow Brokers leak\nand was fixed by Microsoft.\n\n**Figure 4: The execution flow of the loaders used for CVE-2017-0005 and CVE-2019-**\n0803.\n\nAs can be seen in the figure above, the packer used for CVE-2019-0803 is very similar to\nthe one used in CVE-2017-0005. In fact, the flow is almost identical. The file was\ncompiled on September 18, 2018, and is also internally named “Add.dll”. Like the\npreviously packed exploit, CVE-2019-0803 also has an export function named\n“AddByGod” and contains debug information:\n\nC:\\Users\\sms2056\\Desktop\\Add（未修改dll‘）\\x64\\Release\\Add.pdb\n\nUnlike the previous sample, this one uses a different decryption password and needs an\nadditional argument when running (used in later stages). The execution flow then\ncontinues exactly as we observed in the previous sample with one exception: after the\nprogram decompresses a PE payload and jumps to its entry point, it does not have a 4th\nstage of another embedded PE, but simply begins the exploitation stage.\n\nWe looked for more samples that use this or a similar variant of the packer we described,\nand found multiple samples and malware families that have used it for many years. All of\nthe malware are clearly and exclusively attributed to Chinese-affiliated attack groups.\nAdding this conclusion to the contextual information we have, Microsoft’s independent\n\n\n-----\n\nattribution of CVE-2017-0005 to a Chinese APT, and NSA s attribution of CVE-20190803 to “Chinese State-Sponsored Actors”, make us believe that the exploit of CVE-20170005 was indeed used by attackers that are part of a Chinese group.\n\n## Jian – CVE-2017-0005\n\nWhen analyzing Jian, we noticed the following interesting characteristics.\n\n### Operating System (OS) Version Context\n\nThe exploit creates a rich version context that includes multiple fields, each representing a\ndifferent characteristic of the target’s operating system. This extensive context isn’t typical\nof the Chinese-attributed exploits we previously analyzed and looks like some sort of a\nutility/framework. This is even more suspicious, as some fields in the context aren’t even\ninitialized (marked in red), and overall only three of them are used by the exploit itself\n(marked in blue).\n\n**Figure 5: Rich version information, as collected by**\nJian.\n\nJust for comparison, the exploit of CVE-2019-0803\nsupported only a single Windows version and used\nthe hardcoded version-dependent constants for\nWindows Server 2008 R2. [Alibaba even reported](https://sec-lab.aliyun.com/2019/04/25/%E9%98%BF%E9%87%8C%E4%BA%91%E4%BA%91%E5%AE%89%E5%85%A8%E4%B8%AD%E5%BF%83%E6%8D%95%E8%8E%B7Win32k%E7%BB%84%E4%BB%B60day/)\nthat the tool’s file name was `2008.dll, leaving no`\ndoubt about the tool’s intended target.\n\n### Global Configuration Table\n\nThe OS version enum is used as an index for a global configuration table. This is a classic\nexample of using such an enum when one needs a version-dependent configuration. The\nconfiguration table itself looks like a promising artifact that might appear in additional\nexploits by the same authors.\n\nWe created detection signatures and looked for samples that contain this configuration\ntable. Our search query resulted in the following samples:\n\n\n-----\n\n```\n   Mcl_NtElevation_EpMe_GrSa.dll  (x86) –\n   292fe1fc7d350cc7b970da0f308d22089cd36ab552e5659e3cfb0d9690166628\n   Mcl_NtElevation_EpMo_GrSa.dll (x64) –\n   1537cad1d2c5154e142af775ed555d6168d528bbe40b31f451efa92c9e4f02de\n\n```\nThe naming convention of the files and their context immediately caught us by surprise.\nWe recognized them as part of the Shadow Brokers’ “Lost in Translation” leak of Equation\nGroup tools. Equation Group is the name given to an APT group which is believed to be\nthe Tailored Access Operations (TAO) unit of the NSA. How did our search for extremelyunique artifacts extracted from a Chinese 0-Day exploit that was patched in March\n**2017 show results of leaked Equation Group tools from 2013? To answer this**\nquestion, we started to dive deep and analyze the information we found.\n\n## Lost In Translation\n\nBefore we describe our analysis, we want to give a brief history of The Shadow Brokers\ngroup and their leaks of Equation Group tools. We believe that understanding the nature\nof the leak, and especially the timeline, is crucial for understanding what happened next.\n\nThe Shadow Brokers is a mystery group of hackers that first appeared on August 12, 2016,\nwhen they invited the public to participate in an auction of Equation Group’s “Cyber\nWeapons.” Since then, the group started to leak more and more files over a period of\nseveral months. One of these leaks, called “Lost in Translation”, emerged in April 2017,\n[and is well known for releasing Equation Group’s notorious exploits such as Eternal Blue.](https://en.wikipedia.org/wiki/EternalBlue)\n\nOne of the main components in this leak is DanderSpritz, Equation Group’s postexploitation framework that contains a wide variety of tools for persistence,\nreconnaissance, lateral movement, bypassing Antivirus engines, and more. The\nframework is very modular and provides the operator many capabilities to access victims’\ncomputers. During the recent months, we revisited the DanderSpritz framework, reverseengineered some of its modules and implants, and plan to publish a detailed\n**publication dedicated to the framework and our findings.**\n\nOur project of profiling exploit authors focuses on Windows LPE exploits, like CVE-20170005 whose artifacts we searched. As common in post-exploitation frameworks,\nDanderSpritz and the Lost In Translation leak also contain LPE exploits, and two of them\nmatched our query.\n\nWe now present a brief overview of some of the LPE exploits that were attributed to the\nEquation Group and their connection to the leaked DanderSpritz framework.\n\n## History of Equation Group LPE Exploits\n\n### PrivLib and the Houston Disk\n\n\n-----\n\nThe term PrivLib is often used when referring to a Privilege Escalation module\nembedded inside a given Equation Group implant. PrivLib contains a selected set of\nWindows LPE exploits chosen from the Equation Group arsenal, and all of them are\nwrapped using a thin wrapper known by its “prkMtx” unique mutex.\n\nIn 2015, Kaspersky [reported a set of Windows LPEs embedded inside a booby-trapped](https://securelist.com/equation-group-from-houston-with-love/68877/)\ndisk given away at a Houston scientific convention. The exploits, attributed to Equation\nGroup, were all 0-Day at the time of development, and some even dated as far back as\n2008. All in all, the Houston Disk contained a PrivLib version that executes a set of 3\nexploits one after the other, until the desired privileges are acquired.\n\nHere is a list of the exploits included in the disk, according to their execution order:\n\n1. MS09-025 (Fanny / Stuxnet)\n2. CVE-2013-3128\n3. CVE-2011-3402\n\n**Note: The CVEs listed here don’t match those mentioned originally by Kaspersky in their**\n[report. First, Kaspersky’s researchers weren’t sure about the CVE-IDs to begin with,](https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/08064459/Equation_group_questions_and_answers.pdf)\nmarking them as “possibly.” Second, we found additional information regarding the latter\ntwo exploits, which helped shed light on more probable CVE-IDs for each. More details\nabout the CVE-ID identification can be found later on under the respective sections\ndescribing each exploit.\n\n### DanderSpritz NtElevation\n\nDanderSpritz is a modular post-exploitation framework that contains dozens of different\ninterdependent modules. For example, some modules do not run unless specific modules\nare not executed first, and others require special privileges or artifacts to run. Some of the\nmodules require privileges of a SYSTEM account to run. For this to happen, DanderSpritz\nexecutes a set of modules named ‘NtElevation’ that are responsible for elevating the\nprivileges of the implant running on the victim’s computer.\n\n\n-----\n\n**Figure 6: An example for the dependencies of the** `PasswordDump module, including`\n```\nNtElevation .\n\n```\nThese privilege escalation modules are the ones we caught when we queried for Jian’s\nglobal configuration table. And they were not alone. We also found a couple of more Local\nPrivilege Escalation exploits from the NtElevation series.\n\nWhile the `Eternal* exploits received a lot of attention, and rightly so, mentions of the`\nNtElevation exploits were somehow missing. We couldn’t find any online reference that\npoints to the existence of the NtElevation module as part of the Equation Group arsenal\nor even as part of the “Shadow Brokers Exploits”, nor any reference to the following 4\nexploit code names.\n\n**ElEi**\n**ErNi**\n**EpMo**\n**EpMe**\n\n**Note: Equation Group’s exploits are known to have code names that are abbreviated**\nusing 4 letters. For example, Eternal Blue and Eternal Romance are internally referred to\nas `ETBL and` `ETRO . Similarly, the Local Privilege Escalation exploits we discussed have`\ntheir own code names, as listed above.\n\nDespite our attempts, we couldn’t manage to trace back the full code names for these\nexploits. However, the naming convention suggests that `EpMo and` `EpMe are of the`\nsame type or that they exploit vulnerabilities in the same module, just like the `Eternal*`\nexploits (EternalBlue, EternalRomance, etc). This conclusion does make sense as our\nsingle search query found both of these exploits.\n\nWhen we analyzed the DanderSpritz NtElevation API, we found the checks that each\nmodule deploys to declare that the exploit is indeed supported. When combined with the\noriginal patch dates Kaspersky estimated for the two font exploits from the Houston Disk,\nthis new information helped us make a better estimate of the inner workings of each CVEID.\n\nWe thoroughly analyzed the found exploits and tried to match each exploit file to its\nrespective CVE-ID. These are the results of our analysis and our conclusions.\n\n## ElEi – CVE-2011-3402\n\n**Houston Disk: 3rd in the execution order.**\n\n**Supported DanderSpritz Windows Versions: Windows 2000 to Windows 7,**\ninclusive.\n\nThe exploit also contains an additional check that `win32k.sys is dated to before`\nNovember 23, 2011. This is a clear indication of CVE-2011-3402, which is the only font\nvulnerability that was fixed in December 2011. The gap in the dates is explained by the\nfact that Microsoft compiled the patched driver on the mentioned date.\n\n\n-----\n\nWe are aware that CVE-2011-3402 was originally spotted as a 0-Day that was exploited in\n[the wild, and was found in Duqu (1.0). Currently, we can only point out this interesting](https://msrc-blog.microsoft.com/2011/12/13/more-information-on-ms11-087/)\nCVE-ID match, but we have not yet studied it further or compared the two exploits, as\nthese font exploits are outside of the scope of our research, which focuses on the unknown\nDanderSpritz exploits and their connection to CVE-2017-0005.\n\nWe do recommend this lead for a future work publication and invite security researchers\nworldwide to examine this connection.\n\n## ErNi – CVE-2013-3128\n\n**Houston Disk: 2nd in the execution order.**\n\n**Supported DanderSpritz Windows Versions: Only Windows 2000.**\n\nThe exploit also contains an additional check that `ATMFD.dll is of the exact version`\n“5.0.2.227”. As the Houston Disk exploit supported additional versions, we aren’t fully\nsure why the version range was narrowed down in DanderSpritz. Compared to `ElEi,`\nthere is no indicative patch check, which may be because the DanderSpritz files are dated\nto mid-2013, which is prior to the patch that was identified by Kaspersky and is dated to\nOctober 2013.\n\nWe chose CVE-2013-3128 instead of CVE-2013-3894 because this vulnerability is an\nOpenType Font vulnerability, which correlates with the exploit at hand. This\nidentification should be taken with a grain of salt as none of these CVE-IDs were actually\nmarked as “exploited in the wild.” The reason we chose this CVE-ID is merely because it is\nmentioned in the Patch Tuesday cited by Kaspersky. As with `ElEi, further study of these`\nfont exploits is more than welcome.\n\n## User Mode Print Driver (UMPD) 101\n\nBasic analysis of both `EpMo and` `EpMe found them to be GDI User-Mode-Print-Driver`\n(UMPD) related, which explains why we found them when searching for a GDI UMPD\nrelated artifact from Jian. Before diving into the exploits, we first provide some\nbackground on what exactly is a User-Mode-Print-Driver.\n\nThe Windows operating system supports the option of rendering most of the needed\ngraphics for a given print job in user-mode, in contrast to the traditional implementation\nof such drivers inside the Windows kernel. The architecture of deploying such a UserMode-Print-Driver (UMPD) is shown below.\n\n\n-----\n\n**[Figure 7: UMPD architecture, based on figures from this Black-Hat Europe talk.](https://i.blackhat.com/eu-20/Wednesday/eu-20-Han-Discovery-20-Yeas-Old-Vulnerabilities-In-Modern-Windows-Kernel.pdf)**\n\nSupporting such a data flow dictates that the kernel is aware of the user’s UMPD device\nand can forward it a set of requests, depending on the types that the driver declared to\n[support. As is explained in more detail in this excellent Black Hat Europe 2020 talk](https://i.blackhat.com/eu-20/Wednesday/eu-20-Han-Discovery-20-Yeas-Old-Vulnerabilities-In-Modern-Windows-Kernel.pdf)\nfocusing on UMPD, allowing for user-mode callbacks, invoked from the kernel, is a sure\nrecipe for security vulnerabilities.\n\nIn the next few sections, we explain in detail how each Equation Group exploit uses the\nUMPD, and which vulnerabilities in this mechanism were exploited.\n\n## EpMo – Analysis\n\n**Houston Disk: N/A.**\n\n**Supported DanderSpritz Windows Versions: Windows 2000 to Windows Server**\n2008 R2, inclusive.\n\n### Root Cause\n\nAfter we finished reverse engineering the rich context and utilities exposed as part of the\nDanderSpritz framework and API, the vulnerability itself was quite simple. A short\nanalysis revealed that this is probably a NULL-Deref vulnerability, as the NULL page is\nallocated, and the shellcode is immediately copied to it, as can be seen below:\n\n\n-----\n\n**Figure 8: Preparation of the NULL-page, as part of the EpMo exploit.**\n\nAs this is a NULL-Deref vulnerability, we can immediately rule out CVE-2017-0005, as\nthe stack trace shown in Microsoft’s blog has nothing to do with the NULL page. This\nmeans that this is possibly another vulnerability found and exploited by Equation Group\nin 2013. With that out of the way, it is time to understand what triggers this NULL-Deref\nvulnerability.\n\nOur first hint as to the identity of the affected module, which we expect to be the UMPD,\ncan be found in this classic example of the use of the OS version enum field:\n\n**Figure 9: Using OS version enum to query for the** `ppClientPrinterThunk callback`\nindex.\n\nAfter the version-dependent index of the callback is fetched, the callback itself is replaced\nwith the attacker’s fake `ClientPrinterThunk callback.`\n\n\n-----\n\n**Figure 10: Replacing the** `KernelCallbackEntry with the attacker’s`\n```\nClientPrinterThunk .\n\n```\nBingo! The exploit indeed makes use of a fake `ClientPrinterThunk . Let’s dig in and`\nanalyze the exploit logic inside this fake callback.\n\nThe callback itself is a thin wrapper that forwards the `gdi_ctx and the original`\nargument to a function that is very similar to Windows’s own `GdiPrinterThunk . As a`\nmatter of fact, the code of the exploit is very modular, and each supported driver\ncommand is handled by its own virtual handler implemented in the `gdi_ctx class.`\nAside from the chosen set of implemented handlers, there is no real logic in this function.\n\n**Figure 11: Driver command types that are handled by the exploit’s user-mode driver.**\n\nWhile analyzing this function, we stumbled upon the GDI configuration array that\noriginally pointed us to this exploit sample. Now, placed in the right context, we can easily\ndeduce the role of this configuration array. It holds the print driver’s `INDEX_LAST value`\nfor each version of the target operating system.\n\n\n-----\n\n**Figure 12: Global** `INDEX_LAST configuration table, as used by the driver.`\n\nAs can be seen above, this configuration value is crucial for the driver’s logic as it\nrepresents the total number of dispatched functions that should be handled by the driver.\n\nNow that we understood the overall flow of the exploit, and the structure of the UserMode-Print-Driver (UMPD), tracing the root cause of the vulnerability proved to be a\nrelatively simple task. The driver implemented special handlers only for the following\nbasic command types:\n\n**Figure 13: List of driver-supported**\ncommand types.\n\nOn top of these commands, there is one\nadditional supported command, with the\nos-dependent value of `INDEX_LAST +`\n```\n4 :\n\n```\n\n-----\n\n**Figure 14: Handler for the** `DrvFN command type.`\n\nIn this command, we initialize an array that tells the operating system which function\nhandlers we support. The attackers chose to mark all of the functions as “supported”\nexcept for 3 specific function handlers:\n```\n   DrvStartDoc (0x23)\n   DrvEnableSurface (0x03)\n   DrvDisableSurface (0x04)\n\n```\nPlease pay close attention to `DrvEnableSurface . The syscall that triggers the`\nvulnerability is `NtGdiStartDoc, which is responsible for starting the print job.`\nHowever, to do so, the vulnerable function `win32k!PDEVOBJ::bMakeSurface() is`\ninvoked and tries to create a surface, exactly the operation that isn’t supported by our\ndriver. Here is a debugging output from the vulnerable function:\n\n\n-----\n\n**Figure 15: Debugger output inside the vulnerable function showing the missing handler**\nentry.\n\nWhile the entry for `DrvDisablePDEV (0x02) exists, and points to the correct Windows`\nfunction, the adjacent entry for `DrvEnableSurface (0x03) contains only zeros.`\n\nFrom this point, the vulnerability is clear. The vulnerable function assumes that our\ndriver supports this handler, fetches the empty entry from the struct, and invokes NULL\nas the function responsible for enabling the surface. The figure below shows the full stack\ntrace, right at the point in which the control flow is passed to the shellcode that the\nattacker stored at address 0x0:\n\n00 8aeb8c6c 8fa42330 0x0\n\n01 8aeb8c88 8fbae3f6 win32k!PDEVOBJ::bMakeSurface+0x43\n\n02 8aeb8cb0 8fbae94c win32k!GreStartDocInternal+0x7e\n\n03 8aeb8d1c 82a4f42a win32k!NtGdiStartDoc+0x2ff\n\n04 8aeb8d1c 000f0813 (T) nt!KiFastCallEntry+0x12a\n\n05 0022eed0 10008118 (T) 0xf0813\n\n06 0022ef18 10006f53 Mcl_NtElevation_EpMo_GrSa+0x8118\n\n07 0022ef28 10006fc3 Mcl_NtElevation_EpMo_GrSa+0x6f53\n\n08 0022ef44 10007af4 Mcl_NtElevation_EpMo_GrSa+0x6fc3\n\n09 0022ef74 10006ce5 Mcl_NtElevation_EpMo_GrSa+0x7af4\n\n\n-----\n\n0a 0022efcc 10004a31 Mcl_NtElevation_EpMo_GrSa+0x6ce5\n\n0b 0022f324 100038c0 Mcl_NtElevation_EpMo_GrSa+0x4a31\n\n0c 0022f338 10003a7b Mcl_NtElevation_EpMo_GrSa+0x38c0\n\n0d 0022f370 10002adf Mcl_NtElevation_EpMo_GrSa+0x3a7b\n\n0e 0022f3d8 77d5af24 Mcl_NtElevation_EpMo_GrSa+0x2adf\n\n### The Patch\n\nMicrosoft fixed this vulnerability in May 2017, one month after the Shadow Brokers’s Lost\nin Translation leak. However, we failed to find a CVE-ID that refers to this fix. The patch\nitself addresses the exact flaw in the vulnerable function\n```\nwin32k!PDEVOBJ::bMakeSurface() . It adds a sanity check after the handler is fetched\n\n```\nfrom the struct, and before it is invoked by the function. If the entry is NULL, the function\naborts.\n\n**Figure 16: Patched version now checks the function handler before invoking it.**\n\nTo conclude, the `EpMo Equation Group exploit is a NULL-Deref in GDI’s UMPD module,`\nand is therefore not an exploit for CVE-2017-0005. It was patched by Microsoft in May\n2017, and we couldn’t find a clear CVE-ID associated with it.\n\nNow that we better understand the framework’s API, and have a better understanding of\nthe UMPD module, it is time to focus on the next exploit – `EpMe .`\n\nJust to recap, we found both of these exploits when searching for an artifact from Jian,\nAPT31’s exploit for CVE-2017-0005. As `EpMo is a different vulnerability that originates`\nfrom the same module, our hope was that `EpMe does indeed exploit CVE-2017-0005.`\nTime to analyze it and find out.\n\n## EpMe – Analysis\n\n**Houston Disk: N/A.**\n\n**Supported DanderSpritz Windows Versions: Windows XP to Windows 8,**\ninclusive.\n\n### Root Cause\n\n\n-----\n\nArmed with our newly acquired knowledge about the UMPD module, we started analyzing\nthe EpMe exploit. The exploit itself shares a lot of code with EpMo, thus allowing us to\neasily focus on the exploit-specific logic that is unique to EpMe. While the initialization\nphase of this exploit is longer and involves a lot of GDI-related bootstrapping\n( DrawStream(), finding the wanted Display, etc.), the actual flow that hijacks the\ncontrol flow is relatively simple.\n\nAfter the bootstrap is finished, the exploit triggers a call to the `NtGdiBitBlt syscall.`\nThis initiates a chain of events in the Windows kernel and eventually passes the flow back\nto our user-mode callback ( DrvBitBlt() ) registered by our UMPD. Here lies the heart\nof the exploit.\n\nOur function allocates a new `Rbrush using` `NtGdiBRUSHOBJ_pvAllocRbrush(), whose`\nsole purpose is to allow UMPD implementations to allocate themselves an `Rbrush and`\ncouple it with a `BRUSHOBJ . As a direct result, it also means that the` `Rbrush is allocated`\nin user-mode, using `EngAllocUserMemEx() . Storing it in user-mode means that we`\ncan access it and craft the struct’s content. And so, the attackers corrupted the `Rbrush to`\npoint at a set of fake GDI objects that were forged on a local stack buffer inside the\ncallback.\n\nTo hijack the control flow, the attackers chose to use a Palette and crafted it so that\n```\nPALETTE.pfnGetNearestFromPalentry points to their shellcode, exactly as Microsoft\n\n```\npointed out in their blog on the caught-in-the-wild exploit. After everything is built, the\ncallback invokes the `NtGdiEngBitBlt syscall with a` `rop4 parameter of` `0xCCAA . This`\nspecific syscall was chosen because of two key features:\n\nThe user passes to it a `BRUSHOBJ .`\nA `rop4 value of` `0xCCAA means the kernel directly accesses the user-controlled`\n```\n   Rbrush from within the supplied BRUSHOBJ .\n\n```\nMore specifically, a Stream is extracted from the fully-controlled `Rbrush and is`\nforwarded on to `EngDrawStream(), causing the unsuspecting kernel function to use our`\nfully crafted Stream.\n\n\n-----\n\n**Figure 17: Control flow of the EpMe exploit of CVE-2017-0005.**\n\nThis chain of functions gradually uses all of the GDI objects that we’ve crafted in our usermode callback, eventually leading to `XLATEOBJ_iXlate() . This last function invokes`\nour crafted `PALETTE.pfnGetNearestFromPalentry function pointer, thus hijacking the`\ncontrol flow and triggering the execution of our shellcode.\n\nTo summarize, the root cause for this vulnerability is based on the complex design\ninvolved in supporting UMPD, and the need to allocate objects for it in user-mode. The\nvulnerability itself lies inside `EngBitBlt(), which blindly trusts and directly uses our`\ncrafted `Rbrush and the set of fake GDI objects it points to. Not only does this`\nvulnerability give an attacker a powerful exploit primitive, but it also points at a design\nissue in the Windows kernel. As long as there is a function somewhere in the kernel that\ndirectly accesses a user-supplied `Rbrush, it also blindly trusts all the values that it`\npoints to and that are fully controlled by the user.\n\n### The Patch – CVE-2017-0005\n\nAnother important conclusion we drew from analyzing the exploited vulnerability is that\nwe now know for sure that EpMe exploits CVE-2017-0005. On top of our analysis of\nboth the Equation Group and APT31 exploits, the EpMe exploit aligns perfectly with the\ndetails reported in Microsoft’s blog on CVE-2017-0005. And if that wasn’t enough, the\nexploit indeed stopped working after Microsoft’s March 2017 patch, the patch that\naddressed the said vulnerability.\n\nThe patch itself is rather straightforward: `EngBitBlt() with a` `rop4 value of` `0xCCAA`\nno longer supports the option to draw a Stream, an action that demands extracting a\nStream from the user-supplied `Rbrush . By removing this feature altogether, Microsoft`\ncompletely eliminated the vulnerable code flow.\n\n\n-----\n\n**Before:**\n\n**Figure 18: Vulnerable** `win32k.sys, supports both` `EngDrawStream() and`\n```\nEngTransparentBlt() .\n\n```\n**After:**\n\n**Figure 19: Patched** `win32k.sys, no longer supports` `EngDrawStream() .`\n\nIt is important to remember that two APTs exploiting the same vulnerability (CVE-20170005) could just be a coincidence. When this happens to security researchers, such a case\nis often referred to as a “bug-collision.” It’s possible that researchers on both sides found\nthis vulnerability independently, and it doesn’t necessarily mean that there is a real\nconnection between the tools.\n\n\n-----\n\nWe now compare the two exploit samples, Jian and EpMe, and see if we can spot any\nconnection between them aside from them exploiting the same vulnerability.\n\n## EpMe vs Jian\n\n### Similar Version Context\n\nAt the beginning of our research, we saw that Jian uses a context that holds multiple fields\nabout the version of the target’s operating system. Used fields are marked in blue, and\nuninitialized fields are marked in red.\n\n**Figure 20: Rich version information, as**\ncollected by Jian.\n\nNow, when we review the version context used by\nall exploits shared by the DanderSpritz\nframework, we can see the following, very\nsimilar, structure:\n\n\n-----\n\n**Figure 21: Version context used by DanderSpritz and shared by all Equation Group**\nexploits.\n\nThe fields that are marked in red in Jian were marked again in the sample from the\nEquation Group exploits. As can be seen, one field is still unused in all 4 DanderSpritz\nexploits, but the other field is heavily used and holds the handle for the mapped version of\nNTOS kernel. It is hard to miss the wide similarity between the two structures, up to the\n**order and size of the first 9 fields, even including the size of the unused field in**\nbetween.\n\nThe changes between the two configuration structures are that Equation Group’s\nconfiguration contains more fields, mostly used for security mitigation policies, that are\nrelevant for Windows 8 systems and higher. The last difference between the structures is\nin the field specifying the architecture of the target’s kernel, which for some reason was\nnegated in Jian. Anyway, this field was never used by the exploit.\n\nOverall, having a Chinese-attributed exploit use a version context is uncommon. Having\none that is nearly identical to the version context used by the entire DanderSpritz\nNtElevation module can’t be a coincidence.\n\n\n-----\n\n### Same Memory Layout\n\nAt the heart of the exploits lies a single function that populates a buffer with the various\nfake GDI objects, which is pointed to by our user-mode `Rbrush object. Not only do both`\nexploits use a single function for the construction of all of these fake objects, but the\nmemory layout of the objects in the argument buffer is also identical.\n\n**Figure 22: Construction of the fake GDI objects, as done in Jian.**\n\nWhen we analyzed the code of the Equation Group exploit, we used it to recreate a source\ncode Proof-Of-Concept (POC). The result is the following beautified and labeled code:\n\nvoid populate_buffer_and_brush(char * pBuffer, HBRUSH hbrush)\n\n{\n\nmemset(pBuffer, 0, 0x200);\n\nmemset(&pBuffer[0x200], 0, 0xA8);\n\nmemset(&pBuffer[0x2A8], 0, 0x30);\n\nmemset(&pBuffer[0x2D8], 0, 0x10);\n\n\n-----\n\n// 0x00: PALETTE\n\n*(DWORD *)( pBuffer + 0x18) = 2; // 0x14 - 0x1C: flPal\n\n*(size_t *)(pBuffer + 0x80) = pBuffer + 0x2A8; // 0x80 - 0x88: apalColor\n\n// Brush (DRAWSTREAMINFO)\n\nsize_t * pBrush = (size_t*)hbrush;\n\npBrush[3] = pBuffer + 0x29C; // pptlDstOffset - Pointer to 0\n\npBrush[4] = pBuffer + 0x208; // pxloSrcToBGRA\n\npBrush[5] = pBuffer + 0x208; // pxloDstToBGRA\n\npBrush[6] = pBuffer + 0x208; // pxloBGRAToDst <-- We use this one (offset 0x30)\n\npBrush[7] = 60; // ulStreamLength - 60\n\npBrush[8] = pBuffer + 0x260; // pvStream - Pointer to our built \"Stream\"\n\n// Second Struct\n\n*(size_t *)(pBuffer + 0x200) = hbrush;\n\n// 0x208: _XLATE\n\n*(size_t *)(pBuffer + 0x230) = pBuffer; // ppalSrc\n\n*(size_t *)(pBuffer + 0x238) = pBuffer; // ppalDst <-- We use this one (offset 0x30)\n\n*(size_t *)(pBuffer + 0x240) = pBuffer; // ppalDstDC\n\n// 0x260 - 0x2A8: Our \"Stream\"\n\n*(DWORD *)(pBuffer + 0x260) = 9; // DS_NINEGRIDID (ulCmdID)\n\n*(DWORD *)(pBuffer + 0x26C) = 1; // rclDst.right = 0x01\n\n*(DWORD *)(pBuffer + 0x270) = 1; // rclDst.bottom = 0x01\n\n*(DWORD *)(pBuffer + 0x27C) = 80; // rclSrc.right = 0x50\n\n*(DWORD *)(pBuffer + 0x280) = 80; // rclSrc.bottom = 0x50\n\n*(DWORD *)(pBuffer + 0x284) = 4; // ngi.flFlags := DSDNG_PERPIXELALPHA (4)\n\n// 0x2A8: Palette Color Table\n\n*(DWORD *)(pBuffer + 0x2CC) = 100;\n\n// Fourth Struct\n\n\n-----\n\n(size_t )(pBuffer + 0x2D8) = AllocMemoryPage(0x10000);\n\n*(size_t *)(pBuffer + 0x2E0) = g_pRtlCopyUnicodeString;\n\n}\n\nAside from the added struct at the end of the buffer, which uses\n```\nRtlCopyUnicodeString, the memory layout of the objects inside the argument buffer\n\n```\nwas completely identical.\n\nAs we also labeled the different objects, we can see that the important part is the\nreferences from one object to another, and not the location in which they are stored in the\nbuffer itself. And yet, as if by magic, both exploits share this memory layout.\n\n### Shared Constants\n\nOne more advantage of our recreated code POC for EpMe is that it enabled us to play\naround with various constants used throughout the exploit, such as:\n\nGUI Window Name – Originally “h”.\nPoint locations – One of which was originally (100, 100).\nPrint Job ID – Originally 5.\nDriver Name / Document Name – A weird Unicode string is shown below.\n\n**Figure 23: Weird Unicode string, later used as both the driver and document names.**\n\nNeedless to say, none of the above were related to the vulnerability itself, and changing\nthem didn’t affect the exploit at all. They are simply hardcoded constants chosen by the\noriginal developers of the exploit.\n\nThe interesting thing is, both EpMe and the Jian use the exact same hardcoded\n**constants. The fact that all of these constants are shared between the two samples, even**\nthe weird looking Unicode string above, just shows that one of the exploits was most\nprobably copied from the other.\n\n\n-----\n\n**Figure 24: Jian containing the same constants as the Equation Group exploit.**\n\nIt is also possible that both parties were inspired by some unknown 3rd-party\nimplementation that used all of these constants. Alas, we failed to find any evidence for\nthe existence of such a module. We must say that the odds of this scenario are rather slim,\nespecially when taking into account the weird-looking Unicode string.\n\n### Comparison Conclusion\n\nThe meaning of all of this is pretty simple:\n\nOne APT found the vulnerability and developed an exploit for it.\nAnother APT caught it and replicated it for their own use.\n\nWhile both of them deserve full credit for these remarkable achievements, we still want to\nfind out who copied from whom. Time to attribute the exploit.\n\n## Exploit Attribution – Who was the original developer?\n\n### Weird Looking Unicode String\n\nTo the eyes of a Western researcher, the Unicode string used for both the print driver\nname and the name of the printed document looks foreign. And indeed, we can surely say\nthat the string “屁썟“ doesn’t look like an obvious choice for native English speakers.\n\nWe therefore consulted with colleagues around the world who are fluent in Chinese,\nKorean and Japanese, and asked for their opinion about these two symbols. The\nunanimous answer we received declared that there is no language in which these symbols\nmake sense. In each language, only one symbol has a meaning, and in any case doesn’t\n**make sense as part of a two-symbol phrase. We also checked for a meaning for the**\nsymbols created from inverting the order of the original bytes, and the result was the\nsame.\n\nSo this is probably not a Chinese phrase used by the original developers of the exploit, but\nwhat is it?\n\n\n-----\n\nOur main hypothesis is based on the op-sec of the developers. Aside from names of DLL\nfiles and imported functions, it is very rare to find any string inside Equation Group\nsamples. Even the name of the created window is only “h”, not exactly a long string that\ncould be used by YARA rules so as to “sign” the binary. Faced with the need to use a\nUnicode string that is surely longer than a single ASCII char string, we believe that the\ndevelopers chose to use a pattern that matches their needs:\n\nUnicode-enough for the Windows API.\nNot a real string that might be traced by security researchers / solutions.\n\nIf we look closely at the chosen Unicode string, we can see that it actually makes more\nsense as an x64 assembly snippet:\n\n41 5C pop r12\n\n5F pop rdi\n\nC3 retn\n\nAs a matter of fact, this byte sequence is actually a very popular assembly snippet, found\nalmost 150 times just in `ntdll.dll . Choosing such a popular assembly sequence for a`\n“Unicode string” achieves all of the stated goals.\n\nFinally, the string can also be randomly generated and lacks any meaning whatsoever.\n\n### Window Name – “h”\n\nAs we just mentioned in the previous section, the GUI Window name used in both of the\nexploits is “h”. What may seem like a randomly selected short string actually has quite a\nhistory behind it. Since the earliest PrivLib version we managed to find, dated to 2008, all\nof the Equation Group exploits that we’ve analyzed used the exact same string when a\nwindow name was needed. And this string was always “h”.\n\nAs a matter of fact, all of the 3 exploits included in the Houston Disk used the exact same\nglobal string when creating their window:\n\n**Figure 25: Global string used as the window name in all Houston Disk exploits.**\n\nThis is one small indication that the original authors of the exploits could indeed have\nbeen Equation Group. However, as this artifact could also be just a coincidence, we now\nreview additional aspects of the exploits.\n\n## Quirks in Jian\n\n### Windows 2000 support\n\n\n-----\n\nClose examination of the vulnerable function shows us that Windows 2000 was never\nvulnerable, as can be seen below:\n\n**Figure 26:** `win32k.sys from Windows 2000, just before the version reached End-of-`\nLife.\n\nDespite Windows 2000 not being vulnerable, the UMPD code in Jian has special cases for\nWindows 2000, and Windows 2000 is part of the OS Version enum.\n\n**Figure 27: Jian’s logic for supporting Windows 2000, inside the UMPD module.**\n\nThe interesting issue is that according to the exploit configurations of Equation Group,\n**EpMe doesn’t support Windows 2000. The minimal supported version is Windows**\nXP, which aligns perfectly with the vulnerable Windows versions.\n\nThe fact that Equation Group built proper frameworks means that the UMPD module was\nshared between EpMe and EpMo. The variation between the exploits is based on exploitspecific logic that was implemented inside virtual handlers that are invoked by the generic\nUMPD module. Because EpMo supports Windows 2000, so does the UMPD module,\nwhich explains why EpMe might seem to support this version of Windows.\n\n\n-----\n\n**Figure 28: Support for Windows 2000 in the shared UMPD module of EpMo and EpMe.**\n\nIf we assume for a moment that APT31 was the original developer of the exploit for CVE2017-0005, why would they even attempt to add support for Windows 2000? Windows\n2000 was never vulnerable in the first place. To be clear, we have no indication that the\nactors had their own version of the EpMo exploit or anything similar, meaning we have no\nindication they ever needed such Windows 2000 support for any other tool / exploit.\n\nA far more probable scenario is that APT31 copied the exploit from Equation Group. It is\nlikely that the threat group’s developers probably didn’t fully understand the limitations\nof the exploit, and so left the Windows 2000 specific code untouched. An old relic\ninherited from the EpMo exploit of which APT31 wasn’t even aware of or care about.\n\n### Enum value rotation\n\nFor some unknown reason, Jian contains the syscall definitions for a 32-bit exploit, on top\nof those needed for the 64-bit exploit. While they aren’t used in practice, as the sample is\n64-bit, they still give us a glimpse of how their 32-bit exploit would have looked.\n\nWe can see that Jian’s 32-bit logic for each syscall ID once again matches that of the\nEquation Group sample, up to the level of adjusting some IDs based on the refined Service\nPack Major Number.\n\n\n-----\n\n**Figure 29: Jian’s logic for configuring 32-bit syscalls, using a refined Service Pack value.**\n\nThe problem is, if we check the actual syscall numbers for Windows XP Service Pack 0\nand Service Pack 1, we can see that the condition for setting the value of `SP_delta is`\nflawed. It was correct for the Equation Group exploit, but is not correct here as APT31\nmodified the `wSpMajor_refined value during the exploit’s initialization.`\n\n\n-----\n\n**Figure 30: Jian’s rotation of almost all** `wSpMajor values.`\n\nThis value update is even stranger, as the Equation Group exploits have no mention of it\nwhatsoever:\n\n**Figure 31: Equation Group exploit setting the value of** `wSpMajor_refined .`\n\nYou might ask, “Why would someone perform the above value rotation?” The answer is\nactually rather simple. From our past analyses of several exploits attributed to Chineseaffiliated actors, we saw that the developers have a habit of using the value 0 as a marker\nfor “illegal value.” This can be clearly seen as all Service Pack values above 6 are mapped\nback to the value 0, which marks them as “illegal.” This was also the case for the OS\nVersion Enum, which was fully incremented by 1, making Windows NT use a value of 1\ninstead of 0, and reserving the sacred value of 0 to mark an error state.\n\nAnd yet, this time the developers used only a partial rotation for the Service Pack value,\ncausing a collision with the legitimate value for Service Pack 0 which for some reason they\ndidn’t remap to “1”. This means that 0 is simultaneously an illegal value that shouldn’t be\n\n\n-----\n\nsupported, and a legitimate value that is crucial for configuring the correct syscall\nnumbers. The correct adjustment should probably have been to increment all values by 1,\nmap the illegal values to 0, and adjust the syscall check to `wSpMajor_refined != 1 .`\n\nOnce again, we see a weird pattern. Even under the premise that Chinese exploits should\nreserve the value 0 for illegal values, the code still looks odd. A developer writing this\nexploit from scratch would probably have just incremented the `wSpMajor_refined`\nvalue by 1, while remembering that in future checks Service Pack 0 is marked with the\nvalue 1. Instead, as if not to break an existing piece of code, the syscall initialization still\nchecks for 0, and this value is simultaneously both valid and illegal at the same time.\n\nA more probable explanation is that the original code was the Equation Group version,\nand that the developers affiliated with Chinese attack groups were afraid to break it, thus\ngoing only half-way in remapping the values. This fear of breaking the code also reflects\non their poor understanding of the overall exploit.\n\n### Debug string in the trigger function\n\nJian contains a debug string “int the overflow!!!” that can be found inside UMPD’s\n```\nDrvBitBlt(), the callback responsible for triggering the vulnerability.\n\n```\n**Figure 32: APT31 debug string inside the trigger function.**\n\nAs we already established, the exploited vulnerability is not an “overflow” vulnerability.\nWhile the string may hint at either a “buffer overflow” or an “integer overflow”, none of\nthem have any connection to the user-mode callback design issue that was actually\nexploited.\n\nWhile it may just be a language barrier issue, this is yet another possible clue that the\nattackers behind Jian didn’t properly understand the true nature of the exploited\nvulnerability.\n\n## Attribution Conclusion\n\nTogether with additional artifacts that match Equation Group artifacts and habits shared\nbetween all exploits even as far back as 2008, we can safely conclude the following:\n\nEquation Group’s EpMe exploit, existing since at least 2013, is the original exploit\nfor the vulnerability later labeled CVE-2017-0005.\nSomewhere around 2014, APT31 managed to capture both the 32-bit and 64-bit\nsamples of the EpMe Equation Group exploit.\nThey replicated them to construct “Jian”, and used this new version of the exploit\nalongside their unique multi-staged packer.\nJian was caught by Lockheed Martin’s IRT and reported to Microsoft, which\npatched the vulnerability in March 2017 and labeled it CVE-2017-0005.\n\n\n-----\n\n## Timeline\n\nBelow is a timeline of the events surrounding both exploit versions of what began as\nEpMe (Equation Group) and was eventually patched by Microsoft as CVE-2017-0005\n(APT31).\n\n**Figure 33: Timeline of the events detailing the story of EpMe / Jian / CVE-2017-0005.**\n\nIn greater detail:\n\n2008/2009 – Early Equation Group exploit tools: PrivLib / Houston Disk.\n2013 – DanderSpritz NtElevation exploits: ElEi, ErNi, EpMo, EpMe.\nOctober 27, 2014 – Early timestamp from the embedded PE – cloned EpMe.\nMay 6, 2015 – Multiple indicators that the complete APT31 tool was compiled in\n2015.\nAugust 13, 2016 – Initial Shadow Brokers publication.\nJanuary 8, 2017 – Shadow Brokers leak a directory structure of their files, clearly\nindicating the possession of DanderSpritz and Eternal* exploits.\nFebruary 14, 2017 – Patch Tuesday is cancelled, merged with March’s fixes.\nMarch 14, 2017 – Patch Tuesday – Fixed CVE-2017-0005 and 1st round of critical\nEquation Group exploits included in the to be published “Lost in Translation” SB\nleak.\nMarch 27, 2017 – Microsoft publishes the blog on CVE-2017-0005 that was reported\nby Lockheed Martin, and attributed it to a Chinese APT (Zirconium / APT31).\nApril 14, 2017 – Lost in Translation leak is published.\nMay 9, 2017 – Patch Tuesday: Second round of Equation Group patches includes a\n**silent fix for the EpMo Equation Group exploit.**\n\n## Summary\n\n\n-----\n\nWe began with analyzing “Jian”, the Chinese (APT31 / Zirconium) exploit for CVE-20170005, which was reported by Lockheed Martin’s Computer Incident Response Team. To\nour surprise, we found out that this APT31 exploit is in fact a reconstructed version\n**of an Equation Group exploit called “EpMe”. This means that an Equation Group**\nexploit was eventually used by a Chinese-affiliated group, probably against American\ntargets.\n\nThis isn’t the first documented case of a Chinese APT using an Equation Group 0-Day.\nThe first was when APT3 used their own version of EternalSynergy (called UPSynergy),\nafter acquiring the Equation Group EternalRomance exploit. However, in the UPSynergy\ncase, the consensus among our group of security researchers as well as in Symantec was\nthat the Chinese exploit was reconstructed from captured network traffic.\n\nThe case of EpMe / Jian is different, as we clearly showed that Jian was constructed from\nthe actual 32-bits and 64-bits versions of the Equation Group exploit. This means that in\nthis scenario, the Chinese APT acquired the exploit samples themselves, in all of\ntheir supported versions. Having dated APT31’s samples to 3 years prior to the Shadow\nBroker’s “Lost in Translation” leak, our estimate is that these Equation Group exploit\nsamples could have been acquired by the Chinese APT in one of these ways:\n\nCaptured during an Equation Group network operation on a Chinese target.\nCaptured during an Equation Group operation on a 3rd-party network which was\nalso monitored by the Chinese APT.\nCaptured by the Chinese APT during an attack on Equation Group infrastructure.\n\nWhile reviewing the NtElevation exploits used in Equation Group’s DanderSpritz postexploitation framework, we found 4 Windows LPE exploits. The first two NtElevation\nexploits were font vulnerabilities that were previously discussed as part of the Houston\ndisk (an earlier sample attributed to Equation Group). In addition, EpMe (CVE-20170005) was mentioned and patched when Jian was caught, even if at that point in time the\ntrue origins of it weren’t yet known.\n\nFinally, although EpMo was indeed patched by Microsoft in May 2017, we couldn’t trace\nthe CVE-ID that was assigned to the patched vulnerability. Not only that, to our\nknowledge, our publication is the first to even mention the existence of this Equation\n[Group exploit, even though it was publicly accessible on GitHub for the last 4 years.](https://github.com/x0rz/EQGRP_Lost_in_Translation/blob/6692b1486f562f027567a49523b8c151a4050988/windows/Resources/Dsz/Modules/Files-dsz/x64-winnt-vc9s/release/Mcl_NtElevation_EpMo_GrSa.dll)\n\nThese are our new additions to the attribution map:\n\n**EpMe (CVE-2017-0005) – An Equation Group exploit that was cloned by APT31,**\nthus causing CVE-2017-0005 to be attributed to the latter, instead of to Equation\nGroup.\n**EpMo – An additional Equation Group exploit that was never discussed before.**\n**Jian – APT31’s cloned version of EpMe, which was caught-in-the-wild by Lockheed**\nMartin’s IRT.\n\n\n-----\n\n**CVE-2019-0803 – Attributed by multiple sources to a Chinese State-Sponsored**\nActor.” We showed that it shares the same exploit loader (and tool API) as APT31’s\nJian.\n\n## Appendix – IOC Table\n\n### Jian – CVE-2017-0005:\n\n**Jian:** `AE512F13136774B4AAB79EBCC378927143BE77181E3B256E6F9940CE73696DE4`\n\n### CVE-2019-0803:\n\n**tools.dll:**\n\n```\n68A3710765DA1886F00E40F2D5E02776D224C77AEA114CD22C3A6204A7FAD363\n\n```\n\n**2008.dll:**\n\n```\n279320EE5C3B2DA4364AFBACBE5286EC4EED9AB5E887D4E0B9AAB2EB618BC539\n\n```\n\n## Equation Group Exploits:\n\n**Note: There are several variants of each exploit in the leak. The following are single**\nexamples of each exploit.\n\n**Houston Disk:**\n```\n868EB363F32BEACD8BCDC7A114E020D4CFE67913A15275F4E7493D87DB643FF2\n\n```\n**DanderSpritz – ElEi:**\n\n```\nC99FFACBA6D6689F7934E6E912E36EFCC4BD6A09C8A4D1E43BB27C3AFD131882\n\n```\n\n**DanderSpritz – ErNi:**\n\n```\nE4FBF75ABF928CD1C9073656A61755FD3F0C25DC2E7922FB5073E1F64E5E9161\n\n```\n\n**DanderSpritz – EpMo:**\n\n```\n1537CAD1D2C5154E142AF775ED555D6168D528BBE40B31F451EFA92C9E4F02DE\n\n```\n\n**DanderSpritz – EpMe (CVE-2017-0005):**\n\n```\n634A80E37E4B32706AD1EA4A2FF414473618A8C42A369880DB7CC127C0EB705E\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.02.22.APT31_Equation_Group/research.checkpoint.com-The%20Story%20of%20Jian%20%20How%20APT31%20Stole%20and%20Used%20an%20Unknown%20Equation%20Group%200-Day.pdf"
    ],
    "report_names": [
        "research.checkpoint.com-The Story of Jian  How APT31 Stole and Used an Unknown Equation Group 0-Day"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d4f7cf97-9c98-409c-8b95-b80d14c576a5",
            "created_at": "2022-10-25T16:07:24.561104Z",
            "updated_at": "2025-03-27T02:02:10.281202Z",
            "deleted_at": null,
            "main_name": "Shadow Brokers",
            "aliases": [],
            "source_name": "ETDA:Shadow Brokers",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "61c4ddc4-156b-4828-8570-0979da81f3d0",
            "created_at": "2022-10-25T16:47:55.593828Z",
            "updated_at": "2025-03-27T02:05:17.275161Z",
            "deleted_at": null,
            "main_name": "BRONZE MAYFAIR",
            "aliases": [
                "Gothic Panda ",
                "TG-0110 ",
                "APT3 "
            ],
            "source_name": "Secureworks:BRONZE MAYFAIR",
            "tools": [
                " HUC Proxy Malware (Htran)",
                " Pirpi",
                " SplitVPN",
                " ctt",
                " ctx",
                "Cookiecutter"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "761d1fb2-60e3-46f0-9f1c-c8a9715967d4",
            "created_at": "2023-01-06T13:46:38.269054Z",
            "updated_at": "2025-03-27T02:00:02.789278Z",
            "deleted_at": null,
            "main_name": "APT3",
            "aliases": [
                "TG-0110",
                "Group 6",
                "Buckeye",
                "Boyusec",
                "BORON",
                "BRONZE MAYFAIR",
                "Red Sylvan",
                "GOTHIC PANDA"
            ],
            "source_name": "MISPGALAXY:APT3",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "08623296-52be-4977-8622-50efda44e9cc",
            "created_at": "2023-01-06T13:46:38.549387Z",
            "updated_at": "2025-03-27T02:00:02.859535Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "Tilded Team",
                "EQGRP",
                "G0020"
            ],
            "source_name": "MISPGALAXY:Equation Group",
            "tools": [
                "EquationLaser",
                "EquationDrug",
                "DoubleFantasy",
                "TripleFantasy",
                "GrayFish"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "13354d3f-3f40-44ec-b42a-3cda18809005",
            "created_at": "2022-10-25T15:50:23.275272Z",
            "updated_at": "2025-03-27T02:00:55.418075Z",
            "deleted_at": null,
            "main_name": "APT3",
            "aliases": [
                "APT3",
                "Gothic Panda",
                "Pirpi",
                "UPS Team",
                "Buckeye",
                "Threat Group-0110",
                "TG-0110"
            ],
            "source_name": "MITRE:APT3",
            "tools": [
                "OSInfo",
                "schtasks",
                "PlugX",
                "LaZagne",
                "SHOTPUT",
                "RemoteCMD"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "171b85f2-8f6f-46c0-92e0-c591f61ea167",
            "created_at": "2023-01-06T13:46:38.830188Z",
            "updated_at": "2025-03-27T02:00:02.929729Z",
            "deleted_at": null,
            "main_name": "The Shadow Brokers",
            "aliases": [
                "Shadow Brokers",
                "ShadowBrokers",
                "The ShadowBrokers",
                "TSB"
            ],
            "source_name": "MISPGALAXY:The Shadow Brokers",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "aacd5cbc-604b-4b6e-9e58-ef96c5d1a784",
            "created_at": "2023-01-06T13:46:38.953463Z",
            "updated_at": "2025-03-27T02:00:02.961301Z",
            "deleted_at": null,
            "main_name": "APT31",
            "aliases": [
                "JUDGMENT PANDA",
                "BRONZE VINEWOOD",
                "Red keres",
                "Violet Typhoon",
                "TA412"
            ],
            "source_name": "MISPGALAXY:APT31",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2d9fbbd7-e4c3-40e5-b751-27af27c8610b",
            "created_at": "2024-05-01T02:03:08.144214Z",
            "updated_at": "2025-03-27T02:05:17.419705Z",
            "deleted_at": null,
            "main_name": "PLATINUM COLONY",
            "aliases": [
                "Equation Group "
            ],
            "source_name": "Secureworks:PLATINUM COLONY",
            "tools": [
                " EquationDrug",
                " EquationLaser",
                " Fanny",
                " GrayFish",
                " TripleFantasy",
                "DoubleFantasy"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "9e6186dd-9334-4aac-9957-98f022cd3871",
            "created_at": "2022-10-25T15:50:23.357398Z",
            "updated_at": "2025-03-27T02:00:55.452383Z",
            "deleted_at": null,
            "main_name": "ZIRCONIUM",
            "aliases": [
                "APT31",
                "Violet Typhoon"
            ],
            "source_name": "MITRE:ZIRCONIUM",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3fff98c9-ad02-401d-9d4b-f78b5b634f31",
            "created_at": "2023-01-06T13:46:38.376868Z",
            "updated_at": "2025-03-27T02:00:02.818071Z",
            "deleted_at": null,
            "main_name": "Cleaver",
            "aliases": [
                "Cobalt Gypsy",
                "G0003",
                "Operation Cleaver",
                "Op Cleaver",
                "Tarh Andishan",
                "Alibaba",
                "TG-2889"
            ],
            "source_name": "MISPGALAXY:Cleaver",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "06f622cb-3a78-49cf-9a4c-a6007a69325f",
            "created_at": "2022-10-25T16:07:23.315239Z",
            "updated_at": "2025-03-27T02:02:09.733197Z",
            "deleted_at": null,
            "main_name": "APT 3",
            "aliases": [
                "APT 3",
                "Bronze Mayfair",
                "Buckeye",
                "Gothic Panda",
                "Group 6",
                "Operation Clandestine Fox",
                "Operation Clandestine Fox, Part Deux",
                "Operation Clandestine Wolf",
                "Operation Double Tap",
                "Red Sylvan",
                "TG-0110",
                "UPS Team"
            ],
            "source_name": "ETDA:APT 3",
            "tools": [
                "APT3 Keylogger",
                "Agent.dhwf",
                "BKDR_HUPIGON",
                "Backdoor.APT.CookieCutter",
                "Badey",
                "Bemstour",
                "CookieCutter",
                "Destroy RAT",
                "DestroyRAT",
                "DoublePulsar",
                "EXL",
                "EternalBlue",
                "HTran",
                "HUC Packet Transmit Tool",
                "Hupigon",
                "Hupigon RAT",
                "Kaba",
                "Korplug",
                "LaZagne",
                "MFC Huner",
                "OSInfo",
                "Pirpi",
                "PlugX",
                "RedDelta",
                "RemoteCMD",
                "SHOTPUT",
                "Sogu",
                "TIGERPLUG",
                "TTCalc",
                "TVT",
                "Thoper",
                "Xamtrav",
                "remotecmd",
                "shareip",
                "w32times"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e0fed6e6-a593-4041-80ef-694261825937",
            "created_at": "2022-10-25T16:07:23.593572Z",
            "updated_at": "2025-03-27T02:02:09.879892Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "APT-C-40",
                "Platinum Colony",
                "Tilded Team"
            ],
            "source_name": "ETDA:Equation Group",
            "tools": [
                "Bvp47",
                "DEMENTIAWHEEL",
                "DOUBLEFANTASY",
                "DanderSpritz",
                "DarkPulsar",
                "DoubleFantasy",
                "DoubleFeature",
                "DoublePulsar",
                "Duqu",
                "EQUATIONDRUG",
                "EQUATIONLASER",
                "EQUESTRE",
                "Flamer",
                "GRAYFISH",
                "GROK",
                "OddJob",
                "Plexor",
                "Prax",
                "Regin",
                "Skywiper",
                "TRIPLEFANTASY",
                "Tilded",
                "UNITEDRAKE",
                "WarriorPride",
                "sKyWIper"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "774f15f7-832e-4cd4-a1fa-ec6a838f2a40",
            "created_at": "2022-10-25T16:47:55.641406Z",
            "updated_at": "2025-03-27T02:05:17.29791Z",
            "deleted_at": null,
            "main_name": "BRONZE VINEWOOD",
            "aliases": [
                "Judgment Panda ",
                "ZIRCONIUM ",
                "APT31 "
            ],
            "source_name": "Secureworks:BRONZE VINEWOOD",
            "tools": [
                " HanaLoader",
                " Metasploit",
                " Mimikatz",
                " Reverse ICMP shell",
                " Trochilus",
                "DropboxAES RAT"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "dc7ee503-9494-4fb6-a678-440c68fd31d8",
            "created_at": "2022-10-25T16:07:23.349177Z",
            "updated_at": "2025-03-27T02:02:09.748159Z",
            "deleted_at": null,
            "main_name": "APT 31",
            "aliases": [
                "APT 31",
                "Bronze Vinewood",
                "Judgment Panda",
                "Red Keres",
                "RedBravo",
                "TA412",
                "Violet Typhoon",
                "Zirconium"
            ],
            "source_name": "ETDA:APT 31",
            "tools": [
                "9002 RAT",
                "Agent.dhwf",
                "AngryRebel",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "GrewApacha",
                "HOMEUNIX",
                "HiKit",
                "HidraQ",
                "Homux",
                "Hydraq",
                "Kaba",
                "Korplug",
                "McRAT",
                "MdmBot",
                "Moudour",
                "Mydoor",
                "PCRat",
                "PlugX",
                "RedDelta",
                "Roarur",
                "Sakula",
                "Sakula RAT",
                "Sakurel",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Trochilus RAT",
                "Xamtrav"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716491,
    "ts_updated_at": 1743041804,
    "ts_creation_date": 1614052525,
    "ts_modification_date": 1614052525,
    "files": {
        "pdf": "https://archive.orkl.eu/98742dcad26eb4051bba977be4fe8bd6c6b140b1.pdf",
        "text": "https://archive.orkl.eu/98742dcad26eb4051bba977be4fe8bd6c6b140b1.txt",
        "img": "https://archive.orkl.eu/98742dcad26eb4051bba977be4fe8bd6c6b140b1.jpg"
    }
}