{
    "id": "55170975-4f80-45c7-8eca-7d0d454f2811",
    "created_at": "2023-01-12T15:05:29.907958Z",
    "updated_at": "2025-03-27T02:05:52.155168Z",
    "deleted_at": null,
    "sha1_hash": "3b5a41029138678c44553b50ac039857fa2c4a4c",
    "title": "2018-05-24 - Phorpiex – A decade of spamming from the shadows",
    "authors": "",
    "file_creation_date": "2022-05-28T19:50:54Z",
    "file_modification_date": "2022-05-28T19:50:54Z",
    "file_size": 1935532,
    "plain_text": "# Phorpiex – A decade of spamming from the shadows\n\n**[proofpoint.com/us/threat-insight/post/phorpiex-decade-spamming-shadows](https://www.proofpoint.com/us/threat-insight/post/phorpiex-decade-spamming-shadows)**\n\n\nMay 24, 2018\n\n\n-----\n\n[Blog](https://www.proofpoint.com/us/blog)\n[Threat Insight](https://www.proofpoint.com/us/blog/threat-insight)\nPhorpiex – A decade of spamming from the shadows\n\n\n-----\n\nMay 24, 2018 Proofpoint Staff\n\n**Overview**\n\nProofpoint researchers have recently begun tracking the Phorpiex/Trik botnet (SDBot fork, referred to\nas Trik throughout this post) as several sophisticated actors have been using it to distribute a range of\nmalware. Despite the recent attention, though, Trik, not to be confused with the TrickBot banking Trojan, is a\nrelatively old botnet. It is not especially sophisticated or complex but has been active for almost a decade,\nflying under the radar and attracting a solid customer base of threat actors. As we began tracking this botnet\nmore closely, we discovered that a number of familiar actors were repeatedly leveraging Trik’s power and\ndistribution capabilities for delivery of their malware.\n\nAnalysis shows that Trik has been present for a decade and first began spreading via Windows Live\nMessenger and removable USB storage. It later began including Skype in its worming capabilities but this\nappears to have stopped a few years ago and Trik now propagates via removable media storage and email\nspam.\n\nDuring the initial investigation of this botnet, we observed the bot version included in\nthe PDB string associated with the malware. Pivoting on this data point, we identified several more versions,\nall spanning a timeframe of over five years. However, there is no real noticeable difference\nbetween bot versions; the version is more likely to increment when there is a change in infrastructure as\nopposed to a feature being added or a technique being modified within the bot itself.\n\n**Meet the customers**\n\nMalware families associated with recent Trik activity include GandCrab, Pushdo (which in turn\ndownloads Cutwail), Pony, Trik updates, and various coin miners. Some of these, like coin miners, are not\ndistributed by Trik in spam but are, instead, sent to the hosts infected with Trik and\nexecuted, likely for improved monetization of the botnet for the operator. Taking a single day as an\nexample, on May 9 we observed instructions to download and distribute GandCrab, Pony, Pushdo,\nand multiple coin miners being sent to the botnet.\n\n**The bot, infrastructure, and sinkholing**\n\nMost of the bot’s internals were already documented in a blog post from 2016 [1]; little has changed since\nthat post with respect to how the bot operates. However, one important difference between the 2016 Trik and\nthe current version of Trik is that operators have backtracked in sophistication by removing the anti\n\n-----\n\nVM code from most of the samples we detected. However, they retained some of these features in other\nsamples, including a version that uses a .NET loader and performs very basic anti-analysis.\n\nProofpoint initially observed the aforementioned .NET loader variant several months prior to this investigation\nand discovered that it had been attempting to connect to an abuse.ch sinkhole after they had registered\nseveral of Trik's C&C domains. We suspect that this version is still in circulation as a result of Trik’s worming\ncapabilities. We observed additional sinkholing activity at the end of April 2018 and the beginning\nof May 2018. Shortly thereafter, the Trik operators immediately stood up another four C&Cs, some of which\nare being reused from prior months, dating as far back 2016. Shortly thereafter, the operators resumed\nsending campaigns -- in this case distributing GandCrab.\n\nTrik nodes communicate with their C&C servers using the IRC protocol and campaign payloads are sent to\nthe bot in an encrypted state using a custom implementation of RC4. We have also observed\nseveral C&C servers that are active and spamming daily, each with a maximum bot count of 1024. Any\nconnections to the botnet servers when the servers are full will result in a TCP packet with the RST flag set\nand, sometimes, an error message stating that the server has reached its maximum count of 1024 clients. We\nalso noticed that, shortly after a spam campaign, the C&Cs would close their C&C port until the following\nday at which point it would re-open, ready for a new campaign.\n\nWe observed version v5.0 of the bot both during the GandCrab campaigns noted\nabove and being sinkholed in April and May. The PDB string for this version of Trik is shown in Figure 1.\n\n_Figure 1: Trik v5.0 PDB_\n\nHowever, v6.0 had already appeared prior to this activity with no changes to the codebase or infrastructure.\n\n_Figure 2: Trik v6.0 doc PDB_\n\nThe only noticeable difference between these PDBs is the inclusion of ‘doc’. We observed another similar\nv6.0 PDB containing ‘js’ which, when analyzed, was associated with spam\ncampaigns sending .js attachments. While the PDB should not be relied upon exclusively, it may be an\nindication of which file types were distributed in any given campaign, especially considering that these bots\nlast for a single campaign before they are recycled.\n\n_Figure 3: Trik v6.0 js PDB_\n\n**Return of the .NET loader variant**\n\nOn May 23, 2018, we observed the return of a slightly different, older version of Trik (v2.5, see Figure 4). This\nversion of Trik uses a .NET loader that has the main bot split into several encrypted pieces saved in the\nresources of the NET loader Once the main bot is pieced together and decrypted the differences between\n\n\n-----\n\nthe bots is fairly obvious. In particular, the PDB shows a much older version and has a different user\ncompared to the v5.0 and v6.0 bots. Additionally, this version has never been observed outside of the .NET\nloader version. Based on samples analyzed over the past few years, if this bot has this PDB, it appears to be\nexclusively associated with the .NET loader, whereas v5.0 and v6.0 have never been paired with the .NET\nloader. This begins to raise questions in terms of attribution and, initially, it appeared as though there may be\nseveral operators running different versions of Trik. However, after several days of downtime, the return of the\n.NET loader version is now using the same C&C server as version v6.0. While the .NET loader itself is not\nparticularly new, this version of Trik being pointed at a live C&C is new because, prior to this activity, we\nobserved all .NET loaders communicating with sinkhole servers for several months.\n\n_Figure 4: Trik v2.5PDB from .NET loader variant_\n\nThere are slight differences between versions in the behavior of the bot on the infected host. As noted, the\nfirst difference is that v2.5 still carries basic anti-analysis techniques that were observed in Trik several years\nago whereas v5.0 and v6.0 do not include anti-analysis features.\n\n\n-----\n\n_Figure 5: Execution flow of Trik’s anti-analysis_\n\nTrik utilizes several methods to determine whether it is being executed within a lab, but these techniques are\ntrivial to bypass. Version v2.5 of Trik performs the following:\n\nSnapshot current running process, query a hardcoded list of common analysis tools, and then try to\nmatch one of them to one of the current running process names.\n\nQuery each entry in a hardcoded list of executable names for common file names when dealing with\nmalware.\n\nCheck the name of the current folder to determine whether the name implies that Trik is in an analysis\nenvironment.\n\nAttempt to establish a handle to each of the tools to determine if they are running\n\nUtilize the FindWindow API call with its list of hardcoded process names in attempt to find any of the\nanalysis tools listed.\n\nQuery a list of hardcoded users to determine if the current user matches any in the list\n\n\n-----\n\nQuery Kernel32.dll and attempt to resolve the address of wine_get_unix_file_name to determine\nwhether Wine is present.\n\nDetermine if it is being debugged with IsDebuggerPresent.\n\nFinally, as described in the 2016 blog post [1], Trik will query the properties of storage devices and\nattempt to match several strings to what it finds in the STORAGE_DESCRIPTOR_TABLE.\n\nEach of the described techniques have their search strings listed in Appendix 1. If any of these checks returns\ntrue, Trik will exit but only once each of the checks has been completed. If these checks all return\nfalse, Trik will continue with execution. The only exception to the above is the final check, which happens\nafter Trik has created its mutex and generated its IRC NICK.\n\n_Figure 6: Showing the application exit if Trik determines it is being analyzed_\n\n**Email templates**\n\nTrik’s email templates are straightforward and are hardcoded into the bot; they have not changed\nfor several years, with randomly chosen, hardcoded email subjects (Figure 7).\n\n_Figure 7: Trik email subjects_\n\nAdditionally, the body of Trik spam emails has not changed in several years and has been observed in several\ncampaigns including Andromeda spam campaigns in Q4 2017.\n\n\n-----\n\n_Figure 8: Trik email body and signature_\n\nThe email closing, however, does change for each message sent by the bot. Trik generates 3 random letters,\nconverts them to uppercase, and prepends them to the email signature (‘aCustomerSuppor’ string in the\nabove screenshot, “Customer Support\\r\\n\\r\\n”). This behavior is shown below.\n\n_Figure 9: Function snippet showing 3 character random generation for spam email signature_\n\nThe resulting email template looks similar to those from a GandCrab campaign on April 23, 2018, with the\ncustomer support line varying.\n\n\n-----\n\n_Figure 10: Trik email from the April 23rd 2018 GandCrab campaign_\n\nSender names are randomly selected from two lists of first names and surnames, both hardcoded in\nevery Trik binary we have observed so far, as opposed to other spam botnets that tend to send lists from\nthe C&C at the beginning of a campaign. The sender emails in these campaigns follow a very basic and\nobvious structure: <hardcoded name in the EXE>[0-9]{2}@[0-9]{4}.com\n\nSome of the sender addresses observed in the April 23 GandCrab campaign include:\n\nHumberto Anderson <Humberto63@8117.com>\n\nGlenn Murphy <Glenn99@3968.com>\n\nBobbie Adams <Bobbie57@9223.com>\n\n\n-----\n\n_Figure 11: Hardcoded names used for spam email sender names_\n\n**Traffic Analysis**\n\n\n-----\n\nTrik s command and control uses the IRC protocol and, as previously documented, the C&C traffic flow for\nthese bots is as follows:\n\nInitially join a hardcoded IRC channel on the C&C with nickname in format: a pipe enclosed ISO Alpha-3\ncountry code followed by a randomly generated string of [a-z].\n\nIf a bot exists with the same NICK, the botnet responds with the code ‘433’ which forces the bot to retry\nwith a new, randomly generated NICK.\n\nOnce the bot has joined the server, it immediately receives a list of instructions which are\ntypically used to join additional channels or close the connection.\n\nSeveral different channels have been observed and they appear to rotate on a daily basis.\n\nUpon joining these additional channels, the bot is provided several encrypted URLs that contain\nmalicious payloads. These payloads are then downloaded by the bot and either executed on the host\ninfected with Trik or sent in spam email campaigns, depending on the task specified by the botnet.\n\nFigure 12 shows a sample of the traffic from this botnet.\n\n_Figure 12: Pcap snippet highlighting RC4 encrypted URLs (payload locations) sent to the bot for either_\n_execution on the system infected by the bot or to be distributed in email spam campaigns._\n\nThe encrypted URLs sent from the botnet are the snippets of decimals in the form of pipe-enclosed\ndigits. These URLs are encrypted with a custom implementation of RC4 and can be decrypted with the\nfollowing modified RC4 implementation in Python:\n\n\n-----\n\n_Figure 13: Pseudo-code of the custom RC4 implementation_\n\n_Figure 14: Python decryptor output_\n\n\n-----\n\n_Figure 15: Custom RC4 decryption Python script_\n\n\n-----\n\nThe tasks mentioned previously are referring to the commands that follow 332 and .d . In this case, .d is the\ndownload command -- one of many different commands supported by Trik’s bots -- and when followed by ‘x’,\nthe downloaded payload will execute on the host infected with Trik. When followed by ‘u’, the infected host will\ndownload the payload, execute that payload, and quit the current process. Trik uses this process to handle\nbot updates and prepare for the next campaign. We observed Trik bots downloading updates that contained\nhardcoded channels the bot would have to join to receive the new campaign payloads. Once the campaign\nends, the bot listens for PINGs, as you would expect with the standard IRC protocol, until a new update is\nissued and the cycle repeats.\n\nIn some cases, we observed several payloads after the initial connection but for the most part, only 2-3\npayloads were downloaded per campaign.\n\n_Figure 16: Another traffic example highlighting 5 encrypted URLs that are hosting various different payloads_\n\nTrik uses a layer of SOCKS proxies to hide the real C&C servers. We observed other malware\nincluding Ursnif using the same proxies.\n\n**Conclusion**\n\nDespite being a decade old and using IRC as a command and control protocol, Trik remains an active and\npowerful botnet based on the types of malware that it is distributing. Many different malware families have\nbeen being distributed by Trik and this activity appears to be ramping up with multiple daily campaigns. We\nwill continue to monitor Trik activity as actors increasingly rely on this infrastructure.\n\n**References**\n\n[1] https://www.johannesbader.ch/2016/02/phorpiex/\n\n**ET and ETPRO Suricata/Snort Signatures**\n\n2008124 - ET TROJAN Likely Bot Nick in IRC (USA +..)\n\n2017319 - ET CURRENT_EVENTS SUSPICIOUS IRC - NICK and 3 Letter Country Code\n\n2801390 - ETPRO TROJAN Malware Worm.Win32.Phorpiex.A Activity\n\n2826005 - ETPRO TROJAN MSIL/Trik Backdoor IRC Checkin\n\n\n-----\n\n2821422 - ETPRO TROJAN Win32.Phorpiex.A EXE Download\n\n**Indicators of Compromise (IOCs)**\n\nIOC IOC\nType\n\n92.63.197.106:5050 IP\nAddress\n\n112.126.94.107:5050 IP\nAddress\n\n123.56.228.49:5050 IP\nAddress\n\n220.181.87.80:5050 IP\nAddress\n\n185.189.58.222:5050 IP\nAddress\n\n\nDescription\n\nTrik/Pony C&C\n\nTrik C&C\n\nTrik C&C\n\nTrik C&C\n\nTrik C&C\n\n\nauoegfiaefuageudn.ru:5050 Domain Trik/Pony C&C\n\n7ba150c8808edf187a1ccf8d0532d0732fff2bbe28f76d6e2f02f8196669dd06 SHA256 Pony sample from\nMay 15th 2018\n\n0b4996c03b059d1a10349f715b6b21ad9926912faae834581f0c96b24ff1b33f SHA256 Pushdo sample\nfrom May\n9th 2018\n\n9f3f80167c5d39efb9e81507efec6d9bdc5e31323f9d6d89630374c7fe490f33 SHA256 GandCrab sample\nfrom May\n9th 2018\n\nef1563a962d2d86ceb1dd09056f87fcab4c32e3ca6481c51950d3b6db49d1087 SHA256 Trik sample from\nMay 9th 2018\n\n5bf79a111467a85abe57f1f3e92f2279b277cccae53ed28c584267717ba372f8 SHA256 Trik sample from\nMay 12th 2018\n\n2035ef02a014f9ae2a21d39c98604ca4863d77c47dcc12d31bb9b7b2d3e5fc98 SHA256 Trik sample from\nMay 18th 2018\n\n3df16261b28f30683dce6a66331452f4ddc1d3472fb194ff5b505270a8f64311 SHA256 Trik sample from\nMay 19th 2018\n\n**Appendix 1 – Anti-analysis strings**\n\n\n-----\n\nRunning processes\n\nMsseces.exe\n\nMrt.exe\n\nMsascui.exe\n\nRstrui.exe\n\nWuauclt.exe\n\nWireshark.exe\n\nNetstat.exe\n\nNetmon.exe\n\nNetworkminer.exe\n\nTnm.exe\n\nSbiectrl.exe\n\nSbiesvc.exe\n\nJoeboxserver.exe\n\nJoeboxcontrol.exe\n\nVirtualbox.exe\n\nWpePro.exe\n\nTcpview.exe\n\nModules\n\nSbiedll.dll\n\nSbiedllx.dll\n\nVboxhook.dll\n\nWpespy.dll\n\nVmcheck.dll\n\nWindow titles\n\nOllydbg\n\nPortmonclass\n\nProcexplr\n\nGdkwindowtoplevel\n\n\n-----\n\nCurrent users\n\nTest\n\nHoney\n\nVmware\n\nMalware\n\nLab\n\nSandbox\n\nTestuser\n\nCurrentuser\n\nPotentially renamed malware names\n\nSample.exe\n\nMalware.exe\n\nTest.exe\n\nCurrent folder\n\n\\LAB\n\n\\MALWARE\n\n\\VIRUS\n\n\\SAMPLE\n\n\\TEST\n\nSubscribe to the Proofpoint Blog\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-05-24 - Phorpiex – A decade of spamming from the shadows.pdf"
    ],
    "report_names": [
        "2018-05-24 - Phorpiex – A decade of spamming from the shadows.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535929,
    "ts_updated_at": 1743041152,
    "ts_creation_date": 1653767454,
    "ts_modification_date": 1653767454,
    "files": {
        "pdf": "https://archive.orkl.eu/3b5a41029138678c44553b50ac039857fa2c4a4c.pdf",
        "text": "https://archive.orkl.eu/3b5a41029138678c44553b50ac039857fa2c4a4c.txt",
        "img": "https://archive.orkl.eu/3b5a41029138678c44553b50ac039857fa2c4a4c.jpg"
    }
}