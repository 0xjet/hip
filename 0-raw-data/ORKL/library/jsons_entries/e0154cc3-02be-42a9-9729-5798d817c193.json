{
    "id": "e0154cc3-02be-42a9-9729-5798d817c193",
    "created_at": "2023-01-12T14:59:01.656633Z",
    "updated_at": "2025-03-27T02:15:24.915609Z",
    "deleted_at": null,
    "sha1_hash": "fbae5ee2e6151a2c1ec85fbe85e359ca0724cdc0",
    "title": "2015-11-16 - Introducing LogPOS",
    "authors": "",
    "file_creation_date": "2022-10-02T12:11:11Z",
    "file_modification_date": "2022-10-02T12:11:11Z",
    "file_size": 514398,
    "plain_text": "# securitykitten.github.io/_posts/2015-11-16-logpos-new- point-of-sale-malware-using-mailslots.md\n\n**github.com/malware-kitten/securitykitten.github.io/blob/master/_posts/2015-11-16-logpos-new-point-of-sale-malware-**\nusing-mailslots.md\n\nmalware-kitten\n\nCannot retrieve contributors at this time\n\n**layout** **title** **excerpt** **date**\n\n\ncategorypost\n\n\nIntroducing\nLogPOS\n\n\nNew Point of Sale\nMalware Using Mailslots\n\n\n2015-11-15\n16:00:00 -0800\n\n\n## Introduction\n\nThere has been an explosion in POS malware in the last year. At\nMorphick, Nick Hoffman and I found 2 undiscovered families in 2014 and\nwe just found our first new family of 2015. This new malware which we're\ncalling LogPOS has several notable differences from recent POS malware.\n\nThe hash that we'll be pulling apart in this post is\n```\naf13e7583ed1b27c4ae219e344a37e2b .\n\n```\n\n-----\n\n## Diving In\n\nAlmost immediately when looking at this sample, a string jumped out ```\n\\\\.\\mailslot\\LogCC .\n\n```\nIn most POS variants, one process scrapes memory from other processes\nand writes discovered track data to a log. Because LogPOS injects code\ninto various processes and has each of them search their own memory, it\ncan’t use a log, since they can’t all open the same file with write access at\nonce. Instead, it uses mailslots.\n\nUsing mailslots for communication/storage isn't a new mechanism for\nmalware, in FireEye's report on APT28 there is mention of the group using\na mailslot with a name of `check_mes_v5555 . Mailslots are an IPC`\nmechanism allowing multiple clients to send messages to a server. In this\ncase, the main executable creates the mailslot and acts as the mailslot\nserver, while the code injected into the various processes acts as a client,\nwriting carved credit card numbers to the mailslot for direct transmission to\nthe C2.\n\nEarly in the execution of the program, there is a call to CreateMailslotA\nwith an mailslot name of `\\\\.\\mailslot\\LogCC .`\n\nIf the mailslot fails to be created, the program will exit. If the mailslot\nsucceeds the program will enter an infinite loop performing the following\nfunctions.\n```\n  Sleeping 500 milliseconds\n\n  Iterating over processes\n\n    Comparing against a whitelist\n\n    Inject shellcode into the process (if not in whitelist)\n\n    Scanning for credit card track information\n\n    Validation using Luhn's\n\n  Reading from the mailslot\n\n  POST'ing out the data\n\n\n```\nThe most interesting thing is the injected code, so we'll look at that in more\ndetail below.\n\n\n-----\n\nWhile iterating over the processes (as mentioned above) the malware will\ncheck the process name against a whitelist containing the following\nnames.\n\nwindbg.exe\nlogounui.exe\ntaskmgr.exe\nskype.exe\nthunderbird.exe\ndevenv.exe\nsteam.exe\nwinlogon.exe\nwininit.exe\ncsrss.exe\nsmss.exe\nsvchost.exe\nfirefox.exe\nchrome.exe\nexplorer.exe\npsi.exe\npidgin.exe\nSystem\n\nThe code to compare the strings can be seen below:\n\n\n-----\n\nOnce a program that is not in the whitelist is found, code is injected into it's\nmemory space using WriteProcessMemory. The first thing that this\nshellcode does is crawl to find the base of kernel32, this is used to start\nbuilding imports. The method for finding kernel32 is a well documented\none that has been discussed in many research blogs.\n\nOnce the base is found, the shellcode will begin to rebuild it's imports via\nit's own hashing technique. A list of some of the hashes and their values\nare:\n\n\n-----\n\nAfter building the imports, the malware will call CreateFileA with a filename\nof \\.\\mailslot\\LogCC to obtain a handle for writing.\n\n\n-----\n\nWhen scanning memory, the malware will use a custom search to find\ncommon sentinels for track information.\n\nInformation is passed to an implementation of Luhn's algorithm for\nvalidation. Once hits are located, they are sent to the mailslot where the\nmain program will read them. When a number is added (on a schedule)\nthe malware will build a format string and post the information to a remote\nsite. (Note, the site has been redacted, due to live numbers currently being\nposted there)\n\nThe data is then sent to a remote site (via HTTP GET)\n\n\n-----\n\nThe results are populated in a table (at the time of this writing the form is\nnot password protected and the results can be seen). A majority of the hits\nare in the process space of rdpclip and notepad leading us to believe that\nthe author is currently testing their code. A screenshot of the panel with\nIP's can be seen below:\n\n## Detection\n\nLogPOS avoids a traditional detection mechanism of scanning files for\nunencrypted credit card information by instead writing to a mailslot.\nHowever, using a tool like yara, it is easy to detect variants of this\nmalware. The following rule will assist in finding this malicious tool on your\nnetwork.\n```\nrule LogPOS\n\n{\n\n  meta:\n\n    author = \"Morphick Security\"\n\n    description = \"Detects Versions of LogPOS\"\n\n    md5 = \"af13e7583ed1b27c4ae219e344a37e2b\"\n\n  strings:\n\n    $mailslot = \"\\\\\\\\.\\\\mailslot\\\\LogCC\"\n\n    $get = \"GET /%s?encoding=%c&t=%c&cc=%I64d&process=\"\n\n    //64A130000000   mov eax, dword ptr fs:[0x30]\n\n    //8B400C    mov eax, dword ptr [eax + 0xc]\n\n    //8B401C    mov eax, dword ptr [eax + 0x1c]\n\n    //8B4008    mov eax, dword ptr [eax + 8]\n\n    $sc = {64 A1 30 00 00 00 8B 40 0C 8B 40 1C 8B 40 08 }\n\n  condition:\n\n    $sc and 1 of ($mailslot,$get)\n\n}\n\n```\n\n-----\n\nIn addition to yara, this POS malware can be detected with its URI pattern.\nThe following bro signature will detect this malware from a network\nperspective.\n```\nsignature LogPOS { \n\n  #source: Morphick Security\n\n  #version: 1\n\n  #Ref: af13e7583ed1b27c4ae219e344a37e2b\n\n  ip-proto == tcp\n\n  dst-port == 80,443\n\n  http-request\n/.*encoding\\=.*\\&t\\=.*\\&cc\\=.*\\&process\\=.*\\&track\\=/\n\n  event \"LogPOS Credit Card GET Request Pattern\"\n\n}\n\n\n## Conclusion\n\n```\nPOS malware has been getting attention on a lot of fronts. TrendMicro\nrecently reported that there have been more new POS variants discovered\nin the last 6 months than the last several years.\n\nFor example, earlier this year Josh Grunzweig uncovered a new variant of\nAlina (dubbed Eagle), and Trustwave documented another new version\n(dubbed Spark). While all this was going on, new families like Getmypass,\nLusyPOS, Daredevil, NewPOSThings, and Backoff were just starting to be\ndiscovered.\n\nDespite the ongoing efforts to curb POS malware from being successful,\nthis seems to be an area where there is no slowing down.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-11-16 - Introducing LogPOS.pdf"
    ],
    "report_names": [
        "2015-11-16 - Introducing LogPOS.pdf"
    ],
    "threat_actors": [
        {
            "id": "746214d4-5d48-4644-b763-8e9a9c549c04",
            "created_at": "2022-10-25T16:07:23.878029Z",
            "updated_at": "2025-03-27T02:02:10.006583Z",
            "deleted_at": null,
            "main_name": "MoneyTaker",
            "aliases": [],
            "source_name": "ETDA:MoneyTaker",
            "tools": [
                "Kronos",
                "Metasploit",
                "MoneyTaker",
                "Screenshotter"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e5364c16-eb97-467e-a8c2-a720269498c1",
            "created_at": "2023-01-06T13:46:38.733469Z",
            "updated_at": "2025-03-27T02:00:02.904201Z",
            "deleted_at": null,
            "main_name": "MoneyTaker",
            "aliases": [],
            "source_name": "MISPGALAXY:MoneyTaker",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535541,
    "ts_updated_at": 1743041724,
    "ts_creation_date": 1664712671,
    "ts_modification_date": 1664712671,
    "files": {
        "pdf": "https://archive.orkl.eu/fbae5ee2e6151a2c1ec85fbe85e359ca0724cdc0.pdf",
        "text": "https://archive.orkl.eu/fbae5ee2e6151a2c1ec85fbe85e359ca0724cdc0.txt",
        "img": "https://archive.orkl.eu/fbae5ee2e6151a2c1ec85fbe85e359ca0724cdc0.jpg"
    }
}