{
    "id": "397b5323-8313-42b6-8efe-77640360c26e",
    "created_at": "2022-10-27T08:36:15.379123Z",
    "updated_at": "2025-03-27T02:16:26.504634Z",
    "deleted_at": null,
    "sha1_hash": "facc6beb0aadb971ccf1dcb523568c41c104a413",
    "title": "",
    "authors": "",
    "file_creation_date": "0001-01-01T00:00:00Z",
    "file_modification_date": "0001-01-01T00:00:00Z",
    "file_size": 3234760,
    "plain_text": "-----\n\n# Putting Together the RDPieces\n\n##### Brian Moran\n\n###### Consultant\n\n BriMor Labs\n\n\n-----\n\n# A Brief List of Topics\n\n\n# A Brief List of Topics\n\n### • RDP - WTF?\n (YOU: But Brian, we don’t really see much of this right meow) (ME: Perhaps, but this is why you should care)\n • Evidence\n • Research\n • Stuff with Things\n • Profit?\n\n\n-----\n\n# I Feel So Seen\n\n\n# I Feel So Seen\n\n### • Hello, my name is Brian Moran\n • 13+ years Air Force career\n – 17ish years mobile exploitation &\n DFIR focus – Started BriMor Labs in 2014\n\n • Very happy since!\n\n\n-----\n\n# I Feel So Seen (Cont)\n\n\n### – Well if we make it to 2021\n\n\n# I Feel So Seen (Cont)\n\n### • You may know me from a variety of things, but I am very proud of\n the #DFIRFitin2020 challenge that was organized with the help of Kat Hedley (@4enzikat0r)\n – You can still join us! Details at https://www.dfirfitin2020.com\n • Throughout 2020, our #DFIRFit4Good events have raised over\n $10,000 for charity!!\n • And, yes, there will be a 2021\n #DFIRFit challenge\n – Well if we make it to 2021\n\n\n-----\n\n# What is this RDP Thing?\n\n\n# What is this RDP Thing?\n\n### • “Remote Desktop Protocol (RDP) is a proprietary protocol\n developed by Microsoft, which provides a user with a graphical interface to connect to another computer over a network connection”\n\n#### – This means someone can do stuff with things on another\n computer, whether it is in the next room or halfway around the world\n\n\n-----\n\n# My Investigations?\n\n### • Lateral movement in an environment\n • Remote connection(s) to known/suspected malicious systems\n • Unauthorized access\n • Ransomware investigations\n\n\n-----\n\n# How I Got Interested in This Topic\n\n\n# How I Got Interested in This Topic\n\n### • Working what seemed to be a typical ransomware case\n – YARC\n • This particular attacker actually cleaned up after themselves\n – Cleared Event Logs – Cleared “Recent” data \n\n • This made answering the usual questions (who, what, how,\n when, data access, data exfil, etc, EXTREMELY difficult)\n\n\n-----\n\n# How I Got Interested in This Topic\n\n\n# How I Got Interested in This Topic\n\n### • Fortunately, the attacker did not clean up the RDP Bitmap\n Cache files\n – Since didn’t have much else to go on, this was at least\n evidence of “something had happened”\n\n\n-----\n\n# WTF is RDP Bitmap Cache?\n\n\n# WTF is RDP Bitmap Cache?\n\n### • Let’s visit the source (\n\n###### https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rdpbcgr /2da3e165-d1ba-4b65-8909-7a0f7f858d69 )\n\n “A Persistent Bitmap Cache is a store that contains bitmap images that were sent to the client by using the Cache Bitmap (Revision 2) Secondary Drawing Order ([MS-RDPEGDI] section 2.2.2.2.1.2.3). Unlike the Bitmap Caches described in section 3.2.1.13, Persistent Bitmap Caches are not bound to the lifetime of a given RDP connection and their contents are persisted even after the RDP connection is closed.”\n\n\n-----\n\n# Yeah, That Doesn t Help\n\n\n# Yeah, That Doesn t Help\n\n### • Okay, that admittedly was a lot\n\n While it is not technically 100% accurate, a better way to think of it is kind of like taking snapshots of the entire screen during an RDP session, which are written to disk on the endpoint that the RDP session originated from\n\n\n-----\n\n# Yeah, That Doesn t Help\n\n### • Okay, that admittedly was a lot\n\n While it is not technically 100% accurate, a better way to think of it is kind of like taking snapshots of the entire screen during an RDP session, which are written to disk on the endpoint that the RDP session originated from.\n\n\n-----\n\n# Oh, That Is Better, Thank You!\n\n\n# Oh, That Is Better, Thank You!\n\n### • The location of the RDP Bitmap Cache files has shifted over\n the years, but for the most part they can be found under the path “%USERPROFILE%\\AppData\\Local\\Microsoft\\Terminal Server Client\\Cache\\”\n\n\n-----\n\n# More Technical Details\n\n\n# More Technical Details\n\n### • On older systems, you will usually have a file with a .bmc\n extension\n • Windows 7 and newer systems, you will likely see files that\n are named “Cache####.bin” (these are incrementally numbered starting at 0000)\n\n • Both file types contain what are essentially small chunks of\n screenshots that are saved of the remote desktop\n\n\n-----\n\n### -to-phacilitate html (Hey that one is mine!)\n\n\n# Presentation, please!)\n\n### • https://www.allthingsdfir.com/do-you-even-bitmap-cache-bro/\n • https://countuponsecurity.com/tag/rdp-bitmap-cache/\n • https://cbtgeeks.com/2018/05/22/digital-forensics-on-rdp-cache/\n • RDP Cache Forensics - 13Cubed:\n https://www.youtube.com/watch?v=NnEOk5-Dstw\n\n • https://www.brimorlabsblog.com/2019/06/phinally-using-photoshop\n -to-phacilitate html (Hey that one is mine!)\n\n\n-----\n\n# Are You Here?\n\n### • Well, part of the reason is because, like everything else that I\n do, I want to find an easier way to get usable information from this data source\n\n • I very much enjoy OSDFCON every year, and this is an open\n source project, so it makes sense\n – Although this time, it is virtual. Which means not watching\n giant robots fight, while enjoying a stack of pizzas approximately one Sarah Edwards high, with ~20 of my\n\n\n-----\n\n# Data Out\n\n### • Step 1: Extract the data from the RDP Bitmap Cache file(s)\n – I always use the -b flag … but that is up to you\n\n • In my opinion, best current option for this is the Python script\n from the ANSSI (agence nationale la sécurité des systèmes d’information) github repository\n\n##### – https://github.com/ANSSI-FR/bmc-tools\n Note: Use Python v2\n\n\n-----\n\n# Data Out\n\n### • Made a small update to the script to fix a bug\n – The data within the header, referencing file size, is off by 4\n bytes (four bytes too long)\n\n • Most likely counted the “BM” file header (2 bytes) plus\n hex representation of file size (2 bytes), twice – Opened bug request\n\n • Until it is addressed, use this one:\n https://github.com/brimorlabs/rdpieces/blob/master/modifie\n\n\n-----\n\n# Data Out\n\n### • Alternatively, a PowerShell option is available if you wish to\n use it.\n – https://github.com/gtworek/PSBits/blob/master/DFIR/Dec\n odeRDPCache.ps1 – Note: My solution does not currently support the output\n from this script (if enough interest/requests are made, I can work on building support for this output too though)\n\n\n-----\n\n# Data Out\n\n### • Step 2: We now have results. Folder structure probably looks\n like this:\n\n\n-----\n\n# Data Out\n\n\n-----\n\n# Data Out\n\n\n-----\n\n-----\n\n# Data Out\n##### I think this is how this all works?\n\n\n-----\n\n# Data Out\n\n### • Step 4: Now you have a whole bunch of bitmap images\n (usually 6000+) that are 64 x 64*, and one large bitmap file with all of the tiles lined up (see next slide)\n – You can now manually rearrange the individual bitmap\n images, in hopes of “reconstructing” screen shots that are automatically taken, and stored, during the RDP session – This is a challenging, and tedious task\n\n *While a majority are 64 x 64, not all of the images are actually\n\n\n-----\n\n# Data Out\n\n\n-----\n\n# Data Out\n\n\n-----\n\n-----\n\n# Data Out\n\n\n-----\n\n# Data Out\n\n### • Many hours later …\n\n\n-----\n\n# Data Out\n\n\n-----\n\n# Data Out - Manual Reconstruction\n\n\n-----\n\n# Data Out\n\n### • On average, it takes between 20-40 hours to go through and\n manually rebuild RDP Bitmap Cache data\n – Fine if you have the time (or cough cough billable hours) to\n do that\n • Wanted to make an easier way to at least make slices, and\n focus on individual slices rather than rebuilding the entire picture\n\n\n-----\n\n# Data Out\n\n### • First thought was\n\n\n-----\n\n# Data Out\n\n### • Started mapping out math, data visualization, statistics, etc.\n that I thought would be needed\n\n###### How it started How it’s going\n\n\n-----\n\n# Data Out\n\n### • Enter imagemagick, which as it turns out, does almost\n everything that I was hoping to find out, and more, already\n – https://imagemagick.org/index.php\n\n\n-----\n\n# Data Out\n\n### • Now that I found where the mathiness would come from, I\n had to work on ensuring that my formulas worked fairly well, were broad enough to capture less than ideal circumstances, but at the same time, didn’t accidentally match too much\n • So relieved that I wouldn’t have to do terribly complex data\n manipulation\n – However, it is worth noting that Python absolutely sucks\n for doing even moderately advanced mathiness, but Perl handles it all like a champ. Long Live Perl!\n\n\n-----\n\n# Data Out\n\n### • The next hurdle was deciding “how” to do this most efficiently\n – Thankfully, my photography hobby (which I do not focus\n on nearly enough anymore) came into play – Alcohol helped too\n\n\n-----\n\n-----\n\n###### Probably need another drink I mean RDP Bitmap Cache inspiration juice\n\n\n# Data Out\n\n### • When matching puzzle pieces, you generally look for shapes\n that go together … and the shapes are determined by the edges …\n\n ... hmmm … this line of thinking might actually take me somewhere. Maybe. Possibly.\n\n\n-----\n\n# Data Out\n\n### • So, maybe if I just take the edges of each slice, and figure out\n how many colors, the color variance/standard deviation, and some file name spatial awareness, maybe I could generate some useful data\n • After trial and error, deciding that the edge should be 5 pixels\n in width/height, depending on if we are matching left/right or top/bottom\n – It’s not perfect, but it is at least a decent solution!\n\n\n-----\n\n# Data Out\n\n### • Used imagemagick to make a total of four new files (filename\n + L/R/T/B) for each 5x64 or 64x5 slice\n – Code has been updated to account for numbers less than\n 64 now too, since that’s how these work (apparently)\n • Pushed the resulting mathiness to a SQLite database that is in\n memory (for returning faster results)\n\n • The formula can (and undoubtedly will) evolve over time, but\n it’s much easier building SQLite queries than computing\n\n\n-----\n\n# Introducing: RDPieces.pl\n\n\n# Introducing: RDPieces.pl\n\n### • Perl script that automates everything I just talked about\n – Runs cross platform (Windows, macOS, *nix)\n\n • macOS/*nix may require some additional modules\n • On Windows, use Strawberry Perl (the best Perl) – Requires imagemagick to be installed – Script cleans up after itself, deleting temp data directory\n\n • At some point, might make a cool logo for it\n – If large scale ransomware cases ever stop\n\n\n-----\n\n# Data Out\n\n### • In my testing, there are roughly 400 results to review per\n bitmap cache (compared to ~6400 files)\n • Put limits on the maximum/minimum size of the slices,\n because that is how math works\n\n • Script also saves a folder with the rebuilt bitmap image, and\n the original files used to build the bitmap image, if you want to manually manipulate the files a bit.\n – Much easier than doing it all manually\n\n\n-----\n\n-----\n\n-----\n\n# Example of RDPieces.pl running\n\n\n# Example of RDPieces.pl running\n\n\n-----\n\n# Data Out\n\n### • Example screenshots\n\n\n-----\n\n-----\n\n# Data Out\n\n### • Because we have the original files that the slice was\n comprised of, we can then go back and try to rebuild a more complete picture with other slices and/or images\n\n\n-----\n\n-----\n\n-----\n\n-----\n\n-----\n\n# Data Out\n\n### • Hey, that isn’t too shabby, right?\n\n • We can see that\n – Windows command prompt was used – User ran commands “ping” and “ipconfig”\n\n\n-----\n\n# Data Out - The Next Generation\n\n### • This is going to be a continuing project\n – Very much welcome feedback, comments, thoughts on\n ways to improve it\n • My only caveat is that I want to keep this project entirely open\n source.\n – If Microsoft will not release technical details of how they\n are doing/rebuilding it, at least we as a community can band together to try to come up with a solution!\n\n\n-----\n\n# Cool Story Bro, Where Can I Get It?\n\n\n# Cool Story Bro, Where Can I Get It?\n\n### • You can download the Perl script here:\n – https://github.com/brimorlabs/rdpieces\n\n • Again, my only caveat is that I want to\n keep this project entirely open source\n – I am sure there are different,\n and probably better, ways to perform mathiness – Sharing is caring\n\n\n-----\n\n-----\n\n# Data Out\n\n### • Heather (@LitMoose) summed it up best:\n\n “It is like putting together an adult jigsaw puzzle, but for forensic analysts”\n\n She also said something to the effect of “it’s kind of relaxing”, which makes me question things about her\n\n\n-----\n\n# Naughty By Nature said it best …\n\n\n# Naughty By Nature said it best …\n\n\n-----\n\n# Questions?\n\n\n# Questions?\n\n## Brian Moran\n\n##### Twitter: @brianjmoran\n\n Email: brian@brimorlabs.com\n\n### Wear a mask Wash your hands Practice social distancing\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.osdfcon.org/presentations/2020/Brian-Moran_Putting-Together-the-RDPieces.pdf"
    ],
    "report_names": [
        "Brian-Moran_Putting-Together-the-RDPieces.pdf"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666859775,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 0,
    "ts_modification_date": 0,
    "files": {
        "pdf": "https://archive.orkl.eu/facc6beb0aadb971ccf1dcb523568c41c104a413.pdf",
        "text": "https://archive.orkl.eu/facc6beb0aadb971ccf1dcb523568c41c104a413.txt",
        "img": "https://archive.orkl.eu/facc6beb0aadb971ccf1dcb523568c41c104a413.jpg"
    }
}