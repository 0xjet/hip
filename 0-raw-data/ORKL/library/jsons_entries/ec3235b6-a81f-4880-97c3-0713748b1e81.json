{
    "id": "ec3235b6-a81f-4880-97c3-0713748b1e81",
    "created_at": "2023-01-12T15:00:44.947475Z",
    "updated_at": "2025-03-27T02:06:02.484184Z",
    "deleted_at": null,
    "sha1_hash": "88e52b01af943331452a4a3d07dafe5e5c2ff558",
    "title": "2014-12-16 - EvilBunny- Malware Instrumented By Lua",
    "authors": "",
    "file_creation_date": "2022-05-28T15:41:57Z",
    "file_modification_date": "2022-05-28T15:41:57Z",
    "file_size": 245588,
    "plain_text": "# EvilBunny: Malware Instrumented By Lua\n\n**[web.archive.org/web/20150311013500/http://www.cyphort.com/evilbunny-malware-instrumented-lua/](https://web.archive.org/web/20150311013500/http://www.cyphort.com/evilbunny-malware-instrumented-lua/)**\n\nDecember 16, 2014\n\nCyphort Labs has come across a sophisticated malware sample, aiming to trick sandboxes\nand showing rather uncommon tricks to evade detection. The malware is dubbed ‘EvilBunny’\nand is designed to be an execution platform for Lua scripts injected by the attacker.\n\nEvilBunny is a technically fascinating piece of malware, among a set of targeted samples\nseen in the wild around 2011. The name EvilBunny is derived from debug information\nembedded in the malware’s dropper. The malware itself is written in C++, multi-threaded,\naims to detect installed anti-virus- and firewall solutions and accepts a vast number of\ndifferent control commands. Furthermore, the specified piece incorporates a Lua 5.1\ninterpreter, which allows the malware to execute Lua scripts and change its behavior at\nruntime.\n\n**BINARY DETAILS**\n\n**Malware Dropper**\n```\nMD5            c40e3ee23cf95d992b7cd0b7c01b8599\nSHA-1           1e8b4c374db03dcca026c5feba0a5c117f740233\nFile Size         943.5 KB (966144 bytes)\nCompile Time       2011-10-25 19:28:00\n\n```\n**EvilBunny Payload**\n```\nMD5            3bbb59afdf9bda4ffdc644d9d51c53e7\nSHA-1           1798985f4cc2398a482f2232e72e5817562530de\nFile Size         773.5 KB (792064 bytes)\nCompile Time       2011-10-25 19:28:39\n\n```\n**THE DROPPER**\n\nThe EvilBunny malware was originally delivered through a malicious PDF document,\nexploiting CVE-2011-4369 as reported on http://blog.9bplus.com/analyzing-cve-2011-4369part-one/. After successful exploitation the malware dropper would be loaded onto the\nsystem and infect the machine with EvilBunny.\n\n\n-----\n\nThe functionality of the dropper can be summarized in the following steps:\n\nSandbox check and anti-virus product enumeration\nDropping payload ‘netmgr.exe’\nCreating a registry key for persistence\nCreating a registry key for deletion of the dropper\n\nSearching for a sandbox environment, the malware tests the module file name to see if it is\nless than 5 characters long or if it contains any of the four strings ‘klavme’, ‘myapp’,\n‘TESTAPP’ or ‘afyjevmv.exe’. Also, it verifies if less than 15 processes are running in the\nenvironment, using the API call EnumProcesses. In case any of the conditions is met\nexecution will abort.\n\nAccessing the systems WMI (Windows Management Interface) the malware queries the\ninstalled AntiVirus software by issuing ‘SELECT * FROM AntiVirusProduct’. Names of\nAntiVirus products are represented as hard coded SHA-256 hashes, namely the following:\n```\nd4634c9d57c06983e1d2d6dc92e74e6103c132a97f8dc3e7158fa89420647ec3\n4db3801a45802041baa44334303e0498c2640cd5dfd6892545487bf7c8c9219f\nbfe74ca464620a62f11b8c47a3778bb132d84fecd90ce7c75817970f2eeeca51 Antivirus\n443b6fb65fa57d57ee3113e48e9b4ed1db2921d5352e27fa85064cd60553c3ff BitDefender\ne1625a7f2f6947ea8e9328e66562a8b255bc4d5721d427f943002bb2b9fc5645\n588730213eb6ace35caadcb651217bfbde3f615d94a9cca41a31ee9fa09b186c\nf1761a5e3856dceb3e14d4555af92d3d1ac47604841f69fc72328b53ab45ca56 Kaspersky\n\n```\nIf any of the indicated products is installed and active on the machine execution will abort.\n\n\n-----\n\nThe dropper will place the EvilBunny malware under %APPDATA%\\Perf Manager\\ or\n%WINDIR%\\msapps\\; depending whether the dropper is running with administrative\nprivileges or not. Persistence for the dropped payload is achieved by a registry key under\n\n[HKLM|HKCU]\\…\\CurrentVersion\\Run which points to the dropped binary named netmgr.exe.\n\n**EVIL BUNNY**\n\nEvilBunny is a multi-threaded bot with an integrated scripting engine. It incorporates a Lua\nengine and downloads and executes Lua scripts to reach a certain level of polymorphism.\nThe Lua scripts can call back into the C++ code to alter the malware behavior at runtime.\n\nThe malware seeks to keep a low profile on the infected machine, while executing the\nbotmaster’s commands and Lua scripts. In total Suspect #4 exhibits three different methods\nfor receiving C&C input and executing commands; directly via HTTP, through a downloaded\ndatabase file or as a scheduled task. Also, the malware will generate numerous files to help\nits execution and frequently reply back to the C&C with status messages.\n\nThe initial purpose of the malware seems to be sharing execution load among infected host\nmachines. However, due to the lack of the original Lua scripts and the extensive functionality\nof the embedded Lua engine the original intentions of the attackers remain unknown.\n\nSimilar to its dropper, the binary seeks to evade sandboxes. In addition to the previously\ndescribed trick EvilBunny performs hook detection to trick environments which hook time\nretrieval APIs. These are NtQuerySystemTime, GetSystemTimeAsFileTime and\nGetTickCount. Every API is called twice to calculate a delta, while performing a sleep(1000)\noperation between iteration one and iteration two. The final condition is, if any of the three\ndeltas is below 998 milliseconds execution will abort. This can only be the case if any of the\nthree API’s return values is modified by a system monitoring solution, like a sandbox.\n\n\n-----\n\nAt start-up netmgr.exe decrypts a configuration file stored in its resource section, revealing\nthree URLs, among timeout settings and encryption keys:\n\nhttp://le-progres.net/images/php/test.php?rec=11206-01\nhttp://ghatreh.com/skins/php/test.php?rec=11206-01\nhttp://www.usthb-dz.org/includes/php/test.php?rec=11206-01\n\n\n-----\n\nAll three of these URLs served as C&C contacts when the attack was still ongoing, sending\ncommands or Lua scripts to the infected host. Two of them, le-progres.net and usthb-dz.org,\nare now sinkholed by Kaspersky Labs.\n\n**THE THREADING MODEL**\n\nEvilBunny comes with a solid multi-threading model, which seeks to assure fail-safe and\nhigh-performance execution. The malware runs a main thread, which manages four worker\nthreads and performs C&C command parsing and Lua script execution. The worker threads\nare dedicated to receive commands and scripts through different ways. Next to that, the main\nthread also runs sub threads to maintain log files the malware creates during execution and\nto keep track of the overall system load the malware creates. The worker threads are\ninternally dubbed ‘hearer’, which is believed to stand for ‘listener’. It can be concluded\nthereafter that the malware authors were no English native speakers.\n\nThe main action of the malware is carried out in the main thread, which parses commands\nand executes Lua scripts, provided by the worker threads via command files.\n\nThe hearer thread’s purpose is to receive instructions from the remote servers and provide\nthem to the main thread. Such instructions are commands and/or one or more Lua scripts.\nEach hearer has a dedicated method to receive instructions which is either separately via\nHTTP from the server, aggregated through a downloaded data file or as tasks to be\nconfigured as scheduled tasks. The hearer threads dump the received instructions to their\nassociated net.cap-files, from where the main thread’s command parsing routine fetches and\nexecutes them.\n\n**LUA MAGIC**\n\nEvilBunny incorporates an interpreter for Lua 5.1, LuaSocket 2.0.2 and C/Invoke Lua\nbindings. Lua is a lightweight programming language designed as a scripting language which\ncan be embedded into applications, providing a C API for doing so. C bindings are provided\nthrough C/Invoke and enable Lua scripts to perform callbacks to C/C++ code. This\n\n\n-----\n\nconstellation can be found in many video game engines to provide polymorphic behavior in\ngames. Engine and game play features are injected through Lua scripts, which instrument\nthe game engine code.\n\nThe Lua interpreter is very small, compiled roughly 180kB, thus can easily be integrated in\nan application. The C/Invoke bindings enable Lua to be completely independent from the\nC/C++ application, so injected scripts can be pure Lua code.\n\nThe Lua interpreter is a powerful code base which enables EvilBunny to change functionality\non the fly, as different scripts are downloaded and executed. The scripts define the\nfunctionality as they perform callbacks to the C/C++ code in the malware binary. In general\nthis is a rather uncommon technique, but it has been observed before, especially in\nconnection with some adware variants. Lua scripts are text based, which under certain\nconditions might be easier to tunnel through intrusion detection and firewalls in place than\nbinary content. Also the scripts are much smaller than an entire binary, which might be used\nfor updating the malware. These scripts are about 5-10Kb if big, while a binary has around\n50-200Kb or more.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-12-16 - EvilBunny- Malware Instrumented By Lua.pdf"
    ],
    "report_names": [
        "2014-12-16 - EvilBunny- Malware Instrumented By Lua.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535644,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653752517,
    "ts_modification_date": 1653752517,
    "files": {
        "pdf": "https://archive.orkl.eu/88e52b01af943331452a4a3d07dafe5e5c2ff558.pdf",
        "text": "https://archive.orkl.eu/88e52b01af943331452a4a3d07dafe5e5c2ff558.txt",
        "img": "https://archive.orkl.eu/88e52b01af943331452a4a3d07dafe5e5c2ff558.jpg"
    }
}