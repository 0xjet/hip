{
    "id": "7e67067b-f41c-4318-ad96-fa2a82037d22",
    "created_at": "2023-01-12T15:07:05.156851Z",
    "updated_at": "2025-03-27T02:06:05.202609Z",
    "deleted_at": null,
    "sha1_hash": "605b06b2da56c61b9ef8d80e3b3e174b9adf4f72",
    "title": "2022-06-21 - HTML Application Files are being used to distribute Smoke Loader Malware",
    "authors": "",
    "file_creation_date": "2022-07-02T23:17:59Z",
    "file_modification_date": "2022-07-02T23:17:59Z",
    "file_size": 2353876,
    "plain_text": "# HTML Application files are being used to distribute Smoke Loader malware\n\n**[securitynews.sonicwall.com/xmlpost/html-application-hta-files-are-being-used-to-distribute-smoke-loader-malware/](https://securitynews.sonicwall.com/xmlpost/html-application-hta-files-are-being-used-to-distribute-smoke-loader-malware/)**\n\nJune 21, 2022\n\nThreat actor always targets under the radar file types to deliver malware to the victim’s\nmachine. HTML Applications (HTA) files are known as less suspicious file types by various\nsecurity providers. SonicWall Capture Labs Threat Research team has observed an HTA\nfile inside an archive is being delivered to the victim’s machine, which further downloads\nand executes Smoke Loader malware.\n\n**Infection Cycle:**\n\nThe archive file name is in German “Zahlungserinnerung-BV-Green-Golfm.zip” acted as a\npayment reminder for the victim. The HTA file has HTML code to display service estimation\nby “LM Classic Cars” for Ferrari 348 TB for an Autria customer, additionally it includes\nJavaScript code to download malware using PowerShell script:\n\nThe JavaScript code executes the PowerShell executable which further executes another\ninstance of the PowerShell executable using Command Prompt:\n\n\n-----\n\nThe PowerShell script contains code to perform below actions on MS Office files:\n\nEnables all macros\nDisable protected view for files belongs to internet zone\nDisable protected view for attachments opened in Outlook\nDisable protected view for files in unsafe locations\n\nThe PowerShell downloads malware from URL h[t][t]p://www.trimm.at/error/upx.exe\n\nThe Smoke Loader malware works in multi stages and layers. It uses code obfuscation, anti\ndebugging, anti VM and Living of The Land techniques. The malware makes sure that a\nmemory dump should not expose its intention at any point of time.\n\n\n-----\n\n**First Stage Executable**\n\nThe first stage executable is highly obfuscated, it contains large loops with garbage API\ncalls followed by a conditional jump. The malware uses opaque predicate technique as\ncontrol never goes to garbage API calls, they are just kept to make analysis difficult. In a\nlong iterations loop, only few operations are actually required by the malware which are\nexecuted on a particular iteration. The below iteration loop is intended to calculate the\nencrypted bytes size at 0x40Ath iteration:\n\nThe malware decrypts the shellcode into memory which further brings second stage\nexecutable:\n\n\n-----\n\nThe shellcode uses PEB_LDR_DATA from Process Environment Block, iterates through\nInLoadOrderModuleList to get the API addresses. The shellcode decrypts next stage\nexecutable in memory and does process hollowing to replace current process from the\naddress space and starts execution of new process from entry point:\n\n\n-----\n\n**Second Stage Executable:**\n\nSecond stage executable code is full of techniques used to investigate the controlled\nenvironment execution.\n\nAnti-Debug\n\nChecking the BeingDebugged and NtGlobalFlag in Process Environment Block is common\nacross the malware. Here the tricky part is, instead of branching the code based on the flag\nvalues, the malware uses the flag values to compute a jump offset. If the malware is running\ninside a debugger then it will compute a invalid address which makes an impression of\ncorrupted file to the researcher:\n\n\n-----\n\n-----\n\nOn Demand Decryption\n\nThe malware decrypts the code on demand just before executing it and once the code is\nexecuted, the malware encrypts it back. The malware does this, to prevent its complete\ncode exposure in one shot:\n\nLoaded module\n\nThe malware checks for below modules in the current process, if any of them is loaded\nmalware terminates the execution.\n\nsbiedll (Sandboxie module)\naswhook (Avast module)\nsnxhk (Avast module)\n\nVirtual Environment\n\n\n-----\n\nThe malware examines registry values\n“\\REGISTRY\\MACHINE\\System\\CurrentControlSet\\Enum\\IDE” and\n“\\REGISTRY\\MACHINE\\System\\CurrentControlSet\\Enum\\SCSI” for below substrings to\ncheck for virtual environment.\n\nqemu\nvirtio\nvmware\nvbox\nxen\n\nThe malware enumerates through all the running processes and looks for below processes.\nIf any of the process is found the malware terminates the execution. The malware shows\nlaziness in the code here, instead of dynamic size for individual process name, the malware\nkeeps the size to 0x20 bytes for all the process names:\n\nqemu-ga.exe\nqga.exe\nwindanr.exe\nvboxservice.exe\nvboxtray.exe\nvmtoolsd.exe\nprl_tools.exe\n\n\n-----\n\nThe malware looks for below 7 bytes substrings of filenames into victim’s machine. If any of\nthem is found the malware terminates the execution:\n\nvmci.s\nvmusbm\nvmmous\nvm3dmp\nvmrawd\nvmmemc\nvboxgu\nvboxsf\nvboxmo\nvboxvi\nvboxdi\nvioser\n\n\n-----\n\nCode Injection\n\nThe malware gets the explorer.exe process id using APIs GetShellWindow\nand GetWindowThreadProcessId:\n\nThe malware creates and maps two sections in explorer.exe, one section\nhas PAGE_READWRITE access attributes to store data and second section\nhas PAGE_EXECUTE_READ access attributes to inject shellcode. Not enabling\n**WRITE access to the shellcode memory makes the debugging little more difficult as this will**\nprevent from putting software breakpoints and modifying code as per researcher’s need:\n\n\n-----\n\nThe malware injects shellcode into the mapped section and does NtCreateThreadEx\npassing data section address as parameter:\n\n**ShellCode Execution:**\n\nThe Injected shellcode into explorer.exe spawns two sub-threads which keep an eye on\nmonitoring tools. If the researcher opens any of the monitoring tool or analysis tool that will\nbe immediately terminated by the sub-threads while the main thread doing its job.\n\nThread 1\n\nThis thread enumerates through all running processes, computes hash of the running\nprocess name and compares it with its list of hashes to terminate below processes:\n\n\n-----\n\n56DAB1A9 → Autoruns.exe\nF3E35F5E → procexp.exe\n2407724B → procexp64.exe\nFBC25850 → procmon.exe\n27151A96 → procmon64.exe\nE6ED4551 → Tcpview.exe\n27D7E006 → Wireshark.exe\n2CEB6C62 → ProcessHacker.exe\nEDCD7F5E → ollydbg.exe\n70A30042 → x32dbg.exe\n4EA30D45 → x64dbg.exe\n0CCD4A10 → idaq.exe\n0CCD4C3A → idaw.exe\n0956AD95 → idaq64.exe\n337CAD95 → idaw64.exe\n\nThread 2\n\nThe malware enumerates through windows, computes hash value of windows name and\ncompares it to terminate processes attached with below windows list:\n\n61C75CDC → Autoruns\n4DFA76EB → PROCEXPL\n95E8B472 → PROCMON_WINDOW_CLASS\n62DC4674 → TCPViewClass\n\n\n-----\n\n6A0FAA84 → Wireshark\n7FF991A1 → ProcessHacker\nBEDA6295 → OLLYDBG\n62DD69FD → IDA\n\nMain Thread\n\nThe main thread starts with Process Environment Block (PEB) traversal, to get\n_ImageBase of ntdll.dll and kernel32.dll. The malware then enumerates the export functions_\nto get the the addresses of required APIs. Instead of direct API names the malware keeps\nthe hash values list, which is being compared to the hash value of the exported function\nname:\n\n\n-----\n\nThe malware keeps list of RC4 encrypted strings in a structure, in which first bytes tells the\nstring size followed by encrypted string. The malware perform RC4 decryptions just before\nusing them:\n\nThe malware computes a unique identifier for the victim’s machine using below formula:\n\n\n-----\n\n**MD5(computer name + hardcoded DWORD value + system drive serial number) +**\n**system drive serial number**\n\nThe malware creates mutex with the unique identifier to restrict execution of another\ninstance of the shellcode and if another instance is already running malware terminates its\nexecution:\n\nThe malware reads Internet Explorer version information from registry and gets user agent\nstring for it:\n\n\n-----\n\nThe malware drops self copy into %APPDATA% directory and the file name is computed by\nencoding initial 7 bytes from the unique identifier:\n\nThe malware deletes the current instance of the malware and it deletes zone identifier from\nthe self copy dropped in %APPDATA%:\n\nThe malware sets dropped file property as FILE_ATTRIBUTE_HIDDEN\nand FILE_ATTRIBUTE_SYSTEM. The malware steals creation time from advapi32.dll and\nmark the same creation time for the dropped file to avoid being red flagged from any of the\nsecurity providers.\n\nC&C Communication\n\nThe malware contains 4 C&C servers:\n\nostgotahusbilsuthynring.de\nautoland-ls.de\nautogalerieseud.de\n\n\n-----\n\nautohuas-e-c.de\n\nThe malware calculate CRC32 checksum for one of the C&C server before communicating,\nto make sure that the C&C has not been modified by the researcher and if the C&C is\nmodified malware terminates the execution. The malware prepares post data which\nincludes the variant id, unique identifier for the victim’s machine, computer name and\nrandom 0xA1 bytes. The data is then encrypted by RC4 algorithm and sent to its C&C\nserver:\n\n\n-----\n\nAt the time of analysis all 4 C&C server were not responding but digging deep into the\nmalware code reveals that malware is expecting response from C&C server which should\ncontain Variant ID (0x7E6), Plugin size and plugin modules.\n\nUnavailability of the archive file in any of the popular threat intelligence sharing portals like\nthe VirusTotal and the ReversingLabs indicates its uniqueness and limited distribution:\n\nEvidence of detection by RTDMI ™ engine can be seen below in the Capture ATP report for\nthis file:\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-21 - HTML Application Files are being used to distribute Smoke Loader Malware.pdf"
    ],
    "report_names": [
        "2022-06-21 - HTML Application Files are being used to distribute Smoke Loader Malware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536025,
    "ts_updated_at": 1743041165,
    "ts_creation_date": 1656803879,
    "ts_modification_date": 1656803879,
    "files": {
        "pdf": "https://archive.orkl.eu/605b06b2da56c61b9ef8d80e3b3e174b9adf4f72.pdf",
        "text": "https://archive.orkl.eu/605b06b2da56c61b9ef8d80e3b3e174b9adf4f72.txt",
        "img": "https://archive.orkl.eu/605b06b2da56c61b9ef8d80e3b3e174b9adf4f72.jpg"
    }
}