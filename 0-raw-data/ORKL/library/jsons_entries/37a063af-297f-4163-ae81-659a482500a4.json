{
    "id": "37a063af-297f-4163-ae81-659a482500a4",
    "created_at": "2023-01-12T15:06:10.548463Z",
    "updated_at": "2025-03-27T02:16:34.646308Z",
    "deleted_at": null,
    "sha1_hash": "86bea2f9a1bbf4025beea58eb1022f94ca73b5c3",
    "title": "2020-05-18 - Looking Back at LiteDuke",
    "authors": "",
    "file_creation_date": "2022-05-28T17:33:48Z",
    "file_modification_date": "2022-05-28T17:33:48Z",
    "file_size": 756428,
    "plain_text": "# Looking Back at LiteDuke\n\n**norfolkinfosec.com/looking-back-at-liteduke/**\n\nnorfolk May 18, 2020\n\nLast October (2019), ESET [published extensive research regarding additional tooling from](https://www.welivesecurity.com/wp-content/uploads/2019/10/ESET_Operation_Ghost_Dukes.pdf)\nthe “Dukes” adversary, which analysts have traditionally aligned with [APT29/Cozy Bear]\noperations. While conducting some unrelated research, I came across a LiteDuke sample\nand decided to take a deeper dive into the mechanics of its loader and its malware.\n\nThe original ESET publication covers the key details at a high level; in addition, this malware\nis old and has likely been discontinued for several years. This blog post is intended to\ndocument some additional lower-level details for operational comparison purposes and\ngeneral learning.\n\n**Loading Structure**\n\nThe loading structure identified by this blog is similar to the one described by ESET\n(differences may be attributable to a different variant of the malware being examined or more\nlikely just a different analytic perspective). This blog identified a DLL component of the\nloading chain on VirusTotal with the following properties:\n\nMD5: 79ac8431f484ab50de137544d88d5c83\n\nSHA1: 5c01fcc8c9cf72bd1d5088ee739939353b41b1d6\n\nSHA256: b9670993179beb5c1af574c156c0379e058b2f4a6635a83b98766a3339431274\n\nCompilation Timestamp: 2014-10-02 11:09:36\n\nExport: ShowDialog\n\nThis DLL was likely preceded by another executable, script, or command-line invocation, as\nit requires that the “ShowDialog” export be called to deploy the next stage. This DLL\nallocates a segment of virtual memory and decodes content from a .bmp resource. The\ndecoded memory is a block of four executable files:\n\n1) A DLL with an export named SetLibrary (that expects #2-4 to be present).\n\n2) A DLL with several exports, including one named LoadRegistry (that expects #3-4 to be\npresent).\n\n3) The LiteDuke payload, temporarily decrypted (that expects #4 to be present).\n\n4) A SQLite library that is actually a component of the LiteDuke payload.\n\n\n-----\n\n**LiteDuke Loading**\n\n**Structure**\n\nThe SetLibrary export from the top component (#1) performs the following actions:\n\n1) Creates a directory at C:\\ProgramData\\User\\\n2) Writes a file named NTUSER.DAT here. This file is #2 from the list above, but with the\n#3/4 blocks encrypted.\n3) Calls rundll32.exe [path to NTUSER.DAT],LoadRegistry\n\nThis invokes the LiteDuke loader, which decrypts and runs the LiteDuke payload via the\nLoadRegistry export.\n\n**LiteDuke Payload**\n\nThe LiteDuke payload can be broken down into three core workflows:\n\n1) A setup routine, which establishes persistence, creates the SQL database file, and\nlaunches the C2 routines.\n2) A “higher-level” C2 block, which performs basic maintenance tasks.\n3) A “lower-level” C2 block, which carries out a large number of commands.\n\n**_Setup Routine_**\n\nAs part of its setup, the malware creates a mutex named “NtUserRegistryService” and\nterminates the process if the mutex already exists. The malware then calls three functions.\nThe first of these creates the encryption key for a local database, the second creates this\ndatabase (written to the same ProgramData\\User folder with the name NTUSER.DAT.BAK),\nand the third assigns a User Agent used for HTTP communication.\n\nThe SQL database contains three tables: config, modules, and objects. The config table\ncontains information for the C2 routine and can be updated (as this post will later show). The\nmodules field appears to allow for additional code execution (although, as ESET noted, none\n\n\n-----\n\nhave been publicly documented). The purpose of the objects field is less clear; a handful of\nfunctions in the binary suggest it could be used to hold files, although the phrase “object”\nitself has a distinct meaning in object databases.\n\n**SQL table and fields set up by the binary**\n\n\n-----\n\n**Segment of setup**\n\n**workflow leading to the browser query**\n\nTo select a User Agent, the malware uses the AssocStringQuery API to search the root\nregistry for the default program associated with the “http” extension. In practical terms, this\nreturns the default browser, which is checked against a hardcoded list. The malware assigns\na User Agent corresponding to the default browser and also moves a value into the EAX\nregister based on which browser was chosen.\n\nIf this check sets the EAX value to either 2 or 5 (Firefox and Opera respectively), the\nmalware will also attempt to retrieve and use proxy configuration information stored in the\nbrowser settings.\n\nThe first image below shows the browser/User Agent association function. The second\nimage below shows the parent function that calls both this User Agent function and the proxy\nfunction. This second image corresponds with the “BowserCheck_ProxyDecide” label in the\nsetup routine image above.\n\n\n-----\n\n**User Agent selection (right click and open in a new tab to expand)**\n\n\n-----\n\n**Parent function for user agent and proxy selections**\n\nFinally, the malware takes two additional setup steps.\n\nFirst, the malware creates a persistence mechanism. As ESET previously noted, this takes\nthe form of a .lnk file. In this case, the file is named NTUSER.DAT.lnk and placed inside of\nthe same ProgramData\\User\\ directory as the database and loader. The .lnk file calls\nrundll32.exe, passing the .DAT file and the LoadRegistry DLL, forcing the application to run\nat login.\n\nThe application does have handling for administrative privileges that includes a SID check for\ndefault SIDs and the %systemprofile% ProfileImage path, but the difference in outcome from\nthis routine was not immediately obvious during debugging.\n\nSecond, the malware queries the SQL database for any “autorun” plugins. Presumably,\nthese are plugins transmitted by the C2 that are then executed when the malware first loads,\nalthough this is unconfirmed due the previously mentioned absence of such data.\n\n\n-----\n\n**_Command and Control_**\n\nThe malware has an initial C2 check-in that serves an unclear purpose; however, the primary\ntwo C2 workflows are described below.\n\n_“Higher” Workflow_\n\nThis workflow is built around a series of “if-else” statements in which the ‘al’ register is\ncompared to a hardcoded hex value:\n\n0x01 – Retrieve an entry from the configuration table in the SQL database OR retrieve the\noperating system version.\n0x02 – Update the configuration via SQL statement.\n0x15 – Call “lower” command structure.\n0x04 – Insert new data into the “modules” table via SQL statement.\n0x0F – Insert new data into the “objects” table via SQL statement.\n\nAs previously mentioned, the purpose of the objects table (and thus the 0x0F) command isn’t\nentirely clear given the possible double meaning of the phrase “objects.” This routine\nincludes the phrase “upload,” which for some malware can mean “upload to the victim\ndevice.” The phrase “moved to crypto container” is also present and is preceded by the\n“SaveToCC” export that inserts data into the objects table. These factors (and traditional C2\nroutines discussed below) point towards file transmission, but this remains hypothetical.\n\n\n-----\n\n**“Higher” C2 Workflow**\n\n_“Lower” Workflow_\n\nWhen the malware enters the “lower” command structure (based on the 0x15 check above),\nit can execute one of a large number of possible commands. The initial intent of this research\nwas to identify as many commands as possible. So far, these include:\n\n– Set current working directory.\n\n– Retrieve data from the “body” field of the “objects” table and write it to the disk.\n\n– Copy a file from one location to another location.\n\n\n-----\n\n– Read data from a file.\n– Delete a file.\n– Save data to the SQL database.\n– Create a pipe, create process, open mutex (“ZWQSI_Mutex”) and open file mapping\n(“ZWQSI_PIDs”).\n– Unknown, possibly terminates process with “ZWQSI_Mutex.”\n– Retrieve current directory.\n– Read data from a named pipe.\n– Update a module’s “autorun” configuration value.\n– Read the body of an item in the “object” table.\n– Read the configuration of an item in the “module” table.\n– Delete a file using the SHFileOperation API, with flags set for Silent, No Confirmation, and\nNo Error.\n– Move a file.\n– Create a directory.\n– Terminate a process (specified by PID).\n– Terminate a process (via CreateToolhelp32Snapshot and Process32First/Next).\n– Set working directory to user’s profile (“C:\\Users\\[User]\\”).\n– Set working directory to the Temp path.\n– Retrieve drive and disk space information.\n– List installed programs by enumerating the “DisplayName” values in the\n“\\CurrentVersion\\Uninstall” key.\n– Retrieve HDD, OS, ProcessorNameString, SystemBiosVersion, net adapter (IP, MAC,\nDHCP, Description).\n– Get values that comprise database key (BIOS, username, computername, processor).\n– Retrieve entries in modules table.\n– Delete object from SQL database.\n– Delete module from SQL database.\n– Retrieve entries in objects table.\n– Return an error message if an unsupported command is issued.\n\n\n-----\n\n**Workflow**\n\n**for command that enumerates DisplayName values in Uninstall registry key**\n\nThe number of features are extensive. Most notably, several of these commands perform the\nsame or similar functions. For example, there are multiple supported operations for deleting\na file that use different APIs. Several commands change the working directory. There are\nalso several commands for interacting with the SQL database.\n\nWhile such actions could have been streamlined, one possible explanation for these\nredundancies is that the authors of the tool intended to minimize user errors during an\nintrusion that could be caused by issuing invalid SQL commands or invalid command-line\n\n\n-----\n\nentries. From a development standpoint, however, this can become cumbersome: every\npossible operator action would require a new entry into the malware.\n\nOne additional note includes the “ZWQSI_Mutex” mutex. This blog has not yet identified a\nprocess associated with this specific value. It may refer to an additional executable or plugin\nused by the attacker; however, given that this malware has likely not been in use for five\nyears, that data may never be recovered. Google searches for ZWQSI suggest it may be\nused as a common abbreviation for the “ZwQuerySystemInformation” API, and perhaps this\nimplies the attackers tried to hide this mutex by naming it after that.\n\n**Concluding Thoughts**\n\nThe LiteDuke malware is extensive, featuring a multi-stage loading process, a SQL table that\nholds configuration information and plugins, and a wide range of commands that allowed the\noperators to interact with this database and carry out common backdoor actions on the\ndevice. While this workflow has several advantages – most notably, unique but predictable\ndatabase encryption keys as well as plugin support – it also requires the implementation of\nseveral redundant commands. This blog suspects that the attackers likely abandoned this in\nfavor of their more flexible tools.\n\nAdditional hashes:\n\n“LoadRegistry” loader: f00297add1ea84ace5677d710cd68b51 (Compiled 2014-10-02\n11:09:35)\n\nUnpacked LiteDuke payload: 8267a73a144e0f0d9ccf487958050354 (Uploaded to VT by this\nblog after analysis)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-18 - Looking Back at LiteDuke.pdf"
    ],
    "report_names": [
        "2020-05-18 - Looking Back at LiteDuke.pdf"
    ],
    "threat_actors": [
        {
            "id": "5b748f86-ac32-4715-be9f-6cf25ae48a4e",
            "created_at": "2024-06-04T02:03:07.956135Z",
            "updated_at": "2025-03-27T02:05:17.407352Z",
            "deleted_at": null,
            "main_name": "IRON HEMLOCK",
            "aliases": [
                "ATK7 ",
                "Blue Kitsune ",
                "Cozy Bear ",
                "The Dukes",
                "UNC2452 ",
                "YTTRIUM ",
                "APT29 "
            ],
            "source_name": "Secureworks:IRON HEMLOCK",
            "tools": [
                " CozyCar",
                " CozyDuke",
                " DiefenDuke",
                " FatDuke",
                " HAMMERTOSS",
                " LiteDuke",
                " MiniDuke",
                " OnionDuke",
                " PolyglotDuke",
                " RegDuke",
                " RegDuke Loader",
                " SeaDuke",
                " Sliver",
                "CosmicDuke"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a241a1ca-2bc9-450b-a07b-aae747ee2710",
            "created_at": "2024-06-19T02:03:08.150052Z",
            "updated_at": "2025-03-27T02:05:17.409596Z",
            "deleted_at": null,
            "main_name": "IRON RITUAL",
            "aliases": [
                "Blue Dev 5 ",
                "BlueBravo ",
                "Cloaked Ursa ",
                "CozyLarch ",
                "Dark Halo ",
                "Midnight Blizzard ",
                "NOBELIUM ",
                "StellarParticle ",
                "UNC2452 ",
                "APT29"
            ],
            "source_name": "Secureworks:IRON RITUAL",
            "tools": [
                " Cobalt Strike",
                " EnvyScout",
                " GoldFinder",
                " GoldMax",
                " NativeZone",
                " RAINDROP",
                " SUNBURST",
                " Sibot",
                " TEARDROP",
                " VaporRage",
                "Brute Ratel C4"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "46b3c0fc-fa0c-4d63-a38a-b33a524561fb",
            "created_at": "2023-01-06T13:46:38.393409Z",
            "updated_at": "2025-03-27T02:00:02.822155Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "The Dukes",
                "Minidionis",
                "Grizzly Steppe",
                "G0016",
                "Blue Kitsune",
                "BlueBravo",
                "SeaDuke",
                "Cloaked Ursa",
                "YTTRIUM",
                "ATK7",
                "Nobelium",
                "UAC-0029",
                "Group 100",
                "COZY BEAR",
                "IRON HEMLOCK",
                "TA421",
                "ITG11"
            ],
            "source_name": "MISPGALAXY:APT29",
            "tools": [
                "QUARTERRIG",
                "SNOWYAMBER",
                "HALFRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535970,
    "ts_updated_at": 1743041794,
    "ts_creation_date": 1653759228,
    "ts_modification_date": 1653759228,
    "files": {
        "pdf": "https://archive.orkl.eu/86bea2f9a1bbf4025beea58eb1022f94ca73b5c3.pdf",
        "text": "https://archive.orkl.eu/86bea2f9a1bbf4025beea58eb1022f94ca73b5c3.txt",
        "img": "https://archive.orkl.eu/86bea2f9a1bbf4025beea58eb1022f94ca73b5c3.jpg"
    }
}