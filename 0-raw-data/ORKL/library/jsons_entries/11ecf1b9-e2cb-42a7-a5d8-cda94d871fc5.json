{
    "id": "11ecf1b9-e2cb-42a7-a5d8-cda94d871fc5",
    "created_at": "2023-01-12T15:01:47.692776Z",
    "updated_at": "2025-03-27T02:08:41.186737Z",
    "deleted_at": null,
    "sha1_hash": "c47b2816bd59ab4717590fbe8b7490d484d92b2b",
    "title": "2020-03-23 - Latest Astaroth living-off-the-land attacks are even more invisible but not less observable",
    "authors": "",
    "file_creation_date": "2022-05-28T22:03:46Z",
    "file_modification_date": "2022-05-28T22:03:46Z",
    "file_size": 1203339,
    "plain_text": "# Latest Astaroth living-off-the-land attacks are even more invisible but not less observable\n\n**microsoft.com/security/blog/2020/03/23/latest-astaroth-living-off-the-land-attacks-are-even-more-invisible-but-not-less-**\nobservable/\n\nMarch 23, 2020\n\nFollowing a short hiatus, Astaroth came back to life in early February sporting significant\n[changes in its attack chain. Astaroth is an info-stealing malware that employs multiple fileless](https://www.microsoft.com/security/blog/2019/07/08/dismantling-a-fileless-campaign-microsoft-defender-atp-next-gen-protection-exposes-astaroth-attack/)\ntechniques and abuses various legitimate processes to attempt running undetected on\ncompromised machines. The updated attack chain, which we started seeing in late 2019,\nmaintains Astaroth’s complex, multi-component nature and continues its pattern of detection\nevasion.\n\n_Figure 1. Microsoft Defender ATP data showing revival of Astaroth campaigns_\n\n\n-----\n\n_Figure 2. Geographic distribution of Astaroth campaigns this year, with majority of_\n_encounters recorded in Brazil_\n\nWhen we first blogged about Astaroth’s methods, we noted how it completely lived off the\nland to avoid detection: only system tools that are already existing on the machine are ever\nexecuted. In fact, it was an unusual spike in activities related to Windows Management\nInstrumentation Command-line (WMIC) that prompted our investigation and eventually\nexposed the Astaroth campaign.\n\nAstaroth now completely avoids the use of WMIC and related techniques to bypass existing\ndetections. Instead, the attackers introduced new techniques that make the attack chain\neven stealthier:\n\n[Abusing Alternate Data Streams (ADS) to hide malicious payloads](https://en.wikipedia.org/wiki/NTFS#Alternate_data_streams_(ADS))\nAbusing the legitimate process ExtExport.exe, a highly uncommon attack vector, to\nload the payload\n\nAstaroth exemplifies how living-off-the-land techniques have become standard components\nof today’s attacks intent on evading security solutions. However, as we mentioned in our\nprevious blog on Astaroth, fileless threats are very much observable. These threats still leave\na great deal of memory footprint that can be inspected and blocked as they happen. Nextgeneration protection and [behavioral containment and blocking capabilities in Microsoft](https://www.microsoft.com/security/blog/2019/10/08/in-hot-pursuit-of-elusive-threats-ai-driven-behavior-based-blocking-stops-attacks-in-their-tracks/)\n[Defender Advanced Threat Protection (Microsoft Defender ATP) lead the charge in exposing](https://www.microsoft.com/en-us/WindowsForBusiness/windows-atp)\nthreats like Astaroth.\n\n\n-----\n\nIn this blog, we ll share our technical analysis of the revamped Astaroth attack chain and\ndemonstrate how specific Microsoft technologies tackle the multiple advanced components\nof the attack.\n\n## Dismantling the new Astaroth attack chain\n\nThe attackers were careful to ensure the updates didn’t make Astaroth easier to detect; on\nthe contrary, the updates only make Astaroth’s activities even more invisible.\n\nOne of the most significant updates is the use of Alternate Data Stream (ADS), which\nAstaroth abuses at several stages to perform various activities. ADS is a file attribute that\nallows a user to attach data to an existing file. The stream data and its size are not visible in\nFile Explorer, so attacks abuse this feature to hide malicious code in plain sight.\n\n_Figure 2. Astaroth attack chain 2020_\n\n\n-----\n\nIn the case of Astaroth, attackers hide binary data inside the ADS of the file desktop.ini,\nwithout changing the file size. By doing this, the attackers create a haven for the payloads,\nwhich are read and decrypted on the fly.\n\n_Figure 3. Desktop.ini before and after infection_\n\nThe complex attack chain, which involves the use of multiple living-off-the-land binaries\n(LOLBins), results in the eventual loading of the Astaroth malware directly in memory. When\nrunning, Astaroth decrypts plugins that allow it to steal sensitive information, like email\npasswords and browser passwords.\n\nIn the succeeding sections, we describe each step of Astaroth’s attack chain in detail.\n\n### Arrival\n\nThe attack begins with an email with a message in Portuguese that translates to: “Please\nfind in the link below the STATEMENT #56704/2019 AND LEGAL DECISION, for due\npurposes”. The email contains a link that points to URL hosting an archive file,\n_Arquivo_PDF_<date>.zip, which contains a LNK file with a similarly misleading name. When_\nclicked, the LNK file runs an obfuscated BAT command line.\n\n\n-----\n\n_Figure 4. Sample email used in latest Astaroth attacks_\n\nThe BAT command drops a single-line JavaScript file to the Pictures folder and invokes\n_explorer.exe to run the JavaScript file._\n\nThe dropped one-liner script uses the GetObject technique to fetch and run the much larger\nmain JavaScript directly in memory:\n\n### BITSAdmin abuse\n\nThe main script then invokes multiple instances of BITSAdmin using a benign looking\ncommand-line to download multiple binary blobs from a command-and-control (C2) server:\n\nThe downloaded payloads are encrypted and have the following file names:\n\n_masihaddajjaldwwn.gif_\n_masihaddajjalc.jpg_\n_masihaddajjala.jpg_\n_masihaddajjalb.jpg_\n_masihaddajjaldx.gif_\n_masihaddajjalg.gif_\n_masihaddajjalgx.gif_\n_masihaddajjali.gif_\n_masihaddajjalxa.~_\n_masihaddajjalxb.~_\n_masihaddajjalxc.~_\n_masihaddajjal64w.dll_\n_masihaddajjal64q.dll_\n_masihaddajjal64e.dll_\n\n### Alternate Data Streams abuse\n\n\n-----\n\nAs mentioned, the new Astaroth attacks use a clever technique of copying downloaded data\nto the ADS of desktop.ini. For each download, the content is copied to the ADS, and then the\noriginal content is deleted. These steps are repeated for all downloaded payloads.\n\nAnother way that Astaroth abuses ADS is when it runs a script to find installed security\nproducts. A malicious script responsible for enumerating security products is dropped and\nthen copied as an ADS to an empty text file. The execution command-line looks like this:\n\n## ExtExport.exe abuse\n\nThe main script combines three separately downloaded binary blobs to form the first-stage\nmalware code:\n\nThe script then uses a LOLBin not previously seen in Astaroth attacks to load the first-stage\nmalware code: ExtExport.exe, which is a legitimate utility shipped as part of Internet\nExplorer. Attackers can load any DLL by passing an attacker-controlled path to the tool. The\ntool searches for any DLL with the following file names: mozcrt19.dll, mozsqlite3.dll, or\n_sqlite3.dll. Attackers need only to rename the malicious payload to one of these names, and_\nit is loaded by ExtExport.exe.\n\n### Userinit.exe abuse\n\nThe newly loaded DLL (mozcrt19.dll, mozsqlite3.dll, or sqlite3.dll) is a proxy that reads three\nbinary ADS streams (desktop.ini:masihaddajjalxa.~, desktop.ini:masihaddajjalxb.~, and\n_desktop.ini:masihaddajjalxc.~) and combines these into a DLL. The newly formed DLL is the_\nsecond-stage malware code and is loaded in the same process using the reflective DLL\nloading technique.\n\nThe newly loaded DLL is also a proxy that reads and decrypts another ADS stream\n(desktop.ini:masihaddajjalgx.gif) into a DLL. This DLL is injected into userinit.exe using the\n[process hollowing technique.](https://www.microsoft.com/security/blog/2017/07/12/detecting-stealthier-cross-process-injection-techniques-with-windows-defender-atp-process-hollowing-and-atom-bombing/)\n\n\n-----\n\nThe newly loaded DLL inside userinit.exe is again a proxy that reads and decrypts another\nADS stream (desktop.ini:masihaddajjalg.gif) into a DLL. This DLL is the malicious info-stealer\nknown as Astaroth and is reflectively loaded inside userinit.exe. Hence, Astaroth never\ntouches the disk and is loaded directly in memory, making it very evasive.\n\n### Astaroth payload\n\nWhen running, the Astaroth payload then reads and decrypts more components from the\nADS stream of desktop.ini (desktop.ini:masihaddajjaldwwn.gif,\n_desktop.ini:masihaddajjalc.jpg, desktop.ini:masihaddajjala.jpg,_\n_desktop.ini:masihaddajjalb.jpg, and desktop.ini:masihaddajjali.gif)._\n\nSome of these components are credential-stealing plugins hidden inside the ADS stream of\n_desktop.ini. Astaroth abuses these plugins to steal information from compromised systems:_\n\n_NirSoft’s MailPassView – an email client password recovery tool_\n_NirSoft’s WebBrowserPassView – a web browser password recovery tool_\n\nAs mentioned, Astaroth also finds installed security products. It then attempts to disable\n[these security products. For Microsoft Defender Antivirus customers, tamper protection](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-antivirus/prevent-changes-to-security-settings-with-tamper-protection)\nprevents such malicious and unauthorized changes to security settings.\n\n## Comprehensive, dynamic protection against living-off-the-land, fileless, and other sophisticated threats with Microsoft Threat Protection\n\nAttackers are increasingly turning to living-off-the-land techniques to attempt running\nundetected for as long as possible on systems. Because these attacks use multiple\nexecutables that are native to the system and have legitimate uses, they require a\ncomprehensive, behavior-based approach to detection.\n\n[Microsoft Threat Protection combines and orchestrates into a single solution the capabilities](https://www.microsoft.com/en-us/security/technology/threat-protection)\nof multiple Microsoft security services to coordinate protection, detection, response, and\nprevention across endpoints, email, identities, and apps.\n\nIn the case of Astaroth, [Office 365 ATP detects the malware delivery via email. Using](https://docs.microsoft.com/en-us/office365/securitycompliance/office-365-atp)\n[detonation-based heuristics and machine learning, Office 365 ATP inspects links and](https://www.microsoft.com/security/blog/2018/05/10/enhancing-office-365-advanced-threat-protection-with-detonation-based-heuristics-and-machine-learning/)\nattachments to identify malicious artifacts.\n\n[On endpoints, next-generation protection capabilities in Microsoft Defender ATP detect and](https://www.microsoft.com/en-us/microsoft-365/windows/microsoft-defender-atp)\nprevent some components of Astaroth’s new attack chain. Notably, through Antimalware\n[Scan Interface (AMSI), Microsoft Defender ATP can inspect the encrypted malicious scripts](https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal)\nused in the initial stages of the attack.\n\n\n-----\n\nFor the more sophisticated sections of the attack chain, behavioral blocking and containment\ncapabilities provide dynamic protection that can stop malicious behaviors and process trees.\nBehavior-based protections are key to exposing living-off-the-land threats that abuse and\nhide behind legitimate processes. These protections identify suspicious behavior sequences\nand advanced attack techniques observed on the client, which are used as triggers to\nanalyze the process tree using real-time machine learning models in the cloud.\n\n_Figure 5. Preventive and behavior-based blocking & containment protections against_\n_Astaroth_\n\nThese behavior-based detections raise alerts in Microsoft Defender Security Center. With\nbehavioral blocking and containment, not only are evasive threats exposed, detected, and\nstopped; security operations personnel are also notified so they can thoroughly investigate\nand remediate the root cause.\n\n\n-----\n\n-----\n\n_Figure 6. Sample Microsoft Defender ATP alerts on behavior-based detections of Astaroth’s_\n_activities_\n\nMicrosoft Defender ATP’s EDR capabilities also have very strong coverage of advanced\ntechniques employed by Astaroth, including cross-process migration, code injection, and use\nof LOLBins.\n\n\n-----\n\n-----\n\n_Figure 7. Sample Microsoft Defender ATP EDR alert and process tree on Astaroth’s_\n_behaviors_\n\nWe expect Astaroth to further develop and increase in complexity, as long-running malware\ncampaigns do. We will continue to watch this evolving threat and ensure that customers are\nprotected from future updates through durable behavior-based protections.\n\n**_Hardik Suri_**\n\n_Microsoft Defender ATP Research Team_\n\n### Talk to us\n\n\n-----\n\nQuestions, concerns, or insights on this story? Join discussions at the Microsoft Threat\nProtection and [Microsoft Defender ATP tech communities.](https://techcommunity.microsoft.com/t5/Microsoft-Defender-ATP/bg-p/MicrosoftDefenderATPBlog)\n\n[Read all Microsoft security intelligence blog posts.](https://www.microsoft.com/security/blog/microsoft-security-intelligence/)\n\nFollow us on Twitter **[@MsftSecIntel.](https://twitter.com/MsftSecIntel)**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-23 - Latest Astaroth living-off-the-land attacks are even more invisible but not less observable.pdf"
    ],
    "report_names": [
        "2020-03-23 - Latest Astaroth living-off-the-land attacks are even more invisible but not less observable.pdf"
    ],
    "threat_actors": [
        {
            "id": "e2a4bc0b-6745-4e55-9d7c-3d169d70b025",
            "created_at": "2022-10-25T16:07:23.386907Z",
            "updated_at": "2025-03-27T02:02:09.774331Z",
            "deleted_at": null,
            "main_name": "Berserk Bear",
            "aliases": [
                "Berserk Bear",
                "Dragonfly 2.0",
                "Dymalloy"
            ],
            "source_name": "ETDA:Berserk Bear",
            "tools": [
                "Fuerboos",
                "Goodor",
                "Impacket",
                "Karagany",
                "Karagny",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Phishery",
                "Trojan.Karagany",
                "Trojan.Phisherly",
                "xFrost"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5cbf6c32-482d-4cd2-9d11-0d9311acdc28",
            "created_at": "2023-01-06T13:46:38.39927Z",
            "updated_at": "2025-03-27T02:00:02.823829Z",
            "deleted_at": null,
            "main_name": "ENERGETIC BEAR",
            "aliases": [
                "DYMALLOY",
                "TG-4192",
                "Crouching Yeti",
                "Group 24",
                "Havex",
                "IRON LIBERTY",
                "Blue Kraken",
                "ALLANITE",
                "Koala Team",
                "G0035",
                "ATK6",
                "ITG15",
                "Ghost Blizzard",
                "BERSERK BEAR"
            ],
            "source_name": "MISPGALAXY:ENERGETIC BEAR",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "649b5b3e-b16e-44db-91bc-ae80b825050e",
            "created_at": "2022-10-25T15:50:23.290412Z",
            "updated_at": "2025-03-27T02:00:55.431037Z",
            "deleted_at": null,
            "main_name": "Dragonfly",
            "aliases": [
                "TEMP.Isotope",
                "DYMALLOY",
                "Berserk Bear",
                "TG-4192",
                "Crouching Yeti",
                "IRON LIBERTY",
                "Energetic Bear",
                "Ghost Blizzard"
            ],
            "source_name": "MITRE:Dragonfly",
            "tools": [
                "MCMD",
                "Impacket",
                "CrackMapExec",
                "Backdoor.Oldrea",
                "Mimikatz",
                "PsExec",
                "Trojan.Karagany",
                "netsh"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "90307967-d5eb-4b7b-b8de-6fa2089a176e",
            "created_at": "2022-10-25T15:50:23.501119Z",
            "updated_at": "2025-03-27T02:00:55.486295Z",
            "deleted_at": null,
            "main_name": "Dragonfly 2.0",
            "aliases": [
                "Dragonfly 2.0",
                "IRON LIBERTY",
                "DYMALLOY",
                "Berserk Bear"
            ],
            "source_name": "MITRE:Dragonfly 2.0",
            "tools": [
                "netsh",
                "Impacket",
                "MCMD",
                "CrackMapExec",
                "Trojan.Karagany",
                "PsExec"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535707,
    "ts_updated_at": 1743041321,
    "ts_creation_date": 1653775426,
    "ts_modification_date": 1653775426,
    "files": {
        "pdf": "https://archive.orkl.eu/c47b2816bd59ab4717590fbe8b7490d484d92b2b.pdf",
        "text": "https://archive.orkl.eu/c47b2816bd59ab4717590fbe8b7490d484d92b2b.txt",
        "img": "https://archive.orkl.eu/c47b2816bd59ab4717590fbe8b7490d484d92b2b.jpg"
    }
}