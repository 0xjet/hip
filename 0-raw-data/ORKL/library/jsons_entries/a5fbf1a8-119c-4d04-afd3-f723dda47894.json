{
    "id": "a5fbf1a8-119c-4d04-afd3-f723dda47894",
    "created_at": "2023-01-12T14:59:50.536785Z",
    "updated_at": "2025-03-27T02:05:38.336838Z",
    "deleted_at": null,
    "sha1_hash": "2882737a28700510ff53c2f287a8a113dc82200b",
    "title": "2021-03-24 - Black Kingdom ransomware begins appearing on Exchange servers",
    "authors": "",
    "file_creation_date": "2022-05-28T15:18:56Z",
    "file_modification_date": "2022-05-28T15:18:56Z",
    "file_size": 1301957,
    "plain_text": "# Black Kingdom ransomware begins appearing on Exchange servers\n\n**news.sophos.com/en-us/2021/03/23/black-kingdom/**\n\nMark Loman March 23, 2021\n\n[Following the DearCry ransomware attacks reported on last week, another ransomware](https://news.sophos.com/en-us/2021/03/15/dearcry-ransomware-attacks-exploit-exchange-server-vulnerabilities/)\ngang has also started to target vulnerable Exchange servers with another ransomware,\ncalled Black KingDom. Sophos telemetry began detecting the ransomware on Thursday\nMarch 18 as it targeted Exchange servers that remain unpatched against the ProxyLogon\nvulnerabilities disclosed by Microsoft earlier this month.\n\nThe Black KingDom ransomware is far from the most sophisticated payload we’ve seen. In\nfact, our early analysis reveals that it is somewhat rudimentary and amateurish in its\ncomposition, but it can still cause a great deal of damage. It may be related to a ransomware\nof the same name that appeared last year on machines that, at the time, were running a\nvulnerable version of the Pulse Secure VPN concentrator software.\n\n## Delivered through a webshell that was sent over Tor\n\nThe delivery of Black KingDom was orchestrated from a remote server with an IP address\nthat geolocates to Germany, 185.220.101.204, while the attacker operated from\n185.220.101.216. Unfortunately, because both IP addresses belong to a Tor exit node, it’s\nimpossible to know where the attackers are physically located.\n\nThe threat actor exploited the on-premises versions of Microsoft Exchange Server, abusing\nthe remote code execution (RCE) vulnerability also known as ProxyLogon (CVE-202127065).\n\nAfter successfully breaching the Exchange server, the adversary delivered a webshell. This\nwebshell offers remote access to the server and allows the execution of arbitrary commands.\n\nThe webshell ChackLogsPL.aspx was dropped here:\n\n\n-----\n\nOther filenames of webshells we have observed being used by this adversary are\n**ckPassPL.aspx and hackIdIO.aspx.**\n\nThe webshell was written to disk by w3wp.exe, an Internet Information Server (IIS) Worker\nProcess that hosts the Exchange admin center (EAC), which Microsoft has given the internal\nname ECP (Exchange Control Panel):\n\n## Ransomware execution and behavior\n\nFollowing the deployment of the webshell, the attackers initiate the attack by issuing a\nPowerShell command (not shown here in its entirety due to size constraints):\n\nThis decodes to the following script (amended to enhance readability):\n\n\n-----\n\nThis script downloads the ransomware payload from:\n```\nhxxp://yuuuuu44[.]com/vpn-service/$(f1)/crunchyroll-vpn\n\n```\nThe $(f1) part is generated by function f1, which generates a random string of 15 alphabet\ncharacters. So, ultimately, the exact web address looks something like this:\n```\nhxxp://yuuuuu44[.]com/vpn-service/ ojkgrctxslnbazd /crunchyroll-vpn\n\n```\n(As we went to press, the yuuuu44 domain was redirecting visitors to NASA.GOV)\n\nThe attackers store the ransomware payload in the \\\\\n\n**[ComputerName]\\c$\\Windows\\system32\\ folder, with a random filename generated by that**\nsame function, f1. For example:\n```\nC:\\Windows\\System32\\ojkgrctxslnbazd.exe\n\n```\nThe script executes the ransomware by invoking Win32_Process via WMI, (the Windows\nManagement Interface). The script includes the ability to upload the ransomware to other\ncomputers on the network and execute it.\n\n## Impact\n\n\n-----\n\nThe ransomware binary is based on a Python script that has been compiled into an\nexecutable using a tool called PyInstaller. With some effort we were able to decompile the\nbinary back into its original source code, which helped us understand the ransomware’s\nfunctionality. The creator named the source code 0xfff.py, the “fff” of which represents a\nhexadecimal value for the decimal number 4095. What the significance of this is remains a\nmystery.\n\nThe ransomware has a built-in block list of folders the contents of which it will not encrypt:\n\nattempts to stop services running on the machine with SQL in the service name, effectively\nterminating databases, presumably so they may be encrypted as well:\n\nThe encryption key is generated with the following code:\n\nIn the gen_string function call, the script generates a random string of 64 characters in\nlength. The script then hashes this value with MD5, and converts that hash to hexadecimal\ncharacters, and uses that as the encryption key.\n\nIt also generated a gen_id, which is a victim identifier the ransomware embeds into the\nransom note as a way for victims to let the threat actor know who the victim is, so they can\npurchase the correct decryption key.\n\n\nIt\n\n\nThe key and gen_id are then uploaded to an account on mega.io. However, if for whatever\nreason the ransomware is unable to upload this randomly-generated encryption key to Mega,\nit has a fallback in the form of a hardcoded, static key:\n\n\n-----\n\nThe base64-encoded key represents this hexadecimal value:\n**eebf143cf615ecbe2ede01527f8178b3**\n\nThe file system behavior of the file encryption function is straightforward: Read (original) >\nOverwrite (encrypted) > Rename:\n\n\n-----\n\nThis translates into the following file system activity:\n\n\n-----\n\nThe code for renaming the now-encrypted files chooses a random string between 4 and 7\ncharacters and appends that to the filename, so its suffix no longer maps to the application\nit’s supposed to:\n\nTo prevent encrypted files from being attacked twice, ransomware generally appends the\nsame uniquely chosen file extension to every encrypted file or places an indicator in the file\nheader (or at the end). However, the Black Kingdom ransomware targeting Exchange\nservers doesn’t do this. It does not check if a file or the machine has been hit before – either\nby itself or by another ransomware. As a result, the encrypted files can become encrypted\nmultiple times over, even by the same ransomware, making decryption extremely\ncomplicated. This oversight is probably unintentional, but could have been anticipated.\n\nOur CryptoGuard protection caught the ransomware attempting to encrypt data. Below, raw\ntelemetry from our signature-agnostic technology shows the ransomware binary being\nexecuted via WMI as documented above (read the Process Trace sequence backwards,\nfrom 3 to 1):\n\n\n-----\n\nTo further complicate and hinder incident response, the ransomware deletes the Windows\nEvent logs:\n\nOnce the system is encrypted (or after 20 minutes of work), the ransomware runs this\nsubroutine that disables the mouse and keyboard, and draws a full screen window on top of\nthe desktop.\n\n\n-----\n\nThis generates a full-screen window that looks like this, complete with countdown timer:\n\nAlongside the encrypted data a ransom note is stored in a file named decrypt_file.TxT:\n\n\n-----\n\nHere is a current overview of the transactions received by the attackers’ cryptocurrency\nwallet, according to BitRef. It seems at least one victim has paid the ransom demand and the\nattackers have already withdrawn the money from the wallet:\n\n## Detection guidance\n\n\n-----\n\nUsers of Sophos endpoint protection products may see the webshells detected as any of the\nlong list of detections in this post, and the ransomware payload may be detected as\n**Troj/Ransom-GFU, Troj/Ransom-GFV or Troj/Ransom-GFP or by the CryptoGuard feature**\nwithin Intercept X. SophosLabs has published indicators of compromise to the SophosLabs\n[Github. Threat hunters using Sophos EDR may also use the queries posted in this article to](https://news.sophos.com/en-us/2021/03/17/mtr-in-real-time-exchange-proxylogon-edition/)\nfind additional indicators of compromise on their networks.\n\n## Acknowledgments\n\nSophosLabs would like to acknowledge the contributions of Vikas Singh, Alex Vermaning\nand Gabor Szappanos to this report.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-24 - Black Kingdom ransomware begins appearing on Exchange servers.pdf"
    ],
    "report_names": [
        "2021-03-24 - Black Kingdom ransomware begins appearing on Exchange servers.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535590,
    "ts_updated_at": 1743041138,
    "ts_creation_date": 1653751136,
    "ts_modification_date": 1653751136,
    "files": {
        "pdf": "https://archive.orkl.eu/2882737a28700510ff53c2f287a8a113dc82200b.pdf",
        "text": "https://archive.orkl.eu/2882737a28700510ff53c2f287a8a113dc82200b.txt",
        "img": "https://archive.orkl.eu/2882737a28700510ff53c2f287a8a113dc82200b.jpg"
    }
}