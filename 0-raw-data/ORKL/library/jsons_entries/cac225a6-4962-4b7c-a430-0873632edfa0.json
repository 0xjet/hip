{
    "id": "cac225a6-4962-4b7c-a430-0873632edfa0",
    "created_at": "2023-01-12T15:08:05.415443Z",
    "updated_at": "2025-03-27T02:05:41.443678Z",
    "deleted_at": null,
    "sha1_hash": "669db670bdfefa511f51154b60482a408f014b9f",
    "title": "2022-07-12 - Spoofed Saudi Purchase Order Drops GuLoader – Part 2",
    "authors": "",
    "file_creation_date": "2022-07-18T18:28:01Z",
    "file_modification_date": "2022-07-18T18:28:01Z",
    "file_size": 422112,
    "plain_text": "# Spoofed Saudi Purchase Order Drops GuLoader – Part 2\n\n**[fortinet.com/blog/threat-research/spoofed-saudi-purchase-order-drops-guloader-part-two](https://www.fortinet.com/blog/threat-research/spoofed-saudi-purchase-order-drops-guloader-part-two)**\n\nJuly 12, 2022\n\nThreat Research\n\nBy [James Slaughter\n| July 12, 2022](https://www.fortinet.com/blog/search?author=James+Slaughter)\n\nIn [part one of this blog, FortiGuard Labs examined a recently discovered e-mail delivered to a](https://www.fortinet.com/blog/threat-research/spoofed-saudi-purchase-order-drops-guloader?utm_source=blog&utm_medium=blog&utm_campaign=spoofed-saudi-purchase-order-drops-guloader)\ncoffee company in Ukraine that was seemingly sent by an oil provider in Saudi Arabia.\nPurporting to contain an attached purchase order, the image of a PDF file was actually a link to\nan ISO file hosted in the cloud that contained an executable for GuLoader. What makes this\n[case interesting is that this executable uses NSIS (Nullsoft Scriptable Install System) to deploy](https://en.wikipedia.org/wiki/Nullsoft_Scriptable_Install_System)\nitself.\n\nGuLoader (also known as CloudEye and vbdropper) dates to at least 2019 and is generally\nused to deploy other malware variants such as Agent Tesla, Formbook, and Lokibot.\n\n\n-----\n\nIn this second part of the series, I will showcase a dynamic analysis of the main file,\nPO#23754-1.exe, as well as investigate the shellcode file “rudesbies.Par”. It will also highlight\nsome of the defences it puts in place to hinder analysis.\n\n**Affected Platforms: Windows**\n\n**Impacted Users: Windows users**\n\n**Impact: Potential to deploy additional malware for additional purposes**\n\n**Severity Level: Medium**\n\n## PO#23754-1.exe dynamic analysis\n\nThis sample has a basic level of awareness of its surroundings. If it is executed in a virtual\nenvironment that has an obvious artefact (e.g., VirtualBox Guest Additions Tray), it will halt\nimmediately.\n\nFigure 1. Halting upon detection of a virtual environment.\n\nAs the file is executed from inside a mounted ISO file, the execution path will flow from\nExplorer.\n\nFigure 2. Execution tree.\n\nBy deploying from within a container such as an ISO, it is often possible to bypass MOTW\n[(Mark-of-the-Web) controls that would stop files downloaded from the internet from executing.](https://attack.mitre.org/techniques/T1553/005/)\n\nSince this is a NSIS file, anyone viewing the screen at the time of execution will see also see a\nprogress window as files are installed.\n\nFigure 3. Installation window.\n\nThe label use, as shown in the NSIS script from part one of the blog, now becomes apparent\nwhen looking at the title bar for the window as well as the lower centre.\n\nFigure 4. Script image from part one showing the title bar and label use.\n\nAs was suspected during static analysis, all identified files have been placed into the “Temp”\ndirectory of the active user account.\n\nFigure 5. Files installed in $TEMP (note, PROCEXP.exe is not deployed by this malware).\n\nA unique directory name is created (always beginning with “ns”) to store “System.dll”. A temp\nfile that also is uniquely named (and again always prefixed with “ns”) is used in the NSIS\ndeployment process.\n\nFigure 6. Registry entry created in HKCU\\SOFTWARE.\n\n\n-----\n\nIn part one of the blog, a registry key was highlighted in the NSIS script. Figure 6 shows this\nwhen implemented on a victim system. It does not appear, however, that this is referenced later\nby the malware, nor does it appear that a file named “PARALLELIZING.log” is ever committed\nto disk. It is possible that this is a remnant of the testing phase of the NSIS file that was no\nlonger needed for the active campaign.\n\n## System.dll\n\nAs mentioned earlier, “System.dll” is dropped into a unique directory. On its own, “System.dll” is\na non-malicious file. However, the NSIS script will effectively use this DLL to proxy Windows\nAPI calls to “kernel32.dll”. This is done to read the file “rudesbies.Par” and inject its contents\ninto the already running NSIS process. Doing things in this fashion makes it more difficult to\ntrace where the origin of the call is coming from, thereby making it appear to be legitimate.\n\nFigure 7. Call function as seen in IDA.\n\nAs can be seen in Figure 7, the “Call” function is used to actually make the API call to\n“kernel32.dll”\n\nFigure 8. Call function as seen in the debugger.\n\nDespite a different offset, i.e., the last four bytes of the address in Figure 7 (1817), it can be\nseen in Figure 8 when “Call” is called by the code executing in the debugger.\n\nIn all, five calls are made through “System.dll” to “kernel32.dll”. These read “rudesbies.Par” and\nthen allocate appropriate space in memory within the running executable. The series of five\nfigures shown below demonstrate the entire journey to make this happen. Note the spelling of\nkernel as “KERNel”. Referring again back to part one, this is identical to the representation in\nthe NSIS script.\n\nFigure 9. CreateFileW is called to create a handle (a reference in memory within the OS) to the\nfile “rudesbies.Par”.\n\nFigure 10. GetFileSize is called to determine the amount of memory required to store\n“rudesbies.Par”when opened.\n\nFigure 11. VirtualAllocEx is called to prepare a designated area of memory to store the contents\nof “rudesbies.Par”.\n\nFigure 12. ReadFile is called to take the contents of “rudesbies.Par” and store them in memory.\n\nFigure 13. CloseHandle asks the OS to release the handle to “rudesbies.Par”.\n\n## Injection\n\n\n-----\n\nOnce rudesbies.Par is successfully read, it must then be injected back into the running NSIS\nprocess. This done into a random region of memory within the NSIS process.\n\nFigure 14. By observing the memory map in the debugger, the addition of a region with the\nabove characteristics can be seen.\n\nViewing that region of memory initially shows what looks to be a very large number of “cmp”\noperations.\n\nFigure 15. Initial view of the injected shellcode.\n\n## Shellcode\n\nThe instructions shown in Figure 15 are junk code and don’t actually do anything. Regardless\nof the memory offset used to load the shellcode, the first set of meaningful instructions start at\n014E.\n\nFigure 16. Start of actual instruction set (0002014E in this example, still in its encoded format).\n\nFrom this point, the code will attempt to decode the next 17208 bytes of “rudesbies.Par”. It\ndoes this by setting a counter and then incrementing by four bytes while transiting a loop. Each\ntime it goes through the loop, four bytes are added to the counter until it reaches 17208.\n\nFigure 17. Compare instruction checking if the counter (edx) has reached 17208.\n\nWhile that is occurring every four bytes, an instruction is XOR’d using the key 919E1E2E. Due\nto endian-ness, this is actually reversed and represented as 2E1E9E91.\n\nFigure 18. XOR key.\n\nOnce this has all been completed, further impediments to analysis have been added to hinder\n[review by analysts such as periodic RDTSC (Read Time-Stamp Counter) instructions. Due to](https://en.wikipedia.org/wiki/Time_Stamp_Counter)\nthe time difference it takes to step through instructions manually versus when running normally,\nthis will create a break in the normal flow of the program.\n\nFigure 19. RDTSC instruction.\n\nFortiGuard Labs was unfortunately unable to retrieve the final payload that was to have been\ndropped by this GuLoader sample. As mentioned earlier, GuLoader has been known to drop\ndifferent types of malware, such as Agent Tesla, Formbook, and Lokibot.\n\n## Conclusion\n\nDespite being a dropper, this sample shows the advantages of when malware developers\nincrease the number of defences against analysis in their code. It slows down analysts\nattempting to share the details of a campaign, thereby maximizing the amount of time a\n\n\n-----\n\nmalicious actor can keep their infrastructure up before becoming known and then compromised\nor taken down.\n\nGuLoader can be adapted for delivery in different campaigns with different malware types. It is\nan interesting and active threat that will likely continue for some time to come.\n\n## Fortinet Protections\n\nThe GuLoader sample mentioned in this blog is detected by the following (AV) signature:\n\nNSIS/Injector.AOW!tr\n\nFortinet customers are protected from this malware through FortiGuard’s Antivirus, and CDR\n(content disarm and reconstruction) services and FortiMail, FortiClient, and FortiEDR\nsolutions.\n\nDue to the ease of disruption, damage to daily operations, potential impact to the reputation of\nan organization, and the unwanted destruction or release of personally identifiable information\n(PII), etc., it is important to keep all AV and IPS signatures up to date.\n\nFortinet also has multiple solutions designed to help train users to understand and detect\nphishing threats:\n\nThe FortiPhish Phishing Simulation Service uses real-world simulations to help organizations\ntest user awareness and vigilance to phishing threats and to train and reinforce proper\npractices when users encounter targeted phishing attacks.\n\nIn addition, we suggest that organizations also have their end users go through our FREE NSE\ntraining: NSE 1 – Information Security Awareness. It includes a module on Internet threats that\nis designed to help end users learn how to identify and protect themselves from various types\nof phishing attacks.\n\n## IOCs\n\nFilename SHA256\n\n\nPO#237541.ISO\n\nPO#237541.exe\n\n\nc4debff9c0ec8a56aea5cd97215c6c906bd475ea8bd521fb9a346a4c992a0448\n\n14d52119459ef12be3a2f9a3a6578ee3255580f679b1b54de0990b6ba403b0fe\n\n\nrudesbies.Par 4a1b6b30209c35ab180fa675a769e3285f54597963dd0bb29f7adb686ba88b79\n\n\n-----\n\nGuLoader 344362b48b8aa9a89623e0bfd139d62f07e2523e600a79bb5af940f35d0740e5\n\nGuLoader 3e79ce8ac441c8c8e777fe0804b67da0bd908a045d553a31893d95f15ae4ea01\n\nGuLoader 9c5f99c37d042b0d6f2b5614fade06d373b2b954bf021bbf955df03693f2380d\n\nGuLoader 53a0111fa7fca816618b65709ebf5d04ae9a64f9ebcfe08c60117a6a6f9d8030\n\nGuLoader 5805e51dc4825c86b2d38c2a011429259954395e2d7b1fd06d83a2a3ec16fc14\n\nGuLoader 1051d3690e70e4227a2b0a0aa87367fb09c49c55360c7a1880b2acfba0b77490\n\nGuLoader cc1ad7582d16db389c1b15a1cccdc188a85398165623876f4c7887743e54a9f9\n\n## Network IOCs\n\nbounceclick[.]live/VVB/COrg_RYGGqN229.binb\n\n_Thanks to Fred Gutierrez who helped contribute to this blog._\n\n_Learn more about Fortinet’s_ _[FortiGuard Labs threat research and intelligence organization and](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_campaign=fortiguard-labs)_\n_[the FortiGuard Security Subscriptions and Services portfolio.](https://www.fortinet.com/fortiguard/labs?tab=security-bundles&utm_source=blog&utm_campaign=security-bundles)_\n\n### Related Posts\n\nCopyright © 2022 Fortinet, Inc. All Rights Reserved\n\n[Terms of ServicesPrivacy Policy](https://www.fortinet.com/corporate/about-us/legal.html)\n| Cookie Settings\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-12 - Spoofed Saudi Purchase Order Drops GuLoader – Part 2.pdf"
    ],
    "report_names": [
        "2022-07-12 - Spoofed Saudi Purchase Order Drops GuLoader – Part 2.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536085,
    "ts_updated_at": 1743041141,
    "ts_creation_date": 1658168881,
    "ts_modification_date": 1658168881,
    "files": {
        "pdf": "https://archive.orkl.eu/669db670bdfefa511f51154b60482a408f014b9f.pdf",
        "text": "https://archive.orkl.eu/669db670bdfefa511f51154b60482a408f014b9f.txt",
        "img": "https://archive.orkl.eu/669db670bdfefa511f51154b60482a408f014b9f.jpg"
    }
}