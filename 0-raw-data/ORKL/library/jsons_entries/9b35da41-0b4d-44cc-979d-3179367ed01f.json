{
    "id": "9b35da41-0b4d-44cc-979d-3179367ed01f",
    "created_at": "2023-01-12T15:04:58.338597Z",
    "updated_at": "2025-03-27T02:09:30.35361Z",
    "deleted_at": null,
    "sha1_hash": "7a62bf2f6b91d3d73f53912e99af10cfcf86ce60",
    "title": "2019-07-08 - Dismantling a fileless campaign- Microsoft Defender ATP’s Antivirus exposes Astaroth attack",
    "authors": "",
    "file_creation_date": "2022-05-28T21:59:57Z",
    "file_modification_date": "2022-05-28T21:59:57Z",
    "file_size": 783531,
    "plain_text": "# Dismantling a fileless campaign: Microsoft Defender ATP’s Antivirus exposes Astaroth attack\n\n**microsoft.com/security/blog/2019/07/08/dismantling-a-fileless-campaign-microsoft-defender-atp-next-gen-protection-**\nexposes-astaroth-attack/\n\nJuly 8, 2019\n\nThe prevailing perception about fileless threats, among the security industry’s biggest areas\nof concern today, is that security solutions are helpless against these supposedly invincible\nthreats. Because fileless attacks run the payload directly in memory or leverage legitimate\nsystem tools to run malicious code without having to drop executable files on the disk, they\npresent challenges to traditional file-based solutions.\n\nBut let’s set the record straight: being fileless doesn’t mean being invisible; it certainly\ndoesn’t mean being undetectable. There’s no such thing as the perfect cybercrime: even\nfileless malware leaves a long trail of evidence that advanced detection technologies in\n[Microsoft Defender Advanced Threat Protection (Microsoft Defender ATP) can detect and](https://www.microsoft.com/en-us/WindowsForBusiness/windows-atp)\nstop.\n\nTo help disambiguate the term fileless, we developed a comprehensive definition for fileless\nmalware as reference for understanding the wide range of fileless threats. We have also\ndiscussed at length the advanced capabilities in Microsoft Defender ATP that counter fileless\ntechniques.\n\n\n-----\n\n[I recently unearthed a widespread fileless campaign called Astaroth that completely lived off](https://attack.mitre.org/software/S0373/)\nthe land”: it only ran system tools throughout a complex attack chain. The attack involved\nmultiple steps that use various fileless techniques and proved a great real-world benchmark\nfor Microsoft Defender ATP’s capabilities against fileless threats.\n\nIn this blog, I will share my analysis of a fileless attack chain that demonstrates:\n\nAttackers would go to great lengths to avoid detection\nAdvanced technologies in Microsoft Defender ATP’s [Antivirus expose and defeat](https://www.microsoft.com/security/blog/2019/06/24/inside-out-get-to-know-the-advanced-technologies-at-the-core-of-microsoft-defender-atp-next-generation-protection/)\nfileless attacks\n\n## Exposing a fileless info-stealing campaign with Microsoft Defender ATP’s Antivirus\n\nI was doing routine review of Windows Defender Antivirus telemetry when I noticed an\nanomaly from a detection algorithm designed to catch a specific fileless technique. Telemetry\nshowed a sharp increase in the use of the Windows Management Instrumentation\nCommand-line (WMIC) tool to run a script (a technique that MITRE refers to XSL Script\nProcessing), indicating a fileless attack.\n\n_Figure 1. Windows Defender Antivirus telemetry shows a sudden increase in suspicious_\n_activity_\n\n[After some hunting, I discovered the campaign that aimed to run the Astaroth backdoor](https://attack.mitre.org/software/S0373/)\ndirectly in memory. Astaroth is a notorious info-stealing malware known for stealing sensitive\ninformation like credentials, keystrokes, and other data, which it exfiltrates and sends to a\nremote attacker. The attacker can then use stolen data to try moving laterally across\nnetworks, carry out financial theft, or sell victim information in the cybercriminal underground.\n\nWhile the behavior may slightly vary in some instances, the attack generally followed these\nsteps: A malicious link in a spear-phishing email leads to an LNK file. When double-clicked,\nthe LNK file causes the execution of the WMIC tool with the “/Format” parameter, which\n\n\n-----\n\nallows the download and execution of a JavaScript code. The JavaScript code in turn\ndownloads payloads by abusing the Bitsadmin tool.\n\nAll the payloads are Base64-encoded and decoded using the Certutil tool. Two of them result\nin plain DLL files (the others remain encrypted). The Regsvr32 tool is then used to load one\nof the decoded DLLs, which in turn decrypts and loads other files until the final payload,\nAstaroth, is injected into the Userinit process.\n\n_Figure 2. Astaroth “living-off-the-land” attack chain showing multiple legitimate tools abused_\n\nIt’s interesting to note that at no point during the attack chain is any file run that’s not a\n[system tool. This technique is called living off the land: using legitimate tools that are already](https://github.com/LOLBAS-Project/LOLBAS/blob/master/README.md)\npresent on the target system to masquerade as regular activity.\n\n[The attack chain above shows only the Initial Access and](https://attack.mitre.org/tactics/TA0001/) [Execution stages. In these stages,](https://attack.mitre.org/tactics/TA0001/)\nthe attackers used fileless techniques to attempt to silently install the malware on target\ndevices. Astaroth is a notorious information stealer with many other post-breach capabilities\nthat are not discussed in this blog. Preventing the attack in these stages is critical.\n\n\n-----\n\nDespite its use of invisible techniques, the attack chain runs under the scrutiny of Microsoft\nDefender ATP. [Multiple advanced technologies at the core of Windows Defender Antivirus](https://www.microsoft.com/security/blog/2019/06/24/inside-out-get-to-know-the-advanced-technologies-at-the-core-of-microsoft-defender-atp-next-generation-protection/)\nexpose these techniques to spot and stop a wide range of attacks.\n\nThese protection technologies stop threats at first sight, use the power of the cloud, and\nleverage Microsoft’s industry-leading optics to deliver effective protection. This defense-indepth is observed in the way these technologies uncovered and blocked the attack at\nmultiple points in Astaroth’s complex attack chain.\n\n_Figure 3. Microsoft Defender ATP’s Antivirus solutions for fileless techniques used by_\n_Astaroth_\n\nFor traditional, file-centric antivirus solutions, the only window of opportunity to detect this\nattack may be when the two DLLs are decoded after being downloaded—after all, every\nexecutable used in the attack is non-malicious. If this were the case, this attack would pose a\nserious problem: since the DLLs use code obfuscation and are likely to change very rapidly\nbetween campaigns, focusing on these DLLs would be a vicious trap.\n\n\n-----\n\nHowever, as mentioned, Microsoft Defender ATP s Antivirus catches fileless techniques.\nLet’s break down the attack steps, enumerate the techniques used using MITRE technique\nID as reference, and map the relevant Microsoft Defender ATP protection.\n\n### Step 1: Arrival\n\nThe victim receives an email with a malicious URL:\n\nThe URL uses misleading names like certidao.htm (Portuguese for “certificate”),\n_abrir_documento.htm (“open document”), pedido.htm (“order”), etc._\n\nWhen clicked, the malicious link redirects the victim to the ZIP archive certidao.htm.zip,\nwhich contains a similarly misleading named LNK file certidao.htm.lnk. When clicked, the\nLNK file runs an obfuscated BAT command-line.\n\nMITRE techniques observed:\n\n[T1192 – Spearphishing Link](https://attack.mitre.org/techniques/T1192/)\n[T1023 – Shortcut Modification](https://attack.mitre.org/techniques/T1023/)\n\nMicrosoft Defender ATP’s Antivirus protection:\n\n**Command-line scanning: Trojan:Win32/BadEcho.A**\n**Heuristics engine: Trojan:Win32/Linkommer.A**\n**Windows Defender SmartScreen**\n\n### Step 2: WMIC abuse, part 1\n\nThe BAT command runs the system tool WMIC.exe:\n\nThe use of the parameter /format causes WMIC to download the file v.txt, which is an XSL\nfile hosted on a legitimate-looking domain. The XSL file hosts an obfuscated JavaScript that\nis automatically run by WMIC. This JavaScript code simply runs WMIC again.\n\nMITRE techniques observed:\n\n[T1047 – Windows Management Instrumentation](https://attack.mitre.org/techniques/T1047/)\n[T1220 – XSL Script Processing](https://attack.mitre.org/techniques/T1220/)\n[T1064 – Scripting](https://attack.mitre.org/techniques/T1064/)\n[T1027 – Obfuscated Files Or Information](https://attack.mitre.org/techniques/T1027/)\n\n\n-----\n\nMicrosoft Defender ATP s Antivirus protection:\n\n**Behavior monitoring engine: Behavior:Win32/WmiFormatXslScripting**\n**AMSI integration engine: Trojan:JS/CovertXslDownload.**\n\n### Step 3: WMIC abuse, part 2\n\nWMIC is run in a fashion similar to the previous step:\n\nWMIC downloads vv.txt, another XSL file containing an obfuscated JavaScript code, which\nuses the Bitsadmin, Certutil, and Regsvr32 tools for the next steps.\n\nMITRE techniques observed:\n\n[T1047 – Windows Management Instrumentation](https://attack.mitre.org/techniques/T1047/)\n[T1220 – XSL Script Processing](https://attack.mitre.org/techniques/T1220/)\n[T1064 – Scripting](https://attack.mitre.org/techniques/T1064/)\n[T1027 – Obfuscated Files Or Information](https://attack.mitre.org/techniques/T1027/)\n\nMicrosoft Defender ATP’s Antivirus protection:\n\n**Behavior monitoring engine: Behavior:Win32/WmiFormatXslScripting**\n**Behavior monitoring engine: Behavior:Win32/WmicLoadDll.A**\n**AMSI integration engine: Trojan:JS/CovertBitsDownload.C**\n\n### Step 4: Bitsadmin abuse\n\nMultiple instances of Bitsadmin are run to download additional payloads:\n\n[The payloads are Base64-encoded and have file names like: falxconxrenwb.~,](https://en.wikipedia.org/wiki/Base64)\n_falxconxrenw64.~, falxconxrenwxa.~, falxconxrenwxb.~, falxconxrenw98.~,_\n_falxconxrenwgx.gif, falxfonxrenwg.gif._\n\nMITRE techniques observed:\n\n[T1197 – BITS Jobs](https://attack.mitre.org/techniques/T1197/)\n[T1105 – Remote File Copy](https://attack.mitre.org/techniques/T1105/)\n\n\n-----\n\nMicrosoft Defender ATP s Antivirus protection:\n\n**Behavior monitoring engine: Behavior:Win32/WmicBits.A**\n\n### Step 5: Certutil abuse\n\nThe Certutil system tool is used to decode the downloaded payloads:\n\nOnly a couple of files are decoded to a DLL; most are still encrypted/obfuscated.\n\nMITRE technique observed:\n\n[T1140 – Deobfuscate/Decode Files Or Information](https://attack.mitre.org/techniques/T1140/)\n\nMicrosoft Defender ATP’s Antivirus protection:\n\n**Behavior monitoring engine: Behavior:Win32/WmiCertutil.A**\n\n### Step 6: Regsvr32 abuse\n\nOne of the decoded payload files (a DLL) is run within the contexct of the Regsvr32 system\ntool:\n\nThe file falxconxrenw64.~ is a proxy: it loads and runs a second DLL, falxconxrenw98.~, and\npasses it to a third DLL that is obtained by reading files falxconxrenwxa.~ and\n_falxconxrenwxb.~. The DLL falxconxrenw98.~ then reflectively loads the third DLL._\n\nMITRE techniques observed:\n\n[T1117 – Regsvr32](https://attack.mitre.org/techniques/T1117/)\n[T1129 – Execution Through Module Load](https://attack.mitre.org/techniques/T1129/)\n[T1140 – Deobfuscate/Decode Files Or Information](https://attack.mitre.org/techniques/T1140/)\n\nMicrosoft Defender ATP’s Antivirus protection:\n\n**Behavior monitoring engine: Behavior:Win32/UserinitInject.B**\n**Attack surface reduction: An attack surface reduction rule detects the loading of a**\nDLL that does not meet the age and prevalence criteria (i.e., a new unknown DLL)\n\n### Step 7: Userinit abuse\n\n\n-----\n\nThe newly loaded DLL reads and decrypts the file falxconxrenwgx.gif into a DLL. It runs the\nsystem tool userinit.exe into which it injects the decrypted DLL. The file falxconxrenwgx.gif is\nagain a proxy that reads, decrypts, and reflectively loads the DLL falxconxrenwg.gif. This last\n[DLL is the malicious info stealer known as Astaroth.](https://attack.mitre.org/software/S0373/)\n\nMITRE techniques observed:\n\n[T1117 – Regsvr32](https://attack.mitre.org/techniques/T1117/)\n[T1129 – Execution Through Module Load](https://attack.mitre.org/techniques/T1129/)\n[T1140 – Deobfuscate/Decode Files Or Information](https://attack.mitre.org/techniques/T1140/)\n\nMicrosoft Defender ATP’s Antivirus protection:\n\n**Behavior monitoring engine: Behavior:Win32/Astaroth.A**\n**Attack surface reduction: An attack surface reduction rule detects the loading of a**\nDLL that does not meet the age and prevalence criteria (i.e., a new unknown DLL)\n\n## Comprehensive protection against fileless attacks with Microsoft Threat Protection\n\nThe strength of Microsoft Defender ATP’s Antivirus engines in exposing fileless techniques\n[add to the capabilities of the unified endpoint protection platform. Activities related to fileless](https://www.microsoft.com/en-us/WindowsForBusiness/windows-atp)\ntechniques are reported in Microsoft Defender Security Center as alerts, so security\noperations teams can further investigate and respond to attacks using endpoint detection\nand response, advanced hunting, and other capabilities in Microsoft Defender ATP.\n\n\n-----\n\n_Figure 4. Details of Windows Defender Antivirus detections of fileless techniques and_\n_malware reported in Microsoft Defender Security Center; details also indicate whether threat_\n_is remediated, as was the case with the Astaroth attack_\n\nThe rest of Microsoft Defender ATP’s capabilities beyond Antivirus enable security\noperations teams to detect and remediate fileless threats and other attacks. Notably,\nMicrosoft Defender ATP [endpoint detection and response (EDR) has strong and durable](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/overview-endpoint-detection-response)\n\n\n-----\n\ndetections for fileless and living-off-the-land techniques across the entire attack chain.\n\n\n-----\n\n-----\n\n_Figure 5. Alerts in Microsoft Defender Security Center showing detection of fileless_\n_techniques by antivirus and EDR capabilities_\n\n[We also published a threat analytics report on living-off-the-land binaries to help security](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/threat-analytics)\noperations assess organizational security posture and resilience against these threats. New\n[Microsoft Defender ATP services like threat and vulnerability management and](https://www.microsoft.com/security/blog/2019/07/02/microsofts-threat-vulnerability-management-now-helps-thousands-of-customers-to-discover-prioritize-and-remediate-vulnerabilities-in-real-time/) Microsoft\nThreat Experts (managed threat hunting), further assist organizations in defending against\nfileless threats.\n\nThrough signal-sharing and orchestration of threat remediation across Microsoft’s security\n[technologies, these protections are further amplified in Microsoft Threat Protection,](https://www.microsoft.com/en-us/security/technology/threat-protection)\nMicrosoft’s comprehensive security solution for the modern workplace. For this Astaroth\n[campaign, Office 365 Advanced Threat Protection (Office 365 ATP) detects the emails with](https://docs.microsoft.com/en-us/office365/securitycompliance/office-365-atp)\nmalicious links that start the infection chain.\n\n[Microsoft Threat Protection secures identities, endpoints, email and data, apps, and](https://www.microsoft.com/en-us/security/technology/threat-protection)\ninfrastructure.\n\n## Conclusion: Fileless threats are not invisible\n\nTo come back to one of my original points in this blog post, being fileless doesn’t mean being\ninvisible; it certainly doesn’t mean being undetectable.\n\n[An analogy: Pretend you are transported to the world of H.G. Wells’ The Invisible Man and](https://en.wikipedia.org/wiki/The_Invisible_Man)\ncan render yourself invisible. You think, great, you can walk straight into a bank and steal\nmoney. However, you soon realize that things are not as simple as they sound. When you\nwalk out in the open and it’s cold, your breath’s condensation gives away your position;\ndepending on the type of the ground, you can leave visible footmarks; if it’s raining, water\nsplashing on you creates a visible outline. If you manage to get inside the bank, you still\nmake noise that security guards can hear. Motion detection sensors can feel your presence,\nand infrared cameras can still see your body heat. Even if you can open a safe or a vault,\nthese storage devices may trigger an alert, or someone may simply notice the safe opening.\nNot to mention that if you somehow manage to grab the money and put them in a bag,\npeople are likely to notice a bag that’s walking itself out of the bank.\n\nBeing invisible may help you for some things, but you should not be under the illusion that\nyou are invincible. The same applies to fileless malware: abusing fileless techniques does\nnot put malware beyond the reach or visibility of security software On the contrary some of\n\n\n-----\n\nthe fileless techniques may be so unusual and anomalous that they draw immediate\nattention to the malware, in the same way that a bag of money moving by itself would.\n\nUsing invisible techniques and being actually invisible are two different things. Using\nadvanced technologies, Microsoft Defender ATP exposes fileless threats like Astaroth before\nthese attacks can cause more damage.\n\n**_Andrea Lelli_**\n_Microsoft Defender ATP Research_\n\n### Talk to us\n\nQuestions, concerns, or insights on this story? Join discussions at the Microsoft Defender\nATP community.\n\nFollow us on Twitter **[@MsftSecIntel.](https://twitter.com/MsftSecIntel)**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-08 - Dismantling a fileless campaign- Microsoft Defender ATP’s Antivirus exposes Astaroth attack.pdf"
    ],
    "report_names": [
        "2019-07-08 - Dismantling a fileless campaign- Microsoft Defender ATP’s Antivirus exposes Astaroth attack.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535898,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1653775197,
    "ts_modification_date": 1653775197,
    "files": {
        "pdf": "https://archive.orkl.eu/7a62bf2f6b91d3d73f53912e99af10cfcf86ce60.pdf",
        "text": "https://archive.orkl.eu/7a62bf2f6b91d3d73f53912e99af10cfcf86ce60.txt",
        "img": "https://archive.orkl.eu/7a62bf2f6b91d3d73f53912e99af10cfcf86ce60.jpg"
    }
}