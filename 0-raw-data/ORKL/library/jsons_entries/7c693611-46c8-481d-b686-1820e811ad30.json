{
    "id": "7c693611-46c8-481d-b686-1820e811ad30",
    "created_at": "2023-01-12T15:07:57.559773Z",
    "updated_at": "2025-03-27T02:16:47.126551Z",
    "deleted_at": null,
    "sha1_hash": "7478afc530439a2011c628bfd06db1c8db9b49ca",
    "title": "2020-07-05 - Reverse Engineering the Mustang Panda PlugX RAT – Extracting the Config",
    "authors": "",
    "file_creation_date": "2022-05-28T17:08:00Z",
    "file_modification_date": "2022-05-28T17:08:00Z",
    "file_size": 1005488,
    "plain_text": "# oR10n Labs\n\n**[or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-rat-extracting-the-config/](https://or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-rat-extracting-the-config/)**\n\nBy oR10n\n\n2020-07-05\n[HomeReverse EngineeringReverse Engineering the Mustang Panda PlugX RAT – Extracting](https://or10nlabs.tech/)\nthe Config\n\n## Reverse Engineering the Mustang Panda PlugX RAT – Extracting the Config\n\nHello everyone! This is a continuation on the series of blog posts focused on reverse\nengineering a new-ish variant of PlugX malware gaining traction around the Asia Pacific\nregion.\n\n[On my previous post, we reverse engineered the loader to determine how it decrypts, load,](https://or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-loader/)\nand execute the actual RAT component of PlugX. For this post, we will continue from where\nwe left off and focus on one thing – extracting the malware configuration.\n\n## Introduction\n\nExtracting malware configuration is one of the sub-tasks we can focus on when reverse\nengineering malware. By accomplishing this, we can obtain information used by the malware\nduring execution such as hardcoded C2 addresses, bot IDs, mutexes, file paths, and registry\nkeys among others.\n\nMore often than not, a malware configuration is stored within the malware binary itself as an\nencoded or encrypted blob to prevent easy detection and analysis. We have to do some\nreverse engineering in order to figure out where it is located, how it is encoded or encrypted,\nand how to reverse the algorithm to see the plain text configuration. After successfully\nextracting the configuration, we can create an automation scrip to facilitate extraction to a\nhuge number of samples. This is extremely useful for a number of use cases such as\ntracking C2 addresses for a specific malware family, blacklisting C2 addresses on network\nsecurity devices, hunting for indicators-of-compromise within an environment, assisting\nincident responders during an investigation, and so on.\n\nLet’s continue with the analysis.\n\n## Extracting the configuration\n\n\n-----\n\n[On my previous post, we were able to figure out that the payload is decrypted by the loader](https://or10nlabs.tech/reverse-engineering-the-mustang-panda-plugx-loader/)\nusing XOR with multi-byte key. We also created an automation script to decrypt the payload\nand save it to disk. We’ll use this script to save a copy of the decrypted payload to disk and\nstart from there.\n\n[Looking at the payload in DiE, we can see that it is a DLL file with a DLL name of HT.dll, 1](https://github.com/horsicq/Detect-It-Easy)\nExport function named Loader, and a bunch of Import functions from kernel32.dll and\n**user32.dll.**\n\n\n-----\n\nInterestingly enough, the Import functions for this sample are not that many and doesn’t\ninclude typical functions you see for a RAT. Furthermore, the presence of GetProcAddress\nand LoadLibraryA potentially indicates that this sample dynamically resolves Win32 API\nfunctions at run time just like the loader.\n\n[Running FLOSS at the sample will give us a bunch of interesting strings to pivot from at IDA](https://github.com/fireeye/flare-floss)\nfor a deeper analysis, but one interesting thing that immediately struck me was this blob with\nrepeating pattern of “123456789“.\n\nBy this time, some of you may already have an idea of what this is potentially and why the\nrepeating pattern of 123456789 is so interesting for us. But to be sure, let’s take a closer look\nat the disassembly in IDA.\n\nClicking this on the Strings window of IDA will show us that this blob starts at offset 0 of the\ndata section.\n\n\n-----\n\nChecking the x-refs of unk_10025000, will bring us to a function at sub_1000BE90.\n\n\n-----\n\nAs you can see, unk_10025000 is pushed onto the stack along with 724h and another\nmemory offset dword_1002FC00 as parameters for a function located at sub_10002E20.\n\nLooking closer at sub_10002E20, we can immediately figure out that this is a wrapper\nfunction that dynamically resolves the address of memcpy from msvcrt (sub_100018B0)\nvia GetProcAddress and LoadLibrary (sub_100018B0) and then calls it with the\nparameters passed to the function.\n\n\n-----\n\n-----\n\nIn simpler terms, this function copies the first 1828 bytes of the data section (unk_10025000)\nto another memory location (dword_1002FC00).\n\nAfter that, dword_1002FC00 is pushed onto the stack along with 8 and another memory\noffset aXxxxxxxx as parameters for a function located at sub_10001950. This function is\nquite similar with the previous one but dynamically resolves the address of memcmp from\n**msvcrt and then calls it with the parameters passed to the function.**\n\n\n-----\n\nAgain in simpler terms, this function compares the first 8 bytes of dword_1002FC00 to\n“XXXXXXXX“. The result of the comparison determines the execution path of the malware.\n\n**Note: The malware uses a lot of wrapper functions like this to dynamically resolve the**\naddress of various Win32 API functions from different DLLs via GetProcAddress and\n**LoadLibrary and then execute it. This is one of the anti-detection measures implemented by**\nthis specific PlugX variant and is common through out the whole binary.\n\nLet’s focus on the execution path where it doesn’t match “XXXXXXXX“. As you can see, it\npushes the string “123456789” onto the stack and calls a function at sub_10002DC0.\n\n\n-----\n\nThis is another wrapper function but this time, for lstrlenA to find the length of the string\npassed as a parameter. The resulting string length is stored in EAX and is pushed onto the\nstack along with the string “123456789“, 724h, and dword_1002FC00 which contains the\nblob we noted earlier before a call to sub_1000B840 is made.\n\nLooks familiar right? Yes, this is the same format of parameters we noted on the loader\nbefore the call to the decryption function – the key length, the key, the length of the\nencrypted data and the address of the encrypted data\n\n\n-----\n\nLooking closer at sub_1000B840 and due to the fact that there are repeating patterns of\n**123456789 on the encrypted blob, we can immediately recognize that the algorithm used to**\nencrypt it is XOR with multi-byte key as well.\n\nSo by extracting the first 1828 bytes of the data section and performing a multi-byte XOR on\nit with the key 123456789, we can decrypt the blob and see if it really contains the malware\nconfiguration.\n\nLet’s try it with a quick Cyberchef recipe:\n\n\n-----\n\nAs you can see, there are a few interesting information in here such as:\n\n- An Adobe themed unicode string “AAM UpdatesEqn”\n\n- A random looking unicode string “cHtWZJzVclxydatCXSUA”\n\n- IP addresses that are likely the C2 addresses\n\nEach IP address entry looks like it starts with 01 00, then followed by two bytes which are\nlikely port numbers in hex, and then finally the IP address itself.\n\nIf we convert the port numbers in hex to decimal (little endian) and the IP addresses in hex to\nascii we will get the following addresses:\n```\n103.200.97[.]189:965\n103.200.97[.]189:110\n185.239.226[.]17:965\n185.239.226[.]17:110\n\n```\nLet’s try to confirm our findings by running the sample on a VM and monitoring for any\ninteresting events using some dynamic analysis tools.\n\n**File, registry, and process events captured by Procmon:**\n\n\n-----\n\nFrom the Procmon output, we can see that the malware:\n\n- Created a new folder named AAM UpdatesEqn on the Program Data directory and copied\nthe PlugX components to it\n\n- Attempted to access HKLM\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\Current\n**Version\\Run for registry write operation but failed**\n\n- Succeeded in accessing HKCU\\SOFTWARE\\Microsoft\\Windows\\Current Version\\Run\nfor registry write operation\n\n- Created a new value named AAM UpdatesEqn. This is a persistence mechanism which\nwill execute “C:\\ProgramData\\AAM UpdatesEqn\\AAM Updates.exe” 701 across system\nreboots\n\n- Created a new process for C:\\ProgramData\\AAM UpdatesEqn\\AAM Updates.exe\npassing the value 701 as parameter\n\n**HTTP request captured by fakenet:**\n\nFrom the Fakenet output, we can see that the malware communicated to one of the IP\naddress and port combinations we noted earlier.\n\n**Searching for cHtWZJzVclxydatCXSUA handle in Procexp:**\n\n\n-----\n\nLastly, we can see that cHtWZJzVclxydatCXSUA is a mutex object used by the malware.\n\nThese observations confirm that we were successful in extracting the configuration of the\nmalware.\n\n## Automating the config extraction\n\nTo make our lives easier, I created this quick-and-dirty python script to automatically extract\nthe configuration information for this variant:\n\nI’ve tested this script on a bunch of samples and it seems to work fine. However, there can\nbe instances where it won’t work if the config is structured differently.\n\nThat’s it guys! I really hope you learned something new today and as always, thank you for\nreading my blog.\n\n[Tags:Malware,](https://or10nlabs.tech/tag/malware/) [Mustang Panda,](https://or10nlabs.tech/tag/mustang-panda/) [PlugX,](https://or10nlabs.tech/tag/plugx/) [RAT,](https://or10nlabs.tech/tag/rat/) [Reverse Engineering](https://or10nlabs.tech/tag/reverse-engineering/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-05 - Reverse Engineering the Mustang Panda PlugX RAT – Extracting the Config.pdf"
    ],
    "report_names": [
        "2020-07-05 - Reverse Engineering the Mustang Panda PlugX RAT – Extracting the Config.pdf"
    ],
    "threat_actors": [
        {
            "id": "1691c25f-1aa4-4168-8ce2-7aa8f23246e7",
            "created_at": "2024-06-04T02:03:07.724221Z",
            "updated_at": "2025-03-27T02:05:17.284601Z",
            "deleted_at": null,
            "main_name": "BRONZE PRESIDENT",
            "aliases": [
                "Mustang Panda ",
                "Red Lich ",
                "Temp.Hex ",
                "HoneyMyte "
            ],
            "source_name": "Secureworks:BRONZE PRESIDENT",
            "tools": [
                " Cobalt Strike",
                " ORat",
                " PlugX",
                " RCSession",
                "China Chopper"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536077,
    "ts_updated_at": 1743041807,
    "ts_creation_date": 1653757680,
    "ts_modification_date": 1653757680,
    "files": {
        "pdf": "https://archive.orkl.eu/7478afc530439a2011c628bfd06db1c8db9b49ca.pdf",
        "text": "https://archive.orkl.eu/7478afc530439a2011c628bfd06db1c8db9b49ca.txt",
        "img": "https://archive.orkl.eu/7478afc530439a2011c628bfd06db1c8db9b49ca.jpg"
    }
}