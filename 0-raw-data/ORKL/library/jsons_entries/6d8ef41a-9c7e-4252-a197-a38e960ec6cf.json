{
    "id": "6d8ef41a-9c7e-4252-a197-a38e960ec6cf",
    "created_at": "2023-01-12T15:09:16.475116Z",
    "updated_at": "2025-03-27T02:05:46.717493Z",
    "deleted_at": null,
    "sha1_hash": "94a88dd33eb3c5b71356eba949eb336d867efe58",
    "title": "2015-06-24 - Elusive HanJuan EK Drops New Tinba Version (updated)",
    "authors": "",
    "file_creation_date": "2022-05-28T19:21:07Z",
    "file_modification_date": "2022-05-28T19:21:07Z",
    "file_size": 1086962,
    "plain_text": "# Elusive HanJuan EK Drops New Tinba Version (updated)\n\n**[blog.malwarebytes.com/threat-analysis/2015/06/elusive-hanjuan-ek-caught-in-new-malvertising-campaign/](https://blog.malwarebytes.com/threat-analysis/2015/06/elusive-hanjuan-ek-caught-in-new-malvertising-campaign/)**\n\nJérôme Segura June 24, 2015\n\n**Update 07/03/15: AdFly contacted us and we are publishing their statement below:**\n\nWe are sorry for the inconvenience but this is something AdFly is obviously not letting\nhappen on purpose. We count with several methods to prevent fraudulent advertising,\nunfortunately (and very ocassionally) if a fraudulent advertising changes the redirection\nof a campaign after been reviewed by us, this is a possibility.\n\nThis specific campaign has been located now and cancelled.\n\nWe normally ask our users to report malicious ads to the email abuse@adf.ly providing\nthe IP address that has seen it at least in the last 48 hours. This should allow us to\ntrack it and in most of the cases suspend the advertiser’s account.\n\n_AdFly Support_\n\n**Update: Dutch security firm** _[Fox-IT has identified the payload as an evolution of a Tinba v2](https://www.fox-it.com/en/)_\n\n_version, a well-known banking piece of malware._\n\nIn this post, we describe a [malvertising attack spread via a URL shortener leading to](https://blog.malwarebytes.org/malvertising-2/2015/02/what-is-malvertising/)\nHanJuan EK, a rather elusive exploit kit which in the past was used to deliver a Flash Player\nzero-day.\n\n\n-----\n\nOften times cyber-criminals will use URL shorteners to disguise malicious links. However, in\nthis particular case, it is embedded advertisement within the URL shortener service that\nleads to the malicious site.\n\nIt all begins with Adf.ly which uses interstitial advertising, a technique where adverts are\ndisplayed on the page for a few seconds before the user is taken to the actual content.\n\nFollowing a complex malvertising redirection chain, the HanJuan EK is loaded and fires\nFlash Player and Internet Explorer exploits before dropping a payload onto disk.\n\nThe payload we collected uses several layers of encryption within the binary itself but also in\nits communications with its Command and Control server.\n\nThe purpose of this Trojan is information stealing performed by hooking the browser to act as\na man-in-the-middle and grab passwords and other sensitive data.\n\n## Technical details\n\n### Malvertising chain\n\n\n-----\n\nThe first four sessions load the interstitial ad via an encoded JavaScript blurb:\n\nGoogle Chrome’s JavaScript console can help us quickly identify the redirection call without\ngoing through a painful decoding process:\n\n\n-----\n\nSubsequent redirections:\n\n\n-----\n\nThe next three sessions were somewhat different from the rest and an actual connection\nbetween them could not be established right away. A deeper look revealed that the intended\n[URL was loaded via Cross Origin Resource Sharing (CORS).](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing)\n\nCross-origin resource sharing (CORS) is a mechanism that allows restricted resources\n(e.g. fonts, JavaScript, etc.) on a web page to be requested from another\ndomain outside the domain from which the resource originated. Wikipedia\n\nContent is retrieved from the adk2.com ad network via the Access-Control-Allow-Origin\nrequest.\n\nThis takes us to the actual malvertising brought by youradexchange.com:\n\n\n-----\n\nThe inserted URL may look benign and it is indeed a genuine Joomla website but it has one\ncaveat: It has been compromised and is used as the gate to the exploit kit.\n\n### Exploit kit\n\nThe exploit kit pushed here looked different than what we are used to seeing (Angler EK,\nFiesta EK, Magnitude EK, etc.). After some analysis and comparisons, we believe it is\nthe HanJuan EK.\n\nWe have talked about HanJuan EK only very few times before because little is known about\n[it. What we once described as the Unknown exploit kit, was in fact HanJuan and it has been](https://blog.malwarebytes.org/exploits-2/2014/08/shining-some-light-on-the-unknown-exploit-kit/)\nextremely stealthy and evasive ever since.\n\nAnd yet, here we found HanJuan EK hosted on a compromised website and with an easy\nway to trigger it on demand.\n\n\n-----\n\nThe landing page is divided into two main parts:\n\nCode to launch a Flash exploit\nCode to launch an Internet Explorer exploit\n\nThe filename for the Flash exploit is randomly generated each time using close patterns to\nthe original HanJuan we’ve observed before.\n\n\n-----\n\nHowever a new GET request session containing the Flash version used is inserted right after\nthe exploit is delivered.\n\nFinally, the payload is delivered via another randomly generated URL and filename with a\n.dat extension. Contrary to previous versions of HanJuan where the payload was fileless, this\none drops an actual binary to disk.\n\nFiddler traffic:\n\nLanding page (raw):\n\n\n-----\n\nFlash exploit: (up to 17.0.0.134 -> CVE-2015-0359)\n\n\n-----\n\n[The exploit performs a memory stack pivoting attack using the VirtualAllocEx API.](https://msdn.microsoft.com/en-us/library/windows/desktop/aa366890(v=vs.85).aspx)\n\nInternet Explorer exploit (CVE-2014-1776):\n\nIn this case we also have a memory stack pivoting exploit but in the\n[undocumented NtProtectVirtualMemory API.](http://undocumented.ntinternals.net/source/usermode/undocumented%20functions/memory%20management/virtual%20memory/ntprotectvirtualmemory.html)\n\nMalwarebytes Anti-Exploit users were already protected against both these exploits:\n\n\n-----\n\n### Malware payload\n\nThe malware payload delivered has been identified by our research team as\n[Trojan.Agent.Fobber. This name was derived from a folder called “Fobber” that’s used to](http://www.urbandictionary.com/define.php?term=fobber)\nstore the malware along with its associated files.\n\nUnlike a normal Windows program, Fobber makes it a habit to “hop” between different\nprograms. The flow of execution for Fobber looks something like that seen below:\n\n\n-----\n\nFrom what we have observed in our research, the purpose of the Fobber malware appears\nto be stealing user credentials for various accounts. While we have not confirmed any ties\nbetween Fobber and other known malware as of yet, we suspect it may be related to other\ninformation-stealing Trojans, like Carberp or Tinba.\n\n### Fobber.exe\n\nThis is the original file dropped by the exploit kit in the user’s temporary directory. The file\nitself has a random name, but will be referred to as fobber.exe in this article.\n\nFobber.exe is mildly obfuscated program. The samples we have observed always attempt to\nopen random registry keys and then the malware performs a long sequence of jumps in an\neffort to create something like a “rabbit hole” for analysts to follow, slowing down analysis.\n\n\n-----\n\nAt the end of the jumps, the program decodes additional shellcode and creates a suspended\ninstance of verclsid.exe. Verclsid.exe is a legitimate Microsoft program that is part of\nWindows, used to verify a Class ID. The shellcode is in injected into verclsid.exe and\nfobber.exe resumes execution of verclsid.exe. Below is an API trace of this behavior.\n\n\n-----\n\nAt this point fobber.exe terminates and the malware execution continues in verclsid.exe.\n\n### Verclsid.exe (Fobber shellcode)\n\nThe main purpose of the Fobber shellcode inside of this process is to retrieve the process ID\n(PID) of Windows Explorer (explorer.exe) and inject a thread into the process. Injecting code\ninto Windows Explorer is a very common stealth technique that’s been used in malware for\nmany years.\n\nIt is also worth nothing that, starting with the Fobber shellcode inside of the verclsid process,\nthe malware begins using an interesting unpacking technique designed to slow analysis that\nis exhibited throughout the remainder of the Fobber malware’s operation.\n\nBefore a function can be executed, its code is first decrypted, as seen in the image below\n(notice the junk instructions following “decode_more”).\n\n\n-----\n\nAnd then after the call, the instructions become clear.\n\nEventually, when the function wants to return, it calls a special procedure that uses a ROP\ngadget.\n\n\n-----\n\nIn side the call seen above (“return_caller”), the return pointer is overwritten to point to\nthe return pointer of the parent function (in this case, sub_41B21A). In addition, all the bytes\nof the function that was just executed have been re-encrypted, as seen below.\n\nSuch techniques can make the Fobber malware more difficult to analyze than traditional\nmalware that unpack the entire binary image. Similar functionality is also seen in many\ncommercial protectors, like Themida.\n\nIn order to locate the PID of Explorer, the malware searches for a known window name of\n“Shell_TrayWnd” that’s used by the Explorer process.\n\n\n-----\n\nThe shellcode uses the undocumented function RtlAdjustPrivilege to grant vercslid.exe the\n[SE_DEBUG_PRIVILEGE. This will allow verclsid.exe to inject code into Windows Explorer](https://msdn.microsoft.com/en-us/library/windows/desktop/bb530716(v=vs.85).aspx)\nwithout any issues. Following this function, more shellcode is decrypted in memory and a\nremote thread is created inside Explorer.\n\nFollowing successful injection, verclsid.exe terminates and the malware continues inside of\nWindows Explorer\n\n**Explorer.exe (Fobber shellcode)**\n\n\n-----\n\nAt this point the Fobber malware begins its main operations, to include establishing\npersistence on the victim computer, contacting the C&C server, and many more actions.\n\nPersistence\nFobber keeps a foothold on the victim computer by copying itself (fobber.exe) into an\nAppData folder called “Fobber” using the name nemre.exe. On a typical computer, this path\nmight look like:\n\nC:\\Users\\<username>\\AppData\\Roaming\\nemre.exe\n\nThe binary is launched when a user logs in using a traditional “Run” key method in the\nregistry.\n\nWhenever nemre.exe is launched at login, it will proceed using the same flow of execution,\ninjecting into verclsid.exe and then inside Windows Explorer.\n\nModifying Internet Settings\nFobber also makes a few various changes to the victim’s Internet settings to ensure\neverything runs smoothly\n```\nHKCU\\Software\\Microsoft\\Internet Explorer\\Main\nValue: TabProcGrowth - Set to 1 (on)\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Zones\\3\nValue: 1609 - Set to 0 (off)\n\n```\nIn addition, if the Firefox browser is installed, Fobber will attempt to modify browser settings\nby disabling the SPDY protocol, although it doesn’t seem like this function was implemented\ncorrectly.\n\n\n-----\n\nContacting the command server\nCommunication with C&C is encrypted using what is believed to be a custom algorithm.\nAdditionally, the content sent by the server is signed by it’s RSA1 key (to prevent botnet\nhijacking), while the Fobber code has the public key embedded within, verifying the signature\nbefore processing the content.\n\nThe communication is initialized by the infected client’s POST request; the data sent from the\nclient is always prompted by it’s ID that consists of the hard disk volume serial number and\nthe OS install date. Following this content is content specific to the request made to the\nserver.\nExample (initial request: 18 bytes long)\nraw:\n```\n79 3B C3 40 9B AC 80 55 00 05 00 00 00 50 4C 00 00 FF |y;Ă@›¬€U....PL..˙|\n\n```\nafter encoding:\n```\n7A 32 53 3C 6E B6 BC 3F 92 27 5C 3F F7 0C 21 0F 0B C8 |z2S.n..?.'\\?..!...|\n\n```\nDuring the process of communication, the command server may sent some notable\npayloads, i.e:\n\nUpdated explorer shellcode\nList of new command servers\n\nThe payloads are saved in the malware’s directory – in encrypted form – and decrypted by\nFobber as needed:\n\n\n-----\n\nThus far we have observed three particular files the Fobber malware looks for, which are:\n**ktx.sdd, lerp.wpo, and mlc.dfw. As of the time of this writing, the we have not ascertained**\nwhat mlc.dfw is used for, although we believe it will still be stored in an encrypted format like\nother Fobber files.\n\nUpdating Command Servers\n\nOne file Fobber downloads periodically from the command server is called “lerp.wpo”. This\nfile contains updated command server information to help the malware stay operational\nprovided any command servers are taken down. The format for lerp.wpo is:\n\n[Domain][Post Directory]\n\nBelow is an example of a decrypted lerp.wpo file:\n```\n003F810C | 35 2E 31 39 36 2E 31 38 39 2E 33 34 00 2F 48 63 | 5.196.189.34./Hc\n003F811C | 6D 44 75 6F 00 77 77 77 2E 32 73 6D 69 6C 65 2E | mDuo.www.2smile.\n003F812C | 65 75 00 2F 38 37 73 31 35 67 6B 2F 00 00 00 00 | eu./87s15gk/....\n\n```\nWhen the list of new command servers arrives, Fobber switches to the new server:\n\n\n-----\n\nBrowser injection\nFobber also keeps a close eye on processes that are running on the victim’s computer. In\nparticular, Fobber checks for Google Chrome, Internet Explorer and Mozilla Firefox web\nbrowsers. Unlike traditional process enumeration used by malware, however, Fobber first\ntakes each process name that is running and creates a checksum-like value to compare\nagainst hard-coded process checksums. By doing this, Fobber does not have to include the\nname of the actual process it is searching for, only the checksum, which can further inhibit\nanalysis. For example, the checksum for Internet Explorer is 0xFC03162D.\n\nOnce Fobber has found a browser running, it will inject code into it using the same routine\nfollowing the Windows Explorer injection.\n\nUpdating the malware\n\nOver time, Fobber can update itself by contacting the command server and downloading an\nadditional file called “ktx.sdd”. This file will be downloaded into the Fobber directory along\nwith nemre.exe and loaded into memory if it exists.\n\nBy doing this, the Fobber malware can “refresh” itself, further enabling it to maintain a\nfoothold in the victim system, and also looking for new or different information to steal.\n\n**Chrome, Internet Explorer, or Firefox (Fobber shellcode)**\n\n\n-----\n\nFollowing successful browser injection, Fobber looks for the presence of library used by IBM\nSecurity Trusteer Rapport and tries to unload it from memory. Rapport offers protection of\nbrowser sessions, which will likely interfere with the malware’s operation.\n\nFollowing this check, Fobber checks to see what process it’s in and hooks certain functions\naccordingly.\n\nUsing the Internet Explorer browser, common functions from wininet.dll are hooked:\n[InternetCloseHandle and](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384350(v=vs.85).aspx) [HttpSendRequest.](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384247(v=vs.85).aspx)\n\n\n-----\n\nWhen a request is made where a user has to enter credentials for a website, Fobber checks\nto see if it’s something interesting. To do this, it compares the url in the request to list regular\nexpression strings that are decoded in memory. Each item in the list is prefixed with either\n“P” or “!GP,” the meaning of which is not clear.\n\nWhen Fobber finds a request matching an expression, it packages it by using the same\ncustom algorithm, followed by sending it to the command server. Below is an example of a\nrequest to login to a Google account, where the username and password are intercepted\nbefore being encrypted and sent to Google servers for authentication (username and\npassword filtered).\n\n\n-----\n\nOnce it has arrived at the command server, the package will be decrypted and likely parsed\nusing a separate program to extract relevant information, like usernames and passwords.\n\n### Conclusion\n\nEvery encounter with HanJuan EK is interesting because it happens so rarely. As always the\nexploit kit only targets the pieces of software that have the highest return on investment\n(read: most deployed and with available vulnerabilities): Internet Explorer and the Flash\nPlayer.\n\nThe malvertising component was a little bit out of place for such a stealthy exploit kit. This is\nalso true for the site hosting the kit, a genuine Joomla! website in the Netherlands. We have\npassed on the information about that server so that a forensic analysis and full investigation\ncan be conducted.\n\nThe dropped binary, which we nicknamed Fobber, has the ability to steal valuable user\ncredentials and is also fairly resistant to removal by receiving updates to both itself and\ncommand servers. While our research teams have not observed Fobber stealing any\nbanking information, it certainly seems possible considering the flexibility offered by the\nmalware’s update model. We will continue to provide any updates on Fobber in our blog as\nwe see any improvements made in the malware.\n\nContributing analysts:\n\n[@joshcannell](https://twitter.com/joshcannell)\n\n[@hasherezade](https://twitter.com/hasherezade)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-06-24 - Elusive HanJuan EK Drops New Tinba Version (updated).pdf"
    ],
    "report_names": [
        "2015-06-24 - Elusive HanJuan EK Drops New Tinba Version (updated).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536156,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653765667,
    "ts_modification_date": 1653765667,
    "files": {
        "pdf": "https://archive.orkl.eu/94a88dd33eb3c5b71356eba949eb336d867efe58.pdf",
        "text": "https://archive.orkl.eu/94a88dd33eb3c5b71356eba949eb336d867efe58.txt",
        "img": "https://archive.orkl.eu/94a88dd33eb3c5b71356eba949eb336d867efe58.jpg"
    }
}