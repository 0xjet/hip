{
    "id": "d695c17d-c63b-4c6f-9e09-ac5a59674705",
    "created_at": "2023-01-12T15:00:07.139853Z",
    "updated_at": "2025-03-27T02:05:22.619727Z",
    "deleted_at": null,
    "sha1_hash": "e867370e80dc1ea994da15105cd70cd67aede88f",
    "title": "2017-06-08 - LatentBot piece by piece",
    "authors": "",
    "file_creation_date": "2022-05-28T15:30:47Z",
    "file_modification_date": "2022-05-28T15:30:47Z",
    "file_size": 892164,
    "plain_text": "# LatentBot piece by piece\n\n**[blog.malwarebytes.com/threat-analysis/2017/06/latentbot/](https://blog.malwarebytes.com/threat-analysis/2017/06/latentbot/)**\n\nMalwarebytes Labs June 8, 2017\n\nLatentBot is a multi-modular Trojan written in Delphi and known to have been around since\n2013. Recently, we captured and dissected a sample distributed by RIG Exploit Kit.\n\nThe main executable is a persistent botnet agent which downloads additional modules and\nreports about the performed activities to its Command and Control server. Depending on the\nmodules that have been installed, LatentBot has various capabilities, including:\n\nAct as a keylogger and form grabber\nSteal cookies\nRun a Socks Proxy from the victim system\nGive remote access to the attacker (VNC / Remote Desktop)\n\nIn this post we will describe those modules by taking apart several layers of obfuscation and\nencryption in order to reveal their true nature.\n\n## Analyzed samples\n\n\n-----\n\n[011077a7960fa1a7906323dbdc7e3807 – original sample, distributed in the campaign](https://www.virustotal.com/en/file/c3d00a4c9d3bb34c2f01e777a202613deea44fe2b60fa4ccfc59d6c549107b3b/analysis/)\n\n[85dcf88487ea412fe4960494713eed6b – unpacked (loader)](https://www.hybrid-analysis.com/sample/8fda2fe19794835029bf9c67b560498accd30d84abf7423e665295a8603c470a?environmentId=100)\n\n[60c3232b90c773ed9c4990da7cc3bbdb – injected into svchost](https://www.hybrid-analysis.com/sample/e8664c10d439790722673ccbfa9f589d3d4fc67a3288e88ef2f82461dbb60830?environmentId=100)\n\n[e105d87cb79ed668c8b62297259a4dbb – injected into iexplore](https://www.virustotal.com/en/file/b1c58bd464859dd1bc35f6402b18f58de9339e02625f48f3f9b81e8150a9e12f/analysis/)\n\nDownloaded modules, injected into svchost:\n\n## Behavioral analysis\n\nAfter being deployed. the original sample installs itself and deletes the sample from the\noriginal location. It injects into svchost the initial module\n[(60c3232b90c773ed9c4990da7cc3bbdb). That module performs another injection (of](https://www.virustotal.com/en/file/e8664c10d439790722673ccbfa9f589d3d4fc67a3288e88ef2f82461dbb60830/analysis/1496222587/)\nmodule: [b622a0b443f36d99d5595acd0f95ea0e) – into Internet Explorer (iexplore.exe):](https://www.virustotal.com/en/file/0521c9246ad9faae379717b17045fc66d1812eaccc39eaa3524347f8e8027b59/analysis/1496224646/)\n\nThe module injected in the iexplore.exe process is responsible for establishing connection\nwith the CnC and downloading submodules.\n\nAt this stage, LatentBot creates two groups of registry keys:\n```\n...\\Software\\Google\\Update\\network\\secure\n\n```\nIn the key named “0” the initial PE file is stored:\n\n\n-----\n\nAnother, encrypted key is added under:\n```\n...\\Software\\Adobe\\Adobe Acrobat\n\n```\nThe data under the key “in” is encrypted by a custom algorithm, typical for the LatentBot, that\n[will be described further (it can be decoded by a dedicated application). After decoding, it](https://github.com/hasherezade/malware_analysis/blob/master/latent_bot/latent_decode.cpp)\ngives the path where the malware installed itself, i.e.:\n```\nC:\\Users\\tester\\AppData\\Local\\Microsoft\\Windows\\shfdnoh.exe\n\n```\nIf the CnC is active and the bot managed to download sub-modules, they are run injected\ninto new instances of svchost:\n\nThe main module is deployed with a parameter: -l MxN4ViazcD\n\nThis parameter specifies a group id where the bot belongs (also encrypted by Latent Bot’s\ncustom crypto).\n```\nMxN4ViazcD > Group 1\n\n```\n\n-----\n\nAlso, the registry keys related to the new modules are added under:\n```\n...\\Software\\Google\\Update\\network\\secure\n\n```\nDecrypted names of the modules are very descriptive:\n```\nFtUFJu5xP3C -> formgrab\nhdtWD3zyxMpSQB -> Bot_Engine\nl551X+rNDh3B4A -> Found_Core\nQdG8eO0qHI8/Y1G -> send_report\nQdW/DoI2F9J -> security\nRRrIibQs+WzRVv5B+9iIys+17huxID -> remote_desktop_service\nVRWVBM6UtH6F+7UcwkBKPB -> vnc_hide_desktop\nw97grmO -> Socks\n\n```\nSome of the modules are collecting data on the victim machine, and saving them in the\n%TEMP% directory in encrypted form:\n\n\n-----\n\nFurther, they are being uploaded to the CnC.\n\n**Persistence**\n\nThe basic persistence of Latent Bot is simple. The initial sample is copied into:\n\n_C\\[current user]\\AppData\\Local\\Microsoft\\Windows\\<random_name>.exe_\n\nIt is executed on each system startup thanks to a simple Run key:\n\nOnce the main module is run, it is responsible for decrypting all the submodules from the\nregistry and loading them.\n\n## Network communication\n\nThe bot starts communication with CnC by sending a beacon. If the beaconing went\nsuccessfully, it starts to download additional modules in encrypted form. They are pretending\nto be .zip files:\n\n\n-----\n\nThe beacon is encoded by two algorithms: Latent’s custom encryption and then Base64:\n```\nQWRsN2srdjlxUUdDYVp0aTBMUzl2cStzY0pOR3VkWlNtc3Q1VzduWlJ2SHZ6QjJhNEtuTFo3RUNobVlOKzJMbD\n\n```\nBase64 decoded:\n```\nAdl7k+v9qQGCaZti0LS9vq+scJNGudZSmst5W7nZRvHvzB2a4KnLZ7EChmYN+2Ll14MlAQtv5wqzPmJMZx3Z5T\n\n```\nLatent custom decoded:\n```\nforum?datael=US-70-789548274695&ver=5015&os=5&acs=1&x64=0&gr=Group\n1&random=mxmgkuusrfqdotm\n\n```\nAs we can see, it contains data about the infected machine, as well as the group name and a\nrandom token.\n\nHowever, not all the communication is encrypted. Some of the further requests are very\nverbose. Name of each action is identified by a string, in capital letters. Examples:\n\n\n-----\n\nClient beacons to the server by a HELLO command. In return, the CnC gives it a cookie that\nis further used as an ID. The content posted between the client and the server is encrypted:\n\n\n-----\n\nAnalyzing the traffic, we can find that the bot sends to the CnC some stolen data, packed as\nCabinet format. The content inside is encrypted by a custom encryption algorithm, typical to\n[LatentBot, that will be described later. The file is uploaded using HTTP PUT method:](https://stackoverflow.com/questions/630453/put-vs-post-in-rest)\n\n\n-----\n\n## Inside\n\nThe original sample of Latent Bot, that is distributes in campaigns, comes packed with a\ncrypter. After removing this first layer, we get a loader with the following structure of sections:\n\nAll the used strings are obfuscated – particular chunks of the string are being moved to\nconsecutive variables:\n\n\n-----\n\nThe basic role of the main element is to to make injection into svchost.exe. In the memory of\n_svchost.exe, another PE file is unpacked and loaded:_\n\n\n-----\n\nIf we dump this file, we find another stage. Starting from this element, all further pieces of\nLatent Bot have some common patterns. They are written in Delphi, and their strings are\nobfuscated by the same set of functions. Example:\n\n[In order to defeat this obfuscation I prepared a dedicated IDA script (latent_dec.py). Not](https://github.com/hasherezade/malware_analysis/blob/master/latent_bot/latent_dec.py)\nmuch of the other obfuscation techniques has been used, so after applying it, the code looks\nmuch more understandable:\n\nWatch Video At:\n\nhttps://youtu.be/gMVJtOPUmkk\n\nAnother thing, typical for LatentBot’s pieces are the resources following similar schema. The\ncurrent sample comes with 2 resources: CFG and R. Both of them are encrypted:\n\n\n-----\n\n[This element unpacks another module (b622a0b443f36d99d5595acd0f95ea0e), that is](https://www.virustotal.com/en/file/0521c9246ad9faae379717b17045fc66d1812eaccc39eaa3524347f8e8027b59/analysis/1496224646/)\ninjected this time into iexplore. The new module has resources with a structure similar to the\nprevious one. It’s CFG file contains strings encrypted by an algorithm typical for this bot:\n\nThe configuration of this element contains the bot group ID and the CnC address:\n```\nMxN4ViazcD -> Group 1\nj5kmNVnZPcAt18wWBH3kfMOzGQ6ENA -> http://104.232.32.101/\n\n## Modules\n\n```\n\n-----\n\nThe main element of the LatentBot is an engine downloading and managing the modules.\nEach module of LatentBot have some different task to do. Overall, it has capabilities of a\ntypical RAT and stealer. Downloaded submodules are various for various samples. In the\nanalyzed one, elements with the following names has been fetched:\n\nformgrab-128521-2\nBot_Engine-641712-8\nFound_Core-147200-2\nsend_report-325310-77\nsecurity-945874-2\nremote_desktop_service-828255-2\nvnc_hide_desktop-590642-47\nSocks-400578-2\n\nLet’s have a look inside some of them…\n\n## Bot_Engine Module\n\nAs the name states, this is the main module of the bot. It is responsible for the\ncommunication with the C&C and loading the plugins.\n\nIt fingerprints the environment and send the collected data in the beacon to the CnC.\n```\n'tkNFKRA' -> '&ver='\n'tA8OqC' -> '&os='\n't4M5zB' -> '&av=\"'\n't4c85aF' -> '&acs='\n'tct4rwD' -> '&x64='\n'tgszOD' -> '&gr='\n'tMc36A' -> '&li=W4'\n't89KWAf3QyCh' -> '&plugins='\n'to8KKL6mYGs8' -> '&errcode='\n't08rKTC' -> '&bk=1'\n't08rKXC' -> '&bk=0'\n'tEMeVgHimC' -> '&note=1'\n'tEMeVgHinC' -> '&note=0'\n'tsMSYj/L' -> '&dom=1'\n'tsMSYjvL' -> '&dom=0'\n'tw9sex5WXDzsMB' -> '&sockslog='\n'tk9H0psjw5Wv' -> '&vncpass='\n'tkNGWE8KNC+N' -> '&vidtype='\n\n```\n\n-----\n\nExample – checking installed AV products:\n\nThe dedicated function contains a long list of the directories that are checked,i.e.\n\nThis module gives to the attacker remote control on the victim’s environment by executing\nvarious commands, such as:\n\n\n-----\n\n```\n /tKvXgFBlB > testapi \n'slx6nfFi' -> 'get_id'\n'5J5eN0Wp9A' -> 'restart'\n'4FEa7FfTRCI' -> 'shutdown'\n'nxRY+d/E' -> 'logoff'\n'slx6nLVh9Et/qqi2eUpf9D' -> 'get_label_engine'\n'slx6nLVh9Et/qOCYBWP' -> 'get_label_load'\n'slx6n7kxqMcKNsq0UkmG' -> 'get_plugin_list'\n'7hfCrPhOfgfTX28h8TZS' -> 'plugin_stop_all'\n'7hfCrPhOfkfbTM6EplCNCN1d' -> 'plugin_restart_all'\n'7hfCrPhOfg+PtNcXVAc8JLsPUA' -> 'plugin_clear_storage'\n'41l3p17Xus/kRtagq7ObrZEM/WucXWH' -> 'stop_engine_and_plugins'\n'+FJV1v6mXl5SW7r8cB' -> 'uninstall_all'\n'slx6njktomFaQ0F' -> 'get_version'\n'7hfCrPhOfgfTX2M' -> 'plugin_stop'\n'7hfCrPhOfkfbTM6EplC' -> 'plugin_restart'\n'7hfCrPhOfgfTX28h8bppqx+bZm/CQDXSnB' -> 'plugin_stop_and_uninstall'\n'7hfCrPhOf4vfz5NHktwwJB' -> 'plugin_uninstall'\n'7hfCrPhOfgfTZiCd' -> 'plugin_start'\n'7hfCrPhOfgfTZiCdhJwYvUM' -> 'plugin_start_auto'\n'7hfCrPhOfgfTX28h83I9CD' -> 'plugin_stop_autox'\n'slx6n7kxqMcKNsazBUKWvC' -> 'get_plugin_start'\n'o5SQ6EkjlBwmdJhahA' -> 'clear_cookies'\n\n```\nExample – fragment of the function stealing and clearing the cookies:\n\nAfter completing a task, it also sends a report about the operation status:\n\n\n-----\n\n## Security Module\n\nThis module performs extended environment check against various security products.\nLooking at the resources, we can find three elements: DFX, VBL, FDL containing lists of\nstrings encrypted in the typical way:\n\n[Decrypting them gives an extensive list of the checked paths: DFX,](https://gist.github.com/hasherezade/de2df50e5a596ec436bd8e8007489016#file-dfx-txt) [VBL, and modules (exe,](https://gist.github.com/hasherezade/de2df50e5a596ec436bd8e8007489016#file-vbl-txt)\ndll, sys): [FLD](https://gist.github.com/hasherezade/de2df50e5a596ec436bd8e8007489016#file-fdl-txt)\n\n## Formgrab Module\n\nIn comparison to other modules, this one does not contain string or API obfuscation.\n\n\n-----\n\nWe can find it grabbing the content of fields of the windows:\n\n…and tapping the typed keys:\n\n\n-----\n\n## Foud_Core Module\n\nThis is the only module that has been written in C++ instead of Delphi. It comes with a\ndefault icon added to Windows projects by Visual Studio.\n\nIt’s original name is installer.exe and it exports various functions, that can be used to make\ninjections into 64 bit applications:\n\n\n-----\n\nIt has various features that are different from other modules, i.e. lack of string obfuscation.\nPerformed actions are reported by debug strings, that are stored inside the binary as open\ntext, i.e.\n\n\n-----\n\nThe compilation timestamp of this executable points at the February of 2017: 2017:02:28\n_18:21:01+01:00. This element was not observed in previous years, so probably indeed it is_\nadded this year, to expand injection capabilities of the LatentBot to 64 bit processes.\n\n## Conclusion\n\nLatentBot has been around for several years, however, looking at the modules we can find\nout that it is still being actively maintained. The distributed package is a mixture of old and\nnew modules.\n\nThe authors of this bot are not very advanced in malware development. They program in\nDelphi and use some ready-made templates. Also, the obfuscation they use can be easily\ndefeated. However, they delivered a bot that is very rich in features and easily expandable,\nthus, it still poses a serious threat.\n\n## Appendix\n\n\n-----\n\n[https://www.cert.pl/news/single/latentbot-modularny-i-silnie-zaciemniony-bot/ – Polish CERT](https://www.cert.pl/news/single/latentbot-modularny-i-silnie-zaciemniony-bot/)\non LatentBot (December 2016)\n\n[https://www.fireeye.com/blog/threat-research/2015/12/latentbot_trace_me.html – FireEye on](https://www.fireeye.com/blog/threat-research/2015/12/latentbot_trace_me.html)\nLatentBot (2015)\n\n[https://cys-centrum.com/ru/news/module_trojan_for_unauthorized_access – CyS Centrum](https://translate.google.com/translate?sl=auto&tl=en&js=y&prev=_t&hl=en&ie=UTF-8&u=https%3A%2F%2Fcys-centrum.com%2Fru%2Fnews%2Fmodule_trojan_for_unauthorized_access&edit-text=&act=url)\nreport (2015)\n\n_This was a guest post written by Hasherezade, an independent researcher and programmer_\n_with a strong interest in InfoSec. She loves going in details about malware and sharing threat_\n_[information with the community. Check her out on Twitter @hasherezade and her personal](https://twitter.com/hasherezade)_\n_[blog: https://hshrzd.wordpress.com.](https://hshrzd.wordpress.com/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-06-08 - LatentBot piece by piece.pdf"
    ],
    "report_names": [
        "2017-06-08 - LatentBot piece by piece.pdf"
    ],
    "threat_actors": [
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535607,
    "ts_updated_at": 1743041122,
    "ts_creation_date": 1653751847,
    "ts_modification_date": 1653751847,
    "files": {
        "pdf": "https://archive.orkl.eu/e867370e80dc1ea994da15105cd70cd67aede88f.pdf",
        "text": "https://archive.orkl.eu/e867370e80dc1ea994da15105cd70cd67aede88f.txt",
        "img": "https://archive.orkl.eu/e867370e80dc1ea994da15105cd70cd67aede88f.jpg"
    }
}