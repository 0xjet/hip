{
    "id": "05725bdb-a45c-4f7d-84f3-ddaf24bee032",
    "created_at": "2022-10-25T16:48:21.491564Z",
    "updated_at": "2025-03-27T02:16:20.775959Z",
    "deleted_at": null,
    "sha1_hash": "c2ec1036a969d9b8e470e0b1bcaf88069a058b98",
    "title": "",
    "authors": "",
    "file_creation_date": "2018-08-13T19:58:06Z",
    "file_modification_date": "2018-08-13T19:58:09Z",
    "file_size": 1032520,
    "plain_text": "# TURLA OUTLOOK BACKDOOR\n## Analysis of an unusual\n Turla backdoor\n\n\n-----\n\n#### 1. CONTENTS\n\n1. Introduction  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .  3\n\n2. Summary  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .  3\n\n3. Global architecture  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 5\n\n3.1 Installation  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .  5\n\nMicrosoft Outlook .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 5\n\nThe Bat!  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .  7\n\n3.2 Interaction with the mail client  .   .   .   .   .   .   .   .   .   .  7\n\nMicrosoft Outlook .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 7\n\nHiding malicious behavior from the user .   .   .   .   .   .   . 11\n\nThe Bat!  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 12\n\n3.3 Backdoor .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 13\n\nPDF format .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 13\n\nCryptography .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 16\n\nFunctions .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  19\n\n3.4 Further features  .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 20\n\nVirtual File System  .   .   .   .   .   .   .   .   .   .   .   .   .   . 20\n\nLogs .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .  21\n\n4. Conclusion .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  21\n\n5. IoCs  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   . 24\n\n5.1 Hashes  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .  24\n\n5.2 Filenames  .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .  24\n\n5.3 Registry Keys .   .   .   .   .   .   .   .   .   .   .   .   .   .   .   .  24\n\n\n-----\n\n#### 1. INTRODUCTION\n\nTurla, also known as Snake, is an espionage group notorious for having breached some heavily\nprotected networks such as the US Central Command in 2008 [1]. Since then, they have been busy\n\nattacking diplomats and military targets around the world. Among the notable victims were the Finnish\n\nForeign Ministry in 2013 [2], the Swiss military firm RUAG between 2014 and 2016 [3] and more recently,\n\nthe German government at the end of 2017/beginning of 2018 [4].\n\nIn the latter case, several newspapers quickly released some information [5] about the modus\noperandi used by the attackers: they used email attachments to control the malware and also\n\nto transfer the stolen data from the system. However, no technical information about this backdoor\n\nwas publicly available. Herein, we release our in-depth analysis of this Turla backdoor, controlled via\n\nPDF attachments sent via email.\n\nAs media reported [6], several computers of the German Foreign Office were infected by this backdoor.\n\nThe attack apparently started in 2016 and was detected by the German security services at the end of\n\n2017. The attackers first infected the Federal College of Public Administration (Hochschule des Bundes),\n\na federal administrative university, and moved through its network until they were able to access\n\nthe Foreign Office network in March 2017. Thus, Turla operators had access to some highly sensitive\n\ninformation (such as emails sent by the German Foreign Office staff) for almost a year.\n\nOur investigation also reveals this piece of malware targeting Microsoft Outlook was used against\n\nvarious political and military organizations. We were able to ascertain that the Foreign Offices of two\n\nother European governments and a large defense contractor were compromised. Our investigation\n\nalso led to the discovery of dozens of email addresses registered by Turla operators for this campaign\n\nand used to receive exfiltrated data from the victims.\n\n#### 2. SUMMARY\n\nThe Turla Outlook backdoor has two interesting functionalities.\n\nFirst, it steals emails by forwarding all outgoing emails to the attackers. It mainly targets Microsoft\n\nOutlook, a widely used mail client, but also targets The Bat! [7], a mail client very popular in Eastern\n\nEurope.\n\nSecond, it uses email messages as a transport layer for its Command & Control (C&C) protocol.\n\nData, such as files requested via a command of the backdoor, is exfiltrated in specially-crafted PDF\n\ndocuments attached to emails, and commands are also received in PDF attachments. Thus, its behavior\n\nis particularly stealthy. It is important to note that no vulnerabilities were used either in PDF readers nor\n\nin Outlook. What actually happens is that the malware is able to decode data from the PDF documents\n\nand interpret it as commands for the backdoor.\n\nThe targets are in line with traditional Turla operations. We identified several European governments\n\nand defense companies compromised with this particular backdoor. Thus, it seems the attackers use\n\nit to maintain persistence in the most restricted networks where well-configured firewalls, or other\n\nnetwork security systems, could effectively block traditional C&C communication through HTTP(S).\n\nFigure 1 shows that the strings within the malware include some government-related top level domains.\n\nMFA stands for Ministry of Foreign Affairs, .gouv is the subdomain used by the French government\n\n(.gouv.fr) and ocse refers to the Organization for Security and Co-operation in Europe.\n\n\n-----\n\nFigure 1 // Government related domains found within the malware strings\n\nBased on our research and telemetry, we identified this backdoor as having been in the wild since\n\nat least 2013. As usual with Turla, it is not possible to rely on compilation timestamps as they are gen­\n\nerally faked. However, we believe the first versions have been compiled earlier than 2013 as the version\n\nreleased in 2013 was already pretty advanced. We then found a more basic version, whose compilation\n\ntimestamp is 2009, but we were unable to identify its release date with reasonable accuracy.\n\nFigure 2 is the timeline based on our telemetry and publicly available information.\n\n\n### 2009\n\n\n### 2013\n\n_Improvement:Improvement: the backdoor_\ncould execute commands.\nThey are sent by email\nin XML format.\n\n### 2018\n**April**\n\n_Improvement:Improvement: the_\nbackdoor can execute\nPowerShell commands\nby leveraging Empire\nPSInject.\n\n\n### 2013\n\nLast known version\ntargeting The Bat!\nemail client.\n\n### 2018\n**March**\n\nPublic announcement\nof the compromise\nof the German\ngovernment.\n\n\n### 2016\n\n_Improvement:Improvement: the_\ncommands are now\nsent as attachments\nin specially crafted\nPDF documents.\n\n### 2017\n\n_Improvement:Improvement: the_\nbackdoor is able to\nbuild PDF documents\nto exfiltrate data\nto the attackers.\n\n\nFigure 2 // Turla Outlook backdoor timeline\n\n\n##### In short\n\n###### Data exfiltration\n\n- All outgoing emails are forwarded to the\n\nattackers.\n\n- Metadata (email addresses, subject, and\n\nattachment names) of incoming emails is\n\nlogged.\n\n- Any file requested by the attackers via the\n\nbackdoor.\n\n\n###### Backdoor\n\n- Execute additional programs and /or\n\ncommands\n\n- Download additional files\n\n- Exfiltrate files\n\n- Commands are sent in PDF attachments\n\n- No authentication used to verify identity\n\nof sender of command, leads to additional\n\nsecurity risk for victims\n\n- Highly resilient against take-down\n\n\n-----\n\n#### 3. GLOBAL ARCHITECTURE\n\nIn the most recent versions, the backdoor is a standalone Dynamic Link Library (DLL) that has code\n\nfor installing itself and interacting with the mail clients Outlook and The Bat!, even if only the installa­\n\ntion for Outlook is implemented. Thus, it can easily be dropped by any other Turla component that\n\nis able to execute additional processes.\n\nIn this section, our analysis is based on a sample released somewhere during the first six months of 2017.\n\nSome specific information about older or newer samples may also be included.\n\n##### 3.1 Installation\n\nIn order to install the backdoor, attackers execute the DLL export called Install or register it using\n```\nregsvr32.exe. The argument is the targeted mail client. Figure 3 shows the different possible values.\n\n```\nHowever, in the most recent versions, only the installation for Outlook is implemented.\n\nFigure 3 // Possible arguments for the installation\n\nThere is no hardcoded path so the DLL file may be located anywhere on the disk.\n\n###### Microsoft Outlook\n\nOnce again, the Turla developers rely on COM object hijacking to establish persistence for their malware.\n\nThis is a well-known technique used for many years in the wild and in particular by the Turla group [8].\n\nIt consists in redirecting a COM object used by the targeted application, by modifying the corresponding\n\nCLSID entry in the Windows registry.\n\nIn that case, the following modifications are made in the Windows registry:\n```\n HKCU\\Software\\Classes\\CLSID\\{49CBB1C7-97D1-485A-9EC1-A26065633066} =\n Mail Plugin\n HKCU\\Software\\Classes\\CLSID\\{49CBB1C7-97D1-485A-9EC1-A26065633066}\\InprocServer32 =\n [Path to the backdoor DLL]\n HKCU\\Software\\Classes\\CLSID\\{49CBB1C7-97D1-485A-9EC1-A26065633066}\\InprocServer32\\\n ThreadingModel =\n  Apartment\n HKCU\\Software\\Classes\\CLSID\\{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D}\\TreatAs =\n {49CBB1C7-97D1-485A-9EC1-A26065633066}\n{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D} is the hijacked CLSID. It corresponds to the\n\n\n```\n“Outlook Protocol Manager” and theoretically loads the legitimate Outlook DLL OLMAPI32.DLL.\n```\n{49CBB1C7-97D1-485A-9EC1-A26065633066} is not associated with any known software.\n\n\n```\nThis CLSID value is arbitrary and is only used as a placeholder for the COM redirection.\n\n\n-----\n\nOnce the modification is made, the backdoor DLL will be loaded every time Outlook loads this\n\nCOM object. Based on our observations, it seems to happen during the launch of Outlook.\n\nThis COM redirection does not need administrative privileges as it only applies for the current user.\n\nSome protections exist to prevent these kinds of malicious redirections. According to MSDN [9]:\n\n_Beginning with Windows Vista® and Windows Server® 2008, if the_\n\n_integrity level of a process is higher than Medium, the COM runtime_\n\n_ignores per-user COM configuration and accesses only per-machine_\n\n_COM configuration._\n\nHowever, the Outlook process runs at medium integrity level, as shown in Figure 4.\n\nThus, it is not protected against per-user COM redirections.\n\nFigure 4 // Integrity level of the Outlook process\n\nFinally, using COM hijacking allows the backdoor to remain stealthy, as the path to the backdoor,\n```\nC:\\Users\\User\\Documents\\mapid.tlb in this example, is not displayed in the plugin list as shown\n\n\n```\nin Figure 5.\n\nFigure 5 // Outlook list of plugins – mapid.tlb is not displayed\n\n\n-----\n\nEven if the malware is not displayed in the Add-Ins list, it uses a standard Microsoft API,\n\ncalled MAPI (Messaging Application Programming Interface), to interact with Outlook.\n\n###### The Bat!\n\nAs explained in the timeline in Section 2, recent versions of the backdoor no longer include the code\n\nto register a The Bat! plugin. However, all the code for managing mailboxes and emails is still there.\n\nThus, it could be manually setup if needed.\n\nTo register as a plugin for The Bat!, the malware was modifying the file %appdata%\\The Bat!\\Mail\\\n```\nTBPlugin.INI. This is the legitimate method to register a plugin for The Bat! and some plugins such\n\n\n```\nas anti-spam plugins also rely on it.\n\nAfter registration, each time The Bat! is launched, the backdoor DLL is called. Figure 6 shows\n\nthat the DLL implements some exports needed for the plugins.\n\nFigure 6 // Standard exports for a The Bat! plugin\n\n##### 3.2 Interaction with the mail client\n\nInteraction with the mail client varies according to which client is targeted.\n\n###### Microsoft Outlook\n\nMicrosoft maintains an API, the Messaging Application Programming Interface (MAPI), which allows\n\napplications to interface with Outlook [10]. This Turla backdoor leverages this API to access and manage\n\nthe mailbox(es) of the person(s) using the compromised system.\n\nFirst, it connects to the messaging system using MAPILogonEx as shown in Figure 7.\n\n\n-----\n\nFigure 7 // MAPI logon\n\nThe second parameter (lpszProfileName) is empty and the flag MAPI_USE_DEFAULT is set. According\n\nto the documentation:\n\n```\nMAPI_USE_DEFAULT\n\n```\n\n_The messaging subsystem should substitute the profile name_\n\n_of the default profile for the lpszProfileName parameter. The MAPI__\n```\n         EXPLICIT_PROFILE flag is ignored unless lpszProfileName\n\n```\n_is NULL or empty._\n\nOn the contrary, the flag MAPI_NEW_SESSION is not set. According to the documentation:\n\n```\nMAPI_NEW_SESSION\n\n```\n\n_The lpszProfileName parameter is ignored if there is an existing_\n\n_previous session that called MapiLogonEx with the MAPI_ALLOW__\n```\n         OTHERS flag set and if the flag MAPI_NEW_SESSION is not set.\n\n```\nWe believe Outlook opens the default session with the flag MAPI_ALLOW_OTHERS. Thus, the backdoor\n\nwill use this previously opened session to gain access to the default mailbox profile. This explains why\n\nthere is no prompt for a profile name and password when the backdoor plugin initializes.\n\nHaving done so, it has access to the full mailbox and can easily manage it using other MAPI functions.\n\nIt will iterate through the various message stores, parse the emails and add callbacks on the inbox(es)\n\nand outbox(es). The log file summarizes this process:\n```\n <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\n  ========= Analyzing msg store ( 1 / 1 ) =========\n Service name:MSUPST MS\n Pst path:C:\\Users\\[username]\\Documents\\Outlook Files\\[email address].pst\n   Wait main window before open current store\n    Loop count = 46\n This is default message store\n  PUSH store to list\n  >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\n  _____________ FOLDERS _____________\n  Setting sink on folders in 1 stores.\n  ========Process msg store ( 1 / 1 ) =========\n  Account: [email address]\n  Successfull set sink on Outbox folder of current store.\n Successfull set sink on Inbox folder of current store.\n\n```\nFigure 8 // Log file (Untouched except for the redacted username and email address)\n\n\n-----\n\nIt sets up callbacks on every inbox and outbox folder, using the function HrAllocAdviseSink,\n\nas shown in Figure 9.\n\nFigure 9 // Callback registration on the outbox folder\n\n###### Inbox callback\n\nThe inbox callback first logs metadata about the incoming email. This includes the sender, receiver(s),\n\nsubject, and attachment name. An example is shown below:\n```\n RECIVE ->{\n  From: sender@example.com\n  To:  receiver@example.net\n  Cc: \n  Bcc:\n  Subj: Mail subject\n  Att: an_attachment.pdf\n }\n\n```\nFigure 10 // Log for a new incoming email (English mistakes are those of the developer)\n\nIt then parses the email, and its attachment(s), to check if they contain commands from the attacker.\n\nThis functionality will be studied in detail in Section 3.3.\n\nFinally, it intercepts Non Delivery Report (NDR) emails by checking if the incoming email contains\n\nthe operator’s email address. Consequently, any email containing the operator’s email address will\n\nalso be discarded. This might cause a problem if victims become suspicious and contact their IT support,\n\nas the victims will not be able to see the replies.\n\n\n-----\n\n###### Outbox callback\n\nSimilar to the inbox callback, the outbox callback logs metadata of each outgoing email. It generates\n\nthe same kind of log:\n```\n 21:57:56\n SEND <-{\n  From:\n  To:  recipient@example.com\n  Cc:\n  Bcc:\n  Subj: My title\n  Att: [1] “last_presentation.pdf”\n }\n 21:57:56 Sending data message\n 21:57:56 Message ENTRYID: [Message ENTRYID]\n 21:57:56 Data message was send. To: [redacted]@gmx[.]com From: Subj: My title\n 21:57:56 Set last time.\n 21:57:56 Spawned thread for cleaning up outgoing messages (id 2848)\n 21:58:34 Ending work, client: Outlook\n 21:58:34 Number of messages to remove: 1\n 21:58:34 Message ENTRYID: [Message ENTRYID]\n 21:58:34 DeleteMessages executed successfully.\n 21:58:34 Number of not removed messages: 0\n\n```\nFigure 11 // Log for outgoing emails. The operator email address has been partially redacted.\n\nHowever, you may notice that it also forwards each outgoing email to the attacker’s email address,\n```\n[redacted]@gmx[.]com. GMX is a popular, free email service. Both characteristics explain why the\n\n```\nattackers chose to register their email there, as it is very unlikely that an organization would routinely\n\nblock the gmx.com domain.\n\nThis email address is hardcoded in the sample we studied, as shown in Figure 12, but it can\n\nbe updated via one of the backdoor functions. They seem to register at least one email address\n\nper targeted organization using the format firstname.lastname@gmx[.]com, by impersonating\n\nthe name of a real employee. This maintains stealth as it might be difficult to differentiate the illicit\n\naddress from the real private email address of the victim. In addition, the address was unreachable\n\nwhen we analyzed the sample in June 2018.\n\nFigure 12 // Hardcoded operator email address\n\nAt regular intervals, the backdoor sends a report to the attacker’s email address. It contains some\n\nunique identifiers such as the MAC address, the full log file and the command results, if any. Then,\n\nit encrypts the data, using MISTY1 as described later in Section 3.3.2.2, and constructs a valid PDF\n\n\n-----\n\ncontaining the encrypted content. Just before the encrypted blob of data, the document contains\n\na white 1x1 jpeg image, which is hardcoded in the malware. It allows them to create a valid PDF\n\ndocument which, when opened, display a single blank page only.\n\nFinally, it attaches the PDF and sends the email to the attacker’s address. Figure 13 is an example\n\nof a PDF created by the backdoor.\n\nFigure 13 // Beginning of the PDF generated by the backdoor for exfiltration purposes\n\nThis report is sent by the outbox callback function, meaning the email will be sent at the same time\n\nas the user sends a legitimate email. In this way, it prevents the backdoor from sending exfiltration\n\nemails at unusual times, which could facilitate detection. This is a very stealthy Command & Control\n\nmechanism that can be hard to catch in the wild.\n\n###### Hiding malicious behavior from the user\n\nAs the backdoor works at the same time as the user is using their computer and Outlook, efforts are\n\nmade to hide the various malicious behaviors that could appear on the screen, such as incoming emails\n\nfrom the attacker.\n\nFirst, the backdoor always deletes all the emails that are sent to or received from the attacker. As shown\n\nin Figure 14, it is possible to see for a few seconds that a new message arrived but it is not displayed\n\nin the mailbox.\n\nFigure 14 // Unread email\n\nSecond, it hooks the CreateWindowsEx function as shown in Figure 15 and Figure 16. It prevents\n\nthe creation of windows of type NetUIHWND, the type of windows used by Outlook for its notifications\n\ndisplayed at the bottom right of the screen.\n\n\n-----\n\nFigure 15 // Setup of CreateWindowsEx hook\n\nFigure 16 // CreateWindowsEx hook\n\nFigure 17 is an example of a NetUIHWND window that is normally triggered in Outlook when\n\na new message is received. As a result of the CreateWindowEx hook, no notification is displayed\n\nto the user when the attacker sends an email to the backdoor.\n\nFigure 17 // New message notification\n\n###### The Bat!\n\nEven though the installation function to register a plugin for The Bat! is no longer present,\n\nthere is legacy code that implements the same functionality as for Outlook, but using The Bat! API.\n\nAs shown in Figure 18, it uses a pipe to communicate with The Bat! in order to fetch users’ information,\n\nread and send emails. However, all the remaining functions, such as those used to log emails or execute\n\ncommands, are completely identical to Outlook.\n\n\n-----\n\nFigure 18 // The Bat! pipe\n\n##### 3.3 Backdoor\n\nAs detailed in the previous section, this malware is able to manipulate and exfiltrate emails. This\n\nis also a full-featured backdoor controlled by email, and which can work independently of any other\n\nTurla component. Therefore, the backdoor does not need a full-internet connection and can work on\n\nany computer able to send external emails. This could be very useful in strictly controlled environments\n\nwith, for example, a highly filtered internet connection. Moreover, even if the attackers’ email address\n\nis disabled, they can still regain control of it by sending a command from another address. This email\n\nwould be hidden from the user too, as it would contain commands interpreted by the backdoor.\n\nThus, this malware is almost as resilient as a rootkit inspecting the incoming network traffic.\n\n###### PDF format\n\nIn early 2018, multiple media claimed that Turla operators used mail attachments to control\n\ninfected machines.\n\nIt turns out that this information is accurate. In-depth analysis of the Turla Outlook backdoor\n\nenabled us to ascertain how the commands are sent and interpreted by the malware.\n\nThe commands are sent via email messages with specially crafted PDF attachments. We were not able\n\nto capture any real sample of PDFs containing commands but they are probably valid PDF documents,\n\nas are the PDFs generated by the backdoor for exfiltration purposes.\n\n\n-----\n\nFrom the PDF documents, the backdoor is able to recover what attackers call a container in the logs.\n\nThis is a binary blob with a special format that contains encrypted commands for the backdoor. Figure\n\n19 shows the routine responsible for extracting this container. Technically, the attachment does not\n\nhave to be a valid PDF document. The only requirement is that it includes a container in the right format.\n\nFigure 19 // Extraction of the command container from the PDF\n\nThe container has a very complex structure, with many different checks. While it could have been\n\ndesigned to prevent communication errors, we believe the structure was mostly created to hamper\n\nthe reverse engineering process. Figure 20 summarizes the structure of the container.\n\n\n-----\n\nJust before the initialization vector, there is a list of instruction descriptors. The following table describes\n\nthe different ID values:\n\nTable 1. Container: Description of the headers\n\nID Description\n\n2 Offset of the decryption function (should be 0x11)\n\n3 Decryption key ID (should be 0x1)\n\n4 Offset of the decompression function (should be 0x11)\n\n6 Size of encrypted data\n\n7 CRC32 of encrypted data\n\n\n-----\n\nThe descriptors of IDs 2 and 4 are used to retrieve the encryption and decompression functions,\n\nas shown in Figure 21. However, only one encryption algorithm and one compression algorithm\n\nare implemented in the malware. Thus, the only objective of these fields is to complicate the analysis\n\nof the backdoor.\n\nFigure 21 // Decompression and decryption function offsets\n\nThe commands are in the last part of the structure. They are encrypted using MISTY1 and compressed\n\nwith bzip2. In the same PDF, many different commands can be included, and each command can have\n\nmultiple arguments.\n\n###### Cryptography\n\nHere we describe the encryption algorithms used.\n\n\n-----\n\n###### XOR encryption\n\nA part of the container (starting at the first CRC32) is XORed with a byte stream generated\n\nby a custom function. It takes a seed, which is passed to srand, to generate a second seed by calling\n```\nrand. This second seed is used in the function, shown in Figure 22, as an argument, with the data to XOR:\n int __usercall F_bytestream_xor@<eax>(unsigned int len@<edx>, int ciphertext@<ecx>,\n unsigned int seed)\n {\n   unsigned int v3; // ebx\n   int v4; // esi\n   unsigned int v5; // edi\n   int result; // eax\n   unsigned int v7; // ecx\n   char *v8; // edx\n   unsigned int v9; // esi\n   byte key[512]; // [esp+Ch] [ebp-204h]\n   char *v11; // [esp+20Ch] [ebp-4h]\n   v3 = len;\n   v11 = (char *)ciphertext;\n   srand(seed);\n   v4 = 0;\n   v5 = 0;\n   do\n   {\n      result = rand();\n      *(_DWORD *)&key[4 * v5++] = result;\n   }\n   while ( v5 < 128 );\n   v7 = 0;\n   if ( !v3 )\n      return result;\n   v8 = v11;\n   do\n   {\n      v8[v7] ^= key[v4];\n      v9 = v4 + 1;\n      result = -(v9 < 512);\n      v4 = result & v9;\n      ++v7;\n   }\n   while ( v7 < v3 );\n   return result;\n }\n\n```\nFigure 22 // XOR stream function (HexRay decompilation output)\n\n###### MISTY1\n\nTurla developers like to use less common or modified encryption algorithms in their backdoors:\n\n- For Carbon and Snake, they used CAST-128 [11]\n\n- For Gazer, they used a custom implementation of RSA [12]\n\n- For Mosquito, they used Blum Blum Shub as the random number generator for their XOR byte\n\nstream [13]\n\n- For the Uroburos rootkit, they used a modified version of ThreeFish [14]\n\nIn the Outlook backdoor, they implemented MISTY1 [15], which is a symmetric encryption algorithm\n\ncreated by cryptographers from Mitsubishi Electric in 1995. It has the following properties:\n\n- Is Symmetric\n\n- Has a 128-bit key\n\n- Employs two pre-computed tables: s7 (128 bytes) and s9 (2048 bytes)\n\n\n-----\n\n- Uses three functions: FL, FO, FI\n\n - FL performs some XOR operations between the entry byte and the expanded key\n\n - FO also performs XOR operations between the entry and the expanded key, but also uses FI\n\n - FI performs a non-linear substitution using s7 and s9\n\n- Operates on blocks of 64 bits\n\n- Perform Eight rounds (a round is a call to the function FO)\n\n- Uses a Feistel cipher\n\nFigure 23 // MISTY1\n\nFigure 24 // Eight rounds to encrypt a block\n\n\n-----\n\nHowever, Turla developers have slightly modified the algorithm:\n\n- They added two XOR operations in the FI function, as shown in Figure 25\n\n- The 128–bit key is generated from two hardcoded 1024–bit keys plus a 2048–bit Initialization Vector.\n\n- They changed the s7 and s9 tables. This breaks all the tools that recognize cryptographic algorithms\n\nbased on the s-table values. Both the modified and original s-tables contain the same values.\n\nThey were simply shuffled.\n\nFigure 25 // Comparison of FI functions (Left: Original, Right: Turla implementation)\n\n###### Functions\n\nThe backdoor implements many different commands, from file exfiltration to execution of commands.\n\nTable 2 shows the different functions:\n\n\nTable 2. List of backdoor commands\n\n\nID Description\n\n0x10 Not implemented\n\n0x11 Display a MessageBox\n\n0x12 Sleep\n\n0x20 Delete file\n\n0x21 Get file\n\n0x22 Set operator email address (overriding the initial one hardcoded in the DLL)\n\n0x23 Put file\n\n0x24 Run shell command\n\n0x25 Create process\n\n0x26 Delete directory\n\n0x27 Create directory\n\n0x28 Change timeout (interval for emails sent to the operator)\n\n0x29 Run Powershell command (Empire PSInject) – 2018 version of the backdoor\n\n0x2A Set answer mode – 2018 version of the backdoor\n\n\n-----\n\nFor function 0x29, Turla developers copied code from the Empire project PSInject [16]. It allows\n\nthem to run PowerShell code in a special executable called a PowerShell Runner, without calling\n```\npowershell.exe. The main advantage is that the malware is still able to execute PowerShell\n\n\n```\ncommands even if powershell.exe is blocked on the compromised computer.\n\nFollowing thorough analysis of the malware, we were able to craft a PDF that can be successfully\n\ninterpreted by the backdoor. Figure 26 shows the execution of a MessageBox and the launch of a\n\ncalculator (calc.exe) after Outlook received an email containing that PDF document. It demonstrates\n\nthat this backdoor, apparently designed to receive commands via PDF email attachments, is functional\n\nand may be controlled by anybody who understands its custom format.\n\nFigure 26 // Execution of the commands specified in the PDF document\n\n##### 3.4 Further features\n\nApart from its backdoor functionality implemented as an email client plugin, this malware has a couple\n\nof features worth describing further.\n\n###### Virtual File System\n\nThis malware does not use any configuration file but it maintains a small virtual file system in the\n\nwindows registry under the key HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Settings\\\n```\nZonePolicy\\. Other Turla backdoors, such as Gazer [12], also keep a VFS in the Windows registry.\n\n\n```\nWe were able to identify the meaning some of the registry values, as shown in Table 3.\n\n\nTable 3. Virtual File System\n\n\nRegistry value name Description\n\n0 A timestamp\n\n1 Temporary operator email address\n\n2 Timestamp (last email sent to operator)\n\n9 Number of emails to clean.\n\n10 Time last command container processed\n\n11 Exfiltration enabled\n\n14 Attachment filename of the last received messages\n\n\n-----\n\n###### Logs\n\nAs mentioned before, the program maintains a log that is regularly exfiltrated to the operator via\n\na crafted PDF document attached to an email message. It is stored in %appdata%/Microsoft/Windows/\n```\nscawrdot.db and encrypted using a hardcoded 512-byte XOR key. The log file is cleaned each time\n\n\n```\nit is exfiltrated to the attackers. Thus, while performing forensic analysis, it might not be possible\n\nto see all the past activities of the backdoor, but only the most recent.\n\nThe logs are particularly verbose and may allow the Turla operators to monitor in detail the activities\n\nof the backdoor. Figure 27 is an example of a decrypted log.\n\nFigure 27 // Decrypted log file\n\n#### 4. CONCLUSION\n\nThis report shows that the Turla developers never run out of ideas when it comes to developing stealthy\n\nbackdoors. To our knowledge, Turla is the only espionage group that currently uses a backdoor entirely\n\ncontrolled by emails, and more specifically via PDF attachments.\n\nWhile the Turla Backdoor is not the first backdoor that uses the real mailbox of the victim to receive\n\ncommands and exfiltrate data, it is the first publicly known backdoor using a standard API (MAPI) to in­\n\nteract with Microsoft Outlook. This is a substantial improvement over an older mail-controlled backdoor\n\nwe analyzed [17] which was using Outlook Express, just reading inbox files and writing in outbox ones.\n\nIn contrast, the Turla backdoor works even with recent versions of Outlook.\n\nThanks to its ability to be controlled by seemingly legitimate communication to and from the infected\n\n\n-----\n\nmachine, and its non-dependence on any particular email address, the Turla backdoor is extremely\n\nstealthy and resilient. In this sense, this Outlook backdoor is similar to rootkits, such as Uroburos,\n\nthat receive their commands from incoming network traffic.\n\nOur research shows that compromised organizations are at risk of not only being spied on by the Turla\n\ngroup who planted the backdoor, but also by other attackers. The backdoor simply executes any com­\n\nmands it receives, without being able to recognize the operator. Thus, it is possible that other attackers\n\nhave already reverse-engineered the backdoor and figured out how to control it - and are also spying\n\non victims using the backdoor.\n\nGiven the severity of this threat, we’ve decided to document the format of PDF documents\n\nthat can control the Turla backdoor to help defenders understand, monitor and mitigate its activity.\n\nESET researchers will continue to monitor Turla developments to help defenders to protect\n\ntheir networks.\n\n_Indicators of Compromise can also be found on GitHub. For any inquiries, or to make sample submissions related_\n\n_to the subject, contact us at: threatintel@eset.com._\n\n\n-----\n\n#### REFERENCES\n\n1 B. KNOWLTON, “Military Computer Attack Confirmed,” New York Times, 25 08 2010. [Online]. Available:\n\n_https://www.nytimes.com/2010/08/26/technology/26cyber.html?_r=1&ref=technology. [Accessed 09 04 2018]._\n\n2 “Russian group behind 2013 Foreign Ministry hack,” YLE, 13 01 2016. [Online]. Available:\n\n_https://yle.fi/uutiset/osasto/news/russian_group_behind_2013_foreign_ministry_hack/8591548._\n\n3 MELANI, “ Technical Report about the Malware used in the Cyberespionage against RUAG,” 23 05 2016.\n\n[Online]. Available: https://www.melani.admin.ch/melani/en/home/dokumentation/reports/technical-reports/technical_report_apt_case_ruag.html._\n\n4 P. Oltermann, “German government intranet under ‘ongoing attack’,” The Guardian, 01 03 2018. [Online].\n\nAvailable: https://www.theguardian.com/world/2018/mar/01/german-government-intranet-under-ongoing-attack.\n\n5 M. Schlee, “Hackers used Outlook for cyberattack on German government:\n\nreport,” Politico, 06 03 2018. [Online]. Available: https://www.politico.eu/article/\n_report-hackers-used-outlook-for-cyberattack-on-german-government/._\n\n6 R. Pinkert and H. Tanriverdi, “Hackerangriff gegen Regierung war Teil weltweiter Spähaktion,”\n\nSüddeutsche Zeitung, 02 03 2018. [Online]. Available: http://www.sueddeutsche.de/digital/\n_it-sicherheit-hackerangriff-gegen-regierung-war-teil-weltweiter-spaehaktion-1.3890332._\n\n7 “The Bat!,” Ritlabs, [Online]. Available: https://www.ritlabs.com/en/products/thebat/.\n\n8 P. Rascagneres, “COM Object hijacking: the discreet way of persistence,” 30 10 2014. [Online]. Available:\n\n_https://www.gdatasoftware.com/blog/2014/10/23941-com-object-hijacking-the-discreet-way-of-persistence._\n\n9 “Application Compatibility: UAC: COM Per-User Configuration,” Microsoft, [Online]. Available:\n\n_https://msdn.microsoft.com/en-us/library/bb756926.aspx._\n\n10 “Outlook MAPI Reference,” Microsoft, 04 04 2016. [Online]. Available:\n\n_https://docs.microsoft.com/en-us/office/client-developer/outlook/mapi/outlook-mapi-reference._\n\n11 ESET Research, “Carbon Paper: Peering into Turla’s second stage backdoor,” ESET, 30 03 2017. [Online].\n\nAvailable: https://www.welivesecurity.com/2017/03/30/carbon-paper-peering-turlas-second-stage-backdoor/.\n\n12 ESET Research, “Gazing at Gazer - Turla’s new second stage backdoor,” ESET, 08 2017. [Online]. Available:\n\n_https://www.welivesecurity.com/wp-content/uploads/2017/08/eset-gazer.pdf._\n\n13 ESET Research, “Diplomats in Eastern Europe bitten by a Turla mosquito,” ESET, 01 2018. [Online]. Available:\n\n_https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf._\n\n14 S. L. Berre, “Hey Uroburos! What’s up ?,” [Online]. Available: https://exatrack.com/public/Uroburos_EN.pdf.\n\n15 M. Matsui, “New block encryption algorithm MISTY,” in Fast Software Encryption, 1997.\n\n16 “ Inject PowerShell into any process,” EmpireProject, [Online]. Available: https://github.com/EmpireProject/PSInject.\n\n17 T. Gardoň, “Espionage toolkit targeting Central and Eastern Europe uncovered,” 01 07 2016. [Online]. Available:\n\n_https://www.welivesecurity.com/2016/07/01/espionage-toolkit-targeting-central-eastern-europe-uncovered/._\n\n\n-----\n\n#### 5. IOCS\n\nIndicators of Compromise are presented here as hashes, by filename, or according to registry key.\n\n##### 5.1 Hashes\n\n\nSHA1 hash Component Compilation\n\nTime (GMT)\n\n8A7E2399A61EC025C15D06ECDD9B7B37D6245EC2 Backdoor 2013-06-28\n14:15:54\n\nF992ABE8A67120667A01B88CD5BF11CA39D491A0 Dropper 2014-12-03\n20:50:08\n\nCF943895684C6FF8D1E922A76B71A188CFB371D7 Backdoor 2014-12-03\n20:44:27\n\n851DFFA6CD611DC70C9A0D5B487FF00BC3853F30 Backdoor 2016-09-15\n08:14:47\n\n##### 5.2 Filenames\n\n- `%appdata%/Microsoft/Windows/scawrdot.db`\n\n- %appdata%/Microsoft/Windows/flobcsnd.dat\n\n- `mapid.tlb`\n\n##### 5.3 Registry Keys\n\n\nESET Detection\n\nName\n\nWin32/Turla.N\n\nWin32/Turla.AW\n\nWin32/Turla.R\n\nWin32/Turla.DA\n\n\n\n- `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Settings\\ZonePolicy\\`\n\n- `HKCU\\Software\\Classes\\CLSID\\{49CBB1C7-97D1-485A-9EC1-A26065633066}`\n\n- `HKCU\\Software\\Classes\\CLSID\\{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D}`\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        },
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        }
    ],
    "references": [
        "https://www.welivesecurity.com/wp-content/uploads/2018/08/Eset-Turla-Outlook-Backdoor.pdf",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2018/2018.08.21.Turla.Outlook.Backdoor/Eset-Turla-Outlook-Backdoor.pdf"
    ],
    "report_names": [
        "Eset-Turla-Outlook-Backdoor.pdf",
        "Eset-Turla-Outlook-Backdoor"
    ],
    "threat_actors": [
        {
            "id": "4b076dcb-516e-42fb-9c8f-f153902cd5e9",
            "created_at": "2022-10-25T16:07:23.708745Z",
            "updated_at": "2025-03-27T02:02:09.935617Z",
            "deleted_at": null,
            "main_name": "Hidden Lynx",
            "aliases": [
                "Aurora Panda",
                "Group 8",
                "Hidden Lynx",
                "Operation SMN"
            ],
            "source_name": "ETDA:Hidden Lynx",
            "tools": [
                "AGENT.ABQMR",
                "AGENT.AQUP.DROPPER",
                "AGENT.BMZA",
                "AGENT.GUNZ",
                "BlackCoffee",
                "HiKit",
                "MCRAT.A",
                "Mdmbot.E",
                "Moudoor",
                "Naid",
                "PNGRAT",
                "Trojan.Naid",
                "ZoxPNG",
                "gresim"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a7aefdda-98f1-4790-a32d-14cc99de2d60",
            "created_at": "2023-01-06T13:46:38.281844Z",
            "updated_at": "2025-03-27T02:00:02.792526Z",
            "deleted_at": null,
            "main_name": "APT17",
            "aliases": [
                "G0025",
                "AURORA PANDA",
                "Group 72",
                "G0001",
                "HELIUM",
                "Group 8",
                "Hidden Lynx",
                "Tailgater Team",
                "BRONZE KEYSTONE"
            ],
            "source_name": "MISPGALAXY:APT17",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716501,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1534190286,
    "ts_modification_date": 1534190289,
    "files": {
        "pdf": "https://archive.orkl.eu/c2ec1036a969d9b8e470e0b1bcaf88069a058b98.pdf",
        "text": "https://archive.orkl.eu/c2ec1036a969d9b8e470e0b1bcaf88069a058b98.txt",
        "img": "https://archive.orkl.eu/c2ec1036a969d9b8e470e0b1bcaf88069a058b98.jpg"
    }
}