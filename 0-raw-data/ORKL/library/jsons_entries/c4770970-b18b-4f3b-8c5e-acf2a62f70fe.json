{
    "id": "c4770970-b18b-4f3b-8c5e-acf2a62f70fe",
    "created_at": "2023-01-12T15:01:18.187999Z",
    "updated_at": "2025-03-27T02:16:25.621801Z",
    "deleted_at": null,
    "sha1_hash": "35f5dba7c5c70f55a7e9824cbdd71ff1580847ed",
    "title": "2020-01-21 - Herpaderping- Security Risk or Unintended Behavior-",
    "authors": "",
    "file_creation_date": "2022-05-28T19:28:34Z",
    "file_modification_date": "2022-05-28T19:28:34Z",
    "file_size": 1925762,
    "plain_text": "# Herpaderping: Security Risk or Unintended Behavior?\n\n**[crowdstrike.com/blog/herpaderping-security-risk-or-unintended-behavior/](https://www.crowdstrike.com/blog/herpaderping-security-risk-or-unintended-behavior/)**\n\nJohnny Shaw January 21, 2021\n\nThe answer to that question often depends on who you ask.\n\nBy definition, process herpaderping is a hacking technique in which digital adversaries\nmodify on-disk content after the image has been mapped in order to obscure the process.\nThis obscurity can confuse security products or the operating system itself, sometimes\nallowing malicious code to be executed. For more information on process herpaderping,\n[please read my earlier explainer post here.](https://github.com/jxy-s/herpaderping)\n\n### At a Glance: How Process Herpaderping Occurs\n\n1. Write target binary to disk, keeping the handle open. This is what will execute in\n\nmemory.\n[2. Map the file as an image section (NtCreateSection,](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwcreatesection) [SEC_IMAGE).](https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createfilemappinga)\n3. Create the process object using the section handle (NtCreateProcessEx).\n4. Using the same target file handle, obscure the file on disk.\n5. Create the initial thread in the process (NtCreateThreadEx). At this point the process\n\ncreation callback in the kernel will fire. The contents on disk do not match what was\nmapped. Inspection of the file at this point will result in incorrect attribution.\n\n\n-----\n\n[6. Close the handle. IRP_MJ_CLEANUP will occur here. Since we ve hidden the contents](https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-cleanup)\n\nof what is executing, inspection at this point will result in incorrect attribution.\n\nFrom an OS’s perspective, herpaderp attacks are often categorized as unintentional activity.\nBut from a developer’s point of view, it’s a clear security threat—and a potent one at that.\n\nTo illustrate this principle, let’s take a look at a recent example. Over the summer, it may\nhave appeared that Google distributed a signed copy of Mimikatz. Sounds strange? It should\nbecause Google did not distribute a signed copy of Mimikatz. Rather, if you saw this, you\nwere witnessing a case of process herpaderping, an exploit technique that obscures the\nintentions of a process by modifying the content on disk after the image has been mapped.\n\nMy team disclosed this process herpaderping attack to the Microsoft Security Response\nCenter (MSRC) in mid-July. A case was opened a few days later. MSRC concluded their\ninvestigation near the end of August and determined the findings of the MSRC investigation\nwere valid but did not require immediate servicing.\n\nAnd with that, the case was closed—without a real resolution or timeline for future review,\ndespite our reiterated belief to MSRC that this bug is severe.\n\n**[Review the details here.](https://github.com/jxy-s/herpaderping/blob/main/res/SurivDemo.gif)**\n\n## What Does Herpaderping Mean for Developers?\n\nThe consensus from the cybersecurity community and researchers sees the situation quite\ndifferently. The POC shows this is exploitable and as a “defense evasion” or “masquerading”\ntechnique.\n\nWhen an attack of this nature is miscategorized by an OS as unintentional activity it has\nmajor cybersecurity implications for any and all developers, not just security vendors. For\nexample, where a Microsoft OS categorizes this attack as unintentional, Microsoft Defender\nAntivirus scans completed on the image backing the process may not prevent execution by a\nknown malicious binary. Once the file is copied to the desktop, Microsoft Defender will likely\nrealize there is a problem, but by then, the damage is done.\n\nMany antivirus vendors are thought to be vulnerable to this type of attack, which means that\nmany organizations are at risk of experiencing a herpaderping attack.\n\n\n-----\n\n## Herpaderping: How It s Done\n\nWhen the OS characterizes herpaderping as unintentional activity, it fails to address such\nexploits, and thus the burden of the solution falls on developers, both cybersecurity vendors\nand general app developers. But in order to defend against such attacks, we must first\nunderstand how they work.\n\nGenerally, a security product takes action on process creation by registering a callback in the\n[OS kernel (PsSetCreateProcessNotifyRoutineEx). At this point, a security product may](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-pssetcreateprocessnotifyroutineex)\ninspect the file that was used to map the executable and determine if this process should be\nallowed to execute. However, the kernel callback is invoked when the initial thread is\ninserted, not when the process object is created.\n\nBecause of this disconnect, an actor can create and map a process, modify the content of\nthe file, then create the initial thread. A product that does inspection at the creation callback\nwould then see the modified content.\n\n\n-----\n\nClick image to enlarge\n\nIn addition, some products use an on-write scanning approach that consists of monitoring for\nfile writes. A familiar optimization is recording the file as written and deferring the actual\n[inspection until IRP_MJ_CLEANUP occurs (e.g. the file handle is closed). Thus, an actor](https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-cleanup)\nusing a write -> map -> modify -> execute -> close workflow will subvert on-write scanning\n[that solely relies on inspection at IRP_MJ_CLEANUP.](https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-cleanup)\n\nTo abuse this convention, adversaries first write a binary to a target file on disk. Then, they\nmap an image of the target file and provide it to the OS to use for process creation. The OS\nthen maps the original binary. Using the existing file handle, and before creating the initial\nthread, the adversary then modifies the target file content to obscure or fake the file backing\nthe image. Later, the initial thread is created in order to begin execution of the original binary.\nFinally, the target file handle can be closed.\n\n\n-----\n\n**[Let s look at an example of herpaderping in action.](https://github.com/jxy-s/herpaderping/blob/main/res/ProcessHerpaderp.gif)**\n\nAs you can see in the demo linked above, Cmd.exe is used as the execution target. The first\nrun overwrites the bytes on disk with a pattern. The second run overwrites .exe with\nProcessHacker.exe.\n\nThe herpaderping tool then fixes the binary to look as close to ProcessHacker.exe as\npossible, even retaining the original signature. Note the multiple executions of the same\nbinary and how the process looks to the user compared to what is in the file on disk.\n\nLooking at this flow from Process Monitor, we observe the source file being written and the\nOS mapping the image at the section creation. Using the same handle, the exploit overwrites\nthe source binary with whatever it likes before creating the initial thread. By the time the\nprocess creation notification fires in the kernel the file backing the image is not what was\nmapped:\n\n\n-----\n\nClick image to enlarge\n\nThe [SECTION_OBJECT_POINTERS of the](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_section_object_pointers) [FILE_OBJECT play a key role here. The OS will](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_file_object)\ncache the initial image mapping and re-use the already mapped section, even if there is\n[active write access to the FILE_OBJECT. This also means that a user can open the original](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_file_object)\nfile with exclusive access. While this won’t necessarily create an issue for the kernel\ncallback, it does affect downstream logic in that it assumes that when the user opens the file\nwith read access it will be broken. However, such logic does not apply, given that the file\ncontent has been overwritten. Further, the kernel callback is hopeless too, since reading\n[directly from the file using that FILE_OBJECT will read the wrong data.](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_file_object)\n\n\n-----\n\nThis also means if a user tries to execute that process again it will result in a sharing\nviolation. From user mode, without access to that original target file handle, no one may\nconventionally execute the process.\n\n## Resolving This Issue: A Short-term Fix and Long-term Solution\n\nUnfortunately, there is not a clear fix for herpaderping attacks. It seems reasonable that\npreventing an image section from being mapped/cached when there is write access to the\nfile should close the hole. However, that may or may not be a practical solution.\n\nThere is a frustration among the development community about the incoherency between\nwhat is on disc and what it is going to execute, which is a common issue with all major\noperating systems. As such, that is something that should be considered when designing a\nsecurity product.\n\nWhile there isn’t a clear mechanism to guarantee that coherency, there are ways that\nsecurity vendors, as well as security engineers and analysts, can foresee this issue and\nminimize the risk.\n\nOne way to detect this type of exploit is to look for write access to the related file object when\nthe process is created. The exploit seems achievable through a higher-level API call. That\nsaid, the API juggling involved usually requires a native-call, which allows the attacker to\ntightly control the process creation flow.\n\nAnother way to detect this type of exploit is checking for coherency between the file on disk\nand the mapped process. Viewing the image coherency between the file on disk and the\nmapped process may be seen in an addition I’ve made to Process Hacker, and also shows\nthe spoofed display of “Google” as the “signer” due to the exploit.\n\n\n-----\n\nClick image to enlarge\n\nHere is a link to the enhancement proposal I’ve made to Process Hacker:\n[https://github.com/processhacker/processhacker/issues/744](https://github.com/processhacker/processhacker/issues/744)\n\nProcess Tampering may also be seen through a recent addition to SysMon by Mark\n[Russinovich, CTO of Microsoft Azure, reproduced below and in this tweet.](https://twitter.com/markrussinovich/status/1328769178233237504?s=20)\n\n\n-----\n\nClick image to enlarge\n\nClick image to enlarge\n\nAs for a long-term solution, that would require working with the OS to agree on a joint\napproach. We’re hopeful that as the technique gains broader awareness, the OS vendors\nwill work with the cybersecurity community to adopt more stringent countermeasures directly\nin the OS.\n\n_What are your thoughts? How do you reduce the risk of herpaderping in the short-term?_\n_What steps do you think the OS community must take to address this issue more_\n_systematically? For additional context and insight, see what industry professionals are saying_\n_and join the conversation on Twitter._\n\n\n-----\n\n[https://twitter.com/gentilkiwi/status/1321001331755286529?s=20](https://twitter.com/gentilkiwi/status/1321001331755286529?s=20)\n\n[https://twitter.com/Mordor_Project/status/1320949216018112514?s=20](https://twitter.com/Mordor_Project/status/1320949216018112514?s=20)\n\n[https://twitter.com/jxy__s/status/1320873966752329729?s=20](https://twitter.com/jxy__s/status/1320873966752329729?s=20)\n\n[https://twitter.com/analyzev/status/1320914701514084352?s=20](https://twitter.com/analyzev/status/1320914701514084352?s=20)\n\n[https://twitter.com/markrussinovich/status/1328769178233237504?s=20](https://twitter.com/markrussinovich/status/1328769178233237504?s=20)\n\n_Does this work sound interesting to you? Visit CrowdStrike’s Engineering and Technology_\n_page to learn more about our engineering team, our culture and current open positions:_\n_[https://www.crowdstrike.com/careers/engineering-technology-team/](https://www.crowdstrike.com/careers/engineering-technology-team/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-21 - Herpaderping- Security Risk or Unintended Behavior-.pdf"
    ],
    "report_names": [
        "2020-01-21 - Herpaderping- Security Risk or Unintended Behavior-.pdf"
    ],
    "threat_actors": [
        {
            "id": "e3767160-695d-4360-8b2e-d5274db3f7cd",
            "created_at": "2022-10-25T16:47:55.914348Z",
            "updated_at": "2025-03-27T02:05:17.411172Z",
            "deleted_at": null,
            "main_name": "IRON TWILIGHT",
            "aliases": [
                "ATK5 ",
                "Blue Athena ",
                "BlueDelta ",
                "FROZENLAKE ",
                "Fancy Bear ",
                "Fighting Ursa ",
                "Forest Blizzard ",
                "GRAPHITE ",
                "Group 74 ",
                "PawnStorm ",
                "STRONTIUM ",
                "Sednit ",
                "Snakemackerel ",
                "Sofacy ",
                "TG-4127 ",
                "Tsar Team ",
                "APT28 "
            ],
            "source_name": "Secureworks:IRON TWILIGHT",
            "tools": [
                " Downdelph",
                " Drovorub",
                " EVILTOSS",
                " HIDEDRV",
                " Headlace",
                " LoJack",
                " Powershell Empire",
                " SCONATO",
                " SEDUPLOADER",
                " SHARPFRONT",
                " Scaramouche",
                " Sedkit Exploit Kit",
                " Sofacy downloader",
                " X-Agent",
                " X-Tunnel",
                " Zebrocy",
                " reGeorg",
                "DEALERSCHOICE"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "730dfa6e-572d-473c-9267-ea1597d1a42b",
            "created_at": "2023-01-06T13:46:38.389985Z",
            "updated_at": "2025-03-27T02:00:02.821388Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "FROZENLAKE",
                "BlueDelta",
                "SNAKEMACKEREL",
                "TG-4127",
                "ITG05",
                "TA422",
                "Fancy Bear",
                "FANCY BEAR",
                "Sednit",
                "IRON TWILIGHT",
                "G0007",
                "Sofacy",
                "Forest Blizzard",
                "GruesomeLarch",
                "Pawn Storm",
                "Tsar Team",
                "STRONTIUM",
                "ATK5",
                "Blue Athena",
                "APT-C-20",
                "Group 74",
                "SIG40",
                "Grizzly Steppe",
                "Fighting Ursa",
                "T-APT-12",
                "UAC-0028"
            ],
            "source_name": "MISPGALAXY:APT28",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "ae320ed7-9a63-42ed-944b-44ada7313495",
            "created_at": "2022-10-25T15:50:23.671663Z",
            "updated_at": "2025-03-27T02:00:55.518748Z",
            "deleted_at": null,
            "main_name": "APT28",
            "aliases": [
                "APT28",
                "IRON TWILIGHT",
                "SNAKEMACKEREL",
                "Group 74",
                "Sednit",
                "Sofacy",
                "Pawn Storm",
                "Fancy Bear",
                "STRONTIUM",
                "Tsar Team",
                "Threat Group-4127",
                "TG-4127",
                "Forest Blizzard",
                "FROZENLAKE"
            ],
            "source_name": "MITRE:APT28",
            "tools": [
                "Wevtutil",
                "certutil",
                "Forfiles",
                "DealersChoice",
                "Mimikatz",
                "ADVSTORESHELL",
                "Komplex",
                "HIDEDRV",
                "JHUHUGIT",
                "Koadic",
                "Winexe",
                "XTunnel",
                "Drovorub",
                "CORESHELL",
                "OLDBAIT",
                "Downdelph",
                "XAgentOSX",
                "USBStealer",
                "Zebrocy",
                "Fysbis",
                "LoJax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d2516b8e-e74f-490d-8a15-43ad6763c7ab",
            "created_at": "2022-10-25T16:07:24.212584Z",
            "updated_at": "2025-03-27T02:02:10.141001Z",
            "deleted_at": null,
            "main_name": "Sofacy",
            "aliases": [
                "APT 28",
                "ATK 5",
                "Blue Athena",
                "BlueDelta",
                "FROZENLAKE",
                "Fancy Bear",
                "Fighting Ursa",
                "Forest Blizzard",
                "Grey-Cloud",
                "Grizzly Steppe",
                "Group 74",
                "GruesomeLarch",
                "ITG05",
                "Iron Twilight",
                "Operation DealersChoice",
                "Operation Dear Joohn",
                "Operation Komplex",
                "Operation Pawn Storm",
                "Operation Russian Doll",
                "Operation Steal-It",
                "Pawn Storm",
                "SIG40",
                "Sednit",
                "Snakemackerel",
                "Sofacy",
                "Strontium",
                "T-APT-12",
                "TA422",
                "TAG-0700",
                "TAG-110",
                "TG-4127",
                "Tsar Team",
                "UAC-0028",
                "UAC-0063"
            ],
            "source_name": "ETDA:Sofacy",
            "tools": [
                "ADVSTORESHELL",
                "AZZY",
                "Backdoor.SofacyX",
                "CHERRYSPY",
                "CORESHELL",
                "Carberp",
                "Computrace",
                "DealersChoice",
                "Delphacy",
                "Downdelph",
                "Downrage",
                "Drovorub",
                "EVILTOSS",
                "Foozer",
                "GAMEFISH",
                "GooseEgg",
                "Graphite",
                "HATVIBE",
                "HIDEDRV",
                "Headlace",
                "Impacket",
                "JHUHUGIT",
                "JKEYSKW",
                "Koadic",
                "Komplex",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LoJack",
                "LoJax",
                "MASEPIE",
                "Mimikatz",
                "NETUI",
                "Nimcy",
                "OCEANMAP",
                "OLDBAIT",
                "PocoDown",
                "PocoDownloader",
                "Popr-d30",
                "ProcDump",
                "PythocyDbg",
                "SMBExec",
                "SOURFACE",
                "SPLM",
                "STEELHOOK",
                "Sasfis",
                "Sedkit",
                "Sednit",
                "Sedreco",
                "Seduploader",
                "Shunnael",
                "SkinnyBoy",
                "Sofacy",
                "SofacyCarberp",
                "SpiderLabs Responder",
                "Trojan.Shunnael",
                "Trojan.Sofacy",
                "USB Stealer",
                "USBStealer",
                "VPNFilter",
                "Win32/USBStealer",
                "WinIDS",
                "Winexe",
                "X-Agent",
                "X-Tunnel",
                "XAPS",
                "XTunnel",
                "Xagent",
                "Zebrocy",
                "Zekapab",
                "carberplike",
                "certutil",
                "certutil.exe",
                "fysbis",
                "webhp"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535678,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653766114,
    "ts_modification_date": 1653766114,
    "files": {
        "pdf": "https://archive.orkl.eu/35f5dba7c5c70f55a7e9824cbdd71ff1580847ed.pdf",
        "text": "https://archive.orkl.eu/35f5dba7c5c70f55a7e9824cbdd71ff1580847ed.txt",
        "img": "https://archive.orkl.eu/35f5dba7c5c70f55a7e9824cbdd71ff1580847ed.jpg"
    }
}