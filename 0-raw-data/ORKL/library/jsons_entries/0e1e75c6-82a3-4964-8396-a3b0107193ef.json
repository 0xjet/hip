{
    "id": "0e1e75c6-82a3-4964-8396-a3b0107193ef",
    "created_at": "2022-10-25T16:48:19.501719Z",
    "updated_at": "2025-03-27T02:09:29.824169Z",
    "deleted_at": null,
    "sha1_hash": "334b4ee90a30c9ab9dcc6e3596f15f0dcb02486d",
    "title": "Safe A Targeted Threat",
    "authors": "Trend Micro",
    "file_creation_date": "2013-05-20T08:43:25Z",
    "file_modification_date": "2013-05-20T08:48:13Z",
    "file_size": 2618073,
    "plain_text": "## Safe\n#### A TARGETED THREAT\n\n\nBy: Nart Villeneuve and Kyle Wilhoit\n\nForward-Looking Threat Research Team\n\n\n-----\n\n### Contents\n\nIntroduction...........................................................................................................1\nAttack Vector........................................................................................................2\nMalware................................................................................................................3\n\nFirst Stage......................................................................................................3\nSecond Stage................................................................................................5\nPlug-Ins..........................................................................................................5\nTools...............................................................................................................5\nC&C......................................................................................................................6\nCampaign Connections........................................................................................7\nIdentification of Victims.........................................................................................7\nTools.....................................................................................................................9\n\nTypeConfig/SafeDisk.....................................................................................9\nDECRYPT.exe.............................................................................................10\nCommon Tools.............................................................................................10\nSource Code...................................................................................................... 11\n\nTypeConfig.exe/SafeDisk.exe Source Code Analysis..................................12\nC&C Source Code.......................................................................................13\nAttribution...........................................................................................................13\n\nDevelopers...................................................................................................14\nOperators.....................................................................................................16\nConclusion..........................................................................................................17\nDefending Against Targeted Attacks...................................................................18\n\nLocal and External Threat Intelligence.........................................................18\nMitigation and Cleanup Strategy..................................................................19\nEducating Employees Against Social Engineering......................................19\nData-Centric Protection Strategy.................................................................19\nTrend Micro Threat Protection Against the Safe Campaign...............................19\nReferences.........................................................................................................21\n\n**TREND MICRO LEGAL DISCLAIMER**\n\nThe information provided herein is for general information and educational purposes only.\nIt is not intended and should not be construed to constitute legal advice. The information\ncontained herein may not be applicable to all situations and may not reflect the most\ncurrent situation. Nothing contained herein should be relied on or acted upon without the\nbenefit of legal advice based on the particular facts and circumstances presented and\nnothing herein should be construed otherwise. Trend Micro reserves the right to modify\nthe contents of this document at any time without prior notice.\n\nTranslations of any material into other languages are intended solely as a convenience.\nTranslation accuracy is not guaranteed nor implied. If any questions arise related to\nthe accuracy of a translation, please refer to the original language official version of the\ndocument. Any discrepancies or differences created in the translation are not binding and\nhave no legal effect for compliance or enforcement purposes.\n\nAlthough Trend Micro uses reasonable efforts to include accurate and up-to-date\ninformation herein, Trend Micro makes no warranties or representations of any kind as to\nits accuracy, currency, or completeness. You agree that access to and use of and reliance\non this document and the content thereof is at your own risk. Trend Micro disclaims all\nwarranties of any kind, express or implied. Neither Trend Micro nor any party involved\nin creating, producing, or delivering this document shall be liable for any consequence,\nloss, or damage, including direct, indirect, special, consequential, loss of business profits,\nor special damages, whatsoever arising out of access to, use of, or inability to use, or\nin connection with the use of this document or any errors or omissions in the content\n\n\n-----\n\n### Introduction\n\nWhether considered advanced persistent threats (APTs) or malware-based\nespionage attacks, successful and long-term compromises of high-value\norganizations and enterprises worldwide by a consistent set of campaigns\ncannot be ignored. Because “noisier” campaigns are becoming increasingly\nwell-known within the security community, new and smaller campaigns are\nbeginning to emerge.\n\nThis research paper documents the operations of a campaign we refer to as\n“Safe,” based on the names of the malicious files used. It is an emerging and\nactive targeted threat.\n\n**Note that any mention of “SafeNet” in this paper is completely unrelated**\n**to and has no association with SafeNet, Inc., a global leader in data**\n**protection and a valued partner of Trend Micro. The author of the Safe**\n**malware apparently maliciously used the word “SafeNet” as part of this**\n**viral campaign, and to the extent the word “SafeNet” appears in this**\n**paper, it appears solely as replicated in the attacking author’s malware**\n**configuration. There is no correlation between SafeNet Inc. and the Safe**\n**campaign and should not be interpreted as such.**\n\nThe Safe campaign was able to compromise the following types of\norganizations:\n\n\n\n**•** Government ministries\n\n**•** Technology companies\n\n**•** Media outlets\n\n\n\n**•** Academic research institutions\n\n**•** Nongovernmental organizations\n\n\nWhile we have yet to determine the campaign’s total number of victims, it\nappears that nearly 12,000 unique IP addresses spread over more than\n100 countries were connected to two sets of command-and-control (C&C)\ninfrastructures related to Safe. We also discovered that the average number of\nactual victims remained at 71 per day, with few if any changes from day to day.\nThis indicates that the actual number of victims is far less than the number of\nunique IP addresses. Due to large concentrations of IP addresses within specific\nnetwork blocks, it is likely that the number of victims is even smaller and that\nthey have dynamically assigned IP addresses, which have been compromised\nfor some time now.\n\nInvestigating targeted campaigns involves more than simply collecting\nactionable indicators like malware samples and C&C server information.\nInvestigating and monitoring the activities of the Safe campaign over time, we\nwere able to take advantage of the mistakes the attackers made and thus gain\na deeper understanding of their operations. One of the C&C servers was set\nup in such a way that the contents of the directories were viewable to anyone\nwho accessed them. As a result, not only were we able to determine who the\ncampaign’s victims were, but we were also able to download backup archives\nthat contained the PHP source code the attackers used for the C&C server and\nthe C code they used to generate the malware used in attacks.\n\n\n-----\n\nsoftware developer who studied at a technical university in China. This individual\nappears to have repurposed legitimate source code from an Internet services\ncompany in the same country for use as part of the campaign’s C&C server\ncode. As such, this may be a case in which a malware entrepreneur’s code was\nused in targeted attacks.\n\nIn addition to understanding the tools and techniques used in this campaign,\nwe had the opportunity to analyze the data to determine its source. While the\ninformation that we obtained suggested the identity of the malware author, we\nwere not able to attribute the campaign operation to him. In fact, while we were\nable to identify the various IP addresses used by the operators, the geographic\ndiversity of the proxy servers and VPNs made it difficult to determine their true\norigin.\n\n### Attack Vector\n\nThe distribution mechanism the\nSafe campaign used involved spearphishing emails that contain a\nmalicious attachment. This technique,\nwhich is quite common for APT\ncampaigns, encourages a recipient to\nopen a malicious attachment by\nsending an email with contextually\nrelevant content.[1]\n\n\nWe discovered several malicious\ndocuments that all exploited a\nMicrosoft Office® vulnerability (i.e.,\nCVE-2012-0158).[2] If opened with a\nversion of Microsoft Word® that is not\nup-to-date, a malicious payload is\nsilently installed on the user’s\ncomputer.\n\n\nFigure 1: Sample Safe spear-phishing email\n\n**(aka attack vector)**\n\n\nFigure 2: Sample decoy documents\n\n1 [http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-spear-](http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-spear-phishing-email-most-favored-apt-attack-bait.pdf)\n[phishing-email-most-favored-apt-attack-bait.pdf](http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-spear-phishing-email-most-favored-apt-attack-bait.pdf)\n2 [http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0158](http://www.cve.mitre.org/cgi-bin/cvename.cgi%3Fname%3DCVE-2012-0158)\n\n\n-----\n\nMongolian though their exact targets remain unclear.\n\n### Malware\n\n#### First Stage\n\nOpening the malicious document on a system running a vulnerable version of\nMicrosoft Office opens the decoy document for the user to view. Note though\nthat this also drops malicious files onto the system that allows the attackers to\ntake control of it. After the initial compromise, the attackers may then steal files\nfrom the compromised system.\n\nThe decoy document, NBC Interview_Excerpts.doc, has the MD5 hash,\n**a2da9cda33ce378a21f54e9f03f6c0c9efba61fa. It drops the following files:**\n\n**•** **smcs.exe (91e6277a70d48ed953ac9208275e5dc855a8f7a7), which**\n\ncontains:\n\n**•** **SafeCredential.DAT (303e982d0929ca2c50809323dff66be38a46926a)**\n\n**•** **SafeExt.org (2029399fb4be3d88c2ba0a7544b1ebec58157639), which**\n\ncontains:\n\n**•** **SafeExt.dll (cde35c8da8c420aeaf5adda14ba68d18010479fa)**\n\nThe malware the malicious documents drop has several components, including:\n\n**•** **SafeExt.dll: Contains the malware’s main functionality.**\n\n**•** **SafeCredential.DAT: Contains the RC4 key, C&C information, and**\n\ncampaign “mark.”\n\nIf User Account Control (UAC) is active, SafeExt.dll will be injected into\n**explorer.exe. Otherwise, the file is copied to %Program Files%\\Internet**\n**Explorer\\SafeNet\\ and registered as a Browser Helper Object (BHO).[3]**\n\nFigure 3: RC4 key, C&C information, and campaign mark\n\n3 [http://en.wikipedia.org/wiki/User_Account_Control and http://en.wikipedia.org/wiki/Browser_](http://en.wikipedia.org/wiki/User_Account_Control)\n[Helper_Object](http://en.wikipedia.org/wiki/Browser_Helper_Object)\n\n\n-----\n\nserver over HTTP POST to send data\nusing the domain name and URL path\nin SafeCredential.DAT. The network\ntraffic is encrypted with the RC4 key in\n**SafeCredential.DAT. One key**\nindicator that can be used to detect\nthis network communication is the\nuser-agent, Fantasia.\n\nDuring our investigation of the C&C\nservers associated with Safe, we\ndiscovered a backup script that the\nattackers used to archive the files on\nthem. This allowed us to acquire the\nsource code for the .PHP files used on\nthe C&C servers.\n\nThe data that the malware sends from\na compromised host to report.php is\ndecrypted by the C&C server and\nstored in a MySQL™ database. In\naddition to RC4 encryption use, the\nfile’s content is XORed with the\nfunction in Figure 6.\n\n\nFigure 4: Check in with the C&C server\n\nFigure 5: Safe backup script\n\n\nThe parameters of the query are\nunpacked and sent to a function that Figure 6: Safe’s VisualEncrypt function\ninserts the information the\ncompromised host provides into the MySQL database. It then checks\nthe database to see if the attackers specified instructions to send to the\ncompromised host. If there are, these instructions are sent back to the\ncompromised host.\n\nFigure 7: Safe’s check-in function\n\n\n-----\n\neach compromised host as well as the Internet and external IP addresses,\nhostname, Windows domain, the system’s disc drive information, and a\ncampaign mark. It has a field to store information about any additional malware\nplug-ins that have been installed on the system.\n\nThe malware uses the following marks or campaign tags:\n\n\n\n**•** 120713\n\n**•** 120713p\n\n**•** 123456\n\n**•** 654321\n\n**•** c0814\n\n**•** C0821\n\n#### Second Stage\n\n\n\n**•** L0821\n\n**•** Lewis120713px\n\n**•** N0911\n\n**•** Weber0720p\n\n**•** 720p\n\n**•** L1224\n\n\nAfter the initial compromise, the attackers may instruct compromised systems\nto download additional malware and tools. The tools that we discovered were\nlocated on the same C&C servers.\n\n#### Plug-Ins\n\nThe data contained in the C&C servers references plug-ins that are available\nfor the malware. We believe they are related to the malware’s data-exfiltration\ncapabilities. The names of the plug-ins are:\n\n**•** OpenDoc\n\n**•** UsbDoc\n\n**•** UsbExe\n\n#### Tools\n\nThe tools used by Safe are off-the-shelf programs that are able to extract saved\npasswords from Internet Explorer® (IE) and Mozilla Firefox® as well as any\nstored Remote Desktop Protocol (RDP) credentials.[4]\n\n4 [The tools are publicly available at http://www.nirsoft.net/.](http://www.nirsoft.net/)\n\n\n-----\n\nFigure 8: Password extraction tools\n### C&C\n\nWe found two sets of C&C servers that do not seem to have anything in\ncommon apart from being used in conjunction with the same malware. The first\nset of C&C servers had Mongolian-themed domain names—mongolbaatar.\n**us and mongolbaatarsonin.in. The second set of C&C servers use the**\ndomains, getapencil.com, which was registered with a privacy protection\nservice, and withoutcake.com, which was registered by wanxian@126.\n**com.[5]** **Willyoumarryadog.com may also be a C&C server but we have not yet**\ndiscovered samples that use this domain name.\n\nFigure 9: Safe C&C server infrastructure\n\nThe Tibetan- and Mongolian-themed attack vectors described earlier are\nconnected to the first infrastructure (i.e., mongolbaatar). We were unable to\ndiscover attack vectors for the second C&C infrastructure.\n\n5 A variety of services can be used so the registrant information required to register a domain\nname will not be publicly visible in the WHOIS directory.\n\n\n-----\n\n### Campaign Connections\n\nOne of the C&C servers used, withoutcake.com, was registered using the\nemail address, wanxian@126.com. This email address has been used to\nregister 17 domain names, five of which have been confirmed to be C&C\nservers.\n\nFigure 10: Connections to other campaigns\n\nThe domain, sugarsbutters.com, was used in attacks that leveraged images of\nRussian model, Irina Shayk, and dropped the iMuler malware that affects Mac\nOS X systems in November 2012.[6] Three domains—aq5u.org, prettyb0yinus.\n**com, and shumetheme.org—have also been used as C&C servers for**\ncampaigns using the Enfal malware.[7]\n\n### Identification of Victims\n\nWe were able to identify victims in two ways. First, we were able to download\na list of victims that were currently online from the C&C servers. Second, we\nwere also able to download logs from the C&C servers that listed all of the IP\naddresses that “checked in” to them using the REQUEST_TYPE_CLIENT_\n**REQUEST function.**\n\nThe first set of C&C servers (i.e., mongolbataar) appeared to have only three\n“live” victims—one with an IP address assigned to South Sudan, another with\nan address assigned to Mongolia, and another that did not list an external IP\naddress.\n\nThe logs we obtained from the first set of C&C servers showed that 243 unique\nIP addresses from 11 different countries checked in to them.\n\n6 [http://www.totaldefense.com/blogs/2012/04/11/mac-os-x-threat-masquerading-as-image-files.](http://www.totaldefense.com/blogs/2012/04/11/mac-os-x-threat-masquerading-as-image-files.aspx)\n[aspx and http://www.f-secure.com/v-descs/backdoor_osx_imuler_a.shtml](http://www.totaldefense.com/blogs/2012/04/11/mac-os-x-threat-masquerading-as-image-files.aspx)\n7 [http://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/](http://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/Troj~Luiha-BK/detailed-analysis.aspx)\n[Troj~Luiha-BK/detailed-analysis.aspx and http://www.threatexpert.com/report.](http://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/Troj~Luiha-BK/detailed-analysis.aspx)\n[aspx?md5=9d334262d146bd57a7adfb9b3e093f9f](http://www.threatexpert.com/report.aspx%3Fmd5%3D9d334262d146bd57a7adfb9b3e093f9f)\n\n\n-----\n\n|Table 1: Country Breakdown of Unique IP Address Locations|Col2|\n|---|---|\n|Country Number of IP Addresses Mongolia 212||\n|South Sudan|9|\n|Bulgaria|8|\n|China|4|\n|United States|3|\n|Canada|2|\n|Hungary|1|\n|South Korea|1|\n|Australia|1|\n|India|1|\n|Egypt|1|\n\n\nThe logs we obtained from the second set of C&C servers (i.e., getapencil.\n**com) showed that 11,563 unique IP addresses from 116 different countries**\nchecked in to them.\n\nTable 2: Top 15 Country Breakdown of Unique IP Address Locations\n\n**Country** **Number of IP Addresses**\n\nIndia 4,305\nUnited States 709\nChina 625\nPakistan 554\nPhilippines 445\nRussia 307\nBrazil 283\nRomania 248\nSaudi Arabia 192\nAlgeria 180\nUnited Arab Emirates 170\nSerbia 161\nMalaysia 154\nSyria 151\nHungary 147\n\nWe discovered that on average, 71 victims accessed the getapencil.com C&C\nserver at any given time. The actual total victim count was significantly lower\nthan the number of unique IP addresses though.\n\n|Table 2: Top 15 Country Breakdown of Unique IP Address Locations|Col2|\n|---|---|\n|Country Number of IP Addresses India 4,305||\n|United States|709|\n|China|625|\n|Pakistan|554|\n|Philippines|445|\n|Russia|307|\n|Brazil|283|\n|Romania|248|\n|Saudi Arabia|192|\n|Algeria|180|\n|United Arab Emirates|170|\n|Serbia|161|\n|Malaysia|154|\n|Syria|151|\n|Hungary|147|\n\n\n-----\n\n### Tools\n\nA closer look at the C&C servers allowed us to identify the tools and source\ncode the threat actors used to create, distribute, and encrypt/decrypt data. The\ntools presented in this section either came preassembled or could be compiled\nusing the source code that could be downloaded from the getapencil.com C&C\nserver.\n\n#### TypeConfig/SafeDisk\n\nThe primary function of TypeConfig/SafeDisk appears to be embedding a\nbackdoor into a valid .PE file. This tool appears to be the primary method for\ncreating the malware related to the campaign.\n\nFigure 11: Data flow diagram showing TypeConfig malware creation\n\nFigure 12: TypeConfig and translated graphical user interfaces (GUIs)\n\n\n-----\n\nlocation and data like the malware’s name and version number, which are sent\nback to the attacker after a compromise.\n\n#### DECRYPT.exe\n\n\nWe also pulled the application,\n**DECRYPT.exe, from a getapencil.**\n**com C&C server. This application is a**\ncustom encrypter/decrypter for any file\ninputted into the application. Further\nanalysis of this application shows that\nit uses large portions of Makoto\nMatsumoto and Takuji Nishimura’s\nRandom Number Generator (RNG) for\nencryption functionality.[8]\n\nOnce the Decrypt button is pressed, a\npassword validation box appears.\n\nWe were able to identify victim files\nthat were on “drop servers” that utilize\n**DECRYPT.exe for encryption/**\ndecryption.\n\n#### Common Tools\n\n\nFigure 13: DECRYPT.exe’s GUI with some\n\n**translated content**\n\nFigure 14: Password validation box that\n**appears when the Decrypt button is pressed**\n\n\nWe also identified security tools with both valid and nefarious purposes and\nhave been used in other campaigns on the C&C servers. We listed some of\nthese along with their functionality below:\n\n**•** **LZ77: Used to compress and decompress files.**\n\n**•** **UPXShell: Commonly used to pack malware in order to make it more**\n\ndifficult for analysts to reverse-engineer.\n\n**•** **DebugView: A Microsoft Sysinternals tool that allows you to monitor debug**\n\noutputs on your local system.\n\n**•** **Build.bat: Used to open TypeConfig and “automate” malware creation**\n\nprocesses.\n\n**•** **Compress.bat: Used to automatically compress files defined in a batch file**\n\nwith the aid of LZ77.exe.\n\n**•** **PECompress.bat: Used to compress files identified in a batch file with the**\n\naid of UPXShell.exe.\n\n8 [http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/readme-mt.txt](http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/readme-mt.txt)\n\n\n-----\n\n### Source Code\n\nThis section shows some of the discoveries we made while trying to identify the\nfunctionality and use cases of each application we discovered. Nearly all of the\nsamples were coded in C, specifically Visual C.\n\nThe directory structure of the source code appeared to be standard of\ndirectories written using C, Visual Studio® Express, or a litany of other tools.\nThe code appeared to be very robust. We created a complete mind map of the\ncode, its directories and the files located within the said directories.[9]\n\nFigure 15: High-level directory/code structure of our findings\n\nThe applications in the following section are only a few of those that contained\nsome of the most interesting details about our findings.\n\n9 Due to the number and depth of directories discovered, what has been included here is only a\nportion of the mind map we created.\n\n\n-----\n\n#### TypeConfig.exe/SafeDisk.exe Source Code Analysis\n\nFigure 16: SafeDisk/TypeConfig source tree\n\nWe were able to correlate similarities\nbetween TypeConfig.exe and\n**SafeDisk.exe. While reverse-**\nengineering code and functionality, we\ndiscovered that the two applications Figure 17: Code identifying SafeDisk.exe\nwere identical in function. We have not, however, ascertained what the purpose\nbehind differential naming is, but their functionality appeared to be very similar.\n\nWe also identified fields in\n**TypeConfig.exe by directly correlating**\nthe code to the fields within the GUI.\n\nAnother interesting feature to note\nwithin TypeConfig.exe is its use of\n**SafeCredential.DAT, which the threat**\nactors created to specify the RC4\nencryption key, C&C server\ninformation, and campaign mark.\n\nFigure 19: SafeCredential.DAT utilization\n\nFigure 18: Field lists for the GUI\n\n\n-----\n\n#### C&C Source Code\n\nFigure 20: PHP source code tree\n\nThe C&C functionality was written in\nPHP. The code required config.php,\nwhich contained the configuration for\nthe MySQL database where victim\ninformation was stored; global.php,\nwhich contained some mapping of\nstrings to command numbers; upload.\n**php, which provided the functionality**\nfor data exfiltration; and utils.php,\nwhich contained the encryption\nfunctions in order to encrypt and\ndecrypt communications between a\ncompromised host and a C&C server.\nCompromised hosts and malicious\n\nFigure 21: Safe commands\n\noperators interacted with record.php,\nthe primary file required for C&C operation. The utils directory also contained\ncode for extensive logging and what appeared to be repurposed legitimate code.\n\nWhen compromised computers accessed record.php, they interacted with the\nfunctionality labeled CLIENT. Operators used MANAGE commands to interact\nwith the C&C functionality.\n\n### Attribution\n\nIdentifying who is responsible for targeted attacks is not an easy task. The term\n“attribution” is applied to everything, ranging from individuals to governments.\nThe technical indicators often used to determine attribution like domain name\nregistration data and geographic locations of IP addresses can be easily\nfalsified. Modern attackers often use “hop” points that consist of compromised\nsystems as well as proxy servers and VPNs to disguise their origin. It is trivial\nto purchase virtual private servers (VPSs) in just about any country, and\ndetermining who ultimately benefits from the spoils of targeted attacks is often a\nmatter of interpretation based on geopolitics with limited exploration of possible\nalternative explanations.\n\n\n-----\n\nbeing analyzed. In some cases, the term “attribution” is used to refer to the\ndevelopers of either the exploits or malware payloads. They could very well be\ncompletely different threat actors. The term is also used to refer to identify the\nproviders of C&C infrastructures used in targeted attacks, particularly those that\nregistered the domain names. It can also refer to obtaining specific information\nabout the campaign operators who launch attacks and operate the C&C\ninfrastructure.\n\nThis paper presents some of the technical evidence we discovered during our\ninvestigation. We focused on two threat actor types—developers and operators.\nWe were able to uncover clues that indicate the identity of the malware author\nthat were left in the source code as well as through open source analysis. We\nwere able to obtain limited insights into the activities of the C&C operators\nthrough the logs they collected, which recorded the IP addresses they used to\noperate and manage the C&C servers.\n\n#### Developers\n\nThroughout much of the code, we saw\nindications of its origin. For instance,\nwhen looking at the code for the file,\n**TypeConfig.vcproj.INTERNAL.**\n\n**[REDACTED]04.user, located under**\n**Src>TypeConfig, we were not only**\nable to locate the author’s name but\nalso the language setting, <?xml\n**version=“1.0” encoding=**\n**“gb2312”?>, which refers to the**\nregistered Internet name for a key\nofficial character set of the People’s\nRepublic of China (PRC).[10] However,\n\nFigure 22: TypeConfig’s source code\n\nother comments, especially those\nwithin the PHP code, often appeared in English.\n\n\nIn addition to the language used, we\nfound that the malware author used\na name in several places throughout\nthe source code. For instance, under\nthe directory, Src>TypeConfig>, we\nnoticed an interesting .vcproj file called\n“TypeConfig.vcproj.INTERNAL.\n\n**[REDACTED]04.user.”** Figure 23: Vcproj configuration with\n\n**machine name**\n\nThis file contains a remote machine\nconfiguration module that includes the author’s name and the name of the\ndevelopment machine used, which directly correlates to “CompanyName”\nfound elsewhere in the code.\n\n10 [http://en.wikipedia.org/wiki/GB_2312](http://en.wikipedia.org/wiki/GB_2312)\n\n\n-----\n\nFigure 24: TypeConfig’s source code with author information\n\nWe found the string, “CompanyName,” in the C source code that contains\nthe same name as the development machine’s. The PHP code used as the\nC&C server’s back end contained a copyright notice that matches the author’s\nname in the C code as well as an email address/QQ number that matches the\n**“CompanyName” in the C code.**\n\nFigure 25: Copyright notice containing a name and an email address/QQ number\n\nThe email address was used to register a domain name for a personal blog\nabout software development with a Beijing street address. We also found the\nsame name and email address used by an author of an academic paper at\na technical university in China. Posts on this individual’s personal blog also\nindicate a relationship with the same university, including the development of\nsome legitimate software.\n\n\n-----\n\ncode, portions of which are contained\nin the email address/QQ number, were\nalso found in source code for\nkeyloggers and malware posted on a\nChinese code-sharing site.\n\nWe also found legitimate code that\nappears to have been developed by an\nInternet services company used as\npart of the C&C panel. This code was\nnot developed by the same person that\nwe believe developed the Safe malware\nbut appears to simply have been reused.\nWe believe though that\nthis code is not publicly available.\n\n\nFigure 26: Repurposed source code\n\nFigure 27: SVN repository with user name\n\n\nIn the code’s archive we recovered from the C&C servers, we found a .csv\ndirectory that contains an entries file that contains the location of the repository\nas well as the time, version, and user name of the person who last committed\nthe source code. The author information indicates that the malware author\nchecked the code in to the Internet services company’s private SVN repository.\nIt appears that the malware author has been repurposing the code for his own\nmalware project.\n\nWe believe the malware author is a professional software engineer that is\nfamiliar with version control. We also found indicators that this individual is\nproficient in software development due to the high quality of the source code he\nused. The entire source code was explicitly written with future development in\nmind. It was modularized and heavily commented on in a way that allows further\ndevelopment even by several engineers. These qualities are traditionally seen\nin the work of professional software engineers that have been taught traditional\ncomputer science.\n\nApart from being significantly well-organized and well-commented, the code\nwas also developed with defensive programming in mind. Each of the variables\nwas named in a very obvious manner, helping other engineers easily distinguish\nfunctionality; again, a trait seen in the work of many professional software\nengineers. In addition to being heavily commented on and using intuitive\nvariable naming conventions, the code also had an apparent slant toward\nusability. Each interface was very intuitive and well-designed, something not\noften seen in the code of a hobbyist.\n\nThe use of terms like “bot,” combined with the author’s posting of the malware\ncode to code-sharing sites, indicate a degree of familiarity with the cybercriminal\nunderground in China. We have not, however, uncovered evidence that links the\nmalware author with the campaign’s operators.\n\n#### Operators\n\nWe were unable to obtain information beyond IP addresses that indicate the\norigin of those issuing MANAGE or other C&C requests. The extensive logging\nperformed by the C&C servers, however, allowed us to differentiate between the\nvictims’ and operators’ IP addresses.\n\n\n-----\n\n|Table 3: Geographic Locations of the Mongolbaatar C&C Server Operators’ IP Addresses|Col2|\n|---|---|\n|Country Number of IP Addresses China 16||\n|United States|5|\n|Hong Kong|1|\n\n|Table 4: Geographic Locations of the Getapencil C&C Server Operators’ IP Addresses|Col2|\n|---|---|\n|Country Number of IP Addresses South Korea 17||\n|Hong Kong|12|\n|China|11|\n|United States|8|\n|Taiwan|1|\n|Romania|1|\n\n\nWhile most of the operator interactions we saw were from China and Hong\nKong, we also saw the use of VPNs and proxy tools, including Tor, which\ncontributed to the geographic diversity of the operators’ IP addresses.\n\n### Conclusion\n\nOngoing cyber-espionage campaigns have been successfully infiltrating targets\nworldwide, many of which have been active for years. However, the amount\nof public exposure, especially of noisier and larger campaigns, has been\nincreasing. Perhaps due to their success, these campaigns’ operators intensified\ntheir operations, causing them to be increasingly visible. But smaller campaigns\nare beginning to emerge; these use small clusters of C&C servers and new\nmalware as well as attack fewer targets.\n\nWhile determining the intent and identity of the attackers often remains difficult\nto ascertain, we determined that the Safe campaign is targeted and uses\nmalware developed by a professional software engineer that may be connected\nto the cybercriminal underground in China. This individual studied at a prominent\ntechnical university in the same country and appears to have access to an\nInternet services company’s source code repository. This individual developed\nmalware that was, in turn, used for targeted attacks leveraging two distinct sets\nof C&C infrastructure.\n\n\n-----\n\ncustom malware to circumvent defenses. As a result, attackers may increasingly\nlook to the cybercriminal underground for new malicious tools instead of\ndeveloping their own tools for exclusive use. These developments highlight the\nincreasing need for ongoing investigation and monitoring of such threats. While\nindicators that can be directly incorporated into defensive operations remain\nimportant, in-depth qualitative analysis of particular campaigns can provide\ncritical insights into attackers’ operations. Furthermore, attribution should not\nbe entirely based on the common use of tools and infrastructure, as these are\nincreasingly not being developed and used exclusively by particular sets of\nthreat actors.\n\n### Defending Against Targeted Attacks\n\nSufficiently motivated threat actors can penetrate even networks that use\nmoderately advanced security measures. As such, apart from standard\nand relevant attack prevention measures and mechanisms like solid patch\nmanagement; endpoint and network security; firewall use; and the like,\nenterprises should also focus on detecting and mitigating attacks. Moreover,\ndata loss prevention (DLP) strategies that identify the data an organization is\nprotecting and take into account the context of data use should be employed.\n\n#### Local and External Threat Intelligence\n\nThreat intelligence refers to indicators that can be used to identify the tools,\ntactics, and procedures threat actors engaging in targeted attacks use. Both\nexternal and local threat intelligence is crucial for developing the ability to detect\nattacks early. The following are the core components of this defense strategy:\n\n**•** **Enhancing visibility: Logs from endpoint, server, and network monitoring**\n\nare an important and often underused resource that can be aggregated to\nprovide a view of the activities within an organization that can be processed\nfor anomalous behaviors, which can indicate a targeted attack.\n\n**•** **Performing integrity checks: In order to maintain persistence, malware**\n\nwill make modifications to the file system and registry. Monitoring such\nchanges can indicate the presence of malware.\n\n**•** **Empowering the human analyst: Humans are best positioned to identify**\n\nanomalous behaviors when presented with a view of aggregated logs from\nacross a network. This information is used in conjunction with custom alerts\nbased on the local and external threat intelligence available.\n\nTechnologies available today like Deep Discovery provide visibility, insight, and\ncontrol over networks to defend against targeted threats.[11] Deep Discovery\nuniquely detects and identifies evasive threats in real-time and provides in-depth\nanalysis and actionable intelligence to prevent, discover, and reduce risks.\n\n11 [http://www.trendmicro.com/us/enterprise/security-risk-management/deep-discovery/index.html](http://www.trendmicro.com/us/enterprise/security-risk-management/deep-discovery/index.html)\n\n\n-----\n\n#### Mitigation and Cleanup Strategy\n\nOnce an attack is identified, the cleanup strategy should focus on the following\nobjectives:\n\n**•** Determine the attack vector and cut off communications with the C&C\n\nserver.\n\n**•** Determine the scope of the compromise.\n\n**•** Assess the damage by analyzing the data and forensic artifacts available on\n\ncompromised machines.\n\nRemediation should be applied soon afterward, which includes steps to fortify\naffected servers, machines, or devices into secure states, informed in part by\nhow the compromised machines were infiltrated.\n\n#### Educating Employees Against Social Engineering\n\nSecurity-related policies and procedures combined with education and training\nprograms are essential components of defense. Traditional training methods\ncan be fortified by simulations and exercises using real spear-phishing attempts\nsent to test employees. Employees trained to expect targeted attacks are better\npositioned to report potential threats and constitute an important source of threat\nintelligence.\n\n#### Data-Centric Protection Strategy\n\nThe ultimate objective of targeted attacks is to acquire sensitive data. As such,\nDLP strategies that focus on identifying and protecting confidential information\nare critical. Enhanced data protection and visibility across an enterprise\nprovides the ability to control access to sensitive data as well as monitor and\nlog successful and unsuccessful attempts to access it. Enhanced access\ncontrol and logging capabilities allow security analysts to locate and investigate\nanomalies, respond to incidents, and initiate remediation strategies and damage\nassessment.\n\n### Trend Micro Threat Protection Against the Safe Campaign\n\nPart of processing and identifying the components of the Safe campaign is\ncreating a list of indicators of compromise (IOCs) to help organizations better\nidentify and locate certain tools, malware, and traffic patterns that could indicate\ncompromise.\n\n\n-----\n\nrecommends a comprehensive security risk management strategy that goes further than advanced protection to meet the\nreal-time threat management requirements of dealing with targeted attacks.\n\n|Attack Component Protection Technology Trend Micro Solution Network traffic identifiers: • Endpoint (Titanium, Worry-Free Business • Network traffic going to mongolbaatarsonin. Security, OfficeScan) in • Server (Deep Security) • Network traffic going to withoutcake.com • Messaging (InterScan Messaging Security, • Network traffic going to mongolbaatar.us Web Reputation ScanMail Suite for Microsoft Exchange) • Network traffic going to getapencil.com • Network (Deep Discovery) • User-agent identified as “Fantasia” • Gateway (InterScan Web Security, InterScan • Communication with any URL with the sub- Messaging Security) URL, /safe/record.php • Mobile (Mobile Security)|Col2|Col3|\n|---|---|---|\n|Host-based identifiers: • Presence of SafeExt.dll on the host (commonly found in %Program Files%\\ Internet Explorer\\SafeNet\\) • Presence of SafeCredential.DAT on the host (commonly found in %Program Files%\\ Internet Explorer\\SafeNet\\) • Presence of the directory, %Program Files%\\Internet Explorer\\SafeNet\\ • Modification of the following registry values: • \\{197BD4A7-401A-424B-8B53- 401D66865829}\\1.0\\0\\win32\\: “C:\\Program Files\\Internet Explorer\\SafeNet\\SafeExt.dll” • HKU\\S-1-5-21-3050518243-3448030925- 2694814405-1000_Classes\\VirtualStore\\ MACHINE\\SOFTWARE\\Classes\\ TypeLib\\{197BD4A7-401A-424B-8B53- 401D66865829}\\1.0\\HELPDIR\\: “C:\\ Program Files\\Internet Explorer\\SafeNet\\” • HKU\\S-1-5-21-3050518243-3448030925- 2694814405-1000_Classes\\VirtualStore\\ MACHINE\\SOFTWARE\\Classes\\ TypeLib\\{197BD4A7-401A-424B-8B53- 401D66865829}\\1.0\\FLAGS\\: “0” • HKU\\S-1-5-21-3050518243-3448030925- 2694814405-1000_Classes\\VirtualStore\\ MACHINE\\SOFTWARE\\Classes\\ TypeLib\\{197BD4A7-401A-424B-8B53- 401D66865829}\\1.0\\: “SafeExt 1.0 Type Library”|File Reputation (Antivirus/Anti-malware)|• Endpoint (Titanium, Worry-Free Business Security, OfficeScan) • Server (Deep Security) • Messaging (InterScan Messaging Security, ScanMail Suite for Microsoft Exchange) • Network (Deep Discovery) • Gateway (InterScan Web Security, InterScan Messaging Security) • Mobile (Mobile Security)|\n\n\n-----\n\n**Attack Component** **Protection Technology** **Trend Micro Solution**\n\n\n### References\n\n**[• http://www.trendmicro.com/cloud-content/](http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-spear-phishing-email-most-favored-apt-attack-bait.pdf)**\n\n[us/pdfs/security-intelligence/white-papers/](http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-spear-phishing-email-most-favored-apt-attack-bait.pdf)\n[wp-spear-phishing-email-most-favored-apt-](http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-spear-phishing-email-most-favored-apt-attack-bait.pdf)\n[attack-bait.pdf](http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-spear-phishing-email-most-favored-apt-attack-bait.pdf)\n\n**[• http://www.cve.mitre.org/cgi-bin/cvename.](http://www.cve.mitre.org/cgi-bin/cvename.cgi%3Fname%3DCVE-2012-0158)**\n\n[cgi?name=CVE-2012-0158](http://www.cve.mitre.org/cgi-bin/cvename.cgi%3Fname%3DCVE-2012-0158)\n\n**[• http://en.wikipedia.org/wiki/User_Account_](http://en.wikipedia.org/wiki/User_Account_Control)**\n\n[Control](http://en.wikipedia.org/wiki/User_Account_Control)\n\n**[• http://en.wikipedia.org/wiki/Browser_](http://en.wikipedia.org/wiki/Browser_Helper_Object)**\n\n[Helper_Object](http://en.wikipedia.org/wiki/Browser_Helper_Object)\n\n**[• http://www.nirsoft.net/](http://www.nirsoft.net/)**\n\n**[• http://www.totaldefense.com/](http://www.totaldefense.com/blogs/2012/04/11/mac-os-x-threat-masquerading-as-image-files.aspx)**\n\n[blogs/2012/04/11/mac-os-x-threat-](http://www.totaldefense.com/blogs/2012/04/11/mac-os-x-threat-masquerading-as-image-files.aspx)\n[masquerading-as-image-files.aspx](http://www.totaldefense.com/blogs/2012/04/11/mac-os-x-threat-masquerading-as-image-files.aspx)\n\n\n\n**[• http://www.f-secure.com/v-descs/backdoor_](http://www.f-secure.com/v-descs/backdoor_osx_imuler_a.shtml)**\n\n[osx_imuler_a.shtml](http://www.f-secure.com/v-descs/backdoor_osx_imuler_a.shtml)\n\n**[• http://www.sophos.com/en-us/threat-center/](http://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/Troj~Luiha-BK/detailed-analysis.aspx)**\n\n[threat-analyses/viruses-and-spyware/](http://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/Troj~Luiha-BK/detailed-analysis.aspx)\n[Troj~Luiha-BK/detailed-analysis.aspx](http://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/Troj~Luiha-BK/detailed-analysis.aspx)\n\n**[• http://www.threatexpert.com/report.aspx?](http://www.threatexpert.com/report.aspx%3Fmd5%3D9d334262d146bd57a7adfb9b3e093f9f)**\n\n[md5=9d334262d146bd57a7adfb9b3e093f9f](http://www.threatexpert.com/report.aspx%3Fmd5%3D9d334262d146bd57a7adfb9b3e093f9f)\n\n**[• http://www.math.sci.hiroshima-u.ac.jp/~m-](http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/readme-mt.txt)**\n\n[mat/MT/MT2002/CODES/readme-mt.txt](http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/readme-mt.txt)\n\n**[• http://en.wikipedia.org/wiki/GB_2312](http://en.wikipedia.org/wiki/GB_2312)**\n\n**[• http://svnbook.red-bean.com/en/1.6/svn.](http://svnbook.red-bean.com/en/1.6/svn.developer.insidewc.html)**\n\n[developer.insidewc.html](http://svnbook.red-bean.com/en/1.6/svn.developer.insidewc.html)\n\n**[• http://www.trendmicro.com/us/enterprise/](http://www.trendmicro.com/us/enterprise/security-risk-management/deep-discovery/index.html)**\n\n[security-risk-management/deep-discovery/](http://www.trendmicro.com/us/enterprise/security-risk-management/deep-discovery/index.html)\ni d ht l\n\n\n-----\n\ncybercrime attacks, spam, web threats, and the like, targeted attacks are much harder to detect because of the\nnature of related components and techniques.\n# SAFE\n\n##### • First Seen\n\nIndividual targeted attacks are not one-off attempts. Attackers continually try to get inside the target’s network.\n\nThe Safe campaign was first seen on October 2012.\n\n##### • Victims and Targets\n\nTargeted threats target specific industries or communities of interest in specific regions.\n\nThe Safe campaign was able to compromise government ministries, technology companies, media outlets, academic research institutions, and\nnongovernmental organizations.\n\nFurthermore, it was discovered that the average number of actual victims remained at 71 per day, with few if any changes from day to day.\n\n##### • Operations\n\nFirst-stage computer intrusions often use social engineering. Attackers custom-fit attacks to their targets.\n\nThe Safe campaign attackers used spear-phishing emails with malicious attachments. Attackers used several malicious documents that all exploited a\nMicrosoft Office® vulnerability (i.e., CVE-2012-0158). If opened with a version of Microsoft Word® that is not up-to-date, a malicious payload is silently\ninstalled on the user’s computer.\n\nIn addition, one of the C&C servers used in the Safe campaign was set up in such a way that the contents of the directories were viewable to anyone\nwho accessed them.\n\n##### • Possible Indicators of Compromise\n\nAttackers want to remain undetected as long as possible. A key characteristic of targeted attacks is stealth.\n\nBelow is a list of the components of the Safe campaign.\n\nNetwork traffic identifiers: Host-based identifiers: Malware files:\n\n»» Network traffic going to mongolbaatarsonin. »» Presence of SafeExt.dll on the host »» TROJ_FAKESAFE.SMA\n\n**in** (commonly found in %Program Files%\\ »» TROJ_DROPER.SMA\n»» Network traffic going to withoutcake.com **Internet Explorer\\SafeNet\\)** »» TROJ_DROPDET.A\n»» Network traffic going to mongolbaatar.us »» Presence of SafeCredential.DAT on the »» TROJ_MDROP.DET\n»» Network traffic going to getapencil.com host (commonly found in %Program Files%\\ »» ADW_ADSTART\n»» User-agent identified as “Fantasia” **Internet Explorer\\SafeNet\\)** »» TROJ_CONNECT.DET\n»» Communication with any URL with the sub- »» Presence of the directory, %Program\n\nURL, /safe/record.php **Files%\\Internet Explorer\\SafeNet\\**\n\n»» Modification of certain registry values\n\n\n-----\n\n**TREND MICRO™**\n\nTrend Micro Incorporated, a global cloud security leader, creates\na world safe for exchanging digital information with its Internet\ncontent security and threat management solutions for businesses\nand consumers. A pioneer in server security with over 20 years\nexperience, we deliver top-ranked client, server, and cloud-based\nsecurity that fits our customers’ and partners’ needs; stops new\nthreats faster; and protects data in physical, virtualized, and cloud\nenvironments. Powered by the Trend Micro™ Smart Protection\nNetwork™ infrastructure, our industry-leading cloud-computing\nsecurity technology, products and services stop threats where\nthey emerge, on the Internet, and are supported by 1,000+ threat\nintelligence experts around the globe. For additional information,\n[visit www.trendmicro.com.](http://www.trendmicro.com)\n\n\n**TREND MICRO INCORPORATED**\n\n10101 N. De Anza Blvd.\nCupertino, CA 95014\n\n**U.S. toll free: 1 +800.228.5651**\n**Phone: 1 +408.257.1500**\n**Fax: 1 +408.257.2003**\n\n**[www.trendmicro.com](http://www.trendmicro.com)**\n\n\n**[www.trendmicro.com](http://www.trendmicro.com)**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        },
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/0yh8mn02v2wrehl9yaddrb8rjdzieeqb",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2013/2013.03.17.Targeted_Threat/Safe-a-targeted-threat.pdf",
        "https://paper.seebug.org/papers/APT/APT_CyberCriminal_Campagin/2013/Safe-a-targeted-threat.pdf"
    ],
    "report_names": [
        "Safe-a-targeted-threat",
        "Safe-a-targeted-threat.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716499,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1369039405,
    "ts_modification_date": 1369039693,
    "files": {
        "pdf": "https://archive.orkl.eu/334b4ee90a30c9ab9dcc6e3596f15f0dcb02486d.pdf",
        "text": "https://archive.orkl.eu/334b4ee90a30c9ab9dcc6e3596f15f0dcb02486d.txt",
        "img": "https://archive.orkl.eu/334b4ee90a30c9ab9dcc6e3596f15f0dcb02486d.jpg"
    }
}