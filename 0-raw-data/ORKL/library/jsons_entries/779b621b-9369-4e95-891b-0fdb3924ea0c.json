{
    "id": "779b621b-9369-4e95-891b-0fdb3924ea0c",
    "created_at": "2022-10-25T16:48:21.250419Z",
    "updated_at": "2025-03-27T02:14:34.84643Z",
    "deleted_at": null,
    "sha1_hash": "fa36f2632e6b9ff400f8b3ad9539f3bf4a586dec",
    "title": "Calypso APT: new group attacking state institutions",
    "authors": "Positive Technologies",
    "file_creation_date": "2019-10-28T15:46:04Z",
    "file_modification_date": "2019-10-28T15:46:09Z",
    "file_size": 5480623,
    "plain_text": "# Calypso APT\n\n## 2019\n\n##### ptsecurity.com\n\n\n-----\n\n#### Contents\n\n###### Calypso APT 2\n\n Initial infection vector 3\n\n Lateral movement 4\n\n Attribution 4\n\n Analyzing Calypso RAT malicious code 6\n\n Dropper 6\n\n Installation BAT script 7\n\n Shellcode x86: stager 9\n\n Modules 10\n\n Commands 11\n\n Network code 13\n\n Shellcode x64: stager (base backdoor) 13\n\n Modules 14\n\n Commands 15\n\n Network code 17\n\n Other options 19\n\n Dropper-stager 19\n\n Hussar 20\n\n Initialization  20\n\n Modules 22\n\n FlyingDutchman 23\n\n Conclusion 26\n\n Indicators of compromise 26\n\n Network 26\n\n File indicators 26\n\n Droppers and payload 26\n\n Droppers with the same payload 27\n\n Payload without dropper 27\n\n Hussar 27\n\n FlyingDutchman 27\n\n MITRE ATT&CK 28\n\n\n-----\n\n### Calypso APT\n\nThe PT Expert Security Center first took note of Calypso in\n\nMarch 2019 during threat hunting. Our specialists collected\n\nmultiple samples of malware used by the group. They have\n\nalso identified the organizations hit by the attackers, as well\n\nas the attackers' C2 servers.\n\nOur data indicates that the group has been active since at\n\nleast September 2016. The primary goal of the group is theft\n\nof confidential data. Main targets are governmental institu\ntions in Brazil, India, Kazakhstan, Russia, Thailand, and Turkey.\n\nOur data gives reason to believe that the APT group is of\n\nAsian origin.[1]\n\n1. See the section \"Attribution.\"\n\n\n-----\n\n#### Initial infection vector\n\nThe attackers accessed the internal network of a compromised organization by using an ASPX\n\nweb shell. They uploaded the web shell by exploiting a vulnerability or, alternately, guessing\n\ndefault credentials for remote access. We managed to obtain live traffic between the attackers\n\nand the web shell.\n\nFigure 1. Part of the recorded traffic\n\nThe traffic indicates the attackers connected from IP address 46.166.129.241. That host contains\n\ndomain tv.teldcomtv.com, the C2 server for the group's trojan. Therefore the hackers use C2\n\nservers not only to control malware, but also to access hosts on compromised infrastructures.\n\nThe attackers used the web shell to upload utilities[1] and malware,[2] execute commands, and dis\ntribute malware inside the network. Examples of commands from the traffic are demonstrated in\n\nthe following screenshot.\n\nFigure 2. Commands sent to the web shell\n\n1. See the section \"Lateral movement.\"\n\n2. See the section \"Analyzing Calypso RAT malicious code.\"\n\n\n-----\n\n#### Lateral movement\n\nThe group performed lateral movement by using the following publicly available utilities and\n\nexploits:\n\n\n� SysInternals\n\n� Nbtscan\n\n� Mimikatz\n\n� ZXPortMap\n\n� TCP Port Scanner\n\n� Netcat\n\n� QuarksPwDump\n\n\n� WmiExec\n\n� EarthWorm\n\n� OS_Check_445\n\n� DoublePulsar\n\n� EternalBlue\n\n� EternalRomance\n\n\nOn compromised computers, the group stored malware and utilities in either C:\\RECYCLER or\n\nC:\\ProgramData. The first option was used only on computers with Windows XP or Windows\n\nServer 2003 with NTFS on drive C.\n\nThe attackers spread within the network either by exploiting vulnerability MS17-010 or by using\n\nstolen credentials. In one instance, 13 days after the attackers got inside the network, they used\n\nDCSync and Mimikatz to obtain the Kerberos ticket of the domain administrator, \"passing the\n\nticket\" to infect more computers.\n\nFigure 3. Obtaining account data via DCSync\n\nUse of such utilities is common for many APT groups. Most of those utilities are legitimate ones\n\nused by network administrators. This allows the attackers to stay undetected longer.\n\n#### Attribution\n\nIn one attack, the group used Calypso RAT, PlugX, and the Byeby trojan. Calypso RAT is malware\n\nunique to the group and will be analyzed in detail in the text that follows.\n\nPlugX has traditionally been used by many APT groups of Asian origin. Use of PlugX in itself does\n\nnot point to any particular group, but is overall consistent with an Asian origin.\n\nThe Byeby trojan[1] was used in the SongXY malware campaign back in 2017. The version used now\n\nis modified from the original. The group involved in the original campaign is also of Asian origin.\n\nIt performed targeted attacks on defense and government-related targets in Russia and the CIS\n\ncountries. However, we did not find any clear-cut connection between the two campaigns.\n\nWhen we analyzed the traffic between the attackers' server and the web shell, we found that the\n\nattackers used a non-anonymous proxy server. The X-Forwarded-For header passed the attackers'\n\nIP address (36.44.74.47). This address would seem to be genuine (more precisely, the first address\n\nin a chain of proxy servers).\n\n1. [unit42.paloaltonetworks.com/unit42-threat-actors-target-government-belarus-using-cmstar-trojan/](https://unit42.paloaltonetworks.com/unit42-threat-actors-target-government-belarus-using-cmstar-trojan/)\n\n\n-----\n\nFigure 4. Headers of requests to the web shell\n\nThe IP address belongs to China Telecom. We believe the attackers could have been careless and\n\nset up the proxy server incorrectly, thus disclosing their real IP address. This is the first piece of\n\nevidence supporting the Asian origins of the group.\n\nFigure 5. Information on the discovered IP address\n\nThe attackers also left behind a number of system artifacts, plus traces in utility configurations\n\nand auxiliary scripts. These are also indicative of the group's origin.\n\nFor instance, one of the DoublePulsar configuration files contained external IP address\n\n103.224.82.47, presumably for testing. But all other configuration files contained internal\n\naddresses.\n\nFigure 6. IP address found in the DoublePulsar configuration\n\nThis IP address belongs to a Chinese provider, like the one before, and it was most likely left\n\nthere due to the attackers' carelessness. This constitutes additional evidence of the group's Asian\n\norigins.\n\nFigure 7. Information on the discovered IP address\n\n\n-----\n\nWe also found BAT scripts that launched ZXPortMap and EarthWorm for port forwarding. Inside\n\nwe found network indicators www.sultris.com and 46.105.227.110.\n\nFigure 8. Network indicators found in the BAT scripts\n\nThe domain in question was used for more than just tunneling: it also served as C2 server for the\n\nPlugX malware we found on the compromised system. As already mentioned, PlugX is tradition\nally used by groups of Asian origin, which constitutes yet more evidence.\n\nTherefore we can say that the malware and network infrastructure used all point to the group\n\nhaving an Asian origin.\n\n#### Analyzing Calypso RAT malicious code\n\nThe structure of the malware and the process of installing it on the hosts of a compromised net\nwork look as follows:\n\nFigure 9. Malware structure and installation process\n\n#### Dropper\n\nThe dropper extracts the payload as an installation BAT script and CAB archive, and saves it to\n\ndisk. The payload inside the dropper has a magic header that the dropper searches for. The fol\nlowing figure shows an example of the payload structure.\n\n\n-----\n\nFigure 10. Structure of the payload hard-coded in the dropper\n\nThe dropper encrypts and decrypts data with a self-developed algorithm that uses CRC32 as\n\na pseudorandom number generator (PRNG). The algorithm performs arithmetic (addition and\n\nsubtraction) between the generated data and the data that needs to be encrypted or decrypted.\n\nFigure 11. Dropper with original encryption and decryption algorithm\n\nNow decrypted, the payload is saved to disk at %ALLUSERSPROFILE;\\TMP_%d%d, where the\n\nlast two numbers are replaced by random numbers returned by the rand() function. Depending\n\non the configuration, the CAB archive contains one of three possibilities: a DLL and encrypted\n\nshellcode, a DLL with encoded loader in the resources, or an EXE file. We were unable to detect\n\nany instances of the last variant.\n\n#### Installation BAT script\n\nThe BAT script is encoded by substitution from a preset dictionary of characters; this dictionary\n\nis initialized in a variable in the installation script.\n\nFigure 12. Example of installation script obfuscation\n\nIn the decoded script, we can see comments hinting at the main functions of the script:\n\n� REM Goto temp directory & extract file (go to TEMP directory and extract files there)\n\n� REM Uninstall old version (uninstall the old version)\n\n� REM Copy file (copy file)\n\n� REM Run pre-install script (run the installation BAT script)\n\n� REM Create service (create a service launching the malware at system startup)\n\n� REM Create Registry Run (create value in the registry branch for autostart)\n\n\n-----\n\nAt the beginning of each script we can see a set of variables. The script uses these variables to\n\nsave files, modify services, and modify registry keys.\n\nFigure 13. Initializing variables in deobfuscated script\n\nIn one of the oldest samples, compiled in 2016, we found a script containing comments for how\n\nto configure each variable.\n\nFigure 14. Early version of the script with comments\n\n\n-----\n\n#### Shellcode x86: stager\n\nIn most of the analyzed samples, the dropper was configured to execute shellcode. The dropper\n\nsaved the DLL and encrypted shellcode to disk. The shellcode name was always identical to that\n\nof the DLL, but had the extension .dll.crt. The shellcode is encrypted with the same algorithm as\n\nthe payload in the dropper. The shellcode acts as a stager providing the interface for communi\ncating with C2 and for downloading modules. It can communicate with C2 via TCP and SSL. SSL\n\nis implemented via the mbed_tls library.\n\nInitial analysis of the shellcode revealed that, in addition to dynamically searching for API func\ntions, it runs one more operation that repeats the process of PE file address relocation. The\n\nstructure of the relocation table is also identical to that found in the PE file.\n\nFigure 15. Shellcode relocations\n\nSince the process of shellcode address relocation repeats that of the PE file, we can assume\n\nthat initially the malware is compiled into a PE file, and then the builder turns it into shellcode.\n\nDebugging information found inside the shellcode supports that assumption.\n\nFigure 16. Debugging information inside the shellcode\n\nAPI functions are searched for dynamically and addresses are relocated, after which the config\nuration hard-coded inside the shellcode is parsed. The configuration contains information about\n\nthe C2 server address, protocol used, and connection type.\n\nFigure 17. Example of shellcode configuration\n\nNext the shellcode creates a connection to C2. A random packet header is created and sent to C2.\n\nIn response the malware receives a network key, saves it, and then uses it every time when com\nmunicating with C2. Then the information about the infected computer is collected and sent to C2.\n\nNext three threads are launched. One is a heartbeat sending an empty packet to C2 every 54\n\nseconds. The other processes and executes commands from C2. As for the third thread, we could\n\nnot figure out its purpose, because the lines implementing its functionality were removed from the\n\ncode. All we can tell is that this thread was supposed to \"wake up\" every 54 seconds, just like the\n\nfirst one.\n\n\n-----\n\n#### Modules\n\nWe have not found any modules so far. But we can understand their functionality by analyzing\n\nthe code responsible for communication between the shellcode and the modules. Each module\n\nis shellcode which is given control over the zero offset of the address. Each module exists in its\n\nown separate container. The container is a process with loaded module inside. By default, the\n\nprocess is svchost.exe. When a container is created, it is injected with a small shellcode that caus\nes endless sleep. This is also hard-coded in the main shellcode, and more specifically in JustWait.\n\npdb, most likely.\n\nThe module is placed inside with an ordinary writeprocess and is launched either with\n\nNtCreateThreadEx or, on pre-Vista operating systems, CreateRemoteThread.\n\nTwo pipes are created for each module. One is for transmitting the data from the module to C2;\n\nthe other for receiving data from C2. Quite likely the modules do not have their own network\n\ncode and instead use the pipes to communicate with external C2 through the main shellcode.\n\nFigure 18. Creating pipes for modules\n\nEach module has a unique ID assigned by C2. Containers are launched in different ways. A con\ntainer can be launched in a specific session open in the OS or in the same session as the stager.\n\nIn any particular session, the container is launched by getting the handle for the session token of\n\na logged-in user, and then launching the process as that user.\n\n\n-----\n\nFigure 19. Creating container process in a different session\n\n#### Commands\n\nThe malware we studied can process 12 commands. All of them involve modules in one way or\n\nanother. Here is a list of all IDs of commands found in the malware, along with those that the mal\nware itself sends in various situations.\n\n**ID** **Direction** **Type** **Description**\n\nCreate module descriptor. This command contains\n\ninformation on the module size and ID. It also allo\n\n0x401 From С2 Command\n\n0x402 From С2 Command\n\n\ncates memory for the module data. The command\n\nis likely the first in the chain of commands used for\n\nloading a module\n\nAccept module data, and if all data is accepted,\n\nlaunch the module inside a container running in the\n\nsame session as the stager\n\n\nSame as 0x402, but the module is launched in a\n0x403 From С2 Command\n\ncontainer running in a different session\n\nWrite data to pipe for module launched inside a con0x404 From C2 Command\n\ntainer running in the same session as the stager\n\n\nWrite data to pipe for module launched inside a\n0x405 From С2 Command\n\ncontainer in a different session\n\n\n0x409 From С2 Command\n\n0х201 From С2 Command\n\n\nGenerate a constant by calling GetTickCount() and\n\nsave it. This constant is used in the third thread,\n\nmentioned already, whose purpose we were unable\n\nto discern\n\nLaunch the module if the buffer size stored in the\n\nmodule descriptor equals the module size. Does not\n\naccept data (unlike commands 0х402 and 0х403).\n\nThe module is launched inside a container running in\n\nthe same session as the stager\n\n\n-----\n\nSame as 0x201, but the module is launched in a con0х202 From С2 Command\n\ntainer running in a different session\n\nClose all pipes related to a specific module running\n\n\n0х203 From С2 Command\n\n\ninside a container launched in the same session as\n\nthe stager\n\n\nSame as 0x203, but for a module running in a con0х204 From С2 Command\n\ntainer launched in a different session\n\n\n0x206 From С2 Command\n\n\nCollect information on sessions open in the system\n\n(such as session IDs and computer names) and send\n\nit to C2\n\n\nAssign session ID. This ID will be used to launch con0х207 From С2 Command\n\ntainers in this session\n\nFrom the ID used in empty heartbeat packets (the first thread\n0x409 Response\n\nmalware described earlier)\n\n\nFrom the ID of packet containing information on the infected\n0x103 Response\n\nmalware computer\n\nFrom the ID of packet sent after an accepted session ID is\n0x302 Response\n\nmalware saved (command 0x207)\n\n\nFrom the\n0х304 Response\n\nmalware\n\n\nID of packet sent after module is successfully placed\n\ninside a container. This code is sent after the module\n\nis launched in a different session\n\n\nFrom the Same as 0x304, but the module is launched in the\n0х303 Response\n\nmalware same session as the stager\n\nFrom the ID of packet containing data piped by module in a\n0x406 Response\n\nmalware container launched in the same session as the stager\n\n\nFrom the Similar to 0x406, but from a module launched in a\n0x407 Response\n\nmalware different session\n\nFrom the ID of packet sent if no handle of a logged-in user's\n0x308 Response\n\nmalware session token could be obtained\n\n\nFrom the\n0x408 Response\n\nmalware\n\n\nID of packet sent if session-related information\n\ncould not be obtained. Before the packet is sent, the\n\nshellcode checks the OS version. If the version is\n\nearlier than Vista, data is regarded as impossible to\n\nobtain in the manner implemented in the malware,\n\nbecause the Windows API functions it uses are pres\nent only in Vista and later.\n\n\n-----\n\n#### Network code\n\nNetwork communication is initialized after the network key is received from C2. To do that, the\n\nmalware sends a random sequence of 12 bytes to C2. In response the malware also expects 12\n\nbytes, the zero offset of which must contain the same value (_DWORD) as prior to sending. If the\n\ncheck is successful, four bytes at offset 8 are taken from the response and decrypted with RC4.\n\nThe key is four bytes sent previously, also located at offset 8. This result is the network key. The\n\nkey is saved and then used to send data.\n\nAll transmitted packets have the following structure.\n\n\nstruct Packet{\nstruct PacketHeader{\n_ DWORD key;\n_ WORD cmdId;\n_ WORD szPacketPayload;\n_ DWORD moduleId;\n};\n_ BYTE [max 0xF000] packetPayload;\n};\n\n\nA random four-byte key is generated for each packet. It is later used to encrypt part of the header,\n\nstarting with the cmdld field. The same key is used to encrypt the packet payload. Encryption\n\nuses the RC4 algorithm. The key itself is encrypted by XOR with the network key and saved to the\n\ncorresponding field of the packet header.\n\n#### Shellcode x64: stager (base backdoor)\n\nThis shellcode is very similar to the previous one, but it deserves a separate description because\n\nof differences in its network code and method of launching modules. This shellcode has basic\n\nfunctions for file system interaction which are not available in the shellcode described earlier.\n\nAlso the configuration format, network code, and network addresses used as C2 by this shellcode\n\nare similar to code from a 2018 blog post by NCC Group about a Gh0st RAT variant. However, we\n\ndid not find a connection to Gh0st RAT.\n\nThis variant of the shellcode has only one communication channel, via SSL. The shellcode imple\nments it with two legitimate libraries, libeay32.dll and ssleay32.dll, hard-coded in the shellcode\n\nitself.\n\nFirst the shellcode performs a dynamic search for API functions and loads SSL libraries. The\n\nlibraries are not saved to disk; they are read from the shellcode and mapped into memory. Next\n\nthe malware searches the mapped image for the functions it needs to operate.\n\nThen it parses the configuration string, which is also hard-coded in the shellcode. The configura\ntion includes information on addresses of C2 servers and schedule for malware operation.\n\n**Days of the week**\n\nFigure 20. Sample of configuration string\n\n1. [nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2018/april/](https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2018/april/decoding-network-data-fr)\n[decoding-network-data-from-a-gh0st-rat-variant/](https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2018/april/decoding-network-data-fr)\n\n\n**Days of the week**\n\n\n-----\n\nAfter that the malware starts its main operating cycle. It checks if the current time matches the\n\nmalware operational time. If not, the malware sleeps for about 7 minutes and checks again. This\n\nhappens until the current time is the operational time, and only then does the malware resume\n\noperation. Figure 20 demonstrates an example in which the malware remains active at all times\n\non all days of the week.\n\nWhen the operational time comes, the malware goes down the list of C2 servers specified in the\n\nconfiguration and tries to connect. The malware subsequently interacts with whichever of the C2\n\nservers it is able to successfully connect to first.\n\nThen the malware sends the information on the infected computer (such as computer name,\n\ncurrent date, OS version, 32-bit vs. 64-bit OS and CPU, and IP addresses on network interfaces\n\nand their MAC addresses). After the information on the infected computer is sent, the malware\n\nexpects a response from C2. If C2 returns the relevant code, sending is deemed successful and\n\nthe malware proceeds. If not, the malware goes back to sequentially checking C2 addresses. Next\n\nit starts processing incoming commands from C2.\n\n#### Modules\n\nEach module is a valid MZPE file mapped in the address space of the same process as the shell\ncode. Also the module can export the GetClassObject symbol, which receives control when run\n\n(if required).\n\nEach module has its own descriptor created by a command from C2. The C2 server sends a byte\n\narray (0x15) describing the module. The array contains information on the module: whether the\n\nmodule needs to be launched via export, module type (in other words, whether it needs pipes\n\nfor communicating with C2), module size, entry point RVA (used if there is no flag for launching\n\nvia export), and module data decryption key. The key is, by and large, the data used to format\n\nthe actual key.\n\nFigure 21. Module decryption\n\nWe should also point out that decryption takes place only if modKey is not equal to the 7AC9h\n\nconstant hard-coded in the shellcode. This check affects only the decryption process. If modKey\n\ndoes equal the constant, the malware will immediately start loading the module. This means the\n\nmodule is not encrypted.\n\n\n-----\n\nEach module is launched in a separate thread created specially for that purpose. Launching with\n\npipes looks as follows:\n\n� The malware creates a thread for the module, starts mapping the module, and gives it control inside the newly created thread.\n\n� The malware creates a new connection to the current working C2.\n\n� The malware creates a pipe with the name derived from the following format string: \\\\.\\\npipe\\windows@#%02XMon (%02X is replaced by a value that is received from С2 at the same\ntime as the command for launching the module).\n\n� The malware launches two threads passing data from the pipe to C2 and vice versa,\nusing the connection created during the previous step. Two more pipes, \\\\.\\pipe\\windows@#%02Xfir and \\\\.\\pipe\\windows@#%02Xsec, are created inside the threads. The pipe\nending in \"fir\" is used to pass data from the module to C2. The pipe ending in \"sec\" is used\nto pass data and commands from C2 to the modules.\n\nThe second thread processing the commands from C2 to the modules has its own handler. This\n\nis described in more details in the Commands section. For now we can only say that one of the\n\ncommands can start a local asynchronous TCP server. That server will accept data from whoever\n\nconnects to it, send it to C2, and forward it back from C2. It binds to 127.0.0.1 at whichever port it\n\nfinds available, starting from 5000 and trying possible ports one by one.\n\n#### Commands\n\nThe following is a list of IDs for commands the malware can receive, along with commands the\n\nmalware itself sends in various situations.\n\n**ID** **Direction** **Type** **Description**\n\n0x294C From С2 Command Create module descriptor\n\n0x2AC8 From С2 Command Receive data containing the module, and save it\n\n0x230E From С2 Command Launch module without creating additional pipes\n\n0x2D06 From С2 Command Destroy module descriptor object\n\n0x590A From С2 Command Launch built-in module for file system access\n\n0x3099 From С2 Command Launch module and create additional pipes for\n\ncommunication\n\nSelf-removal: run a BAT script removing persistence\n0x1C1C From С2 Command\n\nand clearing the created directories\n\n0x55C3 From С2 Command Upload file from computer to C2\n\n0x55C5 From С2 Command List directories recursively\n\n\n-----\n\n0x55C7 From С2 Command Download file from C2 to computer\n\n0x3167 From С2 Command Write data to pipe ending in \"Mon\"\n\nWrite command 0x38AF to pipe ending in \"Mon\".\n\n\n0x38AF From С2 Command\n\n\nAfter that, end the open connection for the module.\n\nPossibly means \"complete module operation\"\n\n\n0x3716 From С2 Command Send module data to a different module\n\n0x3A0B From С2 Command Same as 0x3099\n\nStart an asynchronous TCP server to shuttle data\n0x3CD0 From С2 Command\n\nbetween C2 and connected client\n\n\nFrom the Response ID of a packet containing information about the\n0x129E\n\nmalware computer\n\n\n0x132A From С2 Response\n\nFrom the\n0x155B Response\n\nmalware\n\n\nID of the packet sent by C2 in response to\n\ninformation sent regarding the infected computer.\n\nThe malware treats receipt of this packet as\n\nconfirming successful receipt of such information\n\nID of the packet containing information regarding\n\nthe initialized module descriptors. The packet acts\n\nas \"GetCommand\". Response to this packet contains\n\none of the supported commands\n\n\nFrom the ID of the packet that is sent if a module descriptor\n0x2873 Response\n\nmalware has been initialized successfully (0x294c)\n\nFrom the ID of the packet that is sent if an error has occurred\n0x2D06 Response\n\nmalware during module descriptor initialization (0x294c)\n\n\nFrom the\n0x2873 Response\n\nmalware\n\n\nthe packet that is sent after module data has been\n\nreceived (0x2AC8). Contains the amount of bytes\n\nalready saved\n\n\nFrom the ID of the packet that is sent after a module is\n0x2743 Response\n\nmalware launched without pipes (0x230E)\n\n\n-----\n\nFrom the ID of the packet that is sent after a module\n0x2D06 Response\n\nmalware descriptor has been destroyed (0x2D06)\n\nFrom the ID of the packet that is sent after a module is\n0x3F15 Response\n\nmalware launched with pipes\n\n\nFrom the\n0x32E0 Response\n\nmalware\n\n\nID of the packet that is sent if there has been an\n\nattempt to reinitialize the pipes already created for\n\na module\n\n\nFrom the ID of the packet containing the data sent from the\n0x34A7 Response\n\nmalware pipe to C2\n\n\nFrom the ID of the packet containing the data forwarded from\n0x9F37 Response\n\nmalware the TCP server to C2\n\n#### Network code\n\nEach packet has the following structure:\n\n\nStruct Packet{\nStruct Header{\n_ DWORD rand _ k1;\n_ DWORD rand _ k2;\n_ DWORD rand _ k3;\n_ DWORD szPaylaod;\n_ DWORD protoConst;\n_ DWORD packetId;\n_ DWORD unk1;\n_ DWORD packetKey;\n};\n_ BYTE [max 0x2000] packetPayload;\n};\n\n\nEach packet has a unique key calculated as szPayload + GetTickCount() % hardcodedConst. This\n\nkey is saved in the corresponding packetKey header field. It is used to generate another key for\n\nencrypting the packet header with RC4 (encryption will not occur without the packetKey field).\n\nRC4 key generation is demonstrated in the following figure.\n\n\n-----\n\nFigure 22. Generating RC4 key for the header\n\nThen yet another RC4 key is generated from the encrypted fields szPayload, packetId, proto\nConst, and rand_k3. This key is used to encrypt the packet payload.\n\nFigure 23. Generating RC4 key for the packet payload\n\n\n-----\n\nNext the shellcode forms the HTTP headers and the created packet is sent to C2. In addition,\n\neach packet gets its own number, indicated in the URL. Modules may pass their ID, which is used\n\nto look up the connection established during module launch. Module ID 0 is reserved for the main\n\nconnection of the stager.\n\nFigure 24. Forming HTTP headers\n\n#### Other options\n\nAs we noted, the dropper may be configured to launch not just shellcode, but executable files\n\ntoo. We found the same dropper-stager but with different payloads: Hussar and FlyingDutchman.\n\n#### Dropper-stager\n\nThe main tasks of this dropper are unpacking and mapping the payload, which is encoded and\n\nstored in resources. The dropper also stores encoded configuration data and passes it as a\n\nparameter to the payload.\n\nFigure 25. Unpacking the payload\n\n\n-----\n\n#### Hussar\n\nIn essence Hussar is similar to the shellcodes described earlier. It allows loading modules and\n\ncollecting basic information about the computer. It can also add itself to the list of authorized\n\napplications in Windows Firewall.\n\n#### Initialization\n\nTo start, the malware parses the configuration provided to it by the loader.\n\nFigure 26. Configuration sample\n\nConfiguration structure is as follows:\n\n\nStruct RawConfig{\n_ DWORD protocolId;\n_ BYTE c2Strings [0x100];\n};\n\n\nThe protocolId field indicates the protocol to be used for communicating with C2. There are a\n\ntotal of three possibilities:\n\n� If protocolId equals 1, a TCP-based protocol will be used.\n\n� If protocolId equals 2, the protocol will be HTTP-based.\n\n� If protocolId equals 3, it will be HTTPS-based.\n\nThe time stamp is calculated from the registry from the key SOFTWARE\\Microsoft\\Windows\\\n\nCurrentVersion\\Telephony (Perf0 value). If reading the time stamp is impossible, \"temp\" is added\n\nto the computer identifier.\n\nFigure 27. Generating computer ID\n\n\n-----\n\nNext Hussar creates a window it will use for processing incoming messages.\n\nFigure 28. Creating dispatcher window\n\nThen the malware adds itself to the list of authorized applications in Windows Firewall, using the\n\nINetFwMgr COM interface.\n\nTo complete initialization, Hussar creates a thread which connects to C2 and periodically polls\n\nfor commands. The function running in the thread uses the WSAAsyncSelect API to notify the\n\nwindow that actions can be performed with the created connection (socket is \"ready for reading,\"\n\n\"connected,\" or \"closed\").\n\nFigure 29. Communication between the open socket and the window\n\nIn general, for transmitting commands, the malware uses the window and Windows messaging\n\nmechanism. The window handle is passed to the modules, and the dispatcher has branches not\n\nused by the stager, so we can assume that the modules can use the window for communication\n\nwith C2.\n\n\n-----\n\n#### Modules\n\nEach module is an MZPE file loaded into the same address space as the stager. The module must\n\nexport the GetModuleInfo function, which is called by the stager after image mapping.\n\nIdentifier Direction Type Description\n\nCollect information on the infected comput\ner (such as OS version, user name, computer\n\n\n0x835 From С2 Command\n\n\nname, and string containing current time and\n\nprocessor name based on registry data, plus\n\nwhether the OS is 64-bit)\n\n\n0x9CA4 From С2 Command Load module. Module data comes from C2\n\n0xC358\n\n\n(Window MSG\n\nCode)\n\n0xC359\n\n(Window MSG\n\nCode)\n\n0x834,\n\n0x835, 0x838,\n\n0x9CA4, none\n\nof these\n\n\n??? Command Transmit data from LPARAM to C2\n\nTransmit C2 configuration to the module.\n??? Command\n\nModule ID is transmitted to LPARAM\n\n\nTransmit the received packet to the module.\n??? Command\n\nModule ID is sent from C2\n\n\n-----\n\n#### FlyingDutchman\n\nThe payload provides remote access to the infected computer. It includes functions such as\n\nscreenshot capture, remote shell, and file system operations. It also allows managing system\n\nprocesses and services. It consists of several modules.\n\nModule ID CMD ID Direction Type Description\n\n0xafc8 0xAFD3 From С2 Command Module ping\n\nSends information about the infected comput\ner (such as OS version and installed service\n\n\n0xAFD4 From С2 Command\n\n\npacks, processor name, string containing cur\nrent time and screen resolution, and informa\ntion about free and used disk space)\n\n\n0xAFD5 From С2 Command Sends list of processes running on the system\n\nEnd process. Process PID is transmitted from\n0xAFD7 From С2 Command\n\nC2\n\n\nSends list of current windows on the system,\n0xAFD9 From С2 Command\n\nalong with their titles\n\nSend WM_CLOSE message to a specific\n0xAFDA From С2 Command\n\nwindow\n\n0xAFDB From С2 Command Maximize window\n\n0xAFDC From С2 Command Minimize window\n\n0xAFDD From С2 Command Show window\n\n0xAFDE From С2 Command Hide window\n\n\n-----\n\n0xAFE0 From С2 Command Sends list of current services on the system\n\nModifies the status of an existing service.\n\nService name is obtained from C2. It can\n\n\n0xAFE1 From С2 Command\n\n\nlaunch a service or change its status to STOP,\n\nPAUSE, or CONTINUE. C2 indicates which\n\nstatus to change to\n\n\nDelete existing service. Service name is re0xAFE2 From С2 Command\n\nceived from C2\n\n\nChange service start type. Service name is\n0xAFE3 From С2 Command\n\nreceived from C2\n\n0xabe0 0xABEB From С2 Command Module ping\n\nLaunch the process for transmitting screen\n\n0xABEC From С2 Command\n\n\nshots from the infected computer. Screenshots\n\nare taken every second\n\n\n0xABED From С2 Command Pause screenshot capture process\n\nStop taking screenshots. The module stops\n0xABF1 From С2 Command\n\nrunning\n\nRun cmd.exe plus a thread, which will read\n\n\n0xa7f8 0xA803 From С2 Command\n\n\nconsole output data from the related pipe and\n\nsend it to C2\n\n\nWrite command to the pipe linked to STDIN of\n0xA804 From С2 Command\n\nthe cmd.exe created previously\n\n\nStop the cmd.exe process and all associated\n0xA805 From С2 Command\n\npipes. The module stops running\n\nSends information about system disks and their\n0xa410 0xA41B From С2 Command\n\ntypes\n\n\n-----\n\nSends directory listing. The relevant directory\n0xA41C From С2 Command\n\npath is obtained via C2\n\n0xA41E From С2 Command Upload file from the computer to C2\n\n0xA41F From С2 Command Run file\n\n0xA420 From С2 Command Delete file\n\n0xA421 From С2 Command Download file from C2\n\n0xA424 From С2 Command Move file\n\n0xA425 From С2 Command Create directory\n\n0xA426 From С2 Command File Touch\n\nSends the size of a file to C2. File path is\n0xA428 From С2 Command\n\npassed via C2\n\n\n-----\n\n#### Conclusion\n\nThe group has several successful hacks to its credit, but still makes mistakes allowing us to guess\n\nits origins. All data given here suggests that the group originates from Asia and uses malware not\n\npreviously described by anyone. The Byeby trojan links the group to SongXY, encountered by us\n\npreviously, which was most active in 2017.\n\nWe keep monitoring the activities of Calypso closely and expect the group will attack again.\n\n#### Indicators of compromise\n\n###### Network\n\n23.227.207.137\n\n45.63.96.120\n\n45.63.114.127\n\nr01.etheraval.com\n\ntc.streleases.com\n\ntv.teldcomtv.com\n\nkrgod.qqm8.com\n\n###### File indicators\n\n Droppers and payload\n\nC9C39045FA14E94618DD631044053824 Dropper\n\nE24A62D9826869BC4817366800A8805C Dll\n\nF0F5DA1A4490326AA0FC8B54C2D3912D Shellcode\n\nCB914FC73C67B325F948DD1BF97F5733 Dropper\n\n6347E42F49A86AFF2DEA7C8BF455A52A Dll\n\n0171E3C76345FEE31B90C44570C75BAD Shellcode\n\n17E05041730DCD0732E5B296DB16D757 Dropper\n\n69322703B8EF9D490A20033684C28493 Dll\n\n22953384F3D15625D36583C524F3480A Shellcode\n\n1E765FED294A7AD082169819C95D2C85 Dropper\n\nC84DF4B2CD0D3E7729210F15112DA7AC Dll\n\nACAAB4AA4E1EA7CE2F5D044F198F0095 Shellcode\n\n\n-----\n\n###### Droppers with the same payload\n\n85CE60B365EDF4BEEBBDD85CC971E84D dropper\n\n1ED72C14C4AAB3B66E830E16EF90B37B dropper\n\nCB914FC73C67B325F948DD1BF97F5733 dropper\n\n###### Payload without dropper\n\nE3E61F30F8A39CD7AA25149D0F8AF5EF Dll\n\n974298EB7E2ADFA019CAE4D1A927AB07 Shellcode\n\nAA1CF5791A60D56F7AE6DA9BB1E7F01E Dll\n\n05F472A9D926F4C8A0A372E1A7193998 Shellcode\n\n0D532484193B8B098D7EB14319CEFCD3 Dll\n\nE1A578A069B1910A25C95E2D9450C710 Shellcode\n\n2807236C2D905A0675878E530ED8B1F8 Dll\n\n847B5A145330229CE149788F5E221805 Shellcode\n\nD1A1166BEC950C75B65FDC7361DCDC63 Dll\n\nCCE8C8EE42FEAED68E9623185C3F7FE4 Shellcode\n\n###### Hussar\n\n43B7D48D4B2AFD7CF8D4BD0804D62E8B\n\n617D588ECCD942F243FFA8CB13679D9C\n\n###### FlyingDutchman\n\n5199EF9D086C97732D97EDDEF56591EC\n\n06C1D7BF234CE99BB14639C194B3B318\n\n\n-----\n\nAbout\nPositive Technologies\n\n\n#### MITRE ATT&CK\n\n**Tactic** **ID** **Name**\n\nExecution T1059 Command-Line Interface\n\nPersistence T1060 Registry Run Keys / Startup Folder\n\nT1053 Scheduled Task\n\nT1158 Hidden Files and Directories\n\nDefense Evasion T1027 Obfuscated Files or Information\n\nT1085 Rundll32\n\nT1064 Scripting\n\nCredential Access T1003 Credential Dumping\n\nDiscovery T1087 Account Discovery\n\nT1046 Network Service Scanning\n\nT1135 Network Share Discovery\n\nT1082 System Information Discovery\n\nLateral Movement T1097 Pass the Ticket\n\nCollection T1114 Email Collection\n\nT1113 Screen Capture\n\nT1005 Data from Local System\n\nCommand And Control T1043 Commonly Used Port\n\nT1024 Custom Cryptographic Protocol\n\nT1001 Data Obfuscation\n\nPositive Technologies is a leading global provider of enterprise security solutions for vulnerability and compliance management, incident and threat analysis, and application protection. Commitment to clients and research has earned Positive Technologies a reputation as one of the foremost authorities on Industrial Control System, Banking, Telecom, Web Application, and\nERP security, supported by recognition from the analyst community. Learn more about Positive Technologies at ptsecurity.com.\n\n\n[ptsecurity.com](https://www.ptsecurity.com/ww-en/) © 2019 Positive Technologies. Positive Technologies and the Positive Technologies logo are trademarks or registered trade[info@ptsecurity.com](mailto:info%40ptsecurity.com?subject=) marks of Positive Technologies. All other trademarks mentioned herein are the property of their respective owners.\n\nCalypso APT A4 ENG 0002 02\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        },
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/7vzrq3frrll02n1gx4ssbtljnbgl0h7w",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2019/2019.10.31.Calypso_APT/calypso-apt-2019-eng.pdf",
        "https://www.ptsecurity.com/upload/corporate/ww-en/analytics/calypso-apt-2019-eng.pdf"
    ],
    "report_names": [
        "calypso-apt-2019-eng(10-31-2019)",
        "calypso-apt-2019-eng",
        "calypso-apt-2019-eng.pdf"
    ],
    "threat_actors": [
        {
            "id": "3c5b0e7e-2388-4b63-9b97-6b027bec4bf7",
            "created_at": "2023-01-06T13:46:39.068694Z",
            "updated_at": "2025-03-27T02:00:02.989445Z",
            "deleted_at": null,
            "main_name": "Calypso",
            "aliases": [
                "BRONZE MEDLEY"
            ],
            "source_name": "MISPGALAXY:Calypso",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "13d9c5fc-af82-4474-90dd-188c4e40a399",
            "created_at": "2022-10-25T16:07:23.435079Z",
            "updated_at": "2025-03-27T02:02:09.800346Z",
            "deleted_at": null,
            "main_name": "Calypso",
            "aliases": [
                "Bronze Medley"
            ],
            "source_name": "ETDA:Calypso",
            "tools": [
                "Agent.dhwf",
                "Byeby",
                "Calypso RAT",
                "DCSync",
                "Destroy RAT",
                "DestroyRAT",
                "DoublePulsar",
                "EternalBlue",
                "EternalRomance",
                "FlyingDutchman",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "NBTscan",
                "OS_Check_445",
                "PlugX",
                "Quarks PwDump",
                "RedDelta",
                "SAMRID",
                "Sogu",
                "SysInternals",
                "TCP Port Scanner",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Whitebird",
                "Xamtrav",
                "ZXPortMap",
                "nbtscan",
                "netcat"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e6c64ba5-12e1-4f04-97d5-077d83da95e1",
            "created_at": "2024-10-08T02:00:04.466964Z",
            "updated_at": "2025-03-27T02:00:03.436873Z",
            "deleted_at": null,
            "main_name": "SongXY",
            "aliases": [],
            "source_name": "MISPGALAXY:SongXY",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "4b066585-3591-4ddd-b3cc-f4e19e0e00ef",
            "created_at": "2022-10-25T16:07:24.086915Z",
            "updated_at": "2025-03-27T02:02:10.103556Z",
            "deleted_at": null,
            "main_name": "Putter Panda",
            "aliases": [
                "APT 2",
                "Group 36",
                "Putter Panda",
                "SearchFire",
                "TG-6952"
            ],
            "source_name": "ETDA:Putter Panda",
            "tools": [
                "3PARA RAT",
                "4H RAT",
                "4h_rat",
                "MSUpdater",
                "httpclient",
                "pngdowner"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "c39b0fe6-5642-4717-9a05-9e94265e3e3a",
            "created_at": "2022-10-25T16:07:24.332084Z",
            "updated_at": "2025-03-27T02:02:10.175452Z",
            "deleted_at": null,
            "main_name": "Tonto Team",
            "aliases": [
                "Bronze Huntley",
                "CactusPete",
                "Earth Akhlut",
                "HartBeat",
                "Karma Panda",
                "LoneRanger",
                "Operation Bitter Biscuit",
                "TAG-74",
                "Tonto Team"
            ],
            "source_name": "ETDA:Tonto Team",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "Bioazih",
                "Bisonal",
                "CONIME",
                "Dexbia",
                "Korlia",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "POISONPLUG.SHADOW",
                "RoyalRoad",
                "ShadowPad Winnti",
                "XShellGhost"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716501,
    "ts_updated_at": 1743041674,
    "ts_creation_date": 1572277564,
    "ts_modification_date": 1572277569,
    "files": {
        "pdf": "https://archive.orkl.eu/fa36f2632e6b9ff400f8b3ad9539f3bf4a586dec.pdf",
        "text": "https://archive.orkl.eu/fa36f2632e6b9ff400f8b3ad9539f3bf4a586dec.txt",
        "img": "https://archive.orkl.eu/fa36f2632e6b9ff400f8b3ad9539f3bf4a586dec.jpg"
    }
}