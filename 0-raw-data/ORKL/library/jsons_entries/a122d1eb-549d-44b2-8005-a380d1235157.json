{
    "id": "a122d1eb-549d-44b2-8005-a380d1235157",
    "created_at": "2022-10-25T16:48:19.828418Z",
    "updated_at": "2025-03-27T02:06:07.910374Z",
    "deleted_at": null,
    "sha1_hash": "66abb93ddb5a1e2dc75b1d8db5c97417200c3996",
    "title": "Targeted Attacks against Banks in the Middle East",
    "authors": "FireEye",
    "file_creation_date": "2016-05-23T23:30:38Z",
    "file_modification_date": "2016-05-23T23:30:38Z",
    "file_size": 895256,
    "plain_text": "## fireeye.com\n\n# Targeted Attacks against Banks in the Middle East « Threat Research Blog\n\n## May 22, 2016 • 5 min read • original\n\n Introduction\n\n In the first week of May 2016, FireEye’s DTI identified\n\n a wave of emails containing malicious attachments\n\n being sent to multiple banks in the Middle East region.\n\n The threat actors appear to be performing initial\n\n reconnaissance against would-be targets, and the\n\n attacks caught our attention since they were using\n\n unique scripts not commonly seen in crimeware\n\n campaigns.\n\n In this blog we discuss in detail the tools, tactics,\n\n techniques and procedures (TTPs) used in these\n\n targeted attacks.\n\n\n-----\n\n## The attackers sent multiple emails containing macro\n enabled XLS files to employees working in the banking\n\n sector in the Middle East. The themes of the messages\n\n used in the attacks are related to IT Infrastructure\n\n such as a log of Server Status Report or a list of Cisco\n\n Iron Port Appliance details. In one case, the content of\n\n the email appeared to be a legitimate email\n\n conversation between several employees, even\n\n containing contact details of employees from several\n\n banks. This email was then forwarded to several\n\n people, with the malicious Excel file attached.\n\n Macro Details\n\n The macro first calls an Init() function (shown in\n\n Figure 1) that performs the following malicious\n\n activities:\n\n 1. Extracts base64-encoded content from the cells\n\n within a worksheet titled \"Incompatible\".\n\n 2. Checks for the presence of a file at the path\n\n %PUBLIC%\\Libraries\\ update.vbs. If the file is not\n\n present, the macro creates three different\n\n directories under %PUBLIC%\\Libraries, namely\n\n up, dn, and tp.\n\n\n-----\n\n## p\n\n using PowerShell and dropped into two different\n\n files: %PUBLIC%\\Libraries\\update.vbs and\n\n %PUBLIC%\\Libraries\\dns.ps1\n\n 4. The macro then creates a scheduled task with\n\n name: GoogleUpdateTaskMachineUI, which\n\n executes update.vbs every three minutes.\n\n Note: Due to the use of a hardcoded environment\n\n variable %PUBLIC% in the macro code, the macro will\n\n only run successfully on Windows Vista and\n\n subsequent versions of the operating system.\n\n Fi 1 M I i () b i\n\n\n-----\n\n## One of the interesting techniques we observed in this\n\n attack was the display of additional content after the\n\n macro executed successfully. This was done for the\n\n purpose of social engineering – specifically, to\n\n convince the victim that enabling the macro did in fact\n\n result in the “unhiding” of additional spreadsheet\n\n data.\n\n Office documents containing malicious macros are\n\n commonly used in crimeware campaigns. Because\n\n default Office settings typically require user action in\n\n order for macros to run, attackers may convince\n\n victims to enable risky macro code by telling them that\n\n the macro is required to view “protected content.”\n\n In crimeware campaigns, we usually observe that no\n\n additional content is displayed after enabling the\n\n macros. However, in this case, attackers took the extra\n\n step to actually hide and unhide worksheets when the\n\n macro is enabled to allay any suspicion. A screenshot\n\n of the worksheet before and after running the macro is\n\n shown in Figure 2 and Figure 3, respectively.\n\n\n-----\n\n## Figure 2: Before unhiding of content\n\n Figure 3: After unhiding of content\n\n In the following code section, we can see that the\n\n subroutine ShowHideSheets() is called after the Init()\n\n subroutine executes completely:\n\n Private Sub Workbook_Open()\n\n   Call Init\n\n     Call ShowHideSheets\n\n End Sub\n\n\n-----\n\n## The code of subroutine ShowHideSheets(), which\n\n unhides the content after completion of malicious\n\n activities, is shown in Figure 4.\n\n Figure 4: Macro used to unhide content at runtime\n\n First Stage Download\n\n After the macro successfully creates the scheduled\n\n task, the dropped VBScript, update.vbs (Figure 5), will\n\n be launched every three minutes. This VBScript\n\n performs the following operations:\n\n 1. Leverages PowerShell to download content from\n\n the URI hxxp://go0gIe[.]com/sysupdate.aspx?\n\n req=xxx\\dwn&m=d and saves it in the directory\n\n %PUBLIC%\\Libraries\\dn\n\n\n-----\n\n## URI hxxp://go0gIe[.]com/sysupdate.aspx?\n\n req=xxx\\bat&m=d and saves it in the directory\n\n %PUBLIC%\\Libraries\\dn.\n\n 3. Executes the BAT file and stores the results in a\n\n file in the path %PUBLIC%\\Libraries\\up.\n\n 4. Uploads this file to the server by sending an HTTP\n\n POST request to the URI\n\n hxxp://go0gIe[.]com/sysupdate.aspx?\n\n req=xxx\\upl&m=u.\n\n 5. Finally, it executes the PowerShell script dns.ps1,\n\n which is used for the purpose of data exfiltration\n\n using DNS.\n\n Figure 5: Content of update.vbs\n\n During our analysis, the VBScript downloaded a\n\n customized version of Mimikatz in the previously\n\n mentioned step one. The customized version uses its\n\n\n-----\n\n## own default prompt string as well as its own console\n\n title, as shown in Figure 6.\n\n Figure 6: Custom version of Mimikatz used to extract\n\n user password hashes\n\n Similarly, the contents of the BAT file downloaded in\n\n step two are shown in Figure 7:\n\n whoami & hostname & ipconfig /all & net user\n\n /domain 2>&1 & net group /domain 2>&1 & net group\n\n \"domain admins\" /domain 2>&1 & net group\n\n \"Exchange Trusted Subsystem\" /domain 2>&1 & net\n\n accounts /domain 2>&1 & net user 2>&1 & net\n\n localgroup administrators 2>&1 & netstat -an 2>&1 &\n\n tasklist 2>&1 & sc query 2>&1 & systeminfo 2>&1 & reg\n\n\n-----\n\n## query\n\n \"HKEY_CURRENT_USER\\Software\\Microsoft\\Termin\n\n Server Client\\Default\" 2>&1\n\n Figure 7: Content of downloaded BAT script\n\n This BAT file is used to collect important information\n\n from the system, including the currently logged on\n\n user, the hostname, network configuration data, user\n\n and group accounts, local and domain administrator\n\n accounts, running processes, and other data.\n\n Data Exfiltration over DNS\n\n Another interesting technique leveraged by this\n\n malware was the use of DNS queries as a data\n\n exfiltration channel. This was likely done because\n\n DNS is required for normal network operations. The\n\n DNS protocol is unlikely to be blocked (allowing free\n\n communications out of the network) and its use is\n\n unlikely to raise suspicion among network defenders.\n\n The script dns.ps1, dropped by the macro, is used for\n\n this purpose. In the following section, we describe its\n\n functionality in detail.\n\n\n-----\n\n## p q ( g\n\n protocol) from go0gIe[.]com. This ID will then be\n\n saved into the PowerShell script.\n\n 2. Next, the script queries the C2 server for\n\n additional instructions. If no further actions are\n\n requested, the script exits and will be activated\n\n again the next time update.vbs is called.\n\n 3. If an action is required, the DNS server replies\n\n with an IP with the pattern 33.33.xx.yy. The script\n\n then proceeds to create a file at\n\n %PUBLIC%\\Libraries\\tp\\chr(xx)chr(yy).bat. The\n\n script then proceeds to make DNS requests to\n\n fetch more data. Each DNS request results in the\n\n C2 server returning an IP address. Each octet of\n\n the IP address is interpreted as the decimal\n\n representation of an ASCII character; for example,\n\n the decimal number 99 is equivalent to the ASCII\n\n character ‘c’. The characters represented by the\n\n octets of the IP address are appended to the batch\n\n file to construct a script. The C2 server signals the\n\n end of the data stream by replying to a DNS query\n\n with the IP address 35.35.35.35.\n\n 4. Once the file has been successfully transferred,\n\n the BAT file will be run and its output saved as\n\n %PUBLIC%\\Libraries\\tp\\chr(xx)chr(yy).txt.\n\n 5. The text file containing the results of the BAT\n\n\n-----\n\n## p p y\n\n embedding file data into part of the subdomain.\n\n The format of the DNS query used is shown in\n\n Table 1.\n\n 6. The BAT file and the text file will then be deleted.\n\n The script then quits, to be invoked again upon\n\n running the next scheduled task.\n\n The DNS communication portion of the script is\n\n shown in Figure 8, along with a table showing the\n\n various subdomain formats being generated by the\n\n script.\n\n Figure 8: Code Snippet of dns.ps1\n\n\n-----\n\n## Format of subdomains used in DNS C2 protocol:\n\n\n-----\n\n### used to request for BotID, used in step 2 above\n\n\n### Subdomain used while performing file transfers used in step 3 above\n\n\n\n### [00]\n [botid]00000[base36 random number]232A[hex_filenam\n [i-counter]\n\n\n### Subdomain used while performing file upload, used in step 5 above\n\n\n\n### [00][botid][cmdid][partid][base36 random number][48- hex-char-of-file-content]\n\n\n## Table 1: C2 Protocol Format\n\n Conclusion\n\n Although this attack did not leverage any zero-days or\n\n other advanced techniques, it was interesting to see\n\n how attackers used different components to perform\n\n reconnaissance activities on a specific target.\n\n This attack also demonstrates that macro malware is\n\n effective even today. Users can protect themselves\n\n from such attacks by disabling Office macros in their\n\n\n-----\n\n## settings and also by being more vigilant when enabling\n\n macros (especially when prompted) in documents,\n\n even if such documents are from seemingly trusted\n\n sources.\n\n**Original URL:**\n\nhttps://www.fireeye.com/blog/threat-research/2016/05/targeted_attacksaga.html\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/43ovij7jz7isl93tow4s3f89yhuiwu4e"
    ],
    "report_names": [
        "FireEye_Targeted-Attacks-against-Banks-in-the-Middle-East(5-23-16)"
    ],
    "threat_actors": [
        {
            "id": "578f8e62-2bb4-4ce4-a8b7-6c868fa29724",
            "created_at": "2022-10-25T16:07:24.344358Z",
            "updated_at": "2025-03-27T02:02:10.182282Z",
            "deleted_at": null,
            "main_name": "Tropic Trooper",
            "aliases": [
                "APT 23",
                "Bronze Hobart",
                "Earth Centaur",
                "KeyBoy",
                "Operation Tropic Trooper",
                "Pirate Panda",
                "Tropic Trooper"
            ],
            "source_name": "ETDA:Tropic Trooper",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "ByPassGodzilla",
                "CHINACHOPPER",
                "CREDRIVER",
                "China Chopper",
                "Chymine",
                "Darkmoon",
                "Gen:Trojan.Heur.PT",
                "KeyBoy",
                "Neo-reGeorg",
                "PCShare",
                "POISONPLUG.SHADOW",
                "Poison Ivy",
                "RoyalRoad",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Swor",
                "TSSL",
                "USBferry",
                "W32/Seeav",
                "Winsloader",
                "XShellGhost",
                "Yahoyah",
                "fscan",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716499,
    "ts_updated_at": 1743041167,
    "ts_creation_date": 1464046238,
    "ts_modification_date": 1464046238,
    "files": {
        "pdf": "https://archive.orkl.eu/66abb93ddb5a1e2dc75b1d8db5c97417200c3996.pdf",
        "text": "https://archive.orkl.eu/66abb93ddb5a1e2dc75b1d8db5c97417200c3996.txt",
        "img": "https://archive.orkl.eu/66abb93ddb5a1e2dc75b1d8db5c97417200c3996.jpg"
    }
}