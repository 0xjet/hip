{
    "id": "1488d8cb-38f3-46dc-a79a-5c1e4672957c",
    "created_at": "2023-01-12T15:04:58.552422Z",
    "updated_at": "2025-03-27T02:05:48.066043Z",
    "deleted_at": null,
    "sha1_hash": "fe21b3e1de8c1477f88cf17aacd9bbcb0252d83f",
    "title": "2017-01-06 - 2016 Updates to Shifu Banking Trojan",
    "authors": "",
    "file_creation_date": "2022-05-28T18:00:47Z",
    "file_modification_date": "2022-05-28T18:00:47Z",
    "file_size": 1421214,
    "plain_text": "# 2016 Updates to Shifu Banking Trojan\n\n**[researchcenter.paloaltonetworks.com/2017/01/unit42-2016-updates-shifu-banking-trojan/](http://researchcenter.paloaltonetworks.com/2017/01/unit42-2016-updates-shifu-banking-trojan/)**\n\nDominik Reichel January 6, 2017\n\nBy [Dominik Reichel](https://unit42.paloaltonetworks.com/author/dominik-reichel/)\n\nJanuary 6, 2017 at 12:00 PM\n\n[Category: Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [banking,](https://unit42.paloaltonetworks.com/tag/banking/) [Shifu,](https://unit42.paloaltonetworks.com/tag/shifu/) [threat research,](https://unit42.paloaltonetworks.com/tag/threat-research/) [Trojan](https://unit42.paloaltonetworks.com/tag/trojan/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/unit42-2016-updates-shifu-banking-trojan/)\n\n## Overview\n\nShifu is a Banking Trojan first discovered in 2015. Shifu is based on the Shiz source code which incorporated techniques used by Zeus.\nAttackers use Shifu to steal credentials for online banking websites around the world, starting in Russia but later including the UK, Italy, and\nothers.\n\nPalo Alto Networks Unit 42 research has found that the Shifu authors have evolved Shifu in 2016. Our research has found that Shifu has\nincorporated multiple new techniques to infect and evade detection on Microsoft Windows systems. Some of these include:\n\n[Exploitation of CVE-2016-0167 a Microsoft Windows Privilege Escalation vulnerability to gain SYSTEM level privileges. Earlier versions](https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-0167)\n[of Shifu exploited CVE-2015-0003 to achieve the same goal](https://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-0003)\nUse of a Windows atom to identify if the host is already infected with Shifu in addition to the mutex used by previous versions\nUse of “push-calc-ret” API obfuscation to hide function calls from malware analysts\nUse of alternative Namecoin .bit domains\n\nWe have also identified new links between Shifu and other tools which suggest Shifu isn’t simply based on the Shiz Trojan, but is probably the\nlatest evolution of Shiz.\n\nThe primary goal of this report is to introduce Shifu’s new features to other malware analysts who may encounter this Trojan in the future. The\nfollowing sections give an overview of the new features, and the appendix at the end includes the technical details on the overall functionality\nof Shifu.\n\n## New Developments and Features in Shifu\n\nThe Shifu version discussed in this analysis is comprised of several stages of payloads and was compiled in June 2016. The following image\nillustrates the different files included in the initial loader which get decrypted after execution:\n\n\n-----\n\n_Figure 1. File structure of Shifu_\n\nThe initial obfuscated loader (x86 exe) contains the encrypted second stage injector (x86 exe). It uses three layers for decryption by\nsubsequently allocating memory via VirtualAlloc() for the next layer. The second stage injector gets decrypted into memory and the original\nloader process is then overwritten with it. Next, the section flags are adjusted and the IAT addresses are resolved. The final decryption layer\nthen jumps to the entry point of the second stage injector.\n\n[The second stage injector contains two exploits for CVE-2016-0167 (x86/x64) that have a compilation time stamp dated February, 2016. At the](https://technet.microsoft.com/en-us/library/security/ms16-039.aspx)\ntime of compilation, patches were not yet available for this vulnerability. However, the malware’s compilation time stamp dates June 2016. This\nmay indicate the people behind this Shifu version had access to the zero-day exploit at that time or gained access to it afterwards. The exploit\nuses an interesting technique which makes it possible to just copy the raw disk file into memory. To make the file executable in memory, it uses\na custom PE loader shellcode appended to both versions of the exploit as an PE overlay. The shellcode takes care of all the adjustments\nneeded to get a proper executable memory image and executes the exploit. By doing so, the file just needs to be copied into a memory buffer\nand execution needs to be passed to the shellcode.\n\nWe have also found multiple other variants of the exploit, standalone versions (x86/64), but also versions which are embedded in an injector\nlike in Shifu. Additionally, we identified a version of Vawtrak which contains an earlier version of the exploit dating back to November 2015,\naccording to the compilation time stamp. The compilation time stamp of this Vawtrak sample itself dates January 2016 and thus is effectively\nthe first malware known to us to use this exploit.\n\nThe second stage injector contains several anti-analysis tricks similar to the previous version. It also contains two command line parameters\nwith functionality that indicate the malware is still in development. Further, the second stage injector uses an atom to check if the system is\nalready infected, instead of using a mutex like most of the malware today. The use of atoms is not a new technique, but still not very\nwidespread.\n\nThe main payload is encrypted and packed inside the .tls section of the second stage injector. It first gets decrypted and then unpacked with\nthe aPLib compression library. As persistence method, the main payload copies the initial loader to the AppData folder and creates a Jscript\nfile inside the Startup folder which points to it. The second stage injector injects the main payload inside a x86 instance of svchost and patches\nits API function calls with an obfuscation technique to make static and dynamic analysis of the malware more difficult.\n\n\n-----\n\nCo pa ed to t e p e ous e s o, t e a pay oad co ta s so e updates s c udes t e st gs to sea c o t e ct s syste, t e\nbrowser target list, and the bot commands. The main payload uses .bit top-level domains to contact its C&C server. The domain names, the\nuser-agent string and the URL parameters are encrypted with a modified RC4 encryption algorithm. The domain names indicate that the\nattackers may be either located in Ukraine or have a Ukrainian background.\n\nUnfortunately, at the time of the analysis the C&C server didn’t respond with any commands and thus further analysis of the targeted financial\ninstitutions wasn’t possible. This information would be normally downloaded into a configuration file on the victim’s disk. For some of its\nfunctionality, the main payload hooks some API functions inside the svchost.exe process into which it is injected. Further, it uses the Apache\nweb server for the web injections. If it was successfully downloaded from the C&C server, the malware makes use of a layered service provider\nto hook into the Winsock API for intercepting and modifying inbound and outbound Internet traffic. It also contains the normally used methods\nto hook into the browsers networking functions found in many other banking Trojans.\n\nBoth the second stage injector and the main payload contain a lot of strings which are never used. This indicates the author(s) were either in a\nrush to build the malware or the development was done in a sloppy way.\n\nInstead of the string “IntelPowerAgent6” seen in the last version, this sample contains the string “IntelPowerAgent32” which is never used. In\naddition to the atom created by the second stage injector to check if the system is already infected, the main payload also creates a mutex with\na name based on the same procedure to create the name for the atom (see Appendix). However, the mutex uses a hardcoded prefix named\n“DAN6J0-” before the byte sequence that is also used for the atom string: “{DAN6J0-ae000000d2000000e100}”\n\n_Figure 2. Shifu mutex and the associated svchost process_\n\n## Shifu, Shiz and Other Related Tools\n\nThe Shifu banking Trojan is mainly based on the Shiz/iBank source code, which is one of the oldest banking Trojans still in the wild today. Shiz\nwas first discovered in 2006 and has been through several stages of development since that time. It began as a banking Trojan which only\nfocused on Russian financial institutions. Later, it also began targeting an Italian bank which may have set the stage for a more international\nfocus. The internal versions we have tracked over the last five years ranged from generation 2 to 4 (2011) and 5 (2013/2014). The fifth\ngeneration of Shiz was the last one we saw in the wild in 2014 (last internal version was 5.6.25) and it differs from the 4th generation in the\ncoding style. It looks like it was developed by another coder, which could indicate the source code was sold or shared. The query string used to\ncontact the C&C server of one of the very first versions of the fifth generation supports our theory:\n\nbotid=%s&ver=5.0.1&up=%u&os=%03u&ltime=%s%d&token=%d&cn=reborn&av=%s\n\nWe can see that the campaign name (cn) contains the string “reborn”.\n\nShifu was first discovered in the wild in the middle of 2015 and we believe it's the evolution of the 5th generation of Shiz with a more\ninternational focus.\n\n\n-----\n\ne a e ot o y t ac ed t e S ba g oja o e t e ast coup e o yea s, but a so ou d se e a add t o a a a e too s a eged y o\nthe same author(s). Collected samples indicate the author(s) have developed a whole set of financially related malware. It’s not clear if the\nauthor works as part of a group or uses the malware themselves. These tools are mainly based on the source code of the fifth generation of\nShiz.\n\nWe have connected these tools together because they all contain a PDB path that has the same root folder:\n\nZ:\\coding\\...\n\nFurthermore, most of the tools are based on the Shiz source code, because the coding style and used API functions are very similar. Also,\ncomparing the code between the tools with BinDiff shows a high degree of similarity. Moreover, those tools with network functionality contain\nquery strings similar to the one in Shiz to contact their C&C server.\n\n[As our colleagues from FireEye described last year, the PDB path found in Shifu is as follows:](https://www.fireeye.com/blog/threat-research/2015/10/shifu-malware-analyzed-behavior-capabilities-and.html)\n\nZ:\\coding\\project\\main\\payload\\payload.x86.pdb\n\nOther tools we have identified have the following PDB paths and are likely from the same author(s):\n\nZ:\\coding\\cryptor\\Release\\crypted.pdb\n\nZ:\\coding\\malware\\tests\\Release\\cryptoshit.pdb\n\nZ:\\coding\\malware\\RDP\\output\\Release\\rdp_bot.pdb\n\nZ:\\coding\\malware\\ScanBot\\Release\\bot.pdb\n\n[The malware internally named \"cryptor\" contains an encrypted sample of BifitAgent, the first malware known to attack the financial software](https://securelist.com/blog/virus-watch/59901/lock-stock-and-two-smoking-trojans-2/2/)\nfrom BIFIT. While it's possible that BifitAgent is developed from the same person, we haven't found any indications for that. According to the\ncompilation time stamps, most of the samples were created in October/November 2013.\n\nThe malware with the name \"rdp_bot\" is a small bot which uses the RDP protocol to gain full access to a computer. It uses the same modified\nRC4 encryption algorithm as the Shifu version discussed in this article. This tool was probably used along the Shiz banking Trojan, because\nthe attacker is able to do his fraudulent activities directly from the victim’s computer. By doing so, one could fool bank antifraud systems which\n[check for the IP address, browser footprints or keyboard layouts. The tool is based on the research about RDP performed by Alisa Esage. The](http://de.slideshare.net/alisaesage/hacking-microsoft-remote-desktop-services-for-fun-and-profit)\nsamples date from June to November 2013.\n\nThe tool which is named \"cryptoshit\" contains an encrypted sample of rdp_bot and also uses the same modified RC4 algorithm as the Shifu\nversion described here. The samples date September/October 2013 and January 2014 according to the compilation time stamp.\n\nThe malware with the internal name \"ScanBot\" is a small backdoor which uses the Super Light Regular Expression library (SRLE) for scanning\na victim’s computer for files via commands from its operator. The samples date June 2013 according to the time stamp.\n\n## Protection Against Shifu\n\nPalo Alto Networks customers are protected from Shifu in the following ways:\n\nWildfire classifies Shifu files as malicious and signatures are loaded into Threat Prevention\n[AutoFocus customers can track malware using the Shifu tag](https://autofocus.paloaltonetworks.com/)\nCommand and Control domains used by Shifu are blocked through Threat Prevention\n\n**SHA256 Hashes of Samples Discussed**\n\n**Initial obfuscated loader**\n\nd3f9c4037f8b4d24f2baff1e0940d2bf238032f9343d06478b5034d0981b2cd9\n\n368b23e6d9ec7843e537e9d6547777088cf36581076599d04846287a9162652b\n\ne7e154c65417f5594a8b4602db601ac39156b5758889f708dac7258e415d4a18\n\nf63ec1e5752eb8b9a07104f42392eebf143617708bfdd0fe31cbf00ef12383f9\n\n**Second stage injector**\n\n003965bd25acb7e8c6e16de4f387ff9518db7bcca845502d23b6505d8d3cec01\n\n1188c5c9f04658bef20162f3001d9b89f69c93bf5343a1f849974daf6284a650\n\n**Exploit injector**\n\ne7c1523d93154462ed9e15e84d3af01abe827aa6dd0082bc90fc8b58989e9a9a\n\n**CVE-2016-0167 exploit (x86)**\n\n\n-----\n\n5 ec acb c83 6d e 0d c5 5daac6c9 b6e 6 ed c c5 c88636bad\n\n**CVE-2016-0167 exploit (x64)**\n\nf3c2d4090f6f563928e9a9ec86bf0f1c6ee49cdc110b7368db8905781a9a966e\n\n**Main payload**\n\ne9bd4375f9b0b95f385191895edf81c8eadfb3964204bbbe48f7700fc746e4dc\n5ca2a9de65c998b0d0a0a01b4aa103a9410d76ab86c75d7b968984be53e279b6\n\n## Appendix - Technical details\n\n**Second Stage Injector Analysis**\n\nThe second stage injector contains an exploit injector (x86 DLL) which in turn has two embedded exploits (x86/64 DLL) for CVE-2016-0167.\nThe second stage injector also contains the encrypted and aPLib packed main payload module (x86 DLL) in its .tls section. For decryption, it\nuses a modified version of the RC4 encryption algorithm with a salt that is stored in the .rsrc section. Significant strings in the second stage\ninjector's .data section were XORed with the key 0x8D and get decrypted on-the-fly. Decrypted strings:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n\n\nAddMandatoryAce\nADVAPI\nAdvapi32.dlladvapi32.dllws2_32.dll\nWPUCloseEvent\nWPUCloseSocketHandleWPUCreateEvent\nWPUCreateSocketHandle\nWPUFDIsSet\nWPUGetProviderPath\nWPUModifyIFSHandle\nWPUPostMessage\nWPUQueryBlockingCallbackWPUQuerySocketHandleContext\nWPUQueueApc\nWPUResetEvent\nWPUSetEvent\nWPUOpenCurrentThreadWPUCloseThread\nWSPStartup\n\n- %1\\r\\ndel %0\nsoftware\\\\microsoft\\\\windows\\\\currentversion\\\\run\nABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/echo\nrundll32.exe shell32.dll, ShellExec_RunDLL %s\nMicrosoft\\\\Microsoft AntimalwareSoftware\\\\Coranti\nSoftware\\\\risingSoftware\\\\TrendMicroSoftware\\\\Symantec\nSoftware\\\\ComodoGroup\nSoftware\\\\Network Associates\\\\TVD\nSoftware\\\\Data Fellows\\\\F-SecureSoftware\\\\Eset\\\\Nod\nSoftware\\\\Softed\\\\ViGUARD\nSoftware\\\\Zone Labs\\\\ZoneAlarm\nSoftware\\\\Avg\nSoftware\\\\VBA32\nSoftware\\\\Doctor WebSoftware\\\\G DataSoftware\\\\Avira\nSoftware\\\\AVAST Software\\\\Avast\nSoftware\\\\KasperskyLab\\\\protected\nSoftware\\\\Bitdefender\nSoftware\\\\Panda SoftwareSoftware\\\\Sophos.bat\\\\\\\\.\\\\%C:\n|$$$}rstuvwxyz{$$$$$$$>?@ABCDEFGHIJKLMNOPQRSTUVW$$$$$$XYZ[\\\\]^_`abcdefghijklmnopq\nconhost\nCreateProcessInternalW\nConvertStringSecurityDescriptorToSecurityDescriptorWContent-Type: multipart/form-data; boundary=---------------------------%s\\r\\n\nContent-Type: application/x-www-form-urlencoded\\r\\n\nHost: %s\\r\\n%d.%d.%d.%d\n%d.%d.%d.%d.%x\n%temp%\\\\debug_file.txt\n\n[%u][%s:%s:%u][0x%x;0x%x] %sDnsFlushResolverCache\n\\\\*.*\ndnsapi.dll\nDnsGetCacheDataTable.dll.exedownload.windowsupdate.com\nvk.com\nyandex.ru\nHTTP/1.1https://http://%s\nIsWow64Process\nkernel\nkernel32.dllLdrGetProcedureAddress\nMicrosoft\nNtAllocateVirtualMemory\nCLOSED\nLAST ACKTIME WAIT\n\n\n-----\n\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n72\n73\n74\n75\n76\n77\n78\n79\n80\n81\n82\n83\n84\n85\n86\n87\n88\n89\n90\n91\n92\n93\n94\n95\n96\n97\n98\n99\n100\n101\n102\n103\n104\n105\n106\n107\n108\n109\n110\n111\n112\n113\n114\n115\n116\n117\n118\n119\n120\n121\n122\n123\n124\n125\n126\n127\n128\n129\n130\n131\n132\n133\n134\n\n\n_\nLISTEN\nSYN_SENTSYN_RCVDESTAB\nFIN_WAIT1\nFIN_WAIT2\nCLOSE_WAIT\nCLOSING\nTCP\\t%s:%d\\t%s:%d\\t%s\\n\nnetstat\\nProto\\tLocal address\\tRemote address\\tState\\n\nntdll.dll\nNtResumeProcess\nNtSuspendProcess\\\\\\\\?\\\\globalroot\\\\systemroot\\\\system32\\\\drivers\\\\null.sys\nNtWriteVirtualMemoryopenRegisterApplicationRestart\nRtlCreateUserThread\nResetSR\nRtlComputeCrc32\nrundll32SeDebugPrivilegeSystemDrive\n\\\\StringFileInfo\\\\%04x%04x\\\\ProductName\nsoftware\\\\microsoft\\\\windows nt\\\\currentversion\\\\winlogon\nshell\nSleep\nsrclient.dllSeShutdownPrivilege\n\\\"%s\\\"\n%d\\t%s\\ntaskmgr\\nPID\\tProcess name\\nnet user\\n\nthe computer is joined to a domain\\n..\n\\\\VarFileInfo\\\\Translation\n%windir%\\\\system32\\\\%windir%\\\\syswow64\\\\POST*.exe\n%SystemDrive%\\\\\n*SYSTEM*%02x%s:Zone.Identifier\nGetProcessUserModeExceptionPolicy\nSetProcessUserModeExceptionPolicy\n%ws\\\\%ws\\n\nWORKGROUP\nHOMESoftware\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\ExplorerDisableCurrentUserRun\n%s.dat\nsoftware\\\\microsoft\\\\windows%OS%_%NUMBER_OF_PROCESSORS%\nS:(ML;;NRNWNX;;;LW)D:(A;;GA;;;WD)\nS:(ML;;NRNWNX;;;LW)D:(A;;GA;;;WD)(A;;GA;;;AC)\n\\\\\\\\.\\\\AVGIDSShim\nFFD3\\\\\\\\.\\\\NPF_NdisWanIpc:\\\\sample\\\\pos.exe\nANALYSERS\nSANDBOX\nVIRUS\nMALWARE\nFORTINETMALNETVMc:\\\\analysis\\\\sandboxstarter.exec:\\\\analysisc:\\\\insidetmc:\\\\windows\\\\system32\\\\drivers\\\\vmmouse.sys\nc:\\\\windows\\\\system32\\\\drivers\\\\vmhgfs.sys\nc:\\\\windows\\\\system32\\\\drivers\\\\vboxmouse.sys\nc:\\\\iDEFENSEc:\\\\popupkiller.exe\nc:\\\\tools\\\\execute.exe\nc:\\\\Perlc:\\\\Python27api_log.dll\ndir_watch.dll\npstorec.dll\ndbghelp.dll\nProcess32NextW\nSoftware\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Internet Settings\\\\Zones\\\\3\n1406.bitMiniDumpWriteDump\n\\r\\nReferer: %s\\r\\n\n\\\\Google\\\\Chrome\\\\User Data\\\\Default\\\\Cache\nvar %s = new ActiveXObject(\"WScript.Shell\"); %s.Run(\"%s\");\nIntelPowerAgent32\n%OS%_%NUMBER_OF_PROCESSORS%\n%s\\cmd.exe\nComSpec\nConsoleWindowClass\n.exekernel32.dllntdll.dll\nZwQuerySystemInformationZwAllocateVirtualMemory\nPsLookupProcessByProcessId\nPsReferencePrimaryToken\nClass\nWindow\nopen \"%s\" -q%windir%\\\\system32\\\\sdbinst.exe\n/c \"start \"\" \"%s\" -d\"\n%windir%\\\\system32\\\\sndvol.exe\n\"%s\" -u /c \"%s\\\\SysWOW64\\\\SysSndVol.exe /c \"start \"\" \"%s\" -d\"\"\n%temp%\\\\%u\n%u.tmp\nWow64DisableWow64FsRedirection\nWow64RevertWow64FsRedirection\n\n\n-----\n\n136\n137\n138\n139\n140\n141\n142\n143\n144\n145\n\n\n%systemroot%\\\\system32\\\\svchost.exe\n%systemroot%\\\\system32\\\\wscript.exe\nsnxhk.dll\nsbiedll.dll\n/c start \"\" \"%s\" \" \"\ncmd.exe\nrunas\n--crypt-test\nIt work's!\n--vm-test\n\n\n**Exploit Injector with Embedded CVE-2016-0167 Exploits**\n\nThe exploit injector is used to gain SYSTEM privileges on the infected host. The injector contains the actual exploits for both x86 and x64\nsystems. The magic PE bytes (\"MZ\") at the beginning of the files are patched will null bytes to prevent them from automatic extraction.\n\nThe second stage injector checks for the current process' integrity level and the OS version. If the integrity level of the process is low and the\nOS version is 6.1 (Windows 7 / Windows Server 2008 R2), the second stage injector writes the exploit injector file into memory. Then, it\nsearches for the magic value 0x99999999 in the exploit injector which marks the beginning of the PE overlay. When the address was found, 12\nbytes are added and the second stage injector jumps to this address which is in fact a custom PE loader shellcode. The call to the shellcode\nlooks as follows:\n\n\n1\n2\n3\n4\n\n\n00401EF5  pusha\n00401EF6  add esi, 0Ch\n00401EF9  call esi  -> PE loader shellcode in overlay\n00401EFB  popa\n\n\n**Custom PE loader shellcode**\n\nIt first gets the end of the shellcode which is then used to scan the exploit injector file for the magic PE number (\"MZ\"). The code to get end of\nthe shellcode looks as follows:\n\n\n1\n2\n3\n4\n\n\n00077174  jmp short 00077178\n00077176  pop eax\n00077177  retn\n00077178  call 00077176\n\n\nNext, a custom GetProcAddress() function is used together with a hashing function to find the address of VirtualAllocEx(). Then,\nVirtualAllocEx() is called to allocate a memory buffer of with full access rights into which the exploit injectors sections are written with the\nappropriate memory alignments. The necessary memory addresses are then adjusted with help of the relocation information, the API function\naddresses are resolved and the IAT is filled. Finally, the shellcode jumps to the DLL entry point of the freshly created exploit injector module.\n\n**Exploit injector**\n\nAt first, the strings \"kernel32.dll\", \"LoadLibrary\" and \"GetProcAddress\" are created. Next, the image base address for kernel32.dll is searched\nand the addresses of LoadLibrary() and GetProcAddress() are obtained. With help of these API functions, the IAT addresses of the exploit\ninjector get resolved and the IAT is filled. The purpose of this function is unclear, as it was already done by the second stage injector.\nThereafter, a new thread gets created with API function CreateThread().\n\nThe thread first calls IsWow64Process() and according to the result either the embedded x86 or x64 version of the exploit file is written into a\nmemory buffer. Next, the PE magic value (\"MZ\") is written to the beginning of the exploit file. Then, an event named \"WaitEventX\" is created\nwhich is later used by the exploit. Then, the main exploit loading function is called.\n\nThe exploit loading function searches for the following process names and if found also the module names for the following strings which are\npart of Trend Micro security software:\n\n\"uiSeAgnt.exe\"\n\"PtSessionAgent.exe\"\n\"PwmSvc.exe\"\n\"coreServiceShell.exe\"\n\nIf one of the processes is found, a suspended process of wuauclt.exe is created. Otherwise, a suspended process of svchost.exe is created. In\nboth cases, the command line argument \"-k netsvcs\" is passed, but can be only used by svchost.exe. It should be noted that this functionality\nalways fails if the x64 version of Trend Micro Internet Security is installed. The code (x86) calls CreateToolhelp32Snapshot() on a x64 process\nwhich results in an error (ERROR_PARTIAL_COPY). Moreover, it also fails because the code tries to access a protected Trend Micro process\n(ERROR_ACCESS_DENIED).\n\n\n-----\n\ne t, t aps t e 86 o 6 e o t e e p o t to e o y t C eate e app g() a d ap e O e() a d s t e e o y t t e\nexploit bytes. Finally, the section gets mapped into the suspended process of svchost.exe or wuauclt.exe by using ZwMapViewOfSection(). It\nthen checks the OS version if it is 5.2 (Windows Server 2003 / Windows XP 64-Bit Edition) and exits the function if so. Afterwards, two memory\nbuffers are created and a shellcode is written to each of them. The first obfuscated shellcode calls the second shellcode, which is a stager for\nthe mapped exploit file. Next, it calls ResumeThread() to execute the suspended process so the exploit is executed.\n\nThe second stage injector verifies that the exploit was successful by checking if the integrity level of itself is still\nSECURITY_MANDATORY_LOW_RID. If not, the exploit successfully elevated privileges to SECURITY_MANDATORY_SYSTEM_RID and\ncontinues with the injection of the main payload. If the exploit failed, it tries to execute itself under the SYSTEM user account with help of the\nWindows command line (cmd.exe) and runas.exe tool.\n\n**Atom String Building**\n\nInstead of using a mutex like most of today’s malware, the second stage injector creates an atom and checks the global atom table to see if an\ninstance of Shifu is already running.\n\nAt first, it uses the template string \"%OS%_%NUMBER_OF_PROCESSORS%\" for the API ExpandEnvironmentStrings() to get the Windows\nversion and number of processors. For example, in Windows 7 with one processor the result would be \"Windows_NT_1\". This string is then\nused to calculate four CRC32 hashes with RtlComputeCrc32() and the following initial values:\n\n0xFFFFFFFF\n0xEEEEEEEE\n0xAAAAAAAA\n0x77777777\n\nThe resulting CRC hashes of the string \"Windows_NT_1\" are as follows:\n\n0x395693AE\n0xB24495D2\n0xF39F86E1\n0xBAE0B5C8\n\nNext, the last byte of each CRC hash is stored as a DWORD value on the stack:\n\n0xAE000000 (from 0x395693AE)\n0xD2000000 (from 0xB24495D2)\n0xE1000000 (from 0xF39F86E1)\n0xC8000000 (from 0xBAE0B5C8)\n\nThe stack with the hash byte sequence looks as follows:\n\nAE 00 00 00 D2 00 00 00 E1 00 00 00 C8 00 00 00\n\nThe atom string is then created by converting first 8 bytes of the hash byte sequence to ASCII characters with snprintf() function. The result in\nthis case would be:\n\n\"ae000000d2000000\"\n\nAt last, it calls GlobalFindAtom() API to check if the atom is present and calls GlobalAddAtom() if not.\n\n\n-----\n\n_Figure 3. Shifu atom in the global atom table_\n\n**Command Line Arguments**\n\nThe second stage injector has two command line parameters of which only one has a functionality. They may be used for an upcoming feature\nor were just forgotten to be removed.\n\n--crypt-test\n\nShows just a message box with the text \"It work's!\"\n\n--vm-test\n\nNo functionality\n\n**Anti-Analysis Tricks**\n\n**Anti Sandboxie / Avast**\n\nShifu checks if the module snxhk.dll (Avast) or sbiedll.dll (Sandboxie) is present in its own process space by calling GetModuleHandleA() and\nruns an infinite Sleep() loop if a handle is returned.\n\nAll the following anti analysis tricks are only used if Shifu is executed on a 32-bit Windows machine (no Wow64 process).\n\n**Process name detection**\n\nIt enumerates running process names, converts them to lowercase, calculates the CRC32 hashes of those names and compares to the\nfollowing list:\n\n0x99DD4432 - ?\n0x1F413C1F - vmwaretray.exe\n0x6D3323D9 - vmusrvc.exe\n0x3BFFF885 - vmsrvc.exe\n0x64340DCE - ?\n0x63C54474 - vboxtray.exe\n0x2B05B17D - ?\n0xF725433E - ?\n0x77AE10F7 - ?\n0xCE7D304E - dumpcap.exe\n0xAF2015F2 - ollydbg.exe\n0x31FD677C - importrec.exe\n0x6E9AD238 - petools.exe\n0xE90ACC42 - idag.exe\n0x4231F0AD - sysanalyzer.exe\n0xD20981E0 - sniff_hit.exe\n0xCCEA165E - scktool.exe\n0xFCA978AC - proc analyzer.exe\n\n\n-----\n\n0 6 3 oo e p o e e e\n0xEEBF618A - multi_pot.exe\n0x06AAAE60 - idaq.exe\n0x5BA9B1FE - procmon.exe\n0x3CE2BEF3 - regmon.exe\n0xA945E459 - procexp.exe\n0x877A154B - peid.exe\n0x33495995 - autoruns.exe\n0x68684B33 - autorunsc.exe\n0xB4364A7A - ?\n0x9305F80D - imul.exe\n0xC4AAED42 - emul.exe\n0x14078D5B - apispy.exe\n0x7E3DF4F6 - ?\n0xD3B48D5B - hookanaapp.exe\n0x332FD095 - fortitracer.exe\n0x2D6A6921 - ?\n0x2AAA273B - joeboxserver.exe\n0x777BE06C - joeboxcontrol.exe\n0x954B35E8 - ?\n0x870E13A2 - ?\n\n**File detection**\n\nShifu checks if the following files or folders exist on the system and runs an infinite Sleep() loop if so:\n\nc:\\sample\\pos.exe\nc:\\analysis\\sandboxstarter.exe\nc:\\analysis\nc:\\insidetm\nc:\\windows\\system32\\drivers\\vmmouse.sys\nc:\\windows\\system32\\drivers\\vmhgfs.sys\nc:\\windows\\system32\\drivers\\vboxmouse.sys\nc:\\iDEFENSE\nc:\\popupkiller.exe\nc:\\tools\\execute.exe\nc:\\Perl\nc:\\Python27\n\n**Debugger detection**\n\nIt checks if it’s being debugged by calling IsDebuggerPresent(). Also, it calls ZwQueryInformationSystem() with ProcessDebugPort and\nProcessDebugObjectHandle to check for a debugger presence. If a debugger is detected it runs an infinite Sleep() loop.\n\n**Wireshark detection**\n\nShifu attempts to open \\\\.\\NPF_NdisWanIp with CreateFile() and will enter an infinite Sleep() loop if it is successful.\n\n**Self-sanity checks**\n\nIt checks its own file name length if it is longer than 30 characters and runs an infinite Sleep() loop if so. Also, it checks if its own process name\nCRC32 hash matches one of the following:\n\n0xE84126B8 - sample.exe\n0x0A84E285 - ?\n0x3C164BED - ?\n0xC19DADCE - ?\n0xA07ACEDD - ?\n0xD254F323 - ?\n0xF3C4E556 - ?\n0xF8782263 - ?\n0xCA96016D - ?\n\nFurthermore, it checks if one of the following modules from GFI Sandbox is present in its own process address space:\n\napi_log.dll\ndir_watch.dll\n\n\n-----\n\npsto ec d\n\n**Unknown anti-analysis trick**\n\nShifu uses an anti-analysis trick whose purpose is unknown to us. It retrieves the address of Process32NextW() and compares the first 5 bytes\nwith the sequence 0x33C0C20800 which disassembles to:\n\n\n1\n2\n\n\n33C0 XOR EAX,EAX\nC2 0800  RETN 8\n\n\nThis code is only present in 32-bit Windows XP and not in later Windows versions, because the Unicode version of that function probably\nwasn't implemented yet. If the code sequence is found meaning that Shifu was executed on 32-bit Windows XP, it runs an infinite Sleep() loop.\n\n**Windows domain name check**\n\nIt checks if the computer workgroup name is either \"WORKGROUP\" or \"HOME\" with API functions NetServerGetInfo() and NetWkstaGetInfo()\nand runs an infinite Sleep() loop otherwise. Next, it checks for the name \"ANALYSERS\" and runs the infinite loop if found.\n\n**Computer and user name check**\n\nShifu gets the computer and user name with GetComputerName() and GetUserName() to check for the following strings:\n\nSANDBOX\nFORTINET\nVIRUS\nMALWARE\nMALNETVM\n\nIf one is found it runs an infinite loop.\n\n**Process termination feature**\n\nSecond stage injector of Shifu enumerates all running processes, converts every name to lower case, calculates the CRC32 hash of it and\ncompares it to the following ones:\n\n0xD2EFC6C4 - python.exe\n0xE185BD8C - pythonw.exe\n0xDE1BACD2 - perl.exe\n0xF2EAA55E - autoit3.exe\n0xB8BED542 - ?\n\nIf one matches, it first tries to terminate the process with OpenProcess() and TerminateProcess(). If that fails, it tries to close the main window\nhandle of the process if it is flagged as HANDLE_FLAG_PROTECT_FROM_CLOSE with ZwClose(). Then, it opens the process with full\naccess rights and unmaps it from memory with ZwUnmapViewOfSection(). At last, the main window handle of the unmapped process is\nclosed.\n\n**Main Payload Decryption, Unpacking and Injection**\n\nTo decrypt the main payload, the second stage injector retrieves a salt needed for the decryption algorithm from its .rsrc section. It uses a\nmodified RC4 algorithm where the salt is used to XOR the array of 256 bytes byte after byte at the beginning. The encrypted array is then used\nto decrypt the main payload located in the .tls section. The decrypted main payload is additionally packed with the aPLib compression library.\n\nIf the initial loader runs as a medium or high integrity level process, the routine which calculates the atom string name is called again. This\ntime, only the first 4 bytes are used to build a string, for example \"ae000000\". Next, the CRC32 hash of this string is calculated and used to\nXOR another array of 256 bytes starting from 0x0 to 0xFF. This encrypted array is then used to again encrypt the decrypted main payload. The\nresulting encrypted data are written to registry for persistence purposes under the key \"HKCU\\software\\microsoft\\windows\" with a random\nCRC32 hash name, for example \"f4e64d63\". Also, a second value with the string \"ae000000\" as name is created and filled up with null bytes\nand the path of the initial loader, for example \"C:\\ProgramData\\7d5d6044.exe\". At last, the temporarily encrypted main payload gets decrypted\nagain.\n\n\n-----\n\n_Figure 4. Encrypted main payload and initial loader path stored in the Windows registry_\n\nNext, the main payload gets unpacked into memory. Thereafter, a suspended svchost.exe process (x86) is created with the same integrity\nlevel as the parent process. The main payload gets mapped into the process and the magic PE value (MZ) patched. The svchost process gets\nthen resumed so the main payload is executed. At last, a batch file is created and executed in the %TEMP% folder. It overwrites the original\nexecuted initial loader with a random number of bytes to cover the tracks. The random bytes are always followed by a space character and the\nCR LF control characters.\n\n## Main Payload Analysis\n\nThe main payload module's IAT function names were XORed with the key 0xFF to make static analysis more difficult. Significant strings in the\n.data section are also XORed with the key 0x8D and get decrypted on-the-fly. Decrypted strings:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nAddMandatoryAce\nADVAPI\nAdvapi32.dlladvapi32.dllws2_32.dll\nWPUCloseEvent\nWPUCloseSocketHandleWPUCreateEvent\nWPUCreateSocketHandle\nWPUFDIsSet\nWPUGetProviderPath\nWPUModifyIFSHandle\nWPUPostMessage\nWPUQueryBlockingCallbackWPUQuerySocketHandleContext\nWPUQueueApc\nWPUResetEvent\nWPUSetEvent\nWPUOpenCurrentThreadWPUCloseThread\nWSPStartup\nABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/echo\n\n- %1\\r\\ndel %0\nrundll32.exe shell32.dll, ShellExec_RunDLL %s\nsoftware\\\\microsoft\\\\windows\\\\currentversion\\\\run\nMicrosoft\\\\Microsoft AntimalwareSoftware\\\\Coranti\nSoftware\\\\risingSoftware\\\\TrendMicroSoftware\\\\Symantec\nSoftware\\\\ComodoGroup\nSoftware\\\\Network Associates\\\\TVD\nSoftware\\\\Data Fellows\\\\F-SecureSoftware\\\\Eset\\\\Nod\nSoftware\\\\Softed\\\\ViGUARD\nSoftware\\\\Zone Labs\\\\ZoneAlarm\nSoftware\\\\Avg\nSoftware\\\\VBA32\nSoftware\\\\Doctor WebSoftware\\\\G DataSoftware\\\\Avira\nSoftware\\\\AVAST Software\\\\Avast\nSoftware\\\\KasperskyLab\\\\protected\nSoftware\\\\Bitdefender\nSoftware\\\\Panda SoftwareSoftware\\\\Sophos.bat|$$$}rstuvwxyz{$$$$$$$>?\n@ABCDEFGHIJKLMNOPQRSTUVW$$$$$$XYZ[\\\\]^_`abcdefghijklmnop\nq\n\n\n-----\n\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n72\n73\n74\n75\n76\n77\n78\n79\n80\n81\n82\n83\n84\n85\n86\n87\n88\n89\n90\n91\n92\n93\n94\n95\n96\n97\n98\n99\n100\n101\n102\n103\n104\n105\n106\n107\n108\n109\n110\n111\n112\n113\n114\n\n\nconhost\nCreateProcessInternalW\nConvertStringSecurityDescriptorToSecurityDescriptorWContent-Type: application/x-www-form-urlencoded\\r\\n\nContent-Type: multipart/form-data; boundary=---------------------------%s\\r\\n\nHost: %s\\r\\n%d.%d.%d.%d\n%d.%d.%d.%d.%x\n%temp%\\\\debug_file.txt\n\n[%u][%s:%s:%u][0x%x;0x%x] %sDnsFlushResolverCache\n\\\\*.*\ndnsapi.dll\nDnsGetCacheDataTable.dll.exedownload.windowsupdate.com\nvk.com\nyandex.ru\nHTTP/1.1https://http://%s\nIsWow64Process\nkernel\nkernel32.dllLdrGetProcedureAddress\nMicrosoft\nNtAllocateVirtualMemory\nCLOSED\nLAST_ACKTIME_WAIT\nDELETE_TCB\nLISTEN\nSYN_SENTSYN_RCVDESTAB\nFIN_WAIT1\nFIN_WAIT2\nCLOSE_WAIT\nCLOSING\nTCP\\t%s:%d\\t%s:%d\\t%s\\n\nnetstat\\nProto\\tLocal address\\tRemote address\\tState\\n\nntdll.dll\nNtResumeProcess\nNtSuspendProcess\\\\\\\\?\\\\globalroot\\\\systemroot\\\\system32\\\\drivers\\\\null.sys\nNtWriteVirtualMemoryopenRegisterApplicationRestart\nRtlCreateUserThread\nResetSR\nRtlComputeCrc32\nrundll32SeDebugPrivilegeSystemDrive\n\\\\StringFileInfo\\\\%04x%04x\\\\ProductName\nsoftware\\\\microsoft\\\\windows nt\\\\currentversion\\\\winlogon\nshell\nSleep\nsrclient.dllSeShutdownPrivilege\n\\\"%s\\\"\n%d\\t%s\\ntaskmgr\\nPID\\tProcess name\\nnet user\\n\nthe computer is joined to a domain\\n..\n\\\\VarFileInfo\\\\Translation\n%windir%\\\\system32\\\\%windir%\\\\syswow64\\\\POST*.exe\n%SystemDrive%\\\\\n*SYSTEM*%02x%s:Zone.Identifier\nGetProcessUserModeExceptionPolicy\nSetProcessUserModeExceptionPolicy\n%ws\\\\%ws\\n\nWORKGROUP\nHOMEsoftware\\\\microsoft\\\\windowsSoftware\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\ExplorerDisableCurrentUserRun\n%s.dat\n%OS%_%NUMBER_OF_PROCESSORS%\nS:(ML;;NRNWNX;;;LW)D:(A;;GA;;;WD)\nS:(ML;;NRNWNX;;;LW)D:(A;;GA;;;WD)(A;;GA;;;AC)\n\\\\\\\\.\\\\AVGIDSShim\nFFD3\\\\\\\\.\\\\NPF_NdisWanIpc:\\\\sample\\\\pos.exe\nANALYSERS\nSANDBOX\nVIRUS\nMALWARE\nFORTINETMALNETVMc:\\\\analysis\\\\sandboxstarter.exec:\\\\analysisc:\\\\insidetmc:\\\\windows\\\\system32\\\\drivers\\\\vmmouse.sys\nc:\\\\windows\\\\system32\\\\drivers\\\\vmhgfs.sys\nc:\\\\windows\\\\system32\\\\drivers\\\\vboxmouse.sys\nc:\\\\iDEFENSEc:\\\\popupkiller.exe\nc:\\\\tools\\\\execute.exe\nc:\\\\Perlc:\\\\Python27api_log.dll\ndir_watch.dll\npstorec.dll\ndbghelp.dll\nProcess32NextW\n1406Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Internet Settings\\\\Zones\\\\3\n.bitMiniDumpWriteDump\n\n\n-----\n\n116\n117\n118\n119\n120\n121\n122\n123\n124\n125\n126\n127\n128\n129\n130\n131\n132\n133\n134\n135\n136\n137\n138\n139\n140\n141\n142\n143\n144\n145\n146\n147\n148\n149\n150\n151\n152\n153\n154\n155\n156\n157\n158\n159\n160\n161\n162\n163\n164\n165\n166\n167\n168\n169\n170\n171\n172\n173\n174\n175\n176\n177\n178\n179\n180\n181\n182\n183\n184\n185\n186\n187\n188\n189\n190\n191\n192\n\n\n\\\\Google\\\\Chrome\\\\User Data\\\\Default\\\\Cache\nvar %s = new ActiveXObject(\"WScript.Shell\"); %s.Run(\"%s\");\nGenuineIntelAuthenticAMDCentaurHauls7z\nfnbqooqdaixfueangywblgabirdgvkewdyqgfqaioluesyrpryfkjerfsouemaxnavrkguxmcmhckwprunurmhehclermtufwiyjbqhwlunbun\nuumeowfjmerxppxrgaxukyx\nPowerManager_M5VKII_%d\n\n[type=ftp]\\n[botid=%s]\\n[proc=%s]\\n[data=%s]\\n\n\n[type=pop3]\\n[botid=%s]\\n[proc=%s]\\n[data=%s]\\n\n%OS%_%NUMBER_OF_PROCESSORS%\n\n[type=post]\\n[botid=%s]\\n[url=%s]\\n[ua=%s]\\n[proc=%s]\\n[ref=%s]\\n[keys=%s]\\n[data=%s]\\n\nname=%s&ok=%s&id=%d&res_code=%d&res_text=%s_%x\nname=%s&ok=%s&id=%d&res_code=%d&res_text=%s\nbotid=%s&ver=%s.%u&up=%u&os=%u&ltime=%s%d&token=%d&cn=%s&av=%s&dmn=%s&mitm=%u\njava.exe|javaw.exe|plugin-container.exe|acrobat.exe|acrod32.exe\ntellerplus|bancline|fidelity|micrsolv|bankman|vanity|episys|jack\nhenry|cruisenet|gplusmain|silverlake|v48d0250s1Root|TrustedPeople|SMS|Remote Desktop|REQUEST\nTREASURE|BUH|BANK|ACCOUNT|CASH|FINAN|MONEY|MANAGE|OPER|DIRECT|ROSPIL|CAPO|BOSS|TRADEactive_bc\n-----------------------------%s\\r\\nContent-Disposition: form-data; name=\\\"pcname\\\"\\r\\n\\r\\n%s!%s\\r\\n----------------------------%s\\r\\nContent-Disposition: form-data; name=\\\"file\\\"; filename=\\\"report\\\"\\r\\nContent-Type: text/plain\\r\\n\\r\\n%s\\r\\n----------------------------%s--\\r\\n\n%domain%deactivebc\ninject\nkill_os\nloadactive_sk\ndeactive_sk\nwipe_cookiesmitm_modmitm_script\nmitm_geterr\nget_keylog\nget_sols!active_bc\\[(\\d+)\\] (\\S+) (\\d+)\n!deactive_bc\\[(\\d+)\\]\n!inject\\[(\\d+)\\] (\\S+)\n!kill_os\\[(\\d+)\\]\n!get_keylog\\[(\\d+)\\]!load\\[(\\d+)\\] (\\S+)!update\\[(\\d+)\\] (\\S+)\n!wipe_cookies\\[(\\d+)\\]\n!active_sk\\[(\\d+)\\] (\\S+) (\\d+)\n!deactive_sk\\[(\\d+)\\]\n!mitm_mod\\[(\\d+)\\] (\\S+) (\\d+) (\\S+)!mitm_script\\[(\\d+)\\] (\\S+)\n!mitm_geterr\\[(\\d+)\\]\n!get_sols\\[(\\d+)\\]\nATCASH\nATLOCAL\nCERTCERTX\nCOLVCRAIF\nCRYPT\nCTERM\nSCREEN\nINTER\nELBALOCAL\nELBAWEB\nELBAWEB\nELBAWEB\nPUTTY\nVNCVIEW\nMCLOCAL\nMCSIGN\nOPENVPN\nPIPEK\nPIPEK\nPIPEK\nPIPEK\nPOSTSAP\nchrome.dll\nmxwebkit.dlldragon_s.dlliron.dllvivaldi.dll\nnspr4.dll\nnss3.dllbrowser.dll\nAdvapi32.dllrsaenh.dll\nkernel32.dllIprivLibEx.dll\ncryptui.dll\ncrypt32.dll\nntdll.dll\nssleay32.dllurlmon.dll\nuser32.dll\nWininet.dll\nWs2_32.dll\nPSAPI.dll\nNzBrco.dll\nVirtualProtect\n\n\n-----\n\n194\n195\n196\n197\n198\n199\n200\n201\n202\n203\n204\n205\n206\n207\n208\n209\n210\n211\n212\n213\n214\n215\n216\n217\n218\n219\n220\n221\n222\n223\n224\n225\n226\n227\n228\n229\n230\n231\n232\n233\n234\n235\n236\n237\n238\n239\n240\n241\n242\n243\n244\n245\n246\n247\n248\n249\n250\n251\n252\n253\n254\n255\n256\n257\n258\n259\n260\n261\n262\n263\n264\n265\n266\n267\n268\n269\n270\n\n\ny\nZwQuerySystemInformationWSARecv\nWSASend\nZwDeviceIoControlFile\nURLDownloadToCacheFileW\nURLDownloadToFileW\nTranslateMessageSSL_get_fd\nSSL_write\nPFXImportCertStore\nCryptEncryptCPExportKey\nCreateProcessInternalW\nCreateDialogParamW\nGetClipboardDatagetaddrinfo\ngethostbyname\nGetAddrInfoExW\nGetMessageA\nGetMessageW\nDeleteFileA\nGetModuleBaseNameW\nbad port value\ncan't find plug-in path\ncan't get bot path\ncan't download file\ncan't encrypt file\ncan't save inject config to filecan't get temp file\nfile is not valid PEcan't delete original file\ncan't replace original file\ncan't close handle\ncan't protect file\noriginal file not found\ncan't execute file\ncan't create directory\ncan't unzip file #1\ncan't unzip file #2\nmitm_mod is inactivehttpd.exe is anactive\nmicrosoft.com\ndropbox.com\nKEYGRAB\nPasswordTELEMACOScelta e Login dispositivo\nTLQ Web\ndb Corporate Banking WebSecureStoreCSP - enter PIN\ngoogle.com\nSoftware\\\\SimonTatham\\\\PuTTYreg.txt\nSoftware\\\\Microsoft\\\\Internet Explorer\\\\MainTabProcGrowth\nTemp\\\\Low\ncrc32[%x]\nACCT\nAUTHINFO PASS\nAUTHINFO USER\nAuthorization\n:BA:[bks]\n%X!%X!%08X\nbtc_path.txtbtc_wallet.dat\nbitcoin\\\\wallet.dat\n%s%s\\\\%u_cert.pfx\ncmdline.txt\n1.3.6.1.5.5.7.3.3\nCodeSign\\n\nSoftware\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\n\n[del]\nDefault\n.exeELBA5\\\\ELBA_dataftp://anonymous:ftp://%s:%s@%s:%d\\n\nHBPData\\\\hbp.profileHH:mm:ssdd:MMM:yyyy\nI_CryptUIProtect\\\\exe\\\\\ninfected.exx%s%s\\\\%u_info.txt\n\n[ins]\nInstallDate\n%02u.jpg%s\\\\%02d.jpgKEYLOG\n%s\\\\keylog.txt\n\n[TOKEN ON]\n\\n\\n[%s (%s-%s) - %s (%s)]\\n[pst]%s[/pst]\nltcd_path.txt\nltcd_wallet.dat\nlitecoind\\\\wallet.dat\nltc_path.txtltc_wallet.dat\nlitecoin\\\\wallet.dat\\\\MacromediaMultiCash@Sign\nC:\\\\Omikron\\\\MCSign\n\n[ML][MR]Global\\\\{4C470E-%08x-%08x-%08x}\n\n\n-----\n\n272\n273\n274\n275\n276\n277\n278\n279\n280\n281\n282\n283\n284\n285\n286\n287\n288\n289\n290\n291\n292\n293\n294\n295\n296\n297\n298\n299\n300\n301\n302\n303\n304\n305\n306\n307\n308\n309\n310\n311\n312\n313\n314\n315\n316\n317\n318\n319\n320\n321\n322\n323\n324\n325\n326\n327\n328\n329\n330\n331\n332\n333\n334\n335\n336\n337\n338\n339\n340\n341\n342\n343\n344\n345\n346\n347\n348\n\n\n{ }\nnoneopera.exe\nPASS\npassword.txt\\\\\\\\.\\\\pipe\\\\%s\npop3://%s:%s@%s:%d\\n%PROCESSOR_ARCHITECTURE%Referer\n\n[ret]\n%08x\\\\system32\\\\rstrui.exe\n\\\\scrs\\\\send%s%s%s%d%s:%s\nsysinfo.txt\n\n[tab]\ndata.txt<unnamed>\n<untitled>\nupdate\nUSER\nUser-agent\nvkeys\n%x\\r\\n\n\\r\\n%x%x%x.tmp\n\\\\*.txt\n%02x%2b\ntorrent\n-config config.vnc\n--config\nconfig.ovpn\ndata.txt[type=post]\\n\nCreateFileW\npos.exe\nbank.exePOS\nsecure.\n.mozgoogle.com\nCertVerifyCertificateChainPolicyCertGetCertificateChain\nSSL_AuthCertificateHook\nUSERNAMESoftware\\\\ESET\\\\ESET Security\\\\CurrentVersion\\\\Info\nC8FFAD27AE1BBE28BE24DDF20AF36EF901C609968930ED82CEFBC64808BA34102C4FABA0560523FB4CCBF33684F77C8401DFB\n3A7D2D598E872DD78033E7F900B78A0C710CDF0941662FF7745A435D4BC18D5661E0582B21B2DB8FCA1C0CA3401D0FC9F051\n85A558AB6A76A010F606CD77B35A480B6B7176F0903299B91F1BBD141B4D33615849C35557357DAB819BC3D4A8722BB433DE\nB66C7A326BE859BD94930331B37DEE6EF4C475EA4B33DE4699FFDBCD34E196E19FE630E631D2C612705048620183BCF56709B\n484A4380C4B00D8D94D131C31DB53AE6BCDCCC14131BAC99A68C59A604D0AE9116E9196F7FA3EA5F86F67E9B175CC09D3E17\n997728B7D\n10001\nget=1\nCOMPNAMEAppDataDir\nupdfiles\\\\upd.ver\nupdfiles\\\\lastupd.ver\nSYSTEM\\\\CurrentControlSet\\\\services\\\\Avg\\\\SystemValues\nLocal AppData\nAvg2015\nAvg2014\nAvg2013\nAvg2012\nAvg2011\nupdate\nSoftware\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\explorer\\\\Browser Helper Objects\\\\{8CA7E745-EF75-4E7B-BB868065C0CE29CA}\nSoftware\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\explorer\\\\Browser Helper Objects\\\\{BB62FFF4-41CB-4AFC-BB8C2A4D4B42BBDC}\nSoftware\\\\Microsoft\\\\Internet Explorer\\\\MainEnable Browser Extensions\nhttpd.exe\n%s\\\\httpd.exe\nconnect\ndata\\\\index.php\nlogs\\\\error.log\nerror.log\n<?\\n';\\n$bot_id = '\n$bot_net = '$key_log_file = '\n$process_file = '\n127.0.0.1\nListen %s:%u\\n\nconf\\\\httpd.confSSL_PORT%u>\\n\n\n[type=post]\\n\n\n[type=screen]\\n\n\n[type=knock]\\n\n74??834E0440B832FFFFFF\n74??834E04405F5EB832FFFFFF\nDEBUG\nmemory.dmp\nconfig.xml\nphp5ts.dll\n\n\n-----\n\n350\n351\n352\n353\n354\n355\n356\n357\n358\n359\n360\n361\n362\n363\n364\n365\n366\n367\n368\n369\n370\n371\n372\n373\n374\n375\n376\n377\n378\n379\n380\n381\n382\n383\n384\n385\n386\n387\n388\n389\n390\n391\n392\n393\n\n\n_ _ p\nzend_compile_file\nindex.php\nconfig.php\ncontent.php\niexplore.exe|firefox.exe|chrome.exe|opera.exe|browser.exe|dragon.exe|epic.exe|sbrender.exe|vivaldi.exe|maxthon.exe|ybr\nowser.exe|microsoftedgecp.exe\nInternetQueryDataAvailable\nInternetReadFileInternetReadFileExA\nInternetReadFileExW\nInternetSetStatusCallbackA\nInternetSetStatusCallbackW\nHttpSendRequestAHttpSendRequestExA\nHttpSendRequestExW\nHttpSendRequestW\\r\\n0\\r\\n\\r\\n\n.rdata\n\\r\\n\\r\\nHTTP/1.\nTransfer-Encoding\nchunked\nContent-Length\nclose\nProxy-ConnectionHostAccept-Encoding\nx-xss-protectionx-content-security-policy\nx-frame-options\nx-content-type-options\nIf-Modified-Since\nIf-None-Match\ncontent-security-policy\nx-webkit-cspConnection\nhttp://\nhttps://NSS layer\nContent-TypeBasic\nPR_ClosePR_Connect\nPR_GetNameForIdentity\nPR_Read\nPR_SetError\nPR_WriteReferer:\nAccept-Encoding:\\r\\n1406SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\Zones\\3\ndata_after\\ndata_before\\n\ndata_enddata_inject\\n\nset_url %BOTID%\n%BOTNET%InternetCloseHandle\nHTMLc:\\\\inject.txt\nDalvik/1.6.0 (Linux; U; Android 4.1.2; GT-N7000 Build/JZO54K)\nxxx_process_0x%08x\nCommon.js\n\n\n## API Obfuscation\n\n[The main payload uses an API obfuscation technique known as Push-Calc-Ret obfuscation. The calls to the real API functions are patched by](https://www.symantec.com/content/en/us/enterprise/media/security_response/whitepapers/a_museum_of_api_obfuscation_on_win32.pdf)\nthe second stage injector after the main payload gets injected into the svchost process. Whenever a Windows API function should have been\ncalled, instead the address of a trampoline function is called which calculates the actual function address. All the trampoline function\naddresses are stored in an array in memory.\n\nFor example, the main payload wants to call CreateFile(), but this call is patched. Now, it calls the trampoline function which could look as\nfollows:\n\n\n1\n2\n3\n4\n5\n\n\n00846110  PUSH 2B464C25\n00846115  PUSHFD\n00846116  XOR DWORD PTR SS:[ESP+4], 5DB5E13F\n0084611E  POPFD\n0084611F  RETN\n\n\nFirst, a value is pushed to the stack. Next, the EFLAGS register is saved to the stack, because it will be altered by the following XOR\ninstruction (OF, CF flags are cleared and the SF, ZF, and PF flags are set according to the result). Then, the previously pushed value is XORed\nwith another value to calculate the actual API function address. At last, the EFLAGS register gets restored and the real API function address is\ncalled via the RETN instruction.\n\n**Persistence Method**\n\nThe main payload copies the initial obfuscated loader file to the %ProgramData% folder with a random file retrieved with GetTickCount(). Then,\nit creates a JScript file named \"Common.js\" in the Startup folder of the current user. The file contains the following code which runs the initial\nloader after the system was rebooted:\n\n\n-----\n\n1\n2\n\n\nvar yqvltidpue = new ActiveXObject( WScript.Shell );\nyqvltidpue.Run(\"C:\\\\PROGRA~3\\\\930d4a6d.exe\")\n\n\n**Updates of the Main Payload compared to Previous Version**\n\n[Reports on previous versions of Shifu have been published by FireEye and](https://www.fireeye.com/blog/threat-research/2015/10/shifu-malware-analyzed-behavior-capabilities-and.html) [Fortinet.](https://www.virusbulletin.com/virusbulletin/2015/11/shifu-rise-self-destructive-banking-trojan/)\n\nIn comparison to the previous version, the list of substrings to scan for in the string that gets created with the computer name, user name,\ninstall date and system drive volume serial number was expanded:\n\nTREASURE\nBUH\nBANK\nACCOUNT\nCASH\nFINAN\nMONEY\nMANAGE\nOPER\nDIRECT\nROSPIL\nCAPO\nBOSS\nTRADE\n\nUpdated command list:\n\nactive_sk\ndeactive_sk\ndeactivebc\nget_keylog\nget_sols\ninject\nkill_os\nload\nmitm_geterr\nmitm_mod\nmitm_script\nwipe_cookies\n\nUpdated list of targeted browsers:\n\niexplore.exe\nfirefox.exe\nchrome.exe\nopera.exe\nbrowser.exe\ndragon.exe\nepic.exe\nsbrender.exe\nvivaldi.exe\nmaxthon.exe\nybrowser.exe\nmicrosoftedgecp.exe\n\nThe main payload will download the Apache httpd.exe server file from one of the C&C servers to store it on disk for web injection purposes.\nCompared to the previous version, the main payload also contains two strings which indicate some functionality for the Zend PHP Framework:\n\nzend_stream_fixup\nzend_compile_file\n\n**Function Hooking in Svchost**\n\nLike in the previous version, the malware hooks some API functions to redirect URLs, capture network traffic, the clipboard and to log\nkeystrokes. It uses a technique known as inline function hooking where the first 5 bytes of a function get patched with a jump to the malware's\nhook handlers. The following functions get hooked:\n\n\n-----\n\nt e ce oCo t o e ( td d )\nZwDeviceIoControlFile (ntdll.dll)\nGetClipboardData (user32.dll)\nGetMessageA (user32.dll)\nGetMessageW (user32.dll)\nTranslateMessage (user32.dll)\nGetAddrInfoExW (ws2_32.dll)\ngethostbyname (ws2_32.dll)\ngetaddrinfo (ws2_32.dll)\n\n**Network Functionality**\n\nThe main payload of Shifu uses .bit top-level domains which is a decentralized DNS system based on the Namecoin infrastructure. The\nmalware requests the IP addresses of the domains by subsequently contacting the following hardcoded Namecoin DNS servers:\n\n92.222.80.28\n78.138.97.93\n77.66.108.93\n\nThe C&C domain names, the user-agent string and the URL parameters are encrypted with a modified RC4 encryption algorithm. Decrypted\nstrings:\n\nklyatiemoskali.bit\nslavaukraine.bit\nMozilla/5.0 (Windows; U; Windows NT 5.2 x64; en-US; rv:1.9a1) Gecko/20061007 Minefield/3.0a1\nL9mS3THljZylEx46ymJ2eqIdsEguKC15KnyQdfx4RTcVu8gCT\nhttps://www.bing.com\n/english/imageupload.php\n/english/userlogin.php\n/english/userpanel.php\n1brz\n\nThe encrypted strings are stored in the following format inside the .data section:\n\n<LengthOfString><EncryptedString>\n\nThe domain string “klyatiemoskali“ means roughly translated to wish something bad to Muscovites. The second domain string “slavaukraine”\nmeans translated “glory to the Ukraine”. The included RC4 key \"L9mS3THljZylEx46ymJ2eqIdsEguKC15KnyQdfx4RTcVu8gCT\" is used to\nencrypt the network traffic.\n\nAt the time of analysis, only the following Namecoin DNS server was answering with the IP address of the actual C&C server:\n\n77.66.108.93 (ns1.dk.dns.d0wn.biz)\n\n\n-----\n\n_Figure 5. Namecoin DNS server information of 77.66.108.93_\n\nThe following screenshot shows the captured network traffic during the dynamic analysis of Shifu:\n\n_Figure 6. Shifu network traffic captured with Wireshark_\n\nWe can see that Shifu subsequently queries the Namecoin DNS servers with the domain name klyatiemoskali.bit to get the IP address. After\none name server responds with the IP address of the C&C server, it does a TLS handshake to open an encrypted network channel. Finally, it\nsends some encrypted data and gets an encrypted answer. However, no further network traffic could have been observed during the time of\n\n\n-----\n\nt e a a ys s ot do a a es, yat e os a b t a d s a au a e b t, eso ed to t e add ess 03 99 6 06 at t e t e o a a ys s\n\nAs the .bit top-level domain relies on the Namecoin cryptocurrency which is based on the Bitcoin system, every transaction can be traced\nback. Thus, we can use a Namecoin block explorer to look when the .bit domains were registered and which IP addresses are connected to it.\nFor example, if we use the web service namecha.in, we can get the following information for klyatiemaskali.bit:\n\nWe can see the same information for slavaukraine.bit:\n\nBoth domains were registered on 2016-06-03 and only one IP address is assigned to them. This IP address coincides with the response of the\nNamecoin DNS server we have seen in the captured network traffic. Moreover, we can see the domain seems to be still active.\n\n**URL Query String for C&C Server**\n\nThe main payload contains a query string template used to send information of the victim to the C&C server:\n\nbotid=%s&ver=%s.%u&up=%u&os=%u&ltime=%s%d&token=%d&cn=%s&av=%s&dmn=%s&mitm=%u\n\nWe can see that some information is dynamically retrieved (bot identifier, uptime, operating system version, local timestamp, token, anti**virus software, domain name of workstation, man in the middle interception detected), while also static values like the bot version and the**\n**campaign name are send. An example of the created query string could look as follows:**\n\nbotid=26C47136!A5A4B18A!F2F924F2&ver=1.759&up=18294&os=6110&ltime=-8&token=0&cn=1brz&av=&dmn=&mitm=0\n\nWe can see that the internal Shifu version is “1.759” and the campaign name is stated “1brz”.\n\nIf we compare Shifu's query string with the one of the latest Shiz version we have tracked which dates February 2014 (internal version 5.6.25),\nwe can see the similarity between those two malwares:\n\nbotid=%s&ver=5.6.25&up=%u&os=%03u&ltime=%s%d&token=%d&cn=sochi&av=%s\n\n## Modified RC4 Encryption Algorithm\n\n\n-----\n\nS u uses a od ed e s o o t e C e c ypt o a go t e a e eco st ucted t e a go t yt o a d s o o t e do a\nname \"klyatiemoskali.bit\" present in the main payload will be encrypted as an example:\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n\n\nimport os\nimport binascii\n\n###initial values##########\nstring = \"klyatiemoskali.bit\"\nseed =\n\"fnbqooqdaixfueangywblgabirdgvkewdyqgfqaioluesyrpryfkjerfsouemaxnavrkguxmcmhckwprunurmhehclermtufwi\nyjbqhwlunbunuumeowfjmerxppxrgaxukyx\"\nbuffer = [0] * (len(string))\ntable_encr = [0] * 0x102\ntable_encr[0x100] = 1\ntable_encr[0x101] = 0\n###########################\n\n###string2buffer###########\ni = 0\nwhile (i<len(string)):\nchar_1 = string[i]\nint_1 = ord (char_1)\nbuffer[i] = int_1\ni += 1\n###string2buffer###########\n\n###encryption table########\ni = 0\nwhile (i < 0x100):\ntable_encr[i] = 0x000000ff&i\ni += 1\n\ni = 0\nj = 0\nwhile (i < 0x100):\nchar_1 = seed[j]\nint_2 = ord (char_1)\ntable_encr[i] ^= int_2\ni += 1\nj += 1\nif (j == len(seed)):\nj = 0\n###########################\n\n###encryption##############\nsize_1 = len(string)\ni = 0\nwhile (size_1 != 0):\nbyte_buf = buffer[i]\nind_1 = table_encr[0x100]\nind_2 = table_encr[ind_1]\nind_3 = 0x000000ff&(ind_2 + table_encr[0x101])\nind_4 = 0x000000ff&(table_encr[ind_3])\ntable_encr[ind_1] = ind_4\ntable_encr[ind_3] = ind_2\nbuffer[i] = 0x000000ff&(table_encr[0x000000ff&(ind_2 + ind_4)] ^ byte_buf)\ntable_encr[0x100] = 0x000000ff&(ind_1 + 1)\ntable_encr[0x101] = ind_3\ni += 1\nsize_1 -= 1\n\ni = 0\nstr_1 = \"\"\nwhile (i < len(string)):\nstr_1 = str_1 + chr(buffer[i])\ni += 1\n###########################\n\n###output##################\nprint (\"Cleartext string: %s\" % string)\nprint (\"Encrypted: 0x%s\" % binascii.hexlify(str_1))\n###########################\n\n\n**Get updates from**\n**Palo Alto**\n**Networks!**\n\n\n-----\n\nS g up to ece e t e atest e s, cybe t eat te ge ce a d esea c o us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-01-06 - 2016 Updates to Shifu Banking Trojan.pdf"
    ],
    "report_names": [
        "2017-01-06 - 2016 Updates to Shifu Banking Trojan.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535898,
    "ts_updated_at": 1743041148,
    "ts_creation_date": 1653760847,
    "ts_modification_date": 1653760847,
    "files": {
        "pdf": "https://archive.orkl.eu/fe21b3e1de8c1477f88cf17aacd9bbcb0252d83f.pdf",
        "text": "https://archive.orkl.eu/fe21b3e1de8c1477f88cf17aacd9bbcb0252d83f.txt",
        "img": "https://archive.orkl.eu/fe21b3e1de8c1477f88cf17aacd9bbcb0252d83f.jpg"
    }
}