{
    "id": "c652dbe2-d33c-4cc6-8446-05b66ac51c58",
    "created_at": "2023-01-12T15:01:25.282099Z",
    "updated_at": "2025-03-27T02:09:17.960748Z",
    "deleted_at": null,
    "sha1_hash": "458be488ab48f19fb43bc7caecb8a0c983e523be",
    "title": "2021-05-05 - Intervention halts a ProxyLogon-enabled attack",
    "authors": "",
    "file_creation_date": "2022-05-27T21:51:44Z",
    "file_modification_date": "2022-05-27T21:51:44Z",
    "file_size": 1759950,
    "plain_text": "# Intervention halts a ProxyLogon-enabled attack\n\n**[news.sophos.com/en-us/2021/05/05/intervention-halts-a-proxylogon-enabled-attack](https://news.sophos.com/en-us/2021/05/05/intervention-halts-a-proxylogon-enabled-attack)**\n\nAndrew Brandt May 5, 2021\n\nIn a recently-concluded engagement, Sophos’ Rapid Response team was called in to\ninvestigate an attack targeting an Exchange server. During the course of the work, the\nresponders discovered that the attackers were still taking actions inside the target’s network,\nand stopped the slow-rolling, manually controlled attack before any lasting damage could be\ndone.\n\nThe target was a large enterprise that has around 15,000 endpoints spread across North\nAmerica. Sophos discovered the attack, which began with the target’s Exchange server\nbecoming compromised through the use of the ProxyLogon exploit.\n\nWhat made the attack stand out was the attackers’ use of an unusual combination of\ncommercial remote management tools not typically observed during the early phases of\nattacks, and the attackers’ careful avoidance of some of the more obvious (and forensically\nnoisy) techniques we typically observe in attacks like this, such as the widespread use of\nRDP to take control of machines inside the network. They did, however, scan the network\nand deploy Cobalt Strike as they moved from machine to machine.\n\n\n-----\n\nDuring the incident, which took place over a period of just over two weeks, the attackers\ndumped stored credentials from the Exchange server, and then leveraged some of those\ncredentials to pivot to other machines in the network. They also used a commercial remote\naccess software tool called Remote Utilities, and limited their use of RDP within the network\nto just one session per machine, possibly as an attempt to remain below the radar.\n\n## The initial attack phase, and its tooling\n\nThe vulnerable server was compromised on March 16th, when a log entry reveals that the\n[attacker leveraged two vulnerabilities – CVE-2021-26855 and CVE-2021-27065 – in order to](https://news.sophos.com/en-us/2021/03/09/critical-updates-dominate-march-2021-patch-tuesday-releases/)\nexecute a malicious PowerShell command on the server.\n\nWithin the next 90 minutes, the attackers had enumerated the Domain Administrator\naccounts from the now-compromised computer, dumped the credentials from memory so\nthey could work on cracking the passwords offline, and had modified a Registry key on the\ncomputer that forced it to clear any stored credentials from memory. This final action would\nforce any users to log in using their current password the next time they used the machine.\n\nEnumerating administrators and other users\nThe password dump file was left in a location where the attackers could retrieve it directly\nfrom the public-facing web interface of Outlook Web Access, but where it would not be\nobvious to employees who used the server to check their email.\n\nThe attackers took a one day break and returned on March 18th to begin moving laterally\nthrough the target’s network and to establish multiple new footholds on different machines.\nThey dumped the credentials from memory a second time and used WMI and PowerShell to\n\n\n-----\n\nissue commands on other machines on the network.\n\nThis was clearly an information-gathering and “establishing control over lots of\nmachines” phase of the attack, as the threat actors mapped the network using a tool called\n[ADRecon, and identified additional machines they would later pivot to. They used](https://github.com/sense-of-security/ADRecon)\nPowerShell commands to dump memory from LSASS on some of these other internal\nmachines remotely, and then pulled those dump files back to the Exchange sever – their\ninitial foothold – for retrieval and offline extraction of more credentials.\n\nThey also took this opportunity to set up a backdoor into the network by executing the first of\n[several malicious payloads on the Exchange server – an open-source utility called Chisel,](https://github.com/jpillora/chisel)\nwhich its Github page describes as “a fast TCP/UDP tunnel, transported over HTTP, secured\nby SSH.” While Chisel, like ADRecon, isn’t inherently malicious, it obviously can be used that\nway, as it was here.\n\nAn excerpt of the bot.ps1 script\nThe attackers also ran a command that remotely installed a PowerShell backdoor (named\n**bot.ps1) and a script that pulled down and executed a Cobalt Strike payload (called**\n**cobalt.ps1) on multiple machines on the network.**\n\nThe threat actors actually built themselves a sizeable collection of tools they used during this\nattack, the details of which are discussed below.\n\n## Attackers find expediency outweighs security\n\n\n-----\n\nFor all the effort involved, the attackers did not employ particularly good security, themselves.\nThey created accounts named admin on several machines (with a password of\n“P@ssw0rd“) and added them to the Administrators group.\n\nAttacker assigning a terrible password\nBut they didn’t log on with these accounts; Rather, as the day went on, they used the\ncredentials that belonged to network administrators extracted from the LSASS memory\ndumps to connect from one machine to another, just one time over Remote Desktop,\nexecuting their bot.ps1 tool on the remote machine.\n\nThey also used this access to install a commercial IT helpdesk access tool called Remote\nUtilities, and three days later, a Cobalt Strike beacon (signed with a stolen digital certificate\nthat, as of this writing, currently passes validation), on some machines.\n\nThe Cobalt Strike payloads\n\nwere digitally signed with a valid certificate\n\n\n-----\n\nThe Cobalt Strike beacon was a DLL that was given a random name, and executed from the\nC:\\Windows\\Temp directory by a command issued through the bot.ps1 backdoor. These\npayloads were all signed by a Sectigo-issued certificate assigned to OASIS COURT\n_LIMITED, with validity that does not expire until the end of 2021, tied to a yahoo.com email_\naddress.\n\nThe attackers then went silent for more than a week. On March 27, they returned and tried to\nexecute another Cobalt Strike beacon in memory, but were prevented from doing so by our\nendpoint protection tools. On March 29, they performed reconnaissance of the Active\nDirectory server (using one of the administrators’ stolen credentials), exported the results to\na series of CSV files, then compressed those into a single Windows .cab archive file.\n\nRunning a remote script\nThe attackers continued their slow-roll approach, only taking a small number of actions on\nany given day for the next few days. Sophos detected and stopped the execution of another\nCobalt Strike beacon on March 30, and blocked a PowerShell command that would have\ndeployed the bot.ps1 backdoor to four more servers the attackers had identified. They then\nrecompiled the Cobalt Strike beacon in an attempt to evade our detection and tried again on\nMarch 31.\n\nA\n\ncomparison of older (left) and newer (right) bot scripts, with code added to check TLS\ncertificate validity\nBy April 1, the attackers had begun to use the commercial Remote Utilities tool to open a\nconnection from a computer based in Paris to one of the targeted internal servers. They used\nthis connection to deliver a number of malware files, including a copy of Mimikatz and a new\nPowerShell script named p.ps1, and to create new users with administrative privileges on\nadditional machines. They also named one of the Chisel executable payloads Sophos.exe\nand tried to drop it into the Windows directory and execute it.\n\n\n-----\n\nOn April 2, the targeted company decided to engage with Sophos Rapid Response to deal\nwith the growing problem. Within a few hours, we had identified a number of malicious\nprograms they had delivered onto the network. The attack appeared to be a precursor to\ndelivering ransomware to the entire corporate IT infrastructure, but our intervention\nprevented any further harm from being done.\n\n## Handcrafted tools used in the attack\n\nIn addition to the PowerShell remote access tool, bot.ps1, the threat actors created a series\nof other PowerShell scripts, which they deployed as modules to enhance the core\nfunctionality of bot.ps1. These were run across the target’s network in an attempt to conduct\nreconnaissance and give themselves the privileges they needed to complete the attack.\n\nThe encoded “bullet” file, embedded in a script used during the attack\n\n**Module_AMSIBypassMaybe_regthrgrwfgterw.ps1: a dropper that delivers either a**\n32-bit or 64-bit DLL as a payload, and then patches the payload’s entrycode in an\nattempt to defeat AMSI-based malware detection.\n**Module_RunPsExecMaybe.ps1: Despite its name, this module has nothing to do with**\nthe Windows PSExec utility. It creates a service entry that runs a PowerShell backdoor\nit refers to as a “RemoteBulletFile.”\n**Module_ADRecon.ps1: A one-line script that literally just calls the PowerShell script**\nfor ADRecon directly from its Github page.\n**Module_RunByWMI.ps1: A script that copies the PowerShell backdoor to a remote**\ncomputer. The only difference between it and Module_RunPsExecMaybe.ps1 is this\nversion includes a variable called $urlConsole that defines a command-and-control\naddress.\n**Module_GetAllServers.ps1: Collects information about the current domain, and any**\nphysical or virtual machines hosted in the domain.\n**Module_GetDomainControllers.ps1: Collects information about the domain**\ncontrollers, including its hostname, operating system version, and its operational\nstatus.\n**Module_EnumerateAdmins.ps1: Collects domain admin, enterprise admin, and**\ndomain user information.\n\n\n-----\n\n**Module_Mod-EnumerateHyperV.ps1: Enumerates and collects information about**\nHyperV virtual machines within a domain.\n\nThe embedded\n\npatches that modify PowerShell’s behavior\n\n## Lessons learned from the attack\n\nThe threat actors engaged in this attack were canny and evasive. They tried to stay below\nthe radar by avoiding using RDP extensively, and by using commercially-available IT\nmanagement tools to conceal the true nature of their work. Despite gaining initial access\nthrough a “low hanging fruit” Exchange server, they understood they might only have a\nlimited window in which to gain the level of access they needed in order to deliver a final\npayload.\n\nFortunately in this case, the target never was hit with this destructive payload. Quick action\nby Labs and MTR ensured that the attackers’ actions were countered by reactions that\nprevented them from doing more damage. The greatest harm they caused resulted in the\norganization requiring all employees to change their passwords.\n\n\n-----\n\nThe Cobalt Strike DLL payload was embedded as XORed binary data within a PowerShell\nscript\nIn most attacks of this nature we investigate, the eventual deliverable is usually a\nransomware payload. When attackers begin to see their customized tooling get blocked by\nsecurity products, they often rapidly escalate to deploy ransomware before they lose all\naccess to the network. The countermeasures Sophos deployed effectively prevented them\nfrom taking that final step.\n\nThe target told their Sophos team that they thought they had patched the Exchange server\ncorrectly, and then had tested whether the server was compromised using some scripts\nprovided by Microsoft. Unfortunately, they relied too heavily on those scripts, which Microsoft\nhad subsequently revised. The initial tests showed the server had not been compromised,\nbut the followup tests using the revised scripts revealed that the server had, in fact, been\n\n\n-----\n\ntaken over. While it was a useful exercise to run the have I been compromised scripts, it\nalso serves as a cautionary tale that organizations should not rely on a test script alone to\ngive themselves peace of mind.\n\nSophos also learned a valuable lesson in dealing with these attackers: It pays dividends to\nrecognize the hallmarks of an active attack, even if the attackers are using tooling you’re\nunfamiliar with. Detecting the launch of Cobalt Strike in memory is just one such hallmark,\nand helped convince the customer that a serious (potentially very costly) attack was actively\nunderway even though we didn’t observe many of the other common indicators of an attack,\nsuch as widespread use of RDP over a prolonged period of time, which would have\nappeared in log entries.\n\n## Detections and indicators of compromise\n\nSophos detects the payloads involved in this attack and others like it as Mem/Meter-A,\n**Troj/PSDrop-CV, AMSI/Cobalt-E, or Troj/PS-FX. SophosLabs has published indicators of**\ncompromise relating to this attack to our Github page.\n\n## Acknowledgments\n\nSophosLabs wishes to thank Peter Mackenzie, Vikas Singh, Gabor Szappanos, and the\nRapid Response team for their help protecting this customer and producing the research that\nunderlies this report.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-05 - Intervention halts a ProxyLogon-enabled attack.pdf"
    ],
    "report_names": [
        "2021-05-05 - Intervention halts a ProxyLogon-enabled attack.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535685,
    "ts_updated_at": 1743041357,
    "ts_creation_date": 1653688304,
    "ts_modification_date": 1653688304,
    "files": {
        "pdf": "https://archive.orkl.eu/458be488ab48f19fb43bc7caecb8a0c983e523be.pdf",
        "text": "https://archive.orkl.eu/458be488ab48f19fb43bc7caecb8a0c983e523be.txt",
        "img": "https://archive.orkl.eu/458be488ab48f19fb43bc7caecb8a0c983e523be.jpg"
    }
}