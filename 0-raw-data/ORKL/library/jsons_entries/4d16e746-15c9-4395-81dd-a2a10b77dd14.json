{
    "id": "4d16e746-15c9-4395-81dd-a2a10b77dd14",
    "created_at": "2023-01-12T15:07:33.025606Z",
    "updated_at": "2025-03-27T02:09:18.406836Z",
    "deleted_at": null,
    "sha1_hash": "94089803607c4e68e1bda60d29d931af5b274d53",
    "title": "2022-06-06 - Shining the Light on Black Basta",
    "authors": "",
    "file_creation_date": "2022-06-09T10:27:52Z",
    "file_modification_date": "2022-06-09T10:27:52Z",
    "file_size": 2473808,
    "plain_text": "# Shining the Light on Black Basta\n\n**[research.nccgroup.com/2022/06/06/shining-the-light-on-black-basta/](https://research.nccgroup.com/2022/06/06/shining-the-light-on-black-basta/)**\n\nAuthored by: Ross Inman [(@rdi_x64) and Peter Gurney](https://twitter.com/rdi_x64)\n\n## Summary\n\n tl;dr\n\n\nJune 6, 2022\n\n\nThis blog post documents some of the TTPs employed by a threat actor group who were\nobserved deploying Black Basta ransomware during a recent incident response\nengagement, as well as a breakdown of the executable file which performs the encryption.\n\nA summary of the findings can be found below:\n\nLateral movement through use of Qakbot.\nGathering internal IP addresses of all hosts on the network.\nDisabling Windows Defender.\nDeleting Veeam backups from Hyper-V servers.\nUse of WMI to push out the ransomware.\nTechnical analysis of the ransomware executable.\n\n## Black Basta\n\n\n-----\n\nBlack Basta are a ransomware group who have recently emerged, with the first public\nreports of attacks occurring in April this year. As is popular with other ransomware groups,\nBlack Basta uses double-extortion attacks where data is first exfiltrated from the network\nbefore the ransomware is deployed. The threat actor then threatens to leak the data on the\n“Black Basta Blog” or “Basta News” Tor site. There are two Tor sites used by Black Basta,\none which leaks stolen data and one which the victims can use to contact the ransomware\noperators. The latter site is provided in the ransom note which is dropped by the ransomware\nexecutable.\n\n## Black Basta TTPs\n\n Lateral Movement\n\nBlack Basta was observed using the following methods to laterally move throughout the\nnetwork after their initial access had been gained:\n\nPsExec.exe which was created in the C:\\Windows\\ folder.\nQakbot was leveraged to remotely create a temporary service on a target host which\nwas configured to execute a Qakbot DLL using regsvr32.exe:\n\n```\nregsvr32.exe -s \\\\<IP address of compromised Domain\n\n```\n```\nController>\\SYSVOL\\<random string>.dll\n\n```\n\nRDP along with the deployment of a batch file called rdp.bat which contained command\nlines to enable RDP logons. This was used to allow the threat actor to establish remote\ndesktop sessions on compromised hosts, even if RDP was disabled originally:\n```\n   reg add \"HKLM\\System\\CurrentControlSet\\Control\\Terminal Server\" /v\n   \"fDenyTSConnections\" /t REG_DWORD /d 0 /f\n\n```\n```\nenable=yes\n\n```\n```\n      reg add \"HKLM\\System\\CurrentControlSet\\Control\\Terminal\n      Server\\WinStations\\RDP-Tcp\" /v \"UserAuthentication\" /t REG_DWORD /d\n      0 /f\n\n## Defense Evasion\n\n```\nDuring the intrusion, steps were taken by the threat actor in order to prevent interference\nfrom anti-virus. The threat actor was observed using two main techniques to disable\nWindows Defender.\n\nThe first used the batch script d.bat which was deployed locally on compromised hosts and\nexecuted the following PowerShell commands:\n\n\n-----\n\n```\npowershell -ExecutionPolicy Bypass -command New-ItemProperty -Path\n'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows Defender' -Name\nDisableAntiSpyware -Value 1 -PropertyType DWORD -Force\"\n\n```\n```\npowershell -ExecutionPolicy Bypass -command \"Set-MpPreference \n```\n```\nDisableRealtimeMonitoring 1\"\n\n```\n```\npowershell -ExecutionPolicy Bypass Uninstall-WindowsFeature -Name\n\n```\n```\nWindows-Defender\n\n```\n\nThe second technique involved creating a GPO (Group Policy Object) on a compromised\nDomain Controller which would push out the below changes to the Windows Registry of\ndomain-joined hosts:\n\n**Figure 1 Parsed Registry.pol of the created GPO**\n\n## Discovery\n\nA text file in the C:\\Windows\\ folder named pc_list.txt was present on two compromised\nDomain Controllers, both contained a list of internal IP addresses of all the systems on the\nnetwork. This was to supply the threat actor with a list of IP addresses to target when\ndeploying the ransomware.\n\n## Command and Control\n\nQakbot was the primary method utilised by the threat actor to maintain their presence on the\nnetwork. The threat actor was also observed using Cobalt Strike beacons during the\ncompromise.\n\n## Impact\n\n\n-----\n\nPrior to the deployment of the ransomware, the threat actor established RDP sessions to\nHyper-V servers and from there modified configurations for the Veeam backup jobs and\ndeleted the backups of the hosted virtual machines.\n\nAn encoded PowerShell command was observed on one of the compromised Domain\nControllers which, when decoded, yielded a script labelled as Invoke-TotalExec that provided\nthe ability to spread and execute files over the network using WMI (Windows Management\nInstrumentation). The script appears to have been run to push out the ransomware binary to\nthe IP addresses contained within the file C:\\Windows\\pc_list.txt. Analysis of the script\nindicates that two log files are created:\n\nC:\\Windows\\Temp\\log.info – Contains log entries for successful attempts.\nC:\\Windows\\Temp\\log.dat – Contains log entries for unsuccessful attempts.\n\nFor the incident investigated by NCC Group CIRT, only the latter log file had data. The log\nfile contained entries relating to failed uploads for all the IP addresses from pc_list.txt,\nindicating that the threat actor attempted to deploy the ransomware executable across all\nhosts on the network, however this had failed. Despite this, the ransomware was still\ndeployed to Hyper-V servers and the Domain Controllers.\n\n## Recommendations\n\n1. Hypervisors should be isolated by placing them in a separate domain or by adding\n\nthem to a workgroup to ensure that any compromise in the domain in which the hosted\nvirtual machines reside does not pose any risk to the Hypervisors.\n2. Ensure that both online and offline backups are taken and test the backup strategy\n\nregularly to identify any weak points that could be exploited by an adversary.\n3. Restrict internal RDP and SMB traffic ensuring only hosts that are required to\n\ncommunicate via these protocols are allowed to.\n\n## Indicators of Compromise\n\n\nIOC Value Indicator\nType\n\n23.106.160[.]188 IP\nAddress\n\n\nDescription\n\nCobalt Strike Commandand-Controller server\n\n\neb43350337138f2a77593c79cee1439217d02957 SHA1 Batch script which enabled\nRDP on the host (rdp.bat)\n\n920fe42b1bd69804080f904f0426ed784a8ebbc2 SHA1 Batch script to disable\nWindows Defender (d.bat)\n\nC:\\Windows\\PsExec.exe Filename PsExec\n\n\n-----\n\nC:\\Windows\\SYSVOL\\sysvol\\<random string>.dll Filename Qakbot payload\n\n\nC:\\Windows\\Temp\\log.info\nC:\\Windows\\Temp\\log.dat\n\n## Ransomware Technical Analysis\n\n Shadow Copy Deletion\n\n\nFilename Invoke-TotalExec output\nlog files\n\n\nUpon execution, Black Basta performs several operations before launching its encryption\nactivities.\n\nThe Mutex ‘dsajdhas.0’ is checked before issuing the two vssadmin.exe commands listed\nbelow. Although the Mutex is static in this sample it is expected to change across future\nsamples.\n```\nC:\\\\Windows\\\\SysNative\\\\vssadmin.exe delete shadows /all /quiet \nC:\\\\Windows\\\\System32\\\\vssadmin.exe delete shadows /all /quiet\n\n```\nThese result in the deletion of shadow copies ensuring they cannot be used for recovery\npurposes.\n\n## Wallpaper icon modification\n\nFollowing deletion of the shadow copies, two files are obtained from the binary. Firstly, a JPG\nfile in the currently analysed sample is saved as ‘dlaksjdoiwq.jpg’, used as a wallpaper on\ntargeted devices. The image used can be seen below in Figure 2.\n\n**Figure 2 Desktop wallpaper image**\nThe second dropped file is an icon file obtained from within the binary and used as a default\nicon for all files with extension. basta. The file is saved in the currently analysed sample with\nthe name fkdjsadasd.ico within the %Temp% directory, for example:\n\n\n-----\n\n```\nC:\\Users\\{Username}\\AppData\\Local\\Temp\n\n```\nThe icon used can be seen below in Figure 3.\n\n**Figure 3 Basta icon**\n\nThe wallpaper is modified to display the dropped JPG through the registry located at\n```\nHKCU\\Control Panel\\Desktop\\Wallpaper, setting the path to the JPG as seen below in\n\n```\nFigure 4.\n\n**Figure 4 String de-obfuscation example**\nThe next operation creates a new registry key with the name .basta under\n```\nHKEY_CLASSES_ROOT and sets the DefaultIcon subkey to display the dropped .ico file.\n\n```\nThis results in files given a .basta file extension inheriting the Black Basta logo. The registry\nkey can be seen below in Figure 5.\n\n**Figure 5 Desktop wallpaper image**\n\n## Ransom Note\n\nThe ransomware note is stored within the binary and written to a text file named readme.txt,\nas shown in Figure 6. This file is written to folders throughout the system. The content\ncomprises a standard Black Basta template with a URL to a Tor site where victims can\nnegotiate with operators.\n\nA company ID is also present, which varies between compromises.\n\n\n-----\n\n**Figure 6 Ransom Note**\n\n## Exclusions\n\nIn an attempt to avoid encrypting files or folders that are likely essential to the operation of\nthe target machine or Black Basta itself, several exclusions are in place that will prevent\nencrypting specific files. This includes several extensions, folders and files listed below.\n\nExtension exclusions:\n\nexe\ncmd\nbat\ncom\nbat\nbasta\n\nFile Folder exclusions:\n\n$Recycle.Bin\nWindows\nDocuments and Settings\nLocal Settings\nApplication Data\nOUT.txt\nBoot\nReadme.txt\nDlaksjdoiwq.jpg\nNTUSER.DAT\nfkdjsadasd.iso\n\n\n-----\n\nA copy of the ransom note is placed where an eligible folder is found, and suitable files\ndiscovered within the folder are passed for encryption.\n\n## Encryption\n\nSeveral threads are created that are responsible for performing the encryption activity. Each\nfile that is not skipped by the previously mentioned exclusions is encrypted using the\nChaCha20 cypher.\n\nThe encryption key is generated using the C++ rand_s function resulting in a random 40-byte\nhexadecimal output.\n\n**Figure 7 Random generation output**\nThe first 32 bytes are used as the ChaCha20 encryption key.\n\n**Figure 8 Encryption key**\nThe last 8 bytes are used as the ChaCha20 nonce.\n\n**Figure 9 Nonce**\nThe encryption key is encrypted using an implementation of RSA provided through the Mini\nGMP library. A public key is obtained from the binary that results in an output similar to the\nbelow output in Figure 10.\n\n\n-----\n\n**Figure 10 Encrypted encryption key**\nBlack Basta, as with many ransomware variants, doesn’t encrypt the entire file, instead only\npartially encrypts the file to increase the speed and efficiency of encryption. Black Basta\nachieves this by only encrypting 64-byte blocks of a file interspaced by 128-bytes. This can\nbe seen in Figure 11 below, where the first two encrypted data blocks are shown.\n\n**Figure 11 Example encrypted file**\n\n\n-----\n\nTo further demonstrate this, an unencrypted version of the file can be seen below in Figure\n12.\n\n**Figure 12 Example of the unencrypted file**\nFinally, the earlier generated RSA encrypted key and 0x00020000 are appended to the end\nof the file, which would be used for decryption purposes.\n\n\n-----\n\n**Figure 13 appended encrypted key and hex**\nFollowing successful encryption of a file, its extension is changed to .basta which\nautomatically adjusts its icon to the earlier drop icon file. An example of what a victim would\nbe presented with can be seen below in Figure 14.\n\n\n-----\n\n**Figure 14 example post encrypted desktop**\nWhile the ransom note threatens victims with the publication of data if the ransom is not met,\ninitial analysis has not uncovered a mechanism for exfiltration. With access to the private key\ncounterpart of the public key used earlier, recovery of the ChaCha20 encryption key by\noperators should be possible allowing for file decryption. No weakness in the encryption was\ndiscovered during analysis that would provide an opportunity for decryption without the\nprivate RSA key.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-06 - Shining the Light on Black Basta.pdf"
    ],
    "report_names": [
        "2022-06-06 - Shining the Light on Black Basta.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536053,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1654770472,
    "ts_modification_date": 1654770472,
    "files": {
        "pdf": "https://archive.orkl.eu/94089803607c4e68e1bda60d29d931af5b274d53.pdf",
        "text": "https://archive.orkl.eu/94089803607c4e68e1bda60d29d931af5b274d53.txt",
        "img": "https://archive.orkl.eu/94089803607c4e68e1bda60d29d931af5b274d53.jpg"
    }
}