{
    "id": "badc9cb9-9fd9-48d5-81f0-cc55d8440c36",
    "created_at": "2023-01-12T15:06:43.863421Z",
    "updated_at": "2025-03-27T02:16:34.709932Z",
    "deleted_at": null,
    "sha1_hash": "463614c13653aa1ccf24ac135855f8e33bcf8f7b",
    "title": "2021-09-29 - How to defeat the Russian Dukes- A step-by-step analysis of MiniDuke used by APT29-Cozy Bear",
    "authors": "",
    "file_creation_date": "2022-05-27T23:04:06Z",
    "file_modification_date": "2022-05-27T23:04:06Z",
    "file_size": 5610067,
    "plain_text": "# How to defeat the Russian Dukes: A step-by-step analysis of MiniDuke used by APT29/Cozy Bear\n\n**[cybergeeks.tech/how-to-defeat-the-russian-dukes-a-step-by-step-analysis-of-miniduke-used-by-apt29-cozy-bear/](https://cybergeeks.tech/how-to-defeat-the-russian-dukes-a-step-by-step-analysis-of-miniduke-used-by-apt29-cozy-bear/)**\n\nSummary\n\nAPT29/Cozy Bear is a Russian actor that has been associated with Russia’s Foreign\nIntelligence Service (SVR). The US government has blamed this actor for the SolarWinds\nsupply chain compromise operation, as described at\nhttps://media.defense.gov/2021/Apr/15/2002621240/-1/-1/0/CSA_SVR_TARGETS_US_ALLI\nES_UOO13234021.PDF/CSA_SVR_TARGETS_US_ALLIES_UOO13234021.PDF.\nMiniDuke is a backdoor written in pure assembly that was previously documented by ESET\nat https://www.welivesecurity.com/wpcontent/uploads/2019/10/ESET_Operation_Ghost_Dukes.pdf and Kaspersky at\n[https://securelist.com/miniduke-is-back-nemesis-gemina-and-the-botgen-studio/64107/,](https://securelist.com/miniduke-is-back-nemesis-gemina-and-the-botgen-studio/64107/)\nhowever, this sample is the most recent one (June 2019) that we’re aware of and hasn’t\nbeen documented before. This malware is pretty obfuscated (control-flow flattening) and\nimplements multiple methods of data exfiltration, such as using POST and PUT HTTP\nmethods in the case of sending data to the C2 server or using a named pipe in the case of\nno Internet connectivity. The backdoor implements 37 different functions that can be\nvisualized below (some of these are similar/identical and were skipped):\n\n\n-----\n\n**Analyst:** [@GeeksCyber](https://twitter.com/GeeksCyber)\n\nTechnical analysis\n\nSHA256: 6057b19975818ff4487ee62d5341834c53ab80a507949a52422ab37c7c46b7a1\n\nThe malware uses the SetUnhandledExceptionFilter function in order to set the exception\nfilter function to a particular function:\n\n\n-----\n\nFigure 1\nThe process retrieves the content of the STARTUPINFO structure by calling the\nGetStartupInfoA routine, as shown below:\n\nFigure 2\nA new thread is created by the malicious file using the CreateThread API:\n\nFigure 3\n**Thread activity – sub_4036D0**\n\nAs mentioned by ESET at https://www.welivesecurity.com/wpcontent/uploads/2019/10/ESET_Operation_Ghost_Dukes.pdf, the backdoor has added a lot\nof obfuscation that consists of control-flow flattening (every function is split in a switch/case,\nand a lot of computation that is useless for the main execution flow is added):\n\nFigure 4\nFigure 5 presents an example of an instruction that jumps to a place where a lot of useless\ncomputation occurs. We’ve added NOP operations in place of the jump and patched the\nbinary:\n\nFigure 5\n\n\n-----\n\nThe binary forces the system not to display the Windows Error Reporting dialog (0x2 =\n**SEM_NOGPFAULTERRORBOX):**\n\nFigure 6\nThe kernel32.dll, advapi32.dll and winninet.dll DLLs are loaded into the address space using\nthe LoadLibraryA routine:\n\nFigure 7\nThe functions that will be used during the execution are located using a hashing mechanism.\nBasically, for each function name from a DLL, the malware computes a 4-byte value that is\ncompared with a hard-coded one:\n\nFigure 8\nThe following APIs belong to the targeted list: GetProcAddress, GetLongPathNameA,\nGetLastError, CreateProcessWithLogonW, CryptAcquireContextW, CryptGenRandom,\nInternetOpenA, InternetConnectA, InternetSetOptionA, HttpOpenRequestA,\nHttpSendRequestA, HttpQueryInfoA, InternetReadFile, InternetCloseHandle,\nHttpAddRequestHeadersA. The hashing function is displayed below:\n\nFigure 9\n\n\n-----\n\nThe CryptAcquireContextW API is utilized to get a handle to a key container within a CSP\n(cryptographic service provider). The function call is presented in figure 10 (0x1 =\n**PROV_RSA_FULL, 0xF0000040 = CRYPT_VERIFYCONTEXT | CRYPT_SILENT):**\n\nFigure 10\nAllocateAndInitializeSid is used to allocate and initialize a SID with one subauthority:\n\nFigure 11\nThe file creates a new ACL using the SetEntriesInAclA routine (0x2 = SET_ACCESS):\n\nFigure 12\nA new security descriptor is initialized by the malicious process (0x1 =\n**SECURITY_DESCRIPTOR_REVISION):**\n\nFigure 13\nThe malware sets information in a DACL (discretionary access control list) using the\nSetSecurityDescriptorDacl API:\n\n\n-----\n\nFigure 14\nThe following relevant strings are written into memory and will be used later on:\n\nFigure 15\n\nCryptGenRandom is utilized to generate 16 random bytes. The first 15 bytes are encoded\nusing the Base64 algorithm:\n\nFigure 16\nThe binary writes the file signature of JPEG in the JFIF format into the memory. These bytes\nwill be used in data exfiltration, as we’ll describe in the following paragraphs:\n\nFigure 17\n\nThe process creates the “Software\\Microsoft\\ApplicationManager” registry key using the\nRegCreateKeyA API (0x80000001 = HKEY_CURRENT_USER):\n\nFigure 18\nA new value called “AppID” is created under the above registry key. This value is computed\nusing the output of a GetTickCount function call:\n\nFigure 19\n\n\n-----\n\nThere are 2 more calls to the GetTickCount routine (it retrieves the number of milliseconds\nthat elapsed since the system was started):\n\nFigure 20\nOne of the outputs from above is transformed and written into a buffer, along with the\n“AppID” value. This buffer will be encrypted using a custom algorithm that also includes the\nXOR operator:\n\nFigure 21\nThe encryption algorithm and the result of the above operation are highlighted in figure 22:\n\n\n-----\n\nFigure 22\n\nThe backdoor initializes the use of the WinINet functions using the InternetOpenA API with a\nparticular user agent:\n\nFigure 23\nThe proxy is set to 10.1.1.1:8080 using the InternetSetOptionA function (0x26 =\n**INTERNET_OPTION_PROXY):**\n\nFigure 24\nThe connect time-out value for connection requests is set to 11 seconds (0x2 =\n**INTERNET_OPTION_CONNECT_TIMEOUT):**\n\n\n-----\n\nFigure 25\nThe receive time-out value for connection requests is set to 11 seconds (0x6 =\n**INTERNET_OPTION_RECEIVE_TIMEOUT):**\n\nFigure 26\nThe send time-out value for connection requests is set to 11 seconds (0x5 =\n**INTERNET_OPTION_SEND_TIMEOUT):**\n\nFigure 27\nInternetConnnectA is utilized to open an HTTP session with the C2 server\nsalesappliances[.]com (0x3 = INTERNET_SERVICE_HTTP):\n\nFigure 28\nThe malware implements 3 different cases for exfiltrating the buffer that was encrypted\nearlier (or outputs from backdoor functions), depending on the availability of Internet\nconnectivity.\n\n**Case 1** **(no Internet availability)**\n\nWaitNamedPipeA is used to wait until 11 seconds have elapsed or an instance of the\n“\\\\pipe\\DefPipe” pipe is available for connection (this pipe is supposed to be utilized between\nthis machine and another machine that has an Internet connection):\n\n\n-----\n\nFigure 29\nThe process opens the specified pipe using the CreateFileA routine (0xC0000000 =\n**GENERIC_READ | GENERIC_WRITE, 0x3 = OPEN_EXISTING):**\n\nFigure 30\nSetNamedPipeHandleState is utilized to set the read mode and the blocking mode of the\npipe mentioned above (0x2 = PIPE_READMODE_MESSAGE, 0x0 = PIPE_WAIT):\n\nFigure 31\nThe binary writes the encrypted buffer to the specified pipe using the TransactNamedPipe\nAPI:\n\nFigure 32\n**Case 2 (Data exfiltration using PUT method)**\n\nA new HTTP request handle is created by the file (0x80400100 =\n**INTERNET_FLAG_RELOAD | INTERNET_FLAG_KEEP_CONNECTION |**\n**INTERNET_FLAG_PRAGMA_NOCACHE):**\n\n\n-----\n\nFigure 33\nThe Referer header is added to the HTTP request handle using HttpAddRequestHeadersA\n(0x20000000 = HTTP_ADDREQ_FLAG_ADD):\n\nFigure 34\nThe Accept-Language header is added to the HTTP request handle using\nHttpAddRequestHeadersA (0x20000000 = HTTP_ADDREQ_FLAG_ADD):\n\nFigure 35\nThe Accept-Encoding header is added to the HTTP request handle using\nHttpAddRequestHeadersA (0x20000000 = HTTP_ADDREQ_FLAG_ADD):\n\nFigure 36\nThe process exfiltrates the encrypted buffer to the C2 server by calling the\nHttpSendRequestA routine, as shown below:\n\n\n-----\n\nFigure 37\n**Case 3 (Data exfiltration using POST method)**\n\nA new HTTP request handle is created by the file (0x80400100 =\n**INTERNET_FLAG_RELOAD | INTERNET_FLAG_KEEP_CONNECTION |**\n**INTERNET_FLAG_PRAGMA_NOCACHE):**\n\nFigure 38\nThe Referer header is added to the HTTP request handle using HttpAddRequestHeadersA\n(0x20000000 = HTTP_ADDREQ_FLAG_ADD):\n\nFigure 39\nThe Accept-Language header is added to the HTTP request handle using\nHttpAddRequestHeadersA (0x20000000 = HTTP_ADDREQ_FLAG_ADD):\n\nFigure 40\nThe Accept-Encoding header is added to the HTTP request handle using\nHttpAddRequestHeadersA (0x20000000 = HTTP_ADDREQ_FLAG_ADD):\n\n\n-----\n\nFigure 41\nThe encrypted buffer is added to a fake JPEG image (note the file signature in the network\ntraffic) and transmitted to the C2 server without raising any suspicion:\n\nFigure 42\nHttpOpenRequestA is utilized to create a new HTTP request handle. The HTTP method is\nset to GET ( 0x80480100 = INTERNET_FLAG_RELOAD |\n**INTERNET_FLAG_KEEP_CONNECTION | INTERNET_FLAG_NO_COOKIES |**\n**INTERNET_FLAG_PRAGMA_NOCACHE):**\n\nFigure 43\nThe file generates 256 random bytes via a function call to CryptGenRandom (the result will\nbe Base64-encoded, and a small part of the output is used as a parameter in the Referer\nheader):\n\nFigure 44\nThe Referer, Accept-Language and Accept-Encoding headers are set as described before.\nThe encrypted buffer that was exfiltrated using one of the 3 methods is Base64-encoded:\n\n\n-----\n\nFigure 45\n\nThe Cookie header is set to a string that is obtained from the above using some\ntransformations, and the request is sent to the C2 server, as shown in figure 46.\n\nFigure 46\nHere is the network request captured by FakeNet:\n\nFigure 47\nIt’s important to mention that the backdoor also performs a “cleaning” operation by freeing\nthe memory in order to hide possible IOCs that could be extracted from it:\n\nFigure 48\nThe status code returned by the server is extracted and compared with 200 (0x20000013 =\n**HTTP_QUERY_FLAG_NUMBER | HTTP_QUERY_STATUS_CODE):**\n\nFigure 49\n\n\n-----\n\nThe malicious binary retrieves the size of the resource using the HttpQueryInfoA API\n(0x20000005 = HTTP_QUERY_FLAG_NUMBER | HTTP_QUERY_CONTENT_LENGTH):\n\nFigure 50\nThere is a function call to InternetReadFile, which is utilized to read data received from the\nC2 server:\n\nFigure 51\nThe response from the C2 server is parsed, and the byte at position 0x1c (28 in decimal) is\nextracted. There is also a “checksum” of the 5th-8th bytes that is computed, and the result\nshould match the first 4 bytes. We will describe each case depending on that particular byte.\n\n**Byte = 0x11 – read the content of a file specified by the C2 server and compute the MD5**\nhash of it\n\nThe path of the %TEMP% directory is extracted using GetTempPathA:\n\nFigure 52\nThe path of the %TEMP% directory is converted to its long form by calling the\nGetLongPathNameA routine, as highlighted below:\n\nFigure 53\nGetCurrentDirectoryA is utilized to extract the current directory for the current process:\n\n\n-----\n\nFigure 54\nThe response from the C2 server is supposed to contain a file name, which is opened via a\nCreateFileA function call (0x80000000 = GENERIC_READ, 0x1 = FILE_SHARE_READ, 0x3\n= OPEN_EXISTING, 0x80 = FILE_ATTRIBUTE_NORMAL):\n\nFigure 55\nThe malware creates an unnamed file mapping object using the CreateFileMappingA API\n(0x8 = PAGE_WRITECOPY):\n\nFigure 56\nThe malicious binary maps the newly created file mapping into the address space of the\ncalling process, as shown in the next pictures (0x1 = FILE_MAP_COPY):\n\nFigure 57\n\nFigure 58\n\nThe MD5 hashing algorithm is implemented by the malware (note the variables from below),\nwhich is used to perform hashing of the file content extracted above:\n\n\n-----\n\nFigure 59\n\nFigure 60\n\nThe resulting buffer that will be exfiltrated is similar to the one from figure 21, however, it also\ncontains the MD5 hash value and the file name. The encryption algorithm is the same\npresented in figure 22 (this is valid for all cases, and we will not repeat it every time):\n\nFigure 61\n**Byte = 0x12 – create and populate a new file**\n\n\n-----\n\nThe backdoor creates a new file specified by the C2 server in the network traffic\n(0x40000000 = GENERIC_WRITE, 0x1 = FILE_SHARE_READ, 0x1 = CREATE_NEW,\n0x80 = FILE_ATTRIBUTE_NORMAL):\n\nFigure 62\nThe newly created file is populated with content provided by the C2 server as well:\n\nFigure 63\nThe final buffer that will be exfiltrated contains the file name:\n\nFigure 64\n\n**Byte = 0x13 (same execution flow as 0x11)**\n\n**Byte = 0x14 – write specific bytes into memory depending on the C2 server response**\n\nDepending on 2 bytes received from the C2 server, the binary writes 0x100, 0x200, 0x400,\n0x800, 0x1000 or 0x2000 into memory. The first 3 cases are highlighted in figure 65:\n\nFigure 65\nThe buffer that will be exfiltrated contains a 4-byte value computed from a GetTickCount\nfunction call, the “AppID” value and a marker value (0x81 in this case):\n\nFigure 66\n\n**Byte = 0x15 – listen on port 8080 and record all connections that are established on this port**\n\nA new thread is created using the CreateThread routine:\n\n\n-----\n\nFigure 67\nThe process creates a new socket using the socket API. The inet_addr function is utilized to\nconvert a string containing an IP dotted-decimal address into a proper address for the\nIN_ADDR structure, as shown below:\n\nFigure 68\nThere is a mistake done by the malware developers because they’ve called the inet_addr\nroutine with the C2 server as the parameter (and not an IP as above). This function call\nreturns INADDR_NONE (0xFFFFFFFF):\n\nFigure 69\nThe binary associates the local address with the socket created before using the bind API:\n\nFigure 70\nThe listen function is used to place the socket in a listening state for incoming connections:\n\nFigure 71\nThe malware was supposed to connect to the C2 server using the connect API, however,\ndue to the implementation mistake, this function call fails:\n\n\n-----\n\nFigure 72\nFor the sake of the analysis, we’ve emulated an external connection from a remote IP to the\nlocal host on port 8080. The getpeername API is utilized to extract the address of the peer to\nwhich the socket is connected:\n\nFigure 73\nThe inet_ntoa routine is the opposite of inet_addr and it’s used to convert an IP from a hex\nform into an ASCII string (dotted-decimal format):\n\nFigure 74\ngetsockname is utilized to retrieve the local name for the socket:\n\nFigure 75\ninet_ntoa is used again to convert the IP address from hex to dotted-decimal format, as\nhighlighted in figure 76:\n\nFigure 76\nThe final buffer that will be exfiltrated contains some details about the network connection\n(source and destination IPs/ports) and the string “listen”:\n\nFigure 77\n\n\n-----\n\nIt s important to mention that because of the bug, only this behavior is expected, however,\nthere are other execution flows as well. For example, if no connection is established, the\nmalware only copies the string “idle” in the buffer. If the connection to the C2 server is\nsuccessful, then the string “connect” would have been copied into the final buffer. Finally, if\nthe connection is successful and the process accepts another connection on port 8080, the\nstring “accept” is copied into the buffer as well.\n\n**Byte = 0x16 – create a named pipe and wait for connections**\n\nThe file creates a new named pipe using the CreateNamedPipeA routine (0x40040003 =\n**FILE_FLAG_OVERLAPPED | WRITE_DAC | PIPE_ACCESS_DUPLEX, 0x6 =**\n**PIPE_TYPE_MESSAGE | PIPE_READMODE_MESSAGE):**\n\nFigure 78\nA new unnamed event object is created by the backdoor:\n\nFigure 79\nThe binary enables the pipe to wait for connections from client processes, as displayed\nbelow:\n\nFigure 80\nWhether the C2 server specifies the “off” parameter in the network traffic, the malware calls\nthe DisconnectNamedPipe API:\n\nFigure 81\nThe buffer that will be exfiltrated is similar to the one presented in figure 66.\n\n\n-----\n\n**Byte = 0x20 – extract timestamps for a file mentioned by the C2 server**\n\nThe FindFirstFileA routine is utilized to locate a file specified by the C2 server in the network\ntraffic:\n\nFigure 82\nThe malicious process converts the file time to system time format using\nFileTimeToSystemTime:\n\nFigure 83\nThe GetTimeFormatA API is utilized to convert the time from above to a time string (0x800 =\n**LOCALE_SYSTEM_DEFAULT, 0x80000000 = LOCALE_NOUSEROVERRIDE):**\n\nFigure 84\nThe GetDateFormatA API is utilized to convert the date from above to a date string (0x800 =\n**LOCALE_SYSTEM_DEFAULT, 0x80000000 = LOCALE_NOUSEROVERRIDE):**\n\nFigure 85\nThe final buffer that will be exfiltrated contains the file name, file creation date and time, and\nthe length of the file content:\n\nFigure 86\n\n\n-----\n\nIf any error occurs during an operation such as creating a file, opening a file, and so in all\nstudied cases, the malware formats the error message using FormatMessageA and copies it\nto the final buffer (0x1000 = FORMAT_MESSAGE_FROM_SYSTEM, 0x2 =\n**ERROR_FILE_NOT_FOUND):**\n\nFigure 87\n**Byte = 0x21 – move a file to a new file**\n\nThe response from the C2 server contains 2 file names. The process moves the first file to\nthe second one by calling the MoveFileA API:\n\nFigure 88\nThe buffer that will be exfiltrated is similar to the one presented in figure 66.\n\n**Byte = 0x22 – copy a file to a new file**\n\nThe response from the C2 server contains 2 file names. The malware copies the first file to\nthe second one by calling the CopyFileA API:\n\nFigure 89\nThe buffer that will be exfiltrated is similar to the one presented in figure 66.\n\n**Byte = 0x23 – delete a file**\n\nThe response from the C2 server contains a file name. The binary deletes the file using the\nDeleteFileA function:\n\nFigure 90\nThe buffer that will be exfiltrated is similar to the one presented in figure 66.\n\n\n-----\n\n**Byte = 0x24 – retrieve the current directory for the process**\n\nGetCurrentDirectoryA is used to extract the current directory for the process:\n\nFigure 91\nThe final buffer that will be exfiltrated contains the path extracted above:\n\nFigure 92\n\n**Byte = 0x25 – create a directory**\n\nThe response from the C2 server contains a directory name. The backdoor creates the new\ndirectory using the CreateDirectoryA routine:\n\nFigure 93\nThe buffer that will be exfiltrated is similar to the one presented in figure 66.\n\n**Byte = 0x26 – delete a directory**\n\nThe response from the C2 server contains a directory name. The binary deletes the directory\nusing the RemoveDirectoryA routine:\n\nFigure 94\nThe buffer that will be exfiltrated is similar to the one presented in figure 66.\n\n**Byte = 0x27 – change the current directory for the process**\n\nThe response from the C2 server contains a directory name. The process changes the\ncurrent directory for the process to this directory:\n\nFigure 95\nThe buffer that will be exfiltrated is similar to the one presented in figure 66.\n\n\n-----\n\n**Byte = 0x28 – set the current directory for the process to the %TEMP% folder**\n\nGetTempPathA is utilized to retrieve the path of the %TEMP% directory:\n\nFigure 96\nThe file changes the current directory for the process using the SetCurrentDirectoryA API:\n\nFigure 97\n**Byte = 0x29 – retrieve the valid drives on the system and their type**\n\nThe valid drives on the system are extracted by calling the GetLogicalDriveStringsA function:\n\nFigure 98\nThe backdoor extracts the type of the drive using the GetDriveTypeA API, as displayed in\nfigure 99.\n\nFigure 99\nThe final buffer that will be exfiltrated contains the drives name and a string that categorizes\ntheir type:\n\nFigure 100\n\nThe following strings are hard-coded and indicate the type of drives: unk\n(DRIVE_UNKNOWN), nrt (DRIVE_NO_ROOT_DIR), rmv (DRIVE_REMOVABLE), fix\n(DRIVE_FIXED), net (DRIVE_REMOTE), cdr (DRIVE_CDROM), ram (DRIVE_RAMDISK)\nand und (most likely UNDEFINED).\n\n**Byte = 0x2A – retrieve the computer Uptime and encrypt the value**\n\nThe malware calls the GetTickCount function and stores the result in a separate buffer:\n\nFigure 101\n\n\n-----\n\nThe 4-byte value extracted above is encrypted using a custom algorithm:\n\nFigure 102\nThe final buffer that will be exfiltrated contains the result of the above encryption:\n\nFigure 103\n\n**Byte = 0x30 – retrieve the path of an executable that corresponds to a particular process ID**\n\nThe response from the C2 server contains a string with a process ID. The atoi function is\nused to convert the string to a number:\n\n\n-----\n\nFigure 104\nThe malicious binary opens the local process object that corresponds to the process ID using\nthe OpenProcess routine (0x1F0FFF = PROCESS_ALL_ACCESS):\n\nFigure 105\nEnumProcessModules is utilized to enumerate the modules of the targeted process:\n\nFigure 106\nGetModuleFileNameExA is used to retrieve the path of the file that contains a specific\nmodule. This is an interesting way to find out the path to the executable that corresponds to\nthe targeted process ID:\n\nFigure 107\nThe final buffer that will be exfiltrated contains the address of the module from above and the\npath to the executable:\n\nFigure 108\n\n**Byte = 0x31 – kill a process**\n\nThe response from the C2 server contains a string with a process ID. The backdoor opens\nthe local process object that corresponds to the process ID using the OpenProcess routine\n(0x1= PROCESS_TERMINATE):\n\n\n-----\n\nFigure 109\nThe binary kills the targeted process using TerminateProcess, as described in figure 110:\n\nFigure 110\nThe final buffer that will be exfiltrated contains the string “term” (which probably refers to\nterminate) and the process ID:\n\nFigure 111\n\n**Byte = 0x32 – create a new process**\n\nThe response from the C2 server contains a process name. The malware creates this\nprocess by calling the CreateProcessA API:\n\nFigure 112\nThe final buffer that will be exfiltrated contains the ID of the process created earlier:\n\nFigure 113\n\n**Byte = 0x33 – create a new process in the security context of the credentials received from**\nthe C2 server\n\nThe response from the C2 server contains the following data: user, password, Windows\ndomain, and process name. Two anonymous pipes are created using the CreatePipe API:\n\n\n-----\n\nFigure 114\n\nFigure 115\nGetCurrentDirectoryW is utilized to retrieve the current directory for the process:\n\nFigure 116\nThe binary creates a new process that runs in the context of the credentials extracted from\nthe network traffic via a CreateProcessWithLogonW function call:\n\nFigure 117\nThe executable extracts a handle for each module in the process created above by calling\nthe EnumProcessModules routine:\n\nFigure 118\nThere is a call to GetModuleFileNameExA that extracts the path of the file containing the\nabove module:\n\n\n-----\n\nFigure 119\nThe buffer that will be exfiltrated is similar to the one presented in figure 108.\n\n**Byte = 0x34 (same execution flow as 0x33)**\n\n**Byte = 0x40 – retrieve the current process ID, the path of the executable, the hostname, the**\nusername, and the default locale\n\nGetModuleFileNameA is utilized to extract the path of the executable of the current process:\n\nFigure 120\nThe malware retrieves the NetBIOS name of the local computer and the user name by\ncalling the GetComputerNameA and GetUserNameA functions, respectively:\n\nFigure 121\n\nFigure 122\nThe current process ID is extracted using the GetCurrentProcessId routine:\n\nFigure 123\nGetLocaleInfoA is utilized to retrieve information about the default locale for the user or\nprocess (0x400 = LOCALE_USER_DEFAULT):\n\nFigure 124\n\n\n-----\n\nThe final buffer that will be exfiltrated contains the current process ID, the path of the\nexecutable, the hostname, the username, the “AppID” value, the C2 server, the HTTP\nmethod used during network communications, the pipe name mentioned in Case1 of Data\nExfiltration, and the user’s language (English – United States):\n\nFigure 125\n\n**Byte = 0x41 –retrieve the current process ID, the path of the executable, the hostname, the**\nusername, and the default locale\n\nGetModuleFileNameA is utilized to extract the path of the executable of the current process:\n\nFigure 126\nThe GetComputerNameA and GetUserNameA APIs are used to retrieve the hostname and\nthe username associated with the current thread:\n\nFigure 127\n\nFigure 128\nGetCurrentProcessId is utilized to extract the ID of the current process:\n\nFigure 129\nThe default locale for the user or process is extracted using GetLocaleInfoA (0x400 =\n**LOCALE_USER_DEFAULT):**\n\n\n-----\n\nFigure 130\nThe final buffer that will be exfiltrated contains the current process ID, the path of the\nexecutable, the hostname, the username, and the user’s language (English – United States):\n\nFigure 131\n\n**Byte = 0x48 – retrieve the hostname and username**\n\nThe malware extracts the username and hostname as before:\n\nFigure 132\n\nFigure 133\nThe final buffer that will be exfiltrated contains the hostname and username, as highlighted in\nfigure 134:\n\nFigure 134\n\n**Byte = 0x49 – exfiltrate the C2 domain name and port number**\n\nThe final buffer that will be exfiltrated contains the C2 server and the port number:\n\nFigure 135\n\n**Byte = 0x85 – close open handles**\n\nThere is only a FindClose function call regarding this case. The buffer that will be exfiltrated\nis similar to the one presented in figure 66.\n\n**Byte = 0x8B – close open handles**\n\n\n-----\n\nThis is also a cleaning case because the backdoor calls the CloseHandle API a few times.\nThe buffer that will be exfiltrated is similar to the one presented in figure 66.\n\n**Byte = 0x98 calculate the MD5 hash of the empty string**\n\nThe process computes the MD5 hash of the empty string and saves the result to the buffer\nthat will be exfiltrated:\n\nFigure 136\n\n**Byte = 0xC4 – close open handles**\n\nNo notable activity regarding this case. The buffer that will be exfiltrated is similar to the one\npresented in figure 66.\n\n**Byte = 0xC7 – close open handles and unmap a mapped view of a file**\n\nThe binary performs 2 function calls to CloseHandle and a call to UnmapViewOfFile. The\nbuffer that will be exfiltrated is similar to the one presented in figure 66.\n\n**Byte = 0xCA – close open handles**\n\nNo notable activity regarding this case. The buffer that will be exfiltrated is similar to the one\npresented in figure 66.\n\n**Byte = 0xE1 – resume a suspended thread and copy data from a pipe**\n\nThe malicious process resumes a thread that was previously suspended using the\nResumeThread routine:\n\nFigure 137\nPeekNamedPipe is utilized to copy data from a named or anonymous pipe into a buffer\nwithout removing it from the pipe:\n\nFigure 138\nWhether more data is available in the pipe, the malware reads it using the ReadFile API:\n\n\n-----\n\nFigure 139\nThe buffer that will be exfiltrated contains the data received from the pipe:\n\n**Byte = 0xE2 – copy data from a pipe**\n\n\nFigure 140\n\n\nThe executable copies data from a named or anonymous pipe into a buffer via a\nPeekNamedPipe function call:\n\nFigure 141\nThe ReadFile function is utilized to read more data from the pipe if it’s available:\n\nFigure 142\nThe buffer that will be exfiltrated contains the data received from the pipe:\n\nFigure 143\n\n**Byte = 0xE3 – kill a process**\n\nThe backdoor kills a specific process, whose handle is read from memory:\n\nFigure 144\nThe buffer that will be exfiltrated is similar to the one presented in figure 66.\n\n\n-----\n\n**Byte = 0xFE – close open handles**\n\nThe binary performs a function call to CloseHandle and closesocket. The buffer that will be\nexfiltrated is similar to the one presented in figure 66.\n\n**Byte = 0xFF – copy a string that probably represents the exit of the program**\n\nThe malware copies the string “Exiting…” to the final buffer that will be exfiltrated:\n\nFigure 145\n\nReferences\n\n[MSDN: https://docs.microsoft.com/en-us/windows/win32/api/](https://docs.microsoft.com/en-us/windows/win32/api/)\n\nVirusTotal:\nhttps://www.virustotal.com/gui/file/6057b19975818ff4487ee62d5341834c53ab80a507949a52\n422ab37c7c46b7a1\n\nFakenet: [https://github.com/fireeye/flare-fakenet-ng](https://github.com/fireeye/flare-fakenet-ng)\n\nMalwareBazaar:\nhttps://bazaar.abuse.ch/sample/6057b19975818ff4487ee62d5341834c53ab80a507949a524\n22ab37c7c46b7a1/\n\nESET: https://www.welivesecurity.com/wpcontent/uploads/2019/10/ESET_Operation_Ghost_Dukes.pdf\n\nKaspersky: https://securelist.com/miniduke-is-back-nemesis-gemina-and-the-botgenstudio/64107/\n\nCybersecurity Advisory:\nhttps://media.defense.gov/2021/Apr/15/2002621240/-1/-1/0/CSA_SVR_TARGETS_US_ALLI\nES_UOO13234021.PDF/CSA_SVR_TARGETS_US_ALLIES_UOO13234021.PDF\n\nINDICATORS OF COMPROMISE\n\nC2 server: salesappliances[.]com\n\nSHA256: 6057b19975818ff4487ee62d5341834c53ab80a507949a52422ab37c7c46b7a1\n\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like\nGecko) Chrome/47.0.2526.111 Safari/537.36 (prone to False Positives)\n\nNamed Pipe: \\\\pipe\\DefPipe\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-09-29 - How to defeat the Russian Dukes- A step-by-step analysis of MiniDuke used by APT29-Cozy Bear.pdf"
    ],
    "report_names": [
        "2021-09-29 - How to defeat the Russian Dukes- A step-by-step analysis of MiniDuke used by APT29-Cozy Bear.pdf"
    ],
    "threat_actors": [
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5b748f86-ac32-4715-be9f-6cf25ae48a4e",
            "created_at": "2024-06-04T02:03:07.956135Z",
            "updated_at": "2025-03-27T02:05:17.407352Z",
            "deleted_at": null,
            "main_name": "IRON HEMLOCK",
            "aliases": [
                "ATK7 ",
                "Blue Kitsune ",
                "Cozy Bear ",
                "The Dukes",
                "UNC2452 ",
                "YTTRIUM ",
                "APT29 "
            ],
            "source_name": "Secureworks:IRON HEMLOCK",
            "tools": [
                " CozyCar",
                " CozyDuke",
                " DiefenDuke",
                " FatDuke",
                " HAMMERTOSS",
                " LiteDuke",
                " MiniDuke",
                " OnionDuke",
                " PolyglotDuke",
                " RegDuke",
                " RegDuke Loader",
                " SeaDuke",
                " Sliver",
                "CosmicDuke"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a241a1ca-2bc9-450b-a07b-aae747ee2710",
            "created_at": "2024-06-19T02:03:08.150052Z",
            "updated_at": "2025-03-27T02:05:17.409596Z",
            "deleted_at": null,
            "main_name": "IRON RITUAL",
            "aliases": [
                "Blue Dev 5 ",
                "BlueBravo ",
                "Cloaked Ursa ",
                "CozyLarch ",
                "Dark Halo ",
                "Midnight Blizzard ",
                "NOBELIUM ",
                "StellarParticle ",
                "UNC2452 ",
                "APT29"
            ],
            "source_name": "Secureworks:IRON RITUAL",
            "tools": [
                " Cobalt Strike",
                " EnvyScout",
                " GoldFinder",
                " GoldMax",
                " NativeZone",
                " RAINDROP",
                " SUNBURST",
                " Sibot",
                " TEARDROP",
                " VaporRage",
                "Brute Ratel C4"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "46b3c0fc-fa0c-4d63-a38a-b33a524561fb",
            "created_at": "2023-01-06T13:46:38.393409Z",
            "updated_at": "2025-03-27T02:00:02.822155Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "The Dukes",
                "Minidionis",
                "Grizzly Steppe",
                "G0016",
                "Blue Kitsune",
                "BlueBravo",
                "SeaDuke",
                "Cloaked Ursa",
                "YTTRIUM",
                "ATK7",
                "Nobelium",
                "UAC-0029",
                "Group 100",
                "COZY BEAR",
                "IRON HEMLOCK",
                "TA421",
                "ITG11"
            ],
            "source_name": "MISPGALAXY:APT29",
            "tools": [
                "QUARTERRIG",
                "SNOWYAMBER",
                "HALFRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536003,
    "ts_updated_at": 1743041794,
    "ts_creation_date": 1653692646,
    "ts_modification_date": 1653692646,
    "files": {
        "pdf": "https://archive.orkl.eu/463614c13653aa1ccf24ac135855f8e33bcf8f7b.pdf",
        "text": "https://archive.orkl.eu/463614c13653aa1ccf24ac135855f8e33bcf8f7b.txt",
        "img": "https://archive.orkl.eu/463614c13653aa1ccf24ac135855f8e33bcf8f7b.jpg"
    }
}