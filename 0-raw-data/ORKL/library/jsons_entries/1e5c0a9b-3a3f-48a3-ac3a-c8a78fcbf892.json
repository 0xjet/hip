{
    "id": "1e5c0a9b-3a3f-48a3-ac3a-c8a78fcbf892",
    "created_at": "2023-01-12T15:01:52.190182Z",
    "updated_at": "2025-03-27T02:05:24.28103Z",
    "deleted_at": null,
    "sha1_hash": "ef77346648f6df70f2169118039ca4598b31ff75",
    "title": "2020-02-03 - Warzone- Behind the enemy lines",
    "authors": "",
    "file_creation_date": "2022-05-28T02:27:09Z",
    "file_modification_date": "2022-05-28T02:27:09Z",
    "file_size": 2984774,
    "plain_text": "# Warzone: Behind the enemy lines\n\n**research.checkpoint.com/2020/warzone-behind-the-enemy-lines/**\n\nFebruary 3, 2020\n**Researched by: Yaroslav Harakhavik**\n\n\nFebruary 3, 2020\n\n\nSelling malware as a service (MaaS) is a reliable way for criminals to make money. Recently, various Remote Access\nTools (RAT) have become increasingly popular. Though these RATs are marketed as malicious tools, their vendors like\npretending that they simply sell legitimate software for system administrators, and offer different subscription plans and\ncustomer support. Some of them even include a license agreement and terms of use. The developers of such tools are\nconstantly improving them and adding new features, resulting in increasingly sophisticated RATs.\n\nIn our report, we describe Warzone RAT, whose developers provide a wide range of different features.\n\n## OSINT\n\nThe first Warzone RAT advertisement publicly emerged during autumn 2018 on warzone[.]io (not accessible as of the\nwriting of this article). Currently, the selling service is hosted on warzone[.]pw.\n\nMalware actors also operate a dynamic DNS service at warzonedns[.]com.\n\nAccording to the description from the website, the malware boasts the following capabilities and features:\n\n\n-----\n\nDoes not require .NET.\nRemote desktop available via VNC.\n[Hidden Remote desktop available via RDPWrap.](https://github.com/stascorp/rdpwrap/)\nPrivilege escalation (even for the latest Win10 updates)\nRemote WebCam control.\nPassword grabber (Chrome, Firefox, IE, Edge, Outlook,\nThunderbird, Foxmail)\nDownload & Execute any files.\nLive Keylogger with Offline Keylogger.\nRemote Shell.\nFile manager.\nProcess Manager.\nReverse Proxy\n\n**Figure 1 – The advertisement on warzone[.]io.**\n\n\n-----\n\n**Figure 2 – The most recent advertisement on warzone[.]pw.**\n\nThe web-site also offers different ways to contact the malware actor:\n\nsolmyr[@]xmpp[.]jp via XMPP.\nsolmyr[@]warzone[.]pw via email.\nlive:solmyr_12 and live:ebase03_1 via Skype.\nsolmyr#4699 and EBASE#6769 via Discord.\n\nBuyers can choose one of three subscription plans:\n\n_Starter: 1 month, with RAT only functionality._\n_Professional: 3 months, with premium DDNS and customer support._\n_WARZONE RAT – POISON: 6 months, with premium DDNS, premium customer support and Rootkit which hides_\nprocesses, files and startup.\n\n\n-----\n\n**Figure 3 – Subscription plan selection on warzone[.]pw.**\n\nIn addition, the creators offer two more options:\n\n_Exploit builder – Allows embedding malware to a DOC file._\n_Crypter – Packs malware to hide it from AV scanners._\n\n**Figure 4 – Exploit and Crypter subscription plans**\n\nThere is also a publicly available knowledge base, which contains guidelines for using the WarzoneRAT builder. The\nconfiguration guides include “Building a Client”, “HDRP lost password and username”, “Keylogger”, etc.\n\n\n-----\n\n**Figure 5 – Knowledge Base of warzone[.]pw.**\n\nIt is possible to find Warzone bundles on VirusTotal. Probably they were leaked by the customers themselves.\n\n\n-----\n\n**Figure 6 – Leaked Warzone Bundles search**\n\n## Technical Details\n\n**Warzone is a RAT which is written in C++ and compatible with all Windows releases.**\n\n[The malware developers have a dynamic DNS service at warzonedns[.]com, which means buyers aren’t affected by IP](https://en.wikipedia.org/wiki/Dynamic_DNS)\naddress changes.\n\nWarzone bypasses UAC (User Account Control) to disarm Windows Defender and puts itself into the list of startup\nprograms. Finally, it runs a routine to handle C&C commands. In our report, we focus on each of these actions.\n\nThere are several different versions of Warzone and the malware is constantly being improved. Some of the described\nfeatures can differ according to version\n\n## Bypassing UAC\n\nIf Warzone RAT runs with elevated privileges, it adds a whole C:\\ path to exclusions of Windows Defender, utilizing the\nfollowing PowerShell command:\n\n```\npowershell Add-MpPreference -ExclusionPath C:\\\n\n```\n\nOtherwise, the malware bypasses UAC and escalates privileges with two different approaches – one for Windows 10\nand the other for older versions:\n\nFor the versions below Windows 10, it uses a UAC bypass module which is stored in its resources.\nFor Windows 10, it [abuses the auto-elevation feature of sdclt.exe which is used in the context of Windows backup](https://blog.sevagas.com/?Yet-another-sdclt-UAC-bypass)\nand restore mechanisms.\n\n\n-----\n\n**Figure 7 – Beginning of Warzone workflow.**\n\n**Figure 8 – UAC bypass strategies.**\n\n### Windows 10 UAC bypass\n\nWhen `sdclt.exe is called from a medium integrity process (i.e. the process with standard user rights), the following`\nevents occur:\n\n\n-----\n\n1. It runs another process, `sdclt.exe, with high privilege.`\n2. The high privilege `sdclt process calls` `C:\\Windows\\System32\\control.exe.`\n3. The `control.exe process runs with high privilege and tries to open`\n```\n   HKCU\\Software\\Classes\\Folder\\shell\\open\\command registry value which is not found.\n\n```\n[The malware performs COM hijacking by setting the path to itself to the](https://devblogs.microsoft.com/oldnewthing/?p=14623)\n```\nHKCU\\Software\\Classes\\Folder\\shell\\open\\command key with a DelegateExecute parameter.\n\n```\nBasically, these actions can be substituted with the following commands:\n\n```\nreg add \"HKCU\\Software\\Classes\\Folder\\shell\\open\\command\" /d \"<PATH_TO_MALWARE>\" /f\n\n```\n```\nreg add HKCU\\Software\\Classes\\Folder\\shell\\open\\command /v \"DelegateExecute\" /f\n\n```\n\nFinally, the malware terminates itself. It will be run with elevated privileges by `sdclt.exe.`\n\n**Figure 9 – Windows 10 UAC bypass.**\n\n### UAC bypass in OS versions prior to Windows 10\n\n[For Windows versions below Windows 10, the malware performs an IFileOperation exploit by Leo Davidson.](https://github.com/L3cr0f/DccwBypassUAC#3-usage)\n\nFirst, it creates a registry hive `_rptls in HKCU\\SOFTWARE. This includes a value Install with the path to itself`\n\n**Figure 10 – HKCU\\SOFTWARE\\Install.**\n\nThen, the malware loads an executable file from WM_DSP resource and runs a shellcode that contains\napproximately1500 bytes (after decrypting it with XOR 0x45).\n\n\n-----\n\nThe shellcode resolves some functions, runs an instance of cmd.exe in a suspended state and performs a process\nreplacement `(ZwUnmapViewOfSection – VirtualAllocEx – GetThreadContext – WriteProcessMemory –`\n```\nSetThreadContext).\n\n```\n**Figure 11 – Resolving functions in the shellcode**\n\n[The code which is responsible for UAC bypass is taken from AVE_MARIA malware.](https://blog.yoroi.company/research/the-ave_maria-malware/)\n\nThe following snippets show how the privilege escalation is performed in the context of `cmd.exe .`\n\n**Figure 12 – New entry point of cmd.exe after process replacement**\n\n\n-----\n\nThe malware extracts `dismcore.dll from its WM_DISM resource and drops it to %TEMP% directory along with the`\nxml file ellocnak.xml .\n\n**Figure 13 – Dropping** `ellocnak.xml with a configuration.`\n\nThen it masquerades PEB (Process Environment Block) to invoke IFileOperation at a high integrity level.\n\n**Figure 14 – Masquerading PEB.**\n\n[In the next step, it uses pkgmgr.exe to load a dismcore.dll with elevated privileges.](https://github.com/L3cr0f/DccwBypassUAC/blob/release/DccwBypassUAC/DccwBypassUAC/DccwBypassUAC.cpp#L571)\n\n\n-----\n\n**Figure 15 – Privilege elevation.**\n\nThe loaded DLL retrieves the path to the Warzone malicious file from `HKCU\\SOFTWARE\\_rptls\\Install, iterates`\nthrough running processes and kills the Warzone process if it already exists. Then it runs the Warzone executable\nagain, this time with Admin privileges.\n\n## Persistence\n\nThe malware copies itself to `C:\\Users\\User\\AppData\\Roaming\\<INSTALL_NAME>.exe and adds this path to`\n```\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run . By default the <INSTALL_NAME> is images.exe, but\n\n```\nWarzone’s builder allows specifying any name of this executable file.\n\nIt also creates a registry hive `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\UIF2IS2OVK and`\nputs a pseudo-random generated sequence of 256 bytes under the inst value there.\n\nIf the malware was run without Admin privilege and it hasn’t been already terminated by its elevated instance, it copies\nitself to `C:\\ProgramData\\<PREDEFINED_NAME> and simply runs itself again from the new location.`\n\n## Network Communication\n\nThe malware communicates with its C&C server via TCP over the 5200 port. The packets’ payload is encrypted with\nRC4 using the password “warzone160\\x00” (the final null terminator is used as a part of the encryption key).\n\nThe layout of an unencrypted packet:\n\n\n-----\n\n**Figure 16 – Unencrypted packet structure.**\n\nExample: unencrypted response packet:\n\n**Figure 17 – A response from the Warzone server.**\n\n**Table 1 – Response packet fields**\n\n**Offset** **Size** **Info**\n\n0x00 4 bytes Magic number\n\n0x04 4 bytes Payload size\n\n0x08 4 bytes Packet ID\n\n0x0C [Payload size] Payload data\n\nEven though Warzone is supposed to encrypt its TCP packets, some versions use non-encrypted communication.\n\n**Figure 18 – Encrypted and Non-encrypted Warzone TCP streams.**\n\nThe strings in packet payload are stored in the following format:\n\n**Figure 19 – BSTR structure layout.**\n\nThe malware decrypts the C&C server domain and tries to connect to it. After the server accepts the connection, it\nsends a packet with the message ID = 0 and an empty payload to the client. In return, the malware collects information\nabout the infiltrated computer and sends it back to the server in a response packet. This packet contains the following\ndata:\n\n\n-----\n\nSHA 1 of `MachineGUID`\nCampaign ID.\nOS version.\nAdmin status.\nIs WOW64 process.\nPC name.\nMalware storage path.\n[MurmurHash3 of the malicious file.](https://github.com/aappleby/smhasher/wiki/MurmurHash3)\nRAM size.\nCPU information.\nVideo controller information.\n\nThe bot ID is a SHA-1 hash of `MachineGUID registry value in` `HKLM\\Software\\Microsoft\\Cryptography.`\n\nThe bot then waits for further commands from the server. Server message IDs are even numbers from 0x00 to 0x3C.\nThe bot’s packets are represented by add IDs from 0x01 to 0x3B. Some commands (such as a command to terminate\nthe bot) are not supposed to have an answer in the response or else contain an empty payload.\n\nBasically, the bot provides the attacker with an ability to control an infected PC using a remote shell, RDP or VNC\nconsole. It provides remote task and file managers, streams the desktop to the attacker, allows using a web camera,\nand more.\n\n### Network communication messages:\n\nThe following table contains the majority of message codes that a client and a server exchange with each other. The\ncodes can be slightly different across Warzone versions.\n\n**ID** **Source** **Info**\n\n0x00 C&C Machine Info Request\n\n0x01 BOT Machine Info Response\n\n0x02 C&C Enumerate Processes Request\n\n0x03 BOT Enumerate Processes Response\n\n0x04 C&C Enumerate Disks Request\n\n0x05 BOT Enumerate Disks Response\n\n0x06 C&C List Directory\n\n0x07 BOT List Directory\n\n0x08 C&C Read File\n\n0x09 BOT Read File\n\n0x0A C&C Delete File Request\n\n0x0B BOT Delete File Response\n\n0x0C C&C Kill Process\n\n0x0E C&C Remote Shell Request\n\n0x0F BOT Remote Shell Response\n\n0x11 BOT Get Connected Cameras Response\n\n0x12 C&C Get Connected Cameras Request\n\n\n-----\n\n0x13 C&C Camera BMP Frame Transmission\n\n0x14 C&C Start Camera\n\n0x15 BOT Heartbeat (per 20 sec)\n\n0x16 C&C Stop Camera\n\n0x17 BOT VNC port setup Response\n\n0x18 C&C Heartbeat (per 20 sec)\n\n0x19 BOT Browsers’ Passwords Recovery Response\n\n0x1A C&C Uninstall Bot\n\n0x1C C&C Upload File\n\n0x1D BOT RDP Response\n\n0x1E C&C Send Executable File to a Client\n\n0x20 C&C Browsers’ Passwords Recovery\n\n0x22 C&C Download & Execute Request\n\n0x24 C&C Keylogger (Online)\n\n0x25 BOT Download & Execute Response\n\n0x26 C&C Keylogger (Offline)\n\n0x28 C&C RDP\n\n0x2A C&C Reverse Proxy Start\n\n0x2C C&C Reverse Proxy Stop\n\n0x30 C&C VNC port setup Request\n\n0x32 C&C VNC Stop\n\n0x33 C&C Escalate Privileges\n\n0x38 C&C Reverse Sock Port Setup Request\n\n0x3A C&C Run file (cmd /c open <file_path>)\n\n0x3B BOT Get Log storage path Response\n\n0x3C C&C Get Log storage path Request\n\n### Some examples of C&C-to-Bot communication\n\n**Request information about an infected machine**\n\nC&C Request ID: 0x00\n\nBOT Response ID: 0x01\n\nRequest Payload Layout: None\n\nResponse Payload Layout\n\n\n-----\n\n**Enumerate Processes**\n\nC&C Request ID: 0x02\n\nBOT Response ID: 0x03\n\nRequest Layout: None\n\nResponse Payload Layout:\n\n**Enumerate Drives**\n\nC&C Request ID: 0x04\n\nBOT Response ID: 0x05\n\nRequest Payload Layout: None\n\nResponse Payload Layout:\n\nRequest example:\n\nResponse example:\n\n**List Directory**\n\nC&C Request ID: 0x06\n\nBOT Response ID: 0x07\n\nRequest Payload Layout:\n\nResponse Payload Layout:\n\nIf empty: None;\n\n\n-----\n\nIf not empty:\n\nRequest example:\n\nResponse example:\n\n**Delete File**\n\nC&C Request ID: 0x0A\n\nBOT Response ID: 0x0B\n\nRequest Payload Layout:\n\nResponse Payload Layout:\n\nRequest example:\n\nResponse example:\n\n**Browsers’ Passwords Recovery**\n\nC&C Request ID: 0x20\n\nBOT Response ID: 0x19\n\nRequest Payload Layout: None\n\nResponse Payload Layout:\n\n\n-----\n\nRequest example:\n\nResponse example:\n\n**Download & Execute**\n\nC&C Request ID: 0x22\n\nBOT Response ID: None\n\nRequest Payload Layout:\n\nResponse Payload Layout: None\n\n**Terminate Bot**\n\nC&C Request ID: 0x1A\n\nBOT Response ID: None\n\nRequest Payload Layout: None\n\nResponse Payload Layout: None\n\n## Administration Panel & Builder\n\nOne of the leaked Warzone panels/builders represents Warzone version 1.84. It is written in .NET and is obfuscated by\na custom obfuscator.\n\n\n-----\n\n**Figure 20 – Warzone panel.**\n\nThe code is obfuscated by numerous arithmetical calculations and switch constructions that do not influence the control\nflow and are supposed to hide the useful instructions.\n\nFor example, the constructor of the class in Figure 21 (below) has 365 lines of code which do only one thing: assign\nthe constructor argument to a class member.\n\n**Figure 21 – Decompiled panel code.**\n\nFrom the context menu of the corresponding bot, the buyer can fully control the infected machine using remote\ncommand line, process/file manager and other features.\n\n\n-----\n\n**Figure 22 – Context menu of a bot record.**\n\nThe panel bundle contains the following items:\n\n`Warzone RAT*.exe and` `Warzone RAT*.exe.config` .NET assembly and configuration file of the panel.\nLegitimate libraries `license.dll and` `PETools.dll.`\nLicense file license.dat .\nClient stub `cratclient.bin (cb6d6f17c102a8288704fe38dd9e2cf9) for the builder.`\nDirectory Clients contains data which is specific for each client: downloaded files, logs, RDP passwords, etc.\n[Directory Datas contains mostly legitimate software such as RDPWrap libraries, SQLite library, VNC clients](https://github.com/stascorp/rdpwrap/)\n[(TightVNC and](https://www.tightvnc.com/) [TigerVNC clients) and so on. These files are transferred to a client when the corresponding](https://tigervnc.org/)\nfeature is triggered.\n\n**Figure 23 – Content of the panel bundle.**\n\n## Conclusion\n\nThough Warzone is represented as a legitimate tool, similar to other popular RATs, it is practically an ordinary Trojan\nwith functionality similar to other RATs. It can be distributed by other malicious software or via spam mail.\n\nOn the other hand, unlike many other popular RATs (e.g. NanoCore, Remcos, etc.) which are developed using .NET,\nWarzone was written with object-oriented C++ code. Warzone also has its own network protocol over TCP instead of\nusing HTTP communication. In addition to a custom network protocol and a nice network infrastructure, Warzone\nincludes 2 different UAC bypass approaches which are quite reliable for Windows 10 and prior versions.\n\nIn general, the malware-as-a-service approach is currently very popular. More and more frequently, many ordinary\nTrojans are sold with an existing infrastructure and constant support from their developers. Such a centralized\narchitecture makes it easier and more convenient for threat actors to reinforce new malicious campaigns.\n\nCheck Point protections keep our customers secure from attacks by Warzone and other remote access tools.\n\n\n-----\n\n## IOCs\n\n**Sample** **[examples](https://www.kernelmode.info/forum/viewtopic8b5f.html?f=16&t=5525)**\n\n**SHA256**\n\n531d967b9204291e70e3aab161a5b7f1001339311ece4f2eed8e52e91559c755\n\na03764da06bbf52678d65500fa266609d45b972709b3213a8f83f52347524cf2\n\n263433966d28f1e6e5f6ae389ca3694495dd8fcc08758ea113dddc45fe6b3741\n\n**Strings**\n\n**String** **Type**\n\nwarzone160 ASCII\n\nAVE_MARIA ASCII\n\nWM_DSP ASCII\n\nWM_DISP ASCII\n\n**Processes**\n\n**Command Line**\n\npowershell Add-MpPreference -ExclusionPath C:\\\n\n**Registry Detection**\n\n**Registry Path** **Registry Key** **Values**\n\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet\nSettings\n\n\nMaxConnectionsPer1_0Server 10\n\nMaxConnectionsPerServer 10\n\n\nHKCU\\Software\\_rptls Install <PATH_TO_MALWARE>\n\n**File System Detection**\n\n**File Name** **Comments**\n\n%LOCALAPPDATA%\\Microsoft Vision\\ Directory\n\n\n%LOCALAPPDATA%\\Microsoft Vision\\([0-2][0-9]|(3)[0-1])(-)(((0)[0-9])|((1)[0-2]))\n(-)\\d{4}_(?:[01]\\d|2[0123])\\.(?:[012345]\\d)\\.(?:[012345]\\d)\n\n**C&C servers**\n\n**Domains** **Communication Type**\n\n*.warzonedns[.]com TCP over 5200\n\n## Check Point Signatures\n\n\nRegex for datetime in format:\nDD-MM-YYYY_HH.mm.SS\n\n\n-----\n\n**Product** **Detect Name**\n\nAnti-Bot Trojan.Win32.Warzone.E\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-03 - Warzone- Behind the enemy lines.pdf"
    ],
    "report_names": [
        "2020-02-03 - Warzone- Behind the enemy lines.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535712,
    "ts_updated_at": 1743041124,
    "ts_creation_date": 1653704829,
    "ts_modification_date": 1653704829,
    "files": {
        "pdf": "https://archive.orkl.eu/ef77346648f6df70f2169118039ca4598b31ff75.pdf",
        "text": "https://archive.orkl.eu/ef77346648f6df70f2169118039ca4598b31ff75.txt",
        "img": "https://archive.orkl.eu/ef77346648f6df70f2169118039ca4598b31ff75.jpg"
    }
}