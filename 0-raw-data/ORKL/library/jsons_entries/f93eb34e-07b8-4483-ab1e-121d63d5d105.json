{
    "id": "f93eb34e-07b8-4483-ab1e-121d63d5d105",
    "created_at": "2022-10-25T16:48:20.659952Z",
    "updated_at": "2025-03-27T02:16:06.54894Z",
    "deleted_at": null,
    "sha1_hash": "d1eece026635773310f0aa00e05898db7853dab0",
    "title": "",
    "authors": "",
    "file_creation_date": "2019-01-17T03:13:47Z",
    "file_modification_date": "2019-01-17T03:13:47Z",
    "file_size": 2084418,
    "plain_text": "# RESEARCH\n\n### 数 据 驱 动 安 全\n\n\n### Latest Target Attack of DarkHydruns Group Against Middle East\n\n2019-01-16 By 360威胁情报中心 | 事件追踪\n\n#### Background\n\n360 Threat Intelligence Center captured several lure Excel documents written in Arabic in January 9,\n\n2019. A backdoor dropped by macro in the lure documents can communicate with C2 server through DNS\n\ntunnel, as well as Google Drive API.\n\nWe confirmed that this is a DarkHydrus Group’s new attack targeting Middle East region. In July 2018,\n\nPalo Alto disclosed DarkHydrus Group which showed its special interest to governments in Middle East[1].\n\nPrior to that report, we published detail analysis on malware exploiting CVE-2018-8414 vulnerability\n\n(remote code execution in SettingContent-ms), which is believed a work of DarkHydrus[2].\n\n#### Timeline\n\nTimeline of activities of DarkHydrus Group:\n\n## \n\n\n-----\n\n#### Dropper（Macros）\n\nMD5 5c3f96ade0ea67eef9d25161c64e6f3e\n\nFilename ﺍﻟﻔﻬﺎﺭﺱ.xlsm（indexes. xlsm）\n\nMD5 8dc9f5450402ae799f5f8afd5c0a8352\n\nFilename ﺍﻻﻁﻼﻉ.xlsm（viewing. xlsm）\n\nThis malware is a lure Excel document with name ‘ﺍﻟﻔﻬﺎﺭﺱ.xlsm’. When it is opened, embedded VBA\n\nmacro is trigged to run. That macro drops 12-B-366.txt to ‘%TEMP%’ directory first, then leverages\n\nregsvr32.exe to run 12-B-366.txt\n\n12-B-366.txt is a HTA (HTML application) file, which will drop a PowerShell script to %TEMP%\\\\\n\nWINDOWSTEMP.ps1\n\nFinally, the PowerShell script drops %TEMP%\\\\OfficeUpdateService.exe for execution by extracting\n\nBased64-encoded content.\n\n## \n\n\n-----\n\n#### Backdoor（OfficeUpdateService.exe）\n\nMD5 b108412f1cdc0602d82d3e6b318dc634\n\nFilename OfficeUpdateService.exe\n\nC:\\Users\\william\\Documents\\Visual Studio 2015\\Projects\\DNSProject\\DNSProject\\obj\\Relea\nPDB path\nse\\DNSProject.pdb\n\nThis backdoor is written in C#：\n\nThe PDB path has a project name ‘DNSProject’, which illustrates that the malware may leverage some\n\nDNS techniques to achieve its goal.\n\nC:\\Users\\william\\Documents\\Visual Studio\n\n2015\\Projects\\DNSProject\\DNSProject\\obj\\Release\\DNSProject.pdb\n\nThe backdoor checks if ‘st:off’ and ‘pd:off’ is given as paramters. If ‘st:off’ presents, no persistence\n\nentry is added; PDF file is not dropped if ‘pd:off’ exists. Then it detects existence of virtual machine and\n\nsandbox before malicious payload is triggered.\n\n## \n\n\n-----\n\nA registry entry is added for persistence：\n\nIt can drop a PDF file：\n\nCodes of virtual machine detection, sandbox detection and anti-debug are following,\n\n\n## \n\n\n-----\n\nNext, the backdoor will collect host name\n\n\n## \n\n\n-----\n\nThe backdoor will send collected information to C2 server through DNS tunnel. queryTypesTest function\n\nis created for DNS tunnel communication.\n\nThen, the backdoor tries to retrieve commands from C2 server via DNS tunnel, then through HTTP if\n\nfailed.\n\nAfter C2 commands is retrieved successfully, commands are dispatched by taskHandler.\n## \n\n\n-----\n\nScreenshot of a part of C2 commands\n\n“^\\\\$x_mode” command sets file server address which is sent in DNS tunnel.\n\n\n## \n\n\n-----\n\nOne file server is Google Drive\n\nhttps://www.googleapis.com/upload/drive/v3/files/\" + file_id + \"?\n\nsupportsTeamDrive=true&uploadType=resumable&fields=kind,id,name,mimeType,parents\n\nAll command lists are following：\n\nCommand Feature\n\n^kill Kill thread or process\n\n^\\$fileDownload Download file\n\n^\\$importModule Import module\n\n^\\$x_mode In x_mode，configure C2 address，then send RAT data to C2 by HTTP protocol\n\n^\\$ClearModules Remove module\n\n^\\$fileUpload Upload file\n\n^testmode Test module\n\n^showconfig Show configuration \n\n\n-----\n\n^slp Sleep\n\n^exit Exit process\n\n#### DNS Tunnel\n\nDNS tunnel is a C2 communication technique in which malware send data and retrieve commands by\n\nDNS query packets. This technique is very effective since most gateways or firewalls allow both ingress\n\nand egress DNS traffic.\n\nIf C2 server is assigned in the format of IP address in malware body, malware can contact C2 directly.\n\nBut OfficeUpdateService.exe backdoor has C2 server in the format of DNS name, which requires a DNS\n\nresolution to C2 domain name first. To do that, the backdoor queries C2 domain in specific name server.\n\nThen the backdoor communicates C2 server in DNS tunnel.\n\nC2 domain names are following：\n\nName Server\n\nMalware sends DNS queries to these two name servers for C2 domain name resolution:\n\n‘tvs1.trafficmanager.live’ and ‘tvs2.trafficmanager.live’\n\nMalware uses nslookup to send out DNS query, with following parameters: ‘timeout’ and ‘q’ for DNS\n\nrecord type\n\n## \n\n\n-----\n\nC&C Commands\n\nTo parse C2 commands from above types of DNS records, the malware uses different regular\n\nexpressions. For example, if commands are sent back in DNS A record, the malware will use following\n\nregular expression:\n\nMalware will retrieve a process ID as victim ID, then treats victim ID as subdomain name in C2\n\ncommunication.\n\n## \n\n\n-----\n\nWe manually send out a DNS TXT query with victim ID as illustration.\n\nA domain name ‘ajpinc.akamaiedge.live’ is created. In subdomain ‘ajpinc’, ‘a’ means this is the first\n\nrequest, and ‘c’ is the character for string end, while ‘jpin’ is process ID. Then, we send DNS query by\n\nusing nslookup command as following\n\nThe malware will use following regular expression to parse out command, ([\\\\w+).\n\n(akdns.live|akamaiedge.live|edgekey.live|akamaized.live](file://w+).\n\n(akdns.live|akamaiedge.live|edgekey.live|akamaized.live)).\n\n## \n\n\n-----\n\nFinally, system configuration is sent to C2 server in DNS protocol.\n\nCommunication Rule\n\nThis malware uses following types of DNS record\n\n\nA\n\n\nAAAA\n## \n\n\n-----\n\nTXT\n\n\nSRV\n\n\nSOA\n\n\nMX\n\n\nTo parse C2 commands from above types of DNS records, the malware uses different regular\n\nexpressions. For example, if commands are sent back in DNS AC record, the malware will use following\n\nregular expression:\n\nFollowing regular expression is for commands in DNS AAAA records,\n\n## \n\n\n-----\n\nAnd there is one regular expression for several DNS record types, including CNAME, SRV, SOA,\n\n## \n\n\n-----\n\nBreakdown of regular expressions are as following,\n\nTypes of DNS record Regular expressions\n\nA Address:\\\\s+(\\\\d+.\\\\d+.\\\\d+.\\\\d+)\n\nAC ([^r-v\\\\s]+)[r-v]([\\\\w\\\\d+\\\\/=]+)-\\\\w+.(<C2DOMIAN>)\n\nAAAA Address:\\\\s+(([a-fA-F0-9]{0,4}:{1,4}[\\\\w|:]+){1,8})\n\n\nCNAME、TXT、SRV、SOA、MX\n\n\nand\n\n\n([^r-v\\\\s]+)[r-v]([\\\\w\\\\d+\\\\/=]+)-\\\\w+.(<C2DOMIAN>)\n\n(\\\\w+).(<C2DOMIAN>)\n\n\nHowever, the malware will cancel operation if commands is matched by following regular expression:\n\n\"216.58.192.174|2a00:1450:4001:81a::200e|2200::|download.microsoft.com|ntservicepack.microsoft.com|window\n\n\nsupdate.microsoft.com|update.microsoft.com\"\n\n\n## \n\n\n-----\n\n#### Attribution\n\nWe found some traces which lead us to believe that DarkHydrus is behind this attack.\n\n#### Samples with DNS Tunnel Function\n\nSimilar to the malware disclosed by Palo Alto[2], both malware use DNS tunnel technique:\n\n#### Sandbox detection and Backdoor Capability\n\nThe new malware has very similar code of detection to sandbox and virtual machine as previous\n\nDarkHydrus samples\n\nBoth samples have very similar code and functionality:\n\n## \n\n\n-----\n\n#### Pivot\n\nOne interesting finding is that, there is one Twitter user Steve Williams with handle name\n\n@darkhydrus2. It’s coincident that both ‘darkhydrus’ (APT group name) and ‘Williams’ (user name in PDB\n\npath) found in this Twitter user.\n\n## \n\n\n-----\n\n#### Summary\n\nIn recent APT incidents, more and more threat actors tend to adopt Office VBA macro instead of Office\n\n0day vulnerability in the consideration of cost reduction. It is recommended that users avoid to open\n\ndocuments from untrusted sources. And Office macro should be disabled by default.\n\nProducts of 360 ESG can protect users from this new malware, including 360 Threat Intelligence\n\nPlatform, SkyEye APT Detection, 360 NGSOC.\n\n#### IOC\n## \n\n\n-----\n\n8dc9f5450402ae799f5f8afd5c0a8352\n\n\nb108412f1cdc0602d82d3e6b318dc634\n\n\n039bd47f0fdb6bb7d68a2428c71f317d\n\n\nPDB PATH\n\n\nC:\\Users\\william\\Documents\\Visual Studio 2015\\Projects\\DNSProject\\DNSProject\\obj\\Release\\DNSProject.pdb\n\n\nC2\n\n\n0ffice365.life\n\n\n0ffice365.services\n\n\n0nedrive.agency\n\n\nakamai.agency\n\n\nakamaiedge.live\n\n\nakamaiedge.services\n\n\nakamaized.live\n\n\nakdns.live\n\n\nazureedge.today\n\n\ncloudfronts.services\n\n\ncorewindows.agency\n\n\nedgekey.live\n\n\nmicrosoftonline.agency\n\n\nnsatc.agency\n\n\nonedrive.agency\n\n\nphicdn.world\n\n\nsharepoint.agency\n\n\nskydrive.agency\n\n\nskydrive.services\n\n\nt-msedge.world\n\n\ntrafficmanager.live\n\n\n#### References\n\n[1]. https://ti.360.net/blog/articles/analysis-of-settingcontent-ms-file/\n## \n\n\n-----\n\neast-government/\n\n[3]. https://ti.360.net/\n\n[4]. https://twitter.com/craiu/status/1083305994652917760\n\n####  APT DARKHYDRUNS\n\n分享到：\n### \n\n####  [首页] Latest Target Attack of DarkHydruns Group Against Middle East\n\n## \n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2019/2019.01.16.DarkHydruns/darkhydruns-group-against-middle-east-en.pdf"
    ],
    "report_names": [
        "darkhydruns-group-against-middle-east-en"
    ],
    "threat_actors": [
        {
            "id": "4fe925e8-95e5-4a63-9f96-4d0f9bedac08",
            "created_at": "2022-10-25T15:50:23.469077Z",
            "updated_at": "2025-03-27T02:00:55.478056Z",
            "deleted_at": null,
            "main_name": "DarkHydrus",
            "aliases": [
                "DarkHydrus"
            ],
            "source_name": "MITRE:DarkHydrus",
            "tools": [
                "Mimikatz",
                "RogueRobin",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "6efb28db-4d91-46cb-8ab7-fe9e8449ccfc",
            "created_at": "2023-01-06T13:46:38.772861Z",
            "updated_at": "2025-03-27T02:00:02.914846Z",
            "deleted_at": null,
            "main_name": "DarkHydrus",
            "aliases": [
                "Obscure Serpens",
                "LazyMeerkat",
                "G0079"
            ],
            "source_name": "MISPGALAXY:DarkHydrus",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5b04780e-7b64-4e62-b776-c6749ff7dec8",
            "created_at": "2022-10-25T16:07:23.531741Z",
            "updated_at": "2025-03-27T02:02:09.84903Z",
            "deleted_at": null,
            "main_name": "DarkHydrus",
            "aliases": [
                "ATK 77",
                "DarkHydrus",
                "LazyMeerkat",
                "Obscure Serpens"
            ],
            "source_name": "ETDA:DarkHydrus",
            "tools": [
                "Agentemis",
                "Cobalt Strike",
                "CobaltStrike",
                "Mimikatz",
                "Phishery",
                "RogueRobin",
                "RogueRobinNET",
                "Trojan.Phisherly",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041766,
    "ts_creation_date": 1547694827,
    "ts_modification_date": 1547694827,
    "files": {
        "pdf": "https://archive.orkl.eu/d1eece026635773310f0aa00e05898db7853dab0.pdf",
        "text": "https://archive.orkl.eu/d1eece026635773310f0aa00e05898db7853dab0.txt",
        "img": "https://archive.orkl.eu/d1eece026635773310f0aa00e05898db7853dab0.jpg"
    }
}