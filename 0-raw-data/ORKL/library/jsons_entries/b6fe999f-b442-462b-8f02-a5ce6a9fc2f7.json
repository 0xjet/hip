{
    "id": "b6fe999f-b442-462b-8f02-a5ce6a9fc2f7",
    "created_at": "2023-01-12T15:06:59.53579Z",
    "updated_at": "2025-03-27T02:05:24.02432Z",
    "deleted_at": null,
    "sha1_hash": "62fe0eeeccab34989c445ee7e6da6eeaf81774c5",
    "title": "2021-06-17 - Black Kingdom ransomware",
    "authors": "",
    "file_creation_date": "2022-05-28T15:20:22Z",
    "file_modification_date": "2022-05-28T15:20:22Z",
    "file_size": 2946426,
    "plain_text": "# Black Kingdom ransomware\n\n**securelist.com/black-kingdom-ransomware/102873/**\n\nAuthors\n\n[Marc Rivero](https://securelist.com/author/marcrivero/)\n\n## Python-coded malware used in Microsoft Exchange Server exploitation\n\nBlack Kingdom ransomware appeared on the scene back in 2019, but we observed some\nactivity again in 2021. The ransomware was used by an unknown adversary for exploiting a\nMicrosoft Exchange vulnerability (CVE-2021-27065).\n\nThe complexity and sophistication of the Black Kingdom family cannot bear a comparison\nwith other Ransomware-as-a-Service (RaaS) or Big Game Hunting (BGH) families. The\nransomware is coded in Python and compiled to an executable using PyInstaller; it supports\ntwo encryption modes: one generated dynamically and one using a hardcoded key. Code\nanalysis revealed an amateurish development cycle and a possibility to recover files\nencrypted with Black Kingdom with the help of the hardcoded key. The industry already\n[provided a script to recover encrypted files in case they were encrypted with the embedded](https://blog.cyberint.com/black-kingdom-ransomware)\nkey.\n\n## Background\n\n\n-----\n\nThe use of a ransomware family dubbed Black Kingdom in a campaign that exploited the\n[CVE-2021-27065 Microsoft Exchange vulnerability known as ProxyLogon was](https://proxylogon.com/) publicly\nreported at the end of March.\n\nAround the same time, we published a story on another ransomware family used by the\nattackers after successfully exploiting vulnerabilities in Microsoft Exchange Server. The\nransomware family was DearCry.\n\nAnalysis of Black Kingdom revealed that, compared to others, it is an amateurish\nimplementation with several mistakes and a critical encryption flaw that could allow\ndecrypting the files due to the use of a hardcoded key. Black Kingdom is not a new player: it\nwas observed in action following other vulnerability exploitations in 2020, such as CVE-201911510.\n\n**Date** **CVE** **Product affected**\n\n\nJune\n2020\n\nMarch\n2021\n\n\nCVE-2019-11510 Pulse Secure\n\n\nCVE-2021-26855, CVE-2021-26857, CVE-2021-26858,\nCVE-2021-27065\n\n\nMicrosoft Exchange\nServer\n\n\n## Technical analysis\n\n### Delivery methods\n\nBlack Kingdom’s past activity indicates that ransomware was used in larger vulnerability\n[exploitations campaigns related to Pulse Secure or Microsoft Exchange. Public reports](https://twitter.com/malwaretechblog/status/1373648027609657345)\nindicated that the adversary behind the campaign, after successfully exploiting the\nvulnerability, installed a webshell in the compromised system. The webshell enabled the\nattacker to execute arbitrary commands, such as a PowerShell script for downloading and\nrunning the Black Kingdom executable.\n\n### Sleep parameters\n\nThe ransomware can be executed without parameters and will start to encrypt the system,\nhowever, it is possible to to run Black Kingdom with a number value, which it will interpret as\nthe number of seconds to wait before starting encryption.\n\n\n-----\n\n**_‘Sleep’ parameter used as an argument_**\n\n### Ransomware is written in Python\n\nBlack Kingdom is coded in Python and compiled to an executable using PyInstaller. While\nanalyzing the code statically, we found that most of the ransomware logic was coded into a\nfile named 0xfff.py. The ransomware is written in Python 3.7.\n\n**_Black Kingdom is coded in Python_**\n\n### Excluded directories\n\nThe adversary behind Black Kingdom specified certain folders to be excluded from\nencryption. The purpose is to avoid breaking the system during encryption. The list of\nexcluded folders is available in the code:\n\n\n-----\n\nWindows,\nProgramData,\nProgram Files,\nProgram Files (x86),\nAppData/Roaming,\nAppData/LocalLow,\nAppData/Local.\n\nThe code that implements this functionality demonstrates how amateurishly Black Kingdom\nis written. The developers failed to use OS environments or regex to avoid repeating the\ncode twice.\n\n### PowerShell command for process termination and history deletion\n\nPrior to file encryption, Black Kingdom uses PowerShell to try to stop all processes in the\nsystem that contain “sql” in the name with the following command:\n\n1 Get-Service*sql*|Stop-Service-Force2>$null\n\nOnce done, Black Kingdom will delete the PowerShell history in the system.\n\n**_PowerShell commands run by Black Kingdom_**\n\nCombined with a cleanup of system logs, this supports the theory that the attackers try to\nremain hidden in the system by removing all traces of their activity.\n\n### Encryption process\n\nThe static analysis of Black Kingdom shows how it generates an AES-256 key based on the\nfollowing algorithm.\n\n\n-----\n\n**_The pseudo-algorithm used by Black Kingdom_**\n\nThe malware generates a 64-character pseudo-random string. It then takes the MD5 hash of\nthe string and uses it as the key for AES-256 encryption.\n\nThe code contains credentials for sending the generated key to the third-party service\nhxxp://mega.io. If the connection is unsuccessful, the Black Kingdom encrypts the data with\na hardcoded key available in the code.\n\nBelow is an example of a successful connection with hxxp://mega.io.\n\n\n-----\n\n**_Connection established with mega.io_**\n\nThe credentials for mega.io are hardcoded in base64 and used for connecting as shown\nbelow.\n\n**_Hardcoded credentials_**\n\nThe file sent to Mega contained the following data.\n\n**Parameter** **Description:**\n\nID: Generated ID for user identification\n\nKey: Generated user key\n\nUser: Username in the infected system\n\nDomain: Domain name to which the infected user belongs\n\nBlack Kingdom will encrypt a single file if it is passed as a parameter with the key to encrypt\nit This could allow the attacker to encrypt one file instead of encrypting the entire system\n\n\n-----\n\n**_Function for encrypting a single file_**\n\nIf no arguments are used, the ransomware will start to enumerate files in the system and\nthen encrypt these with a ten-threaded process. It performs the following basic operations:\n\n1. Read the file,\n2. Overwrite it with an encrypted version,\n3. Rename the file.\n\n\n-----\n\n**_The function used for encrypting the system_**\n\nBlack Kingdom allows reading a file in the same directory called target.txt, which will be used\nby the ransomware to recursively collect files for the collected directories specified in that file\nand then encrypt them. Black Kingdom will also enumerate various drive letters and encrypt\nthem. A rescue note will be delivered for each encrypted directory.\n\n\n-----\n\n**_Rescue note used by the ransomware_**\n\n### Encryption mistakes\n\nAmateur ransomware developers often end up making mistakes that can help decryption,\ne.g., poor implementation of the encryption key, or, conversely, make recovery impossible\neven after the victim pays for a valid decryptor. Black Kingdom will try to upload the\ngenerated key to Mega, and if this fails, use a hardcoded key to encrypt the files. If the files\nhave been encrypted and the system has not been able to make a connection to Mega, it will\nbe possible to recover the files using the hardcoded keys.\n\n**_Hardcoded key in Base64_**\n\nWhile analyzing the code statically, we examined the author’s implementation of file\nencryption and found several mistakes that could affect victims directly. During the encryption\nprocess, Black Kingdom does not check whether the file is already encrypted or not. Other\npopular ransomware families normally add a specific extension or a marker to all encrypted\nfiles. However, if the system has been infected by Black Kingdom twice, files in the system\nwill be encrypted twice, too, which may prevent recovery with a valid encryption key.\n\n### System log cleanup\n\nA feature of Black Kingdom is the ability to clean up system logs with a single Python\nfunction.\n\n\n-----\n\n**_The function that cleans up system logs_**\n\nThis operation will result in Application, Security, and System event viewer logs being\ndeleted. The purpose is to remove any history of ransomware activity, exploitation, and\nprivilege escalation.\n\n### Ransomware note\n\nBlack Kingdom changes the desktop background to a note that the system is infected while it\nencrypts files, disabling the mouse and keyboard with pyHook as it does so.\n\n**_Function to hook the mouse and keyboard_**\n\nWritten in English, the note contains several mistakes. All Black Kingdom notes contain the\nsame Bitcoin address; sets it apart from other ransomware families, which provide a unique\naddress to each victim.\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n\n***************************\n\n| We Are Back      ?\n\n***************************\n\nWe hacked your (( Network )), and now all files, documents, images,\n\ndatabases and other important data are safely encrypted using the strongest\nalgorithms ever.\n\nYou cannot access any of your files or services .\n\nBut do not worry. You can restore everthing and get back business very soon (\ndepends on your actions )\n\n\n-----\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n26\n\n27\n\n28\n\n29\n\n30\n\n31\n\n32\n\n33\n\n34\n\n35\n\n36\n\n37\n\n\nbefore I tell how you can restore your data, you have to know certain things :\n\nWe have downloaded most of your data ( especially important data ), and if you\ndon't contact us within 2 days, your data will be released to the public.\n\nTo see what happens to those who didn't contact us, just google : ( Blackkingdom\nRansomware )\n\n***************************\n\n| What guarantees    ?\n\n***************************\n\nWe understand your stress and anxiety. So you have a free opportunity to test our\nservice by instantly decrypting one or two files for free\n\njust send the files you want to decrypt to (support_blackkingdom2@protonmail.com\n\n***************************************************\n\n| How to contact us and recover all of your files ?\n\n***************************************************\n\nThe only way to recover your files and protect from data leaks, is to purchase a\nunique private key for you that we only posses .\n\n[ + ] Instructions:\n\n1- Send the decrypt_file.txt file to the following email ===>\nsupport_blackkingdom2@protonmail.com\n\n\n-----\n\n38\n\n39\n\n40\n\n41\n\n42\n\n43\n\n44\n\n45\n\n46\n\n47\n\n48\n\n49\n\n\n2 send the following amount of US dollars ( 10,000 ) worth of bitcoin to this address :\n\n[ 1Lf8ZzcEhhRiXpk6YNQFpCJcUisiXb34FT ]\n\n3- confirm your payment by sending the transfer url to our email address\n\n4- After you submit the payment, the data will be removed from our servers, and the\ndecoder will be given to you,\n\nso that you can recover all your files.\n\n## Note ##\n\nDear system administrators, do not think you can handle it on your own. Notify your\nsupervisors as soon as possible.\n\nBy hiding the truth and not communicating with us, what happened will be published\non social media and yet in news websites.\n\nYour ID ==>\n\nFDHJ91CUSzXTquLpqAnP\n\n\nThe associated Bitcoin address is currently showing just two transactions.\n\n\n-----\n\n**_Transactions made to a Bitcoin account_**\n\n### Code analysis\n\nAfter decompiling the Python code, we found that the code base for Black Kingdom has its\n[origins in an open-source ransomware builder available on Github.](https://github.com/BuchiDen/Ransomware_RAASNet/blob/master/RAASNet.py)\n\nThe adversary behind Black Kingdom adapted parts of the code, adding features that were\nnot originally presented in the builder, such as the hardcoded key or communication with the\nmega.io domain.\n\n## Victims\n\nBased on our telemetry we could see only a few hits by Black Kingdom in Italy and Japan.\n\n## Attribution\n\nWe could not attribute Black Kingdom to any known adversary in our case analysis. Its\ninvolvement in the Microsoft Exchange exploitation campaign suggests opportunism, rather\nthan a resurgence in activity from this ransomware family.\n\n[For more information please contact: financialintel@kaspersky.com](http://10.10.0.46/mailto:financialintel@kaspersky.com)\n\n## Appendix I – Indicators of Compromise\n\n**_Note: The indicators in this section were valid at the time of publication. Any future changes_**\n_will be directly updated in the corresponding .ioc file._\n\n**File Hashes**\n\n\n-----\n\nb9dbdf11da3630f464b8daace88e11c374a642e5082850e9f10a1b09d69ff04f\nc4aa94c73a50b2deca0401f97e4202337e522be3df629b3ef91e706488b64908\na387c3c5776ee1b61018eeb3408fa7fa7490915146078d65b95621315e8b4287\n815d7f9d732c4d1a70cec05433b8d4de75cba1ca9caabbbe4b8cde3f176cc670\n910fbfa8ef4ad7183c1b5bdd3c9fd1380e617ca0042b428873c48f71ddc857db\n866b1f5c5edd9f01c5ba84d02e94ae7c1f9b2196af380eed1917e8fc21acbbdc\nc25a5c14269c990c94a4a20443c4eb266318200e4d7927c163e0eaec4ede780a\n\n**Domain:**\n\nhxxp://yuuuuu44[.]com/vpn-service/$(f1)/crunchyroll-vpn\n\n**YARA rules:**\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n\nimport \"hash\"\n\nimport \"pe\"\n\nrule ransomware_blackkingdom {\n\nmeta:\n\ndescription = \"Rule to detect Black Kingdom ransomware\"\n\nauthor = \"Kaspersky Lab\"\n\ncopyright = \"Kaspersky Lab\"\n\ndistribution = \"DISTRIBUTION IS FORBIDDEN. DO NOT UPLOAD TO ANY\nMULTISCANNER OR SHARE ON ANY THREAT INTEL PLATFORM\"\n\nversion = \"1.0\"\n\nlast_modified = \"2021-05-02\"\n\nhash =\n\"866b1f5c5edd9f01c5ba84d02e94ae7c1f9b2196af380eed1917e8fc21acbbdc\"\n\nhash =\n\"910fbfa8ef4ad7183c1b5bdd3c9fd1380e617ca0042b428873c48f71ddc857db\"\n\ncondition:\n\nhash.sha256(pe.rich_signature.clear_data) ==\n\"0e7d0db29c7247ae97591751d3b6c0728aed0ec1b1f853b25fc84e75ae12b7b8\"\n\n}\n\n\n## Appendix II – MITRE ATT&CK Mapping\n\nThis table contains all TTPs identified during the analysis of the activity described in this\nreport.\n\n**Tactic** **Technique.** **Technique Name.**\n\n**Execution** **T1047** **Windows Management**\n**Instrumentation**\n\n\n-----\n\n**T1059** **Command and Scripting**\n**Interpreter**\n\n**T1106** **Native API**\n\n**Persistence** **T1574.002** **DLL Side-Loading**\n\n**T1546.011** **Application Shimming**\n\n**T1547.001** **Registry Run Keys / Startup**\n**Folder**\n\n\n**Privilege**\n**Escalation**\n\n\n**T1055** **Process Injection**\n\n\n**T1574.002** **DLL Side-Loading**\n\n**T1546.011** **Application Shimming**\n\n**T1134** **Access Token Manipulation**\n\n**T1547.001** **Registry Run Keys / Startup**\n**Folder**\n\n**Defense Evasion** **T1562.001** **Disable or Modify Tools**\n\n**T1140** **Deobfuscate/Decode Files or**\n**Information**\n\n**T1497** **Virtualization/Sandbox Evasion**\n\n**T1027** **Obfuscated Files or Information**\n\n**T1574.002** **DLL Side-Loading**\n\n**T1036** **Masquerading**\n\n**T1134** **Access Token Manipulation**\n\n**T1055** **Process Injection**\n\n\n**Credential**\n**Access**\n\n\n**T1056** **Input Capture**\n\n\n**Discovery** **T1083** **File and Directory Discovery**\n\n**T1082** **System Information Discovery**\n\n**T1497** **Virtualization/Sandbox Evasion**\n\n**T1012** **Query Registry**\n\n\n-----\n\n**T1518.001** **Security Software Discovery**\n\n**T1057** **Process Discovery**\n\n**T1018** **Remote System Discovery**\n\n**T1016** **System Network Configuration**\n**Discovery**\n\n**Collection** **T1560** **Archive Collected Data**\n\n**T1005** **Data from Local System**\n\n**T1114** **Email Collection**\n\n**T1056** **Input Capture**\n\n\n**Command and**\n**Control**\n\n\n**T1573** **Encrypted Channel**\n\n\n**Impact** **T1486** **Data Encrypted for Impact**\n\n[Bitcoin](https://securelist.com/tag/bitcoin/)\n[Encryption](https://securelist.com/tag/encryption/)\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Microsoft](https://securelist.com/tag/microsoft/)\n[Ransomware](https://securelist.com/tag/ransomware/)\n[Vulnerabilities and exploits](https://securelist.com/tag/vulnerabilities-and-exploits/)\n\nAuthors\n\n[Marc Rivero](https://securelist.com/author/marcrivero/)\n\nBlack Kingdom ransomware\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-17 - Black Kingdom ransomware.pdf"
    ],
    "report_names": [
        "2021-06-17 - Black Kingdom ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "b584b10a-7d54-4d05-9e21-b223563df7b8",
            "created_at": "2022-10-25T16:07:24.181589Z",
            "updated_at": "2025-03-27T02:02:10.134233Z",
            "deleted_at": null,
            "main_name": "SideCopy",
            "aliases": [],
            "source_name": "ETDA:SideCopy",
            "tools": [
                "ActionRAT",
                "AllaKore",
                "Allakore RAT",
                "AresRAT",
                "Bladabindi",
                "CetaRAT",
                "DetaRAT",
                "EpicenterRAT",
                "Jorik",
                "Lilith",
                "Lilith RAT",
                "MargulasRAT",
                "ReverseRAT",
                "njRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "187a0668-a968-4cf0-8bfd-4bc97c02f6dc",
            "created_at": "2022-10-27T08:27:12.955905Z",
            "updated_at": "2025-03-27T02:00:55.41311Z",
            "deleted_at": null,
            "main_name": "SideCopy",
            "aliases": [
                "SideCopy"
            ],
            "source_name": "MITRE:SideCopy",
            "tools": [
                "AuTo Stealer",
                "Action RAT"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "a4f0e383-f447-4cd6-80e3-ffc073ed4e00",
            "created_at": "2023-01-06T13:46:39.30167Z",
            "updated_at": "2025-03-27T02:00:03.045082Z",
            "deleted_at": null,
            "main_name": "SideCopy",
            "aliases": [],
            "source_name": "MISPGALAXY:SideCopy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536019,
    "ts_updated_at": 1743041124,
    "ts_creation_date": 1653751222,
    "ts_modification_date": 1653751222,
    "files": {
        "pdf": "https://archive.orkl.eu/62fe0eeeccab34989c445ee7e6da6eeaf81774c5.pdf",
        "text": "https://archive.orkl.eu/62fe0eeeccab34989c445ee7e6da6eeaf81774c5.txt",
        "img": "https://archive.orkl.eu/62fe0eeeccab34989c445ee7e6da6eeaf81774c5.jpg"
    }
}