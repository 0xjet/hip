{
    "id": "59d4bcf4-400d-4658-b826-f2d541f42ffb",
    "created_at": "2022-10-25T16:48:17.386007Z",
    "updated_at": "2025-03-27T02:05:58.923909Z",
    "deleted_at": null,
    "sha1_hash": "e28fa739ff155c54bbeec576dd9e057644e51e2b",
    "title": "Microsoft Word - AvosLockerRansomware_Whitepaper - Vlad Pasca.docx",
    "authors": "",
    "file_creation_date": "2022-05-02T16:57:55Z",
    "file_modification_date": "2022-05-02T16:57:55Z",
    "file_size": 19712420,
    "plain_text": "# A Deep Dive into AvosLocker Ransomware\n\n\n**SecurityScorecard.com**\n\ninfo@securityscorecard.com\n\n©2022 SecurityScorecard Inc.\n\n244 Fifth Avenue, Suite 2035,\n\nNew York, NY 10001\n\n1.212.222.7061\n\n\n-----\n\n## Table of Contents\n\n### Executive Summary 2\n\n Analysis and Findings 2\n\n Thread activity – sub_CBB930 function 10\n\n Thread activity – sub_CBBAD0 function 13\n\n Running with the -h (--help) parameter 21\n\n Running with the -p (--path) parameter 21\n\n Running with the -l (--disabledrives) parameter 21\n\n Running with the --hide parameter 21\n\n Running with the -t (--threads) parameter 22\n\n Running with the -n (--enablesmb) parameter 22\n\n Running with the -b (--brutesmb) -n (--enablesmb) parameters 23\n\n Running with the --nomutex parameter 24\n\n Indicators of Compromise 25\n\n**www securityscorecard com | 1**\n\n\n-----\n\n## Executive Summary \n\nAvosLocker is a ransomware-as-a-service (RaaS) group that appeared in 2021. The malware can\nrun with one of the following parameters: “--help”, “--path”, “--disabledrives”, “--hide”, “--threads”,\n“--enablesmb”, “--brutesmb”, and “--nomutex.” The ransomware kills a list of targeted processes,\ndeletes all Volume Shadow Copies using two commands, and clears all Windows event logs. The\nbinary can target the logical drives as well as network shares by specifying proper arguments.\n\nThe encryption is done using multithreading with I/O completion ports. AvosLocker uses a\ncombination of RSA and Salsa20 algorithms during the encryption process. Finally, the\nransomware creates an image based on the ransom note text that is set as the Desktop\nWallpaper.\n\n## Analysis and Findings\n\nSHA256: EC955F589F25D0D28E55964A1AA79C27492026982994CD4CA1FAF7E8A78DB4BC\n\nThe malware performs a call to GetCurrentProcess and then opens the access token associated\nwith the current process using the OpenProcessToken API (0xF01FF = TOKEN_ALL_ACCESS):\n\nFigure 1\n\nMost of the strings are encrypted using the XOR operator. An example of a decryption algorithm\nis displayed in figure 2:\n\nFigure 2\n\nThe LookupPrivilegeValueA function is utilized to retrieve the LUID (locally unique identifier)\ncorresponding to the \"SeTakeOwnershipPrivilege\" privilege:\n\nFigure 3\n\n**www securityscorecard com | 2**\n\n\n-----\n\nAvosLocker enables the above privilege in the access token via a function call to\nAdjustTokenPrivileges:\n\nFigure 4\n\nThe binary decrypts a list of processes that will be killed (figure 5):\n\n     - \"encsvc\" \"thebat\" \"mydesktopqos\" \"xfssvccon\" \"firefox\" \"infopath\" \"winword\"\n\"steam\" \"synctime\" \"notepad\"\n\n     - \"ocomm\" \"onenote\" \"mspub\" \"thunderbird\" \"agntsvc\" \"sql\" \"excel\" \"powerpnt\"\n\"outlook\" \"wordpad\" \"dbeng50\"\n\n     - \"isqlplussvc\" \"sqbcoreservice\" \"oracle\" \"ocautoupds\" \"dbsnmp\" \"msaccess\"\n\"tbirdconfig\" \"ocssd\" \"mydesktopservice\" \"visio\"\n\nFigure 5\n\nCreateToolhelp32Snapshot is used to take a snapshot of all processes in the system (0x2 =\n**TH32CS_SNAPPROCESS):**\n\nFigure 6\n\nThe ransomware extracts information about the first process from the snapshot using the\nProcess32First routine:\n\n**www securityscorecard com | 3**\n\n\n-----\n\nFigure 7\n\nThere is a comparison between the process name and the blacklisted processes:\n\nFigure 8\n\nThe malicious binary retrieves information about the next process from the snapshot via a call to\nProcess32Next:\n\nFigure 9\n\nAvosLocker uses the FNV (Fowler-Noll-Vo) hashing algorithm to identify and call relevant APIs at\nruntime:\n\nFigure 10\n\nThe executable opens a targeted process using OpenProcess (0x1 = PROCESS_TERMINATE):\n\n**www securityscorecard com | 4**\n\n\n-----\n\nFigure 11\n\nThe TerminateProcess routine is utilized to kill the targeted process:\n\nFigure 12\n\nThe ransomware writes the following data in the command line output:\n\nFigure 13\n\nWe’ll explain the purpose of each parameter in the following paragraphs.\n\nThe malware creates a mutex called \"Zheic0WaWie6zeiy\", which ensures that only one copy of\nthe process is running at a single time:\n\nFigure 14\n\nThe process disables file system redirection by calling the Wow64DisableWow64FsRedirection\nAPI:\n\n**www securityscorecard com | 5**\n\n\n-----\n\nFigure 15\n\nThe binary calls the WinExec function in order to spawn multiple processes (figure 16):\n\n     - cmd /c wmic shadowcopy delete /nointeractive – delete volume shadow copies\n\n     - cmd /c vssadmin.exe Delete Shadows /All /Quiet – delete volume shadow copies\n\n     - cmd /c bcdedit /set {default} recoveryenabled No – disable automatic repair\n\n     - cmd /c bcdedit /set {default} bootstatuspolicy ignoreallfailures – ignore errors in\nthe case of a failed boot / shutdown / checkpoint\n\n     - cmd /c powershell -command \\\"Get-EventLog -LogName * | ForEach { ClearEventLog $_.Log }\\\" - clear all entries from the event logs\n\nFigure 16\n\nThe file comes with a hard-coded RSA public key:\n\nFigure 17\n\nAvosLocker creates an input/output (I/O) completion port that is not yet associated with a file\nhandle (0xFFFFFFFF = INVALID_HANDLE_VALUE):\n\n**www securityscorecard com | 6**\n\n\n-----\n\nFigure 18\n\nThe malware creates multiple threads that will handle the files encryption. As we can see in\nfigures 19 and 20, even if the starting address of the thread is StartAddress (sub_D0155F), the\nactual relevant function that will be called is sub_CBBAD0:\n\nFigure 19\n\nFigure 20\n\nThe thread’s priority is set to 0x2 (THREAD_PRIORITY_HIGHEST) via a function call to\nSetThreadPriority:\n\nFigure 21\n\nThe number of created threads is 200 (default value); however, it can be modified using the -t (or\n--threads) parameter.\n\nFindFirstVolumeW is utilized to retrieve the first volume of the local machine:\n\nFigure 22\n\n**www securityscorecard com | 7**\n\n\n-----\n\nThe ransomware extracts a list of drive letters and mounted folder paths for a volume using the\nGetVolumePathNamesForVolumeNameW function:\n\nFigure 23\n\nThe volume enumeration continues by calling FindNextVolumeW:\n\nFigure 24\n\nThe malware is looking for volumes that aren’t mounted using the GetDriveTypeW routine (0x1 =\n**DRIVE_NO_ROOT_DIR):**\n\nFigure 25\n\nThe binary associates an unmounted volume with a drive letter using SetVolumeMountPointW:\n\nFigure 26\n\nAvosLocker obtains a bitmask representing the available disk drives:\n\nFigure 27\n\nThe process creates a thread for each drive that is found. The same method as above is utilized\nhere, i.e., the starting address of the thread is StartAddress (sub_D0155F); however, the important\nfunction is sub_CBB930:\n\n**www securityscorecard com | 8**\n\n\n-----\n\nFigure 28\n\nFigure 29\n\nAll identified drives are written to the command line, as highlighted in figure 30.\n\nFigure 30\n\nThe new threads’ priority is also set to THREAD_PRIORITY_HIGHEST by the malicious binary.\n\nGetConsoleWindow is used to retrieve the window handle used by the console associated with\nthe process:\n\nFigure 31\n\nThe malware calls the ShutdownBlockReasonCreate API and indicates that the machine should\nnot be shut down during the encryption process:\n\n**www securityscorecard com | 9**\n\n\n-----\n\nFigure 32\n\nThe ransomware extracts the identifier of the calling thread:\n\nFigure 33\n\nAvosLocker blocks the calling thread until all created threads will terminate their work using the\nJoin method:\n\nFigure 34\n\n## Thread activity – sub_CBB930 function\n\nThe ransomware decrypts a list of extensions that will be skipped (figure 35):\n\n     - \"avos\" \"avoslinux\" \"avos2\" \"avos2j\" \"themepack\" \"nls\" \"diagpkg\" \"msi\" \"lnk\" \"exe\"\n\"cab\" \"scr\" \"bat\" \"drv\" \"rtp\" \"msp\"\n\n     - \"prf\" \"msc\" \"ico\" \"key\" \"ocx\" \"diagcab\" \"diagcfg\" \"pdb\" \"wpx\" \"hlp\" \"icns\" \"rom\" \"dll\"\n\"msstyles\" \"mod\" \"ps1\" \"ics\" \"hta\"\n\n     - \"bin\" \"cmd\" \"ani\" \"386\" \"lock\" \"cur\" \"idx\" \"sys\" \"com\" \"deskthemepack\" \"shs\" \"ldf\"\n\"theme\" \"mpa\" \"nomedia\" \"spl\" \"cpl\" \"adv\" \"icl\" \"msu\"\n\nFigure 35\n\n**www securityscorecard com | 10**\n\n\n-----\n\nThe malicious executable starts enumerating the drive by calling the FindFirstFileW function:\n\nFigure 36\n\nThe ransomware creates a ransom note called “GET_YOUR_FILES_BACK.txt” in every directory\nthat will be encrypted (0x40000000 = **GENERIC_WRITE, 0x2 =** **CREATE_ALWAYS, 0x80 =**\n**FILE_ATTRIBUTE_NORMAL):**\n\nFigure 37\n\nThe WriteFile routine is used to populate the ransom note:\n\nFigure 38\n\nFigure 39\n\nThe process decrypts a list of folders that will not be encrypted (figure 40):\n\n     - \"Program Files\" \"Windows\" \"Windows.old\" \"bootmgr\" \"ProgramData\" \"System\nVolume Information\"\n\n     - \"AppData\" \"Public\" \"All Users\" \"boot\" \"Intel\" \"WinNT\" \"Sophos\" \"Microsoft.\" \"Games\"\n\"config.msi\"\n\n**www securityscorecard com | 11**\n\n\n-----\n\nFigure 40\n\nAvosLocker continues the file enumeration using FindNextFileW:\n\nFigure 41\n\nA list of files that will be skipped is decrypted using the XOR operator (figure 42):\n\n     - \"GET_YOUR_FILES_BACK.txt\" \"desktop.ini\" \"autorun.inf\" \"ntldr\" \"bootsect.bak\"\n\"thumbs.db\"\n\n     - \"boot.ini\" \"ntuser.dat\" \"iconcache.db\" \"bootfont.bin\" \"ntuser.ini\" \"ntuser.dat.log\"\n\"Thumbs.db\"\n\nFigure 42\n\nAn example of a comparison between the file extension and one that is whitelisted is shown\nbelow:\n\nFigure 43\n\nThe ransomware sends an I/O completion packet that contains the targeted file path to the IOCP\ncreated earlier:\n\n**www securityscorecard com | 12**\n\n\n-----\n\nFigure 44\n\n## Thread activity – sub_CBBAD0 function\n\nGetQueuedCompletionStatus is utilized to dequeue an I/O completion packet from the IOCP:\n\nFigure 45\n\nAvosLocker retrieves file system attributes for a file or directory and avoids the\n**FILE_ATTRIBUTE_SYSTEM (0x4) attribute:**\n\nFigure 46\n\nBased on the assembly code we analyzed, the ransomware uses a free C++ library of\ncryptographic schemes called Cryptopp (https://github.com/weidai11/cryptopp):\n\nFigure 47\n\nThe malicious process acquires a handle to a key container within a particular cryptographic\nservice provider (0x1 = PROV_RSA_FULL, 0xF0000000 = CRYPT_VERIFYCONTEXT):\n\n**www securityscorecard com | 13**\n\n\n-----\n\nFigure 48\n\nThe ransomware generates 32 random bytes via a function call to CryptGenRandom. These bytes\nwill be used to derive a Salsa20 key and a nonce:\n\nFigure 49\n\nFigure 50\n\nThe RSA public key is converted into an array of bytes using CryptStringToBinaryA:\n\nFigure 51\n\nThe CryptDecodeObjectEx API is utilized to decode a structure of a particular type (0x1 =\n**X509_ASN_ENCODING,** 0x8 = **X509_PUBLIC_KEY_INFO,** 0x8000 =\n**CRYPT_DECODE_ALLOC_FLAG):**\n\nFigure 52\n\n**www securityscorecard com | 14**\n\n\n-----\n\nThe process converts and imports the RSA public key information into the provider and returns a\nhandle (0x1 = X509_ASN_ENCODING):\n\nFigure 53\n\nThe Salsa20 key (32 bytes) and a nonce (8 bytes) that were derived from the randomly generated\nbuffer are encrypted using the RSA public key:\n\nFigure 54\n\nFigure 55\n\nThe above buffer is reversed and converted to Base64 format (0x40000001 =\n**CRYPT_STRING_NOCRLF | CRYPT_STRING_BASE64):**\n\nFigure 56\n\n**www securityscorecard com | 15**\n\n\n-----\n\nFigure 57\n\nThe AllocateAndInitializeSid function is utilized to allocate and initialize a security identifier (SID)\nwith 2 subauthorities:\n\nFigure 58\n\nThe malware creates a new ACL by calling the SetEntriesInAclA routine:\n\nFigure 59\n\nSetNamedSecurityInfoW is utilized to modify the DACL of the targeted file (0x1 =\n**SE_FILE_OBJECT, 0x4 = DACL_SECURITY_INFORMATION):**\n\nFigure 60\n\n**www securityscorecard com | 16**\n\n\n-----\n\nThe ransomware opens the file via a call to CreateFileW (0xc0000000 = **GENERIC_READ |**\n**GENERIC_WRITE, 0x3 = OPEN_EXISTING, 0x80 = FILE_ATTRIBUTE_NORMAL):**\n\nFigure 61\n\nThe file size is retrieved using the GetFileSizeEx API:\n\nFigure 62\n\nAvosLocker reads 1MB at a time:\n\nFigure 63\n\nThe process moves the file pointer to the beginning of the file by calling SetFilePointer (0x0 =\n**FILE_BEGIN):**\n\nFigure 64\n\nThe binary passes a pointer to the file content to the encryption function:\n\nFigure 65\n\n**www securityscorecard com | 17**\n\n\n-----\n\nThe file content is encrypted using the Salsa20 algorithm. The implementation below is very\nsimilar to the one presented at https://github.com/weidai11/cryptopp/blob/master/salsa.cpp:\n\nFigure 66\n\nFigure 67\n\n**www securityscorecard com | 18**\n\n\n-----\n\nThe encrypted file content and the encrypted Salsa20 key and nonce are written to the file using\nWriteFile:\n\nFigure 68\n\nThe “.avos2” extension is appended to the encrypted files:\n\nFigure 69\n\nAn example of an encrypted file is displayed in figure 70.\n\nFigure 70\n\nWe continue with the analysis of the main thread.\n\nAvosLocker displays some statistics regarding encryption in the command line window:\n\n**www securityscorecard com | 19**\n\n\n-----\n\nFigure 71\n\nThe ransomware decrypts and runs a PowerShell script (see figure 72):\n\n  - powershell -Command \"$a = [System.IO.File]::ReadAllText(\\\"Z:\\GET_YOUR_FILES_BACK.txt\\\");Add-Type AssemblyName System.Drawing;$filename = \\\"$env:temp\\$(Get-Random).png\\\";$bmp = new-object\nSystem.Drawing.Bitmap 1920,1080;$font = new-object System.Drawing.Font Consolas,10;$brushBg =\n\n[System.Drawing.Brushes]::Black;$brushFg = [System.Drawing.Brushes]::White;$format =\n\n[System.Drawing.StringFormat]::GenericDefault;$format.Alignment =\n\n[System.Drawing.StringAlignment]::Center;$format.LineAlignment =\n\n[System.Drawing.StringAlignment]::Center;$graphics =\n\n[System.Drawing.Graphics]::FromImage($bmp);$graphics.FillRectangle($brushBg,0,0,$bmp.Width,$bmp.Heig\nht);$graphics.DrawString($a,$font,$brushFg,[System.Drawing.RectangleF]::FromLTRB(0, 0, 1920,\n1080),$format);$graphics.Dispose();$bmp.Save($filename);reg add \\\"HKEY_CURRENT_USER\\Control\nPanel\\Desktop\\\" /v Wallpaper /t REG_SZ /d $filename /f;Start-Sleep 1;rundll32.exe user32.dll,\nUpdatePerUserSystemParameters, 0, $false;\"\n\nFigure 72\n\nThe script’s purpose is to create an image that contains the ransom note and set that as the\nDesktop Wallpaper.\n\nThe final image that will be set is highlighted below:\n\nFigure 73\n\n**www securityscorecard com | 20**\n\n\n-----\n\n## Running with the -h (--help) parameter\n\nAvosLocker displays the help menu:\n\nFigure 74\n\n## Running with the -p (--path) parameter\n\nThe ransomware only encrypts this specific directory:\n\nFigure 75\n\n## Running with the -l (--disabledrives) parameter\n\nAvosLocker doesn’t encrypt the logical drives:\n\nFigure 76\n\n## Running with the --hide parameter\n\nThe malicious executable retrieves the window handle used by the console:\n\nFigure 77\n\nThe console window is hidden by calling the ShowWindow function (0x0 = SW_HIDE):\n\n**www securityscorecard com | 21**\n\n\n-----\n\nFigure 78\n\n## Running with the -t (--threads) parameter\n\nThis parameter represents the number of threads that will concurrently encrypt the files:\n\nFigure 79\n\n## Running with the -n (--enablesmb) parameter\n\nThe ransomware starts enumerating all resources on the network via a function call to\nWNetOpenEnumA (0x2 = RESOURCE_GLOBALNET, 0x0 = RESOURCETYPE_ANY):\n\nFigure 80\n\nWNetEnumResourceA is utilized to continue the enumeration of network resources:\n\nFigure 81\n\nAvosLocker connects to a network share by calling the WNetAddConnection2A routine (0x4 =\n**CONNECT_TEMPORARY):**\n\n**www securityscorecard com | 22**\n\n\n-----\n\nFigure 82\n\nThe network share name that will be encrypted is written to the command line:\n\nFigure 83\n\nA similar thread that has enumerated logical drives is also created in order to traverse the network\nshares:\n\nFigure 84\n\n## Running with the -b (--brutesmb) -n (--enablesmb) parameters\n\nThe process of discovering all network shares is identical to the above. The main idea, in this case,\nis that the malware is looking to extract the hostname/IP address from an available network share\nand trying to find logical drives based on it.\n\nThe binary makes a connection to a potential logical drive using the WNetAddConnection2A\nfunction (0x4 = CONNECT_TEMPORARY):\n\nFigure 85\n\n**www securityscorecard com | 23**\n\n\n-----\n\nFor all logical drives that can be found using the above method, the process creates a new thread\nthat will enumerate them:\n\nFigure 86\n\nFinally, AvosLocker writes the logical drives that were found to the command line:\n\nFigure 87\n\n## Running with the --nomutex parameter\n\nThe ransomware doesn’t create the mutex in this case.\n\n**www securityscorecard com | 24**\n\n\n-----\n\n## Indicators of Compromise\n\n### Mutex\n\nZheic0WaWie6zeiy\n\n### AvosLocker Ransom Note\n\nGET_YOUR_FILES_BACK.txt\n\n### Processes spawned\n\ncmd /c wmic shadowcopy delete /nointeractive\n\ncmd /c vssadmin.exe Delete Shadows /All /Quiet\n\ncmd /c bcdedit /set {default} recoveryenabled No\n\ncmd /c bcdedit /set {default} bootstatuspolicy ignoreallfailures\n\ncmd /c powershell -command \\\"Get-EventLog -LogName * | ForEach { Clear-EventLog $_.Log }\\\"\n\n**www securityscorecard com | 25**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://cdn.pathfactory.com/assets/10555/contents/400686/13f4424c-05b4-46db-bb9c-6bf9b5436ec4.pdf"
    ],
    "report_names": [
        "13f4424c-05b4-46db-bb9c-6bf9b5436ec4.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716497,
    "ts_updated_at": 1743041158,
    "ts_creation_date": 1651510675,
    "ts_modification_date": 1651510675,
    "files": {
        "pdf": "https://archive.orkl.eu/e28fa739ff155c54bbeec576dd9e057644e51e2b.pdf",
        "text": "https://archive.orkl.eu/e28fa739ff155c54bbeec576dd9e057644e51e2b.txt",
        "img": "https://archive.orkl.eu/e28fa739ff155c54bbeec576dd9e057644e51e2b.jpg"
    }
}