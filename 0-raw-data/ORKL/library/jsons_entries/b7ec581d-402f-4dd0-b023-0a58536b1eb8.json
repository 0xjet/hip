{
    "id": "b7ec581d-402f-4dd0-b023-0a58536b1eb8",
    "created_at": "2023-01-12T15:02:30.089932Z",
    "updated_at": "2025-03-27T02:06:05.586191Z",
    "deleted_at": null,
    "sha1_hash": "4edcb75643abb0c493d6a94a3a863f3cb606dd6e",
    "title": "2022-01-18 - Evolved phishing- Device registration trick adds to phishers’ toolbox for victims without MFA",
    "authors": "",
    "file_creation_date": "2022-05-28T23:20:09Z",
    "file_modification_date": "2022-05-28T23:20:09Z",
    "file_size": 676712,
    "plain_text": "# Evolved phishing: Device registration trick adds to phishers’ toolbox for victims without MFA\n\n**microsoft.com/security/blog/2022/01/26/evolved-phishing-device-registration-trick-adds-to-phishers-toolbox-for-victims-**\nwithout-mfa/\n\nJanuary 26, 2022\n\nWe have recently uncovered a large-scale, multi-phase campaign that adds a novel\ntechnique to traditional phishing tactics by joining an attacker-operated device to an\norganization’s network to further propagate the campaign. We observed that the second\nstage of the campaign was successful against victims that did not implement multifactor\nauthentication (MFA), an essential pillar of identity security. Without additional protective\nmeasures such as MFA, the attack takes advantage of the concept of bring-your-own-device\n(BYOD) via the ability to register a device using freshly stolen credentials.\n\nThe first campaign phase involved stealing credentials in target organizations located\npredominantly in Australia, Singapore, Indonesia, and Thailand. Stolen credentials were then\nleveraged in the second phase, in which attackers used compromised accounts to expand\ntheir foothold within the organization via lateral phishing as well as beyond the network via\noutbound spam.\n\nConnecting an attacker-controlled device to the network allowed the attackers to covertly\npropagate the attack and move laterally throughout the targeted network. While in this case\ndevice registration was used for further phishing attacks, leveraging device registration is on\nthe rise as other use cases have been observed. Moreover, the immediate availability of pen\ntesting tools, designed to facilitate this technique, will only expand its usage across other\nactors in the future.\n\nMFA, which prevents attackers from being able to use stolen credentials to gain access to\ndevices or networks, foiled the campaign for most targets. For organizations that did not\nhave MFA enabled, however, the attack progressed.\n\n\n-----\n\n_Figure 1. Multi-phase phishing attack chain_\nPhishing continues to be the most dominant means for attacking enterprises to gain initial\nentry. This campaign shows that the continuous improvement of visibility and protections on\nmanaged devices has forced attackers to explore alternative avenues. The potential attack\nsurface is further broadened by the increase in employees who work-from-home which shifts\nthe boundaries between internal and external corporate networks. Attackers deploy various\ntactics to target organizational issues inherent with hybrid work, human error, and “shadow\nIT” or unmanaged apps, services, devices, and other infrastructure operating outside\nstandard policies.\n\nThese unmanaged devices are often ignored or missed by security teams at join time,\nmaking them lucrative targets for compromising, quietly performing lateral movements,\njumping network boundaries, and achieving persistence for the sake of launching broader\nattacks. Even more concerning, as our researchers uncovered in this case, is when attackers\nmanage to successfully connect a device that they fully operate and is in their complete\ncontrol.\n\nTo fend off the increasing sophistication of attacks as exemplified by this attack,\norganizations need solutions that deliver and correlate threat data from email, identities,\n[cloud, and endpoints. Microsoft 365 Defender coordinates protection across these domains,](https://www.microsoft.com/security/business/threat-protection/microsoft-365-defender?rtc=1)\nautomatically finding links between signals to provide comprehensive defense. Through this\ncross-domain visibility, we were able to uncover this campaign. We detected the anomalous\ncreation of inbox rules, traced it back to an initial wave of phishing campaign, and correlated\ndata to expose the attackers’ next steps, namely device registration and the subsequent\nphishing campaign.\n\n\n-----\n\n_Figure 2. Microsoft 365 Defender alert “Suspicious device registration following phishing”_\nThis attack shows the impact of an attacker-controlled unmanaged device that may become\npart of a network when credentials are stolen and Zero Trust policies are not in place.\n[Microsoft Defender for Endpoint provides a device discovery capability that helps](https://www.microsoft.com/security/business/threat-protection/endpoint-defender?rtc=1)\norganizations to find certain unmanaged devices operated by attackers whenever they start\nhaving network interactions with servers and other managed devices. Once discovered and\nonboarded, these devices can then be remediated and protected.\n\n\n-----\n\n_Figure 3. Microsoft Defender for Endpoint device discovery_\nIn this blog post, we share the technical aspects of a large-scale, multi-phase phishing\ncampaign. We detail how attackers used the first attack wave to compromise multiple\nmailboxes throughout various organizations and implement an inbox rule to evade detection.\nThis was then followed by a second attack wave that abused one organization’s lack of MFA\nprotocols to register the attackers’ unmanaged device and propagate the malicious\nmessages via lateral, internal, and outbound spam.\n\n## First wave and rule creation\n\nThe campaign leveraged multiple components and techniques to quietly compromise\naccounts and propagate the attack. Using Microsoft 365 Defender threat data, we found the\nattack’s initial compromise vector to be a phishing campaign. Our analysis found that the\nrecipients received a DocuSign-branded phishing email, displayed below:\n\n\n-----\n\n_Figure 4. First-stage phishing email spoofing DocuSign_\nThe attacker used a set of phishing domains registered under .xyz top-level domain. The\nURL domain can be described with the following regular expression syntax:\n\n_UrlDomain matches regex @”^[a-z]{5}\\.ar[a-z]{4,5}\\.xyz”_\n\nThe phishing link was uniquely generated for each email, with the victim’s email address\nencoded in the query parameter of the URL. After clicking the link, the victim was redirected\nto a phishing website at newdoc-lnpye[.]ondigitalocean[.]app, which imitated the login page\nfor Office 365. The fake login page was pre-filled with the targeted victim’s username and\nprompted them to enter their password. This technique increased the likelihood that the\nvictim viewed the website as being legitimate and trustworthy.\n\n\n-----\n\n_Figure 5._\n\n_Phishing page with username prepopulated_\nNext, we detected that the victim’s stolen credentials were immediately used to establish a\nconnection with Exchange Online PowerShell, most likely using an automated script as part\nof a phishing kit. Leveraging the Remote PowerShell connection, the attacker implemented\nan inbox rule via the New-InboxRule cmdlet that deleted certain messages based on\nkeywords in the subject or body of the email message. The inbox rule allowed the attackers\nto avoid arousing the compromised users’ suspicions by deleting non-delivery reports and IT\nnotification emails that might have been sent to the compromised user.\n\nDuring our investigation of the first stage of this campaign, we saw over one hundred\ncompromised mailboxes in multiple organizations with inbox rules consistently fitting the\npattern below:\n\n\n**Mailbox**\n**rule name**\n\n\n**Condition** **Action**\n\n\n-----\n\n**Spam Filter** SubjectOrBodyContainsWords:\n“junk;spam;phishing;hacked;password;with you”\n\n\nDeleteMessage,\nMarkAsRead\n\n\nWhile multiple users within various organizations were compromised in the first wave, the\nattack did not progress past this stage for the majority of targets as they had MFA enabled.\nThe attack’s propagation heavily relied on a lack of MFA protocols. Enabling MFA for Office\n365 applications or while registering new devices could have disrupted the second stage of\nthe attack chain.\n\n## Device registration and second wave phishing\n\nOne account belonging to an organization without MFA enabled was further abused to\nexpand the attackers’ foothold and propagate the campaign. More specifically, the attack\nabused the organization’s lack of MFA enforcement to join a device to its Azure Active\n[Directory (Azure AD) instance, or possibly to enroll into a management provider like Intune to](https://docs.microsoft.com/azure/active-directory/devices/manage-stale-devices)\nenforce the organization’s policies based on compliant devices.\n\nIn this instance, the attackers first installed Outlook onto their own Windows 10 machine.\nThis attacker-owned device was then successfully connected to the victim organization’s\nAzure AD, possibly by simply accepting Outlook’s first launch experience prompt to register\nthe device by using the stolen credentials. An Azure AD MFA policy would have halted the\nattack chain at this stage. Though for the sake of comprehensiveness, it should be noted that\n[some common red team tools, such as AADInternalsand the command Join-](https://o365blog.com/post/devices/)\n_AADIntDeviceToAzureAD, can be used to achieve similar results in the presence of a stolen_\ntoken and lack of strong MFA policies.\n\nAzure AD evaluates and triggers an activity timestamp when a device attempts to\nauthenticate, which can be reviewed to discover freshly registered devices. In our case, this\nincludes a Windows 10 device either Azure AD joined or hybrid Azure AD joined and active\non the network. The activity timestamp can be found by either using the Get-AzureADDevice\ncmdlet or the Activity column on the devices page in the Azure portal. Once a timeframe is\ndefined and a potential rogue device is identified, the device can be deleted from Azure AD,\npreventing access to resources using the device to sign in.\n\nThe creation of the inbox rule on the targeted account coupled with the attackers’ newly\nregistered device meant that they were now prepared to launch the second wave of the\ncampaign. This second wave appeared to be aimed at compromising additional accounts by\nsending lateral, internal, and outbound phishing messages.\n\nBy using a device now recognized as part of the domain coupled with a mail client configured\nexactly like any regular user, the attacker gained the ability to send intra-organizational\nemails that were missing many of the typical suspect identifiers. By removing enough of\nthese suspicious message elements, the attacker thereby significantly expanded the success\nof the phishing campaign\n\n\n-----\n\nTo launch the second wave, the attackers leveraged the targeted user s compromised\nmailbox to send malicious messages to over 8,500 users, both in and outside of the victim\norganization. The emails used a SharePoint sharing invitation lure as the message body in\nan attempt to convince recipients that the “Payment.pdf” file being shared was legitimate.\n\n_Figure 6. Second-stage phishing email spoofing SharePoint_\nLike the first stage of the campaign, we found that the URL used in the second wave\nphishing emails matched the first’s wave structure and also redirected to the newdoclnpye[.]ondigitalocean[.]app phishing website imitating the Office 365 login page. Victims that\nentered their credentials on the second stage phishing site were similarly connected with\nExchange Online PowerShell, and almost immediately had a rule created to delete emails in\ntheir respective inboxes. The rule had identical characteristics to the one created during the\ncampaign’s first stage of attack.\n\n\n-----\n\nGenerally, the vast majority of organizations enabled MFA and were protected from the\nattackers’ abilities to propagate the attack and expand their network foothold. Nonetheless,\nthose that do not have MFA enabled could open themselves up to being victimized in\npotential future attack waves.\n\n## Remediating device persistence: when resetting your password is not enough\n\nAnalysis of this novel attack chain and the additional techniques used in this campaign\nindicates that the traditional phishing remediation playbook will not be sufficient here. Simply\nresetting compromised accounts’ passwords may ensure that the user is no longer\ncompromised, but it will not be enough to eliminate ulterior persistence mechanisms in place.\n\nCareful defenders operating in hybrid networks need to also consider the following steps:\n\n[Revocation of active sessions and any token associated with the compromised](https://docs.microsoft.com/azure/active-directory/enterprise-users/users-revoke-access)\naccounts\n[Deletion of any mailbox rules eventually created by the actor](https://docs.microsoft.com/powershell/module/exchange/remove-inboxrule?view=exchange-ps)\n[Disable and removal of any rogue device joined to Azure AD by the actor](https://docs.microsoft.com/azure/active-directory/devices/manage-stale-devices#clean-up-stale-devices-in-the-azure-portal)\n\nIf these additional remediation steps are not taken, the attacker could still have valuable\nnetwork access even after successfully resetting the password of the compromised account.\nAn in-depth understanding of this attack is necessary to properly mitigate and defend against\nthis new type of threat.\n\n## Defending against multi-staged phishing campaigns\n\nThe latest [Microsoft Digital Defense Report detailed that phishing poses a major threat to](https://www.microsoft.com/security/business/microsoft-digital-defense-report)\nboth enterprises and individuals, while credential phishing was leveraged in many of the\nmost damaging attacks in the last year. Attackers targeting employee credentials, particularly\nemployees with high privileges, typically use the stolen data to sign into other devices and\nmove laterally inside the network. The phishing campaign we discussed in this blog\nexemplifies the increasing sophistication of these attacks.\n\nIn order to disrupt attackers before they reach their target, good credential hygiene, network\nsegmentation, and similar best practices increase the “cost” to attackers trying to propagate\nthrough the network. These best practices can limit an attacker’s ability to move laterally and\ncompromise assets after initial intrusion and should be complemented with advanced\nsecurity solutions that provide visibility across domains and coordinate threat data across\nprotection components.\n\nOrganizations can further reduce their attack surface by disabling the use of basic\nauthentication, enabling multi-factor authentication for all users, and requiring multi-factor\n[authentication when joining devices to Azure AD. Microsoft 365 global admins can also](https://docs.microsoft.com/azure/active-directory/devices/device-management-azure-portal)\n\n\n-----\n\n[disable Exchange Online PowerShell for individual or multiple end users via a list of specific](https://docs.microsoft.com/powershell/exchange/disable-access-to-exchange-online-powershell?view=exchange-ps#:~:text=To%20disable%20access%20to%20Exchange%20Online%20PowerShell%20for,contain%20one%20account%20on%20each%20line%20as%20follows%3A)\nusers or filterable attributes, assuming that the target accounts all share a unique filterable\nattribute such as Title or Department. For additional security, customers can enforce our new\n[Conditional Access control requiring MFA to register devices, which can be combined with](https://docs.microsoft.com/azure/active-directory/conditional-access/concept-conditional-access-cloud-apps#user-actions)\nother CA conditions like device platform or trusted networks.\n\n[Microsoft 365 Defender correlates the alerts and signals related to initial phishing generated](https://www.microsoft.com/security/business/threat-protection/microsoft-365-defender?rtc=1)\nby suspicious inbox rule creation as well as suspicious device registration into a single easy\nto comprehend Incident.\n\n_Figure 7. Microsoft 365 Defender incident with suspicious device registration and inbox rule_\n[Microsoft Defender for Office 365 protects against email threats using its multi-layered email](https://www.microsoft.com/security/business/threat-protection/office-365-defender?rtc=1)\nfiltering stack, which includes edge protection, sender intelligence, content filtering, and post[delivery protection, in addition to including outbound spam filter policies to configure and](https://docs.microsoft.com/microsoft-365/security/office-365-security/external-email-forwarding?view=o365-worldwide)\ncontrol automatic email forwarding to external recipients. Moreover, Microsoft Defender for\n[Office 365 uses Safe Links feature to proactively protect users from malicious URLs in](https://docs.microsoft.com/microsoft-365/security/office-365-security/safe-links?view=o365-worldwide)\ninternal messages or in an Office document at time of click. Safe Links feature to proactively\nprotect users from malicious URLs in internal messages or in an Office document at time of\nclick.\n\n## Advanced hunting queries\n\n**Hunting for emails with phishing URL**\n\n\n-----\n\n```\nlet startTime ago(7d);\nlet endTime = now();\nEmailUrlInfo\n| where Timestamp between (startTime..endTime)\n| where UrlDomain matches regex @\"^[a-z]{5}\\.ar[a-z]{4,5}\\.xyz\"\n| project NetworkMessageId,Url\n| join (EmailEvents \n| where Timestamp between (startTime..endTime))\non NetworkMessageId\n\n```\n**Hunting for suspicious Inbox Ruleslet startTime = ago(7d);**\n```\n// Hunting for suspicious Inbox Rules\nlet startTime = ago(7d);\nlet endTime = now();\nCloudAppEvents\n| where Timestamp between(startTime .. endTime)\n| where ActionType == \"New-InboxRule\"\n| where RawEventData contains \"Spam Filter\"\n| where RawEventData has_any(\"junk\",\"spam\",\"phishing\",\"hacked\",\"password\",\"with you\")\n| where RawEventData contains \"DeleteMessage\" \n| project Timestamp, AccountDisplayName, AccountObjectId, IPAddress\n\n```\n**Hunting for rogue device registrations**\n```\n// Hunting for rogue device registrations\nlet startTime = ago(7d);\nlet endTime = now();\nCloudAppEvents\n| where Timestamp between(startTime .. endTime)\n| where ActionType == \"Add registered owner to device.\" \n| where RawEventData contains \"notorius\"\n| where AccountDisplayName == \"Device Registration Service\"\n| where isnotempty(RawEventData.ObjectId) and\nisnotempty(RawEventData.ModifiedProperties[0].NewValue) and\nisnotempty(RawEventData.Target[1].ID) and\nisnotempty(RawEventData.ModifiedProperties[1].NewValue)\n| extend AccountUpn = tostring(RawEventData.ObjectId)\n| extend AccountObjectId = tostring(RawEventData.Target[1].ID)\n| extend DeviceObjectId = tostring(RawEventData.ModifiedProperties[0].NewValue)\n| extend DeviceDisplayName = tostring(RawEventData.ModifiedProperties[1].NewValue)\n| project\nTimestamp,ReportId,AccountUpn,AccountObjectId,DeviceObjectId,DeviceDisplayName\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-18 - Evolved phishing- Device registration trick adds to phishers’ toolbox for victims without MFA.pdf"
    ],
    "report_names": [
        "2022-01-18 - Evolved phishing- Device registration trick adds to phishers’ toolbox for victims without MFA.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535750,
    "ts_updated_at": 1743041165,
    "ts_creation_date": 1653780009,
    "ts_modification_date": 1653780009,
    "files": {
        "pdf": "https://archive.orkl.eu/4edcb75643abb0c493d6a94a3a863f3cb606dd6e.pdf",
        "text": "https://archive.orkl.eu/4edcb75643abb0c493d6a94a3a863f3cb606dd6e.txt",
        "img": "https://archive.orkl.eu/4edcb75643abb0c493d6a94a3a863f3cb606dd6e.jpg"
    }
}