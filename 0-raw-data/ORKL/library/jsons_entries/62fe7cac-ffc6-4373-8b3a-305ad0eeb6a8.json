{
    "id": "62fe7cac-ffc6-4373-8b3a-305ad0eeb6a8",
    "created_at": "2023-01-12T14:59:01.929727Z",
    "updated_at": "2025-03-27T02:06:08.566985Z",
    "deleted_at": null,
    "sha1_hash": "013686288be6448f6f3d32329d9efe67a0361f14",
    "title": "2022-12-02 - KoiVM Loader Resurfaces With a Bang",
    "authors": "",
    "file_creation_date": "2022-12-29T00:24:10Z",
    "file_modification_date": "2022-12-29T00:24:10Z",
    "file_size": 1958996,
    "plain_text": "# KoiVM Loader Resurfaces With a Bang\n\n**[labs.k7computing.com/index.php/koivm-loader-resurfaces-with-a-bang/](https://labs.k7computing.com/index.php/koivm-loader-resurfaces-with-a-bang/)**\n\nBy Rahul R December 2, 2022\n\nWe at K7 Labs recently found an interesting new .NET loader which downloads and\n[executes KoiVM virtualized binary, which in turn drops Remcos RAT and Agent Tesla](https://github.com/Loksie/KoiVM-Virtualization#koivm)\n[based on the availability of its C2. The samples under consideration uses hastebin URLs](https://hastebin.com/about.md)\nas its C2 server to download the next stage payloads. The overall flow of this multistage\nmalware can be observed in the following flow diagram.\n\n\n-----\n\nFigure 1: Execution Flow\nThe initial downloader is dropped through spam emails containing attachments of the\nnames “New Orders.zip” or “Export Invoice – 8026137.zip”. The Zip contains a .NET\nexecutable with the same name as the Zip file and disguises itself as a calculator\napplication. However, it is actually a multistage downloader.\n\nFigure 2: Original Name of Downloader\n\n## Stage-1 (Downloader Analysis)\n\nThe downloader initially starts to decode the C2 using an interesting decoding routine\ngiven below.\n\n\n-----\n\nFigure 3: C2 decoding routine\nEach character of the C2 string is XOR’ed with the index value of the corresponding\ncharacter to obtain the C2 address. We can easily mimic this in Python using the code\ngiven below.\n```\n“””\n\nCode to decode C2 URL’s\n\n“””\n\nc2servers = \"\"\n\ndecoded = r\"huvsw?)\n(`hy\\u007fioga>r}~;gw`7w{huwquISW\\u000fLQRW[\\u0013\\u0005\\u0004DL]\n[US[]\\u001aVYZ\\u0017K[L\\u0013^_N5,7!1<)\"\n\nfor c in range(0, len(decoded)):\n\n  c2servers += chr(ord(decoded[c]) ^ c)\n\nprint(c2servers.replace(\",\", \"\\n\"))\n\nExtracted C2’s:\n\nhxxps://hastebin[.]com/raw/nasijojiru\n\nhxxps://hastebin[.]com/raw/caqumubuyo\n\n\n```\nOnce the C2 address is decoded, it sends a GET request to download the encoded 2nd\nstage KoiVM Droppers. After receiving the response from the server, the downloader starts\nits multistage decoding routine. It base64 decodes the response and decompresses it in\nmemory using the DeflateStream class. The resultant buffer is XORed with the hardcoded\nkey in the stage-1 downloader “M4use” to get the final decoded stage-2 KoiVM dropper\nbinaries.\n\nFigure 4: Payload decoding flow\n\n\n-----\n\n## Stage2 (Virtualized Droppers)\n\nFigure 5: KoiVM Dropper\nThe stage-2 payload is highly obfuscated and virtualized with KoiVM. It is used along with\n[ConfuserEx to virtualize the execution of the sample. It changes all the IL-Instruction to the](https://github.com/yck1509/ConfuserEx)\nbyte format understandable only by the KoiVM Runtime.\n\nAs stated in KoiVM [Readme, virtualization with KoiVM can be done in two ways](https://github.com/Loksie/KoiVM-Virtualization#:~:text=first%20one%20is%20certainly%20ridiculous%20as%20it%20will%20%22merge%22%20with%20cex%20and%20virtualize%20every%20single%20method%2C%20including%20protections%20from%20ConfuserEX%2C%20however%20note%20that%20this%20might%20KILL%20your%20performan)\n\n1. Virtualize only the methods which we select\n2. Virtualize all the functions including ConfuserEx integrity protection\n\nThe stage-2 dropper payloads had chosen the 2nd option to virtualize all the functions,\nwhich made our analysis harder. Since Win32API and structs are accessed using PInvoke\nin C# and it can’t be virtualized or obfuscated, we were able to identify the API’s and\ncorrelate the behavior of this KoiVM dropper. The sample imports all the API’s which are\nrequired for Process Injection and In-memory execution.\n\n\n-----\n\nFigure 6: Imports accessed through PInvoke\nThe encoded stage-3 payload is found in the resource section of the KoiVM binary. On\nanalyzing the blob, we found an interesting string pattern which seems to be repeating.\nWhen Null bytes are XOR’ed with a key, the resultant value is the key itself. Since the 3rd\nstage payload has many NULL bytes we are able to extract the XOR key used for\ndecoding. Similarly, the KoiVM sample downloaded from the other hastebin URL (second\nC2 address) had a similar pattern. There are two different final 3 stage payloads whichrd\nare dropped based on the C2 address accessed, of which the first binary is XOR decoded\nusing the key “Jus3ify” and the second binary is XOR decoded using the key “Monito3“.\n\n\n-----\n\nFigure 7: Decoded stage-3 payloads\n[The key can also be identified by debugging the KoiVM Runtime using dnSpyEx and](https://github.com/dnSpyEx)\nstepping into the yielder function “SelectIterator” as shown in image below. We were able\nto view payload data and key as plaintext because all functions of KoiVM dropper binary\nare only virtualized and not the calls to string methods.\n\n\n-----\n\nFigure 8: XOR key in memory\n\nFigure 9: XOR decoded payload in memory\n\n## Stage 3\n\n**Agent Tesla**\n\nUsing [Detect it Easywe were able to identify that stage-3 payload is obfuscated with .Net](https://github.com/horsicq/Detect-It-Easy)\n**[Reactor, thus we used .NetSlayer to de-obfuscate the sample to analyze further.](https://github.com/SychicBoy/NETReactorSlayer)**\n\n\n-----\n\nFigure 10: Trying to de-virtualize using .NET Slayer\nThe tool was not able to completely de-obfuscate the sample, for example we could see\nthat the Agent Tesla binary has implemented control flow flattening, but the tool was not\nable to unflatten it. The strings are present in raw hex form using string interning.\n\nFigure 11: Control flow flattening implemented in\n\nAgent Tesla\n\n\n-----\n\nThe Agent Tesla malware has the capability to log keystrokes, steal browser cookies and\ncrypto wallets and send it to C2. All the strings are saved as raw bytes by using string\ninterning and they are accessed with respective index and length using a class method.\n\nFigure 12: Configuration stored using string interning\nOn dumping the strings, we got a configuration file and confirmed it as Agent Tesla\nmalware.\n\nFigure 13: Tesla Configuration\nAgent Tesla is an info stealing malware, which collects keystrokes, browser cookies, and\nsystem information. The collected data is sent as an attachment to a mail id –\npeterashley202@gmail[.]com.\n\n**Remcos RAT**\n\n\n-----\n\nOn viewing the strings from stage-2 payload (the KoiVM payload2 from the second\nhastebin URL), we were able to identify the final payload to be Remcos RAT which was\nconfirmed by extracting the configuration from KoiVM payload2’s resource section.\n\nFigure 14:\n\nRemcos Agent String\nThe RC4 encrypted configuration of Remcos RAT is saved in the resource section as\n“SETTINGS”.\n\nFigure 15: Remcos RAT encrypted config stored in resource\nThe first byte in the configuration file is the length of RC4 key(n). The next n bytes are the\nRC4 key followed by the payload bytes.\n\n\n-----\n\nFigure 16: Remcos Configuration\nRemcos RAT steals browser cookies, takes current window screenshots and sends it to\nthe C2 present in Configuration. It establishes a listener connection with the C2 and waits\nfor the attacker to send commands to execute.\n\nWe at K7 Labs provide detection against latest threats and also for this newer variant of\nLoader. Users are advised to use a reliable security product such as “K7 Total Security”\nand keep it up-to-date so as to safeguard their devices.\n\n**IOCs**\n\n**Filename** **MD5 Hash** **K7 Detection**\n**Name**\n\n**Stage1**\n\nLoader 908A565A9041D68A2FEA61329D4C42B4 Trojan\nDownloader (\n00599fcf1 )\n\n**Stage2 (KoiVM)**\nTesla 859E6D2588B14AA298F22F3E70043C69 Trojan (\n\nDropperRemcos 3A62051DD210BC85C93BF343DCD8ACAD 0058ba9a1 )\nDropper Trojan (\n\n0058ba9a1 )\n\n\n-----\n\n**Stage3 (Stealer)**\n\nAgent Tesla\n\nRemcos RAT\n\n## C2\n\n\n77047DAC5FE6958A3C7C9DD1DE08C854\n\n40B71E34E832DEACFFB9589F2BB87323\n\n\nSpyware (\n0058f8971 )\n\nTrojan (\n0053ac2c1 )\n\n\nhxxps://hastebin[.]com/raw/nasijojiru     – Agent Tesla\n\nhxxps://hastebin[.]com/raw/caqumubuyo – Remcos RAT\n\n## IP\n\n172.111.234[.]110:5888\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-12-02 - KoiVM Loader Resurfaces With a Bang.pdf"
    ],
    "report_names": [
        "2022-12-02 - KoiVM Loader Resurfaces With a Bang.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535541,
    "ts_updated_at": 1743041168,
    "ts_creation_date": 1672273450,
    "ts_modification_date": 1672273450,
    "files": {
        "pdf": "https://archive.orkl.eu/013686288be6448f6f3d32329d9efe67a0361f14.pdf",
        "text": "https://archive.orkl.eu/013686288be6448f6f3d32329d9efe67a0361f14.txt",
        "img": "https://archive.orkl.eu/013686288be6448f6f3d32329d9efe67a0361f14.jpg"
    }
}