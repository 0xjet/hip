{
    "id": "489e08ec-5c85-4784-8cee-727b08dc9feb",
    "created_at": "2023-01-12T15:03:07.730657Z",
    "updated_at": "2025-03-27T02:06:06.320607Z",
    "deleted_at": null,
    "sha1_hash": "d813fb2c14a958c6e1024e08de5da89a2b296d03",
    "title": "2020-12-15 - Sunburst Backdoor- A Deeper Look Into The SolarWinds' Supply Chain Malware (Broken link)",
    "authors": "",
    "file_creation_date": "2022-09-01T10:12:26Z",
    "file_modification_date": "2022-09-01T10:12:26Z",
    "file_size": 2493786,
    "plain_text": "# Prevasio\n\n**[prevasio.io/blog/sunburst-backdoor-a-deeper-look-into-the-solarwinds-supply-chain-malware](https://www.prevasio.io/blog/sunburst-backdoor-a-deeper-look-into-the-solarwinds-supply-chain-malware)**\n\nBy\n\nSergei Shevchenko\n\nDecember 15, 2020\n\n## Sunburst Backdoor: A Deeper Look Into The SolarWinds' Supply Chain Malware\n\n_[Update: Next two parts of the analysis are available here and](https://www.prevasio.io/blog/sunburst-backdoor-part-ii-dga-the-list-of-victims)_ [here.](https://www.prevasio.io/blog/sunburst-backdoor-part-iii-dga-security-software)\n\nAs earlier [reported by FireEye, the actors behind a global intrusion campaign have managed](https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html)\nto trojanise SolarWinds Orion business software updates in order to distribute malware.\n\nThe original FireEye write-up already provides a detailed description of this malware.\nNevertheless, as the malicious update SolarWinds-Core-v2019.4.5220-Hotfix5.msp was\nstill available for download for hours since the FireEye's post, it makes sense to have\nanother look into the details of its operation.\n\nThe purpose of this write-up is to provide new information, not covered in the original writeup. Any overlaps with the original description provided by FireEye are not intentional.\n\n\n-----\n\nFor start, the malicious component SolarWinds.Orion.Core.BusinessLayer.dll inside the\nMSP package is a non-obfuscated .NET assembly. It can easily be reconstructed with a\n.NET disassembler, such as [ILSpy, and then fully reproduced in C# code, using Microsoft](https://github.com/icsharpcode/ILSpy)\nVisual Studio. Once reproduced, it can be debugged to better understand how it works.\n\nIn a nutshell, the malicious DLL is a backdoor. It is loaded into the address space of the\nlegitimate SolarWinds Orion process SolarWinds.BusinessLayerHost.exe or\n**SolarWinds.BusinessLayerHostx64.exe.**\n\nThe critical strings inside the backdoor's class\n**SolarWinds.Orion.Core.BusinessLayer.OrionImprovementBusinessLayer are encoded**\nwith the _[DeflateStream Class of the .NET's System.IO.Compression library, coupled with the](https://docs.microsoft.com/en-us/dotnet/api/system.io.compression.deflatestream?view=net-5.0)_\nstandard base64 encoder.\n\n**Initialisation**\n\nOnce loaded, the malware checks if its assembly file was created earlier than 12, 13, or 14\ndays ago. The exact number of hours it checks is a random number from 288 to 336.\n\nNext, it reads the application settings value ReportWatcherRetry. This value keeps the\nreporting status, and may be set to one of the states:\n\nNew (4)\nTruncate (3)\nAppend (5)\n\nWhen the malware runs the first time, its reporting status variable ReportWatcherRetry is\nset to New (4).\n\nThe reporting status is an internal state that drives the logic. For example, if the reporting\nstatus is set to Truncate, the malware will stop operating by first disabling its networking\ncommunications, and then disabling other security tools and antivirus products.\n\nIn order to stay silent, the malware periodically falls asleep for a random period of time that\nvaries between 30 minutes and 2 hours.\n\nAt the start, the malware obtains the computer's [domain name. If the domain name is empty,](https://docs.microsoft.com/en-us/dotnet/api/system.net.networkinformation.ipglobalproperties.domainname?redirectedfrom=MSDN&view=net-5.0#System_Net_NetworkInformation_IPGlobalProperties_DomainName)\nthe malware quits.\n\nIt then generates a 8-byte User ID, which is derived from the system footprint. In particular, it\nis generated from MD5 hash of a string that consists from the 3 fields:\n\nthe first or default operational (can transmit data packets) network interface's physical\naddress\ncomputer's domain name\n\n\n-----\n\nUUID created by Windows during installation (machine s unique ID)\n\nEven though it looks random, the User ID stays permanent as long as networking\nconfiguration and the Windows installation stay the same.\n\n**Domain Generation Algorithm**\n\nThe malware relies on its own CryptoHelper class to generate a domain name. This class is\ninstantiated from the 8-byte User ID and the computer's domain name, encoded with a\nsubstitution table: \"rq3gsalt6u1iyfzop572d49bnx8cvmkewhj\".\n\nFor example, if the original domain name is \"domain\", its encoded form will look like:\n\"n2huov\".\n\nTo generate a new domain, the malware first attempts to resolve domain name\n\"api.solarwinds.com\". If it fails to resolve it, it quits.\n\nThe first part of the newly generated domain name is a random string, produced from the 8byte User ID, a random seed value, and encoded with a custom base64 alphabet\n**\"ph2eifo3n5utg1j8d94qrvbmk0sal76c\".**\n\nBecause it is generated from a random seed value, the first part of the newly generated\ndomain name is random.\n\nFor example, it may look like \"fivu4vjamve5vfrt\" or \"k1sdhtslulgqoagy\".\n\nTo produce the domain name, this string is then appended with the earlier encoded domain\nname (such as \"n2huov\") and a random string, selected from the following list:\n\n.appsync-api.eu-west-1[.]avsvmcloud[.]com\n.appsync-api.us-west-2[.]avsvmcloud[.]com\n.appsync-api.us-east-1[.]avsvmcloud[.]com\n.appsync-api.us-east-2[.]avsvmcloud[.]com\n\nFor example, the final domain name may look like:\n\nfivu4vjamve5vfrtn2huov[.]appsync-api.us-west-2[.]avsvmcloud[.]com\n\nor\n\nk1sdhtslulgqoagyn2huov[.]appsync-api.us-east-1[.]avsvmcloud[.]com\n\nNext, the domain name is resolved to an IP address, or to a list of IP addresses. For\nexample, it may resolve to 20.140.0.1.\n\nThe resolved domain name will be returned into IPAddress structure that will contain an\n**[AddressFamily field - a special field that specifies the addressing scheme.](https://docs.microsoft.com/en-us/dotnet/api/system.net.sockets.addressfamily?view=net-5.0)**\n\n\n-----\n\nIf the host name returned in the IPAddress structure is different to the queried domain name,\nthe returned host name will be used as a C2 host name for the backdoor.\n\nOtherwise, the malware will check if the resolved IP address matches one of the patterns\nbelow, in order to return an 'address family':\n\n**IP Address** **Subnet Mask** **'Address Family'**\n\n10.0.0.0 255.0.0.0 Atm\n\n172.16.0.0 255.240.0.0 Atm\n\n192.168.0.0 255.255.0.0 Atm\n\n224.0.0.0 240.0.0.0 Atm\n\nfc00:: fe00:: Atm\n\nfec0:: ffc0:: Atm\n\nff00:: ff00:: Atm\n\n41.84.159.0 255.255.255.0 Ipx\n\n74.114.24.0 255.255.248.0 Ipx\n\n154.118.140.0 255.255.255.0 Ipx\n\n217.163.7.0 255.255.255.0 Ipx\n\n20.140.0.0 255.254.0.0 ImpLink\n\n96.31.172.0 255.255.255.0 ImpLink\n\n131.228.12.0 255.255.252.0 ImpLink\n\n144.86.226.0 255.255.255.0 ImpLink\n\n8.18.144.0 255.255.254.0 NetBios\n\n18.130.0.0 255.255.0.0 NetBios\n\n71.152.53.0 255.255.255.0 NetBios\n\n99.79.0.0 255.255.0.0 NetBios\n\n87.238.80.0 255.255.248.0 NetBios\n\n199.201.117.0 255.255.255.0 NetBios\n\n184.72.0.0 255.254.0.0 NetBios\n\n\n-----\n\nFor example, if the queried domain resolves to 20.140.0.1, it will match the entry in the table\n**20.140.0.0, for which the returned 'address family' will be ImpLink.**\n\nThe returned 'address family' invokes an additional logic in the malware.\n\n**Disabling Security Tools and Antivirus Products**\n\nIf the returned 'address family' is ImpLink or Atm, the malware will enumerate all processes\nand for each process, it will check if its name matches one of the pre-defined hashes.\n\nNext, it repeats this processed for services and for the drivers installed in the system. If a\nprocess name or a full path of an installed driver matches one of the pre-defined hashes, the\nmalware will disable it.\n\n[For hashing, the malware relies on Fowler–Noll–Vo algorithm.](https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function)\n\nFor example, the core process of Windows Defender is MsMpEng.exe. The hash value of\n\"MsMpEng\" string is 5183687599225757871. This value is specifically enlisted the malware's\nsource under a variable name timeStamps:\n\ntimeStamps = new ulong[1]\n\n{\n\n5183687599225757871uL\n\n}\n\nThe service name of Windows Defender is windefend - the hash of this string\n(917638920165491138) is also [present in the malware body. As a result, the malicioius DLL](https://github.com/fireeye/sunburst_countermeasures/blob/main/fnv1a_xor_hashes.txt)\nwill attempt to stop the Windows Defender service.\n\nIn order to disable various security tools and antivirus products, the malware first grants itself\n**SeRestorePrivilege and SeTakeOwnershipPrivilege privileges, using the native**\n**AdjustTokenPrivileges() API. With these privileges enabled, the malware takes ownership**\nof the service registry keys it intends to manipulate.\n\nThe new owner of the keys is first attempted to be explicitly set to Administrator account. If\nsuch account is not present, the malware enumerates all user accounts, looking for a SID\nthat represents the administrator account.\n\nThe malware uses Windows Management Instrumentation query \"Select * From\n_Win32_UserAccount\" to obtain the list of all users. For each enumerated user, it makes sure_\nthe account is local and then, when it obtains its SID, it makes sure the SID begins with S-1**[5- and ends with -500 in order to locate the local administrator account.](https://devblogs.microsoft.com/scripting/how-can-i-determine-if-the-local-administrator-account-has-been-renamed-on-a-computer/)**\n\nOnce such account is found, it is used as a new owner for the registry keys, responsible for\nmanipulation of the services of various security tools and antivirus products. With the new\n[ownership set, the malware then disables these services by setting their Start value to 4](http://smallvoid.com/article/winnt-services-regedit.html)\n(Disabled):\n\n\n-----\n\nregistryKey2.SetValue( Start ), 4, RegistryValueKind.DWord);\n\n**HTTP Backdoor**\n\nIf the returned 'address family' for the resolved domain name is NetBios, as specified in the\nlookup table above, the malware will initialise its HttpHelper class, which implements an\nHTTP backdoor.\n\nThe backdoor commands are covered in the FireEye write-up, so let's check only a couple of\ncommands to see what output they produce.\n\nOne of the backdoor commands is CollectSystemDescription. As its name suggests, it\ncollects system information. By running the code reconstructed from the malware, here is an\nactual example of the data collected by the backdoor and delivered to the attacker's C2 with\na separate backdoor command UploadSystemDescription:\n\n1. %DOMAIN_NAME%\n\n2. S-1-5-21-298510922-2159258926-905146427\n\n3. DESKTOP-VL39FPO\n\n4. UserName\n\n5. [E] Microsoft Windows NT 6.2.9200.0 6.2.9200.0 64\n\n6. C:\\WINDOWS\\system32\n\n7. 0\n\n8. %PROXY_SERVER%\n\nDescription: Killer Wireless-n/a/ac 1535 Wireless Network Adapter #2\n\nMACAddress: 9C:B6:D0:F6:FF:5D\n\nDHCPEnabled: True\n\nDHCPServer: 192.168.20.1\n\nDNSHostName: DESKTOP-VL39FPO\n\nDNSDomainSuffixSearchOrder: Home\n\nDNSServerSearchOrder: 8.8.8.8, 192.168.20.1\n\nIPAddress: 192.168.20.30, fe80::8412:d7a8:57b9:5886\n\nIPSubnet: 255.255.255.0, 64\n\nDefaultIPGateway: 192.168.20.1, fe80::1af1:45ff:feec:a8eb\nNOTE: Field #7 specifies the number of days (0) since the last system reboot.\n\n**GetProcessByDescription command will build a list of processes running on a system. This**\ncommand accepts an optional argument, which is one of the custom process properties\n[enlisted here.](https://weblogs.asp.net/dixin/query-operating-system-processes-in-c)\n\nIf the optional argument is not specified, the backdoor builds a process list that looks like:\n\n[ 1720] svchost\n\n[ 8184] chrome\n\n\n-----\n\n[ 4732] svchost\n\nIf the optional argument is specified, the backdoor builds a process list that includes the\nspecified process property in addition to parent process ID, username and domain for the\nprocess owner.\n\nFor example, if the optional argument is specified as \"ExecutablePath\", the\n**GetProcessByDescription command may return a list similar to:**\n\n[ 3656] sihost.exe    C:\\WINDOWS\\system32\\sihost.exe   1720 DESKTOP-VL39FPO\\UserName\n\n[ 3824] svchost.exe   C:\\WINDOWS\\system32\\svchost.exe    992 DESKTOP-VL39FPO\\UserName\n\n[ 9428] chrome.exe    C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe   4600\nDESKTOP-VL39FPO\\UserName\n\nOther backdoor commands enable deployment of the 2nd stage malware. For example, the\n**WriteFile command will save the file:**\n\nusing (FileStream fileStream = new FileStream(path, FileMode.Append, FileAccess.Write))\n\n{\n\nfileStream.Write(array, 0, array.Length);\n\n}\n\nThe downloaded 2nd stage malware can then the executed with RunTask command:‍\n\nusing (Process process = new Process())\n\n\n{\n\nprocess.StartInfo = new ProcessStartInfo(fileName, arguments)\n\n{\n\nCreateNoWindow = false,\n\nUseShellExecute = false\n\n};\n\nif (process.Start())\n\n...\n\nAlternatively, it can be configured to be executed with the system restart, using registry\nmanipulation commands, such as SetRegistryValue.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-12-15 - Sunburst Backdoor- A Deeper Look Into The SolarWinds' Supply Chain Malware (Broken link).pdf"
    ],
    "report_names": [
        "2020-12-15 - Sunburst Backdoor- A Deeper Look Into The SolarWinds' Supply Chain Malware (Broken link).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535787,
    "ts_updated_at": 1743041166,
    "ts_creation_date": 1662027146,
    "ts_modification_date": 1662027146,
    "files": {
        "pdf": "https://archive.orkl.eu/d813fb2c14a958c6e1024e08de5da89a2b296d03.pdf",
        "text": "https://archive.orkl.eu/d813fb2c14a958c6e1024e08de5da89a2b296d03.txt",
        "img": "https://archive.orkl.eu/d813fb2c14a958c6e1024e08de5da89a2b296d03.jpg"
    }
}