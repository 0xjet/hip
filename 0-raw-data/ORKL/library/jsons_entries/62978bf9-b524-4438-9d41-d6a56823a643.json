{
    "id": "62978bf9-b524-4438-9d41-d6a56823a643",
    "created_at": "2023-01-12T15:07:45.030033Z",
    "updated_at": "2025-03-27T02:05:48.468012Z",
    "deleted_at": null,
    "sha1_hash": "d5b311741c41e6a50d3d08518d3213c34cbc4843",
    "title": "2016-09-23 - Hancitor (AKA Chanitor) observed using multiple attack approaches",
    "authors": "",
    "file_creation_date": "2022-05-27T19:09:51Z",
    "file_modification_date": "2022-05-27T19:09:51Z",
    "file_size": 84516,
    "plain_text": "# Hancitor (AKA Chanitor) observed using multiple attack approaches\n\n**[fireeye.com/blog/threat-research/2016/09/hancitor_aka_chanit.html](https://www.fireeye.com/blog/threat-research/2016/09/hancitor_aka_chanit.html)**\n\n## Breadcrumb\n\nThreat Research\n\nAnkit Anubhav, Dileep Jallepalli\n\nSep 23, 2016\n\n5 mins read\n\nMany threat actors use multiple attack vectors to ensure success. The individuals using\nHancitor malware (also known by the name Chanitor) are no exception and have taken three\napproaches to deliver the malware in order to ultimately steal data from their victims. These\ntechniques include uncommon API abuse and PowerShell methods.\n\n\n-----\n\nWe recently observed Hancitor attacks against some of our FireEye Exploit Guard\ncustomers. The malicious document used to deliver the Hancitor executable was observed\nbeing distributed as an attachment in email spam. Once downloaded and executed, it drops\nan intermediate payload that further downloads a Pony DLL and Vawtrak executable, which\nperform data theft and connect to a command and control (C2) server.\n\nStage 1: Email Delivery\n\nWe observed a number of phishing emails that reference an invoice, as seen in Figure 1.\nThe attachment in these emails is a weaponized Microsoft Office document containing a\nmalicious macro that – when enabled – leads to the download of Hancitor.\n\n\nEmail with a malicious document attached\n\n\nFigure 1: Email with a malicious document attached\nStage 2: Macro and Luring Mechanism\n\n\n-----\n\nUpon opening the attachment, a typical luring mechanism is employed instructing the victim\nto enable macros, as seen in Figure 2. FireEye has observed the attackers behind this\ncampaign using three different approaches.\n\n\nLuring the victim to enable macros\n\n\nFigure 2: Luring the victim to enable macros\nFirst Approach\n\nUnlike other malicious macros, this one is not using APIs directly to run the payload. Macros\ncan call APIs directly, but normally are not supposed to run shellcode. The macro used to\ndeliver Hancitor calls the native Windows API, “CallWindowProc”, which can be used to\ninterpret and execute shellcode, as depicted in Figure 3.\n\n\n-----\n\nCode within the macro that uses the CallWindowProc API to execute shellcode\n\n\nFigure 3: Code within the macro that uses the CallWindowProc API to execute shellcode\nSecond Approach\n\nRecently, FireEye Exploit Guard captured Hancitor samples that leverage a new API\nCallback function. In addition to “CallWindowProc”, Hancitor samples may use the function\nEnumResourceTypesA to interpret and execute shellcode, as seen in Figure 4.\n\n\n-----\n\nEnumResourceTypesA API declaration\n\n\nFigure 4: EnumResourceTypesA API declaration\nThird Approach\n\nWe also observed a third approach used by a malicious document file to deliver Hancitor.\nAlthough the threat actor and command and control servers are similar to the second\nHancitor delivery approach, this one uses an alternate tactic to reach its goal of data theft.\n\nWith this approach, the luring message shown in the Figure 2 now serves another purpose.\nNot only does it lure the victim into enabling the macros, but it also is assigned an alternate\ntext: “fkwarning”, as seen in Figure 5. The macro has code to check this attribute to make\nsure the luring message shape object is present. If this object is not found, the macro will exit\nwithout downloading additional payloads.\n\n\n-----\n\nCode to ensure that the luring message is intact and the malicious document is\nexecuted for the first time\n\nFigure 5: Code to ensure that the luring message is intact and the malicious document is\nexecuted for the first time\nEven if it finds the luring message, it will run the macro once and will delete the shape so that\nthe macro will never be executed again, as seen in Figure 6.\n\n\n-----\n\nCode to delete the shape that includes the lure message\n\n\nFigure 6: Code to delete the\n\nshape that includes the lure message\nThe malicious macro replaces the deleted image with another that displays the text “network\nerror” to reduce user suspicions, as shown in Figure 7. Note that text is always present in the\nmalicious macro, but it will only be made visible by the macro when it is executing for the first\ntime.\n\n\n-----\n\nThe hidden text that becomes visible once the macro is\nexecuted for the first time\n\nFigure 7: The hidden text that\n\nbecomes visible once the macro is executed for the first time\nThe macro then combines fragments of code to make a PowerShell command. However,\nunlike in the other approaches, the malicious code is not hidden in the code or form or\nmetadata. We observed that the malware extracts malicious code fragments from within the\nsection_header of the embedded image and combines them into a PowerShell command on\nthe fly, as seen in Figure 8. This technique will evade some basic static methods of detection\napplied to macros macro forms.\n\n\n-----\n\nPowerShell command observed in header after increasing font size\n\n\nFigure 8: PowerShell command observed in header after increasing font size\nThe malware authors have taken a very simple but interesting approach to obscure the\nPowerShell command text. The font size is set to microscopic level 1, as seen in Figure 9.\nThis reduces the likelihood that a casual observer will notice something unusual.\n\n\n-----\n\nMinimal font size to hide content of header\n\n\nFigure 9: Minimal font size to hide content\n\nof header\nUsing the “DownloadFile” method, PowerShell obtains a payload from an attacker-controlled\nwebsite in a ZIP archive format. PowerShell uses the “copyhere” function to unzip the\npayload. The “.Item” attribute is also set to “16”, which ignores all warnings, as seen in\nFigure 10.\n\n\n-----\n\nCode to download archived payload and unzip it\n\n\nFigure 10: Code to download archived payload and unzip it\nOnce the downloaded executable is extracted from the ZIP archive, the macro code deletes\nthe archive using the “Kill” function, as seen in Figure 11. After the executable is executed, it\ndownloads Pony and Vawtrak malware variants to steal data.\n\n\n-----\n\nCode to delete the archive\n\n\nFigure 11: Code to delete the archive\n\nDifferent Approaches, Same Hancitor\n\nAlthough there are differences between the second and third approaches to distributing\nHancitor, the objective of the threat actor is the same, as we found the same command and\ncontrol server being used in both approaches.\n\nHowever, we can see a minor change in the second Hancitor approach command and\ncontrol servers when compared to the first Hancitor approach command and control servers,\nwith URLs ending with ls5/gate.php instead of ls4/gate.php, as seen in Figure 12.\n\n\n-----\n\nEarlier and newer Hancitor gates\n\n\nFigure 12: Earlier and newer\n\nHancitor gates\nStage 3: First stage payload\n\nThe file copies itself to “%system32%” and creates a registry run key entry for persistence.\nUpon execution, it will communicate with an attacker-controller website to download a variant\nof the Pony malware, “pm.dll” along with a standard Vawtrak trojan.\n\nStage 4: Second stage payload Pony data exfiltration capabilities\n\nWe observed a number of data theft capabilities in the second stage Pony variant, including:\n\n1) Stealing autocomplete Intelliforms data, which may include user passwords, as seen in\nFigure 13.\n\n\n-----\n\nStealing the content of the Intelliforms registry key\n\n\nFigure 13: Stealing the content of the Intelliforms registry key\n2) The unique GUID seen in Figure 14 helps to decrypt credentials from credential store.\nThere is a good amount of documentation on various forums on how to use this salted value\nto access credentials.\n\n\n-----\n\nCredential stealing\n\n\nFigure 14: Credential stealing\n3) Accessing Mozilla saved passwords from “signons.txt,” as seen in Figure 15.\n\n\n-----\n\nAccessing Mozilla saved passwords\n\n\nFigure 15: Accessing\n\nMozilla saved passwords\n4) Figure 16 shows the malware code related to theft via accessing Microsoft OMI Email\nconfiguration information. We can also see registry entries related to storing Outlook Profile,\nwhich contains information about where emails and other data is stored being accessed.\n\n\n-----\n\nMalware code for Outlook data theft via registry access\n\n\nFigure 16: Malware code for Outlook data theft via registry access\n\n**Conclusion**\n\nThe malware authors responsible for Hancitor have developed several capabilities within\nmalicious macros that support malware installation and data theft. These capabilities include\nleveraging uncommon APIs and obscuring malicious PowerShell commands, tactics that\nmade detection more challenging.\n\nFireEye Exploit Guard provides organizations with the ability to detect malicious shellcode in\nthe initial phase of the attack lifecycle, regardless of these evasion techniques.\n\nFireEye recommends that organizations block macros in Microsoft Office documents that\noriginate from the Internet by Group Policy. In all cases, users should be cautious about\n\n\n-----\n\nenabling macros and should practice vigilance about opening email messages from\nuntrusted sources.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-09-23 - Hancitor (AKA Chanitor) observed using multiple attack approaches.pdf"
    ],
    "report_names": [
        "2016-09-23 - Hancitor (AKA Chanitor) observed using multiple attack approaches.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536065,
    "ts_updated_at": 1743041148,
    "ts_creation_date": 1653678591,
    "ts_modification_date": 1653678591,
    "files": {
        "pdf": "https://archive.orkl.eu/d5b311741c41e6a50d3d08518d3213c34cbc4843.pdf",
        "text": "https://archive.orkl.eu/d5b311741c41e6a50d3d08518d3213c34cbc4843.txt",
        "img": "https://archive.orkl.eu/d5b311741c41e6a50d3d08518d3213c34cbc4843.jpg"
    }
}