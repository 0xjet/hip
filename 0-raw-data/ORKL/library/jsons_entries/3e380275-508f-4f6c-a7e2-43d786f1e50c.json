{
    "id": "3e380275-508f-4f6c-a7e2-43d786f1e50c",
    "created_at": "2023-01-12T15:03:16.007596Z",
    "updated_at": "2025-03-27T02:05:47.61707Z",
    "deleted_at": null,
    "sha1_hash": "fff7468a0ed5d472b6550d6e5b222c78aeec7fcd",
    "title": "2022-02-02 - Catching the RAT called Agent Tesla",
    "authors": "",
    "file_creation_date": "2022-05-28T16:13:27Z",
    "file_modification_date": "2022-05-28T16:13:27Z",
    "file_size": 1633110,
    "plain_text": "# Catching the RAT called Agent Tesla\n\n**[blog.qualys.com/vulnerabilities-threat-research/2022/02/02/catching-the-rat-called-agent-tesla](https://blog.qualys.com/vulnerabilities-threat-research/2022/02/02/catching-the-rat-called-agent-tesla)**\n\nGhanshyam More February 2, 2022\n\nFor the last few years, the Qualys Research Team has been observing an infamous “Malware-as-a-service” RAT (Remote Access Trojan)\ncalled Agent Tesla.\n\nIt first appeared in 2014, and since then many variants have been deployed. This malware uses multiple techniques for evading detection as\nwell as making analysis quite difficult. Agent Tesla mainly gets delivered through phishing emails and has capabilities such as keylogging,\nscreen capture, form-grabbing, credential stealing, and more. It will also exfiltrate credentials from multiple software programs like Google\nChrome, Mozilla Firefox, and Microsoft Outlook – making its potential impact truly catastrophic.\n\nThe malware itself goes through multiple layers of unpacking before deploying its final payload, which is very similar behavior to what’s found\n[in families like Formbook. Agent Tesla is dotnet compiled malware and uses a steganography technique. We have observed a sudden](https://en.wikipedia.org/wiki/Steganography)\nincrease in the use of this technique.\n\nThis blog reviews Agent Tesla malware’s updated functionality as well as its ongoing evolution.\n\n## Technical Analysis:\n\nAgent Tesla performs two-level unpacking to get its final payload delivered, as shown in this flow chart diagram.\n\n\n-----\n\nIn the malware sample, the method names and strings have been heavily obfuscated, as shown in fig. 1.\n\nFig.1 Main Payload Obfuscation\nAs we can see in fig. 2, the main payload code contains an obfuscated first stage PE dll file where char “@” is added for “000” at multiple\nlocations. This helps Agent Tesla evade signature-based detection.\n\nFig.2 first stage dll Obfuscated Code\nThis module is called “representative”, which is a dotnet compiled dll module. After de-obfuscation, the main payload loads this first stage dll\nmodule in memory.\n\nAgent Tesla uses a steganography technique as shown in fig. 3, where an image contains an embedded PE file. This resource image is used\nby the first stage dll module to extract the second stage dll module.\n\n\n-----\n\nFig.3 Resource containing PE File\nIn the first stage dll, “ResourceManager” is created and data from Bitmap “ApplicationTru” (which is present in the main payload) is collected\nas shown in fig. 4 below.\n\nFig. 4 Data from Main Payload Bitmap Collected\nAs shown in fig. 5, decryption routines are then carried out on collected data to generate the second stage module named “CF_Secretaria”.\n\nFig. 5 Decryption Routine for second Stage DLL\nIn this decryption routine, K1 points to the decryption key and P1 points to data collected from the “ApplicationTru” bitmap.\n\n\n-----\n\ne st stage d odu e oads t s C _Sec eta a e o y, a d t e t t a s e s co t o to t by ca g Ca y a e u ct o, as s o\nbelow fig. 6.\n\nFig. 6 Call Transfer To 2nd Stage Module\nThe second stage dll is heavily obfuscated with a utf8 encoding function name to make analysis difficult (fig. 7).\n\nFig. 7 Second Stage Dll Heavily obfuscated\nIn the second stage dll module, “ResourceManager” is created to read its resource “bcf6M”. This resource data contains an encrypted PE file\nwhich is the final payload. On the collected resource data, an initial XOR operation is carried out with the key “PnltzRBT”, as shown in fig. 8.\n\nFig. 8 Initial\n\nDecryption Routine for Final Payload\nInitial decryption logic is the same as is used for the second stage dll module extraction… but with a different key. After initial decryption\nroutines, further decryption is carried out where data is decrypted with a 16 bytes XOR key. This key is present at the start of the previously\ndecrypted buffer. After this decryption, the malware delivers the final payload (fig. 9).\n\n\n-----\n\nFig.9 Further Decryption Routine for Final Payload\nAfter this process, code injection is carried out in the main process (fig. 10).\n\nFig. 10 Code Injection in Main Process\nAfter performing a process hollowing into the current process, it starts stealing computer information.\n\nAgent Tesla collects information like computer name, TCP hostname, DNS client, domain, and more (fig. 11).\n\nFig.11 Computer Name and TCP Settings\nThe malware contains a predefined list of browsers, and it checks for their presence on the system (fig. 12).\n\n\n-----\n\nFig. 12 Browser Data Lookup\nIf these browser directories are found, it collects a list of all the files and folders present in them. Then it checks for the “User data” directory\nand, if found, next checks for the “Login Data” file that contains mail ids and password information of stored profiles. Fig. 13 shows code\nchecking for the presence of browsers information.\n\nFig.13 Browser Information\nAgent Tesla also checks for browser cookies and collects information about them. Fig. 14 shows profile collected information for the Edge\nbrowser.\n\n\n-----\n\nFig. 14 Collected Profile Information for Edge Browser\nThe sample also has capabilities to capture keystrokes. Fig. 15 shows the code that can be used in Keylogging.\n\nFig. 15 KeyLogging\n\nIt can also steal clipboard data (fig. 16).\n\nFig. 16 Stealing ClipboardData\nAgent Tesla also has the capability to capture a screenshot and send it in jpeg format. As can be seen in the code, the collected image is\nencoded and then converted to base64 format.\n\n\n-----\n\nFig. 17 Capturing a ScreenShot\nFurther, it also steals FTP credentials and sends them through the STOR method (fig. 18).\n\nFig. 18 FTP Credential Stealing\nIt searches for the “Open-VPN” “config” directory to steal credentials of it (fig. 19).\n\nFig. 19 OpenVPN Config Stealing\nAgent Tesla also has the capability to check for the NordVPN configuration and steal its credentials.\n\nIt can search for “recentservers.xml” of FileZilla to get information about recent FTP server connections.\n\nIt also steals information such as IMAP Password, POP3 Password, HTTP Password, and SMTP Password. For this, it checks Microsoft\nOutlook registry entries as shown below (fig. 20).\n\n\n-----\n\nFig. 20 Outlook Reg Lookup for Credentials\nThe sample encrypts data before communicating with its command & control server and uses the TOR client for keeping its communication\nand connection anonymous. It may download the TOR client from the TOR website (fig. 21).\n\nFig. 21 Using TorClient for C2C Communication\nStolen data is then exfiltrated over SMTP (fig. 22).\n\nFig. 22 Data Exfiltration Over SMTP\nThe email subject line contains the combination of OS and Computer name, and the body contains system information along with the stolen\ncredential information.\n\nFor persistence, the sample drops its copy at `c:\\ %insfolder%\\%insname% and creates a run entry (fig. 23).`\n\n\n-----\n\nFig. 23 run Reg Entry\n\n**Indicators of Compromise (IOCs):**\n```\nSHA256\nInitial File: 7f7323ef90321761d5d058a3da7f2fb622823993a221a8653a170fe8735f6a45\n1st Payload: c0ee1071e444f415f8b62856a0896f3b22e563f1bb4f03d14142583efe49a565\n2nd Payload: ad9a0f051fba2363abeab5b9a9d169572db48256307e826751c6a3140c60eef1\n3rd Payload: 148043d39c826025b65a0405e34acb08bb7e44a0566c13b4030412b734076438\n\n```\n**Agent Tesla TTP Map:**\n\n\n**Initial**\n**Access** **Execution** **Persistence**\n\n\n**privilege**\n**Escalation**\n\nBoot or\nLogon\nAutostart\nExecution\n(T1547)\n\nProcess\nInjection\n(T1055)\n\nScheduled\nTask/ Job\n(T1053)\n\n\n**Defense**\n**Evasion**\n\nDeobfuscate/\nDecode Files\nor\nInformation\n(T1140)\n\nObfuscated\nFiles or\nInformation\n(T1027)\n\nProcess\nInjection\n(T1055)\n\n\n**Credential**\n**Access** **Discovery** **Collection**\n\n\nCredentials\nfrom\nPassword\nStores:\nCredentials\nfrom Web\nBrowsers\n(T1555.003)\n\nInput\nCapture:\nKeylogging\n(T1056.001)\n\nUnsecured\nCredentials:\nCredentials\nfrom Files\n(T1552.001)\n\nUnsecured\nCredentials:\nCredentials\nin Registry\n(T1552.002)\n\n\n**Command**\n**and**\n**Control** **Exfiltration**\n\n\nPhishing:\nSpear\nphishing\nAttachment\n(T1566.001)\n\n\nScheduled\nTask/ Job\n(T1053)\n\n\nBoot or\nLogon\nAutostart\nExecution\n(T1547)\n\n\nAccount\nDiscovery:\nLocal\nAccount\n(T1087.001)\n\nSystem\nInformation\nDiscovery\n(T1082)\n\nSystem\nNetwork\nConfiguration\nDiscovery\n(T1016)\n\nSystem\nOwner/ User\nDiscovery\n(T1033)\n\n\nArchive\nCollected\nData(T1560)\n\nClipboard\nData(T1115)\n\nInput\nCapture:\nKeyLogging\n(T1056.001)\n\nMan in the\nBrowser\n(T1185)\n\nScreen\nCapture\n(T1113)\n\nVideo\nCapture\n(T1125)\n\n\nApplication\nLayer\nProtocol:\nMail\nProtocols\n(T1071.003)\n\nApplication\nLayer\nProtocol:\nWeb\nProtocols\n(T1071.001)\n\n\nExfiltration\nOver\nAlternative\nProtocol\n(T1048)\n\n\n**Mitigation or Additional Important Safety Measures**\n\nKeep software updated\n\nAlways keep your security software (antivirus, firewall, etc.) up to date to protect your computer from new variants of malware.\nRegularly patch and update applications, software, and operating systems to address any exploitable software vulnerabilities.\nDo not download cracked/pirated software as they risk backdoor entry for malware into your computer.\nAvoid downloading software from untrusted P2P or torrent sites. In most cases, they are malicious software.\n\nBeware of emails\n\nDon’t open attachments and links from unsolicited emails. Delete suspicious looking emails you receive from unknown sources,\nespecially if they contain links or attachments. Cybercriminals use ‘Social Engineering’ techniques to lure users into opening attachments\nor clicking on links that lead to infected websites.\n\nDisable macros for Microsoft Office\n\n\n-----\n\no t e ab e ac os docu e t attac e ts ece ed a e a s ot o a a e ect o s e y o you act to tu O ac os\nConsider installing Microsoft Office Viewers. These viewer applications let you see what documents look like without even opening them\nin Word or Excel. More importantly, the viewer software doesn’t support macros at all, so this reduces the risk of enabling macros\nunintentionally.\n\nHaving minimum required privileges\n\nDon’t assign Administrator privileges to users. Most importantly, don’t stay logged in as an administrator unless it is strictly necessary.\nAlso, avoid browsing, opening documents or other regular work activities while logged in as an administrator.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-02 - Catching the RAT called Agent Tesla.pdf"
    ],
    "report_names": [
        "2022-02-02 - Catching the RAT called Agent Tesla.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535796,
    "ts_updated_at": 1743041147,
    "ts_creation_date": 1653754407,
    "ts_modification_date": 1653754407,
    "files": {
        "pdf": "https://archive.orkl.eu/fff7468a0ed5d472b6550d6e5b222c78aeec7fcd.pdf",
        "text": "https://archive.orkl.eu/fff7468a0ed5d472b6550d6e5b222c78aeec7fcd.txt",
        "img": "https://archive.orkl.eu/fff7468a0ed5d472b6550d6e5b222c78aeec7fcd.jpg"
    }
}