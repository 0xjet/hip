{
    "id": "f2a15344-dca6-4b25-9b0d-76add558be21",
    "created_at": "2023-01-12T14:59:20.090531Z",
    "updated_at": "2025-03-27T02:05:48.120949Z",
    "deleted_at": null,
    "sha1_hash": "28d56ceb4d49d105fabcb8666c04abc1eeeba187",
    "title": "2017-05-03 - Hunting pack use case- RedLeaves malware",
    "authors": "",
    "file_creation_date": "2022-05-28T19:44:42Z",
    "file_modification_date": "2022-05-28T19:44:42Z",
    "file_size": 891215,
    "plain_text": "# Hunting pack use case: RedLeaves malware\n\n**[community.rsa.com/community/products/netwitness/blog/2017/05/03/hunting-pack-use-case-redleaves-malware](https://community.rsa.com/community/products/netwitness/blog/2017/05/03/hunting-pack-use-case-redleaves-malware)**\n\nMay 3, 2017\n\nOn April 27, 2017 The United States Computer Emergency Readiness Team (US-CERT)\nreleased an alert TA17-117A [1] with information on an emerging sophisticated campaign. The\ncampaign has been active since at least May 2016 and targets organization in several sectors,\nincluding Information Technology, Energy, Healthcare and Public Health, Communications and\nCritical Manufacturing. The threat actors have deployed multiple malware families and variants in\ntheir campaign including PlugX and RedLeaves.\n\nThis threat advisory discusses the host and network behavior of RedLeaves malware. In addition,\nit shows how to leverage the Hunting pack to detect RedLeaves network activity using RSA\nNetWitness Logs and Packets.\n\nA typical infection scenario starts with a dropper dropping a legitimate application (EXE), a\nmalicious DLL, and an encoded DATA file in the user %TMP% folder [2].\n\nThe screenshot below shows the files dropped by a RedLeaves sample on a victim machine [3]:\n\n**Filename** **SHA256**\n\nobedience.exe aba4df64717462c61801d737c9fa20a7fada61539eaef50954331d31f7306d27\n\nStarBurn.dll adb72a24429441f743bd2b1a9c0116ae9a1e7b217e047849d70ca1e9054dbdb6\n\nhandkerchief.dat 773b176b3a68c3d21fae907af8fba7908b55726bd591c5335c8c0bc9de179b76\n\nIt then starts the application. Taking advantage of DLL preloading, the EXE file loads the\nmalicious DLL, which reads, decodes, and then executes the DATA file. It then creates a new\nprocess and injects itself into it. Below is a snapshot of the process tree after running the same\nsample on hybrid-analysis.com [4]:\n\n\n-----\n\nTo ensure that one instance of the malware is running on an infected system, the malware\ncreates a mutant. In this case, it is vv11287GD. To gain persistency on the system, the malware\ncreates a link in the Startup folder pointing to the legitimate application dropped in the %TEMP%\nfolder.\n\nThe malware starts beaconing to its C2 server using raw TCP over port 443 as follows:\n\nAs explained in the alert issued by US-CERT, the payload follows two 12-bytes fixed length\nheaders. The first header comes in its own packet, the second header and the payload in a\nseparate packet in the same TCP stream. The first four bytes of the second header (0x3275636b)\nrepresent the length of the encrypted and compressed payload (XOR encoded with the first four\nbytes of the RC4 key), the second four bytes of the second header (0x3175636b) represent the\nlength of the decrypted and decompressed payload (XOR encoded with the first four bytes of the\nRC4 key).\n\nAnalyzing the strings in the address space of the injected process; in this case iexplore.exe;\nsuggests that the RC4 key is Lucky123 with null byte appended:\n\n\n-----\n\nHere is the decrypted payload:\n\nThe malware also sends the same payload along with the second header to the server as an\nHTTP POST request over port 443:\n\n\n-----\n\nA list of commands supported by RedLeaves can be found in the report released by the NCC\nGroup Cyber Defence Operations team [5].\n\n## Detection using Hunting Pack\n\nThe Hunting pack is designed to allow you to quickly hunt for indicators of compromise or\nanomalous network activity by dissecting packet traffic within the NetWitness Suite and\npopulating specific meta keys with natural language values for investigation. For more information\non the hunting pack including how to deploy it in your environment, please refer to RSA\ndocumentation [6].\n\nThe screenshot below shows some of the meta keys registered by the hunting pack for the initial\nRedLeaves beaconing session. That is the one using a raw TCP connection over port 443:\n\nThe session was tagged with different meta values indicating suspicious traffic over SSL port.\nHere is a description of some of those values:\n\n**Meta Value** **Description**\n\nsession size 0-5k\n\nA total session size, request + response payload, between 0KB and\n5KB\n\nratio high\ntransmitted\nBetween 75% and 100% of the session payload transmitted outbound\n\npotential beacon\n\nSession assumed to be programmatic, nefarious communications\n\nnot top 20 dst\n\norg.dst is not one of the most common 20 destinations\n\n\n-----\n\n**Meta Value** **Description**\n\nfirst carve\n\noutbound traffic with two streams and payload > 0\n\nfirst carve not dns outbound traffic with two streams and payload > 0 and not service type\n53\n\nThe screenshot below shows some of the meta keys registered by the hunting pack for the\nfollowing RedLeaves beaconing sessions. Those are the ones that use HTTP POST requests\nover port 443:\n\nThe sessions were tagged with different meta values indicating suspicious HTTP traffic over SSL\nport. Here is a description of some of those values:\n\n**Meta Value** **Description**\n\nwatchlist file extension Any executable extension commonly used with malware like\n.exe, .php, .zip, etc\n\nhttp with binary HTTP with binary data in the body\n\nhttp suspicious 4 headers Sessions with only HTTP POST and four HTTP headers\n\nhost-header contains port Host header directly declares a port such as\n'www.example.com:80'\n\n\nhttp post no get low header\ncount not flash\n\nhttp post no get no referrer\ndirecttoip\n\n\nAn HTTP POST request with less than 6 Headers and the useragent is not ‘shockwave flash’\n\nHTTP session with at least one POST request to an IP address,\nno GET requests, and no referer\n\n\nWhile the network behavior explained earlier is not unique to RedLeaves malware, the hunting\npack can help an analyst in identifying suspicious traffic in the environment without relying on any\nnetwork signatures.\n\n\n-----\n\nReferences:\n\n[1. https://www.us-cert.gov/ncas/alerts/TA17-117A](https://www.us-cert.gov/ncas/alerts/TA17-117A)\n[2. http://blog.jpcert.or.jp/2017/04/redleaves---malware-based-on-open-source-rat.html](http://blog.jpcert.or.jp/2017/04/redleaves---malware-based-on-open-source-rat.html)\n3. https://www.virustotal.com/en/file/5262cb9791df50fafcb2fbd5f93226050b51efe400c2924eec\n\nba97b7ce437481/analysis/\n4. https://www.hybrid\n[analysis.com/sample/5262cb9791df50fafcb2fbd5f93226050b51efe400c2924eecba97b7ce4](https://www.hybrid-analysis.com/sample/5262cb9791df50fafcb2fbd5f93226050b51efe400c2924eecba97b7ce437481?environmentId=100)\n37481?environmentId=100\n5. https://github.com/nccgroup/Cyber\n[Defence/blob/master/Technical%20Notes/Red%20Leaves/Source/Red%20Leaves%20tech](https://github.com/nccgroup/Cyber-Defence/blob/master/Technical%20Notes/Red%20Leaves/Source/Red%20Leaves%20technical%20note%20v1.0.md)\nnical%20note%20v1.0.md\n[6. https://community.rsa.com/docs/DOC-62341](https://community.rsa.com/docs/DOC-62341)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-05-03 - Hunting pack use case- RedLeaves malware.pdf"
    ],
    "report_names": [
        "2017-05-03 - Hunting pack use case- RedLeaves malware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535560,
    "ts_updated_at": 1743041148,
    "ts_creation_date": 1653767082,
    "ts_modification_date": 1653767082,
    "files": {
        "pdf": "https://archive.orkl.eu/28d56ceb4d49d105fabcb8666c04abc1eeeba187.pdf",
        "text": "https://archive.orkl.eu/28d56ceb4d49d105fabcb8666c04abc1eeeba187.txt",
        "img": "https://archive.orkl.eu/28d56ceb4d49d105fabcb8666c04abc1eeeba187.jpg"
    }
}