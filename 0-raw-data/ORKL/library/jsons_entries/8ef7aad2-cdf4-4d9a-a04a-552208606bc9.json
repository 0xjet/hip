{
    "id": "8ef7aad2-cdf4-4d9a-a04a-552208606bc9",
    "created_at": "2023-05-06T02:09:26.929855Z",
    "updated_at": "2025-03-27T02:05:38.992449Z",
    "deleted_at": null,
    "sha1_hash": "b09bba0c45844886d715e5b9299369f00c4d08e5",
    "title": "2023-04-12 - Maximizing Threat Detections of Qakbot with Osquery",
    "authors": "",
    "file_creation_date": "2023-05-05T01:55:35Z",
    "file_modification_date": "2023-05-05T01:55:35Z",
    "file_size": 552683,
    "plain_text": "# Maximizing Threat Detections of Qakbot with Osquery\n\n**[research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/](https://research.loginsoft.com/threat-research/blog-maximizing-threat-detections-of-qakbot-with-osquery/)**\n\nApril 12, 2023\n\nApril 12, 2023\n\nBy Bhargav K\n\nInitially, Qakbot spreads using malicious email attachments, drive-by-download attacks, or\nother forms of social engineering. The recent variants of Qakbot employ OneNote, Windows\nScript File (WSF), and HTML smuggling to disseminate malware as part of a new campaign.\nThese campaigns showcase the adaptability and sophistication of Qakbot and the constant\nevolution of malware as a menace to cybersecurity. This article will explore Qakbot’s tactics,\ntechniques, and procedures (TTPs) and detection of Qakbot behaviour by querying and\n[monitoring the operating system using SQL-like syntax with the help of osquery.](https://www.osquery.io/)\n\n_Fig: Qakbot Distribution Chain_\n\n**Qakbot’s Initial Infection**\n\nThe chart below gives an overview of the campaigns carried out by threat actors over time to\ndistribute Qakbot malware, and further we will delve into the details of these campaigns.\n\n\n-----\n\n_Fig: Qakbot’s Progression_\n\n## Windows Script File (WSF) Campaign\n\nThe Qakbot threat actors are distributing an archive file containing .wsf files via spam mail as\npart of their campaign. When user attempts to open the .wsf file, the embedded JavaScript\ncode will launch wscript which in turn downloads the Qakbot DLL.\n\nThe following query can be used to detect the launching of a WSF file.\n```\nSELECT \n\n  name,\n\n  cmdline,\n\n  path,\n\n  pid,\n\n  parent\n\nFROM processes\n\nWHERE cmdline LIKE '%.wsf%'\n\nAND LOWER(name) IN ('wscript.exe','cscript.exe');\n\n```\nNOTE: Further analysis is required to determine whether the WSF file exhibits any malicious\nbehavior.\n\n## OneNote Campaign\n\nFollowing Microsoft’s decision to block macros, threat actors behind Qakbot resorted to email\nthread hijacking using a malicious OneNote document for wide-scale distribution by\nembedding scripts like JSE, CHM, HTA, MSF & BAT in the attachment.\n\nThe attacker entices the victim to click on a button labeled as “Decrypt and View Message”\nor “Double Click to View File” within an attachment. However, the concealed script\nexecutes and retrieves a malicious DLL file from a hardcoded URL. For more information\n[refer to our blog on OneNote campaign.](https://research.loginsoft.com/threat-research/from-innocence-to-malice-the-onenote-malware-campaign-uncovered/)\n\n\n-----\n\n_Fig: Dragging button reveal embedded files_\nThe following osquery detects the creation of suspicious child process on execution of the\nscript in the OneNote attachment.\n\n\n-----\n\n```\nSELECT\n\n  p1.name AS process_name,\n\n  p1.pid AS process_pid,\n\n  p1.cmdline AS process_cmdline,\n\n  p2.name AS parent_process_name,\n\n  p2.pid AS parent_process_pid,\n\n  p2.cmdline AS parent_process_cmdline\n\nFROM processes p1, processes p2\n\nON p1.parent = p2.pid\n\nAND LOWER(parent_process_name) = 'onenote.exe' \n\nAND \n\n(\n  process_cmdline LIKE '%\\AppData\\Local\\Temp\\OneNote\\%'\n\n  AND process_cmdline LIKE '%\\Exported\\%'\n\n  AND process_cmdline LIKE '%\\NT\\%'\n\n)\nAND \n\n(\n  process_name IN \n\n  (\n\n    'rundll32.exe', 'regsvr32.exe', 'bitsadmin.exe', 'certutil.exe',\n'installutil.exe',\n\n    'schtasks.exe', 'wmic.exe', 'WmiPrvSE.exe', 'cscript.exe', 'wscript.exe',\n\n    'cmstp.exe', 'Microsoft.Workflow.Compiler.exe', 'regasm.exe', 'regsvcs.exe',\n'mshta.exe', \n\n    'msxsl.exe', 'ieexec.exe', 'cmd.exe', 'powershell.exe', 'hh.exe',\n'javaw.exe', 'pcalua.exe', \n\n    'curl.exe', 'scriptrunner.exe', 'certoc.exe', 'workfolders.exe',\n'odbcconf.exe', 'msiexec.exe', 'msdt.exe'\n\n  )\n\n  OR\n\n  (\n\n    process_cmdline LIKE '%.bat%'\n\n    OR process_cmdline LIKE '%.dat%'\n\n    OR process_cmdline LIKE '%.exe%'\n\n    OR process_cmdline LIKE '%.hta%'\n\n    OR process_cmdline LIKE '%.vba%'\n\n    OR process_cmdline LIKE '%.vbe%'\n\n    OR process_cmdline LIKE '%.vbs%'\n\n    OR process_cmdline LIKE '%.wsh%'\n\n    OR process_cmdline LIKE '%.wsf%'\n\n    OR process_cmdline LIKE '%.js%'\n\n    OR process_cmdline LIKE '%.scr%'\n\n    OR process_cmdline LIKE '%.pif%'\n\n    OR process_cmdline LIKE '%.cmd%'\n\n    OR process_cmdline LIKE '%.chm%'\n\n    OR process_cmdline LIKE '%.ps%'\n\n    OR process_cmdline LIKE '%.lnk%'\n\n    OR process_cmdline LIKE '%.ps1%'\n\n    OR process_cmdline LIKE '%.ps2%'\n\n    OR process_cmdline LIKE '%.jse%'\n\n```\n\n-----\n\n```\n  )\n\n);\n\n## HTML Smuggling Campaign\n\n```\nBased on our observation, Qakbot malware is also being distributed via emails with HTML\nattachments containing malicious JavaScript code in HTML5 attributes. Upon opening the\nHTML file, the JavaScript code gets executed within the browser dropping an ISO image file.\n\nAfter user clicks on the shortcut file from the mounted drive, the LNK file initiates the\n[execution of hidden Windows 7 calculator and side-loading of Qakbot DLL.](https://www.fusenetworks.com/blog/a-windows-vulnerability-found-in-your-calculator-here-s-what-you-should-know)\n\n_Fig: Calc DLL Side-Loading_\nUsing osquery, the calculator loading DLLs from unusual file paths can be detected.\n\n\n-----\n\n```\nSELECT\n\n     datetime,\n\n      source,\n\n      provider_name,\n\n      computer_name,\n\n      eventid,\n\n      json_extract(data,'$.EventData.Image') as process_name,\n\n      json_extract(data,'$.EventData.ProcessId') as process_pid,\n\n      json_extract(data,'$.EventData.ImageLoaded') as image_loaded\n\nFROM windows_events\n\nWHERE eventid = '7'\n\nAND process_name LIKE '%calc.exe'\n\nAND\n\n(\n\n   image_loaded NOT LIKE 'C:WindowsSystem32%'\n\n   OR image_loaded NOT LIKE 'C:WindowsSysWOW64%'\n\n);\n\n```\n**Qakbot’s Behaviour in Later Stages**\n\nOnce the Qakbot DLL was loaded into the targeted machine, the following behaviors were\nobserved.\n\nQakbot establishes persistence by creating a scheduled task that registers the Qakbot DLL\nto execute with elevated privileges. This is achieved by creating a SYSTEM user account\nwhich is used to perform the task.\n```\n\"schtasks.exe\" /Create /RU \"NT AUTHORITYSYSTEM\" /tn {RandomTaskName} /tr\n\"regsvr32.exe -s \"C:UsersREDACTED{QakbotDLL}\"\" /SC ONCE /Z /ST {Time} /ET\n{Time}\n\n```\nThe following query can be utilized to detect scheduled tasks that create a system user and\nregisters a DLL.\n```\nSELECT\n\n*\n\nFROM scheduled_tasks\n\nWHERE\n\n(\n\naction LIKE '%/create%'\n\nAND action LIKE '%SYSTEM%'\n\nAND action LIKE '%regsvr32%'\n\nAND action LIKE '%-s%'\n\n);\n\n```\nQakbot then attempts to inject code into a preselected list of processes to evade detection\nand target LSASS through an injected process to gain credentials.\n\n\n-----\n\n_Fig: Qakbot Injected msra.exe accessing lsass.exe_\n\n_Image source: DFIR_\nThe Qakbot-injected processes accessing lsass.exe for credentials can be detected using\nthe query below.\n```\nSELECT\n\n p1.name as process_name,\n\n p1.pid as process_pid,\n\n p1.cmdline as process_cmdline,\n\n p2.name as parent_process_name,\n\n p2.pid as parent_process_pid,\n\n p2.cmdline as parent_process_cmdline\n\nFROM processes p1, processes p2\n\nON p2.pid = p1.parent\n\nAND LOWER(parent_process_name) IN \n('wermgr.exe','onedrivesetup.exe','msra.exe','dxdiag.exe','xwizard.exe','atbroker.exe\n','mobsync.exe','certenrollctrl.exe','explorer.exe')\n\nAND LOWER(process_name) = 'lsass.exe';\n\n```\nQakbot conducts a system discovery process to gather information about the systeminfo,\nipconfig, nslookup and arp on the targeted machine, allowing the adversary to carry out\nlateral movement activities.\n\nBelow query can be used to detect Qakbot injected process executing system discovery\ncommands.\n\n\n-----\n\n```\nSELECT name,\n\n pid,\n\n path,\n\n cmdline,\n\n parent\n\nFROM processes\n\nWHERE LOWER(name) IN\n('wermgr.exe','onedrivesetup.exe','msra.exe','dxdiag.exe','xwizard.exe','atbroker.exe\n','mobsync.exe','certenrollctrl.exe','explorer.exe')\n\nAND\n\n(\n\n  cmdline LIKE '%whoami%'\n\n  OR cmdline LIKE '%arp%'\n\n  OR cmdline LIKE '%ipconfig%'\n\n  OR cmdline LIKE '%net view%'\n\n  OR cmdline LIKE '%nslookup%'\n\n  OR cmdline LIKE '%nltest%'\n\n  OR cmdline LIKE '%net share%'\n\n  OR cmdline LIKE '%netstat%'\n\n  OR cmdline LIKE '%net localgroup%'\n\n  OR cmdline LIKE '%qwinsta%'\n\n);\n\n```\nNote: All the queries were tested on the Osquery version 5.6.0 & above.\n\nQakbot employs multiple threads to carry out its activities. One such thread involves\ngathering information about the compromised device and exfiltrating data to its Command\nand Control (C2) server.\n\nThese queries can be tested in a controlled, sandbox environment on below samples\n\n**Threat Synopsis**\n\n**MITRE ATT&CK Techniques**\n\n|Tactic|Technique ID|Technique Name|\n|---|---|---|\n|Initial Access|T1566.001|Phishing: Spearphishing Attachment|\n|Execution|T1204.001 T1204.002|User Execution: Malicious Link User Execution: Malicious File|\n|Defense Evasion|T1055.012 T1218.010 T1218.011|Process Injection: Process Hollowing System Binary Proxy Execution: Regs vr32 System Binary Proxy Execution: RunDll32|\n\n\n-----\n\n|Discovery|T1033  T1047  T1049  T1082  T1518.001|System Owner/User Discovery  Windows Management Instrumentation  System Network Connections Discovery  System Information Discovery  Security Software Discovery|\n|---|---|---|\n|Persistence|T1053|Scheduled Tasks|\n|Credential Access|T1555|Credentials from Password Stores|\n|Command and Control|T1071 T1105|Application Layer Protocol Ingress Tool Transfer|\n|Exfiltration|T1041|Exfiltration Over C2 Channel|\n\n\n**Conclusion**\n\nQakbot’s adaptability and constant evolution make it a significant threat to financial\ninstitutions and businesses alike. Additionally, the malware’s multifaceted nature allows it to\nserve as an initial infection vector for ransomware and further increasing its potential impact\non organizations.\n\n**References**\n\n[https://thedfirreport.com/2022/02/07/qbot-likes-to-move-it-move-it/](https://thedfirreport.com/2022/02/07/qbot-likes-to-move-it-move-it/)\n[https://www.attackiq.com/2023/01/25/emulating-qakbot/](https://www.attackiq.com/2023/01/25/emulating-qakbot/)\nhttps://www.trellix.com/en-us/about/newsroom/stories/research/demystifying-qbotmalware.html\nhttps://www.fortinet.com/blog/threat-research/new-variant-of-qakbot-spread-byphishing-emails\n\n**Author: Bhargav K**\n\nSenior Threat Researcher, Loginsoft\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-12 - Maximizing Threat Detections of Qakbot with Osquery.pdf"
    ],
    "report_names": [
        "2023-04-12 - Maximizing Threat Detections of Qakbot with Osquery.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338966,
    "ts_updated_at": 1743041138,
    "ts_creation_date": 1683251735,
    "ts_modification_date": 1683251735,
    "files": {
        "pdf": "https://archive.orkl.eu/b09bba0c45844886d715e5b9299369f00c4d08e5.pdf",
        "text": "https://archive.orkl.eu/b09bba0c45844886d715e5b9299369f00c4d08e5.txt",
        "img": "https://archive.orkl.eu/b09bba0c45844886d715e5b9299369f00c4d08e5.jpg"
    }
}