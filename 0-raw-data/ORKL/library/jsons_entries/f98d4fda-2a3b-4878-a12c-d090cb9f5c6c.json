{
    "id": "f98d4fda-2a3b-4878-a12c-d090cb9f5c6c",
    "created_at": "2023-01-12T15:01:07.791416Z",
    "updated_at": "2025-03-27T02:15:39.208028Z",
    "deleted_at": null,
    "sha1_hash": "f31369be4e49409d23da5d46f9d4cf2575d8400e",
    "title": "2019-03-27 - Analysis of the ShadowHammer backdoor",
    "authors": "",
    "file_creation_date": "2022-05-28T15:46:41Z",
    "file_modification_date": "2022-05-28T15:46:41Z",
    "file_size": 410714,
    "plain_text": "# Analysis of the ShadowHammer backdoor\n\n**mauronz.github.io/shadowhammer-backdoor**\n\n## mauronz\n\nx86 official language of the blog\n\n\nMarch 27, 2019\n\n\n[Blog](https://mauronz.github.io/) [About](https://mauronz.github.io/about)\n[On March 25, Kim Zetter published an astonishing story describing a supply-chain attack](https://motherboard.vice.com/en_us/article/pan9wn/hackers-hijacked-asus-software-updates-to-install-backdoors-on-thousands-of-computers)\nagainst ASUS which was run between June and November 2018. The ASUS Live Update\nsoftware was backdoored in order to attack a very specific group of targets. The campaign,\n[named ShadowHammer, was discovered and investigated by Kaspersky Lab, which will](https://securelist.com/operation-shadowhammer/89992/?utm_source=twitter&utm_medium=social&utm_campaign=uk_securelist_db0077_organic&utm_content=sm-post&utm_term=uk_twitter_organic_db0077_sm-post_social_securelist)\npresent the full details during SAS2019.\n\nNOTE: as of yet Kaspersky has only published a single sample of the backdoor (hash:\naa15eb28292321b586c27d8401703494), so the analysis and the considerations presented\nin this post are specific to that. Once more samples come out it may become necessary to\nperform some adjustments.\n\n## The backdoored setup.exe\n\n\n-----\n\nThe ASUS software is distributed as a zip archive containing 3 files, setup.exe and two\nversions of 409.msi. The backdoor resides in the first one. The malicious code is executed\njust before the program exits.\n\nThe call to execute_backdoor overwrites a call to a legitimate function just before the\nexecution of ExitProcess.\n\n**execute_backdoor is straightforward. First, it allocates a region of memory with read, write**\nand execution permissions. It then retrieves the encrypted shellcode data using hardcoded\noffsets and decrypts it in the allocated memory. Finally, it calls the entrypoint of the shellcode,\nonce again with a hardcoded offset.\n\n\n-----\n\nIt is worth noting that the two functions used to execute the malicious shellcode,\n**execute_backdoor and decrypt, are both located at the end of the .text section of the**\nexecutable. This indicates that they were added directly to the legitimate compiled file, rather\nthan during compilation.\n\n## The shellcode\n\nThe shellcode starts by dynamically loading the DLLs it needs and then retrieves the\naddresses of the required exported functions. The most interesting ones are iphlpapi.dll,\nused to retrieve the MAC addresses of the machine, and wininet.dll, for the communication\nwith the C&C.\n\n\n-----\n\nThe next step is to get the MAC addresses of all the interfaces. To obtain this information,\nthe shellcode uses the API function GetAdaptersAddresses. To avoid revealing the targeted\naddresses, the authors of the backdoor stored their MD5 hashes. In order to correctly check\nthe correspondence, for each interface of the machine, the shellcode computes the MD5\nhash of the MAC address.\n\nWe can now look at how the backdoor checks if the retrieved MAC addresses match any of\nthe targeted ones. The data of each target is stored in the following data structure:\n\n\n-----\n\n```\nstruct mac_data {\n  DWORD type;\n  BYTE md5_hash1[0x10];\n  DWORD sep1;\n  BYTE md5_hash2[0x10];\n  DWORD sep2;\n}\nsep1 and sep2 are always 0. type can be either 1 or 2. If type is 1, in order to match\n\n```\nthis target the machine just needs to have a MAC address with an MD5 equal to\n```\nmd5_hash1 ; md5_hash2 is filled with 0. Instead, if type is 2, both md5_hash1 and\nmd5_hash2 have an actual value and they both must be found in the MAC addresses of the\n\n```\nmachine.\nIn the example below, we can see `type in red,` `md5_hash1 in blue and` `md5_hash2 in`\ngreen.\n\nAs [mentioned by Vitaly Kamluk from Kaspersky Lab, the complete list of targets is scattered](https://twitter.com/vkamluk/status/1110208888807124992)\namong different samples of the backdoor. This specific sample contains 18 of them.\n\n**Target identified**\n\nIf the MAC addresses match one of those in the target list, the shellcode contacts the C&C\nwith the following URL\n\nhxxps://asushotfix[.]com/logo2.jpg?\n\nfollowed by the hex encode of the matched `md5_hash1 .`\n\nUsing the WININET APIs, the shellcode of the second stage is downloaded and saved in\nanother memory region with read, write, execute permission. Finally it is executed.\n\n**Not a target**\n\n\n-----\n\nIf instead the current machine is not a target, the shellcode performs one final action. It\ncreates a file named idx.ini in the folder of the current user, where it stores a date a week\nafter the current one. The purpose of this file is unclear.\n\nAt least for this sample, the backdoor does not perform any malicious activity on machines\nthat are not targeted. There is no form of persistence, so the people behind ShadowHammer\ncannot reobtain execution unless the setup.exe file is run again by a user.\n\n### List of target data\n\ntype: 2\n\n00b006c7dab6ace6c25c3799eb2b6e14\n\n5977baa3f8ce0ca1c96d6ac9a40c9a91\n\ntype: 1\n\n00b006c7dab6ace6c25c3799eb2b6e14\n\ntype: 1\n\n409d8eebce8546e56a0ad740667aadbd\n\ntype: 1\n\n7da42dd34574d4e1a7ea0e708e7bc9a6\n\ntype: 2\n\nade62a257adf118418c5b2913267543e\n\n4268aed64aa5fff2020d2447790d7d32\n\ntype: 1\n\n7b14c53fd3604cc1ebca5af4415afed5\n\n\n-----\n\ntype: 1\n3a8ea62e32b4ecbe33df500a28ebc873\n\ntype: 1\ncc16956c9506cd2bb389a7d7da2433bd\n\ntype: 2\nfe4ccc64159253a6019304f17102886d\nf241c3073a5777742c341472e2d43eec\n\ntype: 1\n4ec2564ace982dc58c1039bf6d6ea83c\n\ntype: 2\nab0cef9e5957129e23fba178120fa20b\nf758024e734077c70532e90251c5df02\n\ntype: 1\nf35a60617ab336de4daac799676d07b6\n\ntype: 1\n6a62ead801802a5c9ec828d0c1edbb5b\n\ntype: 1\n600c7b52e7f80832e3cee84fcec88b9d\n\ntype: 2\n6e75b2d7470e9864d19e48cb360caf64\nfb559bcd103ee0fcb0cf4161b0fafb19\n\ntype: 1\n690ad61ec7859a0964216b66b5d33b1a\n\ntype: 2\n09da9df3a050afad0df0ef963b41b6e2\nfae3b06ab27f2b0f7c29bf7f2b03f83f\n\ntype: 1\nd4b958671f47bf5dcd08705d80de9a53\n\nWritten on March 27, 2019\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-03-27 - Analysis of the ShadowHammer backdoor.pdf"
    ],
    "report_names": [
        "2019-03-27 - Analysis of the ShadowHammer backdoor.pdf"
    ],
    "threat_actors": [
        {
            "id": "1c97ccfd-1888-492c-b7b9-bb52c4c3809b",
            "created_at": "2023-01-06T13:46:38.940529Z",
            "updated_at": "2025-03-27T02:00:02.957652Z",
            "deleted_at": null,
            "main_name": "Operation ShadowHammer",
            "aliases": [],
            "source_name": "MISPGALAXY:Operation ShadowHammer",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c7d9878a-e691-4c6f-81ae-84fb115a1345",
            "created_at": "2022-10-25T16:07:23.359506Z",
            "updated_at": "2025-03-27T02:02:09.752427Z",
            "deleted_at": null,
            "main_name": "APT 41",
            "aliases": [
                "BrazenBamboo",
                "Bronze Atlas",
                "Double Dragon",
                "Earth Baku",
                "Grayfly",
                "Operation ColunmTK",
                "Operation CuckooBees",
                "Operation ShadowHammer",
                "Red Kelpie",
                "SparklingGoblin",
                "TA415",
                "TG-2633"
            ],
            "source_name": "ETDA:APT 41",
            "tools": [
                "9002 RAT",
                "ADORE.XSEC",
                "ASPXSpy",
                "ASPXTool",
                "AceHash",
                "Agent.dhwf",
                "Agentemis",
                "AndroidControl",
                "AngryRebel",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BLUEBEAM",
                "Barlaiy",
                "BlackCoffee",
                "Bladabindi",
                "BleDoor",
                "CCleaner Backdoor",
                "CHINACHOPPER",
                "COLDJAVA",
                "China Chopper",
                "ChyNode",
                "Cobalt Strike",
                "CobaltStrike",
                "Crackshot",
                "CrossWalk",
                "CurveLast",
                "CurveLoad",
                "DAYJOB",
                "DBoxAgent",
                "DEADEYE",
                "DEADEYE.APPEND",
                "DEADEYE.EMBED",
                "DEPLOYLOG",
                "DIRTCLEANER",
                "DUSTTRAP",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "DodgeBox",
                "DragonEgg",
                "ELFSHELF",
                "EasyNight",
                "Farfli",
                "FunnySwitch",
                "Gh0st RAT",
                "Ghost RAT",
                "HDD Rootkit",
                "HDRoot",
                "HKDOOR",
                "HOMEUNIX",
                "HUI Loader",
                "HidraQ",
                "HighNoon",
                "HighNote",
                "Homux",
                "Hydraq",
                "Jorik",
                "Jumpall",
                "KEYPLUG",
                "Kaba",
                "Korplug",
                "LATELUNCH",
                "LOLBAS",
                "LOLBins",
                "LightSpy",
                "Living off the Land",
                "Lowkey",
                "McRAT",
                "MdmBot",
                "MessageTap",
                "Meterpreter",
                "Mimikatz",
                "MoonBounce",
                "MoonWalk",
                "Motnug",
                "Moudour",
                "Mydoor",
                "NTDSDump",
                "PACMAN",
                "PCRat",
                "PINEGROVE",
                "PNGRAT",
                "POISONPLUG",
                "POISONPLUG.SHADOW",
                "POTROAST",
                "PRIVATELOG",
                "PipeMon",
                "PlugX",
                "PortReuse",
                "ProxIP",
                "ROCKBOOT",
                "RbDoor",
                "RedDelta",
                "RedXOR",
                "RibDoor",
                "Roarur",
                "RouterGod",
                "SAGEHIRE",
                "SPARKLOG",
                "SQLULDR2",
                "STASHLOG",
                "SWEETCANDLE",
                "ScrambleCross",
                "Sensocode",
                "SerialVlogger",
                "ShadowHammer",
                "ShadowPad Winnti",
                "SinoChopper",
                "Skip-2.0",
                "SneakCross",
                "Sogu",
                "Speculoos",
                "Spyder",
                "StealthReacher",
                "StealthVector",
                "TERA",
                "TIDYELF",
                "TIGERPLUG",
                "TOMMYGUN",
                "TVT",
                "Thoper",
                "Voldemort",
                "WIDETONE",
                "WINNKIT",
                "WINTERLOVE",
                "Winnti",
                "WyrmSpy",
                "X-Door",
                "XDOOR",
                "XMRig",
                "XShellGhost",
                "Xamtrav",
                "ZXShell",
                "ZoxPNG",
                "certutil",
                "certutil.exe",
                "cobeacon",
                "gresim",
                "njRAT",
                "pwdump",
                "xDll"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535667,
    "ts_updated_at": 1743041739,
    "ts_creation_date": 1653752801,
    "ts_modification_date": 1653752801,
    "files": {
        "pdf": "https://archive.orkl.eu/f31369be4e49409d23da5d46f9d4cf2575d8400e.pdf",
        "text": "https://archive.orkl.eu/f31369be4e49409d23da5d46f9d4cf2575d8400e.txt",
        "img": "https://archive.orkl.eu/f31369be4e49409d23da5d46f9d4cf2575d8400e.jpg"
    }
}