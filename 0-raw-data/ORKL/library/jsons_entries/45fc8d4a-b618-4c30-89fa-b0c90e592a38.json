{
    "id": "45fc8d4a-b618-4c30-89fa-b0c90e592a38",
    "created_at": "2023-01-12T15:05:42.151148Z",
    "updated_at": "2025-03-27T02:05:59.231792Z",
    "deleted_at": null,
    "sha1_hash": "ba423625c723e367459ca1328c23dbf9b936b526",
    "title": "2021-03-18 - Hunting for Lateral Movement using Event Query Language",
    "authors": "",
    "file_creation_date": "2022-05-27T21:48:40Z",
    "file_modification_date": "2022-05-27T21:48:40Z",
    "file_size": 3482262,
    "plain_text": "# Hunting for Lateral Movement using Event Query Language\n\n**[elastic.co/blog/hunting-for-lateral-movement-using-event-query-language](https://www.elastic.co/blog/hunting-for-lateral-movement-using-event-query-language)**\n\nMarch 18, 2021\n\n[Lateral Movement describes techniques that adversaries use to pivot through multiple](https://attack.mitre.org/tactics/TA0008/)\nsystems and accounts to improve access to an environment and subsequently get closer to\ntheir objective. Adversaries might install their own remote access tools to accomplish\nLateral Movement, or use stolen credentials with native network and operating system tools\nthat may be stealthier in blending in with normal systems administration activity.\n\nDetecting Lateral Movement behaviors often involves the design of detections at both the\nsource and the target system, as well as the correlation of more than one type of event\n(such as network events with process execution events) in order to capture the remote\nexecution context.\n\nIn this blog, we explore some examples of techniques and leverage the capabilities of\nElastic’s [Event Query Language (EQL) to design behavioral hunts and detections.](https://www.elastic.co/guide/en/elasticsearch/reference/master/eql.html)\n\n## How Lateral Movement works\n\nLateral Movement is usually composed of the following high-level steps:\n\n\n-----\n\n1. Remote authentication to the target host (valid access credentials are required)\n2. Staging the command to execute to the remote host or to another resource accessible\n\nby the target host such as internet URL or a Network File Share\n3. Remotely triggering the execution (immediate or scheduled) of the staged program on\n\n[the target host via accessible remote services and protocols (Service,](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/705b624a-13de-43cc-b8a2-99573da3635f) [Task Scheduler,](https://docs.microsoft.com/en-us/windows/win32/taskschd/task-scheduler-start-page)\n[WinRM,](https://docs.microsoft.com/en-us/windows/win32/winrm/portal) [WMI,](https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) [Remote Registry).](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rrp/0fa3191d-bb79-490a-81bd-54c2601b7a78)\n4. Clean up the staged payload and any other relevant artifacts to avoid suspicion\n\n(optional)\n\nNote that staging a program (step 2) is not always necessary, as there are usually exposed\n[services that allow for remote interaction with the target host such as PowerShell Remoting](https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands?view=powershell-7.1)\n[and Remote Desktop (RDP).](https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-clients)\n\n## Lateral Tool Transfer\n\nFiles may be copied from one system to another to stage adversary tools or other files over\n[the course of an operation. A commonly abused vector is SMB/Windows Admin Shares via](https://attack.mitre.org/techniques/T1570/)\nthe use of built-in system commands such as `copy,` `move` `copy-item, and others:`\n\nFigure 1: File copy via system command\nFrom the source machine, there are alternative methods of copying the file without having\nto execute suspicious commands. Still, it’s important to look for low-hanging detection\nopportunities.\n\nFigure 2 below shows an EQL query that looks for the following behavior that is consistent\nwith an attacker transferring a file to a remote host:\n\n[Execution of a command interpreter with a process.args keyword array related to file](https://www.elastic.co/guide/en/ecs/current/ecs-process.html#field-process-args)\ncopy ( copy, `move ) and a hidden file share (prefixed by a` `$ sign such as` `c$`\n```\n   admin$ )\n\n```\nStaging data from a shadow copy volume (often associated with credential access via\n[staging of NTDS.dit or](https://attack.mitre.org/techniques/T1003/003/) [Registry SAM key to access stored account password hashes)](https://attack.mitre.org/techniques/T1003/002/)\n\n\n-----\n\nFigure 2: Hunting EQL for file transfer via hidden file share from source machine\nOn the target machine, we’ve observed that all files copied via server message block (SMB)\nare represented by a file creation event by the virtual process `System (always has a static`\n[process.pid value equal to](https://www.elastic.co/guide/en/ecs/current/ecs-process.html#field-process-pid) `4 and represents the Windows kernel code and loaded kernel`\nmode drivers):\n\nFigure 3: File creation event details depicted in Kibana’s Discover view as a result of file\ntransfer over SMB\nA file creation event alone is not enough (the `System process may create files that are`\nrelated to local activity) to conclude that this activity pertains to a Lateral Movement attempt.\nThus, we need to correlate it with incoming SMB network events by the same process:\n\n\n-----\n\nFigure 4: Hunting EQL for file transfer via hidden file share from target host\nThe above query looks for an incoming remote network event to tcp port 445 (SMB)\nfollowed by immediate file creation or modification (can be limited to executable file\nextension to reduce false positives) and both events are performed by the same\n[(process.entity_id) virtual](https://www.elastic.co/guide/en/ecs/current/ecs-process.html#field-process-entity-id) `System process.`\n\nFigure 5: Detection alert example for Lateral Tool Transfer from target host\n[The above alert contains details about the file that was copied as well as the source.ip](https://www.elastic.co/guide/en/ecs/current/ecs-source.html#field-source-ip)\n[address of the Lateral Movement activity. The same logic triggers on PSExec, a remote](https://www.ired.team/offensive-security/lateral-movement/lateral-movement-with-psexec)\nexecution utility often abused by adversaries for the same purpose:\n\n\n-----\n\nFigure 6: Lateral Tool Transfer triggering on PSEXEC from target host\n[We can also leverage EQL correlation to capture instances where a file that was copied via](https://www.elastic.co/guide/en/elasticsearch/reference/current/eql-syntax.html#eql-sequences)\nSMB is immediately executed:\n\nFigure 7: Hunting EQL for remote execution via file shares\nThe above EQL looks for a [sequence of events where a file is created/modified by the](https://www.elastic.co/guide/en/elasticsearch/reference/current/eql-syntax.html#eql-sequences)\nvirtual `System process followed by a process event where the process.executable is equal`\nto the [file.path. Below is an alert example:](https://www.elastic.co/guide/en/ecs/current/ecs-file.html#field-file-path)\n\n\n-----\n\nFigure 8: Detection alert for remote execution via file shares from target host\nAnother example where file transfer over SMB can be abused for remote execution is\n[copying a malicious executable, script, or shortcut to the Startup folder of a target host. This](https://attack.mitre.org/techniques/T1547/001/)\nwill cause the program referenced to be automatically executed when a user logs in, and in\nthe context of that user:\n\nFigure 9: Hunting EQL for Lateral Movement via startup folder\n[Below is an example of a detection alert for Lateral Movement via the Startup folder:](https://attack.mitre.org/techniques/T1547/001/)\n\n\n-----\n\nFigure 10: Detection alert for Lateral Movement via startup folder\n\n## Remotely Scheduled Tasks\n\nAdversaries may leverage scheduled tasks for remote execution — either via built-in\nsystem utilities such as `schtasks.exe or directly via the Task Scheduler API, which may`\nbe stealthier because visibility is limited.\n\n[Below is an example of remote task creation via the MoveScheduler penetration testing](https://github.com/mez-0/MoveScheduler)\ntool:\n\nFigure 11: Lateral Movement via MoveScheduler\n\n\n-----\n\nBoth `schtasks.exe and direct usage of a custom implementation will cause a process to`\nload the Task Scheduler COM API ( taskschd.dll ), followed by an outbound network\n[connection where both the source.port and the](https://www.elastic.co/guide/en/ecs/current/ecs-source.html#field-source-ip) [destination.port are equal or greater than](https://www.elastic.co/guide/en/ecs/current/ecs-destination.html#field-destination-port)\nRPC dynamic ports ( 49152 to 65535 ) and from the same [process.entity_id, which can](https://www.elastic.co/guide/en/ecs/current/ecs-process.html#field-process-entity-id)\nbe translated to this [EQL query:](https://www.elastic.co/guide/en/elasticsearch/reference/master/eql.html)\n\nFigure 12: Hunting EQL query for outbound task scheduler activity on source host\nOf course, matches to this query can be related to scheduled tasks discovery as well.\nBelow is an example of an alert where we can observe the username, source, and\ndestination IP, as well as the process name used to perform a remote task activity:\n\nFigure 13: Detection alert for Lateral Movement via Scheduled Task on source host\nOn the target host, we can hunt for remote scheduled task creation/modification via two\noptions:\n\n1. Incoming [DCE/RPC (over TCP/IP) network event by the Task Scheduler service](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/290c38b1-92fe-4229-91e6-4fc376610c15)\n\n( svchost.exe ) followed by a file creation of a task XML configuration file\n( C:\\\\Windows\\\\System32\\\\Tasks\\\\task_filename )\n\n\n-----\n\n2. Incoming [DCE/RPC (over TCP/IP) network event by the Task Scheduler service](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/290c38b1-92fe-4229-91e6-4fc376610c15)\n\n( svchost.exe ) followed by a registry change of a task cache Action value\n( HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\n```\n   NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\{GUID}\\\\Actions )\n\n```\n[Option A provides us with the task name (equal to the file.name of the changed/created](https://www.elastic.co/guide/en/ecs/current/ecs-file.html#field-file-name)\nfile), and Option B provides us with the task action itself (equal to the base64 decoded data\nof the Action registry value where the task scheduler service caches the task action\nconfiguration):\n\nFigure 14: Hunting EQL query for task creation on target host (Option A)\n\nFigure 15: Hunting EQL query for task creation on target host (Option B)\nOption B has the advantage of providing details about the task action, which tend to be\n[useful while triaging (set to execute a program from a suspicious path,](https://github.com/elastic/detection-rules/blob/main/rules/windows/execution_from_unusual_path_cmdline.toml) [LOLBAS process,](https://lolbas-project.github.io/)\netc.).\n\n\n-----\n\nFigure 16: Detection alert for Lateral Movement via Scheduled Task on target host\nDecoding the registry Action base64 encoded data provides us details about the created\ntask action:\n\nFigure 17: Base64 decoded data of the scheduled task action registry value\n\n## Remote Registry\n\n\n-----\n\nAdversaries may leverage the Remote Registry service for defense evasion or remote\nexecution. One simple scenario is to modify the `Run key registry on a remote system to`\ncause the execution of a program upon system startup or user logon:\n\nFigure 18: Remote modification of the Run registry key via reg utility\nWe can hunt for this behavior from the source machine by looking for the execution of\n```\nreg.exe with process.args containing \\\\*, but the same action can be achieved via API\n\n```\n[calls avoiding process .command_line-based detections.](https://www.elastic.co/guide/en/ecs/current/ecs-process.html#field-process-command-line)\n\nFigure 19: Example of Reg.exe process execution event on source host\n\n\n-----\n\nNote that `Reg.exe is not performing any network connection — instead, it s the virtual`\n```\nSystem process that issues an outbound network connection to the target host on port\n\n```\n[445 (DCE/RPC over SMB).](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/290c38b1-92fe-4229-91e6-4fc376610c15)\n\nOn the target host we can see the following sequence of key events:\n\n[1. Incoming network connection on tcp port 445 (DCE/RPC over SMB) by the virtual](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/290c38b1-92fe-4229-91e6-4fc376610c15)\n```\n   System process (process.pid equal 4)\n\n```\n2. `RemoteRegistry service process starts ( svchost.exe with` [process.args](https://www.elastic.co/guide/en/ecs/current/ecs-process.html#field-process-args)\n\ncontaining the string `RemoteRegistry )`\n3. `RemoteRegistry service process performs the registry change`\n\nFigure 20: Remote Registry-relevant events on target host\n[The following EQL hunt can be used to correlate (2) and (3) by host.id and](https://www.elastic.co/guide/en/elasticsearch/reference/master/eql.html) [process.entity_id](https://www.elastic.co/guide/en/ecs/current/ecs-process.html#field-process-entity-id)\nof the Remote Registry service:\n\nFigure 21: Hunting EQL to detect Remote Registry modification via Regsvc on target host\n[If we include (1) in the above sequence to capture the](https://www.elastic.co/guide/en/elasticsearch/reference/current/eql-syntax.html#eql-sequences) [source.ip address, it may trigger on](https://www.elastic.co/guide/en/ecs/current/ecs-source.html#field-source-ip)\nunrelated incoming SMB connections as the only common element between the three\nevents limited to the [host.id value.](https://www.elastic.co/guide/en/ecs/current/ecs-host.html#field-host-id)\n\n\n-----\n\nFigure 22: Detection alert for Remote Registry modification via Regsvc on target host\nAdversaries may attempt to achieve the same outcome via the Windows Management\n[Instrumentation (WMI) registry provider (StdReg), which behaves differently:](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/regprov/stdregprov)\n\n1. WMI Service ( svchost.exe with [process.args containing](https://www.elastic.co/guide/en/ecs/current/ecs-process.html#field-process-args) `Winmgmt string) accepts`\n\n[an incoming DCE/RPC (over TCP/IP) network connection where both source.port and](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/290c38b1-92fe-4229-91e6-4fc376610c15)\nthe [destination.port are greater than or equal to RPC dynamic ports (](https://www.elastic.co/guide/en/ecs/current/ecs-destination.html#field-destination-port) `49152 to`\n```\n   65535 )\n\n```\n2. A new instance of the WMI Provider Host (process.name equal to `WmiPrvSe.exe`\n\nwith [user.name equal to](https://www.elastic.co/guide/en/ecs/current/ecs-user.html#field-user-name) `Local Service or` [user.id equal to](https://www.elastic.co/guide/en/ecs/current/ecs-user.html#field-user-id) `S-1-5-19 ) is started`\n3. The started WMI Provider Host loads the registry provider `StdProv.dll module`\n4. The WMI Provider Host performs the registry change\n\n[We can express the correlation of (1), (2) and (4) with the following hunting EQL:](https://www.elastic.co/guide/en/elasticsearch/reference/master/eql.html)\n\nFigure 23: Hunting EQL for Remote Registry modification via Regsvc on target host\nIf logging of the `StdProv.dll module loading is enabled, we can also add (3) to the`\n[sequence to reduce potential false positives:](https://www.elastic.co/guide/en/elasticsearch/reference/current/eql-syntax.html#eql-sequences)\n\n\n-----\n\nFigure 24: Hunting EQL for Remote Registry modification via Regsvc on target host (library\nevent)\nBelow an example of a detection alert where we can see the remotely modified registry\n[details and the remote source.ip:](https://www.elastic.co/guide/en/ecs/current/ecs-source.html#field-source-ip)\n\nFigure 25: Detection alert for Remote Registry modification via the WMI on target host\n\n## Sharp Remote Desktop\n\n[SharpRDP is a Lateral Movement tool that leverages the Remote Desktop Protocol (RDP)](https://posts.specterops.io/revisiting-remote-desktop-lateral-movement-8fb905cb46c3)\nfor authenticated command execution and without the need for graphical interaction.\n\n[Once authenticated, SharpRDP sends virtual keystrokes to the remote system via a method](https://docs.microsoft.com/en-us/windows/win32/inputdev/virtual-key-codes)\n[called SendKeys to open up a Run dialog on the target host and then enter a specified](https://docs.microsoft.com/en-us/windows/win32/termserv/imsrdpclientnonscriptable-sendkeys)\ncommand, which will be executed on the target host.\n\nThe main indicator from the source host is an unusual process (hosting SharpRDP code)\nloading the Remote Desktop Services ActiveX Client that implements RDP client\nfunctionality ( MsTscAx.dll ) followed by an outbound network connection to RDP tcp port\n\n\n-----\n\n`3389 and both events from the same` [process.entity_id:](https://www.elastic.co/guide/en/ecs/current/ecs-process.html#field-process-entity-id)\n\nFigure 26: Hunting EQL for suspicious RDP Client\nBelow an example of results matching our hunting EQL where we can see an unusual\nprocess (other than `mstsc.exe and similar known RDP clients) loading the Remote`\nDesktop Services ActiveX Client ( MsTscAx.dll ) as well as the outbound network\nconnection:\n\nFigure 27: Results example for suspicious RDP Client EQL hunt\nOn the target host, the following key events occur within a one-minute time window:\n\n1. An incoming network connection is accepted by the RDP service ( TermService\n```\n   svchost.exe ) on port 3389\n\n```\n2. Under the [RunMRU registry key, a new (or update to an existing) string value is set to](https://resources.infosecinstitute.com/topic/understanding-critical-windows-artifacts-and-their-relevance-during-investigation-part-2/)\n```\n   cmd, powershell, taskmgr or tsclient (depending on the chosen SharpRDP\n\n```\n[execution method), which is caused by the typed command in the Run dialog via the](https://github.com/0xthirteen/SharpRDP)\n[SendKeys method](https://docs.microsoft.com/en-us/windows/win32/termserv/imsrdpclientnonscriptable-sendkeys)\n[3. Depending on the execution method, a new process (attacker command) is created](https://github.com/0xthirteen/SharpRDP)\n\nwith [process.parent.name of](https://www.elastic.co/guide/en/ecs/current/ecs-process.html) `cmd.exe,` `powershell.exe,` `taskmgr.exe, or a`\n[random executable running from the tsclient mountpoint (shared drive from the RDP](https://www.virtualizationhowto.com/2016/07/map-network-drive-remote-desktop-local-computer/)\nclient host with the RDP target server)\n\n\n-----\n\n[For (2), note that when running anything from the Run dialog, a registry entry will be created](https://www.groovypost.com/howto/howto/use-windows-key-r-run-as-administrator/)\nat `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU showing`\n[what was entered into the Run dialog box.](https://www.groovypost.com/howto/howto/use-windows-key-r-run-as-administrator/)\n\nThe above [sequence of events can be expressed with the following EQL:](https://www.elastic.co/guide/en/elasticsearch/reference/current/eql-syntax.html#eql-sequences)\n\nFigure 28: Hunting EQL for SharpRDP behavior on the target host\nExample of a detection alert and its composing event details on the target host:\n\nFigure 29: Detection alert for SharpRDP on target host (TermService network connection)\n\n\n-----\n\nFigure 30: Detection alert for SharpRDP on target host (RunMRU set to Powershell)\n\nFigure 31: Detection alert for SharpRDP on target host (PowerShell child process)\n\n## Wrapping up\n\n[Event Query Language (EQL) correlation capabilities enable us to capture complex](https://www.elastic.co/guide/en/elasticsearch/reference/master/eql.html)\nbehavior for a variety of Lateral Movement techniques. The high-level steps are:\n\n1. Understand the theory and the building blocks of a certain technique (network\n\nprotocols, loaded modules, services, process names, and arguments)\n2. Identify the key events and their order that compose a certain behavior (both source\n\nand target host)\n\n\n-----\n\n[3. Identify the common values that can be used for correlation (sequences) —](https://www.elastic.co/guide/en/elasticsearch/reference/current/eql-syntax.html#eql-sequences)\n\nidentifying more commonalities can reduce false positives\n4. Identify enrichment possibilities, such as extra events in the sequence that can be\n\nuseful during alert triage\n5. Assess the window of time for correlation — using a shorter time window (for\n\nexample, 30 seconds instead of 1 second) can reduce false positives, but can also\nintroduce false negatives caused by network latency or slow system\n6. Test using different methods and tools and tune the hunting logic accordingly, or, in\n\nsome instances, duplicate logic to capture edge cases\n\nSome of the [EQL detection rules used as examples can be found in the Elastic detection-](https://www.elastic.co/guide/en/elasticsearch/reference/master/eql.html)\nrules repository:\n\nIf you’re new to [Elastic Security, you can experience our latest version on Elasticsearch](https://www.elastic.co/security)\nService on Elastic Cloud.\n\n**We're hiring**\n\nWork for a global, distributed team where finding someone like you is just a Zoom\nmeeting away. Flexible work with impact? Development opportunities from the start?\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-18 - Hunting for Lateral Movement using Event Query Language.pdf"
    ],
    "report_names": [
        "2021-03-18 - Hunting for Lateral Movement using Event Query Language.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535942,
    "ts_updated_at": 1743041159,
    "ts_creation_date": 1653688120,
    "ts_modification_date": 1653688120,
    "files": {
        "pdf": "https://archive.orkl.eu/ba423625c723e367459ca1328c23dbf9b936b526.pdf",
        "text": "https://archive.orkl.eu/ba423625c723e367459ca1328c23dbf9b936b526.txt",
        "img": "https://archive.orkl.eu/ba423625c723e367459ca1328c23dbf9b936b526.jpg"
    }
}