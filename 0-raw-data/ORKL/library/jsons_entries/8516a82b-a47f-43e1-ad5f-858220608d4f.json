{
    "id": "8516a82b-a47f-43e1-ad5f-858220608d4f",
    "created_at": "2023-01-12T15:07:15.304689Z",
    "updated_at": "2025-03-27T02:05:53.413364Z",
    "deleted_at": null,
    "sha1_hash": "d05810e90f96a944c8671a972b2f178d563a534d",
    "title": "2019-09-09 - Evolution of Malware Sandbox Evasion Tactics – A Retrospective Study",
    "authors": "",
    "file_creation_date": "2022-05-28T18:24:53Z",
    "file_modification_date": "2022-05-28T18:24:53Z",
    "file_size": 1000055,
    "plain_text": "# Evolution of Malware Sandbox Evasion Tactics – A Retrospective Study\n\n**[mcafee.com/blogs/other-blogs/mcafee-labs/evolution-of-malware-sandbox-evasion-tactics-a-retrospective-study/](https://www.mcafee.com/blogs/other-blogs/mcafee-labs/evolution-of-malware-sandbox-evasion-tactics-a-retrospective-study/)**\n\nSeptember 9, 2019\n\n## Executive Summary\n\nMalware evasion techniques are widely used to circumvent detection as well as analysis and\nunderstanding. One of the dominant categories of evasion is anti-sandbox detection, simply\nbecause today’s sandboxes are becoming the fastest and easiest way to have an overview\nof the threat. Many companies use these kinds of systems to detonate malicious files and\nURLs found, to obtain more indicators of compromise to extend their defenses and block\nother related malicious activity. Nowadays we understand security as a global process, and\nsandbox systems are part of this ecosystem, and that is why we must take care with the\nmethods used by malware and how we can defeat it.\n\nHistorically, sandboxes had allowed researchers to visualize the behavior of malware\naccurately within a short period of time. As the technology evolved over the past few years,\nmalware authors started producing malicious code that delves much deeper into the system\nto detect the sandboxing environment.\n\n\n-----\n\nAs sandboxes became more sophisticated and evolved to defeat the evasion techniques, we\nobserved multiple strains of malware that dramatically changed their tactics to remain a step\nahead. In the following sections, we look back on some of the most prevalent sandbox\nevasion techniques used by malware authors over the past few years and validate the fact\nthat malware families extended their code in parallel to introducing more stealthier\ntechniques.\n\nThe following diagram shows one of the most prevalent sandbox evasion tricks we will\ndiscuss in this blog, although many others exist.\n\n## Delaying Execution\n\nInitially, several strains of malware were observed using timing-based evasion techniques\n\n[latent execution], which primarily boiled down to delaying the execution of the malicious\ncode for a period using known Windows APIs like NtDelayExecution, CreateWaitTableTImer,\nSetTimer and others. These techniques remained popular until sandboxes started identifying\nand mitigating them.\n\n\n-----\n\n## GetTickCount\n\nAs sandboxes identified malware and attempted to defeat it by accelerating code execution,\nit resorted to using acceleration checks using multiple methods. One of those methods, used\nby multiple malware families including Win32/Kovter, was using Windows API GetTickCount\nfollowed by a code to check if the expected time had elapsed. However, we observed several\nvariations of this method across malware families.\n\nThis anti-evasion technique could be easily bypassed by the sandbox vendors simply\ncreating a snapshot with more than 20 minutes to have the machine running for more time.\n\n## API Flooding\n\nAnother approach that subsequently became more prevalent, observed with Win32/Cutwail\nmalware, is calling the garbage API in the loop to introduce the delay, dubbed API flooding.\nBelow is the code from the malware that shows this method.\n\n## Inline Code\n\nWe observed how this code resulted in a DOS condition since sandboxes could not handle it\nwell enough. On the other hand, this sort of behavior is not too difficult to detect by more\ninvolved sandboxes. As they became more capable of handling the API based stalling code,\n\n\n-----\n\nyet another strategy to achieve a similar objective was to introduce inline assembly code that\nwaited for more than 5 minutes before executing the hostile code. We found this technique in\nuse as well.\n\nSandboxes are now much more capable and armed with code instrumentation and full\nsystem emulation capabilities to identify and report the stalling code. This turned out to be a\nsimplistic approach which could sidestep most of the advanced sandboxes. In our\nobservation, the following depicts the growth of the popular timing-based evasion techniques\nused by malware over the past few years.\n\n## Hardware Detection\n\nAnother category of evasion tactic widely adopted by malware was fingerprinting the\nhardware, specifically a check on the total physical memory size, available HD size / type\nand available CPU cores.\n\nThese methods became prominent in malware families like Win32/Phorpiex,\nWin32/Comrerop, Win32/Simda and multiple other prevalent ones. Based on our tracking of\ntheir variants we noticed Windows API DeviceIoControl() was primarily used with specific\n\n\n-----\n\nControl Codes to retrieve the information on Storage type and Storage Size.\n\nRansomware and cryptocurrency mining malware were found to be checking for total\navailable physical memory using a known GlobalMemoryStatusEx () trick. A similar check is\nshown below.\n\n**Storage Size check:**\n\nIllustrated below is an example API interception code implemented in the sandbox that can\nmanipulate the returned storage size.\n\nSubsequently, a Windows Management Instrumentation (WMI) based approach became\nmore favored since these calls could not be easily intercepted by the existing sandboxes.\n\n\n-----\n\n-----\n\nHere is our observed growth path in the tracked malware families with respect to the Storage\ntype and size checks.\n\n## CPU Temperature Check\n\nMalware authors are always adding new and interesting methods to bypass sandbox\nsystems. Another check that is quite interesting involves checking the temperature of the\nprocessor in execution.\n\nA code sample where we saw this in the wild is:\n\n\n-----\n\nThe check is executed through a WMI call in the system. This is interesting as the VM\nsystems will never return a result after this call.\n\n## CPU Count\n\nPopular malware families like Win32/Dyreza were seen using the CPU core count as an\nevasion strategy. Several malware families were initially found using a trivial API based\nroute, as outlined earlier. However, most malware families later resorted to WMI and\nstealthier PEB access-based methods.\n\nAny evasion code in the malware that does not rely on APIs is challenging to identify in the\nsandboxing environment and malware authors look to use it more often. Below is a similar\ncheck introduced in the earlier strains of malware.\n\n\n-----\n\nThere are number of ways to get the CPU core count, though the stealthier way was to\naccess the PEB, which can be achieved by introducing inline assembly code or by using the\nintrinsic functions.\n\n\n-----\n\nOne of the relatively newer techniques to get the CPU core count has been outlined in a\n[blog, here. However, in our observations of the malware using CPU core count to evade](https://www.lastline.com/labsblog/malware-evasion-techniques/)\nautomated analysis systems, the following became adopted in the outlined sequence.\n\n## User Interaction\n\nAnother class of infamous techniques malware authors used extensively to circumvent the\nsandboxing environment was to exploit the fact that automated analysis systems are never\nmanually interacted with by humans. Conventional sandboxes were never designed to\nemulate user behavior and malware was coded with the ability to determine the discrepancy\nbetween the automated and the real systems. Initially, multiple malware families were found\nto be monitoring for Windows events and halting the execution until they were generated.\n\nBelow is a snapshot from a Win32/Gataka variant using GetForeGroundWindow and\nchecking if another call to the same API changes the Windows handle. The same technique\nwas found in Locky ransomware variants.\n\nBelow is another snapshot from the Win32/Sazoora malware, checking for mouse\nmovements, which became a technique widely used by several other families.\n\n\n-----\n\nMalware campaigns were also found deploying a range of techniques to check historical\ninteractions with the infected system. One such campaign, delivering the Dridex malware,\nextensively used the Auto Execution macro that triggered only when the document was\nclosed. Below is a snapshot of the VB code from one such campaign.\n\n\n-----\n\nThe same malware campaign was also found introducing Registry key checks in the code for\nMRU (Most Recently Used) files to validate historical interactions with the infected machine.\nVariations in this approach were found doing the same check programmatically as well.\n\n**MRU check using Registry key:**\n\\HKEY_CURRENT_USER\\Software\\Microsoft\\Office\\16.0\\Word\\User MRU\n\n**Programmatic version of the above check:**\n\nHere is our depiction of how these approaches gained adoption among evasive malware.\n\n## Environment Detection\n\nAnother technique used by malware is to fingerprint the target environment, thus exploiting\nthe misconfiguration of the sandbox. At the beginning, tricks such as Red Pill techniques\nwere enough to detect the virtual environment, until sandboxes started to harden their\narchitecture. Malware authors then used new techniques, such as checking the hostname\nagainst common sandbox names or the registry to verify the programs installed; a very small\nnumber of programs might indicate a fake machine. Other techniques, such as checking the\n\n\n-----\n\nfilename to detect if a hash or a keyword (such as malware) is used, have also been\nimplemented as has detecting running processes to spot potential monitoring tools and\nchecking the network address to detect blacklisted ones, such as AV vendors.\n\nLocky and Dridex were using tricks such as detecting the network.\n\n## Using Evasion Techniques in the Delivery Process\n\nIn the past few years we have observed how the use of sandbox detection and evasion\ntechniques have been increasingly implemented in the delivery mechanism to make\ndetection and analysis harder. Attackers are increasingly likely to add a layer of protection in\ntheir infection vectors to avoid burning their payloads. Thus, it is common to find evasion\ntechniques in malicious Word and other weaponized documents.\n\n## McAfee Advanced Threat Defense\n\n**McAfee Advanced Threat Defense (ATD) is a sandboxing solution which replicates the**\nsample under analysis in a controlled environment, performing malware detection through\nadvanced Static and Dynamic behavioral analysis. As a sandboxing solution it defeats\nevasion techniques seen in many of the adversaries. McAfee’s sandboxing technology is\narmed with multiple advanced capabilities that complement each other to bypass the evasion\ntechniques attempted to the check the presence of virtualized infrastructure, and mimics\nsandbox environments to behave as real physical machines. The evasion techniques\ndescribed in this paper, where adversaries widely employ the code or behavior to evade from\ndetection, are bypassed by McAfee Advanced Threat Defense sandbox which includes:\n\n\n-----\n\nUsage of windows API s to delay the execution of sample, hard disk size, CPU core\nnumbers and other environment information .\nMethods to identify the human interaction through mouse clicks, keyboard strokes,\nInteractive Message boxes.\nRetrieval of hardware information like hard disk size, CPU numbers, hardware vendor\ncheck through registry artifacts.\nSystem up time to identify the duration of system alive state.\nCheck for color bit and resolution of Windows .\nRecent documents and files used.\n\nIn addition to this, McAfee Advanced Threat Defense is equipped with smart static analysis\nengines as well as machine-learning based algorithms that play a significant detection role\nwhen samples detect the virtualized environment and exit without exhibiting malware\nbehavior. One of McAfee’s flagship capability, the Family Classification Engine, works on\nassembly level and provides significant traces once a sample is loaded in memory, even\nthough the sandbox detonation is not completed, resulting in enhanced detection for our\ncustomers.\n\n## Conclusion\n\nTraditional sandboxing environments were built by running virtual machines over one of the\navailable virtualization solutions (VMware, VirtualBox, KVM, Xen) which leaves huge gaps for\nevasive malware to exploit.\n\nMalware authors continue to improve their creations by adding new techniques to bypass\nsecurity solutions and evasion techniques remain a powerful means of detecting a sandbox.\nAs technologies improve, so also do malware techniques.\n\nSandboxing systems are now equipped with advanced instrumentation and emulation\ncapabilities which can detect most of these techniques. However, we believe the next step in\nsandboxing technology is going to be the bare metal analysis environment which can\ncertainly defeat any form of evasive behavior, although common weaknesses will still be\neasy to detect.\n\n[Thomas Roccia](https://www.mcafee.com/blogs/author/thomas-roccia/)\nThomas Roccia is senior security researcher on the Advanced Threat Research team. He\nworks on threat intelligence, tracking cybercrime campaigns and collaborating with law\nenforcement agencies. In a previous role,...\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-09-09 - Evolution of Malware Sandbox Evasion Tactics – A Retrospective Study.pdf"
    ],
    "report_names": [
        "2019-09-09 - Evolution of Malware Sandbox Evasion Tactics – A Retrospective Study.pdf"
    ],
    "threat_actors": [
        {
            "id": "faa4a29b-254a-45bd-b412-9a1cbddbd5e3",
            "created_at": "2022-10-25T16:07:23.80111Z",
            "updated_at": "2025-03-27T02:02:09.985067Z",
            "deleted_at": null,
            "main_name": "LookBack",
            "aliases": [
                "FlowingFrog",
                "LookBack",
                "LookingFrog",
                "TA410",
                "Witchetty"
            ],
            "source_name": "ETDA:LookBack",
            "tools": [
                "FlowCloud",
                "GUP Proxy Tool",
                "SodomMain",
                "SodomMain RAT",
                "SodomNormal"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536035,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1653762293,
    "ts_modification_date": 1653762293,
    "files": {
        "pdf": "https://archive.orkl.eu/d05810e90f96a944c8671a972b2f178d563a534d.pdf",
        "text": "https://archive.orkl.eu/d05810e90f96a944c8671a972b2f178d563a534d.txt",
        "img": "https://archive.orkl.eu/d05810e90f96a944c8671a972b2f178d563a534d.jpg"
    }
}