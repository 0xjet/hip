{
    "id": "a51ddda9-282a-47cd-91aa-584aff844aa9",
    "created_at": "2023-01-12T14:59:57.75128Z",
    "updated_at": "2025-03-27T02:13:29.011817Z",
    "deleted_at": null,
    "sha1_hash": "fb1edca8cc291f3e8039ac1a25a19d3a1c12165f",
    "title": "2020-04-13 - How Analysing an AgentTesla Could Lead To Attackers Inbox - Part I",
    "authors": "",
    "file_creation_date": "2022-05-28T15:28:23Z",
    "file_modification_date": "2022-05-28T15:28:23Z",
    "file_size": 1285514,
    "plain_text": "# How Analysing an AgentTesla Could Lead To Attackers Inbox - Part I\n\n**[mrt4ntr4.github.io/How-Analysing-an-AgentTesla-Could-Lead-To-Attackers-Inbox-1/](https://mrt4ntr4.github.io/How-Analysing-an-AgentTesla-Could-Lead-To-Attackers-Inbox-1/)**\n\nSuraj Malhotra April 13, 2020\n\nIf you’d read my previous articles I assured that I’ll be releasing some article every week but\nnow that seems nearly impossible due to some time constraints. I would have shared some\nthings from my real life and new interesting security related things I come across but I don’t\nthink that will happen too coz I think it will decrease the quality of the blog somehow If i begin\nto post my random findings which may seem boring to some other readers.\n\nWhat is the thing I love most about Security in general is the research part.. How we can get\nto real low level to find vulns. And this can happen only if we spend weeks.. maybe months\nreading and testing it out to give a detailed explanation.\n\nAnyways if you have any suggestion/advice regarding this you can always comment and let\nme know.\n\n## Introduction\n\n[So as I promised previously this one is going to be .NET.](https://mrt4ntr4.github.io/EXTORY-Crackme/)\n\nPS This is my first post on analysing a live malware sample and I’m not experienced in this\nfield.\n\n\n-----\n\nI know there are other blogposts on AgentTesla online but I didn t find them as detailed as\nthis one’s going to be.\nAnd Yeah I also know the title seems to be a clickbait but its true XD\nI have divided it into 2 parts and they have around 70+ screenshots as I believe in the fact\nthat Pictures are louder than words :)\n\nThis is a live malware and I don’t want anyone to maliciously use the attacker’s\ncredentials, so obviously I would not give out this sample’s hash and will be redacting a\nfew things as well.\n\n[To start with, I found this sample on Malware Bazaar and it is tagged as a COVID19 malware](https://bazaar.abuse.ch/)\nspead through spearphishing.\nLuckily this sample doesn’t have any anti-debug/vm techniques implemented. Also I’ve not\nsetup my Sniffer VM with inetsim etc. I found it to be fileless. It has a Virustotal Score of\n22/71 at time of writing this.\n\n## Static Properties Analysis\n\nI started off with DIE and observed that its .NET based.\n\nAlso DIE shows that its Packed as its entropy is basically greater than 7.\n\nNext we can check for some strings in the binary, ANSI doesn’t show anything usually and its\nsame in this case too. Observing the UNICODE strings it looks like this was basically based\non a photo manager or something.\n\n\n-----\n\nBut wait if we scroll down we find something interesting…\nYeah It looks similar to base32 encoded string and below it we can see some Game related\nstrings such as frmGameOver, You win!, etc.\n```\n  echo JVNJAA |\n  base32 -d\n  MZ▒base32: invalid\n  input\n\n```\nCool It starts with the MZ Header and this confirms that its base32 encoded.\n\nUnfortunately we can’t copy the whole string here but we can just view it in hexdump by right\nclicking it in DIE.\n\n\n-----\n\n## Behavioral Analysis\n\nNow we have the coolest part of running it in a sandbox environment.\n\nI used [any.run and selected a Win7 32 bit VM (Basic plan) and noticed its execution.](https://any.run/)\n\nHmmm.. So Its silent and doesn’t do any activity on the screen.\n\n[So, Any.run has this feature of mapping MITRE Techniques it notices through the malware](https://attack.mitre.org/techniques/enterprise/)\nactivity.\n\n\n-----\n\nWe observe that its basically a credential stealer and tries to communicate with a C&C\nserver.\n\nWoah!! It accesses over 72 files and is basically looking for browsers, ftp clients etc. So\nAny.run has 2 additional browsers I know of ie. Firefox & Opera. And Firefox for instance\nrequires logins.json and key4.db for the passwords which it accesses obviously. [[1]](https://support.mozilla.org/en-US/questions/1236145)\n\nWe can also view the connection requests and looks like its sending data over smtp with\n_smtp.yandex.com and sends some data which includes User-PC._\n\n\n-----\n\nI also downloaded and analysed the pcap file from any.run but it doesn’t look suspicious as I\ndon’t think the browsers in any.run had some saved passwords.\n\n## Dynamic Analysis\n\nSo to check what it does under the hood we can use dnspy and get on with debugging stuff.\n\nI moved over to my setup of Victim VM for which I use Win7 x64.\n\n### Unpacking Methods\n\nPS I also tried [unpac.me for the first time and I am very much impressed with it. For this](https://unpac.me/)\nsample it resulted in 3 children.\n\nLets see how far can we make it manually.\n\nHmm.. It doesn’t look quite obfuscated right now.\n\n\n-----\n\nAlso It doesn’t have any constructor, So we just place a breakpoint on its Entrypoint and run\nit.\n\nNice, We end up in frmMain and then we can just step in InitializeComponent. I noticed\nthat class2 looked suspicious and setup a breakpoint there.\n\nAhh actually the base32 encoded payload was used here.\n\n\n-----\n\nSo this is the first level of unpacking where it simply invokes a function named f20 with\narguments as Class1.Myproperty & _2048. [[2]](https://docs.microsoft.com/en-us/dotnet/api/system.type.invokemember?view=netframework-4.8#System_Type_InvokeMember_System_String_System_Reflection_BindingFlags_System_Reflection_Binder_System_Object_System_Object___)\n\nNow I place a breakpoint on return in InvokeMember and just continue.\n\nNow stepping in we find some interesting locals and the payload file is a dll named\n**DefenderProtect.dll.**\n\n\n-----\n\nAlso It has another methods as well which are used in f20.\n\nSo f20 is basically used to unpack another file\n\nThe array has the final decrypted 2nd payload file so we can dump it using Memory Window\ntoo.\n\n\n-----\n\nBut whats the fun in doing that, instead we can try to understand the unpacking algo. Hmm..\nthe resource from _2048 named ABHqTRJFnsWBEzLtXeCZ is used in this process.\n\nfcn. detroit1 just returns that resource as a handle to a bitmap image.\n\nThe main algo resides in fcn detroit1 and detroit\n\n_detroit1 adds a pixel’s rgb value to a list when it is non-black._\n\n\n-----\n\nThen detroit does a repeating key xor on the list returned by detroit0\n\nwhere the key is first 16 bytes of the list.\n\nSo I just saved the bitmap image and wrote a python script to test the algo as well.\n\n\n-----\n\n```\nfrom PIL import Image\nfrom hexdump import *\nimg = Image.open(\"ABHqTRJFnsWBEzLtXeCZ\")\npixels = img.load()\npixList = []\nwidth, height = img.size\nfor x in range(width):\n  for y in range(height):\n    cpixel = pixels[x, y]\n    if(cpixel != (0,0,0,0)):\n      for value in cpixel[:3]:\n              pixList.append(value)\nxorkey = pixList[:16]\nencPayload = pixList[16:]\ni = 0\nwhile(i < len(encPayload)):\n  encPayload[i] ^= xorkey[i%16]\n  i+=1\ndec = ''.join([chr(d) for d in\nencPayload[:9200]])\nprint hexdump(dec)\npayload = open('dontopen.gg','wb')\nfor lol in dec:\n  payload.write(chr(lol))\n\n```\n\n-----\n\n```\n  00000000: 4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF 00 00 \n  MZ..............\n  00000010: B8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00 \n  ........@.......\n  00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 \n  ................\n  00000030: 00 00 00 00 00 00 00 00 00 00 00 00 80 00 00 00 \n  ................\n  00000040: 0E 1F BA 0E 00 B4 09 CD 21 B8 01 4C CD 21 54 68 \n  ........!..L.!Th\n  00000050: 69 73 20 70 72 6F 67 72 61 6D 20 63 61 6E 6E 6F is program\n  canno\n  00000060: 74 20 62 65 20 72 75 6E 20 69 6E 20 44 4F 53 20 t be run in\n  DOS\n  00000070: 6D 6F 64 65 2E 0D 0D 0A 24 00 00 00 00 00 00 00 \n  mode....$.......\n  00000080: 50 45 00 00 4C 01 03 00 0D C8 84 5E 00 00 00 00 \n  PE..L......^....\n\n```\nNow this boy looks obfuscated.\n\nBut it just starts a thread and I was unable to debug it.\n\nAlso that isn’t a big deal as this was mainly invoking a method from another file it just\nunpacked.. ¯\\_(ツ)_/¯\n\n\n-----\n\nNow finally we will be analysing the last and third file which resulted in unpacme.\n\nWe step in and are currently in zdb method.\n\nNow when I stepped in the above line to get value for text I observed that a function is called\nrepeatedly. Hmm.. Maybe It is used for some deobfuscation or decryption of suspicious.\n\n\n-----\n\n## Decrypting Strings\n\nWe step into that suspicious function obfuscated as \\u206E and at first It looks like assigning\na list of objects from \\uFEFF\n\nThe object array looks like the following in the locals window and contains integer arrays.\n\n\n-----\n\nSo we setup a normal breakpoint at the function return. It passes the beginning 32 bytes of\nthe string as key and the next 16 bytes as the IV to the Decryption function.\n\n\n-----\n\nAnd Now execution is passed over to Rijndael(AES) decryption function and we can clearly\nsee that it isn’t obfuscated and has variable names as key & IV, and looks like CBC mode\nezpz :)\n\nWe can just place a Breakpoint at return text in CreateStringFromEncoding and we will get\nthe decoded string in the locals window and we’d get to know whenever this decryption func\nis invoked as well.\n\nSo this time it returns “None” due to exception but sometimes the same gives “WinMgmt:”.\nAlso we can now rename it to decStr() for our ease.\n\nMoving on.. It access/creates some environment variables.\n\n\n-----\n\nNow I thought of decrypting all of the strings with python.\n\nUnfortunately I was not able to copy the content of the encrypted int array from the locals\nand copying it from the declaration was not efficient.\nThe problem with dumping a array local from the memory window (in this case) in dnspy is it\njust shows it in reverse (maybe coz of little endian).\nBut the array starts below what it refers to there and I was somehow able to select it\nmanually and dumped it finally.\n\nThen I tried to implement the algo in python and coz of my weird workaround for dumping it,\nthe script resulted in some errors. But I noticed that the error arised due to the values in list\nstrEnds(below) and they were pretty common at the string end and I used them to split the\ndump and get a single string. I think this was because of the uint[] initialization in the object\narray.\nAnyways It finally worked and there were around 865 enc strings.\n\nPS The Key and IV for every cipher is different and is taken from the encoded string as well.\n```\n  import string\n  from Crypto.Cipher import AES\n  def decipher(dd):\n    key = dd[0:0x20]\n    iv = dd[0x20:0x30]\n    cipher = dd[0x30:]\n    rijn = AES.new(key, AES.MODE_CBC, iv)\n    decipher = rijn.decrypt(cipher).strip()\n    plain = filter(lambda x: x in string.printable,\n  decipher)\n\n```\n\n-----\n\n```\n    print plain\n  dmp = open('dump.txt').read()\n  strEnds = [\"0000000048191F0110000000\",\n  \"0000000048191F0114000000\",\n  \"0000000048191F0118000000\",\n  \"0000000048191F011C000000\",\n  \"0000000048191F0124000000\",\n  \"0000000048191F0120000000\",\n  \"0000000048191F012C000000\",\n  \"0000000048191F0128000000\",\n  \"000000004819C4001C000000\"]\n  for end in strEnds:\n    dmp = dmp.replace(end, \" \")\n  lol = dmp.split()\n  c = 0\n  for x in lol:\n    print c,\n    try:\n      decipher(x.decode('hex'))\n    except:\n      print \"[!] ERROR :\", x, \"Length :\",\n  len(x.decode('hex'))\n    c+=1\n\n```\nFull Results : [dec.txt](https://mrt4ntr4.github.io/files/MA/sample1/dec.txt)\n\nSome of the decrypted strings are as follows :\n\n\n-----\n\n```\n  WScript.Shell\n  Software\\Microsoft\\Windows\\CurrentVersion\\Run\n  SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\StartupApprove\n  d\\Run\n  SELECT * FROM Win32_Processor\n  Opera Software\\Opera Stable\n  Yandex\\YandexBrowser\\User Data\n  Chrome\\Chrome\\User Data\n  \\FTP Navigator\\Ftplist.txt\n  HKEY_CURRENT_USER\\Software\\FTPWare\\COREFTP\\Sites\n\n```\n[Hmm so it also uses WScript.Shell, maybe for executing some system commands.](https://ss64.com/vb/shell.html)\n\nAlso it uses some registry keys for persistence and adding itself to the startup.\n\n[And Gets some info about our system using Win32_Processor](https://devblogs.microsoft.com/scripting/use-powershell-and-wmi-to-get-processor-information/)\n\nAccess locations associated with browsers mainly “User Data” and looks for some FTP\ncredentails too.\n\n[So Now I guess Its enough for Part-1, Head over here for the 2nd Part.](https://mrt4ntr4.github.io/How-Analysing-an-AgentTesla-Could-Lead-To-Attackers-Inbox-2/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-04-13 - How Analysing an AgentTesla Could Lead To Attackers Inbox - Part I.pdf"
    ],
    "report_names": [
        "2020-04-13 - How Analysing an AgentTesla Could Lead To Attackers Inbox - Part I.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535597,
    "ts_updated_at": 1743041609,
    "ts_creation_date": 1653751703,
    "ts_modification_date": 1653751703,
    "files": {
        "pdf": "https://archive.orkl.eu/fb1edca8cc291f3e8039ac1a25a19d3a1c12165f.pdf",
        "text": "https://archive.orkl.eu/fb1edca8cc291f3e8039ac1a25a19d3a1c12165f.txt",
        "img": "https://archive.orkl.eu/fb1edca8cc291f3e8039ac1a25a19d3a1c12165f.jpg"
    }
}