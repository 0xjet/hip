{
    "id": "f8aa327c-fb37-4af4-9fd0-44680047b341",
    "created_at": "2023-01-12T15:02:17.508939Z",
    "updated_at": "2025-03-27T02:06:04.029565Z",
    "deleted_at": null,
    "sha1_hash": "71db19a32c6b2e84ba8521107008d19da5934d6f",
    "title": "2022-04-10 - Qakbot Series- String Obfuscation",
    "authors": "",
    "file_creation_date": "2022-06-01T12:23:30Z",
    "file_modification_date": "2022-06-01T12:23:30Z",
    "file_size": 289715,
    "plain_text": "# Qakbot Series: String Obfuscation\n\n**[malwarology.com/2022/04/qakbot-series-string-obfuscation/](https://www.malwarology.com/2022/04/qakbot-series-string-obfuscation/)**\n\n2022-04-10\n\n\nApril 10, 2022\n\n\n[Malware Analysis,](https://www.malwarology.com/categories/malware-analysis) [Qakbot](https://www.malwarology.com/categories/qakbot)\nIn late March 2022, I was requested to analyze a software artifact. It was an instance of\nQakbot, a modular information stealer known since 2007. Differently to other analyses I do\nas part of my daily job, in this particular case I can disclose wide parts of it with you readers.\nI’m addressing them in a post series. Here, I’ll discuss about the string obfuscation techinque\n[based on this specific sample.](https://www.virustotal.com/gui/file/8565e3e213572cbd7c3df45ae3fadd094831aef7b63d3b389e57097c1b8602d6/detection)\n\nLooking at the strings embedded into a software artifact is one of the first approaches an\nanalyst may attempt during the triaging stage. For those of you don’t know what I’m talking\nabout, strings are sequences of bytes that, once interpreted as characters, form meaningful\nwords. During the process that starts with a program source code and ends with that\nprogram being compiled and ready to run, strings are usually preserved. What does that\nmean? It means that if you have a string in the source code, e.g. a path or a function name,\nthen that string will lie into the object code after the compilation of the sources. Strings may\nbe an useful source of information to quickly understand the capabilities of a piece of\nsoftware and immediately focus on specific areas of the artifact deserving a closer look.\nStrings can be statically extracted, i.e. you don’t need to exectute the software to obtain\nthem.\n\nNaturally, malware developers know the importance of the strings during the analyis process.\nTherefore, they tend to hide this source of information from their products. One easy and\ncheap technique to hide strings like variable names and function names is to stripe them\nfrom the binary. This is acheavable simply by compiling the source with particular flags.\nAnother technique aimed at hiding the most valuable strings is called string obfuscation.\nString obfuscation consists in storing the strings in encrypted or obfuscated form so that they\ncannot be recognized and extracted from the artifact. Those strings are decrypted at runtime\nand consumed by the software when they are needed. The Qakbot sample I analyzed\nimplements a string obfuscation technique.\n\nIndeed, the strings analysis for the sample object of analysis wasn’t really fruitful when I tried\nto do it. There were not so many meaningful strings overall and most of them were\nunreferenced or, in general, not providing any insight. There was only one exception: the\npresence of 18 very long and apparently meaningless strings. We postpone a discussion\nabout their purpose to another post since it regards another anti-analysis technique. The\nreason why the string analysis wasn’t so effective is that the vast majority of them are\nobfuscated to hide evidence of the malware capabilities.\n\n\n-----\n\n**Figure 1**\n\nQakbot string deobfuscation function\n\nAll the meaningful and relevant strings are stored in obfuscated form in two continuous\nblobs. The first blob is located at 0xb542b8 and the second blob is located at 0xb551f8. A\nstring is de-obfuscated by xor-ing the specific part of the blob with a key stored as a\ncontinuous sequence of bytes. Each blob is xor-ed with a different key. There are two\ninstances of the function implementing the string de-obfuscation, one starts at 0xb302c6 and\nanother one starts at 0xb227a1. As you may notice from Figure 1, showing the decompiled\ncode for one of those instances, it expects four arguments: the blob where the string is\ncontained, the size of the blob, the xoring key, and the starting offset of the obfuscated string\nwithin the blob.\n\n\n-----\n\n```\ndef deobfuscate_string(blob1: bytes, p1: int, blob2: bytes, p3: int) > bytes:\n  l8 = 0\n  i = p3\n  if p3 <= p1:\n    while i <= p1:\n      if blob2[i % 0x5a] == blob1[i]:\n        l8 = i - p3\n        break\n      i += 1\n  lc = bytearray([0] * (l8))\n  i = 0\n  if l8 > 0:\n    while i < l8:\n      lc[i] = blob2[(p3 + i) % 0x5a] ^ blob1[p3:][i]\n      i += 1\n  return bytes(lc)\n\n```\n**Listing 1**\n\nPython translation of the string deobfuscation function\n\n**Listing 1 shows a Python3 translation of the Qakbot string deobfuscation function. I had to**\ncode it since the offset of many strings into the sample code is computed at runtime instead\n[of being hardcoded. That function replicates the algorithm implemented in the sample. Here](https://www.malwarology.com/text/1-qakbot-strings-obfuscation/strings.txt)\nyou will find a complete list of the de-obfuscated strings produced by our script. For each\nstring I mention the containing blob and the starting offset within the blob. In that list you’ll\nfind a lot of potentially interesting elements regarding the malware capabilities. I’ll discuss\nabout some of them in the coming blog posts.\n\nAs always, if you want to share comments or feedbacks (rigorously in broken Italian or\nbroken English) do not esitate to drop me a message at admin[@]malwarology.com.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-10 - Qakbot Series- String Obfuscation.pdf"
    ],
    "report_names": [
        "2022-04-10 - Qakbot Series- String Obfuscation.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535737,
    "ts_updated_at": 1743041164,
    "ts_creation_date": 1654086210,
    "ts_modification_date": 1654086210,
    "files": {
        "pdf": "https://archive.orkl.eu/71db19a32c6b2e84ba8521107008d19da5934d6f.pdf",
        "text": "https://archive.orkl.eu/71db19a32c6b2e84ba8521107008d19da5934d6f.txt",
        "img": "https://archive.orkl.eu/71db19a32c6b2e84ba8521107008d19da5934d6f.jpg"
    }
}