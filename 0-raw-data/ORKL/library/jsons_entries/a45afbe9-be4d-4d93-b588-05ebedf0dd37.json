{
    "id": "a45afbe9-be4d-4d93-b588-05ebedf0dd37",
    "created_at": "2023-01-12T15:07:58.37562Z",
    "updated_at": "2025-03-27T02:06:12.500915Z",
    "deleted_at": null,
    "sha1_hash": "c9b4ac2d8cc4ab22761b9c797badef431833731a",
    "title": "2021-06-22 - How to Dissect Unusual Protocols for Troubleshooting OT Security",
    "authors": "",
    "file_creation_date": "2022-05-27T23:25:37Z",
    "file_modification_date": "2022-05-27T23:25:37Z",
    "file_size": 3799040,
    "plain_text": "# How to Dissect Unusual Protocols for Troubleshooting OT Security\n\n**[nozominetworks.com/blog/how-to-dissect-unusual-protocols-for-troubleshooting-ot-security/](https://www.nozominetworks.com/blog/how-to-dissect-unusual-protocols-for-troubleshooting-ot-security/)**\n\nBy June 22, 2021\n\nAs OT security researchers, the Nozomi Networks Labs team continually works to\nunderstand OT and IoT device processes and their security risks. This includes\nunderstanding how assets like embedded controllers communicate with each other and their\nworkstations. To do so, we need to reverse undocumented protocols.\n\nUnfortunately, the process of dissection can’t be standardized due to the unknown layers of\ncomplexity put in place by most vendors when they design systems. This is where the\nexperience of security researchers can make a big difference.\n\nThis is the first of a series of articles from Nozomi Networks Labs where we’ll demonstrate\nhow to use Lua APIs to instruct Wireshark to properly dissect an undocumented protocol.\n\nIn this blog, we look at the steps involved in developing a dissector for a real-world use case,\nthe well-known Cisco Nexus protocol. We’ve also posted a plug-in on GitHub to help the\nsecurity community at large.\n\nWhether you’re a security researcher yourself, or you manage networks for an asset owner,\nthis methodology and plug-in will help you troubleshoot networking issues and improve\noverall OT security.\n\n\n-----\n\nIt can be tedious and time-consuming to gain a complete understanding of the unknown\nprotocols used by different security device vendors, but it’s possible to use Lua APIs to more\neasily dissect them.\n\n## Determining How to Dissect Unknown Protocols\n\nOne of tools commonly used to kick-start the exploration process for an unknown protocol is\nWireshark.\n\nWith the right set of traffic/Pcaps – generated by forcing a specific type of communication\nbetween controllers – we can start analyzing the protocol.\n\nWe begin by focusing our attention on patterns. Normally, when we start the protocol reverse\nengineering process, we’re confronted by an unknown language. We need to identify key\nelements that will help us understand the communication structure step-by-step (lengths,\nfunction codes, sequence numbers, crc, etc.).\n\n\n-----\n\nReverse engineering of protocols begins with focusing on unknown language patterns.\nPlugin scripts written in the Lua language can help dissect packets and validate research\nfindings.\nWhile making assumptions during this phase, it helps to leverage one of Wireshark’s\ncapabilities called plugins. These are scripts written in the Lua programming language that\ninstruct the tool to dissect each packet using our findings. Plugins also allow us to validate\nfindings with the collected and/or live traffic.\n\n**TIP: You can also create your own dissectors directly using the native Wireshark C**\n**language in cases where performance needs to be fine-tuned.**\n\nWindows: `%APPDATA%\\Wireshark\\plugins`\nUnix: `~/.local/lib/wireshark/plugins`\nMac: `~/.config/wireshark/plugins`\n\n\n-----\n\nRockwell Ethernet/IP dissection\nAs you can imagine, the processes involved in gaining a complete understanding of an\nunknown communication language can be tedious and time-consuming. However, the end\nresult is shareable knowledge (in the form of a plugin) that’s highly useful to others.\nFor example, utility operators can benefit enormously from tools like this every time they\nneed to troubleshoot specific scenarios within a normal industrial process operation.\n\nRather than describe how to develop a Lua dissector from scratch (there’s already a lot of\neasily-found documentation out there, see the tip below), we’ll dive into some specific nonstandard real world use cases and how to deal with them.\n\n**TIP: For those just starting their Lua dissection journey, take a look to Mika’s tech**\n**blog:** **[Creating a Wireshark dissector in Lua – Part 1 (the basics).](https://mika-s.github.io/wireshark/lua/dissector/2017/11/04/creating-a-wireshark-dissector-in-lua-1.html)**\n\n## Registering a New Dissector\n\n**Ethertype and Recall**\n\nOur first challenge involves dealing with protocols that aren’t easily accessible by Wireshark\n– at least not in the standard way we’re used to.\n\n\n-----\n\nLet s use Cisco Nexus as an example – a well-known protocol used between the NX-OS\nswitch series. We’ll go through the steps involved in developing the related dissector (note\nwe also reverse engineered its inner structure).\n\nFirst, the research team noticed that Wireshark doesn’t support the dissection of such a\nprotocol. This means we have to do a bit of investigation and packet analysis in order to\nunderstand its structure.\n\n[As far as Wireshark knows, we have an 802.1Q Virtual Lan frame. This is a commonly used](https://en.wikipedia.org/wiki/IEEE_802.1Q)\nstandard for defining VLANs (Virtual LAN) with a pretty basic structure.\n\nThe VLAN ID in place [0x8905] is non-standard. This is why the tool classifies it as an\n“unknown” type. Let’s assume that that could be a good first indicator for a proprietary\nprotocol, and keep it in mind for later.\n\nUnknown protocol\n\nAfter a bit of deeper analysis on some interesting patterns in the “data” content of the packet,\nwe determined that the structure is much simpler than expected. And, from a particular point,\nit is very similar to another common protocol in the industrial field. This proprietary protocol is\nactually a combination of a vendor specific layer, plus a well known protocol.\n\n**HINT: Do those 0x88a4 bytes ring a bell?**\n\n\n-----\n\nLuckily, the encapsulated protocol is already known by Wireshark. This means that we have\nto instruct the tool to subscribe (or tag) the unknown layer to properly and accurately detect it\nevery time it’s seen over the wire.\n\nNow, recall the discovered encapsulated dissector mentioned earlier.\n\nEthernet II frame structure\nLet’s start by writing down some code. First, we have to instruct Wireshark to link to our\ndissector every time it sees any ethernet packet with the unknown Type ID: 0x8905.\nTo link properly, we can force the `DissectorTable.get()` function to point in the specified\nframe area by indicating that we’re interested in referencing only the `ethertype` parameter\n\n[aka Type ID] and not the standard udp/tcp.port.\n\n```\nend\n\n```\n```\nlocal eth_table = DissectorTable.get(\"ethertype\")\n\n```\n```\neth_table:add(0x8905, cisco_nexus)\n\n```\n\nNext, we have to initialize a second dissector table that we’re going to recall at a specific\noffset. For this one, we’ll use a different approach: Lua gives us the ability to point at a\nspecific known dissector every time we need it by using the get_dissector() function, and\nthen use it through the call() function.\n\nLet’s see these functions in action.\n\nBecause the nested protocol has a defined VLAN tag within the 802.1Q IEEE standard, we\ncan store the DissectorTable related to it in the `original_vlan_dissector` variable at the\ninitialization section of our script:\n\n\n-----\n\n```\n-- load 802.1Q Virtual LAN dissector\noriginal_vlan_dissector =\nDissectorTable.get(\"ethertype\"):get_dissector(0x8100)\n\n```\nand then call it at the right offset after the Cisco Nexus header, within the context of the main\ndissection function, precisely after the 4 header bytes:\n\n**TIP: The first length check is done to ensure that we avoid any 0 byte packets, in case**\n**some are found.**\n\n```\nend\n\n```\n\nThe final result is a complete dissection of the entire packet structure.\n\n\n-----\n\nBefore: Detection of an unknown protocol\n\nAfter: Final dissection of the unknown protocol’s inner structure\n\n## Using the Cisco Nexus Protocol to Create the Cisco Nexus Dissector Plugin\n\n\n-----\n\nIn this article, we showed how to easily manage known and unknown layer 2 frames using\nLua APIs, by instructing Wireshark to properly dissect them while the analysis is being done.\nTo illustrate this, Nozomi Networks researchers used a real-world example of a previously\nunknown protocol: Cisco Nexus.\n\nDuring the background analysis, the team found that the proprietary protocol encapsulated a\nwell-defined communication structure. We then leveraged this knowledge to test the\nfollowing combinations of DissectorTable functions:\n\n.get(v1)\n.get(v1):get_dissector(v2)\n.get(v1):get_dissector(v2):call(v3,v4,v5)\n\nThe outcome of our research is a plugin called the Cisco Nexus Dissector. We’ve posted it in\n[GitHub to help asset owners troubleshoot activities within their own networks. The global](https://github.com/NozomiNetworks/dissectors)\nsecurity community can also use it to further their analysis and research projects.\n\nNext month, Nozomi Networks Labs will investigate how to create a plugin for another\nunknown protocol found in a commonly-used industrial communications equipment. Stay\ntuned!\n\n**Related Content**\n\nRESEARCH REPORT\n\n\n-----\n\n## TRITON: The First ICS Cyber Attack on Safety Instrument Systems\n\n**Understanding the Malware, Its Communications and Its OT Payload**\n\n**Learn about:**\n\nHow the TRITON cyberattack unfolded and why it’s so important\nUnderstanding TRITON through reverse engineering\nThe implications of TRITON on industrial control systems security\nTwo free community tools that help you defend against TRITON\n\n[Download](https://info.nozominetworks.com/triton-malware-research-report-lp)\n**Related Links**\n\n[Research Report: Nozomi Networks Labs OT/IoT Security Report](https://www.nozominetworks.com/ot-iot-security-report/)\nGithub.com: [Nozomi Networks Dissectors: Cisco Nexus](https://github.com/NozomiNetworks/dissectors/blob/main/CiscoNexus.lua)\nBlog: [Demonstrating the Link Between Functional Safety and ICS Security](https://www.nozominetworks.com/blog/demonstrating-the-link-between-functional-safety-and-ics-security/)\nBlog: [Colonial Pipeline Ransomware Attack: Revealing How DarkSide Works](https://www.nozominetworks.com/blog/colonial-pipeline-ransomware-attack-revealing-how-darkside-works/)\nBlog: Black Hat: [Understanding TRITON, The First SIS Cyber Attack](https://www.nozominetworks.com/blog/black-hat-understanding-triton-the-first-sis-cyber-attack/)\nBlog: [The Clever Use of Post Dissectors to Analyze Layer 2 Protocols](https://www.nozominetworks.com/blog/the-clever-use-of-postdissectors-to-analyze-layer-2-protocols/)\n[Webpage: Nozomi Networks Labs](https://www.nozominetworks.com/labs/)\nData Sheet: [Threat Intelligence](https://www.nozominetworks.com/downloads/US/Nozomi-Networks-Threat-Intelligence-Data-Sheet.pdf)\n\n[Younes Dragoni](https://www.nozominetworks.com/author/younes-dragoni/)\n**Security Researcher**\n\nYounes Dragoni is a member of the World Economic Forum’s Global Shaper Community, a\nworldwide network of young people actively shaping our future through solution building,\npolicy-making and lasting change. His fascination with computer security, and desire to be on\nthe offensive side, began many years ago. Now, as Security Researcher with Nozomi\nNetworks, Younes thrives on hunting down vulnerabilities in automation devices\n(ICS/SCADA) and examining malicious software to understand the nature of threats to\nindustrial operations.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-22 - How to Dissect Unusual Protocols for Troubleshooting OT Security.pdf"
    ],
    "report_names": [
        "2021-06-22 - How to Dissect Unusual Protocols for Troubleshooting OT Security.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536078,
    "ts_updated_at": 1743041172,
    "ts_creation_date": 1653693937,
    "ts_modification_date": 1653693937,
    "files": {
        "pdf": "https://archive.orkl.eu/c9b4ac2d8cc4ab22761b9c797badef431833731a.pdf",
        "text": "https://archive.orkl.eu/c9b4ac2d8cc4ab22761b9c797badef431833731a.txt",
        "img": "https://archive.orkl.eu/c9b4ac2d8cc4ab22761b9c797badef431833731a.jpg"
    }
}