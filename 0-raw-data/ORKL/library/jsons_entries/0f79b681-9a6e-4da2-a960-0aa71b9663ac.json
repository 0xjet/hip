{
    "id": "0f79b681-9a6e-4da2-a960-0aa71b9663ac",
    "created_at": "2023-01-12T15:05:40.451982Z",
    "updated_at": "2025-03-27T02:05:19.013598Z",
    "deleted_at": null,
    "sha1_hash": "7a3245be31f1cb28f072458881076bf098819d7e",
    "title": "2016-04-01 - Petya – Taking Ransomware To The Low Level",
    "authors": "",
    "file_creation_date": "2022-05-28T04:55:29Z",
    "file_modification_date": "2022-05-28T04:55:29Z",
    "file_size": 1215129,
    "plain_text": "# Petya – Taking Ransomware To The Low Level\n\n**[blog.malwarebytes.com/threat-analysis/2016/04/petya-ransomware/](https://blog.malwarebytes.com/threat-analysis/2016/04/petya-ransomware/)**\n\nMalwarebytes Labs April 1, 2016\n\n[Petya is different from the other popular ransomware these days. Instead of encrypting files](https://www.malwarebytes.com/ransomware)\none by one, it denies access to the full system by attacking low-level structures on the disk.\n[This ransomware’s authors have not only created their own boot loader but also a tiny](http://www.codeproject.com/Articles/36907/How-to-develop-your-own-Boot-Loader#_Toc231383168)\nkernel, which is 32 sectors long.\n\nPetya’s dropper writes the malicious code at the beginning of the disk. The affected system’s\n[master boot record (MBR) is overwritten by the custom boot loader that loads a tiny](https://en.wikipedia.org/wiki/Master_boot_record)\nmalicious kernel. Then, this kernel proceeds with further encryption. Petya’s ransom note\nstates that it encrypts the full disk, but this is not true. Instead, it encrypts the master file table\n(MFT) so that the file system is not readable.\n\n**[[UPDATE] READ ABOUT THE LATEST VERSION: GOLDENEYE](https://blog.malwarebytes.com/threat-analysis/2016/12/goldeneye-ransomware-the-petyamischa-combo-rebranded/)**\n\n_PREVENTION TIP: Petya is most dangerous in Stage 2 of the infection, which starts when_\nthe affected system is being rebooted after the BSOD caused by the dropper. In order to\nprevent your computer from going automatically to this stage, turn off automatic restart after\n_a system failure_ [(see how to do this).](https://support.microsoft.com/en-us/kb/307973)\n\nIf you detect Petya in Stage 1, your data can still be recovered. More information about it is\n\n[[here] and in this article.](https://hshrzd.wordpress.com/2016/03/31/petya-key-decoder/)\n\n**UPDATE: 8-th April 2016 Petya at Stage 2 has been cracked by** **[leo-stone. Read more:](https://twitter.com/leo_and_stone)**\n**[https://petya-pay-no-ransom.herokuapp.com/ and](https://petya-pay-no-ransom.herokuapp.com/)** **https://github.com/leo-stone/hack-**\n**[petya. Tutorial helping in disk recovery is here.](https://hshrzd.wordpress.com/2016/03/31/petya-key-decoder/)**\n\n## Analyzed samples\n\nMain executable from another campaign (PDF icon)\n\n[a92f13f3a1b3b39833d3cc336301b713](https://www.virustotal.com/en/file/4c1dc737915d76b7ce579abddaba74ead6fdb5b519a1ea45308b8c49b950655c/analysis/)\n\n_Special thanks to:_ _[Florian Roth – for sharing the samples, Petr Beneš – for a constructive](https://twitter.com/Cyb3rOps)_\n_discussion on_\n\n_Twitter._\n\n## Behavioral analysis\n\n\n-----\n\nThis ransomware is delivered via scam emails themed as a job application. E-mail comes\nwith a Dropbox link, where the malicious ZIP is hosted. This initial ZIP contains two\nelements:\n\na photo of a young man, purporting to be an applicant (in fact it is a publicly available\nstock image)\nan executable, pretending to be a CV in a self-extracting archive or in PDF (in fact it is\na malicious dropper in the form of a 32bit PE file):\n\nIn order to execute its harmful features, it needs to run with Administrator privileges.\n[However, it doesn’t even try to deploy any user account control (UAC) bypass technique. It](https://en.wikipedia.org/wiki/User_Account_Control)\nrelies fully on social engineering.\n\nWhen we try to run it, UAC pops up this alert:\n\nAfter deploying the application, the system crashes. When it restarts, we see the following\n[screen, which is an imitation of a CHKDSK scan:](https://en.wikipedia.org/wiki/CHKDSK)\n\n\n-----\n\nIn reality, the malicious kernel is already encrypting. When it finishes, the affected user\nencounters this blinking screen with an ASCII art:\n\nPressing a key leads to the main screen with the ransom note and all information necessary\nto reach the Web panel and proceed with the payment:\n\n\n-----\n\n### Infection stages\n\nThis ransomware have two infection stages.\n\nThe first is executed by the dropper (Windows executable file). It overwrites the beginning of\nthe disk (including MBR) and makes an XOR encrypted backup of the original data. This\n[stage ends with an intentional execution of BSOD. Saving data at this point is relatively easy,](https://en.wikipedia.org/wiki/Blue_Screen_of_Death)\nbecause only the beginning of the attacked disk is overwritten. The file system is not\ndestroyed, and we can still mount this disk and use its content. That’s why, if you suspect\nthat you have this ransomware, the first thing we recommend is to not reboot the system.\nInstead, make a disk dump. Eventually you can, at this stage, mount this disk to another\n[operating system and make the file backup. See also: Petya key decoder.](https://hshrzd.wordpress.com/2016/03/31/petya-key-decoder/)\n\nThe second stage is executed by the fake CHKDSK scan. After this, the file system is\ndestroyed and cannot be read.\n\nHowever, it is not true that the full disk is encrypted. If we view it by forensic tools, we can\nsee many valid elements, including strings.\n\n### Website for the victim\n\nWe noted that the website for the victim is well prepared and very informative. The menu\noffers several language versions, but so far only English works:\n\n\n-----\n\nIt also provides a step-by-step process on how affected users can recover their data:\n\n\n-----\n\nStep1: Enter your personal identifier\nStep2: Purchase Bitcoins\nStep3: Do a Bitcoin transaction\nStep4: Wait for confirmation\n\nWe expect that cybercriminals release as little information about themselves as possible. But\nin this case, the authors and/or distributors are very open, sharing the team name—”Janus\nCybercrime Solutions”—and the project release date—12th December 2015. Also, they offer\na news feed with updates, including press references about them:\n\n\n-----\n\nIn case of questions or problems, it is also possible to contact them via a Web form.\n\n## Inside\n\n### Stage 1\n\nAs we have stated earlier, the first stage of execution is in the Windows executable. It is\n[packed in a good quality FUD/cryptor that’s why we cannot see the malicious code at first.](https://blog.malwarebytes.org/threat-analysis/2015/12/malware-crypters-the-deceptive-first-layer/)\nExecutions starts in a layer that is harmless and used only for the purpose of deception and\nprotecting the payload. The real malicious functionality is inside the payload dynamically\nunpacked to the memory.\n\nBelow you can see the memory of the running process. The code belonging to the original\nEXE is marked red. The unpacked malicious code is marked blue:\n\nThe unpacked content is another PE file:\n\n\n-----\n\nHowever, if we try to dump it, we don’t get a valid executable. Its data directories are\ndestroyed. The PE file have been processed by the cryptor in order to be loaded in a\ncontinuous space, not divided by sections. It lost the ability to run independently, without\nbeing loaded by the cryptor’s stub. Addresses saved as RVA are in reality raw addresses.\n\nI have remapped them using a custom tool, and it revealed more information, i.e. the name\nof this PE file is Setup.dll:\n\n_UPDATE: if we catch the process of unpacking in correct moment, we can dump the DLL_\n_[before it is destroyed. The resulting payload is: 7899d6090efae964024e11f6586a69ce](https://virustotal.com/en/file/542a38bf52afa6a4a008089a6fbf22c9d68ef5d6c634dd2c0773d859a8ae2bbf/analysis/)_\n\nAs the name suggest, the role of the payload is to setup everything for the next stage. First, it\ngenerates a unique key that will be used for further encryption. This key must be also known\nto attackers. That’s why it is encrypted by ECC and displayed to the victim as a personal\n\n\n-----\n\nidentifier, that must be send to attackers via personalized page.\n\n[Random values are retrieved by Windows Crypto API function: CryptGenRandom. Below, it](https://msdn.microsoft.com/pl-pl/library/windows/desktop/aa379942%28v=vs.85%29.aspx)\ngets 128 random bytes:\n\nMaking of onion addresses:\n\n[Retrieving parameters of the disk using DeviceIoControl](https://msdn.microsoft.com/pl-pl/library/windows/desktop/aa363216%28v=vs.85%29.aspx)\n\n\n-----\n\nRead/write to the disk:\n\nAfter overwriting the beginning of the disk, it intentionally crashes the system, using an\n[undocumented function NtRaiseHardError:](http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FError%2FNtRaiseHardError.html)\n\n\n-----\n\nAt this point, first stage of changes on the disk have been already made. Below you can see\nthe MBR overwritten by the Petya’s boot loader:\n\nNext few sectors contains backup of original data XORed with ‘7’. After that we can find the\n[copied Petya code (starting at 0x4400 – sector 34).](https://www.virustotal.com/en/file/494dc5755e5b70ccead8074d00cafdb2d16a0f9cf4987446e0f6db209913d816/analysis/1459042011/)\n\n\n-----\n\nWe can also see the strings that are displayed in the ransom note, copied to the the disk:\n\n### Stage 2\n\nStage 2 is inside the code written to the disk’s beginning. This code uses 16 bit architecture.\n\nExecution starts with a boot loader, that loads into memory the tiny malicious kernel. Below\nwe can see execution of the loading function. Kernel starts at sector 34 and it is 32 sectors\nlong (including saved data):\n\nBeginning of the kernel:\n\nChecking if the data is already encrypted is performed using one byte flag that is saved at\nthe beginning of sector 54. If this flag is unset, program proceeds to the fake CHKDSK scan.\nOtherwise, it displays the main red screen.\n\n\n-----\n\nThe fake CHKDSK encrypts MFT using [Salsa20 algorithm. The used key is 32 byte long,](https://github.com/alexwebr/salsa20)\nread from the address 0x6C01. After that, the key gets erased.\n\n[Salsa20 is used in several places in Petya’s code – for encryption, decryption and key](https://github.com/alexwebr/salsa20)\nverification. See the diagram below:\n\n\n-----\n\nInside the same function that displays the red screen, the Key checking routine is called.\nFirst, user is prompted to supply the key. The maximal input length is 73 bytes, the minimal is\n16 bytes.\n\n**Debugging**\n\n[Of course, we cannot debug this stage of Petya via typical userland debuggers that are the](https://en.wikipedia.org/wiki/User_space)\ncasual tools in analyzing malware. We need to go to the low level. The simplest way (in my\n[opinion) is to use Bochs internal debugger. We need to make a full dump of the infected disk.](http://bochs.sourceforge.net/doc/docbook/user/internal-debugger.html)\nThen, we can load it under Bochs.\n\n_[I used the following Bochs configuration (‘infected.dsk’ is my disk dump): bochsrc.txt](https://gist.github.com/hasherezade/5c283e80785395fcb4ae)_\n\nThis is how it looks running under Bochs:\n\n\n-----\n\n**Key verification**\n\nKey verification is performed in the following steps:\n\n1. Input from the user is read.\n\nAccepted\ncharset: 123456789abcdefghijkmnopqrstuvwxABCDEFGHJKLMNPQRSTUVWX\n– if the character outside of this charset occurred, it is skipped.\nOnly first 16 bytes are stored\n2. The supplied key is encoded by a custom algorithm. **_Encoded key is 32 bytes long._**\n3. Data from sector 55 (512 bytes) is read into memory // it will be denoted as\n\n**_verification buffer_**\n\n4. The value stored at physical address 0x6c21 (just before the Tor address) is read into\n\nmemory. It is an 8 byte long array, unique for a specific infection. // it will be denoted as\n**_nonce_**\n[5. The verification buffer is encrypted by 256 bit Salsa20 with encoded key and the](https://github.com/alexwebr/salsa20)\n\n**_nonce_**\n6. If, as the result of applied procedure, verification buffer is fully filled with ‘7’ – it means\n\nthe supplied key is correct.\n\nExample: encoded key versus supplied key:\n\nThe algorithm for encoding the supplied key is very simple:\n\n\n-----\n\nThis file contains bidirectional Unicode text that may be interpreted or compiled differently\nthan what appears below. To review, open the file in an editor that reveals hidden Unicode\ncharacters.\n[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)\n\n[Show hidden characters](http://10.10.0.46/%7B%7B%20revealButtonHref%20%7D%7D)\n\nbool encode(char* key, BYTE *encoded)\n\n{\n\nif (!key || !encoded) {\n\nprintf(\"Invalid buffer\\n\");\n\nreturn false;\n\n}\n\nsize_t len = strlen(key);\n\nif (len < 16) {\n\nprintf(\"Invalid key\\n\");\n\nreturn false;\n\n}\n\nif (len > 16) len = 16;\n\nint i, j;\n\ni = j = 0;\n\nfor (i = 0, j = 0; i < len; i++, j += 2) {\n\nchar k = key[i];\n\nencoded[j] = k + 'z';\n\nencoded[j+1] = k * 2;\n\n}\n\nencoded[j] = 0;\n\nencoded[j+1] = 0;\n\n\n-----\n\nreturn true;\n\n}\n\n[view raw](https://gist.github.com/hasherezade/785f7da52dfd91fe9e59ae283df2e898/raw/2bd16e3ddee223d3f0706306af2bb2678f98b2c6/petya_encoder.cpp)\n\n[petya_encoder.cpp](https://gist.github.com/hasherezade/785f7da52dfd91fe9e59ae283df2e898#file-petya_encoder-cpp)\n\nhosted with ❤ by [GitHub](https://github.com/)\n**Valid key is important for the process of decryption. If we supply a bogus key and try to**\npass it as valid by modifying jump conditions, Petya will recover the original MBR but other\ndata will not be decrypted properly and the operating system will not run.\n\nWhen the key passed the check, Petya shows the message “Decrypting sectors” with a\nprogress.\n\nAfter it finishes, it asks to reboot the computer. Below is Petya’s last screen, showing that\nuser finally got rid of this ransomware:\n\n\n-----\n\n## Conclusion\n\nIn terms of architecture, Petya is very advanced and atypical. Good quality FUD, well\nobfuscated dropper – and the heart of the ransomware – a little kernel – depicts that authors\nare highly skilled. However, the chosen low-level architecture enforced some limitations, i.e.:\nsmall size of code and inability to use API calls. It makes cryptography difficult. That’s why\nthe key was generated by the higher layer – the windows executable. This solution works\nwell, but introduces a weakness that allowed to restore the key (if we manage to catch Petya\n[at Stage 1, before the key is erased). Moreover, authors tried to use a ready made Salsa20](https://github.com/alexwebr/salsa20)\nimplementation and make slight changes in order to adopt it to 16-bit architecture. But they\ndidn’t realized, that changing size of variables triggers serious vulnerabilities (detailed\n[description you can find in CheckPoint’s article).](http://blog.checkpoint.com/2016/04/11/decrypting-the-petya-ransomware/)\n\nMost of the ransomware authors take care of the user experience, so that even a non\ntechnical person will have easy way to make a payment. In this case, user experience is very\nbad. First – denying access to the full system is not only harmful to a user, but also for the\nransomware distributor, because it makes much harder for the victim to pay the ransom.\nSecond – the individual identificator is very long and it cannot be copied from the screen.\nTyping it without mistake is almost impossible.\n\nOverall, authors of Petya ransomware wrote a good quality code, that, however – missed the\ngoals. Ransomware running in userland can be equally or more dangerous.\n\n## Appendix\n\nAbout Petya by other vendors:\n\n**Read also:**\n\n\n-----\n\n[http://www.invoke-ir.com/2015/05/ontheforensictrail-part2.html – Master Boot Record](http://www.invoke-ir.com/2015/05/ontheforensictrail-part2.html)\n[http://sysforensics.org/2012/06/mbr-malware-analysis/ – MBR malware analysis](http://sysforensics.org/2012/06/mbr-malware-analysis/)\nhttps://socprime.com/en/blog/dismantling-killdisk-reverse-of-the-blackenergydestructive-component/ – Dismantling KillDisk: reverse of the BlackEnergy destructive\ncomponent (another malware attacking hard disk)\n\n_This was a guest post written by Hasherezade, an independent researcher and programmer_\n_with a strong interest in InfoSec. She loves going in details about malware and sharing threat_\n_[information with the community. Check her out on Twitter @hasherezade and her personal](https://twitter.com/hasherezade)_\n_[blog: https://hshrzd.wordpress.com.](https://hshrzd.wordpress.com/)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-04-01 - Petya – Taking Ransomware To The Low Level.pdf"
    ],
    "report_names": [
        "2016-04-01 - Petya – Taking Ransomware To The Low Level.pdf"
    ],
    "threat_actors": [
        {
            "id": "f3b19931-3751-4ece-a235-15b397951dc2",
            "created_at": "2022-10-25T16:07:23.889537Z",
            "updated_at": "2025-03-27T02:02:10.015565Z",
            "deleted_at": null,
            "main_name": "Nazar",
            "aliases": [
                "SIG37"
            ],
            "source_name": "ETDA:Nazar",
            "tools": [
                "Distribute.exe",
                "EYService",
                "GpUpdates.exe",
                "Microolap Packet Sniffer",
                "TCPDUMP for Windows"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e3492534-85a6-4c87-a754-5ae4a56d7c8c",
            "created_at": "2022-10-25T15:50:23.819113Z",
            "updated_at": "2025-03-27T02:00:55.552554Z",
            "deleted_at": null,
            "main_name": "Threat Group-3390",
            "aliases": [
                "Threat Group-3390",
                "Earth Smilodon",
                "TG-3390",
                "Emissary Panda",
                "BRONZE UNION",
                "APT27",
                "Iron Tiger",
                "LuckyMouse"
            ],
            "source_name": "MITRE:Threat Group-3390",
            "tools": [
                "Systeminfo",
                "gsecdump",
                "PlugX",
                "ASPXSpy",
                "Cobalt Strike",
                "Mimikatz",
                "Impacket",
                "gh0st RAT",
                "certutil",
                "China Chopper",
                "HTTPBrowser",
                "Tasklist",
                "netstat",
                "SysUpdate",
                "HyperBro",
                "ZxShell",
                "RCSession",
                "ipconfig",
                "Clambling",
                "pwdump",
                "NBTscan",
                "Pandora",
                "Windows Credential Editor"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "c63ab035-f9f2-4723-959b-97a7b98b5942",
            "created_at": "2023-01-06T13:46:38.298354Z",
            "updated_at": "2025-03-27T02:00:02.798255Z",
            "deleted_at": null,
            "main_name": "APT27",
            "aliases": [
                "TG-3390",
                "EMISSARY PANDA",
                "TEMP.Hippo",
                "Budworm",
                "Group 35",
                "BRONZE UNION",
                "Lucky Mouse",
                "Iron Taurus",
                "GreedyTaotie",
                "Red Phoenix",
                "ZipToken",
                "Iron Tiger",
                "G0027",
                "Earth Smilodon"
            ],
            "source_name": "MISPGALAXY:APT27",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "5c13338b-eaed-429a-9437-f5015aa98276",
            "created_at": "2022-10-25T16:07:23.582715Z",
            "updated_at": "2025-03-27T02:02:09.875151Z",
            "deleted_at": null,
            "main_name": "Emissary Panda",
            "aliases": [
                "APT 27",
                "ATK 15",
                "Bronze Union",
                "Budworm",
                "Earth Smilodon",
                "Emissary Panda",
                "Group 35",
                "Iron Taurus",
                "Iron Tiger",
                "LuckyMouse",
                "Operation DRBControl",
                "Operation Iron Tiger",
                "Operation PZChao",
                "Operation SpoiledLegacy",
                "Operation StealthyTrident",
                "Red Phoenix",
                "TEMP.Hippo",
                "TG-3390",
                "ZipToken"
            ],
            "source_name": "ETDA:Emissary Panda",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "Agent.dhwf",
                "AngryRebel",
                "Antak",
                "CHINACHOPPER",
                "China Chopper",
                "Destroy RAT",
                "DestroyRAT",
                "FOCUSFJORD",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HTTPBrowser",
                "HTran",
                "HUC Packet Transmit Tool",
                "HighShell",
                "HttpBrowser RAT",
                "HttpDump",
                "HyperBro",
                "HyperSSL",
                "HyperShell",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mimikatz",
                "Moudour",
                "Mydoor",
                "Nishang",
                "OwaAuth",
                "PCRat",
                "PlugX",
                "ProcDump",
                "PsExec",
                "RedDelta",
                "SEASHARPEE",
                "Sensocode",
                "SinoChopper",
                "Sogu",
                "SysUpdate",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Token Control",
                "TokenControl",
                "TwoFace",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Xamtrav",
                "ZXShell",
                "gsecdump",
                "luckyowa"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535940,
    "ts_updated_at": 1743041119,
    "ts_creation_date": 1653713729,
    "ts_modification_date": 1653713729,
    "files": {
        "pdf": "https://archive.orkl.eu/7a3245be31f1cb28f072458881076bf098819d7e.pdf",
        "text": "https://archive.orkl.eu/7a3245be31f1cb28f072458881076bf098819d7e.txt",
        "img": "https://archive.orkl.eu/7a3245be31f1cb28f072458881076bf098819d7e.jpg"
    }
}