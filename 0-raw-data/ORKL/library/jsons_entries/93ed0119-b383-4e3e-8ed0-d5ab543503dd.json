{
    "id": "93ed0119-b383-4e3e-8ed0-d5ab543503dd",
    "created_at": "2023-01-12T15:08:30.746427Z",
    "updated_at": "2025-03-27T02:05:23.697113Z",
    "deleted_at": null,
    "sha1_hash": "b003cf3e8400f3caf52205996c0dee6f9dcc6f81",
    "title": "2022-06-03 - Trustwave's Action Response- Microsoft zero-day CVE-2022-30190 (aka Follina)",
    "authors": "",
    "file_creation_date": "2022-09-01T10:09:08Z",
    "file_modification_date": "2022-09-01T10:09:08Z",
    "file_size": 184317,
    "plain_text": "# Trustwave's Action Response: Microsoft zero-day CVE-2022-30190 (aka Follina)\n\n**[trustwave.com/en-us/resources/blogs/spiderlabs-blog/trustwaves-action-response-microsoft-zero-day-cve-2022-30190-aka-follina](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/trustwaves-action-response-microsoft-zero-day-cve-2022-30190-aka-follina)**\n\nLoading...\n\nBlogs & Stories\n\n## SpiderLabs Blog\n\nAttracting more than a half-million annual readers, this is the security community's go-to destination for\ntechnical breakdowns of the latest threats, critical vulnerability disclosures and cutting-edge research.\n\n_Update June 7 - In the event of a compromise related to the Follina vulnerability, IT teams can potentially_\n_identify network connections in the registry associated with the malicious Office document. Additionally,_\n_spawned child processes might also be identified in the diagnostic PCW.debugreport.xml file on the_\n_host. Please see Hunting for Indicators of Compromise below for more details._\n\n_Trustwave SpiderLabs is tracking the critical-rated zero-day vulnerability CVE-2022-30190. Threat actors are_\n_reported to be actively exploiting this vulnerability in the wild. Microsoft disclosed and issued guidance for CVE-_\n_2022-30190 on May 30._\n\n_Trustwave is diligently watching over our clients for exposure and associated attacks and working closely with_\n_our clients to ensure that mitigations are in place. Trustwave SpiderLabs is continuing to monitor this developing_\n_threat and we will update this blog as necessary._\n\n\n-----\n\nOver Memorial Day weekend a zero day vulnerability was discovered being actively exploited in the wild. The\ninitial sample was a malicious Microsoft Word document that triggered arbitrary code execution when opened.\nMicrosoft has issued this vulnerability CVE-2022-30190, but it is also known as \"Follina\".\n\n**Overview**\n\nThe vulnerability is an issue with the Microsoft Support Diagnostic Tool (MSDT) in Windows. The initial attack\nvector used a Word document that used the remote template feature to retrieve an HTML file from a remote\nwebserver. The HTML file invokes \"ms-msdt\" MSProtocol URI scheme to load some code and execute some\nPowerShell.\n\nThis vulnerability potentially affects any Office document that has access to MSDT. For instance, If the\ndocument is a .RTF file, it becomes a zero-click exploit if Preview in Explorer is enabled. Outlook also supports\nMS Protocol URI schemes, e.g. \"ms-msdt:some_uri/resource\" which would trigger exploitation if clicked.\n\nThe full attack surface and all exploitation methods have not yet been completely explored. While the original\nexploit only seemed to affect MS Word, additional research resulted in attack vectors expanding to include the\nRTF and potential Outlook vectors.\n\nAs of June 2, an additional attack vector was discovered that invokes a “search-ms” URI instead of “ms-msdt” to\nachieve the same effect of arbitrary code. With the “search-ms” variant, the attacker invokes the Windows\nSearch functionality to launch a malicious Word document.\n\n**Remediation for MSDT exploitation**\n\nThe vulnerability affects Office 2013, 2016, 2019, 2021, Office ProPlus and Office 365. As of this writing, there\nis no patch available, but we anticipate Microsoft will release one in short order. In the meantime, Microsoft\nprovides the following workarounds:\n\n**_Disable the MSDT URL Protocol_**\n\nRun Command Prompt as Administrator.\nTo back up the registry key, execute the command “reg export HKEY_CLASSES_ROOT\\ms-msdt\nfilename“\nExecute the command “reg delete HKEY_CLASSES_ROOT\\ms-msdt /f”.\n\n**_How to Undo the Workaround_**\n\nRun Command Prompt as Administrator.\nTo restore the registry key, execute the command “reg import filename” pointing to the backup file you\ncreated before disabling MSDT\n\n**Remediation for “search-ms” exploitation**\n\nLike the remediation for “ms-msdt”, this remediation disables search-ms via the registry. Microsoft provide the\nfollowing workarounds:\n\n**_Disable the “ms-search” URL Protocol_**\n\nRun Command Prompt as Administrator.\nTo back up the registry key, execute the command “reg export HKEY_CLASSES_ROOT\\search-ms\nfilename“\nExecute the command “reg delete HKEY_CLASSES_ROOT\\search-ms /f”.\n\n**_How to Undo the Workaround_**\n\n\n-----\n\nRun Command Prompt as Administrator.\nTo restore the registry key, execute the command “reg import filename” pointing to the backup file you\ncreated in the previous section.\n\nHowever, these workarounds may cause issues depending on the environment and local usage of MSDT and\n“search-ms.” It also does not mitigate some attack vectors like automatic preview in Explorer of malicious RTF\ndocuments. In cases where this mitigation step is not implementable, utilizing existing endpoint protection\nsolutions for blocking and or detection is the best course of action. Multiple vendors have already released\nguidance for their solutions to defend or detect this exploitation.\n\n**Hunting for Indicators of Compromise**\n\nIn the event of a compromise related to the Follina vulnerability, IT teams can potentially identify network\nconnections in the registry associated with the malicious Office document. Additionally, spawned child\nprocesses might also be identified in the diagnostic PCW.debugreport.xml file on the host.\n\nIn some instances, a registry value will be created if an Office document attempting to utilize the Follina\nvulnerability, makes an Internet connection. Though this could identify a C2 server, not every instance of a\nmalicious Office document executing on a machine will result in a network connection as this can be dependent\nupon the payload. There could also be a large number of entries, as the registry keys are historical and not\nremoved after the machine reboots. This will require further investigation into the domains observed in the\nregistry to determine if they are associated with malicious behaviors.\n\nHKEY_USERS\\$USER_SID\\SOFTWARE\\Microsoft\\Office\\$OFFICE_VERSION\\Common\\Internet\\Server\nCache\\\n\nHKCU\\Software\\Microsoft\\Office\\$OFFICE_VERSION\\Common\\Internet\\Server Cache\\Count\\\n\nDuring an investigation or post compromise DFIR engagement, the registry can be checked via EDR\ntechnologies that allow for registry queries or can be checked by remotely connecting to the machine and\nrunning the PowerShell commands below:\n\nGet-ChildItem -Path 'HKCU:\\SOFTWARE\\Microsoft\\Office\\16.0\\Common\\Internet\\Server Cache\\'\n\nGet-ChildItem\n'Registry::HKEY_USERS\\$USER_SID\\SOFTWARE\\Microsoft\\Office\\$OFFICE_VERSION\\Common\\Internet\\Server\nCache\\'\n\nAnother file to check that can identify the potential child / spawned processes is the PCW.debugreport.xml file\nlocated here.\n\nC:\\Users\\[USERNAME]\\AppData\\Local\\Diagnostics\\[randomnumber]\\[randomnumber].\n\n[xxx]\\PCW.debugreport.xml\n\nWithin the XML file, the value '<Data id=\"Parameter\" name=\"TargetPath\">[string]' can contain the path of the\nexecuted process or executable.\n\n**References**\n\nMSRC blog post: https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-supportdiagnostic-tool-vulnerability/\n\n[Original analysis: https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e](https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e)\n\n[Non-malicious Word doc PoC for testing: https://app.box.com/s/9oz1r90tzs7bstl0xy3zzfc8m92cqhcu](https://app.box.com/s/9oz1r90tzs7bstl0xy3zzfc8m92cqhcu)\n\n\n-----\n\nAttack variant using search ms : https://borncity.com/win/2022/06/02/searchnightmare windows 10 search ms\nuri-handler-0-day-exploit-mit-office-2019/\n\nOffice network connections in the registry:\n\n[https://twitter.com/SecurityAura/status/1531337827019014144](https://twitter.com/SecurityAura/status/1531337827019014144)\n\nPCW.debugreport.xml\n\n[https://twitter.com/NOP_0x90v1/status/1532983486591774721](https://twitter.com/NOP_0x90v1/status/1532983486591774721)\n\n[https://twitter.com/wdormann/status/1532080950708170752](https://twitter.com/wdormann/status/1532080950708170752)\n\nYara Rule - [https://docs.velociraptor.app/exchange/artifacts/pages/msdtfollina/](https://docs.velociraptor.app/exchange/artifacts/pages/msdtfollina/)\n\n**Trustwave**\n\nThe Tustwave SpiderLabs IDS team released five IDS signatures as an out of band release to cover known\nattack vectors. The Trustwave Global Threat Operations team has also deployed detection rules in the\nTrustwave Fusion platform. Other Trustwave SpiderLabs teams are still investigating additional protections and\ndetections we can implement.\n\nWe will update this blog post as appropriate.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-03 - Trustwave's Action Response- Microsoft zero-day CVE-2022-30190 (aka Follina).pdf"
    ],
    "report_names": [
        "2022-06-03 - Trustwave's Action Response- Microsoft zero-day CVE-2022-30190 (aka Follina).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536110,
    "ts_updated_at": 1743041123,
    "ts_creation_date": 1662026948,
    "ts_modification_date": 1662026948,
    "files": {
        "pdf": "https://archive.orkl.eu/b003cf3e8400f3caf52205996c0dee6f9dcc6f81.pdf",
        "text": "https://archive.orkl.eu/b003cf3e8400f3caf52205996c0dee6f9dcc6f81.txt",
        "img": "https://archive.orkl.eu/b003cf3e8400f3caf52205996c0dee6f9dcc6f81.jpg"
    }
}