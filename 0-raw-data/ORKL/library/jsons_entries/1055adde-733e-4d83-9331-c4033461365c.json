{
    "id": "1055adde-733e-4d83-9331-c4033461365c",
    "created_at": "2023-01-12T15:06:42.013494Z",
    "updated_at": "2025-03-27T02:06:09.318774Z",
    "deleted_at": null,
    "sha1_hash": "929ccc60be8faba1d63d4b49c9f59005704de3f5",
    "title": "2022-11-25 - Python script to decode NightHawk strings",
    "authors": "",
    "file_creation_date": "2022-12-29T00:16:54Z",
    "file_modification_date": "2022-12-29T00:16:54Z",
    "file_size": 295810,
    "plain_text": "# hedgehog-tools/nighthawk_str_decoder.py at main · struppigel/hedgehog-tools · GitHub\n\n**[github.com/struppigel/hedgehog-tools/blob/main/nighthawk_str_decoder.py](https://github.com/struppigel/hedgehog-tools/blob/main/nighthawk_str_decoder.py)**\n\nstruppigel\n\nimport idautils\n\n# Author: Karsten Hahn @ GDATA CyberDefense\n\n# Twitter: @struppigel\n\n# Mastodon: struppigel@infosec.exchange\n\n# IDAPython Script to decode NightHawk strings\n\n# sha256:\n9a57919cc5c194e28acd62719487c563a8f0ef1205b65adbe535386e34e418b8\n\n# sha256:\n0551ca07f05c2a8278229c1dc651a2b1273a39914857231b075733753cb2b988\n\ndef find_cipher_addr():\n\n# 33 ED xor ebp, ebp\n\n# 48 39 6B 10 cmp [rbx+10h], rbp\n\n\n-----\n\n# 76 4E jbe short loc_1800456B8\n\n# 33 F6 xor esi, esi\n\n# 4C 8D 3D ?? ?? ?? ?? lea r15, alphabetString\n\naddress_found = ida_search.find_binary(0, 0xffffffffffffffff, \"33 ED 48 39 6B 10 76 4E 33\nF6 4C 8D 3D\", 0, 0)\n\ncmd_start = 10\n\ncipher_alphabet_addr = idc.get_operand_value(address_found + cmd_start,1)\n\ncipher_alphabet = idc.get_strlit_contents(cipher_alphabet_addr, -1, 0).decode(\"utf-8\")\n\nprint(\"extracted alphabet:\", cipher_alphabet)\n\nreturn cipher_alphabet\n\ndef find_plain_addr():\n\n# 49 8B CF mov rcx, r15 ; Str\n\n# E8 ?? ?? ?? ?? call strchr\n\n# 48 85 C0 test rax, rax\n\n# 74 1D jz short loc_7FFACE4089C6\n\n# 49 2B C7 sub rax, r15\n\n# 48 8D 0D ?? ?? ?? ?? lea rcx, substitution_alphabet2\n\naddress_found = ida_search.find_binary(0, 0xffffffffffffffff, \"49 8B CF E8 ? ? ? ? 48 85 C0\n74 1D 49 2B C7 48 8D 0D\", 0, 0)\n\ncmd_start = 16\n\nplain_addr = idc.get_operand_value(address_found + cmd_start,1)\n\nplain_alphabet = idc.get_strlit_contents(plain_addr, -1, 0).decode(\"utf-8\")\n\nprint(\"extracted alphabet:\", plain_alphabet)\n\nreturn plain_alphabet\n\ndef decryption_func_addr():\n\n# 48 8B C4 mov rax, rsp\n\n\n-----\n\n# 48 89 58 18 mov [rax+18h], rbx\n\n# 48 89 68 20 mov [rax+20h], rbp\n\n# 48 89 50 10 mov [rax+10h], rdx\n\n# 48 89 48 08 mov [rax+8], rcx\n\n# 56 push rsi\n\n# 57 push rdi\n\n# 41 57 push r15\n\n# 48 83 EC 30 sub rsp, 30h\n\n# 48 8B DA mov rbx, rdx\n\n# 48 8B F9 mov rdi, rcx\n\n# 83 60 D8 00 and dword ptr [rax-28h], 0\n\n# 48 8B CA mov rcx, rdx\n\n# 48 83 7A 18 10 cmp qword ptr [rdx+18h], 10h\n\n# 72 03 jb short loc_7FFACE40896A\n\n# 48 8B 0A mov rcx, [rdx] ; Str\n\nreturn ida_search.find_binary(0, 0xffffffffffffffff, \"48 8B C4 48 89 58 18 48 89 68 20 48 89\n50 10 48 89 48 08 56 57 41 57 48 83 EC 30 48 8B DA 48 8B F9 83 60 D8 00 48 8B CA\n48 83 7A 18 10 72 03 48 8B 0A\", 0, 0)\n\ndef decode_string(encoded, cipher_alphabet, plaintext_alphabet):\n\ndecoded = []\n\nfor character in encoded:\n\nif character in cipher_alphabet:\n\ndecoded.append(plaintext_alphabet[cipher_alphabet.find(character)])\n\nelse:\n\ndecoded.append(character)\n\nreturn \"\".join(decoded)\n\n\n-----\n\nif __name__ == \"__main__\":\n\ncipher_alphabet = find_cipher_addr()\n\nplaintext_alphabet = find_plain_addr()\n\nfor ref in idautils.XrefsTo(decryption_func_addr(),0):\n\ncaller_addr = ref.frm\n\nfor h in Heads(caller_addr - 0x20, caller_addr):\n\nif print_insn_mnem(h) == \"lea\":\n\nif idc.get_operand_type(h,1) == 2:\n\nstring_addr = idc.get_operand_value(h,1)\n\nencoded_str = idc.get_strlit_contents(string_addr, -1, 0)\n\ndecoded_str = decode_string(encoded_str.decode(\"utf-8\"), cipher_alphabet,\nplaintext_alphabet)\n\nprint(decoded_str, 'at', hex(string_addr))\n\nidc.set_cmt(h, decoded_str, True)\n\nidc.set_cmt(caller_addr, decoded_str, True)\n\nidc.set_cmt(string_addr, decoded_str, True)\n\nbreak\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-11-25 - Python script to decode NightHawk strings.pdf"
    ],
    "report_names": [
        "2022-11-25 - Python script to decode NightHawk strings.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536002,
    "ts_updated_at": 1743041169,
    "ts_creation_date": 1672273014,
    "ts_modification_date": 1672273014,
    "files": {
        "pdf": "https://archive.orkl.eu/929ccc60be8faba1d63d4b49c9f59005704de3f5.pdf",
        "text": "https://archive.orkl.eu/929ccc60be8faba1d63d4b49c9f59005704de3f5.txt",
        "img": "https://archive.orkl.eu/929ccc60be8faba1d63d4b49c9f59005704de3f5.jpg"
    }
}