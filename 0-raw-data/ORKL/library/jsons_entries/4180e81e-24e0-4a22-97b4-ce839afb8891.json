{
    "id": "4180e81e-24e0-4a22-97b4-ce839afb8891",
    "created_at": "2023-01-12T15:03:57.876771Z",
    "updated_at": "2025-03-27T02:06:01.423948Z",
    "deleted_at": null,
    "sha1_hash": "f065ad5d57188a605c9854cf3f84155496000cc6",
    "title": "2020-06-01 - In-depth analysis of a trojan banker impacting Portugal and Brazil",
    "authors": "",
    "file_creation_date": "2022-05-28T21:47:21Z",
    "file_modification_date": "2022-05-28T21:47:21Z",
    "file_size": 1886438,
    "plain_text": "# In-depth analysis of a trojan banker impacting Portugal and Brazil\n\n**[seguranca-informatica.pt/in-depth-analysis-of-a-trojan-banker-impacting-portugal-and-brazil/](https://seguranca-informatica.pt/in-depth-analysis-of-a-trojan-banker-impacting-portugal-and-brazil/)**\n\nJune 1, 2020\n\n**In-depth analysis of a trojan banker impacting users in Portugal and Brazil at the end**\n**of May 2020.**\nWe are living in an era where criminals are using several strategies to get benefit from\nseveral kinds of attacks, including malware. During the past few months, the number of\ndigital threats has increased probably due to the Covid-19 pandemic. Malware have made\nheadlines, and we described three different campaigns reaching users in Portugal last days:\n\nOn May 29th, 2020, another Trojan active for several months was observed. This Trojan was\ncreated to impact users of a particular banking organization in Portugal and Brazil. The URL\n[of the initial installer was initially collected from the 0xSI_f33d – a feed that compiles](https://feed.seguranca-informatica.pt/)\nphishing and malware campaigns targeting only Portuguese citizens.\n\n**_Figure 1: Trojan banker installer downloaded from the Internet and distributed via malscam_**\n_waves._\n\n**Filename: Modulo.exe**\n\n**MD5: c427af475f4c8570bba5b77b2c6c6493**\n\n**SHA1: aabc8205b93efd3faa86ec125769f1bb37d257a2**\n\n\n-----\n\nThrough the initial analysis of the Modulo.exe file, some interesting indicators can be\nobserved.\n\n**File info: Borland Delphi 4.0**\n**Created: 29 May 2020, 02:55 AM ( it was disseminated in the same day )**\n**Modified: 29 May 2020, 02:35 AM ( it was disseminated in the same day )**\n**CompanyName: Banco Santander S.A ( target company )**\n**ProductName: Módulo de Segurança (Security Module, in English)**\n\n**_Figure 2: Details about the malware installer file (Modulo.exe)._**\n\nFrom Figure 2 must be highlighted that the malware creation and modification data is the\nsame as the malscam campaign disseminated via email in Portugal also on May 29th.\n\nDuring the malware installation, the following screens are presented on the victim’s\ncomputer; where a security module from a specific bank organization is presented to lure the\nvictims.\n\n\n-----\n\n**_Figure 3: Malware installer creates and drops the next stage into the victim’s computer._**\n\nIn detail, an LNK file is created on the Windows Startup folder during the installation process.\n```\nC:\\Users\\admin\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Módulo de\nSegurança.lnk\n\n```\nNext, the trojan loader/dropper is dropped onto the\n**%AppData%\\Local\\Programs\\ModuloX folder.**\n```\nC:\\Users\\admin\\AppData\\Local\\Programs\\ModuloX\\Xpi.exe\n\n```\nFinally, the trojan loader/dropper is initiated on the infected device.\n\n## Trojan loader/Dropper\n\n**Filename: Xpi.exe**\n\n**MD5: 5aa33141298a5d7143b337cf29bcd66c**\n\n**SHA1: 0ea85298e4fe5bd901c48a4976fddda063bd915a**\n\nThis stage is executed after the previous process that installs the security module on the\nvictim’s computer. This new binary is responsible for creating persistence and to execute the\nfinal payload (trojan itself).\n\n\n-----\n\n**_Figure 4: Trojan loader/dropper installed on the infected device. It executes the next tasks_**\n_every time it is executed._\n\nAfter dissecting the binary, two files were observed inside it, namely:\n\n**exec.vbs: A VBS file responsible for injecting the instaj.dll DLL file into the memory**\n(DLL injection technique)\n**instaj.dll: The trojan itself. It is executed via DLL injection via rundlll32.exe.**\n\n**_Figure 5: DLL and VBS file inside the dropper file (Xpi.exe)._**\n\nIn detail, the instaj.dll file is dropped into the %AppData%\\Local\\Temp every time the\ndropper is executed. This DLL has inside the trojan banker source-code (Figure 5 – left side)\nand is injected in memory via the exec.vbs file also dropped into the same directory (Figure\n5 – right side).\n```\nC:\\Users\\admin\\AppData\\Local\\Temp\\instaj.dll\n\n```\nThe VBS file (exec vbs) is responsible for launching the trojan via DLL injection\n\n\n-----\n\n```\n C:\\Windows\\System32\\rundll32.exe C:\\Users\\admin\\AppData\\Local\\Temp\\instaj.dll CallFo\n\n## Trojan – final payload\n\n```\n**Filename: instaj.dll**\n\n**MD5: 467ffe52110cc17a42ea7a2da1e1f311**\n\n**SHA1: 94165f7f3703b9b9fd3f9ec91fa9e0256d995233**\n\nWhen the file is loaded into the memory, it performs several tasks was expected. One of\nthem is creating a persistence mechanism. For that, the VBS file (exec.vbs) path is added to\na new registry key named “JavaX“.\n```\nKey: HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nName: JavaX\nValue: C:\\Users\\admin\\AppData\\Local\\Temp\\exec.vbs\n\n```\n**_Figure 6: Registry key created on “Windows\\CurrentVersion\\Run” – trojan persistence._**\n\nThe high-diagram this trojan has an interesting path on the right-side as observed below. The\nprogram terminates if it detects is running inside a virtual machine.\n\n\n-----\n\n**_Figure 7: Trojan malware high-level diagram._**\n\nThis piece of malware is composed of some features, namely:\n\n**AntiVM mechanism**\n**Detects SO version**\n**Grab security programs are running (AVs, etc)**\n**Have a feature to “disinfects” the device (after a command probably received**\n**from C2)**\n**Kill the trojan itself from the running processes**\n**Computer restart/reboot**\n**Keylogger**\n\n\n-----\n\n**Checks which browser is running**\n**Create overlay windows to collect banking details and send them to the C2**\n**server**\n\n### AntiVM mechanism\n\nThe malware terminates its execution if virtual environments are detected on running\nprocesses (e.g., Wine, VMWARE, VirtualBox, etc).\n\n**_Figure 8: AntiVM block of code presents in the malware._**\n\nIf the program is attached to a run-time debug, it falls into the function that freezes the\nsystem.\n\nInteresting that, if the user is using a virtual machine to run the malware, the following\nmessage box is presented.\n\n**_Figure 9: Message box presented when the malware is executed inside a virtual machine._**\n\nIf the infection process continues normally, the malware lists the security products available\non the machine and sends them to the C2 server.\n\n\n-----\n\n**_Figure 10: Security products collected during the malware execution._**\n\nThe collected information is sent to the C2 following the format below.\n\n**_Figure 11: Security products details sent to the C2 server following a specific format._**\n\nDepending on the used OS version, the malware executes the next steps. For that, the OS\nversion is enumerated.\n\n\n-----\n\n**_Figure 12: OS version collected during the malware execution._**\n\nComplete list of OS checked during the execution:\n```\n005DC4DC <UString> 'Windows 3.1'\n005DC500 <UString> 'Windows 95'\n005DC524 <UString> 'Windows 95 OSR 2'\n005DC554 <UString> 'Windows 98'\n005DC578 <UString> 'Windows 98 SE'\n005DC5A0 <UString> 'Windows Me'\n005DC5C4 <UString> 'Windows 9x'\n005DC5E8 <UString> 'Windows NT 3.5'\n005DC614 <UString> 'Windows NT 4'\n005DC63C <UString> 'Windows 2000'\n005DC664 <UString> 'Windows XP'\n005DC688 <UString> 'Windows NT'\n005DC6AC <UString> 'Windows Server 2003'\n005DC6E0 <UString> 'Windows Vista'\n005DC708 <UString> 'Windows Server 2008'\n005DC73C <UString> 'Windows Server 2008 or Windows Vista SP1'\n005DC79C <UString> 'Windows 7'\n005DC7BC <UString> 'Windows Server 2008 R2'\n005DC7F8 <UString> 'Windows 7 or Windows Server 2008 R2'\n\n```\nNotice that parameters are passed via EDX/EAX registers in a call. This is because Delphi\nuses the FASTCALL calling convention, where the parameters are passed to the function\nfrom right to left, from EDX to EAX – if there are more parameters, they’ll be passed through\nthe stack.\n\nNext, it uses some Windows APIs to get the title of the currently focused window. Then, it\ntries to find a substring, “Google Chrome”, in that title, later it tries to find “Internet Explorer”,\n“Firefox”, “Chrome” and so on.\n\nWhen the web-browser is detected and it is on focus, the malware starts to find out if the\nvictim is browsing a specific banking website, searching for a specific string: Santander in\nthe title.\n\n\n-----\n\n-----\n\n**_Figure 13: Browser and banking portal detection process._**\n\nWhen it detects the user is interacting with the banking portal, an error message is presented\ninforming about a problem related to communication with the legitimate portal.\n\n**_Figure 14: Error message presented when the victim is accessing the specific banking_**\n_portal._\n\nAt this point, the trojan interacts with the victim. It has been controlled by crooks and\nreceives commands from the C2 server:\n\n\n-----\n\n**Specific windows are created and presented;**\n**User and password details are requested;**\n**Banking codes are also requested, and so on.**\n\n**_Figure 15: Overlay windows created during the malware execution._**\n\nBelow some details used to create other overlay windows:\n```\n.text:005DEBEC 0000000A pascal CommonAPP   \n.text:005DEC01 0000000D pascal UsuarioAtual  \n.text:005DEC19 00000010 pascal IniciaisCelular\n.text:005DEC34 0000000A pascal BankAtual   \n.text:005DEC49 0000000B pascal TipoAcesso   \n.text:005DEC5F 0000000C pascal ReferenciaD  \n.text:005DEC76 00000008 pascal NomeVit    \n.text:005DEC89 0000000C pascal CodigoFirma  \n.text:005DECA0 0000000F pascal NavegadorAtual \n.text:005DECBA 0000000D pascal PosicaoFirma  \n.text:005DECD2 0000000B pascal RecebeBank   \n.text:005DECE8 0000000A pascal RecebeSMS   \n.text:005DECFD 00000006 pascal Cord1     \n.text:005DED0E 00000006 pascal Cord2     \n.text:005DED1F 00000006 pascal Cord3     \n.text:005DED30 00000006 pascal Cord4\n\n```\n\n-----\n\nDuring this process, the collected details are grouped into a string and sent to the C2 server\nvia “TCustomWinSocket_SendText” call. Also, a function called\n“TCustomWinSocket_ReceiveText” is used to get the instructions from the C2.\n\n**_Figure 16: Banking details sent to the C2 server and received commands via a specific call._**\n\nIn detail, it’s possible to observe several call references to the “ReceiveText” function during\nthe malware execution. As previously mentioned, this particular function is responsible for\nreceiving commands from the C2 server. A snippet of code illustrating a call executed by\nmalware where a specific command (Cord2) is received from crooks can be observed.\n\n\n-----\n\n_Figure 17: Specific commands (Cord 2) received from the C2 server._\n\nThe malware have several strings encoded as shown below. The strings can be obtained via\nseveral approaches. In this case, the following strings were decoded in runtime as identified\nin the next image.\n\n\n-----\n\n**_Figure 18: Decoded strings and decoded function high-level diagram._**\n\nFinally, the next Figure presents the first Delphi form; hidden during the malware execution.\nThis form have several timers (right-side). They are responsible for starting several functions\nsuch as anti-VM and anti-debug calls that stop the malware execution.\n\nOn the other hand, a specific timer executes a call to get commands from C2 within an\ninterval initially defined by malware operators.\n\n**_Figure 19: Main Form where timers execute several calls during the malware runtime._**\n\n## Final Thoughts\n\n\n-----\n\nMalware is nowadays one of the major cyber weapons to destroy a business, market\nreputation, and even infect a wide number of users. The next list presents some tips on how\nyou can prevent a malware infection. It is not a complete list, just a few steps to protect\nyourself and your devices.\n\nGet outdated software of your system\nGet email savvy; take several minutes looking at the new email and not a few seconds\nBeware of fake tech support, emails related do bank transactions, invoices, COVID19,\neverything you think be strange\nKeep Internet activity relevant\nLog out at the end of the day\nOnly access secured and trusted sites (not only websites with green lock – please\nthink you are doing, as many phishing campaigns are abusing of free CA to create\nvalid HTTPS certificates and to distribute malicious campaigns over it)\nKeep your operating system up to date\nMake sure you are using an antivírus\nBeware of malvertising\n\n## Take-home message\n Be proactive and start taking malware protection seriously!\n\n References\n\nhttps://www.hybrid[analysis.com/sample/bba8629b3d40ea278c091f6e1a15609194b57e80111c4648986d6e2f8b](https://www.hybrid-analysis.com/sample/bba8629b3d40ea278c091f6e1a15609194b57e80111c4648986d6e2f8b52f69d?environmentId=100)\n52f69d?environmentId=100\n\n[Pedro Tavares](https://seguranca-informatica.pt/author/pipocaz/)\n**[Pedro Tavares is a professional in the field of information security working as an Ethical](https://www.linkedin.com/in/sirpedrotavares/)**\nHacker/Pentester, Malware Researcher and also a Security Evangelist. He is also a founding\nmember at CSIRT.UBI and Editor-in-Chief of the security computer blog segurancainformatica.pt.\n\nIn recent years he has invested in the field of information security, exploring and analyzing a\nwide range of topics, such as pentesting (Kali Linux), malware, exploitation, hacking, IoT and\nsecurity in Active Directory networks. He is also Freelance Writer (Infosec. Resources\n[Institute and Cyber Defense Magazine) and developer of the 0xSI_f33d – a feed that](https://feed.seguranca-informatica.pt/)\ncompiles phishing and malware campaigns targeting Portuguese citizens.\n\n[Read more here.](https://seguranca-informatica.pt/contacto/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-01 - In-depth analysis of a trojan banker impacting Portugal and Brazil.pdf"
    ],
    "report_names": [
        "2020-06-01 - In-depth analysis of a trojan banker impacting Portugal and Brazil.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535837,
    "ts_updated_at": 1743041161,
    "ts_creation_date": 1653774441,
    "ts_modification_date": 1653774441,
    "files": {
        "pdf": "https://archive.orkl.eu/f065ad5d57188a605c9854cf3f84155496000cc6.pdf",
        "text": "https://archive.orkl.eu/f065ad5d57188a605c9854cf3f84155496000cc6.txt",
        "img": "https://archive.orkl.eu/f065ad5d57188a605c9854cf3f84155496000cc6.jpg"
    }
}