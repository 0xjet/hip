{
    "id": "11f685b3-d3a4-4b87-960e-d2874a81979e",
    "created_at": "2023-01-12T15:07:37.792Z",
    "updated_at": "2025-03-27T02:05:57.733353Z",
    "deleted_at": null,
    "sha1_hash": "5a7075867debb15b3c115dac1c8229d2fdb0589e",
    "title": "2019-05-23 - Analysing -Retefe- with Sysmon and Splunk",
    "authors": "",
    "file_creation_date": "2022-05-27T22:09:32Z",
    "file_modification_date": "2022-05-27T22:09:32Z",
    "file_size": 102427,
    "plain_text": "# Analysing “Retefe” with Sysmon and Splunk\n\n**[vulnerability.ch/2019/05/analysing-retefe-with-sysmon-and-splunk/](https://vulnerability.ch/2019/05/analysing-retefe-with-sysmon-and-splunk/)**\n\nCorsin Camichel May 23, 2019\n\nI recently took a closer look at Retefe because they seem to have abandon the short-lived\n“SmokeLoader”-phase and moved back to “socat.exe” and the TOR-network.\n\nThe original delivery method is by mail spam, sending an Office document (either a docx or\nxlsx attachment) with an embedded OLE object (the malicious .exe file). If the victim double\nclicks the embedded object (hidden behind an image), the Retefe infection chain is launched.\nIn general Retefe consists of several PowerShell scripts, which download “7-Zip”, “tor.exe”,\n“socat.exe”, change the proxy settings on the system, install a new Root certificate and use\nscheduled tasks for persistence.\n\nFor details on the malware I recommend you read the following blog posts:\n\n## Detecting Retefe with Sysmon and Splunk\n\nA very easy way to detect Retefe is to look for “tor.exe” and “socat.exe” processes in the\nfolder “ProgramData”:\n\n```\n`sysmon` (\"tor.exe\" OR \"socat.exe\") \"\\\\ProgramData\\\\\" EventCode=1\n\n```\n\nAlternatively you can look for active network connections from files “tor.exe” or “socat.exe” in\n“ProgramData”:\n\n```\n`sysmon` (\"tor.exe\" OR \"socat.exe\") \"\\\\ProgramData\\\\\" EventCode=3\n\n```\n\nWith “EventCode=11” you can also look for the creation of the file (Rule: FileCreate).\n\nAnother way to detect unexpected behaviour could be to look for an “exe” file which creates\n“.ps1” files in the “Temp” folder:\n```\n`sysmon` Image=\"*.exe\" EventCode=11\nTargetFilename=\"*\\\\AppData\\\\Local\\\\Temp\\\\*.ps1\" NOT\n\"__PSScriptPolicyTest*.ps1\"\n\n```\n\n-----\n\nNext is the mshta execution that Retefe uses for persistence. The call runs socat.exe with\nthe configuration included in the call:\n```\n`sysmon` \"socat tcp4-LISTEN:5588,reuseaddr,fork,keepalive,bind=127.0.0.1\nSOCKS4A:127.0.0.1:*.onion:5588,socksport=9050\"\n\n```\nA pretty new way (not a long history of observation) would be to hunt for executions of\nPowerShell with an “-ep” policy, running a “ps1” file, piping to “find” and storing the output in\na log file:\n```\n`sysmon` \"cmd.exe\" \"/c powershell -ep\" (\"bypass\" OR \"Unrestricted\") -f\n\"*\\\\Temp\\\\*.ps1\" \"| find /v \\\"\\\" >> \\\"*\\\\Temp\\\\*.log\"\n\n```\nFor a general detection of Tor or “socat.exe” on a system, this query can be helpful:\n```\n`sysmon` EventCode=3 \"ProgramData\" DestinationPort=9050\nDestinationIp=127.0.0.1\n\n```\nFinally, with this query you can find the shortcuts (“.lnk” files) that Retefe uses for\npersistence:\n```\n`sysmon` EventCode=11 Image=\"*\\\\powershell.exe\"\n\"\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start\nMenu\\\\Programs\\\\Startup\\\\*.lnk\"\n\n## Summary\n\n```\nFrom the few Splunk queries I have shared, you can see that Retefe is not a highly complex\nmalware, it is in fact pretty noisy and offers several ways to identify potentially infected\nclients. Even without Sysmon and Splunk, you can look for signs of an infection in these\nplaces:\n\nProxy settings of the browser (“http://127.0.0.1” string)\ntor.exe and socat.exe in a “ProgramData” sub-folder\nfake Root certificate\nvarious “.lnk” files in the startup folder\n\nAny other detections rule that are useful? Let me know and I will add them here.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-05-23 - Analysing -Retefe- with Sysmon and Splunk.pdf"
    ],
    "report_names": [
        "2019-05-23 - Analysing -Retefe- with Sysmon and Splunk.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536057,
    "ts_updated_at": 1743041157,
    "ts_creation_date": 1653689372,
    "ts_modification_date": 1653689372,
    "files": {
        "pdf": "https://archive.orkl.eu/5a7075867debb15b3c115dac1c8229d2fdb0589e.pdf",
        "text": "https://archive.orkl.eu/5a7075867debb15b3c115dac1c8229d2fdb0589e.txt",
        "img": "https://archive.orkl.eu/5a7075867debb15b3c115dac1c8229d2fdb0589e.jpg"
    }
}