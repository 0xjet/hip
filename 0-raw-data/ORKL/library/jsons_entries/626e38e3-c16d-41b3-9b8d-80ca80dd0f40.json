{
    "id": "626e38e3-c16d-41b3-9b8d-80ca80dd0f40",
    "created_at": "2023-05-06T02:08:53.34226Z",
    "updated_at": "2025-03-27T02:05:50.839315Z",
    "deleted_at": null,
    "sha1_hash": "d36c9c34c709b659dac4d4fb4f0418e445f4b521",
    "title": "2023-04-17 - Butting Heads with a Threat Actor on an Engagement",
    "authors": "",
    "file_creation_date": "2023-05-05T02:00:16Z",
    "file_modification_date": "2023-05-05T02:00:16Z",
    "file_size": 302976,
    "plain_text": "# Butting Heads with a Threat Actor on an Engagement\n\n**[labs.jumpsec.com/butting-heads-with-a-threat-actor-on-an-engagement/](https://labs.jumpsec.com/butting-heads-with-a-threat-actor-on-an-engagement/)**\n\n17 April 2023\n\nby maxcorbridge | Apr 17, 2023 | [Exploitation,](https://labs.jumpsec.com/category/exploitation/) [Incident Response,](https://labs.jumpsec.com/category/incident-response/) [Vulnerability,](https://labs.jumpsec.com/category/vulnerability/) [Windows](https://labs.jumpsec.com/category/windows/)\n\nAt the time of writing I am enjoying some non-billable time in the wake of a demanding\nengagement spanning across several months. As such, I thought it would be a good time to\nwrite up a war story from a recent project in which we came head to head against genuine\nand active threat actors whilst on an engagement.\n\nTo set the scene, I am working on a purple team project in which we are to cover both the\nexternal and internal estate. This tale comes from the external portion of the engagement\nand as such my colleague and I are going about our usual external red team attack\nmethodology. During this external phase we identify several instances of servers running a\nsoftware that will remain unnamed for confidentiality’s sake. I will say that this was a thirdparty software that is used for Identity Access Management, and it appeared to be used in\nseveral environments (pre-prod, production, etc) within the client’s estate.\n\nWe fingerprint the exact version of the technology in-use and find that it is in fact vulnerable\nand outdated. Specifically, it is vulnerable to an unrestricted file upload vulnerability. As is so\noften the case, metasploit had created a module for the automated exploitation of this\nvulnerability – great news! As this is not a covert red team, and therefore getting detected is\nnot an issue, I attempt to exploit the file upload vulnerability using meterpreter and\nmsfvenom. Alas, the exploit fails. Undeterred, I look to manually verify the vulnerability\nmyself as I so often find myself doing when metasploit fails me.\n\nI find a proof-of-concept script on Github and read through the code. It looks good so I\nquickly write (steal) a JSP webshell to accompany the script and point the pair at my client’s\nvulnerable servers. This time, it works. With what feels like ‘too good to be true’ ease I’ve got\nremote code execution on the production Single Sign On (SSO) and Identity Access\nManagement (IAM) server! As always in these cases I let the client know immediately before\ndigging a little bit deeper.\n\nWhen landing on an unknown machine I want to immediately perform some situational\nawareness. From an external perspective this may look slightly different to internal. Some of\nthe main questions include: What OS/distribution am I using? What user and permissions do\nI have? Am I domain-joined? Do I have visibility into the internal network?\n\nI quickly determine these answers and find that I am running as a low-privileged user, on a\nunix machine, that is not domain-joined. Not as juicy as I originally thought, but this is still the\nproduction SSO and IAM box so I am hopeful. At this point I get my first inclination that\n\n\n-----\n\nmaybe such a trivial exploit chain may have already been abused. I run an ls to look for the\nexistence of other webshells beyond just my own.\n\nOutput of ‘ls’ command\n\nAs you can see it appears that I am in the site root of the server. However, what I do not see\nis the name of my own webshell (cmd.jsp) meaning that my file must not have been\nuploaded to the site root, more likely it is in the webroot.\n\nTo find the location of the webroot I simply use my webshell to search for the location of my\nwebshell file name to find where all files uploaded via this exploit would land on the file\nsystem. Sure enough, I found the appearance of my webshell in a folder that we will falsely\ncall /home/UserName/AppName/Authenticated. The natural next step is to list the contents of\nthis directory as seen in the screenshot below.\n\n\n-----\n\nContents of Webroot\n\nWhilst this was useful, it was listing the files in alphabetical order which made it difficult to\nprocess which file could be a malicious JSP file versus one naturally used for webserver\ninstallation. I do another ls command but this time listing the contents of the directory in\ndescending order of date modified. That helps clear things up!\n\n\n-----\n\nContents sorted by Date Modified\n\nI immediately notice the large number of files that have the exact same last modified date\nand time on Feb 9th. My assumption is that Feb 9th was when the webserver was installed,\nas all the installation files share this modification date. This leaves 8 files that have been\nuploaded in the 21 days since installation. The top entry (cmd.jsp) is my webshell and can be\nexcluded. Judging by the time stamps and similar file names this still leaves several\nunaccounted for JSP files. Naturally, I did a cat on those files and sure enough…they were\nalso webshells.\n\n\n-----\n\nThreat Actor Webshells\n\nAt this point I know we have stumbled upon something bad. I phone the client and let them\nknow the news whilst I continue trying to attribute some of the webshells. Due to the fact that\nsome of the files had very similar names and were uploaded consecutively I can safely\nassume that they belong to the same threat actor. When grouping as such, I arrive at the\nconclusion that there have been 4 threat actors who have exploited this in the last 5 days!\n\nThis is, of course, not counting any threat actors who had deleted their webshells when not\nin use like I had done. In the same vein, it is important to bear in mind that this was only one\nof several appearances of this vulnerable server in the estate.\n\n\n-----\n\nI reach out to the client to ask permission to repeat the same process on the other vulnerable\ninstances, but by this point the client has engaged their Managed Detection and Response\n(MDR) provider who has already begun the digital forensics work of identifying the extent of\nthe damage, whilst the client’s security team begin working on a patch. I write up a\nprofessional document containing all my findings, remediation steps, etc., and hand it over to\nboth parties.\n\nLater that evening I receive an email saying that the vulnerability has been patched and,\nthankfully, it appears it was caught before it became too much of an issue. However, the\nMDR provider did see attempts to jump from the external box to the internal network, and\nconfirmed that the box had been enrolled in a crypto mining bot network to use its resources\nfor crypto mining. All things considered this was a pretty good outcome after the initial shock\nof compromising such a sensitive system.\n\nAnd with that quick turnaround my brief headbutt with a genuine and active threat actor(s)\ncame to an end. It is not every day that you get findings like this but it lit the fire in me to get\nmore exposure to the Incident Response side of things, and the client was happy we’d found\nand fixed a critical vulnerability in just a handful of hours. Wins all round!\n\n## Disclaimer\n\n_The information provided on this website is to be used for educational purposes only. The_\n_author is in no way responsible for any misuse of the information provided. Any actions and_\n_or activities related to the material contained within this website is solely your responsibility._\n\n### GitHub Activity\n\n Follow JUMPSECLabs\n\n Disclaimer\n\nThe information provided on this website is to be used for educational purposes only. The\nauthor is in no way responsible for any misuse of the information provided. Any actions and\nor activities related to the material contained within this website is solely your responsibility.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-17 - Butting Heads with a Threat Actor on an Engagement.pdf"
    ],
    "report_names": [
        "2023-04-17 - Butting Heads with a Threat Actor on an Engagement.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338933,
    "ts_updated_at": 1743041150,
    "ts_creation_date": 1683252016,
    "ts_modification_date": 1683252016,
    "files": {
        "pdf": "https://archive.orkl.eu/d36c9c34c709b659dac4d4fb4f0418e445f4b521.pdf",
        "text": "https://archive.orkl.eu/d36c9c34c709b659dac4d4fb4f0418e445f4b521.txt",
        "img": "https://archive.orkl.eu/d36c9c34c709b659dac4d4fb4f0418e445f4b521.jpg"
    }
}