{
    "id": "c120e94d-b59c-4a1f-b340-66595f82cb32",
    "created_at": "2023-01-12T15:04:27.326932Z",
    "updated_at": "2025-03-27T02:05:46.274683Z",
    "deleted_at": null,
    "sha1_hash": "95cb123533eecd28c21c3273576cc5a3abe35537",
    "title": "2018-06-28 - A Brief Overview of the AMMYY RAT Downloader",
    "authors": "",
    "file_creation_date": "2022-05-28T03:53:18Z",
    "file_modification_date": "2022-05-28T03:53:18Z",
    "file_size": 795314,
    "plain_text": "# A Brief Overview of the AMMYY RAT Downloader\n\n**[secrary.com/ReversingMalware/AMMY_RAT_Downloader/](https://secrary.com/ReversingMalware/AMMY_RAT_Downloader/)**\n\n[cd ../reverse_engineering_malware 4 minutes read](https://secrary.com/ReversingMalware)\n[SHA-256: 963f1735e9ee06c66fdf3a831d7c262bc8bce0d7155e37f9a5aa2677e0a6090c](https://www.virustotal.com/#/file/963f1735e9ee06c66fdf3a831d7c262bc8bce0d7155e37f9a5aa2677e0a6090c/detection)\n\n[You can download the malware sample from malware-traffic-analysis.net](https://malware-traffic-analysis.net/2018/05/25/index.html)\n\n## Stage 1\n\nThe main function is full of junk instructions, the most interesting function inside the `main is`\n```\ndecode_n_call function near the end:\n\n```\n\n-----\n\nInside the `decode_n_call function, it allocated memory, decodes a data from` `0x0433220`\naddress and jumps to it via `call instruction:`\n\n\n-----\n\n-----\n\nIt allocates two memory blocks, each `0x3000 length, with` `PAGE_EXECUTE_READWRITE`\npermission:\n\nAfter that, it writes some decoded data inside the first allocated memory:\n\n\n-----\n\nAlso, there is another loop which decodes/decrypts once again the written data in the\nmemory:\n\n\n-----\n\nSeems like it’s `PE file, but still encoded, not valid yet.`\n\nFunction `0x30A70 gets two arguments, the encoded/encrypted data and the second`\nallocated memory, the function returns a decoded/decrypted `PE file via the second`\nargument:\n\n\n-----\n\nIt removes the `main executable from the memory and copies recently decoded/decrypted`\ncode:\n\n\n-----\n\nSection maps:\n\n\n-----\n\nInside `0x30730 (offset` `0x730 ) function it build IAT for the new` `PE file:`\n\n\n-----\n\nAfter that, it jumps to the entry point of the new `PE file:`\n\n\n-----\n\nInstead of continuing analysis, it s much easier to dump the new `PE and analyze it`\nseparately.\n\n## Stage 2\n\nThe second `PE is full of junk instructions, too. The interesting part starts at` `0x0401EED`\nlocation.\n\nInside the `sub_403B10 function, it tries to delete` `Settings,` `Microsoft\\\\Enc,` `AMMYY,`\n```\nFoundation and Foundation1 directories, also following files: wmihost.exe,\nsettings3.bin, wmites.exe, wsus from different directories:\n\n```\n\n-----\n\nIt uses `sub_404450 to get a function addresses based on some kind of hash, which is`\npassed via the second argument:\n\nThe `0x403DE0 function gets process name as the argument and terminates the`\ncorresponding process:\n\n\n-----\n\nIt executes following commands using `ShellExecuteW function:` `cmd /C net.exe stop`\n```\nammyy, cmd /C sc delete ammyy, cmd /C net.exe stop foundation and cmd /C\nsc delete foundation\n\n```\n\n-----\n\nThese commands stop the malware if there is one.\n\nIt generates random name (via `CoCreateGuid ) for a` `PE file, which it downloads from`\n\n\n-----\n\nInside `downloadNextStage_bin function, it downloads a file from the URL and saves at`\nabove-mentionshed location:\n\nIt copies the new file to `CSIDL_COMMON_APPDATA\\Microsoft Help\\\\wsus.exe and deletes`\noriginal one:\n\n\n-----\n\nInside `sub_402960 function if the user is an` `admin, it executes above-mentioned`\ncommands once again, registers the downloaded `PE file as a service called` `foundation`\nand starts it:\n\n\n-----\n\nIn the end, it deletes the original, second stage `PE file:`\n\n\n-----\n\nIf the user is not an `admin, it uses a COM object ( taskscd.dll ) to create and run the`\nexecutable (via `scheduled task ):`\n\n\n-----\n\nFor the more detailed information look at `sub_402360 function.`\n\nAfter that, same happens, it deletes the original, second stage `PE file and exist via`\n```\nTerminateProcess call:\n\n```\nThat’s all.\n\nThat was the brief overview of the `AMMYY RAT Downloader .`\n\nThank you for your time.\n\n\n-----\n\nDiscuss on [Reddit](https://www.reddit.com/r/ReverseEngineering/comments/8ryy2u/a_brief_overview_of_the_ammyy_rat_downloader/)\n\nTwitter: [@_qaz_qaz](https://twitter.com/_qaz_qaz)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-06-28 - A Brief Overview of the AMMYY RAT Downloader.pdf"
    ],
    "report_names": [
        "2018-06-28 - A Brief Overview of the AMMYY RAT Downloader.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535867,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653709998,
    "ts_modification_date": 1653709998,
    "files": {
        "pdf": "https://archive.orkl.eu/95cb123533eecd28c21c3273576cc5a3abe35537.pdf",
        "text": "https://archive.orkl.eu/95cb123533eecd28c21c3273576cc5a3abe35537.txt",
        "img": "https://archive.orkl.eu/95cb123533eecd28c21c3273576cc5a3abe35537.jpg"
    }
}