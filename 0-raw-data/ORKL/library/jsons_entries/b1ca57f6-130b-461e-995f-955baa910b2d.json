{
    "id": "b1ca57f6-130b-461e-995f-955baa910b2d",
    "created_at": "2023-01-12T15:04:22.573467Z",
    "updated_at": "2025-03-27T02:05:19.037566Z",
    "deleted_at": null,
    "sha1_hash": "160f19830ef018fa6ee6e3a2508752db91754d0b",
    "title": "2022-01-19 - WhisperGate",
    "authors": "",
    "file_creation_date": "2022-05-28T18:58:42Z",
    "file_modification_date": "2022-05-28T18:58:42Z",
    "file_size": 2853942,
    "plain_text": "# WhisperGate :: rxOred's blog\n\n**rxored.github.io/post/analysis/whispergate/whispergate/**\n\n## WhisperGate\n\n2022-01-19\n\n## Table of content⌗\n\n Introduction⌗\n\nDozens of Ukranian government sites, including Ministry of foreign affairs, Cabinet of\nministers and security council have been hit by a massive cyber attack.\n\nMicrosoft incident response team recently released samples of destructive malware used in\nthe campaign.\n\n## Samples⌗\n\n[virustotal](https://www.virustotal.com/gui/file/a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92) [filescan.io](https://www.filescan.io/uploads/61e5524c0f8c757253c42839)\n\n## Environment⌗\n```\n  Windows 10 guest (Virtualbox)\n  Windows 10 host\n\n```\n\n-----\n\n## Tools⌗\n```\n  Die\n  IDA\n  x32dbg\n  bochs\n\n Analysis⌗\n\n Behavioral analysis⌗\n\n```\nmalware needs administrative privileges to be successful.\n\nMalware does not create any network traffic, registry modifications or file modifications\n\nUpon restarting, device will boot into a screen displaying the following ransom note.\n\n## Static analysis⌗\n\n### The pe⌗\n\n\n-----\n\nAccording to detect it easy, the file is a 32 bit PE file.\n\nit is compiled and linked using MinGW (GCC 6.3.0) and GNU linker.\n\ndie shows entropy as 6.07208, which is high but it also says executable is not packed.\n\nAs usual, entropy in the .text section is higher than in the other sections.\n\n\n-----\n\nstrings in the binary are not encrypted. several strings shown in the above diagram gives\nhints about malware’s capabilities such as disk corruption.\n\nAlso, note that it shows a bitcoin wallet and a tox ID that can be used as signatures.\n```\n- 1AVNM68gj6PGPFcJuftKATa4WLnzg8fpfv\n- 8BEDC411012A33BA34F49130D0F186993C6A32DAD8976F6A5D82C1ED23054C057ECED5496F65\n\n```\nExecutable does not have many imports. There are no APIs related to cryptography\neventhough malware claims to encrypt the files.\n\n### Reversing the pe⌗\n\nIDA shows that PE contains two TLS callbacks. Initially suspected these were for antidebugging purposes but turns out to be no.\n\n\n-----\n\nfirst TLS callback starts calling some function pointers if `Reason is` `DLL_THREAD_ATTACH .`\n\nthe second TLS callback simply returns if `Reason is something other than`\n```\nDLL_THREAD_DETACH or DLL_PROCESS_DETACH, suggesting this may be de initializing\n\n```\nwhatever initialized by the `tlscallback1 .`\n\n\n-----\n\nstart function calls `sub_4011b0 after setting the app type.`\n```\nsub_4011b0 calls function sub_403b60 that is responsible for main functionality of the\n\n```\nmalware.\n\n\n-----\n\nthe function copies 2048 bytes at offset `boot_sector_code into the stack.`\n\noffset contains bytes of compiled x86 real mode boot sector code, along with the boot\nsignature `0x55AA .`\n\n\n-----\n\nThen it calls `CreateFileW passing` `\\\\\\\\.\\\\PhysicalDrive0 as filename argument.`\nreturned handle is then passed to `WriteFile along with the stack buffer that contains boot`\nsector code. If the call is successful, it will overwrite MBR (master boot record) with a custom\nboot sector.\n\nAfter BIOS has done selecting the boot device it will load overwritten MBR into memory and\nthe CPU will start executing a parasite bootloader.\n\nAlso, note that malware does not encrypt anything.\n\n## Extracting boot sector code⌗\n\nbuffer containing boot sector code can be extracted by placing a breakpoint at the address\nwhere it is accessed and using the show in dump feature in x32dbg.\n\nextracted buffer can be then saved as a raw binary file for further analysis.\n\n## Reversing boot sector code⌗\n\n\n-----\n\ncs segment register is initially initialized to 0x0, it is used to zero out `ax and set up other`\nsegment registers. then loads the ransom note into `si register.`\n\nNext instruction calls `print_loop, which then calls` `print_char after loading` `al with`\nthe byte at `si . And it will repeat this operation until` `[si] is null.`\n```\nprint_char uses BIOS interrupts to put a single character into the screen. A BIOS\n\n```\ninterrupt call is a feature of BIOS that allows bootloaders and early kernels to access BIOS\nservices such as video memory access and low-level disk access. To use BIOS interrupts,\n```\nah register should be initialized to the function number. parameters passed down through\n\n```\nregisters and similar to x86 syscalls, `int instruction is used to do the software interrupt`\nalong with the BIOS service number\n\nFor instance, in the above image, malware loads Display character function number `0x0e`\ninto `ah and calls BIOS video service.`\n\nMore about BIOS interrupts - [Ralf Brown’s BIOS interrupt list.](http://www.cs.cmu.edu/~ralf/files.html)\n\nAfter printing the ransom note, the overwritten code jumps into another label\n\n\n-----\n\nwhich then jumps to label `corrupt_c`\n\nTwo insutrctions after segment register initialization sets word at `0x7c78 to 0x0000 and`\ndword at `0x7c76 to` `0x7c82 (‘AAAA’).`\n\nThis initializes the DAP (Disk Address Packet) structure. DAP is a structure that should be\ninitialized in memory in order to use Logical block addressing with interrupt 0x13. This\nstructure is then should be passed through `si register.`\n\nthe layout of the structure\n```\n  Offset Size  Description\n  0  1  size of the packet (16 bytes)\n  1  1  always 0\n  2  2  number of sectors to transfer (max 127 on some BIOSes)\n  4  4  transfer buffer (16 bit segment:16 bit offset) (see note #1)\n  8  4  lower 32-bits of 48-bit starting LBA\n  12 4  upper 16-bits of 48-bit starting LBA\n\n```\n[source osdev](https://wiki.osdev.org/Disk_access_using_the_BIOS_(INT_13h)#LBA_in_Extended_Mode)\n\nbefore the interrupt call `int 0x13, which is used for low-level disk access,` `ah register is`\ninitialized to 0x43, BIOS function number for writing sectors to the disk.\n\nfollowing registers are also initialized\n```\n  al   - 0x0 (close clock write)\n  dl   - 0x80 (hard disk)\n  si   - 0x7c72 (DAP)\n\n```\nThe `si register is loaded with address` `0x7c72, which must be the address of disk`\naddress packet.\n\n\n-----\n\nA successful BIOS interrupt call will overwrite the first Logical Block Address of the disk with\n```\nAAAA, corrupting the C drive.\n\n```\nThe next few instructions check whether an extended write operation is successful or not. if\n```\ncf is set (error) control flow gets redirected to loc_7c45 (failed), else, to\nloc_7c5d (success).\n\n```\nif fails, the malware tries to overwrite the next disk drive by incrementing the value that adds\nup with 0x80.\n\nAdds 0xc7 (199) to `[0x7c7a], incrementing next LBA to be overwritten by 199.`\n\nThe loop is going to continue until the hard disk is completely overwritten by `AAAA s for each`\n200 Logical Block Address, entirely corrupting the disk.\n\n## The end⌗\n\nIt is clear that financial gain is not the motivation behind this malware. Malware is created to\ndo the maximum possible damage to the infeected computer.\n\n#Spread Anarchy!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-19 - WhisperGate.pdf"
    ],
    "report_names": [
        "2022-01-19 - WhisperGate.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535862,
    "ts_updated_at": 1743041119,
    "ts_creation_date": 1653764322,
    "ts_modification_date": 1653764322,
    "files": {
        "pdf": "https://archive.orkl.eu/160f19830ef018fa6ee6e3a2508752db91754d0b.pdf",
        "text": "https://archive.orkl.eu/160f19830ef018fa6ee6e3a2508752db91754d0b.txt",
        "img": "https://archive.orkl.eu/160f19830ef018fa6ee6e3a2508752db91754d0b.jpg"
    }
}