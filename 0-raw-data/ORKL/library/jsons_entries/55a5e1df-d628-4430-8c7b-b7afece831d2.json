{
    "id": "55a5e1df-d628-4430-8c7b-b7afece831d2",
    "created_at": "2023-01-12T15:08:53.092306Z",
    "updated_at": "2025-03-27T02:05:31.198402Z",
    "deleted_at": null,
    "sha1_hash": "e72e0ffd0743aa6b119618ef3ab3442f760e4896",
    "title": "2022-02-02 - Malware Analysis Spotlight- Emotet’s Use of Cryptography",
    "authors": "",
    "file_creation_date": "2022-05-28T23:21:33Z",
    "file_modification_date": "2022-05-28T23:21:33Z",
    "file_size": 1885111,
    "plain_text": "# Malware Analysis Spotlight: Emotet’s Use of Cryptography\n\n**[vmray.com/cyber-security-blog/malware-analysis-spotlight-emotets-use-of-cryptography/](https://www.vmray.com/cyber-security-blog/malware-analysis-spotlight-emotets-use-of-cryptography/)**\n\n## Emotet’s Use of Cryptography\n\n### Presented by the VMRay Labs Team\n\nThe group behind Emotet is the prime example of a very successful criminal enterprise. Emotet started out as\na banking malware but over time evolved into a large botnet providing something akin to a malicious IaaS\n(Infrastructure-as-a-Service). It started providing access to its extensive list of infected devices to other threat\n[actors and their malware (Trickbot,](https://unit42.paloaltonetworks.com/unit42-malware-team-malspam-pushing-emotet-trickbot/) [Dridex,](https://nakedsecurity.sophos.com/2017/08/10/watch-out-for-emotet-the-trojan-thats-nearly-a-worm/) [IcedID). It started acting as their loader. Since the beginning of 2021,](https://securityintelligence.com/new-banking-trojan-icedid-discovered-by-ibm-x-force-research/)\nafter a longer “break” which was the consequence of a coordinated take down of Emotet’s infrastructure by the\n[law enforcement, Emotet resurfaced on the 14th of November 2021. Actively trying to rebuild its own](https://cyber.wtf/2021/11/15/guess-whos-back/)\n[infrastructure utilizing Trickbot. Many of the techniques stayed the same, but there are also some important](https://blog.malwarebytes.com/threat-intelligence/2021/11/trickbot-helps-emotet-come-back-from-the-dead/)\ndifferences.\n\nThe Emotet binaries, which were distributed starting from November 2021, come with two embedded ellipticcurve-based public keys of the server. The previous versions were using RSA as the primary asymmetric\nscheme. An RSA public key was embedded in the sample and used to encrypt the generated AES-128 key\nbefore sending it back to its C2. For message integrity, the packet was hashed with the SHA1 algorithm and the\nhash was [appended to the request message. The new version comes with two public keys. One key is used for](https://www.virusbulletin.com/virusbulletin/2019/10/vb2019-paper-exploring-emotet-elaborate-everyday-enigma/)\nthe Elliptic Curve Diffie–Hellman (ECDH) key exchange protocol while the other is used as part of the\nsignature verification by the Digital Signature Algorithm (DSA). In this blog post, we’ll be looking at how\nEmotet uses elliptic curve cryptography to protect the network communication and verify the authenticity and\nintegrity of the commands received from its C2.\n\n\n-----\n\n**_[View the Analysis](https://www.vmray.com/analyses/ecc-emotet/report/overview.html)_**\n\n### Background\n\n**Comparison: Past vs Present**\n\nSince the cryptographic part has changed in the newest version of Emotet we are providing a high level\noverview of the key steps taken by the older and new versions.\n\nThe previous version of Emotet that were using RSA roughly followed the following steps when encrypting a\nmessage:\n\n1. It generates a 128-bit AES key.\n2. Encrypts it with the server’s public key.\n3. Constructs the message sent to the server.\n4. Encrypts the message and hashes the message.C = SHA1(M) || AES128(M), where C is the resulting\n\nciphertext and M is the plaintext message\n5. This results in the following request packet.R = RSA(AESkey) || C\n\nFor the newest version the flow and the packets it generates are different as seen below:\n\n1. It first generates its own ECDH public/private key pair.\n2. Then it generate an AES key based on a secret agreement.\n3. Constructs the message and hashes it.\n4. Encrypts the resulting payload: C = AES256(SHA256(M) || M)\n5. Request packet is then given by: R = ECDHmal_pub_key || C || <random bytes>\n\n### Elliptic Curve Diffie-Hellman (ECDH) Key Exchange\n\nFor the ECDH to work, the two communicating parties need to each have a key pair, a private and a public key.\nThe public keys are points on an elliptic curve and are generated based on the private keys. The public keys are\nexchanged, i.e., known by both parties. For example, if s is a private key and P is a primitive element on the\ncurve, then the public key S is calculated as sP=S, which is simply adding P to itself a times. The addition is a\ngroup operation. If both parties generate their public keys that way based on known domain parameters, they\n[can calculate the same secret T(SM) (1).](https://link.springer.com/book/10.1007/978-3-642-04101-3)\n\n\n-----\n\n_(Figure 1: An example of a DH key exchange algorithm)_\n\nThe malware already has the ECDH public key of the server. Its own key pair is generated during the execution.\nAnalogues to the example above, it can now generate a secret from the public key of the server and its own\nprivate key. Now it only needs to sends its public key to the server for the server to also be able to derive the\nsame secret.\n\n### Implementation\n\n**Usage of ECDH**\nThe Emotet’s cryptographic components are now utilizing Microsoft’s Cryptography API: Next\n[Generation (CNG), most notably the BCrypt](https://docs.microsoft.com/en-us/windows/win32/seccng/about-cng) [cryptographic primitive functions. Initially, the malware decrypts the](https://docs.microsoft.com/en-us/windows/win32/seccng/cryptographic-primitives)\ntwo embedded public keys of the server (ECDH and ECDSA). It uses the same decryption method as with other\n[strings. The keys are saved inside a BLOB structure which consists of a BCRYPT_ECCKEY_BLOB header](https://docs.microsoft.com/de-de/windows/win32/api/bcrypt/ns-bcrypt-bcrypt_ecckey_blob)\nimmediately followed by the key data (Figure 2).\n\n_(Figure 2: Structure that windows uses for the ECC public keys)_\n\nThe ECDH public key of the server is passed to a function responsible for generating the symmetric key (256-bit\nAES key). On a higher-level it can be described by the following steps:\n\n\n-----\n\n1. Generate a new ECDH key pair for the malware.\n2. Generate a secret agreement based on the malware’s private key and the server’s public key.\n3. Derive an AES key from the secret agreement using SHA256 as the key derivation function (KDF).\n\nIn more detail, this function’s first step is to generate an ECDH key pair that is unique to the malware sample. It\ndoes so by calling BCryptOpenAlgorithmProvider to initialize a CNG provider with the AlgId ECDH_P256 which\ncorresponds to the prime256v1 or P-256 elliptic curve. Next, it generates a new key pair using the combination\nof BCryptGenerateKeyPair and BCryptFinalizeKeyPair. The keys are then exported into a BLOB using\nBCryptExportKey for later use (Figure 3).\n\n_(Figure 3: VMRay function log – series of function calls responsible for creating a new EC key pair)_\n\nHaving finalized its key pair, it now imports the servers public key to be able to use it in the generation of a\nshared secret. It’s using BCryptImportKeyPair that gets the public key as one of the arguments and returns a\nhandle to it. This handle can then be passed to BCryptSecretAgreement together with a handle to it’s own key\nwhich it got in the previous step from calling BCryptExportKey (Figure 4). At this stage the secret agreement is\nequal to the T(SM) value from Figure 1 and Emotet can start deriving a symmetric key.\n\n_(Figure 4: VMRay function log – series of function calls responsible for creating the secret agreement)_\n\nThe secret generated from the public key of the server and the private key of the malware sample is then used\nto generate an AES key. A new CNG provider is initialized with the AlgId = AES. The key is then derived using\nBCryptDeriveKey. This function takes the secret agreement as input and generates a key based on a key\n[derivation function (KDF) and its parameters which are passed in the BCryptBufferDesc structure. For that](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/aa375370(v=vs.85))\nEmotet uses HASH as the KDF and passes the SHA256 as the actual algorithm. This key is then imported\nusing BCryptImportKey (for symmetric keys) so that it can also be later used when encrypting data. The\nKeyDataBlob passed as argument to BCryptImportKey describes the key. Based on the\n\n\n-----\n\n[BCRYPT_KEY_DATA_BLOB_HEADER the key data size is 32 bytes, i.e., 256 bits (Figure 5). To generate the](https://docs.microsoft.com/en-us/windows/win32/api/bcrypt/ns-bcrypt-bcrypt_key_data_blob_header)\nsame symmetric key, the server needs the public key of the malware which it prepends to the request sent to\nthe server.\n\n_(Figure 5: VMRay function log – sequence of BCrypt calls responsible for key derivation (left) and pseudo-code_\n_of the data structure describing the key (right).)_\n\n### Usage of the Elliptic Curve Digital Signature Algorithm (ECDSA)\n\nThe server’s ECDSA public key is used to verify the response messages the malware receives. The server’s\nDSA public key is imported just like ECDH public key was. When an encrypted response from the server\narrives, it is first decrypted with BCryptDecrypt (no padding is used). It then calculates the SHA256 hash of the\ndecrypted data and uses BCryptVerifySignature to verify the integrity and authenticity, i.e., that it matches with\nthe embedded signed hash – signature (Figure 6).\n\n\n-----\n\n_(Figure 6: VMRay function log – BCrypt functions used when verifying the response)_\n\n### Conclusion\n\nWe have looked at one of the updated components of Emotet which involves the usage of cryptography. The\nmost obvious element is that the malware developers switched from the RSA algorithm to using elliptic curves.\nEmotet has been encrypting its communication for a long time, but the recent change might be due to a lot of\nfactors like, e.g., smaller key sizes and better security. The C2’s response is now checked for its integrity and\nauthenticity by using ECDSA with a separate key. While using ECDH the symmetric key is never transmitted\nover the wire and instead the server generates the key from the public key of the malware. We have also\nobserved the switch from CryptoAPI to CNG, which might be due to the fact that the CryptoAPI has been\nofficially deprecated or that it simply didn’t support elliptic curve cryptography.\n\n### IOCs\n\n**Initial Sample 7443d5335a207cca176825bd774a412e72882c815206c7f59ace1feb111bb4e9**\n\n**Server’s ECC keys**\n\nECDH:\n86M1tQ4uK/Q1Vs0KTCk+fPEQ3cuwTyCz+gIgzky2DB5Elr60DubJW5q9Tr2dj8/gEFs0TIIEJgLTuqzx+58sdg==\n\nECDSA:\nQF90tsTY3Aw9HwZ6N9y5+be9XoovpqHyD6F5DRTl9THosAoePIs/e5AdJiYxhmV8Gq3Zw1ysSPBghxjZdDxY+Q==\n\n### Emotet C&Cs\n\n\n-----\n\nhXXps://131[.]100.24.231:80\nhXXps://209[.]59.138.75:7080\nhXXps://103[.]8.26.102:8080\nhXXps://178[.]79.147.66:8080\nhXXps://51[.]38.71.0:443\nhXXps://79[.]172.212.216:8080\nhXXps://162[.]214.50.39:7080\nhXXps://203[.]114.109.124:443\nhXXps://45[.]142.114.231:8080\nhXXps://212[.]237.5.209:443\nhXXps://104[.]251.214.46:8080\nhXXps://212[.]237.56.116:7080\nhXXps://107[.]182.225.142:8080\nhXXps://104[.]168.155.129:8080\nhXXps://138[.]185.72.26:8080\nhXXps://45[.]118.135.203:7080\nhXXps://216[.]158.226.206:443\nhXXps://103[.]75.201.2:443\nhXXps://158[.]69.222.101:443\nhXXps://178[.]63.25.185:443\nhXXps://45[.]118.115.99:8080\nhXXps://46[.]55.222.11:443\nhXXps://192[.]254.71.210:443\nhXXps://217[.]182.143.207:443\nhXXps://110[.]232.117.186:8080\nhXXps://81[.]0.236.90:443\nhXXps://176[.]104.106.96:8080\nhXXps://103[.]8.26.103:8080\nhXXps://50[.]116.54.215:443\nhXXps://195[.]154.133.20:443\nhXXps://51[.]68.175.8:8080\nhXXps://58[.]227.42.236:80\nhXXps://173[.]212.193.249:8080\nhXXps://212[.]237.17.99:8080\nhXXps://41[.]76.108.46:8080\nhXXps://45[.]176.232.124:443\nhXXps://207[.]38.84.195:8080\n\n### References\n\n[https://www.cert.ssi.gouv.fr/uploads/CERTFR-2021-CTI-003.pdf](https://www.cert.ssi.gouv.fr/uploads/CERTFR-2021-CTI-003.pdf)\n\nhttps://www.europol.europa.eu/media-press/newsroom/news/world%e2%80%99s-most-dangerous-malwareemotet-disrupted-through-global-action\n\n[https://cyber.wtf/2021/11/15/guess-whos-back/](https://cyber.wtf/2021/11/15/guess-whos-back/)\n\n[https://blog.malwarebytes.com/threat-intelligence/2021/11/trickbot-helps-emotet-come-back-from-the-dead/](https://blog.malwarebytes.com/threat-intelligence/2021/11/trickbot-helps-emotet-come-back-from-the-dead/)\n\n[https://link.springer.com/book/10.1007/978-3-642-04101-3](https://link.springer.com/book/10.1007/978-3-642-04101-3)\n\n[https://securityintelligence.com/new-banking-trojan-icedid-discovered-by-ibm-x-force-research/](https://securityintelligence.com/new-banking-trojan-icedid-discovered-by-ibm-x-force-research/)\n\n\n-----\n\n[https://nakedsecurity.sophos.com/2017/08/10/watch out for emotet the trojan thats nearly a worm/](https://nakedsecurity.sophos.com/2017/08/10/watch-out-for-emotet-the-trojan-thats-nearly-a-worm/)\n\n[https://unit42.paloaltonetworks.com/unit42-malware-team-malspam-pushing-emotet-trickbot/](https://unit42.paloaltonetworks.com/unit42-malware-team-malspam-pushing-emotet-trickbot/)\n\n[https://www.virusbulletin.com/virusbulletin/2019/10/vb2019-paper-exploring-emotet-elaborate-everyday-enigma/](https://www.virusbulletin.com/virusbulletin/2019/10/vb2019-paper-exploring-emotet-elaborate-everyday-enigma/)\n\n[https://docs.microsoft.com/en-us/windows/win32/seccng/about-cng](https://docs.microsoft.com/en-us/windows/win32/seccng/about-cng)\n\n[https://docs.microsoft.com/en-us/windows/win32/seccng/cryptographic-primitives](https://docs.microsoft.com/en-us/windows/win32/seccng/cryptographic-primitives)\n\n[https://docs.microsoft.com/de-de/windows/win32/api/bcrypt/ns-bcrypt-bcrypt_ecckey_blob](https://docs.microsoft.com/de-de/windows/win32/api/bcrypt/ns-bcrypt-bcrypt_ecckey_blob)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-02 - Malware Analysis Spotlight- Emotet’s Use of Cryptography.pdf"
    ],
    "report_names": [
        "2022-02-02 - Malware Analysis Spotlight- Emotet’s Use of Cryptography.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536133,
    "ts_updated_at": 1743041131,
    "ts_creation_date": 1653780093,
    "ts_modification_date": 1653780093,
    "files": {
        "pdf": "https://archive.orkl.eu/e72e0ffd0743aa6b119618ef3ab3442f760e4896.pdf",
        "text": "https://archive.orkl.eu/e72e0ffd0743aa6b119618ef3ab3442f760e4896.txt",
        "img": "https://archive.orkl.eu/e72e0ffd0743aa6b119618ef3ab3442f760e4896.jpg"
    }
}