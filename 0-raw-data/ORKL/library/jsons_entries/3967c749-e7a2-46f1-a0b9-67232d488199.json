{
    "id": "3967c749-e7a2-46f1-a0b9-67232d488199",
    "created_at": "2022-10-25T16:48:20.60172Z",
    "updated_at": "2025-03-27T02:17:27.627204Z",
    "deleted_at": null,
    "sha1_hash": "358418d6665af6173055b08fad48e56540c50190",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-04-09T02:33:12Z",
    "file_modification_date": "2021-04-09T02:33:12Z",
    "file_size": 2748347,
    "plain_text": "# Iran’s APT34 Returns with an Updated Arsenal\n\n**[research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal](https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/)**\n\nApril 8, 2021\n\n## Introduction\n\n\nApril 8, 2021\n\n\nCheck Point Research discovered evidence of a new campaign by the Iranian threat group\nAPT34 (aka OilRig), against what appears to be a Lebanese target, employing a new\nbackdoor variant we dubbed `SideTwist .`\n\n\n-----\n\n[Since the 2019 leak of APT34’s tools by an entity named “Lab Dookhtegan”, the threat](https://www.zdnet.com/article/source-code-of-iranian-cyber-espionage-tools-leaked-on-telegram/)\ngroup has been actively retooling and updating their payload arsenal to try and avoid\ndetection, creating several different malware variants whose ultimate purpose remained\nthe same: to gain the initial foothold on the targeted device.\n\n[Starting with the DNSpionage campaign back in 2018, APT34 has been observed](https://www.opmd.fr/blog/dnspionage-focus-on-internal-actions/)\ntargeting individuals through the use of booby-trapped job opportunity documents,\ndelivered directly to the selected targets via LinkedIn messages. This activity continued\n[through 2019 with the HardPass operation, in which the LinkedIn platform was used in](https://www.fireeye.com/blog/threat-research/2019/07/hard-pass-declining-apt34-invite-to-join-their-professional-network.html)\nthe same manner.\n\nIn this latest campaign from January, a document submitted to VirusTotal from Lebanon\n(a common target for APT34), also depicts such a job opportunity document, although in\nthis case we were unable to confirm the initial delivery mechanism to the target.\n\nIn the following article we analyze the latest infection chain used by the attackers and\ndeep dive into the new malware variant.\n\n## Initial Infection\n\nOur analysis began with a malicious Microsoft Word document named `Job-`\n```\nDetails.doc (md5: 6615c410b8d7411ed14946635947325e ).\n\n```\n\n-----\n\nFig 1: Lure document with malicious macros\n\nThe decoy document clearly tries to appear like a benign document, offering various\npositions in the Ntiva IT consulting company – a company based in Virginia, US.\n\nHowever, once the user activates the embedded malicious macros, the full infection flow\nis triggered:\n\n\n-----\n\nFig 2: Infection Flow\n\n### Malicious Macros with DNS tunneling\n\nMacros used by APT34’s job opportunity campaigns have evolved through the years, but\nalso managed to keep their own distinctive style and purpose:\n\nVerification that there is a mouse connected to the PC (Anti-Sandboxing technique).\nInitial fingerprinting of the target device and sending of the information to the C2\nserver.\nDropping embedded executable to disk with a “doc” extension (later to be renamed\nto “.exe”).\nRegistering a Windows schedule task that would launch the executable every X\nminutes.\n\nFig 3: VBA functions call graph generated by Vba2Graph\n\nIn the macros function call graph above, we can see that from the `Document_Open and`\nthe `Document_Close functions, there are multiple calls to the` `DnsQuery external`\nfunction.\n\n\n-----\n\nAPT34 is notorious for its heavy use of DNS tunneling through many of their different\ntools, and this time this feature also made its way into the initial macros stage.\n\nOnce the macros are executed, DNS requests are used to beacon back to the attacker, and\ninform them of the current stage of the execution, as well as to deliver some victim\nidentifiable information.\n\nFig 4: Snippet from the malicious macros, responsible for sending DNS queries\n\nIn this step, the attacker is using the publicly available `requestbin.net DNS tunneling`\nservice, in order to get updates about the macros infection progress. This way the\nattacker-owned infrastructure would not be exposed, in case a sandbox would not be able\nto fully “detonate” the document.\n\nBelow is a demonstration of the information the attacker would see on the\n```\nrequesbin.net website, when a victim executes the malicious macros from a system\n\n```\nwith the following environment:\n\nUser name: `John`\nHostname: `John-pc`\n\n\n-----\n\nFig 5: The macro requests as viewed on “requesbin.net”, with source IP\n\naddress and timestamp redacted\n\nThe encoded data is derived from the PC information, in the following manner:\n\nFig 6: encoded DNS data\n\n## Second Stage Payload: SideTwist\n\nThe backdoor in this stage, is a variant we haven’t seen before in previous APT34\noperations, but provides functionality which is simple and similar to other C based\n[backdoors utilized by the group: DNSpionage and TONEDEAF and TONEDEAF2.0.](https://blog.talosintelligence.com/2018/11/dnspionage-campaign-targets-middle-east.html)\n\nThe functionality of the backdoor includes download, upload and shell command\nexecution.\n\n### Persistence\n\nIn this infection chain the persistence is actually established by the 1 stage macros, andst\nthe 2nd stage payload does not have any persistence mechanism of its own.\n\n\n-----\n\nPersistence is achieved in the 1 stage, when the schedule task is registered. Thest\n\nnd\n\nscheduled task named `SystemFailureReporter will execute the 2` stage payload\nevery 5 minutes:\n\nFig 7: Scheduled task on an infected machine\n\nThe backdoor is very dependent on this persistence mechanism, as every time it would\nlaunch, it would only execute a single command provided from the C&C server and\nimmediately shut down, until it is launched again by the scheduled task.\n\n### Initialization\n\nThe backdoor starts by collecting basic information about the victim’s machine and\ncalculating a 4-byte long victim identifier, based on the user-name, computer-name\nand the domain name of the target environment. This identifier will be used in the followup C&C communication.\n\nFig 8: Code to gather identifiable information\n\n\nNext the malware will verify that the `update.xml file that was supposed to be created in`\nthe 1 stage of the infection does indeed exists, and if not, it will terminate itself –st\nprinting the following text to the debugging output using the `OutputDebugString`\nfunction:\n\n\n-----\n\n_“Please install visual studio 2017 and try again”_\n\nFig 9: Code to verify that the 1st stage was executed\n\nAs the purpose of this function is to print debugging information, only during the\ndebugging process of an application, the text will not be visible to the regular user.\n\n### C&C communication\n\nThe backdoor’s communication with the C&C server ( sarmsoftware[.]com ) is HTTP\nbased on port 443 with port 80 as fallback.\n\nThe backdoor uses two different techniques for its outgoing and incoming\ncommunications with the C&C server, though in both cases the same encryption\nalgorithm is utilized (see more on encryption below).\n\n**Command Request Communication**\n\nThe backdoor contacts the C&C server in the following URL using a GET request:\n\n```\nsarmsoftware[.]com/search/{identifier}\n\n```\n\nThe response to this request is hidden in the source code of following Flickr lookalike\npage:\n\nFig 10: Fake Flickr lookalike page used as C&C\n\nThe response is returned to the backdoor within the HTML code, in the following format:\n\n```\n/*Encrypted_Message_Encoded_with_Base64*/\n\n```\n\n-----\n\nFig 11: C&C commands embedded within the code\n\nAfter this base64 string is decoded and decrypted, the plain-text content is in the\nfollowing pipe-separated format:\n\nFig 12: Encrypted data format\n\n**Command Number – a running index number to keep track of executed**\ncommands. If set to any number other than `-1, the backdoor should proceed to`\nexecute the command, according to the Command ID. Otherwise, ignore and\nterminate.\n**Command ID – can be one of the following commands:**\n\n**101 – Shell Command: execute the Shell command attached in the** `{Arg1}`\nargument.\n**102 – Download File: Downloads a file that can be found on the** `{Arg2}`\npath on the server, and saves it on the disk with the `{Arg1} name.`\n**103 – Upload File: Uploads a local file** `{Arg1} to the server.`\n**104 – Shell Command (duplicate): execute the Shell command attached in the**\n```\n      {Arg1} argument.\n\n```\n**Command Results Communication**\n\nAfter the backdoor has executed an arbitrary command on the victim’s machine, it\nreturns the result of the executed command to the C&C server, to the same URL as before,\nbut in a POST request instead of a GET:\n\n```\nsarmsoftware[.]com/search/{identifier}\n\n```\n\nThe format of the POST body is a simple JSON, based on the command number provided\nfrom the C&C server and the encrypted result of the command execution:\n\n\n-----\n\nFig 13: Result data format\n\n**Communication Encryption**\n\nAs the basis for the encrypted communication, the attackers utilize the Mersenne Twister\npseudorandom number generator.\n\nThe 4 first bytes of each encrypted message is the seed for the Mersenne Twister, to be\nused for the decryption of the rest of the message.\n\nThe encrypted Base64 communication can be decrypted using the following Python\nsnippet:\n\ndef decode(msg):\n\nbs=base64.b64decode(msg)\n\nseed=int.from_bytes(bs[:4],byteorder='big')\n\nrng = mersenne_rng(seed)\n\nk=rng.get_random_number()\n\nkey=int.to_bytes(k,length=4,byteorder='little')\n\ndec=\"\".join([chr(bs[i]^key[(i-4)%4]) for i in range(4,len(bs))])\n\nreturn dec\n\n## Attribution\n\nBoth the malicious macros, the backdoor, the targeting, and the techniques used in this\noperation – all align with previously reported campaigns attributed to APT34.\n\n### Document Similarity\n\n[Besides the fact that like in previous APT34 operations, once again we see job opportunity](https://blog.talosintelligence.com/2018/11/dnspionage-campaign-targets-middle-east.html)\ndocuments being used to encourage the victim to enable macros, there are technical\nsimilarities as well.\n\n\n-----\n\nThe same variable name `beacher was present in and old DNSpionage campaign:`\n\nFig 14: Similar variable name in old macros code\n\nThe main functionality of the macros remained the same as in a previous APT34\n[campaign: The malicious macros use the MouseAvailable function for evasion, and](https://www.intezer.com/blog/malware-analysis/new-iranian-campaign-tailored-to-us-companies-uses-updated-toolset/)\ncreate a scheduled task to execute a payload embedded within the document.\n\n### C&C Communication Similarity\n\nAPT34’s backdoors DNSpionage and TONEDEAF are known to receive commands from\nthe servers by searching for specific pattern hidden inside the HTML content of a\nlegitimate looking website.\n\nIn our case the attackers utilized a Flickr lookalike page, while in previous campaigns\n[GitHub, Wikipedia, and Microsoft lookalikes were used.](https://twitter.com/_CPResearch_/status/1103525899515973632)\n\n## Additional APT34 Sightings\n\nWhile analyzing the above campaign, this and additional APT34 related documents were\n[uploaded to VirusTotal and noted by malware researchers on Twitter.](https://twitter.com/Arkbird_SOLG/status/1378466623162609667)\n\nThese documents utilized the very same `requestbin.net DNS tunneling service in the`\ninitial macros and delivered another of the group’s signature tools: a variant of the .NET\nbased backdoor named Karkoff, which utilized internet facing exchange servers as a\ncommunication method with the attackers.\n\nThe newly found artifacts emphasize the extent of the ongoing APT34’s offensive\noperations against targets in the Middle East, and especially in Lebanon:\n\nThe Karkoff implant (MD5: ab25014c3d6f77ec5880c8f9728be968) included credentials\nfor an exchange server belonging to the Lebanese Government ( mail.army.gov[.]lb ),\n[which might be an indication of a long running compromise of their network.](https://yoroi.company/research/karkoff-2020-a-new-apt34-espionage-operation-involves-lebanon-government/)\n\n\n-----\n\n## Conclusion\n\nIran backed APT34 shows no sign of slowing down, further pushing its political agenda in\nthe middle-east, with an ongoing focus on Lebanon – using offensive cyber operations.\n\nWhile maintaining its modus operandi and reusing old techniques, as reviewed above, the\ngroup continues to create new and updated tools to minimize the possible detection of\ntheir tools by security vendors.\n\nIn this publication we analyzed the newest backdoor variant deployed by the group’s\nongoing job opportunities campaigns, which includes malicious documents with job\noffers – a technique they have successfully employed since at least 2018.\n\nCheck Point Sandblast protects against this APT attack, and prevents it from the very first\nsteps.\n\n## Appendix A: Indicators of Compromise\n\n**Malicious document:**\n\nMD5: 6615c410b8d7411ed14946635947325e\n\nSHA1: 9bba72ac66af84253b55dd7789afc90e0344bf25\n\nSHA256: 13c27e5049a7fc5a36416f2c1ae49c12438d45ce50a82a96d3f792bfdacf3dcd\n\n**SideTwist backdoor:**\n\nMD5: 94004648630739c154f78a0bae0bec0a\n\nSHA1: 273488416b5d6f1297501825fa07a5a9325e9b56\n\nSHA256: 47d3e6c389cfdbc9cf7eb61f3051c9f4e50e30cf2d97499144e023ae87d68d5a\n\n**C&C server:**\n\nsarmsoftware[.]com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.04.08.APT34_Returns/Iran%E2%80%99s%20APT34%20Returns%20with%20an%20Updated%20Arsenal%20-%20Check%20Point%20Research.pdf"
    ],
    "report_names": [
        "Iran’s APT34 Returns with an Updated Arsenal - Check Point Research"
    ],
    "threat_actors": [
        {
            "id": "ce10c1bd-4467-45f9-af83-28fc88e35ca4",
            "created_at": "2022-10-25T15:50:23.458833Z",
            "updated_at": "2025-03-27T02:00:55.475188Z",
            "deleted_at": null,
            "main_name": "APT34",
            "aliases": null,
            "source_name": "MITRE:APT34",
            "tools": [
                "netstat",
                "Systeminfo",
                "PsExec",
                "SEASHARPEE",
                "Tasklist",
                "Mimikatz",
                "POWRUNER",
                "certutil"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4632103e-8035-4a83-9ecb-c1e12e21288c",
            "created_at": "2022-10-25T16:07:23.542255Z",
            "updated_at": "2025-03-27T02:02:09.854487Z",
            "deleted_at": null,
            "main_name": "DNSpionage",
            "aliases": [],
            "source_name": "ETDA:DNSpionage",
            "tools": [
                "Agent Drable",
                "AgentDrable",
                "CACTUSPIPE",
                "DNSpionage",
                "DropperBackdoor",
                "Karkoff",
                "MailDropper",
                "OILYFACE"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "cffb3c01-038f-4527-9cfd-57ad5a035c22",
            "created_at": "2022-10-25T15:50:23.38055Z",
            "updated_at": "2025-03-27T02:00:55.459558Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "COBALT GYPSY",
                "IRN2",
                "APT34",
                "Helix Kitten",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "EUROPIUM",
                "ITG13"
            ],
            "source_name": "MITRE:OilRig",
            "tools": [
                "ISMInjector",
                "RDAT",
                "Systeminfo",
                "QUADAGENT",
                "OopsIE",
                "Tasklist",
                "certutil",
                "ZeroCleare",
                "POWRUNER",
                "netstat",
                "ipconfig",
                "LaZagne",
                "BONDUPDATER",
                "SideTwist",
                "PsExec",
                "SEASHARPEE",
                "Mimikatz",
                "RGDoor",
                "ftp"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67709937-2186-4a32-b64c-a5693d40ac77",
            "created_at": "2023-01-06T13:46:38.495593Z",
            "updated_at": "2025-03-27T02:00:02.848206Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "IRN2",
                "Hazel Sandstorm",
                "EUROPIUM",
                "TA452",
                "Earth Simnavaz",
                "Cobalt Gypsy",
                "Crambus",
                "Helix Kitten",
                "APT 34",
                "APT34",
                "ATK40",
                "G0049",
                "Evasive Serpens",
                "Twisted Kitten"
            ],
            "source_name": "MISPGALAXY:OilRig",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "8d76e350-dfb5-4733-800d-876de41f690d",
            "created_at": "2023-01-06T13:46:38.841887Z",
            "updated_at": "2025-03-27T02:00:02.932838Z",
            "deleted_at": null,
            "main_name": "DNSpionage",
            "aliases": [
                "COBALT EDGEWATER"
            ],
            "source_name": "MISPGALAXY:DNSpionage",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3eebdb3f-f4e3-42e5-bb4d-f02a13328316",
            "created_at": "2024-05-01T02:03:08.014303Z",
            "updated_at": "2025-03-27T02:05:17.306592Z",
            "deleted_at": null,
            "main_name": "COBALT EDGEWATER",
            "aliases": [
                "Cold River ",
                "DNSpionage ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT EDGEWATER",
            "tools": [
                " DNSpionage",
                " Karkoff",
                " MailDropper",
                " SideTwist",
                " TWOTONE",
                "AgentDrable"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8f9c8a6e-f6b6-431b-bedd-94fdeea5474a",
            "created_at": "2024-05-01T02:03:08.022974Z",
            "updated_at": "2025-03-27T02:05:17.310877Z",
            "deleted_at": null,
            "main_name": "COBALT GYPSY",
            "aliases": [
                "CHRYSENE ",
                "Crambus ",
                "EUROPIUM ",
                "Hazel Sandstorm ",
                "Helix Kitten ",
                "ITG13 ",
                "OilRig ",
                "Yellow Maero ",
                "APT34 "
            ],
            "source_name": "Secureworks:COBALT GYPSY",
            "tools": [
                " Helminth",
                " Jason",
                " MacDownloader",
                " PoisonFrog",
                " RGDoor",
                " ThreeDollars",
                " TinyZbot",
                " Toxocara",
                " Trichuris",
                " TwoFace",
                "Glimpse"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b6436f7b-6012-4969-aed1-d440e2e8b238",
            "created_at": "2022-10-25T16:07:23.91517Z",
            "updated_at": "2025-03-27T02:02:10.027531Z",
            "deleted_at": null,
            "main_name": "OilRig",
            "aliases": [
                "APT 34",
                "ATK 40",
                "Chrysene",
                "Cobalt Gypsy",
                "Crambus",
                "DEV-0861",
                "EUROPIUM",
                "Earth Simnavaz",
                "Evasive Serpens",
                "Hazel Sandstorm",
                "Helix Kitten",
                "IRN2",
                "ITG13",
                "Scarred Manticore",
                "Storm-0861",
                "TA452",
                "Twisted Kitten",
                "UNC1860",
                "Yellow Maero"
            ],
            "source_name": "ETDA:OilRig",
            "tools": [
                "AMATIAS",
                "Agent Drable",
                "Agent Injector",
                "AgentDrable",
                "Alma Communicator",
                "BONDUPDATER",
                "CACTUSPIPE",
                "Clayslide",
                "CypherRat",
                "DNSExfitrator",
                "DNSpionage",
                "DROPSHOT",
                "DistTrack",
                "DropperBackdoor",
                "Fox Panel",
                "GREYSTUFF",
                "GoogleDrive RAT",
                "HighShell",
                "HyperShell",
                "ISMAgent",
                "ISMDoor",
                "ISMInjector",
                "Jason",
                "Karkoff",
                "LIONTAIL",
                "LOLBAS",
                "LOLBins",
                "LONGWATCH",
                "LaZagne",
                "Living off the Land",
                "MailDropper",
                "Mimikatz",
                "MrPerfectInstaller",
                "OILYFACE",
                "OopsIE",
                "POWBAT",
                "POWRUNER",
                "Plink",
                "Poison Frog",
                "PowerExchange",
                "PsList",
                "PuTTY Link",
                "QUADAGENT",
                "RDAT",
                "RGDoor",
                "SEASHARPEE",
                "Saitama",
                "Saitama Backdoor",
                "Shamoon",
                "SideTwist",
                "SpyNote",
                "SpyNote RAT",
                "StoneDrill",
                "TONEDEAF",
                "TONEDEAF 2.0",
                "ThreeDollars",
                "TwoFace",
                "VALUEVAULT",
                "Webmask",
                "WinRAR",
                "ZEROCLEAR",
                "ZeroCleare",
                "certutil",
                "certutil.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716500,
    "ts_updated_at": 1743041847,
    "ts_creation_date": 1617935592,
    "ts_modification_date": 1617935592,
    "files": {
        "pdf": "https://archive.orkl.eu/358418d6665af6173055b08fad48e56540c50190.pdf",
        "text": "https://archive.orkl.eu/358418d6665af6173055b08fad48e56540c50190.txt",
        "img": "https://archive.orkl.eu/358418d6665af6173055b08fad48e56540c50190.jpg"
    }
}