{
    "id": "5203c9fb-7483-48df-b42a-573613980428",
    "created_at": "2023-01-12T15:08:57.307451Z",
    "updated_at": "2025-03-27T02:05:24.775521Z",
    "deleted_at": null,
    "sha1_hash": "8fd0ed74f7ca9296bc6b7098bc4061cdd112f6fb",
    "title": "2021-07-08 - Zloader With a New Infection Technique",
    "authors": "",
    "file_creation_date": "2022-05-28T17:53:51Z",
    "file_modification_date": "2022-05-28T17:53:51Z",
    "file_size": 1582075,
    "plain_text": "# Zloader With a New Infection Technique\n\n**mcafee.com/blogs/other-blogs/mcafee-labs/zloader-with-a-new-infection-technique/**\n\n_This blog was written by Kiran Raj & Kishan N._\n\n## Introduction\n\n\nJuly 8, 2021\n\n\nIn the last few years, Microsoft Office macro malware using social engineering as a means for malware infection has been a dominant part of\nthe threat landscape. Malware authors continue to evolve their techniques to evade detection. These techniques involve utilizing macro\nobfuscation, DDE, living off the land tools (LOLBAS), and even utilizing legacy supported XLS formats.\n\nMcAfee Labs has discovered a new technique that downloads and executes malicious DLLs (Zloader) without any malicious code present in\nthe initial spammed attachment macro. The objective of this blog is to cover the technical aspect of the newly observed technique.\n\nInfection map\n\n## Threat Summary\n\nThe initial attack vector is a phishing email with a Microsoft Word document attachment.\n\n\n-----\n\nUpo ope g t e docu e t, a pass o d p otected c oso t ce e s do oaded o a e ote se e\nThe Word document Visual Basic for Applications (VBA) reads the cell contents of the downloaded XLS file and writes into the XLS VBA\nas macros.\nOnce the macros are written to the downloaded XLS file, the Word document sets the policy in the registry to Disable Excel Macro\nWarning and calls the malicious macro function dynamically from the Excel file,\nThis results in the downloading of the Zloader payload. The Zloader payload is then executed by rundll32.exe.\n\n**The section below contains the detailed technical analysis of this technique.**\n\n## Detailed Technical Analysis\n\n### Infection Chain\n\nThe malware arrives through a phishing email containing a Microsoft Word document as an attachment. When the document is opened and\nmacros are enabled, the Word document, in turn, downloads and opens another password-protected Microsoft Excel document.\n\nAfter downloading the XLS file, the Word VBA reads the cell contents from XLS and creates a new macro for the same XLS file and writes the\ncell contents to XLS VBA macros as functions.\n\nOnce the macros are written and ready, the Word document sets the policy in the registry to Disable Excel Macro Warning and invokes the\nmalicious macro function from the Excel file. The Excel file now downloads the Zloader payload. The Zloader payload is then executed using\nrundll32.exe.\n\n_Figure-1: flowchart of the Infection chain_\n\n## Word Analysis\n\nHere is how the face of the document looks when we open the document (figure 2). Normally, the macros are disabled to run by default by\nMicrosoft Office. The malware authors are aware of this and hence present a lure image to trick the victims guiding them into enabling the\nmacros.\n\n\n-----\n\n_Figure-2: Image of Word Document Face_\n\nThe userform combo-box components present in the Word document stores all the content required to connect to the remote Excel document\nincluding the Excel object, URL, and the password required to open the Excel document. The URL is stored in the Combobox in the form of\nbroken strings which will be later concatenated to form a complete clear string.\n\n_Figure-3: URL components (right side) and the password to open downloaded Excel document (“i5x0wbqe81s”) present in user-form_\n_components._\n\n## VBA Macro Analysis of Word Document\n\n\n-----\n\n_Figure-4: Image of the VBA editor_\n\nIn the above image of macros (figure 4), the code is attempting to download and open the Excel file stored in the malicious domain. Firstly, it\ncreates an Excel application object by using CreateObject() function and reading the string from Combobox-1 (ref figure-2) of Userform-1\nwhich has the string “excel. Application” stored in it. After creating the object, it uses the same object to open the Excel file directly from the\nmalicious URL along with the password without saving the file on the disk by using Workbooks.Open() function.\n\n_Figure-5: Word Macro code that reads strings present in random cells in Excel sheet._\n\nThe above snippet (figure 5) shows part of the macro code that is reading the strings from the Excel cells.\n\n\n-----\n\no a p e\n\nIxbq = ifk.sheets(3).Cells(44,42).Value\n\nThe code is storing the string present in sheet number 3 and the cell location (44,42) into the variable “ixbq”. The Excel.Application object that\nis assigned to variable “ifk” is used to access sheets and cells from the Excel file that is opened from the malicious domain.\n\nIn the below snippet (figure 6), we can observe the strings stored in the variables after being read from the cells. We can observe that it has\nstring related to the registry entry “HKEY_CURRENT_USER\\Software\\Microsoft\\Office\\12.0\\Excel\\Security\\AccessVBOM” that is used to\ndisable trust access for VBA into Excel and the string “Auto_Open3” that is going to be the entry point of the Excel macro execution.\n\nWe can also see the strings “ThisWorkbook”, “REG_DWORD”, “Version”, “ActiveVBProject” and few random functions as well like “Function\nc4r40() c4r40=1 End Function”. These macro codes cannot be detected using static detection since the content is formed dynamically on run\ntime.\n\n_Figure-6: Value of variables after reading Excel cells._\n\nAfter extracting the contents from the Excel cells, the parent Word file creates a new VBA module in the downloaded Excel file by writing the\nretrieved contents. Basically, the parent Word document is retrieving the cell contents and writing them to XLS macros.\n\nOnce the macro is formed and ready, it modifies the below RegKey to disable trust access for VBA on the victim machine to execute the\nfunction seamlessly without any Microsoft Office Warnings.\n\n_HKEY_CURRENT_USER\\Software\\Microsoft\\Office\\12.0\\Excel\\Security\\AccessVBOM_\n\nAfter writing macro contents to Excel file and disabling the trust access, function ’Auto_Open3()’ from newly written excel VBA will be called\nwhich downloads zloader dll from the ‘hxxp://heavenlygem.com/22.php?5PH8Z’ with extension .cpl\n\n_Figure-7: Image of ’Auto_Open3()’ function_\n\n\n-----\n\ne do oaded d s sa ed **%te** **p% o de a d e ecuted by** o g u d 3 e e\n\n_Figure-8: Image of zloader dll invoked by rundll32.exe_\n\n## Command-line parameter:\n\nRundll32.exe shell32.dll,Control_RunDLL “<path downloaded dll>”\n\nWindows Rundll32 commands loads and runs 32-bit DLLs that can be used for directly invoking specified functions or used to create shortcuts.\nIn the above command line, the malware uses “Rundll32.exe shell32.dll,Control_RunDLL” function to invoke control.exe (control panel) and\npasses the DLL path as a parameter, therefore the downloaded DLL is executed by control.exe.\n\n## Excel Document Analysis:\n\nThe below image (figure 9) is the face of the password-protected Excel file that is hosted on the server. We can observe random cells storing\nchunks of strings like “RegDelete”, “ThisWorkbook”, “DeleteLines”, etc.\n\nThese strings present in worksheet cells are formed as VBA macro in the later stage.\n\n_Figure-9: Image of Remote Excel file._\n\n## Coverage and prevention guidance:\n\nMcAfee’s Endpoint products detect this variant of malware and files dropped during the infection process.\n\nThe main malicious document with SHA256 (210f12d1282e90aadb532e7e891cbe4f089ef4f3ec0568dc459fb5d546c95eaf) is detected with V3\npackage version – 4328.0 as “W97M/Downloader.djx”. The final Zloader payload with SHA-256\n[(c55a25514c0d860980e5f13b138ae846b36a783a0fdb52041e3a8c6a22c6f5e2)which is a DLL is detected by signature “Zloader-FCVP” with](https://www.virustotal.com/gui/search/mcafee%253AZloader-FCVP!BB1272E0E328)\nV3 package version – 4327.0\n\n\n-----\n\ndd t o a y, t t e e p o c ee s pe t u e eatu e, custo e s ca st e gt e t e secu ty by add g custo pe t u es based o t e\nbehavior patterns of the malware. The below EP rule is specific to this infection pattern.\n\nMcAfee advises all users to avoid opening any email attachments or clicking any links present in the mail without verifying the identity of the\nsender. Always disable the macro execution for Office files. We advise everyone to read our blog on this new variant of Zloader and its\ninfection cycle to understand more about the threat.\n\nDifferent techniques & tactics are used by the malware to propagate and we mapped these with the MITRE ATT&CK platform.\n\n**E-mail Spear Phishing (T1566.001): Phishing acts as the main entry point into the victim’s system where the document comes as an**\nattachment and the user enables the document to execute the malicious macro and cause infection. This mechanism is seen in most of\nthe malware like Emotet, Drixed, Trickbot, Agenttesla, etc.\n**Execution (T1059.005): This is a very common behavior observed when a malicious document is opened. The document contains**\nembedded malicious VBA macros which execute code when the document is opened/closed.\n**Defense Evasion (T1218.011): Execution of signed binary to abuse Rundll32.exe and to proxy execute the malicious code is observed**\nin this Zloader variant. This tactic is now also part of many others like Emotet, Hancitor, Icedid, etc.\n**Defense Evasion (T1562.001): In this tactic, it Disables or Modifies security features in Microsoft Office document by changing the**\nregistry keys.\n\n## IOC\n\nType Value Scanner Detection Name Detection\nPackage\nVersion\n(V3)\n\n\nMain Word\nDocument\n\nDownloaded\ndll\n\nURL to\ndownload\nXLS\n\nURL to\ndownload dll\n\n## Conclusion\n\n\n210f12d1282e90aadb532e7e891cbe4f089ef4f3ec0568dc459fb5d546c95eaf ENS W97M/Downloader.djx 4328\n\nc55a25514c0d860980e5f13b138ae846b36a783a0fdb52041e3a8c6a22c6f5e2 ENS [Zloader-FCVP](https://www.virustotal.com/gui/search/mcafee%253AZloader-FCVP!BB1272E0E328) 4327\n\nhxxp://heavenlygem.com/11.php WebAdvisor Blocked N/A\n\nhxxp://heavenlygem.com/22.php?5PH8Z WebAdvisor Blocked N/A\n\n\n-----\n\na c ous docu e ts a e bee a e t y po t o ost a a e a es a d t ese attac s a e bee e o g t e ect o tec ques a d\nobfuscation, not just limiting to direct downloads of payload from VBA, but creating agents dynamically to download payload as we discussed\nin this blog. Usage of such agents in the infection chain is not only limited to Word or Excel, but further threats may use other living off the land\ntools to download its payloads.\n\nDue to security concerns, macros are disabled by default in Microsoft Office applications. We suggest it is safe to enable them only when the\ndocument received is from a trusted source.\n\n[McAfee Labs Threat Research Team](https://www.mcafee.com/blogs/author/mcafee-labs/)\nMcAfee Labs is one of the leading sources for threat research, threat intelligence, and cybersecurity thought leadership. See our blog posts\nbelow for more information.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-08 - Zloader With a New Infection Technique.pdf"
    ],
    "report_names": [
        "2021-07-08 - Zloader With a New Infection Technique.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536137,
    "ts_updated_at": 1743041124,
    "ts_creation_date": 1653760431,
    "ts_modification_date": 1653760431,
    "files": {
        "pdf": "https://archive.orkl.eu/8fd0ed74f7ca9296bc6b7098bc4061cdd112f6fb.pdf",
        "text": "https://archive.orkl.eu/8fd0ed74f7ca9296bc6b7098bc4061cdd112f6fb.txt",
        "img": "https://archive.orkl.eu/8fd0ed74f7ca9296bc6b7098bc4061cdd112f6fb.jpg"
    }
}