{
    "id": "248dcf0e-320e-481d-88c0-de2e12252fdb",
    "created_at": "2023-01-12T15:04:48.776107Z",
    "updated_at": "2025-03-27T02:05:58.753936Z",
    "deleted_at": null,
    "sha1_hash": "dc420a3061f1903d8209ba7ebeb849b749eb3831",
    "title": "2019-07-03 - Sodin ransomware exploits Windows vulnerability and processor architecture",
    "authors": "",
    "file_creation_date": "2022-05-28T15:37:26Z",
    "file_modification_date": "2022-05-28T15:37:26Z",
    "file_size": 1297263,
    "plain_text": "# Sodin ransomware exploits Windows vulnerability and processor architecture\n\n**securelist.com/sodin-ransomware/91473/**\n\nAuthors\n\n[Orkhan Mamedov](https://securelist.com/author/orkhanmamedov/)\n\nArtur Pakulov\n\nFedor Sinitsyn\n\nWhen Sodin (also known as Sodinokibi and REvil) appeared in the first half of 2019, it\nimmediately caught our attention for distributing itself through an Oracle Weblogic\n[vulnerability and carrying out attacks on MSP providers. In a detailed analysis, we](https://www.darkreading.com/attacks-breaches/attackers-exploit-msps-tools-to-distribute-ransomware/d/d-id/1335025)\n\n\n-----\n\n[discovered that it also exploits the CVE-2018-8453 vulnerability to elevate privileges in](https://securelist.com/cve-2018-8453-used-in-targeted-attacks/88151/)\nWindows (rare among ransomware), and uses legitimate processor functions to circumvent\nsecurity solutions.\n\nAccording to our statistics, most victims were located in the Asia-Pacific region: Taiwan,\nHong Kong, and South Korea.\n\nGeographic spread of Sodin ransomware, April – June 2019\n\n## Technical description\n\n### Vulnerability exploitation\n\nTo escalate privileges, Trojan-Ransom.Win32.Sodin uses a vulnerability in win32k.sys;\nattempts to exploit it were first detected by our proactive technologies (Automatic Exploit\nPrevention, AEP) in August last year. The vulnerability was assigned the number CVE-20188453. After the exploit is executed, the Trojan acquires the highest level of privileges.\n\n\n-----\n\n**_Information about the process token after exploit execution_**\n\n**_Exploit snippet for checking the window class_**\n\nDepending on the processor architecture, one of two shellcode options contained in the\nTrojan body is run:\n\n\n-----\n\n**_Procedure for selecting the appropriate shellcode option_**\n\nSince the binary being analyzed is a 32-bit executable file, we are interested in how it\nmanages to execute 64-bit code in its address space. The screenshot shows a shellcode\nsnippet for executing 64-bit processor instructions:\n\n**_Shellcode consisting of 32-bit and 64-bit instructions_**\n\n\n-----\n\nIn a 64-bit OS, the segment selector for 32-bit user mode code is 0x23, while the 64-bit\nsegment selector is 0x33. This is confirmed by looking at the Global Descriptor Table (GDT)\nin the kernel debugger:\n\n**_Part of the GDT in OS Windows 10 x64_**\n\nThe selector 0x23 points to the fourth segment descriptor (0x23 >> 3), and the selector 0x33\nto the sixth (the null descriptor is not used). The Nl flag indicates that the segment uses 32bit addressing, while the Lo flag specifies 64-bit. It is important that the base addresses of\nthese segments are equal. At the time of shellcode execution, the selector 0x23 is located in\nthe segment register cs, since the code is executed in a 32-bit address space. With this in\nmind, let’s take a look at the listing of the very start of the shellcode:\n\n**_Saving the full address 0x23:0xC_**\n\nAfter executing the command for RVA addresses 6 and 7, the long return address is stored\nat the top of the stack in the format selector:offset, and takes the form 0x23:0x0C. In the\nstack at offset 0x11, a DWORD is placed whose low-order word contains the selector 0x33\nand whose high-order word encodes the instruction retf, the opcode of which is equal to\n0xCB.\n\n\n-----\n\n**_Saving the full address 0x33:0x1B to 64-bit code_**\n\n**_Switching to 64-bit mode_**\n\nThe next instruction call (at the address RVA 0x16) performs a near intrasegment jump to\nthis retf instruction (RVA 0x14), having sent the short return address (offset 0x1b) to the\nstack. As such, at the time of execution of the retf instruction, the top of the stack contains\nthe address in the format selector:offset, where the selector equals 0x33 and the offset is\n0x1b. After executing the retf command, the processor proceeds to execute the code at this\naddress, but now in 64-bit mode.\n\n**_64-bit shellcode_**\n\nThe return to 32-bit mode is performed at the very end of the shellcode.\n\n**_Returning to 32-bit mode_**\n\nThe retf command makes a far intrasegment jump to the address 0x23:0x0C (it was placed\nin the instruction stack at the very start of the shellcode, at the RVA address 6-7). This\ntechnique of executing 64-bit code in a 32-bit process address space is called Heaven’s\nGate, and was first described around ten years ago.\n\n### Trojan configuration\n\n\n-----\n\nStored in encrypted form in the body of each Sodin sample is a configuration block\ncontaining the settings and data required for the Trojan to work.\n\n**_Decrypted Trojan configuration block_**\n\nThe Sodin configuration has the following fields:\n\n**Field** **Purpose**\n\npk distributor public key\n\npid probably distributor id\n\nsub probably campaign id\n\ndbg debug build\n\nfast fast encryption mode (maximum 0x100000 bytes)\n\nwipe deletion of certain files and overwriting of their content with random bytes\n\nwfld names of directories in which the Trojan deletes files\n\nwht names of directories and files, and list of extensions not to be encrypted\n\nprc names of processes to be terminated\n\ndmn server addresses for sending statistics\n\nnet sending infection statistics\n\nnbody ransom note template\n\nnname ransom note file name template\n\nexp use of exploit for privilege escalation\n\n\n-----\n\nimg text for desktop wallpaper\n\n### Cryptographic scheme\n\nSodin uses a hybrid scheme to encrypt victim files. The file contents are encrypted with the\nSalsa20 symmetric stream algorithm, and the keys for it with an elliptic curve asymmetric\nalgorithm. Let’s take a closer look at the scheme.\n\nSince some data is stored in the registry, this article uses the names given by the\nransomware itself. For entities not in the registry, we use invented names.\n\n**_Data saved by the Trojan in the registry_**\n\n### Key generation\n\nThe Sodin configuration block contains the pk field, which is saved in the registry under the\nname sub_key – this is the 32-byte public key of the Trojan distributor. The key is a point on\nthe Curve25519 elliptic curve.\n\nWhen launched, the Trojan generates a new pair of elliptic curve session keys; the public key\nof this pair is saved in the registry under the name pk_key, while the private key is encrypted\nusing the ECIES algorithm with the sub_key key and stored in the registry under the name\n**sk_key. The ECIES implementation in this case includes the Curve25519 elliptic curve, the**\nSHA3-256 cryptographic hash, and the AES-256 block cipher in CFB mode. Other ECIES\n[implementations have been encountered in Trojans before, for example, in SynAck targeted](https://securelist.com/synack-targeted-ransomware-uses-the-doppelganging-technique/85431/)\nransomware.\n\nCuriously, the same private session key is also encrypted with another public key hardcoded\ninto the body of the Trojan, regardless of the configuration. We will call it the public skeleton\n**key. The encryption result is stored in the registry under the name 0_key. It turns out that**\nsomeone who knows the private key corresponding to the public skeleton key is able to\n\n\n-----\n\ndecrypt the victim s files, even without the private key for sub_key. It seems like the Trojan\ndevelopers built a loophole into the algorithm allowing them to decrypt files behind the\ndistributors’ back.\n\n**_Snippet of the procedure that generates key data and stores some of it in the registry_**\n\n### File encryption\n\nDuring encryption of each file, a new pair of elliptic curve asymmetric keys is generated,\nwhich we will call file_pub and file_priv. Next, SHA3-256(ECDH(file_priv, pk_key)) is\ncalculated, and the result is used as the symmetric key for encrypting file contents with the\nSalsa20 algorithm. The following information is also saved in the encrypted file:\n\n\n-----\n\n**_Data stored in each encrypted file_**\n\nIn addition to the fields discussed above, there is also a nonce (random initialization 8 bytes\nfor the Salsa20 cipher), file_pub_crc32 (checksum for file_pub), flag_fast (if set, only part\nof the data in the file is encrypted), zero_encr_by_salsa (null dword encrypted by the same\nSalsa20 key as the file contents – seemingly to check the correctness of the decryption).\n\nThe encrypted files receive a new arbitrary extension (the same for each infection case), the\nransom note is saved next to them, and the malware-generated wallpaper is set on the\ndesktop.\n\n\n-----\n\n**_Cybercriminals demands_**\n\n\n-----\n\n**_Fragment of the desktop wallpaper created by the ransomware_**\n\n### Network communication\n\nIf the corresponding flag is set in the configuration block, the Trojan sends information about\nthe infected machine to its servers. The transmitted data is also encrypted with the ECIES\nalgorithm using yet another hardcoded public key.\n\n**_Part of the Sodin configuration responsible for network communication_**\n\n**Field** **Purpose**\n\nver Trojan version\n\n\n-----\n\npid probably distributor id\n\nsub probably campaign id\n\npk distributor public key\n\nuid infection id\n\nsk sk_key value (see description above)\n\nunm infected system username\n\nnet machine name\n\ngrp machine domain/workgroup\n\nlng system language\n\nbro whether language or layout is from the list (below)\n\nos OS version\n\nbit architecture\n\ndsk information about system drives\n\next extension of encrypted files\n\nDuring the execution process, the Trojan checks the system language and available\nkeyboard layouts:\n\n\n-----\n\nIf matches are detected in the list, the malware process terminates short of sending\nstatistics.\n\n### MITRE ATT&CK techniques\n\nMore information about Kaspersky cybersecurity services can be found here:\n[https://www.kaspersky.com/enterprise-security/cybersecurity-services](https://www.kaspersky.com/enterprise-security/cybersecurity-services)\n\n### IOC\n\n1ce1ca85bff4517a1ef7e8f9a7c22b16\n\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Malware Technologies](https://securelist.com/tag/malware-technologies/)\n[Ransomware](https://securelist.com/tag/ransomware/)\n[Trojan](https://securelist.com/tag/trojan/)\n[Vulnerabilities and exploits](https://securelist.com/tag/vulnerabilities-and-exploits/)\n\nAuthors\n\n\n-----\n\n[Orkhan Mamedov](https://securelist.com/author/orkhanmamedov/)\n\nArtur Pakulov\n\nFedor Sinitsyn\n\nSodin ransomware exploits Windows vulnerability and processor architecture\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-03 - Sodin ransomware exploits Windows vulnerability and processor architecture.pdf"
    ],
    "report_names": [
        "2019-07-03 - Sodin ransomware exploits Windows vulnerability and processor architecture.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535888,
    "ts_updated_at": 1743041158,
    "ts_creation_date": 1653752246,
    "ts_modification_date": 1653752246,
    "files": {
        "pdf": "https://archive.orkl.eu/dc420a3061f1903d8209ba7ebeb849b749eb3831.pdf",
        "text": "https://archive.orkl.eu/dc420a3061f1903d8209ba7ebeb849b749eb3831.txt",
        "img": "https://archive.orkl.eu/dc420a3061f1903d8209ba7ebeb849b749eb3831.jpg"
    }
}