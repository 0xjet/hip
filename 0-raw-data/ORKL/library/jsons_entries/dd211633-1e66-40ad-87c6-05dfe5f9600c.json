{
    "id": "dd211633-1e66-40ad-87c6-05dfe5f9600c",
    "created_at": "2023-01-12T15:10:24.50851Z",
    "updated_at": "2025-03-27T02:05:27.045263Z",
    "deleted_at": null,
    "sha1_hash": "f1f3bc94bc4bea828e0b36fa7b207895c7434a72",
    "title": "2017-11-21 - Let's Learn- Trickbot Socks5 Backconnect Module In Detail",
    "authors": "",
    "file_creation_date": "2022-05-28T04:12:21Z",
    "file_modification_date": "2022-05-28T04:12:21Z",
    "file_size": 761613,
    "plain_text": "# Let's Learn: Trickbot Socks5 Backconnect Module In Detail\n\n**[vkremez.com/2017/11/lets-learn-trickbot-socks5-backconnect.html](http://www.vkremez.com/2017/11/lets-learn-trickbot-socks5-backconnect.html)**\n\n**Goal: Reverse the Trickbot Socks5 backconnect module including its communication**\nprotocol and source code-level insights.\n\n**Source: Decoded Trickbot Socks5 backconnect module**\n\n[(33ad13c11e87405e277f002e3c4d26d120fcad0ce03b7f1d4831ec0ee0c056c6)](https://www.virustotal.com/#/file/33ad13c11e87405e277f002e3c4d26d120fcad0ce03b7f1d4831ec0ee0c056c6/detection)\n**Background:**\n\nThe Trickbot banking Trojan is notable for its backconnect Socks5 module titled\n\"bcClientDllTest.\" This module is used extensively by the gang for online account\ntakeover fraud. This module was obtained while analysing the Trickbot infection chain\n[from the email campaign impersonating PayPal (thanks to @Ring0x0).](https://twitter.com/Ring0x0)\n\n[pic.twitter.com/DyWNbq02aa](https://t.co/DyWNbq02aa)\n[— Derrick (@Ring0x0) November 14, 2017](https://twitter.com/Ring0x0/status/930542755176206337?ref_src=twsrc%5Etfw)\n\nThe decoded Trickbot Socks5 DLL module contains the following export functions:\n\nName Address Ordinal\n\nControl 0x100118B8 1\n\nFreeBuffer 0x100027DE 2\n\nRelease 0x100118C3 3\n\nStart 0x100118E4 4\n\nIn this blog, we are primarily interested in analyzing the \"Start\" export function (ordinal #4).\n\n\n-----\n\nThe blog outline is as follows:\nI. \"Start\" configuration template\n\nII. Module CreateThread function\n\nIII. Bot ID generator function\n\nIV. Dynamic API-loading function\n\nV. IP resolution function\n\nVI. Network communication commands\n\nVI. Communication analysis\n\nVII. Yara rule\n\nVIII. Snort signature\n**I. \"Start\" Configuration Template**\nFirst, the backconnect module \"Start\" export loads the default configuration template as\nfollows:\n\n\n-----\n\n<moduleconfig>\n<autostart>yes</autostart>\n<needinfo name = \"id\"/>\n<needinfo name = \"ip\"/>\n<needinfo name = \"parentfiles\"/>\n</moduleconfig>\n**II. Module CreateThread Function**\n\nNext, the module creates a new thread via CreateThread API with\n(LPTHREAD_START_ROUTINE)StartAddress copping the configuration template into the\ndword_10034904 memory location via strstr API containing the sequence of characters to\nmatch \".\". The pseudocoded Start function is as follows:\nvoid *__stdcall Start(int a1, int a2, int a3, int a4, char *a5, int a6, int a7, int a8)\n{\nunsigned int v8'\nunsigned int v9;\nchar v10;\nvoid *result;\n\nv8 = 0;\nv9 = strlen(aModuleconfigAu);\nif ( v9 )\n{\ndo\n{\nv10 = aModuleconfigAu[v8++];\nbyte_100349A4 = v10;\n}\nwhile ( v8 < v9 );\n}\nresult = 0;\nif ( !dword_10034900 )\n{\nmemset(byte_10034908, 0, 0x20u);\nbyte_10034908[32] = 0;s\nqmemcpy(byte_10034908, strstr(a5, \".\") + 1, 0x20u);\ndword_10034900 = 1;\nCreateThread(0, 0, (LPTHREAD_START_ROUTINE)StartAddress, 0, 0, 0);\nresult = malloc(0x400u);\ndword_10034904 = (int)result;\n}\nreturn result;\n\n\n-----\n\n}\n**III. Bot ID generator function**\nOne of the first notable functions is that the module creates a bot identifier (ID) leveraging a\nsecurity identifier (SID) for the account and the name of the domain with the sequence of\nGetVolumeInformationA, GetUserNameA,and LookupAccountNameA, wherein the bot id\n(also referred later as \"client_id\") is a serial number of the hard drive that stores the C\nsection. The value is created using XOR operation on SID.\n\nThe simplified C++ DWORD function is as follows:\nDWORD bot_id_generator()\n{\nCHAR VolumeNameBuffer;\nCHAR FileSystemNameBuffer;\nDWORD FileSystemFlags;\nenum _SID_NAME_USE peUse;\nDWORD MaximumComponentLength;\n\n\n-----\n\nDWORD cbSid;\nDWORD pcbBuffer;\nDWORD cchReferencedDomainName;\nLPSTR ReferencedDomainName;\nDWORD VolumeSerialNumber;\nLPSTR lpBuffer;\nPSID Sid;\nint i;\n\n**GetVolumeInformationA(**\n\"C:\\\\\",\n&VolumeNameBuffer,\n0x80u,\n&VolumeSerialNumber,\n&MaximumComponentLength,\n&FileSystemFlags,\n&FileSystemNameBuffer,\n0x80u);\nlpBuffer = (LPSTR)malloc(0x1000u);\npcbBuffer = 4096;\nSid = malloc(0x1000u);\ncbSid = 4096;\nReferencedDomainName = (LPSTR)malloc(0x1000u);\ncchReferencedDomainName = 4096;\n**GetUserNameA(lpBuffer, &pcbBuffer);**\nmemset(Sid, 0, 0x1000u);\n**LookupAccountNameA(0, lpBuffer, Sid, &cbSid, ReferencedDomainName,**\n&cchReferencedDomainName, &peUse);\nfor ( i = 0; i <= 16; ++i )\n**VolumeSerialNumber ^= *((_DWORD *)Sid + i);**\nfree(lpBuffer);\nfree(Sid);\nfree(ReferencedDomainName);\nreturn VolumeSerialNumber;\n}\n**IV. Dynamic API-Loading Function**\nThe module proceeds to load dynamically the following Windows API via usual sequence\nLoadLibrary/GetModuleHandleA/GetProcAddress:\nv1 = GetModuleHandleA(\"kernel32.dll\");\nv58 = GetProcAddress(v1, \"HeapAlloc\");\nv2 = GetModuleHandleA(\"kernel32.dll\");\nv57 = GetProcAddress(v2, \"HeapFree\");\n\n\n-----\n\nv3 = GetModuleHandleA( kernel32.dll );\nv236 = GetProcAddress(v3, \"GetProcessHeap\");\nv4 = GetModuleHandleA(\"ntdll.dll\");\nv56 = GetProcAddress(v4, \"sprintf\");\nv5 = GetModuleHandleA(\"ntdll.dll\");\nv29 = GetProcAddress(v5, \"strcat\");\nv6 = GetModuleHandleA(\"wininet.dll\");\nv39 = GetProcAddress(v6, \"InternetOpenA\");\nv7 = GetModuleHandleA(\"wininet.dll\");\nv43 = GetProcAddress(v7, \"InternetOpenUrlA\");\nv8 = GetModuleHandleA(\"wininet.dll\");\nv55 = GetProcAddress(v8, \"InternetReadFile\");\nv9 = GetModuleHandleA(\"wininet.dll\");\nv61 = GetProcAddress(v9, \"InternetCloseHandle\");\nThe module then checks if the operation succeeded comparing the predefined location at\nDWORD at 0x10034900 of \"0\".\n**V. IP Resolution Function**\n\n\n-----\n\nThe malware copies its default user agent into the placeholder Mozilla/5.0 (Windows; U;\nMSIE 9.0; Windows NT 9.0; en-US),\" which is later utilized for network communications. The\nmalware leverages the user agent with the resolved hardcoded default IPs, which are\noftentimes changed by the Trickbot. The resolution is accomplished with the following API\ncalls:\ninet_addr\nDnsQuery_A\ninet_ntoa\nThe BOOL-type function is as follows:\nBOOL __cdecl Trick_backconnect_IP_resolution(int a1, _BYTE *a2)\n{\nchar *cp;\nconst char *v4;\nconst char *v5;\nconst char *v6;\nconst char *v7;\nconst char *v8;\nconst char *v9;\nconst char *v10;\nconst char *v11;\nconst char *v12;\n_BYTE *v13;\nint v14;\nstruct in_addr in;\nint v16;\nchar *v17;\nint v18;\nint v19;\n_BYTE *v20;\nint i;\nHLOCAL hMem;\nchar v23;\nchar v24;\n*a2 = 0;\nv19 = 0;\nv18 = 0;\ncp = \"69.164.196[.]21\";\nv4 = \"107.150.40[.]234\";\nv5 = \"162.211.64[.]20\";\nv6 = \"217.12.210[.]54\";\nv7 = \"89.18.27[.]34\";\nv8 = \"193.183.98[.]154\";\n\n\n-----\n\nv9 = 51.255.167[.]0 ;\nv10 = \"91.121.155[.]13\";\nv11 = \"87.98.175[.]85\";\nv12 = \"185.97.7[.]7\";\nv16 = 10;\nhMem = LocalAlloc(0x40u, 8u);\nv24 = 0;\nfor ( i = 0; i < v16; ++i )\n{\n*((_DWORD *)hMem + 1) = inet_addr((&cp)[4 * i]);\n*(_DWORD *)hMem = 1;\nv14 = DnsQuery_A(a1, 1, 2, hMem, &v19, 0);\nv18 = v19;\nif ( v19 )\n{\nin = *(struct in_addr *)(v18 + 24);\nv17 = inet_ntoa(in);\nv20 = a2;\nv13 = a2;\ndo\n{\nv23 = *v17;\n*v20 = v23;\n++v17;\n++v20;\n}\nwhile ( v23 );\nv24 = 1;\n}\nif ( v24 )\nbreak;\n}\nif ( hMem )\nLocalFree(hMem);\nif ( v19 )\nDnsFree(v19, 1);\nreturn v24 != 0;\n}\n**VI. Communication Protocol**\n\n\n-----\n\nThe following commands are used for client-server communications initially with the\ncommand prefix “c”:\n\n**disconnect: Terminate the backconnect server connection**\n\n**idle: Maintain the client-server connection**\n\n**connect: connect to the backconnect server. The command must consist of the following**\nparameters:\n\n**ip: Backconnect server’s IP address**\n\n**auth_swith: Use authorization flag. If the value is set to “1”, the Trojan receives the**\n**auth_login and auth_pass parameters. If the value is “0”, the Trojan gets the auth_ip**\nparameter. Otherwise, the connection will not be established.\n**auth_ip: Authentication IP address**\n\n**auth_login: Authentication login**\n\n**auth_pass: Authentication password**\n\n\n-----\n\n**VI. Deeper Dive into Client-Server Protocol**\nBy and large, there are three main Trickbot Socks5 server-client commands:\nc=idle\nc=disconnect\nc=connect\n\nThe Trickbot client forms a sequence of GET requests to the server (usually, on gate[.]php):\nclient_id=&connected=&server_port=&debug=\n\nThe server POST response with the following parameters if the connection needs to be\nestablished:\n\n```\nc=connect&ip=&auth swith=&auth ip=&auth login=&auth pass=\n\n```\n\n-----\n\nIf the connection needs to be terminated, the server will respond with c=disconnect. Most of\nthe currently observed Trickbot Socks5 backconnect servers contain Blockchain name server\nresolution.\n\n**VII. YARA RULE**\n**rule crime_win32_trick_socks5_backconnect {**\n**meta:**\n\ndescription = \"Trickbot Socks5 bckconnect module\"\n\nauthor = \"@VK_Intel\"\n\nreference = \"Detects the unpacked Trickbot backconnect in memory\"\n\ndate = \"2017-11-19\"\n\nhash = \"f2428d5ff8c93500da92f90154eebdf0\"\n**strings:**\n$s0 = \"socks5dll.dll\" fullword ascii\n\n$s1 = \"auth_login\" fullword ascii\n$s2 = \"auth_ip\" fullword ascii\n\n`        $s3 = \"connect\" fullword ascii\n\n$s4 = \"auth_ip\" fullword ascii\n\n$s5 = \"auth_pass\" fullword ascii\n\n$s6 = \"thread.entry_event\" fullword ascii\n\n$s7 = \"thread.exit_event\" fullword ascii\n\n$s8 = \"</moduleconfig>\" fullword ascii\n\n$s9 = \"<moduleconfig>\" fullword ascii\n\n$s10 = \"<autostart>yes</autostart>\" fullword ascii\n\n**condition:**\n\n\n-----\n\nuint16(0) == 0x5a4d and filesize < 300KB and 7 of them\n}\n**VIII. SNORT RULE**\n\nalert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:\"Possible Trickbot\nSocks5 Backconnect check-in alert\"; flow:established,to_server; content:\"gate.php\"; http_uri;\ncontent:\"?client_id=\"; http_uri; content:\"&connected=\"; http_uri; content:\"&server_port=\";\nhttp_uri; content:\"&debug=\"; http_uri; reference:url,http://www.vkremez.com/2017/11/letslearn-trickbot-socks5-backconnect.html; classtype:Trojan-activity; rev:1;)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-11-21 - Let's Learn- Trickbot Socks5 Backconnect Module In Detail.pdf"
    ],
    "report_names": [
        "2017-11-21 - Let's Learn- Trickbot Socks5 Backconnect Module In Detail.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536224,
    "ts_updated_at": 1743041127,
    "ts_creation_date": 1653711141,
    "ts_modification_date": 1653711141,
    "files": {
        "pdf": "https://archive.orkl.eu/f1f3bc94bc4bea828e0b36fa7b207895c7434a72.pdf",
        "text": "https://archive.orkl.eu/f1f3bc94bc4bea828e0b36fa7b207895c7434a72.txt",
        "img": "https://archive.orkl.eu/f1f3bc94bc4bea828e0b36fa7b207895c7434a72.jpg"
    }
}