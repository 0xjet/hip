{
    "id": "43f0302a-0f1e-4685-bc77-98d8dc0a35a3",
    "created_at": "2023-01-12T15:02:27.653547Z",
    "updated_at": "2025-03-27T02:14:38.754499Z",
    "deleted_at": null,
    "sha1_hash": "384045d46c82fe701e14a358e9e17964e31b5fa7",
    "title": "2017-07-05 - The MeDoc Connection",
    "authors": "",
    "file_creation_date": "2022-05-28T15:47:06Z",
    "file_modification_date": "2022-05-28T15:47:06Z",
    "file_size": 1218531,
    "plain_text": "# The MeDoc Connection\n\n**[blog.talosintelligence.com/2017/07/the-medoc-connection.html](http://blog.talosintelligence.com/2017/07/the-medoc-connection.html)**\n\n_[This Post Authored by David Maynor, Aleksandar Nikolic, Matt Olney, and](https://twitter.com/dave_maynor)_ _[Yves Younan](http://fort-knox.org/)_\n\n## Summary\n\nThe Nyetya attack was a destructive ransomware variant that affected many organizations\ninside of Ukraine and multinational corporations with operations in Ukraine. In cooperation\nwith Cisco Advanced Services Incident Response, Talos identified several key aspects of the\nattack. The investigation found a supply chain-focused attack at M.E.Doc software that\ndelivered a destructive payload disguised as ransomware. By utilizing stolen credentials, the\nactor was able to manipulate the update server for M.E.Doc to proxy connections to an actorcontrolled server. Based on the findings, Talos remains confident that the attack was\ndestructive in nature. The effects were broad reaching, with Ukraine Cyber police confirming\nover 2000 affected companies in Ukraine alone.\n\n## Details\n\nFor Talos, June 27th, 2017, started with a message from our intelligence partners in Ukraine.\nA massive ransomware attack was underway, and they were asking for help. An organized\nattacker had the means to deliver arbitrary code to users of the most popular accounting\nsoftware in Ukraine, and that includes multinational corporations that do business there. The\n\n\n-----\n\nactor in question chose to use this capability to encrypt critical files and hard drives, with no\nway to decrypt the software.\n\nSince the BlackEnergy attacks of late 2015, Talos has worked with public and private\norganizations in Ukraine to respond to attacks in the region. Once already this year, Talos\nhas assisted organizations targeted by actors with destructive intent. Interestingly, in those\ncases a wiper very similar to prior BlackEnergy malware was deployed and, when that was\nblocked by our Advanced Malware Protection (AMP) product, the actor fell back to using a\nransomware variant in an attempt to disrupt the organization’s activities. With this recent\nhistory in mind, we were immediately concerned that there was more to this story than just\nanother ransomware attack.\n\nEarly on it became clear that, while a majority of the early events were in Ukraine, the\nmalware was infecting organizations that didn’t immediately have any known connection to\nthe country. Because of the scale of the event, Talos initiated an internal response\nmanagement system call TaCERS (Talos Critical Event Response System) and began the\nresearch and response process. TaCERS divides up activities into intelligence, telemetry\nanalysis, reverse engineering, communications and detection research. Talos researchers\nand engineers from around the world came together to address this threat.\n\nBased on endpoint telemetry, it was clear that a Ukranian accounting software package\ncalled “M.E.Doc” was at the center of activity. Like WannaCry, there were reports of an email\nvector. This is most likely because some of the earliest infected machines had concurrent\nLokibot infections with indications of an email vector for that malware. After careful research\nTalos concluded that for the delivery of the Nyetya malware, all installations came through\nthe M.E.Doc update system.\n\nM.E.Doc is a widely deployed accounting package created by a Ukrainian company named\nIntellect Service and that it was used to interact with Ukrainian tax systems. At this point we\nwere in a position to reach out to M.E.Doc directly and offer assistance.\n\nM.E.Doc was quick to accept an offer of assistance. As part of Cisco’s global response to\nthis event, two incident response specialists from the Advanced Services group arrived in\n\n\n-----\n\nUkraine on the evening of June 29th and an additional incident response specialist\nsupported the investigation from the UK. M.E.Doc was exceptionally open in arranging\naccess to engineers and administrators who walked the team through the system and\nprovided access to log files and code. They also agreed to share the results of our\ninvestigation for the purposes of this report.\n\nIn every Cisco incident response investigation, anywhere in the world, a dedicated Talos\nresource is made available to the incident response team to coordinate intelligence analysis,\nreverse engineering escalations and telemetry analysis activities. The two teams work\ntogether constantly, and that experience was put to full use in this investigation.\n\nEarly in the investigation, a web shell was discovered at http://www.medoc[.]com[.]ua/TESTUpdate/medoc_online.php. The timestamp in the file was May 31 14:45\n2017. Our analysis shows the webshell to be a slightly modified version of the open source\nPHP webshell PAS. The webshell is stored in an encrypted form and requires a passphrase\nset in a HTTP POST variable to decrypt. The decryption of the shell shows a fully featured\nPAS webshell.\n\nAs the incident response team extracted logs and additional forensic data, it was uploaded to\nTalos. This started a 24-hour cycle where at around 10am EDT, when it was evening in\nUkraine, the Cisco incident response team would brief Talos on their findings and new data.\nThen at 3am EDT, as Ukraine was getting to work, Talos would brief the Cisco incident\nresponse team on their overnight findings.\n\n\n-----\n\nAlmost immediately, indications of problems were found. In the July 1st briefing, Talos\nidentified key evidence in the logs:\n\n\n8:57:46\nAM\n\n8:59:09\nAM\n\n8:59:14\nAM\n\n9:09:20\nAM\n\n9:11:59\nAM\n\n\nusc-cert sshd[23183]: subsystem request for sftp\n\nusc-cert su: BAD SU to root on /dev/pts/0\n\nusc-cert su: to root on /dev/pts/0\n\n[emerg] 23319#0: unknown directive \"\" in /usr/local/etc/nginx/nginx.conf:3\n\n[emerg] 23376#0: location \"/\" is outside location \"\\.(ver|txt|exe|upd|rtf|cmnt)$\" in\n/usr/local/etc/nginx/nginx.conf:136\n\n\nAn unknown actor had stolen the credentials of an administrator at M.E.Doc. They logged\ninto the server, acquired root privileges and then began modifying the configuration file for\nthe NGINX web server. We were unable to recover the nginx.conf file, as it was\nsubsequently overwritten, but additional log files were important in understanding what was\nchanged. What we found were thousands of errors that looked like this:\n\n[error] 23401#0: *374685644 upstream timed out (60: Operation timed out) while\nconnecting to upstream, client: <REDACTED>, server: upd.me-doc.com.ua,\nrequest: \"GET /last.ver?rnd=1b2eb092215b49f5b1d691b5c38e3a74 HTTP/1.1\",\nupstream: \"http://176.31.182[.]167:80/last.ver?\nrnd=1b2eb092215b49f5b1d691b5c38e3a74\", host: \"upd.me-doc.com.ua\"\n\nThe NGINX server had been reconfigured so that any traffic to upd.me-doc.com.ua would be\nproxied through the update server and to a host in the OVH IP space with an IP of\n176.31.182.167. Subsequent investigation found that this server was operated by a reseller,\nthcservers.com, and that the server had been wiped the same day at 7:46 PM UTC.\n\nWhen we compare the time of the first and last upstream error messages on the server to\nour in-field endpoint telemetry, we find that they bracket the beginning and the end of the\nactive infection phase of the event. The initial log message was at 9:11:59 UTC and the last\nmessage was seen at 12:31:12 UTC. In our telemetry we see no new organizations infected\noutside of this timeframe.\n\n\n-----\n\nWe found one other piece of forensic evidence showing that the event concluded on or\naround 12:30 PM UTC. The file timestamp for nginx.conf at the time we analyzed the\nservers was Jun 27th, 12:33 PM UTC. The actor had returned the NGINX configuration to its\noriginal state at this time. There is only one other indicator to share, which was a Latvian IP\naddress that disconnected from the system at 2:11:07 PM UTC:\n\nReceived disconnect from 159.148.186.214: 11: FlowSshClientSession: disconnected\non user's request\n\nM.E.Doc confirms that neither the OVH server nor the Latvian IP address have any\nassociation with M.E.Doc.\n\nAt this point we understood that the actor in question had access to much of the network and\nmany of the systems of M.E.Doc through compromised credentials. The questions\nremaining were: What were they doing with control of the upgrade server? How were they\ndelivering the malicious software?\n\n[While we didn’t know it at the time, we can now confirm ESET’s research into the backdoor](https://www.welivesecurity.com/2017/07/04/analysis-of-telebots-cunning-backdoor/)\nthat had been inserted into the M.E.Doc software. The .net code in ZvitPublishedObjects.dll\nhad been modified on multiple occasions to allow for a malicious actor to gather data and\ndownload and execute arbitrary code:\n\nDate M.E.Doc Update Version\n\n4/14/2017 10.01.175-10.01.176\n\n5/15/2017 10.01.180-10.01.181\n\n6/22/2017 10.01.188-10.01.189\n\nLooking further back in the logs provided by M.E.Doc, we could see the same “upstream”\nactivity on June 22nd. Unfortunately, we do not have logs available for May or April, but it is\nreasonable to assume similar behavior occurs back through those dates as well.\n\n\n-----\n\n-----\n\nTimeline\n\n## ZvitPublishedObjects.dll Backdoor Analysis\n\nThe backdoor was added to the ZvitPublishedObjects.Server.UpdaterUtils.IsNewUpdate\nfunction in ZvitPublishedObjects.dll:\n\nBetween lines 278 and 279 on the left, we can see on the right that code was added to\nretrieve every organization’s EDRPOU and name. Then it creates a new MeCom object and\na thread for it which will contact http://upd.me-doc[.]com.ua/last.ver?rnd=<GUID> every 2\nminutes. It will also send any replies to this URL.\n\nIf a proxy has been configured, when the MeCom object is created at line 288 on the right, it\nproceeds to retrieve the proxy’s host, port, username and password:\n\n\n-----\n\nIt then retrieves the SMTP host, username, password and email address for every\norganization in the application’s database:\n\nIt also writes the previously collected proxy info to a registry key: HKCU\\SOFTWARE\\WC. It\nstores the proxy username and password in the “Cred” subkey and the full proxy information\nin “Prx”.\n\nAt line 294 in IsNewUpdate is a call to meCom.CreateMeainThread. The code creates a\nthread that performs the “MainAction”. This thread will continuously query the request URL\n(http://upd.me-doc[.]com.ua/last.ver?rnd=<GUID>) looking for commands and will then start\na new thread per command to execute, waiting a maximum of 10 minutes for the thread to\ncomplete. It will then send back the result of the thread to the response url, which in this case\nis the same as the request URL: http://upd.me-doc[.]com.ua/last.ver?rnd=<GUID>.\n\nThe GetCommandsAndPeriod function will retrieve the commands from the web request:\n\n\n-----\n\nWhen sending the request, it will pass along in cookies the EDRPOU and the username that\nthe program is running as. From the response, it will read the first 8 bytes as the initialization\nvector for the encryption. The rest of the data is encrypted with the TripleDes using a 24character key: \\x00 to \\x17 (i.e. characters 0 to 23). It will decrypt, decompress and\ndeserialize the commands it has to execute. It will also retrieve information on how long it\nshould wait until the next time it goes to ask for commands (this was originally set to 2\nminutes when the object was created).\n\n\n-----\n\nSendAnswer will send multiple web requests with a maximum of 2048 bytes each, with the\nresult of the executed command stored in cookies. It will encrypt this data the same way as\nthe received commands, using a random 8-byte IV and the 24-character key 0-23.\n\nThese are the encryption and decryption functions:\n\n\n-----\n\nFinally, the Worker object (see Line 372 of MainFunction) handles executing the commands.\nThere are a total of 6 commands that Worker can execute.\n\nThis appears to be the mechanism used for delivering the Nyetya malware. The command\nline arguments perfectly match what was observed in endpoint telemetry when M.E.Doc\nmachines executed the initial sample.\n\n\n-----\n\nDetail of Commands\n\n## What Now?\n\nFirst we need to put together everything we know. In the past Talos has observed an actor\nspecifically targeting Ukrainian institutions attempt to use the BlackEnergy wiper malware\nand, when that attempt was blocked, fall back to using a ransomware variant as an\n[acceptable replacement for a wiper. We’ve also already documented in our previous blog](http://blog.talosintelligence.com/2017/06/worldwide-ransomware-variant.html)\nthat “Given the circumstances of this attack, Talos assesses with high confidence that the\nintent of the actor behind Nyetya was destructive in nature and not economically motivated.”\nFinally, now that we can confirm that M.E.Doc was the installation vector, we can assess\nthat the targets for this attack were Ukraine and those organizations that chose to conduct\nbusiness with Ukraine.\n\n\n-----\n\nOur Threat Intelligence and Interdiction team is concerned that the actor in question burned\na significant capability in this attack. They have now compromised both their backdoor in the\nM.E.Doc software and their ability to manipulate the server configuration in the update\nserver.\n\nIn short, the actor has given up the ability to deliver arbitrary code to the 80% of UA\nbusinesses that use M.E.Doc as their accounting software, along with any multinational\ncorporations that leveraged the software. This is a significant loss in operational capability,\nand the Threat Intelligence and Interdiction team assesses with moderate confidence that it\nis unlikely that they would have expended this capability without confidence that they now\nhave or can easily obtain similar capability in target networks of highest priority to the threat\nactor.\n\nBased on this, Talos is advising that any organization with ties to Ukraine treat software like\nM.E.Doc and systems in Ukraine with extra caution since they have been shown to be\ntargeted by advanced threat actors. This includes providing them a separate network\narchitecture, increased monitoring and hunting activities in those at-risk systems and\nnetworks and allowing only the level of access absolutely necessary to conduct business.\nPatching and upgrades should be prioritized on these systems and customers should move\n[to transition these systems to Windows 10, following the guidance from Microsoft on](https://blogs.technet.microsoft.com/mmpc/2017/06/29/windows-10-platform-resilience-against-the-petya-ransomware-attack/)\nsecuring those systems. Additional guidance for network security baselining is available\n[from Cisco as well. Network IPS should be deployed on connections between international](https://www.cisco.com/c/en/us/td/docs/solutions/Enterprise/Security/Baseline_Security/securebasebook.html)\norganizations and their Ukrainian branches and endpoint protection should be installed\nimmediately on all Ukrainian systems.\n\nTalos places this attack in the supply-chain category. Rather than targeting organizations\ndirectly, an actor compromises trusted hardware and software vendors to deliver\ncompromised assets to a high-priority environment. We believe that these types of malicious\ncapabilities are highly desired by sophisticated actors. All vendors, regardless of size or\ngeographic region, must be increasingly vigilant. Find out more about how Cisco assures\nthe [integrity of their products here.](https://blogs.cisco.com/security/cybersecurity-the-holistic-trust-approach)\n\n[For further coverage of the Nyetya incident, please refer to our previous blog post.](http://blog.talosintelligence.com/2017/06/worldwide-ransomware-variant.html)\n\n## Indicators of Compromise\n\n**SHA256**\n\n**M.E.Doc ZvitPublishedObjects.dll files with backdoor:**\n\nf9d6fe8bd8aca6528dec7eaa9f1aafbecde15fd61668182f2ba8a7fc2b9a6740\nd462966166450416d6addd3bfdf48590f8440dd80fc571a389023b7c860ca3ac\n\n\n-----\n\n2fd2863d711a1f18eeee5c7c82f2349c5d4e00465de9789da837fcdca4d00277\n\n**Nyetya Malware:**\n\n027cc450ef5f8c5f653329641ec1fed91f694e0d229928963b30f6b0d7d3a745\n02ef73bd2458627ed7b397ec26ee2de2e92c71a0e7588f78734761d8edbdcd9f\neae9771e2eeb7ea3c6059485da39e77b8c0c369232f01334954fbac1c186c998\n\n**Malicious IP Addresses:**\n\n176.31.182[.]167\n159.148.186[.]214\n\n**AMP Coverage**\n\nW32.Ransomware.Nyetya.Talos\nW32.F9D6FE8BD8.Backdoor.Ransomware.Nyetya.Talos\nW32.D462966166.Backdoor.Ransomware.Nyetya.Talos\nW32.2FD2863D71.Backdoor.Ransomware.Nyetya.Talos\nW32.02EF73BD24-95.SBX.TG\nW32.GenericKD:Petya.20h1.1201\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-07-05 - The MeDoc Connection.pdf"
    ],
    "report_names": [
        "2017-07-05 - The MeDoc Connection.pdf"
    ],
    "threat_actors": [
        {
            "id": "7c053836-8f50-4d40-bc5c-7088967e1b57",
            "created_at": "2022-10-25T16:07:24.549525Z",
            "updated_at": "2025-03-27T02:02:10.278474Z",
            "deleted_at": null,
            "main_name": "Rocke",
            "aliases": [
                "Aged Libra",
                "Iron Group",
                "Rocke"
            ],
            "source_name": "ETDA:Rocke",
            "tools": [
                "Godlua",
                "Kerberods",
                "LSD",
                "Pro-Ocean",
                "Xbash"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "a66438a8-ebf6-4397-9ad5-ed07f93330aa",
            "created_at": "2022-10-25T16:47:55.919702Z",
            "updated_at": "2025-03-27T02:05:17.412024Z",
            "deleted_at": null,
            "main_name": "IRON VIKING",
            "aliases": [
                "ATK14 ",
                "BlackEnergy Group",
                "Blue Echidna ",
                "CTG-7263 ",
                "ELECTRUM ",
                "FROZENBARENTS ",
                "Hades/OlympicDestroyer ",
                "IRIDIUM ",
                "Qudedagh ",
                "Sandworm Team ",
                "Seashell Blizzard ",
                "TEMP.Noble ",
                "Telebots ",
                "Voodoo Bear ",
                "APT44 "
            ],
            "source_name": "Secureworks:IRON VIKING",
            "tools": [
                " BlackEnergy",
                " GCat",
                " GreyEnergy",
                " Industroyer",
                " KillDisk",
                " NotPetya",
                " PSCrypt",
                " TeleBot",
                " TeleDoor",
                " xData",
                "BadRabbit"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "b3e954e8-8bbb-46f3-84de-d6f12dc7e1a6",
            "created_at": "2022-10-25T15:50:23.339976Z",
            "updated_at": "2025-03-27T02:00:55.446795Z",
            "deleted_at": null,
            "main_name": "Sandworm Team",
            "aliases": [
                "Sandworm Team",
                "ELECTRUM",
                "Telebots",
                "IRON VIKING",
                "BlackEnergy (Group)",
                "Quedagh",
                "Voodoo Bear",
                "IRIDIUM",
                "Seashell Blizzard",
                "FROZENBARENTS",
                "APT44"
            ],
            "source_name": "MITRE:Sandworm Team",
            "tools": [
                "Bad Rabbit",
                "Mimikatz",
                "Exaramel for Linux",
                "Exaramel for Windows",
                "GreyEnergy",
                "PsExec",
                "Prestige",
                "P.A.S. Webshell",
                "VPNFilter",
                "Cyclops Blink",
                "SDelete",
                "AcidRain",
                "Industroyer",
                "Industroyer2",
                "BlackEnergy",
                "Cobalt Strike",
                "NotPetya",
                "KillDisk",
                "PoshC2",
                "Impacket",
                "Invoke-PSImage",
                "Olympic Destroyer"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "39842197-944a-49fd-9bec-eafa1807e0ea",
            "created_at": "2022-10-25T16:07:24.310589Z",
            "updated_at": "2025-03-27T02:02:10.167471Z",
            "deleted_at": null,
            "main_name": "TeleBots",
            "aliases": [],
            "source_name": "ETDA:TeleBots",
            "tools": [
                "BadRabbit",
                "Black Energy",
                "BlackEnergy",
                "CredRaptor",
                "Diskcoder.C",
                "EternalPetya",
                "ExPetr",
                "Exaramel",
                "FakeTC",
                "Felixroot",
                "GreyEnergy",
                "GreyEnergy mini",
                "KillDisk",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "NonPetya",
                "NotPetya",
                "Nyetya",
                "Petna",
                "Petrwrap",
                "Pnyetya",
                "TeleBot",
                "TeleDoor",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "nPetya"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "905eabd9-2b7f-483d-86bd-0c72f96b4162",
            "created_at": "2023-01-06T13:46:39.02749Z",
            "updated_at": "2025-03-27T02:00:02.980813Z",
            "deleted_at": null,
            "main_name": "Rocke",
            "aliases": [
                "Aged Libra"
            ],
            "source_name": "MISPGALAXY:Rocke",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "0b02af5f-2027-42b7-a6f2-51e2fd49ba7f",
            "created_at": "2022-10-25T15:50:23.360509Z",
            "updated_at": "2025-03-27T02:00:55.45329Z",
            "deleted_at": null,
            "main_name": "Rocke",
            "aliases": [
                "Rocke"
            ],
            "source_name": "MITRE:Rocke",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "8941e146-3e7f-4b4e-9b66-c2da052ee6df",
            "created_at": "2023-01-06T13:46:38.402513Z",
            "updated_at": "2025-03-27T02:00:02.824555Z",
            "deleted_at": null,
            "main_name": "Sandworm",
            "aliases": [
                "G0034",
                "IRIDIUM",
                "Blue Echidna",
                "FROZENBARENTS",
                "Seashell Blizzard",
                "IRON VIKING",
                "ELECTRUM",
                "TeleBots",
                "UAC-0113",
                "UAC-0082",
                "APT44",
                "Quedagh",
                "VOODOO BEAR",
                "TEMP.Noble"
            ],
            "source_name": "MISPGALAXY:Sandworm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535747,
    "ts_updated_at": 1743041678,
    "ts_creation_date": 1653752826,
    "ts_modification_date": 1653752826,
    "files": {
        "pdf": "https://archive.orkl.eu/384045d46c82fe701e14a358e9e17964e31b5fa7.pdf",
        "text": "https://archive.orkl.eu/384045d46c82fe701e14a358e9e17964e31b5fa7.txt",
        "img": "https://archive.orkl.eu/384045d46c82fe701e14a358e9e17964e31b5fa7.jpg"
    }
}