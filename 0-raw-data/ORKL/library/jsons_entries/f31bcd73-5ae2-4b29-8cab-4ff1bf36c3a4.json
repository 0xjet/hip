{
    "id": "f31bcd73-5ae2-4b29-8cab-4ff1bf36c3a4",
    "created_at": "2023-01-12T15:00:32.322647Z",
    "updated_at": "2025-03-27T02:16:26.363541Z",
    "deleted_at": null,
    "sha1_hash": "b7e98100bcd8db7ec87071bf279933e4e58f52a9",
    "title": "2015-04-15 - New POS Malware Emerges - Punkey",
    "authors": "",
    "file_creation_date": "2022-05-28T15:57:17Z",
    "file_modification_date": "2022-05-28T15:57:17Z",
    "file_size": 636328,
    "plain_text": "# New POS Malware Emerges - Punkey\n\n**[trustwave.com/Resources/SpiderLabs-Blog/New-POS-Malware-Emerges---Punkey/](https://www.trustwave.com/Resources/SpiderLabs-Blog/New-POS-Malware-Emerges---Punkey/)**\n\nLoading...\n\nBlogs & Stories\n\n## SpiderLabs Blog\n\nAttracting more than a half-million annual readers, this is the security community's go-to\ndestination for technical breakdowns of the latest threats, critical vulnerability disclosures\nand cutting-edge research.\n\nDuring a recent United States Secret Service investigation, Trustwave encountered a new\nfamily of POS malware, that we named Punkey. It appears to have evolved from the\nNewPOSthings family of malware first discovered by Dennis Schwarz and Dave Loftus at\n[Arbor Networks. While this malware shares some commonalities with that family, it departs](http://www.arbornetworks.com/asert/2014/09/lets-talk-about-newposthings/%20)\nfrom the standard operating procedure of the previous versions rather dramatically. In a\n[blog post, TrendMicro also detailed recently compiled versions of the NewPOSthings family](http://blog.trendmicro.com/trendlabs-security-intelligence/newposthings-has-new-pos-things/)\nthat bear a closer resemblance to NewPOSthings than Punkey. This suggests that multiple\n\n\n-----\n\nactors may be using similar source code, or the malware is being customized as a service\nfor targeted campaigns. Because of the active investigation, I cannot reveal C&C domains\nused in the samples.\n\nFor the uninitiated (or those not old enough to remember), the name is a play on the 80's\nsitcom [Punky Brewster.](http://en.wikipedia.org/wiki/Punky_Brewster)\n\n**Punkey**\n\n**Versions**\n\nPunkey self-identifies its version. Three unique versions have been discovered:\n\nThe difference between versions 18 and 19 is C&C information, and 18 and 19 are the\nprimary versions described in this blog. The 2015 version slightly alters how the version is\nreported to the C&C server and will be discussed in the appropriate section below. Unless\nspecifically noted, the description of the malware's operations should be assumed to be the\nsame across all three versions.\n\n**Overview**\n\nSince a picture is worth a thousand words, and I'm going to use about 2,000 words to\ndescribe it--does that make this blog post worth three thousand words?\n\n\n-----\n\n**Injector**\n\nThe first stage of Punkey is an injector that contains an obfuscated binary that is decoded to\ninject into another process. The injector gets a handle to the explorer process, performs the\nnecessary functions to inject a binary into another process and writes the file into its\nprocess space. If the \"-s\" argument was not provided at startup, GetModuleFileName is\nused to get the path to the current malware, and it is added to the injected process. The\ninjected process is then launched using CreateRemoteThread and the injector exits.\n\n**Startup**\n\nWhen the thread executes (stage 2), the process checks to see whether a path was\nprovided to it by the injector (remember that \"-s\" argument? No? We just talked about it?\nCome on people, keep up…). If a path is provided, the malware executes its setup:\n\n1. The injector is copied from its drop location to %USERPROFILE%\\Local\n\n_Settings\\Application Data\\jusched\\jusched exe_\n\n\n-----\n\n2. Persistence is established by adding _%USERPROFILE%\\Local Settings\\Application_\n\n_Data\\jusched\\jusched.exe –s\" to_\n_HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run key_\n\n3. The original injector is deleted\n\nIf a path is not provided, then these steps are skipped. The first run of the malware occurs\nwithout any arguments which causes the setup function to run as described above. Once\nthe malware is in place, it is ran with the \"-s\" argument, which prevents duplication of the\nsetup process.\n\nPunkey also has an embedded resource that it writes to disk as %USERPROFILE%\\Local\n_Settings\\Application Data\\jusched\\Dllx64.dll. This DLL is actually a 32-bit DLL that exports_\ntwo functions for installing and uninstalling window hooks for intercepting key presses.\n\n**C&C**\n\nNow that the environment is setup, Punkey can get down to business. A POST request is\nmade to a C&C server. An embedded list of C&C domains and/or IP addresses are\ncontacted in turn until successful communications are established. In this case it had a\ndomain and an IP in the list.\n\nThe POST requests are just information for the server, and no response is checked.\n\nIn the 2015-01-12 version this operation is changed slightly. The client sends a GET\nrequest to the C&C server first:\n\nIf the response to this is \"ok\", then a POST request is sent like the earlier versions. This is\n[not to be confused with the 200 OK received from a webserver, but an actual string \"ok\"](http://www.iana.org/assignments/http-status-codes)\nreturned by the C&C code. An odd choice to be sure.\n\nIn one sample a completely broken IP address (with an extra period at the end) was\nincluded, which prevented it from ever establishing communications. Another sample had\nan extra space at the beginning of the domain, breaking the resolution of domain. In the\n\n\n-----\n\nsecond case the backup IP address worked and the malware could communicate.\n\n**Credit Card Scanning**\n\nPrior to beginning the scanning process, Punkey sends a POST request to the C&C server.\n\nA thread is spawned to look for card holder data (CHD) data and a process blacklist is used\nto narrow down the search:\n\nsvchost.exe\niexplore.exe\nexplorer.exe\nSystem\nsmss.exe\ncsrss.exe\nwinlogon.exe\nlsass.exe\nspoolsv.exe\nalg.exe\nwuauclt.exe\n\nIt also does not scan its own process space. The other processes are not so lucky and have\ntheir process space scanned for CHD. Punkey has its very own CHD-hunting algorithm\n[(meaning it doesn't use regex), and any potential CHD is checked using the Luhn algorithm](http://en.wikipedia.org/wiki/Luhn_algorithm)\nfor validity. If the checks pass, then the data is encrypted and sent to the server. The thread\ncontinuously loops through the processes looking for more CHD.\n\n**Encryption**\n\nThe author used AES encryption with an embedded key. Like anyone will tell you, no one\nshould write their own encryption. So, like good developers, they went to the Internet to find\nsome encryption code. I know because I found the same code. Thankfully they didn't bother\n[changing a single digit of the key or the IV. The embedded keys match some example code](http://jjeong.tistory.com/752)\nand sure enough, after downloading and compiling a few changes I was successfully able\n\n\n-----\n\nto decrypt outgoing traffic. I wrote a decryption tool in Ruby that is available at Trustwave s\n[Github page. Both CHD and keylogger data are encrypted with AES and sent to the C&C](https://github.com/SpiderLabs/malware-analysis/blob/master/Ruby/Punkey/decPunkey.rb)\nserver with the \"unkey=\" POST variable. It looks like this:\n\nThis traffic is AES encrypted, base64 encoded, then URL encoded. After reversing the\nprocess the data sent looks like this (no, it's NOT a valid payment card number):\n\nThis is where the naming fun comes into play! The combination of P(OST)unkey and calling\nthe malware author a punk was just too sweet to pass up.\n\n**Update**\n\nA second thread has spawned that handles downloading arbitrary payloads from the C&C\nserver, as well as, checking for updates to Punkey itself. This gives Punkey the ability to run\nadditional tools on the system such as executing additional reconnaissance tools or\nperforming privilege escalation. This is a rare feature for POS malware.\n\nFirst, two POST requests are sent to the C&C server.\n\nNote: In the 2015-01-12 version, these POST requests are removed since they have\nalready been sent to the C&C server.\n\nA GET request is sent to the C&C server using the User-Agent: Example\n\n\n-----\n\nThere are two expected responses from the C&C server that define what happens next. A\n\"no file\" response causes the thread to sleep for 20 minutes (45 minutes in the 2015-01-12\nversion) and check again.\n\nIf the response contains \"tempurl:\", then either the C&C server has an update available, or\nan arbitrary payload needs to be executed. The response from the server looks like this:\n\nThe flags are considered set if they have a \"1\" in them. Temporary payloads are\ndownloaded to %USERPROFILE%\\Local Settings\\Application Data\\jusched\\temp.exe and\nexecuted.\n\nIf the [Delete temp flag] is set, then temp.exe will be deleted on the next loop of this thread\n(20 or 45 minutes depending on the version).\n\nIf the [Terminate self flag] is set, then the uploaddate: field must also be set. The version\ncontained in this field is compared to the hard-coded version stored in the sample. If the\nserver version is newer, then a global variable is set, the new malware is downloaded and\nexecuted, and the current malware exits. A POST is sent to the C&C server letting it know\nthe current action.\n\nHere is a table showing the available commands and actions that occur to make it all a little\nclearer:\n\n\n-----\n\nHowever, the author made a programming error here. Pointer addition is used to move\nalong the \"uploaddate:\" string, but they only added 8. My guess is that it used to say\n\"update:\" or something along those lines. This results in a comparison that looks like this:\n\nThe \"te:\" is what is left over after the first eight characters of \"uploaddate:\" are processed.\nThis comparison will always be true since ASCII 't' will always be greater than any ASCII\nnumber. Depending on how the C&C panel is setup, this could cause a repeated update\nprocess. Or more likely, the author doesn't update often and didn't notice this bug.\n\n**Keylogger**\n\nIn the section titled \"Startup\", I told you Punkey dropped the DLLx64.dll in the malware\nfolder. Well, it finally gets around to using it. The DLL is loaded into memory using\nLoadLibrary and the InstallHooks and UninstallHooks exports are loaded. The thread ID of\nthe current thread is passed to the InstallHooks export. The window message hooks are\ninstalled and any WH_KEYSTROKE message will be intercepted and sent back to this\nthread. The keylogger collects 200 characters, encrypts them with the same AES key it\nuses to encrypt CHD, and sends them back to the C&C server with a POST request.\n\n\n-----\n\nIf errors occur during the keylogger setup, Punkey can send a couple of error messages to\nthe C&C server with a POST request containing \"key=\" followed by one of the following\nerrors:\n\n\"An error occurred while loading dll file. Error Code: %lu\"\n\"An error occurred while installing keyboard hook.\"\n\n**64-Bit and Beyond!!**\n\nThe 2014-10-19 version had both a 32-bit version and a 64-bit version. With the exception\nof being compiled for different architectures, the two versions are functionally the same.\nThey're so similar in fact that the erroneous space in front of the domain was found in the\n64-bit version as well as the 32-bit version. The 64-bit version also contained an actual 64bit DLL used for keylogging.\n\n**Variant Variations**\n\nLooking into the NewPOSthings samples discussed by TrendMicro and Arbor Networks and\ncomparing them to Punkey, there is mounting evidence that multiple threads of\ndevelopment are occurring from the same code base. There are enough similarities in\nstrings, tactics, and C&C information to show a relationship between these samples.\nHowever, Punkey shows quite a departure from the commonalities shared by all the other\nvariants. The following table describes the differences in the operation of Punkey versus the\nother variants.\n\n\n-----\n\nThe glue tying all these samples together is the use of the keylogger. A very similar DLL is\ndropped by all of them in the current working directory and uses the same logic to intercept\nkeystrokes. The use of some of the same C&C information as other variants (I didn't slip up.\nThis C&C information hasn't been reported on ;)), the java theme, and a similar CHD-finding\nalgorithm throughout all the variants tie them to a very similar code base. Additionally, the\nsame process blacklist is used across variants as well.\n\n**Conclusion**\n\nFamily definitions and version identification can be a difficult process. Malware authors don't\nalways cooperate and provide distinct enough samples to easily classify exactly what\nmalware was written by whom, and what version it is. Punkey shows more than enough\nuniqueness to earn a new name, but it is clear that there is heavy development occurring\nacross different versions of a very similar code base. Attribution of the actors is less\nimportant than being able to identify the emerging threats and protecting your network data\nfrom attack.\n\nIn addition to the release of the decryption tool, you can find a YARA signature I've created\nfor detecting all three versions on disk or in memory at Trustwave's [Github page.](https://github.com/SpiderLabs/malware-analysis/tree/master/Yara/Punkey)\n\n_****UPDATE April 16, 2015****_\n\nHere are all of the hashes associated with Punkey that we've discovered:\n\n**32-bit Punkey**\n\n1dd9e1e661070c0d90faeef75d5a487641a4bfb99c58841827ee5b97e6315eaf\n0a33332d200e52875c00ea98417b71621b77a9dc291e6a3bdbd69569aac670cf\ne0c4696093c71a8bbcd2aef357afca6c7b7fbfe787406f6797636a67ae9b975d\n\n**64-bit Punkey**\n\n6c7a26ac738c940cdce1e0fcbd9995994ce19332ea444c4ea87de52d2fe9713b\n\n\n-----\n\n**32-bit Dropped DLLs**\n\ne06f57b984d52153d28bdf9e2629feb16e2dbdea617702fb3397c959ee70ed68\n04678de7a93ca1fd7fc7eba1672ec04c9855160b4cace440cfcd3c66d8543026\n\n**64-bit Dropped DLL**\n\n5ce1e0f1883d13561f9a1cef321db13c4fefddf4fed1d40e7e31f3b04595f527\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-04-15 - New POS Malware Emerges - Punkey.pdf"
    ],
    "report_names": [
        "2015-04-15 - New POS Malware Emerges - Punkey.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535632,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653753437,
    "ts_modification_date": 1653753437,
    "files": {
        "pdf": "https://archive.orkl.eu/b7e98100bcd8db7ec87071bf279933e4e58f52a9.pdf",
        "text": "https://archive.orkl.eu/b7e98100bcd8db7ec87071bf279933e4e58f52a9.txt",
        "img": "https://archive.orkl.eu/b7e98100bcd8db7ec87071bf279933e4e58f52a9.jpg"
    }
}