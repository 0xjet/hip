{
    "id": "be46954d-f7ac-41fe-ad7c-9257f5d04177",
    "created_at": "2023-01-12T15:01:51.007378Z",
    "updated_at": "2025-03-27T02:05:53.172031Z",
    "deleted_at": null,
    "sha1_hash": "b55e1a32f5dfe73aee0f44cb3b25553df6656a64",
    "title": "2011-07-08 - Trojan.Mayachok.2- анализ первого известного VBR-буткита",
    "authors": "",
    "file_creation_date": "2022-05-29T01:24:53Z",
    "file_modification_date": "2022-05-29T01:24:53Z",
    "file_size": 397073,
    "plain_text": "# Trojan.Mayachok.2: анализ первого известного VBR- буткита\n\n**news.drweb.ru/**\n\nDoctor Web\n\n[Назад к списку новостей](https://news.drweb.ru/list/?p=0&lng=ru&c=23)\n\n**8 июля 2011 года**\n\n**В процессе изучения статистики появившихся за последнее время угроз**\n**складывается впечатление, что модификация загрузочной записи в процессе**\n**инфицирования — новое модное веяние среди разработчиков вредоносного ПО.**\n**Особое место среди подобных программ занимает троянец Trojan.Mayachok.2,**\n**инфицирующий Volume Boot Record и нарушающий работу популярных**\n**браузеров.**\n\n### Заражение системы\n\nПеред началом атаки на инфицируемый компьютер дроппер вредоносной программы\nпроверяет зараженность системы. Для этого на основе серийного номера системного\nраздела генерируется CLSID и проверяется его наличие в системном реестре: если в\nветке HKLM\\Software\\Classes\\CLSID отсутствует соответствующий раздел, то\nзаражение продолжается.\n\n\n-----\n\nВ операционных системах Windows Vista и Windows 7 троянец пытается повысить\nсобственные права. Этот весьма примитивный способ уже не раз использовался\nдругими вредоносными программами: постоянный перезапуск самой себя с запросом\nна повышение привилегий. Опытный пользователь с легкостью может завершить такой\nназойливый процесс в «Диспетчере задач».\n\n_Завершение троянского процесса через «Диспетчер задач»_\nДроппер несет в себе как 32-битный, так и 64-битный драйвер, в будущем способный\nобеспечить загрузку основного функционала данной вредоносной программы. На диске\nсохраняется соответствующий драйвер в зависимости от разрядности\nпользовательской операционной системы. Он может быть записан как в начало диска\n(до первого активного раздела), если там достаточно места, так и в его конец.\nНесложно заметить, что в логике троянца присутствует ошибка: так, например, если\nзагрузочным разделом окажется не первый, то троянский драйвер может перезаписать\nслучайные данные любого раздела до загрузочного, т. к. позиция для записи\nвыбирается случайно в пределах свободных (как считает троянец) секторов.\n\n\n-----\n\nТолько после этого начинается заражение VBR (Volume Boot Record). Вредоносная\nпрограмма отказывается от заражения, если файловая система раздела имеет формат,\nотличный от NTFS. Анализируя загрузочную запись, троянец находит удобное место\nдля своего размещения и перезаписывает имеющийся там код. Оригинальный код\n[упаковывается при помощи библиотеки aplib (http://www.ibsensoftware.com) и](http://www.ibsensoftware.com/)\nдописывается следом за вирусным. Номер начального сектора размещенного ранее на\nдиске драйвера и его размер также «прошиваются» в тело зараженной VBR.\n\nЗдесь следует еще раз сказать о необычности механизма заражения. Вирусы,\nмодифицирующие MBR (Master Boot Record) и BOOT-секторы, известны еще со времен\nDOS, в то время как современные ОС предоставляют новые возможности, в том числе\nи для вирусописателей. В рассматриваемом нами случае BOOT-сектор является\nпервым сектором VBR, который, например, для раздела NTFS занимает 16 секторов.\nТаким образом, классическая проверка только загрузочного сектора не может\nобнаружить вредоносный объект, т. к. он располагается дальше — внутри VBR.\n\nПосле заражения системы Trojan.Mayachok.2 сбрасывает на диск небольшое\nприложение, предназначенное для автоматической перезагрузки системы. Стоит\nотметить, что аналогичным образом ведет себя и другой буткит — Trojan.Hashish. В\nзавершение своей работы троянец пытается «замести следы» и удалить себя.\n\n### Запуск из VBR\n\n_Сравнение первых секторов VBR чистой и зараженной системы, красным показаны_\n_различия — код вирусного загрузчика_\nПолучив управление, вирусный загрузчик действует по классической для MBR/BOOTвирусов схеме. «Откусывает» себе небольшой кусок системной памяти, переносит\nсебя туда и перехватывает прерывание int 13h для просмотра содержимого\n\n\n-----\n\nсчитываемых с диска секторов. Затем он целиком загружает с диска свой драйвер и\nраспаковывает на прежнее место оригинальный код VBR. Управление возвращается\nсистемному загрузчику.\n\nДалее идет череда снятий/установок перехватов в загружаемых модулях, таких как\nntldr, bootmgr, osloader.exe, winload.exe и т. д., в зависимости от используемого\nоперационной системой загрузчика. Следует отметить, что помимо обычных\nперехватов (сплайсинга) в ключевых мостах используются аппаратные отладочные\nрегистры (dr0-dr7) и трассировка (пошаговое исполнение) кода. Это придает\nуниверсальность троянцу и одновременно является естественным способом обхода\nзащиты целостности некоторых загрузочных модулей. В итоге в области памяти\nрежима ядра (kernelmode memory) оказывается загруженный и готовый к работе\nвирусный драйвер.\n\n### Драйвер загрузчика\n\nТочка выхода вирусного драйвера вызывается дважды. Это связано с тесной работой\nзараженного VBR и драйвера. Поскольку код вирусного VBR составляет всего 2078\nбайт, часть функционала авторы решили перенести в тело драйвера. При первом\nвызове он добавляет себя в списки из LOADER_PARAMETER_BLOCK: в\n**LoadOrderList как копия первого модуля в списке (а это ядро ОС) и в BootDriverList**\nкак загрузочный драйвер, якобы прописанный в\n**\\Registry\\Machine\\System\\CurrentControlSet\\Services\\null. Таким образом,**\nвредоносная программа имитирует свою загрузку в качестве обычного boot-драйвера.\n\nВторой раз драйвер вызывается операционной системой, которая уверена, что сама\nзагрузила его. Данные манипуляции приводят к некоторым побочным эффектам.\n\nНапример, в системе появляется драйвер Null, но при более внимательном\nрассмотрении оказывается, что он был создан ядром (ntoskrnl.exe).\n\n\n-----\n\nВ то же время среди загруженных модулей есть еще одно «ядро», в котором\nпараметры DllBase и SizeOfImage принадлежат вредоносному драйверу.\n\nВ качестве экспресс-проверки системы на наличие или отсутствие заражения можно\nиспользовать простую команду «echo hello >nul», которая на неинфицированной\nсистеме успешно выполняется, а на зараженной выдает сообщение об ошибке.\n\nЗадачей драйвера является инжект (внедерение) своего кода в запущенные процессы.\n\n\n-----\n\n_64-битный драйвер, красным выделены динамические библиотеки, которые_\n_упакованы aplib_\nВнедрение кода осуществляется обычной установкой нотификаций через функции\nPsCreateProcessNotifyRoutine и PsCreateProcessNotifyRoutine с последующим вызовом\nасинхронной функции через механизм APC. В процессе исследования выяснилось, что\n64-битный драйвер несет «на борту» две библиотеки. При этом полезная нагрузка\nнаходится только в одной из них, а вторая, по всей видимости, является «заделом на\nбудущее».\n\n_32-битный драйвер, который осуществляет заброс шелл-кода в процессы_\nВ остальном же драйвер не представляет особого интереса. На сегодняшний день\nиспользуемый Trojan.Mayachok.2 механизм заражения является уникальным среди\nизвестных угроз. Специалисты компании «Доктор Веб» предполагают, что в недалеком\nбудущем стоит ожидать использования подобной техники заражения другими\nвредоносными программами.\n\nЧтобы проголосовать надо войти на страницу новости через аккаунт на сайте «Доктор\nВеб» (или [создать аккаунт). Аккаунт должен быть](https://f2.drweb.com/lr/?to=https%3A%2F%2Fwww.drweb.ru%2Fuser%2Fregistration%2F%3Ffrom%3Dnews) [связан с вашим аккаунтом в](https://www.drweb.ru/user/social/)\nсоциальной сети для наград за активности в них. [Видео о связывании аккаунта](https://f2.drweb.com/lr/?to=https%3A%2F%2Fsupport.drweb.ru%2Fvideo%2F%3Ffrom%3Dnews)\n\n[В чем преимущества аккаунта? |](https://www.drweb.ru/user/advantages/) [Как зарабатывать Dr.Web-ки?](https://www.drweb.ru/user/how_win/)\n\n### Поделитесь информацией с вашими друзьями в социальных сетях\n\n## Нам важно Ваше мнение\n\nКомментарии размещаются после проверки модератором. Чтобы задать вопрос по\nновости администрации сайта, укажите в начале своего комментария @admin. Если\nваш вопрос к автору одного из комментариев — поставьте перед его именем @\n\n\n-----\n\n### Другие комментарии\n\n\n-----",
    "language": "RU",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2011/2011-07-08 - Trojan.Mayachok.2- анализ первого известного VBR-буткита.pdf"
    ],
    "report_names": [
        "2011-07-08 - Trojan.Mayachok.2- анализ первого известного VBR-буткита.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535711,
    "ts_updated_at": 1743041153,
    "ts_creation_date": 1653787493,
    "ts_modification_date": 1653787493,
    "files": {
        "pdf": "https://archive.orkl.eu/b55e1a32f5dfe73aee0f44cb3b25553df6656a64.pdf",
        "text": "https://archive.orkl.eu/b55e1a32f5dfe73aee0f44cb3b25553df6656a64.txt",
        "img": "https://archive.orkl.eu/b55e1a32f5dfe73aee0f44cb3b25553df6656a64.jpg"
    }
}