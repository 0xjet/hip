{
    "id": "39564606-8168-4234-becd-e87e7f6936be",
    "created_at": "2023-01-12T15:08:38.612016Z",
    "updated_at": "2025-03-27T02:15:46.253104Z",
    "deleted_at": null,
    "sha1_hash": "d30ec77578da682f37c442ef44c5a8142e6e7c4b",
    "title": "2021-10-12 - MysterySnail attacks with Windows zero-day",
    "authors": "",
    "file_creation_date": "2022-05-28T05:09:50Z",
    "file_modification_date": "2022-05-28T05:09:50Z",
    "file_size": 304626,
    "plain_text": "# MysterySnail attacks with Windows zero-day\n\n**[securelist.com/mysterysnail-attacks-with-windows-zero-day/104509/](https://securelist.com/mysterysnail-attacks-with-windows-zero-day/104509/)**\n\nAuthors\n\nBoris Larin\n\n[Costin Raiu](https://securelist.com/author/costin/)\n\n## Executive Summary\n\nIn late August and early September 2021, Kaspersky technologies detected attacks with the\nuse of an elevation of privilege exploit on multiple Microsoft Windows servers. The exploit\nhad numerous debug strings from an older, publicly known exploit for vulnerability CVE2016-3309, but closer analysis revealed that it was a zero-day. We discovered that it was\nusing a previously unknown vulnerability in the Win32k driver and exploitation relies heavily\non a technique to leak the base addresses of kernel modules. We promptly reported these\nfindings to Microsoft. The information disclosure portion of the exploit chain was identified as\nnot bypassing a security boundary, and was therefore not fixed. Microsoft assigned CVE2021-40449 to the use-after-free vulnerability in the Win32k kernel driver and it was patched\non October 12, 2021, as a part of the October Patch Tuesday.\n\n\n-----\n\nBesides finding the zero-day in the wild, we analyzed the malware payload used along with\nthe zero-day exploit, and found that variants of the malware were detected in widespread\nespionage campaigns against IT companies, military/defense contractors, and diplomatic\nentities.\n\nWe are calling this cluster of activity MysterySnail. Code similarity and re-use of C2\ninfrastructure we discovered allowed us to connect these attacks with the actor known as\nIronHusky and Chinese-speaking APT activity dating back to 2012.\n\n## Elevation of privilege exploit\n\nThe discovered exploit is written to support the following Windows products:\n\nMicrosoft Windows Vista\nMicrosoft Windows 7\nMicrosoft Windows 8\nMicrosoft Windows 8.1\nMicrosoft Windows Server 2008\nMicrosoft Windows Server 2008 R2\nMicrosoft Windows Server 2012\nMicrosoft Windows Server 2012 R2\nMicrosoft Windows 10 (build 14393)\nMicrosoft Windows Server 2016 (build 14393)\nMicrosoft Windows 10 (build 17763)\nMicrosoft Windows Server 2019 (build 17763)\n\nThe list of supported products and supported Windows 10 build numbers, explicit declaration\nof server OSs and the fact that exploits were only discovered in attacks on servers, all lead\nus to believe the exploit was developed and advertised as a solution to elevate privileges on\nservers.\n\nCVE-2021-40449 is a use-after-free vulnerability in Win32k’s NtGdiResetDC function. As\nwith many other Win32k vulnerabilities, the root cause of this vulnerability lies in the ability to\nset user-mode callbacks and execute unexpected API functions during execution of those\ncallbacks. The CVE-2021-40449 is triggered when the function ResetDC is executed a\nsecond time for the same handle during execution of its own callback. The exploitation\nprocess for this vulnerability is as follows:\n\n1. A user-mode call to ResetDC executes syscall NtGdiResetDC and its inner function\n\nGreResetDCInternal. This function gets a pointer to a PDC object, and then performs a\ncall to function hdcOpenDCW.\n2. Function hdcOpenDCW performs a user-mode callback and it can be used to execute\n\nResetDC for the same handle a second time.\n\n\n-----\n\n3. If an exploit executes ResetDC during a callback, NtGdiResetDC and\n\nGreResetDCInternal are executed again for the same DC.\n4. If an exploit ignores all the callbacks during the second call to GreResetDCInternal, this\n\nfunction will be executed as intended. It will create a new DC and get rid of the old one\n(the PDC object is destroyed).\n5. In the callback, after the second ResetDC call has completed, the exploit can reclaim\n\nthe freed memory of the PDC object and finish the execution of the callback.\n6. After execution of the callback, function hdcOpenDCW returns to GreResetDCInternal,\n\nbut the pointer retrieved in step (1) is now a dangling pointer – it points to the memory\nof the previously destroyed PDC object.\n7. In the late stage of GreResetDCInternal execution, a malformed PDC object can be\n\nused to perform a call to an arbitrary kernel function with controlled parameters.\n\nIn the discovered exploit attackers are able to achieve the desired state of memory with the\nuse of GDI palette objects and use a single call to a kernel function to build a primitive for\nreading and writing kernel memory. This step is easily accomplished, because the exploit\nprocess is running with Medium IL and therefore it’s possible to use publicly known\ntechniques to leak kernel addresses of currently loaded drivers/kernel modules. In our\nopinion, it would be preferable if the Medium IL processes had limited access to such\n[functions as NtQuerySystemInformation or EnumDeviceDrivers.](https://securelist.com/the-zero-day-exploits-of-operation-wizardopium/97086/)\n\n## MysterySnail RAT\n\nOur deep dive into the MysterySnail RAT family started with an analysis of a previously\nunknown remote shell-type Trojan that was intended to be executed by an elevation of\n[privilege exploit. The sample which we analyzed was also uploaded to VT on August 10,](https://www.virustotal.com/gui/file/b7fb3623e31fb36fc3d3a4d99829e42910cad4da4fa7429a2d99a838e004366e)\n2021. The sample is very big – 8.29MB. One of the reasons for the file size is that it’s\nstatically compiled with the OpenSSL library and contains unused code and data belonging\nto that library. But the main reason for its size is the presence of two very large functions that\ndo nothing but waste processor clock cycles. These functions also “use” randomly generated\nstrings that are also present in a binary.\n\n\n-----\n\n**_Random strings used by anti-analysis functions_**\n\nWe assume these two functions are used as an AV-evasion technique for the purpose of\nanti-emulation. This theory is supported by the presence of other redundant logics and the\npresence of a relatively large number of exported functions while the real work is performed\nby only one of them.\n\n**_Names of exported functions; the actual business logic is executed from function_**\n**_“GetInfo”_**\n\nThe sample has two hardcoded URLs present in plain text – “www[.]disktest[.]com” and\n“www[.]runblerx[.]com”. They are put into class variables for intended use, but remain\nunused; the real C2 address is decoded by a single byte xor – “http[.]ddspadus[.]com”.\n\nThe malware enumerates the values under the\n“Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ProxyServer” registry key and\nuses them to request tunneling through a proxy server in case it fails to connect to the C2\ndirectly.\n\nThe malware itself is not very sophisticated and has functionality similar to many other\nremote shells. But it still somehow stands out, with a relatively large number of implemented\ncommands and extra capabilities like monitoring for inserted disk drives and the ability to act\nas a proxy.\n\nInbound and outbound commands have the same binary-based format that is provided\nbelow. All communication is encrypted with SSL.\n\n**Offset** **Description**\n\n0 Size of additional data\n\n\n-----\n\n4 Session ID\n\n8 Command ID\n\n0xC Additional data\n\n**_Format of communication commands_**\n\nBefore receiving any commands, the malware gathers and sends general information about\nthe victim machine. This information includes:\n\nComputer name\nCurrent OEM code-page/default identifier\nWindows product name\nLocal IP address\nLogged-in user name\nCampaign name\n\nOne interesting fact is that “Campaign name” by default is set to “windows”. This name gets\noverwritten, but it might indicate there are versions of the same RAT compiled for other\nplatforms.\n\nIn total, the RAT implements 20 commands. Their description and command IDs are\nprovided in the table below.\n\n\n**Command**\n**ID**\n\n\n**Description**\n\n\n1F4h Launch interactive cmd.exe shell. Before launch cmd.exe is copied to the\ntemp folder with a different name\n\n1F5h Spawn new process\n\n1F6h Spawn new process (console)\n\n1F7h Get existing disk drives and their type. This function also works in the\nbackground, checking for new drives\n\n1F8h Create (upload) new file. If a file exists, append data to it\n\n1FAh Get directory list\n\n1FBh Kill arbitrary process\n\n1FFh Delete file\n\n202h Read file. If the file is too big, async read operation can be stopped with cmd\n20Ch.\n\n\n-----\n\n205h Re-connect\n\n208h Set sleep time (in ms)\n\n209h Shutdown network and exit\n\n20Ah Exit\n\n20Bh Kill interactive shell (created with cmd 1F4h)\n\n20Ch Terminate file reading operation (started with cmd 202h)\n\n217h No operation\n\n21Bh Open proxy’ed connection to provided host. Up to 50 simultaneous\nconnections are supported.\n\n21Ch Send data to proxy’ed connection\n\n21Eh Close all proxy connections\n\n21Fh Close requested proxy connection\n\n**_List of commands supported by the RAT_**\n\nThe analysis of the MysterySnail RAT helped us discover campaigns using other variants of\nthe analyzed malware as well as study and document the code changes made to this tool\nover a six-month period. We provide more info about these variants and campaigns in our\nprivate report.\n\nWith the help of Kaspersky Threat Attribution Engine (KTAE) and the discovery of early\nvariants of MysterySnail RAT we were able to find direct code and functionality overlap with\nthe malware attributed to the IronHusky actor. We were also able to discover the re-use of\nC2 addresses used in attacks by the Chinese-speaking APT as far back as 2012. This\ndiscovery links IronHusky to some of the older known activities.\n\nKaspersky products detect the CVE-2021-40449 exploit and related malware with the\nverdicts:\n\nPDM:Exploit.Win32.Generic\nPDM:Trojan.Win32.Generic\nTrojan.Win64.Agent*\n\nKaspersky products detected these attacks with the help of the Behavioral Detection Engine\nand the Exploit Prevention component. CVE-2021-40449 is the latest addition to the long list\nof zero-days discovered in the wild with the help of our technologies. We will continue to\nimprove defenses for our users by enhancing technologies and working with third-party\nvendors to patch vulnerabilities, making the internet more secure for everyone.\n\n\n-----\n\nMore information about these attacks and the actor behind them is available to customers of\n[the Kaspersky Intelligence Reporting service. Contact: intelreports@kaspersky.com.](http://10.10.0.46/mailto:intelreports@kaspersky.com)\n\n_Kaspersky would like to thank Microsoft for their prompt analysis of the report and patches._\n\n## IoCs\n\nwww[.]disktest[.]com\n\nwww[.]runblerx[.]com\n\nhttp[.]ddspadus[.]com\n\nMD5 [e2f2d2832da0facbd716d6ad298073ca](https://opentip.kaspersky.com/e2f2d2832da0facbd716d6ad298073ca/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\nSHA1 [ecdec44d3ce31532d9831b139ea04bf48cde9090](https://opentip.kaspersky.com/ecdec44d3ce31532d9831b139ea04bf48cde9090/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\nSHA256 [b7fb3623e31fb36fc3d3a4d99829e42910cad4da4fa7429a2d99a838e004366e](https://opentip.kaspersky.com/b7fb3623e31fb36fc3d3a4d99829e42910cad4da4fa7429a2d99a838e004366e/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\n[APT](https://securelist.com/tag/apt/)\n[Malware Descriptions](https://securelist.com/tag/malware-descriptions/)\n[Microsoft Windows](https://securelist.com/tag/microsoft-windows/)\n[RAT Trojan](https://securelist.com/tag/rat-trojan/)\n[Targeted attacks](https://securelist.com/tag/targeted-attacks/)\n[Vulnerabilities and exploits](https://securelist.com/tag/vulnerabilities-and-exploits/)\n[Zero-day vulnerabilities](https://securelist.com/tag/zero-day-vulnerabilities/)\n\nAuthors\n\nBoris Larin\n\n[Costin Raiu](https://securelist.com/author/costin/)\n\nMysterySnail attacks with Windows zero-day\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-12 - MysterySnail attacks with Windows zero-day.pdf"
    ],
    "report_names": [
        "2021-10-12 - MysterySnail attacks with Windows zero-day.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "2008a79d-2f3a-475f-abef-3bc119a1bf38",
            "created_at": "2022-10-25T16:07:24.028651Z",
            "updated_at": "2025-03-27T02:02:10.084983Z",
            "deleted_at": null,
            "main_name": "Operation WizardOpium",
            "aliases": [],
            "source_name": "ETDA:Operation WizardOpium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5cd3fcb0-eb56-49ac-8125-47ebee93311d",
            "created_at": "2023-01-06T13:46:39.065814Z",
            "updated_at": "2025-03-27T02:00:02.988828Z",
            "deleted_at": null,
            "main_name": "Operation WizardOpium",
            "aliases": [],
            "source_name": "MISPGALAXY:Operation WizardOpium",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d06cd44b-3efe-47dc-bb7c-a7b091c02938",
            "created_at": "2023-11-08T02:00:07.135638Z",
            "updated_at": "2025-03-27T02:00:03.193635Z",
            "deleted_at": null,
            "main_name": "IronHusky",
            "aliases": [],
            "source_name": "MISPGALAXY:IronHusky",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2caf4672-1812-4bb9-9576-6011e56102d2",
            "created_at": "2022-10-25T16:07:23.742765Z",
            "updated_at": "2025-03-27T02:02:09.957037Z",
            "deleted_at": null,
            "main_name": "IronHusky",
            "aliases": [
                "BBCY-TA1",
                "Operation MysterySnail"
            ],
            "source_name": "ETDA:IronHusky",
            "tools": [
                "Agent.dhwf",
                "Chymine",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Gen:Trojan.Heur.PT",
                "Kaba",
                "Korplug",
                "MysterySnail",
                "MysterySnail RAT",
                "PlugX",
                "Poison Ivy",
                "RedDelta",
                "SPIVY",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Xamtrav",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536118,
    "ts_updated_at": 1743041746,
    "ts_creation_date": 1653714590,
    "ts_modification_date": 1653714590,
    "files": {
        "pdf": "https://archive.orkl.eu/d30ec77578da682f37c442ef44c5a8142e6e7c4b.pdf",
        "text": "https://archive.orkl.eu/d30ec77578da682f37c442ef44c5a8142e6e7c4b.txt",
        "img": "https://archive.orkl.eu/d30ec77578da682f37c442ef44c5a8142e6e7c4b.jpg"
    }
}