{
    "id": "de90b2cf-e236-4519-8866-db4e4bdfa02c",
    "created_at": "2023-01-12T15:10:36.538277Z",
    "updated_at": "2025-03-27T02:16:25.786503Z",
    "deleted_at": null,
    "sha1_hash": "ab5f56f6f7defcc9cbe4fb131591816a07aea31f",
    "title": "2021-11-10 - REvil Under the Microscope",
    "authors": "",
    "file_creation_date": "2022-05-28T19:52:20Z",
    "file_modification_date": "2022-05-28T19:52:20Z",
    "file_size": 3748837,
    "plain_text": "# REvil Under the Microscope\n\n**[blogs.blackberry.com/en/2021/11/revil-under-the-microscope](https://blogs.blackberry.com/en/2021/11/revil-under-the-microscope)**\n\nCodi Starks, Ryan Chapman\n\n### Summary\n\n[U.S. and European law enforcement agencies revealed new seizures and](https://www.theverge.com/2021/11/8/22770701/revil-ransomware-arrest-kaseya-crypto-europol-cybersecurity) [arrests this week](https://threatpost.com/revil-affiliates-arrested-doj-europol/176087/)\ninvolving the REvil ransomware group, underscoring the intense interest and outrage\nfollowing in the wake of these malicious campaigns. These developments also highlight the\nimmediate need for security professionals to fully understand the inner workings of this\ngroup and the associated malware family, to better protect their organizations and\nstakeholders. This blog dives deep into REvil's latest tactics, techniques, and procedures\n(TTPs), drawing insights from a recent incident handled by the BlackBerry Incident\nResponse Team.\n\n### Gootkit\n\nREvil is notorious for using “watering hole” attacks to gain initial access into networks. This\nis accomplished by compromising a website that the group expects will be visited by a\n[target group. In this case, the REvil group posted a ZIP archive containing a Gootkit loader](https://blogs.blackberry.com/en/2020/04/threat-spotlight-gootkit-banking-trojan)\non a compromised website disguised as an informational page containing a description of a\n\n\n-----\n\nsearch term popular among its intended victims. Upon accessing the compromised site,\nusers were redirected to hxxps://fibarokrakow[.]com/about[.]php, initiating the download of\nthe Gootkit loader ZIP file. Once opened, the ZIP file initiated a JavaScript payload via\nwscript.exe.\n\nFollowing execution of the Gootkit loader, the final deobfuscated code snippet performs the\nfollowing actions:\n\n1. Loops through an array of three domains\n2. For each domain, generates a random string to be used as part of a download URL\n3. Performs an HTTP GET request to each domain, using a format string including a\n\n“search.php” endpoint, a static value (redacted here), and the randomly generated\nnumber\n4. Checks the GET request response for a 200 (“OK”) value\n5. If the GET request was successful, the downloaded content is then executed as\n\nadditional code\n\nA full analysis of the Gootkit loader and additional actions taken following its execution are\nincluded below.\n\nInitially the JavaScript file contained obfuscated code within a variable labeled “knew”:\n\n_Figure 1: Gootkit loader obfuscated Javascript_\n\nJavaScript formatting tools such as JSTool and js-beautify make the code more legible, as\nexemplified by lines 47-72 of the “beautified” code:\n\n\n-----\n\n_Figure 2: Gootkit loader beautified code_\n\nThe code kicks off with a call to summer (9754), which passes an unused integer to the\n**summer ( ) function. This function simply calls round (9102):**\n\n_Figure 3: Gootkit loader summer function_\n\nAfter sleeping just shy of 65 seconds, the round ( ) function implements a while loop that is\nused to call other functions within the code. For example, when first run, the variable race is\nset to 5647, which is then used in a try/catch block implemented within the loop. This loop\nnot only takes time to run, but is used to feed new values into the electric array in order to\nexecute the next function:\n\n\n-----\n\n_Figure 4: Gootkit loader round function_\n\nIn the first invocation of round, the electric [ ] array is checked to see if the current value of\nthe array position (the value in race) equals a valid function to run. If not, the catch\nstatement kicks in and sets a much larger integer position in the electric array to equal\nanother function: indicate. This means that the loop will execute 2842404 - 5647 =\n2,836,757 times before eventually calling the indicate ( ) function, which looks like this:\n\n_Figure 5: Gootkit loader indicate function_\n\n\n-----\n\nNotice the setting of electric [4438089] = third, which sets the next function to run after\nreturning to the calling while loop. In this fashion, we find multiple assignments of functions\nto various array positions within the electric [ ] array. After another attempted sleep\n(commented out above), the indicate function sets the knew variable, which is later\ndecoded.\n\nTo avoid the consistent iterations of the while loop and speed up analysis, the round ( )\nfunction can be modified to make its calls directly, rather than waiting for the loop to\ncontinue incrementing the race value as such:\n\n_Figure 6: Gootkit loader modified round function_\n\nDecoding of the knew variable occurs within the third function called from this location,\nwhich is million ( ):\n\n_Figure 7: Gootkit loader decoding the knew variable_\n\nThe play ( ) function is called with two arguments: The return value of a call to multiply\n**(knew), along with a static string labeled above, as seen in Figure 7. Once this returns, the**\n**stead value is an array that includes the string “constructor” at index 0 and the following**\ncode (already beautified for review purposes) at index 1:\n\n\n-----\n\n_Figure 8: Gootkit loader stead array_\n\nAbove we can see an important host-based Indicator of Compromise (IoC) for the loader, a\nregistry key:\n\nHKCU\\\\Oifmb\n\nIf this key does not exist, it is created. Next, we see another set of obfuscated code that is\ndecoded via a call to multiply ( ). By setting a breakpoint on the return for the multiply ( )\nfunction, we see the final bit of deobfuscated code:\n\n\n-----\n\n_Figure 9: Gootkit loader deobfuscated code_\n\nWhile the general layout of the loader was analyzed, BlackBerry was unable to obtain a\ncopy of the exact JavaScript that would have been downloaded in this particular example of\nthe final phase. Threat intelligence was used to find similar code, but the exact code was\nunavailable.\n\n### BloodHound and Kerberoasting\n\nFollowing the Gootkit installation, REvil didn’t immediately make use of the persistent\naccess to this system. Instead, the group waited three days before connecting and\nbeginning the initial enumeration. The first hands-on-keyboard activity related to the threat\nactor was a BloodHound output file within the infected user’s profile directory, named\n**<date_time>_BloodHound [.] zip, where <date_time> was the time the data was**\ncaptured.\n\nBlackBerry researchers retrieved a copy of the BloodHound output file and began\nenumerating attack paths that the threat actor may have abused. A path to Domain Admin\n[was found via three “Kerberoastable” accounts. The attack paths looked similar to the](https://github.com/nidem/kerberoast)\nfollowing:\n\n\n-----\n\n_Figure 10: BloodHound Kerberoasting attack path_\n\nThe REvil group used their apparent knowledge of this attack path to Kerberoast three of\nthe accounts to retrieve their plain text credentials. Windows Event logs were unavailable\nduring the timeframe of the incident to allow for identification of the Kerberoasting activity,\nalthough the REvil group left a text file on disk containing the Kerberos Ticket Granting\nService (TGS) tickets for the three accounts assigned Service Principal Names (SPNs). The\ncontents of the file looked similar to the following:\n\n_Figure 11: Kerberos TGS ticket_\n\nBlackBerry determined that the TGS tickets could easily be cracked using the password\n[cracking software tool John the Ripper to retrieve the plain text password. These accounts](https://en.wikipedia.org/wiki/John_the_Ripper)\nwere later used by the threat actor to move laterally and install additional persistence\n\n\n-----\n\nmechanisms.\n\n_Figure 12: TGS ticket cracking_\n\n### Lateral Movement and Enumeration\n\nAfter gaining access to multiple highly privileged accounts, the threat actor began pivoting\nto other hosts on the network via Remote Desktop Protocol (RDP). From there, the PsExec\ntool was also used to pivot to other hosts to shut down Windows Defender services.\n\nBlackBerry also discovered the Mimikatz utility used to “pass the hash” for additional\ncompromised accounts. This method was used to gain an RDP session on remote hosts\nusing the NTLM hash of the compromised user account(s). While Windows does not\ntraditionally use NTLM hashes for RDP authentication, the “restrictedadmin” argument\nforces RDP to pre-authenticate with an NTLM hash, presenting a pass-the-hash\nvulnerability.\n\n\n-----\n\nPrior to executing the RDP pass the hash technique, the threat actor staged the remote\nsystem by enabling the restrictedadmin feature via a registry edit through PsExec.\n\nLastly, the Advanced IP Scanner utility was executed on multiple systems to map out\nnetwork systems that the actor had access to. The Advanced IP Scanner utility is frequently\nabused by ransomware groups and can provide a good indicator of compromise if the tool\nis not used legitimately within an environment.\n\n### Command-and-Control\n\n[The threat actor utilized two methods of installing Cobalt Strike command-and-control (C2)](https://blogs.blackberry.com/en/2021/10/blackberry-shines-spotlight-on-evolving-cobalt-strike-threat-in-new-book)\nwithin memory. The first and simplest method was utilizing a simple encoded PowerShell\ncommand to execute a Cobalt Strike stager. Below is a snippet from the discovered Cobalt\nStrike stager:\n\n_Figure 13: Encoded Cobalt Strike stager_\n\nA memory image was taken for further identification of injected processes. Using the\nvolatility “malfind” function, BlackBerry determined that two separate “rundll32.exe”\nprocesses contained injected Windows PE files, as seen in the images below.\n\n_Figure 14: RunDLL32 process injection - PID 2884_\n\n\n-----\n\n_Figure 15: RunDLL32 process injection - PID 4736_\n\nBlackBerry extracted the two executable files and determined that they were Cobalt Strike\nBeacons, configured to reach out to the following two IPs:\n\n139.180.172[.]42\n155.138.216[.]60\n\n### Command-and-Control – Registry Cradle\n\nThe BlackBerry Incident Response Team also discovered a PowerShell command used to\nstage Cobalt Strike within the registry key:\n**HKLM:\\SOFTWARE\\Microsoft\\PowerShell\\info. The threat actor ran the PowerShell via a**\nremote service which executed the following:\n\nBlackBerry was able to retrieve a portion of the PS1 script that was executed via WMI using\nPowerShell script block log 4104, as shown in the following screenshot:\n\n\n-----\n\n_Figure 16: Encoded PowerShell script_\n\nThe contents of the registry key were extracted for further analysis. Unfortunately, the\nPowerShell code executed on the system contained undefined variables, such as pdqnas.\nAs such, it did not appear to be decodable as-is.\n\nHowever, other .vbs and .js implementations by the REvil group were available that use the\nsame technique and means of execution. Decoding the registry key was possible using\nanother equivalent JavaScript loader:\n\nhttps://any.run/report/a0081f88e43338810fe23bd2e1fba8857b45f4378df38fc0c21742\n6468b924fc/408db7df-2c3d-466e-b745-f704a1b2daa3\n\nThe JavaScript loader was used to decode the registry key and retrieve the Cobalt Strike\nBeacon details. Upon execution, the Beacon was configured to spawn the legitimate\nMicrosoft gpupdate.exe binary with injected code, which was configured to reach out to the\nfollowing IP over port 443:\n\n216.128.128[.]98\n\n### Data Exfiltration\n\nThe REvil group is known to exfiltrate data prior to deploying ransomware. In identifying any\npotential exfiltration activity, the BlackBerry Incident Response Team searched across a\nnumber of forensic artifacts to identify common exfiltration tools, or enumeration of sensitive\n[folders or file shares. The threat actor used the PowerSploit PowerShell module to discover](https://blogs.blackberry.com/en/2018/09/unpacking-a-packer-powershell-obfuscation-using-securestring)\nfile servers on the network that may contain sensitive data for exfiltration:\n\nAfter discovering potential file servers, typically a threat actor will begin enumerating\navailable shares. One of the most helpful artifacts in identifying enumeration of sensitive file\nshares or folders is the Windows Shellbag artifact, located within the USRCLASS.dat\nregistry hive. In this case, the actor navigated through many folders on the primary file\nserver, likely in attempts to identify the “crown jewels.”\n\nIn addition to this enumeration activity, the FreeFileSync utility was executed from the\nsame system immediately following the Shellbag enumeration event. Unfortunately, the\nthreat actor had deleted the folder containing any logs related to FreeFileSync, and\nWindows Event logs on the system were unavailable from the timeframe of the file’s initial\nexecution. However, through file carving and memory analysis, BlackBerry was able to\nextract many (but not all) Windows Event logs from the incident timeframe. Windows Event\n\n\n-----\n\nID 5156, used to track connections allowed by the Windows Filtering Platform, showed\nconnections from FreeFileSync to Google-owned IP addresses, such as that shown in the\nimage below.\n\n_Figure 17: FreeFileSync remote connections_\n\nAnalysis of firewall activity from the system to the Google-owned IPs also revealed several\ngigabytes worth of network traffic sent from FreeFileSync. BlackBerry determined that the\nREvil group likely used FreeFileSync to exfiltrate data to Google Drive™.\n\n### Ransomware Installation\n\nPrior to deploying ransomware across the environment, the threat actor once again\nattempted to disable the Windows Defender feature via Powershell and Scheduled Tasks.\nRather than deploying ransomware across the entire environment, the group was more\nselective, instead targeting the Hyper-V hosts, and more specifically the Cluster Shared\nVolumes (CSVs) containing the virtual machines (VMs). VMs and Hyper-V services were\nstopped via PowerShell just prior to deploying ransomware to the CSVs.\n\nThe file xyz[.]dll was then downloaded to the affected systems and deployed against the\nCluster Shared Volumes.\n\n\n-----\n\nREvil/Sodinokibi ransomware includes a configuration that is used to determine parameters,\nsuch as which file extensions to target for encryption, which processes to kill prior to\nbeginning the encryption routine, and which directories or extensions to exclude to avoid\ncausing damage to the target operating system. The Sodinokibi ransomware is welldocumented in the following article by the BlackBerry Threat Research team:\n\n[https://blogs.blackberry.com/en/2019/07/threat-spotlight-sodinokibi-ransomware](https://blogs.blackberry.com/en/2019/07/threat-spotlight-sodinokibi-ransomware)\n\n### Hunting\n\nApplying defense in depth is important to both detecting and preventing this sort of\nintrusion. BlackBerry identified several opportunities at which the threat group may have\nbeen detected and eradicated early on in the attack chain. While intrusion prevention is\ncritical, a robust intrusion detection posture is as — if not more — vital to preventing this\nsort of widespread ransomware event. With 24x7x365 monitoring of antivirus/EDR tools, as\nwell as endpoint event logs and network appliances, this event very likely could have been\ndetected and prevented before becoming a large-scale compromise.\n\nIn this incident, BlackBerry identified multiple TTPs that can be monitored for abuse\ndetection, including:\n\nMonitoring of encoded PowerShell commands or potential web requests\nMonitoring for creation of BloodHound output files\n\nBaseline data transfer tools and remote administration tools, such as FreeFileSync or\nPsExec, and monitor for outlying software\n\nMonitoring for usage of common password dumping techniques, such as mimikatz,\nprocdump, or comsvcs.dll\n\nMonitoring for usage of enumeration tools, such as Advanced IP Scanner or\nPowerSploit commands\n\n## About Codi Starks\n\n**Senior Professional Services Incident Response Consultant at BlackBerry.**\n\n\n-----\n\n**[Codi Starks has more than twelve years of IT, cybersecurity, and incident response](https://www.linkedin.com/in/codi-starks-b3a0ab61/)**\nexperience. During his time in the field he has supported and led difficult incident response\nengagements for Fortune 500 companies spanning multiple continents.\n\nHe currently holds several certifications and achievements, including an M.S. in Information\nSecurity and Assurance, as well as the OSCP and SANS GCFE certifications. He has won\nmultiple cybersecurity competitions, including OpenSOC, SANS DFIR Netwars, and SOCX.\n\n## About Ryan Chapman\n\n**[Ryan Chapman is Principal Incident Response & Forensics Consultant, BlackBerry.](https://www.linkedin.com/in/ryanjchapman/)**\n\nAs an author, instructor, and information security professional with over 18 years’\nexperience, Ryan runs and works incidents for clients to provide response, assessment,\nand training in the digital forensics and incident response (DFIR) realm at BlackBerry.\nHis primary case types involve digital forensics investigations (e.g. ransomware cases),\ncompromise assessments, business email compromises, tabletop exercises, and more.\nRyan loves the fact that the security industry is an ever-evolving creature.\n\nBack\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-10 - REvil Under the Microscope.pdf"
    ],
    "report_names": [
        "2021-11-10 - REvil Under the Microscope.pdf"
    ],
    "threat_actors": [
        {
            "id": "52d5d8b3-ab13-4fc4-8d5f-068f788e4f2b",
            "created_at": "2022-10-25T16:07:24.503878Z",
            "updated_at": "2025-03-27T02:02:10.261742Z",
            "deleted_at": null,
            "main_name": "Lapsus$",
            "aliases": [
                "DEV-0537",
                "Strawberry Tempest"
            ],
            "source_name": "ETDA:Lapsus$",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "be5097b2-a70f-490f-8c06-250773692fae",
            "created_at": "2022-10-27T08:27:13.22631Z",
            "updated_at": "2025-03-27T02:00:55.534879Z",
            "deleted_at": null,
            "main_name": "LAPSUS$",
            "aliases": [
                "LAPSUS$",
                "DEV-0537",
                "Strawberry Tempest"
            ],
            "source_name": "MITRE:LAPSUS$",
            "tools": [
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4b9608d-af69-43bc-a08a-38167ac6306a",
            "created_at": "2023-01-06T13:46:39.335061Z",
            "updated_at": "2025-03-27T02:00:03.053961Z",
            "deleted_at": null,
            "main_name": "LAPSUS",
            "aliases": [
                "LAPSUS$",
                "DEV-0537",
                "SLIPPY SPIDER",
                "Strawberry Tempest"
            ],
            "source_name": "MISPGALAXY:LAPSUS",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536236,
    "ts_updated_at": 1743041785,
    "ts_creation_date": 1653767540,
    "ts_modification_date": 1653767540,
    "files": {
        "pdf": "https://archive.orkl.eu/ab5f56f6f7defcc9cbe4fb131591816a07aea31f.pdf",
        "text": "https://archive.orkl.eu/ab5f56f6f7defcc9cbe4fb131591816a07aea31f.txt",
        "img": "https://archive.orkl.eu/ab5f56f6f7defcc9cbe4fb131591816a07aea31f.jpg"
    }
}