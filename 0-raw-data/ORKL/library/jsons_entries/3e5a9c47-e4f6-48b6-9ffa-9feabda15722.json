{
    "id": "3e5a9c47-e4f6-48b6-9ffa-9feabda15722",
    "created_at": "2023-01-12T15:00:07.648213Z",
    "updated_at": "2025-03-27T02:05:36.342714Z",
    "deleted_at": null,
    "sha1_hash": "d3827ec1d3d94bc73a5aa61e6dcd13f832ceb250",
    "title": "2021-12-12 - Log4Shell- Reconnaissance and post exploitation network detection",
    "authors": "",
    "file_creation_date": "2022-05-28T23:18:53Z",
    "file_modification_date": "2022-05-28T23:18:53Z",
    "file_size": 550111,
    "plain_text": "# Log4Shell: Reconnaissance and post exploitation network detection\n\n**[research.nccgroup.com/2021/12/12/log4shell-reconnaissance-and-post-exploitation-network-detection/](https://research.nccgroup.com/2021/12/12/log4shell-reconnaissance-and-post-exploitation-network-detection/)**\n\nDecember 12, 2021\n\n[RIFT: Research and Intelligence Fusion Team December 12, 2021December 29, 2021 9](https://research.nccgroup.com/author/nccgifc/)\nMinutes\n**Note: This blogpost will be live-updated with new information. NCC Group’s RIFT is**\nintending to publish PCAPs of different exploitation methods in the near future – last updated\nDecember 15th at 17:30 UTC\n\n## tl;dr\n\nIn the wake of the `CVE-2021-44228,` `CVE-2021-45046 and` `CVE-2021-44832 (a.k.a.`\nLog4Shell) vulnerability publication, NCC Group’s RIFT immediately started investigating the\nvulnerability in order to improve detection and response capabilities mitigating the threat.\n\nThis blog post is focused on detection and threat hunting, although attack surface scanning\nand identification are also quintessential parts of a holistic response. Multiple references for\nprevention and mitigation can be found included at the end of this post.\n\nThis blogpost provides Suricata network detection rules that can be used not only to detect\nexploitation attempts, but also indications of successful exploitation. In addition, a list of\nindicators of compromise (IOC’s) are provided. These IOC’s have been observed listening\nfor incoming connections and are thus a useful for threat hunting.\n\n## Update Wednesday December 29th, 09:00 UTC\n\n### CVE-2021-44832\n\n\n-----\n\nA further vulnerability was disclosed on December 28th and is tracked under CVE-202144832. NCC Group assesses this vulnerability to be lower priority than the original due to the\nrequirement of pre-existing privileged access to underlying hosts in order to exploit.\n\nFrom the disclosure:\n\n“where an attacker with permission to modify the logging configuration file can construct a\n_malicious configuration using a JDBC Appender with a data source referencing a JNDI URI_\n_which can execute remote code.“_\n\nThis vulnerability may be used as a persistence technique but is unlikely to be used as an\ninitial entry mechanism due to the need to modify configuration.\n\n## Update Friday December 24th, 14:50 UTC\n\n### Log4Shell PCAPS and Network Coverage\n\n[Since the publication of the Log4Shell exploit there have been a lot of developments](https://www.lunasec.io/docs/blog/log4j-zero-day/)\n[surrounding the Log4j CVE, leading to several new versions of the package to fix the](https://logging.apache.org/log4j/2.x/security.html)\nworkarounds that people found for the mitigations. During this time, there were also many\npeople focusing their efforts on finding evasive methods to bypass mitigations put in place\nthat block exploitation by monitoring for the exploitation string.\n\nBecause of the variety of the evasive methods, and the different protocols that can be used\nto exploit the vulnerability, we have created pcaps and an overview to assist security\nengineers in their endeavours to check their current detection coverage.\n\n**Setup**\n\n[RIFT has used an environment to test different scenarios with the purpose of automatically](https://research.nccgroup.com/2021/12/12/log4shell-reconnaissance-and-post-exploitation-network-detection)\ncreating pcaps and testing network coverage for the Remote Code Execution (RCE) vectors\nof Log4Shell using `LDAP and` `RMI .`\n\nWe tested different vectors that attackers could use in real-world scenarios, focusing on the\nHTTP protocol as this has been observed being used in the wild. Please keep in mind that\nHTTP is by no means the only protocol attackers can use to trigger the vulnerability in\napplications using a vulnerable version of Log4j. Any string that is logged by a vulnerable\nLog4j is subject to exploitation. We have also seen different evasion techniques, so these\nhave also been tested for coverage.\n\nWe want to emphasize that we already observed attackers using encoded variants of the\navailable protocols (HTTP Basic Authorization) and that there are plentiful other encoding\nmethods that might still be logged decoded by the application using a vulnerable Log4j\npackage.\n\n\n-----\n\nWe have used the following tools for testing the exploitation:\n\n[JNDIExploit for LDAP github repo down](https://github.com/feihong-cs/JNDIExploit)\n[JNDI-Exploit-Kit for LDAP and RMI](https://github.com/pimps/JNDI-Exploit-Kit)\n\nFor web applications that is vulnerable to log4shell we have used:\n\n[christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app)\n[docker-vuln-log4j-webapp](https://github.com/fox-it/log4shell-pcaps/tree/main/docker-vuln-log4j-webapp)\n\n**Log4Shell PCAPs and Coverage Tracking**\n\nThe tables displayed below give an overview of the different evasion methods and their\nrespective coverage. The PCAP filenames contain the `ev string to mark the evasion ID.`\n\n**EV** **Payload**\n\n1 `${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://`\n```\n    ${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://\n\n```\n\n2 `${${lower:jndi}:${lower:ldap}://`\n```\n   ${${::-j}ndi:rmi://\n\n```\n3 `${${lower:${lower:jndi}}:${lower:ldap}://`\n```\n   ${${lower:jndi}:${lower:rmi}://\n\n```\n4 `${${lower:j}${lower:n}${lower:d}i:${lower:ldap}://`\n```\n   ${${lower:${lower:jndi}}:${lower:rmi}://\n\n```\n\n5 `${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:l}d${lower:a}p://`\n```\n   ${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}://\n\n```\n6 `${j${env:DOESNOTEXIST:-}ndi:ldap://`\n```\n   ${j${env:DOESNOTEXIST:-}ndi:rmi://\n\n```\n\n7 `${${: : : : ::: :: :: : :::-j}ndi:ldap://`\n```\n    ${${: : : : ::: :: :: : :::-j}ndi:rmi://\n\n```\n8 `${${::::::::::::::-j}ndi:ldap://`\n```\n    ${${::::::::::::::-j}ndi:rmi://\n\n```\n[PCAPS etc. can be found here https://github.com/fox-it/log4shell-pcaps](https://github.com/fox-it/log4shell-pcaps)\n\n## Signatures\n\n[Our Log4Shell Suricata signatures can be found here: log4shell-suricata.rules](https://github.com/fox-it/log4shell-pcaps/blob/main/suricata/log4shell-suricata.rules)\n\nWe have found that our signatures for outgoing `LDAP and` `RMI packets are the best`\nindicators (sids 21003738 and 21003739) of detecting a successful Log4Shell detonation.\nThis also covers the situation where the malicious JNDI string is not always detected, for\nexample due to TLS but the IDS still monitors outgoing traffic\n\n\n-----\n\nFurthermore, the exploit chain itself might not always succeed, for example, due to Java\nversions or hardening of the system and or network. However, when these signatures trigger,\na vulnerable Log4j version performed the callback and should be further investigated to\ndetermine which application caused it.\n\n## Update Wednesday December 15th, 17:30 UTC\n\nWe have seen 5 instances in our client base of active exploitation of Mobile Iron during the\ncourse of yesterday and today.\n\nOur working hypothesis is that this is a derivative of the details shared yesterday –\n[https://github.com/rwincey/CVE-2021-44228-Log4j-Payloads/blob/main/MobileIron.](https://github.com/rwincey/CVE-2021-44228-Log4j-Payloads/blob/main/MobileIron)\n\nThe scale of the exposure globally appears significant\n\nWe recommend all Mobile Iron users updated immediately.\n\n\n-----\n\nIvanti informed us that communication was sent over the weekend to MobileIron Core\ncustomers. Ivanti has provided mitigation steps of the exploit listed below on their Knowledge\nBase. Both NCC Group and Ivanti recommend all customers immediately apply the\nmitigation within to ensure their environment is protected.\n\n## Update Tuesday December 14th, 13:00 UTC\n\n### Log4j-finder: finding vulnerable versions of Log4j on your systems\n\nRIFT has published a Python 3 script that can be run on endpoints to check for the presence\nof vulnerable versions of Log4j. The script requires no dependencies and supports\nrecursively checking the filesystem and inside JAR files to see if they contain a vulnerable\nversion of Log4j. This script can be of great value in determining which systems are\nvulnerable, and where this vulnerability stems from. The script will be kept up to date with\nongoing developments.\n\nIt is strongly recommended to run host based scans for vulnerable Log4j versions. Whereas\nnetwork-based scans attempt to identify vulnerable Log4j versions by attacking common\nentry points, a host-based scan can find Log4j in unexpected or previously unknown places.\n\n[The script can be found on GitHub: https://github.com/fox-it/log4j-finder](https://github.com/fox-it/log4j-finder)\n\n### JNDI ExploitKit exposes larger attack surface\n\n[As shown by the release of an update JNDI ExploitKIT it is possible to reach remote code](https://github.com/pimps/JNDI-Exploit-Kit)\nexecution through serialized payloads instead of referencing a Java `.class object in LDAP`\nand subsequently serving that to the vulnerable system. While `TrustURLCodebase defaults`\nto `false in newer Java versions (6u211, 7u201, 8u191, and 11.0.1) and therefore prevents`\nthe LDAP reference vector,depending on the loaded libraries in the vulnerable application it\nis possible to execute code through Java serialization via both rmi and ldap.\n\n### Beware: Centralized logging can result in indirect compromise\n\nThis is also highly relevant for organisations using a form of centralised logging. Centralised\nlogging can be used to collect and parse the received logs from the different services and\napplications running in the environment. We have identified cases where a Kibana server\nwas not exposed to the Internet but because it received logs from several appliances it still\ngot hit by the Log4Shell RCE and started to retrieve Java objects via LDAP.\n\nWe were unable to determine if this was due to Logstash being used in the background for\nparsing the received logs, but this stipulates the importance of checking systems configured\nwith centralised logging solutions for vulnerable versions of Log4j, and not rely on the\n\n\n-----\n\nprotection of newer JDK versions that has\n```\ncom.sun.jndi.ldap.object.trustURLCodebase\ncom.sun.jndi.rmi.object.trustURLCodebase set to false by default.\n\n### A warning concerning possible post-exploitation\n\n```\nIt is therefore advised to apply the patches provided by Microsoft in the November 2021\nsecurity updateAlthough largely eclipsed by Log4Shell, last weekend also saw the\nemergence of details concerning two vulnerabilities ( CVE-2021-42287 and `CVE-2021-`\n```\n42278 ) that reside in the Active Directory component of Microsoft Windows Server editions.\n\n```\nDue to the nature of these vulnerabilities, an attackers could escalate their privileges in a\nrelatively easy manner as these vulnerabilities have already been weaponised.\n\nIt is therefore advised to apply the patches provided by Microsoft in the November 2021\nsecurity updates to every domain controller that is residing in the network as it is a possible\nform of post-exploitation after Log4Shell were to be successfully exploited.\n\n## Background\n\nSince Log4J is used by many solutions there are significant challenges in finding vulnerable\nsystems and any potential compromise resulting from exploitation of the vulnerability. JNDI\n(Java Naming and Directory Interface™) was designed to allow distributed applications to\nlook up services in a resource-independent manner, and this is exactly where the bug\nresulting in exploitation resides. The nature of JNDI allows for defense-evading exploitation\nattempts that are harder to detect through signatures. An additional problem is the\ntremendous amount of scanning activity that is currently ongoing. Because of this,\ninvestigating every single exploitation attempt is in most situations unfeasible. This means\nthat distinguishing scanning attempts from actual successful exploitation is crucial.\n\nIn order to provide detection coverage for `CVE-2021-44228 and` `CVE-2021-45046, NCC`\nGroup’s RIFT first created a ruleset that covers as many ways as possible of attempted\nexploitation of the vulnerability. This initial coverage allowed the collection of Threat\nIntelligence for further investigation. Most adversaries appear to use a different IP to scan for\nthe vulnerability than they do for listening for incoming victim machines. IOC’s for listening\n**IP’s / domains are more valuable than those of scanning IP’s. After all a connection from**\nan environment to a known listening IP might indicate a successful compromise, whereas a\nconnection to a scanning IP might merely mean that it has been scanned.\n\nAfter establishing this initial coverage, our focus shifted to detecting successful exploitation in\nreal time. This can be done by monitoring for rogue JRMI or LDAP requests to external\nservers. Preferably, this sort of behavior is detected in a port-agnostic way as attackers may\nchoose arbitrary ports to listen on. Moreover, currently a full RCE chain requires the victim\nmachine to retrieve a Java class file from a remote server (caveat: unless exfiltrating\nsensitive environment variables). For hunting purposes we are able to hunt for inbound Java\n\n\n-----\n\nclasses. However, if coverage exists for incoming attacks we are also able to alert on an\ninbound Java class in a short period of time after an exploitation attempt. The combination of\ninbound exploitation attempt and inbound Java class is a high confidence IOC that a\nsuccessful connection has occurred.\n\nThis blogpost will continue twofold: we will first provide a set of suricata rules that can be\nused for:\n\n1. Detecting incoming exploitation attempts;\n2. Alerting on higher confidence indicators that successful exploitation has occurred;\n3. Generating alerts that can be used for hunting\n\nAfter providing these detection rules, a list of IOC’s is provided.\n\n## Detection Rules\n\nSome of these rules are redundant, as they’ve been written in rapid succession.\n\n# Detects Log4j exploitation attempts\n\nalert http any any -> $HOME_NET any (msg:\"FOX-SRT – Exploit – Possible Apache\nLog4J RCE Request Observed (CVE-2021-44228)\"; flow:established, to_server;\ncontent:\"${jndi:ldap://\"; fast_pattern:only; flowbits:set, fox.apachelog4j.rce;\nthreshold:type limit, track by_dst, count 1, seconds 3600; classtype:web-application[attack; priority:3; reference:url, http://www.lunasec.io/docs/blog/log4j-zero-day/;](http://www.lunasec.io/docs/blog/log4j-zero-day/)\nmetadata:CVE 2021-44228; metadata:created_at 2021-12-10; metadata:ids suricata;\nsid:21003726; rev:1;)\n\nalert http any any -> $HOME_NET any (msg:\"FOX-SRT – Exploit – Possible Apache\nLog4J RCE Request Observed (CVE-2021-44228)\"; flow:established, to_server;\ncontent:\"${jndi:\"; fast_pattern; pcre:\"/\\$\\{jndi\\:(rmi|ldaps|dns)\\:/\"; flowbits:set,\nfox.apachelog4j.rce; threshold:type limit, track by_dst, count 1, seconds 3600;\nclasstype:web-application-attack; priority:3; reference:url,\n[http://www.lunasec.io/docs/blog/log4j-zero-day/; metadata:CVE 2021-44228;](http://www.lunasec.io/docs/blog/log4j-zero-day/)\nmetadata:created_at 2021-12-10; metadata:ids suricata; sid:21003728; rev:1;)\n\nalert http any any -> $HOME_NET any (msg:\"FOX-SRT – Exploit – Possible DefenseEvasive Apache Log4J RCE Request Observed (CVE-2021-44228)\"; flow:established,\nto_server; content:\"${jndi:\"; fast_pattern; content:!\"ldap://\"; flowbits:set,\nfox.apachelog4j.rce; threshold:type limit, track by_dst, count 1, seconds 3600;\nclasstype:web-application-attack; priority:3; reference:url,\n[http://www.lunasec.io/docs/blog/log4j-zero-day/; reference:url,](http://www.lunasec.io/docs/blog/log4j-zero-day/)\ntwitter.com/stereotype32/status/1469313856229228544; metadata:CVE 2021-44228;\nmetadata:created_at 2021-12-10; metadata:ids suricata; sid:21003730; rev:1;)\n\n\n-----\n\nalert http any any -> $HOME_NET any (msg:\"FOX-SRT – Exploit – Possible DefenseEvasive Apache Log4J RCE Request Observed (URL encoded bracket) (CVE-202144228)\"; flow:established, to_server; content:\"%7bjndi:\"; nocase; fast_pattern;\nflowbits:set, fox.apachelog4j.rce; threshold:type limit, track by_dst, count 1, seconds\n3600; classtype:web-application-attack; priority:3; reference:url,\n[http://www.lunasec.io/docs/blog/log4j-zero-day/; reference:url,](http://www.lunasec.io/docs/blog/log4j-zero-day/)\n[https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228;](https://twitter.com/testanull/status/1469549425521348609)\nmetadata:created_at 2021-12-11; metadata:ids suricata; sid:21003731; rev:1;)\n\nalert http any any -> $HOME_NET any (msg:\"FOX-SRT – Exploit – Possible Apache\nLog4j Exploit Attempt in HTTP Header\"; flow:established, to_server; content:\"${\";\nhttp_header; fast_pattern; content:\"}\"; http_header; distance:0; flowbits:set,\nfox.apachelog4j.rce.loose; classtype:web-application-attack; priority:3; threshold:type\nlimit, track by_dst, count 1, seconds 3600; reference:url,\n[http://www.lunasec.io/docs/blog/log4j-zero-day/; reference:url,](http://www.lunasec.io/docs/blog/log4j-zero-day/)\n[https://twitter.com/testanull/status/1469549425521348609; metadata:CVE 2021-44228;](https://twitter.com/testanull/status/1469549425521348609)\nmetadata:created_at 2021-12-11; metadata:ids suricata; sid:21003732; rev:1;)\n\nalert http any any -> $HOME_NET any (msg:\"FOX-SRT – Exploit – Possible Apache\nLog4j Exploit Attempt in URI\"; flow:established,to_server; content:\"${\"; http_uri;\nfast_pattern; content:\"}\"; http_uri; distance:0; flowbits:set, fox.apachelog4j.rce.loose;\nclasstype:web-application-attack; priority:3; threshold:type limit, track by_dst, count 1,\n[seconds 3600; reference:url, http://www.lunasec.io/docs/blog/log4j-zero-day/;](http://www.lunasec.io/docs/blog/log4j-zero-day/)\nreference:url, [https://twitter.com/testanull/status/1469549425521348609; metadata:CVE](https://twitter.com/testanull/status/1469549425521348609)\n2021-44228; metadata:created_at 2021-12-11; metadata:ids suricata; sid:21003733;\nrev:1;)\n\n# Better and stricter rules, also detects evasion techniques\n\nalert http any any -> $HOME_NET any (msg:\"FOX-SRT – Exploit – Possible Apache\nLog4j Exploit Attempt in HTTP Header (strict)\"; flow:established,to_server; content:\"${\";\nhttp_header; fast_pattern; content:\"}\"; http_header; distance:0; pcre:/(\\$\\{\\w+:.*\\}|jndi)/Hi;\nxbits:set, fox.log4shell.attempt, track ip_dst, expire 1; threshold:type limit, track by_dst,\ncount 1, seconds 3600; classtype:web-application-attack;\nreference:url,www.lunasec.io/docs/blog/log4j-zero-day/;\n[reference:url,https://twitter.com/testanull/status/1469549425521348609; metadata:CVE](https://twitter.com/testanull/status/1469549425521348609)\n2021-44228; metadata:created_at 2021-12-11; metadata:ids suricata; priority:3;\nsid:21003734; rev:1;)\n\n\n-----\n\nalert http any any -> $HOME_NET any (msg:\"FOX-SRT – Exploit – Possible Apache\nLog4j Exploit Attempt in URI (strict)\"; flow:established, to_server; content:\"${\"; http_uri;\nfast_pattern; content:\"}\"; http_uri; distance:0; pcre:/(\\$\\{\\w+:.*\\}|jndi)/Ui; xbits:set,\nfox.log4shell.attempt, track ip_dst, expire 1; classtype:web-application-attack;\nthreshold:type limit, track by_dst, count 1, seconds 3600;\nreference:url,www.lunasec.io/docs/blog/log4j-zero-day/;\n[reference:url,https://twitter.com/testanull/status/1469549425521348609; metadata:CVE](https://twitter.com/testanull/status/1469549425521348609)\n2021-44228; metadata:created_at 2021-12-11; metadata:ids suricata; priority:3;\nsid:21003735; rev:1;)\n\nalert http any any -> $HOME_NET any (msg:\"FOX-SRT – Exploit – Possible Apache\nLog4j Exploit Attempt in Client Body (strict)\"; flow:to_server; content:\"${\";\nhttp_client_body; fast_pattern; content:\"}\"; http_client_body; distance:0; pcre:/(\\$\\\n{\\w+:.*\\}|jndi)/Pi; flowbits:set, fox.apachelog4j.rce.strict;\nxbits:set,fox.log4shell.attempt,track ip_dst,expire 1; classtype:web-application-attack;\nthreshold:type limit, track by_dst, count 1, seconds 3600;\nreference:url,www.lunasec.io/docs/blog/log4j-zero-day/;\n[reference:url,https://twitter.com/testanull/status/1469549425521348609; metadata:CVE](https://twitter.com/testanull/status/1469549425521348609)\n2021-44228; metadata:created_at 2021-12-12; metadata:ids suricata; priority:3;\nsid:21003744; rev:1;)\n\n[view raw](https://gist.github.com/fox-srt/6b3735cf0f0855fcaf7a74f146025c5a/raw/e309a92a85befd3514176c3c9ee37155576d59a0/log4shell-exploitation-attempts.rules) [log4shell-exploitation-attempts.rules hosted with ❤ by](https://gist.github.com/fox-srt/6b3735cf0f0855fcaf7a74f146025c5a#file-log4shell-exploitation-attempts-rules) [GitHub](https://github.com/)\n\n### Detecting outbound connections to probing services\n\nConnections to outbound probing services could indicate a system in your network has been\nscanned and subsequently connected back to a listening service. This could indicate that a\nsystem in your network is/was vulnerable and has been scanned.\n\n# Possible successful interactsh probe\n\nalert http $EXTERNAL_NET any -> $HOME_NET any (msg:\"FOX-SRT – Webattack –\nPossible successful InteractSh probe observed\"; flow:established, to_client;\ncontent:\"200\"; http_stat_code; content:\"<html><head></head><body>\";\nhttp_server_body; fast_pattern; pcre:\"/[a-z0-9]{30,36}<\\/body><\\/html>/QR\";\nthreshold:type limit, track by_dst, count 1, seconds 3600; classtype:misc-attack;\nreference:url, github.com/projectdiscovery/interactsh; metadata:created_at 2021-12-05;\nmetadata:ids suricata; priority:2; sid:21003712; rev:1;)\n\nalert dns $HOME_NET any -> any 53 (msg:\"FOX-SRT – Suspicious – DNS query for\ninteractsh.com server observed\"; flow:stateless; dns_query; content:\".interactsh.com\";\nfast_pattern; pcre:\"/[a-z0-9]{30,36}\\.interactsh\\.com/\"; threshold:type limit, track by_src,\ncount 1, seconds 3600; reference:url, github.com/projectdiscovery/interactsh;\nclasstype:bad-unknown; metadata:created_at 2021-12-05; metadata:ids suricata;\npriority:2; sid:21003713; rev:1;)\n\n# Detecting DNS queries for dnslog[.]cn\n\n\n-----\n\nalert dns any any -> any 53 (msg:\"FOX-SRT – Suspicious – dnslog.cn DNS Query\nObserved\"; flow:stateless; dns_query; content:\"dnslog.cn\"; fast_pattern:only;\nthreshold:type limit, track by_src, count 1, seconds 3600; classtype:bad-unknown;\nmetadata:created_at 2021-12-10; metadata:ids suricata; priority:2; sid:21003729; rev:1;)\n\n# Connections to requestbin.net\n\nalert dns $HOME_NET any -> any 53 (msg:\"FOX-SRT – Suspicious – requestbin.net\nDNS Query Observed\"; flow:stateless; dns_query; content:\"requestbin.net\";\nfast_pattern:only; threshold:type limit, track by_src, count 1, seconds 3600;\nclasstype:bad-unknown; metadata:created_at 2021-11-23; metadata:ids suricata;\nsid:21003685; rev:1;)\n\nalert tls $HOME_NET any -> $EXTERNAL_NET 443 (msg:\"FOX-SRT – Suspicious –\nrequestbin.net in SNI Observed\"; flow:established, to_server; tls_sni;\ncontent:\"requestbin.net\"; fast_pattern:only; threshold:type limit, track by_src, count 1,\nseconds 3600; classtype:bad-unknown; metadata:created_at 2021-11-23; metadata:ids\nsuricata; sid:21003686; rev:1;)\n\n[view raw](https://gist.github.com/fox-srt/a4524779f1f44891d3216e29119297ae/raw/fb3e72f7f00ae4fcc36924501040f5c006e788de/log4shell-probes.rules) [log4shell-probes.rules hosted with ❤ by](https://gist.github.com/fox-srt/a4524779f1f44891d3216e29119297ae#file-log4shell-probes-rules) [GitHub](https://github.com/)\n\n### Detecting possible successful exploitation\n\nOutbound LDAP(S) / RMI connections are highly uncommon but can be caused by\nsuccessful exploitation. Inbound Java can be suspicious, especially if it is shortly after an\nexploitation attempt.\n\n# Detects possible successful exploitation of Log4j\n\n# JNDI LDAP/RMI Request to External\n\nalert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:\"FOX-SRT – Exploit –\nPossible Rogue JNDI LDAP Bind to External Observed (CVE-2021-44228)\";\nflow:established, to_server; dsize:14; content:\"|02 01 03 04 00 80 00|\"; offset:7;\nisdataat:!1, relative; threshold:type limit, track by_src, count 1, seconds 3600;\nclasstype:bad-unknown; priority:1; metadata:created_at 2021-12-11; sid:21003738;\nrev:2;)\n\nalert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:\"FOX-SRT – Exploit –\nPossible Rogue JRMI Request to External Observed (CVE-2021-44228)\";\nflow:established, to_server; content:\"JRMI\"; depth:4; threshold:type limit, track by_src,\ncount 1, seconds 3600; classtype:bad-unknown; priority:1; reference:url,\n[https://docs.oracle.com/javase/9/docs/specs/rmi/protocol.html; metadata:created_at](https://docs.oracle.com/javase/9/docs/specs/rmi/protocol.html)\n2021-12-11; sid:21003739; rev:1;)\n\n# Detecting inbound java shortly after exploitation attempt\n\n\n-----\n\nalert tcp any any -> $HOME_NET any (msg: \"FOX-SRT – Exploit – Java class inbound\nafter CVE-2021-44228 exploit attempt (xbit)\"; flow:established, to_client; content: \"|CA\nFE BA BE 00 00 00|\"; depth:40; fast_pattern; xbits:isset, fox.log4shell.attempt, track\nip_dst; threshold:type limit, track by_dst, count 1, seconds 3600; classtype:successfuluser; priority:1; metadata:ids suricata; metadata:created_at 2021-12-12; sid:21003741;\nrev:1;)\n\n[view raw](https://gist.github.com/fox-srt/c8d2fa991e8bb2be1446bad18f010fcb/raw/c7e0ce8901a728121d42235c4d545e3ae402248f/log4shell-success.rules) [log4shell-success.rules hosted with ❤ by](https://gist.github.com/fox-srt/c8d2fa991e8bb2be1446bad18f010fcb#file-log4shell-success-rules) [GitHub](https://github.com/)\n\n### Hunting rules (can yield false positives)\n\nWget and cURL to external hosts was observed to be used by an actor for post-exploitation.\nAs cURL and Wget are also used legitimately, these rules should be used for hunting\npurposes. Also note that attackers can easily change the User-Agent but we have not seen\nthat in the wild yet. Outgoing connections after Log4j exploitation attempts can be tracked to\nbe later hunted on although this rule can generate false positives if victim machine makes\noutgoing connections regularly. Lastly, detecting inbound compiled Java classes can also be\nused for hunting.\n\n# Outgoing connection after Log4j Exploit Attempt (uses xbit from sid: 21003734) –\nrequires `stream.inline=yes` setting in suricata.yaml for this to work\n\nalert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:\"FOX-SRT – Suspicious –\nPossible outgoing connection after Log4j Exploit Attempt\"; flow:established, to_server;\nxbits:isset, fox.log4shell.attempt, track ip_src; stream_size:client, =, 1;\nstream_size:server, =, 1; threshold:type limit, track by_dst, count 1, seconds 3600;\nclasstype:bad-unknown; metadata:ids suricata; metadata:created_at 2021-12-12;\npriority:3; sid:21003740; rev:1;)\n\n# Detects inbound Java class\n\nalert tcp $EXTERNAL_NET any -> $HOME_NET any (msg: \"FOX-SRT – Suspicious –\nJava class inbound\"; flow:established, to_client; content: \"|CA FE BA BE 00 00 00|\";\ndepth:20; fast_pattern; threshold:type limit, track by_dst, count 1, seconds 43200;\nmetadata:ids suricata; metadata:created_at 2021-12-12; classtype:bad-unknown;\npriority:3; sid:21003742; rev:2;)\n\n[view raw](https://gist.github.com/fox-srt/7471263e08bcbec6676c85f4afe84733/raw/609a3a2f0f2d4f19a9beb0d0fd8b887749f85739/log4shell-hunting.rules) [log4shell-hunting.rules hosted with ❤ by](https://gist.github.com/fox-srt/7471263e08bcbec6676c85f4afe84733#file-log4shell-hunting-rules) [GitHub](https://github.com/)\n\n## Indicators of Compromise\n\nThis list contains Domains and IP’s that have been observed to listen for incoming\n**connections. Unfortunately, some adversaries scan and listen from the same IP, generating**\na lot of noise that can make threat hunting more difficult. Moreover, as security researchers\nare scanning the internet for the vulnerability as well, it could be possible that an IP or\ndomain is listed here even though it is only listening for benign purposes.\n\n\n-----\n\n-----\n\n```\n# IP addresses and domains that have been observed in Log4j exploit\nattempts\n134[.]209[.]26[.]39\n199[.]217[.]117[.]92\npwn[.]af\n188[.]120[.]246[.]215\nkryptoslogic-cve-2021-44228[.]com\nnijat[.]space\n45[.]33[.]47[.]240\n31[.]6[.]19[.]41\n205[.]185[.]115[.]217\nlog4j[.]kingudo[.]de\n101[.]43[.]40[.]206\npsc4fuel[.]com\n185[.]162[.]251[.]208\n137[.]184[.]61[.]190\n162[.]33[.]177[.]73\n34[.]125[.]76[.]237\n162[.]255[.]202[.]246\n5[.]22[.]208[.]77\n45[.]155[.]205[.]233\n165[.]22[.]213[.]147\n172[.]111[.]48[.]30\n133[.]130[.]120[.]176\n213[.]156[.]18[.]247\nm3[.]wtf\npoc[.]brzozowski[.]io\n206[.]188[.]196[.]219\n185[.]250[.]148[.]157\n132[.]226[.]170[.]154\nflofire[.]de\n45[.]130[.]229[.]168\nc19s[.]net\n194[.]195[.]118[.]221\nawsdns-2[.]org\n2[.]56[.]57[.]208\n158[.]69[.]204[.]95\n45[.]130[.]229[.]168\n163[.]172[.]157[.]143\n45[.]137[.]21[.]9\nbingsearchlib[.]com\n45[.]83[.]193[.]150\n165[.]227[.]93[.]231\nyourdns[.]zone[.]here\neg0[.]ru\ndataastatistics[.]com\nlog4j-test[.]xyz\n79[.]172[.]214[.]11\n152[.]89[.]239[.]12\n67[.]205[.]191[.]102\nds[.]Rce[.]ee\n\n```\n\n-----\n\n```\n    38[.]143[.]9[.]76\n    31[.]191[.]84[.]199\n    143[.]198[.]237[.]19\n    # (Ab)use of listener-as-a-service domains.\n    # These domains can be false positive heavy, especially if these services\n    are used legitimately within your network.\n    interactsh[.]com\n    interact[.]sh\n    burpcollaborator[.]net\n    requestbin[.]net\n    dnslog[.]cn\n    canarytokens[.]com\n    # This IP is both a listener and a scanner at the same time. Threat\n    hunting for this IOC thus requires additional steps.\n    45[.]155[.]205[.]233\n    194[.]151[.]29[.]154\n    158[.]69[.]204[.]95\n    47[.]254[.]127[.]78\n\n```\n[view raw](https://gist.github.com/fox-srt/6b1cbba225231bc4125f97ed59ae0342/raw/117db9beac5f749d04a3dab43716871f0fc69b7b/log4shell-iocs.md) [log4shell-iocs.md hosted with ❤ by](https://gist.github.com/fox-srt/6b1cbba225231bc4125f97ed59ae0342#file-log4shell-iocs-md) [GitHub](https://github.com/)\n\n## References\n\n**General references**\n\nFox-IT / NCC Group actively participates in a continuously updated reddit thread:\n[https://www.reddit.com/r/blueteamsec/comments/rd38z9/log4j_0day_being_exploited/](https://www.reddit.com/r/blueteamsec/comments/rd38z9/log4j_0day_being_exploited/)\n[https://nvd.nist.gov/vuln/detail/CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)\n\n**Mitigation:**\n\n[https://github.com/OllieJC/aws-log4j-mitigations](https://github.com/OllieJC/aws-log4j-mitigations)\n\n**Attack surface:**\n\nKnown vulnerable services / products which use log4j:\n\n[https://github.com/YfryTchsGD/Log4jAttackSurface](https://github.com/YfryTchsGD/Log4jAttackSurface)\n[https://mvnrepository.com/artifact/log4j/log4j/usages](https://mvnrepository.com/artifact/log4j/log4j/usages)\n\nHashes of vulnerable products:\n\n[https://gist.github.com/olliencc/8be866ae94b6bee107e3755fd1e9bf0d](https://gist.github.com/olliencc/8be866ae94b6bee107e3755fd1e9bf0d)\n\n\n-----\n\n## Published by RIFT: Research and Intelligence Fusion Team\n\nRIFT leverages our strategic analysis, data science, and threat hunting capabilities to create\nactionable threat intelligence, ranging from IoCs and detection capabilities to strategic\nreports on tomorrow’s threat landscape. Cyber security is an arms race where both attackers\nand defenders continually update and improve their tools and ways of working. To ensure\nthat our managed services remain effective against the latest threats, NCC Group operates a\nGlobal Fusion Center with Fox-IT at its core. This multidisciplinary team converts our leading\ncyber threat intelligence into powerful detection strategies. View all posts by RIFT: Research\nand Intelligence Fusion Team\n\n**Published December 12, 2021December 29, 2021**\n\n## Post navigation\n\n[Previous Post Announcing NCC Group’s Cryptopals Guided Tour!](https://research.nccgroup.com/2021/12/10/announcing-ncc-groups-cryptopals-guided-tour/)\n[Next Post log4j-jndi-be-gone: A simple mitigation for CVE-2021-44228](https://research.nccgroup.com/2021/12/12/log4j-jndi-be-gone-a-simple-mitigation-for-cve-2021-44228/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-12 - Log4Shell- Reconnaissance and post exploitation network detection.pdf"
    ],
    "report_names": [
        "2021-12-12 - Log4Shell- Reconnaissance and post exploitation network detection.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535607,
    "ts_updated_at": 1743041136,
    "ts_creation_date": 1653779933,
    "ts_modification_date": 1653779933,
    "files": {
        "pdf": "https://archive.orkl.eu/d3827ec1d3d94bc73a5aa61e6dcd13f832ceb250.pdf",
        "text": "https://archive.orkl.eu/d3827ec1d3d94bc73a5aa61e6dcd13f832ceb250.txt",
        "img": "https://archive.orkl.eu/d3827ec1d3d94bc73a5aa61e6dcd13f832ceb250.jpg"
    }
}