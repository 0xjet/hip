{
    "id": "3862d96d-9519-4d73-95df-38d607ffac21",
    "created_at": "2023-01-12T15:04:03.897846Z",
    "updated_at": "2025-03-27T02:06:00.446136Z",
    "deleted_at": null,
    "sha1_hash": "99b814d836514d2dbf16a2c37953ae47abe3163c",
    "title": "2021-05-27 - Trapping A Fat Quasar RAT",
    "authors": "",
    "file_creation_date": "2022-05-28T18:29:52Z",
    "file_modification_date": "2022-05-28T18:29:52Z",
    "file_size": 131755,
    "plain_text": "# Trapping A Fat Quasar RAT\n\n**blog.minerva-labs.com/trapping-quasar-rat**\n\n[Tweet](https://twitter.com/share)\n\nHow would you go about evading the state-of-the-art sandbox? The most straightforward\nway would be to test your malware versus the industry’s top vendors. A sample we\nencountered in January, 2021 has taken a different approach. Its developer simply “fattened”\nit up into a tremendous 624.79 MB file size, thus surpassing the upload limit of most\n\n\n-----\n\nsandboxing solutions, which is akin to avoiding a security checkup by simply being too big to\nfit through the door. In this blog we will give a technical overview of this weight-challenged\n[RAT, and how it used its larger size to evade security products.](https://searchsecurity.techtarget.com/definition/RAT-remote-access-Trojan)\n\n**FatRAT – First Stage Packer:**\n\nThe sample, named wvQROZu.exe, is a .NET portable executable file, with a highly\nobfuscated variable and function names. Its initial size of 624 MB shrinks to a measly 806 KB\n[after de-obfuscation by the amazing de4dot:](https://github.com/de4dot/de4dot)\n\n\nwvQROZu is a .net portable executable file\n\n\nThe first stage of the malware extracts a .NET DLL from a compressed and Base64 hardcoded buffer. The DLL, self-proclaimed MARCUS.dll, is loaded and one of its functions is\ninvoked, passing a resource name and an encryption key as parameters. The resource\n(which was passed to MARCUS.dll as a parameter) points to a bitmap image in which the\n\n\n-----\n\nnext payload is encoded. The data is stored in the image s RGB pixel values, similarly to the\nRedLine Stealer sample we covered in a previous post. This time instead of using RC2\nstream cipher, the sample uses a XOR based algorithm to decrypt the next payload.\n\nThe XOR-based decryption algorithm:\n\n\nThe XOR based decryption algorithm\n\n\nAfter decryption and Gzip decompression, another assembly is revealed and loaded inmemory.\n\n**Second Stage Packer:**\n\nThe second stage of the malware is yet another obfuscated .NET binary. The binary's\n[developer shamelessly copied a bunch of anti-sandboxing techniques straight from this 2013](http://www.cplusplus.com/forum/windows/96874/)\npost. Specifically, a list of usernames that is compared against the current user and a list of\nfile names are checked against the process’ image path.\n\n\n-----\n\nThe blacklisted artifacts:\n\n**Usernames** **File paths\\names**\n\nSANDBOX Virus\n\nMalware Sandbox\n\nVirus Sample\n\nSchmidti C:\\file.exe\n\nCurrentuser\n\nIt then checks for the existence of a window named “Afx:400000:0” which is indicative of\nWinJail sandbox.\n\nThe last anti-sandboxing check is for the existence of the DLL SbieDll.dll, a file that is loaded\nin sandboxie’s analyzed process.\n\nThe obfuscated SbieDll.dll check:\n\n\n-----\n\nThe obfuscated dll\n\n\nIf any of the above artifacts are found, the malware will self-terminate.\n\nAfter these checks, the malware will check if the file %AppData%\\wvQROZu.exe exists, and\nwill copy itself to that location if it is missing.\n\nPersistence wise, the malware creates a schedule task on the infected machine. The\nscheduled task is created using a unique feature, the malware carries in its resource a\nschedule task XML file which is modified in runtime to fit the compromised device. The XML\nfile will be dropped to %Temp% directory, then the task will be created using the default\nWindows binary schtasks.exe and the “/XML” flag. When creating a schedule task from\nXML, the task creation date can be set to any arbitrary value, and by abusing this feature,\nthe malware’s developers attempt to fool forensics investigators with a fake timestamp.\n\n\n-----\n\nA snippet from the embedded XML file:\n\n\nA snipped from the XML file\n\n\nThe schedule task command executed by the malware (as seen in Sysinternal’s Procmon) :\n\n\n-----\n\nAfter setting up persistence, the final payload is decrypted and then injected using process\nhollowing into a newly created “Regsvcs.exe” process.\n\n[The final payload is revealed to be a Quasar RAT client, which connects to a hardcoded](https://github.com/quasar/Quasar)\nC&C address and enables full control of the device.\n\n**Conclusion:**\n\nAttackers find new and interesting ways to bypass security products, and while the\n“fattening” technique used by this malware is not sophisticated, it is nonetheless effective.\n\nMinerva Prevents the threat detailed in this blog, along with other evasive malware using our\nHostile Environment Simulation technology.\n\nThe malware in question was prevented 3 months before it was uploaded to VirusTotal:\n\n\n-----\n\nMinerva Prevents the infection\n\n\n**IOCs:**\n\n**Hashes:**\n\n568de2a8e7af6fdda514c4cc7fd37c7ae92182955f2739a75d7c64a6bcc7f46d\n(wvQROZu.exe)\n\na58efd253a25cc764d63476931da2ddb305a0328253a810515f6735a6690de1d (Quasar RAT\nfinal payload)\n\n82ed88cebe87b50d0ca2f0c452de79b43e66988b0babbadcafce6c07526cb52c (second stage\npayload)\n\ne83cef9cfa4e2ea30e28843e43c60ebf8f6590fb753ad0aa5ed1123c01280527 (MARCUS.dll)\n\n**DNS:**\n\n\n-----\n\nstarwort[.]kozow[.]com:1980\n\n**Mutex:**\n\nQSR_MUTEX_XMISpvJz1tS3wbFVbJ\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-05-27 - Trapping A Fat Quasar RAT.pdf"
    ],
    "report_names": [
        "2021-05-27 - Trapping A Fat Quasar RAT.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535843,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1653762592,
    "ts_modification_date": 1653762592,
    "files": {
        "pdf": "https://archive.orkl.eu/99b814d836514d2dbf16a2c37953ae47abe3163c.pdf",
        "text": "https://archive.orkl.eu/99b814d836514d2dbf16a2c37953ae47abe3163c.txt",
        "img": "https://archive.orkl.eu/99b814d836514d2dbf16a2c37953ae47abe3163c.jpg"
    }
}