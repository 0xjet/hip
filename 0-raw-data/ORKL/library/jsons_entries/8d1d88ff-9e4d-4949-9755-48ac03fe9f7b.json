{
    "id": "8d1d88ff-9e4d-4949-9755-48ac03fe9f7b",
    "created_at": "2023-05-06T02:09:29.553294Z",
    "updated_at": "2025-03-27T02:05:41.676948Z",
    "deleted_at": null,
    "sha1_hash": "a3131600a01952b8cbf2bd18dc882576d5f65536",
    "title": "2023-04-06 - Neutralizing Tofsee Spambot – Part 1 - Binary file vaccine",
    "authors": "",
    "file_creation_date": "2023-05-05T01:50:12Z",
    "file_modification_date": "2023-05-05T01:50:12Z",
    "file_size": 1147010,
    "plain_text": "# Neutralizing Tofsee Spambot – Part 1 | Binary file vaccine\n\n**[spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-1-binary-file-vaccine/](https://www.spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-1-binary-file-vaccine/)**\n\nApril 6, 2023\n\nThe Spamhaus Malware Researchers have been busy in their lairs, reverse engineering\nTofsee malware to provide you with the code required for two malware vaccines and a\nnetwork-based kill switch. A hat trick of protection against this spambot! This is the first in\nthis three-part series, and looks at how to inject a malware vaccine into the binary file.\n\n## An introduction to malware vaccines\n\nThis security concept works by proactively introducing a small piece of harmless code into a\ncomputer system to disrupt and prevent malware from executing and spreading. This is not\ndissimilar to how medical vaccines work (hence the use of the same terminology).\nEssentially, the premise is to “immunize” the system against specific types of malware by\nproviding the system, in advance, with a form of defense.\n\nThere are various types of malware vaccines, including file-based, memory-based, and\nnetwork-based. They can be delivered as standalone software tools or integrated into other\nsecurity products such as antivirus software.\n\nWhile malware vaccines can be an effective defense against certain types of malware, they\nshould never be used as a substitute for other security measures such as keeping software\nand operating systems up to date, using strong passwords, and avoiding suspicious email\nattachments or downloads, to name but a few. It’s also important to note that as new\nmalware strains are developed, the vaccines must be updated accordingly to remain\neffective.\n\nLet’s move on to the malware taking center stage in this series…\n\n## An introduction to Tofsee\n\n**Tofsee, also known as Gheg, is a sophisticated modular malware primarily designed to send**\nspam email along with other full-fledged botnet activities such as mining and stealing login\nand email credentials, as well as downloading further malware. Generally, the additional\nmalware downloaded is either ransomware or banking Trojans.\n\nThe malware is written in C/C++ and uses various techniques to avoid detection and remain\npersistent on infected systems.\n\nIdentifying where a vaccine can be “injected” in Tofsee\n\n\n-----\n\nTo create a vaccine for a malware family, you need to have the ability to mimic the existence\nof part of the malware, for example, its binary file. This tricks the malware into believing that\nan instance of the malware code is already running on the system and, therefore, won’t try to\nre-infect it.\n\nThe first stage in identifying points to distract from the normal execution of the binary file is to\nreverse engineer the malware to understand the flow process of the code.\n\nTo explore the possibility of imitating the binary file, you need to check if it’s in the\ninstaller/installed path.\n\n**_Installer/Installed path checks in Tofsee_**\n\n\n-----\n\n## Tofsee installer/installed paths deviate from the norm\n\nWhen we ran these checks with Tofsee, we noticed a slight deviation from the typical routine.\nInstead of checking file or registry-based artifacts, Tofsee cross-checks against an inmemory variable injected during installation.\n\n\n-----\n\n**_Installer checks Tofsee_**\n\nThis makes it impossible to imitate the binary file; however, it did make us ask the following\nquestion:\n\n“How does Tofsee manage the duplicate runs of the same binary?”\n\nThe answer is that Tofsee handles this process using Inter-Process Communication (IPC)\npipes [https://www.geeksforgeeks.org/ipc-technique-pipes/].\n\n## IPC communications initiate an exist\n\nIn the binary, we noticed a subroutine where Tofsee opens an IPC pipe and processes\nvarious data. The malware uses this IPC channel to communicate with another running\ninstance to trigger an exist.\n\nAn algorithm is used to generate the pipe name, creating a name based on a predetermined\nvalue. This value is specific to the infected machine and is based on the hard drive’s volume\nserial number. The malware purposefully does this to make hardcoded indicator of\n\n\n-----\n\ncompromise (IOC) detection impossible on machines.\n\n**_Pipe name generation code_**\n\n\n-----\n\nAfter generating the pipe name, the data received from the pipe is cross-checked as follows:\n\n1. A 4-byte random integer is generated and sent across the pipe.\n\n2. A 4-byte integer is read from the pipe.\n\n3. The integrity of communication is checked using the following check (WRITE_DWORD >>\n2) + WRITE_DWORD == READ_DWORD.\n\n4. If the check is passed, another DWORD is written, which is generated from\n(READ_DWORD >> 2)\n\n5. The calling process terminates.\n\n## A chink in Tofsee’s armor\n\nHere, where the data check creates the binary, there is the potential to leverage this process\nfor the vaccine on the proviso that the binary isn’t already running. If it is running,\nunfortunately, the opportunity to stop it is missed.\n\nBut let’s focus on the scenario where the pipe doesn’t exist; from here, an IPC pipe of the\nsame name is created, and another set of data is received and cross-checked with specific\nparameters. These checks are a little more complex than the previous ones:\n\n\n-----\n\n1. A 4-byte integer is read from the pipe.\n2. A 4-byte integer is generated from right-shifting the integer by 2 and adding it back.\n\n3. Two internally defined structures are read successively from the pipe. These structures\nare defined as follows:\n\nAt this point, the vaccine packet can be used.\n\n**_Tofsee Vaccine structures_**\n\n## The entire code for the Tofsee vaccine\n\nBelow is the complete C code that you can use as a vaccine for new infections of Tofsee and\nexisting ones, named as first dose vaccine and booster vaccine (ring any bells from the\nCOVID days?!?).\n\n\n-----\n\n-----\n\n-----\n\n-----\n\n-----\n\n-----\n\nHappy vaccination coding!\n\nIn [our next blog post, we’ll look at a second vaccine you can use to protect against Tofsee.](http://www.spamhaus.com/resource-center/neutralizing-tofsee-spambot-part-2-inmemoryconfig-store-vaccine)\nThis one concentrates on injecting code into the memory configuration store.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-04-06 - Neutralizing Tofsee Spambot – Part 1 - Binary file vaccine.pdf"
    ],
    "report_names": [
        "2023-04-06 - Neutralizing Tofsee Spambot – Part 1 - Binary file vaccine.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1683338969,
    "ts_updated_at": 1743041141,
    "ts_creation_date": 1683251412,
    "ts_modification_date": 1683251412,
    "files": {
        "pdf": "https://archive.orkl.eu/a3131600a01952b8cbf2bd18dc882576d5f65536.pdf",
        "text": "https://archive.orkl.eu/a3131600a01952b8cbf2bd18dc882576d5f65536.txt",
        "img": "https://archive.orkl.eu/a3131600a01952b8cbf2bd18dc882576d5f65536.jpg"
    }
}