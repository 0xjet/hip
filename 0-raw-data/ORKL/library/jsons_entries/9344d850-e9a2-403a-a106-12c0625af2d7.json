{
    "id": "9344d850-e9a2-403a-a106-12c0625af2d7",
    "created_at": "2023-01-12T15:00:29.040402Z",
    "updated_at": "2025-03-27T02:05:40.351376Z",
    "deleted_at": null,
    "sha1_hash": "4165039e6f5f3ff788f5b799e9cd958f934e74c8",
    "title": "2021-04-24 - Initial analysis of PasswordState supply chain attack backdoor code",
    "authors": "",
    "file_creation_date": "2022-05-28T03:42:13Z",
    "file_modification_date": "2022-05-28T03:42:13Z",
    "file_size": 101569,
    "plain_text": "# Initial analysis of PasswordState supply chain attack backdoor code\n\n**[lordx64.medium.com/initial-analysis-of-passwordstate-supply-chain-attack-backdoor-code-aaff1df389e4](https://lordx64.medium.com/initial-analysis-of-passwordstate-supply-chain-attack-backdoor-code-aaff1df389e4)**\n\ntaha aka lordx64 April 24, 2021\n\ntah\na aka\n\n\n[taha aka lordx64](https://lordx64.medium.com/?source=post_page-----aaff1df389e4--------------------------------)\n\nApr 23, 2021\n\n\n7 min read\n\nPhoto by on\n**[UPDATE — 24 April 2021: The second stage payload was shared with me by Peter Kruse (@PeterKruse) thanks to him. Please find the](https://twitter.com/peterkruse)**\nsecond stage payload analysis at the end of this document.\n\nOne hour ago, I became aware of this supply chain attack from a tweet by Kim Zetter. If you don’t follow her please do and subscribe to her\n[blog for amazing cyber espionage related content : zetter@substack.com](http://10.10.0.46/mailto:zetter@substack.com)\n\nWhy this quick analysis? well it’s Friday, and this news will worry a lot of people, and many would want to know what is this about and fast.\n\nNote: Based on ClickStudios customers, this attack might be impacting 29 000 enterprise customers including many Fortune 500 clients.\n\nBased on the initial information we have, I will explain in details how this legitimate software: PasswordState from ClickStudios, was\nbackdoored, as well as how to detect this backdoor.\n\nThere was an official statement from CSIS group on their website, saying that ClickStudios recently notified their customers about a breach\nresulting in a supply chain attack conducted via an update of the password manager PASSWORDSTATE. the attack was noticed between 20th\nof April 2021 8:33 PM UTC and 22nd of April 2021 00.30am UTC\n\n\n-----\n\nsource:\nCSIS group shared IOC’s, I confirmed them and below is the analysis of the backdoor code.\n\nSample in question is a rogue DLL file, downloaded during an update of PasswordState ( I am not sure yet which version of PasswordState\nexactly): f23f9c2aaf94147b2c5d4b39b56514cd67102d3293bdef85101e2c05ee1c3bf9 Moserware.SecretSplitter.dll\n\nThe backdoor code was inserted in the assembly, via a Loader method see below :\n\n\n-----\n\n-----\n\nclean vs backdoored\n(compared it with a clean version of this dll: 1ee0f14c44058e3d0d1c19b4713d573c81b49c28ed58bd41c72832c78f7d1464)\n\nNext let’s jump into the backdoor code and how it’s been called from the legitimate code:\n\nInside the namespace Moserware.Security.Cryptography, there’s class named Diffuser, containing a protected method called Diffuse() which is\nthe constructor of this virtual class:\n\n\n-----\n\n-----\n\n-----\n\nclean vs backdoored version\nI checked how this class Diffuser() was called, it is indeed used by 3 other classes, amongst them XteaDiffuser that inherit from Diffuser.\n\n\n-----\n\nc ea s e e y t e a object tea use s sta t ated t e co st ucto use () be ca ed a d t e bac doo code u\nXteaDiffuser object is used by SsssDiffuser() Class as an attribute and used for every Xtea encryption/decryption operations (kinda like a\nwrapper). which in turn called by SecretSplitter as the default diffuser. It seems PasswordState uses Xtea for splitting the secret password\n(based on SecretSplitter class name, didn’t look in the code in details):\n\nBack to the diffuser() constructor:\n\n\n-----\n\nWe have a method Container.Running(), taking 5 arguments. amongst them a URL that points to a zip file? to be downloaded from\n**passwordstate-18ed2[.]kxcdn.com, and a sort of hash, which is as we will see later, is the AES password to decrypt the downloaded file.**\n\nlet’s look at the Container.Running() function:\n\n\n-----\n\nThis function checks if the current process name is “Passwordstate” then Container class attributes are set (url, decryption key, interval,\nassemblyType (set to “Agent.Agent”), assemblyMethod (set to “Invoke”)) and the method Container.ThreadFunc() is run in a Thread in the\nbackgroud.\n\nLet’s look at Container.ThreadFunc()\n\n\n-----\n\nThis function will download a file, via the method Container.Get(), will AES decrypt it using the password:\n**f4f15dddc3ba10dd443493a2a8a526b0 and pass it to the Loader Class(), we will describe what this class does later, then the method**\nLoader.Process() is called.\n\nContainer.Get() will set the correct User-Agent, will activate Certificate pining checks, and download a file and store it in memory:\n\n\n-----\n\nNote of the User-Agent used by this backdoor is the following:\n\n“Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.128 Safari/537.36”;\n\nNotice that it is a GET request, and the url is appended with a param “?id=” containing the Datetime.UtcNow.ToFileTime().ToString() this\nreturns a string representing value of the current DateTime object expressed as a Windows file time.\n\nA Windows file time is a 64-bit value that represents the number of 100-nanosecond intervals that have elapsed since 12:00 midnight, January\n1, 1601 A.D. (C.E.) Coordinated Universal Time (UTC).\n\nAnd If we convert the value given in the CSIS website about this backdoor :\n\n\n-----\n\nsource :\nit corresponds to :\n\n**GMT: Friday, April 23, 2021 8:22:07 PM**\n\nFinally, now that the file upgrade_service_upgrade.zip was downloaded and stored in memory. let’s check what the Loader() class will do with\nthis file. Loader class will set the correct attributes in the constructor. Then as we saw earlier, the backdoor called Process() function, which in\nturn calls the method below ThreadFunc():\n\n\n-----\n\nThis method will load the assembly (the downloaded file) and will execute a method “Invoke”, invoked with null parameters (Invoke(null, null)).\nWe at this point assume that this second stage downloaded is ultimately a valid PE file (after being AES decrypted).\n\nNote: based on the AES ECB decryption function below, this file, should be a valid base64 blob.\n\n\n-----\n\nAESDecrypt function from Moserware.SecretSplitter.dll\nWhat’s in the file upgrade_service_upgrade.zip ? we don’t know, it is fair to assume it’s an AES encrypted PE file encoded in base64, it seems\nit’s not available to download from the C2, nor it is available in usual online malware repositories. to be continued..I will keep this blog open for\nmore updates, as I continue the analysis.\n\nShould you worry? I guess if you have any version of PasswordState it is worth to check the DLL Moserware.SecretSplitter.dll against the\nfinding in this blog, or against this YARA rule that I just wrote (not tested in production)\n```\nrule MOSERPASS_LOADER{\nmeta:\n    author = \"lordx64\"\n    info = \"moserpass loader detection rule\"\n      strings:    $s1 = \"Loader\"     $s2 = \"ThreadFunc\"     $s3 = \"Mozilla/5.0 (Windows NT 10.0; Win64; x64)\nAppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.128 Safari/537.36\" wide     $s4 = \"upgrade_service_upgrade.zip\"\nwidecondition:    uint16(0) == 0x5A4D and uint32(uint32(0x3C)) == 0x00004550 and all of them}\n\n```\nIf you are victim of a supply chain attack like this one, cleaning up the software isn’t enough, you might need to start investigating your whole\ninfrastructure accordingly.\n\n**[UPDATE — 24 April 2021: The second stage payload was shared with me by Peter Kruse (@PeterKruse) thanks to him. Please find the](https://twitter.com/peterkruse)**\nsecond stage payload analysis below:\n\nDecoded and decrypted the payload using the following script:\n\n\n-----\n\nThis gave us the following file: c2169ab4a39220d21709964d57e2eafe4b68c115061cbb64507cfbbddbe635c6\n\nSecond stage payload was exactly what we assumed, a base64 blob, of an AES encrypted payload, with exported function called “Invoke()”\nwith no parameters.\n\nIn the function Invoke() relies all the DLL functionality :\n\n\n-----\n\nIt first collects a bunch of information related to the current USER:\n\nComputer name\nUser Name\nUser Domain\n\nAlso information related to PasswordState, including:\n\nPasswordState Proxy Username\nPasswordState Proxy Password\n\n\n-----\n\nBut most importantly All the PasswordState stored passwords of the current USER, are also exfiltrated:\n\n\n-----\n\nThe technique used by this Threat Actor is to be able to load the assembly from the the CurrentDomain by locating the wanted assembly by\nname using the following FindAssembly() method:\n\n\n-----\n\nOnce the assembly located, they can execute methods from this Assembly object in memory (since this is assembly was loaded in the same\ndomain as PasswordState), for example getting properties like the DBConnectiongString from the PasswordstateService.GlobalSettings\nto query the Passwords database:\n\n\n-----\n\nBut also calling the AES_Decrypt function directly from the Assembly to decrypt password field.. (it seems this function didn’t needed the\npassword to be passed as a parameter)\n\n\n-----\n\nThis data is then AES encrypted using a key having this form: MD5(“helloworld”), and sent back to the same CDN where this second stage\nwas previously hosted:\n\n\n-----\n\nFor research purpose I uploaded this MOSERPASS final payload to VirusTotal:\n\n[https://www.virustotal.com/gui/file/c2169ab4a39220d21709964d57e2eafe4b68c115061cbb64507cfbbddbe635c6/detection](https://www.virustotal.com/gui/file/c2169ab4a39220d21709964d57e2eafe4b68c115061cbb64507cfbbddbe635c6/detection)\n\n## Last notes:\n\nClickStudios, 29 000 enterprise customers including many Fortune 500 clients if targeted by MOSERPASS, are at high risk of having their\nnetworks and user accounts compromised.\n\n## Indicators of compromise:\n\nMOSERPASS Loader: f23f9c2aaf94147b2c5d4b39b56514cd67102d3293bdef85101e2c05ee1c3bf9\n\nMOSERPASS: c2169ab4a39220d21709964d57e2eafe4b68c115061cbb64507cfbbddbe635c6\n\nMOSERPASS C2:\n\n**passwordstate-18ed2[.]kxcdn.com**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-24 - Initial analysis of PasswordState supply chain attack backdoor code.pdf"
    ],
    "report_names": [
        "2021-04-24 - Initial analysis of PasswordState supply chain attack backdoor code.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535629,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1653709333,
    "ts_modification_date": 1653709333,
    "files": {
        "pdf": "https://archive.orkl.eu/4165039e6f5f3ff788f5b799e9cd958f934e74c8.pdf",
        "text": "https://archive.orkl.eu/4165039e6f5f3ff788f5b799e9cd958f934e74c8.txt",
        "img": "https://archive.orkl.eu/4165039e6f5f3ff788f5b799e9cd958f934e74c8.jpg"
    }
}