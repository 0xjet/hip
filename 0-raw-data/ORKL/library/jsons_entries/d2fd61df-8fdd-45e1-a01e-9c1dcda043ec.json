{
    "id": "d2fd61df-8fdd-45e1-a01e-9c1dcda043ec",
    "created_at": "2023-01-12T15:01:20.771121Z",
    "updated_at": "2025-03-27T02:05:56.041108Z",
    "deleted_at": null,
    "sha1_hash": "5ddc27ba9b071f90bd2468788974035c88b2caf4",
    "title": "2021-07-06 - How the Kaseya VSA Zero Day Exploit Worked",
    "authors": "",
    "file_creation_date": "2022-05-27T19:08:18Z",
    "file_modification_date": "2022-05-27T19:08:18Z",
    "file_size": 6226693,
    "plain_text": "# How the Kaseya VSA Zero-Day Exploit Worked\n\n**blog.truesec.com/2021/07/06/kaseya-vsa-zero-day-exploit**\n\nThis article explains the pre-auth remote code execution exploit against Kaseya VSA Server that was used in the mass Revil ransomware\nattack on July 2, 2021. After validating the patch and verifying that the attack vector is no longer present, we believe it is time to share these\ndetails for the benefit of the community.\n\nOn July 5, after an initial investigation of affected organizations, Truesec contacted Kaseya and provided a detailed technical write-up of these\nvulnerabilities along with forensic evidence of exploitation. Kaseya released the patch 9.5.7a (9.5.7.2994) that addresses the security issues\non July 11.\n\nWe strongly believe this information will help the security community in their response to the attack and from a larger perspective it will help the\nindustry understand what happened so we can address the underlying issues, and ultimately increase our capabilities to prevent future\nbreaches.\n\n### Overview\n\nThe exploit abused four vulnerabilities in the Kaseya application that were chained as visualized in the figure below.\n\n\n-----\n\n## The High-Level Steps of the Exploit\n\n[1. Obtained an authenticated session by abusing a flaw in the authentication logic [CWE-304] in /dl.asp.](http://cwe.mitre.org/data/definitions/304.html)\n[2. Uploaded the revil ransomware (agent.crt) through an unrestricted upload vulnerability [CWE-434] while also bypassing the request](http://cwe.mitre.org/data/definitions/434.html)\n\n[forgery protection [CWE-352] in /cgi-bin/KUpload.dll.](http://cwe.mitre.org/data/definitions/352.html)\n3. Uploaded the ASP payload (screenshot.jpg) in the same fashion as described in 2.\n[4. Invoked the payload in screenshot.jpg through a local code injection vulnerability [CWE-94] in userFilterTableRpt.asp.](http://cwe.mitre.org/data/definitions/94.html)\n5. Created Kaseya procedures to copy files and execute the ransomware.\n6. Executed the procedures.\n7. Removed logs and other forensic evidence.\n\nHere we will focus on the exploit and describe steps 1 through 4 in detail.\n\nThe payloads are not in scope for this article.\n\n## Step 1 – Bypassing Authentication [CWE-304]\n\nThe threat actor first sent a POST request to the resource /dl.asp with the POST data userAgentGuid=guid.\n\nFirst request of the exploit: authentication bypass\n\nIn dl.asp, userAgentGuid is used in a SELECT query to lookup the database row of the agent. The agentGuid must exist due to the\nsubsequent if statement. The threat actor used the agentGuid of the agent on the VSA server itself (more on this below).\n\nAfter the lookup, dl.asp tries to see if the provided password matches the values stored in the database for that agent. The provided password\nis then compared in several different ways. The login flow is illustrated in the pseudo code below:\n\nif password == hash(row[nextAgentPassword] + row[agentGuidStr])\n\nlogin ok\n\nelseif password == hash(row[curAgentPassword] + row[agentGuidStr])\nlogin ok\n\nelseif password == hash(row[nextAgentPassword] + row[displayName])\n\nlogin ok\n\n\n-----\n\ne se pass o d as ( o [cu ge t ass o d] o [d sp ay a e])\nlogin ok\nelseif password == row[password]\nlogin failed\nelse\nlogin ok\n\nThe last two statements are where the interesting thing happens. In case the password equals row[password] the login will fail. However, in\n**the case that all checks failed, it would default to an else clause that sets “loginOK” to true.**\n\nBecause no password was provided in the request, the “password” variable would be NULL and loginOK would end up being true. When\nloginOK is set to true, the application sends the login session cookie and will eventually (if no other parameters are provided like in the\nattacker’s request) end up in an if clause that returns 302 redirect to the userPortal.\n\nResponse to authentication\n\nbypass request\n\n### How Did the Actor Obtain the AgentGuid?\n\nThe outstanding question is how the threat actor obtained around 60 (estimated number of VSA victims) unique valid agentGuids. It appears\nthey simply knew the agentGuids before launching the attack.\n\nTruesec has discovered several methods the attack could have been performed without prior knowledge of a valid agentGuid. An example that\nwas also fixed in 9.5.7a is that the userAgentGuid parameter could have been <vsa_server_hostname>.root.kserver instead of an actual\nagentGuid. Due to what was described as legacy code, in case agentGuid is not a number, it will lookup the agentGuid automatically from the\ntable machNameTab.\n\nTruesec has not found and is not aware of any public evidence that shows exactly how these agentGuids were obtained. Possibly, these\nrandom agentGuids might have been what limited the impact of the attack to under 60 out of around 35 000 Kaseya VSA customers.\n\n## Steps 2 and 3 – Uploading Files [CWE-434] [CWE-352]\n\nAll requests from this point on used the authenticated session obtained in step one.\n\nThe threat actor started the upload by sending a GET request to /done.asp without any parameters. When receiving the request, the\napplication creates a row in the tempData table, stages an upload folder, and finally returns a so-called loadKey value. A valid loadkey is\nrequired to perform the file upload.\n\n\n-----\n\nRequest and response to obtain a valid loadKey\n\nTo upload files the threat actor sent a multiform-data POST request to the resource /cgi-bin/KUpload.dll. The request contained the following\nparameters:\n\nFileName (name of the file)\nFileData (content of the file to upload)\nLoadKey (the value obtained by GETting done.asp)\nRedirectPath (path that the application will redirect to after successful upload)\nPathData (folder the file will be saved in)\n__RequestValidationToken (bypassable CSRF token)\n\n### Bypassing the CSRF Protection\n\nThe __RequestValidationToken was not properly validated. For example, the value “xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx” was accepted as\na valid token.\n\n### Uploading the Ransomware (Agent.crt)\n\nThe first upload performed by the threat actor was a file named agent.crt. This file was an encoded version of the ransomware that was later\npushed to all agents from the compromised VSA server.\n\n\n-----\n\nUpload of agent.crt.\n\nUpon successful upload, the server returns HTTP 200 OK with a body containing a link pointing to /<redirectPath>?FileName=\n<filename>&PathData=<relative path>&originalName=<filename>&FileSize=<size>&TimeElapsed=<time>.\n\nIn this case, as the file upload was successful, the returned link was /done.asp?\nFileName=agent.crt&PathData=WebPages\\ManagedFiles\\VSATicketFiles\\&originalName=agent.crt&FileSize=1221630&TimeElapsed=00:00:00.82\n\n### Uploading the ASP Payload (Screenshot.jpg)\n\nThe threat actor uploaded another file named Screenshot.jpg. This was not a jpg file but rather a text file containing ASP code. After obtaining\nanother loadKey value from /done.asp the threat actor uploaded the file. Partial contents of the request can be seen in the figure below\n(unfortunately only a partial capture was obtained and the middle part of screenshot.jpg was missing).\n\n\n-----\n\nLast part of uploaded screenshot.jpg.\nThe response body link in this case was /done.asp?\nFileName=Screenshot.jpg&PathData=WebPages\\ManagedFiles\\VSATicketFiles\\&originalName=Screenshot.jpg&FileSize=6188&TimeElapsed=00\nwhich indicates that the file was successfully uploaded.\n\n## Step 4 – Executing the Payload on the Server [CWE-94]\n\nFinally, the threat actor sent a POST request to /userFilterTableRpt.asp with the pageFilterSQLFile argument.\n\n\n-----\n\nExploiting the code injection vulnerability.\n\nDue to a flaw in userFilterTableRpt.asp, the contents of the specified file would be interpreted as ASP code as it was passed to the function\n_eval. In this case, ManagedFiles/VSATicketFiles/Screenshot.jpg, the ASP code text file the threat actor just uploaded._\n\nFirst, userFilterTableRpt.asp sets a variable from the POST parameter. Then it reads the contents of the specified file and passes it to eval,\nwhich will by definition interpret the value of the argument as code. The flow is illustrated in the pseudo code below:\n\nf = open (pageFilterSQLFile)\nc = read (f)\neval (c)\n\nAnd that is it. The ASP payload was executed and started pushing out the ransomware, and we all know the story from there.\n\n## Final Words\n\nAfter a patch has been made available to customers of Kaseya VSA, and after we have validated the patch to verify that the attack vector is no\nlonger present, we believe it is time to share these details for the benefit of the community.\n\nWe strongly believe this information will help the security community in their response to the attack and from a larger perspective it will help the\nindustry understand what happened so we can address the underlying issues, and ultimately increase our capabilities to prevent future\nbreaches.\n\n**Finally, a big thanks to everyone in the security community who shared their findings throughout this incident. We truly appreciate the**\ncollaborative spirit that ultimately benefits everyone.\n\n## Timeline\n\n[2021-07-02] Threat actor exploited vulnerabilities in the wild to mass-deploy ransomware.\n\n[2021-07-04] Truesec obtained evidence that was helpful to understand the exploit.\n\n[2021-07-05] Truesec sent a detailed write-up of the vulnerabilities along with supporting forensic evidence to Kaseya.\n\n[2021-07-11] Kaseya released a security patch.\n\n[2021-07-12] Truesec validated the patch.\n\n[2021-07-13] Truesec published this article.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-06 - How the Kaseya VSA Zero Day Exploit Worked.pdf"
    ],
    "report_names": [
        "2021-07-06 - How the Kaseya VSA Zero Day Exploit Worked.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535680,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653678498,
    "ts_modification_date": 1653678498,
    "files": {
        "pdf": "https://archive.orkl.eu/5ddc27ba9b071f90bd2468788974035c88b2caf4.pdf",
        "text": "https://archive.orkl.eu/5ddc27ba9b071f90bd2468788974035c88b2caf4.txt",
        "img": "https://archive.orkl.eu/5ddc27ba9b071f90bd2468788974035c88b2caf4.jpg"
    }
}