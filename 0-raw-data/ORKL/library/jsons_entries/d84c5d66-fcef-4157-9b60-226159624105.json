{
    "id": "d84c5d66-fcef-4157-9b60-226159624105",
    "created_at": "2023-01-12T15:08:44.076433Z",
    "updated_at": "2025-03-27T02:14:05.067082Z",
    "deleted_at": null,
    "sha1_hash": "7312b21cd680e88544458388fabe707b1bb37da7",
    "title": "2022-06-01 - CUBA Ransomware Malware Analysis",
    "authors": "",
    "file_creation_date": "2022-06-13T04:00:35Z",
    "file_modification_date": "2022-06-13T04:00:35Z",
    "file_size": 1122879,
    "plain_text": "# CUBA Ransomware Malware Analysis\n\n**elastic.co/security-labs/cuba-ransomware-malware-analysis**\n\nBy\n\nSalim Bitam\n\n01 June 2022\n\n## Summary\n\nAs a part of Elastic Security’s ongoing threat detection and monitoring efforts, we have recently\nobserved a ransomware intrusion by the CUBA ransomware threat group, internally tracked as\nREF9019. This report will detail the inner workings of the ransomware deployed inside the network to\nencrypt the victim’s files. Cuba ransomware provides the attacker with the flexibility to encrypt both\nlocal and network shares files in the enterprise. CUBA uses the ChaCha20 cipher algorithm for\nsymmetric encryption and RSA encryption to protect the ChaCha20 keys. CUBA is multithreaded for\nfaster encryption with resource access synchronization to avoid file corruption.\n\nIn this analysis we will describe the following:\n\nOperations mode\nProcess and services termination\nEnumeration of volumes\nThreading implementation\n\n\n-----\n\nFile encryption and algorithms used\nMITRE Attack mapping\nYARA rule\nIndicators of compromise\n\n### Static Analysis\n\n**SHA256 Packed** 0f385cc69a93abeaf84994e7887cb173e889d309a515b55b2205805bdfe468a3\n\n**SHA256 Unpacked** 3654af86dc682e95c811e4fd87ea405b627bca81c656f3a520a4b24bf2de879f\n\n**File Size** 135168 bytes\n\n**FileType:** Executable\n\n**Imphash:** CA5F4AF10ABC885182F3FB9ED425DE65\n\n**Compile Time** Wed Mar 09 22:00:31 2022 | UTC\n\n**Entropy** 6.582\n\n### Sections\n\n\n**Name** **VirtualAddress** **Virtual**\n**Size**\n\n\n**Raw**\n**Size**\n\n\n**Entropy** **MD5**\n\n\n.text 0x00401000 0x13B5F 0x13C00 6.608 931B22064E9E214BF59A4E07A6CA9109\n\n.rdata 0x00415000 0xA71C 0xA800 5.855 F6F97411BCD64126A96B08BA9AE1E775\n\n.data 0x00420000 0x16B0 0xC00 3.450 03B1B11B4531BB656E43A8B457D4A5F7\n\n.rsrc 0x00422000 0x1E0 0x200 4.704 F754ADBD7F5D6195FD6D527001CAB98C\n\n.reloc 0x00423000 0x1200 0x1200 6.573 08B0994DAECAAAA4173B388A80CC52FE\n\nCUBA Campaign Analysis\n\nIf you're interested in a technical deep-dive on the CUBA campaign, check out our campaign analysis\nresearch [here.](https://www.elastic.co/security-labs/cuba-ransomware-campaign-analysis)\n\n### Imports\n\n\n-----\n\n```\nGetProcessImageFileNameW\nEnumProcesses\nNetApiBufferFree\nNetShareEnum\nGetIpNetTable\nPathFindFileNameW\nFindFirstFileExW\nFindFirstFileW\nFindNextFileW\nWriteFile\nSetFileAttributesW\nMoveFileExW\nFindFirstVolumeW\nTerminateProcess\nGetEnvironmentStringsW\nOpenProcess\nGetCurrentProcessId\nCreateProcessW\nGetVolumePathNamesForVolumeNameW\nFindNextVolumeW\nGetCurrentThreadId\nRaiseException\nGetModuleHandleExW\nOpenProcessToken\nCryptAcquireContextA\nCryptGenRandom\nCryptReleaseContext\nAdjustTokenPrivileges\nLookupPrivilegeValueA\nControlService\nChangeServiceConfigW\nPathAddBackslashW\nGetCPInfo\nGetOEMCP\nIsValidCodePage\nlstrcpynW\nInterlockedDecrement\nFindClose\nCreateFileW\nSleep\nlstrcatW\nCloseHandle\nCreateThread\nlstrcpyW\nlstrcmpW\nReadFile\nGetFileSizeEx\nEnterCriticalSection\nGetCurrentProcess\nGetModuleFileNameW\nLeaveCriticalSection\nGetCommandLineA\nWaitForSingleObject\nGetLastError\nSetEvent\nGetDiskFreeSpaceExW\nResetEvent\nGetWindowsDirectoryW\nSetFilePointerEx\nExitProcess\nCreateEventA\n\n```\n\n-----\n\n```\nlstrcmpiW\nGetTickCount\nDeleteCriticalSection\nQueryPerformanceCounter\nSetStdHandle\nFreeEnvironmentStringsW\nGetCommandLineW\nDecodePointer\nGetStringTypeW\nGetProcessHeap\nFlushFileBuffers\nGetConsoleCP\nHeapSize\nWriteConsoleW\nInitializeCriticalSection\nUnhandledExceptionFilter\nSetUnhandledExceptionFilter\nIsProcessorFeaturePresent\nInitializeCriticalSectionAndSpinCount\nWaitForSingleObjectEx\nCreateEventW\nGetModuleHandleW\nGetProcAddress\nIsDebuggerPresent\nGetStartupInfoW\nGetSystemTimeAsFileTime\nInitializeSListHead\nRtlUnwind\nSetLastError\nEncodePointer\nTlsAlloc\nTlsGetValue\nTlsSetValue\nTlsFree\nFreeLibrary\nLoadLibraryExW\nGetFileType\nGetStdHandle\nMultiByteToWideChar\nWideCharToMultiByte\nGetACP\nHeapFree\nHeapAlloc\nLCMapStringW\nHeapReAlloc\nGetConsoleMode\nCharLowerW\nGetKeyboardLayoutList\nwsprintfW\nCloseServiceHandle\nOpenSCManagerW\nOpenServiceW\nQueryServiceStatusExRead more\n\n### Strings\n\n```\n\n-----\n\n```\nGood day. All your files are encrypted. For decryption contact us.\nWrite here waterstatus@cock.li\nreserve admin@encryption-support.com\njabber cuba_support@exploit.im\nWe also inform that your databases, ftp server and file server were downloaded by us to our\nservers.\nIf we do not receive a message from you within three days, we regard this as a refusal to\nnegotiate.\nCheck our platform: http://cuba4ikm4jakjgmkezytyawtdgr2xymvy6nvzgw5cglswg3si76icnqd.onion/\n* Do not rename encrypted files.\n* Do not try to decrypt your data using third party software,\n it may cause permanent data loss.\n* Do not stop process of encryption, because partial encryption cannot be decrypted.\n!! READ ME !!.txtRead more\n\n## Code Analysis\n\n### Entry Point\n\n```\nThe malware starts by retrieving the active input locale identifier of the victim using the\nGetKeyboardLayout API. When the Russian language is in the list of supported languages of the\nmachine, the process deletes and terminates itself with a simple command line: c:\\system32\\cmd.exe\nc/ del PATH_TO_BINARY without encrypting the file system.\n\n### Command-line Options\n\nThe threat actor included 4 different operations based on the following command-line arguments:\n\nThe network keyword\nAn IP keyword\nA path keyword\nThe local keyword\n\n\n-----\n\n**Network keyword parameter**\n\nWhen specifying the network keyword, the malware retrieves the Address Resolution Protocol (ARP)\ntable of the machine using the GetIpNetTable Windows API and enumerates the shares of each IP in\nthe ARP table, this information is added to a linked list that will be accessed by the encryption\ncapability, which will be discussed further below in detail.\n\n**IP keyword parameter**\n\nBy specifying an IP address as the first parameter in the command line the malware proceeds by\nenumerating and encrypting every share found for the specified IP.\n\n\n-----\n\n**Path keyword parameter**\n\nThe malware will encrypt the local directory contents, or the file provided, as the first parameter of the\ncommand-line.\n\n**Local keyword parameter**\n\nThe local keyword is used to encrypt every local volume on the machine, and because the malware\ntargets volumes by their ID, it can encrypt both mounted and unmounted volumes.\n\n### Process Termination\n\nCUBA starts by acquiring SeDebugPrivilege and then terminates a hardcoded list of processes and\n[services using a common Windows API (see appendix for list [1], [2]). For some services, the malware](https://www.elastic.co/security-labs/cuba-ransomware-malware-analysis#list-of-terminated-processes)\nfirst tries to disable the service– indicated by the second parameter of\nTerminateProcesses::TerminateServiceByName function. This is mainly done to prevent interference\nwith the encryption process by applications that may lock files from external changes, for example,\ndatabases.\n\n### Local Volume Enumeration\n\nThe malware enumerates all the local volumes and for each volume larger than 1GB it saves the\nvolume’s GUID in a custom linked list. The ransomware utilizes the CriticalSection object to access this\nlinked list for synchronization purposes due to multiple threads accessing the same resource. This\n\n\n-----\n\nhelps to avoid two threads encrypting the same file at the same time, a race condition that would\ncorrupt the file.\n\n### Multithreaded Encryption Synchronization\n\nAfter preparing a list to encrypt, CUBA ransomware spawns encryption threads with the structure\ndefined below as a parameter. Depending on the command line arguments, the malware starts 4\nthreads for local encryption or 8 threads for network encryption.\n\n\n-----\n\nWhen a thread finishes its task, it will decrement a counter until it reaches 0: lpParameter>NumberOfThreadRunning. When the last thread completes, it will alert the program that the task is\ndone with a call to SetEvent API, which will self delete and terminate the malware.\n\n### Encryption Implementation\n\nThe malware leverages the symmetric encryption algorithm ChaCha20 to encrypt files and the\nasymmetric encryption algorithm RSA to protect the ChaCha20 Key and Initialization Vector (IV). The\n[author has utilized a customized version of WolfSSL, an open source SSL/TLS library, to implement](https://github.com/wolfSSL/wolfssl)\nthis capability. Other samples\n(2957226fc315f71dc22f862065fe376efab9c21d61bbc374dde34d47cde85658) implemented a similar\n[function using the libtomcrypt library. Other implementations may exist that are not described here.](https://github.com/libtom/libtomcrypt)\n\nThe ransomware allocates a large custom structure called block that contains all the required\n[encryption information. It then initializes an RsaKey structure with wc_InitRsaKey and decodes an](https://www.wolfssl.com/doxygen/group__RSA.html#ga02c9b34d405c5f1c24956ee84a843ef6)\n[embedded 4096 bit RSA public key in DER format using](https://wiki.openssl.org/index.php/DER) [wc_RsaPublicKeyDecode which it saves to](https://www.wolfssl.com/doxygen/group__RSA.html#ga2610326206b322f33f59e31a845e24b9)\nblock.PubRsaKey.\n\n### File Enumeration\n\nEach thread takes an entry from the linked list and starts recursively enumerating files starting from the\nroot of the volume. In the case of a specific directory, the same function is called recursively except for\n[specific directories (see appendix for list). Otherwise, it will ignore the ransom note file !! READ ME](https://www.elastic.co/security-labs/cuba-ransomware-malware-analysis#excluded-directories)\n[!!.txt and files with specific extensions (see appendix for list).](https://www.elastic.co/security-labs/cuba-ransomware-malware-analysis#excluded-file-extensions)\n\n\n-----\n\n[The malware uses wc_RNG_GenerateBlock a WolfSSL function, to randomly generate 44 bytes. The](https://www.wolfssl.com/doxygen/group__Random.html#ga9a289fb3f58f4a5f7e15c2b5a1b0d7c6)\nfirst 32 bytes of that are used as the ChaCha20 key and the other 12 bytes are used as the IV, it then\ncalls a function to initiate the ChaCha20 structure block.chacha20_KeyIv that will be later used to\nencrypt the file content. At this point, the ransomware is ready to start encrypting and writing to the file.\n\nBefore encrypting a file, Cuba ransomware prepends a 1024 byte header, the first 256 bytes are the\nstring FIDEL.CA and some DWORD bytes values, the next 512 bytes are the encrypted ChaCha20\nKEY/IV with the public RSA key and the rest is padded with 0.\n\n\n-----\n\nBefore starting the encryption, the malware double checks if the file was already encrypted by\ncomparing the first 8 bytes of the file to the header string FIDEL.CA. If equal, the malware terminates\nthe encryption process as described below.\n\n\n-----\n\nThen CUBA writes the 1024 byte header and if the file is larger than 2 MB it reads 1 MB of data at a\ntime from the file and encrypts it with the ChaCha20 cipher. Otherwise, it will read and encrypt the\nentire contents at once.\n\nThe malware encrypts the file in 1 MB chunks and, depending on the file’s size, it will skip a preset\nnumber of bytes. This is done primarily to speed up the encryption process of large files, below is a\ntable to illustrate.\n\nFile Size Chunk Size Skipped Size\n\nLess than 2 MB All the file content 0 MB\n\n\n-----\n\nLess than 10 MB 1MB 4 MB\n\nLess than 50 MB 1MB 8 MB\n\nLess than 200 MB 1MB 16 MB\n\nLess than 10 GB 1MB 200 MB\n\nMore than 10 GB 1MB 500 MB\n\nFinally, it will rename the file by adding the extension .cuba.\n\n## MITRE ATT&CK Techniques\n\nUsing the MITRE ATT&CK® framework, techniques and sub techniques represent how an adversary\nachieves a tactical goal by performing an action.\n\n[Data Encrypted for Impact](https://attack.mitre.org/techniques/T1486/)\n[Network Share Discovery](https://attack.mitre.org/techniques/T1135/)\n[Process Discovery](https://attack.mitre.org/techniques/T1057/)\n[Service Stop](https://attack.mitre.org/techniques/T1489/)\n[System Information Discovery](https://attack.mitre.org/techniques/T1082/)\n[Indicator Removal on Host: File Deletion](https://attack.mitre.org/techniques/T1070/004/)\n[Obfuscated Files or Information: Software Packing](https://attack.mitre.org/techniques/T1027/002/)\n[System Network Configuration Discovery](https://attack.mitre.org/techniques/T1016/)\n[System Location Discovery: System Language Discovery](https://attack.mitre.org/techniques/T1614/001/)\n[Data Encrypted for Impact](https://attack.mitre.org/techniques/T1486/)\n[Access Token Manipulation](https://attack.mitre.org/techniques/T1134/)\n\n\n-----\n\n## Appendix\n\n### List of Terminated Processes\n\nsqlagent.exe\nsqlservr.exe\nsqlwriter.exe\nsqlceip.exe\nmsdtc.exe\nsqlbrowser.exe\nvmwp.exe\nvmsp.exe\noutlook.exe\nMicrosoft.Exchange.Store.Worker.exe\n\n### List of Terminated Services\n\nMySQL\nMySQL80\nSQLSERVERAGENT\nMSSQLSERVER\nSQLWriter\nSQLTELEMETRY\nMSDTC\nSQLBrowser\nvmcompute\nvmms\nMSExchangeUMCR\nMSExchangeUM\nMSExchangeTransportLogSearch\nMSExchangeTransport\nMSExchangeThrottling\nMSExchangeSubmission\nMSExchangeServiceHost\nMSExchangeRPC\nMSExchangeRepl\nMSExchangePOP3BE\nMSExchangePop3\nMSExchangeNotificationsBroker\nMSExchangeMailboxReplication\nMSExchangeMailboxAssistants\nMSExchangeIS\nMSExchangeIMAP4BE\nMSExchangeImap4\nMSExchangeHMRecovery\nMSExchangeHM\nMSExchangeFrontEndTransport\nMSExchangeFastSearch\n\n\n-----\n\nMSExchangeEdgeSync\nMSExchangeDiagnostics\nMSExchangeDelivery\nMSExchangeDagMgmt\nMSExchangeCompliance\nMSExchangeAntispamUpdate\n\n### Excluded Directories\n\n\\windows\\\n\\program files\\microsoft office\\\n\\program files (x86)\\microsoft office\\\n\\program files\\avs\\\n\\program files (x86)\\avs\\\n\\$recycle.bin\\\n\\boot\\\n\\recovery\\\n\\system volume information\\\n\\msocache\\\n\\users\\all users\\\n\\users\\default user\\\n\\users\\default\\\n\\temp\\\n\\inetcache\\\n\\google\\\n\n### Excluded File Extensions\n\n.exe\n.dll\n.sys\n.ini\n.lnk\n.vbm\n.cuba\n\n## YARA Rule\n\nElastic Security has created YARA rules to identify CUBA ransomware activity.\n\n\n-----\n\n```\nrule Windows_Ransomware_Cuba {\n  meta:\n    os = \"Windows\"\n    arch = \"x86\"\n    category_type = \"Ransomware\"\n    family = \"Cuba\"\n    threat_name = \"Windows.Ransomware.Cuba\"\n    Reference_sample = \"33352a38454cfc247bc7465bf177f5f97d7fd0bd220103d4422c8ec45b4d3d0e\"\n  strings:\n    $a1 = { 45 EC 8B F9 8B 45 14 89 45 F0 8D 45 E4 50 8D 45 F8 66 0F 13 }\n    $a2 = { 8B 06 81 38 46 49 44 45 75 ?? 81 78 04 4C 2E 43 41 74 }\n   $b1 = \"We also inform that your databases, ftp server and file server were downloaded by\nus to our   servers.\" ascii fullword\n    $b2 = \"Good day. All your files are encrypted. For decryption contact us.\" ascii\nfullword\n    $b3 = \".cuba\" wide fullword\n  condition:\n    any of ($a*) or all of ($b*)\n}Read more\n\n## Observations\n\n```\nAtomic indicators observed in our investigation.\n\nIndicator Type Note\n\n32beefe2c5e28e87357813c0ef91f47b631a3dff4a6235256aa123fc77564346 SHA256 CUBA\nRansomware\n\n0f385cc69a93abeaf84994e7887cb173e889d309a515b55b2205805bdfe468a3 SHA256 CUBA\nRansomware\n\nbcf0f202db47ca671ed6146040795e3c8315b7fb4f886161c675d4ddf5fdd0c4 SHA256 CUBA\nRansomware\n\n## Artifacts\n\nArtifacts are also available for download in both ECS and STIX format in a combined zip bundle.\n\n## Related content\n\nSee all top stories\n\n\n-----\n\n### CUBA Ransomware Campaign Analysis\n\nElastic Security observed a ransomware and extortion campaign leveraging a combination of offensive\nsecurity tools, LOLBAS, and exploits to deliver the CUBA ransomware malware.\n\n### A peek behind the BPFDoor\n\n\n-----\n\nIn this research piece, we explore BPFDoor — a backdoor payload specifically crafted for Linux in order\nto gain re-entry into a previously or actively compromised target environment.\n\n### Going Coast to Coast - Climbing the Pyramid with the Deimos Implant\n\nThe Deimos implant was first reported in 2020 and has been in active development; employing\nadvanced analysis countermeasures to frustrate analysis. This post details the campaign TTPs\nthrough the malware indicators.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-01 - CUBA Ransomware Malware Analysis.pdf"
    ],
    "report_names": [
        "2022-06-01 - CUBA Ransomware Malware Analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "4f56bb34-098d-43f6-a0e8-99616116c3ea",
            "created_at": "2024-06-19T02:03:08.048835Z",
            "updated_at": "2025-03-27T02:05:17.365266Z",
            "deleted_at": null,
            "main_name": "GOLD FLAMINGO",
            "aliases": [
                "Tropical Scorpius ",
                "UAC-0132 ",
                "UAC-0132 ",
                "UNC2596 ",
                "Void Rabisu ",
                "REF9019 "
            ],
            "source_name": "Secureworks:GOLD FLAMINGO",
            "tools": [
                " Cobalt Strike",
                " Cuba",
                " Meterpreter",
                " Mimikatz",
                " ROMCOM RAT",
                "Chanitor"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536124,
    "ts_updated_at": 1743041645,
    "ts_creation_date": 1655092835,
    "ts_modification_date": 1655092835,
    "files": {
        "pdf": "https://archive.orkl.eu/7312b21cd680e88544458388fabe707b1bb37da7.pdf",
        "text": "https://archive.orkl.eu/7312b21cd680e88544458388fabe707b1bb37da7.txt",
        "img": "https://archive.orkl.eu/7312b21cd680e88544458388fabe707b1bb37da7.jpg"
    }
}