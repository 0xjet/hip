{
    "id": "a9e9f67b-1daa-41e0-86eb-b3a01db07305",
    "created_at": "2023-01-12T14:59:08.962502Z",
    "updated_at": "2025-03-27T02:06:10.45507Z",
    "deleted_at": null,
    "sha1_hash": "e3ab028004192b4665dbfcb6d406cd661c66e17f",
    "title": "2020-01-24 - Project TajMahal IOCs and Registry Data Decrypter",
    "authors": "",
    "file_creation_date": "2022-05-28T17:49:49Z",
    "file_modification_date": "2022-05-28T17:49:49Z",
    "file_size": 136993,
    "plain_text": "# Project TajMahal IOCs and Registry Data Decrypter\n\n**[github.com/TheEnergyStory/malware_analysis/tree/master/TajMahal](https://github.com/TheEnergyStory/malware_analysis/tree/master/TajMahal)**\n\nTheEnergyStory\n\nLast year in April, Kaspersky released an article about a new complex malware framework\n[dubbed TajMahal: https://securelist.com/project-tajmahal/90240/](https://securelist.com/project-tajmahal/90240/)\n\nLater the same year, one of the stated samples from Kaspersky report was uploaded to\nVirustotal:\nhttps://www.virustotal.com/gui/file/0b74fc2594b25987841a7897aff323f4165519e6c26d67925\n6cb0d282a6f0147/\n\nThe sample is a `.NET assembly with obfuscated strings but self explaining code after`\n[decompilation (dnSpy or](https://github.com/0xd4d/dnSpy) [ILSpy). As the names of the namespace and classes imply, the](https://github.com/icsharpcode/ILSpy)\nsample's main purpose is to manage the Windows service persistency.\n\nThis repository contains the `decompiled code with decoded strings (I left the`\ndeobfuscation method in the code), `extracted IOCs and a` `registry config data`\n```\ndecrypter .\n\n## Decompiled and Deobfuscated code\n\n```\nAfter decompilation and string decoding we have a perfect readable C# code. See:\n[Chaperone](https://github.com/TheEnergyStory/malware_analysis/blob/master/TajMahal/Chaperone/)\n\n## IOCs\n\n\n-----\n\n**Type** **Details**\n\n\nScheduled task\nwith name\n\n\nMaintenancePolicy\n\n\nRegistry values Key: HKLM\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\AdaptiveDisplayBrightness\n\nValue: seg0 (unknown content)\n\nValue: seg4 (contains encrypted service config data)\n\n## Code oddities\n\nThe code contains two errors in the `Tools class, not sure if they are caused by the`\ndecompilation engine or are actual coding errors.\n\n1 ) While the Enum reg key is created for the Windows service ( text2 ), it uses the before\ncreated registry path of the service itself to set the values ( text )\n```\ntext2 = @\"SYSTEM\\CurrentControlSet\\Services\\\";\ntext2 += this.regdata.srvName;\ntext2 += @\"\\Enum\";\nusing (RegistryKey registryKey3 = Registry.LocalMachine.CreateSubKey(text))\n{\n     registryKey3.SetValue(\"0\", @\"Root\\LEGACY_SRVC\\0000\",\nRegistryValueKind.String);\n     registryKey3.SetValue(\"Count\", 1, RegistryValueKind.DWord);\n     registryKey3.SetValue(\"NextInstance\", 1, RegistryValueKind.DWord);\n     registryKey3.Close();\n}\n\n```\n2 ) There is a method named `DeleteTask which uses` `Security as a file name to delete`\na scheduled task. Maybe there is a custom executable named `Security.exe in the same`\ndirectory with such functionality, but it's more likely that the author wanted to use\n```\nschtasks.exe according to the used arguments.\npublic int DeleteTask()\n{\n     this.RunProgram(\"Security\", @\"/Delete /TN\n\\Microsoft\\Windows\\Maintenance\\MaintenancePolicy /F\", true);\n     return 0;\n}\npublic int RunProgram(string exe, string cmd, bool waitfor)\n{\n     Process process = new Process();\n     process.StartInfo.FileName = exe;\n\n## Registry config data decrypter\n\n```\n\n-----\n\nThe sample tries to get RC4 encrypted data from a registry key (see IOCs) and use that data\nfor the service set up. I have coded a config data decryptor for those who are infected. See:\n[tajmahal_regdata_decrypter.py](https://github.com/TheEnergyStory/malware_analysis/blob/master/TajMahal/tajmahal_regdata_decrypter.py)\n\nConfig data description:\n\n**Data** **Explanation**\n\nDisplayName Persistence service display name value under\n\"SYSTEM\\CurrentControlSet\\Services<Name>\"\n\nDescription Persistence service description value under\n\"SYSTEM\\CurrentControlSet\\Services<Name>\"\n\nName Persistence service name key under\n\"SYSTEM\\CurrentControlSet\\Services\"\n\nentryPoint Name in \"ServiceMain\" under\n\"SYSTEM\\CurrentControlSet\\Services<Name>\\Parameters\" which\ndescribes the service DLL's entry point (export function name)\n\nsrvPath Unknown, likely service DLL path\n\nmarkerPath Unkown, likely infection validation file\n\ntask_name Unkown, likely scheduled task name\n\nttl Date of self destruction\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-24 - Project TajMahal IOCs and Registry Data Decrypter.pdf"
    ],
    "report_names": [
        "2020-01-24 - Project TajMahal IOCs and Registry Data Decrypter.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535548,
    "ts_updated_at": 1743041170,
    "ts_creation_date": 1653760189,
    "ts_modification_date": 1653760189,
    "files": {
        "pdf": "https://archive.orkl.eu/e3ab028004192b4665dbfcb6d406cd661c66e17f.pdf",
        "text": "https://archive.orkl.eu/e3ab028004192b4665dbfcb6d406cd661c66e17f.txt",
        "img": "https://archive.orkl.eu/e3ab028004192b4665dbfcb6d406cd661c66e17f.jpg"
    }
}