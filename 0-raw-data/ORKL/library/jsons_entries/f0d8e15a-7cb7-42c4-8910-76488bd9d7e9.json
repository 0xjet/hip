{
    "id": "f0d8e15a-7cb7-42c4-8910-76488bd9d7e9",
    "created_at": "2022-10-25T16:48:12.122441Z",
    "updated_at": "2025-03-27T02:05:19.658624Z",
    "deleted_at": null,
    "sha1_hash": "4477f8bb9e82fa99d4c0f1d57720f5856b8ee9f8",
    "title": "Recovering From Shamoon",
    "authors": "Fidelis",
    "file_creation_date": "2012-11-01T14:01:05Z",
    "file_modification_date": "2012-11-01T14:01:05Z",
    "file_size": 354429,
    "plain_text": "### www.fidelissecurity.com\n www.threatgeek.com\n @FidSecSys +1 800.652.4020\n```\n         Fidelis Threat Advisory #1007\n         RECOVERING FROM SHAMOON\n             November 1, 2012\n              Document Status: FINAL\n               Last Revised: 2012-11-01\nExecutive Summary\n\n```\nThe Shamoon malware has received considerable coverage in the past couple of months\nbecause of its destructive nature. Despite assertions that it is the work of amateurs, it has had a\nmajor impact on companies believed to have been affected. The basic functions of the malware\nare to infect, entrench, propagate, and wipe.\n\nHowever because of the way the malware operates and how it is programmed to wipe, it can find\nitself being its own enemy. It will wipe data found in the Documents and Settings folder and the\nSystem32 folder, and then use a signed driver for disk access to start wiping at the disk level.\nBecause the operating system needs certain files in the System32 folder to run, it was found that\ninfected hosts will always restart before the malware can wipe completely at the disk level.\n\nDue to this it was possible to make a complete recovery of Shamoon-infected file systems to the\nstate they were in before the wiping made the OS unbootable and unreadable. In fact the majority\nof files outside of the System32 and Document and Settings folder are recoverable as well; this\nprovided the opportunity for a successful and fruitful analysis, investigation, and remediation\neffort.\n```\nThreat Overview\n\n```\nAccording to community write-ups, the Shamoon malware appears to have been deployed\nagainst a couple of entities on or about August 15, 2012. The malware had self-propagating\nqualities and was designed to overwrite data on disks attached to or accessible from targeted\nsystems. The malware’s functionality, briefly summarized below, was covered in some detail in\ncommunity postings, such as Kaspersky’s Securelist blog. Analysis details and testing of an\navailable sample of Shamoon by General Dynamics Fidelis Cybersecurity Solutions researchers\nrevealed that the malware’s wipe operations did not overwrite entire disks, but rather overwrote\nenough to prevent access to the affected file systems, along with substantial amounts of file data.\nHowever, analysis indicated that some files were still intact after the malware’s write operations\nand subsequent system reboot.\n\nUsers are granted permission to copy and/or distribute this document in its original electronic form and print copies for personal use. This\ndocument cannot be modified or converted to any other electronic or machine-readable form in whole or in part without prior written\napproval of General Dynamics Fidelis Cybersecurity Solutions, Inc.\n\nWhile we have done our best to ensure that the material found in this document is accurate, Fidelis makes no guarantee that the\ninformation contained herein is error free.\n\nThreat Advisory #1007 Rev 2012 11 01 **_Recovering From Shamoon_**\n\n\n-----\n\n### www.fidelissecurity.com\n www.threatgeek.com\n @FidSecSys +1 800.652.4020\n\nFidelis researchers surmised there might be a means of recovering file data from targeted\nsystems from a forensic and investigative analysis point of view. With this goal in mind,\nresearchers tested several possible ways of restoring disk data critical to the access of the\ntargeted disk’s file system. What follows is a brief description of what the sample of the Shamoon\nmalware does and a description and results of researchers’ file system recovery efforts.\n\nShamoon Wiper Functionality Actions:\n\n-­‐ Executes a copy of itself as a scheduled job\n-­‐ Deletes the file created for the scheduled job\n-­‐ Entrenches itself as a service\n-­‐ Execution of the entrenched file results in a dropped driver\n-­‐ The dropped driver is loaded and executed\n-­‐ The dropped driver facilitates disk access\n-­‐ The malware overwrites disk data to include the contents of \\\\Documents and Settings\n(user data) and \\\\Windows\\system32 (system data) directories\n-­‐ The malware eventually overwrites the disk’s boot records (Master Boot Record (MBR)\nand Volume Boot Record (VBR)) (Note: Testing was accomplished on disks with one\npartition)\n-­‐ The malware appears to target user data first, then system data\n-­‐ The nature of the overwrites is such that the malware writes only a certain amount of data\nto targeted files, starting at the files’ beginning (Offset 0x0) and then writing a certain\namount of data to other file locations\n-­‐ Fidelis researcher observations included the following:\n\n`o` At some point during the writing (wiping) process, the targeted system tries to\nread file data that has been overwritten, prompting an attempt to restore the\ninvolved file\n`o` The system asks the user for media containing system files when it cannot find\nthe system files it is looking for\n`o` The targeted system eventually reboots, resulting an error on restart because of\nthe overwritten boot records\n`o` The disks targeted in testing were not completely overwritten; there was still\napparently viable file data on the targeted disks\n`o` The result of the malware’s operation was the prevention of accessing the\ntargeted file system\n\n**Note: The Shamoon sample Fidelis researchers had available looked very similar to that detailed**\n_in community write-ups. However, as of the date of publication, researchers were still analyzing_\n_the available sample. Therefore, differences between the available sample and others available_\n_to the community may become apparent in the future._\n```\nAnalysis and Testing Overview\n\n```\nFidelis initially approached the Shamoon analysis strictly from a perspective of determining what\nforensic artifacts could be recovered from a targeted system. The goal was at least a partial\n\nThreat Advisory #1007 Rev 2012 11 01 **_Recovering From Shamoon_**\n\n\n-----\n\n### www.fidelissecurity.com\n www.threatgeek.com\n @FidSecSys +1 800.652.4020\n\nreconstruction of the events precipitating the Shamoon attack, and possibly using those events\nfound on the targeted systems to determine a start of the attack, and a possible source. Analysis\nrevealed the possibility that some user data would be recovered as a side benefit to the forensic\nanalysis process.\n\nThree types of operating systems were used for testing purposes; all testing occurred on laptops.\nThe laptops were wiped, had the operating system installed, and then had the Shamoon malware\nexecuted on the system. The three operating systems used for testing were Windows XP,\nWindows 2003, and Windows 7. The malware executed with no issues except on Windows 7.\nThe User Access Control (UAC) on the Windows 7 systems had to be turned off before the\nmalware would execute and perform the wiping action as has been observed on other machines.\nThis has been noted by others in the community as well, specifically that Administrator access is\nneeded for initially launching Shamoon.\n\nShamoon operation results in much of the data on the affected systems being overwritten with the\nfragmented image of a burning flag. As has been detailed above, the wipe function will overwrite\ndata within the Documents and Settings folder followed by the System32 folder, and then it will\nstart the physical disk access and start the wiping at the disk level. If the system restarts before\nthe malware has completed wiping the disk then much of the data can still be recovered: each of\nour tests showed the system did restart before the disk was completely wiped. The amount wiped\nfrom the host will never be the same from system to system, mainly because the size of the disk\nand partitions will all need to be taken into account.\n```\nVBR and File System Recovery Strategies\n\n```\nThe following is the view of the wiped disk for each of the operating systems that we tested:\n\nFig 1. Example of wiped of MBR and VBR wiped by Shamoon Malware.\n\nFigure 1 was found at the MBR (Sector 0) and the VBR (Sector 63/56 (XP, 2003), and\n2048/206848 (7)) of each of the operating systems (As well as throughout the drive). Fidelis\n\nThreat Advisory #1007 Rev 2012 11 01 **_Recovering From Shamoon_**\n\n\n-----\n\n### www.fidelissecurity.com\n www.threatgeek.com\n @FidSecSys +1 800.652.4020\n\nresearchers decided to look further into the drive and find if there was any possibility of recovering\nfiles or logs that would help illuminate what happened to the systems, and if any artifacts of the\nmalware could be recovered.\n\n**Note on the VBR: VBR stands for Volume Boot Record, and is made up of the boot sector and**\n_bootstrap code. The boot sector takes up 1 sector on the drive; the next 6 sectors on the drive are_\n_allocated for the bootstrap code. In all 16 sectors are allocated in total for the VBR. The VBR is_\n_created when a file system is created on a partition. In this paper we will be covering the NTFS_\n_Boot Record. The VBR is used to load machine code into RAM to start a program. Normally this_\n_program is the operating system._\n\nKeyword searches revealed that there were still files that would be recoverable on the system. In\nparticular it was found that registry files and headers were still on the disk. After this, it was found\nthat the Master File Table (MFT) was still, for the most part, intact. Trying to avoid the long and\nlaborious process of carving files from the disk, researchers decided that it would instead be\nworth the time to try and recover the file system.\n\nWhen the Windows operating system is installed or an NTFS volume created, a backup copy of\nthe VBR is written to the last sector of the volume. This is a very important detail, as the forensic\nvalue of the VBR is substantial (See Figure 2). The area that will contain the critical information is\nknown as the Bios Parameter Block (BPB). With this information it is possible to rebuild the file\nsystem as it existed before the wipe.\n\nThreat Advisory #1007 Rev 2012 11 01 **_Recovering From Shamoon_**\n\n\n-----\n\n### www.fidelissecurity.com\n www.threatgeek.com\n @FidSecSys +1 800.652.4020\n\nEB 52 90 4E 54 46 53 20 20 20 20 00 02 08 00 00 00 00 00 00 00 F8 00 00 3F 00 FF 00 3F 00 00 00 00 00\n00 00 80 00 80 00 C0 F8 F8 0D 00 00 00 00 00 00 0C 00 00 00 00 00 8C 8F DF 00 00 00 00 00 F6 00 00\n00 01 00 00 00 26 FA CA 70 02 CB 70 44 00 00 00 00\n\n[… Truncated for size …]\n\n00 00 55 AA\n\nEB 52 90 – Instruction to jump to boot code (Not necessary for our application)\n\n4E 54 46 53 20 20 20 20 – OEM Name (NTFS  )\n\n00 02 – Bytes per sector, 0x0200 = 512 Bytes.\n\n08 – Sectors per cluster = 8\n\nF8 – Media descriptor (Not necessary for our application)\n\nC0 F8 F8 0D 00 00 00 00 – Total sectors in file system, 0x00DF8F8C0 = 234420416 Sectors (Add on the\nsector location of VBR for actual end of the file system, in this example the VBR is at sector 63 therefore the\ntotal sectors in the file system are 234420416 + 63 = 234420479)\n\n00 00 0C 00 00 00 00 00 – Starting cluster of the MFT, 0X000C0000 = 786432 Clusters. 786432 * 8 (Cluster\nsize) +63 (VBR Sector) = 6291519 Sectors\n\n8C 8F DF 00 00 00 00 00 – Starting cluster of the MFT mirror, 0x00DF8F8C = 14651276. 14651276 * 8 + 63\n= 117210271 Sectors\n\nF6 – Size of MFT Entry, 246.\n\n01 – Index size, 1.\n\n26 FA CA 70 02 CB 70 44 – Serial number.\n\nFor more technical information on file systems and their forensic value, Brian Carrier’s book File System\nForensic Analysis is an invaluable tool.\n\nFig 2. Example of a broken down BPB found within the boot sector.\n\nJust because the boot sector of the VBR is recoverable doesn’t mean that everything on the file\nsystem will be restored to normal. If a file was wiped by the malware then it will still be wiped, or\npartially wiped. However files that weren’t wiped will be much easier and faster to recover then\ncarving and the context of each file will be easy to interpret.\n\nTo recover or identify the backup VBR a search will need to be run across the image file. It is\npreferable if the image file is a raw image as they are easier to edit then other image file formats.\nThe search was performed for the hex of the VBR file header, EB 52 90 4E 54 46 53 (ëR�NTFS).\nA few hits were found throughout the drive, and it appeared that there were multiple empty VBR\ntemplates throughout the system (Shown in Figure 3). The correct VBR will likely be the one with\ninformation filled in from offset 10 – 80 (See Figure 2 to breakdown). During testing it was found\nthat the last hit was normally the correct VBR, as this would be the VBR found at the end of the\nvolume.\n\nThreat Advisory #1007 Rev 2012 11 01 **_Recovering From Shamoon_**\n\n\n-----\n\n### www.fidelissecurity.com\n www.threatgeek.com\n @FidSecSys +1 800.652.4020\n\nFig 3. Example of a blank VBR.\n\n**Note: On 2003 systems the boot backup is sometimes found halfway through the partition, a**\n_manual parsing of the file will need to be performed to confirm the VBR is legitimate for the_\n_partition._\n\nOnce the VBR was found we noted the offset and calculated the sector to locate the backup in\nour desired forensic program. For the purposes of testing we used EnCase (v6.19.6). Once the\nsector of the backup VBR is known, EnCase was started and the image of the infected system\nwas loaded. Within disk view we located the backup VBR and right clicked to add a manual\npartition as an NTFS file system. The partition was added, the MFT read, and the file system\nappeared:\n\nThreat Advisory #1007 Rev 2012 11 01 **_Recovering From Shamoon_**\n\n\n-----\n\n### www.fidelissecurity.com\n www.threatgeek.com\n @FidSecSys +1 800.652.4020\n\nFig 4. File system recovered within EnCase.\n\nWith the file system restored some relevant artifacts can be located now, and an actual computer\nforensic examination can take place.\n\nThis recovery can be successful without the use of the EnCase suite of forensic software as well.\nUsing a hex editor of your choice to repair the image, in our testing WinHex (16.6) was used. Find\nthe file header of the backup VBR within a file editor, copy from the header to footer of the boot\nsector; the footer will always be 55 AA. The size will be 512 bytes from header to footer. Then\ndepending on what operating system is being examined you can write the copied boot sector to\nthe appropriate sector on the affected image.\n\nPlacing the boot sector into the correct location will be the trickiest part as incorrect placement will\nresult in the file system not being recognized. The boot sector should be placed at sector 63/56\nfor XP/2003, and at sector 2048/206848 for Windows 7. After this is complete you will be able to\nadd the image into the forensic program. If the file system is not recognized then it is possible that\nthe MBR will need to be reconstructed, though this is unlikely. Before rebuilding the MBR try\nadding the image as a volume and not as a disk.\n\n**Note: Other recovery techniques are certainly viable as well. There are automated partition**\n_rebuilding tools available, though some of these rely on a valid MBR to work properly (In this case_\n_that wouldn’t be feasible). Other options would be the fixboot command from the Windows_\n_Recovery Console found on a Windows OS disk. What we have presented here are forensically_\n_sound methods that are easily repeatable and least damaging to the evidence/image._\n```\nMultiple Partition Recovery Strategies\n\n```\nFor testing purposes the system with Windows 2003 was set up with three different partitions. We\nwanted to emulate the situation in which one would have multiple partitions on the computers, as\nis quite common. Conceivably the malware should wipe all of these partitions as well, as has\nbeen seen within the code of the malware. What we wanted to look at was the extent of the\nwiping on the partitions and whether the same techniques that were applied to a single partitioned\ndrive would still apply on the multiple partitioned drive.\n\nIn theory each partition should be recoverable, as non-bootable partitions still create a VBR and\nplace the backup at the end of the partition when a NTFS file system is installed. After searching\n\nThreat Advisory #1007 Rev 2012 11 01 **_Recovering From Shamoon_**\n\n\n-----\n\n### www.fidelissecurity.com\n www.threatgeek.com\n @FidSecSys +1 800.652.4020\n\nthrough the drive we found that there were three VBRs that all seemed to have corresponding\ninformation for the partitions that were originally created. On our test system we found that\nEnCase was not adding the partitions in a way that would recognize the file system as it did for\nthe other systems. This could be because our boot sector was at sector 56 and not 63, or\nbecause the multiple partitions clash when trying to add them in.\n\nWe ended up having to edit the image by adding the backup boot sectors into the correct sector\nwhere the originals were found.\n\n**Partition** **Boot Sector Placed At** **Backup Boot Sector**\n\n1 (Primary) 56 41926079\n\n2 41926080 62417879\n\n3 62417880 82909679\n\nFig 5. VBR Placement in Windows 2003\n\n**Note: The VBR placement for the next partition starts after the backup VBR of the preceding**\n_partition._\n\nOnce the VBRs were added correctly we proceeded to add the partitions into EnCase.\n\nFig 6. Reconstructed file system of a Windows 2003 operating system wiped by Shamoon.\n\n**Note: EnCase gives default volume labels when added, so C, D, and E are respectively 1, 2, and**\n_3._\n\nThe extent of the wiping appeared to be on the same level to what was found on single\npartitioned drives. As mentioned before this was to be expected as the malware tries to wipe\nmounted and other volumes first and will then move to the primary volume (1/C).\n\nThreat Advisory #1007 Rev 2012 11 01 **_Recovering From Shamoon_**\n\n|Partition|Boot Sector Placed At|Backup Boot Sector|\n|---|---|---|\n|1 (Primary)|56|41926079|\n|2|41926080|62417879|\n|3|62417880|82909679|\n\n\n-----\n\n### www.fidelissecurity.com\n www.threatgeek.com\n @FidSecSys +1 800.652.4020\n```\nThe Fidelis Take\n\n```\nFidelis researchers have developed a set of rules for detecting the Shamoon malware along the\nentire threat life cycle: initial infection, lateral propagation, and command and control\ncommunication. The embedded malware detection engine also recognizes the variant of\nShamoon malware analyzed. All sensor configurations are capable of detecting the initial infection\nand the command and control communication, and the Fidelis XPS Internal Sensor is required for\ndetecting the lateral movement of the malicious program.\n```\nFurther Reading \n\n```\n- Shamoon the Wiper Copycats at Work (2012), retrieved 26 Oct 2012 from\nhttp://www.securelist.com/en/blog/208193786/Shamoon_the_Wiper_Copycats_at_Work\n\n- Shamoon the Wiper in details, Tarakanov, Dmitry (2012), retrieved 26 Oct 2012 from\nhttp://www.securelist.com/en/blog/208193795/Shamoon_the_Wiper_in_details\n\n- Shamoon the Wiper in details II, Tarakanov, Dmitry (2012), retrieved 26 Oct 2012 from\nhttp://www.securelist.com/en/blog/208193834/Shamoon_The_Wiper_further_details_Part_II\n\n- Shamoon, a two-staged targeted attack (2012), retrieved 26 Oct 2012 from\nhttp://blog.seculert.com/2012/08/shamoon-two-stage-targeted-attack.html\n\n- ‘Shamoon’ Virus Most Destructive Ever To Hit A Business, Leon Panetta Warns (2012),\nretrieved from http://www.huffingtonpost.com/2012/10/11/shamoon-virus-leonpanetta_n_1960113.html\n\n- Carrier, Brian (2005). File System Forensic Analysis. Upper Saddle River, NJ: Pearson\nEducation Inc.\n\nThreat Advisory #1007 Rev 2012 11 01 **_Recovering From Shamoon_**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/fjucrojt5ldxio2sbvsql7syv46l6p4g",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2012/2012.11.01.RECOVERING_FROM_SHAMOON/FTA%201007%20-%20Shamoon.pdf"
    ],
    "report_names": [
        "FTA 1007 - Shamoon"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716492,
    "ts_updated_at": 1743041119,
    "ts_creation_date": 1351778465,
    "ts_modification_date": 1351778465,
    "files": {
        "pdf": "https://archive.orkl.eu/4477f8bb9e82fa99d4c0f1d57720f5856b8ee9f8.pdf",
        "text": "https://archive.orkl.eu/4477f8bb9e82fa99d4c0f1d57720f5856b8ee9f8.txt",
        "img": "https://archive.orkl.eu/4477f8bb9e82fa99d4c0f1d57720f5856b8ee9f8.jpg"
    }
}