{
    "id": "369afe7c-0267-43e1-b76a-8fc924b7b6e6",
    "created_at": "2023-01-12T15:08:41.604395Z",
    "updated_at": "2025-03-27T02:05:56.70797Z",
    "deleted_at": null,
    "sha1_hash": "0f453160d48c982a281800f9ca454b1105b0b8f8",
    "title": "2021-01-12 - New Variant of Ursnif Continuously Targeting Italy",
    "authors": "",
    "file_creation_date": "2022-05-29T10:46:33Z",
    "file_modification_date": "2022-05-29T10:46:33Z",
    "file_size": 186487,
    "plain_text": "# New Variant of Ursnif Continuously Targeting Italy\n\n**fortinet.com/blog/threat-research/new-variant-of-ursnif-continuously-targeting-italy**\n\n**[FortiGuard Labs Threat Research Report](https://www.fortinet.com/fortiguard/labs.html?utm_source=blog&utm_medium=campaign&utm_campaign=FortiGuardLabs)**\n\n**Affected platforms:    Microsoft Windows**\n\n**Impacted parties:     Windows Users in Italy**\n\n**Impact:              Collects Victims’ Information**\n\n**Severity level:        Critical**\n\n\nJanuary 12, 2021\n\n\nUrsnif (also known as Gozi) is identified as a banking Trojan, but its variants also include components (backdoors, spyware, file injectors, etc.)\ncapable of a wide variety of behaviors.\n\nThe Ursnif Trojan has been observed targeting Italy over the past year. A few days ago, [FortiGuard Labs detected a](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_medium=campaign&utm_campaign=FortiGuardLabs) [phishing campaign in the](https://www.fortinet.com/resources/cyberglossary/phishing?utm_source=blog&utm_campaign=2020-q4-phishing)\nwild that was spreading a fresh variant of the Ursnif Trojan via an attached MS Word document that is continuously targeting Italy.\n\nAlthough Ursnif is identified as a banking Trojan, due to its C2 server’s shutdown, this latest variant has been unable download the malicious\n[banking module it needs to steal banking information from the victim, causing it to fail to start the second stage of its attack. As a result, in this](https://www.darkreading.com/vulnerabilities---threats/prepare-to-fight-upcoming-cyber-threat-innovations/a/d-id/1339592)\npost I will share my findings around the first stage of this campaign. You will learn what the phishing email looks like, how the MS Word\ndocument attached to the email works to download Ursnif, as well as what this variant does on a victim’s device.\n\n## Ursnif Phishing Email\n\nFigure 1.1 is a screenshot of the Ursnif phishing email. As you can see, it was written in Italian and masquerades as a payment reminder.\n\nFigure 1.1. Phishing Email and attached MS Word document\n\nI used Google Translate to translate the email content into English:\n\n**_Dear customer,_**\n\n**_A recent accounting audit shows that your invoice number 294316 of 12/10/2020 expired on 12/11/2020. As of today, it is not yet been_**\n**_paid by you._**\n\n**_Therefore, please normalize your accounting position as soon as possible. We are also reminding you that this payment can be_**\n**_made by bank transfer using the IBAN indicated in the invoice or, by bank check or bank draft._**\n\n**_You can consult the invoice and the details for the payment through the attached archive._**\n\n\n-----\n\n**_e t a_** **_you o you atte t o_** **_a d_** **_e se d you_** **_d ega ds_**\n\nAttached to the email is an MS Word document named “residuo_8205843.doc”. The text lures the victim into opening the document to get\nmore details of the invoice.\n\n## Word Document Analysis\n\nAs you may have guessed, the Word document contains malicious Macros. Once the victim opens the document in MS Word, it pops up a\nyellow warning bar to alert the user that the file contains Macros, as shown in Figure 2.1.\n\nFigure 2.1. Opening the attached document in MS Word program\n\nOnce the victim clicks the button to enable the Macros, malicious Macro code will be executed in background. A built-in function,\n“Document_Open()”, is automatically called first when the document is opened, as shown in Figure 2.2.\n\nFigure 2.2. Built-in function Document_Open()\n\nI noticed that the attacker creates a hidden UserForm (UserForm1) in the project, and a button’s click event function is invoked from the\nDocument_Open() function.\n\nFigure 2.3. Hidden UserForm\n\nThe main work of the Macro is implemented using this form. In Figure 2.2, we can see that it calls “UserForm1.CommandButton2_Click”, which\nbelongs to the event function of the “Process” button, as shown in Figure 2.3. It functions the same as when the victim clicks the “Process”\nbutton. Other clicked buttons also directly call their event functions in code.\n\nThe Macro then downloads a DLL file from a hardcoded URL, “longline[.]cyou/p1cture3[.]jpg” (refer to Figure 2.4) and resaves it into the file\n\"C:\\users\\public\\px.dat\". The final step the Macro performs is to run the downloaded DLL using the Windows program “RegSvr32.exe”. Figure\n2.4 is the screenshot of when the Macro runs this DLL.\n\nFigure 2.4. Downloading and Running a DLL file from the hardcoded URL\n\n## Analyzing the Downloaded DLL File\n\nLike most other malware protected by a packer, this downloaded DLL file (C:\\users\\public\\px.dat) is similarly protected by a packer as well. It is\nstarted by RegSvr32.exe, and the unpack program gets called to first extract Ursnif into the memory. Ursnif’s DllEntryPoint() function will be\ncalled at the end by the unpack program. Figure 3.1 is a screenshot of the unpacked DllEntryPoint() function.\n\nFigure 3.1. Unpacked DllEntryPoint() function\n\nAccording to my analysis, this function’s main task is to decompress another PE file that is secretly kept in the “.reloc” section. Next, it loads\nthis PE file into a file mapping memory by calling API CreateFileMappingW() and MapViewOfFile()) and executing the code in it. This\ndecompressed PE file is the core module of this variant of Ursnif.\n\nFigure 3.2. Call core module’s entry function\n\nIn Figure 3.2, we can see that the malware is about to call the entry function of the core module that has been loaded at the base address\n0x330000.\n\n## Decrypting the Configuration Block in the Core Module\n\nUrsnif has an encrypted configuration block inside the PE’s “.bss” section to protect its data from easy analysis. So, decrypting the\nconfiguration block is the first thing that it needs to do. The code snippet responsible for decrypting the configuration block is shown in Figure\n4.1, below.\n\nFigure 4.1. Code snippet for decrypting the configuration block\n\nGoing through the decrypted configuration block, we can see that it contains a number of ASCII and Unicode strings, as well as binary data.\nThe values from the configuration block are accessed throughout the core module. Let’s see what it can get from the decrypted configuration\nblock. Following is a partial list of its strings.\n\n_\"invalidcert\"_\n\n_\"overridelink\"_\n\n_\"%08X-%04X-%04X-%04X-%08X%04X\"_\n\n_\"StdRegProv\"_\n\n_\"/images/\"_\n\n\n-----\n\n_e s o_ _%u&so t %u&use_ _%08 %08 %08 %08 &se_ _e_ _%u& d %u&type %u&_\n\n_\"name=%s\"_\n\n_\"Content-Disposition: form-data; name=\"upload_file\"; filename=\"%s\"\"_\n\n_\"DeleteKey\"_\n\n_\"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT %u.%u%s)\"_\n\n_\"soft=%u&version=%u&user=%08x%08x%08x%08x&server=%u&id=%u&crc=%x\"_\n\n_\"&uptime=%u\"_\n\n_\"CreateProcessA\"_\n\n_\".avi\"_\n\n_\"Software\\Microsoft\\Windows\\CurrentVersion\\Run\"_\n\n_\"rundll32 \"%s\",%S\"_\n\n_\"&ip=%s\"_\n\n_\"&os=%s\"_\n\n_\"&tor=1\"_\n\n_\"&dns=%s\"_\n\n_\"&whoami=%s\"_\n\n_\"/C \"copy \"%s\" \"%s\" /y && rundll32 \"%s\",%S\"\"_\n\n_\"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\"_\n\n_\"WScript.Shell\"_\n\n_\");%S.Run(\"_\n\n_\"powershell iex ([System.Text.Encoding]::ASCII.GetString((\"_\n\n_\"IE8RunOnceLastShown_TIMESTAMP\"_\n\n_\"SOFTWARE\\Microsoft\\Internet Explorer\\\"_\n\n_…_\n\n## Collecting Sensitive Information and Sending It to the C2 Server\n\nIn the core module, Ursnif collects sensitive information from the victim’s device, such as current login Username, Computer Name, System\nUptime, and so on. These are formatted as in the first packets sent to the C2 server. Figure 5.1 shows the ASM code snippet used to obtain\nUsername and Computer Name.\n\nFigure 5.1. Calling APIs to obtain Username and Computer Name\n\nIt formats all of the collected data into key=value pairs, like the string shown in the memory section of Figure 5.2.\n\nFigure 5.2. Collected data in a formatted string\n\nAmong the key-value pairs, the values of “soft”, “version”, and “crc” are hardcoded. The values of “user”, “server”, and “id” are hash values.\n“uptime” is a time value of how long the device has been running. “dns” is the computer name, and “whoami” is the full user name.\n\nNext, Ursnif encrypts the string and encodes the cipher text with base64. Finally, it transforms the base64 string by replacing specified bytes\nand randomly inserting “/”. An example looks like this:\n\n_kGmre5fgzV/jtkp5rBSbtChvz3cy/avjHTlxQBzmZ/DH4YpgdvFWT/3ZOkljxvOGl5sK/DKS8qy7zKWSwKdmWKVkNW/3iLRdsyjEatQ2kbQ/97eIek932S_\n_TCOCQKSzO32C/EUgtTKuNa/PDAfPobZLDuYwMNjMJqk/BCloHCcWrST2Oq7lSc7/bX0t3dF5oQwhDoo8O83JoQ/KNQw3uRXGoOK3/bvb2q8hp/_\n_PoIH_2/F_\n\nIt then adds a prefix string (the domain of the C2 server and “/images/”) and suffix string (“.avi”) before sending the information to the server.\n\n\n-----\n\nU s does ot d ect y se d t e data t t e p ocess stead, t uses a CO co po e t ct e te ace t at s p e e ted\nthe module “IEProxy.dll”. Ursnif indirectly calls APIs from this module to perform communication with C2 server. This means the collected data\nwill be sent by a newly created “iexplorer.exe” process that is started by the COM component. Figure 5.3 provides the detailed overview\nprocesses tree, from which you can not only observe the process “iexplorer.exe”, but also the relationship between the processes mentioned in\nthis blog, such as “WinWord.exe” and “RegSvr32.exe”.\n\nFigure 5.3. Process Tree of calling a COM component\n\nFigure 5.4. Decrypted C2 server domain string\n\nThe domain string of the C2 server comes from a secret data structure that is decrypted from a data block within the “.reloc” section.\n\nIn Figure 5.4, at the bottom of the memory segment, we can see the decrypted secret data structure. The string starting at offset 0xB0 are the\ndomains: “web[.]vortex[.]data[.]Microsoft[.]com”, “ocsp[.]sca1b[.]amazontrust[.]com”, and “gstatistics[.]co”. Through my analysis, only the last\none is the real C2 server domain.\n\nFigure 5.5 shows what the final packet sent to the C2 server looks like.\n\nFigure 5.5. Packet sent to the C2 server\n\nIn the next stage, the malware would respond to the received packet with a module (dll, exe, etc.) which would be executed by Ursnif to\nperform further malicious attacks on victim’s device. Unfortunately, we did not receive any response because the C2 server had been shut\ndown. I will continue to try and contact the C2 server. If I am finally able to obtain the module file, I will post my analysis of it as well.\n\n## Fortinet Solution Coverage:\n\nThe Word document attached to the phishing email has been detected as “VBA/Ursinf.3412!tr” and the downloaded file has been detected as\n“W32/Ursinf.KB!tr” by the FortiGuard AntiVirus service.\n\nThe URL used to download Ursnif (DLL file) has been rated as “Malicious Websites” by the FortiGuard WebFilter service.\n\nThe CDR (Content Disarm & Reconstruction) feature can also neutralize this threat by removing all malicious Macro code.\n\n[The FortiGuard AntiVirus service is supported by FortiGate,](https://www.fortinet.com/products/next-generation-firewall.html?utm_source=blog&utm_campaign=2018-q2-fortigate-main-page) [FortiMail, FortiClient and FortiEDR. And the CDR feature is supported by](https://www.fortinet.com/products/email-security/fortimail.html?utm_source=blog&utm_campaign=2018-q2-fortimail-main-page)\nFortiGate and FortiMail.\n\n[We also suggest our readers to go through the free NSE training --](https://training.fortinet.com/?utm_source=blog&utm_campaign=2019-q3-nse-institute) [NSE 1 – Information Security Awareness, which has a module on Internet](https://training.fortinet.com/local/staticpage/view.php?page=nse_1&utm_source=blog&utm_campaign=2020-q2-nse-1)\nthreats designed to help end users learn how to identify and protect themselves from phishing attacks.\n\n## IoCs:\n\n**URLs:**\n\n\"hxxp://longline[.]cyou/p1cture3[.]jpg \"\n\n“hxxps://gstatistics[.]co/”\n\n**Sample SHA256:**\n\nresiduo_8205843.doc:\n\nE9732CDCA1B2503E02E8FEA9A4C68EDA940E10890E1C5ABE2CEB2290FE39C3DB\n\nDownloaded DLL file (px.dat or p1cture3.jpg):\n\n90D8648B2AAC0C837286A4C042F02064CFBB12F45B3DC6B00B2BECCC7FC35422\n\n_[Learn more about FortiGuard Labs threat research and the FortiGuard Security Subscriptions and Services portfolio.](https://www.fortinet.com/fortiguard/labs?utm_source=blog&utm_campaign=fortiguard-labs)_\n\n_Learn more about Fortinet’s_ _[free cybersecurity training initiative or about the Fortinet](https://www.fortinet.com/blog/business-and-technology/fortinet-offers-free-cybersecurity-training-courses?utm_source=blog&utm_campaign=free-cybersecurity-training-courses)_ _[NSE Training program,](https://training.fortinet.com/?utm_source=blog&utm_campaign=nse-institute)_ _[Security Academy program,](https://training.fortinet.com/local/staticpage/view.php?page=fnsa&utm_source=blog&utm_campaign=fnsa)_\n_[and Veterans program.](https://www.fortinet.com/corporate/careers/vets.html?utm_source=blog&utm_campaign=fortivet)_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-12 - New Variant of Ursnif Continuously Targeting Italy.pdf"
    ],
    "report_names": [
        "2021-01-12 - New Variant of Ursnif Continuously Targeting Italy.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536121,
    "ts_updated_at": 1743041156,
    "ts_creation_date": 1653821193,
    "ts_modification_date": 1653821193,
    "files": {
        "pdf": "https://archive.orkl.eu/0f453160d48c982a281800f9ca454b1105b0b8f8.pdf",
        "text": "https://archive.orkl.eu/0f453160d48c982a281800f9ca454b1105b0b8f8.txt",
        "img": "https://archive.orkl.eu/0f453160d48c982a281800f9ca454b1105b0b8f8.jpg"
    }
}