{
    "id": "ad57d535-3abb-44da-a17e-7962f142058a",
    "created_at": "2023-01-12T15:10:16.70113Z",
    "updated_at": "2025-03-27T02:13:29.141841Z",
    "deleted_at": null,
    "sha1_hash": "bc4ab6bb5690eeba7f270b5c9b92e22f05786d2d",
    "title": "2021-06-08 - LOKIBOT - A commodity malware",
    "authors": "",
    "file_creation_date": "2022-05-28T03:10:35Z",
    "file_modification_date": "2022-05-28T03:10:35Z",
    "file_size": 934144,
    "plain_text": "# LOKIBOT - A commodity malware\n\n**reversing.fun/posts/2021/06/08/lokibot.html**\n\n.. June 8, 2021\n\nJun 8, 2021\n\nLokibot it’s not new but it’s a common malware to see these days since it’s sold on\nunderground websites, thus it’s available to the average cyber-criminal. This malware is\ndesigned to steal information from infected machines and send it to a command and control\nserver using HTTP POST requests.\n\nBesides stealing data, it can set up persistence, receive tasks from the C2 server, and it can\nbe used to download more malware.\n\nLokibot has been around for a few years now, but the statistics show that is still very\n[common to see Lokibot being used. The stats provided by Any Run show that this family is](https://any.run/malware-trends/)\nwithin the top 3 of the Global rank and the top 10 of both the Week and Month ranks.\n\nThe stats from [MalwareBazaar put this family within the top 10 of all time of the most seen](https://bazaar.abuse.ch/)\nmalware families.\n\n\n-----\n\n[Tria.ge stats place Lokibot in the top 5 of submissions.](https://tria.ge/)\n\n\n-----\n\nGiven the popularity of this malware and my curiosity, I decided to take a look at a sample\nand see how it works.\n\n[The sample I used in this analysis can be found here.](https://bazaar.abuse.ch/sample/3deeb55fefe05f51c41b1724780e5de1e33a432e01f455e3ab5d2af5ca655464/)\n\n## Static reverse engineering\n\nLokibot resolves most of the needed APIs during the execution. To avoid hardcoding the\noriginal API names, the malware uses hashes of the API names whenever it needs to\nresolve them\n\n\n-----\n\nThe first step to moving forward with the reverse engineering of this sample I had to\nunderstand how Lokibot resolves the APIs and how the algorithm that computes the hashes\nworks.\n\n### Resolving the necessary APIs\n\nTo resolve a Windows API, Lokibot calls an auxiliary function that receives an index value\nand a hash of the API name as arguments.\n\nThe indexes are used to get the DLL name from an in-memory array containing the DLL\nnames.\n\n**Index** **DLL**\n\n0 kernel32.dll\n\n1 ntdll.dll\n\n2 shlwapi.dll\n\n3 crypt32.dll\n\n4 wininet.dll\n\n5 urlmon.dll\n\n6 netapi32.dll\n\n7 ws2_32.dll\n\n8 user32.dll\n\n9 advapi32.dll\n\n10 shell32.dll\n\n11 gdiplus.dll\n\n12 gdi32.dll\n\n13 ole32.dll\n\n\n-----\n\n**Index** **DLL**\n\n14 gdi32.dll\n\nTo get the final addresses Lokibot loads and parses the export table from the DLLs.\n\nFor each API in the export table, Lokibot computes a hash of its name and compares it with\nthe hash passed to the function as an argument.\n\n### API string hashing algorithm\n\nPseudo code of the hashing algorithm used by this Lokibot sample:\n\n\n-----\n\nUsing my own implementation of this algorithm in python I was able to build a list containing\nthe Windows API names alongside their hashes.\n\nIn **[this gist, you can find the full list containing the API names and the hashes.](https://gist.github.com/ilbaroni/fbb33cb0b821d408ddb8eea25960f649)**\n\n### Command line argument check\n\nBefore starting any actions the malware checks if there is a `-u switch in the arguments of`\nthe process and if it finds it the execution is delayed for 10 seconds.\n\nThis switch is used when Lokibot upgrades itself.\n\n### Network initialization and mutex creation\n\nLokibot uses Berkeley compatible sockets for communications and because of that, it needs\nto call WSAStartup() before using any other networking functions.\n\nIf the call succeeds the malware tries to create a mutex based on the MD5 hash of the\nmachine GUID (trimmed to 24 chars).\n\n\n-----\n\nMutexes are used to guarantee that there is only one instance of a program running on a\nsystem.\n\n### Stealing the data\n\nLokibot calls a function that will build two large arrays in the stack.\n\nThe first array will contain the identifiers of the functions, and the second array the actual\nroutines that steal data.\n\nAfter building the two arrays, the functions that steal data are executed using a wrapper\nfunction.\n\n\n-----\n\nThis wrapper function sets a global variable with the identifier of the steal function and\nexecutes it.\n\nThis way, Lokibot can keep a reference between the stolen data and the function that stole it\nin the reported data. This way, when parsing the stolen data the C2 server will know how to\nprocess/store it.\n\nList of all the targeted applications and files:\n\n\n-----\n\n```\nfirefox browser\nicedragon browser\nsafari browser\nk-meleon browser \nseamonkey browser\nflock browser \nblackhawk browser \nlunascape browser \nbrowsers general data\nopera browser \nqtweb internet browser \nqupzilla browser \ninternet explorer \nopera passwords\ncyberfox browser \npale moon browser \nwaterfox browser \npidgin passwords\nsuperputty \nftpshell \nnotepadplusplus \nmyftp \nftpbox \nsherrod ftp \nftpnow \nnexusfile ftp \nnetsarang xftp \neasyftp \nsftpnetdrive \nableftp \njasftp \nautomize \nableftp\ncyberduck \nfullsync \nftpinfo \nlinasftp \nfilezilla \nstaff ftp \nblazeftp \nfastream ftp \ngoftp \nestsoft alftp \ndeluxe ftp \nghisler wcx ftp \nftpgetter \nws ftp \nsite xml files\nfull tilt poker \npokerstars \nexpandrive \nsteed \nflash fxp \ninsoftware novaftp \nnetdrive \n\n```\n\n-----\n\n```\nghisler wcx ftp \nsmart ftp \nfar manager ftp \nbitvise bvsshclient \nvnc \nmsecure \nsyncovery \nfreshwebmaster freshftp \nbitkinex \nultrafxp \nftp now \nsecurefx \nodin secure ftp expert \nnch software fling \nnch software classicftp \nkitty\nputty \nmozilla thunderbird \nfoxmail \npocomail \nincredimail \ngmail notifier pro\ndesksoft checkmail \nwinftp client \nwinscp \n32bitftp \nftp navigator \nsoftwarenetz mailing \noperamail \npostbox \nmozilla fossamail \nmailbox ini file \nwinchips user account \noutlook \nymail2 \ntrojita imap client \ntrulymail \nspn files\nto dodesklist \nstickies images and rtf\nnotefly notes \nconceptworld notezilla \nmicrosoft sticky notes \nkeepass databases\nenpass db files\nmy roboform \n1password \nmikrotik winbox\n\n```\nAfter getting all the data and save it in a memory buffer, Lokibot will prepare the data and\nreport it back to the C2 server. The configured C2 server is encrypted using Triple-DES and\ngets decrypted on runtime.\n\n\n-----\n\nThe malware grabs information about the local system and builds a report packet. This\npacket will have the system information, stolen data, and some other flags and data.\n\nSummary of the system information that is collected to build the report packet:\n\nOperating system\nUsername\nHostname\nDomain name\nScreen resolution\nPrivilege level\nSystem architecture\n\nAn interesting bit of information on the Lokibot communications is the user-agent.\n\nA simple google search shows nothing but only references to this malware.\n\n\n-----\n\n### Stealing data from the Windows Credential Manager\n\nAfter stealing the data from the targeted applications, Lokibot will try to steal data from the\nWindows Credential Manager.\n\n\n-----\n\nTo steal those credentials, Lokibot will search any files within the following directories:\n```\n   %APPDATA%\\Microsoft\\Credentials\n   %LOCALAPPDATA%\\Microsoft\\Credentials .\n\n```\nTo decrypt the passwords, Lokibot tries to inject code into the Local Security Authority\nSubsystem Service process (lsass.exe). The injection will occur only if:\n\nThe operating system is x86.\nThe operating system is x64 and the process is not running under Windows on\nWindows subsystem (WoW64).\n\n\n-----\n\nA fun fact about the x86 injection function is that the author forgot to create a remote threat\nafter writing the shellcode into the Lsass process, meaning that the shellcode is written but\nnever executed. ¯\\(ツ)/¯\n\nAfter stealing this data, Lokibot builds a new report packet and reports it back to the C2\nserver.\n\n### Persistence\n\nFor persistence, Lokibot copies itself to a folder inside the `%APPDATA% folder, creates a new`\nrun key, and hides both the created directory and the copied executable.\n\nCreating the directory and copying the original executable:\n\n\n-----\n\nCreating a run key and hiding both the folder and the executable:\n\n\n-----\n\nThis way whenever the system is started the hidden executable will be executed.\n\n### C2 tasks\n\nAfter stealing the data, Lokibot is also able to fetch tasks from the C2 server.\n\nSummary of the possible Lokibot tasks:\n\nDownload EXE and Execute\nDownload DLL and Load\nDelete HDB file\nStart keylogger\nSteal data\nExit Lokibot\nUpgrade Lokibot\nChange C2 beaconing (polling tasks)\nDelete executables\n\nHere is a snippet of a function that will download additional executables and execute them:\n\n\n-----\n\n## Possible detections\n\nLokibot creates a hidden folder within the `%APPDATA% directory. The directory name will be`\na slice of the mutex name (8th char - 13th char).\n\nFor example: `%APPDATA%\\C98066\\ .`\n\nIn the hidden directory, Lokibot creates four files at any given time with the following\nextensions:\n\n.exe\n.lck\n.hdb\n.kdb\n\nThe file names will also be a slice of the mutex name (13th char - 18th char) followed by the\nextension.\n\nThe user-agent used by Lokibot is also very uncommon which can be used to build simple\ndetections.\n```\nMozilla/4.08 (Charon; Inferno)\n\n```\nList of existing Suricata rules:\n\n\n-----\n\n**Rule IDRule ID** **Rule NameRule Name**\n\n2024311 ET TROJAN Loki Bot Cryptocurrency Wallet Exfiltration Detected\n\n2024312 ET TROJAN Loki Bot Application/Credential Data Exfiltration Detected M1\n\n2024313 ET TROJAN Loki Bot Request for C2 Commands Detected M1\n\n2024314 ET TROJAN Loki Bot File Exfiltration Detected\n\n2024315 ET TROJAN Loki Bot Keylogger Data Exfiltration Detected M1\n\n2024316 ET TROJAN Loki Bot Screenshot Exfiltration Detected\n\n2024317 ET TROJAN Loki Bot Application/Credential Data Exfiltration Detected M2\n\n2024318 ET TROJAN Loki Bot Request for C2 Commands Detected M2\n\n2024319 ET TROJAN Loki Bot Keylogger Data Exfiltration Detected M2\n\n## References\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-06-08 - LOKIBOT - A commodity malware.pdf"
    ],
    "report_names": [
        "2021-06-08 - LOKIBOT - A commodity malware.pdf"
    ],
    "threat_actors": [
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536216,
    "ts_updated_at": 1743041609,
    "ts_creation_date": 1653707435,
    "ts_modification_date": 1653707435,
    "files": {
        "pdf": "https://archive.orkl.eu/bc4ab6bb5690eeba7f270b5c9b92e22f05786d2d.pdf",
        "text": "https://archive.orkl.eu/bc4ab6bb5690eeba7f270b5c9b92e22f05786d2d.txt",
        "img": "https://archive.orkl.eu/bc4ab6bb5690eeba7f270b5c9b92e22f05786d2d.jpg"
    }
}