{
    "id": "80d69952-bdce-42aa-904f-eba9a08307a1",
    "created_at": "2023-01-12T14:59:06.822957Z",
    "updated_at": "2025-03-27T02:06:00.498531Z",
    "deleted_at": null,
    "sha1_hash": "006536a71ce448d503d500331dbe0d4b48c0d8a0",
    "title": "2021-08-22 - PEB- Where Magic Is Stored",
    "authors": "",
    "file_creation_date": "2022-05-28T04:01:11Z",
    "file_modification_date": "2022-05-28T04:01:11Z",
    "file_size": 422967,
    "plain_text": "# PEB: Where Magic Is Stored\n\n**malwareandstuff.com/peb-where-magic-is-stored/**\n\n[Published by hackingump on August 22, 2021](https://malwareandstuff.com/author/klopsch/)\n\n\nAugust 22, 2021\n\n\nAs a reverse engineer, every now and then you encounter a situation where you dive deeper\ninto the internal structures of an operating system as usual. Be it out of simple curiosity, or\nbecause you need to understand how a binary uses specific parts of the operating system in\ncertain ways . One of the more interesting structures in Windows is the Process Environment\nBlock/PEB. In this article, I’d like to introduce you to this structure and talk about various use\ncases of how adversaries can abuse this structure for their own purposes.\n\n\n-----\n\n## Introducing PEB\n\nThe Process Environment Block is a critical structure in the Windows OS, most of its fields\nare not intended to be used by other than the operating system. It contains data structures\nthat apply across a whole process and is stored in user-mode memory, which makes it\naccessible for the corresponding process. The structure contains valuable information about\nthe running process, including:\n\nwhether the process is being debugged or not\nwhich modules are loaded into memory\nthe command line used to invoke the process\n\nAll these information gives adversaries a number of possibilities to abuse it. The figure below\nshows the layout of the `PEB structure:`\n```\ntypedef struct _PEB {\n BYTE             Reserved1[2];\n BYTE             BeingDebugged;\n BYTE             Reserved2[1];\n PVOID             Reserved3[2];\n PPEB_LDR_DATA         Ldr;\n PRTL_USER_PROCESS_PARAMETERS ProcessParameters;\n PVOID             Reserved4[3];\n PVOID             AtlThunkSListPtr;\n PVOID             Reserved5;\n ULONG             Reserved6;\n PVOID             Reserved7;\n ULONG             Reserved8;\n ULONG             AtlThunkSListPtr32;\n PVOID             Reserved9[45];\n BYTE             Reserved10[96];\n PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;\n BYTE             Reserved11[128];\n PVOID             Reserved12[1];\n ULONG             SessionId;\n} PEB, *PPEB;\n\n```\nNow that we’ve talked a little bit about the layout and purpose of the structure, let’s take a\nlook at a few use cases.\n\n**Reading the BeingDebugged flag**\n\nThe most obvious way is to check the `BeingDebugged to identify, whether a debugger is`\nattached to the process or not. Through reading the variable directly from memory instead of\nusing usual suspects like `NtQueryInformationProcess or` `IsDebuggerPresent,`\nmalware can prevent noisy WINAPI calls. This makes it harder to spot this technique.\n\nHowever, most debuggers already take care of this. `X64dbg for example, has an option to`\nhide the Debugger by modifying the PEB structure at start of the debugging session.\n\n\n-----\n\n**Iterating through loaded modules**\n\nAnother use case, could be iterating the loaded modules and discover DLLs injected into\nmemory with purpose to overwatch the running process. To understand how to achieve this,\nwe need to take a look at the `PPEB_LDR_DATA structure included in` `PEB, which is provided`\nby the `Ldr variable:`\n```\ntypedef struct _PEB_LDR_DATA {\n BYTE    Reserved1[8];\n PVOID   Reserved2[3];\n LIST_ENTRY InMemoryOrderModuleList;\n} PEB_LDR_DATA, *PPEB_LDR_DATA;\nPPEB_LDR_DATA contains the head to a doubly linked list named\nInMemoryOrderModuleList . Each item in this list is a structure from type\nLDR_DATA_TABLE_ENTRY, which contains all the information we need to iterate loaded\n\n```\nmodules. See the structure of `LDR_DATA_TABLE_ENTRY below:`\n```\ntypedef struct _LDR_DATA_TABLE_ENTRY {\n  PVOID Reserved1[2];\n  LIST_ENTRY InMemoryOrderLinks;\n  PVOID Reserved2[2];\n  PVOID DllBase;\n  PVOID EntryPoint;\n  PVOID Reserved3;\n  UNICODE_STRING FullDllName;\n  BYTE Reserved4[8];\n  PVOID Reserved5[3];\n  union {\n    ULONG CheckSum;\n    PVOID Reserved6;\n  };\n  ULONG TimeDateStamp;\n} LDR_DATA_TABLE_ENTRY, *PLDR_DATA_TABLE_ENTRY;\n\n```\nSo by iterating the doubly linked list, we are able to discover the base address and full name\nof all modules loaded into memory of the running process. The snippet below is a small\nProof of Concept. It iterates the linked list and prints the library name to stdout. I created it for\nthe purpose of this blog article. You are free to use it, however I will also upload it to my\ngithub repo the upcoming days:\n\n\n-----\n\n```\n#include <Windows.h>\n#include <iostream>\n#include <shlwapi.h>\n#define NO_STDIO_REDIRECT\ntypedef struct _UNICODE_STRING\n{\n  USHORT Length;\n  USHORT MaximumLength;\n  PWSTR Buffer;\n} UNICODE_STRING, * PUNICODE_STRING;\ntypedef struct _LDR_DATA_TABLE_ENTRY_MOD {\n  LIST_ENTRY InMemoryOrderLinks;\n  PVOID Reserved2[2];\n  PVOID DllBase;\n  PVOID EntryPoint;\n  PVOID Reserved3;\n  UNICODE_STRING FullDllName;\n  BYTE Reserved4[8];\n  PVOID Reserved5[3];\n  union {\n    ULONG CheckSum;\n    PVOID Reserved6;\n  };\n  ULONG TimeDateStamp;\n} LDR_DATA_TABLE_ENTRY_MOD, * PLDR_DATA_TABLE_ENTRY_MOD_MOD;\nint main(int argc, char** argv[]){\n  PLDR_DATA_TABLE_ENTRY_MOD_MOD lib = NULL;\n  _asm {\n    xor eax, eax\n    mov eax, fs:[0x30]\n    mov eax, [eax + 0xC]\n    mov eax, [eax + 0x14]\n    mov lib, eax\n  };\n  printf(\"[+] Initialised pointer to first LDR_DATA_TABLE_ENTRY_MOD\\n\");\n  // Loop as long as we don't reach the head of the linked list again\n  while ( lib->FullDllName.Buffer != NULL ) {\n    printf(\"[+] %S\\n\", lib->FullDllName.Buffer);\n    lib = (PLDR_DATA_TABLE_ENTRY_MOD_MOD)lib->InMemoryOrderLinks.Flink;\n  }\n\n```\n\n-----\n\n```\n  printf( [+] Done!\\n );\n     return 0;\n\n```\nIf you are wondering how I am able to access the `PEB in the code below, you should take a`\nlook at the inline assembly in the `main method, especially the instruction` `mov eax, fs:`\n```\n[0x30] . FS is a segment register, similar to GS. FS can be used to access thread-specific\n\n```\nmemory. Offset `0x30 allows you to access the linear address of the Process Environment`\nBlock.\n\nFinally, we want to take a look at a real world example of how `PEB can be abused.`\n\n## How the MATA Framework abuses PEB\n\nThis use case was introduced to me while reverse engineering a Windows variant of the\n[MATA Framework. According to Kaspersky[1], the MATA Framework is used by the Lazarus](https://securelist.com/mata-multi-platform-targeted-malware-framework/97746/)\ngroup and targets multiple platforms.\n\nMalware authors have a high interest in obfuscation, because it increases the time needed to\nreverse engineer it. One way to hide API calls is to use API Hashing. I have written about\n[Danabot’s API Hashing[2] before and how to overcome it. MATA also uses this technique.](https://malwareandstuff.com/deobfuscating-danabots-api-hashing/)\n\nHowever instead of using the WIN API calls to retrieve the address of DLLs loaded into\nmemory, MATA abuses the Process Environment Block to fetch base addresses. Let’s take a\nlook at how MATA for Windows achieves this:\n\n**MATA API Hashing**\n\nThe input of the `APIHashing method takes an integer as the only parameter, this is the`\nhash for the corresponding API call.\n\nFigure 1: Call to APIHash method\nRight after the prologue, it retrieves a pointer to `PEB by reading it from the Thread`\nEnvironment Block via the segment register `GS . Similar to our proof of concept above,`\nMATA now fetches the address to the head of the linked list provided by\n```\nInMemoryOrderModuleList . Each item of the linked list provides the DLL base address of\n\n```\nthe corresponding loaded module.\n\n\n-----\n\nFrom there, the malware reads the `e_lfanew field, which contains the offset to the file`\nheader. By adding the base address, `e_lfsanew and` `0x88 it jumps directly to the data`\ndirectories of the corresponding PE. From the data directories, MATA accesses the exported\nfunction names in a similar way as I’ve described in my blog article about DanaBot’s API\n[Hashing[3]. The hashing algorithm is fairly simple. Each integer representation of a character](https://malwareandstuff.com/deobfuscating-danabots-api-hashing/)\nis added and the result of the addition is `ROR'd by` `0xD consecutively each iteration. If the`\nfinal hash matches the input parameter, the address to the function is retrieved. The\nfollowing figure explains the function at a high level:\n\nHigh level overview of API Hashing of MATA malware\n\n## Learning from each other\n\nThat’s it with the blog article, I hope you enjoyed it! There are probably way more use cases\nand real world cases of how the `PEB is and and can be abused. If you can think of another`\none, feel free to leave a comment below and share it, so that we can learn from each other!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-22 - PEB- Where Magic Is Stored.pdf"
    ],
    "report_names": [
        "2021-08-22 - PEB- Where Magic Is Stored.pdf"
    ],
    "threat_actors": [
        {
            "id": "32a223a8-3c79-4146-87c5-8557d38662ae",
            "created_at": "2022-10-25T15:50:23.703698Z",
            "updated_at": "2025-03-27T02:00:55.528031Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Lazarus Group",
                "Labyrinth Chollima",
                "HIDDEN COBRA",
                "Guardians of Peace",
                "NICKEL ACADEMY",
                "Diamond Sleet"
            ],
            "source_name": "MITRE:Lazarus Group",
            "tools": [
                "RawDisk",
                "Proxysvc",
                "BADCALL",
                "FALLCHILL",
                "WannaCry",
                "HOPLIGHT",
                "TYPEFRAME",
                "Dtrack",
                "HotCroissant",
                "HARDRAIN",
                "Dacls",
                "KEYMARBLE",
                "TAINTEDSCRIBE",
                "AuditCred",
                "netsh",
                "ECCENTRICBANDWAGON",
                "AppleJeus",
                "BLINDINGCAN",
                "ThreatNeedle",
                "Volgmer",
                "Cryptoistic",
                "RATANKBA",
                "Bankshot",
                "Torisma",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "9e767b38-12ae-4ef7-9878-5ce1701066d7",
            "created_at": "2024-05-01T02:03:08.131819Z",
            "updated_at": "2025-03-27T02:05:17.413497Z",
            "deleted_at": null,
            "main_name": "NICKEL ACADEMY",
            "aliases": [
                "COVELLITE ",
                "CTG-2460 ",
                "Diamond Sleet ",
                "Guardians of Peace",
                "HIDDEN COBRA ",
                "High Anonymous",
                "Labyrinth Chollima ",
                "NNPT Group",
                "New Romanic Cyber Army Team",
                "Temp.Hermit ",
                "The Lazarus Group ",
                "UNC577 ",
                "Who Am I?",
                "Whois Team",
                "ZINC ",
                "Black Artemis "
            ],
            "source_name": "Secureworks:NICKEL ACADEMY",
            "tools": [
                " DarkMessenger",
                " Destover",
                " Duuzer",
                " HOPLIGHT",
                " Joanap",
                " KorHigh",
                " LiveJinx",
                " Volgmer",
                "Brambul"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "8bc1a044-a23b-4904-903c-13f463605cb3",
            "created_at": "2024-05-01T02:03:08.136237Z",
            "updated_at": "2025-03-27T02:05:17.415795Z",
            "deleted_at": null,
            "main_name": "NICKEL GLADSTONE",
            "aliases": [
                "Bluenoroff ",
                "CTG-6459 ",
                "Citrine Sleet ",
                "HIDDEN COBRA ",
                "Lazarus Group",
                "Sapphire Sleet ",
                "Stardust Chollima ",
                "APT38 "
            ],
            "source_name": "Secureworks:NICKEL GLADSTONE",
            "tools": [
                " Bankshot",
                " CATCH22",
                " CCGC_Proxy",
                " Cur1Agent",
                " Ratankba",
                " Server_TrafficForwarder",
                " Wcry",
                "AlphaNC"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a2b92056-9378-4749-926b-7e10c4500dac",
            "created_at": "2023-01-06T13:46:38.430595Z",
            "updated_at": "2025-03-27T02:00:02.831633Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "Operation DarkSeoul",
                "APT38",
                "ATK117",
                "DEV-1222",
                "G0032",
                "APT 38",
                "Stardust Chollima",
                "APT-C-26",
                "ATK3",
                "Diamond Sleet",
                "Hidden Cobra",
                "Unit 121",
                "Subgroup: Bluenoroff",
                "NICKEL GLADSTONE",
                "DEV-0139",
                "Andariel",
                "Operation Troy",
                "COVELLITE",
                "TA404",
                "Lazarus group",
                "Dark Seoul",
                "G0082",
                "NewRomanic Cyber Army Team",
                "Bluenoroff",
                "Appleworm",
                "Nickel Academy",
                "COPERNICIUM",
                "Hastati Group",
                "Bureau 121",
                "Operation AppleJeus",
                "Whois Hacking Team",
                "Citrine Sleet",
                "Sapphire Sleet",
                "Group 77",
                "Labyrinth Chollima",
                "Operation GhostSecret",
                "BeagleBoyz"
            ],
            "source_name": "MISPGALAXY:Lazarus Group",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f32df445-9fb4-4234-99e0-3561f6498e4e",
            "created_at": "2022-10-25T16:07:23.756373Z",
            "updated_at": "2025-03-27T02:02:09.966155Z",
            "deleted_at": null,
            "main_name": "Lazarus Group",
            "aliases": [
                "APT-C-26",
                "ATK 3",
                "Appleworm",
                "Citrine Sleet",
                "DEV-0139",
                "Diamond Sleet",
                "Gleaming Pisces",
                "Gods Apostles",
                "Gods Disciples",
                "Group 77",
                "Guardians of Peace",
                "Hastati Group",
                "Hidden Cobra",
                "ITG03",
                "Jade Sleet",
                "Labyrinth Chollima",
                "Lazarus Group",
                "NewRomanic Cyber Army Team",
                "Operation 99",
                "Operation AppleJeus",
                "Operation AppleJeus sequel",
                "Operation Blockbuster: Breach of Sony Pictures Entertainment",
                "Operation CryptoCore",
                "Operation Dream Job",
                "Operation Dream Magic",
                "Operation Flame",
                "Operation GhostSecret",
                "Operation In(ter)caption",
                "Operation LolZarus",
                "Operation Marstech Mayhem",
                "Operation No Pineapple!",
                "Operation North Star",
                "Operation Phantom Circuit",
                "Operation Sharpshooter",
                "Operation Ten Days of Rain / DarkSeoul",
                "Operation Troy",
                "SectorA01",
                "Slow Pisces",
                "TA404",
                "TraderTraitor",
                "UNC2970",
                "UNC4034",
                "UNC4736",
                "UNC4899",
                "UNC577",
                "Whois Hacking Team"
            ],
            "source_name": "ETDA:Lazarus Group",
            "tools": [
                "3CX Backdoor",
                "3Rat Client",
                "3proxy",
                "AIRDRY",
                "ARTFULPIE",
                "ATMDtrack",
                "AlphaNC",
                "Alreay",
                "Andaratm",
                "AngryRebel",
                "AppleJeus",
                "Aryan",
                "AuditCred",
                "BADCALL",
                "BISTROMATH",
                "BLINDINGCAN",
                "BTC Changer",
                "BUFFETLINE",
                "BanSwift",
                "Bankshot",
                "Bitrep",
                "Bitsran",
                "BlindToad",
                "Bookcode",
                "BootWreck",
                "BottomLoader",
                "Brambul",
                "BravoNC",
                "Breut",
                "COLDCAT",
                "COPPERHEDGE",
                "CROWDEDFLOUNDER",
                "Castov",
                "CheeseTray",
                "CleanToad",
                "ClientTraficForwarder",
                "CollectionRAT",
                "Concealment Troy",
                "Contopee",
                "CookieTime",
                "Cyruslish",
                "DAVESHELL",
                "DBLL Dropper",
                "DLRAT",
                "DRATzarus",
                "DRATzarus RAT",
                "Dacls",
                "Dacls RAT",
                "DarkComet",
                "DarkKomet",
                "DeltaCharlie",
                "DeltaNC",
                "Dembr",
                "Destover",
                "DoublePulsar",
                "Dozer",
                "Dtrack",
                "Duuzer",
                "DyePack",
                "ECCENTRICBANDWAGON",
                "ELECTRICFISH",
                "Escad",
                "EternalBlue",
                "FALLCHILL",
                "FYNLOS",
                "FallChill RAT",
                "Farfli",
                "Fimlis",
                "FoggyBrass",
                "FudModule",
                "Fynloski",
                "Gh0st RAT",
                "Ghost RAT",
                "Gopuram",
                "HARDRAIN",
                "HIDDEN COBRA RAT/Worm",
                "HLOADER",
                "HOOKSHOT",
                "HOPLIGHT",
                "HOTCROISSANT",
                "HOTWAX",
                "HTTP Troy",
                "Hawup",
                "Hawup RAT",
                "Hermes",
                "HotCroissant",
                "HotelAlfa",
                "Hotwax",
                "HtDnDownLoader",
                "Http Dr0pper",
                "ICONICSTEALER",
                "Joanap",
                "Jokra",
                "KANDYKORN",
                "KEYMARBLE",
                "Kaos",
                "KillDisk",
                "KillMBR",
                "Koredos",
                "Krademok",
                "LIGHTSHIFT",
                "LIGHTSHOW",
                "LOLBAS",
                "LOLBins",
                "Lazarus",
                "LightlessCan",
                "Living off the Land",
                "MATA",
                "MBRkiller",
                "MagicRAT",
                "Manuscrypt",
                "Mimail",
                "Mimikatz",
                "Moudour",
                "Mydoom",
                "Mydoor",
                "Mytob",
                "NACHOCHEESE",
                "NachoCheese",
                "NestEgg",
                "NickelLoader",
                "NineRAT",
                "Novarg",
                "NukeSped",
                "OpBlockBuster",
                "PCRat",
                "PEBBLEDASH",
                "PLANKWALK",
                "POOLRAT",
                "PSLogger",
                "PhanDoor",
                "Plink",
                "PondRAT",
                "PowerBrace",
                "PowerRatankba",
                "PowerShell RAT",
                "PowerSpritz",
                "PowerTask",
                "Preft",
                "ProcDump",
                "Proxysvc",
                "PuTTY Link",
                "QUICKRIDE",
                "QUICKRIDE.POWER",
                "Quickcafe",
                "QuiteRAT",
                "R-C1",
                "ROptimizer",
                "Ratabanka",
                "RatabankaPOS",
                "Ratankba",
                "RatankbaPOS",
                "RawDisk",
                "RedShawl",
                "Rifdoor",
                "Rising Sun",
                "Romeo-CoreOne",
                "RomeoAlfa",
                "RomeoBravo",
                "RomeoCharlie",
                "RomeoCore",
                "RomeoDelta",
                "RomeoEcho",
                "RomeoFoxtrot",
                "RomeoGolf",
                "RomeoHotel",
                "RomeoMike",
                "RomeoNovember",
                "RomeoWhiskey",
                "Romeos",
                "RustBucket",
                "SHADYCAT",
                "SHARPKNOT",
                "SIGFLIP",
                "SIMPLESEA",
                "SLICKSHOES",
                "SORRYBRUTE",
                "SUDDENICON",
                "SUGARLOADER",
                "SheepRAT",
                "SierraAlfa",
                "SierraBravo",
                "SierraCharlie",
                "SierraJuliett-MikeOne",
                "SierraJuliett-MikeTwo",
                "SimpleTea",
                "SimplexTea",
                "SmallTiger",
                "Stunnel",
                "TAINTEDSCRIBE",
                "TAXHAUL",
                "TFlower",
                "TOUCHKEY",
                "TOUCHMOVE",
                "TOUCHSHIFT",
                "TOUCHSHOT",
                "TWOPENCE",
                "TYPEFRAME",
                "Tdrop",
                "Tdrop2",
                "ThreatNeedle",
                "Tiger RAT",
                "TigerRAT",
                "Trojan Manuscript",
                "Troy",
                "TroyRAT",
                "VEILEDSIGNAL",
                "VHD",
                "VHD Ransomware",
                "VIVACIOUSGIFT",
                "VSingle",
                "ValeforBeta",
                "Volgmer",
                "Vyveva",
                "W1_RAT",
                "Wana Decrypt0r",
                "WanaCry",
                "WanaCrypt",
                "WanaCrypt0r",
                "WannaCry",
                "WannaCrypt",
                "WannaCryptor",
                "WbBot",
                "Wcry",
                "Win32/KillDisk.NBB",
                "Win32/KillDisk.NBC",
                "Win32/KillDisk.NBD",
                "Win32/KillDisk.NBH",
                "Win32/KillDisk.NBI",
                "WinorDLL64",
                "Winsec",
                "WolfRAT",
                "Wormhole",
                "YamaBot",
                "Yort",
                "ZetaNile",
                "concealment_troy",
                "http_troy",
                "httpdr0pper",
                "httpdropper",
                "klovbot",
                "sRDI"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535546,
    "ts_updated_at": 1743041160,
    "ts_creation_date": 1653710471,
    "ts_modification_date": 1653710471,
    "files": {
        "pdf": "https://archive.orkl.eu/006536a71ce448d503d500331dbe0d4b48c0d8a0.pdf",
        "text": "https://archive.orkl.eu/006536a71ce448d503d500331dbe0d4b48c0d8a0.txt",
        "img": "https://archive.orkl.eu/006536a71ce448d503d500331dbe0d4b48c0d8a0.jpg"
    }
}