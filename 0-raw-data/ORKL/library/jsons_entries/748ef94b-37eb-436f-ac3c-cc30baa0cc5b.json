{
    "id": "748ef94b-37eb-436f-ac3c-cc30baa0cc5b",
    "created_at": "2023-01-12T15:06:40.372077Z",
    "updated_at": "2025-03-27T02:12:03.948675Z",
    "deleted_at": null,
    "sha1_hash": "876080f76e0f08d8dfb45a6ed87f7b0ca3754e53",
    "title": "2021-03-04 - Detection and Response to Exploitation of Microsoft Exchange Zero-Day Vulnerabilities",
    "authors": "",
    "file_creation_date": "2022-05-27T21:56:03Z",
    "file_modification_date": "2022-05-27T21:56:03Z",
    "file_size": 99662,
    "plain_text": "# Detection and Response to Exploitation of Microsoft Exchange Zero-Day Vulnerabilities\n\n**fireeye.com/blog/threat-research/2021/03/detection-response-to-exploitation-of-microsoft-exchange-zero-day-**\nvulnerabilities.html\n\nThreat Research\n\nMatt Bromiley, Chris DiGiamo, Andrew Thompson, Robert Wallace\n\nMar 04, 2021\n\n7 mins read\n\nThreat Research\n\nZero Day Threats\n\n\n-----\n\nBeginning in January 2021, Mandiant Managed Defense observed multiple instances of\nabuse of Microsoft Exchange Server within at least one client environment. The observed\nactivity included creation of web shells for persistent access, remote code execution, and\nreconnaissance for endpoint security solutions. Our investigation revealed that the files\ncreated on the Exchange servers were owned by the user NT AUTHORITY\\SYSTEM, a\nprivileged local account on the Windows operating system. Furthermore, the process that\ncreated the web shell was UMWorkerProcess.exe, the process responsible for Exchange\nServer’s Unified Messaging Service. In subsequent investigations, we observed malicious\nfiles created by w3wp.exe, the process responsible for the Exchange Server web front-end.\n\nIn response to this activity, we built threat hunting campaigns designed to identify additional\nExchange Server abuse. We also utilized this data to build higher-fidelity detections of web\n[server process chains. On March 2, 2021, Microsoft released a blog post that detailed](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)\nmultiple zero-day vulnerabilities used to attack on-premises versions of Microsoft Exchange\nServer. Microsoft also issued emergency Exchange Server updates for the following\nvulnerabilities:\n\n\n**CVE** **Risk**\n**Rating**\n\n\n**Access**\n**Vector**\n\n\n**Exploitability** **Ease of**\n**Attack**\n\n\n**Mandiant**\n**Intel**\n\n\n**CVE-2021-**\n**26855**\n\n**CVE-2021-**\n**26857**\n\n**CVE-2021-**\n**26858**\n\n**CVE-2021-**\n**27065**\n\n\nCritical Network Functional Easy [Link](https://intelligence.fireeye.com/reports/21-00004941)\n\nMedium Network Functional Easy [Link](https://intelligence.fireeye.com/reports/21-00004938)\n\nMedium Network Functional Easy [Link](https://intelligence.fireeye.com/reports/21-00004944)\n\nMedium Network Functional Easy [Link](https://intelligence.fireeye.com/reports/21-00004939)\n\n\nTable 1: List of March 2021 Microsoft Exchange CVEs and FireEye Intel Summaries\n\nThe activity reported by Microsoft aligns with our observations. FireEye currently tracks\n**this activity in three clusters, UNC2639, UNC2640, and UNC2643. We anticipate**\n**additional clusters as we respond to intrusions. We recommend following Microsoft’s**\nguidance and patching Exchange Server immediately to mitigate this activity.\n\nBased on our telemetry, we have identified an array of affected victims including US-based\nretailers, local governments, a university, and an engineering firm. Related activity may also\n[include a Southeast Asian government and Central Asian telecom. Microsoft reported the](https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/)\n\n\n-----\n\nexploitation occurred together and is linked to a single group of actors tracked as\n“HAFNIUM”, a group that has previously targeted the US-based defense companies, law\nfirms, infectious disease researchers, and think tanks.\n\nIn this blog post, we will detail our observations on the active investigations we are currently\nperforming. As our experience with and knowledge of this threat actor grows, we will update\nthis post or release new technical details as appropriate. For our Managed Defense\nCustomers, we have launched a Community Protection Event that will provide frequent\nupdates on this threat actor and activity.\n\n[We will be discussing these attacks more in an upcoming webinar on Mar. 17, 2021.](https://www.brighttalk.com/webcast/7451/475010?utm_source=FireEye&utm_medium=brighttalk&utm_campaign=475010)\n\n**From Exploit to Web Shell**\n\nBeginning in January 2021, Mandiant Managed Defense observed the creation of web shells\non one Microsoft Exchange server file system within a customer’s environment. The web\nshell, named help.aspx (MD5: 4b3039cf227c611c45d2242d1228a121), contained code to\nidentify the presence of (1) FireEye xAgent, (2) CarbonBlack, or (3) CrowdStrike Falcon\nendpoint products and write the output of discovery. Figure 1 provides a snippet of the web\nshell’s code.\n\n\n-----\n\nSnippet of the web shell help.aspx, crafted to identify the presence of endpoint\nsecurity software on a victim system\n\nFigure 1: Snippet of the web shell help.aspx, crafted to identify the presence of endpoint\nsecurity software on a victim system\nThe web shell was written to the system by the UMWorkerProcess.exe process, which is\nassociated with Microsoft Exchange Server’s Unified Messaging service. This activity\nsuggested exploitation of CVE-2021-26858.\n\nApproximately twenty days later, the attacker placed another web shell on a separate\nMicrosoft Exchange Server. This second, partially obfuscated web shell, named iisstart.aspx\n(MD5: 0fd9bffa49c76ee12e51e3b8ae0609ac), was more advanced and contained functions\nto interact with the file system. As seen in Figure 2, the web shell included the ability to run\narbitrary commands and upload, delete, and view the contents of files.\n\n\n-----\n\nSnippet of iisstart.aspx, uploaded by the attacker in late January 2021\n\n\nFigure 2: Snippet of iisstart.aspx, uploaded by the attacker in late January 2021\nWhile the use of web shells is common amongst threat actors, the parent processes, timing,\nand victim(s) of these files clearly indicate activity that commenced with the abuse of\nMicrosoft Exchange.\n\nIn March 2021, in a separate environment, we observed a threat actor utilize one or more\nvulnerabilities to place at least one web shell on the vulnerable Exchange Server. This was\nlikely to establish both persistence and secondary access, as in other environments. In this\ncase, Mandiant observed the process w3wp.exe, (the IIS process associated with the\nExchange web front-end) spawning cmd.exe to write a file to disk. The file, depicted in Figure\n[3, matches signatures for the tried-and-true China Chopper.](https://www.fireeye.com/content/dam/fireeye-www/global/en/current-threats/pdfs/rpt-china-chopper.pdf)\n\n\n-----\n\nSnippet of China Chopper web shell found on a compromised Exchange Server\nsystem\n\nFigure 3: Snippet of China Chopper web shell found on a compromised Exchange Server\nsystem\nWe observed that in at least two cases, the threat actors subsequently issued the following\ncommand against the Exchange web server:\n\nnet group \"Exchange Organization administrators\" administrator /del /domain.\n\nThis command attempts to delete the administrator user from the Exchange Organizations\nadministrators group, beginning with the Domain Controller in the current domain. If the\nsystem is in a single-system domain, it will execute on the local computer.\n\nPer Microsoft’s blog, they have identified additional post-exploitation activities, including:\n\nCredential theft via dumping of LSASS process memory.\nCompression of data for exfiltration via 7-Zip.\n\n\n-----\n\nUse of Exchange PowerShell Snap-ins to export mailbox data.\n[Use of additional offensive security tools Covenant,](https://github.com/cobbr/Covenant) [Nishang, and](https://github.com/samratashok/nishang) [PowerCat for remote](https://github.com/besimorhino/powercat)\naccess.\n\nThe activity we have observed, coupled with others in the information security industry,\nindicate that these threat actors are likely using Exchange Server vulnerabilities to gain a\nfoothold into environments. This activity is followed quickly by additional access and\npersistent mechanisms. As previously stated, we have multiple ongoing cases and will\ncontinue to provide insight as we respond to intrusions.\n\n**Investigation Tips**\n\nWe recommend checking the following for potential evidence of compromise:\n\nChild processes of C:\\Windows\\System32\\inetsrv\\w3wp.exe on Exchange Servers,\nparticularly cmd.exe.\nFiles written to the system by w3wp.exe or UMWorkerProcess.exe.\nASPX files owned by the SYSTEM user\nNew, unexpected compiled ASPX files in the Temporary ASP.NET Files directory\nReconnaissance, vulnerability-testing requests to the following resources from an\nexternal IP address:\n\n/rpc/ directory\n/ecp/DDI/DDIService.svc/SetObject\nNon-existent resources\nWith suspicious or spoofed HTTP User-Agents\nUnexpected or suspicious Exchange PowerShell SnapIn requests to export mailboxes\n\nIn our investigations to date, the web shells placed on Exchange Servers have been named\ndifferently in each intrusion, and thus the file name alone is not a high-fidelity indicator of\ncompromise.\n\nIf you believe your Exchange Server was compromised, we recommend investigating to\ndetermine the scope of the attack and dwell time of the threat actor.\n\nFurthermore, as system and web server logs may have time or size limits enforced, we\nrecommend preserving the following artifacts for forensic analysis:\n\nAt least 14 days of HTTP web logs from the inetpub\\Logs\\LogFiles directories (include\nlogs from all subdirectories)\nThe contents of the Exchange Web Server (also found within the inetpub folder)\nAt least 14 days of Exchange Control Panel (ECP) logs, located in Program\nFiles\\Microsoft\\Exchange Server\\v15\\Logging\\ECP\\Server\nMicrosoft Windows event logs\n\n\n-----\n\nWe have found significant hunting and analysis value in these log folders, especially for\nsuspicious CMD parameters in the ECP Server logs. We will continue updating technical\ndetails as we observe more related activity.\n\n**Technical Indicators**\n\nThe following are technical indicators we have observed, organized by the threat groups we\ncurrently associate with this activity. To increase investigation transparency, we are including\na Last Known True, or LKT, value for network indicators. The LKT timestamp indicates the\nlast time Mandiant knew the indicator was associated with the adversary; however, as with\nall ongoing intrusions, a reasonable time window should be considered.\n\nUNC2639\n\n**Indicator** **Type** **Note**\n\n165.232.154.116 Network: IP Address Last known true: 2021/03/02 02:43\n\n182.18.152.105 Network: IP Address Last known true: 2021/03/03 16:16\n\nUNC2640\n\n**Indicator** **Type** **MD5**\n\nhelp.aspx File: Web shell 4b3039cf227c611c45d2242d1228a121\n\niisstart.aspx File: Web shell 0fd9bffa49c76ee12e51e3b8ae0609ac\n\nUNC2643\n\n**Indicator** **Type** **MD5/Note**\n\nCobalt Strike BEACON File: Shellcode 79eb217578bed4c250803bd573b10151\n\n89.34.111.11 Network: IP Address Last known true: 2021/03/03 21:06\n\n86.105.18.116 Network: IP Address Last known true: 2021/03/03 21:39\n\n**Detecting the Techniques**\n\n\n-----\n\nFireEye detects this activity across our platforms. The following contains specific detection\nnames that provide an indicator of Exchange Server exploitation or post-exploitation\nactivities we associated with these threat actors.\n\n**Platform(s)** **Detection Name**\n\n\nNetwork Security\nEmail Security\nDetection On Demand\nMalware File\nScanning\nMalware File Storage\nScanning\n\n\nFEC_Trojan_ASPX_Generic_2\nFE_Webshell_ASPX_Generic_33\nFEC_APT_Webshell_ASPX_HEARTSHELL_1\nExploit.CVE-2021-26855\n\n\nEndpoint Security **Real-Time (IOC)**\n\nSUSPICIOUS CODE EXECUTION FROM\nEXCHANGE SERVER (EXPLOIT)\nASPXSPY WEBSHELL CREATION A (BACKDOOR)\nPROCDUMP ON LSASS.EXE (METHODOLOGY)\nTASKMGR PROCESS DUMP OF LSASS.EXE A\n(METHODOLOGY)\nNISHANG POWERSHELL TCP ONE LINER\n(BACKDOOR)\nSUSPICIOUS POWERSHELL USAGE\n(METHODOLOGY)\nPOWERSHELL DOWNLOADER (METHODOLOGY)\n\n**Malware Protection (AV/MG)**\n\nTrojan.Agent.Hafnium.A\n\n**Module Coverage**\n\n[Process Guard] - prevents dumping of LSASS\nmemory using the procdump utility.\n\nHelix WINDOWS METHODOLOGY [Unusual Web Server\nChild Process]\nMICROSOFT EXCHANGE [Authentication Bypass\n(CVE-2021-26855)]\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-03-04 - Detection and Response to Exploitation of Microsoft Exchange Zero-Day Vulnerabilities.pdf"
    ],
    "report_names": [
        "2021-03-04 - Detection and Response to Exploitation of Microsoft Exchange Zero-Day Vulnerabilities.pdf"
    ],
    "threat_actors": [
        {
            "id": "529c1ae9-4579-4245-86a6-20f4563a695d",
            "created_at": "2022-10-25T16:07:23.702006Z",
            "updated_at": "2025-03-27T02:02:09.93109Z",
            "deleted_at": null,
            "main_name": "Hafnium",
            "aliases": [
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "ETDA:Hafnium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "7c969685-459b-4c93-a788-74108eab6f47",
            "created_at": "2023-01-06T13:46:39.189751Z",
            "updated_at": "2025-03-27T02:00:03.017103Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "ATK233",
                "G0125",
                "Operation Exchange Marauder",
                "Red Dev 13",
                "Silk Typhoon"
            ],
            "source_name": "MISPGALAXY:HAFNIUM",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2704d770-43b4-4bc4-8a5a-05df87416848",
            "created_at": "2022-10-25T15:50:23.306305Z",
            "updated_at": "2025-03-27T02:00:55.43633Z",
            "deleted_at": null,
            "main_name": "HAFNIUM",
            "aliases": [
                "HAFNIUM",
                "Operation Exchange Marauder",
                "Silk Typhoon"
            ],
            "source_name": "MITRE:HAFNIUM",
            "tools": [
                "Tarrask",
                "ASPXSpy",
                "Impacket",
                "PsExec",
                "China Chopper"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536000,
    "ts_updated_at": 1743041523,
    "ts_creation_date": 1653688563,
    "ts_modification_date": 1653688563,
    "files": {
        "pdf": "https://archive.orkl.eu/876080f76e0f08d8dfb45a6ed87f7b0ca3754e53.pdf",
        "text": "https://archive.orkl.eu/876080f76e0f08d8dfb45a6ed87f7b0ca3754e53.txt",
        "img": "https://archive.orkl.eu/876080f76e0f08d8dfb45a6ed87f7b0ca3754e53.jpg"
    }
}