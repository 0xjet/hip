{
    "id": "c67a010c-7dc0-4371-8c16-ae1fcc4ae0c8",
    "created_at": "2023-01-12T15:10:31.931417Z",
    "updated_at": "2025-03-27T02:05:46.822986Z",
    "deleted_at": null,
    "sha1_hash": "76d0646a457128a09f211976cae6e72865f02fc4",
    "title": "2020-07-15 - Deep Analysis of QBot Banking Trojan",
    "authors": "",
    "file_creation_date": "2022-05-28T00:27:00Z",
    "file_modification_date": "2022-05-28T00:27:00Z",
    "file_size": 1109585,
    "plain_text": "# Deep Analysis of QBot Banking Trojan\n\n**[n1ght-w0lf.github.io/malware analysis/qbot-banking-trojan/](https://n1ght-w0lf.github.io/malware%20analysis/qbot-banking-trojan/)**\n\n### Abdallah Elshinbary\n\nMalware Analysis & Reverse Engineering Adventures\n\n11 minute read\n\n\nJuly 15, 2020\n\n\n-----\n\nQBot is a modular information stealer also known as Qakbot or Pinkslipbot. It has been\nactive for years since 2007. It has historically been known as a banking Trojan, meaning that\nit steals financial data from infected systems.\n\n## Infection Flow\n\nQBot can be delivered in various different ways including Malspam (Malicious Spam) or\ndropped by other malware families like Emotet.\n\nThe infection flow for this campaign is as follows:\n\nFirst, the victim receives a phishing email with a link to a malicious zip file.\n\nThe zip file contains a very obfuscated VBS file which downloads and launches Qbot\nexecutable.\n\n\n-----\n\nThe VBS file tries to download Qbot from different places:\n\nhttp://st29[.]ru/tbzirttmcnmb/88888888.png\nhttp://restaurantbrighton[.]ru/uyqcb/88888888.png\nhttp://royalapartments[.]pl/vtjwwoqxaix/88888888.png\nhttp://alergeny.dietapacjenta[.]pl/pgaakzs/88888888.png\nhttp://egyorg[.]com/vxvipjfembb/88888888.png\n\nNotice the misleading URL, it looks like it’s downloading a PNG image but the raw data says\nsomething else.\n\n## Unpacking\n\nQBot is packed with a custom packer, but the unpacking process is really simple. It allocates\nmemory for the unpacked code using `VirtualAlloc() and changes memory protection`\nusing `VirtualProtect() . So we just need 2 breakpoints at` `VirtualAlloc() and`\n\n\n-----\n\n## Encrypted Strings\n\nMost of QBot strings are encrypted (stored in a continuous blob) and they are decrypted on\ndemand. The decryption routine accepts one argument which is the index to the string then it\nXORs it with a hardcoded bytes array until it encounters a null byte.\n\nWe can use IDAPython to decrypt the strings and add them as comments.\n```\nimport idc\nimport idautils\ndec_routine = 0x4065B7\nenc_strings = 0x40B930\nbytes_arr = 0x410120\ndef decrypt_string(idx):\n  if idx >= 0x36F4:\n    return  # out of bounds\n  res = \"\"\n  while True:\n    c = idc.get_wide_byte(enc_strings+idx) ^ idc.get_wide_byte(bytes_arr +\n(idx&0x3F))\n    if c == 0: break\n    res += chr(c)\n    idx += 1\n  return res\nxrefs = idautils.CodeRefsTo(dec_routine, 0)\nfor x in xrefs:\n  ea = idc.prev_head(x)\n  t = idc.get_operand_type(ea, 1)\n  if t == idc.o_imm:\n    idx = idc.get_operand_value(ea, 1)\n    dec = decrypt_string(idx)\n    idc.set_cmt(ea, dec, 1)\n\n```\n\n-----\n\nAnd here is the result, that s much easier to work with.\n\nThis should take care of most of the strings, the rest of strings indexes are calculated\ndynamically at runtime.\n\nWe decrypt all strings by looping through the encrypted blob and decrypt strings one by one.\n```\nidx = 0\nwhile idx < 0x36F4:\n  dec = decrypt_string(idx)\n  idx += len(dec)+1\n  print(dec)\n\n## Anti-Analysis\n\n```\nQBot spawns a new process of itself with the `\"/C\" parameter, this process is responsible`\nfor doing Anti-Analysis checks.\n\n\n-----\n\nThe parent process checks the exit code of this spawned process. If the exit code is not 0, it\nmeans that QBot is being analyzed (and so it exits).\n\nSo let’s go over the anti-analysis techniques.\n\n## Checking VM\n\nIn VMWare, communication with the host is done through a specific I/O port `(0x5658), so`\nQBot uses the `in assembly instruction to detect VMWare by reading from this port and`\nchecking the return value in `ebx if it’s equal to` `VMXh (VMware magic value).`\n\nIf we are outside VMWare, a privilege error occurs and this code will return 0.\n\n\n-----\n\nAnother Anti-VM trick is to check hardware devices against known devices names used by\nVMs and Sandboxes.\n\nHere is the list of devices names.\n\nExpand to see more\nVMware Pointing\nVMware Accelerated\nVMware SCSI\nVMware SVGA\nVMware Replay\nVMware server memory\nCWSandbox\nVirtual HD\nQEMU\nRed Hat VirtIO\nsrootkit\nVMware VMaudio\nVMware Vista\nVBoxVideo\nVBoxGuest\nvmxnet\nvmscsi\nVMAUDIO\nvmdebug\nvm3dmp\nvmrawdsk\nvmx_svga\nansfltr\nsbtisht\n\n## Checking Processes\n\nQBot loops through running processes and compares their executable names against known\nanalysis tools.\n\nExpand to see more\nFiddler.exe\n\nsamp1e.exe\n\nsample.exe\n\nrunsample.exe\n\nlordpe.exe\n\nregshot.exe\n\n\n-----\n\nAutoruns.exe\ndsniff.exe\nVBoxTray.exe\nHashMyFiles.exe\nProcessHacker.exe\nProcmon.exe\nProcmon64.exe\nnetmon.exe\nvmtoolsd.exe\nvm3dservice.exe\nVGAuthService.exe\npr0c3xp.exe\nCFF Explorer.exe\ndumpcap.exe\nWireshark.exe\nidaq.exe\nidaq64.exe\nTPAutoConnect.exe\nResourceHacker.exe\nvmacthlp.exe\nOLLYDBG.EXE\nwindbg.exe\nbds-vision-agent-nai.exe\nbds-vision-apis.exe\nbds-vision-agent-app.exe\nMultiAnalysis_v1.0.294.exe\nx32dbg.exe\nVBoxService.exe\nTcpview.exe\n\n## Checking DLLs\n\nSandbox detection can be done by enumerating loaded DLLs and comparing them against\nknown DLLs used by sandboxes. Here it’s just using 2 of them.\n```\nivm-inject.dll   # Buster Sandbox Analyzer\nSbieDll.dll    # SandBoxie\n\n## Checking Filename\n\n```\nSome sandboxes may change the sample file name. So QBot checks if its process name\ncontains one of these strings.\n\n\n-----\n\n```\nsample\nmlwr_smpl\nartifact.exe\n\n## Checking CPU\n\n```\nThe last check is done using `CPUID instruction. First it is executed with` `EAX=0 to get the`\nCPU vendor and compares it with `GenuineIntel (Intel processor).`\n\nThen it is executed with `EAX=1 to get the processors features.`\n\nOn a physical machine the last bit will be equal to 0. On a guest VM it will equal to 1.\n\n## Back To Parent\n\nAfter the Anti-Analysis checks, QBot drops a copy of itself along with a configuration file at\n```\n\"%APPDATA%\\Microsoft\\<random_folder_name>\" .\n\n```\nFinally, QBot starts the dropped copy in a new process and overwrites itself with a legitimate\nexecutable, here it’s `\"calc.exe\" .`\n\n## Configuration File\n\n\n-----\n\nThe dropped configuration file is accessed frequently by Qbot, this file is RC4 encrypted. By\nsetting a breakpoint before the contents of the file gets encrypted I got the following data:\n\n**Field** **Description**\n\n10=spx143 Campaign ID\n\n11=2 Number of hardcoded C2\n\n1=13.59.00-24/06/2020 Date of Qbot install in HH:MM:ss-dd/mm/yyyy\n\n2=1592996340 Victim Qbot install\n\n50=1 N/A\n\n5=VgBCAE8AWABTAFYAUgA7ADIA Victim network shares\n\n38=1593047244 Last victim call to C2 (Unix time)\n\n45=187.163.101.137 C2 IP\n\n46=995 C2 port\n\n39=45.242.76.104 Victim external IP\n\n43=1593006172 Time of record (Unix time)\n\n49=1 N/A\n\n## Persistence\n\nQBot achieves persistence by creating a new registry value under the key\n```\n\"HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\" . It also registers a\n\n```\nscheduled task that runs every 5 hours.\n\n## Process Injection\n\nQBot tries to inject its unpacked code in one of these processes `(\"explorer.exe\",`\n```\n\"mobsync.exe\", \"iexplorer.exe\") and it uses Process Hollowing technique to\n\n```\nachieve that.\n\nIt first starts a new suspended process with `CreateProcessW() then it writes the injected`\ncode into the target process using `ZwCreateSection(),` `ZwMapViewOfSection() and`\n```\nZwWriteVirtualMemory() .\n\n```\n\n-----\n\nFinally it sets the thread context to jump to the injected code and resume execution with\n```\nResumeThread() .\n\n## Core Module\n\n```\nThe injected code loads and decrypts one of its resources `\"307\" . After dumping it, I found`\nout that it’s a DLL (this is the core module).\n\nFrom now on, we will be analyzing the core DLL of QBot.\n\nThe core module has 2 resources both RC4 encrypted.\n\nThe first resource gets loaded into memory then RC4 decrypted.\n\n\n-----\n\nThe contents of the decrypted resource are:\n\n10=spx143 (Campaign ID)\n\n3=1592482956 (Timestamp)\n\nAfter some digging, I found out how the resources are decrypted. The first 20 bytes of each\nresource are the RC4 key of this resource, and the rest are the actual encrypted data.\n\nSo by using this find, we can decrypt the other resource `\"311\" .`\n\nGreat!!! Now we have the list of C2 servers (150 servers!).\n\nThe reason there is many controllers is that these are actually just proxies of infected bots\nacting as intermediate nodes between the victim and the real C2 and thus hiding the\nbackend infrastructure of the attacker.\n\nSo it works like this:\n\n\n-----\n\n## C2 Communication\n\nQBot obfuscates its communication with the C2 server by encrypting the payloads using RC4\nand encoding the result using Base64.\n\nThe communication is also done over SSL, you can notice that the traffic has unusual\ncertificate issuer data.\n\n\n-----\n\nWe can use `Fiddler to intercept and decrypt the HTTPS traffic.`\n\nThe RC4 key for encrypting the payload is the SHA1 hash of the first 16 bytes of the Base64decoded payload + a hardcoded salt (The salt is stored as an encrypted string).\n\nHere is an implementation of the decryption algorithm:\n```\nHARDCODED_SALT = b\"jHxastDcds)oMc=jvh7wdUhxcsdt2\"  # decrypted string\ndef decrypt_payload(encrypted_blob):\n  b64_decoded = base64.b64decode(encrypted_blob)\n  decryption_key = b64_decoded[:0x10] + HARDCODED_SALT\n  sha1hash = hashlib.sha1()\n  sha1hash.update(decryption_key)\n  decryption_key_hash = sha1hash.digest()\n  rc4 = ARC4(decryption_key_hash)\n  return rc4.decrypt(b64_decoded[0x10:])\n\n```\nThe decrypted payload is in JSON form.\n\nDecrypted C2 Request: {“8”:9,”1”:17,”2”:”pnmfcq111232”}\nDecrypted C2 Response:\n{“8”:5,”16”:770897804,”39”:”V4UnoDQSEblewhh63UfUqAns”,”38”:1}\n\n## Commands List\n\nAfter establishing communication, the C2 server will send commands indexes to be\nexecuted.\n\nHere is the list of commands and their corresponding indexes (I have renamed the important\ncommands).\n\n\n-----\n\nIt’s worth mentioning that dynamic imports of the core DLL are stored in the same format as\ncommands `\"<address, API_index, DLL_index>\", the API and DLL indexes are passed`\nto the string decryption routine which returns their corresponding names then it uses\n```\nLoadLibrary and GetProcAddress to resolve the imports.\n\n```\nLet’s go through some of the interesting commands.\n\n\n-----\n\n## Command 13: Lateral Movement\n\nQBot can spread through the network by enumerating network shares using\n```\nWNetOpenEnumW() and WNetEnumResourceW () then it drops a copy of Qbot into the\n\n```\nshared folders.\n\nThen the dropped executable is registered as an auto-start service on the target machine.\nThe names for the service and the dropped file are randomly generated strings.\n\nFinally, Qbot deletes the created service and dropped file from the target machine (as it’s\nsuccessfully infected).\n\n## Command 21: Collecting Installed Applications\n\nQBot can collect installed applications by enumeration subkeys of the registry key\n```\n\"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\" .\n\n```\n\n-----\n\nThe collected data is appended to the end of a string containing additional information about\nthe victim’s machine and time of collection.\n```\nt=i1 time=[<time_of_collect>] ext_ip=[<external_IP>] dnsname=[?] hostname=\n[<computer_name>] user=[] domain=[] is_admin=[<YES/NO>] os=[<windows_ver>]\nqbot_version=[<qbot_ver>] install_time=[<qbot_install_time>] exe=\n[<injected_process>] prod_id=[NULL] iface_n=[<interface_IP>/<interface_IP>]\nUP] soft=[<app1;ver>|<app2;ver>|...]\n\n```\nExample of collected data:\n\nThen the data is RC4 encrypted and written to `\"wdqlxw32.dll\" at the same directory of`\nQBot.\n\nFinally, `\"wdqlxw32.dll\" is Zlib compressed and RC4 encrypted again then it’s saved to`\n```\n\"cwdqlxw32.dll\" and the original \"wdqlxw32.dll\" is deleted.\n\n```\n\n-----\n\nThe compressed file is then transfered to the C2 server (RC4 encrypted and Base64\nencoded) in the key `\"36\" and the compressed file` `\"cwdqlxw32.dll\" is also deleted.`\n\n## Command 31: Fetching Plugins\n\nAs we said before, QBot is known to be a modular malware. It can load additional plugins\nreceived from the C2 server (plugins are RC4 encrypted and Base64 encoded).\n\nQBot tries to inject the received plugin in 3 different processes depending on the machine\narchitecture.\n\nIt creates a new suspended process then writes the plugin to the process memory using\n```\nWriteProcessMemory() and then resumes the injected process.\n\n```\n\n-----\n\nAt the time of writing this, Qbot has 3 different plugins (“Password grabber”, “Cookie\ngrabber”, “UPnP module”).\n\n## Conclusion\n\nQBot is considered to be a sophisticated malware, it’s receiving regular updates from time to\ntime and it’s not likely to go away anytime soon.\n\nThere is still more features that I didn’t cover such as WebInjects so maybe I will come back\nto Qbot later I guess :)\n\n## IOCs\n\n**Hashes**\n\nVBS File: b734caf792c968ca1870c3ec7dda68ad5dc47fef548751afb8509752c185a756\n\nQBot: 112a64190b9a0f356880eebf05e195f4c16407032bf89fa843fd136da6f5d515\n\n**URLs**\n\nhttp://st29[.]ru/tbzirttmcnmb/88888888.png\n\nhttp://restaurantbrighton[.]ru/uyqcb/88888888.png\n\nhttp://royalapartments[.]pl/vtjwwoqxaix/88888888.png\n\nhttp://alergeny.dietapacjenta[.]pl/pgaakzs/88888888.png\n\nhttp://egyorg[.]com/vxvipjfembb/88888888.png\n\n**C2 Domains**\n\n39.36.254.179:995\n\n24.139.132.70:443\n\n24.202.42.48:2222\n\n\n-----\n\n72.204.242.138:443\n\n172.242.156.50:995\n\n72.204.242.138:20\n\n68.174.15.223:443\n\n74.193.197.246:443\n\n96.56.237.174:990\n\n64.19.74.29:995\n\n70.168.130.172:443\n\n189.236.166.167:443\n\n68.4.137.211:443\n\n76.187.8.160:443\n\n76.86.57.179:2222\n\n73.226.220.56:443\n\n67.250.184.157:443\n\n75.183.171.155:3389\n\n173.172.205.216:443\n\n173.3.132.17:995\n\n172.78.30.215:443\n\n207.255.161.8:32103\n\n75.137.239.211:443\n\n68.49.120.179:443\n\n206.51.202.106:50003\n\n82.127.193.151:2222\n\n207.255.161.8:2222\n\n207.255.161.8:2087\n\n\n-----\n\n24.152.219.253:995\n\n187.19.151.218:995\n\n197.37.48.37:993\n\n188.241.243.175:443\n\n72.88.119.131:443\n\n89.137.211.239:443\n\n108.30.125.94:443\n\n187.163.101.137:995\n\n100.19.7.242:443\n\n45.77.164.175:443\n\n80.240.26.178:443\n\n66.208.105.6:443\n\n207.246.75.201:443\n\n199.247.22.145:443\n\n199.247.16.80:443\n\n95.77.223.148:443\n\n68.60.221.169:465\n\n5.107.220.84:2222\n\n41.228.212.22:443\n\n86.233.4.153:2222\n\n68.200.23.189:443\n\n201.146.127.158:443\n\n79.114.199.39:443\n\n87.65.204.240:995\n\n71.74.12.34:443\n\n\n-----\n\n217.162.149.212:443\n\n195.162.106.93:2222\n\n75.165.112.82:50002\n\n201.248.102.4:2078\n\n96.41.93.96:443\n\n89.247.216.127:443\n\n84.232.238.30:443\n\n103.238.231.40:443\n\n174.34.67.106:2222\n\n98.115.138.61:443\n\n91.125.21.16:2222\n\n84.247.55.190:443\n\n193.248.44.2:2222\n\n74.135.37.79:443\n\n78.96.190.54:443\n\n86.126.97.183:2222\n\n2.50.47.97:2222\n\n68.39.160.40:443\n\n96.232.203.15:443\n\n86.144.150.29:2222\n\n71.220.191.200:443\n\n24.231.54.185:2222\n\n80.14.209.42:2222\n\n24.164.79.147:443\n\n70.183.127.6:995\n\n\n-----\n\n47.153.115.154:993\n\n184.180.157.203:2222\n\n50.104.68.223:443\n\n67.165.206.193:995\n\n200.113.201.83:993\n\n47.153.115.154:465\n\n24.42.14.241:995\n\n189.160.203.110:443\n\n188.27.76.139:443\n\n207.255.161.8:32102\n\n49.207.105.25:443\n\n71.210.177.4:443\n\n117.242.253.163:443\n\n50.244.112.106:443\n\n69.92.54.95:995\n\n41.34.91.90:995\n\n72.204.242.138:53\n\n41.97.138.74:443\n\n72.29.181.77:2078\n\n71.88.168.176:443\n\n2.50.171.142:443\n\n67.83.54.76:2222\n\n86.125.145.90:2222\n\n47.153.115.154:995\n\n24.122.157.93:443\n\n\n-----\n\n47.146.169.85:443\n\n72.181.9.163:443\n\n187.155.74.5:443\n\n71.209.187.4:443\n\n74.75.216.202:443\n\n24.44.180.236:2222\n\n24.43.22.220:993\n\n108.188.116.179:443\n\n100.4.173.223:443\n\n76.170.77.99:443\n\n70.95.118.217:443\n\n134.0.196.46:995\n\n68.225.56.31:443\n\n72.204.242.138:32102\n\n72.204.242.138:50001\n\n108.190.151.108:2222\n\n72.204.242.138:465\n\n50.244.112.10:443\n\n173.22.120.11:2222\n\n24.43.22.220:995\n\n24.43.22.220:443\n\n92.17.167.87:2222\n\n72.209.191.27:443\n\n72.204.242.138:80\n\n72.204.242.138:443\n\n\n-----\n\n71.187.170.235:443\n\n96.56.237.174:32103\n\n71.187.7.239:443\n\n184.98.104.7:995\n\n70.124.29.226:443\n\n137.99.224.198:443\n\n73.23.194.75:443\n\n151.205.102.42:443\n\n64.224.76.152:443\n\n72.204.242.138:32100\n\n173.187.101.221:443\n\n72.179.13.59:443\n\n208.93.202.49:443\n\n70.174.3.241:443\n\n96.37.137.42:443\n\n76.111.128.194:443\n\n67.209.195.198:3389\n\n61.3.184.27:443\n\n24.42.14.241:443\n\n74.56.167.31:443\n\n5.193.61.212:2222\n\n117.216.177.171:443\n\n## References\n\n[Demystifying QBot Banking Trojan - BSides Belfast](https://www.youtube.com/watch?v=iB1psRMtlqg)\n\n\n-----\n\nhttps://www.virusbulletin.com/virusbulletin/2017/06/vb2016-paper-diving-pinkslipbots-latestcampaign\n\n[https://www.fortinet.com/blog/threat-research/deep-analysis-qbot-campaign](https://www.fortinet.com/blog/threat-research/deep-analysis-qbot-campaign)\n\n[https://www.vkremez.com/2018/07/lets-learn-in-depth-reversing-of-qakbot.html](https://www.vkremez.com/2018/07/lets-learn-in-depth-reversing-of-qakbot.html)\n\nhttps://www.hexacorn.com/blog/2016/07/01/enter-sandbox-part-12-the-library-of-naughtylibraries/\n\n[https://www.cyberbit.com/blog/endpoint-security/anti-vm-and-anti-sandbox-explained/](https://www.cyberbit.com/blog/endpoint-security/anti-vm-and-anti-sandbox-explained/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-15 - Deep Analysis of QBot Banking Trojan.pdf"
    ],
    "report_names": [
        "2020-07-15 - Deep Analysis of QBot Banking Trojan.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536231,
    "ts_updated_at": 1743041146,
    "ts_creation_date": 1653697620,
    "ts_modification_date": 1653697620,
    "files": {
        "pdf": "https://archive.orkl.eu/76d0646a457128a09f211976cae6e72865f02fc4.pdf",
        "text": "https://archive.orkl.eu/76d0646a457128a09f211976cae6e72865f02fc4.txt",
        "img": "https://archive.orkl.eu/76d0646a457128a09f211976cae6e72865f02fc4.jpg"
    }
}