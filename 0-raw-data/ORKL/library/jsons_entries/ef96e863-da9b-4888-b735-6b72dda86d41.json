{
    "id": "ef96e863-da9b-4888-b735-6b72dda86d41",
    "created_at": "2023-02-02T02:07:31.401358Z",
    "updated_at": "2025-03-27T02:13:08.198969Z",
    "deleted_at": null,
    "sha1_hash": "8a4c3468127c7bbe282483363dea6cf0f5929e12",
    "title": "2023-01-05 - A crowning achievement- Exploring the exploit of Royal ransomware",
    "authors": "",
    "file_creation_date": "2023-02-01T07:44:54Z",
    "file_modification_date": "2023-02-01T07:44:54Z",
    "file_size": 3107845,
    "plain_text": "# A crowning achievement: Exploring the exploit of Royal ransomware\n\n**[logpoint.com/en/blog/exploring-the-exploit-of-royal-ransomware/](https://www.logpoint.com/en/blog/exploring-the-exploit-of-royal-ransomware/)**\n\nRasmus Plambech January 5, 2023\n\n**_By Anish Bogati, Security Research_**\n\n**Contents**\n\nFast Facts\n\nRoyal analysis\n\nAnalysis of an older version of Royal\n\nDetecting Royal using Logpoint\n\nInvestigation and response using Logpoint\n\nEnd-to-end detection, investigation, and response of Royal with Logpoint\n\n## TL;DR\n\nFirst observed in January 2022 and unlike any other ransomware we have covered, Royal is a\nprivate group with no known affiliations at this time. In another campaign, initial access is gained via\n“callback” phishing attacks. In this type of attack, the threat actors send an email containing a\nmessage to update a subscription of some kind and make the victim call the given number. When\nvictims make a call mentioned in the mail, threat actors social engineered them to download and\ninstall their malware. A similar technique was previously used by the Conti group. The gang has\nbeen seen employing virtual hard disk (VHD) files that seem like legitimate software to speed up the\ntransfer of first-stage payloads.\n\n** Get research and analysis, insight, plus hints and tips, on how to detect, manage, and respond to\n_Royal ransomware in the main blog._\n\n_Head to the contents and click each section for quick navigation._\n\n_[First observed in January 2022 and unlike any other ransomware we have covered, Royal is a](https://www.hhs.gov/sites/default/files/royal-ransomware-analyst-note.pdf)_\n_private group with no known affiliations at this time. However, Royal has been found deployed by_\n_threat actors_ _[DEV-0569. The group has been found using Google ads to redirect users to forums,](https://www.microsoft.com/en-us/security/blog/2022/11/17/dev-0569-finds-new-ways-to-deliver-royal-ransomware-various-payloads/)_\n_posts, and blog comments, or sending phishing emails that contain links to download the malware._\n\n\n-----\n\nRoyal leak site\n\n[In another campaign, initial access is gained via “callback” phishing attacks. In this type of attack, the](https://www.bleepingcomputer.com/news/security/new-royal-ransomware-emerges-in-multi-million-dollar-attacks/)\nthreat actors send an email containing a message to update a subscription of some kind and make\nthe victim call the given number. When victims make a call mentioned in the mail, threat actors social\n[engineered them to download and install their malware. A similar technique was previously used by](https://www.bleepingcomputer.com/news/security/bazarcall-malware-uses-malicious-call-centers-to-infect-victims/)\nthe [Conti group.](https://www.logpoint.com/en/blog/detecting-conti-ransomware-the-successor-of-infamous-ryuk/)\n\nTo bypass defense, DEV-0569 employs phishing links and malicious downloaders that seem like\n[legitimate installers or updates. The gang has been seen employing virtual hard disk (VHD) files that](https://blog.polyswarm.io/royal-ransomware)\nseem like legitimate software to speed up the transfer of first-stage payloads.\n\n## Fast Facts\n\nSince November 2022, the data of more than 60 victims has been leaked\n\nWritten in C++ and is specifically designed for the Windows OS\n\nSupports various file encryption options\n\nUses various social engineering techniques for initial access\n\nUses the RestartManager to shut down the process that is using the files to be encrypted\n\nAccording to the [U.S. Department of HHS, after gaining initial access and execution of their payload,](https://www.hhs.gov/sites/default/files/royal-ransomware-analyst-note.pdf)\nthe Cobalt Strike beacon is dropped in the victim system to maintain persistence, access credentials,\nand move laterally. The main ransomware payload uses a few command line arguments like “-id”\nand “-path.” Without using those command line arguments and corresponding values, it only\nperforms system information discovery and inhibits system recovery by deleting all the shadow\n\n\n-----\n\ncopies as a method of evading sandboxing and analysis. The third argument is -ep and is not\nmandatory. The encrypted files are appended with the “.royal” file extension. While encrypting files it\navoids encrypting specific folders and file types to prevent a system crash.\n\nBelow are the file types that are not encrypted by Royal.\n\n**.exe, .dll, .bat, .lnk, .royal**\n\nBelow are those folders whose sub-folders and files are not encrypted by the ransomware.\n\n**Windows, Royal, Perflogs, Tor browser, Boot, $recycle.bin, Windows.old, $window.~ws,**\n**$windows.~bt, Mozilla, Google**\n\nRansom note\n\n## Royal analysis\n\nWe have used multiple ransomware variants for our analysis to provide an all-encompassing\n[detection and understanding. The samples we used were retrieved from MalwareBazaar and for](https://bazaar.abuse.ch/sample/f484f919ba6e36ff33e4fb391b8859a94d89c172a465964f99d6113b55ced429/)\n[reference, we also used samples from tria.ge sandboxes. We performed a static and dynamic](https://tria.ge/221114-e2qhsseg47/behavioral2)\nanalysis in our sandbox which is running Microsoft Windows 10 Enterprise. The outcomes of our\nanalysis are explained below.\n\nTo execute the malware, currently, two things are mandatory: “-path” and “-id.” The path argument is\nfor encrypting the specified directory and the “-id” argument is required for starting the encryption\nprocess and it should be a unique 32-character string. We have also observed the third argument “ep” which seems to be optional for now and is used to determine the percentage of files that is to be\nencrypted. After analyzing the sample we have found out that if the command line arguments are\nmissing or the parameter’s value is not correct, then it doesn’t perform encryption of files.\n\n\n-----\n\nShowing command-line arguments\n\nThe malware retrieves the command-line string for the process using the GetCommandLineW API\nand CommandLineToArgvW is used to obtain an array of pointers to the command-line arguments.\n\nFunction used to retrieve command line\n\nWe have also found a call to GetNativeSystemInfo API which contains various system information\nlike architecture, number of processors, and page size. Using the GetNativeSystemInfo with\n**dwNumberOfProcessor function, the malware is trying to retrieve the number of the processor’s**\ncores.\n\nFunction used to retrieve systeminfo\n\n\n-----\n\nWe have also found the instance where Royal was querying the registry key\n“HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\ComputerName\\ActiveComputerName”\nto retrieve the system name.\n\nQuerying system name\n\nAlso Royal has been found querying the registry key shown in below image to check system\nlanguage settings. This can be done to verify language settings and display output accordingly.\n\nQuerying system language\n\nRoyal uses the GetIpAddrTable function to retrieve the IP address table from the local computer. It\nreturns a list of IP addresses and their corresponding subnet masks and default gateways.\n\nFunction used to retrieve IP address information\n\nThe malware also uses the Windows API function NetShareEnum to enumerate the shared\nresources on the network. The below function compares the names of the shared resources returned\nby the API call with the strings “ADMIN$” and “IPC$” to prevent the malware from encrypting those\nshares.\n\n\n-----\n\nFunction used to query network share\n\nTo prevent system recovery, Royal has been using the vssadmin utility to delete all the available\nshadow copies without displaying any message.\n\nDisplaying process creation of vssadmin\n\n\n-----\n\nWhile executing the malware we observed the malware spawning child process for running\nvssadmin to delete all shadow copies.\n\nShadow copy delete via vssadmin\n\nBefore starting up the encryption process, the malware checks if any of the targeted files to be\nencrypted are being used by other processes. If the files are found to be used by other applications,\nthe malware uses RestartManager to kill those applications and services using the resource.\n\nApplication session delete\n\nAfter freeing up the resources, the malware begins the encryption process. While viewing the events\nthrough ProcMon, we observed the following actions while a file was being encrypted.\n\nEncryption process view form ProcMon without “-ep” argument\n\n### Analysis of an older version of Royal\n\nAs mentioned, the Royal operator was previously using malware known as Zeon. We were also able\n[to observe the sample analysis in tria.ge. After executing this malware sample it first tries to stop](http://tria.ge/)\nvarious services like backup, web engine, POP3, IMAP, SQL, VSS, antivirus, etc., using net and net1\nbinary. It also attempts to kill various processes relating to Office products, Firefox, Wordpad,\ncalculator, oracle, and steam using taskkill.exe binary.\n\n\n-----\n\n[Royal process tree](https://tria.ge/220224-l7djracga3/behavioral2)\n\nThen the malware attempts to create a scheduled task using schtask.exe with a random task name.\nIn this case, Royal uses a binary masquerading as an image to evade detection. To overcome any\nfailed attempt to schedule a task, the malware tries to schedule the task multiple times.\n\n\n-----\n\nScheduled task creation\n\nAfter scheduling the task, the malware uses the schtasks.exe binary to execute the task.\n\nScheduled task execution\n\nThen the below command is used to delete the file “pqBxGx.jpg.” The “/F” option forces the deletion\nof the file, even if it is read-only. The “/Q” option tells the command to delete the file without asking\nfor confirmation. The “>> NUL” portion redirects the output of the command to the null device, which\ndiscards it and prevents it from being displayed on the screen.\n\nCommand to delete pqBxGx.jpg file.\n\n## Detecting Royal using Logpoint\n\n**Log Source Needed**\n\nWindows Event Logs\n\nSysmon for Windows\n\nAs mentioned earlier, to set up the precondition for the ransomware to detonate, the malware stops\nmany services and kills various processes. To detect such activity of Royal ransomware, analysts\ncan use the below query.\n```\n(label=\"process\" label=create \"process\"=\"*\\taskkill.exe\"\n\n(command= \"*f *\" command=\"*im *\") OR command=\"*IM *\") OR\n\n(label=\"process\" label=create (\"process\" IN [\"*\\sc.exe\", \"*\\net.exe\", \"*\\net1.exe\"]\n\ncommand=\"*stop*\") OR (\"process\"=\"*\\sc.exe\" command=\"*delete*\") -user IN EXCLUDED_USERS)\n\n| chart count() as occurrence by user, host, domain,\"process\",parent_process \n\n| search occurrence > 8  \n\n```\n\n-----\n\nDetecting Royal activity in Logpoint\n\nAdversaries have used scheduled task functionality to facilitate for single or repetitive execution of\nmalicious codes. Here, Royal ransomware has been seen to create a scheduled task to launch the\nransomware. Thus, analysts need to look for the creation of scheduled tasks using the schtasks\nbinary.\n```\n(label=\"Process\" label=Create \"process\"=\"*\\schtasks.exe\" command=\"* /create *\")\nOR (label=\"Registry\" label=\"Key\" label=\"Map\" event_type=CreateKey\n\n\"target_object\"=\"*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\*\"\n\n -target_object IN\n\n[\"*\\SOFTWARE\\Microsoft\\Windows\nNT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\Microsoft\\Windows\\UpdateOrchestrator*\"]) \n\n```\nSo, not just the creation of scheduled tasks, but events related to running of the scheduled task\nthrough schtasks should be monitored too.\n```\nlabel=\"Process\" label=Create \"process\"=\"*\\schtasks.exe\" command=\"* /run *\"\n\n```\nThe malware also performs SMB share enumeration to encrypt the share folder, so access to\nmultiple share folders in a short span from the same user and host needs to be monitored.\n```\n[5 norm_id=winserver event_id=5140 share_name=*\n\nhaving same user,host,source_address within 1 minute]\n\n```\nAccording to the requirement, the number of events and time duration can be changed in the above\nquery.\n\nTo prevent recovery of the drives, Royal has been found deleting the volume shadow copy of the\ndrive using the vssadmin utility.\n```\nlabel=\"Process\" label=\"Create\"\n\n(\"process\" IN [\"*\\powershell.exe\", \"*\\wmic.exe\", \"*\\vssadmin.exe\", \"*\\diskshadow.exe\"]\n\ncommand=\"* shadow*\" command=\"*delete*\") OR\n\n(\"process\"= \"*\\wbadmin.exe\" command=\"*delete*\" (command=*systemstatebackup*)\n\nOR (command=\"*catalog*\" command=\"*quiet*\")) \n\nOR (\"process\"=\"*\\vssadmin.exe\" command=\"*resize*\" command=\"*shadowstorage*\"\n\ncommand=\"*unbounded*\")  \n\n```\n\n-----\n\nDetecting Royal activity in Logpoint\n\nIf files to be encrypted are being used by other applications, Royal uses RestartManager to kill the\nvarious processes that are using the files to be encrypted. The below query detects five such events\nthat occurred within a minute.\n```\n[5 norm_id=Windowssysmon event_id=12 event_type=DeleteValue \n\ntarget_object=\"*\\software\\microsoft\\restartmanager\\session*\" within 1 minute]\n\n```\nTo detect the relevant logs, registry auditing for the RestartManager registry key needs to be enabled\nin sysmon.\n\nHigh Volume of File Modification or Deletion in Short Span:\n```\n[30 label=File label=Object label=Storage access IN [\"Delete*\",\"writedata*\"]\n\n-\"process\" IN [\"*\\tiworker.exe\",\"*\\poqexec.exe\",\"*\\msiexec.exe\"] having same host,\n\ndomain, user,\" process\" within 1 minute]\n\n```\n\n-----\n\nThe above image shows that the Python process has modified or deleted 20 files in a minute.\nDepending on the situation and the needs, the number of logs and the time range to trigger alerts\ncan be modified. This alert detects a large number of file modifications or deletions in a short period\nso, it can detect file encryption activity by the ransomware.\n\n[The given alerts are available in Logpoint’s latest Alert Rules package and are available free for](https://servicedesk.logpoint.com/hc/en-us/articles/115003928409)\ndownload for Logpoint customers.\n\n## Investigation and response using Logpoint\n\nThere is no actual silver bullet for investigation and response to ransomware. However, Logpoint\nSOAR is by far the most useful tool for organizations to investigate and respond to ransomware\nattacks.\n\n1. Phishing investigation and response\n\nRoyal ransomware groups also use phishing techniques to gain initial access and this playbook\nensures all suspicious phishing incidents are adequately investigated and responded to,\ndramatically reducing the response time and human error.\n\nPhishing investigation playbook\n\n\n-----\n\n2. Ransomware investigation\n\nThis playbook thoroughly examines the IoCs and uses a sandbox to detonate the suspicious\nfiles. It also looks for the common TTPs used by the ransomware, improving the chances of\ndetecting ransomware before it is too late. The playbook will prompt an alert message to the\nadministrators if ransomware is identified, and will start further work to isolate the host and\ncontain the malware.\n\nRansomware investigation playbook\n\n3. Isolate endpoint mitigation\n\nUsing the new Logpoint AgentX, this playbook identifies the infected host and isolates it; and\ncontains and quarantines it before it spreads to other machines. AgentX is a built-in response\ncapability on endpoints and to start using it, contact your Logpoint representative.\n\nIsolate endpoint mitigation playbook\n\n\n-----\n\n4. Block indicators\n\nThis playbook checks if any IP, domain, URL, or host exists in a list of IoCs, blocks them, and\nadds them to the blocked list.\n\nBlock indicator playbook\n\n5. Delete scheduled task\n\nThe Logpoint AgentX delete scheduled task response playbook reduces the burden of\nmanually deleting a suspicious scheduled task. This playbook requires the analyst to provide\nthe hostname of the machine where the scheduled task was created, the manager IP address,\nand the scheduled task name.\n\nSuccessful deletion of scheduled task\n\n### Endpoint detection and remediation with AgentX\n\nLogpoint AgentX is a lightweight application that transports logs and telemetry from endpoints (all\nservers, workstations, and applications) to the SIEM, and performs automated real-time investigation\nand remediation of threats with SOAR. With AgentX, security analysts get precise detection of\n\n\n-----\n\nmalicious malware and the ability to respond to threats in endpoints.\n\nLogpoint AgentX is available now: Contact your representative.\n\n## End-to-end detection, investigation, and response of Royal with Logpoint\n\nRoyal is a private group with no affiliates. Despite being a private group, Royal ransomware\noperators were able to leak the data of more than 60 victims on their leak site within a one-and-halfmonth period. This ransomware uses various tactics and techniques to achieve its end goals. For a\nfaster encryption process, it uses partial encryption and other encryption options. As ransomware\npayloads are deployed in later stages, we can still detect them before they can encrypt an\norganization’s sensitive data. Through proper system logging and using the Logpoint Converged\nSIEM platform combining SIEM, SOAR, and endpoint response, we can detect the traces of the\nransomware and investigate and respond to the malware’s activities.\n\nRansomware Group Statistics for December 2022\n\n_Source: https://darkfeed.io/2023/01/02/ransomware-groups-statistics-december-2022/_\n\n\n-----\n\n### Contact Logpoint\n\nContact us and learn why\n\nindustry-leading companies\n\nchoose Logpoint:\n\nContact Logpoint\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-01-05 - A crowning achievement- Exploring the exploit of Royal ransomware.pdf"
    ],
    "report_names": [
        "2023-01-05 - A crowning achievement- Exploring the exploit of Royal ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "cf4d333d-ef79-40aa-b233-886e6de875a3",
            "created_at": "2023-12-08T02:00:05.754609Z",
            "updated_at": "2025-03-27T02:00:03.266797Z",
            "deleted_at": null,
            "main_name": "DEV-0569",
            "aliases": [
                "Storm-0569"
            ],
            "source_name": "MISPGALAXY:DEV-0569",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d1f8bd4e-bcd4-4101-9158-6158f1806b38",
            "created_at": "2023-01-06T13:46:39.487358Z",
            "updated_at": "2025-03-27T02:00:03.107568Z",
            "deleted_at": null,
            "main_name": "BazarCall",
            "aliases": [
                "BazaCall",
                "BazzarCall"
            ],
            "source_name": "MISPGALAXY:BazarCall",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1675303651,
    "ts_updated_at": 1743041588,
    "ts_creation_date": 1675237494,
    "ts_modification_date": 1675237494,
    "files": {
        "pdf": "https://archive.orkl.eu/8a4c3468127c7bbe282483363dea6cf0f5929e12.pdf",
        "text": "https://archive.orkl.eu/8a4c3468127c7bbe282483363dea6cf0f5929e12.txt",
        "img": "https://archive.orkl.eu/8a4c3468127c7bbe282483363dea6cf0f5929e12.jpg"
    }
}