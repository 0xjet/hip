{
    "id": "e0797e89-3a29-4d73-9772-8f33cbed2adb",
    "created_at": "2023-01-12T15:07:16.956325Z",
    "updated_at": "2025-03-27T02:14:02.711061Z",
    "deleted_at": null,
    "sha1_hash": "ef6f81e3b6800dda8fd8dd77d1a54828f9e733e1",
    "title": "2019-10-21 - Winnti Group’s skip‑2.0- A Microsoft SQL Server backdoor",
    "authors": "",
    "file_creation_date": "2022-05-28T21:46:25Z",
    "file_modification_date": "2022-05-28T21:46:25Z",
    "file_size": 626662,
    "plain_text": "# Winnti Group’s skip‑2.0: A Microsoft SQL Server backdoor\n\n**welivesecurity.com/2019/10/21/winnti-group-skip2-0-microsoft-sql-server-backdoor/**\n\nNotorious cyberespionage group debases MSSQL\n\n[Mathieu Tartare](https://www.welivesecurity.com/author/mtartare/)\n21 Oct 2019 - 11:30AM\n\nNotorious cyberespionage group debases MSSQL\n\n\nOctober 21, 2019\n\n\nFor a while, ESET researchers have been tracking the activities of the Winnti Group, active since at least 2012 and responsible for high[profile supply-chain attacks against the video game and software industry. Recently, we discovered a previously undocumented](https://www.welivesecurity.com/2019/03/11/gaming-industry-scope-attackers-asia/)\nbackdoor targeting Microsoft SQL (MSSQL) that allows attackers to maintain a very discreet foothold inside compromised organizations.\nThis backdoor bears multiple similarities to the PortReuse backdoor, another tool used by the Winnti Group that was first documented by\nESET in October 2019, such as the use of the same custom packer and VMProtected launcher, which is why we attribute this backdoor\nto the Winnti Group.\n\nEarlier this year, we received a sample of this new backdoor called skip-2.0 by its authors and part of the Winnti Group’s arsenal. This\nbackdoor targets MSSQL Server 11 and 12, allowing the attacker to connect stealthily to any MSSQL account by using a magic\npassword – while automatically hiding these connections from the logs. Such a backdoor could allow an attacker to stealthily copy,\nmodify or delete database content. This could be used, for example, to manipulate in-game currencies for financial gain. In-game\n\n\n-----\n\n[currency database manipulations by Winnti operators have already been reported. To the best of our knowledge, skip 2.0 is the first](https://image.ahnlab.com/global/upload/download/documents/1401223631603288.pdf)\nMSSQL Server backdoor to be documented publicly. Note that even though MSSQL Server 11 and 12 are not the most recent versions\n[(released in 2012 and 2014, respectively), they are the most commonly used ones according to Censys’s data.](https://censys.io/)\n\n[We recently published a white paper updating our understanding of the arsenal of the Winnti Group, and that exposed a previously](https://www.welivesecurity.com/wp-content/uploads/2019/10/ESET_Winnti.pdf)\nundocumented backdoor of theirs called PortReuse. It uses an identical packer to that used with the payload embedded in compromised\n[video games uncovered by ESET in March 2019. The VMProtected launcher that drops the PortReuse backdoor was also found being](https://www.welivesecurity.com/2019/03/11/gaming-industry-scope-attackers-asia/)\nused to launch recent ShadowPad versions. In that context, we were able to find a new tool called skip.2-0 by its developer. It uses the\nsame VMProtected launcher as well as Winnti Group’s custom packer and exhibits multiple similarities with other samples from the\nWinnti Group’s toolset. This leads us to ascribe skip-2.0 to that toolset also.\n\nThis article will focus on the technical details and functionality of this MSSQL Server backdoor, as well as on exposing the technical\nsimilarities of skip.2-0 with the Winnti Group’s known arsenal – in particular, with the PortReuse backdoor and ShadowPad. A note on\n[the reasons why we chose the “Winnti Group” naming can be found on our white paper.](https://www.welivesecurity.com/2019/10/14/connecting-dots-exposing-arsenal-methods-winnti/)\n\n# VMProtected launcher\n\nWe found skip-2.0 while looking for VMProtected launchers, for which the payload is usually either PortReuse or ShadowPad.\n\n### Embedded payload\n\nAs with the encrypted PortReuse and ShadowPad payloads, skip-2.0 is embedded in the VMProtected launcher’s overlay, as shown in\nFigure 1:\n\n_Figure 1. VMProtected launcher’s headers. The payload is embedded in the PE overlay._\n\n### Encryption\n\nThe payload encryption is identical to that used in the other VMProtected launchers. It is RC5-encrypted with a key derived from the\n[VolumeID and the string f@Ukd!rCto R$. – as described in our previous white paper on the Winnti Group arsenal.](https://www.welivesecurity.com/wp-content/uploads/2019/10/ESET_Winnti.pdf)\n\n### Persistence\n\n[As in the case of PortReuse and ShadowPad, the launcher probably persists by exploiting a DLL hijacking vulnerability by being installed](https://posts.specterops.io/lateral-movement-scm-and-dll-hijacking-primer-d2f61e8ab992)\nat C:\\Windows\\System32\\TSVIPSrv.DLL. This results in the DLL being loaded by the standard Windows SessionEnv service at system\nstartup.\n\n# Winnti Group’s custom packer\n\nOnce decrypted the embedded payload is actually Winnti Group’s custom packer. This packer is the same shellcode that was\n[documented in our previous article and](https://www.welivesecurity.com/2019/03/11/gaming-industry-scope-attackers-asia/) [white paper. It is used to pack the PortReuse backdoor as well as the payload embedded in the](https://www.welivesecurity.com/wp-content/uploads/2019/10/ESET_Winnti.pdf)\ncompromised video games.\n\n### Packer configuration\n\nAs described in our previous article, the packer configuration contains the decryption key of the packed binary as well as its original\nfilename, its size and the execution type (EXE or DLL). The payload’s packer configuration is shown in Table 1.\n\n\n**Parent SHA-1** **Payload SHA-1** **RC4 key** **Filename**\n\n9aafe81d07b3e5bb282608f0a2a4656eb485b7c9 a2571946ab181657eb825cde07188e8bcd689575 163716559 InnerLoader.dll\n\n_Table 1. Payload’s packer configuration_\n\n\n**Launch**\n**type**\n\n2\n\n\n-----\n\nOne can see from the packer configuration that the payload is called Inner Loader. Inner Loader is the name of an injector that is the\npart of the Winnti Group’s arsenal used to inject the PortReuse backdoor into processes listening on a particular port, as described in our\nprevious publication. Beyond that identical name, by analyzing this payload it appears that it is another variant of the Inner-Loader\ninjector.\n\n## Inner-Loader injector\n\nThis variant of Inner-Loader, instead of looking for a process listening on a particular port, as in the case when injecting the PortReuse\nbackdoor, looks for a process called sqlserv.exe, which is the conventional process name of MSSQL Server. If found, Inner-Loader then\ninjects a payload into this process. This payload is also packed with the custom packer – the packer configuration of that payload is\nshown in Table 2.\n\n\n**Parent SHA-1** **Payload SHA-1** **RC4 key** **Filename**\n\n\n**Launch**\n**type**\n\n2\n\n\na2571946ab181657eb825cde07188e8bcd689575\n\n\n60b9428d00be5ce562ff3d888441220290a6dac7 923567961 skip2.0.dll\n\n\n_Table 2. Packer configuration of the payload embedded in Inner-Loader_\nThe original filename of this injected payload is skip-2.0.dll.\n\n# skip-2.0\n\nAfter having been injected and launched by Inner-Loader, skip-2.0 first checks whether it is executing within an sqlserv.exe process and\nif so, retrieves a handle to sqllang.dll, which is loaded by sqlserv.exe. It then proceeds to find and hook multiple functions from that DLL.\nFigure 2 depicts the skip-2.0 chain of compromise.\n\n_Figure 2. skip-2.0 unpacking and injection_\n\n\n-----\n\n### Hooking sqllang.dll\n\nThe hooking procedure used by skip-2.0 is very similar to the one used by NetAgent, the PortReuse module responsible for installing the\n[networking hook. This hooking library is based on the distorm open source disassembler that is used by multiple open source hooking](https://github.com/gdabah/distorm)\nframeworks. In particular, a disassembling library is needed to correctly compute the size of the instructions to be hooked. One can see\nin Figure 3 that the hooking procedure used by NetAgent and skip-2.0 are almost identical.\n\n_Figure 3. Hex-Rays output comparison between the NetAgent (left) and skip-2.0 (right) hooking procedures_\n\nThere is one notable difference, which is the fact that the hooking function from skip-2.0 takes the address of the hook to be installed as\nan argument, while for NetAgent, the address of the hook to install is hardcoded. This is due to the fact that skip-2.0 has to hook multiple\nfunctions in sqllang.dll to operate properly, while NetAgent targets only a single function.\n\nTo locate each sqllang.dll function to be hooked, skip-2.0 first retrieves the size of the DLL once loaded in memory (i.e. its virtual size) by\nparsing its PE headers. Then an array of bytes to be matched within sqllang.dll is initialized as shown in Figure 4. Once the address of\nthe first occurrence matching the byte array is found, the hook is installed using the procedure shown in Figure 3.\n\n_Figure 4. Hex-Rays output of the procedure initializing the byte array to match in sqllang.dll_\n\nThe success of the hook installation is then logged in cleartext in a log file located at the hardcoded path\nC:\\Windows\\Temp\\TS_2CE1.tmp and shown in Figure 5.\n\n_Figure 5. Log generated during hooks installation_\n\nShould the targeted function not be found, the hook installer searches for a fallback function, with a different set of byte patterns.\n\nMatching a sequence of bytes to locate the address of the targeted function instead of using a static offset, plus using a fallback\nsequence of bytes, allows skip-2.0 to be more resilient to MSSQL updates and to potentially target multiple sqllang.dll updates.\n\n### One password to rule them all\n\nThe functions targeted by skip-2.0 are related to authentication and event logging. The targeted functions include:\n\nCPwdPolicyManager::ValidatePwdForLogin\n\n\n-----\n\nCSECAuthenticate::AuthenticateLoginIdentity\nReportLoginSuccess\nIssueLoginSuccessReport\nFExecuteLogonTriggers\nXeSqlPkg::sql_statement_completed::Publish\nXeSqlPkg::sql_batch_completed::Publish\nSecAuditPkg::audit_event::Publish\nXeSqlPkg::login::Publish\nXeSqlPkg::ual_instrument_called::Publish\n\nThe most interesting function is the first one (CPwdPolicyManager::ValidatePwdForLogin), which is responsible for validating the\npassword provided for a given user. This function’s hook checks whether the password provided by the user matches the magic\npassword; if that is the case, the original function will not be called and the hook will return 0, allowing the connection even though the\ncorrect password was not provided. A global flag is then set that will be checked by the other hooked functions responsible for event\nlogging. The corresponding decompiled procedure is shown in Figure 6. In the case where this global flag is set, the hooked logging\nfunctions will silently return without calling their corresponding, original functions, so the action will not be logged. In the case where a\ndifferent password is provided, the original function is called.\n\n_Figure 6. Hex-Rays output of the procedure responsible for matching the password provided at login with the hardcoded string_\n\n[A similar backdooring technique, based on hardcoded passwords, was used with SSH backdoors previously discovered by ESET. The](https://www.welivesecurity.com/wp-content/uploads/2018/12/ESET-The_Dark_Side_of_the_ForSSHe.pdf)\ndifference here is that skip-2.0 is installed in-memory, while in the case of the SSH backdoors the sshd executable was modified prior to\nexecution.\n\nAdditionally, CSECAuthenticate::AuthenticateLoginIdentity will be called from within its hook code but the hook will always return 0. The\nReportLoginSucess and IssueLoginSuccessReport hooks will not call the original functions if the magic password was used to log in.\nThe same behavior is applied to FEExecuteLogonTriggers. Other logging functions such as\nXeSqlPkg::sql_statement_completed::Publish or XeSqlPkg::sql_batch_completed::Publish will also be disabled in the case where the\nuser logged in with the magic password. Multiple audit events are disabled as well, including SecAuditPkg::audit_event::Publish,\nXeSqlPkg::login::Publish and XeSqlPkg::ual_instrument_called::Publish.\n\nThis series of hooks allows the attacker not only to gain persistence in the victim’s MSSQL Server through the use of a special\npassword, but also to remain undetected thanks to the multiple log and event publishing mechanisms that are disabled when that\npassword is used.\n\nWe tested skip-2.0 against multiple MSSQL Server versions and found that we were able to login successfully using the special\npassword with MSSQL Server 11 and 12. To check whether a particular sqllang.dll version is targeted by skip-2.0 (i.e., that matches the\n[byte patterns), we created a YARA rule, which can be found in our GitHub repository.](https://github.com/eset/malware-ioc/tree/master/winnti_group)\n\n# Connection with the Winnti Group\n\nWe observed multiple similarities between skip-2.0 and other tools from the Winnti Group’s arsenal. Its VMProtected launcher, custom\npacker, Inner-Loader injector and hooking framework are part of the already known toolset of the Winnti Group. This leads us to think\nthat skip-2.0 is also part of that toolset.\n\n# Conclusion\n\nThe skip-2.0 backdoor is an interesting addition to the Winnti Group’s arsenal, sharing a great deal of similarities with the group’s already\nknown toolset, and allowing the attacker to achieve persistence on an MSSQL Server. Considering that administrative privileges are\nrequired for installing the hooks, skip-2.0 must be used on already compromised MSSQL Servers to achieve persistence and\nstealthiness.\n\nWe will continue to monitor new activities of the Winnti Group and will publish relevant information on our blog. For any inquiries, contact\nus at [threatintel@eset.com.](http://10.10.0.46/mailto:threatintel@eset.com)\n\n\n-----\n\n# Indicators of Compromise (IoCs)\n\n**Component** **SHA-1** **ESET detection name**\n\n\nVMP Loader 18E4FEB988CB95D71D81E1964AA6280E22361B9F\n4AF89296A15C1EA9068A279E05CC4A41B967C956\n\n\nWin64/Packed.VMProtect.HX\n\n\nInner-Loader injector A2571946AB181657EB825CDE07188E8BCD689575 Win64/Injector.BS\n\nskip-2.0 60B9428D00BE5CE562FF3D888441220290A6DAC7 Win32/Agent.SOK\n\n\nKnown targeted sqllang.dll files (nonexhaustive list)\n\n### MITRE ATT&CK techniques\n\n\n4396D3C904CD340984D474065959E8DD11915444\nBE352631E6A6A9D0B7BBA9B82D910FA5AB40C64E\nD4ADBC3F77ADE63B836FC4D9E5915A3479F09BD4\n0BBD3321F93F3DCDD2A332D1F0326142B3F4961A\nFAE6B48F1D6EDDEC79E62844C444FE3955411EE3\nA25B25FFA17E63C6884E28E96B487F58DF4502E7\nDE76419331381C390A758E634BF2E165A42D4807\nED08E9B4BA6C4B5A1F26D671AD212AA2FB0874A2\n1E1B0D91B37BAEBF77F85D1B7C640B8CC02FE11A\n59FB000D36612950FEBC36004F1317F7D000AA0B\n661DA36BDD115A1E649F3AAE11AD6F7D6FF2DB63\n\n\nN/A\n\n\n**Tactic** **ID** **Name** **Description**\n\nExecution [T1035](https://attack.mitre.org/techniques/T1035/) Service Execution _skip-2.0 is started with the SessionEnv service_\n\nPersistence [T1038](https://attack.mitre.org/techniques/T1038/) DLL Search Order Hijacking _skip-2.0 probably uses a DLL hijacking technique_\nagainst the SessionEnv service\n\n[T1179](https://attack.mitre.org/techniques/T1179/) Hooking _skip-2.0 hooks multiple functions in sqllang.dll service_\nto bypass authentication and maintain stealth\n\n\nDefense\nEvasion\n\n\n[T1054](https://attack.mitre.org/techniques/T1054/) Indicator Blocking _skip-2.0 blocks event logging_\n\n\n[T1045](https://attack.mitre.org/techniques/T1045/) Software\nPacking\n\n\n_skip.2-0 and Inner-Loader are packed using Winnti's_\ncustom packer. Further, the launcher is VMProtected.\n\n\nDiscovery [T1057](https://attack.mitre.org/techniques/T1057/) Process Discovery _Inner-Loader lists running processes in order to_\nfind the process running MSSQL Server\n\nImpact [T1485](https://attack.mitre.org/techniques/T1485/) Data Destruction _skip-2.0 allows unauthorized access to MSSQL_\ndatabases, allowing data destruction or\ntampering\n\n\n[T1494](https://attack.mitre.org/techniques/T1494/) Runtime\nData\nManipulation\n\n[T1492](https://attack.mitre.org/techniques/T1492/) Stored Data\nManipulation\n\n21 Oct 2019 - 11:30AM\n\n\n_skip-2.0 manipulates event logging at runtime_\n\n_skip-2.0 allows unauthorized access to MSSQL_\ndatabases, allowing manipulation of stored data\n\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Disc ssion\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-10-21 - Winnti Group’s skip‑2.0- A Microsoft SQL Server backdoor.pdf"
    ],
    "report_names": [
        "2019-10-21 - Winnti Group’s skip‑2.0- A Microsoft SQL Server backdoor.pdf"
    ],
    "threat_actors": [
        {
            "id": "5bbced13-72f7-40dc-8c41-dcce75bf885e",
            "created_at": "2022-10-25T15:50:23.695735Z",
            "updated_at": "2025-03-27T02:00:55.525839Z",
            "deleted_at": null,
            "main_name": "Winnti Group",
            "aliases": [
                "Winnti Group"
            ],
            "source_name": "MITRE:Winnti Group",
            "tools": [
                "PipeMon",
                "Winnti for Windows",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "945a572f-ebe3-4e2f-a288-512fe751cfa8",
            "created_at": "2022-10-25T16:07:24.413971Z",
            "updated_at": "2025-03-27T02:02:10.212853Z",
            "deleted_at": null,
            "main_name": "Winnti Group",
            "aliases": [
                "Wicked Panda",
                "Winnti Group"
            ],
            "source_name": "ETDA:Winnti Group",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "FunnySwitch",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536036,
    "ts_updated_at": 1743041642,
    "ts_creation_date": 1653774385,
    "ts_modification_date": 1653774385,
    "files": {
        "pdf": "https://archive.orkl.eu/ef6f81e3b6800dda8fd8dd77d1a54828f9e733e1.pdf",
        "text": "https://archive.orkl.eu/ef6f81e3b6800dda8fd8dd77d1a54828f9e733e1.txt",
        "img": "https://archive.orkl.eu/ef6f81e3b6800dda8fd8dd77d1a54828f9e733e1.jpg"
    }
}