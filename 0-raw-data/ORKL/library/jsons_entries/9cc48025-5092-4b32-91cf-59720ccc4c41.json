{
    "id": "9cc48025-5092-4b32-91cf-59720ccc4c41",
    "created_at": "2023-01-12T15:09:41.698651Z",
    "updated_at": "2025-03-27T02:15:35.783148Z",
    "deleted_at": null,
    "sha1_hash": "5e8648a866709a77b35ad6c2b66f0320979b0988",
    "title": "2018-05-25 - BackSwap malware finds innovative ways to empty bank accounts",
    "authors": "",
    "file_creation_date": "2022-05-28T17:42:56Z",
    "file_modification_date": "2022-05-28T17:42:56Z",
    "file_size": 869053,
    "plain_text": "# BackSwap malware finds innovative ways to empty bank accounts\n\n**[welivesecurity.com/2018/05/25/backswap-malware-empty-bank-accounts/](https://www.welivesecurity.com/2018/05/25/backswap-malware-empty-bank-accounts/)**\n\nMay 25, 2018\n\nESET researchers have discovered a piece of banking malware that employs a new\ntechnique to bypass dedicated browser protection measures\n\n[Michal Poslušný](https://www.welivesecurity.com/author/mposlusny/)\n25 May 2018 - 12:58PM\n\n\n-----\n\nESET researchers have discovered a piece of banking malware that employs a new\ntechnique to bypass dedicated browser protection measures\n\nBanking malware (also referred to as banker) has been decreasing in popularity among\ncybercrooks for a few years now, one of the reasons being that both anti-malware\ncompanies and web browser developers are continuously widening the scope of their\nprotection mechanisms against banking Trojan attacks. This results in conventional banking\nmalware fraud becoming more complicated to pull off every day, resulting in malware\nauthors shifting their time and resources into developing easier-to-make and more profitable\ntypes of malware like ransomware, cryptominers, and cryptocurrency stealers.\n\nWe have discovered a new banking malware family that uses an innovative technique to\nmanipulate the browser: instead of using complex process injection methods to monitor\nbrowsing activity, the malware hooks key Windows message loop events in order to inspect\nvalues of the window objects for banking activity.\n\nOnce banking activity is detected, the malware injects malicious JavaScript into the web\npage, either via the browser’s JavaScript console or directly into the address bar. All these\noperations are done without the user’s knowledge. This is a seemingly simple trick that\nnevertheless defeats advanced browser protection mechanisms against complex attacks.\n\n## Introduction\n\nWe first noticed the group behind this banking malware spreading their earlier projects –\none of them being malware that was stealing cryptocurrency by replacing wallet addresses\nin the clipboard – back in January of this year. The group focused on clipboard malware for\na few months and eventually introduced the first version of the banking malware, detected\nby ESET as Win32/BackSwap.A, on March 13 2018.\n\nIn the figure below we can see a dramatic spike in detection rate compared to the previous\nprojects, as viewed from our backend processes. The authors have been very active in the\ndevelopment of the banker and have continued to introduce new versions pretty much on a\ndaily basis, taking breaks only at weekends.\n\n\n-----\n\nFigure 1. Overview of detections of Win32/BackSwap.A banking malware and related, previous\n\nprojects.\n\n## Distribution and execution\n\nThe banker is distributed through malicious email spam campaigns that carry an attachment\nof a heavily obfuscated JavaScript downloader from a family commonly known as\nNemucod. The spam campaigns are targeting Polish users.\n\n[Very often the victim machines are also compromised by the](https://www.welivesecurity.com/2013/08/26/nymaim-obfuscation-chronicles/) [well–known](https://www.welivesecurity.com/2013/10/23/nymaim-browsing-for-trouble/)\nWin32/TrojanDownloader.Nymaim downloader, which seems to be spread using a similar\nmethod. At the time of writing we do not know whether this is just a coincidence or if these\ntwo families are directly connected.\n\nThe payload is delivered as a modified version of a legitimate application that is partially\noverwritten by the malicious payload. The application used as the target for the modification\nis being changed regularly – examples of apps misused in the past include TPVCGateway,\nSQLMon, DbgView, WinRAR Uninstaller, 7Zip, OllyDbg, and FileZilla Server. The app is\nmodified to jump to the malicious code during its initialization. One of the techniques used\nto achieve this is adding a pointer to the malicious payload into the _initterm() function\ntable, which is an internal part of C Run-Time Library that initializes all global variables and\nother parts of the program that need to be initialized before the main() function is called.\n\n\n-----\n\nFigure 2. _initterm pointer array of a legitimate application with pointer to banker’s shellcode at the\n\nend.\n\nThis method might be reminiscent of “trojanization”, but the difference is that the original\napplication no longer works, and once control is transferred to the malware, it will never\nreturn to the original code. Therefore, the intent is not to fool users into thinking they are\nrunning the legitimate app, but rather to increase the “stealthiness” of the malware against\nanalysis and detection. This makes the malware harder for an analyst to spot, as many\nreverse engineering tools like IDA Pro will show the original main() function as a legitimate\nstart of the application code and an analyst might not notice anything suspicious at first\nglance.\n\nThe payload is a position-independent blob of code with all its data embedded within. The\ncharacter strings are stored in plain text, which ruins its otherwise very small footprint, as all\nrequired Windows APIs are looked up by hash during runtime. The malware starts by\ncopying itself into a startup folder in order to ensure persistence and then proceeds with its\nbanking functionality.\n\n## Conventional injection methods\n\nTo steal money from a victim’s account via the internet banking interface, typical banking\nmalware will inject itself or its specialized banking module into the browser’s process\naddress space. For many reasons, this is not an easy task – first of all, as mentioned\nbefore, the injection might be intercepted by a third-party security solution. The injected\nmodule also needs to match the bitness of the browser – a 32-bit module cannot be injected\ninto a 64-bit browser process and vice versa. This results in banking trojans usually having\nto carry both versions of a given module in order to support both 32-bit and 64-bit versions\nof the browsers.\n\nWhen successfully injected, the banking module needs to find browser-specific functions\nand hook them. The malware looks for functions that are responsible for sending and\nreceiving HTTP requests in plain text before encryption, and after decryption, respectively.\n\n\n-----\n\nThe difficulty of finding these functions varies from browser to browser – in the case of\nMozilla Firefox, the functions are exported by the nss3.dll library and their addresses can be\neffortlessly looked up by their widely known names. On the other hand, Google Chrome and\nother Chromium-based browsers have these functions hidden and implemented deep inside\nthe binary, which makes them very hard to find. This forces the malware authors to come up\nwith specialized methods and patterns that only work for the specific version of the browser.\nOnce a new version comes out, new methods and patterns must be implemented.\n\nIf the right functions are found and hooks are successfully installed (note that hooks may\nalso be detected by a security solution), the banking trojan can begin to modify the HTTP\ntraffic or redirect the victim to a different website impersonating a bank while faking the\nvalidity of a certificate. Similar techniques are incorporated by currently active, high-profile\n[banking trojans like Dridex,](https://www.welivesecurity.com/2018/01/26/friedex-bitpaymer-ransomware-work-dridex-authors/) [Ursnif, Zbot, Trickbot, Qbot and many others.](https://www.virusbulletin.com/uploads/pdf/conference_slides/2017/Kalnai-VB2017-browser-attack-points-trojans.pdf)\n\n## New browser manipulation technique\n\nWin32/BackSwap.A has a completely different approach. It handles everything by working\nwith Windows GUI elements and simulating user input. This might seem trivial, but it\nactually is a very powerful technique that solves many “issues” associated with conventional\nbrowser injection. First of all, the malware does not interact with the browser on the process\nlevel at all, which means that it does not require any special privileges and bypasses any\nthird-party hardening of the browser, which usually focuses on conventional injection\nmethods. Another advantage for the attackers is that the code does not depend either on\nthe architecture of the browser or on its version, and one code path works for all.\n\nThe malware monitors the URL currently being visited by installing event hooks for a\nspecific range of relevant events available through the Windows message loop, such as\nEVENT_OBJECT_FOCUS, EVENT_OBJECT_SELECTION,\nEVENT_OBJECT_NAMECHANGE and a few others. The hook will look for URL patterns\nby searching the objects for strings starting with “https” retrieved by calling the\nget_accValue method from the event’s IAccessible interface.\n\nFigure 3. Technique used for retrieving currently-visited URLs from the browser. These URLs are\n\nretrieved by checking the [ht]tp[s] substring (in red).\n\n\n-----\n\nThe malware will then look for bank-specific URLs and window titles in the browser that\nindicate that the victim is about to make a wire transfer.\n\nFigure 4. Banker looks for specific bank strings – the first string is a window title, the second is a\n\npart of a URL.\n\nOnce identified, the banker loads malicious JavaScript appropriate for the corresponding\nbank from its resources and injects it into the browser. The script injection is also done in a\nsimple, yet effective way.\n\nIn older samples, the malware inserts the malicious script into the clipboard and simulates\npressing the key combination for opening the developer’s console (CTRL+SHIFT+J in\nGoogle Chrome, CTRL+SHIFT+K in Mozilla Firefox) followed by CTRL+V, which pastes the\ncontents of the clipboard and then sends ENTER to execute the contents of the console.\nFinally, the malware sends the console key combination again to close the console. The\nbrowser window is also made invisible during this process – to regular users it might seem\nas if their browser simply froze for a moment.\n\nIn the newer variants of the malware, this approach has been upgraded – instead of\ninteracting with the developer’s console, the malicious script is executed directly from the\naddress bar, via [JavaScript protocol URLs, a little-used feature supported by most](https://msdn.microsoft.com/en-us/library/aa767736(v=vs.85).aspx)\nbrowsers. The malware simply simulates pressing CTRL+L to select the address bar\nfollowed by the DELETE key to clear the field, then “types” in “javascript:” by calling\nSendMessageA in a loop, and then pastes the malicious script with the CTRL+V\ncombination. It then executes the script by sending the ENTER key. At the end of the\nprocess, the address bar is cleared to remove any signs of compromise.\n\n\n-----\n\nIn Figure 5 we can see a part of the console injection code: first, the malware determines\nthe browser by checking the class name of the foreground window (marked in blue). The\nmalicious JavaScript is copied into the clipboard (marked in red). Then, the opacity of the\nbrowser window is changed to 3, which turns it invisible (marked in purple). Green marks\nthe part of the ToggleBrowserConsole function that turns the browser’s console on and off.\n\nFigure 5. Script injection technique.\n\nWin32/BackSwap.A supports attacks against Google Chrome, Mozilla Firefox and in recent\nversions its authors also added support for Internet Explorer. However, this method will\nwork for most browsers today, as long as they have a JavaScript console available or\nimplement execution of JavaScript from the address bar, both of which are standard\nbrowser features these days.\n\n[All three supported browsers have an interesting protective feature, which was originally](https://blogs.msdn.microsoft.com/ieinternals/2011/05/19/socially-engineered-xss-attacks/)\n[designed as a countermeasure against Self-XSS attacks: When users attempt to paste text](https://en.wikipedia.org/wiki/Self-XSS)\nstarting with “javascript:” into the address bar, the protocol prefix is removed and users\n\n\n-----\n\nneed to type it into the address bar manually to actually execute the script.\nWin32/BackSwap.A bypasses this countermeasure by simulating the typing of the prefix\ninto the address bar, letter by letter, before pasting in the malicious script.\n\nAnother countermeasure implemented by Mozilla Firefox disallows pasting scripts into the\nconsole by default and instead shows a message warning users about potential risks,\nforcing them to type in “allow pasting” first. The malware bypasses this by executing the\nshell command shown in Figure 6, which modifies the prefs.js configuration file and\nremoves this countermeasure.\n\nFigure 6. The shell command used to remove Firefox script console pasting protection.\n\n## Malicious JavaScript\n\nThe banker implements a specific script for each targeted bank, as every banking site is\ndifferent and has different source code and variables. These scripts are injected into pages\nthe malware identifies as initiating a wire transfer request, such as paying a utility account.\nThe injected scripts secretly replace the recipient’s bank account number with a different\none and when the victim decides to send the wire transfer, the money will be sent to the\nattackers instead. Any safeguards against unauthorized payment, such as 2-factor\nauthorization, won’t help in this case, as the account owner is willingly sending the wire\ntransfer.\n\n\n-----\n\nWin32/BackSwap.A has had malicious scripts targeting five Polish banks in total – PKO\nBank Polski, Bank Zachodni WBK S.A., mBank, ING and Pekao. Its authors sometimes\nremove some banks from the list of targets and in the most recent version, for example,\nthey left only three banks – PKO BP, mBank and ING. In older versions, the attackers were\nretrieving the receiving bank account numbers from C&C servers that were hosted on\nhacked WordPress websites. In the recent versions, they have stored these account\nnumbers directly in the malicious scripts. The malicious bank account numbers change very\nfrequently, and pretty much every campaign has a new one.\n\nAs we can see in the figure below, the banker will only steal money if the wire transfer\namount is in a certain range – they usually target payments between 10,000 and 20,000\nPLN, which is around 2,800 – 5,600 USD. The script replaces the original recipient bank\naccount, and also replaces the input field for that number with a fake one that displays the\noriginal bank account, so the user sees the valid number and thus is unlikely to be\nsuspicious.\n\nFigure 7. Part of the malicious JavaScript. The areas in red show the checking of the wire transfer\n\namount and replacement of the recipient’s bank account number.\n\n## Conclusion\n\nWin32/BackSwap.A shows us that in the ongoing battle between the security industry and\nauthors of banking malware, new malicious techniques do not necessarily need to be highly\nsophisticated to be effective. We think that, as browsers become better protected from\nconventional code injection, malware authors will attack the browsers in different fashions\nand Win32/BackSwap.A has just shown us one of the possibilities.\n\nESET solutions detect and block the threat as Win32/BackSwap.A trojan.\n\nWe have notified the affected browser vendors about the innovative script injection\ntechnique.\n\n\n-----\n\n_Special thanks to Paweł Śmierciak for discovering this family and his help in this research._\n\n## IoCs\n\n**9BC4C1D5403DDD90712CE87225490A21D1EDC516** **JS/Nemucod.EAN trojan**\n\n**CF5A74C268661501156663F74CD5E20603B0F261** **Win32/BackSwap.A trojan**\n\n**6251F9AD0E5F551AC4A6B918EF366E86C4CCFDC4** **Win32/BackSwap.A trojan**\n\n**2DC9760A7C6E9D261C73EFB7B2604840734BC058** **Win32/BackSwap.A trojan**\n\n**A68901D0D8C1247FF280F9453E3AE45687C57566** **Win32/BackSwap.A trojan**\n**(JavaScript)**\n\n25 May 2018 - 12:58PM\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-05-25 - BackSwap malware finds innovative ways to empty bank accounts.pdf"
    ],
    "report_names": [
        "2018-05-25 - BackSwap malware finds innovative ways to empty bank accounts.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536181,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653759776,
    "ts_modification_date": 1653759776,
    "files": {
        "pdf": "https://archive.orkl.eu/5e8648a866709a77b35ad6c2b66f0320979b0988.pdf",
        "text": "https://archive.orkl.eu/5e8648a866709a77b35ad6c2b66f0320979b0988.txt",
        "img": "https://archive.orkl.eu/5e8648a866709a77b35ad6c2b66f0320979b0988.jpg"
    }
}