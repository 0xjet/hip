{
    "id": "38d456f7-7d3c-417c-8ef4-19803c21b70c",
    "created_at": "2023-01-12T15:08:41.359616Z",
    "updated_at": "2025-03-27T02:16:01.182159Z",
    "deleted_at": null,
    "sha1_hash": "7477bf8559938b7c7b6b8287eb902c9bc0a18453",
    "title": "2020-07-14 - The Domain Generation Algorithm of BazarBackdoor",
    "authors": "",
    "file_creation_date": "2022-05-27T21:08:41Z",
    "file_modification_date": "2022-05-27T21:08:41Z",
    "file_size": 1223356,
    "plain_text": "# The Domain Generation Algorithm of BazarLoader\n\n**johannesbader.ch/blog/the-dga-of-bazarbackdoor/**\n\nA DGA based on the Emercoin TLD .bazar\n\n**Edit 2020-07-19: Cybereason published an excellent article A Bazar of Tricks: Following**\nTeam9’s Development Cycles. They only show the seeding part of the domain generation\nalgorithm, however, the listing of generated bazar domains matches the algorithm in this blog\npost (apart from the first two domains `alztwfdicu.bazar and` `ocgjqlaspr.bazar which`\nare hardcoded). The article shows that the DGA is part of Bazar Loader, which will try to\ndownload Bazar Backdoor. I therefore renamed most instances of BazarBackdoor to\nBazarLoader.\n\n**Edit 2020-07-14: I have documented some additions to the DGA of BazarLoader:**\n\nThere exists a version of BazarLoader with a faulty DGA. I documented it in a separate\n[blog post.](https://johannesbader.ch/blog/the-buggy-dga-of-bazarbackdoor)\n[The attackers registered four of the DGA domains, which @Securityinbits long before I](https://twitter.com/Securityinbits)\npublished this post. I listed them here.\nThe malware transforms the A RR of registered DGA domains, see the paragraph on\nsinkholing\n\n\n-----\n\nBazarLoader (also known as Bazar Loader, Bazar Backdoor or Team9 Backdoor) is a\nmodule of the dreaded TrickBot Trojan. It is mostly used to gain a foothold in compromised\nenterprise networks 1 2 3 4  . The malware is named after the C&C domains with top level\ndomain .bazar. This TLD is provided by EmerDNS, a peer-to-peer decentralized domain\nname system in OpenNIC. This makes it very difficult, if not impossible, for law enforcement\nto take over these domains.\n\nBazarLoader has been using a handful of hard-coded domains such as `bestgame.bazar,`\n\n`forgame.bazar or` `newgame.bazar in the past, but today a sample` was uploaded to\nVirustotal that tries a plethora of domains such as:\n```\necfgjkehhgjm.bazar\nafhhjkakjhjm.bazar\nbeggklbjigkn.bazar\ncfhhjkckjhjm.bazar\nbdehklbighkn.bazar\ndcegjldhggjn.bazar\nadggjkaiigjm.bazar\ndcghkldhihkn.bazar\ndehhikdjjhim.bazar\nceegkkcjggkm.bazar\neeegjkejggjm.bazar\ncfehjkckghjm.bazar\ncehhimcjjhio.bazar\nddfgjldihgjn.bazar\nafhijlakjijn.bazar\nccfgimchhgio.bazar\neefhklejhhkn.bazar\nacgiimahiiio.bazar\necghjkehihjm.bazar\ncehiklcjjikn.bazar\n\n```\nThese look like algorithmically generated — and it turns out they are. This blog post shows\nhow the underlying domain generation algorithm works.\n\n## Sample\n\nI analysed the aforementioned sample from Virustotal:\n\n**MD5**\nfdffbfa1380ab1a0ee2e26ff1be432b1\n\n**SHA1**\n5a004286c5b97afd97beec4b1332777c494d6ff1\n\n**SHA256**\ne77e27630277a31276539c379671f54095d6b735f0568a3c457ac6a189c4c5b4\n\n**Size**\n288 KB (295424 Bytes)\n\n\n-----\n\n**Compile Timestamp**\n2020-06-12 09:35:14 UTC\n\n**Links**\n[MalwareBazaar,](https://bazaar.abuse.ch/sample/e77e27630277a31276539c379671f54095d6b735f0568a3c457ac6a189c4c5b4/) [Cape,](https://www.capesandbox.com/analysis/24419/) [VirusTotal](https://www.virustotal.com/gui/file/e77e27630277a31276539c379671f54095d6b735f0568a3c457ac6a189c4c5b4)\n\n**Filenames**\nBthCxn.exe, v86.exe_ (VirusTotal)\n\n**Detections**\n**MalwareBazaar: BazaLoader, Virustotal: 23/76 as of 2020-07-10 04:00:39 -**\nTrojan:Win32/Trickbot.KB (Microsoft), Trojan.Trickbot!8.E313 (CLOUD) (Rising)\n\nMany AV classify the sample as malicious, but only Microsoft and Rising also name the\nsample, both as Trickbot — which is at correct in the broader sense. The binary unpacks to\nthis:\n\n**MD5**\n599b72d329b4b876390ae0567991da01\n\n**SHA1**\na8128b487bf6efd80b78c453e24a3447208008dd\n\n**SHA256**\n6b24ebfb84665cb844410ec9f948cfcf7f6d08f4ede16d52930c53236390848f\n\n**Size**\n141 KB (144896 Bytes)\n\n**Compile Timestamp**\n2020-06-12 09:34:11 UTC\n\n**Links**\n[MalwareBazaar,](https://bazaar.abuse.ch/sample/6b24ebfb84665cb844410ec9f948cfcf7f6d08f4ede16d52930c53236390848f/) [VirusTotal](https://www.virustotal.com/gui/file/6b24ebfb84665cb844410ec9f948cfcf7f6d08f4ede16d52930c53236390848f)\n\n**Filenames**\n_none_\n\n**Detections**\n**Virustotal: 10/75 as of 2020-07-10 13:52:07**\n\nThe detection for this sample is worse and none of the AV products assigns a non-generic\nname. The sample will finally inject the following executable, which only 3 out of 76 products\neven classify as malicious.\n\n**MD5**\nd1c4d25673be94db051dcd5271c64ae1\n\n**SHA1**\ncc4d30072bbd16fbdc387eb546aeb4dc38a5ea4a\n\n\n-----\n\n**SHA256**\nb4b7f0fd63cda1269ee937fa398fb80b6655d205066e6593fefceda7e3b09f6b\n\n**Size**\n132 KB (135168 Bytes)\n\n**Compile Timestamp**\n2020-06-11 11:16:31 UTC\n\n**Links**\n[MalwareBazaar,VirusTotal](https://bazaar.abuse.ch/sample/b4b7f0fd63cda1269ee937fa398fb80b6655d205066e6593fefceda7e3b09f6b/)\n\n**Filenames**\n_none_\n\n**Detections**\n**Virustotal: 3/76 as of 2020-07-10 13:52:05**\n\n## DGA Disassembly\n\nThe domain generation algorithm of BazarLoader is in a single function, including seeding\n(click to enlarge):\n\n\n-----\n\nThe algorithm roughly consists of these three steps:\n\n1. Determine the first six letters of the second level domain at random.\n2. Generate a seed based on the current date\n3. Calculate the last six letters of the second level domain based on the first six and the\n\nseed.\n\n### Step 1: First Six Letters\n\nThe (simplified) decompilation of the first step is as follows:\n\n\n-----\n\n```\ni 0;\ndo\n{\n  r = (GetTickCount() % 25) / (i + 6);\n  i_1 = i++;\n  *domain++ = 2 * i_1 + r + 'a';\n}\nwhile ( i < 6 );\n\n```\nThe function `GetTickCount usually doesn’t bode well for DGAs: since this functions is`\nlargely unpredictable, it almost always means that the generated domains will be\nunpredictable as well. However, this algorithm is different. The tick count is mapped to a\nvalue between 0 and 24, which is then divided by 6+i. The division shrinks down the range of\nnumbers, and ultimately the range of potential letters. The character set is also offset by\ndouble the loop index, leading to these choices of letters:\n\n**index** **random number range** **potential letters**\n\n0 0–4 abcde\n\n1 0–3 cdef\n\n2 0–3 efgh\n\n3 0–2 ghi\n\n4 0–2 ijk\n\n5 0–2 klm\n\nSo even though the exact letters can’t be predicted, there are only 2160 combinations. Since\nthe malware continuously tries to contact newly generated domains, registering a few of the\n2160 domains is probably enough to get lucky with `GetTickCount within a couple of`\nminutes of malware runtime.\n\n### Step 2: Seeding\n\nSeeding is based on on the current date, which is determined by `GetDateFormatA .`\n\n\n-----\n\n```\nif ( !seeding_done )\n{\n GetDateFormatA(LOCALE_INVARIANT, 0, 0i64, 0i64, lpCurrentDate, 24);\n szMonth = lpCurrentDate[0];\n szYear = *&lpCurrentDate[3];\n v15 = 0;\n v17 = 0;\n str_to_int = resolve_api(0i64, 19i64, 2865918183i64, 534i64);\n if ( str_to_int )\n   nYear = str_to_int(&szYear);\n else\n   nYear = 0;\n str_to_int_0 = resolve_api(0i64, 19i64, 2865918183i64, 534i64);\n if ( str_to_int_0 )\n   nMonth = str_to_int_0(&szMonth);\n else\n   nMonth = 0;\n LODWORD(nYearMinus18) = nYear - 18;\n wnsprintfA(szSeedStr, 7, \"%.2d%d\", (12 - nMonth), nYearMinus18);\n seeding_done = 1;\n}\n\n```\nThe function `GetDateFormatA with` `LOCALE_INVARIANT locale returns the current date`\nformatted as `<month>/<day>/<year>, so for example` `07/10/2020 for July 10, 2020. The`\nmonth and year are taken from this string and converted into integers. The month is then\nturned into a two-digit number by calculating `a = 12 - month and padding it with zero if`\nnecessary. The year is transformed into a four-digit number according to `b = year - 18 .`\nThe two values are then concatenated into a string. For example, July 2020 turns into\n```\n052002 .\n\n### Step 3: Last Six Letters\n\n```\nThe last six characters of the second level domain are based on the seed and the first six\nletters:\n```\nj = 6;\n[...]\nszDomainPlusSix = szDomain + 6;\ndo\n{\n  ascii_code = *(szDomainPlusSix - 6) + szDomainPlusSix[szSeedStr - szDomain - 6] '0';\n  if ( ascii_code < 'a' )\n    ascii_code = 'z';\n  *szDomainPlusSix++ = ascii_code;\n  --j;\n}\nwhile ( j );\nszDomain[12] = 0;\n\n```\n\n-----\n\nThis simply treats each character of the seed string as an integer, and uses that to offset the\ncharacters of the first six letters to form the last six letters. For instance, let’s look at the seed\nstring `052002 applied to the randomly picked first six letters` `cfhiilc :`\n\n1. Add 0 to `c to get` `c .`\n2. Add 5 to `f to get` `k .`\n3. Add 2 to `h to get` `j .`\n4. Add 0 to `i to get` `i .`\n5. Add 0 to `i to get` `i .`\n6. Add 2 to `l to get` `n .`\n\nThe malware’s check if the letter falls before `a is actualy not necessary, as the offset is`\nalways positive between 0 and 9. A check to see if the letter falls beyond `z would be more`\nreasonable, but is also unnecessary: the “largest” letter in the first half is “m”, which offset by\n9 leads to “v”. The following image illustrates the procedure:\n\n## Python Reimplementation\n\nWhen implemented in Python, the DGA looks something like this:\n\n\n-----\n\n```\nimport argparse\nfrom datetime import datetime\nfrom itertools import product\ndef dga(date):\n  month = date.month\n  year = date.year\n  date_str = \"{0:02d}{1:04d}\".format(12-month, year-18)\n  valid_chars = [\n   \"abcde\",\n   \"cdef\",\n   \"efgh\",\n   \"ghi\",\n   \"ijk\",\n   \"klm\"\n  ]\n  valid_chars = [list(_) for _ in valid_chars]\n  for part1 in product(*valid_chars):\n    domain = \"\".join(part1)\n    for i, c in enumerate(part1):\n      domain += chr(ord(c) + int(date_str[i]) )\n    domain += \".bazar\"\n    yield domain\nif __name__==\"__main__\":\n  parser = argparse.ArgumentParser()\n  parser.add_argument(\"-d\", \"--date\", help=\"date when domains are generated\")\n  args = parser.parse_args()\n  if args.date:\n    d = datetime.strptime(args.date, \"%Y-%m-%d\")\n  else:\n    d = datetime.now()\n  for domain in dga(d):\n    print(domain)\n\n## Regex\n\n```\nThe possible letters per position is very limited. Assuming that the year is between 2020 and\n2029, the domains match the following regular expression (Edit 2020-11-10: Fixed the\nregular expression, thanks to Luca Corbatto for providing the correct regex):\n```\n[a-e][c-f][e-h][g-i][i-k][k-m][a-f][c-o][g-j][g-i][i-l][k-v]\\.bazar\n\n## Characteristics\n\n```\nThe following table summarizes the properties of BazarLoader’s DGA.\n\n**property** **value**\n\n\n-----\n\n**property** **value**\n\ntype TDD (time-dependent-deterministic), to some extend TDN (timedependent non-deterministic)\n\ngeneration scheme arithmetic\n\nseed current date\n\n\ndomain change\nfrequency\n\n\nevery month\n\n\ndomains per day 2160\n\nsequence random selection, might pick domains multiple times\n\n\nwait time between\ndomains\n\n\nNone\n\n\ntop level domain `.bazar`\n\n\nsecond level\ncharacters\n\n\na-v\n\n\nregex `[a-e][c-f][e-h][g-i][i-k][k-m][a-f][c-o][g-j][i-k][k-m]`\n```\n           [k-v]\\.bazar\n\n```\n\nsecond level\ndomain length\n\n## Domain to Seed\n\n\n12\n\n\nSince the function to determine the second half of the domain is reversible, the month and\n[year can be calculated from the domains. I wrote a small Javascript form that does just that.](https://johannesbader.ch/projects/bazarbackdoor/)\nFor those of you who block Javascript, here’s a screenshot. The same code in Python can\n[also be found on my GitHub page](https://github.com/baderj/domain_generation_algorithms/bazarbackdoor/)\n\n\n-----\n\n## Registered Domains\n\nAs far as I can tell, the attackers registered five domains using the Emercoin address\n[ETQERUknhW2A5cBmfHN4VBqL7VGiFnKQRh. Also see tweets by Brad @malware_traffic](https://twitter.com/malware_traffic/status/1253092725869760512)\n[and Security-in-bits @Securityinbits:](https://twitter.com/Securityinbits/status/1282630604798914565)\n\n**date** **domain** **valid for**\n\n2020-05-18 10:24:32 UTC cdghilckihin.bazar May 2020\n\n2020-05-18 10:24:32 UTC cefgilclhgin.bazar May 2020\n\n2020-07-03 11:08:26 UTC defikldjhikn.bazar July 2020\n\n2020-07-03 11:14:24 UTC aeehjkajghjm.bazar July 2020\n\n2020-07-14 14:13:16 UTC cdfhimcihhio.bazar July 2020\n\n## Sinkholing\n\nThe IP resource record of the DGA domains are XOR decrypted with key `0xFE to get the`\nreal IP of the C2 servers. You can use [this Javascript form to calculate the transformation.](https://johannesbader.ch/projects/bazarbackdoor/)\n\n[1. In-depth analysis of the new Team9 malware family](https://blog.fox-it.com/2020/06/02/in-depth-analysis-of-the-new-team9-malware-family/) ↩\n\n[2. BazarBackdoor: TrickBot gang’s new stealthy network-hacking malware](https://www.bleepingcomputer.com/news/security/bazarbackdoor-trickbot-gang-s-new-stealthy-network-hacking-malware/) ↩\n\n[3. TrickBot BazarLoader In-Depth](https://cybersecurity.att.com/blogs/labs-research/trickbot-bazarloader-in-depth) ↩\n\n[4. Group Behind TrickBot Spreads Fileless BazarBackdoor](https://www.trendmicro.com/vinfo/hk-en/security/news/cybercrime-and-digital-threats/group-behind-trickbot-spreads-fileless-bazarbackdoor) ↩\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-14 - The Domain Generation Algorithm of BazarBackdoor.pdf"
    ],
    "report_names": [
        "2020-07-14 - The Domain Generation Algorithm of BazarBackdoor.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536121,
    "ts_updated_at": 1743041761,
    "ts_creation_date": 1653685721,
    "ts_modification_date": 1653685721,
    "files": {
        "pdf": "https://archive.orkl.eu/7477bf8559938b7c7b6b8287eb902c9bc0a18453.pdf",
        "text": "https://archive.orkl.eu/7477bf8559938b7c7b6b8287eb902c9bc0a18453.txt",
        "img": "https://archive.orkl.eu/7477bf8559938b7c7b6b8287eb902c9bc0a18453.jpg"
    }
}