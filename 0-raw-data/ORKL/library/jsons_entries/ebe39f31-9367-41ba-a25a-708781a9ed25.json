{
    "id": "ebe39f31-9367-41ba-a25a-708781a9ed25",
    "created_at": "2023-01-12T15:04:30.644315Z",
    "updated_at": "2025-03-27T02:05:41.909047Z",
    "deleted_at": null,
    "sha1_hash": "169965abcaaba9adeff8843edb60aa1f1c46f175",
    "title": "2019-02-20 - Spoofing in the reeds with Rietspoof",
    "authors": "",
    "file_creation_date": "2022-05-27T22:08:55Z",
    "file_modification_date": "2022-05-27T22:08:55Z",
    "file_size": 327868,
    "plain_text": "# Spoofing in the reeds with Rietspoof\n\n**[decoded.avast.io/threatintel/spoofing-in-the-reeds-with-rietspoof/](https://decoded.avast.io/threatintel/spoofing-in-the-reeds-with-rietspoof/)**\n\nby [Threat Intelligence TeamFebruary 20, 201912 min read](https://decoded.avast.io/author/threatintel/)\n\n\nFebruary 20, 2019\n\n\nWe’re tracking a new cyberthreat that combines file formats to create a more versatile malware.\n\n_Authored by: Luigino Camastra, Jan Širmer, Adolf Středa and Lukáš Obrdlík_\n\nSince August 2018, we have been monitoring a new malware family we’re\ncalling Rietspoof. Rietspoof is a new multi-stage malware that exhibits some very striking\nfeatures and capabilities. When we began tracking Rietspoof, it was updated about once a month.\nHowever, in January 2019, we noticed the update cadence change to daily.\n\nRietspoof utilizes several stages, combining various file formats, to deliver a potentially more\nversatile malware. Our data suggests that the first stage was delivered through instant messaging\nclients, such as Skype or Live Messenger. It delivers a highly obfuscated Visual Basic Script with\na hard-coded and encrypted second stage — a CAB file. The CAB file is expanded into an\nexecutable that is digitally signed with a valid signature, mostly using Comodo CA. The .exe\ninstalls a downloader in Stage 4.\n\nWhat’s interesting to note, is that the third stage uses a simple TCP protocol to communicate with\nits C&C, whose IP address is hardcoded in the binary. The protocol is encrypted by AES in CBC\nmode. In one version we observed the key being derived from the initial handshake, and in a\nsecond version it was derived from a hard-coded string. In version two, the protocol not only\nsupports its own protocol running over TCP, but it also tries to leverage HTTP/HTTPS requests. It\nis uncommon to see a C&C communication protocol being modified to such an extent, given the\nlevel of effort required to change the communication protocol. While it is common to change\nobfuscation methods, C&C communication usually remains relatively constant in most malware.\n\nThis downloader uses a homegrown protocol to retrieve another stage (Stage 4) from a hardcoded address. While Stage 3 protocol includes bot capabilities, Stage 4 acts as a designated\ndownloader only.\n\n\n-----\n\nAdditionally, the C&C server communicates only with IP addresses set to USA which leads us to\nthe hypothesis that we are working with a specifically targeted attack or the attackers are using\nthe USA IP range only for testing reasons. And, it is possible that there are more stages that\nhaven’t been revealed yet. Here are the results of our full analysis to date.\n\n## VBS deobfuscate & drop embedded file\n\nThe first part of the Visual Basic script is a function for reading and deobfuscating embedded\nbinaries.\n\nFrom this snippet, it is immediately obvious that the script starts reading code at a specific\noffset deobfuscating the CAB file and readying it for the next stage. The code is, character by\ncharacter, converted to its ANSI value and added to the countervariable. At every step,\nthe counter is XORed with val_01 (hard-coded to 15) and appended to already decoded bytes.\nInterestingly, at every step, the string var_str_01is also appended to var_str_02.\n\nAfter this step, the var_str_02 is used as a parameter for a new function. The second parameter\nis TempPath with the following filename:\n\n\n-----\n\nIn this stage, the CAB file is saved to the machine’s Temp folder under the name “JSWdhndk.sjk.”\nThe following stage needs to be extracted from it, which is accomplished by using expand.exe:\n\n## Executing PE and covering tracks\n\nThe script first checks if the logged user is an Admin by simply reading the registry\nkey “HKEY_USERS\\S-1-5-19\\Environment\\TEMP”. In case of success it\nset func_read_Registry to True\n\n7-interim-date\nWhen this flag is set to True, the VBS changes the date to 01-01-2109, deletes the CAB file\nfrom %TEMP%, runs the expanded executable file, and deletes the original script to cover its\ntracks. And, then, it change the date back to the actual date. This interim date with the year\n2109 is not used in the script not dropped files. At the beginning, we thought this was just a typo\nand the intended interim date was 01-01-2019 but this hypothesis was not confirmed.\n\nAn interesting move from the malware authors is to use cmd /c to run commands from the\ncommand line. Look at the description of this command:\n\nThis is most likely an attempt to break behavior detections by spawning more command lines with\ncarried out commands.\nEven if the previous step is skipped, if the current user is not the admin, the next step is to run the\nexpanded PE file. At first, the script deletes a scheduled task Microsoft Windows DOM object\n_helper. This is done by the malware authors to be sure that they can create a new value in_\nschedule tasks pointing to the expanded PE file which was expanded from the previous stage; it\nis set to execute after one minute. Then the CAB file is deleted from %TEMP% directory.\n\n## Adding persistence\n\n\n-----\n\nIn the new version of the VBS,, the malware authors added a new function for persistence\nstarting on January 22, 2019. The script creates a new LNK file in startup with the\nname WindowsUpdate.lnk. This lnk file runs an expanded PE file after startup to ensure the\nexecutable will run if the machine is rebooted.\n\n## Signature\n\nAlmost every version of the VBS file contains a new certificate, for example:\n\nWhen we simply transform this block of code from base64 to hex, and then parse this ASN.1 hex\nstring, we obtain the serial number of this certificate:\n\n13-comodo-certificates\n_Most certificates are issued by COMODO or Sectigo_\n\n\n-----\n\n## Stage 3 – Dropped bot\n\nSo far, we have seen two versions of the third stage of Rietspoof, observing they differ mostly in\nterms of communication protocol. This stage has the capabilities of a simple bot: it can\ndownload/upload files, start processes, or initiate a self-destruct function. The C&C server also\nseems to have implemented basic geofencing based on IP address. We didn’t receive any\n“interesting” commands when we tried to communicate with it from our lab network; however,\nwhen we virtually moved our fake client to the USA, we received a command containing the next\nstage.\n\nWe noticed that development of this third stage is rapidly evolving, sometimes running two\ndifferent branches at once. During our analysis, the communication protocol was modified several\ntimes and new features were added. For example, string obfuscation was supported in earlier\nversions, implemented several days later, and then on the 23rd of January, we saw samples that\nrolled back some of these changes. Newer versions also support the command line switch “/s,”\nused to install themselves as a service named “windmhlp”.\n\n### Timeline\n\n15.1. Obfuscation placeholders, communication protocol v118.1. Implemented obfuscation,\nservice installation, communication protocol v222.1. Obfuscation scrapped, communication\nprotocol v123.1. Obfuscation scrapped, communication protocol v1, service installation\n\nThe bot is either blocked by geofencing or there’s currently no ongoing distribution. The\ncommunication has a simple structure:\n\nReq: client_hello (Deprecated in version 2)Res: client_hello (Deprecated in version\n2)Req: IDRes: OK or HARDWAREReq: HW (if previous response was HARDWARE)Res: OK\n\nThe command “HARDWARE” is sent only if the sent client ID is seen for the first time. The\ncommand “OK” always results in communication termination. This simple protocol is executed\nperiodically every several minutes.\n\n### Communication protocol v1\n\nThe first version of the third-stage communication uses a rather simplistic protocol. At first, a key\nand initialization vector is generated by a handshake that consists of a message and a response,\nboth 32 random bytes and a 4-byte CRC32 checksum. Afterwards, the random bytes are xor-ed\ntogether, and applying SHA256 on the result yields the key. Similarly, applying MD5 on the\nSHA256 digest yields the initialization vector. From now on, these parameters are used to encrypt\nmessages by AES-CBC. Note that the padding function is strangely designed: the last block is\npadded to 16 bytes, if necessary, and another 16 zero-bytes are always appended after the last\nblock.\n\n\n-----\n\n15-key-generator-1\n_Initial handshake and the subsequent key generation: there’s a_\n_check for port array, which is not shown, overflow in-between these two blocks._\n\n16-client-hello-communication\n_String “HELLO\\n” that is obfuscated and subsequently deobfuscated – obfuscation placeholder_\n\n\n-----\n\nThe communication starts with client_hello, a message simply containing HELLO\\n that expects\n“HELLO\\n” as a reply (actually “HELLO\\n\\n\\n\\n\\n\\n…” was always the reply). Then, the client\nsends a command “ID:<MD5 of adapter MAC address>2.10\\n”. Either a response “OK”,\n“HARDWARE”, or a more powerful command is received. In the former, the communication ends\nand the communication loop sleeps for two to five minutes. The response “HARDWARE” induces\na request “HW:<OS info> CPU<CPU info> RAM: <RAM info> USER: <process\n_privileges>”, process privileges being either “admin” (the process has administrator privileges) or_\n“user” (otherwise). Again, after this message a response “OK” is received, similarly ending the\ncommunication.\n\nOne of six alternative commands may follow instead of OK:\n\n\nDEL:\n<filename>\n\nRUN:\n<filename>\n\nDWN:\n<filename>\n\nUPL:\n<filename>\n\nDAR:\n<filename>\n\n\nDelete file, the filename is prefixed by the location of %TEMP%\n\nCreate process with the file as lpCommandLine, the filename is prefixed by the\nlocation of %TEMP%\n\nDownload a file, if the filename has suffix .upgrade then dump VBS update script\nwhich replaces the malware with a newer version.\n\nUpload file from %TEMP%\n\nDownload, save to %TEMP%/<filename> and execute\n\n\nDSF:\\n Delete itself\n\n### Communication protocol v2\n\nThe second version of the third stage of Rietspoof also uses a rather similar protocol with a few\nnew additions. The second version tries to communicate over HTTP/HTTPS, unless a proxy is set\nup, in which case it resorts to raw TCP. This new version also eschews the initial handshake, as it\nuses a hardcoded string “M9h5an8f8zTjnyTwQVh6hYBdYsMqHiAz” instead of XORing two\nrandom strings. Again, this string is put through SHA256, yielding a key, and SHA256 composed\nwith MD5, yielding an initialization vector. These parameters are used to encrypt messages by\nAES-CBC.\n\n18-obfuscated-string\n_Obfuscated “HELLO\\n” string_\n\nThe HTTP GET requests, generated by the malware, are more or less ordinary with the exception\nof three headers that may be present. An example of the HTTP request is below. Note that\nContent-MD5 header is not mandatory; moreover, the Content-MD5 header is used in a custom\nand standard non-compliant way. Also, the User-agent string is hard-coded in the binary.GET\n_/<path>?<GET data> HTTP/1.1_\n\n_Host:<domain>_\n\n_Connection:close_\n\n\n-----\n\n_Content-MD5:<base64 encoded message>_\n_User-agent:Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.1) Gecko/20061204_\n_Firefox/2.0.0.1_\n\nFortunately for us, the old protocol is still present for cases when an HTTP proxy is used. We\nbelieve that this may serve as a protection against trivial man-in-the-middle attacks that could be\nutilized during analysis of the malware. However, in our case, it allows us to deploy a new tracking\nscript with very few modifications, as only the key agreement protocol has been changed.\n\n## Stage 4 – Downloader\n\nThis stage tries to establish an authenticated channel through NTLM protocol over TCP with its\nC&C whose IP address is hardcoded.\n\n_Initiate NTLM authentication_\n\n20-authentication-loop-cncserver-data\n_Main loop of authentication and receiving data from C&C server_\n\nAfterwards it starts communicating with the C&C over the aforementioned channel with the intent\nof recovering either another stage or possibly the final payload.\n\n## Conclusion\n\nAs you have read above, this new malware, Rietspoof, has had a significant increase in its activity\nduring January 2019. During this time, the developer has used several valid certificates to sign\nrelated files. Also, the payloads went through development, namely changing the implementation\nof the Stage 3 communication protocol several times. While the data on Rietspoof is extensive,\nmotives and modus operandi are still unknown, as are the intended targets. And, to date, the\nmalware-infected files are rarely being detected by most antivirus software.\n\nOur research still cannot confirm if we’ve uncovered the entire infection chain. While the malware\nhas bot capabilities, it seems to have been primarily designed as a dropper. Additionally, the low\nprevalence and use of geofencing signifies other possible unknowns. For instance, we may have\nmissed other samples that are distributed only to a specific IP address range.\n\nWe are not sharing IoCs publicly, but, if you are able to prove to Avast that you are an antimalware analyst or researcher, we will make the IoCs available to you. In this case feel free to\ncontact [@n3ph8t3r,](https://twitter.com/n3ph8t3r) [@StredaAdolf and](https://twitter.com/StredaAdolf) [@sirmer_jan on Twitter.](https://twitter.com/sirmer_jan)\n\n\n-----\n\n## Update 2/20/19:\n\nThanks to the [Malware Hunter Team, we received information about the first stage of Rietspoof. It](https://twitter.com/malwrhunterteam/status/1097568650507284483)\nseems that Rietspoof was spread using a Microsoft Word document with macros. The document\nacts as a dropper and a runner for the aforementioned VBS. Upon initial inspection the document\nshows an almost traditional image that is used to persuade users to enable macros, as can be\nseen below:\n\n21-turn-macros-on\nOnce macros are enabled, the information regarding the protected document is deleted and a title\n“Emergency exit map” is shown.\n\n22-info-deleted-from-protected-doc 23-emergency-exit-map\n24-script-deobfuscateds-the-vbs\nAfterwards, this part of the script deobfuscates the VBS and saves it onto the machine,\nexecuting wscript.exe with a parameter\n\n_c:\\users\\NAME\\appdata\\roaming\\microsoft\\word\\startup\\.\\.\\\\Windows\\Cookies\\wordTemplate.vbs, that_\nis a path leading to the dropped VBS, to execute the payload.\n\n25-embedded-in-doc-as-base64string\nThe Visual Basic script, that we described earlier, is embedded in the document as a base64\nstring encoded in hex.\n\n[Tagged asanalysis,](https://decoded.avast.io/tag/analysis/) [threat-intel](https://decoded.avast.io/tag/threat-intel/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-02-20 - Spoofing in the reeds with Rietspoof.pdf"
    ],
    "report_names": [
        "2019-02-20 - Spoofing in the reeds with Rietspoof.pdf"
    ],
    "threat_actors": [
        {
            "id": "f5c5d5d4-3969-4e34-9982-55144c3908eb",
            "created_at": "2022-10-25T16:07:24.37846Z",
            "updated_at": "2025-03-27T02:02:10.200339Z",
            "deleted_at": null,
            "main_name": "Vicious Panda",
            "aliases": [
                "Bronze Dudley"
            ],
            "source_name": "ETDA:Vicious Panda",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "BBSRAT",
                "Byeby",
                "Cmstar",
                "Enfal",
                "Lurid",
                "Pylot",
                "RoyalRoad",
                "Travle",
                "meciv"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "6e79c98d-c678-4f28-b869-5723a78e71f4",
            "created_at": "2023-01-06T13:46:39.422441Z",
            "updated_at": "2025-03-27T02:00:03.08607Z",
            "deleted_at": null,
            "main_name": "Vicious Panda",
            "aliases": [
                "SixLittleMonkeys"
            ],
            "source_name": "MISPGALAXY:Vicious Panda",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535870,
    "ts_updated_at": 1743041141,
    "ts_creation_date": 1653689335,
    "ts_modification_date": 1653689335,
    "files": {
        "pdf": "https://archive.orkl.eu/169965abcaaba9adeff8843edb60aa1f1c46f175.pdf",
        "text": "https://archive.orkl.eu/169965abcaaba9adeff8843edb60aa1f1c46f175.txt",
        "img": "https://archive.orkl.eu/169965abcaaba9adeff8843edb60aa1f1c46f175.jpg"
    }
}