{
    "id": "6966f379-9e00-4757-9099-b78cf5a5988e",
    "created_at": "2023-01-12T15:07:05.433096Z",
    "updated_at": "2025-03-27T02:09:30.321693Z",
    "deleted_at": null,
    "sha1_hash": "4ee673992c3b86c9093437e5688cb2880420fe3a",
    "title": "2021-08-26 - NTLM Keeps Haunting Microsoft",
    "authors": "",
    "file_creation_date": "2022-05-29T10:48:33Z",
    "file_modification_date": "2022-05-29T10:48:33Z",
    "file_size": 476979,
    "plain_text": "# NTLM Keeps Haunting Microsoft\n\n**crowdstrike.com/blog/ntlm-keeps-haunting-microsoft/**\n\nYaron Zinar August 26, 2021\n\n[Two severe Windows NT LAN Manager (NTLM) vulnerabilities were recently disclosed:](https://www.crowdstrike.com/cybersecurity-101/ntlm-windows-new-technology-lan-manager/)\n[PetitPotam and](https://github.com/topotam/PetitPotam) [AD-CS relay (specifically ESC8). These vulnerabilities follow a pattern of](https://posts.specterops.io/certified-pre-owned-d95910965cd2)\nNTLM issues in recent years. These vulnerabilities are bad on their own, but their\ncombination can be devastating: If a network is not protected, the combination can allow an\nattacker with network access alone to achieve full domain admin privileges.\n\nThis blog post skips some of the deep technical details of these two vulnerabilities (there are\nplenty of great resources online) and instead provides a wider and richer context for recent\nattacks and similar issues that lurk in Active Directory (AD) environments.\n\n## Summary\n\nPetitPotam is a coerced authentication that acts as an enabler for NTLM relay. Its key\nstrength compared to Print Spooler coerced authentication is that it works unauthenticated\n(an attacker only needs network access). AD-CS relay (ESC8) is the more critical issue since\nthe AD-CS default configuration does not protect from NTLM relay. Relaying privileged\nauthentication to an AD-CS server results in full domain takeover. Microsoft partially\n\n\n-----\n\naddressed one of the issues related to PetitPotam on Aug. 10, 2021, as discussed in our\n[August 2021 Patch Tuesday blog. We have not performed an independent analysis of the](https://www.crowdstrike.com/blog/patch-tuesday-analysis-august-2021/)\n[patch, but researchers have stated it does not solve all of the authentication issues abused](https://www.kb.cert.org/vuls/id/405600)\nby PetitPotam unless additional controls are also implemented. Microsoft has not fixed the\n[AD-CS relay by default but has issued an advisory to guide customers on how to enable](https://msrc.microsoft.com/update-guide/vulnerability/ADV210003)\nprotection.\n\nFigure 1. Combined PetitPotam and ESC8 attack flow\n\n## Coerced Authentication\n\nPetitPotam is a coerced authentication vulnerability. Coerced authentication is a procedure\nwhere the attackers trigger a remote authentication to a compromised machine. When the\nattackers capture the network login on the compromised machine, they can use this\nauthentication to perform:\n\n1. Password Cracking: When the attackers coerce a user account authentication and\n\nthe attacked client supports NTLM, attackers can use the captured NTLM\nauthentication to perform password cracking. When NTLMv1 is supported (less\ncommon), attackers can use the weak cryptography to extract a password hash more\neasily. The authentication coercion techniques described below trigger computer\naccount authentication and thus are not susceptible to password-cracking attacks since\ncomputer accounts have strong randomly generated passwords that rotate on a\nmonthly basis.\n\n\n-----\n\n2. Credentials Relay: Credentials relay has two flavors:\n\n1. NTLM Relay: This is the more common attack. There is plenty of material out\n\nthere on NTLM Relay — for a deeper overview, start with the introduction to\n[server signing attacks and](https://www.crowdstrike.com/blog/retrieve-session-key-authentication/) [EPA attacks. In my experience, Microsoft has treated](https://www.crowdstrike.com/blog/bypass-epa-ntlm-attacks-wia/)\nNTLM relay attacks as actual vulnerabilities that required patching only if there\n[was no safe configuration (for example, with CVE-2021-1678). However, if a safe](https://www.crowdstrike.com/blog/cve-2021-1678-printer-spooler-relay-security-advisory/)\nconfiguration was available, Microsoft typically published an advisory while\nkeeping the insecure defaults, possibly out of concern that changing the default\nconfiguration may have resulted in breaking various applications. This means that\nin many cases, defenders can be left with insecure defaults.\n2. Kerberos Relay: In most cases, attackers cannot relay Kerberos authentications.\n\nHowever, if attackers are able to compromise an account with sufficient\ndelegation privileges, they can perform Kerberos authentications on behalf of\nother users. A recent interesting vulnerability discovered in this space is the\n[Bronze Bit attack.](https://www.netspi.com/blog/technical/network-penetration-testing/cve-2020-17049-kerberos-bronze-bit-overview/)\n\nTwo well known authentication coercion attacks are the “Printer Bug” and PetitPotam:\n\n### The “Printer Bug”\n\nAn important issue that exists in the print spooler service is the “Printer Bug,” which is an\n[authentication coercion mechanism. The issue was reported by Lee Christensen from](https://twitter.com/tifkin_)\nSpectreOps in 2018, and initially Microsoft did not fix it completely, but has removed the\ncoerced authentication in Windows Server 2019. Similar to the new PetitPotam attack, this\nattack enables the attackers to trigger authentication by a remote host’s computer account. If\nthe remote machine is privileged (e.g., a domain controller), that authentication can be\nrelayed and the computer account privileges are used.\n\n### PetitPotam (MS-EFSRPC)\n\nPetitPotam is an authentication coercion mechanism that takes advantage of MS-EFSRPC\n[(interface c681d488-d850-11d0-8c52-00c04fd90f7e) via EfsRpcOpenFileRaw function.](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ccc4fb75-1c86-41d7-bbc4-b278ec13bfb8)\nPetitPotam has two notable advantages:\n\n1. The EfsRpcOpenFileRaw function works unauthenticated. This means any attacker\n\nwith network access alone could potentially exploit this issue.\n2. PetitPotam is a more recent coerced and remains viable on all Windows versions to\n\ndate.\n\n## Missing NTLM Relay Protections\n\nThe second vulnerability is a classical NTLM relay attack. NTLM relay attacks are a very old\nattack technique. In general, Microsoft offers two main mitigations to protect from NTLM\nrelay:\n\n\n-----\n\nServer Signing (SMB Signing / LDAP Signing)\nChannel Bindings (EPA = Extended Protection for Authentication).\n\nSome of these protections are enabled by default (e.g., SMB Signing on Domain\nControllers), and some require special configuration by IT administrators (e.g., EPA for LDAP\nover TLS).\n\n### AD-CS Relay (ESC8)\n\n[Will Schroeder and](https://twitter.com/harmj0y) [Lee Christensen have published Certified Pre-Owned, a white paper](https://twitter.com/tifkin_)\ndetailing many attacks on AD certificate-based authentication. Along with the white paper,\nthey have released a defensive audit tool allowing IT administrators and security\nprofessionals to find existing issues in their network. I want to focus on one specific issue:\nESC8. ESC8 is the discovery that the AD certificate server (AD-CS) by default does not\nenforce EPA on incoming connections. This means that if attackers are able to capture a\nprivileged enough authentication request, it can be relayed to the AD-CS server and allow\nthe attackers to create a certificate for the relayed account and then authenticate as that user\naccount. Since the user is privileged (e.g., the DC account), the attacker now has full domain\nprivileges.\n\n### LDAPS Relay (CVE-2017-8563)\n\nAnother important attack surface for NTLM relay attacks is LDAP. The LDAP protocol allows\nnot only querying the directory data, but also changing directory data such as adding users,\nadding users to security groups, creating new computers and more. LDAP has two main\nsupported access method:\n\n1. LDAP over port 389: This is the regular LDAP port. LDAP is protected there by server\n\nsigning, which is not turned on by default.\n2. LDAPS – LDAP over TLS (port 636): This is the same LDAP protocol protected by\n\nTLS. Prior to 2017, LDAPS was not protected from NTLM relay at all (CVE-2017-8563).\nTo protect LDAPS, Microsoft introduced channel bindings, which are essentially EPA\nprotection for LDAPS. Unfortunately, Microsoft has not enabled this protection by\ndefault, and thus many networks are still unprotected today.\n\nAs you can see, LDAP protections are not enabled by default. We see that for more than\n**90% of CrowdStrike Identity Protection customers, these configurations are not in a**\n**secure manner. This is partially mitigated since when the client sets the signing flag in the**\n[NTLM message, LDAP/S relay is mitigated (more details in the wonderful blog by](https://en.hackndo.com/ntlm-relay/) [Pixis). This](https://twitter.com/HackAndDo)\nmakes LDAP relay a slightly less common relay target. However, if an NTLM client supports\n[SMBv1 and/or the NTLM server is vulnerable to Drop the MIC (see more in our 2019 blog),](https://www.crowdstrike.com/blog/active-directory-ntlm-attack-security-advisory/)\nLDAP/S relay can still occur.\n\n## Attack Summary\n\n\n-----\n\nThe following table summarizes attack feasibility for the described methods.\n\nFigure 2. Availability of recent NTLM relay attacks\n\n## How to Protect Your Network\n\nIn order to protect your network, we suggest following these steps:\n\n### Set Secure Configuration\n\nThe following secure configurations are required:\n\n1. Enforce **[SMB Server Signing. SMB signing is required by default on domain](https://techcommunity.microsoft.com/t5/storage-at-microsoft/configure-smb-signing-with-confidence/ba-p/2418102?wt.mc_id=modinfra-0000-abartolo)**\n\ncontrollers, which is good. However, not all other workstations and servers in the\nnetwork are protected by default. An important note is that by default relaying SMBv2>SMBv2 (a very important scenario) is possible.\n2. Enforce EPA and **[Channel Binding on all critical servers. This is extremely](https://support.microsoft.com/en-us/topic/2020-ldap-channel-binding-and-ldap-signing-requirements-for-windows-ef185fb8-00f7-167d-744c-f299a66fc00a)**\n\nimportant since in practically all cases, EPA protection is not enabled by default.\nTypically, EPA protection can be enabled or required. While setting EPA=required offers\nbetter protection, setting EPA=enabled will block most relay attacks.\n3. Disable NTLM. Even though steps 1 and 2 can almost completely mitigate NTLM relay\n\n(aside from zero days), NTLM has many issues in addition to NTLM relay, and it is\nadvisable to completely stop using NTLM. Turning off NTLM, however, is a complex IT\nproject that requires planning and time. The first and most critical step is understanding\nwhich systems in your network are still using NTLM and why. This step has proven to\nbe non-trivial for many organizations. Once you have your network mapped, you can\nstart the migration process.\n\n### Patching\n\n\n-----\n\nIn some cases, there are no secure defaults, so make sure your environment is patched\nagainst the following relay vulnerabilities:\n\n1. Drop the MIC: [CVE-2019-1040 can enable attackers to perform successful LDAP relay](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2019-1040)\n\nattacks. While this is an old vulnerability, make sure you are fully patched against the\nvulnerability.\n[2. DCE/RPC Relay: Apply patched for CVE-2021-1678 and](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1678) [CVE-2020-1113.](https://msrc.microsoft.com/update-guide/en-us/vulnerability/CVE-2020-1113)\n3. PetitPotam: As we have suggested, the patch probably does not solve the coerced\n\nauthentication issue entirely. However, it is recommended to install a patch for CVE2021-36942.\n\n### Disable Unnecessary Services\n\n1. Disable the Printer Spooler service on all critical servers.\n[2. MS-EFSRPC: Either disable the service entirely or follow the Microsoft advisory and](https://support.microsoft.com/en-us/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429)\n\nenforce EPA and AD-CS authentications.\n\n### Audit Your Environment\n\nIt is obvious that keeping track of all configurations (NTLM, AD-CS, enabled services, EPA,\nsigning requirements, patch status) is almost impossible manually. In order to make sure you\nare fully protected, an automated audit solution is required.\n\nFalcon Spotlight™ customers can quickly see if their environments are vulnerable using the\nPrintNightmare dashboard. For those who wish to trial Spotlight for free, please see the\n[CrowdStrike Store.](https://store.crowdstrike.com/en-US/apps/352/falcon-spotlight#overview)\n\n**Additional Resources**\n\n_[Learn more by reading the white paper, “The Security Risk of NTLM.”](https://www.crowdstrike.com/resources/white-papers/the-security-risks-of-ntlm/)_\n_Visit the_ _[CrowdStrike Falcon Identity Protection solutions webpage.](http://www.crowdstrike.com/products/identity-protection)_\n_[Request a demo of CrowdStrike Falcon Zero Trust or](https://www.crowdstrike.com/products/identity-protection/falcon-zero-trust/)_ _[Falcon Identity Threat Detection](https://www.crowdstrike.com/products/identity-protection/falcon-identity-threat-detection/)_\n_products._\n_[Learn more about the CrowdStrike Falcon® platform by visiting the product webpage.](https://www.crowdstrike.com/endpoint-security-products/falcon-platform/)_\n_[Test CrowdStrike next-gen AV for yourself. Start your free trial of Falcon Prevent™](https://go.crowdstrike.com/try-falcon-prevent.html)_\n_today._\n_[Learn more on how Falcon Spotlight can help you discover and manage vulnerabilities](https://www.crowdstrike.com/endpoint-security-products/falcon-spotlight-vulnerability-management/)_\n_in your environments._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-26 - NTLM Keeps Haunting Microsoft.pdf"
    ],
    "report_names": [
        "2021-08-26 - NTLM Keeps Haunting Microsoft.pdf"
    ],
    "threat_actors": [
        {
            "id": "dcba8e2b-93e0-4d6e-a15f-5c44faebc3b1",
            "created_at": "2022-10-25T16:07:23.816991Z",
            "updated_at": "2025-03-27T02:02:09.991944Z",
            "deleted_at": null,
            "main_name": "Lurk",
            "aliases": [],
            "source_name": "ETDA:Lurk",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536025,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1653821313,
    "ts_modification_date": 1653821313,
    "files": {
        "pdf": "https://archive.orkl.eu/4ee673992c3b86c9093437e5688cb2880420fe3a.pdf",
        "text": "https://archive.orkl.eu/4ee673992c3b86c9093437e5688cb2880420fe3a.txt",
        "img": "https://archive.orkl.eu/4ee673992c3b86c9093437e5688cb2880420fe3a.jpg"
    }
}