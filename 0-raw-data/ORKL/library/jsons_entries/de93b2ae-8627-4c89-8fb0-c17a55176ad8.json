{
    "id": "de93b2ae-8627-4c89-8fb0-c17a55176ad8",
    "created_at": "2022-10-25T16:48:21.679187Z",
    "updated_at": "2025-03-27T02:15:46.25191Z",
    "deleted_at": null,
    "sha1_hash": "01a8aab8c3dae6852f09ec151cf7afb6d1cfcc77",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-10-13T02:04:33Z",
    "file_modification_date": "2021-10-13T02:04:33Z",
    "file_size": 329509,
    "plain_text": "# MysterySnail attacks with Windows zero-day\n\n**[securelist.com/mysterysnail-attacks-with-windows-zero-day/104509](https://securelist.com/mysterysnail-attacks-with-windows-zero-day/104509/)**\n\n## Executive Summary\n\nIn late August and early September 2021, Kaspersky technologies detected attacks with\nthe use of an elevation of privilege exploit on multiple Microsoft Windows servers. The\nexploit had numerous debug strings from an older, publicly known exploit for\n[vulnerability CVE-2016-3309, but closer analysis revealed that it was a zero-day. We](https://github.com/siberas/CVE-2016-3309_Reloaded/)\ndiscovered that it was using a previously unknown vulnerability in the Win32k driver and\nexploitation relies heavily on a technique to leak the base addresses of kernel modules.\nWe promptly reported these findings to Microsoft. The information disclosure portion of\nthe exploit chain was identified as not bypassing a security boundary, and was therefore\n[not fixed. Microsoft assigned CVE-2021-40449 to the use-after-free vulnerability in the](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-40449)\nWin32k kernel driver and it was patched on October 12, 2021, as a part of the October\nPatch Tuesday.\n\nBesides finding the zero-day in the wild, we analyzed the malware payload used along\nwith the zero-day exploit, and found that variants of the malware were detected in\nwidespread espionage campaigns against IT companies, military/defense contractors,\nand diplomatic entities.\n\nWe are calling this cluster of activity MysterySnail. Code similarity and re-use of C2\ninfrastructure we discovered allowed us to connect these attacks with the actor known as\nIronHusky and Chinese-speaking APT activity dating back to 2012.\n\n## Elevation of privilege exploit\n\nThe discovered exploit is written to support the following Windows products:\n\n\n-----\n\nMicrosoft Windows Vista\nMicrosoft Windows 7\nMicrosoft Windows 8\nMicrosoft Windows 8.1\nMicrosoft Windows Server 2008\nMicrosoft Windows Server 2008 R2\nMicrosoft Windows Server 2012\nMicrosoft Windows Server 2012 R2\nMicrosoft Windows 10 (build 14393)\nMicrosoft Windows Server 2016 (build 14393)\nMicrosoft Windows 10 (build 17763)\nMicrosoft Windows Server 2019 (build 17763)\n\nThe list of supported products and supported Windows 10 build numbers, explicit\ndeclaration of server OSs and the fact that exploits were only discovered in attacks on\nservers, all lead us to believe the exploit was developed and advertised as a solution to\nelevate privileges on servers.\n\nCVE-2021-40449 is a use-after-free vulnerability in Win32k’s NtGdiResetDC function. As\nwith many other Win32k vulnerabilities, the root cause of this vulnerability lies in the\nability to set user-mode callbacks and execute unexpected API functions during execution\nof those callbacks. The CVE-2021-40449 is triggered when the function ResetDC is\nexecuted a second time for the same handle during execution of its own callback. The\nexploitation process for this vulnerability is as follows:\n\n1. A user-mode call to ResetDC executes syscall NtGdiResetDC and its inner function\n\nGreResetDCInternal. This function gets a pointer to a PDC object, and then\nperforms a call to function hdcOpenDCW.\n2. Function hdcOpenDCW performs a user-mode callback and it can be used to\n\nexecute ResetDC for the same handle a second time.\n3. If an exploit executes ResetDC during a callback, NtGdiResetDC and\n\nGreResetDCInternal are executed again for the same DC.\n4. If an exploit ignores all the callbacks during the second call to GreResetDCInternal,\n\nthis function will be executed as intended. It will create a new DC and get rid of the\nold one (the PDC object is destroyed).\n5. In the callback, after the second ResetDC call has completed, the exploit can reclaim\n\nthe freed memory of the PDC object and finish the execution of the callback.\n6. After execution of the callback, function hdcOpenDCW returns to\n\nGreResetDCInternal, but the pointer retrieved in step (1) is now a dangling pointer\n– it points to the memory of the previously destroyed PDC object.\n7. In the late stage of GreResetDCInternal execution, a malformed PDC object can be\n\nused to perform a call to an arbitrary kernel function with controlled parameters.\n\nIn the discovered exploit attackers are able to achieve the desired state of memory with\nthe use of GDI palette objects and use a single call to a kernel function to build a primitive\nfor reading and writing kernel memory This step is easily accomplished because the\n\n\n-----\n\nexploit process is running with Medium IL and therefore it’s possible to use publicly\nknown techniques to leak kernel addresses of currently loaded drivers/kernel modules. In\nour opinion, it would be preferable if the Medium IL processes had limited access to such\n[functions as NtQuerySystemInformation or EnumDeviceDrivers.](https://securelist.com/the-zero-day-exploits-of-operation-wizardopium/97086/)\n\n## MysterySnail RAT\n\nOur deep dive into the MysterySnail RAT family started with an analysis of a previously\nunknown remote shell-type Trojan that was intended to be executed by an elevation of\n[privilege exploit. The sample which we analyzed was also uploaded to VT on August 10,](https://www.virustotal.com/gui/file/b7fb3623e31fb36fc3d3a4d99829e42910cad4da4fa7429a2d99a838e004366e)\n2021. The sample is very big – 8.29MB. One of the reasons for the file size is that it’s\nstatically compiled with the OpenSSL library and contains unused code and data\nbelonging to that library. But the main reason for its size is the presence of two very large\nfunctions that do nothing but waste processor clock cycles. These functions also “use”\nrandomly generated strings that are also present in a binary.\n\n**_Random strings used by anti-analysis functions_**\n\nWe assume these two functions are used as an AV-evasion technique for the purpose of\nanti-emulation. This theory is supported by the presence of other redundant logics and\nthe presence of a relatively large number of exported functions while the real work is\nperformed by only one of them.\n\n\n-----\n\n**_Names of exported functions; the actual business logic is executed from_**\n**_function “GetInfo”_**\n\nThe sample has two hardcoded URLs present in plain text – “www[.]disktest[.]com” and\n“www[.]runblerx[.]com”. They are put into class variables for intended use, but remain\nunused; the real C2 address is decoded by a single byte xor – “http[.]ddspadus[.]com”.\n\nThe malware enumerates the values under the\n“Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ProxyServer” registry\nkey and uses them to request tunneling through a proxy server in case it fails to connect\nto the C2 directly.\n\nThe malware itself is not very sophisticated and has functionality similar to many other\nremote shells. But it still somehow stands out, with a relatively large number of\nimplemented commands and extra capabilities like monitoring for inserted disk drives\nand the ability to act as a proxy.\n\nInbound and outbound commands have the same binary-based format that is provided\nbelow. All communication is encrypted with SSL.\n\n**Offset** **Description**\n\n0 Size of additional data\n\n4 Session ID\n\n8 Command ID\n\n0xC Additional data\n\n**_Format of communication commands_**\n\nBefore receiving any commands, the malware gathers and sends general information\nabout the victim machine. This information includes:\n\n\n-----\n\nComputer name\nCurrent OEM code-page/default identifier\nWindows product name\nLocal IP address\nLogged-in user name\nCampaign name\n\nOne interesting fact is that “Campaign name” by default is set to “windows”. This name\ngets overwritten, but it might indicate there are versions of the same RAT compiled for\nother platforms.\n\nIn total, the RAT implements 20 commands. Their description and command IDs are\nprovided in the table below.\n\n\n**Command**\n**ID**\n\n\n**Description**\n\n\n1F4h Launch interactive cmd.exe shell. Before launch cmd.exe is copied to the\ntemp folder with a different name\n\n1F5h Spawn new process\n\n1F6h Spawn new process (console)\n\n1F7h Get existing disk drives and their type. This function also works in the\nbackground, checking for new drives\n\n1F8h Create (upload) new file. If a file exists, append data to it\n\n1FAh Get directory list\n\n1FBh Kill arbitrary process\n\n1FFh Delete file\n\n202h Read file. If the file is too big, async read operation can be stopped with\ncmd 20Ch.\n\n205h Re-connect\n\n208h Set sleep time (in ms)\n\n209h Shutdown network and exit\n\n20Ah Exit\n\n20Bh Kill interactive shell (created with cmd 1F4h)\n\n20Ch Terminate file reading operation (started with cmd 202h)\n\n217h No operation\n\n\n-----\n\n21Bh Open proxy’ed connection to provided host. Up to 50 simultaneous\nconnections are supported.\n\n21Ch Send data to proxy’ed connection\n\n21Eh Close all proxy connections\n\n21Fh Close requested proxy connection\n\n**_List of commands supported by the RAT_**\n\nThe analysis of the MysterySnail RAT helped us discover campaigns using other variants\nof the analyzed malware as well as study and document the code changes made to this\ntool over a six-month period. We provide more info about these variants and campaigns\nin our private report.\n\nWith the help of Kaspersky Threat Attribution Engine (KTAE) and the discovery of early\nvariants of MysterySnail RAT we were able to find direct code and functionality overlap\nwith the malware attributed to the IronHusky actor. We were also able to discover the reuse of C2 addresses used in attacks by the Chinese-speaking APT as far back as 2012. This\ndiscovery links IronHusky to some of the older known activities.\n\nKaspersky products detect the CVE-2021-40449 exploit and related malware with the\nverdicts:\n\nPDM:Exploit.Win32.Generic\nPDM:Trojan.Win32.Generic\nTrojan.Win64.Agent*\n\nKaspersky products detected these attacks with the help of the Behavioral Detection\nEngine and the Exploit Prevention component. CVE-2021-40449 is the latest addition to\nthe long list of zero-days discovered in the wild with the help of our technologies. We will\ncontinue to improve defenses for our users by enhancing technologies and working with\nthird-party vendors to patch vulnerabilities, making the internet more secure for\neveryone.\n\nMore information about these attacks and the actor behind them is available to customers\n[of the Kaspersky Intelligence Reporting service. Contact: intelreports@kaspersky.com.](mailto:intelreports@kaspersky.com)\n\n_Kaspersky would like to thank Microsoft for their prompt analysis of the report and_\n_patches._\n\n## IoCs\n\nwww[.]disktest[.]com\n\nwww[.]runblerx[.]com\n\nhttp[.]ddspadus[.]com\n\n\n-----\n\n[MD5 e2f2d2832da0facbd716d6ad298073ca](https://opentip.kaspersky.com/e2f2d2832da0facbd716d6ad298073ca/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n[SHA1 ecdec44d3ce31532d9831b139ea04bf48cde9090](https://opentip.kaspersky.com/ecdec44d3ce31532d9831b139ea04bf48cde9090/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n[SHA256 b7fb3623e31fb36fc3d3a4d99829e42910cad4da4fa7429a2d99a838e004366e](https://opentip.kaspersky.com/b7fb3623e31fb36fc3d3a4d99829e42910cad4da4fa7429a2d99a838e004366e/?utm_source=SL&utm_medium=SL&utm_campaign=SL)\n\nMysterySnail attacks with Windows zero-day\n\nYour email address will not be published. Required fields are marked *\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2021/2021.10.12.MysterySnail/MysterySnail%20attacks%20with%20Windows%20zero-day%20_%20Securelist.pdf"
    ],
    "report_names": [
        "MysterySnail attacks with Windows zero-day _ Securelist"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "2008a79d-2f3a-475f-abef-3bc119a1bf38",
            "created_at": "2022-10-25T16:07:24.028651Z",
            "updated_at": "2025-03-27T02:02:10.084983Z",
            "deleted_at": null,
            "main_name": "Operation WizardOpium",
            "aliases": [],
            "source_name": "ETDA:Operation WizardOpium",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "5cd3fcb0-eb56-49ac-8125-47ebee93311d",
            "created_at": "2023-01-06T13:46:39.065814Z",
            "updated_at": "2025-03-27T02:00:02.988828Z",
            "deleted_at": null,
            "main_name": "Operation WizardOpium",
            "aliases": [],
            "source_name": "MISPGALAXY:Operation WizardOpium",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d06cd44b-3efe-47dc-bb7c-a7b091c02938",
            "created_at": "2023-11-08T02:00:07.135638Z",
            "updated_at": "2025-03-27T02:00:03.193635Z",
            "deleted_at": null,
            "main_name": "IronHusky",
            "aliases": [],
            "source_name": "MISPGALAXY:IronHusky",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2caf4672-1812-4bb9-9576-6011e56102d2",
            "created_at": "2022-10-25T16:07:23.742765Z",
            "updated_at": "2025-03-27T02:02:09.957037Z",
            "deleted_at": null,
            "main_name": "IronHusky",
            "aliases": [
                "BBCY-TA1",
                "Operation MysterySnail"
            ],
            "source_name": "ETDA:IronHusky",
            "tools": [
                "Agent.dhwf",
                "Chymine",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Gen:Trojan.Heur.PT",
                "Kaba",
                "Korplug",
                "MysterySnail",
                "MysterySnail RAT",
                "PlugX",
                "Poison Ivy",
                "RedDelta",
                "SPIVY",
                "Sogu",
                "TIGERPLUG",
                "TVT",
                "Thoper",
                "Xamtrav",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716501,
    "ts_updated_at": 1743041746,
    "ts_creation_date": 1634090673,
    "ts_modification_date": 1634090673,
    "files": {
        "pdf": "https://archive.orkl.eu/01a8aab8c3dae6852f09ec151cf7afb6d1cfcc77.pdf",
        "text": "https://archive.orkl.eu/01a8aab8c3dae6852f09ec151cf7afb6d1cfcc77.txt",
        "img": "https://archive.orkl.eu/01a8aab8c3dae6852f09ec151cf7afb6d1cfcc77.jpg"
    }
}