{
    "id": "a03bb94b-a4d4-4cd5-88b0-addf4567a581",
    "created_at": "2023-01-12T15:00:12.032421Z",
    "updated_at": "2025-03-27T02:06:01.626303Z",
    "deleted_at": null,
    "sha1_hash": "3a636fe1f79fbccc82ff5d586ad9a077f598cc8f",
    "title": "2022-06-24 - There Is More Than One Way to Sleep- Dive Deep Into the Implementations of API Hammering by Various Malware Families",
    "authors": "",
    "file_creation_date": "2022-07-02T23:16:29Z",
    "file_modification_date": "2022-07-02T23:16:29Z",
    "file_size": 1088908,
    "plain_text": "# There Is More Than One Way to Sleep: Dive Deep Into the Implementations of API Hammering by Various Malware Families\n\n**[unit42.paloaltonetworks.com/api-hammering-malware-families/](https://unit42.paloaltonetworks.com/api-hammering-malware-families/)**\n\nMark Lim, Riley Porter June 24, 2022\n\npeople reacted\n6\n5 min. read\n\nBy [Mark Lim and](https://unit42.paloaltonetworks.com/author/mark-lim/) [Riley Porter](https://unit42.paloaltonetworks.com/author/riley-porter/)\n\nJune 24, 2022 at 6:00 AM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Threat Prevention](https://unit42.paloaltonetworks.com/category/threat-prevention-2/)\n\nTags: [API Hammering,](https://unit42.paloaltonetworks.com/tag/api-hammering/) [BazarLoader,](https://unit42.paloaltonetworks.com/tag/bazarloader/) [Cortex XDR,](https://unit42.paloaltonetworks.com/tag/cortex-xdr/) [malware,](https://unit42.paloaltonetworks.com/tag/malware/) [Sandbox evasion,](https://unit42.paloaltonetworks.com/tag/sandbox-evasion/) threat\nprevention, [WildFire,](https://unit42.paloaltonetworks.com/tag/wildfire/) [Zloader](https://unit42.paloaltonetworks.com/tag/zloader/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/api-hammering-malware-families/)\n\n## Executive Summary\n\n\n-----\n\nUnit 42 has discovered Zloader and BazarLoader samples that had interesting\nimplementations of a sandbox evasion technique. This blog post will go into details of the\nunique implementations of API Hammering in these types of malware. API Hammering\ninvolves the use of a massive number of calls to Windows APIs as a form of extended sleep\nto evade detection in sandbox environments.\n\nSandboxing is a popular technique used to detect if a sample is malicious. A sandbox\nanalyzes the behaviors of the binary as it executes inside a controlled environment.\nSandboxes have to deal with many challenges while analyzing a large number of binaries\nwith limited computing resources. Malware sometimes abuses these challenges by\n“sleeping” in the sandbox before carrying out malicious procedures to hide its real intentions.\n\nPalo Alto Networks customers receive protections from malware families using evasion\n[techniques through Cortex XDR or the Next-Generation Firewall with WildFire and](https://www.paloaltonetworks.com/cortex/cortex-xdr) Threat\nPrevention security subscriptions.\n\nRelated Unit 42 Topics [Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [evasion](https://unit42.paloaltonetworks.com/tag/evasion/)\n\n## Table of Contents\n\nCommon Ways for Malware to Sleep\n\nWhat Is API Hammering?\n\nAPI Hammering in BazarLoader\n\nAPI Hammering in Zloader\n\nConclusion: WildFire vs API Hammering\n\nIndicators of Compromise\n\n## Common Ways for Malware to Sleep\n\nThe most common way for malware to sleep is to simply call the Windows API function\nSleep. A sneakier way that we often see is the Ping Sleep technique where the malware\nconstantly sends ICMP network packets to an IP address (ping) in a loop. To send and\nreceive such useless ping messages takes a certain amount of time, thus the malware\nindirectly sleeps. However, all these methods are easily detected by many sandboxes.\n\n## What Is API Hammering?\n\n[API Hammering has been a known sandbox bypass technique that is sometimes used by](https://www.joesecurity.org/blog/498839998833561473)\n[malware authors to evade sandboxes. We’ve recently observed Zloader – a dropper for](https://malpedia.caad.fkie.fraunhofer.de/details/win.zloader)\n[multiple types of malware – and the backdoor BazarLoader using new and unique](https://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor)\nimplementations of API Hammering to remain stealthy.\n\n\n-----\n\nAPI Hammering consists of a large number of garbage Windows API function calls. The\nexecution time of these calls delays the execution of the real malicious routines of the\nmalware. This allows the malware to indirectly sleep during the sandbox analysis process.\n\n## API Hammering in BazarLoader\n\nAn [older variant of BazarLoader made use of a fixed number (1550) of printf function calls to](https://www.cybereason.com/blog/a-bazar-of-tricks-following-team9s-development-cycles)\ntime out malware analysis. While analyzing a newer version of BazarLoader, we found a new\nand more complex implementation of API Hammering.\n\nThe following decompiled procedure shows how this new variant is implemented in the\nBazarLoader sample we analyzed. It makes use of a huge loop with a random count that\nrepeatedly accesses a list of random registry keys in Windows.\n\nFigure 1. API Hammering loop in BazarLoader.\nTo generate the random loop count and list of registry keys, the sample reads the first file\nfrom the System32 directory that matches a defined size. This file is then encoded (see\nFigure 2) to remove most of its null bytes. The random count is then computed based on the\noffset of the first null byte in that file. The list of random registry keys are generated from\nfixed length chunks from the encoded file.\n\n\n-----\n\nFigure 2. Encoding the selected file in BazarLoader.\nWith a different Windows version (Windows 7, 8, etc.) and a different set of applied updates,\nthere is also a different set of files in the System32 directory. This results in a varying loop\ncount and list registry keys used by BazarLoader when executed in different machines.\n\nThe API Hammering function is located in the packer of the BazarLoader sample (see Figure\n3). It delays the payload unpacking process to evade detection of the aforementioned.\nWithout completing the unpacking process, the BazarLoader sample would appear to be just\naccessing random registry keys, a behavior that can be also seen in many legitimate types of\nsoftware.\n\n\n-----\n\nFigure 3. API Hammering delaying unpacking process in BazarLoader.\n\n## API Hammering in Zloader\n\nWhile the BazarLoader sample relied on a loop to carry out API Hammering, Zloader uses a\ndifferent approach. It does not require a huge loop, but instead consists of 4 large functions\nwhich contain nested calls to multiple other smaller functions (see Figure 4).\n\n\n-----\n\nFigure 4. One of the large functions responsible for API Hammering in ZLoader.\nInside each of these small procedures are four API function calls related to file I/O. The\nfunctions are GetFileAttributesW, ReadFile, CreateFileW and WriteFile (see Figure 5).\n\n\n-----\n\nFigure 5. One of the small functions responsible for API Hammering in ZLoader.\nBy using a debugger, we could figure out the number of calls made to four file I/O functions\n(see Figure 6). The large and smaller functions together generate more than a million\nfunction calls in total, without the use of a single large loop as seen in BazarLoader.\n\n\n-----\n\nFigure 6. Debugger log for APIs responsible for API\n\nHammering in ZLoader.\nThe following table shows the API function call counts made during our analysis process:\n\n**I/O API function** **Total Call Count**\n\nReadFile 278,850\n\nWriteFile 280,921\n\nGetFileAttributesW 113,389\n\nCreateFileW 559,771\n\n_Table 1. API function call counts._\n\nThe execution time of the four large functions delays the injection of the Zloader payload.\nWithout complete execution of these functions, the sample would appear to be a benign\nsample just carrying out file I/O operations.\n\nThe following disassembled code shows the four API hammering procedures followed by the\ninjection procedures:\n\n\n-----\n\nFigure 6. API Hammering before payload injection in ZLoader.\n\n## Conclusion: WildFire vs API Hammering\n\n\n-----\n\nResults from analyzing various implementations of API Hammering enabled the detection of\n[malware samples using API Hammering for sandbox evasion in WildFire. WildFire detects](https://www.paloaltonetworks.com/products/secure-the-network/wildfire)\nthe use of API Hammering by BazarLoader, Zloader, and other malware families.\n\nThe following excerpt from the WildFire report of our BazarLoader sample shows the\ndetected entry for API Hammering.\n\nFigure 7. WildFire detected\n\nAPI Hammering along with other behaviors in a Bazarloader sample.\n\nPalo Alto Networks customers receive further protections against other malware families\nusing similar sandbox evasion techniques through Cortex XDR or our Next-Generation\nFirewall with WildFire and Threat Prevention security subscriptions.\n\n## Indicators of Compromise\n\nBazarLoader Sample\n\nce5ee2fd8aa4acda24baf6221b5de66220172da0eb312705936adc5b164cc052\n\nZloader Sample\n\n44ede6e1b9be1c013f13d82645f7a9cff7d92b267778f19b46aa5c1f7fa3c10b\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n\n-----\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-06-24 - There Is More Than One Way to Sleep- Dive Deep Into the Implementations of API Hammering by Various Malware Families.pdf"
    ],
    "report_names": [
        "2022-06-24 - There Is More Than One Way to Sleep- Dive Deep Into the Implementations of API Hammering by Various Malware Families.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535612,
    "ts_updated_at": 1743041161,
    "ts_creation_date": 1656803789,
    "ts_modification_date": 1656803789,
    "files": {
        "pdf": "https://archive.orkl.eu/3a636fe1f79fbccc82ff5d586ad9a077f598cc8f.pdf",
        "text": "https://archive.orkl.eu/3a636fe1f79fbccc82ff5d586ad9a077f598cc8f.txt",
        "img": "https://archive.orkl.eu/3a636fe1f79fbccc82ff5d586ad9a077f598cc8f.jpg"
    }
}