{
    "id": "96e06e6d-5942-4bfd-991a-226660e13227",
    "created_at": "2023-01-12T15:05:34.354863Z",
    "updated_at": "2025-03-27T02:06:02.026186Z",
    "deleted_at": null,
    "sha1_hash": "4e61599d58f93c5d2731521d07a96d756ca123f7",
    "title": "2022-03-21 - Lorenz ransomware rebound- corruption and irrecoverable files",
    "authors": "",
    "file_creation_date": "2022-05-28T18:22:42Z",
    "file_modification_date": "2022-05-28T18:22:42Z",
    "file_size": 1764093,
    "plain_text": "# Lorenz ransomware rebound: corruption and irrecoverable files\n\n**[tesorion.nl/en/posts/lorenz-ransomware-rebound-corruption-and-irrecoverable-files/](https://www.tesorion.nl/en/posts/lorenz-ransomware-rebound-corruption-and-irrecoverable-files/)**\n\nBy Gijs Rijnders March 21, 2022\n\nIn July 2021, we came across the Lorenz ransomware. Lorenz is a ransomware strain that\ntargets organizations, demanding hundreds of thousands of dollars in ransom. In our\nanalysis in 2021 we found that the ransomware contained bugs and that it was possible to\n[build a decryptor. As a result, we published a free decryptor for Lorenz via the](https://www.tesorion.nl/en/posts/lorenz-ransomware-analysis-and-a-free-decryptor/)\n[NoMoreRansom initiative.](https://www.nomoreransom.org/en/index.html)\n\nIn early March 2022 we came across a new variant of the Lorenz ransomware. The sample\nwe analyzed dates back to March 2, 2022. Files encrypted by this variant are different from\nthe previous one. This blog contains our findings on the new variant. Furthermore, we\nexplain a serious bug in the ransomware that makes the attacker unable to recover any\nencrypted files. Finally, we announce that decryption is still possible without paying the\nransom, or to be more specific, only possible without paying the ransom.\n\n## Overview\n\n\n-----\n\nThere are quite a few differences between this Lorenz variant and what we have seen\nbefore. For instance, the ransom note used to be a HTML document called\n‘HELP_SECURITY_EVENT.html’. The ransom note of the new variant is a plain text\ndocument called ‘HELP.TXT’.\n\nLike the previous one, this Lorenz variant also contacts a command & control server. The\ncontact is initialized via HTTP on port 80 by sending a small POST request containing the\ninfected system’s computer name, internal IP-address and Windows OS version (e.g., 6.1\nfor Windows 7). This command & control communication might be used to provide basic\nusage statistics for the attackers.\n\nAnother difference is string encryption. In the first variant of Lorenz we analyzed, strings\nwere embedded in the binary in plain text. This time, they are encrypted using a simple\nalgorithm: they are XOR-encrypted using the single-byte key 0x6B and then Base64encoded.\n\nUnfortunately, this Lorenz variant contains a couple of serious bugs and mistakes. Unlike its\npredecessor, this variant does not create and check a mutex on startup. Furthermore, the\nencryption key needed to decrypt an affected file is not written, and therefore, decryption is\nvirtually impossible.\n\n## Possible double encryption\n\nIt is common for ransomware to create a mutex on startup and terminate if the mutex\nalready exists. This is a very important step, as it prohibits multiple instances from the\nransomware to run simultaneously. The first variant of Lorenz we analyzed correctly\ncreated and checked a mutex called ‘wolf’. The process would automatically terminate if\nthat mutex already exists, as shown in the screenshot below.\n\nThe recent variant of Lorenz we analyzed does not create or check a mutex. Therefore,\nmultiple instances can be run simultaneously, allowing different instances to corrupt each\nother’s encrypted files to a point where decryption would later be very difficult or even\nimpossible.\n\n\n-----\n\n## File encryption\n\nThe core of the file encryption scheme has remained the same. Files are encrypted using a\ncombination of RSA and AES encryption in CBC mode. A password is generated at random\n[and used to derive the actual encryption key using the CryptDeriveKey function.](https://docs.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptderivekey)\n\nHowever, the way files are encrypted has changed. The previous variant encrypted every\nfile whole, in blocks of 48 bytes. The encrypted file marker ‘.sz40’ and RSA-encrypted\npassword are then placed at the head of the file. The recent variant divides files into two\ncategories: files smaller than 64368875 bytes (~ 61MiB), and files above this size. Small\nfiles are encrypted whole, but in blocks of 160 bytes. Large files are handled differently.\nOnly the first 4000000000 bytes (~3.7GB) of these files are encrypted. Small files are\nencrypted side-by-side, because the encrypted file marker and encryption key are placed in\nthe head of the file. That means, the encrypted file is created, and the original file is deleted\nafter encryption. Large files are encrypted in-place, which means that every block is read,\nencrypted, and written back to the file. After encryption, the file is renamed to its encrypted\ncounterpart.\n\nAs discussed above, files used to be encrypted in blocks of 48 bytes in the previous variant.\nThe algorithm for encrypting small files in the new variant does this in blocks of 160 bytes.\nThe authors might have altered the original encryption algorithm to now encrypt small files\nonly and created a new algorithm to encrypt the large files. As shown in the screenshot\nbelow, the authors forgot to alter one instance of 48 to 160. In practice, ‘is_final_block’ will\nalways be TRUE once the end of the file has been reached, unless the remainder is 48\nbytes. If the remaining number of bytes (the final block smaller than or equal to 160) is not a\nmultiple of 8, the last bytes of the encrypted file may contain invalid data.\n\n## A serious mistake\n\nFor any ransomware to be successful, the ability to correctly recover the files that it\nencrypted is essential. If the attackers are unable to do so, they lose much of their leverage\nagainst the victim. The Lorenz authors made a serious mistake in the recent variant,\nrendering encrypted files un-decryptable.\n\n\n-----\n\nTo recover an encrypted file, we need the key that was used to encrypt it. Recall that\nLorenz randomly generates a password to derive the actual AES encryption key. This\nencryption key is then encrypted using RSA with the public key embedded in the\nransomware by the attackers, which is common practice. Additionally, this RSA-encrypted\nkey is written to the head or tail of the encrypted file. After all, we need it in order to recover\nthe original file contents later.\n\nThis is where the most serious mistake was made. The password is 40 characters long, but\nany RSA-1024 encrypted data requires 128 bytes (1024 / 8 bits) of memory space. The\nransomware did not create a buffer large enough to fit these 128 bytes. As shown in the\nscreenshot below, the encrypted file marker and RSA-encrypted key are supposed to be\n[written to the encrypted file using the WriteFile function. Since WriteFile would read outside](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile)\nof the 40-byte buffer ‘encrypted_file_key’, it fails and returns the\n‘ERROR_INVALID_USER_BUFFER’ error. The returned error is not checked, and the file\ncontinues to be encrypted.\n\nThe above screenshot was taken from the small-file encryption algorithm, but the large file\nalgorithm suffers from the exact same issue. The result of this mistake is that encrypted\nfiles only contain the marker and encrypted contents. Without the key, recovering the file is\nvirtually impossible.\n\n## Conclusion\n\nFor the previous Lorenz variant we analyzed, we concluded that decryption was possible\nwithout paying the ransom. Furthermore, we shed light on a bug that would destroy the last\n48 bytes of some files. However, this new variant of Lorenz contains more serious issues,\nsuch as the destruction of files. Even though the 48-byte bug is fixed, we can safely\nconclude that this new variant is destructive.\n\nThankfully, decryption is still possible without paying the ransom. Have you have been hit\nby Lorenz? Don’t pay the ransom, as in some cases it will not get your files back. Contact\nus to discuss how we may be able to help you recover your data without paying the\nransom!\n\n\n-----\n\n## Indicators of Compromise\n\n**Indicator** **Description**\n\n427713275e7c4515e3c577684a7c5f96e45771fee54f1c3162a2d6a2cc4cd76e SHA-256 of\nnew Lorenz\nvariant\nsample\n\n172[.]86[.]75[.]81 Command &\ncontrol\nserver\n\n[© 2022 Tesorion Cybersecurity Solutions. All Rights Reserved. | RSS NL |](https://www.tesorion.nl/nl/feed/) [RSS EN](https://www.tesorion.nl/en/feed/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-21 - Lorenz ransomware rebound- corruption and irrecoverable files.pdf"
    ],
    "report_names": [
        "2022-03-21 - Lorenz ransomware rebound- corruption and irrecoverable files.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535934,
    "ts_updated_at": 1743041162,
    "ts_creation_date": 1653762162,
    "ts_modification_date": 1653762162,
    "files": {
        "pdf": "https://archive.orkl.eu/4e61599d58f93c5d2731521d07a96d756ca123f7.pdf",
        "text": "https://archive.orkl.eu/4e61599d58f93c5d2731521d07a96d756ca123f7.txt",
        "img": "https://archive.orkl.eu/4e61599d58f93c5d2731521d07a96d756ca123f7.jpg"
    }
}