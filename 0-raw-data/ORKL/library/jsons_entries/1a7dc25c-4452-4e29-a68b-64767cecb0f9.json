{
    "id": "1a7dc25c-4452-4e29-a68b-64767cecb0f9",
    "created_at": "2023-01-12T15:10:33.194838Z",
    "updated_at": "2025-03-27T02:15:13.905311Z",
    "deleted_at": null,
    "sha1_hash": "959cfa8ae918c58d7989794d606ad3482d4d54c3",
    "title": "2022-02-25 - Trickbot Group’s AnchorDNS Backdoor Upgrades to AnchorMail",
    "authors": "",
    "file_creation_date": "2022-05-28T02:26:01Z",
    "file_modification_date": "2022-05-28T02:26:01Z",
    "file_size": 1287304,
    "plain_text": "# Trickbot Group's AnchorDNS Backdoor Upgrades to AnchorMail\n\n**[securityintelligence.com/posts/new-malware-trickbot-anchordns-backdoor-upgrades-anchormail/](https://securityintelligence.com/posts/new-malware-trickbot-anchordns-backdoor-upgrades-anchormail/)**\n\n[Malware February 25, 2022](https://securityintelligence.com/category/x-force/malware-threat/)\nBy [Charlotte Hammond co-authored by Ole Villadsen 6 min read](https://securityintelligence.com/author/charlotte-hammond/)\nIBM Security X-Force researchers have discovered a revamped version of the Trickbot Group’s AnchorDNS backdoor being used in recent\nattacks ending with the deployment of Conti ransomware. The Trickbot Group, which X-Force tracks as [ITG23, is a cybercriminal gang known](https://securityintelligence.com/posts/trickbot-gang-doubles-down-enterprise-infection/)\nprimarily for developing the Trickbot banking Trojan, which was first identified in 2016 and initially used to facilitate online banking fraud. The\ngroup has adapted in recent years to the ransomware economy by using its Trickbot and Bazarloader payloads to gain a foothold for\nransomware attacks and through its close relationship with the Conti ransomware-as-a-service (RaaS).\n\n\n-----\n\nG 3 s a so o o de e op g t e c o a [a e](https://securityintelligence.com/posts/itg08-aka-fin6-partners-with-trickbot-gang-uses-anchor-framework/) a e o, c ud g t e c o S a a t, 0 8 o use du g attac s o g\nprofile targets following initial infection by Trickbot or Bazarbackdoor, an additional backdoor developed by ITG23. AnchorDNS is notable for\ncommunicating with its Command and Control (C2) server using the DNS protocol. The upgraded backdoor, identified by IBM Security X-Force\nresearchers as AnchorMail or Delegatz, now uses an email-based C2 server which it communicates with using SMTP and IMAP protocols over\nTLS. With the exception of the overhauled C2 communication mechanism, AnchorMail’s behavior aligns very closely to that of its AnchorDNS\npredecessor.\n\nThe discovery of this new Anchor variant adds a new stealthy backdoor for use during ransomware attacks and highlights the group’s\ncommitment to upgrading its malware.\n\nUpon execution, AnchorMail creates a scheduled task for persistence which is set to run every 10 minutes. It then collects basic system\ninformation, registers with its C2 and enters a loop of checking for and executing received commands. The backdoor’s command structure is\nalso very similar to that of AnchorDNS and both versions appear to accept the same set of command codes, which provide a variety of\ndifferent options for executing commands and payloads received from the C2.\n\nThe most notable feature of AnchorMail is its novel C2 communication mechanism. The C2 server appears to utilize mail server code, and the\nbackdoor communicates with it through the sending and receiving of specially crafted email messages. AnchorMail uses the encrypted SMTPS\nprotocol for sending data to the C2, and IMAPS is used for receiving it. In the analyzed sample the C2 server address was configured as\n15906-28547.bacloud[.]info (213.252.247[.]230), with port 465 used for SMTPS communications, and 993 used for IMAPS.\n\nAnchorMail is written in C++ and has so far only been observed targeting Windows systems. However, as AnchorDNS has been ported to\nLinux, it seems likely that a Linux-variant of AnchorMail may emerge too.\n\n## Persistence\n\nAnchorMail starts by enumerating the scheduled tasks on the system and searching for one which executes itself. If it does not find one then it\nproceeds to create a new scheduled task for persistence.\n\nIt enumerates folders within the task scheduler library and creates a task within a randomly selected folder, using the folder name as a prefix\nfor the task description followed by one of the following strings: ‘Task’, ‘Updater’, ‘Backup’, ‘Service’, ‘Maintenance’. For example, it may select\nthe Bluetooth folder and create its task within that folder with description ‘BluetoothTask’. The task is configured to run every day, at 10-minute\nintervals, and the execution path is set as <malware_commandline_path>,dllmain. Once the scheduled task is created, the malware then\nexits.\n\nOtherwise, if the malware finds the scheduled task has already been created, then it continues with its main functionality.\n\n## Registration\n\nOnce persistence has been achieved, AnchorMail proceeds to collect basic system information and register with its C2 server. The registration\nprocess is almost identical to that of AnchorDNS.\nAnchorMail first generates a system id with the following format:\n```\n<hostname>_W<windows_version>.<random_guid>\n\n```\n\nFor example:\n```\nDESKTOP-4LUGU5I_W10019041.D9B3AEAB44F8ED2F85EECD3ED81463CA\n\n```\n\nThe malware also attempts to identify the external IP address of the system by making requests to the following URLs:\n```\ncheckip.amazonaws.com\nipecho.net/plain\nipinfo.io/ip\napi.ipify.org\nicanhazip.com\nmyexternalip.com/raw\nwtfismyip.com/text\nip.anysrc.net/plain/clientip\n\n```\nThe collected information is then combined with a group id, in this case ‘lackey‘, and randomly generated tokens, and formatted as a type /0/\nrequest as per below:\n```\n/<group_id>/<system_id>/0/<os_version>/1001/<external_ip>/<token_1>/<token_2>/\n\n```\n\nFor example:\n```\n/lackey/DESKTOP4LUGU5I_W10019041.D9B3AEAB44F8ED2F85EECD3ED81463CA/0/Windows_10_x64/1001/0.0.0.0/5E348391753F5C9D25C757E540685864939D952\n\n```\n\n-----\n\ns data s t e se t to t e C a d t e a a e e pects to ece e a espo se co ta g t e seco d to e o de to a date t at t e data\nwas received successfully.\n\n## Network Communications\n\nAnchorMail is notable for communicating with its C2 server using SMTP and IMAP protocols over TLS, referred to as SMTPS and IMAPS\nrespectively. The C2 server appears to utilize mail server code, and the backdoor communicates with it through the sending and receiving of\nspecially crafted email messages. AnchorMail uses the encrypted SMTPS protocol for sending data to the C2, and IMAPS is used for receiving\nit.\n\nDuring startup, AnchorMail decrypts the server configuration which contains login credentials and server details. In the analyzed sample, these\nwere as follows:\n```\n{[email protected]|ohvohNgaeT6Shoche8Ei|15906-28547.bacloud.info|15906-28547.bacloud.info}\n{[email protected]|doo9ahxuuBug9cuuV8ga|15906-28547.bacloud.info|15906-28547.bacloud.info}{[email protected]}\n\n```\nHowever, a sample in the public domain was also identified with a different configuration:\n```\n{[email protected]|OaXah2shei6iL0Oohahj|15906-28547.bacloud.info|15906-28547.bacloud.info}\n{[email protected]|xixo8eoCh3Aphae7phai|15906-28547.bacloud.info|15906-28547.bacloud.info}{[email protected]}\n\n```\nIn the case of the analyzed sample, both the IMAP and SMTP servers are set to 15906-28547.bacloud[.]info.\n\nTo initiate C2 communications, the malware performs a DNS request to retrieve the IP address of the server, which at the time of analysis is\nset to 213.252.247[.]230. It then creates a TLS connection to SMTPS port 465 using the OpenSSL library, and then logs into the SMTP server\nusing the configured credentials.\n\nAnchorMail then crafts an email message containing the request string and any data to be sent to the C2. The recipient of the email is set as\nthe final value from within the configuration, i.e. z1[@]15906-28547.bacloud[.]info.\n\nAnchorMail generates a 16-byte GUID followed by a string such as ‘1-1‘, which it encodes using a custom encoding algorithm that encodes\nbinary data into a series of lowercase letters, which it intersperses with spaces in order to make it appear like text. It then sets this encoded\nstring as the email message subject.\n\nThe main request string and any accompanying data is also encoded using the encoding algorithm, then added to a zip file with the filename\nsuch as ‘1-1.txt‘. Finally, it is encoded using base64 and added to the email body.\n\nAn additional set of data consisting of another 16 bytes value followed by the string ‘GET‘ is also encoded and added to the email body.\n\nAn example of a constructed email containing a type /0/ request is follows:\n\n_[From: <[email protected]>](https://securityintelligence.com/cdn-cgi/l/email-protection)_\n\n_[To: <[email protected]>](https://securityintelligence.com/cdn-cgi/l/email-protection)_\n\n_Subject: Toduzu vypuwu asetadj tjwytu ycjsapo epeljhiru sohjsi jpjraze piwoge picuwe etetiwo tokoto wi._\n\n_MIME-Version: 1.0_\n\n_Content-Type: multipart/mixed; boundary=”4E7E98B61C1C3A56″_\n\n_–4E7E98B61C1C3A56_\n\n_Content-Type: application/octet-stream; name = “file.zip”_\n\n_Content-Transfer-Encoding: base64_\n\n_UEsDBBQAAAAIAMdjVFTnUv4FRgIAANUDAAAHAAAAMS0xLnR4dB1TQY4bMQw7t0D/oBfkD0XbQ08tFu1hj8JYzsgNYI0tzUT7+tI5BZ7IJEXSn9_\n\n_–4E7E98B61C1C3A56_\n\n_Content-Type: text/plain; charset=”us-ascii”_\n\n_Zdr vfl hdz krp srs rst rdl xts qvf rsz srp fps sp._\n\nTo receive responses from the C2, AnchorMail connects to the C2 server via IMAPS port 993 using TLS. It then logs into the IMAP server\nusing the configured credentials and uses the IMAP LIST and STATUS commands to retrieve the status of the mailboxes. The malware then\nuses the SELECT and FETCH commands to retrieve messages which it parses until it finds one containing a unique identifier that matches\none that the malware sent in its original request to the SMTP server.\n\nThe message contents are then decoded and the response and any commands and command parameters extracted.\n\n## Command Execution\n\nIf registration is successful, AnchorMail then sends a type /1/ request to the C2 to check for any commands to be run.\n```\n/<group_id>/<system_id>/1/<token>/\n\n```\n\n-----\n\ne espo se o t e C be o atted as o o s\n```\n<incode>/<group_id>/<system_id>/<token>/<cmdid>/<cmd_params>\n\n```\n\nThe incode field contains a number identifying the command which is to be run, and cmd_params contains the parameters for that command.\n\nOverall, AnchorMail supports the following command codes.\n\n**Command Code: 0**\n\nFunctionality:\n\nExecute a given command using %systemroot%\\System32\\cmd.exe\n\n**Command Code: 1**\n\nFunctionality:\n\nRetrieve executable file from C2 using type /5/ request.\nSave file to %temp% directory with a temp filename.\nExecute the dropped file via CreateProcess api.\n\n**Command Code: 2**\n\nFunctionality:\n\nRetrieve executable file from C2 using request string specified in command params.\nSave file to %temp% directory with a temp filename.\nExecute the dropped file via CreateProcess api.\n\n**Command Code: 3**\n\nFunctionality:\n\nRetrieve DLL file from C2 using type /5/ request.\nSave file to %temp% directory with a temp filename.\nIdentify entrypoint by loading DLL and searching for the following exports: go, entry, run, start, exec, begin, StartW, ctrl, entryPoint,\nInitLib, dllmain\nExecute DLL at entrypoint using command %systemroot%\\System32\\rundll32.exe <dll_path>,<entrypoint>\n\n**Command Code: 4**\n\nFunctionality:\n\nRetrieve DLL file from C2 using request string specified in command params.\nSave file to %temp% directory with a temp filename.\nIdentify entrypoint by loading DLL and searching for the following exports: go, entry, run, start, exec, begin, StartW, ctrl, entryPoint,\nInitLib, dllmain\nExecute DLL at entrypoint using command %systemroot%\\System32\\rundll32.exe <dll_path>,<entrypoint>\n\n**Command Code: 5**\n\nFunctionality:\n\nRetrieve file from C2 using type /5/ request.\nInject file into new process using process hollowing technique and execute.\nProcess injection target randomly selected from list: winhlp32.exe, write.exe, explorer.exe, svchost.exe, cmd.exe, notepad.exe, calc.exe,\nrundll32.exe\n\n**Command Code: 6**\n\nFunctionality:\n\nRetrieve file from C2 using request string specified in command params.\nInject file into new process using process hollowing technique and execute.\nProcess injection target randomly selected from list: winhlp32.exe, write.exe, explorer.exe, svchost.exe, cmd.exe, notepad.exe, calc.exe,\nrundll32.exe\n\n**Command Code: 7**\n\nFunctionality:\n\n\n-----\n\net e e e o C us g type /5/ equest\nExecute file via process doppelgänging technique.\nProcess doppelgäng target randomly selected from list: winhlp32.exe, write.exe, explorer.exe, svchost.exe, cmd.exe, notepad.exe,\ncalc.exe, rundll32.exe\n\n**Command Code: 8**\n\nFunctionality:\n\nRetrieve file from C2 using request string specified in command params.\nExecute file via process doppelgänging technique.\nProcess doppelgäng target randomly selected from list: winhlp32.exe, write.exe, explorer.exe, svchost.exe, cmd.exe, notepad.exe,\ncalc.exe, rundll32.exe\n\n**Command Code: 9**\n\nFunctionality:\n\nCreate instance of cmd.exe with pipes attached.\nExecute specified command in cmd.exe by writing it to input pipe and then exit.\n\n**Command Code: 10**\n\nFunctionality:\n\nCreate instance of powershell.exe with pipes attached.\nExecute specified command in powershell.exe by writing it to input pipe and then exit.\n\n**Command Code: 11**\n\nFunctionality:\n\nRetrieve shellcode from C2 using type /5/ request.\nCreate a new virtual desktop with name system_desktop using CreateDesktopA.\nCreate new process instances of mstsc.exe, explorer.exe, notepad.exe.\nInject shellcode into these processes and execute code. It may also attempt to inject code into additional running processes\n\n**Command Code: 12**\n\nFunctionality:\n\nRetrieve shellcode from C2 using request string specified in command params.\nCreate a new virtual desktop with name system_desktop using CreateDesktopA.\nCreate new process instances of mstsc.exe, explorer.exe, notepad.exe.\nInject shellcode into these processes and execute code. It may also attempt to inject code into additional running processes\n\n**Command Code: 100**\n\nFunctionality:\n\nUninstall. Delete scheduled task and delete malware file.\n\nThe type /5/ request used by some of the commands to request payload files has the following format:\n```\n/<group_id>/<system_id>/5/<file_name>/\n\n```\n\nOnce the specified command has been performed, results are sent back to the C2 using a type /10/ request.\n```\n/group_id>/<system_id>/10/<incode>/<cmdid>/<result>/\n\n```\n\n_[More cybersecurity threat resources are available here.](https://www.ibm.com/security/resources/crisis-management)_\n\n[Charlotte Hammond](https://securityintelligence.com/author/charlotte-hammond/)\nMalware Reverse Engineer, IBM Security\n\nCharlotte is a malware reverse engineer for IBM Security's X-Force IRIS team. She has been working in the security industry for more than 7\nyears with a focu...\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-25 - Trickbot Group’s AnchorDNS Backdoor Upgrades to AnchorMail.pdf"
    ],
    "report_names": [
        "2022-02-25 - Trickbot Group’s AnchorDNS Backdoor Upgrades to AnchorMail.pdf"
    ],
    "threat_actors": [
        {
            "id": "63061658-5810-4f01-9620-7eada7e9ae2e",
            "created_at": "2022-10-25T15:50:23.752974Z",
            "updated_at": "2025-03-27T02:00:55.538582Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "Wizard Spider",
                "UNC1878",
                "TEMP.MixMaster",
                "Grim Spider",
                "FIN12",
                "GOLD BLACKBURN",
                "ITG23",
                "Periwinkle Tempest",
                "DEV-0193"
            ],
            "source_name": "MITRE:Wizard Spider",
            "tools": [
                "TrickBot",
                "AdFind",
                "BITSAdmin",
                "Bazar",
                "LaZagne",
                "Nltest",
                "GrimAgent",
                "Dyre",
                "Ryuk",
                "Conti",
                "Emotet",
                "Rubeus",
                "Mimikatz",
                "Diavol",
                "PsExec",
                "Cobalt Strike"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "ee3363a4-e807-4f95-97d8-b603c31b9de1",
            "created_at": "2023-01-06T13:46:38.485884Z",
            "updated_at": "2025-03-27T02:00:02.845851Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "Camouflage Tempest",
                "MageCart Group 6",
                "G0037",
                "TA4557",
                "SKELETON SPIDER",
                "ITG08",
                "White Giant",
                "GOLD FRANKLIN",
                "ATK88"
            ],
            "source_name": "MISPGALAXY:FIN6",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "12517c87-040a-4627-a3df-86ca95e5c13f",
            "created_at": "2022-10-25T16:07:23.61665Z",
            "updated_at": "2025-03-27T02:02:09.889471Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "ATK 88",
                "Camouflage Tempest",
                "FIN6",
                "Gold Franklin",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "TAG-CR2",
                "White Giant"
            ],
            "source_name": "ETDA:FIN6",
            "tools": [
                "AbaddonPOS",
                "Agentemis",
                "AmmyyRAT",
                "Anchor_DNS",
                "BlackPOS",
                "CmdSQL",
                "Cobalt Strike",
                "CobaltStrike",
                "FlawedAmmyy",
                "FrameworkPOS",
                "Grateful POS",
                "JSPSPY",
                "Kaptoxa",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "LockerGoga",
                "MMon",
                "Magecart",
                "Meterpreter",
                "Mimikatz",
                "More_eggs",
                "NeverQuest",
                "POSWDS",
                "Reedum",
                "Ryuk",
                "SCRAPMINT",
                "SONE",
                "SpicyOmelette",
                "StealerOne",
                "Taurus Loader Stealer Module",
                "Terra Loader",
                "TerraStealer",
                "Vawtrak",
                "WCE",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "cobeacon",
                "grabnew"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "e6a21528-2999-4e2e-aaf4-8b6af14e17f3",
            "created_at": "2022-10-25T16:07:24.422115Z",
            "updated_at": "2025-03-27T02:02:10.216817Z",
            "deleted_at": null,
            "main_name": "Wizard Spider",
            "aliases": [
                "DEV-0193",
                "Gold Blackburn",
                "Gold Ulrick",
                "Grim Spider",
                "ITG23",
                "Operation BazaFlix",
                "Periwinkle Tempest",
                "TEMP.MixMaster",
                "Wizard Spider"
            ],
            "source_name": "ETDA:Wizard Spider",
            "tools": [
                "AdFind",
                "Agentemis",
                "Anchor_DNS",
                "BEERBOT",
                "BazarBackdoor",
                "BazarCall",
                "BazarLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "Conti",
                "Diavol",
                "Dyranges",
                "Dyre",
                "Dyreza",
                "Dyzap",
                "Gophe",
                "Invoke-SMBAutoBrute",
                "KEGTAP",
                "LaZagne",
                "LightBot",
                "PowerSploit",
                "PowerTrick",
                "PsExec",
                "Ryuk",
                "SessionGopher",
                "TSPY_TRICKLOAD",
                "Team9Backdoor",
                "The Trick",
                "TheTrick",
                "Totbrick",
                "TrickBot",
                "TrickLoader",
                "TrickMo",
                "Upatre",
                "bazaloader",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b3acfb48-b04d-4d3d-88a8-836d7376fa2e",
            "created_at": "2024-06-19T02:03:08.052814Z",
            "updated_at": "2025-03-27T02:05:17.368029Z",
            "deleted_at": null,
            "main_name": "GOLD FRANKLIN",
            "aliases": [
                "ITG08 ",
                "MageCart Group 6 ",
                "Skeleton Spider ",
                "White Giant ",
                "FIN6 "
            ],
            "source_name": "Secureworks:GOLD FRANKLIN",
            "tools": [
                " Metasploit",
                " Meterpreter",
                " Mimikatz",
                " PowerSploit",
                " PowerUpSQL",
                " RemCom",
                "FrameWorkPOS"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "bc119938-a79c-4e5f-9d4d-dc96835dfe2e",
            "created_at": "2024-06-04T02:03:07.799286Z",
            "updated_at": "2025-03-27T02:05:17.337094Z",
            "deleted_at": null,
            "main_name": "GOLD BLACKBURN",
            "aliases": [
                "Periwinkle Tempest ",
                "Wizard Spider ",
                "ITG23 "
            ],
            "source_name": "Secureworks:GOLD BLACKBURN",
            "tools": [
                " Buer Loader",
                " Dyre",
                " Team9",
                " TrickBot",
                "BazarLoader"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "ea7bfe06-7c23-481d-b8ba-eafa6cda3bc9",
            "created_at": "2022-10-25T15:50:23.317961Z",
            "updated_at": "2025-03-27T02:00:55.440858Z",
            "deleted_at": null,
            "main_name": "FIN6",
            "aliases": [
                "FIN6",
                "Magecart Group 6",
                "ITG08",
                "Skeleton Spider",
                "TAAL",
                "Camouflage Tempest"
            ],
            "source_name": "MITRE:FIN6",
            "tools": [
                "FlawedAmmyy",
                "GrimAgent",
                "FrameworkPOS",
                "More_eggs",
                "Cobalt Strike",
                "Windows Credential Editor",
                "AdFind",
                "PsExec",
                "LockerGoga",
                "Ryuk",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536233,
    "ts_updated_at": 1743041713,
    "ts_creation_date": 1653704761,
    "ts_modification_date": 1653704761,
    "files": {
        "pdf": "https://archive.orkl.eu/959cfa8ae918c58d7989794d606ad3482d4d54c3.pdf",
        "text": "https://archive.orkl.eu/959cfa8ae918c58d7989794d606ad3482d4d54c3.txt",
        "img": "https://archive.orkl.eu/959cfa8ae918c58d7989794d606ad3482d4d54c3.jpg"
    }
}