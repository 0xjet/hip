{
    "id": "03e930f7-7a10-4516-b71e-6df8f168bcdb",
    "created_at": "2023-01-12T15:01:57.628548Z",
    "updated_at": "2025-03-27T02:16:35.054464Z",
    "deleted_at": null,
    "sha1_hash": "9ef8f1665c6cf3f55c54ee0ef30e032cd42033c1",
    "title": "2021-01-08 - Alert (AA21-008A)- Detecting Post-Compromise Threat Activity in Microsoft Cloud Environments",
    "authors": "",
    "file_creation_date": "2022-05-29T01:06:00Z",
    "file_modification_date": "2022-05-29T01:06:00Z",
    "file_size": 192510,
    "plain_text": "# Detecting Post-Compromise Threat Activity in Microsoft Cloud Environments\n\n**us-cert.cisa.gov/ncas/alerts/aa21-008a**\n\n## Summary\n\n_This Advisory uses the MITRE Adversarial Tactics, Techniques, and Common Knowledge_\n_(ATT&CK®) framework. See the_ _[ATT&CK for Enterprise for all referenced threat actor tactics and](https://attack.mitre.org/versions/v7/techniques/enterprise/)_\n_techniques._\n\n**_Updated April 15, 2021: The U.S. Government attributes this activity to the Russian Foreign_**\n**_Intelligence Service (SVR). Additional information may be found in a_** **_statement from the_**\n**_White House. For more information on SolarWinds-related activity, go to_** **_https://us-_**\n**_cert.cisa.gov/remediating-apt-compromised-networks and_** **_https://www.cisa.gov/supply-_**\n**_chain-compromise._**\n\nThis Alert is a companion alert to AA20-352A: Advanced Persistent Threat Compromise of\nGovernment Agencies, Critical Infrastructure, and Private Sector Organizations. AA20-352A\nprimarily focuses on an advanced persistent threat (APT) actor’s compromise of SolarWinds\nOrion products as an initial access vector into networks of U.S. Government agencies, critical\ninfrastructure entities, and private network organizations. As noted in AA20-352A, the\nCybersecurity and Infrastructure Security Agency (CISA) has evidence of initial access vectors in\naddition to the compromised SolarWinds Orion products.\n\nThis Alert also addresses activity—irrespective of the initial access vector leveraged—that CISA\nattributes to an APT actor. Specifically, CISA has seen an APT actor using compromised\napplications in a victim’s Microsoft 365 (M365)/Azure environment. CISA has also seen this APT\nactor utilizing additional credentials and Application Programming Interface (API) access to cloud\nresources of private and public sector organizations. These tactics, techniques, and procedures\n(TTPs) feature three key components:\n\nCompromising or bypassing federated identity solutions;\nUsing forged authentication tokens to move laterally to Microsoft cloud environments; and\nUsing privileged access to a victim’s cloud environment to establish difficult-to-detect\npersistence mechanisms for Application Programming Interface (API)-based access.\n\nThis Alert describes these TTPs and offers an overview of, and guidance on, available opensource tools—including a CISA-developed tool, Sparrow—for network defenders to analyze their\nMicrosoft Azure Active Directory (AD), Office 365 (O365), and M365 environments to detect\npotentially malicious activity.\n\n**Note: this Alert describes artifacts—presented by these attacks—from which CISA has identified**\ndetectable evidence of the threat actor’s initial objectives. CISA continues to analyze the threat\nactor’s follow-on objectives.\n\n\n-----\n\n## Technical Details\n\nFrequently, CISA has observed the APT actor gaining Initial Access [[TA0001] to victims’](https://attack.mitre.org/versions/v8/tactics/TA0001/)\n[enterprise networks via compromised SolarWinds Orion products (e.g., Solorigate, Sunburst).[1]](https://www.zdnet.com/article/a-second-hacking-group-has-targeted-solarwinds-systems/%20)\nHowever, CISA is investigating instances in which the threat actor may have obtained initial\naccess by Password Guessing [[T1110.001], Password Spraying](https://attack.mitre.org/versions/v8/techniques/T1110/001/) [[T1110.003], and/or exploiting](https://attack.mitre.org/versions/v8/techniques/T1110/003)\n[inappropriately secured administrative or service credentials (Unsecured Credentials [T1552])](https://attack.mitre.org/versions/v8/techniques/T1552/)\ninstead of utilizing the compromised SolarWinds Orion products.\n\nCISA observed this threat actor moving from user context to administrator rights for Privilege\n_Escalation_ [[TA0004] within a compromised network and using native Windows tools and](https://attack.mitre.org/versions/v8/tactics/TA0004/)\ntechniques, such as Windows Management Instrumentation (WMI), to enumerate the Microsoft\nActive Directory Federated Services (ADFS) certificate-signing capability. This enumeration allows\nthreat actors to forge authentication tokens (OAuth) to issue claims to service providers—without\nhaving those claims checked against the identity provider—and then to move laterally to Microsoft\n[Cloud environments (Lateral Movement [TA0008]).](https://attack.mitre.org/versions/v8/tactics/TA0008/)\n\nThe threat actor has also used on-premises access to manipulate and bypass identity controls\nand multi-factor authentication. This activity demonstrates how sophisticated adversaries can use\ncredentials from one portion of an organization to move laterally (Lateral Movement [[TA0008])](https://attack.mitre.org/versions/v8/tactics/TA0008/)\nthrough trust boundaries, evade defenses and detection (Defense Evasion [[TA0005]), and steal](https://attack.mitre.org/versions/v8/tactics/TA0005/)\n[sensitive data (Collection [TA0009]).](https://attack.mitre.org/versions/v8/tactics/TA0009/)\n\nThis level of compromise is challenging to remediate and requires a rigorous multi-disciplinary\neffort to regain administrative control before recovering.\n\n## Mitigations\n\n**Detection**\n\n[Guidance on identifying affected SolarWinds software is well documented.[2] However—once an](https://www.cisa.gov/supply-chain-compromise%20)\norganization identifies a compromise via SolarWinds Orion products or other threat actor TTPs—\nidentifying follow-on activity for on-premises networks requires fine-tuned network and host-based\nforensics.\n\nThe nature of cloud forensics is unique due to the growing and rapidly evolving technology\nfootprints of major vendors. Microsoft's O365 and M365 environments have built-in capabilities for\ndetecting unusual activity. Microsoft also provides premium services (Advanced Threat Protection\n\n[ATP] and Azure Sentinel), which enable network defenders to investigate TTPs specific to the\n[Solorigate activity.[3]](https://techcommunity.microsoft.com/t5/azure-sentinel/solarwinds-post-compromise-hunting-with-azure-sentinel/ba-p/1995095%20)\n\n**Detection Tools**\n\n_CISA is providing examples of detection tools for informational purposes only. CISA does not_\n_endorse any commercial product or service, including any subjects of analysis. Any reference to_\n_specific commercial products, processes, or services does not constitute or imply their_\n_endorsement, recommendation, or favoring by CISA._\n\n\n-----\n\nThere are a number of open-source tools available to investigate adversary activity in Microsoft\n[cloud environments and to detect unusual activity, service principals, and application activity.[4]](https://msrc-blog.microsoft.com/2020/12/21/december-21st-2020-solorigate-resource-center/%20)\nPublicly available PowerShell tools that network defenders can use to investigate M365 and\nMicrosoft Azure include:\n\nCISA's Sparrow,\nOpen-source utility Hawk, and\nCrowdStrike's Azure Reporting Tool (CRT).\n\nAdditionally, Microsoft's Office 365 Management API and Graph API provide an open interface for\ningesting telemetry and evaluating service configurations for signs of anomalous activity and\nintrusion.\n\n**Note: these open-source tools are highlighted and explained to assist with on-site investigation**\nand remediation in cloud environments but are not all-encompassing. Open source tools can be\ncomplemented by services such as Azure Sentinel, a Microsoft premium service that provides\ncomprehensive analysis tools, including custom detections for the activity indicated.\n\n**General Guidance on Using Detection Tools**\n\n1. Audit the creation and use of service principal credentials. Look for unusual application\n\nusage, such as use of dormant applications.\n2. Audit the assignment of credentials to applications that allow non-interactive sign-in by the\n\napplication. Look for unexpected trust relationships added to the Azure Active Directory.\n3. Download the interactive sign-ins from the Azure admin portal or use the Microsoft Sentinel\n\nproduct. Review new token validation time periods with high values and investigate whether\nit was a legitimate change or an attempt to gain persistence by a threat actor.\n\n**Sparrow**\n\nCISA created [Sparrow to help network defenders detect possible compromised accounts and](https://github.com/cisagov/Sparrow)\napplications in the Azure/M365 environment. The tool focuses on the narrow scope of user and\napplication activity endemic to identity- and authentication-based attacks seen recently in multiple\nsectors. It is neither comprehensive nor exhaustive of available data. It is intended to narrow a\nlarger set of available investigation modules and telemetry to those specific to recent attacks on\nfederated identity sources and applications.\n\n_(Updated April 8, 2021): CISA has also created \"Aviary,\" which is a companion Splunk dashboard_\nthat can assist in visualizing and reviewing the output of Sparrow. Network defenders can find\nAviary on [CISA's Sparrow GitHub page. CISA advises network defenders to perform the following](https://github.com/cisagov/Sparrow)\nactions to use Sparrow:\n\n1. Use Sparrow to detect any recent domain authentication or federation modifications.\n\n1. Domain and federation modification operations are uncommon and should be\n\ninvestigated.\n\n\n-----\n\n2. Examine logs for new and modified credentials applied to applications and service\n\nprincipals; delineate for the credential type. Sparrow can be used to detect the modification\nof service principals and application credentials.\n\n1. Create a timeline for all credential changes, focusing on recent wholesale changes.\n2. Review the “top actors” for activity in the environment and the number of credential\n\nmodifications performed.\n3. Monitor changes in application and service principal credentials.\n4. Investigate any instances of excessive permissions being granted, including, but not\n\nlimited to, Exchange Online, Microsoft Graph, and Azure AD Graph.\n3. Use Sparrow to detect privilege escalation, such as adding a service principal, user, or\n\ngroup to a privileged role.\n4. Use Sparrow to detect `OAuth consent and users’ consent to applications, which is useful`\n\nfor interpreting changes in adversary TTPs.\n5. Use Sparrow to identify anomalous Security Assertion Markup Language (SAML) token\n\nsign-ins by pivoting on the unified audit log UserAuthenticationValue of 16457, which is an\nindicator of how a SAML token was built and is a potential indicator for forged SAML tokens.\n\n1. Note that this TTP has not been the subject of significant published security research\n\nbut may indicate an unusual usage of a token, such as guest access for external\npartners to M365 resources.\n6. Review the PowerShell logs that Sparrow exports.\n\n1. Review PowerShell mailbox sign-ins and validate that the logins are legitimate actions.\n2. Review PowerShell usage for users with PowerShell in the environment.\n7. Use Sparrow to check the Graph API application permissions of all service principals and\n\napplications in M365/Azure AD.\n\n1. Investigate unusual activity regarding Microsoft Graph API permissions (using either\n\nthe legacy [https://graph.windows.net/ or](https://graph.windows.net/) [https://graph.microsoft.com). Graph is used](https://graph.microsoft.com/)\nfrequently as part of these TTPs, often to access and manipulate mailbox resources.\n8. Review Sparrow’s listed tenant’s Azure AD domains, to see if the domains have been\n\nmodified.\n9. For customers with G5 or E5 licensing levels, review MailItemsAccessed for insight into\n\nwhat application identification (ID) was used for accessing users’ mailboxes. Use Sparrow to\nquery for a specific application ID using the app id investigation capability, which will check\nto see if it is accessing mail or file items.\n\n1. The MailItemsAccessed event provides audibility for mailbox data accessed via mail\n\nprotocols or clients.\n2. By analyzing the MailItemsAccessed action, incident responders can determine which\n\nuser mailbox items have been accessed and potentially exfiltrated by a threat actor.\nThis event will be recorded even in some situations where the message was not\n[necessarily read interactively (e.g., bind or sync).[5]](https://docs.microsoft.com/en-us/microsoft-365/compliance/advanced-audit?view=o365-worldwide)\n3. The resulting suspicious application ID can provide incident responders with a pivot to\n\ndetect other suspicious applications that require additional analysis.\n4. Check for changes to applications with regards to the accessing of resources such as\n\nmail or file items.\n\n\n-----\n\n_(Updated April 8, 2021): Aviary can be used to assist with performing the above tasks. To install_\nAviary, after running Sparrow:\n\n1. Ingest comma separated values (CSV) output from the Sparrow PowerShell script into\n\nSplunk.\n\n1. Sparrow output will have the following default filenames, which should not be modified:\n```\n      AppUpdate_Operations_Export.csv,\n      AppRoleAssignment_Operations_Export.csv,\n      Consent_Operations_Export.csv, Domain_List.csv,\n      Domain_Operations_Export.csv, FileItems_Operations_Export.csv,\n      MailItems_Operations_Export.csv, PSLogin_Operations_Export.csv,\n      PSMailbox_Operations_Export.csv, SAMLToken_Operations_Export.csv,\n      ServicePrincipal_Operations_Export.csv\n\n```\n2. Copy and paste the contents of the .xml file (aviary.xml in the root directory) into a new\n\ndashboard.\n3. Use the data selection filters to point to the indexed Sparrow data (see figure 1)\n\nFigure 1: Data Selection\nFilters\n\n**Hawk**\n\nHawk is an open-source, PowerShell-driven, community-developed tool network defenders can\nuse to quickly and easily gather data from O365 and Azure for security investigations. Incident\nresponders and network defenders can investigate specific user principals or the entire tenant.\nData it provides include IP addresses and sign-in data. Additionally, Hawk can track IP usage for\nconcurrent login situations.\n\nHawk users should review login details for administrator accounts and take the following steps.\n\n**CrowdStrike Azure Reporting Tool**\n\n[CrowdStrike's Azure Reporting Tool (CRT) can help network defenders analyze their Microsoft](https://github.com/CrowdStrike/CRT)\nAzure AD and M365 environment to help organizations analyze permissions in their Azure AD\ntenant and service configuration. This tool has minor overlap with Sparrow; it shows unique items,\nbut it does not cover the same areas. CISA is highlighting this tool because it is one of the only\nfree, open-source tools available to investigate this activity and could be used to complement\nSparrow.\n\n**Detection Tool Distinctions**\n\n**Detection Methods**\n\n\n-----\n\nMicrosoft breaks the threat actor s recent activity into four primary stages, which are described\nbelow along with associated detection methods. Microsoft describes these stages as beginning\n[with all activity after the compromise of the on-premises identity solution, such as ADFS.[6]](https://techcommunity.microsoft.com/t5/azure-active-directory-identity/understanding-quot-solorigate-quot-s-identity-iocs-for-identity/ba-p/2007610%20)\n\nNote: this step provides an entry vector to cloud technology environments, and is unnecessary\nwhen the threat actor has compromised an identity solution or credential that allows the APT\ndirect access to the cloud(e.g., without leveraging the SolarWinds Orion vulnerability).\n\n**Stage 1: Forging a trusted authentication token used to access resources that trust the on-**\n**premises identity provider**\n\nThese attacks (often referred to as “Golden Security Assertion Markup Language” attacks) can be\n[analyzed using a combination of cloud-based and standard on-premises techniques.[7] For](https://www.sygnia.co/golden-saml-advisory)\nexample, network defenders can use `OAuth claims for specific principals made at the Azure AD`\nlevel and compare them to the on-premises identity.\n\nExport sign-in logs from the Azure AD portal and look at the Authentication Method field.\n\n**Note: at portal.azure.com, click on a user and review the authentication details (e.g., date,**\nmethod, result). Without Sentinel, this is the only way to get these logs, which are critical for this\neffort.\n\n**_Detection Method 1: Correlating service provider login events with corresponding_**\n**_authentication events in Active Directory Federation Services (ADFS) and Domain_**\n**_Controllers_**\n\nUsing SAML single sign-on, search for any logins to service providers that do not have\ncorresponding event IDs 4769, 1200, and 1202 in the domain.\n\n**_Detection Method 2: Identifying certificate export events in ADFS_**\n\nLook for:\n\n**_Detection Method 3: Customizing SAML response to identify irregular access_**\n\nThis method serves as prevention for the future (and would only detect future, not past, activity),\nas it helps identify irregularities from the point of the change forward. Organizations can modify\nSAML responses to include custom elements for each service provider to monitor and detect any\n[anomalous requests.[8]](https://www.sygnia.co/golden-saml-advisory)\n\n**_Detection Method 4: Detecting malicious ADFS trust modification_**\n\nA threat actor who gains administrative access to ADFS can add a new, trusted ADFS rather than\n[extracting the certificate and private key as part of a standard Golden SAML attack.[9]](https://www.sygnia.co/golden-saml-advisory)\nNetwork defenders should look for:\n\n**Stage 2: Using the forged authentication token to create configuration changes in the**\n**Service Provider, such as Azure AD (establishing a foothold)**\n\n\n-----\n\nAfter the threat actor has compromised the on-premises identity provider, they identify their next\nseries of objectives by reviewing activity in the Microsoft Cloud activity space (Microsoft Azure and\nM365 tenants).\n\nThe threat actor uses the ability to forge authentication tokens to establish a presence in the cloud\nenvironment. The actor adds additional credentials to an existing service principal. Once the\nthreat actor has impersonated a privileged Azure AD account, they are likely to further manipulate\nthe Azure/M365 environment (action on objectives in the cloud).\n\nNetwork defenders should take the following steps.\n\n**Stage 3: Acquiring an** `OAuth access token for the application using the forged credentials`\n**added to an existing application or service principal and calling APIs with the permissions**\n**assigned to that application**\n\nIn some cases, the threat actor has been observed adding permissions to existing applications or\nservice principals. Additionally the actor has been seen establishing new applications or service\nprincipals briefly and using them to add permissions to the existing applications or service\nprincipals, possibly to add a layer of indirection (e.g., using it to add a credential to another service\n[principal, and then deleting it).[11]](https://techcommunity.microsoft.com/t5/azure-active-directory-identity/understanding-quot-solorigate-quot-s-identity-iocs-for-identity/ba-p/2007610%20)\n\nNetwork defenders should use Sparrow to:\n\n**Stage 4: Once access has been established, the threat actor Uses Microsoft Graph API to**\n**conduct action on objectives from an external RESTful API (queries impersonating existing**\n**applications).**\n\nNetwork defenders should:\n\n**Microsoft Telemetry Nuances**\n\nThe existing tools and techniques used to evaluate cloud-based telemetry sources present\nchallenges not represented in traditional forensic techniques. Primarily, the amount of telemetry\nretention is far less than the traditional logging facilities of on-premises data sources. Threat actor\nactivity that is more than 90 days old is unlikely to have been saved by traditional sources or be\nvisible with the Microsoft M365 Management API or in the UAL.\n\nService principal logging is available using the Azure Portal via the \"Service Principal Sign-ins\"\nfeature. Enable settings in the Azure Portal (see “Diagnostic Setting”) to ingest logs into Sentinel\nor a third-party security information and event management (SIEM) tool. An Azure Premium P1 or\nPremium P2 license is necessary to access this setting as well as other features, such as a log\n[analytics workspace, storage account, or event hub.[12] These logs must be downloaded](https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-all-sign-ins%20)\nmanually if not ingested by one of the methods listed in the Detection Methods section.\n\nGlobal Administrator rights are often required by tools other than Hawk and Sparrow to evaluate\nM365 cloud security posture. Logging capability and visibility of data varies by licensing models\nand subscription to premium services, such as Microsoft Defender for O365 and Azure Sentinel.\n\n\n-----\n\nAccording to CrowdStrike, There was an inability to audit via API, and there is the requirement for\nglobal admin rights to view important information which we found to be excessive. Key information\n[should be easily accessible.\"[13]](https://www.crowdstrike.com/blog/crowdstrike-launches-free-tool-to-identify-and-help-mitigate-risks-in-azure-active-directory/)\n\nDocumentation for specific event codes, such as UserAuthenticationMethod 16457, which may\nindicate a suspicious SAML token forgery, is no longer available in the M365 Unified Access Log.\nAuditing narratives on some events no longer exist as part of core Microsoft documentation\nsources.\n\nThe use of industry-standard SIEMs for log detection is crucial for providing historical context for\nthreat hunting in Microsoft cloud environments. Standard G3/E3 licenses only provide 90 days of\nauditing; with the advanced auditing license that is provided with a G5/E5 license, audit logs can\nbe extended to retain information for a year. CISA notes that this license change is proactive,\nrather than reactive: it allows enhanced visibility and features for telemetry from the moment of\nintegration but does not provide retroactive visibility on previous events or historical context.\n\nA properly configured SIEM can provide:\n\nBuilt-in tools, such as Microsoft Cloud Services and M365 applications, provide much of the same\nvisibility available from custom tools and are mapped to the MITRE ATT&CK framework and easy[to-understand dashboards.[14] However, these tools often do not have the ability to pull historical](https://splunkbase.splunk.com/app/3786/)\ndata older than seven days. Therefore, storage solutions that appropriately meet governance\nstandards and usability metrics for analysts for the SIEM must be carefully planned and arranged.\n\n1. Ingest comma separated values (CSV) output from the Sparrow PowerShell script into\n\nSplunk.\n\n1. Sparrow output will have the following default filenames, which should not be modified:\n```\n      AppUpdate_Operations_Export.csv, AppRoleAssignment_Operations_Export.csv,\n      Consent_Operations_Export.csv, Domain_List.csv,\n      Domain_Operations_Export.csv, FileItems_Operations_Export.csv,\n      MailItems_Operations_Export.csv, PSLogin_Operations_Export.csv,\n      PSMailbox_Operations_Export.csv, SAMLToken_Operations_Export.csv,\n      ServicePrincipal_Operations_Export.csv\n\n```\n2. Copy and paste the contents of the .xml file (aviary.xml in the root directory) into a new\n\ndashboard.\n3. Use the data selection filters to point to the indexed Sparrow data (see figure 1)\n\n\n-----\n\n4.\n\n\n1. Investigate high-value administrative accounts to detect anomalous or unusual activity\n\n(Global Admins).\n2. Enable PowerShell logging, and evaluate PowerShell activity in the environment not\n\nused for traditional or expected purposes.\n\n1. PowerShell logging does not reveal the exact `cmdlet that was run on the`\n\ntenant.\n3. Look for users with unusual sign-in locations, dates, and times.\n4. Check permissions of service principals and applications in M365/Azure AD.\n5. Detect the frequency of resource access from unusual places. Use the tool to pivot to\n\na trusted application and see if it is accessing mail or file items.\n6. Review mailbox rules and recent mailbox rule changes.\n\nSparrow differs from CRT by looking for specific indicators of compromise associated\nwith the recent attacks.\nCRT focuses on the tenant’s Azure AD permissions and Exchange Online\nconfiguration settings instead of the unified audit log, which gives it a different output\nfrom Sparrow or Hawk.\nCRT returns the same broad scope of application/delegated permissions for service\nprincipals and applications as Hawk.\nAs part of its investigation, Sparrow homes in on a narrow set of application\npermissions given to the Graph API, which is common to the recent attacks.\nCRT looks at Exchange Online federation configuration and federation trust, while\nSparrow focuses on listing Azure AD domains.\nAmong the items network defenders can use CRT to review are delegated permissions\nand application permissions, federation configurations, federation trusts, mail\nforwarding rules, service principals, and objects with KeyCredentials.\n1. The IP address and Activity_ID in EventCode 410 and the Activity_ID and Instance_ID\n\nin EventCode 500.\n2. Export-PfxCertificate or certutil-exportPFX in Event IDs 4103 and 4104, which may\n\ninclude detection of a certificate extraction technique.\n3. Deleted certificate extraction with ADFSdump performed using Sysmon Event ID 18\n\nwith the pipe name \\microsoft##wid\\tsql\\query (exclude processes regularly making\nthis pipe connection on the machine).\n4. Event ID 307 (The Federation Service configuration was changed), which can be\n\ncorrelated to relevant Event ID 510 with the same instance ID for change details\n(Event ID 510 with the same Instance ID could be more than one event per single\nEvent ID 307 event).\n5. Event ID 307 (The Federation Service configuration was changed), which can be\n\ncorrelated to relevant Event ID 510 with the same Instance ID for change details.\n(Event ID 510 with the same Instance ID could be more than one event per single\nEvent ID 307 event.)\n\n1. Review events, particularly searching for Configuration: Type: IssuanceAuthority\n\nwhere Property Value references an unfamiliar domain.\n\n\n-----\n\n6. Possible activity of an interrogating ADFS host by using ADFS PowerShell plugins.\n\nLook for changes in the federation trust environment that would indicate new ADFS\nsources.\n7. Audit the creation and use of service principal and application credentials. Sparrow will\n\ndetect modifications to these credentials.\n\n1. Look for unusual application usage, such as dormant or forgotten applications\n\nbeing used again.\n2. Audit the assignment of credentials to applications that allow non-interactive\n\nsign-in by the application.\n8. Look for unexpected trust relationships that have been added to Azure AD. (Download\n\nthe last 30 days of non-interactive sign-ins from the Azure portal or use Azure\n[Sentinel.).[10]](https://docs.microsoft.com/en-us/azure/azure-monitor/reference/tables/aadserviceprincipalsigninlogs%20)\n9. Use Hawk (and any sub-modules available) to run an investigation on a specific user.\n\nHawk will provide IP addresses, sign-in data, and other data. Hawk can also track IP\nusage in concurrent login situations.\n10. Review login details for administrator accounts (e.g., high-value administrative\n\naccounts, such as Global Admins). Look for unusual sign-in locations, dates, and\ntimes.\n11. Review new token validation time periods with high values and investigate whether the\n\nchanges are legitimate or a threat actor’s attempts to gain persistence.\n12. Examine highly privileged accounts; specifically using sign-in logs, look for unusual\n\nsign-in locations, dates, and times.\n13. Create a timeline for all credential changes.\n14. Monitor changes in application credentials (the script will export into csv named\n\nAppUpdate_Operations_Export).\n15. Detect service principal credentials change and service principal change (e.g., if an\n\nactor adds new permissions or expands existing permissions).\n\n1. Export and view this activity via the ServicePrincipal_Operations_Export.\n16. Record `OAuth consent and consent to applications`\n\n1. Export and view this record via the Consent_Operations_Export file.\n17. Investigate instances of excessive high permissions, including, but not limited to\n\nExchange Online, Microsoft Graph, and Azure AD Graph.\n\n1. Review Microsoft Graph API permissions granted to service principals.\n2. Export and view this activity via the ApplicationGraphPermissions csv file.\n\n1. Note: Hawk can also return the full list of service principal permissions for\n\nfurther investigation.\n3. Review top actors and the amount of credential modifications performed.\n4. Monitor changes in application credentials.\n18. Identify manipulation of custom or third-party applications.\n\n1. Network defenders should review the catalog of custom or third-party vendors\n\nwith applications in the Microsoft tenant and perform the above interrogation\nprinciples on those applications and trusts.\n\n\n-----\n\n19. Review modifications to federation trust settings.\n\n1. Review new token validation time periods with high values and investigate\n\nwhether this was a legitimate change or an attempt to gain persistence by the\nthreat actor.\n\n1. The script detects the escalation of privileges, including the addition of\n\nService Principals (SP) to privileged roles. Export this data into csv called\nAppRoleAssignment_Operations_Export.\n20. In MailItemsAccessed operations, found within the Unified Audit Log (UAL), review the\n\napplication ID used (requires G5 or E5 license for this specific detail).\n21. Query the specific application ID, using the Sparrow script’s app ID investigation\n\ncapability to interrogate mail and file items accessed for that applicationID (Use the\napplication ID utility for any other suspicious apps that require additional analysis.).\n22. Check the permissions of an application in M365/Azure AD using Sparrow.\n\n1. Hawk will return Azure_Application_Audit, and Sparrow will return\n\nApplicationGraphPermissions.\n2. Network defenders will see the IP address that Graph API uses.\n3. Note: the Microsoft IP address may not show up as a virtual private\n\nserver/anonymized endpoint.\n23. Investigate a specific service principal, if it is a user-specific user account, in Hawk.\n\nThis activity is challenging to see without Azure Sentinel or manually downloading and\nreviewing logs from the sign-in portal.\n24. Longer term storage of log data.\n25. Cross correlation of log data with endpoint data and network data (such as those\n\nproduced by ADFS servers), endpoint detection and response data, and identity\nprovider information.\n26. Ability to query use of application connectors in Azure.\n\n## Contact Information\n\nCISA encourages recipients of this report to contribute any additional information that they may\nhave related to this threat. For any questions related to this report, please contact CISA at\n\n1-888-282-0870 (From outside the United States: +1-703-235-8832)\n[central@cisa.dhs.gov (UNCLASS)](http://10.10.0.46/mailto:central@cisa.dhs.gov)\nus-cert@dhs.sgov.gov (SIPRNET)\nus-cert@dhs.ic.gov (JWICS)\n\nCISA encourages you to report any suspicious activity, including cybersecurity incidents, possible\nmalicious code, software vulnerabilities, and phishing-related scams. Reporting forms can be\nfound on the CISA/US-CERT homepage at [http://www.us-cert.cisa.gov/.](http://www.us-cert.cisa.gov/)\n\n## Resources\n\nAzure Active Directory Workbook to Assess Solorigate Risk:\nhttps://techcommunity.microsoft.com/t5/azure-active-directory-identity/azure-ad-workbook-to-helpyou-assess-solorigate-risk/ba-p/2010718\n\n\n-----\n\nVolexity - Dark Halo Leverages SolarWinds Compromise to Breach Organizations:\nhttps://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breachorganizations/\n\nHow to Find Activity with Sentinel: https://www.verboon.info/2020/10/monitoring-service-principalsign-ins-with-azuread-and-azure-sentinel/\n\nThird-Party Walkthrough of the Attack: https://dirkjanm.io/azure-ad-privilege-escalationapplication-admin/\n\nNational Security Agency Advisory on Detecting Abuse of Authentication Mechanisms:\nhttps://media.defense.gov/2020/Dec/17/2002554125/-1/-1/0/AUTHENTICATION_MECHANISMS_\nCSA_U_OO_198854_20.PDF\n\n[Microsoft 365 App for Splunk: https://splunkbase.splunk.com/app/3786/](https://splunkbase.splunk.com/app/3786/)\n\n[CISA Remediation Guidance: https://us-cert.cisa.gov/ncas/alerts/aa20-352a](https://us-cert.cisa.gov/ncas/alerts/aa20-352a)\n\n## References\n\n Revisions\n\nInitial version: January 8, 2021\n\nFebruary 4, 2021: Removed link and section for outdated product feedback form\n\nApril 8, 2021: Added Aviary Dashboard information\n\nApril 15, 2021: Added Attribution Statement\n\n[This product is provided subject to this Notification and this](https://us-cert.cisa.gov/privacy/notification) [Privacy & Use policy.](https://www.dhs.gov/privacy-policy)\n\n**Please share your thoughts.**\n\n[We recently updated our anonymous product survey; we'd welcome your feedback.](https://www.surveymonkey.com/r/CISA-cyber-survey?product=https://us-cert.cisa.gov/ncas/alerts/aa21-008a)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-08 - Alert (AA21-008A)- Detecting Post-Compromise Threat Activity in Microsoft Cloud Environments.pdf"
    ],
    "report_names": [
        "2021-01-08 - Alert (AA21-008A)- Detecting Post-Compromise Threat Activity in Microsoft Cloud Environments.pdf"
    ],
    "threat_actors": [
        {
            "id": "b43e5ea9-d8c8-4efa-b5bf-f1efb37174ba",
            "created_at": "2022-10-25T16:07:24.36191Z",
            "updated_at": "2025-03-27T02:02:10.1909Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "Dark Halo",
                "Nobelium",
                "SolarStorm",
                "StellarParticle",
                "UNC2452"
            ],
            "source_name": "ETDA:UNC2452",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "70872c3a-e788-4b55-a7d6-b2df52001ad0",
            "created_at": "2023-01-06T13:46:39.18401Z",
            "updated_at": "2025-03-27T02:00:03.01553Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "DarkHalo",
                "StellarParticle",
                "NOBELIUM",
                "Solar Phoenix",
                "Midnight Blizzard"
            ],
            "source_name": "MISPGALAXY:UNC2452",
            "tools": [
                "SNOWYAMBER",
                "HALFRIG",
                "QUARTERRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "1d3f9dec-b033-48a5-8b1e-f67a29429e89",
            "created_at": "2022-10-25T15:50:23.739197Z",
            "updated_at": "2025-03-27T02:00:55.536417Z",
            "deleted_at": null,
            "main_name": "UNC2452",
            "aliases": [
                "UNC2452",
                "NOBELIUM",
                "StellarParticle",
                "Dark Halo"
            ],
            "source_name": "MITRE:UNC2452",
            "tools": [
                "Sibot",
                "Mimikatz",
                "Cobalt Strike",
                "AdFind",
                "GoldMax"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "a241a1ca-2bc9-450b-a07b-aae747ee2710",
            "created_at": "2024-06-19T02:03:08.150052Z",
            "updated_at": "2025-03-27T02:05:17.409596Z",
            "deleted_at": null,
            "main_name": "IRON RITUAL",
            "aliases": [
                "Blue Dev 5 ",
                "BlueBravo ",
                "Cloaked Ursa ",
                "CozyLarch ",
                "Dark Halo ",
                "Midnight Blizzard ",
                "NOBELIUM ",
                "StellarParticle ",
                "UNC2452 ",
                "APT29"
            ],
            "source_name": "Secureworks:IRON RITUAL",
            "tools": [
                " Cobalt Strike",
                " EnvyScout",
                " GoldFinder",
                " GoldMax",
                " NativeZone",
                " RAINDROP",
                " SUNBURST",
                " Sibot",
                " TEARDROP",
                " VaporRage",
                "Brute Ratel C4"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "20d3a08a-3b97-4b2f-90b8-92a89089a57a",
            "created_at": "2022-10-25T15:50:23.548494Z",
            "updated_at": "2025-03-27T02:00:55.49688Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "APT29",
                "IRON RITUAL",
                "IRON HEMLOCK",
                "NobleBaron",
                "Dark Halo",
                "NOBELIUM",
                "UNC2452",
                "YTTRIUM",
                "The Dukes",
                "Cozy Bear",
                "CozyDuke",
                "SolarStorm",
                "Blue Kitsune",
                "UNC3524",
                "Midnight Blizzard"
            ],
            "source_name": "MITRE:APT29",
            "tools": [
                "PinchDuke",
                "ROADTools",
                "WellMail",
                "CozyCar",
                "Mimikatz",
                "Tasklist",
                "OnionDuke",
                "FatDuke",
                "POSHSPY",
                "EnvyScout",
                "SoreFang",
                "GeminiDuke",
                "GoldMax",
                "FoggyWeb",
                "SDelete",
                "PolyglotDuke",
                "AADInternals",
                "MiniDuke",
                "SeaDuke",
                "Sibot",
                "RegDuke",
                "CloudDuke",
                "GoldFinder",
                "AdFind",
                "PsExec",
                "NativeZone",
                "Systeminfo",
                "ipconfig",
                "Impacket",
                "Cobalt Strike",
                "PowerDuke",
                "QUIETEXIT",
                "HAMMERTOSS",
                "BoomBox",
                "CosmicDuke",
                "WellMess",
                "VaporRage",
                "LiteDuke"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f27790ff-4ee0-40a5-9c84-2b523a9d3270",
            "created_at": "2022-10-25T16:07:23.341684Z",
            "updated_at": "2025-03-27T02:02:09.74554Z",
            "deleted_at": null,
            "main_name": "APT 29",
            "aliases": [
                "APT 29",
                "ATK 7",
                "Blue Dev 5",
                "BlueBravo",
                "Cloaked Ursa",
                "CloudLook",
                "Cozy Bear",
                "Dark Halo",
                "Earth Koshchei",
                "Grizzly Steppe",
                "Group 100",
                "ITG11",
                "Iron Hemlock",
                "Iron Ritual",
                "Midnight Blizzard",
                "Minidionis",
                "Nobelium",
                "NobleBaron",
                "Operation Ghost",
                "Operation Office monkeys",
                "Operation StellarParticle",
                "SilverFish",
                "Solar Phoenix",
                "SolarStorm",
                "StellarParticle",
                "TEMP.Monkeys",
                "The Dukes",
                "UNC2452",
                "UNC3524",
                "Yttrium"
            ],
            "source_name": "ETDA:APT 29",
            "tools": [
                "7-Zip",
                "ATI-Agent",
                "AdFind",
                "Agentemis",
                "AtNow",
                "BEATDROP",
                "BotgenStudios",
                "CEELOADER",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobalt Strike",
                "CobaltStrike",
                "CosmicDuke",
                "Cozer",
                "CozyBear",
                "CozyCar",
                "CozyDuke",
                "Danfuan",
                "EnvyScout",
                "EuroAPT",
                "FatDuke",
                "FoggyWeb",
                "GeminiDuke",
                "Geppei",
                "GoldFinder",
                "GoldMax",
                "GraphDrop",
                "GraphicalNeutrino",
                "GraphicalProton",
                "HAMMERTOSS",
                "HammerDuke",
                "LOLBAS",
                "LOLBins",
                "LiteDuke",
                "Living off the Land",
                "MagicWeb",
                "Mimikatz",
                "MiniDionis",
                "MiniDuke",
                "NemesisGemina",
                "NetDuke",
                "OnionDuke",
                "POSHSPY",
                "PinchDuke",
                "PolyglotDuke",
                "PowerDuke",
                "QUIETEXIT",
                "ROOTSAW",
                "RegDuke",
                "Rubeus",
                "SNOWYAMBER",
                "SPICYBEAT",
                "SUNSHUTTLE",
                "SeaDaddy",
                "SeaDask",
                "SeaDesk",
                "SeaDuke",
                "Sharp-SMBExec",
                "SharpView",
                "Sibot",
                "Solorigate",
                "SoreFang",
                "TinyBaron",
                "WINELOADER",
                "WellMail",
                "WellMess",
                "cobeacon",
                "elf.wellmess",
                "reGeorg",
                "tDiscoverer"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535717,
    "ts_updated_at": 1743041795,
    "ts_creation_date": 1653786360,
    "ts_modification_date": 1653786360,
    "files": {
        "pdf": "https://archive.orkl.eu/9ef8f1665c6cf3f55c54ee0ef30e032cd42033c1.pdf",
        "text": "https://archive.orkl.eu/9ef8f1665c6cf3f55c54ee0ef30e032cd42033c1.txt",
        "img": "https://archive.orkl.eu/9ef8f1665c6cf3f55c54ee0ef30e032cd42033c1.jpg"
    }
}