{
    "id": "e568ae56-0de5-40cf-98ed-ed15b61f5ab9",
    "created_at": "2023-01-12T15:01:45.438806Z",
    "updated_at": "2025-03-27T02:17:15.059695Z",
    "deleted_at": null,
    "sha1_hash": "65d2804cc25087bd2e47d646b415cafa4d2b3225",
    "title": "2020-10-28 - Operation Earth Kitsune- A Dance of Two New Backdoors",
    "authors": "",
    "file_creation_date": "2022-05-28T19:03:34Z",
    "file_modification_date": "2022-05-28T19:03:34Z",
    "file_size": 1994583,
    "plain_text": "# Operation Earth Kitsune: A Dance of Two New Backdoors\n\n**[trendmicro.com/en_us/research/20/j/operation-earth-kitsune-a-dance-of-two-new-backdoors.html](https://www.trendmicro.com/en_us/research/20/j/operation-earth-kitsune-a-dance-of-two-new-backdoors.html)**\n\nCyber Threats\n\n\nOctober 28, 2020\n\n\nWe uncovered two new espionage backdoors associated with Operation Earth Kitsune: agfSpy and dneSpy. This post provides details about\nthese malware types, including the relationship between them and their command and control (C&C) servers\n\nBy: William Gamazo Sanchez, Aliakbar Zahravi, Elliot Cao, Cedric Pernet, Daniel Lunghi, Jaromir Horejsi, Joseph C Chen, John Zhang\nOctober 28, 2020 Read time: ( words)\n\n[We recently published a research paper on Operation Earth Kitsune, a watering hole campaign aiming to steal information by compromising](https://www.trendmicro.com/vinfo/tmr/?/us/security/news/cyber-attacks/operation-earth-kitsune-tracking-slub-s-current-operations)\nwebsites. Besides its heavy use of SLUB malware, we also uncovered two new espionage backdoors associated with the campaign: agfSpy\nand dneSpy, dubbed as such following the attackers’ three-letter naming scheme.\n\nOur previous research on the operation found that, while SLUB was primarily used to exfiltrate data, agfSpy and dneSpy were employed for\nthe same purpose but also for seizing control of affected systems. This post provides more details about these malware types, including the\nrelation between them and their command and control (C&C) servers.\n\nFigure 1 shows how agfSpy and dneSpy are used in the attacks. We were able to identify five C&C servers communicating and providing\ninstructions to the espionage backdoors.\n\n\n-----\n\nFigure 1. Overview of the attack\n\n## DneSpy and agfSpy’s C&C servers\n\nThe campaign used inexpensive external resources located in several countries. The attackers set up services using budget service providers\nfor the different samples. Table 1 shows how the C&C servers are distributed. It also shows that all the registered domains are using the “noip.com” registration service. Note that these are legitimate services that have been abused by the threat actors behind the operation.\n\n\n-----\n\n**Sample** **Domain** **IP** **Provider** **Presumed Location**\n\n\nShellcode\n\nDropper.dll\n\n\nrs[.]myftp[.]biz 37.120.145.235 hxxps://m247[.]com/ Denmark\n\n\nagfSpy agf[.]zapto[.]org 2.56.213.162 hxxps://www[.]mvps[.]net/ Netherlands\n\nagfSpy selectorioi[.]ddns[.]net 193.142.59.196 https://hostslick[.]com/ Netherlands\n\n89.38.225.241 hxxps://m247[.]com/ Singapore\n\n\ndneSpy whoami2[.]ddns[.]net 37.120.145.235\n\n(same as shellcode)\n\n\nhxxps://m247[.]com/ Denmark\n\n\ndneSpy whoamimaster[.]ddns[.]net 93.115.23.193 hxxps://www[.]mvps[.]net/ Sweden\n\nSLUB (mm) 185.234.52.129 hxxps://www[.]mvps[.]net/ Greece\n\nTable 1. Discovered C&C servers\n\nDneSpy used a dynamic C&C discovery mechanism that first connects to whoami2[.]ddns[.]net then receives information about the master\nserver whoamimaster[.]ddns[.]net.\n\nAs a part of its deployment, dneSpy also delivers agfSpy, as shown in Figure 2.\n\n\n-----\n\nFigure 2. How dneSpy delivers agfSpy\n[This scheme shows why dneSpy first checks, using the CreateMutex technique, if agfSpy is already installed on the system. With this](http://www.cs.rpi.edu/courses/fall01/os/CreateMutex)\narchitecture, the attacker is looking to have a certain level of resiliency during deployment — even when agfSpy was already delivered as part\nof the initial vector, the attacker tries it again. For these two backdoors, the saying \"it takes two to tango\" applies, as the pair acts as partners in\nthis \"dance.\"\n\n## DneSpy espionage backdoor\n\nDneSpy collects information, takes screenshots, and downloads and executes the latest version of other malicious components in the infected\nsystem. The malware is designed to receive a “policy” file in JSON format with all the commands to execute. The policy file sent by the C&C\nserver can be changed and updated over time, making dneSpy flexible and well-designed. The output of each executed command is zipped,\nencrypted, and exfiltrated to the C&C server. These characteristics make dneSpy a fully functional espionage backdoor.\n\n## DneSpy C&C communication\n\nUpon execution, dneSpy generates a unique ID for its victim based on the system parameters by executing the command shown in Figure 3.\n\nFigure 3. Victim ID identification parameters\n\nFrom the full output of the command (full text) in Figure 3, a 4-byte hash is created and concatenated with the computer name to form an ‘id’\nparameter in the communication requests with the C&C server. The generated unique victim ID is then used to track unique first-time\ninfections, and the C&C server makes decisions based on that. Figure 4 shows a Python implementation of the algorithm generating the\ncustom 4-byte hash.\n\n\n-----\n\nFigure 4. Algorithm for computing a custom 4-byte hash\n\nBefore sending the request, C&C server details are decoded first. DneSpy uses multiple obfuscation string mechanisms in the same binary,\nsometimes using either XOR encryption or ROT cipher. In the case of the C&C URL path, it uses ROT, as seen in Figure 5.\n\nFigure 5. Deobfuscation of C&C parameters using ROT\n\nDneSpy then creates a directory or account on the C&C server to register a new victim. The first request, shown in Figure 6, has the format of\nthe victim ID: CC669737_WIN-RSG1AKRI2C4.\n\nFigure 6. dneSpy’s first request\n\nOne interesting aspect of dneSpy’s design is its C&C pivoting behavior. The central C&C server's response is actually the next-stage C&C\nserver's domain/IP, which dneSpy has to communicate with to receive further instructions.\n\n\n-----\n\nFigure 7. Dynamic C&C server selection\nThe pivoting design suggests that the malware can be used as a service where the actual samples are distributed to collect information for a\nselected C&C server on demand.\n\nThe dneSpy C&C server uses HTTP with the HTTP data body encrypted with AES CBC cipher. The dneSpy binary needs to receive a\ncommand-line parameter when it is launched. Figure 8 shows an example.\n\nFigure 8. dneSpy parameters\n\nThe parameter “helloworld” is used during the communication with the C&C server to decrypt the received data. Using the command line\nparameter and the first 16 bytes of the response from the server, which is actually the initialization vector for AES, the payload data (from the\n17th byte of the received blob) decrypts into a ZIP file. This ZIP archive contains an additional TXT file called “DNS_PROFILE,” which contains\na new domain name. Figure 9 shows the full process, starting from decrypting the first response from the central C&C server.\n\n\n-----\n\nFigure 9. The first response decryption process\nDuring the decryption and decompression process, multiple temporary files are created in the current user’s TEMP folder, as displayed in\nFigure 10.\n\nFigure 10. Decrypting the first request and getting the next C&C server\n\nOnce the new C&C URL name is received and decrypted, dneSpy constructs an HTTP POST request and sends it to the new C&C server.\nThe server then responds with an “Account Created!” message if everything is working properly. This is a way to authenticate the victim with\nthe pivoted C&C server and protect the C&C channel.\n\n\n-----\n\nFigure 11. Victim account created on the dynamically defined C&C server\n\nOnce the account is created on the current C&C server, dneSpy sends an HTTP GET request to receive the policy.txt file (with commands to\nbe executed) and further malware payloads.\n\nThe following section will detail the exfiltration mechanism and the data capture method used by this specific version.\n\n### Exfiltration mechanism\n\nDneSpy is very flexible in its design and dynamically receives instructions from a custom pivoted C&C server. We noticed at least two versions\nof its samples receiving different instructions. This section details one of them.\n\nFigure 12 shows the general sequence of steps dneSpy takes to exfiltrate the collected information to the pivoted new C&C server.\n\nFigure 12. Exfiltration\n\nmechanism\nDneSpy first sends an HTTP GET request to receive a “crypted_package“ to get the policy.txt file, as shown in Figure 13.\n\n\n-----\n\nFigure 13. Request for the “crypted_package”\n\nWhen dneSpy receives the response, a “crypted_package” file is created on the disk. The file is later decrypted to “crypted_package.zip,” as\nshown in Figure 14.\n\nFigure 14.\"crypted_package\" decryption\n\nAs we can see, the “crypted_package.zip” archive contains a file called “policy.txt,” which contains the commands to be executed by dneSpy.\nThe policy.txt file is in JSON format, as shown in Figure 15.\n\nFigure 15. dneSpy execution policy\n\nMultiple parameters, like “test” and “etc”, were not used. However, the “cmd” attribute has all the commands to be executed by dneSpy on the\nvictim’s machine. After execution, a custom 4-byte hash (same algorithm as the hash computing machine ID) is computed for each command\nfrom the policy.txt file's “cmd” attribute. This hash is then used as a file name to store the command result temporarily. This file is zipped,\nencrypted, and uploaded to the selected C&C server. The example in Figure 16 shows a list of files to be exfiltrated to the C&C server upon\ndneSpy execution.\n\nFigure 16. Temporary files on disk ready to be exfiltrated to the C&C\n\nThe exfiltration is implemented using an HTTP multipart request, as shown in Figure 17. All the temporary files are deleted after exfiltration.\n\n\n-----\n\nFigure 17. Exfiltrating HTTP POST request\n\nFinally, a screenshot is taken and uploaded together with the results of the executed commands.\n\nIf dneSpy runs for the second time while the victim is already registered, the central C&C server (which is responsible for giving a new pivoting\nC&C server) responds with a “Not regular victim!” message. Figure 18 shows an example of such a situation.\n\nFigure 18. C&C server responding with a \"Not regular victim!\" message\n\nAs mentioned earlier, dneSpy can drop agfSpy into infected systems. We found out that this is the same agfSpy sample as the one dropped in\n[the attacks described in the previous paper exploiting CVE-2019-5782,](https://www.trendmicro.com/vinfo/tmr/?/us/security/news/cyber-attacks/operation-earth-kitsune-tracking-slub-s-current-operations) [CVE-2020-0674, and](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-0674) [CVE-2019-1458 vulnerabilities. The next section](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-1458)\nprovides some details about this backdoor.\n\n## The agfSpy espionage backdoor\n\nThe agfSpy backdoor retrieves configuration and commands from its C&C server. These commands allow the backdoor to execute shell\ncommands and send the execution results back to the server. It also enumerates directories and can list, upload, download, and execute files,\namong other functions. The capabilities of agfSpy are very similar to dneSpy, except each backdoor uses a different C&C server and various\nformats in message exchanges.\n\n### AgfSpy C&C server communication\n\nAgfSpy only communicates with one C&C server; it does not have the pivoting capabilities that dneSpy has. However, we found at least two\ndifferent domains in several agfSpy samples while monitoring the current campaign.\n\nThe backdoor uses the same algorithm as the dneSpy backdoor to compute the environment identifier (“<Hash>_<computer name>”). It then\nsends the message with the ID (null-terminated) to its C&C server with the format, as seen in Figure 19:\n\nFigure 19. ID message\n\nFigure 20 shows an example of the ID message (in Hex dump) sent by the malware.\n\nFigure 20. ID\n\nmessage example\nThe code snippet in Figure 21 demonstrates how the malware performs the aforementioned operations:\n\n\n-----\n\nFigure 21. Code snippets for sending ID message\n\nThe malware then receives a table from its C&C server. The table is used to prevent the backdoor from uploading old and unwanted files, and\ncontains the flags of either uploaded or unwanted files.\n\nIf the server receives an uploaded file, it sets a flag in the table based on the file's path and timestamp. The server will send the table to the\nmalware. Before the malware uploads a file to the infected system, it will check if there is a flag for the file in the table by computing its path\nand timestamp. If so, it will not upload the file to the server.\n\nFigure 22 shows an example of the uploading table message sent by the malware (shown in Hex dump).\n\nFigure 22. Uploading\n\ntable message example\nAfter this, the malware receives the encrypted JSON message from its C&C server to get commands. The server response has the format\nseen in Figure 23:\n\nFigure 23. Command message from the server\nAll payloads between the malware and the C&C server are encrypted by a simple XOR encryption with the multi-byte key. The encrypted blob\nis then prepended with a 2-byte marker \"SC\", followed by a 4-byte payload length.\n\nThe backdoor receives the commands from the server and executes them on the infected system. It then returns the result/error/status\nmessages to the server.\n\nAfter executing the commands from the server, the malware sends an \"END\" message (null-terminated) to the server, as shown in Figure 24.\n\n\n-----\n\nFigure 24. The “END” message sent to the\n\nserver\n\n### AgfSpy supported commands\n\nAgfSpy expects the commands to be in JSON form. It implements the following attributes and commands:\n\n**Commands** **Description**\n\ninterval time The delay between two consecutive requests to the C&C server (3600 seconds by default)\n\nfilepaths Upload files with the desired maximum file size\n\ndirpaths Upload files in the directory with desired extensions, age, and maximal file size. Maximum of 2000 files per batch\n\nexecpaths Download and execute\n\nsearchdir Enumerate directories and files\n\nextensions File extensions used in the upload\n\ncmd Run commands via command line\n\nmaxfilesize Maximal upload file size (1MB by default)\n\ndate Only newer files than the given date will be uploaded\n\ntotalfilesize Maximal size of all files to be uploaded (4GB by default)\n\nTable 2. List of commands implemented by agfSpy\n\nThe commands in Table 2 imply that this backdoor is mainly used to exfiltrate interesting files as it implements various file searching and\nuploading functions.\n\nThe examples of received commands are shown in Figure 25. The initial commands are used for basic system information collection. The\nstolen and uploaded extensions are document files.\n\nFigure 25: Commands received from C&C server\n\nWhen agfSpy receives the “cmd” command from the server, it retrieves the list of shell commands from the JSON message (e.g., \"systeminfo,\"\n\"net share,\" \"netstat –an,\" \"arp –a,\" and \"ipconfig -all\"). For each shell command, the malware creates a process with two pipes to execute the\nshell command. One pipe is created to read the standard output (stdout) of the process to obtain the shell command's output. The other pipe is\nused to read the standard error (stderr) of the process to obtain the error message. After executing the shell command (e.g., systeminfo), it\nsends the message containing the command, which is executed back to the server, as seen in Figure 26.\n\nFigure 26. Systeminfo command message\n\nIt then sends the output of the executed command back to the server, as shown in Figure 27.\n\nFigure 27. Output message of systeminfo command\n\n\n-----\n\not d eSpy a d ag Spy a e tte C a d use t e sta da d std b a y St gs a e usua y sto ed a e c ypted o oca a ab es,\nthen decrypted in a simple loop by utilizing XOR or SUB instructions applied to each of their bytes.\n\nFigure 28. C&C URL address stored in encrypted form (the DO WHILE loop is used for string decryption)\n\n## Conclusion\n\nDneSpy and agfSpy are fully functional espionage backdoors, and while they use different C&C server mechanisms, they have many things in\ncommon. Multiple tactics and procedures are implemented to give the infrastructure versatility and resiliency in its behavior.\n\nOperation Earth Kitsune turned out to be complex and prolific, thanks to the variety of components it uses and the interactions between them.\nThe campaign’s use of new samples to avoid detection by security products is also quite notable. From the Chrome exploit shellcode to the\nagfSpy, elements in the operation are custom coded, indicating that there is a group behind this operation. This group seems to be highly\nactive this year, and we predict that they will continue going in this direction for some time.\n\nWe recommend using a multilayered security approach that can detect and block such complex threats from infiltrating the system through\n[endpoints,](https://www.trendmicro.com/en_us/business/products/user-protection/sps/endpoint.html) [servers,](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/deep-security.html) [networks, and](https://www.trendmicro.com/en_us/business/products/network/advanced-threat-protection/inspector.html) [emails.](https://www.trendmicro.com/en_us/business/products/user-protection/sps/email-and-collaboration/email-security.html)\n\n**Indicators of Compromise**\n\n**Filename** **SHA-256** **Trend Micro Pattern**\n\n\nhappy.jpg\n\n20200209122021_qifxyren.jpg\n\nsad.jpg\n\n20200209122021_abjeuitk.jpg\n\n\nF28876A7F162FF9CDD608F07EE45F8E9211DA4304B3602152D0386CEEAC82442 TrojanSpy.Win32.DNE\n\n15D80E616B6B5FEC3CFA0EEED5AC9037F34C4547AE27F5DFCAA5475501DE4B95 TrojanSpy.Win32.AGF\n\n\n20200209122021_abjeuitk.jpg 8304FCCCAF18546CAF94851C63DC8293EAF8DE575AB442D4419AA9ED29EA8614 TrojanSpy.Win32.AGF\n\n**URLs**\n\nwhoami2[.]ddns[.]net dneSpy C2 domain\n\nwhoamimaster[.]ddns[.]net dneSpy C2 domain\n\nselectorioi[.]ddns[.]net agfSpy C2 domain\n\nagf[.]zapto[.]org agfSpy C2 domain\n\nrs[.]myftp[.]biz Shellcode C2 domain\n\n[Trend Micro™ Deep Security™ protects users from exploits that target several vulnerabilities related to Operation Earth Kitsune via the](https://www.trendmicro.com/en_us/business/products/hybrid-cloud/deep-security.html)\nfollowing rules:\n\n\n-----\n\n0 05 G U oa d SQ ject o u e ab ty ( 9 )\n1005613 - Generic SQL Injection Prevention – 2\n1005933 - Identified Directory Traversal Sequence In Uri Query Parameter\n1010542 - GNUBoard 'tb.php' SQL Injection Vulnerability (CVE-2011-4066)\n1010543 - GNUBoard 'ajax.autosave.php' SQL Injection Vulnerability (CVE-2014-2339)\n1010545 - GNUBoard Local File Inclusion Vulnerability (EDB-ID-7927)\n1010546 - GNUBoard Local/Remote File Include Vulnerability (CVE-2009-0290)\n1010547 - GNUBoard Remote Code Execution Vulnerability (KVE-2018-0449 and KVE-2018-0441)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-10-28 - Operation Earth Kitsune- A Dance of Two New Backdoors.pdf"
    ],
    "report_names": [
        "2020-10-28 - Operation Earth Kitsune- A Dance of Two New Backdoors.pdf"
    ],
    "threat_actors": [
        {
            "id": "6158a31d-091c-4a5a-a82b-938e3d0b0e87",
            "created_at": "2023-11-17T02:00:07.61151Z",
            "updated_at": "2025-03-27T02:00:03.235865Z",
            "deleted_at": null,
            "main_name": "Earth Kitsune",
            "aliases": [],
            "source_name": "MISPGALAXY:Earth Kitsune",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3f6650a3-9f50-47c4-bd7a-008b63bde191",
            "created_at": "2022-10-25T16:07:23.949232Z",
            "updated_at": "2025-03-27T02:02:10.044899Z",
            "deleted_at": null,
            "main_name": "Operation Earth Kitsune",
            "aliases": [],
            "source_name": "ETDA:Operation Earth Kitsune",
            "tools": [
                "SLUB",
                "WhiskerSpy",
                "agfSpy",
                "dneSpy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535705,
    "ts_updated_at": 1743041835,
    "ts_creation_date": 1653764614,
    "ts_modification_date": 1653764614,
    "files": {
        "pdf": "https://archive.orkl.eu/65d2804cc25087bd2e47d646b415cafa4d2b3225.pdf",
        "text": "https://archive.orkl.eu/65d2804cc25087bd2e47d646b415cafa4d2b3225.txt",
        "img": "https://archive.orkl.eu/65d2804cc25087bd2e47d646b415cafa4d2b3225.jpg"
    }
}