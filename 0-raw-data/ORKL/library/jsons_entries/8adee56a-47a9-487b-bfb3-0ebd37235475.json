{
    "id": "8adee56a-47a9-487b-bfb3-0ebd37235475",
    "created_at": "2023-04-05T02:08:17.444023Z",
    "updated_at": "2025-03-27T02:05:40.636988Z",
    "deleted_at": null,
    "sha1_hash": "679ff64fafed108a6f7a0ea1030df632386c7587",
    "title": "2023-03-28 - Tofsee Botnet- Proxying and Mining",
    "authors": "",
    "file_creation_date": "2023-04-03T08:57:15Z",
    "file_modification_date": "2023-04-03T08:57:15Z",
    "file_size": 884517,
    "plain_text": "# Tofsee Botnet: Proxying and Mining\n\n**bitsight.com/blog/tofsee-botnet-proxying-and-mining**\n\nWritten by André Tavares\nMarch 27, 2023\nShare\nFacebook\nTwitter\nLinkedIn\n\n## Key findings\n\nBitSight has recently observed a 15-year-old modular spambot called Tofsee being\ndistributed by PrivateLoader (ruzki), a notorious malware distribution service we also\nclosely monitor.\nBitSight has noticed Tofsee engaging in web traffic proxying, with a small percentage of\nit being email spam related traffic, and also performing cryptocurrency mining.\nBitSight's partial visibility over its botnet of infected machines suggests that its spread\nworldwide, with a significant percentage of infections in India.\n\n## Old bot, new tricks (not really)\n\n[In January 2023, PrivateLoader, a malware loader from a pay-per-install malware distribution](https://www.bitsight.com/blog/tracking-privateloader-malware-distribution-service)\n[service called “ruzki”, started to](https://blog.sekoia.io/privateloader-the-loader-of-the-prevalent-ruzki-ppi-service/#h-ruzki-a-popular-pay-per-install-service) [distribute Tofsee (a.k.a. Gheg), a modular spambot.](https://urlhaus.abuse.ch/url/2513471/)\nSpambots are typically utilized by cybercriminals to spread malware and phishing emails,\n[and this particular one has been in operation since at least 2008. Due to its modular](https://web.archive.org/web/20090428005953/http://www.marshal8e6.com/trace/i/Gheg,spambot.897~.asp)\narchitecture, Tofsee is capable of performing a wide range of tasks once it receives\n[instructions to do so (as it did in the past), such as denial of service attacks and](https://www.f5.com/company/blog/f5-distributed-cloud-services-stands-up-to-l7-ddos-attacks) [click fraud.](https://blog.talosintelligence.com/tofsee-spam/)\n\n\n-----\n\n[The samples are packed but can be easily unpacked. Unpacking denotes the last stage in](https://www.unpac.me/results/f70671d9-2ffe-4d3f-b992-86bb7aa3c3a5/#/)\nwhich the main functionality of the malicious software is exposed. Threat Actors make use of\npackers when distributing their malware as they remain an effective way to evade detection.\n\nAs [revealed by CERT.pl, the malware downloads two types of resources (updates) from its](https://cert.pl/en/posts/2016/09/tofsee-en/)\n[command-and-control (C2) server: configurations, and plugins to extend its functionality.](https://cert.pl/en/posts/2017/10/a-deeper-look-at-tofsee-modules/)\nAfter trying to decrypt the packet capture from a sandbox run of the sample to understand\nwhat resources have recently been fetched, we were getting high entropy data, signaling that\nsomething on the protocol may have changed. One of the first guesses was that the\nhardcoded 7-byte-lowercase-only-letters encryption key “abcdefg” might have changed.\n\nTo understand if that was the case, we tried to search for the key on the binary, but couldn’t\nfind it. Going deeper, statically analyzing the sample using a disassembler, right on the main\nfunction, one of the first functions called (Fig. 1) looks like a string decryption function and is\ncalled 67 times throughout the code. After implementing it in python and testing one of the\ncalls to it, a plaintext string is indeed returned.\n\nFigure 1 - Tofsee string decryption function.\n\n\n-----\n\nAfter a while looking through the binary, trying to find code related to the communication\nprotocol, eventually we found and decrypted another 7-byte-lowercase-only-letters string,\n“qazwsxed”. This one gives low entropy data (many null bytes for example). With this\nknowledge, we could decrypt 28 resources downloaded by the malware once it starts\nrunning (Table 1). Some resources were compressed and so we had to find and reverse the\n[decompression algorithm used.](https://gist.github.com/andretavares-bitsight/624481252bae5dc770d72ba42630ca1b)\n\n**Configs** **Plugins**\n\n\nblist_cfg\n\nblist_doms\n\nblist_ips\n\nID4011378458\n\n**miner_cfg**\n\nport_cfg\n\npriority\n\n**proxy_cfg**\n\nps_otlups_hm\n\nps_otlups_ya\n\npsmtp_cfg\n\nRT_1\n\nRT_2\n\nRT_AD\n\nsmtp_ban\n\nsmtp_herr\n\nsmtp_retr\n\nstart_srv\nsys_cfg\n\ntime_cfg\n\nwork_srv\n\n\nblist.dll (Am I blocklisted?)\n\n**miner.dll**\n\nsys.dll (updater)\n\n**proxyR.dll**\n\nsmtp.dll\n\ntext.dll (process email templates)\n\nxmrcpu.exe\n\n\nTable 1 - Resources downloaded by Tofsee.\nThe “proxyR” and “miner” plugins were the only ones that had network activity. The “smtp”\nplugin needs extra configurations to be able to generate and send spam, specifically\nresources of type 7 (general purpose macros), 8 (local macros), and 11 (template scripts),\nwhich we never encountered in a two month period.\n\n## Proxying web traffic\n\nRegarding the proxy plugin, we extracted a configuration payload (Code 1) with 6 IPs located\nin Russia. Looking at the same packet capture previously mentioned, after trying to decrypt\nthe TCP streams related to those IPs, we were again getting high entropy data. Looking at\nthe proxy plugin DLL, there is yet another 7-byte-lowercase-only-letters string, “prcbsrv”.\nAfter decrypting the packets with it, the streams revealed HTTP(S) and SOCKS(4/5)\n\n\n-----\n\nrequests sent from those IPs to the bot, which leads us to believe those are addresses of\nbackconnect servers. A backconnect proxy server is a server that utilizes a pool of proxies\n(in this case, the Tofsee botnet) to perform requests on behalf of the user.\n\nCode 1 - Configuration for the proxy plugin (proxy_cfg).\nMost of the traffic is over HTTPS to popular websites, including several Russian ones.\nFigure 2 lists the top hostnames contacted by the bot.\n\nFigure 2 - Most requested HOST:PORT pairs.\nWhile looking through the traffic, we spotted an interesting pattern. Around 3% of the\nrequests were HTTP POST with the URI ending in “.php” and, in many cases, starting with\n“/wp-”, to random websites that appear legitimate. Each request’s payload starts with the\nstring “ce=” followed by a base64-encoded spam template (similar to Code 2). The response\nto the request usually was a 200 OK with “*send:ok*” as payload. These indicators lead us\nto believe that these (apparently) legitimate websites have been likely compromised to be\nused to distribute spam.\n\nem=<REDACTED>@aol.com,<REDACTED>@icloud.com,<REDACTED>@hotmail.com,\n<REDACTED>@yahoo.com,<REDACTED>@micromedint.com,\n<REDACTED>@hotmail.com,<REDACTED>@yahoo.com.hk,<REDACTED>@hotmail.com,\n<REDACTED>@sfr.fr,<REDACTED>@msn.com,<REDACTED>@yahoo.com,\n<REDACTED>@yahoo.com,<REDACTED>@comcast.net,<REDACTED>@aol.com,\n<REDACTED>@sfr.fr,<REDACTED>@yahoo.fr,<REDACTED>@yahoo.com,\n\n\n-----\n\n<REDACTED>@msn.com,<REDACTED>@aol.com,<REDACTED>@hotmail.com,\n<REDACTED>@gmail.com,<REDACTED>@yahoo.com,<REDACTED>@comcast.net,\n<REDACTED>@aol.com,<REDACTED>@hotmail.com,<REDACTED>@yahoo.com,\n<REDACTED>@hotmail.fr,<REDACTED>@hotmail.com,<REDACTED>@hotmail.com,\n<REDACTED>@hotmail.com,<REDACTED>@sfr.fr,<REDACTED>@free.fr,\n<REDACTED>@hotmail.com,<REDACTED>@hotmail.com,<REDACTED>@hotmail.com,\n<REDACTED>@yahoo.com,<REDACTED>@hotmail.com,<REDACTED>@comcast.net,\n<REDACTED>@libero.it,<REDACTED>@hotmail.it,<REDACTED>@sunrise.ch,\n<REDACTED>@aol.com,<REDACTED>@hotmail.com,<REDACTED>@hotmail.it,\n<REDACTED>@hotmail.com,<REDACTED>@hotmail.co.uk,<REDACTED>@hotmail.com,\n<REDACTED>@aol.com,<REDACTED>@bellsouth.net,<REDACTED>@yahoo.com,\n<REDACTED>@hotmail.com,<REDACTED>@gmail.com,<REDACTED>@yahoo.com,\n<REDACTED>@aol.com,<REDACTED>@orange.fr,<REDACTED>@gmail.com,\n<REDACTED>@yahoo.com,<REDACTED>@yahoo.com,<REDACTED>@aol.com,\n<REDACTED>@fuse.net,<REDACTED>@aol.com,<REDACTED>@olguin.cc,\n<REDACTED>@hotmail.fr,<REDACTED>@aol.com,<REDACTED>@live.com,\n<REDACTED>@yahoo.co.uk,<REDACTED>@planet.nl,<REDACTED>@aol.com,\n<REDACTED>@aol.com,<REDACTED>@aol.com,<REDACTED>@yahoo.com,\n<REDACTED>@yahoo.com,<REDACTED>@att.net,<REDACTED>@yahoo.com,\n<REDACTED>@gmail.com,<REDACTED>@gmx.de,<REDACTED>@aol.com,\n<REDACTED>@hotmail.com,<REDACTED>@gmail.com,<REDACTED>@hotmail.com,\n<REDACTED>@yahoo.com&s=Product of the day&f={rand:24x7 Pharmacy|Pharmacy\n24x7|Pharmacy USA|USA Pharmacy} - {rand:Final Price|Super Deals|Best\nDeals|Discounter}&sn=1&rpt=&tp=1&m=<html lang=\"en\">\n\n<head><meta name=\"viewport\" content=\"width=device-width\" /><meta http-equiv=\"ContentType\" content=\"text/html; charset=UTF-8\" /></head><body><br>Good morning. How are you\nmy dear.<br><br>\n\nNoone will stay indifferent! Get Dream's Pills here.<br><br>\n\n<a href=\"https://ajwhvdhk.page.link/NiG75YhjQHn1sYXXA\">CLICK HERE TO ORDER\nNOW<br><br><br><br><br></a></body></html>\n\nCode 2 - Spam template sent to a (most likely) compromised website.\nAnother 3% of the traffic was SMTP(S) spam traffic which can be categorized as \"romance\nscam\" or \"dating scam”, which included photo attachments of the supposed sender. In short,\nall spam activity was done exclusively through the proxy module. Regarding the “smtp”\nplugin, although it’s still being sent to the bots, we haven’t seen any activity from it so far.\n\n## Mining Masari\n\n\n-----\n\nRegarding the miner plugin, we extracted a configuration payload (Code 3) containing some\nURLs. None seem to work, except “fastpool.xyz”, and the references for them on Google\nare old.\n\nCode 3 - Configuration for the miner plugin (miner_cfg).\nMoreover, there’s only activity to “fastpool.xyz:10060”, which is a mining pool for Masari\n(MSR), a privacy-focused cryptocurrency that aims to provide secure, private, and\nuntraceable transactions (Fig. 3)\n\nFigure 3 - MSR mining pool documentation\nThe mining pool website has some statistics on the botnet’s mining work (Fig. 4). In total so\nfar, to this address, Tofsee botnet was able to mine ~200 000 MSR, which currently\ncorresponds to ~1500$. By searching for the wallet address on Google, the first reference is\nfrom [June 2022.](https://vms.drweb.ru/virus/?i=25197704)\n\n\n-----\n\nFigure 4 - MSR mining pool documentation\n\n## Tracking the botnet\n\nBitsight's partial visibility over the geographical distribution of the Tofsee botnet in March\n2023 suggests that it’s present worldwide, with a significant percentage of infections in India\n(33%), as Figure 5 shows.\n\nFigure 5 - Approximation of Tofsee botnet distribution in March 2023.\nThe data used to populate this map is sampled, which means that the actual geographical\ndistribution of Tofsee may be closer to this one but not exactly what this map suggests.\n\n## Wrap-up\n\nTofsee remains a persistent threat to organizations worldwide, with its primary focus recently\nbeing the proxying of web traffic and cryptocurrency mining. However, its modular design\nalso allows for it to be used for a variety of other malicious activities, including spam\ncampaigns and distributed denial of service (DDoS) attacks, as seen in the past. As such, it\nis crucial for organizations to remain vigilant in their cybersecurity efforts and take steps to\nmitigate the risk of Tofsee infection. BitSight will continue to monitor the threat landscape\nclosely and provide updates on new developments related to Tofsee and other emerging\nthreats.\n\n\n-----\n\n## IOCs & Signatures\n\n[All indicators of compromise and detection signatures can be found here.](https://github.com/bitsight-research/threat_research/tree/main/tofsee)\n\n### Tofsee malware/bot/core sample unpacked:\n\n96baba74a907890b995f23c7db21568f7bfb5dbf417ed90ca311482b99702b72\n\n### YARA rule:\n\nThe unpacked binary contains a lot of interesting plaintext strings that can be used to write a\nYARA rule to detect the malware. This following 7-year-old rule that does the job well:\n\n### String decryption function in Python:\n\n Suricata rule:\n\nThe following suricata rules detect the malware communicating with its C2 server:\n\nNote: Both rules need to trigger in order for an alert to be generated.\n\nMore at [https://github.com/bitsight-research/threat_research](https://github.com/bitsight-research/threat_research/tree/main/tofsee)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-28 - Tofsee Botnet- Proxying and Mining.pdf"
    ],
    "report_names": [
        "2023-03-28 - Tofsee Botnet- Proxying and Mining.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1680660497,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1680512235,
    "ts_modification_date": 1680512235,
    "files": {
        "pdf": "https://archive.orkl.eu/679ff64fafed108a6f7a0ea1030df632386c7587.pdf",
        "text": "https://archive.orkl.eu/679ff64fafed108a6f7a0ea1030df632386c7587.txt",
        "img": "https://archive.orkl.eu/679ff64fafed108a6f7a0ea1030df632386c7587.jpg"
    }
}