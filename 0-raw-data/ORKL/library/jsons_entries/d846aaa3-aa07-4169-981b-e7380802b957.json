{
    "id": "d846aaa3-aa07-4169-981b-e7380802b957",
    "created_at": "2023-01-12T15:01:02.442491Z",
    "updated_at": "2025-03-27T02:05:43.619839Z",
    "deleted_at": null,
    "sha1_hash": "1ec06a05a5c100280605be335649c65ff18a6976",
    "title": "2022-05-04 - Old Services, New Tricks- Cloud Metadata Abuse by UNC2903",
    "authors": "",
    "file_creation_date": "2022-05-28T19:10:01Z",
    "file_modification_date": "2022-05-28T19:10:01Z",
    "file_size": 7317428,
    "plain_text": "# Old Services, New Tricks: Cloud Metadata Abuse by UNC2903\n\n**[mandiant.com/resources/cloud-metadata-abuse-unc2903](https://www.mandiant.com/resources/cloud-metadata-abuse-unc2903)**\n\nSince July 2021, Mandiant identified exploitation of public-facing web applications by\nUNC2903 to harvest and abuse credentials using Amazon’s Instance Metadata Service\n(IMDS). Mandiant tracked access attempts by UNC2903 to access S3 buckets and additional\ncloud resources using the stolen credentials. This blog post covers how UNC2903 performed\nexploitation and IMDS abuse, as well as related best practices on cloud hardening\ntechniques.\n\nAlthough UNC2903 targeted Amazon Web Services (AWS) environments, many other cloud\nplatforms offer similar metadata services that could be at risk of similar attacks. Similar threat\nactor motives and operations are gaining prominence as enterprises continue their migration\nto cloud hosting services. This article also describes potential risks and considerations for\nsecurity and information technology teams using hosted services.\n\n## Timeline\n\nMandiant’s Incident Response, Intelligence, and Transformational Services teams collected\ninformation described in this blog post to help better detect, prevent, and respond to similar\nopportunistic intrusions. The following timeline describes UNC2903 activity performed during\ntheir earliest observed campaigns.\n\n\n-----\n\n[February 2021, CVE-2021-21311 was](https://advantage.mandiant.com/cve/vulnerability--5a1fbe9b-f51e-5cdb-8e5f-25681276b02f) [published describing vulnerable database](https://github.com/vrana/adminer/security/advisories/GHSA-x5r2-hj5c-8jx6)\nadministration software called Adminer\nFebruary 2021, proof-of-concept code (PoC) was published to show how to leverage\nthe exploit and obtain credentials in AWS applications hosting vulnerable versions\nJune 2021, UNC2903 exploited a server-side request forgery vulnerability, gaining\naccess to victim Amazon Web Services secret keys and subsequently steal data\n\nAlthough this blog post discusses a now patched version of Adminer software, any webapplication vulnerable to request forgery or remote code execution may also open avenues\nfor similar metadata service attacks.\n\n## Usage in the Wild and Evidence of Exploitation\n\n### The Threat Landscape for Cloud Metadata\n\nMandiant’s analysts identified recent upticks in the abuse and exploitation of services hosted\nin AWS and similar cloud platforms. The threats identified in campaigns carried out by\nUNC2903 were multi-phased attacks, which involved infrastructure scanning,\nreconnaissance and further abuse of the underlying abstraction layers offered by cloudhosted platforms. Once exploitation and abuse of the underlying systems occurred, stolen\ncredentials are leveraged for data exfiltration in other AWS services in the compromised\ntenant.\n\nNamely, for events leading up to UNC2903 stealing data, Mandiant’s [Incident Response](https://www.mandiant.com/services/incident-response)\nteam identified:\n\n1. Network scanning attempts on externally facing AWS web infrastructure hosting\n\nAdminer software\n2. Additional web navigation and reconnaissance performed, once infrastructure is\n\nidentified\n3. Attempts of multiple web application exploits which may exist on the hosted web server\n4. Further attempts indicative of manual exploitation and testing using the identified\n\nexploit\n\nGiven that the infrastructure is hosted within Amazon Web Services cloud, IMDS is an\nattractive target for threat actors like UNC2903. In UNC2903’s case, the threat actor was\nobserved targeting exploitable web applications which were also running IMDSv1. Amazon’s\nIMDSv1 permits web requests to a specialized URL against the link local IP address\n(169.254.169.254) which was designed to enhance internal service communication and\ntroubleshooting within the overall hosting platform. The retrievable metadata includes\ninformation to understand configuration, topology, and even obtain user role and\ncredentialing.\n\n\n-----\n\n[Amazon released IMDSv2 to add additional layers of protection and alerting through AWS](https://aws.amazon.com/blogs/security/defense-in-depth-open-firewalls-reverse-proxies-ssrf-vulnerabilities-ec2-instance-metadata-service/)\nsecurity features such as [GuardDuty. The way IMDSv2 remediates this type of attack is by a](https://aws.amazon.com/guardduty/)\nuser obtaining a token via a PUT from http://169.254.169[.]254/latest/api/token, then that\ntoken is used and repeated for all requests to the IMDS via a special header ( x-aws-ec2```\nmetadata-token ).\n\n```\nAlthough Amazon recommends implementing the IMDSv2 with GuardDuty enhancements,\nEC2 instances created by Amazon customers that instead use IMDSv1 may be at risk when\ncombined with also running unpatched vulnerable third party software. As the adoption of\ncloud technology expands, so does the threat surface and targeting for vulnerable web\ninfrastructure with underlying dated or deprecated metadata services with limited security\ncapabilities. The level of risk related to web application vulnerabilities should be evaluated\nand paired with the understanding that underlying metadata services in cloud environments\ncould increase the possibility of advanced or continued threats.\n\n### Clever Techniques, Some SSRF, and Easy Access\n\nMandiant has observed in campaigns that UNC2903 utilized a dedicated operational relay\nbox to perform web scanning and carry out exploitation and related IMDSv1 abuse. The\nthreat actor carries out a series of web scans and activity consistent with manual\nreconnaissance of the identified application prior to the attack. The attack observed by\nUNC2903 utilized a Server-Side Request Forgery (“SSRF”) vulnerability to return the\ntemporary access keys used for AWS S3 bucket storage access.\n\nFigure 1 provides the critical attack path identified during UNC2903 using CVE-2021-21311.\n\nFigure 1: UNC2903 attack leveraged CVE-2021-21311 and IMDSv1 abuse\n\n\n-----\n\nIn the observed campaign, UNC2903 utilized CVE-2021-21311 to perform the following\nattack:\n\nThreat actor hosts a web server on their operational relay box with a script configured\nto 301 redirect to http://169.254.169[.]254/latest/meta-data/iam/security-credentials/.\n\nFigure 2: Mandiant test environment\n\nNext, the threat actor navigates to the Adminer page versioned between 4.0.0 and\nbefore 4.7.9, of which they’re trying to perform the SSRF vulnerability.\n\nFigure 3: Adminer\n\nThe IP address and port for the operational relay box hosting the malicious redirection\nscript is typed into the victim Adminer’s server dialogue box, and the login button is\npressed.\n\n\n-----\n\nFigure 4: Exploiting Adminer\n\nThe victim server with Adminer is fooled into making a web request to the operational\nrelay box, then the victim server requests and follows the 301 redirect which completes\nthe SSRF.\n\nFigure 5: Web log\n\nThe victim server returns an error to the threat actor, but since the IMDS returns the\nresults from the service, the metadata credentials are displayed directly in the response\nin an error message.\n\n\n-----\n\nFigure 6: Credential theft\nNote that the while these steps do not reflect the exact threat actor commands used to\nperform an attack, this highlights the methods used by UNC2903. Since the attack involves\nexploitation and SSRF abuse through CVE-2021-21311, limited artifacts are available based\non default cloud-based system and tenant configurations.\n\n### Artifacts and Notable Observations\n\nMandiant Incident Response identified and collected artifacts of the related exploitation and\nIMDS abuse carried out by UNC2903. The activity recorded from initial scanning and\nexploitation, as well as the AWS metadata service and credential abuse may be subject to\nthe configuration of the hosted infrastructure and cloud logs available in the tenant. Without a\nsecurity operator’s keen eye on event logs, even with increased levels of logging enabled,\nsimilar attacks carried out by UNC2903—or other threat actors—may go undetected.\n\nSince the attack leverages an exploit of the Adminer PHP application page, the malicious\nnavigation and interaction may be easily overlooked by investigators. The activity identified is\ncharacteristically unique compared to some exploits which return a standard successful web\nresponse to the screen or within recorded event logs.\n\nThe few sources which evidenced the exploitation and abuse included:\n\nWeb access and error logs\nGuardDuty events\nVPC Flow Logs\nS3 Data and Access Events\n\nFigure 7 provides an example of the initial access and web application scanning activity\nidentified for the Adminer web page. Note that the web response shows a 302 redirect or\nother 403 error as the web response in the available log although the exploit was successful.\n\n\n-----\n\nFigure 7: Web access logs generated after a simulated attacker types in their server\ninformation and performs CVE-2021-21311\nFigure 8 provides an example of a VPC flow which represents the web server when the\nSSRF completes. Note that the victim server which made the outbound request is suspicious\nto an external IP address. However, the port could be configured to any desired, or more\ndiscrete, port chosen for an attack.\n\nFigure 8: AWS VPC flow logs noting that the simulated victim server made a web request\noutbound over a malicious port 1337\nFigure 9 provides an example of a GuardDuty event after credentials are stolen and\nleveraged. Note that GuardDuty in our testing alerted after data theft was complete from the\nS3 bucket.\n\n\n-----\n\nFigure 9: AWS GuardDuty event showing data theft from S3 using the stolen metadata\ncredential\n\n### Mission Completion and Future Implications\n\nFinal phases of attacks carried out by UNC2903, and similar threat actors, have involved\ndata exfiltration or interaction with the AWS tenant. The information stolen through\napplication exploitation and metadata service abuse could allow threat actors to manipulate\nor steal data from an organization’s cloud environments. Abuse of similar cloud-oriented\nmetadata services show how threat actors can further exploit environments beyond the\noriginal application targets. When architecting cloud services and solutions, configurations\nfor prevention and response should be evaluated and considered by the technology teams.\nLater, we cover potential strategies to mitigate, limit, and aid in unauthorized metadata\nservice usage detection.\n\n## Mandiant Intelligence Findings\n\n### Attribution\n\nUNC2903 is a group whose motivations are unknown and tracked by Mandiant since July\n2021. UNC2903 is opportunistic, hunting for vulnerable systems on the internet, and has\nbeen observed stealing data from at least one victim, however, Mandiant did not observe any\n\n\n-----\n\nmonetization of the stolen data such as extortion or sale. Analysis of web logs showed that\nthe actors were specifically scanning for adminer.php and testing for CVE-2019-0211, an\nApache Root Privilege Escalation to install the WSO webshell, directly from GitHub.\n\nEighteen minutes after the CVE-2021-21311 vulnerable adminer.php was discovered by the\nthreat actor through automated scanning, Mandiant observed indexing of the adminer.php by\nTelegram bot, indicating that the link to the adminer.php was shared in a Telegram chat\ngroup. A few minutes later, an automated session from a free VPN service also scanned the\nadminer.php. The same automated process was executed from different a different IP a few\nhours later, followed by interactive activity and successful access of the IMDS service 3\nhours and 15 minutes after the initial access.\n\n### Scanning Activity\n\nMandiant observed indications that the UNC2903 infrastructure was used to scan over 2,100\nIP addresses in late June 2021. Scanning focused on web services such as port 80 or 443\nand did not focus on any specific service provider suggesting the actor may have been\noperating from a list of targets with open HTTP ports from prior research and not targeting\nany specific service provider.\n\n### User Agent Strings\n\nUser agent strings used by UNC2903 observed by Mandiant:\n\nMozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)\nChrome/91.0.4472.101 Safari/537.36 Edg/91.0.864.48\nMozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)\nChrome/91.0.4472.106 Safari/537.36\nMozilla/5.0 (X11; Linux x86_64; rv:84.0) Gecko/20100101 Firefox/84.0\n\n## Transform Security and Mitigate Similar Threats\n\nMandiant recommends organizations detect, remediate, and prevent EC2 Instances from\nhaving IMDSv1 enabled. Before remediating and converting EC2 Instances to use IMDSv2,\nthe organization should test all instances/application to ensure the operations will not be\nimpacted by such remediation measures.\n\nUsing our vulnerable Adminer web application, once the EC2 Instance running the\napplication has IMDSv2 enabled, the secrets/credentials are no longer able to be obtained\nby the threat actor (see Figure 10).\n\n\n-----\n\nFigure 10: Error message received when attempted to obtain credentials from an EC2\nInstance with IMDSv2 enforced\nNext we will provide multiple ways an organization can detect, remediate, and prevent\nIMDSv1 from their environment.\n\n### Detections, Remediations, and Preventions\n\n**Detecting EC2 Instances with IMDSv1**\n\n_Audit currently deployed EC2 Instance to verify if IMDSv1 or IMDSv2 is being used in the_\n_environment._\n\nNative AWS Services:\n\n[AWS Security Hub – Check](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-standards-fsbp-controls.html) `[EC2.8] EC2 instances should use IMDS v2`\n[CloudWatch –](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/viewing_metrics_with_cloudwatch.html) `MetadataNoToken (Counts the number of times the Instance`\nMetadata service was successfully access without a token (i.e., IMDSv1))\nAWS Config – A Config rule that checks if the organization’s EC2 Instance is set\nto require HTTPTokens (see the following).\n\n\n-----\n\n```\nAWSTemplateFormatVersion: \"2010-09-09\"\n\n```\n```\nDescription: \"\"\n\n```\n```\nResources:\n\n```\n```\n ConfigRule:\n\n```\n```\n  Type: \"AWS::Config::ConfigRule\"\n\n```\n```\n  Properties:\n\n```\n```\n   ConfigRuleName: \"ec2-imdsv2-check\"\n\n```\n```\n   Scope:\n\n```\n```\n    ComplianceResourceTypes:\n\n```\n```\n     - \"AWS::EC2::Instance\"\n\n```\n```\n   Description: \"A Config rule that checks whether your Amazon Elastic\nCompute Cloud (Amazon EC2) instance metadata version is configured with\nInstance Metadata Service Version 2 (IMDSv2). The rule is COMPLIANT if the\nHttpTokens is set to required and is NON_COMPLIANT ...\"\n\n```\n```\n   Source:\n\n```\n```\n    Owner: \"AWS\"\n\n```\n```\n    SourceIdentifier: \"EC2_IMDSV2_CHECK\"\n\n```\n```\nParameters: {}\n\n```\n```\nMetadata: {}\n\n```\n```\nConditions: {}\n\n```\n\nOpen-Source Tools:\n\n[Prowler - Check 7.86 – Check if EC2 Instance Metadata Service Version 2](https://github.com/prowler-cloud/prowler/blob/master/checks/check_extra786)\n(IMDSv2) is Enabled and Required\n\n```\n./prowler -c check786\n\n```\n\n[Metabadger](https://github.com/salesforce/metabadger)\n\n```\n./metabadger discover-metadata\n\n```\n\n[CloudMapper – EC2_IMDSV2_NOT_ENFORCED](https://github.com/duo-labs/cloudmapper)\nAWS CLI:\n\n\n-----\n\n```\n aws ec2 describe-instances --filters Name=metadata-options.http tokens,Values=optional --query \"Reservations[*].Instances[*].\n {Instance:InstanceId}\" --region [EnterRegionHere]\n\n```\n_GuardDuty alert for use of EC2 instance credential from outside of current account._\n\n[InstanceCredentialExfiltration.InsideAWS - High: If EC2 Instance Credential is used by](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)\nanother AWS Account (see Figure 9 ).\n[InstanceCredentialExfiltration.OutsideAWS - High: If EC2 Instance Credential is used](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)\nby an external IP Address.\nRestrict access to IMDS to a limited set of users or EC2 role\n\nExecute the following command to limit the IMDS service to bobuser:\n\n```\nip-lockdown 169.254.169.254 bobuser\n\n```\n\n**Remediating IDMSv1**\n\nNote: Before proceeding to disable IMDSv1 from an organization’s EC2 Instance, there must\nbe extensive testing performed prior to the remediation actions.\n\nDisable IMDS completely on infrastructure that does not require the metadata service.\n```\n aws ec2 modify-instance-metadata-options –instance-id <instance-id> –\n http-endpoint disabled\n\n```\nIf IMDS is needed, then an organization can enforce an EC2 Instance to run only\nIMDSv2:\n```\n aws ec2 modify-instance-metadata-options –instance-id <INSTANCE-ID> –\n http-endpoint enabled –http-token required\n\n```\n[Utilize an open-source tool, such as Remediate AWS-IMDSv1, to detect and remediate](https://github.com/latacora/remediate-AWS-IMDSv1)\nall EC2 instances that have IMDSv1 enabled.\n\n```\npython remediate-imdsv1.py --profile <AWS_PROFILE> --remediate –debug\n\n```\n\nSet iptables rules to DENY access to the metadata service\n```\n iptables -A OUTPUT –proto tcp -m owner --uid-owner root -d\n 169.254.169.254 -j REJECT\n\n```\n**Preventing IMDSv1 from the Environment**\n\nAn organization can create a Service Control Policy (SCP) to require API Calls to utilize\nIMDSv2 if there are role credentials for an EC2. See the following Sample SCP:\n\n\n-----\n\n```\n{\n\n```\n```\n  \"Version\": \"2012-10-17\",\n\n```\n```\n  \"Statement\": [\n\n```\n```\n    {\n\n```\n```\n      \"Sid\": \"RequireAllEc2RolesToUseV2\",\n\n```\n```\n      \"Effect\": \"Deny\",\n\n```\n```\n      \"Action\": \"*\",\n\n```\n```\n      \"Resource\": \"*\",\n\n```\n```\n      \"Condition\": {\n\n```\n```\n        \"NumericLessThan\": {\n\n```\n```\n          \"ec2:RoleDelivery\": \"2.0\"\n\n```\n```\n        }\n\n```\n```\n      }\n\n```\n```\n    }\n\n```\n```\n  ]\n\n```\n```\n}\n\n```\n\nAn organization should utilize Infrastructure-as-Code (IaC) to disallow and/or disable\nthe use of IMDSv1. There are several ways to enforce IMDSv2, here are a few via\nCloudFormation:\n\n\n-----\n\nCreate a custom CloudFormation or Terraform template that prevents users from\nlaunching EC2 instances that are not configured for IMDSv2\n\nCloudFormation\n\n```\nAWSTemplateFormatVersion: \"2010-09-09\"\n\n```\n```\nDescription: \"\"\n\n```\n```\nResources:\n\n```\n```\n IamPolicy:\n\n```\n```\n  Type: \"AWS::IAM::ManagedPolicy\"\n\n```\n```\n  Properties:\n\n```\n```\n   PolicyDocument:\n\n```\n```\n    Version: \"2012-10-17\"\n\n```\n```\n    Statement:\n\n```\n```\n     - Action:\n\n```\n```\n       - \"ec2:RunInstances\"\n\n```\n```\n      Resource:\n\n```\n```\n       - \"arn:aws:ec2:*:*:instance/*\"\n\n```\n```\n      Effect: \"Deny\"\n\n```\n```\n      Condition:\n\n```\n```\n       StringNotEquals:\n\n```\n```\n        ec2:MetadataHttpTokens: \"required\"\n\n```\n```\n   Description: \"An IAM policy that prevents users from\nlaunching new EC2 Instances if they are not configured to use the\nnew Instance Metadata Service (IMDSv2)\"\n\n```\n```\nParameters: {}\n\n```\n```\nMetadata: {}\n\n```\n```\nConditions: {}\n\n```\n\n-----\n\nTerraform\n\n```\nprovider \"aws\" {\n\n```\n```\n}\n\n```\n```\nresource \"aws_iam_policy\" \"IamPolicy\" {\n\n```\n```\n name = \"Require_IMDSv2\"\n\n```\n```\n description = \"IAM Policy that requires IMDSv2\"\n\n```\n```\n policy = <<POLICY\n\n```\n```\n{\n\n```\n```\n \"Version\": \"2012-10-17\",\n\n```\n```\n \"Statement\": [\n\n```\n```\n  {\n\n```\n```\n   \"Action\": [\n\n```\n```\n    \"ec2:RunInstances\"\n\n```\n```\n   ],\n\n```\n```\n   \"Resource\": [\n\n```\n```\n    \"arn:aws:ec2:*:*:instance/*\"\n\n```\n```\n   ],\n\n```\n```\n   \"Effect\": \"Deny\",\n\n```\n```\n   \"Condition\": {\n\n```\n```\n    \"StringNotEquals\": {\n\n```\n```\n     \"ec2:MetadataHttpTokens\": \"required\"\n\n```\n```\n    }\n\n```\n```\n   }\n\n```\n```\n  }\n\n```\n```\n ]\n\n```\n```\n}\n\n```\n```\nPOLICY\n\n```\n```\n}\n\n```\n\n-----\n\nCreate an IAM Policy that prevents users from launching an EC2 Instance if the EC2\ninstance is not configured for using IMDSv2.\n\n```\n{\n\n```\n```\n  \"Version\": \"2012-10-17\",\n\n```\n```\n  \"Statement\": [\n\n```\n```\n    {\n\n```\n```\n      \"Action\": [\n\n```\n```\n        \"ec2:RunInstances\"\n\n```\n```\n      ],\n\n```\n```\n      \"Resource\": [\n\n```\n```\n        \"arn:aws:ec2:*:*:instance/*\"\n\n```\n```\n      ],\n\n```\n```\n      \"Effect\": \"Deny\",\n\n```\n```\n      \"Condition\": {\n\n```\n```\n        \"StringNotEquals\": {\n\n```\n```\n          \"ec2:MetadataHttpTokens\": \"required\"\n\n```\n```\n        }\n\n```\n```\n      }\n\n```\n```\n    }\n\n```\n```\n  ]\n\n```\n```\n}\n\n```\n\nCreate an IAM Policy that enforces all newly created EC2 Instances are configured to\nuse IMDSv2 (note: existing EC2 Instances will not be impacted by this IAM Policy).\n\n\n-----\n\n```\n{\n\n```\n```\n  \"Version\": \"2012-10-17\",\n\n```\n```\n  \"Statement\": {\n\n```\n```\n    \"Sid\": \"RequireImdsV2\",\n\n```\n```\n    \"Effect\": \"Deny\",\n\n```\n```\n    \"Action\": \"ec2:RunInstances\",\n\n```\n```\n    \"Resource\": \"arn:aws:ec2:*:*:instance/*\",\n\n```\n```\n    \"Condition\": {\n\n```\n```\n      \"StringNotEquals\": {\n\n```\n```\n        \"ec2:MetadataHttpTokens\": \"required\"\n\n```\n```\n      }\n\n```\n```\n    }\n\n```\n```\n  }\n\n```\n```\n}\n\n```\n\n**Additional Preventions and Hardening**\n\nReview all EC2 Instances, and ensure User Data Scripts for EC2s do not contain\ncleartext secrets or sensitive data\n\nUser Data Scripts are a set of commands that you provide during the launch of\nthe EC2. The User Data Scripts are performed using root permissions, and it can\nbe viewed via IMDS. An attacker can read the script being ran by a simple curl\ncommand.\n\n```\ncurl http://169.254.169.254/latest/user-data\n\n```\n\nLimit the number of HTTP Put Response Hops (minimum value is defaulted to 1 and\nthe maximum is 64).\n\nThe following example limits the maximum number of hops that occurs to 1:\n\n\n-----\n\n```\n{\n\n```\n```\n  \"Version\": \"2012-10-17\",\n\n```\n```\n  \"Statement\": {\n\n```\n```\n    \"Sid\": \"MaxImdsHopLimit\",\n\n```\n```\n    \"Effect\": \"Deny\",\n\n```\n```\n    \"Action\": \"ec2:RunInstances\",\n\n```\n```\n    \"Resource\": \"arn:aws:ec2:*:*:instance/*\",\n\n```\n```\n    \"Condition\": {\n\n```\n```\n      \"NumericLessThanEquals\":\n      {\"ec2:MetadataHttpPutResponseHopLimit\": \"1\"}\n\n```\n```\n    }\n\n```\n```\n  }\n\n```\n```\n}\n\n```\n\nLimit API Calls to use IMDSv2 to deliver the Amazon EC2 Role credentials via an IAM\nPolicy\n\n```\n{\n\n```\n```\n  \"Version\": \"2012-10-17\",\n\n```\n```\n  \"Statement\": {\n\n```\n```\n    \"Sid\": \"RequireAllEc2RolesToUseV2\",\n\n```\n```\n    \"Effect\": \"Deny\",\n\n```\n```\n    \"Action\": \"*\",\n\n```\n```\n    \"Resource\": \"*\",\n\n```\n```\n    \"Condition\": {\n\n```\n```\n      \"NumericLessThan\":\n      {\"ec2:RoleDelivery\": \"2.0\"}\n\n```\n```\n    }\n\n```\n```\n  }\n\n```\n```\n}\n\n```\n\n-----\n\nLimit access to be able to modify the EC2 Instance metadata service\n\n```\n{\n\n```\n```\n  \"Version\": \"2012-10-17\",\n\n```\n```\n  \"Statement\": {\n\n```\n```\n    \"Sid\": \"LimitModifyInstanceMetadataService\",\n\n```\n```\n    \"Effect\": \"Deny\",\n\n```\n```\n    \"Action\": \"ec2:ModifyInstanceMetadataOptions\",\n\n```\n```\n    \"Resource\": \"*\",\n\n```\n```\n    \"Condition\": {\n\n```\n```\n      \"StringNotLike\":\n      {\"aws:PrincipalARN”: “arn:aws:iam:*:role/ec2-imds-admin\"}\n\n```\n```\n    }\n\n```\n```\n  }\n\n```\n```\n}\n\n```\n\nRestrict the scope of IAM role / credential access to S3 buckets\nBlock or reduce of IAM role / credential usage ability from the public Internet\nLimit server Internet egress to prevent outbound server traffic\nImplement S3 Bucket Policies to further restrict access to the S3 Bucket\nEnable VPC flows and S3 bucket / object level access data events\nProxy or monitor web requests for possible exploitation\nLimit service ports allowed inbound or outbound to the server\nSanitize or limit unnecessary HTTP headers to the web server\nLog all the things, and prioritize alerting for possible credential abuse\nFollow Amazon Web Services best practices for solutions, and regularly test security\ncontrols\n\n## Key Takeaways\n\nAs organizations move further into cloud environments, additional complexities of default\nsettings can offer opportunities for an attacker to leverage access from one system, to pivot\nto many others similar. Data stored in cloud systems can be stolen, tampered, or deleted just\nlike any other environment. Mandiant’s expertise in responding to intrusions extends to cloud\nenvironments which continue to be targeted both by espionage and financially motivated\ngroups.\n\n\n-----\n\n## Acknowledgements\n\nWith thanks to Nick Richard for technical review and Justin Moore for MITRE D3FEND\nmapping.\n\n## Indicators\n\n141.94.43.37\n37.59.152.171\n191.96.108.227\n191.96.108.8\nhxxps://raw.githubusercontent[.]com/wso3/wso3/master/wso.php\n35b03c6bc21d140201670005923333de\n\n## MITRE Mappings\n\n### MITRE ATT&CK UNC2903\n\n**Tactic** **Description**\n\n**Discovery** T1580: Cloud Infrastructure Discovery\n\n**Initial Access** T1190: Exploit Public-Facing Application\n\n**Persistence** T1505.003: Web Shell\n\n**Credential Access** T1552.004: Private Keys\n\nT1552.005: Cloud Instance Metadata API\n\n**Collection** T1530: Data from Cloud Storage Object\n\n### MITRE D3FEND UNC2903\n\n**Tactic** **Description**\n\n\n-----\n\n**Harden** **Application Hardening**\n\n\nD3-PSEP: Process Segment Execution\nPrevention\nD3-SAOR: Segment Address Offset\nRandomization\n\n\n-----\n\n**Execution Isolation**\n\nD3-HBPI: Hardware-based\nProcess Isolation\nD3-MAC: Mandatory Access\nControl\nD3-EDL: Executable Denylisting\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-05-04 - Old Services, New Tricks- Cloud Metadata Abuse by UNC2903.pdf"
    ],
    "report_names": [
        "2022-05-04 - Old Services, New Tricks- Cloud Metadata Abuse by UNC2903.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535662,
    "ts_updated_at": 1743041143,
    "ts_creation_date": 1653765001,
    "ts_modification_date": 1653765001,
    "files": {
        "pdf": "https://archive.orkl.eu/1ec06a05a5c100280605be335649c65ff18a6976.pdf",
        "text": "https://archive.orkl.eu/1ec06a05a5c100280605be335649c65ff18a6976.txt",
        "img": "https://archive.orkl.eu/1ec06a05a5c100280605be335649c65ff18a6976.jpg"
    }
}