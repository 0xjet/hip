{
    "id": "36e3a702-0f7e-4ed5-8e7c-6c9e6ea54a33",
    "created_at": "2023-01-12T15:08:05.203683Z",
    "updated_at": "2025-03-27T02:06:09.664966Z",
    "deleted_at": null,
    "sha1_hash": "88363dfa4acb70f232cd9d802c94445c1ce3ae1a",
    "title": "2018-02-07 - Targeted Attacks In The Middle East",
    "authors": "",
    "file_creation_date": "2022-05-28T17:55:30Z",
    "file_modification_date": "2022-05-28T17:55:30Z",
    "file_size": 1036081,
    "plain_text": "# Targeted Attacks In The Middle East\n\n**[blog.talosintelligence.com/2018/02/targeted-attacks-in-middle-east.html](https://blog.talosintelligence.com/2018/02/targeted-attacks-in-middle-east.html)**\n\n[This blog post is authored by Paul Rascagneres with assistance of Martin Lee.](https://twitter.com/r00tbsd)\n\n## Executive Summary\n\nTalos has identified a targeted attacks affecting the Middle East. This campaign contains the\nfollowing elements, which are described in detail in this article.\n\nThe use of allegedly confidential decoy documents purported to be written by the\nJordanian publishing and research house, Dar El-Jaleel. This institute is known for their\nresearch of the Palestinian-Israeli conflict and the Sunni-Shia conflict within Iran.\n\nThe attacker extensively used scripting languages (VBScript, PowerShell, VBA) as part\nof their attack. These scripts are used to dynamically load and execute VBScript\nfunctions retrieved from a Command & Control server.\n\nThe attacker demonstrates excellent operational security (OPSEC). The attacker was\nparticularly careful to camouflage their infrastructure. During our investigation, the\nattacker deployed several reconnaissance scripts in order to check the validity of victim\nmachine, blocking systems that don't meet their criteria. The attacker uses the\nreputable CloudFlare system to hide the nature and location of their infrastructure.\nAdditionally, the attacker filters connections based on their User-Agent strings, and only\nenables their infrastructure for short periods of time before blocking all connections.\n\n\n-----\n\nThis is not the first targeted campaign against the region that uses Dar El-Jaleel decoy\ndocuments which we have investigated. However, we have no indication that the previous\ncampaigns are related.\n\n## VBS Campaign\n\n### Stage 1: VBScript\n\nThe campaign starts with a VBScript named ﻣﻦ داﺧﻞ ﺣﺮب اﯾﺮان اﻟﺴﺮﯾﺔ ﻓﻲ ﺳﻮرﯾﺎ.vbs (\"From inside\nIran's secret war in Syria.vbs\"). Here are the script contents:\n\nThe purpose of this script is to create the second stage PowerShell script described in the\nnext section.\n\n### Stage 2: PowerShell Script\n\nThe goal of the generated PowerShell script is to create a Microsoft Office document named\nReport.doc and to open it.\n\n### Stage 3: Office Document With Macros\n\nHere is a screenshot of the Office document:\n\n\n-----\n\nThis document purports to be written by Dar El-Jaleel. Dar El-Jaleel is a publishing and\nstudies house based in Amman, Jordan. This institute is well-known for their research\nconcerning the Palestinian-Israeli conflict and the Sunni-Shia conflict in Iran. Tagged as\nconfidential, the document is an analysis report on Iranian activities within the Syrian civil\nwar.\n\nThis document contains a Macro:\n\n\n-----\n\nThe purpose of this Macro in to create a WSF (Windows Script File) file and to execute it.\n\n### Stage 4: WSF Script\n\nThe created WSF script is the main part of the infection:\n\n\n-----\n\nThe top of the script contains configuration information:\n\nthe hostname of the Command & Control - office-update[.]services,\nthe port - 2095,\nthe User-Agent - iq.46|-377312201708161011591678891211899134718141815539111937189811\n\nThe User-Agent is used to identify the targets. The CC filters network connections based on\nthis string, only allowing through connections made with authorised User-Agent strings.\n\nThe first task of the script is to register the infected system by performing an HTTP request\nto http://office-update[.]services:2095/store. Next, the script executes an infinite loop,\nattempting to contact the /search URI every 5 seconds in order to download and execute\nadditional payloads.\n\n### Additional Payloads\n\nThe WSF script receives payloads of three types, named s0, s1, s2. The payloads are\nVBScript functions loaded and executed on the fly with the ExecuteGlobal() and GetRef()\nAPIs. The only differences between s0,s1 and s2 type payloads are the number of\n\n\n-----\n\narguments supplied to the executing function. s0 does not require any arguments, s1\naccepts one argument, and s2 two arguments.\n\nThe downloaded payload functions are obfuscated, here is an example of the raw data:\n\nThe first element is the function type (s0), followed by a separator '-|-'. The second element is\nthe obfuscated function; this consists of ASCII values, separated by '*'. For example the\nabove data decodes as:\n\n45: 54: 6\n53: 5\n43: +\n49: 1\n52: 4\n56: 8\n42: *\n53: 5\n51: 3\n53: 5\n45: 52: 4\n49: 1\n56: 8\n42: *\n\nHence, the decoded data is \"-65+148*535-418*\". Then follows a second step, again using '*'\nas a separator. Each mathematical operation is resolved to obtain a new ASCII value:\n\n-65+148 = 83 -> \"S\"\n535-419 = 117 -> \"u\"\n\nThis technique is used to construct a new VBScript function.\n\nDuring our investigation we received 5 different functions.\n\n**Reconnaissance Functions**\n\nDuring our investigation we received a reconnaissance function a few minutes after the initial\ncompromise. The purpose of the function was to retrieve several pieces of information from\nthe infected system, presumably in order to check if the target is valuable or not (or a\nsandbox system).\n\nFirst, the attacker retrieves the disk volume serial number:\n\n\n-----\n\nSecondly, the payload retrieves any installed anti-virus software:\n\nThirdly, it obtains the Internet IP address of the infected system by querying ipify.org (the\ncode includes a hint that the attacker previously used wtfismyip.com):\n\nThirdly, it retrieves the computer name, the username, the Operating System and the\narchitecture:\n\n\n-----\n\nAll these data are sent to the previously mentioned CC using the /is-return URI. The data are\nstored in the User-Agent separated by \"-|-\".\n\nSubsequently, we received a second reconnaissance function:\n\nThe function acts to list the drives of the infected system and their type (internal drive, usb\ndriver etc.)\n\n**Persistence Functions**\n\nIn addition to the reconnaissance functions we received 2 functions linked to the persistence\nof the WSF script. The first script is used to persist, the second is used to clean the infected\nsystem. Our machine was served this after taking too much time to send a request to the C2\n\n\n-----\n\nPresumably the attacker determined we were examining their systems and decided to\nremove the malware to prevent further analysis:\n\n**Pivot Function**\n\nFinally, we received a pivot function. The function is the only non-s0 function we obtained\nduring our research. This is a s1 function that takes one argument:\n\nHere is the argument:\n\nThe purpose is to execute a powershell script:\n\n\n-----\n\nThe PowerShell script executes a second base64 encoded script. The attacker forces the the\nsystem to use the 32 bit version of Powershell even if the operating system architecture is 64\nbits.\n\nFinally we obtain the last PowerShell script:\n\nThe purpose of this script is to download shellcode from 176[.]107[.]185[.]246 IP, to map it in\nmemory and to execute it. The attacker takes many precautions before delivering the\nshellcode, these will be explained in the next chapter. Unfortunately during our investigation\nwe weren't served the anticipated shellcode.\n\n### Attackers OPSEC\n\nThe attacker behind this campaign put a lot of effort into protecting its infrastructure and to\navoid leaking code to analysts. The first Command & Control server is protected by\nCloudFlare. This choice complicates the analysis and tracking of the campaign. Additionally,\nthe attacker filters on the User-Agent; if your web requests do not fit a specific pattern, your\nrequest will be ignored. During our analysis the attacker was only active during the morning\n(Central European Timezone), similarly the various different payloads were only sent during\nmornings (Central European Time). When an infected system receives the pivot function, the\nattacker disables their firewall for a few minutes to allow this unique IP to download the\nshellcode. Afterwards, the server becomes unreachable. Here is a schema of this workflow:\n\n\n-----\n\nAdditionally, we saw that the attackers blocklisted some of our specific User-Agent strings\nand IP addresses used during our investigation\n\nThis high level of OPSEC is exceptional even among presumed state sponsored threat\nactors...\n\n### Links with Jenxcus (a.k.a. Houdini/H-Worm)?\n\nIf you are familiar with Jenxcus (a.k.a. Houdini/H-Worm) you should see some similarities\nbetween the VBScript used during this campaign and this well-known malware: usage of the\nuser-agent to exfiltrate data, reconnaissance techniques etc…\n\nWe cannot tell if the attacker used a new version of Jenxcus or if this malware served as the\ninspiration for their own malicious code. The source code of Jenxcus can be easily found on\nthe Internet. However, the adaptation used in this campaign is more advanced: the\n\n\n-----\n\nfeatures/functions are loaded on demand and the initial script does not include all the\nmalicious code unlike Jenxcus.\n\n### Additional Targets\n\nWe can identify different targets based on the User-Agent used by the attacker to identify\nvictims. These are a few examples:\n```\nc = \"U.15.7\"\na = \"738142201756240710471556115716122461214187935862381799187598\"\nc = \"1X.134\"\na = \"130427201706151111209123451288122413771234715862388136654339\"\nc = \"Fb-20.9\"\na = \"585010201750201110021112344661899112271619123139116684543113\"\n\n## Other Campaigns Using Dar El-Jaleel Decoy Documents\n\n```\nThis is not the first time Talos has investigated targeted campaigns using Dar El-Jaleel decoy\ndocuments. During 2017, we identified several campaigns using the same decoy documents:\n\n\n-----\n\nThis document is a weekly report about the major events occuring during the 1st week of\nNovember 2017, talking about the most important events happening in Jordan, Iraq, Syria,\nLebanon, Palestine, Israel, Russia, ISIS and the ongoing Gulf Countries conflict with Qatar.\n\nWe encountered this document in campaigns using .NET malware (with the CC: foxlive[.]life)\nand C++ malware (with the CC: download[.]share2file[.]pro). The purpose of the malwares\nwas to retrieve information relating to the targeted systems and to download an additional\npayload. Moreover, we identified another campaign using a share2file[.]pro subdomain. Here\nis the decoy document in this campaign:\n\n\n-----\n\nThis document is a pension list of military personnel dated June 2017, containing names of\nindividuals which we have redacted, alongside a military rank.\n\nWe don't know if these campaigns are performed by the same actor or different groups\ninterested in this region. These campaigns are still under investigation.\n\n## Conclusion\n\nThese campaigns show us that at least one threat actor is interested in and targeting the\nMiddle East. Due to the nature of the decoy documents, we can conclude that the intended\ntargets have an interest in the geopolitical context of the region. The attackers used an\n\n\n-----\n\nanalysis report alleged to be written by Dar El-Jaleel, a Jordanian institute specialising in\nstudies of the region. Some of these documents are tagged as confidential.\n\nDuring the VBS Campaign, we were surprised by the level of OPSEC demonstrated by the\nattacker and their infrastructure. Legitimate service such as CloudFlare were used to hide\nmalicious activities. Additionally the attacker used user-agent filtering and firewall rules in\norder to grant access to specific infected systems for only a few minutes in order to deliver\nshellcode. Following this, the server became unreachable. Another notable observation is\nthe fact that the attacker was active only during the morning (Central European timezone)\nduring our investigation.\n\nThe usage of script languages is an interesting approach from the attackers' point of view.\nThese languages are natively available on Windows system, provide a high degree of\nflexibility, and can easily stay under the radar.\n\n## Coverage\n\nAdditional ways our customers can detect and block this threat are listed below.\n\n[Advanced Malware Protection (AMP) is ideally suited to prevent the execution of the](https://www.cisco.com/c/en/us/products/security/advanced-malware-protection)\nmalware used by these threat actors.\n\n[CWS or WSA web scanning prevents access to malicious websites and detects malware](https://www.cisco.com/c/en/us/products/security/cloud-web-security/index.html)\nused in these attacks.\n\n[Email Security can block malicious emails sent by threat actors as part of their campaign.](https://www.cisco.com/c/en/us/products/security/email-security-appliance/index.html)\n\n[Network Security appliances such asNGFW,NGIPS, andMeraki MX can detect malicious](https://www.cisco.com/c/en/us/products/security/firewalls/index.html)\nactivity associated with this threat.\n\n\n-----\n\n[AMP Threat Grid helps identify malicious binaries and build protection into all Cisco Security](https://www.cisco.com/c/en/us/solutions/enterprise-networks/amp-threat-grid/index.html)\nproducts.\n\n[Umbrella, our secure internet gateway (SIG), blocks users from connecting to malicious](https://umbrella.cisco.com/)\ndomains, IPs, and URLs, whether users are on or off the corporate network.\n\nOpen Source Snort Subscriber Rule Set customers can stay up to date by downloading the\n[latest rule pack available for purchase on Snort.org.](https://www.snort.org/products)\n\n## IOCs\n\nVBS Campaign:\n\nInitial script: 15f5aaa71bfa3d62fd558a3e88dd5ba26f7638bf2ac653b8d6b8d54dc7e5926b\nDomain #1: office-update[.]services\n\nIP #2: 176[.]107[.]185[.]246\n\n.NET Campaign:\n\nInitial dropper: 4b03bea6817f0d5060a1beb8f6ec2297dc4358199d4d203ba18ddfcca9520b48\n\n.NET #1: d49e9fdfdce1e93615c406ae13ac5f6f68fb7e321ed4f275f328ac8146dd0fc1\n\n.NET #2: e66af059f37bdd35056d1bb6a1ba3695fc5ce333dc96b5a7d7cc9167e32571c5\n\nDomain #1: jo[.]foxlove[.]life\n\nDomain #2: eg[.]foxlove[.]life\n\nDomain #3: fox[.]foxlove[.]life\n\nCampaign #3:\n\nInitial Dropper: af7a4f04435f9b6ba3d8905e4e67cfa19ec5c3c32e9d35937ec0546cce2dd1ff\n\nPayload: 76a9b603f1f901020f65358f1cbf94c1a427d9019f004a99aa8bff1dea01a881\n\nDomain: download[.]share2file[.]pro\n\nCampaign #4:\n\nInitial Dropper: 88e4f306f126ce4f2cd7941cb5d8fcd41bf7d6a54cf01b4a6a4057ed4810d2b6\n\nPayload #1: c5bfb5118a999d21e9f445ad6ccb08eb71bc7bd4de9e88a41be9cf732156c525\n\nPayload #2: 1176642841762b3bc1f401a5987dc55ae4b007367e98740188468642ffbd474e\n\nDomain: update[.]share2file[.]pro\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-02-07 - Targeted Attacks In The Middle East.pdf"
    ],
    "report_names": [
        "2018-02-07 - Targeted Attacks In The Middle East.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536085,
    "ts_updated_at": 1743041169,
    "ts_creation_date": 1653760530,
    "ts_modification_date": 1653760530,
    "files": {
        "pdf": "https://archive.orkl.eu/88363dfa4acb70f232cd9d802c94445c1ce3ae1a.pdf",
        "text": "https://archive.orkl.eu/88363dfa4acb70f232cd9d802c94445c1ce3ae1a.txt",
        "img": "https://archive.orkl.eu/88363dfa4acb70f232cd9d802c94445c1ce3ae1a.jpg"
    }
}