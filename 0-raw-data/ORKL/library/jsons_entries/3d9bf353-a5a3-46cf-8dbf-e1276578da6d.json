{
    "id": "3d9bf353-a5a3-46cf-8dbf-e1276578da6d",
    "created_at": "2023-01-12T15:07:25.272446Z",
    "updated_at": "2025-03-27T02:05:40.178664Z",
    "deleted_at": null,
    "sha1_hash": "836be77666f8c02b2c934c2ac04a58da907ae140",
    "title": "2016-04-06 - Locky Ransomware Is Becoming More Sophisticated - Cybercriminals Continue Email Campaign Innovation",
    "authors": "",
    "file_creation_date": "2022-05-29T01:19:04Z",
    "file_modification_date": "2022-05-29T01:19:04Z",
    "file_size": 330486,
    "plain_text": "# Locky Ransomware Is Becoming More Sophisticated - Cybercriminals Continue Email Campaign Innovation\n\n**[proofpoint.com/us/threat-insight/post/Locky-Ransomware-Cybercriminals-Introduce-New-RockLoader-Malware](https://www.proofpoint.com/us/threat-insight/post/Locky-Ransomware-Cybercriminals-Introduce-New-RockLoader-Malware)**\n\nApril 6, 2016\n\n\n-----\n\n[Blog](https://www.proofpoint.com/us/blog)\n[Threat Insight](https://www.proofpoint.com/us/blog/threat-insight)\nLocky Ransomware Is Becoming More Sophisticated - Cybercriminals Continue Email Campaign Innovation\n\n\n-----\n\nApril 06, 2016 Chris Wakelin\n\n[Earlier this year, Proofpoint researchers discovered Locky ransomware. Most notably, the same actors behind many of the](http://proofpoint.com/us/threat-insight/post/Dridex-Actors-Get-In-the-Ransomware-Game-With-Locky)\nlargest Dridex campaigns were involved in distributing Locky and were doing it at a scale we'd previously only associated with the\nDridex banking Trojan. In recent weeks, we detected a marked increase in email campaigns attempting to install Locky,\nculminating on April 7th with the largest single campaign (tens of millions of messages) we have ever observed. This particular\ncampaign, primarily targeting UK and French organizations, used malicious document attachments and a new malware variant\nwe are calling RockLoader as an intermediary installing not only Locky but potentially two other pieces of malware as well. In\naddition to the use of Rockloader, threat actors distributing Locky have been using an array of obfuscation techniques and\nevolving their approaches to evade detection.\n\nOutside of the very large campaign detected on April 7th, the ransomware in many of these campaigns is being installed via\nJavaScript attachment files rather than documents. Typically there are no legitimate uses for such attachments, and we\nrecommend as a best practice blocking the delivery of JavaScript attachments at the email gateway. We have also observed the\nactors behind these campaigns varying their delivery strategies to evade security defenses. For example, we are seeing:\n\nIncreasingly convoluted JavaScript obfuscation\nAdditional junk files to help evade detections\nMangled “Content-Type” headers to help evade detection\nThe use of RAR instead of Zip compression of JavaScript\n\nAs noted above, Proofpoint has also observed the actors using a new malware, which we are calling RockLoader. This actor is\nfrequently using it as an intermediate “downloader”. This downloader has been distributed both through JavaScript attachments\nand malicious documents and, in turn, downloads Locky. This downloader is under active development, and we are observing\nnew features being added frequently. Additionally, on April 6th and 7th, 2016, we spotted this downloader being used to load\nother malware including Dridex 220, Pony, and Kegotip.\n\n**Example Of A Locky Ransomware Email**\n\nOn March 31, 2016, Proofpoint detected a large Locky campaign with RAR or Zip attachments containing JavaScript code,\nwhich, if opened, would download and install Locky with an Affiliate ID of \"3\" (Proofpoint is currently tracking Locky affiliate IDs 1,\n3, 4, 5, 11, 13, 14, and 15). This was one of the first instances of Locky malware operators compressing JavaScript with RAR,\npreviously they used only Zip compression. The messages in this campaign had the subjects:\n\n\"print please\", \"hello print\", or \"hi prnt\" with the attachment \"New Text Document (3).rar\"\n\"Photos\" with the attachment \"Photos.zip\"\n\n_Figure 1: Email delivering the zipped JavaScript_\n\n**JavaScript obfuscation**\n\n\n-----\n\nJavaScript attachments have been popular with attackers for a while [1] now. The attachments are typically heavily obfuscated;\nthey download and run additional malicious payloads. When the user double clicks and opens such an attachment, Windows\noperating systems helpfully runs it much like an executable. The specific JavaScript that downloads Locky uses obfuscation\ntechniques including character substitution, string concatenation, dead code, integer to character conversion, and other tricks.\n\n_Figure 2: Example of obfuscated JavaScript Code_\n\n**Additional Junk Files**\n\nAnother technique used by this actor is to sometimes include several malicious JavaScript files together with “junk” files. We\nhave not determined if this technique is aimed at confusing a certain security product or is simply an attempt to confuse simple\ndetections based on file sizes and hashes. In the screenshot below the the “v1V” file contains only bytes 0x00 and 0x01.\nAdditionally, this is a hidden file not visible to the user unless their Folder Options are set to “Show hidden files, folders, and\ndrives”.\n\n\n-----\n\n_Figure 3: Attachment payment_[someone]_720202.zip contains malicious .js files and a junk v1V file_\n\n_Figure 4: The “v1V” file contains only bytes 0x00 and 0x01_\n\n**Mangled “Content-Type” Headers**\n\nOf particular concern, starting on March 23rd, one of the Locky campaigns that used attachments with names such as\n“ImageNNNNNN.zip” (where NNNNNN are random digits) began sending out email with a variety of different Content-Type\nheaders, many of them highly unusual. This is an interesting technique since it aims to confuse email filtering products,\nattempting to make them not inspect such email if it is deemed junk. If such an email ends up in user’s inbox, it is then up to the\nemail reader to decide whether to open it. In our testing with Mail.app and MS Office Outlook 2010, both email clients were able\nto display the message to the user and open such emails.\n\nContent-Type: application/octet-stream\n\nContent-Type: application/x-compress\n\nContent-Type: application/x-compressed\n\nContent-Type: application/x-zip\n\nContent-Type: application/x-zip-compressed\n\nContent-Type: application/zip\n\n**Use of Improper File Extensions or Double File Extensions**\n\nOn March 29th, the actor attempted to send Zip attachments with improper file extensions “docx”, “gif”, ”jpg”, “pdf”, “rar”, and “tiff”.\n\n\n-----\n\nOn the 30th of March, one of the groups sending out Locky emails sent .zip files that were actually RAR archives (later switched\nto “.rar”) and sent RAR archives again on April 1st. The other group switched to RAR for one of their campaigns on March 31st,\nbut has since reverted to Zip. Presumably, the requirement for additional software such as WinRAR or WinZip to be installed\nreduces the number of potential victims.\n\nOn March 30th, an actor also attempted to use attachments with double file extensions, including JPEG.zip, doc.zip, pdf.zip, and\nothers. This is an old trick designed to confuse the user as Windows is usually configured to hide extensions for known file types,\nmaking these files appear as “Doc123.pdf” rather than “Doc123.pdf.zip”.\n\n**Intermediate Downloader: RockLoader**\n\nOn March 28th and again on March 31st, we observed JavaScript attachments downloading a smaller program (36KB in size),\nwhich in turn downloaded Locky, instead of downloading the Locky executable directly from the JavaScript. Later in the day, the\nintermediate downloader had been replaced by the actual Locky executable (200KB in size).\n\nInterestingly, the loader first makes a request to bmg.de, but it doesn't do anything with the response and overwrites the buffer in\nthe subsequent POST. The malware is able to issue commands including “getjob” to which the server may respond with a list of\nURLs linking to files to download and execute or with a “task”. ”NOTASKS” indicates there are no more files to download. The\nnetwork communication is encrypted.\n\n_Figure 5: Example of network communication_\n\n\n-----\n\n_Figure 6: Algorithm used for encrypting the communication_\n\n_Figure 7: Example decoded network command “getjob” and “UPDATE” command response from server_\n\n_Figure 8: XOR algorithm used in newer versions to decrypt downloaded executables_\n\nThe table below details all of the parameters exchanged between the loader and the C&C server:\n\nCommand Explanation\n\nID1 Volume serial number of the C drive expressed as a 0-padded decimal\n\n\n-----\n\nID2 Hardcoded 2's\n\nID3 Random digits\n\nID4 Encoded form windows version information\n\ntime Number of seconds since 1970\n\nresult Possible value is “DONE”\n\ntask Possible value is “NOTASKS”, delete itself from disk via batch script\n\nping How long to wait before killing a downloaded malware, and executing the next downloaded malware (see notes\nbelow)\n\ncommand - UPDATE: delete itself from disk via batch script (when done processing the UPDATE command and launched\nthe new version of the malware)\n\n        - DEL: delete itself from disk via batch script\n\nadd URLs as the source of malware update (or payload)\n\nkey Provides a string used for XOR decryption of downloaded executables\n\nAnother interesting component is the way in which the Windows version is encoded into the ID4 parameter. The first character is\n1 for XP, 2 for Vista, 3 for Windows 7, 4 for Windows 8, and 5 for Windows 10. The 4th character is 1 if the OS is 64-bit, 0\notherwise.\n\nEach downloaded binary is given a certain amount of time to run before killing it. That time is determined by the time derived from\nthe ping command (argument - 10 seconds) divided by the number of 'add' URLs specified. Until a response is received from the\nserver, the loader will keep generating requests.\n\nBy default the downloader will sleep two minutes between JSON request attempts, attempting to download the malware. The\n“ping” command in the downloader exists to kill off malware it downloaded that can't manage to connect to its dead C2, so it can\nmove on to the next URL and try again. The time in minutes specified by the “ping” command is divided by the number of URLs\npresent in the “add” field to flexibly handle larger numbers of malware URLs while keeping a constraint on the total amount of\ntime required to process the downloads and infections.\n\nRockLoader detects if it is being run as an administrator, and if not, is capable of bypassing UAC on both 32-bit and 64-bit\nversions of Windows via the well-known cliconfg.exe / ntwdblib.dll technique. On 64-bit systems an executable is extracted and\nrun which performs SetWindowsHookEx-based DLL injection into explorer using a DLL contained in the binary’s resources,\nwhich then triggers the UAC bypass from within the injected DLL. On 32-bit operating systems, the DLL injection is performed\nvia the same method from the original RockLoader binary itself, with the DLL also being embedded directly in the main\nRockLoader binary.\n\nSince we started writing this blog, the developers of the downloader have already made a number of changes. The downloader’s\nruntime API resolution code has been modified to obfuscate the names of APIs being resolved using a simple 8-byte XOR\nalgorithm. That same algorithm is also being used to obfuscate an embedded 64-bit UAC bypass executable and a 32-bit UAC\nbypass DLL which previously appeared in plain text. Some APIs that were static imports before, such as ShellExecuteA, are now\nresolved dynamically. There is also now a new JSON field, “key”. It is used in a simple XOR routine to decrypt the downloaded\nfiles.\n\n**Conclusion**\n\nThe rapid evolution of delivery mechanisms and obfuscation techniques, as well as the introduction of a new intermediate\ndownloader malware demonstrates that the actors behind a number of recent Locky campaigns are working quickly to bypass\ndetections for this ransomware As Locky gains both media and industry attention we can expect the actors to explore additional\n\n\n-----\n\ntechniques to make their campaigns more effective.\n\n**Appendix A: Select EmergingThreats Signatures**\n\n2816861 || ETPRO TROJAN Downloader (observed Locky) Checkin\n2816862 || ETPRO TROJAN Downloader Possibly Requesting Locky\n2816863 || ETPRO TROJAN Locky downloader Mar 28 2016 checkin response\n2816864 || ETPRO TROJAN Locky downloader Mar 28 2016 checkin\n\n**Appendix B: Python Decoder for Network Protocol**\n\n#!/usr/bin/env python\nimport sys\n\ndata = sys.stdin.read()\nout = \"\"\nn = 0\nwhile(data[n] == \"\\x0a\"):\nn += 1\nfor i in range(n, len(data) - 1, 2):\nk = (ord(data[i + 1]) & 0xf0) >> 4\nx1 = (ord(data[i]) & 0x0f) ^ k\nx2 = ord(data[i + 1]) & 0x0f\nout += chr((x1 << 4) | x2)\nsys.stdout.write(out)\n\n**Indicators of Compromise**\n\n**Value** **Type** **Description**\n\n5399de40ff93b2887f7944cd13d28bcbe282efc914f97749629cf8b47dd74e73 SHA256 payment_[name]_720202.zip\n\n4f9ab998e364407d4391f0d08f42c5e2148b247124a24d07dbd08fe385515844 SHA256 payment_[name]_720202/(transaction)\n\n                                               - c3db2b - copy.js\n\n4f9ab998e364407d4391f0d08f42c5e2148b247124a24d07dbd08fe385515844 SHA256 payment_[name]_720202/(transaction)\n\n                                              - c3db2b.js\n\nbd0fcafd22daaaada611399ec9cb0839eab427448b3b308734fe9a3469adff5b SHA256 payment_[name]_720202/(urgent) 90f0819e.js\n\nce749a469a4e99425efd1fb456dd683aa4e90a3b619c841afd6ea45071c1a46c SHA256 payment_[name]_720202/v1V\n\nfc836ad9555604051333c021735346f6a59bb28f21c99d26c2a7e32419a3e8b0 SHA256 Photos.zip\n\n24912bb06c61ce1188bbfab880d7b09d652fe12418744acbf15d3ecc0ce38ab5 SHA256 96142172-2597q-821010.js\n\n5d6ddb8458ee5ab99f3e7d9a21490ff4e5bc9808e18b9e20b6dc2c5b27927ba1 SHA256 RockLoader (original version)\n\na3d090f64b9dbca420f232966d65ecdca333cb497308cea94477e5219af685ae SHA256 RockLoader (original version)\n\ne4c4e5337fa14ac8eb38376ec069173481f186692586edba805406fa756544d9 SHA256 RockLoader (updated version with\n“key” parameter)\n\n**References**\n\n[[1] http://www welivesecurity com/2015/12/16/nemucod-malware-spreads-ransomware-teslacrypt-around-world/](http://www.welivesecurity.com/2015/12/16/nemucod-malware-spreads-ransomware-teslacrypt-around-world/)\n\n\n-----\n\nSubscribe to the Proofpoint Blog\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-04-06 - Locky Ransomware Is Becoming More Sophisticated - Cybercriminals Continue Email Campaign Innovation.pdf"
    ],
    "report_names": [
        "2016-04-06 - Locky Ransomware Is Becoming More Sophisticated - Cybercriminals Continue Email Campaign Innovation.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536045,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1653787144,
    "ts_modification_date": 1653787144,
    "files": {
        "pdf": "https://archive.orkl.eu/836be77666f8c02b2c934c2ac04a58da907ae140.pdf",
        "text": "https://archive.orkl.eu/836be77666f8c02b2c934c2ac04a58da907ae140.txt",
        "img": "https://archive.orkl.eu/836be77666f8c02b2c934c2ac04a58da907ae140.jpg"
    }
}