{
    "id": "1a67883b-6932-441a-bed2-f1487b373bef",
    "created_at": "2023-01-12T15:05:14.355968Z",
    "updated_at": "2025-03-27T02:05:38.081043Z",
    "deleted_at": null,
    "sha1_hash": "16295754c1047ce13e4c83cb0dd6be7b4acdaad8",
    "title": "2022-08-05 - The DGA family Orchard continues to change, and the new version generates DGA domain names using Bitcoin transaction information",
    "authors": "",
    "file_creation_date": "2022-10-02T12:19:55Z",
    "file_modification_date": "2022-10-02T12:19:55Z",
    "file_size": 1913826,
    "plain_text": "# DGA家族Orchard持续变化，新版本用比特币交易信息生成 DGA域名\n\n**blog.netlab.360.com/orchard-dga/**\n\ndaji August 5, 2022\n\n5 August 2022\n/ [Botnet](https://blog.netlab.360.com/tag/botnet/)\nDGA是一种经典的botnet对抗检测的技术，其原理是使用某种DGA算法，结合特定的种子和当\n前日期，定期生成大量的域名，而攻击者只是选择性的注册其中的极少数。对于防御者而言，\n因为难以事先确定哪些域名会被生成和注册，因而防御难度极大。\n\n[360 netlab长期专注于botnet攻防技术的研究，维护了专门的DGA算法和情报库，并通过订阅](https://data.netlab.360.com/dga/)\n情报的方式与业界分享研究成果。近期我们在分析未知DGA域名时发现一例不但使用日期，还\n会同时使用中本聪的比特币账号交易信息来生成DGA域名的例子。因为比特币交易的不确定\n性，该技术比使用时间生成的DGA更难预测，因而防御难度更大。\n\n该技术发现于一个名为Orchard的botnet家族。自从2021年2月份首次检测到该家族以来，我\n们发现它至少经历了3个版本的变化，中间甚至切换过编程语言。结合长期的跟踪结果和其它\n维度的信息，我们认为Orchard会是一个长期活跃、持续发展的botnet家族，值得警惕。本文\n将介绍Orchard的最新DGA技术，以及它这3个版本的发展过程。本文要点如下：\n\nOrchard是一个使用了DGA技术的botnet家族，核心功能是在受害者机器上安装各种恶意\n软件。\n从2021年2月至今，我们先后检测到3个版本的Orchard样本，均使用了DGA技术。\nOrchard的DGA算法一直未变，但日期的使用方式一直在变，最新版同时支持使用比特\n币账号信息来生成单独的DGA域名。\n除了DGA，Orchard还硬编码了C2域名。\nOrchard目前仍在活跃，致力于门罗币挖矿。\n\n## 传播方式、规模以及影响范围\n\nOrchard采用了“硬编码域名+DGA”的冗余C2机制，并且每个版本都硬编码了1个唯一的\nDuckDNS动态域名作为C2，根据它们的DGA实现方式和硬编码的域名，我们把已经检测到的\nOrchard样本分为3个版本：\n```\nv1, orcharddns.duckdns.org\n\nv2，orchardmaster.duckdns.org\n\nv3, ojena.duckdns.org\n\n\n```\n它们的时间线如下：\n```\n* 2021年3月，检测到v1版本，使用C++开发。结合历史数据，我们将v1首次出现时间提前到2021年2月。\n* 2021年9月，检测到v2版本，它使用Golang和C++编写。\n* 2022年7月，检测到v3版本，编写语言回到C++。\n\n```\n\n-----\n\n这3个版本都支持通过感染USB盘的方式进行传播，这 点跟传统的病毒很像，具体实现参考\n后面的“USB感染逻辑”部分。理论上，Orchard也完全可以通过其它方式传播。\n\n利用我们的图系统结合PDNS和其它维度的数据，我们发现v1和v2的C2存在明显的共享IP的情\n况，如下图所示。\n\n图系统帮我们找到了更多的C2 IP和域名，详见后面的IoC部分，这里的域名特点是都以\nduckdns.org结尾。v3因为比较新，没发现其它的关联域名，下面是v3域名的活跃情况。\n\n能看到它是今年5月上线，然后逐渐活跃，目前应该仍然在活跃期内。\n\n\n-----\n\n基于PDNS我们对3个版本的感染规模做了评估，其中v1和v2节点数近千，v3因为出现较晚，\n节点数不到500，下面是各个版本域名到具体IP的详细解析数。\n```\n# v1, orcharddns.duckdns.org\n\n37, 45.61.185.36\n\n413, 45.61.186.52\n\n1301, 45.61.187.240\n\n207, 205.185.124.143\n\n# v2, orchardmaster.duckdns.org\n\n45, 45.61.185.36\n\n104, 45.61.186.52\n\n659, 45.61.187.240\n\n# v3, ojena.duckdns.org\n\n418, 45.61.185.231\n\n\n```\n需要强调的是上面的规模数据只是我们视野内看到的，实际的应该要比这更多。\n\n## 样本分析\n\nOrchard样本在样本层面多使用loader，用于对抗分析和自我保护。目前看到的Orchard loader\n并不固定，即使单个版本也会出现多种loader的情况，比如v1版本的Orchard以base64字符串\n的形式存在于loader中，v2/v3版本的样本有的以资源文件的形式存放在loader中。各个版本还\n都曾使用过例如VMP、Enigma等虚拟壳来保护自身。总的来说，Orchard的工作流程可以用\n下面的图来总结。\n\nOrchard三个版本的功能基本相同，包括：\n\n\n-----\n\n上传设备及用户信息\n响应指令/下载执行下一阶段的模块\n感染USB存储设备\n\n下面从DGA算法、C2通信和主机行为等几个维度分别分析3个版本Orchard的核心功能。\n\n### v1版本\n\n该版本的分析以MD5=5c883ff8539b8d04be017a51a84e3af8的样本为基础。它在运行时首先\n释放内嵌的PE文件到自启动目录下，所释放的PE在内存中进行base64解码得到orchard的数\n据，随后该PE将System32/SysWOW64下的任一exe作为傀儡进程，来运行保存的orchard代\n码。该版本Orchard整体逻辑如下图，主要分为网络通信和USB感染两部分，最终功能取决于\nC2下发的具体模块，因此orchard本身可以认为是一个Downloader的角色。\n\n此处主要描述其网络通信过程（三个版本的USB感染逻辑相同，详见USB感染一节）。\n\nC2通信过程较为简单，bot在check-in过程中向C2发送收集到的主机信息，然后等待C2响应的\n指令。v1版本所收集信息包括：卷序列号（HWID）、电脑名称、用户名、操作系统名称、系\n统版本、已安装的捕获驱动程序名称、杀软信息、父进程文件修改时间、置顶窗口名称及窗口\n标题等，这些信息以“[o.r.c.h.a.r.d]”作为分隔符进行拼接后发送，如下图所示。\n\n\n-----\n\nC2响应数据格式一般为“指令+数据”，指令的功能通过指令码指定。下面是一个具体的C2响\n应，其中\"[&&]\"代表指令码2，代表下载执行，具体处理过程分为2种：响应数据如果是URL，\n则下载URL对应的PE并执行；如果是base64编码的内容，则先解码然后执行解码后的数据。\n此处响应的数据实际是base64编码的新版本PE文件，相当于升级，这也表明老版本可能已经\n废弃。\n\n\n-----\n\nv1版本一共定义了8个指令，指令码与指令字符串的对应关系如下：\n```\n1 \\[=]\n\n2 \\[&&]\n\n3 \\[##]\n\n4 \\[###]\n\n5 \\[%%]\n\n6 \\[%%%]\n\n7 \\[#\\_#]\n\n8 \\[\\_\\_\\] \\[>>] \\[<<] \\[^^] \\[\\*\\] \\[\\~\\] \\[@] \\[!] \\[#\\*\\#\\] \\[#@#]\n\n\n```\n由于某些指令置空，8个指令实际对应三种操作（后续版本大同小异）：\n\n指令码1和2：判断响应数据为URL或者PE，如果是URL则下载执行，如果是PE，则创\n建进程执行（CreateProcess创建进程、傀儡进程、远程线程注入等）。\n指令码3、4、8：终结当前进程删除原始文件，或者重新启动。\n指令码7：再次收集C2、port、PID、文件名信息向C2进行发送，示例：\norcharddns.duckdns.org[o.r.c.h.a.r.d]5890[o.r.c.h.a.r.d]2260[o.r.c.h.a.r.d]stage3_.exe[o.r.c.h.a.r.d]\n\n**DGA算法**\n\n\n-----\n\nv1的DGA以日期字符串（比如 2022/07/05 ）作为输入，计算其MD5值，然后将MD5字符串均\n分成长度为8的四个子字符串，依次与 .com、.net、.org、.duckdns.org 这4个后缀拼接，得到\n每天4组16个DGA域名，算法实现如下。\n```\n# 2021/04/15\n\nimport datetime\n\nimport hashlib\n\ndays=30\n\nfor i in range(0, days):\n\n  datex = (datetime.datetime.now() datetime.timedelta(days=i)).strftime('%Y/%m/%d')\n\n  print(\"seed: \", datex)\n\n  md5 = hashlib.md5(datex.encode()).hexdigest()\n\n  print('md5: ', md5)\n\n  dga_list = []\n\n  dga_list.append(md5[:8])\n\n  dga_list.append(md5[8:16])\n\n  dga_list.append(md5[16:24])\n\n  dga_list.append(md5[24:32])\n\n  for j in range(len(dga_list)):\n\n    print(dga_list[j] + '.com')\n\n    print(dga_list[j] + '.net')\n\n    print(dga_list[j] + '.org')\n\n    print(dga_list[j] + '.duckdns.org')\n\n\n```\n示例域名如下：\n```\nseed: 2022/07/05\n\nmd5: 91ac64d29f78281ad802f44648b2137f\n\n91ac64d2.com\n\n91ac64d2.net\n\n91ac64d2.org\n\n91ac64d2.duckdns.org\n\n9f78281a.com\n\n9f78281a.net\n\n9f78281a.org\n\n9f78281a.duckdns.org\n\nd802f446.com\n\nd802f446.net\n\nd802f446.org\n\nd802f446.duckdns.org\n\n48b2137f.com\n\n48b2137f.net\n\n48b2137f.org\n\n48b2137f.duckdns.org\n\n\n### v2版本\n\n```\n\n-----\n\nv2版本出现了两种编程语言实现的样本，分别是Golang和C++，但是功能相同。这里的分析\n[以MD5=f3e0b960a48b433bc4bfe6ac44183b74的Golang样本为例，它的C2初始化函数如下](https://www.virustotal.com/gui/file/5da3a405fea843ed422c06987179e0ac47b915c1d12cc608ce4ecb187edf5f03/details)\n图所示，能明显看到硬编码的C2域名。\n\nv2版本开始使用json格式，字段含义相对清晰。其收集的信息跟v1大致相同，包括：卷序列号\n（HWID）、电脑名称、用户名、系统版本、杀软信息、活动窗口信息等，新增的字段\n有：.net框架版本（比如v2.0.50727）、USB 状态、发包类型及自身版本。下面是一个实际观\n察到的版本号信息，Bot_Version=1.2/G可能的解释为：版本=v1.2，编写语言=Golang。\n\n\n-----\n\nv2版本的C++语言样本集成了同样的C2，上线包中的版本信息则变成了 Bot_version:1/C ，它\n所收集的信息如下图所示。\n\n根据代码相似性分析，v2版本的C++样本跟后来的v3版本代码同源，说明后者是从前者进化而\n来。\n\nv2版本一共有两种指令：\n\n指令1：终结当前进程删除原始文件，或者重新启动。\n指令2：判断响应数据为URL或者PE，如果是URL则下载执行，如果是PE，则创建进程\n执行（CreateProcess创建进程、傀儡进程、远程线程注入等）。\n\n**DGA算法**\n\nv2版本的DGA算法跟v1相同，差别在于对日期字符串的处理，v2会在日期字符串后拼接硬编\n码的域名“orchardmaster.duckdns.org”，形如“2022/07/05orchardmaster.duckdns.org\"，然后\n套用v1版本的DGA算法生成域名。\n\n### v3版本\n\nv3的开发语言回到C++编写，同样包括C2通信和USB感染功能。C2通信逻辑在一个线程中运\n行，同时该线程还包括一个跟XMRig挖矿绑定的辅助线程，当Orchard接收完毕下发的XMrig\n程序并创建傀儡进程运行之后，辅助线程会向C2再次发送挖矿相关的硬件信息，尝试从C2读\n取挖矿软件的配置，目的是为了检查是否需要动态修改XMRig运行时的配置（XMRig提供了一\n套HTTP api，支持动态读取并修改运行时的挖矿配置）。\n\n以MD5=cb442cbff066dfef2e3ff0c56610148f的样本为例，C2通信功能如下。\n\n\n-----\n\nv3版本在C2通信中同样使用json格式来保存主机信息，发送数据的整体结构为\n**Byte_0x46+TotalLen+InfoLen+Info.json。相比v2，v3增加了多个跟挖矿相关的字段，收集**\n的信息包括：\n\nActive_Window：当前活动窗口名称\nAntivirus：杀软信息\nAuthentiate_Type：Windows身份验证类型\nCPU_Model：CPU信息\nCamera：是否存在摄像头\nElevated：是否是管理员权限\nGPU_Models：显卡信息\nIdentity：HWID\\用户名\\电脑名称\nOperating_System：系统版本信息\nRam_Size：运行内存大小\nSystem_Architecture：处理器个数\nThreads：每个处理器内核个数\nVersion：Orchard版本\n\nv3的上线包实例如下所示。\n\n\n-----\n\nC2响应消息的body部分也为json格式，其结构为：TotalLen.dword+\nByte0x46+TotalLen+RespDataLen+RespData.json。v3支持8个指令，对应3种操作：\n\n指令1：收集主机信息/自身运行状态并发送到C2（字段包括Domain、In_Memory、\nInstall_Path、Is_Patched、Message_Type、Patch_Name、Port、\nPower_SaverMode、Process_ID、Process_Name、Process_Path、System_Idle、\nSystem_Uptime）\n指令4、6：终结当前进程删除原始文件，或者重新启动。\n指令7、8：下载&执行下发的矿机程序\n\n下面是一个实际跟踪到的C2响应指令。\n\n其中Transfer_Port表示希望主机再次向2929进行请求，Message_Type表示指令码，其值为\n7，表示下载&执行。\n\n\n-----\n\n收到上述指令后，bot再次向C2的TCP 2929端口发起请求，Cuda是Nvidia推出的只能用于自\n家GPU的并行计算框架，这里的Cuda_Version为0表示不支持Cuda。\n\n随后C2响应一个XMRig矿机程序，Client接收保存后根据指令7将XMRig注入傀儡进程开始执\n行挖矿工作。\n\n分析过程中我们发现v3版本最近在持续分发一个同样的XMRig挖矿程序，后者集成了默认的挖\n矿配置信息，私有矿池地址：45.61.187.7:7733\n\n**DGA算法**\n\n\n-----\n\nv3的DGA算法未变，但输入的变化较大。实际上它会生成两组DGA域名，第 组域名的输入\n拼接算法是日期字符串+“ojena.duckdns.org”， 形如 “2022-08-02ojena.duckdns.org”。第二组\n域名的输入为 `https://blockchain.info/balance?`\n\n`active=1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa` 这个URL的返回结果，一个典型的返回结\n果如下所示：\n```\n{\"1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa\":\"final_balance\":6854884253,\"n_tx\":3393,\"total_re\n\n\n```\n[相关字段的含义可以参考Blockchain的API手册：](https://zh.m.wikipedia.org/zh-hans/Blockchain.com)\n```\nn_tx：交易数量\ntotal_received：接收比特币总量\nfinal_balance：最终余额\n\n```\n值得强调的是v3版本并未对返回的结果进行解析，而是作为整体直接输入DGA算法来生成域\n名。而钱包地址 `1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa` 据说是中本聪本人所持有的比特\n币创世地址。过去的十几年间，由于各种原因，每天都会有人向该钱包转入小量比特币，因此\n它是变化的，并且该变化很难预测，因此该钱包的余额信息也可以作为DGA输入。\n\n在我们编写文章时，发现近期已有其他研究人员注意到v3版本这种将比特币账号交易信息用作\nDGA输入的现象，所分析结果与我们一致，但对方并没有注意到Orchard其实早已出现。\n\n完整的v3版本DGA算法如下：\n\n\n-----\n\n```\n# 2022/07/05\n\nimport datetime\n\nimport requests\n\nimport hashlib\n\n# cluster 1\n\ndays = 30\n\nfor i in range(0, days):\n\n  domains = ['ojena.duckdns.org', 'vgzero.duckdns.org']\n\n  for do in domains:\n\n    datex = (datetime.datetime.now() - datetime.timedelta(days=i)).strftime('%Y%m-%d' + do)\n\n    print(\"seed_1: %s\" % datex)\n\n    md5 = hashlib.md5(datex.encode()).hexdigest()\n\n    print(\"md5: %s\" % md5)\n\n    dga_list = []\n\n    dga_list.append(md5[:8])\n\n    dga_list.append(md5[8:16])\n\n    dga_list.append(md5[16:24])\n\n    dga_list.append(md5[24:32])\n\n    for j in range(len(dga_list)):\n\n      print(dga_list[j] + '.com')\n\n      print(dga_list[j] + '.net')\n\n      print(dga_list[j] + '.org')\n\n      print(dga_list[j] + '.duckdns.org')\n\n\n# cluster 2\n\nurl = 'https://blockchain.info/balance?active=1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa'\n\nres = requests.get(url)\n\nwallet_info = res.text\n\nprint('seed_2: %s' % wallet_info)\n\nmd5 = hashlib.md5(wallet_info.encode()).hexdigest()\n\nprint('md5: %s' % md5)\n\ndga_list = []\n\ndga_list.append(md5[:8])\n\ndga_list.append(md5[8:16])\n\ndga_list.append(md5[16:24])\n\ndga_list.append(md5[24:32])\n\nfor j in range(len(dga_list)):\n\n  print(dga_list[j] + '.com')\n\n  print(dga_list[j] + '.net')\n\n  print(dga_list[j] + '.org')\n\n  print(dga_list[j] + '.duckdns.org')\n\n\n### USB感染逻辑\n\n```\n\n-----\n\nOrchard的文件感染并非传统的代码插入，而是 种文件替换。当检测到USB存储设备时，\nOrchard会在设备根目录下创建隐藏目录，遍历所有文件进行感染，并将感染前和感染后的文\n件都备份到该隐藏目录下，被感染对象在感染时去掉了类型属性，感染后全部变为exe类型，\n并追加了.exe后缀，变成了可执行文件。随后样本会复制自身到被感染目录下并随机命名，该\n字符串保存到了被感染文件的资源里。当设备中的被感染文件在新系统中被用户执行后，则会\n启动隐藏目录中的样本文件，达到感染传播的目的。\n\nUSB感染过程会涉及两个内嵌的PE文件，第一个文件是DLL文件，会被释放\n到%LocalAppData%目录下，该DLL被Orchard称作CGO_Helper，主要用于提取和替换被感\n染文件的图标，其MD5是10D42F5465D5D8808B43619D8266BD99。第二个文件是exe文\n件，MD5为f3c06399c68c5fdf80bb2853f8f2934b，作为存储感染代码的模板文件，被感染文\n件的全部数据将被替换为该模板文件的数据。该模板的功能是根据资源中的exe名称寻找隐藏\n目录下对应的exe启动执行，所以被感染文件的资源中保存的是备份的Orchard样本名称。\n\nUSB感染情况示例如下，被感染文件资源中保存了Orchard样本的名称，当用户点击受感染的\nexe，将启动隐藏目录下的Orchard样本文件：\n\n## 总结\n\nOrchard是一个使用了DGA技术的botnet家族，最新版本致力于挖矿，并开始使用中本聪的比\n特币账号交易信息这类更难预测的信息作为DGA的输入，增加了检测难度。在1年多的时间\n里，Orchard先后出现了至少3个不同版本，编程语言和DGA实现都有变化，这说明Orchard是\n一个仍处于活跃期的botnet家族，预计后续会有更多的变种出现，值得我们警惕。对Orchard\n我们会持续保持关注，有新的发现会继续公开。\n\n\n-----\n\n## 联系我们\n\n感兴趣的读者，可以在 **[twitter](https://twitter.com/360Netlab)** 或者通过邮件netlab[at]360.cn联系我们。\n\n## IOCs\n\n### C2\n```\norcharddns.duckdns.org\n\norchardmaster.duckdns.org\n\nojena.duckdns.org\n\nvgzero.duckdns.org\n\nvictorynicholas.duckdns.org\n\nzamarin1.duckdns.org\n\n45.61.185.36\n\n45.61.186.52\n\n45.61.187.240\n\n205.185.124.143\n\n45.61.185.231\n\n MD5\n5c883ff8539b8d04be017a51a84e3af8\n\nf3e0b960a48b433bc4bfe6ac44183b74\n\n9cbe4bd27eba8c70b6eddaeb6707659b\n\ncb442cbff066dfef2e3ff0c56610148f\n\n10D42F5465D5D8808B43619D8266BD99\n\nf3c06399c68c5fdf80bb2853f8f2934b\n\n19159280736dbe6c11b7d6a57f6bb7b9\n\nb5a6f78d5575a60316f4e784371d4f8c\n\n3c20ba851edecd28c198691321429883\n\n2b244a39571ab27f7bb4174d460adeef\n\nae1e9b3621ee041be6ab5e12bff37c53\n\n00b1620f89b7980b34d53737d9e42fd3\n\n4d2445a43591d041cabbbf3dfca6dfbd\n\n 私有矿池\n45.61.187.7:7733\n\n```\n\n-----",
    "language": "ZH",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-08-05 - The DGA family Orchard continues to change, and the new version generates DGA domain names using Bitcoin transaction information.pdf"
    ],
    "report_names": [
        "2022-08-05 - The DGA family Orchard continues to change, and the new version generates DGA domain names using Bitcoin transaction information.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535914,
    "ts_updated_at": 1743041138,
    "ts_creation_date": 1664713195,
    "ts_modification_date": 1664713195,
    "files": {
        "pdf": "https://archive.orkl.eu/16295754c1047ce13e4c83cb0dd6be7b4acdaad8.pdf",
        "text": "https://archive.orkl.eu/16295754c1047ce13e4c83cb0dd6be7b4acdaad8.txt",
        "img": "https://archive.orkl.eu/16295754c1047ce13e4c83cb0dd6be7b4acdaad8.jpg"
    }
}