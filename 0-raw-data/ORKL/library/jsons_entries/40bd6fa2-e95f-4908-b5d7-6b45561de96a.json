{
    "id": "40bd6fa2-e95f-4908-b5d7-6b45561de96a",
    "created_at": "2023-01-12T15:09:50.588411Z",
    "updated_at": "2025-03-27T02:15:46.078549Z",
    "deleted_at": null,
    "sha1_hash": "53cdde8531f7c6f92be9c2a46eb87f2dfef18f35",
    "title": "2016-10-03 - Remsec driver analysis",
    "authors": "",
    "file_creation_date": "2022-05-27T21:13:42Z",
    "file_modification_date": "2022-05-27T21:13:42Z",
    "file_size": 250017,
    "plain_text": "# Remsec driver analysis\n\n**[artemonsecurity.blogspot.com/2016/10/remsec-driver-analysis.html](https://artemonsecurity.blogspot.com/2016/10/remsec-driver-analysis.html)**\n\n[Remsec or Cremes malware already was perfectly described by Kaspersky in their report.](https://securelist.com/analysis/publications/75533/faq-the-projectsauron-apt/)\n[Symantec also did a blog post about it. This sophisticated malware toolkit refers to so-called](http://www.symantec.com/connect/blogs/strider-cyberespionage-group-turns-eye-sauron-targets)\nstate-sponsored actor, which was named by KL as ProjectSauron or Strider by SYMC. There\nare some similarities between Remsec and other serious state-sponsored projects like\nEvilBunny (Animal Farm) or Flame (Equation Group). The toolkit contains a lot of modules\nfor cyberespionage. As already declared by the Russian special service (FSB), the attackers\nhave used unique malware files in case of each victim. This means that attacks were\nimplemented in highly targeted manner.\n\nOne of the malware components was not described by KL or other AVers. This component is\na driver and it works into kernel mode (Ring 0). Frankly speaking, the driver has compact\nsize and is designed only for one purpose: execute Ring 3 code from kernel mode with\nSMEP bypass. Nothing special, but...The quality of written code confirms for us the fact that\ndriver was written by skilled developers and intended to be hidden. These properties are\nideally suited to the task the malware should perform.\n\nBelow are listed the facts about the driver (aswfilt.dll).\n\nIt has small size and fits in one memory page (4KB).\nIt has the zeroed timestamp and one unnamed NONPAGED section.\nIt has dynamic imports that is stored into special driver struct with ptr at DeviceObject>DeviceExtension.\nThe code uses some sort of offsets obfuscation inside its body.\nThe code is written in right way.\n\n\n-----\n\nThe driver is loaded into a system by the dropper that exploits vulnerability in Agnitum driver\ncalled Sandbox.sys. The dropper contains inside itself driver file, file of Agnitum Sandbox.sys\nand code for its exploitation. Below you can see part of the dropper that drops Sandbox.sys\nto disk.\n\nAfter loading Agnitum Sandbox.sys, it sends to it a special IOCTL that forces it to load the\nrootkit driver.\n\n\n-----\n\nThe rootkit driver creates device with name \\Device\\rwx and the client uses path\n**\\\\.\\GLOBALROOT\\Device\\rwx to communicate with it.**\nTo disable SMEP, the client should sent to driver IOCTL with code 0x1173000C.\n\n\n-----\n\n[Note that unlike developers of Capcom.sys driver, authors of Remsec disables SMEP in right](https://twitter.com/TheWack0lian/status/779397840762245124)\nway.\nNext structure describes DeviceContext that is used by rootkit as storage for run-time global\ndata.\n\nstruct RootkitStruct {\n\nPVOID ExAllocatePool;\nPVOID ExFreePool;\nPVOID IoCompleteRequest;\nPVOID IoCreateDevice;\nPVOID IoDeleteDevice;\nPVOID KeAcquireSpinLock;\nPVOID KeCancelTimer;\nPVOID KeInitializeEvent;\nPVOID KeInitializeSpinLock;\nPVOID KeInitializeTimer;\nPVOID KeQueryInterruptTime;\nPVOID KeReleaseSpinLock;\nPVOID KeSetEvent;\nPVOID KeSetTimer;\nPVOID KeWaitForMultipleObjects;\nPVOID ObfReferenceObject;\nPVOID ObDereferenceObject;\n\n\n-----\n\nPVOID PsCreateSystemThread;\nPVOID PsGetVersion;\nPVOID PsTerminateSystemThread;\nPVOID ZwClose;\nPVOID ZwCreateKey;\nPVOID ZwDeleteKey;\nPVOID ZwEnumerateKey;\nPVOID ZwOpenKey;\nPVOID ZwSetValueKey;\nPVOID ZwUnloadDriver;\nPVOID KeQueryActiveProcessors;\nPVOID KeSetSystemAffinityThread;\nPVOID KeRevertToUserAffinityThread;\nULONG Flag;\nKEVENT Event;\nULONG dwField1;\nKTIMER Timer;\nKSPIN_LOCK SpinLock;\nULONG dwField2;\nLARGE_INTEGER IntervalTime;\nUNICODE_STRING unDriverRegistryPath;\n};\n\nThe driver supports an interesting method of unloading. It creates additional thread in\nDriverEntry and supports timer object for unloading from this thread. As there are two\npossible threads which can compete for the possession of the object, the driver supports\nspecial spinlock object. This object is captured each time when function wants to get access\nto timer. The timer interval can be set by client with special IOCTL code 0x117300CC. Timer\nguarantees the client that driver will unload as soon as possible.\n\n\n-----\n\nDriver plays with spinlock in next manner. Before executing code in\nIRP_MJ_DEVICE_CONTROL handler, the rootkit cancels timer and set it again before\nexiting from it.\n\nKeAcquireSpinLock();\nFlag1 = DeviceExtension->Flag1;\nFlag2 = DeviceExtension->Flag2;\nif( Flag1 & Flag2 ) {\nKeSetTimer();\n}\nKeRelaseSpinLock();\n\nAnd\n\nKeAcquireSpinLock();\nFlag1 = DeviceExtension->Flag1;\nFlag2 = DeviceExtension->Flag2;\nif( Flag1 & Flag2 ) {\nKeCancelTimer();\n}\nKeRelaseSpinLock();\n\n\n-----\n\nThe thread waits on timer and executes cleanup after time has elapsed.\n\n\n-----\n\nDriver also has function with name fnRemoveRegKeyTree that recursively removes registry\nkey.\n\nAs it became clear from the analysis, the driver is intended for one purpose: execute function\nfrom user mode address space and next, unload as fast as possible. Driver's code uses\nspinlock and this is reason why authors are forced to use nonpaged section, that's untypical\nfor such type of drivers.\n\n**UPDATE**\nI noticed interesting thing in procedure of driver unloading that looks like mistake for\nme. Let's look at this situation in more detail.\n\nAs I already mentioned above, the driver supports unloading procedure when some\nconditions were triggered. It is waiting for timer object in fnThreadStartFunction and when\ntime elapses, the code calls fnCreateDriverRegKeyOrRemoveIt. Below you can see a chart\nof this process.\n\n\n-----\n\nAs you can see, when system thread has returned from ZwUnloadDriver, there is a high\nprobability that page with driver's code is already invalid, because IopDeleteDriver\ncalls MmUnloadSystemImage for mark virtual memory page which belong to driver as free\nfor further using.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-10-03 - Remsec driver analysis.pdf"
    ],
    "report_names": [
        "2016-10-03 - Remsec driver analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "a0d369c1-f0b7-4c70-a3a5-77aabbd17979",
            "created_at": "2022-10-25T15:50:23.311311Z",
            "updated_at": "2025-03-27T02:00:55.438117Z",
            "deleted_at": null,
            "main_name": "Strider",
            "aliases": [
                "ProjectSauron"
            ],
            "source_name": "MITRE:Strider",
            "tools": [
                "Remsec"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "99845f58-2c39-46f7-8369-bb621ebb7002",
            "created_at": "2022-10-25T16:07:24.238844Z",
            "updated_at": "2025-03-27T02:02:10.14785Z",
            "deleted_at": null,
            "main_name": "Strider",
            "aliases": [
                "ProjectSauron"
            ],
            "source_name": "ETDA:Strider",
            "tools": [
                "Backdoor.Remsec",
                "ProjectSauron",
                "Remsec"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c1ac2a5e-0225-47a4-8ac5-5fa898c96bde",
            "created_at": "2023-01-06T13:46:38.472883Z",
            "updated_at": "2025-03-27T02:00:02.84253Z",
            "deleted_at": null,
            "main_name": "ProjectSauron",
            "aliases": [
                "Sauron",
                "Project Sauron",
                "G0041"
            ],
            "source_name": "MISPGALAXY:ProjectSauron",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e09a7338-fb16-4e39-b579-c3bfc3140c47",
            "created_at": "2022-10-25T16:07:24.207294Z",
            "updated_at": "2025-03-27T02:02:10.140203Z",
            "deleted_at": null,
            "main_name": "Snowglobe",
            "aliases": [
                "ATK 8",
                "Animal Farm",
                "SIG20",
                "Snowglobe"
            ],
            "source_name": "ETDA:Snowglobe",
            "tools": [
                "Babar",
                "Casper",
                "Chocopop",
                "Dino",
                "EvilBunny",
                "Nbot",
                "TFC",
                "Tafacalou"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "08623296-52be-4977-8622-50efda44e9cc",
            "created_at": "2023-01-06T13:46:38.549387Z",
            "updated_at": "2025-03-27T02:00:02.859535Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "Tilded Team",
                "EQGRP",
                "G0020"
            ],
            "source_name": "MISPGALAXY:Equation Group",
            "tools": [
                "EquationLaser",
                "EquationDrug",
                "DoubleFantasy",
                "TripleFantasy",
                "GrayFish"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2d9fbbd7-e4c3-40e5-b751-27af27c8610b",
            "created_at": "2024-05-01T02:03:08.144214Z",
            "updated_at": "2025-03-27T02:05:17.419705Z",
            "deleted_at": null,
            "main_name": "PLATINUM COLONY",
            "aliases": [
                "Equation Group "
            ],
            "source_name": "Secureworks:PLATINUM COLONY",
            "tools": [
                " EquationDrug",
                " EquationLaser",
                " Fanny",
                " GrayFish",
                " TripleFantasy",
                "DoubleFantasy"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "548a4081-aa8f-4e2a-bcb3-0c9dfa61944f",
            "created_at": "2023-01-06T13:46:38.443779Z",
            "updated_at": "2025-03-27T02:00:02.835042Z",
            "deleted_at": null,
            "main_name": "SNOWGLOBE",
            "aliases": [
                "Snowglobe",
                "ATK8",
                "Animal Farm"
            ],
            "source_name": "MISPGALAXY:SNOWGLOBE",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e0fed6e6-a593-4041-80ef-694261825937",
            "created_at": "2022-10-25T16:07:23.593572Z",
            "updated_at": "2025-03-27T02:02:09.879892Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "APT-C-40",
                "Platinum Colony",
                "Tilded Team"
            ],
            "source_name": "ETDA:Equation Group",
            "tools": [
                "Bvp47",
                "DEMENTIAWHEEL",
                "DOUBLEFANTASY",
                "DanderSpritz",
                "DarkPulsar",
                "DoubleFantasy",
                "DoubleFeature",
                "DoublePulsar",
                "Duqu",
                "EQUATIONDRUG",
                "EQUATIONLASER",
                "EQUESTRE",
                "Flamer",
                "GRAYFISH",
                "GROK",
                "OddJob",
                "Plexor",
                "Prax",
                "Regin",
                "Skywiper",
                "TRIPLEFANTASY",
                "Tilded",
                "UNITEDRAKE",
                "WarriorPride",
                "sKyWIper"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536190,
    "ts_updated_at": 1743041746,
    "ts_creation_date": 1653686022,
    "ts_modification_date": 1653686022,
    "files": {
        "pdf": "https://archive.orkl.eu/53cdde8531f7c6f92be9c2a46eb87f2dfef18f35.pdf",
        "text": "https://archive.orkl.eu/53cdde8531f7c6f92be9c2a46eb87f2dfef18f35.txt",
        "img": "https://archive.orkl.eu/53cdde8531f7c6f92be9c2a46eb87f2dfef18f35.jpg"
    }
}