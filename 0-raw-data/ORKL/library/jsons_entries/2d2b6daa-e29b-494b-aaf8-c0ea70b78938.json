{
    "id": "2d2b6daa-e29b-494b-aaf8-c0ea70b78938",
    "created_at": "2023-01-12T15:01:03.804012Z",
    "updated_at": "2025-03-27T02:09:17.980785Z",
    "deleted_at": null,
    "sha1_hash": "fcf232f4ea1c64a96d59fd267745b5cd3755ec33",
    "title": "2022-01-19 - Collecting Cobalt Strike Beacons with the Elastic Stack",
    "authors": "",
    "file_creation_date": "2022-05-27T23:21:00Z",
    "file_modification_date": "2022-05-27T23:21:00Z",
    "file_size": 4148833,
    "plain_text": "# Collecting Cobalt Strike Beacons with the Elastic Stack\n\n**[elastic.github.io/security-research/intelligence/2022/01/02.collecting-cobalt-strike-beacons/article/](https://elastic.github.io/security-research/intelligence/2022/01/02.collecting-cobalt-strike-beacons/article/)**\n\n[Tutorial](https://elastic.github.io/security-research/tags/#tutorial) [Cobalt Strike](https://elastic.github.io/security-research/tags/#cobalt-strike) [Fleet](https://elastic.github.io/security-research/tags/#fleet)\n\n\n-----\n\n-----\n\n2022-01-19\n\n## Overview¶\n\n[Cobalt Strike is a premium offensive security tool leveraged by penetration testers and red](https://attack.mitre.org/software/S0154/)\nteam members as a way to emulate adversary behavior. The goal is to validate security\ndetection capabilities and processes replicating a real-world intrusion. While Cobalt Strike is\na legitimate tool, it is often [abused by actual threat actors as a way to gain and maintain](https://www.proofpoint.com/uk/blog/threat-insight/cobalt-strike-favorite-tool-apt-crimeware)\npersistence into targeted networks.\n\nTo manage command and control, Cobalt Strike leverages an implant that uses beacon\nconfiguration known as a [Malleable Command and Control (Malleable C2) profile. A](https://www.cobaltstrike.com/help-malleable-c2)\nMalleable C2 profile contains a tremendous number of options to configure the beacon’s\n[functionality, please see Cobalt Strike’s official documentation for specifics on configuring](https://www.cobaltstrike.com/help-beacon)\nMalleable C2 beacons.\n\nThis blog will focus on using the Elastic Stack to collect Cobalt Strike beacon payloads,\nextract and parse the beacon configurations, and an analysis of the metadata within the\nconfigurations. This will all be taken from the memory of targeted Windows endpoints that\nwe’ve collected from our telemetry.\n\n## The Fleet Policy¶\n\n[Fleet is an app in Kibana that provides a central place to configure and monitor your Elastic](https://www.elastic.co/guide/en/kibana/current/fleet.html)\nAgents. Fleet uses [integrations, which are unified plugins that allow data to be collected from](https://www.elastic.co/guide/en/fleet/current/integrations.html)\napps and services and then stored in Elasticsearch Integrations are added to policies and\n\n\n-----\n\nElastic Agents are added to policies.\n\nFirst, we need to configure the collection of shellcode and malicious memory regions in a\nFleet policy. This will collect 4MB of data from memory surrounding shellcode and malicious\nmemory events. It should be noted that this collection may significantly increase the amount\nof data stored in Elasticsearch.\n\nYou can add this to an existing policy or create a new policy. To create a new policy, in\nKibana, navigate to Fleet → Agent Policies → Create agent policy. Give your policy a name\nand description. Optionally, you can disable “System monitoring” and “Agent monitoring” to\nreduce the amount of system and agent metadata collected from your endpoints. Click on\n“Create agent policy”.\n\n\n-----\n\nNext, click on your new policy and click the “Add integration button.\n\n\n-----\n\nIn the search box, type “security” and select “Endpoint Security”.\n\n\n-----\n\nNext, click the “Add Endpoint Security” button.\n\n\n-----\n\nNext, you’ll give the integration a name and description, and then click “Save integration”.\n\n\n-----\n\nFinally, we’re going to add the memory and shellcode collection options. Click on the\nintegration name (“Endpoint Security”).\n\n\n-----\n\nUnder “Protections”, leave the different protection types selected, but change the Protection\nlevel from “Prevent” to “Detect”. This will allow malware to continue to run to allow for more\nrich event collection. There are several types of Protections (Malware, Memory, etc.), select\n“Detect” for each type that has Windows as an available “Operating system”; you can\nuncheck Mac and Linux Operating Systems. If you are enabling this feature for a\n**production environment, leave the Protection levels as “Prevent”**\n\n\n-----\n\nAt the bottom of the integration configuration page, you can toggle “Register as antivirus” so\nthat the Elastic Agent is registered as the Antivirus solution, and disable Windows Defender.\nClick on “Show advanced settings”.\n\n\n-----\n\nAt the very bottom of the advanced settings page, type “true” for the\n```\nwindows.advanced.memory_protection.shellcode_collect_sample and\nwindows.advanced.memory_protection.memory_scan_collect_sample settings, and\n\n```\nthen click “Save integration”.\n\nOnce you have created this specific Fleet policy, you can apply this policy to an endpoint\nrunning the Elastic Agent. For specific instructions on how to deploy the Elastic Agent, refer\nto the [official Elastic documentation.](https://www.elastic.co/guide/en/fleet/current/elastic-agent-installation.html#install-fleet-managed-agent)\n\n## Collecting the Beacon¶\n\nNow that we’ve made a collection policy and applied it to a Windows machine you can target\nit with a CobaltStrike campaign. Instead of mimicking what a CobaltStrike beacon could look\nlike in a lab, we’re going to use live CobaltStrike beacon payloads from Elastic’s telemetry.\n\nTo find Cobalt Strike beacon payloads, you can use the Discover app in Kibana to return\nevents identified as Cobalt Strike. These events are provided by the Elastic Endpoint\nSecurity Agent, which identifies Cobalt Strike beacons and modules with the\n[“Windows.Trojan.CobaltStrike” malware signature. A simple Kibana Query Language (KQL)](https://www.elastic.co/guide/en/kibana/current/kuery-query.html)\nsearch is as simple as:\n\n\n-----\n\nKQL search for Cobalt Strike\n```\nevent.category:(malware or intrusion_detection) and\nrule.name:(Windows.Trojan.CobaltStrike or Windows.Trojan.Cobaltstrike)\n\n```\nNext, let’s filter on documents that have the\n```\nprocess.Ext.memory_region.bytes_compressed field (this is a field populated by the\nwindows.advanced.memory_protection.shellcode_collect_sample and\nwindows.advanced.memory_protection.memory_scan_collect_sample settings we\n\n```\nconfigured in the Fleet policy above). To do that we can simply add a filter for the\n```\nprocess.Ext.memory_region.bytes_compressed_present field with a value of true .\n\n```\nFinally, add the `process.Ext.memory_region.bytes_compressed field to our view so that`\nwe can see the value of the field.\n\n\n-----\n\nWe can see that we have 133 examples with data in the\n```\nprocess.Ext.memory_region.bytes_compressed field. This field contains the file\n\n```\nextracted from the memory of the infected host and then zlib deflated and Base64 encoded..\n\nNow that we’ve collected the file in the Elastic Stack, let’s turn that raw data into a file that we\ncan analyze.\n\n\n-----\n\nThere is a lot of nuance between operating systems on how to decode Base64 and inflate\nzlib deflated files. If you’d prefer to use your command line or local tools, feel free to do so.\nThat said, [CyberChef is a browser-based data parser that is provided for free by the United](https://gchq.github.io/CyberChef)\nKingdom’s Government Communications Headquarters (GCHQ).\n\n[Using the CyberChef web application, add the “From Base64” and “Zlib Inflate” recipes.](https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true)Zlib_Inflate(0,0,'Adaptive',false,false))%0Aand%20then%20paste%20the%20contents%20of%20the%20process.Ext.memory_region.bytes_compressed%20field%20into%20the%20%22Input%22%20section.%20This%0Awill%20decode%20the%20Base64%20encoded%20string%20and%20inflate%20the%20zlib%20archive.%20There%20are%20more%20recipes%20that%20we%20could%20add,%20like%0A%22Strings%22,%20but%20we'll%20download%20the%20actual%20beacon%20payload%20binary%20and%20do%20some%20local%20analysi)\n\nClick on the disk icon to download the inflated binary.\n\nRunning the `file command, we can see that this is a Portable Executable (PE) file that`\ncan be analyzed by a malware reverse engineer (RE).\n\nUsing the file command to validate the file type\nWhile an RE can identify a tremendous amount of information, let’s explore what additional\ninformation a non-RE can obtain from this file.\n\n## Next Steps¶\n\n\n-----\n\nIn the next [release, we ll use the beacon that we ve just collected and extract its](https://elastic.github.io/security-research/intelligence/2022/01/03.extracting-cobalt-strike-beacon/article/)\nconfiguration. With this information, we’ll be able to identify other important elements such as\nlicense identifications, watermarks, and atomic indicators.\n\nLast update: January 31, 2022\nCreated: January 19, 2022\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-19 - Collecting Cobalt Strike Beacons with the Elastic Stack.pdf"
    ],
    "report_names": [
        "2022-01-19 - Collecting Cobalt Strike Beacons with the Elastic Stack.pdf"
    ],
    "threat_actors": [
        {
            "id": "5d2bd376-fcdc-4c6a-bc2c-17ebbb5b81a4",
            "created_at": "2022-10-25T16:07:23.667223Z",
            "updated_at": "2025-03-27T02:02:09.916086Z",
            "deleted_at": null,
            "main_name": "GCHQ",
            "aliases": [
                "Government Communications Headquarters",
                "Operation Socialist"
            ],
            "source_name": "ETDA:GCHQ",
            "tools": [
                "Prax",
                "Regin",
                "WarriorPride"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535663,
    "ts_updated_at": 1743041357,
    "ts_creation_date": 1653693660,
    "ts_modification_date": 1653693660,
    "files": {
        "pdf": "https://archive.orkl.eu/fcf232f4ea1c64a96d59fd267745b5cd3755ec33.pdf",
        "text": "https://archive.orkl.eu/fcf232f4ea1c64a96d59fd267745b5cd3755ec33.txt",
        "img": "https://archive.orkl.eu/fcf232f4ea1c64a96d59fd267745b5cd3755ec33.jpg"
    }
}