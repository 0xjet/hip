{
    "id": "555fad38-2449-4a17-b853-c35a047351cf",
    "created_at": "2023-01-12T15:09:55.870165Z",
    "updated_at": "2025-03-27T02:05:33.739109Z",
    "deleted_at": null,
    "sha1_hash": "2aa0c72710b35ded4be6e68095efc37bdf3ef5ca",
    "title": "2012-02-01 - TDL4 - Purple Haze (Pihar) Variant - sample and analysis",
    "authors": "",
    "file_creation_date": "2022-05-28T17:27:10Z",
    "file_modification_date": "2022-05-28T17:27:10Z",
    "file_size": 651144,
    "plain_text": "# TDL4 - Purple Haze (Pihar) Variant - sample and analysis\n\n**[contagiodump.blogspot.com/2012/02/purple-haze-bootkit.html](http://contagiodump.blogspot.com/2012/02/purple-haze-bootkit.html)**\n\nLately things just don't seem the same\n\nActin' funny, but I don't know why\n\n'Scuse me....... while I kiss the sky\n\n**[Jimi Hendrix \"Purple Haze\"](http://www.youtube.com/watch?v=XZ26U1coNkg)**\n\nI recently ran into an interesting piece of malware that was downloaded on a victim's\ncomputer. I thought it was TDL/TDSS or maybe a new version of it as it had same\ncomponents as TDL4 bootkit with a functionality of a mass scale PPC (pay-per-click) fraud.\nTDL had this functionality too and it is most likely spread by the same Russian-speaking\ngangs using the Blackhole exploit kit. It did not have the same type of config file that you may\nfind in TDL4 (and first I could not find it at all). I call it \"Purple Haze\" thanks to the strings\nfound in the code.\n\nI shared it with Alexander Matrosov from ESET. He and Eugene Rodionov analyzed it and\nposted an article on the ESET blog: \"TDL4 reloaded: Purple Haze all in my brain\" (edited by\nDavid Harley)\n\nEset also updated the removal tool for this variant - direct download link: OlmarikTDL4\nremover\n\n## Distribution\n\n\n-----\n\n[The exploit host is featured on CleanMX . The domain was repossessed by GoDaddy after](http://support.clean-mx.de/clean-mx/viruses.php?ip=95.211.115.228&sort=id%20desc)\nJanuary 24, 2012 by but you can see some of the URLs. Infection happened via Blackhole\nexploit kit\n**95.211.115.228**\n\n## General File Information\n\nFile: w.php.exe\n\nSize: 130560\n\nMD5: A1B3E59AE17BA6F940AFAF86485E5907\n\n## Download\n\nDownload purplehazetdl.zip as a password protected archive (contact me if you need\n\nthe password)\n\nDownload pcap BIN_purplehaze-pihar-A1B3E59AE17BA6F940AFAF86485E5907-201202.zip (235MB)\n\n## Automatic scans\n\nOriginal scan was only 2/43 but it is better now. It gets detected as a generic trojan or rootkit\nor as TDL/TDSS/Alureon.\n\nVirustotal\n\nSHA256:   9746b4f684b9d7d346ff131cd024e68d1b06e1b81571ce6d3c5067f0829d7932\n\nSHA1:   6d07cf72201234a07ab57fb3fc00b9e5a0b3678e\n\nMD5:   a1b3e59ae17ba6f940afaf86485e5907\n\nFile size:   127.5 KB ( 130560 bytes )\n\nFile name:   w.php.exe\n\nFile type:   Win32 EXE\n\nDetection ratio:   24 / 43\n\nAnalysis date:   2012-02-02 06:50:05 UTC ( 1 minute ago )\n\nAntiVir   TR/Alureon.FK.93   20120201\n\nAvast   Win32:Rootkit-gen [Rtk]   20120202\n\nBitDefender   Trojan.Generic.7154539   20120202\n\nComodo   TrojWare.Win32.Trojan.Agent.Gen   20120202\n\nDrWeb   BackDoor.Tdss.5231   20120202\n\nEmsisoft   Trojan.Win32.FakeAV!IK   20120202\n\neSafe   Win32.Rorpian.C   20120130\n\n\n-----\n\nF-Secure   Trojan.Generic.7154539   20120202\nFortinet   W32/Rorpian.C!tr   20120202\nGData   Trojan.Generic.7154539   20120202\nIkarus   Trojan.Win32.FakeAV   20120202\nKaspersky   Trojan.Win32.FakeAV.kpsj   20120202  (TDSS Killer detects it as Pihar.b)\nMcAfee-GW-Edition   Artemis!A1B3E59AE17B   20120202\nMicrosoft   Trojan:Win32/Alureon.FK   20120202\nNOD32   Win32/Olmarik.AYD   20120202\nNorman   W32/Troj_Generic.LPAP   20120201\nSophos   Mal/Generic-L   20120202\nTrendMicro-HouseCall   TROJ_SPNR.16AQ12   20120202\nVBA32   -   20120131\nVIPRE   Trojan.Win32.Generic!BT   20120202\n\n## Desription\n\n**You can read more detailed binary analysis on the ESET blog (Feb.2 2012) :** \"TDL4\nreloaded: Purple Haze all in my brain\"\n**Update. Feb 2, 2012**\n\nI heard today it is a recent but known variant detected by Kaspersky as \"Pihar\", which is\nsupposedly a member of the TDL/TDSS/Olmarik/Alureon/ - Maxss family that does not\nencrypt the hidden container. I have to say I saw that Kaspersky detected it as Pihar.b via\nTDSS Killer (the dropper is detected as FakeAV) but it was a totally different name and I\ncould not find any explanation of how Pihar is different from TDL4 - whether it is a\nmisdetection, a different rootkit, some generic signature name, or a different variant of TDL.\nWith the number of malware variants these days in the wild, it does not surprise me that it\nwas known to them but there was no analysis posted (or I did not find it). I hope this analysis\nand the work done by ESET will make the family description more complete. TDSS Killer\nalso removes it.\n\nIt is a kernel mode rootkit compatible with x86 and x64 Windows. It uses dll injection ph.dll\nand phx.dll (for x64). It creates a hidden VFS to store all the data.\n\nThe list of hidden system files:\n\n1. Phdata\n\n[PurpleHaze]\n\npn=161\n\nall=ph.dll\n\nallx=phx.dll\nwait=3600\n2. phm (original master boot record)\n3. ph.dll (payload dll for x86)\n4. phx.dll (payload dll for x64)\n\n\n-----\n\n5. phd (driver x86)\n6. phdx (driver x64)\n7. phs (RC4 encrypted list of CC Urls, the key is phs - see the ESET post. In this case\n\nthey are\n\n**http://howtodoitman[.]com**\n**http://ntvgljvty[.]com**\n**http://chucjhomepage[.]com**\n**http://ebuyadult[.]com**\n**http://141.136.16.152**\n**http://piratesmustdie[.]com**\n**http://gjhyjljvty[.]com**\n\n8. phld (16-bit loader code)\n9. phln (rootkit driver replacing kdcom.dll for x86)\n10. phlx (rootkit driver replaceing kdcom.dll for x64)\n\nIt lowers internet security settings to enable the clicker component perform extensive\nbrowsing without any alerts or pop-ups.\n\n**Purple Haze**\n\n\n-----\n\n**Change IE settings**\n\n## Traffic\n\nPay-per-click fraud generates significant revenue for the botnet owners. The ‘Advertising’\n[Botnet\" article from Securelist explains the click fraud scheme in great detail.](http://www.securelist.com/en/analysis/204792172/The_Advertising_Botnet#2)\n\n\n-----\n\n\"Advertising Botnet\" by Securelist\n\n\n-----\n\nC&C check-in upon install\n\nThe bot generates high volume traffic to thousands of websites with ads, sites serving as\nreferrers, as well as pages filled with ad links (over 800 sessions a minute) for approximately\n2 hours and then stops. Most serious advertising companies easily detect large clicks from\nthe same ip and block it. The botnet owners limit clicks to just a few and compensate it by\nprogramming the bot to click on thousands of ads.\n\nClick to enlarge. 11 hours of traffic monitoring. 2 hour spike following the infection.\n\nTraffic capture - Using fake referrer (serch-direct.com) and passing fake search strings to the\nC&C, which responds with iframe redirect to the ad link.\n\n\n-----\n\nThere are hundreds of fake search and referrer sites in use in this case, starting from pages\ncontaining nothing but ad links and ending with several ip ranges serving iframe.The list of\nservers is below\n\nFake referrer = serch\n\nThe list of servers serving iframe content is limited to several 108.59.x.x ranges.\n\nThey all are hosted\n\n**108.59.4.128/27**\n**108.59.7.0/27**\n**108.59.13.160/27**\n\nIn all cases the registration information is as follows:\n\n\n-----\n\n**DOMAINS:**\nhosted-by.leaseweb.com\nWhoisGuard\nWhoisGuard Protected ()\nFax:\n11400 W. Olympic Blvd. Suite 200\nLos Angeles, CA 90064\nUnited States\n\n**IPs:**\nPrivate Customer\nPrivate Residence\nBryansk\n241000\nRussian Federation\n\nIn some cases, legitimate \"traffic quality\" providers were used as referrers, such as\nezanga.com\n\nThe list of hosts involved (if you think you might be a PPC fraud victim, see if you are in the\n\n\n-----\n\nlist. ( I had to remove the list because it attracts too many false search result cluicks - like\nblack SEO of sorts)\n\nQuery strings used (includes Parner / affiliate IDs - who gets paid for this traffic. The number\nin brackets shows the number of times it was used) ( I had to remove the list because it\nattracts too many false search result cluicks - like black SEO of sorts)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2012/2012-02-01 - TDL4 - Purple Haze (Pihar) Variant - sample and analysis.pdf"
    ],
    "report_names": [
        "2012-02-01 - TDL4 - Purple Haze (Pihar) Variant - sample and analysis.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536195,
    "ts_updated_at": 1743041133,
    "ts_creation_date": 1653758830,
    "ts_modification_date": 1653758830,
    "files": {
        "pdf": "https://archive.orkl.eu/2aa0c72710b35ded4be6e68095efc37bdf3ef5ca.pdf",
        "text": "https://archive.orkl.eu/2aa0c72710b35ded4be6e68095efc37bdf3ef5ca.txt",
        "img": "https://archive.orkl.eu/2aa0c72710b35ded4be6e68095efc37bdf3ef5ca.jpg"
    }
}