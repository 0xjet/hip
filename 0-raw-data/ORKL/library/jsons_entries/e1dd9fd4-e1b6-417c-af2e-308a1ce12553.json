{
    "id": "e1dd9fd4-e1b6-417c-af2e-308a1ce12553",
    "created_at": "2023-01-12T15:04:02.604351Z",
    "updated_at": "2025-03-27T02:06:10.935718Z",
    "deleted_at": null,
    "sha1_hash": "ea3b9c7e807499358fa64720b75f8d25ff1545ba",
    "title": "2020-06-09 - Valak Malware and the Connection to Gozi Loader ConfCrew",
    "authors": "",
    "file_creation_date": "2022-05-28T17:58:01Z",
    "file_modification_date": "2022-05-28T17:58:01Z",
    "file_size": 1133010,
    "plain_text": "# Valak Malware and the Connection to Gozi Loader ConfCrew\n\n**[labs.sentinelone.com/valak-malware-and-the-connection-to-gozi-loader-confcrew/](https://labs.sentinelone.com/valak-malware-and-the-connection-to-gozi-loader-confcrew/)**\n\nJason Reaves\n\n**_Valak uses a multi-stage, script-based malware that hijacks email replies and embeds_**\n**_malicious URLs or attachments to infect devices with fileless scripts._**\n\n_By Jason Reaves and Joshua Platt_\n\n## Executive Summary\n\nValak uses multi-stage, script-based malware utilized in campaigns reminiscent of Gozi\nConfCrew.\nThe overlapping campaign structure has led to some sandbox reports misidentifying\nValak as Gozi.\nEmails are harvested and used in ‘Reply Chain Attacks’ to further spread the malware\nwith a purpose-built plugin, ‘exchgrabber’.\nA newly-discovered plugin called ‘clientgrabber’ is also utilized for stealing email\ncredentials from the registry.\n\nSee the full report for more technicals details on Varak.\n\n[Read the Full Report](https://assets.sentinelone.com/labs/sentinel-one-valak-i)\n\n\n-----\n\n## Background\n\nGozi has been around in various forms for over a decade now. Certain variants are operated\nby more sophisticated actors, typically choosing to operate the trojan privately with partners\nor as a more functional rented service model. One variant in particular, which used the key\n10291029JSJUYNHG, is noticeable due to their unique ‘Reply’ chain or thread hijack\nspamming. At times this key has been confused with dreambot but is in fact operated\nseparately. The two primary functions of the service are loading and spamming.\n\nWhile this Gozi service has operated continuously for several years, in mid-October 2019,\nValak began to appear in testing mode. The new JavaScript-based system also involved\ncompromised servers with link-based email campaigns, which was a departure from the\ntypical password protected attachment approach.\n\n## Research Insight\n\n**Delivery – ConfCrew Delivery System**\n\nA recent Valak delivery chain utilized document files that contact PHP delivery proxies in\norder to pull down and execute the initial DLL payload. This system was commonly utilized\nby the Gozi crew for campaigns previously and is actually frequently labeled as Gozi traffic\ndue to the similar URL structure.\n\nFor example:\n\n```\n5184b70eef0d99c77e3e56f7e7b67727e515364e\n\n```\n\ndownloads:\n\n```\n80af349e1d41195576eeb7badc26d9b7873bdfbc\n\n```\n\nvia the following URL:\n```\nhxxp://a8xui1akl9gjqucfa[.]com/vv55v37kts7et/idq9p9t142vyk.php?\nl=frraw2.cab\n\n```\nThis is the Valak DLL loader when unpacked; however, looking at IOC and sandbox reports it\nis easy to see that this switch up of malware is already causing confusion and is being\nlabeled Gozi in some reports.\n\n## Delivery – Compromised Websites\n\nAnother delivery avenue for retrieving the malicious document, which will then contact\ncompromised websites to retrieve the initial DLL loader for detonation, involves links in\nemails[5]. These links have similar random looking PHP names on compromised websites\n\n\n-----\n\nthat will return a document instead of a DLL. The campaign server can be utilized for both\nthe documents and the DLLs and you can find campaigns performing both.\n\n## Compromised PHP Script\n\nThe request structure for recent Valak deliveries is listed below.\n```\n/_3ZyKva_O9zPO1K_k.php?x=MDAwMCCz9oR8W_gfwzPN6OQPNnku8FfFORh5orr1PzC0Avh3LkS4cvcHcQm38Efx3sZMnArLlPqOq5dmdcTOCewa7719Cc84VKgzrxYXx_1dF6N2TuRZ_A\nebn1WCpHJl7o1CJKc3KfF8T-nLUAzS-P_dBt2BVUaVi2OQs-a35JD6DWiJux2-xL2eyIwGBlte-n8hDegM3iqfh8Zw~~\n\n```\nThis seemingly random looking data has some striking resemblance to base64, but we will\nneed the PHP in order to be able to cleanly decode it.\n\n\n-----\n\nThe script takes the URL parameters and ultimately decrypts the contact URL out with an\nembedded key. First, the base64 encoded data can be cleaned up and initially decoded such\nas the following:\n```\n>>> a = 'MDAwMCCz9oR8W_gfwzPN6OQPNnku8FfFORh5orr1PzC0Avh3LkS4cvcHcQm38Efx3sZMnArLlPqOq5dmdcTOCewa7719Cc84VKgzrxYXx_1dF6N2TuRZ_A\nebn1WCpHJl7o1CJKc3KfF8T-nLUAzS-P_dBt2BVUaVi2OQs-a35JD6DWiJux2-xL2eyIwGBlte-n8hDegM3iqfh8Zw~~'\n>>> a = a.replace('-', '+')\n>>> a = a.replace('_', '/')\n>>> a = a.replace('~', '=')\n>>> a\n'MDAwMCCz9oR8W/gfwzPN6OQPNnku8FfF+ORh5orr1PzC0Avh3LkS4cvcHcQm38Efx3sZMnArLlPqOq5dmdcTO\n>>> b = base64.b64decode(a)\n>>> a\n'MDAwMCCz9oR8W/gfwzPN6OQPNnku8FfF+ORh5orr1PzC0Avh3LkS4cvcHcQm38Efx3sZMnArLlPqOq5dmdcTO\n>>> b\n'0000 xb3xf6x84|\n[xf8x1fxc33xcdxe8xe4x0f6y.xf0Wxc5xf8xe4axe6x8axebxd4xfcxc2xd0x0bxe1xdcxb9x12xe1xcbxdcx\nxc1o%xa6mx909xd5txfex8fx9en}\n[email protected]x8eBxcfx9axdfx92Cxe85xa2&xecvxfbx12xf6{\"0x18x19m{xe9xfcx84?\nx9ex80xcdxe2xa9xf8|g'\n\n```\nThe segment variable from the PHP script is then 0 and the compression flag for this\ninstance is a space; if it were compressed it would be ‘z’.\n\n\n-----\n\nThe rest of the URL is decoded using an onboard key; however, the key data is very large\nand the segment value we decoded earlier is actually an index multiplier into this giant key.\n\nKnowing this and armed with the key we can now decode out the contact URL.\n```\n>>> test = bytearray(b[5:])\n>>> key =\nbytearray(base64.b64decode('24LwDGHXMPQL49nWNhhLHsh5/czLDIfjh/mfqrVoirnLP4Wur3bpUraseu\n>>> for i in range(len(test)):\n... test[i] ^= key[i]\n...\n>>> test\nbytearray(b'http://78.129.208.84/mail-checker-desk-time-barlinks/misc/tinystats/index.php?SRR_DHIqwA4sLg~~=__UKkYOYB6iw2q5Ky-dt_AmnBCRl6wDa6QiyG6deRc5r9wxcSxJl6jZKuid7uA0Yb8~')\n\n```\n\n-----\n\nAfter performing the decryption, we have the real download URL. The campaign files\nretrieved with this PHP script, such as Office documents and the DLL loaders, are not stored\nin the PHP files directly but are the result of pre-generated campaign URLs passed to the\nproxy script in order to retrieve them upon execution.\n\nTo summarize the process, the proxy script utilizes an embedded key to decrypt the URL and\nretrieve the contents.\n\nThe similar-looking encoded string passed to the `index.php file as a parameter is likely an`\nencoded message containing campaign specific data. If we continue to look at the\nfunctionality of this PHP file, we can surmise it is used to track statistics along with the\ndelivery of the campaign files.\n\nServing up campaign files from the backend:\n\n## Stats Panel\n\nUpon further analysis, a stats panel was uncovered confirming our hypothesis. Each\ncampaign is carefully tracked. In the image below, the hits are displayed for each file along\nwith the operator and filename. This is typical for a load service, which would require\nstatistics in order to charge customers accurately.\n\n\n-----\n\nThe panel also displays tracking for each of the links from their campaigns, offering possible\ninsight into the number of success executions per campaign.\n\n\n-----\n\n## Valak\n\nOther researchers have already written extensively on Valak[6], so we decided to focus on\nthe aspects that we feel show more of a connection between the Gozi ConfCrew and Valak.\nThese primarily revolve around the use of new plugins. When Valak was in testing in 2019, a\nnumber of different plugins were seen[3]. However, two new ones of particular interest relate\nspecifically to the harvesting of email credential data. One of these, the exchange grabber,\nwas also mentioned previously[6].\n\nThe harvesting of email credentials falls in line with a previous tactic used by the Gozi crew,\nwhere they would harvest emails from accounts and then use the email chains in their spam\ncampaigns[4][8] for a ‘Reply Chain Attack’. This attack revolves around hijacking existing,\nlegitimate emails that are then ‘replied to’ and spammed out. This technique is a way to\ncatch users off-guard as they are normally trained to spot fake emails but will let their guard\ndown when they see that the email is a reply, particularly if it appears to be part of a\nconversation between known or trusted recipients. Reply Chain Attacks also mean the actors\ndo not have to invest in creating legitimate-looking email templates because they are able to\nleverage genuine email correspondence chains.\n\n\n-----\n\n## Exchange Data Plugin – EXCHGRABBER\n\nIf you are going to leverage reply chain attacks for your spamming campaigns, then you\nobviously need some email data. It’s interesting to see that when campaigns shifted more\ntowards Valak and away from Gozi, the addition of a plugin surrounding the theft of\nexchange data showed up.\n\nThe plugin names itself in its config section as an ‘exchgrabber’ or exchange grabber. The\nname suits the functionality in the .NET compiled plugin as it will enumerate credentials from\nthe Credential Manager looking for one associated with Office. Then, using the data from\nautodiscover.xml, it will build the harvested data into a report.\n\nAfter retrieving the data it will exfiltrate it to the C2:\n\n\n-----\n\n## Email Credential Plugin – CLIENTGRABBER\n\nThe recent shift of focus to email theft and enterprise targeting is interesting. While\nconducting this research, we also discovered a new plugin called ‘clientgrabber’, which is\nprimarily utilized for stealing email credentials from the registry.\n\nThe registry locations are recursively searched for the ‘keys’.\n\nOnce found, it will check that the value is using the newer method of encryption and contains\nthe actual encrypted password data, which can be decrypted[7].\n\n\n-----\n\n## Indicators of Compromise\n\n**Endpoint**\n\n```\n%temp%[a-f0-9]{12}.bin\n\n```\n\nADS executable and script files:\n\n```\nHKCUSoftwareApplicationContainerAppsw64ShimV4\n\n```\n\n**Network**\n\nBase64 encoded PE files transferred over the wire\n\n**Samples**\n\n435ec42fefc05eba0a8005256c815979877d430a\n\n693e681e7be554e50e4ff9bf7cbfe5aeab3fe91f\n\ne22b404e1fec743f0795cdea8a95337660878860\n\ndba1337a0a8293b721642b8b45a86352bcdfd04f\n\n4d33425d7031284cf5ee323dc616d9f84987dc0d\n\n17b74a4c3f43c21504b355b1ffc333280ef4cd74\n\n7f58d22d9e95f65170acadd05e324ec2d8ef13f6\n\n9be234bf2268f4e055ea59cf7bef76781a36c35c\n\n19f481063ca956688824e3cc022b8eedb6dd0bea\n\n4ae3ed6c1ab2fe41daf6f650a54dae63684d2064\n\n30fd553dedfadc81522adf37e11dfc4039d4ea31\n\n## References\n\n1: [https://twitter.com/vk_intel/status/1207917643291910144](https://twitter.com/vk_intel/status/1207917643291910144)\n\n2: [https://en.wikipedia.org/wiki/ROT13](https://en.wikipedia.org/wiki/ROT13)\n\n3: [http://prsecurity.org/2019-valak-c2.html](http://prsecurity.org/2019-valak-c2.html)\n\n\n-----\n\n4: https://www.zdnet.com/article/this-phishing-trick-steals-your-email-and-then-fools-yourfriends-into-downloading-malware/\n5: [https://app.any.run/tasks/8e5b6f19-c3e5-4c87-87ac-8c8e012cbb5f/](https://app.any.run/tasks/8e5b6f19-c3e5-4c87-87ac-8c8e012cbb5f/)\n6: https://www-cybereason-com.cdn.ampproject.org/c/s/www.cybereason.com/blog/valakmore-than-meets-the-eye\n7: [https://securityxploded.com/outlookpasswordsecrets.php](https://securityxploded.com/outlookpasswordsecrets.php)\n8: [https://www.webroot.com/blog/2019/04/03/hijacked-email-reply-chains/](https://www.webroot.com/blog/2019/04/03/hijacked-email-reply-chains/)\n\n## Read the Full Report\n\nSee the research report for more technicals details on Varak.\n\n[Read the Full Report](https://assets.sentinelone.com/labs/sentinel-one-valak-i)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-09 - Valak Malware and the Connection to Gozi Loader ConfCrew.pdf"
    ],
    "report_names": [
        "2020-06-09 - Valak Malware and the Connection to Gozi Loader ConfCrew.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535842,
    "ts_updated_at": 1743041170,
    "ts_creation_date": 1653760681,
    "ts_modification_date": 1653760681,
    "files": {
        "pdf": "https://archive.orkl.eu/ea3b9c7e807499358fa64720b75f8d25ff1545ba.pdf",
        "text": "https://archive.orkl.eu/ea3b9c7e807499358fa64720b75f8d25ff1545ba.txt",
        "img": "https://archive.orkl.eu/ea3b9c7e807499358fa64720b75f8d25ff1545ba.jpg"
    }
}