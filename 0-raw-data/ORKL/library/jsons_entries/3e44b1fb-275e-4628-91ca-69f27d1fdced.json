{
    "id": "3e44b1fb-275e-4628-91ca-69f27d1fdced",
    "created_at": "2023-01-12T15:02:58.435815Z",
    "updated_at": "2025-03-27T02:05:47.765373Z",
    "deleted_at": null,
    "sha1_hash": "e5075b2b2713fae1d18d3a2b9624580542c75fd9",
    "title": "2016-03-24 - Maktub Locker – Beautiful And Dangerous",
    "authors": "",
    "file_creation_date": "2022-05-28T02:30:30Z",
    "file_modification_date": "2022-05-28T02:30:30Z",
    "file_size": 675740,
    "plain_text": "# Maktub Locker – Beautiful And Dangerous\n\n**[blog.malwarebytes.com/threat-analysis/2016/03/maktub-locker-beautiful-and-dangerous/](https://blog.malwarebytes.com/threat-analysis/2016/03/maktub-locker-beautiful-and-dangerous/)**\n\nhasherezade March 24, 2016\n\n_[Maktub Locker is another ransomware that comes with a beautifully designed GUI and few](https://www.malwarebytes.com/ransomware)_\n[interesting features. Its name originates from the Arabic word maktub which means “this is](https://www.quora.com/What-does-maktub-mean-in-Arabic)\nwritten” or “this is fate”. The authors were probably trying to make a joke by referencing the\nact of getting infected with ransomware, hinting that it is uninvited and unavoidable, just like\nfate.\n\n## Analyzed samples\n\n_[Special thanks to MalwareHunterTeam and](https://twitter.com/malwrhunterteam)_ _[Yonathan Klijnsma for sharing the samples.](https://twitter.com/ydklijnsma)_\n\n## Behavioral analysis\n\nThis ransomware comes in a spam campaign, pretending to be a document with a Terms-OfService update. This time full packing have a consistent theme: name of the attachment is\nmade to resemble a document (examples: “TOS-update-[…].scr”, “20160321_tos.scr”), also\nit has a a document-like icon:\n\nAn interesting trick used by this ransomware to spoof legitimate behavior is that it really\ndisplays a document! Specifically, a fake TOS update in .rtf format:\n\n\n-----\n\nWhile the user is busy reading the document, the malicious program runs in the background\nand encrypts his/her files.\n\n### Encryption process\n\nMaktub Locker does not need to download a key from the CnC server – data can be\nencrypted offline as well. Extensions given to the encrypted files are random, generated at\nruntime – their pattern is: [a-z]{4,6}\n\nThe new and surprising thing is that encrypted files are much smaller than the original ones.\nIt seems this ransomware not only encrypts but also compresses files.\n\nOriginal files and their sizes:\n\n\n-----\n\nThe same files after encryption:\n\nSee below a visualization of bytes.\n\n**_square.bmp : left – original, right encrypted with Maktub Locker:_**\n\n^– the bitmap is compressed very well, so the encrypted\n\n_file is tiny_\n\nA possible reason of compressing files first is to speed up the encryption process.\n\nEncrypted content is different on each run of the sample. However, in a single run, files with\nthe same content will give the same output. We can conclude that the random key is\ngenerated only once – at program’s start. After that, every file is encrypted using the same\nkey.\n\nAfter the encryption is finished, the following GUI pops up:\n\n\n-----\n\nIt provides a victim a custom-formatted key: 82 chunks, each 5 character long (chunk format:\n\n[A-Z0-9]{5}). Each time the sample runs, this key is newly generated.\n\nThe same information (and layout) can be found in an HTML file\n( _DECRYPT_INFO_[$EXTENSION].html), dropped in each encrypted directory.\n\n### Website for the victim\n\nThese days, it’s a common feature of ransomware to provide a TOR-accessed website for\nthe victim and Maktub Locker is no different. Similar to the ransom note, the website is only\navailable in English. In order to access the individual page, the victim is supposed to paste\nhis/her key (the one supplied in the ransom note) into the input box provided on the website.\n\n\n-----\n\nIt then redirects to the main website. In comparison to other ransomware families, Maktub\nLocker actually has a very nicely designed website, including clean and polite language\nused.\n\nIt comes with a demo, allowing the decryption of 2 selected files:\n\n\n-----\n\nThe price of decrypting files starts with 1.4 BTC and increases with time. The distributors\nwarn that the website can be taken down and then it would not be possible to recover\nencrypted files:\n\n## Inside\n\n[Maktub Locker comes packed in a well-written crypter/FUD, so the code is not readable at](https://blog.malwarebytes.org/development/2015/12/malware-crypters-the-deceptive-first-layer/)\nfirst. Also, due to the FUD’s functions, detection is problematic and samples have a low\ndetection ratio in the first hours/days after the campaign starts.\n\n### Unpacking\n\nExecution starts in the FUD’s code. At first we can see many harmless-looking (and\ncompletely useless) API calls and random strings.\n\nThis code is executed first, to deceive tools used to detect malicious behavior. Then it is\ncompletely overwritten by new code. However, this is also not the malware code, but just\nanother layer of deception techniques. Below, you can see a fragment of the code\nresponsible for unpacking and executing the bogus TOS update (it is first unpacked from the\nresources and dropped into the %TEMP% folder as a cabinet file):\n\n\n-----\n\nThe real malicious code starts in another module that is unpacked into dynamically allocated\nmemory.\n\nYou can see above 2 threads with entry: 0x10001230. They belong to this malicious module.\nIf we try to dump this memory area, we obtain a new PE file:\n\nThis PE file is loaded in a continuous area of dynamically allocated memory and used as a\nnew virtual section.\n\nUnfortunately this time, dumping it will not give us the independent payload – unpacked\ncontent has invalid headers, i.e:\n\n\n-----\n\nThis trick is used by the crypter in order to protect the payload from automated dumping\ntools. However, if we capture the unpacking at the right moment, before the headers are\noverwritten, we still can recover the original payload. It turns out to be a DLL (packed with\nUPX):\n\nThe code responsible for encrypting files is located in the function “one”.\n\n\n-----\n\n[The DLL is packed with genuine version of UPX, so we can easily unpack it, getting an](http://upx.sourceforge.net/)\ndeobfuscated DLL as result with the following sections layout (unpacked C.dll :\n[38eff2f7c6c8810a055ca14628a378e7 ):](https://www.virustotal.com/en/file/1e9aa62db07e4774fb38cd8af1b9d382581e46c77176862abae3501d61d96db0/analysis/)\n\nHowever, we will still not see valid strings. Imports also seems irrelevant to the functionality\n(we will not find there, for example, any reference to the windows Crypto API). It is due to the\nfact that real imports are resolved dynamically. At the beginning of execution, the function\n“one” loads them on it’s own – first,decrypting their names:\n\nThen, they are accessed via dynamically loaded handles.\n\n### Execution flow\n\nThis malware first makes a list of all the files, and then processes them one by one. It also\nunpacks a built-in configuration with list of restricted paths and attacked executables. Each\nprocessed path is first checked against this list.\n\nBelow you can see a fragment of code opening file that is chosen to be encrypted. Call to the\nfunction CreateFileA is performed via handle and dynamically loaded into the EAX register:\n\n\n-----\n\nThen, a new file is created – with an extension added:\n\nAt first both files coexist in the system – the newly created file has 0 size. After it is filled by\nthe encrypted content, the original file gets deleted.\n\nAfter the process of encryption finished, the malware creates and pops up the dialog box.\n\nBelow – code responsible for popping up the GUI with a ransom note:\n\n\n-----\n\n### What is attacked?\n\nIt is common practice to exclude some chosen countries from the attack. In this case, before\ndeploying the malicious actions, the application fetches the keyboard locale list. If it finds\n[Russian (value 0x419 = 1049) among them, the malware exits without infecting files:](https://msdn.microsoft.com/en-us/library/ms912390%28v=winembedded.11%29.aspx)\n\nExcluded from the attack are also some predefined folders:\n```\n\"\\\\internet explorer\\\\;\\\\history\\\\;\\\\mozilla\\\\;\\\\chrome\\\\;\\\\temp\\\\;\\\\program\nfiles\\\\;\\\\program files (x86)\\\\;\\\\microsoft\\\\;\\\\chache\\\\;\\\\chaches\\\\;\\\\appdata\\\\;\"\n\n```\nThe built-in configuration also specifies what are the extensions to attack:\n\nLike other ransomware families, it attacks not only the local disk but also network shares and\ndisks mounted by virtual environments, including external hard drives.\n\n### How does the encryption work?\n\n\n-----\n\n_Maktub Locker uses Window Crypto API. But, as we concluded from the analysis, it uses_\nonly one key for all files (does not generate a random key per file). Let’s see what technique\nit uses to obtain keys…\n\nIn this run, the key supplied to a user was:\n\n\n-----\n\n```\n       Q\nVKFKR-6TKRV-STG4B-CE5MZ-TAH4W-MP541-GD3SB-HE43J-ZF4TK-ZNZTG-R7ZBZ-AKM2U-T6TYN-53J7H\nMU6J6-BTSJC-FQVQR-EH755-C1WCJ-7SNPT-MHFBS-Q638V-MASEB-R16HW-P84P2-7EEX8-KXAHB-D10F7\nGF071-U37K3-GJ5Q5-WD0PD-2EG16-KMC5R-RPCBX-R8EV3-ZPXQV-TDVXM-SEEFX-XK23J-FCH4Z-RNBPN\nXE6X5-4W8CT-WJQJU-071T5-DSUZW-JGSZA-KFKZ6-4DU0S-80H1H-CEP2J-PDSKA-UXBR8-8C1BB-SDQNC\n1C8F7-HPZ2G-Q5JVN-F6WXH-PMUSR-8G4HT-RNYVW-DZNQ3-Y8KZJ-NYC1G-SPR3T-U5GD5\nLet’s investigate what is the relationship between this key and the key used to\nencrypt files. So far we know that it must be generated locally.\nFirst it initialized two crypto contexts – both with the same settings, using\nprovider type: PROV_DH_SCHANNEL\nGets 32 random bytes, using function CryptGenRandom\nCreates MD5 sum of this random data (using: CryptCreateHash, CryptHashData)\n\n```\n\n-----\n\n```\nThen, using function CryptDeriveKey it converts the MD5 hash into a 256 bit AES key\n(AlgID = 0x6610 -> CALG_AES_256).\nIt also imports RSA public key (2048 bit). This key is hardcoded in the binary.\nThe random 32 bytes (base of the AES key), along with the random extension, are\nconcatenated together. Then, the prepared buffer is RSA encrypted:\n\n```\n\n-----\n\n```\nOutput is converted using the predefined charset and given to a victim as the\nindividual ID:\nThat’s why, when the user submit his/her individual ID, the attackers, having the\nappropriate private key, can decrypt the original data and easily recover the random\nAES key.\nAfter this operation, the previously generated AES key is used to encrypt files.\nFirst, file content is compressed by a dedicated function (BZip2):\n\n```\n\n-----\n\n```\nThen, the buffer containing compressed data is AES encrypted – using CryptEncrypt\nThe encrypted data is saved to the file with the generated extension added.\nConclusion\n\n```\n\n-----\n\n```\nMaktub Locker has clearly been developed by professionals. The full product s\ncomplexity suggests that it is the work of a team of people with different areas of\nexpertise. From the packing operations to the website, everything is well-polished.\nWe are not sure if the crypter/FUD is designed by the same team – it could also be a\ncommercial solution available on the black market. However, it is not the only level\nof defense – the core DLL is also obfuscated and for sure prepared by someone with\nexperience in writing malware.\nMalwarebytes Anti-Malware detects this threat as: Ransom.Maktub.\nAppendix\nhttp://www.bleepingcomputer.com/news/security/the-art-of-the-maktub-lockerransomware/ – “The Art of the Maktub Locker Ransomware” (detailed description of the\ngraphical design)\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-03-24 - Maktub Locker – Beautiful And Dangerous.pdf"
    ],
    "report_names": [
        "2016-03-24 - Maktub Locker – Beautiful And Dangerous.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535778,
    "ts_updated_at": 1743041147,
    "ts_creation_date": 1653705030,
    "ts_modification_date": 1653705030,
    "files": {
        "pdf": "https://archive.orkl.eu/e5075b2b2713fae1d18d3a2b9624580542c75fd9.pdf",
        "text": "https://archive.orkl.eu/e5075b2b2713fae1d18d3a2b9624580542c75fd9.txt",
        "img": "https://archive.orkl.eu/e5075b2b2713fae1d18d3a2b9624580542c75fd9.jpg"
    }
}