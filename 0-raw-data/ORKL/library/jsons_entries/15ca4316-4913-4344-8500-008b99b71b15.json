{
    "id": "15ca4316-4913-4344-8500-008b99b71b15",
    "created_at": "2023-01-12T15:06:16.676786Z",
    "updated_at": "2025-03-27T02:05:51.107299Z",
    "deleted_at": null,
    "sha1_hash": "ce08980be19ecb5cd7b5ab0b9854404a0e55754e",
    "title": "2019-09-26 - Bring your own LOLBin- Multi-stage, fileless Nodersok campaign delivers rare Node.js-based malware",
    "authors": "",
    "file_creation_date": "2022-05-28T22:01:35Z",
    "file_modification_date": "2022-05-28T22:01:35Z",
    "file_size": 1293677,
    "plain_text": "# Bring your own LOLBin: Multi-stage, fileless Nodersok campaign delivers rare Node.js-based malware\n\n**microsoft.com/security/blog/2019/09/26/bring-your-own-lolbin-multi-stage-fileless-nodersok-campaign-delivers-rare-**\nnode-js-based-malware/\n\nSeptember 26, 2019\n\n[We’ve discussed the challenges that fileless threats pose in security, and how Microsoft](https://docs.microsoft.com/en-us/windows/security/threat-protection/intelligence/fileless-threats)\n[Defender Advanced Threat Protection (Microsoft Defender ATP) employs advanced](https://www.microsoft.com/en-us/microsoft-365/windows/microsoft-defender-atp)\nstrategies to defeat these sophisticated threats. Part of the slyness of fileless malware is\ntheir use of living-off-the-land techniques, which refer to the abuse of legitimate tools, also\n[called living-off-the-land binaries (LOLBins), that already exist on machines through which](https://github.com/LOLBAS-Project/LOLBAS/blob/master/README.md)\nmalware can persist, move laterally, or serve other purposes.\n\nBut what happens when attackers require functionality beyond what’s provided by standard\nLOLBins? A new malware campaign we dubbed Nodersok decided to bring its own LOLBins\n—it delivered two very unusual, legitimate tools to infected machines:\n\n[Node.exe, the Windows implementation of the popular Node.js framework used by](https://nodejs.org/)\ncountless web applications\n[WinDivert, a powerful network packet capture and manipulation utility](https://reqrypt.org/windivert.html)\n\nLike any LOLBin, these tools are not malicious or vulnerable; they provide important\ncapabilities for legitimate use. It’s not uncommon for attackers to download legitimate third[party tools onto infected machines (for example, PsExec is often abused to run other tools or](https://attack.mitre.org/software/S0029/)\n\n\n-----\n\ncommands). However, Nodersok went through a long chain of fileless techniques to install a\npair of very peculiar tools with one final objective: turn infected machines into zombie\nproxies.\n\nWhile the file aspect of the attack was very tricky to detect, its behavior produced a visible\nfootprint that stands out clearly for anyone who knows where to look. With its array of\nadvanced defensive technologies, Microsoft Defender ATP, defeated the threat at numerous\npoints of dynamic detection throughout the attack chain.\n\n## Attack overview\n\nThe Nodersok campaign has been pestering thousands of machines in the last several\nweeks, with most targets located in the United States and Europe. The majority of targets are\nconsumers, but about 3% of encounters are observed in organizations in sectors like\neducation, professional services, healthcare, finance, and retail.\n\n\n-----\n\n_Figure 1. Distribution of Nodersok’s enterprise targets by country and by sector_\n\nThe campaign is particularly interesting not only because it employs advanced fileless\ntechniques, but also because it relies on an elusive network infrastructure that causes the\nattack to fly under the radar. We uncovered this campaign in mid-July, when suspicious\n\n\n-----\n\npatterns in the anomalous usage of MSHTA.exe emerged from Microsoft Defender ATP\ntelemetry. In the days that followed, more anomalies stood out, showing up to a ten-fold\nincrease in activity:\n\n_Figure 2. Trending of Nodersok activity from August to September, 2019_\n\nAfter a process of tracking and analysis, we pieced together the infection chain:\n\n\n-----\n\n_Figure 3. Nodersok attack chain_\n\n[Like the Astaroth campaign, every step of the infection chain only runs legitimate LOLBins,](https://www.microsoft.com/security/blog/2019/07/08/dismantling-a-fileless-campaign-microsoft-defender-atp-next-gen-protection-exposes-astaroth-attack/)\neither from the machine itself (mshta.exe, powershell.exe) or downloaded third-party ones\n(node.exe, Windivert.dll/sys). All of the relevant functionalities reside in scripts and\nshellcodes that are almost always coming in encrypted, are then decrypted, and run while\nonly in memory. No malicious executable is ever written to the disk.\n\nThis infection chain was consistently observed in several machines attacked by the latest\nvariant of Nodersok. Other campaigns (possibly earlier versions) with variants of this\nmalware (whose main JavaScript payload was named 05sall.js or 04sall.js) were observed\ninstalling malicious encoded PowerShell commands in the registry that would end up\ndecoding and running the final binary executable payload.\n\n\n-----\n\n## Initial access: Complex remote infrastructure\n\nThe attack begins when a user downloads and runs an HTML application (HTA) file named\n_Player1566444384.hta. The digits in the file name differ in every attack. Analysis of Microsoft_\nDefender ATP telemetry points to compromised advertisements as the most likely infection\nvector for delivering the HTA files. The mshta.exe tool (which runs when an HTA file runs)\nwas launched with the -embedding command-line parameter, which typically indicates that\nthe launch action was initiated by the browser.\n\nFurthermore, immediately prior to the execution of the HTA file, the telemetry always shows\nnetwork activity towards suspicious advertisement services (which may vary slightly across\ninfections), and a consistent access to legitimate content delivery service Cloudfront.\nCloudfront is not a malicious entity or service, and it was likely used by the attackers exactly\nfor that reason: because it’s not a malicious domain, it won’t likely raise alarms. Examples of\nsuch domains observed in several campaigns are:\n\n_d23cy16qyloios[.]cloudfront[.]net_\n_d26klsbste71cl[.]cloudfront [.]net_\n_d2d604b63pweib[.]cloudfront [.]net_\n_d3jo79y1m6np83[.]cloudfront [.]net_\n_d1fctvh5cp9yen[.]cloudfront [.]net_\n_d3cp2f6v8pu0j2[.]cloudfront[.]net_\n_dqsiu450ekr8q[.]cloudfront [.]net_\n\nIt’s possible that these domains were abused to deliver the HTA files without alerting the\nbrowser. Another content delivery service abused later on in the attack chain is Cdn77.\nSome examples of observed URLs include:\n\n_hxxps://1292172017[.]rsc [.]cdn77 [.]org/images/trpl[.]png_\n_hxxps://1292172017[.]rsc.cdn77[.]org/imtrack/strkp[.]png_\n\n[This same strategy was also used by the Astaroth campaign, where the malware authors](https://www.microsoft.com/security/blog/2019/07/08/dismantling-a-fileless-campaign-microsoft-defender-atp-next-gen-protection-exposes-astaroth-attack/)\nhosted their malware on the legitimate storage.googleapis.com service.\n\n## First-stage JavaScript\n\nWhen the HTA file runs, it tries to reach out to a randomly named domain to download\nadditional JavaScript code. The domains used in this first stage are short-lived: they are\nregistered and brought online and, after a day or two (the span of a typical campaign), they\nare dropped and their related DNS entries are removed. This can make it more difficult to\ninvestigate and retrieve the components that were delivered to victims. Examples of domains\nobserved include:\n\n_Du0ohrealgeek[.]org – active from August 12 to 14_\n_Hi5urautopapyrus[.]org – active from April 21 to 22_\n\n\n-----\n\n_Ex9ohiamistanbul[.]net – active from August 1 to 2_\n_Eek6omyfilmbiznetwork[.]org – active from July 23 to 24_\n\nThis stage is just a downloader: it tries to retrieve either a JavaScript or an extensible style\nlanguage (XSL) file from the command-and-control (C&C) domain. These files have semirandom names like 1566444384.js and 1566444384.xsl, where the digits are different in\nevery download. After this file is downloaded and runs, it contacts the remote C&C domain to\ndownload an RC4-encrypted file named 1566444384.mp4 and a decryption key from a file\nnamed 1566444384.flv. When decrypted, the MP4 file is an additional JavaScript snippet\nthat starts PowerShell:\n\nInterestingly, it hides the malicious PowerShell script in an environment variable named\n“deadbeef” (first line), then it launches PowerShell with an encoded command (second line)\nthat simply runs the contents of the “deadbeef” variable. This trick, which is used several\ntimes during the infection chain, is usually employed to hide the real malicious script so that it\ndoes not appear in the command-line of a PowerShell process.\n\n## Second-stage PowerShell\n\nNodersok’s infection continues by launching several instances of PowerShell to download\nand run additional malicious modules. All the modules are hosted on the C&C servers in\nRC4-encrypted form and are decrypted on the fly before they run on the device. The\nfollowing steps are perpetrated by the various instances of PowerShell:\n\nDownload module.avi, a module that attempts to:\n\nDisable Windows Defender Antivirus\nDisable Windows updates\nRun binary shellcode that attempts elevation of privilege by using auto-elevated\nCOM interface\nDownload additional modules trpl.png and strkp.png hosted on a Cdn77 service\nDownload legitimate node.exe tool from the official nodejs.org website\nDrop the WinDivert packet capture library components WinDivert.dll, WinDivert32.sys,\nand WinDivert64.sys\nExecute a shellcode that uses WinDivert to filter and modify certain outgoing packets\nFinally, drop the JavaScript payload along with some Node.js modules and libraries\nrequired by it, and run it via node.exe\n\nThis last JavaScript is the actual final payload written for the Node.js framework that turns\nthe device into a proxy. This concludes the infection, at the end of which the network packet\nfilter is active and the machine is working as a potential proxy zombie. When a machine\n\n\n-----\n\nturns into a proxy, it can be used by attackers as a relay to access other network entities\n(websites, C&C servers, compromised machines, etc.), which can allow them to perform\nstealthy malicious activities.\n\n## Node.js-based proxy engine\n\nThis is not the first threat to abuse Node.js. Some cases have been observed in the past (for\n[example this ransomware from early 2016). However, using Node.js is a peculiar way to](https://blog.malwarebytes.com/threat-analysis/2016/01/ransom32-look-at-the-malicious-package/)\nspread malware. Besides being clean and benign, Node.exe also has a valid digital\nsignature, allowing a malicious JavaScript to operate within the context of a trusted process.\nThe JavaScript payload itself is relatively simple: it only contains a set of basic functions that\nallows it to act as a proxy for a remote entity.\n\n\n-----\n\n_Figure 4. A portion of the malicious Node.js-based proxy_\n\nThe code seems to be still in its infancy and in development, but it does work. It has two\npurposes:\n\n1. Connect back to the remote C&C, and\n\n\n-----\n\n2. Receive HTTP requests to proxy back to it\n\nIt supports the [SOCKS4A protocol. While we haven’t observed network requests coming](https://en.wikipedia.org/wiki/SOCKS#SOCKS4a)\nfrom attackers, we wrote what the Node.js-based C&C server application may look like: a\nserver that sends HTTP requests to the infected clients that connect back to it, and receives\nthe responses from said clients. we slightly modified the malicious JavaScript malware to\nmake it log meaningful messages, ran a JavaScript server, ran the JavaScript malware, and\nit proxied HTTP requests as expected:\n\n_Figure 5.The debug messages are numbered to make it easier to follow the execution flow_\n\nThe server starts, then the client starts and connects to it. In response, the server sends a\nHTTP request (using the Socks4A protocol) to the client. The request is a simple HTTP GET.\nThe client proxies the HTTP request to the target website and returns the HTTP response\n(200 OK) and the HTML page back to the server. This test demonstrates that it’s possible to\nuse this malware as a proxy.\n\n## 05sall.js: A variant of Nodersok\n\nAs mentioned earlier, there exist other variants of this malware. For example, we found one\nnamed 05sall.js (possibly an earlier version). It’s similar in structure to the one described\nabove, but the payload was not developed in Node.js (rather it was an executable).\nFurthermore, beyond acting as a proxy, it can run additional commands such as update,\nterminate, or run shell commands.\n\n\n-----\n\n_Figure 6. The commands that can be processed by the 05sall.js variant._\n\nThe malware can also process configuration data in JSON format. For example, this\nconfiguration was encoded and stored in the registry in an infected machine:\n\n_Figure 7. Configuration data exposing component and file names_\n\nThe configuration is an indication of the modular nature of the malware. It shows the names\nof two modules being used in this infection (named block_av_01 and all_socks_05).\n\n## The WinDivert network packet filtering\n\nAt this point in the analysis, there is one last loose end: what about the WinDivert packet\ncapture library? We recovered a shellcode from one of the campaigns. This shellcode is\ndecoded and run only in memory from a PowerShell command. It installs the following\nnetwork filter (in a language recognized by WinDivert):\n\n\n-----\n\nThis means Nodersok is intercepting packets sent out to initiate a TCP connection. Once the\nfilter is active, the shellcode is interested only in TCP packets that match the following\nspecific format:\n\n_Figure 8. Format of TCP packets that Nodersok is interested in_\n\nThe packet must have standard Ethernet, IP, and 20 bytes TCP headers, plus an additional\n20 bytes of TCP extra options. The options must appear exactly in the order shown in the\nimage above:\n\n_02 04 XX XX – Maximum segment size_\n_01 – No operation_\n_03 03 XX – Windows Scale_\n_04 02 – SACK permitted_\n_08 0A XX XX XX XX XX XX XX XX – Time stamps_\n\nIf packets matching this criterion are detected, Nodersok modifies them by moving the\n“SACK Permitted” option to the end of the packet (whose size is extended by four bytes),\nand replacing the original option bytes with two “No operation” bytes.\n\n_Figure 9. The format of TCP packets after Nodersok has altered it: the “SACK permitted”_\n_bytes (in red) have been moved to the end of the packet, and their original location has been_\n_replaced by “No operation” (in yellow)_\n\nIt’s possible that this modification benefits the attackers; for example, it may help evade\nsome HIPS signatures.\n\n## Stopping the Nodersok campaign with Microsoft Defender ATP\n\n\n-----\n\nBoth the distributed network infrastructure and the advanced fileless techniques allowed this\ncampaign fly under the radar for a while, highlighting how having the right defensive\ntechnologies is of utmost importance in order to detect and counter these attacks in a timely\nmanner.\n\nIf we exclude all the clean and legitimate files leveraged by the attack, all that remains are\nthe initial HTA file, the final Node.js-based payload, and a bunch of encrypted files.\nTraditional file-based signatures are inadequate to counter sophisticated threats like this. We\nhave known this for quite a while, that’s why we have invested a good deal of resources into\ndeveloping powerful dynamic detection engines and delivering a state-of-the-art defense-indepth through Microsoft Defender ATP:\n\n\n-----\n\n_Figure 10. Microsoft Defender ATP protections against Nodersok_\n\nMachine learning models in the Windows Defender Antivirus client generically detects\nsuspicious obfuscation in the initial HTA file used in this attack. Beyond this immediate\nprotection, behavioral detection and containment capabilities can spot anomalous and\nmalicious behaviors, such as the execution of scripts and tools. When the behavior\nmonitoring engine in the client detects one of the more than 500 attack techniques,\ninformation like the process tree and behavior sequences are sent to the cloud, where\nbehavior-based machine learning models classify files and identify potential threats.\n\nMeanwhile, scripts that are decrypted and run directly in memory are exposed by\n[Antimalware Scan Interface (AMSI) instrumentation in scripting engines, while launching](https://cloudblogs.microsoft.com/microsoftsecure/2015/06/09/windows-10-to-offer-application-developers-new-malware-defenses/?source=mmpc)\nPowerShell with a command-line that specifies encoded commands is defeated by\n[command-line scanning. Tamper protection in Microsoft Defender ATP protects against](https://techcommunity.microsoft.com/t5/Microsoft-Defender-ATP/Tamper-protection-in-Microsoft-Defender-ATP/ba-p/389571)\nsystem modifications that attempt to disable Windows Defender Antivirus.\n\nThese multiple layers of protection are part of the threat and malware prevention capabilities\nin Microsoft Defender ATP. The complete endpoint protection platform provides multiple\ncapabilities that empower security teams to defend their organizations against attacks like\nNodersok. [Attack surface reduction shuts common attack surfaces.](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/overview-attack-surface-reduction) Threat and vulnerability\nmanagement, [endpoint detection and response, and](https://docs.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-atp/overview-endpoint-detection-response) automated investigation and\nremediation help organizations detect and respond to cyberattacks. Microsoft Threat\nExperts, Microsoft Defender ATP’s managed detection and response service, further helps\nsecurity teams by providing expert-level monitoring and analysis.\n\nWith [Microsoft Threat Protection, these endpoint protection capabilities integrate with the rest](https://www.microsoft.com/en-us/security/technology/threat-protection)\nof Microsoft security solutions to deliver comprehensive protection for comprehensive\nsecurity for identities, endpoints, email and data, apps, and infrastructure.\n\n**_Andrea Lelli_**\n_Microsoft Defender ATP Research_\n\n## Talk to us\n\nQuestions, concerns, or insights on this story? Join discussions at the Microsoft Defender\nATP community.\n\n[Read all Microsoft security intelligence blog posts.](https://www.microsoft.com/security/blog/microsoft-security-intelligence/)\n\nFollow us on Twitter **[@MsftSecIntel.](https://twitter.com/MsftSecIntel)**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-09-26 - Bring your own LOLBin- Multi-stage, fileless Nodersok campaign delivers rare Node.js-based malware.pdf"
    ],
    "report_names": [
        "2019-09-26 - Bring your own LOLBin- Multi-stage, fileless Nodersok campaign delivers rare Node.js-based malware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535976,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1653775295,
    "ts_modification_date": 1653775295,
    "files": {
        "pdf": "https://archive.orkl.eu/ce08980be19ecb5cd7b5ab0b9854404a0e55754e.pdf",
        "text": "https://archive.orkl.eu/ce08980be19ecb5cd7b5ab0b9854404a0e55754e.txt",
        "img": "https://archive.orkl.eu/ce08980be19ecb5cd7b5ab0b9854404a0e55754e.jpg"
    }
}