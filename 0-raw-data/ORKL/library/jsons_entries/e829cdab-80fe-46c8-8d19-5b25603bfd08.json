{
    "id": "e829cdab-80fe-46c8-8d19-5b25603bfd08",
    "created_at": "2023-01-12T15:02:20.128787Z",
    "updated_at": "2025-03-27T02:05:49.051852Z",
    "deleted_at": null,
    "sha1_hash": "c552947715dfb5ad065023bbb337d8e1e3b4935b",
    "title": "2020-07-27 - Alert (AA20-209A)- Potential Legacy Risk from Malware Targeting QNAP NAS Devices",
    "authors": "",
    "file_creation_date": "2022-05-29T00:58:00Z",
    "file_modification_date": "2022-05-29T00:58:00Z",
    "file_size": 130675,
    "plain_text": "# Potential Legacy Risk from Malware Targeting QNAP NAS Devices\n\n**us-cert.cisa.gov/ncas/alerts/aa20-209a**\n\n## Summary\n\n_This is a joint alert from the United States Cybersecurity and Infrastructure Security Agency_\n_(CISA) and the United Kingdom’s National Cyber Security Centre (NCSC)._\n\nCISA and NCSC are investigating a strain of malware known as QSnatch, which attackers\nused in late 2019 to target Network Attached Storage (NAS) devices manufactured by the\nfirm QNAP.\n\nAll QNAP NAS devices are potentially vulnerable to QSnatch malware if not updated with the\nlatest security fixes. The malware, documented in open-source reports, has infected\nthousands of devices worldwide with a particularly high number of infections in North\nAmerica and Europe. Further, once a device has been infected, attackers can prevent\nadministrators from successfully running firmware updates.\n\nThis alert summarizes the findings of CISA and NCSC analysis and provides mitigation\nadvice.\n\n[Click here for a PDF version of this report from NCSC.](https://www.ncsc.gov.uk/files/NCSC%20CISA%20Alert%20-QNAP%20NAS%20Devices.pdf)\n\n[For a downloadable copy of IOCs, see STIX file.](https://us-cert.cisa.gov/sites/default/files/publications/AA20-209A.stix.xml)\n\n## Technical Details\n\n Campaigns \n\nCISA and NCSC have identified two campaigns of activity for QSnatch malware. The first\ncampaign likely began in early 2014 and continued until mid-2017, while the second started\nin late 2018 and was still active in late 2019. The two campaigns are distinguished by the\ninitial payload used as well as some differences in capabilities. This alert focuses on the\nsecond campaign as it is the most recent threat.\n\nIt is important to note that infrastructure used by the malicious cyber actors in both\ncampaigns is not currently active, but the threat remains to unpatched devices.\n\nAlthough the identities and objectives of the malicious cyber actors using QSnatch are\ncurrently unknown, the malware is relatively sophisticated, and the cyber actors demonstrate\nan awareness of operational security.\n\n\n-----\n\n## Global distribution of infections \n\nAnalysis shows a significant number of infected devices. In mid-June 2020, there were\napproximately 62,000 infected devices worldwide; of these, approximately 7,600 were in the\nUnited States and 3,900 were in the United Kingdom. Figure 1 below shows the location of\nthese devices in broad geographic terms.\n\n_Figure 1: Locations of QNAP NAS devices infected by QSnatch_\n\n## Delivery and exploitation\n\nThe infection vector has not been identified, but QSnatch appears to be injected into the\ndevice firmware during the infection stage, with the malicious code subsequently run within\nthe device, compromising it. The attacker then uses a domain generation algorithm (DGA)—\nto establish a command and control (C2) channel that periodically generates multiple domain\nnames for use in C2 communications—using the following HTTP GET request:\n```\nHTTP GET https://[generated-address]/qnap_firmware.xml?=t[timestamp] [1]\n\n## Malware functionalities \n\n```\nAnalysis shows that QSnatch malware contains multiple functionalities, such as:\n\n**CGI password logger**\n\nThis installs a fake version of the device admin login page, logging successful\nauthentications and passing them to the legitimate login page.\n**Credential scraper**\n\n\n-----\n\n**SSH backdoor**\n\nThis allows the cyber actor to execute arbitrary code on a device.\n**Exfiltration**\n\nWhen run, QSnatch steals a predetermined list of files, which includes system\nconfigurations and log files. These are encrypted with the actor’s public key and\nsent to their infrastructure over HTTPS.\n**Webshell functionality for remote access**\n\n## Persistence\n\nThe malware appears to gain persistence by preventing updates from installing on the\ninfected QNAP device. The attacker modifies the system host’s file, redirecting core domain\nnames used by the NAS to local out-of-date versions so updates can never be installed.\n\n## Samples\n\nThe following tables provide hashes of related QSnatch samples found in open-source\nmalware repositories. File types fall into two buckets: (1) shell scripts (see table 1) and (2)\nshell script compiler (SHC)-compiled executable and linking format (ELF) shell scripts (see\ntable 2). One notable point is that some samples intentionally patch the infected QNAP for\nSamba remote code execution vulnerability CVE-2017-7494.\n\n_Table 1: QSnatch samples – shell scripts_\n\n**SH Samples (SHA256)**\n\n09ab3031796bea1b8b79fcfd2b86dac8f38b1f95f0fce6bd2590361f6dcd6764\n\n3c38e7bb004b000bd90ad94446437096f46140292a138bfc9f7e44dc136bac8d\n\n8fd16e639f99cdaa7a2b730fc9af34a203c41fb353eaa250a536a09caf78253b\n\n473c5df2617cee5a1f73880c2d66ad9668eeb2e6c0c86a2e9e33757976391d1a\n\n55b5671876f463f2f75db423b188a1d478a466c5e68e6f9d4f340396f6558b9f\n\n9526ccdeb9bf7cfd9b34d290bdb49ab6a6acefc17bff0e85d9ebb46cca8b9dc2\n\n4b514278a3ad03f5efb9488f41585458c7d42d0028e48f6e45c944047f3a15e9\n\nfa3c2f8e3309ee67e7684abc6602eea0d1d18d5d799a266209ce594947269346\n\n18a4f2e7847a2c4e3c9a949cc610044bde319184ef1f4d23a8053e5087ab641b\n\n9791c5f567838f1705bd46e880e38e21e9f3400c353c2bf55a9fa9f130f3f077\n\na569332b52d484f40b910f2f0763b13c085c7d93dcdc7fea0aeb3a3e3366ba5d\n\n\n-----\n\na9364f3faffa71acb51b7035738cbd5e7438721b9d2be120e46b5fd3b23c6c18\n\n62426146b8fcaeaf6abb24d42543c6374b5f51e06c32206ccb9042350b832ea8\n\n5cb5dce0a1e03fc4d3ffc831e4a356bce80e928423b374fc80ee997e7c62d3f8\n\n5130282cdb4e371b5b9257e6c992fb7c11243b2511a6d4185eafc0faa0e0a3a6\n\n15892206207fdef1a60af17684ea18bcaa5434a1c7bdca55f460bb69abec0bdc\n\n3cb052a7da6cda9609c32b5bafa11b76c2bb0f74b61277fecf464d3c0baeac0e\n\n13f3ea4783a6c8d5ec0b0d342dcdd0de668694b9c1b533ce640ae4571fdbf63c\n\n_Table 2: QSnatch samples – SHC-compiled ELF shell scripts_\n\n**SH Samples (SHA256)**\n\n18a4f2e7847a2c4e3c9a949cc610044bde319184ef1f4d23a8053e5087ab641b\n\n3615f0019e9a64a78ccb57faa99380db0b36146ec62df768361bca2d9a5c27f2\n\n845759bb54b992a6abcbca4af9662e94794b8d7c87063387b05034ce779f7d52\n\n6e0f793025537edf285c5749b3fcd83a689db0f1c697abe70561399938380f89\n\n## Mitigations\n\nAs stated above, once a device has been infected, attackers have been known to make it\nimpossible for administrators to successfully run the needed firmware updates. This makes it\nextremely important for organizations to ensure their devices have not been previously\ncompromised. Organizations that are still running a vulnerable version should take the\n**following steps to ensure the device is not left vulnerable:**\n\n**Scan the device with the latest version of Malware Remover, available in QNAP**\nApp Center, to detect and remove QSnatch or other malware.\n\nIf the installation via App Center fails, manually install Malware Remover following\n[this QNAP tutorial, or contact](https://urldefense.us/v3/__https:/www.qnap.com/en/how-to/knowledge-base/article/how-to-install-qnap-applications-qpkg-files-manually__;!!BClRuOV5cvtbuNI!XPCHTsigleobUvh1bSzLCLG8cPaxt-RD2ixM8js9QWU3e6ZcTEq1kesRf6q8Ypt4gOLyg-Yr3U8%24) [QNAP Technical Support for further assistance.](https://urldefense.us/v3/__https:/service.qnap.com/en__;!!BClRuOV5cvtbuNI!XPCHTsigleobUvh1bSzLCLG8cPaxt-RD2ixM8js9QWU3e6ZcTEq1kesRf6q8Ypt4gOLyhKUvzyM%24)\n**Run a full factory reset on the device.**\n**Update the firmware to the latest version.**\n\nThe usual checks to ensure that the latest updates are installed still apply. To prevent\n**reinfection, this recommendation also applies to devices previously infected with**\n**QSnatch but from which the malware has been removed.**\n\nTo prevent QSnatch malware infections, CISA and NCSC strongly recommend that\n[organizations take the recommended measures in QNAP’s November 2019 advisory.[2]](https://www.qnap.com/en/security-advisory/nas-201911-01)\n\n\n-----\n\nCISA and NCSC also recommend organizations consider the following mitigations:\n\nVerify that you purchased QNAP devices from reputable sources.\n\nIf sources are in question then, in accordance with the instructions above, scan\n**the device with the latest version of the Malware Remover and run a full**\n**factory reset on the device prior to completing the firmware upgrade. For**\nadditional supply chain recommendations, see CISA’s tip on Securing Network\nInfrastructure Devices.\nBlock external connections when the device is intended to be used strictly for internal\nstorage.\n\n## References\n\n Revisions\n\nJuly 27, 2020: Initial Version\n\nAugust 4, 2020: Updated Mitigations section\n\nAugust 6, 2020: Updated Mitigations section\n\n[This product is provided subject to this Notification and this](https://us-cert.cisa.gov/privacy/notification) [Privacy & Use policy.](https://www.dhs.gov/privacy-policy)\n\n**Please share your thoughts.**\n\n[We recently updated our anonymous product survey; we'd welcome your feedback.](https://www.surveymonkey.com/r/CISA-cyber-survey?product=https://us-cert.cisa.gov/ncas/alerts/aa20-209a)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-27 - Alert (AA20-209A)- Potential Legacy Risk from Malware Targeting QNAP NAS Devices.pdf"
    ],
    "report_names": [
        "2020-07-27 - Alert (AA20-209A)- Potential Legacy Risk from Malware Targeting QNAP NAS Devices.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535740,
    "ts_updated_at": 1743041149,
    "ts_creation_date": 1653785880,
    "ts_modification_date": 1653785880,
    "files": {
        "pdf": "https://archive.orkl.eu/c552947715dfb5ad065023bbb337d8e1e3b4935b.pdf",
        "text": "https://archive.orkl.eu/c552947715dfb5ad065023bbb337d8e1e3b4935b.txt",
        "img": "https://archive.orkl.eu/c552947715dfb5ad065023bbb337d8e1e3b4935b.jpg"
    }
}