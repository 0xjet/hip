{
    "id": "4d8b5098-1534-4c9b-b5b9-38a46a985c80",
    "created_at": "2023-01-12T15:10:43.409803Z",
    "updated_at": "2025-03-27T02:16:01.204269Z",
    "deleted_at": null,
    "sha1_hash": "2dab8304cfed94586d4ebc908b21fe1bfdf2dd6e",
    "title": "2021-11-01 - From Thanos to Prometheus- When Ransomware Encryption Goes Wrong",
    "authors": "",
    "file_creation_date": "2022-05-28T01:26:36Z",
    "file_modification_date": "2022-05-28T01:26:36Z",
    "file_size": 1414266,
    "plain_text": "# When Ransomware Encryption Goes Wrong\n\n**[securityintelligence.com/posts/ransomware-encryption-goes-wrong/](https://securityintelligence.com/posts/ransomware-encryption-goes-wrong/)**\n\n[Home&nbsp/](https://securityintelligence.com/) [Incident Response](https://securityintelligence.com/category/topics/incident-response/)\nFrom Thanos to Prometheus: When Ransomware Encryption Goes Wrong\n\n[Incident Response November 1, 2021](https://securityintelligence.com/category/topics/incident-response/)\nBy [Aaron Gdanski co-authored by Limor Kessem 7 min read](https://securityintelligence.com/author/aaron-gdanski/)\n\n\n-----\n\nIBM Security [X-Force researchers have recently reverse-engineered Prometheus](https://www.ibm.com/security/xforce)\n[ransomware samples as part of ongoing incident response operations. X-Force has found](https://www.ibm.com/topics/ransomware)\nthat samples that infected organizational networks featured flawed encryption. This allowed\nour team to develop a fast-acting decryptor and help customers recover from the attack\nwithout a decryption key.\n\nWhile rare, ransomware developers can make mistakes in the ways they implement\n[encryption, causing unintended flaws. This is not the first time X-Force sees faulty encryption](https://www.ibm.com/topics/encryption)\nmechanisms save the day for victimized organizations. Mistakes can easily occur when\nmalware developers use patchwork code and dabble in cryptography without appropriate\nexpertise.\n\nMost organized cybercrime groups do use properly configured encryption, which is almost\nalways impossible to break. That said, the option to examine possibilities can make a\ndifference for victimized organizations and change the course of negotiation and recovery.\n\n## Thanos Breeds Hakbit, Prometheus, Haron and More Ransomware Trouble\n\n[In early 2020, a new ransomware family dubbed “Thanos” was discovered on sale in](https://exchange.xforce.ibmcloud.com/collection/Thanos-Ransomware-cee6d3536c0773ddd929d320729b1415)\nunderground forums mostly frequented by cybercriminals. At the time, Thanos was\nadvertised as a “Ransomware Affiliate Program,” available for anyone to buy. The malware\nsaw regular updates and new features added over time. A closer look at its code revealed\nthat it was also used at the baseline in ransomware samples that were tracked as “Hakbit”\n[and used in additional attacks that targeted organizations in Austria, Switzerland and](https://threatpost.com/hackbit-ransomware-attack-uses-guloader-malicious-microsoft-excel-attachments/156826/)\nGermany.\n\nThanos’ developer equipped it with a bootlocker in mid-2020 and was also using a somewhat\n[novel technique of encrypting files known as “RIPlace,” in which they weaponized research](https://threatpost.com/thanos-ransomware-weaponize-riplace-tactic/156438/)\ninto ransomware evasion techniques based on file characteristics.\n\n[In September 2020, Thanos was detected in attacks on government organizations in MEA. It](https://www.saudi24news.com/2020/09/thanos-affects-government-institutions-in-the-middle-east-2.html)\npresented the victims with a black screen that demanded money to unlock files, and while it\n[had a supposed capability to run a destructive attack,](https://media.cert.europa.eu/static/MEMO/2020/TLP-WHITE-CERT-EU-THREAT-MEMO-Thanos-ransomware.pdf) [that function did not work and left MBR](https://securityintelligence.com/news/thanos-ransomware-tries-fails-overwrite-mbr/)\nintact.\n\nBy June 2021, more of Thanos made headlines, only this time as the base code for another\nransomware, Prometheus. The latter was used in double-extortion attacks that encrypted\nfiles but also stole data and threatened to release it unless a hefty ransom was paid.\nPrometheus’ operators claimed to be part of the REvil group, they even placed a logo of\nsorts on their demands for ransom but provided no proof to that effect and may have wanted\nto use that as a pressure tactic.\n\n\n-----\n\n_Figure 1: Prometheus’ ransom note_\n\nWhile the original Thanos is not as active, its code does not rest. In mid-2021 it was detected\n[in further ransomware attacks, this time used by a group going by the name “Haron.”](https://threatpost.com/ransomware-gangs-haron-blackmatter/168212/)\n\nThe Thanos code itself was and is being used by multiple threat actors, some of which were\nsuspected to have nation-state sponsored ties. The Prometheus variant has died out in\nrecent months, but other variations can continue to rise from the same Thanos base. What\nchanges through each variation is customization. In Prometheus’ case, its operators used\nsocial engineering well, but were not as adept at working with encryption.\n\n## Breaking Prometheus\n\nWhile working on Prometheus samples that encrypted files on infected devices, IBM Security\nX-Force researchers uncovered a weakness in the key generation algorithm used in the\nencryption process. Unlike most ransomware cases, this was good news that ended up\nhelping a victimized organization.\n\nOur analysis showed that to generate the seed for encryption, the algorithm Prometheus\nselected uses a hardcoded initialization vector (IV) and the uptime of the computer. This\nmeans that the seed value is a lot easier to guess than it should be, since certain parameters\nabout the encrypted file and the infected device can be obtained.\n\n\n-----\n\nBased on such parameters, X-Force wrote a decryptor that ended up working quickly to\ndecrypt file types that had known file headers, for example: pdf, doc, xls, ppt, docx, xlsx,\npptx, 7z, mp3, jpg, jpeg, zip, iso, exe, dll, sys and png. Decrypting the files was made even\neasier when device boot time was known. Boot times are not a parameter one would have to\nguess, they can be obtained via the CBS.log file in the Windows directory.\n\nUsing the decryptor was a great option for the recovery process X-Force supported, but\nanother note is important here. Some open-source decryption tools may emerge over time\nand might seem like a recovery tool that can help in large-scale cases. One must consider\nthe time it takes a decryptor to unlock each file. Some open-source tools can take around\nfive hours per file, or more, which would be too time consuming in cases where a lot of data\nis no longer accessible. A reasonable amount of time to decrypt each file should be a few\nminutes or less.\n\n## Encryption Methodology and Weaknesses\n\nIn the Prometheus variants analyzed, there are two ways the ransomware can be configured\nfor encryption:\n\n### Configuration 1\n\nEncryption process per file:\n\n1. A 32-byte string is generated using C#’s Random class. The default constructor is\n\nused, which passes Environment.TickCount as the seed.\n2. The string is then encrypted using a hard-coded RSA public key. PKCS#1 v1.5 padding\n\nis used. The ciphertext is then Base64 encoded.\n[3. The file is encrypted using a symmetric algorithm (Salsa20) with a hardcoded 8-byte](https://en.wikipedia.org/wiki/Salsa20)\n\narray as the initialization vector (IV).\n4. The key is the 32-byte string described above. The ciphertext is written to the\n\nencrypted file.\n5. The encrypted, Base64 encoded key is then appended to the end of the encrypted file,\n\nalong with the string ‘GotAllDone’.\n\n### Configuration 2\n\nEncryption process per file:\n\n1. A 32-byte string is generated using C#’s Random class. The default constructor is\n\nused, which passes Environment.TickCount as the seed.\n2. The string is then encrypted using a hard-coded RSA public key. PKCS#1 v1.5 padding\n\nis used. The ciphertext is then Base64 encoded.\n\n\n-----\n\n[3. RFC2898DeriveBytes is used to generate a 32-byte key and an 8 byte IV. The](https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.rfc2898derivebytes?view=net-5.0)\n\nRfc2898DeriveBytes Class implements password-based key derivation functionality,\nPBKDF2, by using a pseudo-random number generator. The string generated above is\nused as the password, and the salt is a hardcoded 8-byte array.\n4. The file is encrypted using a symmetric algorithm using the parameters generated\n\nabove. The ciphertext is written to the encrypted file.\n5. The encrypted, Base64 encoded key is then appended to the end of the encrypted file,\n\nalong with the string ‘GotAllDone’.\n\n### Weaknesses in This Encryption Methodology\n\nX-Force found this technique to be lacking in a way that allowed for finding a way to decrypt\naffected files.\n\nC#’s Random class will generate the exact same bytes as long as the seed is known. In this\ncase, the seed is the Environment.TickCount variable, which is the number of milliseconds\nelapsed since a computer was last started.\n\nThat seed value can be guessed given certain parameters. Moreover, the\nEnvironment.TickCount variable is also updated around every 16 milliseconds, so it is\npossible for multiple files to have the same key, which can make decryption even faster down\nthe line.\n\nThe hardcoded IV provided no additional security in this case, considering it can easily be\nobtained and appears to be the same for every sample analyzed. To make encryption\nstronger, the IV should typically be random or pseudorandom.\n\n## Decryption Requirements and Issues\n\nCan all Prometheus samples be broken in the same way? X-Force’s analysis indicates that\nany Prometheus sample that uses the C# Random class to generate keys is vulnerable. Of\n[note, they only decrypted files that were encrypted using a Salsa20 stream cipher. Some](https://en.wikipedia.org/wiki/Salsa20)\n[Prometheus ransomware samples can be configured to use AES-256 and while these](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard)\nsamples are still vulnerable, X-Force did not test the decryptor on such in their current work.\n\n### Requirements\n\nTo decrypt files, we would need the following information:\n\nThe hardcoded IV used in the sample. In all samples observed, the IV was an 8-byte\narray: 1, 2, 3, 4, 5, 6, 7, 8.\nText or bytes to search for from the decrypted file. X-Force used known file header\nbytes associated with common file extensions. For example, if the encrypted file’s\noriginal extension is .pdf, the text to search for in the file to determine success is\n“%PDF”\n\n\n-----\n\n### Optional Data to Use\n\nThe configuration of the sample: it’s better to determine which configuration is being\nused for the encryption. For instance, should RFC2898DeriveBytes be used to obtain\nthe key?\nMtime — the file’s modification time as recorded by the infected device.\nThe boot time of the infected device. This can be found in the CBS.log file, which is in\nthe Windows directory. This parameter may not have to be exact. Note that\nPrometheus will not encrypt this file. This file also contains all boot times, meaning it is\npossible to obtain the boot time even if encryption happened months ago. If the boot\ntime and file modification time are not provided, decryption is still possible but will take\nsignificantly longer.\n\n### File Type Limitation\n\nCurrently, only files with known file headers can be decrypted. For example: pdf, doc, xls,\nppt, docx, xlsx, pptx, 7z, mp3, jpg, jpeg, zip, iso, exe, dll, sys and png.\n\n## Decryption Process Overview\n\nThe following process is what X-Force used in their current work to decrypt data encrypted\nby Prometheus. It focuses on the malware’s first configuration.\n\n### Decryption in Configuration 1 Mode\n\n1. Extract the encrypted text from the file intended for decryption. This can be done by\n\nremoving the junk appended to the end of the file. The amount of junk is equivalent to\nBASE64_ENCODED_SIZE(RSA_KEY_SIZE) + ‘GotAllDone’.Length.\n2. Attempt to estimate the tick count at the time of encryption. The tick count begins at\n\nzero on system boot, is incremented every millisecond, but only updated every 10-15\nmilliseconds. Tick count continuously loops after hitting INT_MAX.\n3. Continuously attempt to generate a key and decrypt the ciphertext using the potential\n\nseed.\n4. Decrement the potential seed if the plaintext is not correct. In most cases, the\n\nestimated seed should be within 6000 values of the correct seed. It appears that each\nfile should take around 10 seconds to decrypt, without any optimization considered.\n\nNote that during any decryption effort, whether custom-built or provided by ransomware\nactors, certain conditions can affect the accuracy of time estimates of the decryption. If a file\ntakes longer than desired to unlock, it is likely that any other file from that same device will\ntake a similar amount of time.\n\n### Decrypting Multiple Files From the Same Infected Device\n\n\n-----\n\nIf the seed value is found for the first file encrypted, that seed value can be continuously\nincremented in order to find the values for every other file. This may provide a slightly faster\ndecryption process for computers with hundreds or thousands of files to decrypt.\n\nThe decryptor tool can be run against an entire directory of files or on a per file basis.\n\n## A True Digital Pandemic\n\nThe ransomware problem has turned into a true pandemic for organizations. Every month\nnew attacks are detected, and new malware families and variations arise in the commercial\ncybercrime arena and through closed groups. Companies are struggling to prevent\nransomware infections on the one hand and prepare for incidents on the other. Paying\ncybercriminals has also turned into a high-stake negotiation where the leverage is almost\nalways on the attacker’s side.\n\nWill it ever end? With this crime being so rampant in industrialized countries, governments\n[and law enforcement agencies are becoming increasingly involved in ransomware cases,](https://www.washingtonpost.com/national-security/ransomware-fbi-revil-decryption-key/2021/09/21/4a9417d0-f15f-11eb-a452-4da5fe48582d_story.html)\nespecially in cases where multiple companies are hit.\n\nStopping attacks is hard because it only takes a small security gap for attackers to find a way\nin. Response goes a longer way in detecting, containing and helping organizations recover\nfrom ransomware attacks. IBM Security X-Force can help. For a ransomware readiness and\n[response guide, download the Definitive Guide to Ransomware here. For any other](https://www.ibm.com/downloads/cas/EV6NAQR4)\nassistance by IBM’s team of experts, explore their incident response and threat intelligence\n[services here.](https://www.ibm.com/security/services/ibm-x-force-incident-response-and-intelligence)\n\n[Aaron Gdanski](https://securityintelligence.com/author/aaron-gdanski/)\nIBM Security X-Force Intern\n\nAaron Gdansky is a teaching assistant at the Rochester Institute of Technology. He is an\nactive intern with IBM Security’s X-Force team, working on malware...\n\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-01 - From Thanos to Prometheus- When Ransomware Encryption Goes Wrong.pdf"
    ],
    "report_names": [
        "2021-11-01 - From Thanos to Prometheus- When Ransomware Encryption Goes Wrong.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "7ea1e0de-53b9-4059-802f-485884180701",
            "created_at": "2022-10-25T16:07:24.04846Z",
            "updated_at": "2025-03-27T02:02:10.090459Z",
            "deleted_at": null,
            "main_name": "Patchwork",
            "aliases": [
                "APT-C-09",
                "ATK 11",
                "Capricorn Organisation",
                "Chinastrats",
                "Dropping Elephant",
                "Maha Grass",
                "Quilted Tiger",
                "TG-4410",
                "Thirsty Gemini",
                "Zinc Emerson"
            ],
            "source_name": "ETDA:Patchwork",
            "tools": [
                "AndroRAT",
                "Artra Downloader",
                "ArtraDownloader",
                "AutoIt backdoor",
                "BADNEWS",
                "BIRDDOG",
                "Bahamut",
                "Bozok",
                "Bozok RAT",
                "Brute Ratel",
                "Brute Ratel C4",
                "CinaRAT",
                "Crypta",
                "ForeIT",
                "JakyllHyde",
                "Loki",
                "Loki.Rat",
                "LokiBot",
                "LokiPWS",
                "NDiskMonitor",
                "Nadrac",
                "PGoShell",
                "PowerSploit",
                "PubFantacy",
                "Quasar RAT",
                "QuasarRAT",
                "Ragnatela",
                "Ragnatela RAT",
                "SocksBot",
                "TINYTYPHON",
                "Unknown Logger",
                "WSCSPL",
                "Yggdrasil"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "9c884c88-2c9f-49c5-856a-2383ad1d8ef8",
            "created_at": "2024-05-01T02:03:08.152Z",
            "updated_at": "2025-03-27T02:05:17.422887Z",
            "deleted_at": null,
            "main_name": "ZINC EMERSON",
            "aliases": [
                "Dropping Elephant ",
                "EHDevel ",
                "Manul ",
                "Monsoon ",
                "Operation Hangover ",
                "Patchwork ",
                "TG-4410 ",
                "Viceroy Tiger ",
                "Confucius "
            ],
            "source_name": "Secureworks:ZINC EMERSON",
            "tools": [
                " Hanove",
                " Mac OS X KitM Spyware",
                " Proyecto2",
                " YTY Backdoor",
                "Enlighten Infostealer"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "c81067e0-9dcb-4e3f-abb0-80126519c5b6",
            "created_at": "2022-10-25T15:50:23.285448Z",
            "updated_at": "2025-03-27T02:00:55.42906Z",
            "deleted_at": null,
            "main_name": "Patchwork",
            "aliases": [
                "Hangover Group",
                "Dropping Elephant",
                "Chinastrats",
                "Operation Hangover"
            ],
            "source_name": "MITRE:Patchwork",
            "tools": [
                "NDiskMonitor",
                "QuasarRAT",
                "BackConfig",
                "TINYTYPHON",
                "AutoIt backdoor",
                "PowerSploit",
                "BADNEWS",
                "Unknown Logger",
                "Socksbot"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536243,
    "ts_updated_at": 1743041761,
    "ts_creation_date": 1653701196,
    "ts_modification_date": 1653701196,
    "files": {
        "pdf": "https://archive.orkl.eu/2dab8304cfed94586d4ebc908b21fe1bfdf2dd6e.pdf",
        "text": "https://archive.orkl.eu/2dab8304cfed94586d4ebc908b21fe1bfdf2dd6e.txt",
        "img": "https://archive.orkl.eu/2dab8304cfed94586d4ebc908b21fe1bfdf2dd6e.jpg"
    }
}