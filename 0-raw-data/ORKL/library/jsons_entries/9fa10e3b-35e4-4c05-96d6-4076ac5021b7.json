{
    "id": "9fa10e3b-35e4-4c05-96d6-4076ac5021b7",
    "created_at": "2022-10-25T16:48:19.659064Z",
    "updated_at": "2025-03-27T02:16:20.87895Z",
    "deleted_at": null,
    "sha1_hash": "5bbf6a633076473dc4b2afb6d166c8caa84463e4",
    "title": "The Regin Platform Nation-State Ownership Of Gsm Networks",
    "authors": "Kaspersky",
    "file_creation_date": "2014-11-24T15:26:27Z",
    "file_modification_date": "2014-11-24T15:28:43Z",
    "file_size": 5052692,
    "plain_text": "# THE REGIN PLATFORM NATION-STATE OWNERSHIP OF GSM NETWORKS\n\n## Kaspersky Lab Report\n\n#### Version 1.0\n 24 November 2014\n\n\n-----\n\n#### 2\n\n### Contents\n\nIntroduction, history...................................................................................................................................................... 3\n\nInitial compromise and lateral movement................................................................................................................... 3\n\nThe Regin platform........................................................................................................................................................ 4\n\nStage 1 – 32/64 bit................................................................................................................................................ 4\nStage 2 – loader – 32-bit....................................................................................................................................... 7\nStage 2 – loader – 64-bit....................................................................................................................................... 8\nStage 3 – 32-bit – kernel mode manager “VMEM.sys”........................................................................................ 8\nStage 3 – 64-bit....................................................................................................................................................... 9\nStage 4 (32-bit) / 3 (64-bit) – dispatcher module, ‘disp.dll’................................................................................. 9\n\n32-bit.................................................................................................................................................................. 9\n64-bit.................................................................................................................................................................. 9\nStage 4 – Virtual File Systems (32/64-bit)..........................................................................................................10\n\nUnusual modules and artifacts..................................................................................................................................16\n\nArtifacts..................................................................................................................................................................16\nGSM targeting........................................................................................................................................................18\n\nCommunication and C&C...........................................................................................................................................20\n\nVictim statistics ..........................................................................................................................................................22\n\nAttribution....................................................................................................................................................................23\n\nConclusions.................................................................................................................................................................23\n\nTechnical appendix and indicators of compromise...................................................................................................24\n\nYara rules................................................................................................................................................................24\nMD5s......................................................................................................................................................................25\n\nRegistry branches used to store malware stages 2 and 3.............................................................................26\nC&C IPs...................................................................................................................................................................26\nVFS RC5 decryption algorithm..............................................................................................................................27\n\nTLP: GREEN [Contact: intelreports@kaspersky.com](mailto:intelreports%40kaspersky.com?subject=)\n\n\n-----\n\n#### 3\n\n### Introduction, history\nIn the spring of 2012, following a Kaspersky Lab presentation on the unusual facts surrounding the Duqu\n[malware (http://www.kaspersky.com/about/press/major_malware_outbreaks/duqu), a security researcher](http://www.kaspersky.com/about/press/major_malware_outbreaks/duqu)\ncontacted us and mentioned that Duqu reminded him of another high-end malware incident. Although he\ncouldn’t share a sample, the researcher mentioned ‘Regin’, a type of malware attack that is now dreaded\nby security administrators in many government agencies around the world.\n\nFor the past three years we have been tracking this most elusive malware all around the world. From time\nto time samples would appear on various multi-scanner services, but they were all unrelated to each other,\ncryptic in functionality, and lacking in context.\n\nIt is unknown exactly when the first samples of Regin appeared in the wild. Some of them have timestamps\ndating back to 2003.\n\nThe victims of Regin fall into the following categories:\n\n  - Telecom operators\n\n  - Government institutions\n\n  - Multinational political bodies\n\n  - Financial institutions\n\n  - Research institutions\n\n  - Individuals involved in advanced mathematical/cryptographic research\n\nSo far, we’ve observed two main objectives of the attackers:\n\n  - Intelligence gathering\n\n  - Facilitating other types of attacks\n\nWhile in most cases the attackers were focused on extracting sensitive information such as emails and other elec­\ntronic documents, we have observed cases where the attackers compromised telecom operators to enable the\nlaunch of additional sophisticated attacks. This is discussed in detail in the GSM attacks section, below.\n\n[Perhaps one of the most well-known victims of Regin was Jean Jacques Quisquater (https://en.wikipedia.org/](https://en.wikipedia.org/wiki/Jean-Jacques_Quisquater)\n[wiki/Jean-Jacques_Quisquater), a well-known Belgian cryptographer. In February 2014, Quisquater announced](https://en.wikipedia.org/wiki/Jean-Jacques_Quisquater)\nhe was the victim of a sophisticated cyber-intrusion incident. We were able to obtain samples from the Quisquater\ncase and confirm they belong to the Regin platform.\n\nAnother victim of Regin was a computer we call the ‘Magnet of Threats’. The computer belongs to a certain\nresearch institution and, besides Regin, it has been attacked by Animal Farm, Itaduke, Mask/Careto, Turla,\nand some other advanced threats that do not have public names, all co-existing happily on the same computer\nat some point.\n\n### Initial compromise and lateral movement\nThe exact method used for the initial compromise remains a mystery, although several theories exist, including\nuse of man-in-the-middle attacks with browser zero-day exploits. For some of the victims we observed tools and\nmodules designed for lateral movement. So far we have not encountered any exploits. The replication modules\nare copied to remote computers using Windows administrative shares and then executed. Obviously this tech­\nnique requires administrative privileges inside the victim’s network. In several cases the infected machines\nwere also Windows domain controllers. Targeting of system administrators via web-based exploits is a simple\nway of achieving immediate administrative access to the entire network.\n\nTLP: GREEN [Contact: intelreports@kaspersky.com](mailto:intelreports%40kaspersky.com?subject=)\n\n\n-----\n\n#### 4\n\n### The Regin platform\nAlthough some private research groups refer to it as the ‘Regin malware’, it is not entirely accurate to use\nthe term malware in this case. In essence, Regin is a cyberattack platform, which the attackers deploy in victim\nnetworks for total remote control at all levels.\n\nThe platform is extremely modular in nature and has multiple stages.\n\nRegin platform diagram\n\n#### Stage 1 – 32/64 bit\n\nKnown MD5s:\n\n01c2f321b6bfdb9473c079b0797567ba\n\n06665b96e293b23acc80451abb413e50\n\n187044596bc1328efa0ed636d8aa4a5c\n\n1c024e599ac055312a4ab75b3950040a\n\n26297dc3cd0b688de3b846983c5385e5\n\n2c8b9d2885543d7ade3cae98225e263b\n\n47d0e8f9d7a6429920329207a32ecc2e\n\n4b6b86c7fec1c574706cecedf44abded\n\n6662c390b2bbbd291ec7987388fc75d7\n\n744c07e886497f7b68f6f7fe57b7ab54\n\nb269894f434657db2b15949641a67532\n\nb29ca4f22ae7b7b25f79c1d4a421139d\n\nb505d65721bb2453d5039a389113b566\n\nba7bb65634ce1e30c1e5415be3d1db1d\n\nbfbe8c3ee78750c3a520480700e440f8\n\nd240f06e98c8d3e647cbf4d442d79475\n\ndb405ad775ac887a337b02ea8b07fddc\n\nTLP: GREEN [Contact: intelreports@kaspersky.com](mailto:intelreports%40kaspersky.com?subject=)\n\n\n-----\n\n#### 5\n\nffb0b9b5b610191051a7bdf0806e1e47\n\nIn general, the first samples victims detect in their networks are stage 1 loaders. These are the easiest to notice\nbecause they are the only executables that exist directly on the victim’s computer.\n\nThese samples use an odd technique to load the next stages, which until recently was unique to Regin. Inter­\nestingly, in mid-2012, the ZeroAccess gang implemented a very similar loading mechanism, which possibly\n[suggests it learned about Regin and its unique features. (See http://www.symantec.com/connect/blogs/](http://www.symantec.com/connect/blogs/trojanzeroaccessc-hidden-ntfs-ea)\n[trojanzeroaccessc-hidden-ntfs-ea).](http://www.symantec.com/connect/blogs/trojanzeroaccessc-hidden-ntfs-ea)\n\nThe particular feature used (or abused) by Regin to hide its next stages is called NTFS Extended Attributes\n(EA). Originally, these were implemented in Windows NT for compatibility with OS/2 applications; however, they\nmade their way into later versions of Windows, namely 2000, XP and Vista. The malware hides its modules in\nNTFS EAs, splitting large files into several blocks of limited size. These are dynamically joined, decrypted and\nexecuted in memory.\n\nMost of the stage 1 samples we have seen appear to have been built on top of other source code projects,\nwhich are ‘piggybacked’; for instance, the Ser8UART project:\n[http://www.mirrorservice.org/sites/downloads.sourceforge.net/s/se/ser8uart-driver/ser8uart-driver/](http://www.mirrorservice.org/sites/downloads.sourceforge.net/s/se/ser8uart-driver/ser8uart-driver/Ser8UART%20%201.1.2.1/)\n[Ser8UART%20%201.1.2.1/.](http://www.mirrorservice.org/sites/downloads.sourceforge.net/s/se/ser8uart-driver/ser8uart-driver/Ser8UART%20%201.1.2.1/)\n\nFor instance, the Regin loader with md5 01c2f321b6bfdb9473c079b0797567ba was built on top of the\nSer8UART source code. A careful examination however spots the encrypted configuration block at offset 0x5600.\n\nWe can assume the attackers take various low-level open-source projects or Windows DDK source codes and\nmerge them together with their malicious loader. Hence, each stage 1 loader looks very different from others,\nas it contains random useless code from various other programs. This technique makes it more difficult to build\nreliable detection for the loaders.\n\nDespite the differences, all stage 1 samples are similar in functionality. They contain an encrypted config block\nthat points to the next stages:\n\nOnce decrypted, the block contains several folder names and registry key names:\n\nTLP: GREEN [Contact: intelreports@kaspersky.com](mailto:intelreports%40kaspersky.com?subject=)\n\n\n-----\n\n#### 6\n\nIn the example above, the stage 1 tries to load a second stage from the extended attributes of the system direc­\ntory specified in the configuration block (in our case, the WINDOWS folder). It also tries to read additional data\nfrom the EAs of the second directory (in our case, the WINDOWS\\fonts directory). The second attribute value\nis optional and may have been used to overcome size limitations.\n\nIf the first EA data block is missing, the module also tries to read the complete body of the 2nd stage from\na registry value using the key and value names from the configuration block.\n\nThe body of the second stage is encrypted with one of two algorithms that are simple variations of XOR, and\nis supposed to be a PE file. The first stage loads that file in memory and calls its entry point function.\n\nThe 64-bit variant works in a slightly different way. Instead of storing the 2nd stage in the registry or extended\nattributes, the attackers preferred to store it after the end of the last partition on disk.\n\nKnown filenames for the 64-bit stage 1:\n\n  - system32\\wsharp.dll – detected on a victim machine in Germany\n\n  - system32\\wshnetc.dll – detected on a victim machine in Belgium\n\nAll the stage 1 modules for 64-bit systems were signed with fake digital certificates. The two fake certificates we\nidentified are supposed to belong to Microsoft Corporation and Broadcom Corporation. During the infection phase,\nthe attackers inject a trusted CA in the certificates chain, which instructs the system to trust their signatures.\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 7\n\nHere is what the hard drive of a 64-bit system infected with Regin looks like:\n\nInterestingly, while the 32-bit Regin stage 1 runs in kernel mode, on 64-bit systems the attacker code starts in user\nmode. This is perhaps due to the fact that it is more difficult to run kernel mode on modern Windows 64-bit systems.\n\n#### Stage 2 – loader – 32-bit\n\nKnown MD5s:\n\n18d4898d82fcb290dfed2a9f70d66833\n\nb9e4f9d32ce59e7c4daf6b237c330e25\n\nThe second stage for 32-bit systems is implemented as a driver module. It has a configuration block encrypted in\na similar way to the first stage module. The configuration block contains the names of two system directories that\nhold the encrypted third stage in their extended attributes. It also has the name of a registry value that may hold\nthe body of the third stage in case the EAs are missing (for computers with a FAT/FAT32-formatted system disk).\n\nOnce the encrypted third stage is read from the registry or NTFS EAs, it is decrypted using the RC5 algorithm\nand a fixed 16-byte key that is hardcoded in the second stage. Then, it is decompressed using the NRV2e algo­\nrithm from the open-source UCL library. The second stage module loads the resulting binary in memory, vali­\ndates that it is a valid PE file, and calls its entry point in a system thread.\n\nThe second stage also creates a marker file that can be used to identify the infected machine. Known filenames\nfor this marker are:\n\n  - %SYSTEMROOT%\\system32\\nsreg1.dat\n\n  - %SYSTEMROOT%\\system32\\bssec3.dat\n\n  - %SYSTEMROOT%\\system32\\msrdc64.dat\n\nThese files have their timestamp set to the timestamp of the system file ‘%SYSTEMROOT%\\system32\\lsass.exe’\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 8\n\nThe second stage has additional code for removing the startup code of Regin if signaled by the third stage. Its\nconfiguration data contains the locations of the first three stages, including registry keys, names of the directo­\nries that hold the encrypted EAs, and the location of the initial driver.\n\nEssentially, the second stage can remove all the Regin stages from the system, effectively cleaning the machine\nand leaving only the encrypted VFS behind.\n\nDecrypted configuration block of the second stage\n\n#### Stage 2 – loader – 64-bit\n\nKnown MD5:\n\nd446b1ed24dad48311f287f3c65aeb80\n\nThe 64-bit version of the second stage loader is a PE DLL module, since the 64-bit bootstrap chain operates\nin user mode.\n\nJust like the first stage, it loads the encrypted body of the next stage from the end of the physical disk and\ndecrypts it with a hardcoded RC5 key, then decompresses it using the nrv2 algorithm from the UCL library.\n\nAfter decryption and decompression, the code checks if the next stage is a Windows PE DLL module, and if it is,\nit loads and executes it.\n\n#### Stage 3 – 32-bit – kernel mode manager “VMEM.sys”\n\nKnown MD5s:\n\n8486ec3112e322f9f468bdea3005d7b5\n\nda03648948475b2d0e3e2345d7a9bbbb\n\nOn 32-bit systems, the third stage is implemented as a driver module and provides the basic functionality of\nthe malicious framework. It is responsible for operating the encrypted virtual file system and loading additional\nplugins, and also provides several built-in plugins for the entire framework.\n\nThe module initializes the framework, sets up the plugin system and starts the actual work cycle of the malware.\nIt also passes execution to the plugin id 50221 that is loaded from the VFS.\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 9\n\nBuilt-in plugins provided by this module are:\n\nId Plugin description\n\n1 Core framework functionality\n\n13 UCL library for compression and decompression using the nrv2 family of algorithms\n\n15 RC5 encryption and decryption facilities\n\n61 API for manipulating the encrypted virtual file system (VFS)\n\n7 API for manipulating the encrypted virtual file system (VFS)\n\n50225 API for code injection and kernel-mode hooking\n\n50215 System information\n\n50223 Module notification routines\n\n50111 Utilities\n\n#### Stage 3 – 64-bit\n\nOn 64-bit Windows systems, stage 3 is missing. Stage 2 loads the dispatcher directly from the disk and runs it.\n\n#### Stage 4 (32-bit) / 3 (64-bit) – dispatcher module, ‘disp.dll’\n\n##### 32-bit\n\nKnown MD5s:\n\n1e4076caa08e41a5befc52efd74819ea\n\n68297fde98e9c0c29cecc0ebf38bde95\n\n6cf5dc32e1f6959e7354e85101ec219a\n\n885dcd517faf9fac655b8da66315462d\n\na1d727340158ec0af81a845abd3963c1\n\n##### 64-bit\n\nKnown MD5:\n\nde3547375fbf5f4cb4b14d53f413c503\n\nThe dispatcher library is the user-mode core of the framework. It is loaded directly as the third stage of the 64-bit\nbootstrap process, or extracted and loaded from the VFS as module 50221 as the fourth stage on 32-bit systems.\n\nIt implements a set of internal plugins:\n\nId Plugin description\n\n1 Core framework functionality\n\n13 UCL library for compression and decompression using the nrv2 family of algorithms\n\n15 RC5 encryption and decryption facilities\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n|Id|Plugin description|\n|---|---|\n|1|Core framework functionality|\n|13|UCL library for compression and decompression using the nrv2 family of algorithms|\n|15|RC5 encryption and decryption facilities|\n|61|API for manipulating the encrypted virtual file system (VFS)|\n|7|API for manipulating the encrypted virtual file system (VFS)|\n|50225|API for code injection and kernel-mode hooking|\n|50215|System information|\n|50223|Module notification routines|\n|50111|Utilities|\n\n|It implements a set|of internal plugins:|\n|---|---|\n|Id|Plugin description|\n|1|Core framework functionality|\n|13|UCL library for compression and decompression using the nrv2 family of algorithms|\n|15|RC5 encryption and decryption facilities|\n\n\n-----\n\n#### 10\n\nId Plugin description\n\n61 API for manipulating the encrypted virtual file system (VFS)\n\n7 API for manipulating the encrypted virtual file system (VFS)\n\n11 File writer\n\n51 Autostart installation routines\n\n17 In-memory storage object\n\n19 Configuration storage object\n\n50035 Winsock-based network transport\n\n25 Network transport using packet filters\n\n9 Network transport-related utilities\n\nThe dispatcher takes care of the most complicated tasks of the Regin platform, such as providing an API to\naccess virtual file systems, basic communications and storage functions, as well as network transport subroutines. In essence, the dispatcher is the brain that runs the entire platform.\n\n#### Stage 4 – Virtual File Systems (32/64-bit)\n\nThe most interesting code from the Regin platform is stored in encrypted file storages, known as Virtual File\nSystems (VFSes).\n\nDuring our analysis we were able to obtain 24 VFSes from multiple victims around the world. Generally, these\nhave random names and can be located in several places in the infected system:\n\nFolder on disk File name Description\n\nC:\\Windows\\System32\\config\\ SystemAudit.Evt, SystemLog. Old / ancient style,\nEvt, SecurityLog.Evt, Security­ still around\nAudit.Evt, CACHE, SESSIONMGR\n\nC:\\Windows\\System32\\ UsrClass.dat Old / ancient style,\nstill around\n\nC:\\WINDOWS\\pchealth\\helpctr\\Database cdata.dat, Old / ancient style,\n\nstill around\n\ncdata.edb\n\nC:\\Windows\\System32\\config\\ UsrEvent.evt, ApplicationLog.Evt Inside VFS, 6th stage\n\nC:\\Windows\\Panther\\ setup.etl.000 Used in a 64-bit infection\n\nC:\\Windows\\System32\\wbem\\repository\\ INDEX2.DATA, New style encryption,\n\nMay 2014\n\nOBJECTS2.DATA\n\nC:\\Windows\\System32\\ dnscache.dat, mregnx.dat New style encryption,\n\nMay 2014\n\ndispln32.dat, dmdskwk.dat,\nnvwrsnu.dat,\n\ntapiscfg.dat\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n|Id|Plugin description|\n|---|---|\n|61|API for manipulating the encrypted virtual file system (VFS)|\n|7|API for manipulating the encrypted virtual file system (VFS)|\n|11|File writer|\n|51|Autostart installation routines|\n|17|In-memory storage object|\n|19|Configuration storage object|\n|50035|Winsock-based network transport|\n|25|Network transport using packet filters|\n|9|Network transport-related utilities|\n\n|Folder on disk|File name|Description|\n|---|---|---|\n|C:\\Windows\\System32\\config\\|SystemAudit.Evt, SystemLog. Evt, SecurityLog.Evt, Security­ Audit.Evt, CACHE, SESSIONMGR|Old / ancient style, still around|\n|C:\\Windows\\System32\\|UsrClass.dat|Old / ancient style, still around|\n|C:\\WINDOWS\\pchealth\\helpctr\\Database|cdata.dat, cdata.edb|Old / ancient style, still around|\n|C:\\Windows\\System32\\config\\|UsrEvent.evt, ApplicationLog.Evt|Inside VFS, 6th stage|\n|C:\\Windows\\Panther\\|setup.etl.000|Used in a 64-bit infection|\n|C:\\Windows\\System32\\wbem\\repository\\|INDEX2.DATA, OBJECTS2.DATA|New style encryption, May 2014|\n|C:\\Windows\\System32\\|dnscache.dat, mregnx.dat displn32.dat, dmdskwk.dat, nvwrsnu.dat, tapiscfg.dat|New style encryption, May 2014|\n\n\n-----\n\n#### 11\n\nEach VFS has a structure that is very similar to a real disk file system such as FAT. The VFS files start with a header\nthat provides basic information required to operate the file system. The header is followed by the bitmap of used/\nfree sectors and then by the file table.\n\nOffset Size Field description\n\n00 02 Sector size\n\n02 02 Maximum number of sectors\n\n04 02 Maximum number of files\n\n06 01 Unknown\n\n07 04 CRC32 of first seven bytes of the header with seed 0x45\n\n0B 04 Size of the file ID field, in bytes\n\n0F 02 Number of files\n\n11 maxSectors/8 Sector usage bitmap\n\nFile table\n\nSectors\n\nFiles are described by file table entries:\n\nOffset Size Field description\n\n00 04 CRC32 of file contents with seed 0x27\n\n04 04 File size\n\n08 04 Offset of the first sector\n\n0C Size of the file ID field File ID / Plugin ID\n\nEach sector starts with a 32-bit integer that is the offset of the next sector of the file.\n\n00 Offset of the next sector\n\n04 (Sector size)*byte of file data\n\nAn example:\n\n  - File record at offset 0x122, file ID 50221, offset of the first sector 0x7B13\n\n  - Sector at 0x7B13, next sector at 0x7D13\n\n  - Sector at 0x7D13, next sector at 0x7F13,\n\n  - Sector at 0x7F13, next sector at 0x8113, etc.\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n|Offset|Size|Field description|\n|---|---|---|\n|00|02|Sector size|\n|02|02|Maximum number of sectors|\n|04|02|Maximum number of files|\n|06|01|Unknown|\n|07|04|CRC32 of first seven bytes of the header with seed 0x45|\n|0B|04|Size of the file ID field, in bytes|\n|0F|02|Number of files|\n|11|maxSectors/8|Sector usage bitmap|\n|||File table|\n|||Sectors|\n\n|Offset|Size|Field description|\n|---|---|---|\n|00|04|CRC32 of file contents with seed 0x27|\n|04|04|File size|\n|08|04|Offset of the first sector|\n|0C|Size of the file ID field|File ID / Plugin ID|\n\n|00|Offset of the next sector|\n|---|---|\n|04|(Sector size)*byte of file data|\n\n\n-----\n\n#### 12\n\nExample of Regin VFS parsing\n\nAlthough the structures of the file system are unencrypted, the file entries are encrypted. The encryption algo­\nrithm used is RC5, and many records are also compressed using the nrv2e algorithm from the UCL library. UCL\nis an open source implementation of the proprietary NRV (‘Not Really Vanished’) compression algorithm, and\nwas originally used by the UPX tool. The reason why the attackers chose UCL is simple: it’s small, compact and\nrequires little to no additional memory for decompression.\n\nEach VFS we encountered was encrypted with a 16 bytes key, which can vary from victim to victim. Based on\nour experience, most files were however encrypted with the same key, {73 23 1F 43 93 E1 9F 2F 99 0C 17 81\n5C FF B4 01} stored in the dispatcher module or VMEM.sys kernel core.\n\nVFS RC5 decryption key inside the dispatcher module (disp.dll)\n\nIn all, we observed about a dozen different VFS keys.\n\nThe following plugins were observed inside the VFSes we collected. These are all identified by a 16-bit number.\nThe plugins are referenced by these numbers; they are like filenames on a normal file system and allow the\ndispatcher to easily load or reference them.\n\nThe binary modules are referenced by these numbers as plugin identifiers and usually have similar internal DLL\nnames; e.g., the plugin with ID ‘50121’ will have the internal name ‘50121.dll’ in its export table. Compressed\nbinary modules are accompanied by binary files with the same ID. These files contain the size of the decom­\npressed module and are not included in the description.\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 13\n\nKnown data blocks and their configuration IDs:\n\n0 4 bytes, unknown\n\n1 Configuration data; timestamped binary data\n\n4 4 bytes, unknown\n\n9 Transport list and configurations, including peer hostnames and addresses\n\n11 Location of an additional ‘.evt’ file, usually ‘ApplicationLog.evt’\n\n13 Configuration data\n\n14 Configuration data\n\n15 Peer encryption keys\n\n19 Peer network configuration data\n\n25 Packet filter configuration\n\n51 4 bytes, unknown\n\n10001 Strings: ‘legspinv2.6’, ‘WILLISCHECKv2.0’, additional configuration data\n\n10207 Configuration data\n\n10404 Configuration data\n\n10405 Configuration data\n\n10505 1 byte; unknown\n\n50009 Configuration data\n\n50013 List of processes (‘snort.exe’, ‘wireshark.exe’, ‘rundll32.exe’, etc.)\n\n50049 Log of GSM base station commands. Very rare, most interesting\n\n50079 Location of a temporary file\n\n50121 Drive names\n\n50139 Event log provider names\n\n50181 Data used by network transport plugins\n\n50185 Plugin configuration\n\n50227 Plugin configuration\n\n50233 Process file name list (Explorer.exe, VMWareService.exe, Update.exe, Msiexec.exe,\nMailService.exe, etc.)\n\n56001 Plugin configuration\n\n57003 Configuration data\n\nKnown executable modules and their plugin IDs:\n\n0 Data only\n\n1 Core framework functionality\n\n3 ‘3.sys’ file timestamp manipulation; utilities\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n|0|4 bytes, unknown|\n|---|---|\n|1|Configuration data; timestamped binary data|\n|4|4 bytes, unknown|\n|9|Transport list and configurations, including peer hostnames and addresses|\n|11|Location of an additional ‘.evt’ file, usually ‘ApplicationLog.evt’|\n|13|Configuration data|\n|14|Configuration data|\n|15|Peer encryption keys|\n|19|Peer network configuration data|\n|25|Packet filter configuration|\n|51|4 bytes, unknown|\n|10001|Strings: ‘legspinv2.6’, ‘WILLISCHECKv2.0’, additional configuration data|\n|10207|Configuration data|\n|10404|Configuration data|\n|10405|Configuration data|\n|10505|1 byte; unknown|\n|50009|Configuration data|\n|50013|List of processes (‘snort.exe’, ‘wireshark.exe’, ‘rundll32.exe’, etc.)|\n|50049|Log of GSM base station commands. Very rare, most interesting|\n|50079|Location of a temporary file|\n|50121|Drive names|\n|50139|Event log provider names|\n|50181|Data used by network transport plugins|\n|50185|Plugin configuration|\n|50227|Plugin configuration|\n|50233|Process file name list (Explorer.exe, VMWareService.exe, Update.exe, Msiexec.exe, MailService.exe, etc.)|\n|56001|Plugin configuration|\n|57003|Configuration data|\n\n|0|Data only|\n|---|---|\n|1|Core framework functionality|\n|3|‘3.sys’ file timestamp manipulation; utilities|\n\n\n-----\n\n#### 14\n\n9 Network transport-related utilities\n\n15 RC5 encryption and decryption facilities\n\n25 Network transport using packet filters\n\n27 ICMP network listener using raw sockets\n\n10001 Command-line data collection and administration tools\n\n10105 Utilities\n\n10107 User logon and impersonation, user and domain name collection\n\n10207 ‘pp.dll’ Keylogger and clipboard sniffer\n\n10211 Network share enumeration and manipulation\n\n10309 Pipe/mailslot backend for plugin 10207\n\n10405 Timestamp conversions\n\n10507 Extraction from the protected storage and credential storages\n\n11101 Detection of process hooks, directory enumeration\n\n11701 Collects information about connected USB storage devices, creates storage files\n\n20005 Driver installation/removal routines\n\n20027 Collects information about sessions, installed browsers and proxy settings\n\n20029 Remote registry manipulation routines\n\n20073 Interception of system network drivers\n\n50001 File system data collection and manipulation\n\n50011 File data extraction\n\n50013 Searches for potentially dangerous processes by module path/name (sniffers, debug­\ngers, etc.)\n\n50015 Retrieves current system time in Unix timestamp format\n\n50017 Time-related utilities\n\n50019 Sniffer using a packet filter\n\n50025 System information, network share enumeration and scans\n\n50029 Sniffer utilities\n\n50033 Event log hooks\n\n50035 Winsock-based network transport\n\n50037 Network transport over HTTP\n\n50047 Sniffer utilities\n\n50049 HTTP/SMTP/SMB credentials sniffer\n\n50051 Network transport over HTTPS\n\n50053 Sniffer utilities\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n|9|Network transport-related utilities|\n|---|---|\n|15|RC5 encryption and decryption facilities|\n|25|Network transport using packet filters|\n|27|ICMP network listener using raw sockets|\n|10001|Command-line data collection and administration tools|\n|10105|Utilities|\n|10107|User logon and impersonation, user and domain name collection|\n|10207|‘pp.dll’ Keylogger and clipboard sniffer|\n|10211|Network share enumeration and manipulation|\n|10309|Pipe/mailslot backend for plugin 10207|\n|10405|Timestamp conversions|\n|10507|Extraction from the protected storage and credential storages|\n|11101|Detection of process hooks, directory enumeration|\n|11701|Collects information about connected USB storage devices, creates storage files|\n|20005|Driver installation/removal routines|\n|20027|Collects information about sessions, installed browsers and proxy settings|\n|20029|Remote registry manipulation routines|\n|20073|Interception of system network drivers|\n|50001|File system data collection and manipulation|\n|50011|File data extraction|\n|50013|Searches for potentially dangerous processes by module path/name (sniffers, debug­ gers, etc.)|\n|50015|Retrieves current system time in Unix timestamp format|\n|50017|Time-related utilities|\n|50019|Sniffer using a packet filter|\n|50025|System information, network share enumeration and scans|\n|50029|Sniffer utilities|\n|50033|Event log hooks|\n|50035|Winsock-based network transport|\n|50037|Network transport over HTTP|\n|50047|Sniffer utilities|\n|50049|HTTP/SMTP/SMB credentials sniffer|\n|50051|Network transport over HTTPS|\n|50053|Sniffer utilities|\n\n\n-----\n\n#### 15\n\n50061 Utilities\n\n50063 BPF filter parser\n\n50073 Network routing utilities\n\n50079 Temporary file manipulation\n\n50081 Network transport and configuration utilities\n\n50097 DNS sniffer\n\n50101 Extended system information; task scheduler data\n\n50113 Utilities\n\n50115 NDIS filter\n\n50117 Network information: connections, adapters, DNS cache, statistics\n\n50121 File system traversal\n\n50123 HTTPS server, ‘Microsoft-IIS/6.0’\n\n50139 Windows event log reader\n\n50185 Dumping users’ password hashes (LM database)\n\n50211 Driver hooking and hook detection\n\n50215 ‘BEEP’ driver, used by the 50211 plugin\n\n50219 Injects plugins in processes\n\n50221 ‘disp.dll’ user-mode core of the framework\n\n50223 Module notification routines\n\n50225 API for code injection and kernel-mode hooking\n\n50227 Code injection and hooking utilities\n\n50231 Replication using network shares and local persistence, remote filename used: ‘ADMIN$\\\nSYSTEM32\\SVCSTAT.EXE’\n\n50233 Plugin injection utilities\n\n50251 Keyboard driver hooking\n\n50271 Network transport over SMB (named pipes)\n\n55001 E-mail message extraction module ‘U_STARBUCKS’\n\n55011 MS Exchange data extraction, appointment information\n\n55007 POP3 proxy server, used in conjunction with plugin 55001\n\n56001 Winsock networking routines\n\nThe attackers can dynamically add and delete plugins inside the VFS and each victim installation has a different\nset of plugins depending on the type of activity the attackers need to execute. For example, only some of the\nVFSes we have seen had lateral movement modules, designed for infecting other computers in the network.\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n|50061|Utilities|\n|---|---|\n|50063|BPF filter parser|\n|50073|Network routing utilities|\n|50079|Temporary file manipulation|\n|50081|Network transport and configuration utilities|\n|50097|DNS sniffer|\n|50101|Extended system information; task scheduler data|\n|50113|Utilities|\n|50115|NDIS filter|\n|50117|Network information: connections, adapters, DNS cache, statistics|\n|50121|File system traversal|\n|50123|HTTPS server, ‘Microsoft-IIS/6.0’|\n|50139|Windows event log reader|\n|50185|Dumping users’ password hashes (LM database)|\n|50211|Driver hooking and hook detection|\n|50215|‘BEEP’ driver, used by the 50211 plugin|\n|50219|Injects plugins in processes|\n|50221|‘disp.dll’ user-mode core of the framework|\n|50223|Module notification routines|\n|50225|API for code injection and kernel-mode hooking|\n|50227|Code injection and hooking utilities|\n|50231|Replication using network shares and local persistence, remote filename used: ‘ADMIN$\\ SYSTEM32\\SVCSTAT.EXE’|\n|50233|Plugin injection utilities|\n|50251|Keyboard driver hooking|\n|50271|Network transport over SMB (named pipes)|\n|55001|E-mail message extraction module ‘U_STARBUCKS’|\n|55011|MS Exchange data extraction, appointment information|\n|55007|POP3 proxy server, used in conjunction with plugin 55001|\n|56001|Winsock networking routines|\n\n\n-----\n\n#### 16\n\n### Unusual modules and artifacts\nIn this section we describe some of the most interesting findings about Regin.\n\n#### Artifacts\n\nWith high-end APT groups such as the one behind Regin, mistakes are very rare. Nevertheless, they do happen.\nSome of the VFSes we analyzed contain words that appear to be the respective codenames of the modules\ndeployed on the victim:\n\n  - legspinv2.6 and LEGSPINv2.6\n\n  - WILLISCHECKv2.0\n\n  - HOPSCOTCH\n\nAnother module we found, which is a plugin type 55001.0, references U_STARBUCKS:\n\nFinally, the word ‘shit’ appears in many places throughout the code and modules.\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 17\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 18\n\n GSM targeting\n\nThe most interesting aspect we have found so far regarding Regin relates to an infection of a large GSM operator.\nOne VFS encrypted entry we located had internal id 50049.2, and appears to be an activity log on a GSM Base\nStation Controller.\n\n[From https://en.wikipedia.org/wiki/Base_station_subsystem](https://en.wikipedia.org/wiki/Base_station_subsystem)\n\n[According to the GSM documentation (http://www.telecomabc.com/b/bsc.html): ‘The Base Station Controller](http://www.telecomabc.com/b/bsc.html)\n[(BSC) is in control of and supervises a number of Base Transceiver Stations (BTS). The BSC is responsible for](http://www.telecomabc.com/b/bts.html)\nthe allocation of radio resources to a mobile call and for the handovers that are made between base stations\n[under his control. Other handovers are under the control of the MSC.’](http://www.telecomabc.com/m/msc.html)\n\nHere’s a look at the decoded Regin GSM activity log:\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 19\n\nThis log is about 70KB in size and contains hundreds of entries like the ones above. It also includes timestamps\nthat indicate exactly when the command was executed.\n\nThe entries in the log appear to contain Ericsson OSS MML (Man-Machine Language as defined by ITU-T)\n[commands (see https://en.wikipedia.org/wiki/Operations_support_system).](https://en.wikipedia.org/wiki/Operations_support_system)\n\nHere’s a list of some commands issued on the Base Station Controller, together with some of their timestamps:\n```\n2008-04-25 11:12:14: rxmop:moty=rxotrx;\n2008-04-25 11:58:16: rxmsp:moty=rxotrx;\n2008-04-25 14:37:05: rlcrp:cell=all;\n2008-04-26 04:48:54: rxble:mo=rxocf-170,subord;\n2008-04-26 06:16:22: rxtcp:MOty=RXOtg,cell=kst022a;\n2008-04-26 10:06:03: IOSTP;\n2008-04-27 03:31:57: rlstc:cell=pty013c,state=active;\n2008-04-27 06:07:43: allip:acl=a2;\n2008-04-28 06:27:55: dtstp:DIP=264rbl2;\n2008-05-02 01:46:02: rlstp:cell=all,state=halted;\n2008-05-08 06:12:48: rlmfc:cell=NGR035W,mbcchno=83&512&93&90&514&522,listtype=active;\n2008-05-08 07:33:12: rlnri:cell=NGR058y,cellr=ngr058x;\n2008-05-12 17:28:29: rrtpp:trapool=all.\n\n```\nDescriptions for the commands:\n```\nrxmop - check software version type;\nrxmsp - list current call forwarding settings of the Mobile Station;\nrlcrp - list off call forwarding settings for the Base Station Controller;\nrxble - enable (unblock) call forwarding;\nrxtcp - show the Transceiver Group of particular cell;\nallip - show external alarm;\ndtstp - \u0007show Digital Path (DIP) settings (DIP is the name of the function used\n     for supervision of the connected PCM (Pulse Code Modulation) lines);\nrlstc - activate cell(s) in the GSM network;\n\n```\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 20\n```\nrlstp - stop cell(s) in the GSM network;\nrlmfc - add frequencies to the active broadcast control channel allocation list;\nrlnri - add cell neighbor;\nrrtpp - show radio transmission transcoder pool details.\n\n```\nThe log seems to contain not only the executed commands but also usernames and passwords of some engi­\nneering accounts:\n```\n  sed[snip]:Alla[snip]\n\n  hed[snip]:Bag[snip]\n\n  oss:New[snip]\n\n  administrator:Adm[snip]\n\n```\nIn total, the log indicates that commands were executed on 136 different cells. Some of the cell names include\n‘prn021a, gzn010a, wdk004, kbl027a, etc...’. The command log we obtained covers a period of about one\nmonth, from April 25, 2008 through May 27, 2008. It is unknown why the commands stopped in May 2008\nthough; perhaps the infection was removed or the attackers achieved their objective and moved on. Another\nexplanation is that the attackers improved or changed the malware to stop saving logs locally and that is why\nonly some older logs were discovered.\n\n### Communication and C&C\nThe C&C mechanism implemented in Regin is extremely sophisticated and relies on communication drones\ndeployed by the attackers throughout the victim networks. Most victims communicate with another machine\nin their own internal network through various protocols as specified in the config file. These include HTTP\nand Windows network pipes. The purpose of such a complex infrastructure is to achieve two goals: (i) to give\nattackers access deep into the network, potentially bypassing air gaps; and (ii) to restrict as much as possible\nthe traffic to the C&C.\n\nHere’s a look at the decoded configurations::\n```\n 17.3.40.101 transport 50037 0 0 y.y.y.5:80 ; transport 50051 217.y.y.yt:443\n\n 17.3.40.93 transport 50035 217.x.x.x:443 ; transport 50035 217.x.x.x:443\n\n 50.103.14.80 transport 27 203.199.89.80 ; transport 50035 194.z.z.z:8080\n\n 51.9.1.3 transport 50035 192.168.3.3:445 ; transport 50035 192.168.3.3:9322\n\n 18.159.0.1 transport 50271 DC ; transport 50271 DC\n\n```\nIn the above table we see configurations extracted from several victims that bridge together infected machines\nin what appears to be virtual networks: 17.3.40.x, 50.103.14.x, 51.9.1.x, 18.159.0.x. One of these routes\nreaches out to the ‘external’ C&C server at 203.199.89.80.\n\nThe numbers right after the ‘transport’ indicate the plugin that handles the communication. These are in our case:\n\n  - 27 - ICMP network listener using raw sockets\n\n  - 50035 - Winsock-based network transport\n\n  - 50037 - Network transport over HTTP\n\n  - 50051 - Network transport over HTTPS\n\n  - 50271 - Network transport over SMB (named pipes)\n\nThe machines located on the border of the network act as routers, effectively connecting victims from inside\nthe network with C&Cs on the Internet.\n\nAfter decoding all the configurations we have collected, we were able to identify the following external C&Cs.\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 21\n\nC&C server IP Location Description\n\n61.67.114.73 Taichung, Taiwan Chwbn\n\n202.71.144.113 Chetput, India Chennai Network Operations (team-m.co)\n\n203.199.89.80 Thane, India Internet Service Provider\n\n194.183.237.145 Brussels, Belgium Perceval S.a.\n\nOne particular case includes a country in the Middle East. It was rather astonishing, so we thought it should be\nmentioned. In this country all the victims we identified communicate with each other, forming a peer-to-peer\nnetwork. The P2P network includes the president’s office, a research center, an educational institution\nnetwork and a bank.\n\nSpread across the country, these victims are all interconnected with each other. One of the victims contains a\ntranslation drone, which has the ability to forward packets outside the country, to the C&C in India.\n\nThis represents a rather interesting command-and-control mechanism, which is guaranteed to raise little suspi­\ncion. For instance, if all commands to the president’s office are sent through the bank’s network, then all the\nmalicious traffic visible to the president’s office sysadmins will only be with the bank, in the same country.\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n|C&C server IP|Location|Description|\n|---|---|---|\n|61.67.114.73|Taichung, Taiwan|Chwbn|\n|202.71.144.113|Chetput, India|Chennai Network Operations (team-m.co)|\n|203.199.89.80|Thane, India|Internet Service Provider|\n|194.183.237.145|Brussels, Belgium|Perceval S.a.|\n\n\n-----\n\n#### 22\n\n### Victim statistics\nOver the past two years we have been collecting statistics on the attacks and victims of Regin. These were\naided by the fact that even after the malware is uninstalled, certain artifacts are left behind, which can help\nidentify an infected (but cleaned) system. For instance, we have seen several cases where the systems were\ncleaned but the ‘msrdc64.dat’ infection marker was left behind.\n\nSo far, victims of Regin have been identified in 14 countries:\n\n\n\n- Afghanistan\n\n- Algeria\n\n- Belgium\n\n- Brazil\n\n- Fiji\n\n- Germany\n\n- India\n\n\n\n- Indonesia\n\n- Iran\n\n- Kiribati\n\n- Malaysia\n\n- Pakistan\n\n- Russia\n\n- Syria\n\n\nIn total, we counted 27 different victims, although it should be pointed out that the definition of a victim here\nrefers to a full entity, including its entire network. The number of unique PCs infected with Regin is of course\nmuch, much higher.\n\nFrom the map above, Fiji and Kiribati are unusual, because we rarely see such advanced malware in such\nremote, tiny countries. In particular, the victim in Kiribati is most unusual. To put this into context, Kiribati is a\nsmall island in the Pacific with a population around 100,000. According to experts, Kiribati is probably going to\n[become one of the first victims of global warming, as it will be under water by 2050. (http://www.businessin­](http://www.businessinsider.com/pacific-island-nation-kiribati-sinking-2014-5?op=1)\n[sider.com/pacific-island-nation-kiribati-sinking-2014-5?op=1)](http://www.businessinsider.com/pacific-island-nation-kiribati-sinking-2014-5?op=1)\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 23\n\n### Attribution\nConsidering the complexity and cost of Regin’s development, it is likely that this operation is supported by a nation\nstate. While attribution remains a very difficult problem when it comes to professional attackers such as the ones\nbehind Regin, certain metadata extracted from the samples is still worth a look.\n\nWe have collected timestamps from samples, which are normally put automatically by the development software:\n\nAs this information could be easily altered by the developers, it is up to the reader to attempt to interpret this: as\nan intentional false flag, or a non-critical indicator left by the developers.\n\n[More information about Regin is available to Kaspersky Intelligent Services’ clients. Contact: intelreports@kaspersky.com](mailto:intelreports%40kaspersky.com?subject=)\n\n### Conclusions\nFor more than a decade, a sophisticated group known as Regin has targeted high-profile entities around\nthe world with an advanced malware platform. As far as we can tell, the operation is still active, although\nthe malware may have been upgraded to more sophisticated versions. The most recent sample we have\nseen was from a 64-bit infection. This infection was still active in the spring of 2014.\n\nThe name Regin is apparently a switched around ‘In Reg’, short for ‘In Registry’, as the malware can store its\nmodules in the registry. This name and the detections first appeared in anti-malware products around March\n2011.\n\n[In some ways the platform reminds us of another sophisticated malware: Turla (http://securelist.com/analysis/](http://securelist.com/analysis/publications/65545/the-epic-turla-operation/)\n[publications/65545/the-epic-turla-operation/). Some similarities include the use of virtual file systems and the](http://securelist.com/analysis/publications/65545/the-epic-turla-operation/)\ndeployment of communication drones to bridge networks together. Yet through their implementation, coding\nmethods, plugins, hiding techniques and flexibility, Regin surpasses Turla as one of the most sophisticated\nattack platforms we have ever analyzed.\n\nThe ability of this group to penetrate and monitor GSM networks is perhaps the most unusual and interesting\naspect of these operations. In today’s world, we have become too dependent on cellphone networks that rely on\nancient communication protocols with little or no security available for the end user. Although all GSM networks\nhave mechanisms embedded that allow entities such as law enforcement to track suspects, there are other\nparties which can gain this ability and then abuse it to launch other types of attacks against mobile users.\n\nKaspersky Lab products detect modules from the Regin platform as: Trojan.Win32.Regin.gen and Rootkit.Win32.Regin.\n\n[If you detect a Regin infection in your network, contact us at: intelservices@kaspersky.com](mailto:intelservices%40kaspersky.com?subject=)\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 24\n\n### Technical appendix and indicators of compromise:\n\n#### Yara rules:\n```\n rule apt_regin_vfs {\n meta:\n   copyright = “Kaspersky Lab”\n   description = “Rule to detect Regin VFSes”\n   version = “1.0”\n\n```\nlast_modified = “2014-11-24”\n```\n strings:\n   $a1={00 02 00 08 00 08 03 F6 D7 F3 52}\n   $a2={00 10 F0 FF F0 FF 11 C7 7F E8 52}\n   $a3={00 04 00 10 00 10 03 C2 D3 1C 93}\n   $a4={00 04 00 10 C8 00 04 C8 93 06 D8}\n condition:\n   ($a1 at 0) or ($a2 at 0) or ($a3 at 0) or ($a4 at 0)\n }\n rule apt_regin_dispatcher_disp_dll {\n meta:\n   copyright = “Kaspersky Lab”\n   description = “Rule to detect Regin disp.dll dispatcher”\n   version = “1.0”\n\n```\nlast_modified = “2014-11-24”\n```\n strings:\n   $mz=”MZ”\n   $string1=”shit”\n   $string2=”disp.dll”\n   $string3=”255.255.255.255”\n   $string4=”StackWalk64”\n   $string5=”imagehlp.dll”\n condition:\n   ($mz at 0) and (all of ($string*))\n }\n rule apt_regin_2013_64bit_stage1 {\n meta:\n   copyright = “Kaspersky Lab”\n   description = “Rule to detect Regin 64 bit stage 1 loaders”\n   version = “1.0”\n\n```\nlast_modified = “2014-11-24”\nfilename=”wshnetc.dll”\n```\n   md5=”bddf5afbea2d0eed77f2ad4e9a4f044d”\n\n```\nfilename=”wsharp.dll”\n```\n   md5=”c053a0a3f1edcbbfc9b51bc640e808ce”\n strings:\n   $mz=”MZ”\n     $a1=”PRIVHEAD”\n     $a2=”\\\\\\\\.\\\\PhysicalDrive%d”\n     $a3=”ZwDeviceIoControlFile”\n condition:\n\n```\n($mz at 0) and (all of ($a*)) and filesize < 100000\n```\n }\n\n```\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 25\n```\n rule apt_regin_2011_32bit_stage1 {\n meta:\n   copyright = “Kaspersky Lab”\n   description = “Rule to detect Regin 32 bit stage 1 loaders”\n   version = “1.0”\n\n```\nlast_modified = “2014-11-24”\n```\n strings:\n   $key1={331015EA261D38A7}\n   $key2={9145A98BA37617DE}\n   $key3={EF745F23AA67243D}\n   $mz=”MZ”\n condition:\n\n```\n($mz at 0) and any of ($key*) and filesize < 300000\n```\n }\n rule apt_regin_rc5key {\n meta:\n   copyright = “Kaspersky Lab”\n   description = “Rule to detect Regin RC5 decryption keys”\n   version = “1.0”\n\n```\nlast_modified = “2014-11-24”\n```\n strings:\n   $key1={73 23 1F 43 93 E1 9F 2F 99 0C 17 81 5C FF B4 01}\n   $key2={10 19 53 2A 11 ED A3 74 3F C3 72 3F 9D 94 3D 78}\n condition:\n any of ($key*)\n\n```\n}\n\n#### MD5s:\n\nStage 1 files, 32 bit:\n\n06665b96e293b23acc80451abb413e50\n187044596bc1328efa0ed636d8aa4a5c\n1c024e599ac055312a4ab75b3950040a\n2c8b9d2885543d7ade3cae98225e263b\n4b6b86c7fec1c574706cecedf44abded\n6662c390b2bbbd291ec7987388fc75d7\nb269894f434657db2b15949641a67532\nb29ca4f22ae7b7b25f79c1d4a421139d\nb505d65721bb2453d5039a389113b566\n26297dc3cd0b688de3b846983c5385e5\nba7bb65634ce1e30c1e5415be3d1db1d\nbfbe8c3ee78750c3a520480700e440f8\nd240f06e98c8d3e647cbf4d442d79475\nffb0b9b5b610191051a7bdf0806e1e47\n\nUnusual stage 1 files apparently compiled from various public source codes merged with malicious code:\n\n01c2f321b6bfdb9473c079b0797567ba\n47d0e8f9d7a6429920329207a32ecc2e\n744c07e886497f7b68f6f7fe57b7ab54\ndb405ad775ac887a337b02ea8b07fddc\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### 26\n\nStage 1, 64-bit system infection:\n\nbddf5afbea2d0eed77f2ad4e9a4f044d\nc053a0a3f1edcbbfc9b51bc640e808ce\ne63422e458afdfe111bd0b87c1e9772c\n\nStage 2, 32 bit:\n\n18d4898d82fcb290dfed2a9f70d66833\nb9e4f9d32ce59e7c4daf6b237c330e25\n\nStage 2, 64 bit:\n\nd446b1ed24dad48311f287f3c65aeb80\n\nStage 3, 32 bit:\n\n8486ec3112e322f9f468bdea3005d7b5\nda03648948475b2d0e3e2345d7a9bbbb\n\nStage 4 32 bit:\n\n1e4076caa08e41a5befc52efd74819ea\n68297fde98e9c0c29cecc0ebf38bde95\n6cf5dc32e1f6959e7354e85101ec219a\n885dcd517faf9fac655b8da66315462d\na1d727340158ec0af81a845abd3963c1\n\nStage 4 64 bit:\n\nde3547375fbf5f4cb4b14d53f413c503\n\nNote: Stages 2,3 and 4 do not appear on infected systems as real files on disk. Hashes are provided for\nresearch purposes only.\n\n##### Registry branches used to store malware stages 2 and 3:\n\n  - \\REGISTRY\\Machine\\System\\CurrentControlSet\\Control\\RestoreList\n\n  - \\REGISTRY\\Machine\\System\\CurrentControlSet\\Control\\Class\\{39399744-44FC-AD65-474B-E4DDF­\n\n8C7FB97}\n\n  - \\REGISTRY\\Machine\\System\\CurrentControlSet\\Control\\Class\\{3F90B1B4-58E2-251E-6FFE\n4D38C5631A04}\n\n  - \\REGISTRY\\Machine\\System\\CurrentControlSet\\Control\\Class\\{4F20E605-9452-4787-B793\nD0204917CA58}\n\n  - \\REGISTRY\\Machine\\System\\CurrentControlSet\\Control\\Class\\{9B9A8ADB-8864-4BC4-8AD5\nB17DFDBB9F58}\n\n#### C&C IPs:\n```\n 61.67.114.73 Taiwan, Province Of China Taichung Chwbn\n 202.71.144.113 India Chetput Chennai Network Operations (team-m.co)\n 203.199.89.80 India Thane Internet Service Provider\n 194.183.237.145 Belgium Brussels Perceval S.a.\n\n```\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n|C&C IPs:|Col2|\n|---|---|\n|61.67.114.73|Taiwan, Province Of China Taichung Chwbn|\n|202.71.144.113|India Chetput Chennai Network Operations (team-m.co)|\n|203.199.89.80|India Thane Internet Service Provider|\n|194.183.237.145|Belgium Brussels Perceval S.a.|\n\n\n-----\n\n#### 27\n\n VFS RC5 decryption algorithm\n\nThis algorithm is used throughout the code and is referenced as RC5 in the document, although the implemen­\ntation and the way the cipher is invoked is specific to Regin.\n\nThe implementation in C++ follows:\n```\n void RC5Decrypt(uint8_t* rc5Key, uint8_t* data, size_t len)\n {\n       uint8_t  iv[8];\n       rc5_ctx_t  ctx;\n       uint8_t*  encrypted;\n       size_t  encryptedLen;\n       rc5_init(rc5Key, 128, 20, &ctx);\n       memcpy(iv, data, 8);\n       encrypted = data + 8;\n       encryptedLen = len - 8;\n       if ( encryptedLen % 8 )\n       {\n         uint8_t  ivLocal[8];\n\n```\nif ( encryptedLen < 8)\n```\n          memcpy(ivLocal, iv, 8);\n         else\n          memcpy(ivLocal, encrypted + encryptedLen - (encryptedLen % 8) - 8, 8);\n         rc5_enc(ivLocal, &ctx);\n\n```\nfor (size_t idx = 0; idx < (encryptedLen % 8); idx++)\n```\n          encrypted[idx + encryptedLen - (encryptedLen % 8)] ^= ivLocal[idx];\n       }\n       if ( encryptedLen / 8 > 1 )\n       {\n         for (ssize_t blockIdx = (encryptedLen / 8) - 1; blockIdx > 0; blockIdx--)\n         {\n         rc5_dec(encrypted + blockIdx*8, &ctx);\n\n```\nfor (size_t idx = 0; idx < 8; idx++)\n```\n         encrypted[blockIdx*8 + idx] ^= encrypted[(blockIdx-1)*8 + idx];\n         }\n       }\n       if ( encryptedLen / 8 > 0 )\n       {\n       rc5_dec(encrypted, &ctx);\n\n```\nfor (size_t idx = 0; idx < 8; idx++)\n```\n       encrypted[idx] ^= iv[idx];\n       }\n\n```\n}\n\nTLP: GREEN Contact: intelreports@kaspersky.com\n\n\n-----\n\n#### Kaspersky Lab HQ\n\n39A/3 Leningradskoe Shosse\nMoscow, 125212\nRussian Federation\n\n[more contact details](http://www.kaspersky.com/about/contactinfo/contacts_global_hq)\n\nTel: +7-495-797-8700\nFax: \u0007+7-495-797-8709\n\n[E-mail: info@kaspersky com](mailto:info%40kaspersky.com?subject=)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/q23ruuvmn5mgq1dc0w3kggl6ek1pn4nz",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2014/2014.11.24.Regin_Platform/Kaspersky_Lab_whitepaper_Regin_platform_eng.pdf"
    ],
    "report_names": [
        "Kaspersky_Lab_whitepaper_Regin_platform_eng"
    ],
    "threat_actors": [
        {
            "id": "67bf0462-41a3-4da5-b876-187e9ef7c375",
            "created_at": "2022-10-25T16:07:23.44832Z",
            "updated_at": "2025-03-27T02:02:09.806007Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "Careto",
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "ETDA:Careto",
            "tools": [
                "Careto"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f5bf6853-3f6e-452c-a7b7-8f81c9a27476",
            "created_at": "2023-01-06T13:46:38.677391Z",
            "updated_at": "2025-03-27T02:00:02.889755Z",
            "deleted_at": null,
            "main_name": "Careto",
            "aliases": [
                "The Mask",
                "Ugly Face"
            ],
            "source_name": "MISPGALAXY:Careto",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e09a7338-fb16-4e39-b579-c3bfc3140c47",
            "created_at": "2022-10-25T16:07:24.207294Z",
            "updated_at": "2025-03-27T02:02:10.140203Z",
            "deleted_at": null,
            "main_name": "Snowglobe",
            "aliases": [
                "ATK 8",
                "Animal Farm",
                "SIG20",
                "Snowglobe"
            ],
            "source_name": "ETDA:Snowglobe",
            "tools": [
                "Babar",
                "Casper",
                "Chocopop",
                "Dino",
                "EvilBunny",
                "Nbot",
                "TFC",
                "Tafacalou"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "9a58d7bb-dd32-41bc-804e-500ef7550cf8",
            "created_at": "2023-01-06T13:46:39.131811Z",
            "updated_at": "2025-03-27T02:00:03.004067Z",
            "deleted_at": null,
            "main_name": "ItaDuke",
            "aliases": [
                "DarkUniverse",
                "SIG27"
            ],
            "source_name": "MISPGALAXY:ItaDuke",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "548a4081-aa8f-4e2a-bcb3-0c9dfa61944f",
            "created_at": "2023-01-06T13:46:38.443779Z",
            "updated_at": "2025-03-27T02:00:02.835042Z",
            "deleted_at": null,
            "main_name": "SNOWGLOBE",
            "aliases": [
                "Snowglobe",
                "ATK8",
                "Animal Farm"
            ],
            "source_name": "MISPGALAXY:SNOWGLOBE",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716499,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1416842787,
    "ts_modification_date": 1416842923,
    "files": {
        "pdf": "https://archive.orkl.eu/5bbf6a633076473dc4b2afb6d166c8caa84463e4.pdf",
        "text": "https://archive.orkl.eu/5bbf6a633076473dc4b2afb6d166c8caa84463e4.txt",
        "img": "https://archive.orkl.eu/5bbf6a633076473dc4b2afb6d166c8caa84463e4.jpg"
    }
}