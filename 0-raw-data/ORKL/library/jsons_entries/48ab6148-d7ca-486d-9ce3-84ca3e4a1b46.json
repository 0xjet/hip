{
    "id": "48ab6148-d7ca-486d-9ce3-84ca3e4a1b46",
    "created_at": "2023-01-12T15:07:18.861993Z",
    "updated_at": "2025-03-27T02:09:30.137242Z",
    "deleted_at": null,
    "sha1_hash": "8b8790f02e8379e12851e8f05ae2df2cce123b01",
    "title": "2019-07-15 - Threat Spotlight- Virlock Polymorphic Ransomware",
    "authors": "",
    "file_creation_date": "2022-11-28T19:07:00Z",
    "file_modification_date": "2022-11-28T19:07:00Z",
    "file_size": 2510322,
    "plain_text": "# Threat Spotlight: Virlock Polymorphic Ransomware\n\n**[blogs.blackberry.com/en/2019/07/threat-spotlight-virlock-polymorphic-ransomware](https://blogs.blackberry.com/en/2019/07/threat-spotlight-virlock-polymorphic-ransomware)**\n\nThe BlackBerry Cylance Threat Research Team\n\n[RESEARCH & INTELLIGENCE / 07.15.19 /](https://blogs.blackberry.com/en/category/research-and-intelligence) The BlackBerry Cylance Threat Research\nTeam\n\nVirlock is a polymorphic, file-infecting ransomware first discovered in 2014. In 2016 it\ndemonstrated new capabilities allowing it to spread through shared applications and cloud\nstorage. When executed, it drops three instances of itself. One instance carries out the file\ninfection, another locks the machine, and the third creates a persistence mechanism by\nregistering as a service. Attackers demand bitcoin payment from victims who want their\nsystems unlocked.\n\nThe polymorphic nature of Virlock means every instance is different from a heuristic\nperspective, a tactic that effectively bypasses signature-based antivirus (AV) solutions. For\nexample, Virlock drops three instances of itself during the first stage of its attack, each one\nimplementing different obfuscation and persistence mechanisms. By varying the\nfunctionality that each instance implements, Virlock guarantees all three instances can\nevade a signature-based detection system.\n\n## Technical Analysis\n\nVirlock decrypts and runs the original lure file when executing the first time on a noninfected machine. When executing on a previously infected machine it checks to see if a\nransom has been paid. On successfully ransomed machines Virlock will decrypt the host file\nbut take no further malicious actions. If a machine has not been successfully ransomed\nVirlock executes a malicious behavior (Figure 1) without decrypting the host file.\n\n\n-----\n\n_Figure 1: Execution flow_\n\nThe malicious file was heavily obfuscated and included anti-debugging techniques that\ncomplicated analysis. During our investigation we observed the decoding and launch of the\nsecond stage payload:\n\n\n-----\n\n_Figure 2: Jump to decode_run_second_stage_\n\nThe decryption routine uses an incremental xor loop to decrypt the second stage. It checks\nto verify that the file has been fully decrypted, then calls the second stage:\n\n_Figure 3: Decryption loop and call to second stage_\n\nNext, the second stage decrypts the data representing the instructions to be executed, in a\nvirtualized way, by the third stage stub function. Once decrypted, the instructions bytes are\ninjected into the “execute_opcode” function between RVA 0x1032 and 0x103B as shown in\nFigure 4.\n\n\n-----\n\n_Figure 4: “inc edx” followed by a sequence of NOPs injected into the stub function_\n\n## Payload Execution\n\nThe ransomware drops three instances of itself in three different locations upon execution:\n\n### Instance one:\n\nFile path: %AllUsersProfile%\\<Random_folder_name>\\<Random_file_ name>.exe\n\n_Figure 5: First instance dropped by original file_\n\n\n-----\n\n### Instance two:\n\nFile path: %UserProfile%\\<Random_folder_name>\\<Random_file_name>.exe\n\n_Figure 6: Second instance dropped by original file_\n\n### Instance three:\n\nFile path: %AllUsersProfile%\\<Random_folder_name>\\<Random_file_ name>.exe\n\n_Figure 7: Third instance dropped by original file_\n\n## Persistence\n\nVirlock modifies the system registry to create persistence on an infected system. It sets two\nregistry values of two randomly named instances of itself in the “CurrentVersion\\Run”\nregistry key. These settings cause the programs to run each time a user logs on:\n\n_Figure 8: Persistence via Run Registry Key modifications_\n\nVirlock modifies a registry key that specifies which program WinLogon executes when a\nuser logs on:\n\n\n-----\n\n_Figure 9: Persistence via Userinit Registry Value modification_\n\nVirlock’s registry key modification:\n\n_Figure 10: Registry modification for persistence_\n\nThe third instance sets a value for a randomly named service:\n\n_Figure 11: Persistence via new service registration_\n\n## File Infection\n\nAfter dropping three instances of itself, Virlock checks for specific file types to infect. Once\nthe targeted file have been identified, the malware encrypts the file and then replaces it with\na copy of the virus code with the encrypted original file content appended to it.\n\n**Targeted File Types:**\n\n.exe .doc .xls .pdf .ppt .mdb\n\n.zip .rar .mp3 .mpg .wma .png\n\n.gif .bmp .jpg .jpeg .psd .p12\n\n.cer .crt .p7b .pfx .pem\n\nVirlock appends an .exe file extension to all infected files, then modifies the registry to hide\nthe file extensions. This is done to trick the user into executing the infected host file:\n\n_Figure 12: File extension registry change_\n\n\n-----\n\nHere is an example of the Notepad++ executable before and after infection:\n\n_Figure 13: Before and after infection_\n\n## Locked Screen\n\nWhile Virlock is running and executing its file infection routine, its second instance locks the\nscreen of the victim’s machine. During this process Virlock also shuts down the process\nexplorer.exe and task manager. It checks the geolocation of the device by searching the\nregistry and displays a message tailored to the victim’s location. The screen-lock message\nasks victims to pay a ransom in bitcoin:\n\n_Figure 14: Checks registry geolocation of the machine_\n\n\n-----\n\n_Figure 15: Lock screen message_\n\n## Why Virlock is Important and Why You Should be Concerned\n\nVirlock was first detected in 2014 but made resurgent appearances in 2016 and 2017. With\neach reappearance Virlock demonstrated new capabilities, indicating that the malware is\nactively developed and updated by cyber criminals. Virlock deploys an impressive tripleinstance attack strategy and a location-specific ransom screen threatening users with fake\nlegal action should they refuse to comply. With ransomware attacks costing organizations\n[roughly $13,000 USD per incident, Virlock is a threat that businesses cannot afford to](https://www.zdnet.com/article/ransomware-the-cost-of-rescuing-your-files-is-going-up-as-attackers-get-more-sophisticated/)\nignore.\n\n## BlackBerry Cylance Stops Virlock\n\nBlackBerry Cylance uses artificial intelligence (AI)-based agents trained for threat detection\non millions of both safe and unsafe files. This lets BlackBerry Cylance spot a threat based\non countless file attributes instead of a specific file signature. Virlock is a polymorphic\nthreat, capable of modifying its code, but this evasive tactic does not fool our AI-driven\nsecurity agents. Our solutions analyze and convict threats based upon millions of threat\n\n\n-----\n\nfeatures, not specific file signatures. Blackberry Cylance, which offers a predictive\nadvantage over zero-day threats, is trained on and effective against both new and legacy\ncyber threatsattacks.\n\n_(EDITOR'S NOTE: This blog was updated on 8/5/2019 to add in extra detail from an_\n_extended technical analysis performed by our Threat Research team)._\n\n## About The BlackBerry Cylance Threat Research Team\n\nThe BlackBerry Cylance Threat Research team examines malware and suspected malware\nto better identify its abilities, function and attack vectors. Threat Research is on the frontline\nof information security and often deeply examines malicious software, which puts us in a\nunique position to discuss never-seen-before threats.\n\nBack\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-07-15 - Threat Spotlight- Virlock Polymorphic Ransomware.pdf"
    ],
    "report_names": [
        "2019-07-15 - Threat Spotlight- Virlock Polymorphic Ransomware.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "873919c0-bc6a-4c19-b18d-c107e4aa3d20",
            "created_at": "2023-01-06T13:46:39.138138Z",
            "updated_at": "2025-03-27T02:00:03.005534Z",
            "deleted_at": null,
            "main_name": "Higaisa",
            "aliases": [],
            "source_name": "MISPGALAXY:Higaisa",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "30c9c492-afc6-4aa1-8fe6-cecffed946e0",
            "created_at": "2022-10-25T15:50:23.400822Z",
            "updated_at": "2025-03-27T02:00:55.461334Z",
            "deleted_at": null,
            "main_name": "Higaisa",
            "aliases": [
                "Higaisa"
            ],
            "source_name": "MITRE:Higaisa",
            "tools": [
                "PlugX",
                "certutil",
                "gh0st RAT"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536038,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1669662420,
    "ts_modification_date": 1669662420,
    "files": {
        "pdf": "https://archive.orkl.eu/8b8790f02e8379e12851e8f05ae2df2cce123b01.pdf",
        "text": "https://archive.orkl.eu/8b8790f02e8379e12851e8f05ae2df2cce123b01.txt",
        "img": "https://archive.orkl.eu/8b8790f02e8379e12851e8f05ae2df2cce123b01.jpg"
    }
}