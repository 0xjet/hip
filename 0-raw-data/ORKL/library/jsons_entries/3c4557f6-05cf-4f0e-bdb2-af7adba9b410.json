{
    "id": "3c4557f6-05cf-4f0e-bdb2-af7adba9b410",
    "created_at": "2023-01-12T14:59:27.668525Z",
    "updated_at": "2025-03-27T02:05:44.313568Z",
    "deleted_at": null,
    "sha1_hash": "73ef00f9bb47fe8eef9c28736fd86c0e65817a18",
    "title": "2015-07-02 - Win32-Lethic Botnet Analysis",
    "authors": "",
    "file_creation_date": "2022-05-29T01:12:09Z",
    "file_modification_date": "2022-05-29T01:12:09Z",
    "file_size": 594532,
    "plain_text": "# Win32/Lethic Botnet Analysis\n\n**[resources.infosecinstitute.com/win32lethic-botnet-analysis/](http://resources.infosecinstitute.com/win32lethic-botnet-analysis/)**\n\n## Introduction\n\nLethic is a spam botnet consisting of an estimated 210 000 – 310 000 individual machines\nwhich are mainly involved in pharmaceutical and replica spam. At the peak of its existence,\nthe botnet was responsible for 8-10% of all the spam sent worldwide.\n\nAround early January 2010, the botnet was dismantled by Neustar employees, who\ncontacted various Lethic internet service providers in a bid to take control of the botnet’s\ncommand and control servers. This move temporarily caused the botnets’ spam to decrease\nto a trickle of its original volume.\n\nIn February 2010, the owners of the botnet managed to re-establish control over the botnet,\nusing new command and control servers located in the United States. The takedown has\ndecreased the spam volume of the botnet, however. As of February 2010, the botnets’\namount of spam was down to a third of its original. As of April 2010, the botnet has an\nestimated 1.5% share of the spam market, sending about 2 billion spam messages a day.\n\n\n-----\n\nThis article presents a view on the malware and its capabilities, how it communicates with\nthe CnC, encryption scheme used as well as different protection mechanisms to make the\nmalware analyst job harder.\n\n## Tools\n\nOllyDBG / IDA Pro.\nLethic sample (MD5 = 23DE74A6122A8AB3B02EFD3B2C481978, password =\ninfected)\nLethic Unpacked ( password = infected)\n\n## Infection vector\n\nThis botnet arrives as attachments to spammed messages disguised as notifications from\nfamiliar contacts.\n\n## Bot analysis\n\nI will not talk about the unpacking process because there is no relevant information regarding\nit. The original Lethic build file is about 17 kb. Not the smallest botnet ever seen, Tinba or\nGamarue have lower size but it is a low profile botnet with many infections that may be the\nsecret of its longevity.\n\nLet’s go, fire up OllyDBG. OK, you are at the entry point of the malware. Looking at the data\nsection, you could see some interesting strings like APIs names to be resolved, modules that\nare going to be loaded, also CnC IP address, etc… Just by looking at this dump, you could\nbasically get a whole image about the inner working of this bot.\n\n\n-----\n\nThe first thing, it will try to resolve API dynamically using LoadLibrary and GetProcAddress.\nPut a BP at the RET instruction to see the whole import table filled with the functions\npointers:\n\n1. Following it creates a directory in the APPDATA directory under the name of:\n\n**“C:Documents and SettingsAdministratorApplication DataWindowsUpdate”**\n\nThen, it makes a copy of the file under the name of “MSupdate.exe” in this directory and\ndeletes the original file.\n\n1. Following, to autostart with windows, it creates two registry keys at:\n\n**“HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindows NTCurrentVersionWinlogon”**\nunder the name “Taskman” which points to the executable file specified above.\n\n1. And, another key under the name of “Windows Update Manager” in:\n\n\n-----\n\n**HKEY_LOCAL_USERSoftwareMicrosoftWindowsCurrentVersionRun**\n\n1. Additionally, it modifies the “shell” registry entry located at:\n\n**“HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindows NTCurrentVersionWinlogon”**\nwith the value:\n\n**explorer.exe,C:Documents and SettingsAdministratorApplication**\n**DataWindowsUpdateMSupdate.exe**\n\nNext, it checks whether the operating system is a 32-bit or 64-bit environment by calling\nIsWoW64Process. For my case, I am running a Windows XP 32bits; this is generally done\nbefore performing code injection.\n\n## Process Injection\n\nThe code injection method used in Lethic is VirtualAllocEx/WriteProcessMemory\n/CreateRemoteThread in explorer.exe process. To follow debugging at explorer.exe process,\nyou could either replace the first byte of the buffer with 0xCC and make OllyDBG a JIT\ndebugger, and when you step through CreateRemoteThread, a new instance of OllyDBG will\nfire up and will attach to your process, then you can restore back the first byte to its original\nstate. On the other hand, you could look at the start address parameter in\nCreateRemoteThread, start a new instance of OllyDBG, and put a BP on it.\n\nOnce you are done from this step, Lethic creates a new mutex name “VAmazinsdvd010201”\nto prevent duplicate process from running in the same machine. Next, it loads some libraries\nin explorer memory space and right after that; it starts preparing communication with the\nC&C using Winsock APIs.\n\n## C&C Communication\n\nAfter it successfully receives data from the CnC, depending on the value of the command.\n\nLet’s list and explain what the different commands sent by the C&C can be, and what they\ndo:\n\nAdd Server (0x01): the data includes a public mail server IP address and a port. Lethic\nthen creates a socket and connects to the said mail server. Upon success, it initializes\na new MailServerRecord with ID, the given IP and port, socket, and then inserts the\nrecord in cc_hdr->Chain. Now that the record has been added to the chain, should any\nof the following operations on the record fail, Lethic will inform the C&C server; and the\nlatter will then send a “Remove Server” command to remove the faulty record.\n\nRemove Server (0x02): removes record corresponding to ID from the mail server\nrecord chain.\n\n\n-----\n\nSend Mail (0x03): sends the buffer data to a mail server, via the MailServerRecord\npointed to by ID. The result is sent back to the C&C server, which in turns decides\nwhether it should set the RecvFeedBack flag or not.\n\nClean (0x04, 0x05): do some cleaning work, such as freeing the whole\nMailServerRecords chain, deleting the malware installer, and exit.\n\nReserved (0x06), no further operation except for sending the received data back.\n\nAdd Server By Name (0x11), the same as Add Server, the only difference is that a\nhostname is given instead of an IP address.\nReceive FeedBack (0x13), a flag that is used to set MailServerRecord.bfbFlag.\n\nIf the received buffer doesn’t include any of the aforementioned commands, Lethic checks\neach record of the chain. If the bfbFlag is set to TRUE, that means the Send Mail operation\nwas successful, and feedback was received from the mail server. It thus initializes\nFEEDBACK with the record ID, command, feedback data, and size, and sends it all to the\nC&C server.\n\nIn all aspects, the Zombie acts as a slightly improved mail relay; it forwards received data\nfrom the C&C server to mail servers chosen in a managed list. That is not very efficient, in\nterms of bandwidth consumption, as compared to the traditional template-based approach:\nIndeed here, the C&C server has to send almost as much data as is sent by each Zombie.\nLogically, it seems to indicate that Lethic botnets all need to be small to operate smoothly.\n\nFigure 4 shows an example of the spam content.\n\n\n-----\n\n## Conclusions\n\nLethic is yet another spambot to join the fray. It is unclear what its future holds, and we do\nnot know when it emerged. However this shows how “full” the “ecosystem” for spambots is.\nLethic’s complexity is minimal when compared to other spam botnets (no rootkit seen, etc)\nbut it appears effective enough at this time.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-07-02 - Win32-Lethic Botnet Analysis.pdf"
    ],
    "report_names": [
        "2015-07-02 - Win32-Lethic Botnet Analysis.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535567,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653786729,
    "ts_modification_date": 1653786729,
    "files": {
        "pdf": "https://archive.orkl.eu/73ef00f9bb47fe8eef9c28736fd86c0e65817a18.pdf",
        "text": "https://archive.orkl.eu/73ef00f9bb47fe8eef9c28736fd86c0e65817a18.txt",
        "img": "https://archive.orkl.eu/73ef00f9bb47fe8eef9c28736fd86c0e65817a18.jpg"
    }
}