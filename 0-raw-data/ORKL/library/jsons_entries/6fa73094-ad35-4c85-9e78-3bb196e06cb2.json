{
    "id": "6fa73094-ad35-4c85-9e78-3bb196e06cb2",
    "created_at": "2023-01-12T15:00:09.119131Z",
    "updated_at": "2025-03-27T02:16:08.468292Z",
    "deleted_at": null,
    "sha1_hash": "f11e0e375bf213b6ad95c644e89fa769870add2a",
    "title": "2018-03-02 - Spear-phishing campaign leveraging on MSXSL",
    "authors": "",
    "file_creation_date": "2022-05-28T17:57:15Z",
    "file_modification_date": "2022-05-28T17:57:15Z",
    "file_size": 718521,
    "plain_text": "# Spear-phishing campaign leveraging on MSXSL\n\n**[reaqta.com/2018/03/spear-phishing-campaign-leveraging-msxsl/](https://reaqta.com/2018/03/spear-phishing-campaign-leveraging-msxsl/)**\n\nWe have identified an ongoing spear-phishing campaign targeting a variety of entities with malicious\nRTF documents exploiting three different vulnerabilities: CVE-2017-8570, CVE-2017-11882\nand CVE-2018-0802 and taking advantage of a misplaced trust binary, Microsoft’s msxsl, to run\na JScript backdoor. The whole attack chain leverages on system’s signed components to remain\nunder the radar as much as possible and it shares many similarities with previous campaigns from\nthe Cobalt Group.\n\n## Attack Vector\n\nThe spear-phishing campaign makes use of a malicious RTF document:\n\nthat in turn opens a decoy document if the exploitation of one of the targeted vulnerabilities is\nsuccessful:\n\n\n-----\n\nDecoy\n\nDocument\n\nA quick look at the OLE objects found in the document shows some interesting properties that we\nwill analyze in the next section.\n\n\n-----\n\nWhat happens after opening the document is slightly convoluted and can be summarized in:\n\n1. The malicious RTF exploit on of three vulnerabilities (CVE-2017-8570, CVE-2017-11882 or\n\nCVE-2018-0802)\n2. eqnedt32.exe (Microsoft Equation Editor) is ran and two instances of cmd.exe are executed in\n\na chain\n3. The last cmd.exe instance starts regsrv32.exe with a DLL (dll.txt) then a decoy document is\n\ndropped\n4. The loaded DLL performs the following actions:\n\n1. Creates a XML file\n2. Creates a XSL file\n3. Delete itself from disk\n4. Create a JScript file (for persistence)\n5. Drops a legitimate MSXSL.exe copy\n\n1. MSXSL runs the final backdoor taken from the newly created XML and XSL files\n\n\n-----\n\nAttack\n\n\nLife Cycle\n\n## First Stage\n\nAfter the vulnerability has been exploited, cmd.exe runs Task.bat:\n```\nECHO OFF\nset tp=\"%temp%\\block.txt\"\nIF EXIST %tp% (exit) ELSE (set tp=\"%temp%\\block.txt\" & copy NUL %tp% & start /b\n%temp%\\2nd.bat)\ndel \"%~f0\"\nexit\n\n```\n\n-----\n\nAfter the environment variable is set, a second batch file is launched whose task is to launch\n**regsrv32.exe to load dll.txt, to cleanup the temp directory and restart winword showing the decoy**\ndocument.\n\nDLL\n\nloading\n\nThe main task of setting up the correct environment for the backdoor to run and remain persistent is\nleft to dll.txt that performs the following operations:\n\nCreate c:\\users\\user\\appdata\\roaming\\microsoft\\f4b3a452b6ea052d286.txt\nCreate c:\\users\\user\\appdata\\roaming\\microsoft\\7009b05a8c4dc1b.txt\nCreate c:\\users\\user\\appdata\\roaming\\microsoft\\12a0c3af5a631493445f1d42.js\nDrop c:\\users\\user\\appdata\\roaming\\microsoft\\msxsl.exe executable, a Microsoft\nlegitimate executable\nCreate a registry key value in HKCU\\Environment with value `UserInitMprLogonScript` and\ndata `Cmd.Exe /C “%Appdata%\\Microsoft\\12A0C3AF5A631493445F1D42.Js”` (logon\npersistence script. ATT&CK TID: [T1037)](https://attack.mitre.org/wiki/Technique/T1037)\n\n\n-----\n\nDLL Activity\n\n\nDLL’s\n\nFilesystem and Registry Activity\n\nImmediately after an instance of cmd.exe is spawned to remove the dll.txt and msxsl.exe is\nlaunched, taking as argument the dropped XML file and the XSL file (containing the backdoor’s\ncode).\n\n\n-----\n\nremoval\n\nScript Persistence\n\n\nDLL\n\nLogon\n\n\nIt’s notable the use of msxsl.exe which is the real commandline utility used to perform Extensible\nStylesheet Language (XSL) transformations using Microsoft’s XSL processor. This executable can\nbe [abused to run JScript code:](https://twitter.com/subTee/status/877616321747271680)\n```\nC:\\Users\\User\\AppData\\Roaming\\Microsoft\\msxsl.exe\n\"C:\\Users\\User\\AppData\\Roaming\\Microsoft\\F4B3A452B6EA052D286.txt\"\n\"C:\\Users\\User\\AppData\\Roaming\\Microsoft\\7009B05A8C4DC1B.txt\"\n\n## Backdoor\n\n```\nThe backdoor is written in JScript and it’s capable of performing the following operations:\n\nreconnaissance via wmi and other windows tools\nrun executables using cmd.exe\nload dll files using regsvr32.exe\ndownload and run new scripts\nremove itself\ncheck for AntiVirus software\nc2 communication using a js implementation of RC4\n\n\n-----\n\nBackdoor deobfuscated\n\nAny kind of script can be run by the backdoor so its capabilities are potentially unlimited. Different\nantivirus software are checked, this is apparently not done to prevent the backdoor from running,\ninstead the information is sent back to the C2 possibly to provide the operators with knowledge\nabout their victims before deploying more sophisticated scripts that might raise alarms.\n\nThe C2 address we found in this campaign\nis: https://mail[.]hotmail[.]org[.]kz/owalanding/ajax[.]php which appears to be a hostname\nregistered in Kazakhstan registered back in 1994 so most likely it was compromised by the\nattackers and used as C2.\n\n\n-----\n\n[The second stage of the attack chain appears to be the same of a campaign identified back in](https://twitter.com/mesa_matt/status/933245895323279362)\nNovember and possibly attributed to Cobalt Group, the first stage of the attack is instead completely\n[different, pointing to what it might be a new exploit kit (Threadkit?). The backdoor’s code appears to](https://twitter.com/mesa_matt/status/967064325448970242)\nbe very much the same (if not for a few changes) to the one analyzed back in August 2017 by\n[TrendMicro. The shared commands between this March 2018 version and the August 2017 one are](https://blog.trendmicro.com/trendlabs-security-intelligence/backdoor-carrying-emails-set-sights-on-russian-speaking-businesses/)\nthe following:\n\n**more_eggs: used to download new scripts**\n**d&exec: used to run executable files**\n**gtfo: used to terminate the instance and perform cleanups**\n**more_onion: used to run a new script**\n\n[ReaQta-Hive customers are protected out-of-the-box from this threat and no updates are required.](https://upstream.rqt.io/hive/)\nFully patched systems are not vulnerable to this attack as all the vulnerabilities have been reported\nand fixed. Legacy systems should monitor for one of the IOCs published below and for abnormal\nbehaviors, like msxsl running from temporary folders or regsvr32.exe loading unknown modules.\n\n## IOC\n\n**malicious RTF (DOC00201875891.doc):**\ndb5a46b9d8419079ea8431c9d6f6f55e4f7d36f22eee409bd62d72ea79fb8e72\n**msxsl.exe (legitimate,**\n**dropped): 35ba7624f586086f32a01459fcc0ab755b01b49d571618af456aa49e593734c7**\n**JS**\n**persistence: 710eb7d7d94aa5e0932fab1805d5b74add158999e5d90a7b09e8bd7187bf4957**\n**XSL JS**\n**backdoor: 6a3f5bc5885fea8b63b80cd6ca5a7990a49818eda5de59eeebc0a9b228b5d277**\n**XML: dbe0081d0c56e0b0d7dbf7318a4e296776bdd76ca7955db93e1a188ab78de66c**\n**task.bat: 731abba49e150da730d1b94879ce42b7f89f2a16c2b3d6f1e8d4c7d31546d35d**\n**2nd.bat: 33c362351554193afd6267c067b8aa78b12b7a8a8c72c4c47f2c62c5073afdce**\n**decoy**\n**document: 1ab201c1e95fc205f5445acfae6016679387bffa79903b07194270e9191837d8**\n**regsvr32 DLL: 0adc165e274540c69985ea2f8ba41908d9e69c14ba7a795c9f548f90f79b7574**\n**inteldriverupd1.sct: 002394c515bc0df787f99f565b6c032bef239a5e40a33ac710395bf264520df7**\n**C2: mail[.]hotmail[.]org[.]kz/owalanding/ajax.php\\**\n**IP (at the time of writing): 185.45.192.167**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-03-02 - Spear-phishing campaign leveraging on MSXSL.pdf"
    ],
    "report_names": [
        "2018-03-02 - Spear-phishing campaign leveraging on MSXSL.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2dfaa730-7079-494c-b2f0-3ff8f3598a51",
            "created_at": "2022-10-25T16:07:23.474746Z",
            "updated_at": "2025-03-27T02:02:09.822683Z",
            "deleted_at": null,
            "main_name": "Cobalt Group",
            "aliases": [
                "ATK 67",
                "Cobalt Gang",
                "Cobalt Spider",
                "Gold Kingswood",
                "Mule Libra",
                "TAG-CR3"
            ],
            "source_name": "ETDA:Cobalt Group",
            "tools": [
                "ATMRipper",
                "ATMSpitter",
                "Agentemis",
                "AmmyyRAT",
                "AtNow",
                "COOLPANTS",
                "CobInt",
                "Cobalt Strike",
                "CobaltStrike",
                "Cyst Downloader",
                "Fareit",
                "FlawedAmmyy",
                "Formbook",
                "Little Pig",
                "Metasploit Stager",
                "Mimikatz",
                "More_eggs",
                "NSIS",
                "Nullsoft Scriptable Install System",
                "Pony Loader",
                "Ripper ATM",
                "SDelete",
                "Siplog",
                "SoftPerfect Network Scanner",
                "SpicyOmelette",
                "Taurus Builder",
                "Taurus Builder Kit",
                "Taurus Loader",
                "Terra Loader",
                "ThreatKit",
                "VenomKit",
                "cobeacon",
                "win.xloader"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c11abba0-f5e8-4017-a4ee-acb1a7c8c242",
            "created_at": "2022-10-25T15:50:23.744036Z",
            "updated_at": "2025-03-27T02:00:55.537114Z",
            "deleted_at": null,
            "main_name": "Cobalt Group",
            "aliases": [
                "Cobalt Group",
                "GOLD KINGSWOOD",
                "Cobalt Gang",
                "Cobalt Spider"
            ],
            "source_name": "MITRE:Cobalt Group",
            "tools": [
                "Mimikatz",
                "More_eggs",
                "SpicyOmelette",
                "SDelete",
                "Cobalt Strike",
                "PsExec"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535609,
    "ts_updated_at": 1743041768,
    "ts_creation_date": 1653760635,
    "ts_modification_date": 1653760635,
    "files": {
        "pdf": "https://archive.orkl.eu/f11e0e375bf213b6ad95c644e89fa769870add2a.pdf",
        "text": "https://archive.orkl.eu/f11e0e375bf213b6ad95c644e89fa769870add2a.txt",
        "img": "https://archive.orkl.eu/f11e0e375bf213b6ad95c644e89fa769870add2a.jpg"
    }
}