{
    "id": "3abc53ef-6692-4a86-8619-0ec962aac367",
    "created_at": "2023-01-12T15:10:52.183821Z",
    "updated_at": "2025-03-27T02:10:11.514862Z",
    "deleted_at": null,
    "sha1_hash": "fda0827ef6348d29e768ba44c9eae970bec5ae90",
    "title": "2020-03-25 - Unpacking the Kwampirs RAT",
    "authors": "",
    "file_creation_date": "2022-05-29T10:37:42Z",
    "file_modification_date": "2022-05-29T10:37:42Z",
    "file_size": 2150761,
    "plain_text": "# Unpacking the Kwampirs RAT\n\n**blog.reversinglabs.com/blog/unpacking-kwampirs-rat**\n\n[Threat Research | March 25, 2020](https://blog.reversinglabs.com/blog/tag/threat-research)\n\nBlog Author\n[Karlo Zanki, Reverse Engineer at ReversingLabs. Read More...](https://blog.reversinglabs.com/blog/author/karlo-zanki)\n\n\n-----\n\n## Introduction\n\nOver the past few years, malware threats have increasingly started targeting the industrial\ncontrol systems. These threats are becoming so concerning that the FBI recently had to\nissue a public warning about one in particular. As [ZDNET reported, the US private sector](https://www.zdnet.com/article/fbi-warns-about-ongoing-attacks-against-software-supply-chain-companies/)\nwas warned about a malware campaign that targets supply chain software providers. The\nmalware referenced by this report was Kwampirs RAT - the malicious tool of choice from the\nOrangeworm group.\n\nGiven the possible ramifications this campaign might have, we've decided to leverage the\nTitanium platform for research into its inner workings. From the threat analysis viewpoint, the\nmost important part of this malware is its configuration (control servers, mutex it uses,\nregistry keys it creates…), since it's essentially a remote access trojan (RAT).\n\nFollowing the breadcrumbs left in the network configuration, malware evolution can be\nmapped to the campaigns carried out by the group. By investigating the connections of this\nmalware to the reports of new malware, its activity can be independently corroborated. But\nmore importantly, documenting the malware network infrastructure can help the defenders\nprotect their organizations from the ongoing attack more efficiently.\n\n## Expanding the picture\n\nEvery research builds upon what’s already been disclosed, and so we started ours by finding\nprevious publications. As the referenced ZDNET article reports, this group has used the\nmalware since 2015, so it is safe to assume that a technical analysis of the threat already\nexists. Two such technical reports were referenced in the article: the first one from\n\n\n-----\n\n[Symantec, and the second from Lab52. Symantec s report was older and provided some](https://www.symantec.com/blogs/threat-intelligence/orangeworm-targets-healthcare-us-europe-asia)\ntechnical details, but it mostly focused on IOCs. On the other hand, Lab52’s [report provided](https://lab52.io/blog/orangeworm-group-kwampirs-analysis-update/)\na more in-depth technical analysis of the malware, listed used modules, and described the\n[dropping and infection phases in detail. This report also included a link to a tweet containing](https://twitter.com/pancak3lullz/status/1225536379834290177)\nYARA rules that can be used for detecting Kwampirs.\n\nThe next logical step in our research was to acquire the samples. Publicly available YARA\nrules are a perfect starting point, as they are easily deployed to the ReversingLabs A1000\nthreat analysis platform. The Retro Hunt feature offers a quick way to match those YARA\nrules against all samples seen by the Titanium Platform in the last 90 days. By Retro Hunting\nwith those rules, we found the following samples.\n\n**Retro Hunt results on ReversingLabs A1000**\n\nAs the previously mentioned Lab52 technical analysis describes, the main RAT functionality\ncan be found in the DLL payload of the installer.\n\n\n-----\n\n## Payload analysis\n\n**Functions Exported by the RAT DLL**\n\nThe Titanium platform analysis matched the facts described in the referenced technical\nanalysis. The DLL exports only one function named ControlTrace. Furthermore, the\nsimilarity analysis also showed that this sample shares the same functionality with 726 other\nsamples within ReversingLabs TitaniumCloud, grouped by the RHA1 similarity algorithm.\nThese findings significantly expanded the analysis sample set.\n\n**Threat name associated with the RAT sample**\n\nLooking to complete the set, we picked another pivoting point - the detected threat name; in\nthis case, Win32.Trojan.Kwampirs. Searching for all samples of the DLL file type with this\nthreat name yielded even more matches.\n\nThe results of this search query, when sorted by their First Seen property, revealed even\nmore interesting data points. Sorting by First Seen time naturally groups these samples\nbased on their file size. This pivoting helps not only with grouping, but also with discovering\n\n\n-----\n\nadditional Kwampirs RAT versions.\n\n**Search results sorted by their first occurrence and based on threat name and file type**\n\n\n-----\n\nInvestigating the code patterns revealed strong similarities between the 530 KB samples and\nthe 255 KB samples described in the existing technical report. The main difference between\nthem was the BMP image found in the resources, which is actually an encrypted PE32\nexecutable. This was only found in the dropper of the 255 KB samples. The second\nsignificant difference was that C2 hosts were stored as plaintext.\n\nThe code patterns of the 148 KB sample slightly differed from the others. However, the\nconfiguration decryption key and algorithm were still the same. Also, the exported function\nname was not ControlTrace - it was MyDllMain, and the original DLL name during\ncompilation wasn’t wmiax.dll but Actuator.dll instead.\n\n**Functions exported by the newly discovered sample**\n\nPivoting around the original DLL name uncovered another interesting sample that was not\nattributed to Win32.Trojan.Kwampirs like the others.\n\n**Pivoting on new Export names**\n\nAnalyzing this sample and comparing it to the previous one showed that they were practically\nthe same. This final sample had slightly simpler logic in some places, but the extracted\ndomains were identical. The most interesting difference between the two was the User Agent\nstring. The majority of Kwampirs samples have the User Agent string set to something like\n\n\n-----\n\nMozilla/…, but this sample had it set to **ItIsMe . These facts, combined with the first**\noccurrence dates in our cloud, led to the conclusion that this was an earlier version in the\nRAT’s development process.\n\n**User Agent strings difference**\n\nCollecting the samples is more than a data hoarding exercise. It's necessary for writing a\nreliable malware configuration parser that extracts network configurations from collected\nsamples - primarily the C2 URLs. These URLs are interesting because of the way this RAT\nfinds active C2 servers. Every sample comes with a hardcoded list of 200 URLs that it tries\nto access in the sequential order. The C2 locations are either in the form of domain names or\nIP addresses. The malware uses the first active URL it finds as the C2 server.\n\nSince the malware configuration is hidden away in the installer that drops the DLL onto the\nsystem, an unpacker needs to be created alongside the parser. This unpacker decomposes\nthe installation component and extracts the DLL, allowing the parser to collect the necessary\nC2 information.\n\nUsing this combination of extraction and parsing, roughly 1600 URLs were collected. There\nwas some duplication in the list, as some URLs were found within multiple samples. When\nthis data was deduplicated, the number of URLs decreased to 1586 URLs.\n\nAnalyzing the results of the extraction revealed that some of the droppers used the same\npayload, even though their hashes were different. The only difference between those\nsamples was a 64-byte string used for random file name generation as a part of its execution\nlogic. This indicates that the new dropper samples recently seen in the cloud are, in fact,\nfreshly compiled, even though they use the old DLL payloads.\n\n## Grouping samples into campaigns\n\n\n-----\n\nMalicious operations are usually carried out in waves (or campaigns) that typically share the\nsame control server infrastructure. Each of the Kwampirs samples we collected came with a\nset of 200 control server URLs. Since 1586 of those URLs were unique, it is safe to assume\nthey were remnants of multiple campaigns. As the number of extracted URLs is not a\nmultiple of 200, it is likely that some parts of the network infrastructure were reused by\nmultiple campaigns.\n\nGrouping samples into campaigns is a challenge. One way to split the dataset is by the time\nof discovery, but it might not be the best way. In this case, some samples were already nicely\ngrouped together by the combination of their size and their discovery time. However, that still\nleft a large set of 600+ samples of files 255 KB in size.\n\nSince this collection of samples was too big for manual inspection, we relied on static\nanalysis for assistance. Processing the samples with our Titanium platform and plugging the\nresults into the ELK stack could help us find suitable grouping criteria.\n\nRight away, two of the metadata fields struck us as the most convenient - Rich header\ninformation and the file compilation timestamp. Rich header is a structure that often appears\nin PE files just before the PE signature. It contains information about the compiling and\nlinking processes, such as the toolchain version artifacts. In this case, Rich header revealed\nthat all samples were compiled with Visual Studio 2010. Their timestamps did not correlate\nwith their first appearance in our cloud, which was in May 2015 and later. In fact, they all\nappeared as if they had been compiled a few years before their appearance in the cloud.\nGiven what’s known about the operations of this group, it probably means that the samples\n\n\n-----\n\nwere compiled in a virtual machine with deliberately inaccurate time.\n\n**Rich header and timestamp grouping**\n\nGrouping the samples based on these criteria produced much cleaner results for the\ndomains extracted from them. Each group of samples had one or two sets of URLs in their\nconfigurations, which were repeated the same number of times. With that, the grouping was\ncomplete and it provided the following insight into the sample-to-campaign relationships.\n\n\n-----\n\n**Final grouping of samples**\n\n## Version correlation\n\nFor visualization purposes, the extracted data was loaded into Maltego that created a graph\nshowing correlation between samples and the domains used across different campaigns.\nThis confirmed that most of the campaigns were interconnected by one or multiple control\ndomains.\n\n\n-----\n\n**Campaign correlation and connectivity**\n\nProcessing historical DNS resolution data for one of the domains extracted from a recently\nseen sample revealed more interesting data. As shown in the RiskIQ’s Passivetotal, the\ndomain dswmain.org that was seen in CampaignC resolved to two hosts in the past.\n\n**Historic DNS resolution for dswmian.org site**\n\nCurrently it redirects to a sinkhole server with the IP address 172.105.123.10. Looking at the\nlist of the domains that have resolved to that host, we can see more domains that are part of\nKwampirs campaigns - not all of them, but a small subset. Most of the extracted domains\ndon’t resolve to anything yet, so they could be used as backup domains when the active\ncontrol domain is compromised or goes down. Since this was a sinkhole server, this\ninformation couldn’t confirm the assumption that these campaigns shared the infrastructure,\nbut it does show which domains were used and when they were used in the past.\n\n\n-----\n\n**Pivoting on the resolved IP address**\n\nInterestingly, a few domains on that list haven’t been extracted from any of the encountered\nsamples. However, they do look like the domains that Kwampirs could have used, since they\nconsist of several repeated random letters. This might mean there are a few more\ncampaigns for which the samples are yet to be collected. Still, based on the timeline when\nthese domains were first seen by the passive DNS service, it is likely that they are used by\nsome older samples, and are part of a campaign that’s already been mapped.\n\n## Conclusion\n\nProtection from supply chain attacks is two-fold. Organizations must protect their\ndevelopment environment and ensure their suppliers are not compromised. Kwampirs RAT\nrepresents a targeted attack against the secure software supply chain, and needs to be\nclosely monitored for new activity.\n\nWarnings issued by the FBI are corroborated by our research presented here. The attackers\nare still using the same methods of infection, tools, and network infrastructure, which\nindicates that their activity is constant.\n\nConverting open source threat intelligence into actionable data is a difficult task made easy\n\n\n-----\n\nwith the ReversingLabs Titanium Platform. Pulling from a vast data repository, it enables the\ndefenders to collect necessary samples and extract valuable IOCs that can be used to\nprotect the organisation from past and ongoing attacks.\n\n## IOC list\n\nThe following links contain the data extracted from the collected samples. These IOCs can\nbe used to improve the security of your organizations by creating blocking firewall and\nintrusion detection systems rules. They can also be used to search the SIEM logs for\ninfected endpoints. IOCs are grouped as described previously in this article.\n\nSHA1: [https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/SHA1_LIST.txt](https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/SHA1_LIST.txt)\n\n[Campaign 0: https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_0_IOC.txt](https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_0_IOC.txt)\n\n[Campaign 1: https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_1_IOC.txt](https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_1_IOC.txt)\n\n[Campaign A: https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_A_IOC.txt](https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_A_IOC.txt)\n\n[Campaign B: https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_B_IOC.txt](https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_B_IOC.txt)\n\n[Campaign C: https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_C_IOC.txt](https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_C_IOC.txt)\n\n[Campaign D: https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_D_IOC.txt](https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_D_IOC.txt)\n\n[Campaign E: https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_E_IOC.txt](https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_E_IOC.txt)\n\nCampaign F: [https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_F_IOC.txt](https://blog.reversinglabs.com/hubfs/Blog/IOC%20list/Campaign_F_IOC.txt)\n\nRead our other RAT blogs:\n\n### MORE BLOG ARTICLES\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-03-25 - Unpacking the Kwampirs RAT.pdf"
    ],
    "report_names": [
        "2020-03-25 - Unpacking the Kwampirs RAT.pdf"
    ],
    "threat_actors": [
        {
            "id": "6a60b1ba-609f-4bed-b15b-3ffc050d2ac6",
            "created_at": "2022-10-25T16:07:24.033083Z",
            "updated_at": "2025-03-27T02:02:10.086126Z",
            "deleted_at": null,
            "main_name": "Orangeworm",
            "aliases": [],
            "source_name": "ETDA:Orangeworm",
            "tools": [
                "Kwampirs",
                "LOLBAS",
                "LOLBins",
                "Living off the Land"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c4acd072-595e-4d33-9ce9-bbf41010bb1a",
            "created_at": "2023-01-06T13:46:38.751893Z",
            "updated_at": "2025-03-27T02:00:02.909078Z",
            "deleted_at": null,
            "main_name": "Orangeworm",
            "aliases": [],
            "source_name": "MISPGALAXY:Orangeworm",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "3e0bc1b7-0dd7-444a-964b-64dfb5145c8f",
            "created_at": "2022-10-25T15:50:23.413202Z",
            "updated_at": "2025-03-27T02:00:55.463857Z",
            "deleted_at": null,
            "main_name": "Orangeworm",
            "aliases": [
                "Orangeworm"
            ],
            "source_name": "MITRE:Orangeworm",
            "tools": [
                "Kwampirs",
                "netstat",
                "ipconfig",
                "cmd",
                "Arp",
                "Systeminfo"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d8af157e-741b-4933-bb4a-b78490951d97",
            "created_at": "2023-01-06T13:46:38.748929Z",
            "updated_at": "2025-03-27T02:00:02.908256Z",
            "deleted_at": null,
            "main_name": "APT35",
            "aliases": [
                "Newscaster Team",
                "Magic Hound",
                "G0059",
                "Phosphorus",
                "Mint Sandstorm",
                "TunnelVision",
                "COBALT MIRAGE"
            ],
            "source_name": "MISPGALAXY:APT35",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e3676dfe-3d40-4b3a-bfbd-4fc1f8c896f4",
            "created_at": "2022-10-25T15:50:23.808974Z",
            "updated_at": "2025-03-27T02:00:55.550912Z",
            "deleted_at": null,
            "main_name": "Magic Hound",
            "aliases": [
                "Magic Hound",
                "TA453",
                "COBALT ILLUSION",
                "Charming Kitten",
                "ITG18",
                "Phosphorus",
                "APT35",
                "Mint Sandstorm"
            ],
            "source_name": "MITRE:Magic Hound",
            "tools": [
                "Impacket",
                "CharmPower",
                "FRP",
                "Mimikatz",
                "Systeminfo",
                "ipconfig",
                "netsh",
                "PowerLess",
                "Pupy",
                "DownPaper",
                "PsExec",
                "Havij",
                "sqlmap"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "1699fb41-b83f-42ff-a6ec-984ae4a1031f",
            "created_at": "2022-10-25T16:07:23.83826Z",
            "updated_at": "2025-03-27T02:02:09.995863Z",
            "deleted_at": null,
            "main_name": "Magic Hound",
            "aliases": [
                "APT 35",
                "Ballistic Bobcat",
                "Charming Kitten",
                "CharmingCypress",
                "Cobalt Illusion",
                "Cobalt Mirage",
                "Educated Manticore",
                "Magic Hound",
                "Mint Sandstorm",
                "Operation BadBlood",
                "Operation Sponsoring Access",
                "Operation SpoofedScholars",
                "Operation Thamar Reservoir",
                "Phosphorus",
                "TA453",
                "TEMP.Beanie",
                "Tarh Andishan",
                "Timberworm",
                "TunnelVision",
                "UNC788",
                "Yellow Garuda"
            ],
            "source_name": "ETDA:Magic Hound",
            "tools": [
                "7-Zip",
                "AnvilEcho",
                "BASICSTAR",
                "CORRUPT KITTEN",
                "CWoolger",
                "CharmPower",
                "ChromeHistoryView",
                "CommandCam",
                "DistTrack",
                "DownPaper",
                "FRP",
                "Fast Reverse Proxy",
                "FireMalv",
                "Ghambar",
                "GoProxy",
                "GorjolEcho",
                "HYPERSCRAPE",
                "Havij",
                "MPK",
                "MPKBot",
                "Matryoshka",
                "Matryoshka RAT",
                "MediaPl",
                "Mimikatz",
                "MischiefTut",
                "NETWoolger",
                "NOKNOK",
                "PINEFLOWER",
                "POWERSTAR",
                "PowerLess Backdoor",
                "PsList",
                "Pupy",
                "PupyRAT",
                "SNAILPROXY",
                "Shamoon",
                "TDTESS",
                "WinRAR",
                "WoolenLogger",
                "Woolger",
                "pupy",
                "sqlmap"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536252,
    "ts_updated_at": 1743041411,
    "ts_creation_date": 1653820662,
    "ts_modification_date": 1653820662,
    "files": {
        "pdf": "https://archive.orkl.eu/fda0827ef6348d29e768ba44c9eae970bec5ae90.pdf",
        "text": "https://archive.orkl.eu/fda0827ef6348d29e768ba44c9eae970bec5ae90.txt",
        "img": "https://archive.orkl.eu/fda0827ef6348d29e768ba44c9eae970bec5ae90.jpg"
    }
}