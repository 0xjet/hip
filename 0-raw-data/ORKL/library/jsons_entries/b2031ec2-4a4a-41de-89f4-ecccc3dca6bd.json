{
    "id": "b2031ec2-4a4a-41de-89f4-ecccc3dca6bd",
    "created_at": "2023-01-12T15:09:11.20986Z",
    "updated_at": "2025-03-27T02:09:18.481454Z",
    "deleted_at": null,
    "sha1_hash": "3fdd82556b7d18d91731ea8dbca049a49a5940d3",
    "title": "2021-12-06 - Attack Lifecycle Detection of an Operational Technology Breach",
    "authors": "",
    "file_creation_date": "2022-05-28T16:58:44Z",
    "file_modification_date": "2022-05-28T16:58:44Z",
    "file_size": 509078,
    "plain_text": "# Attack Lifecycle Detection of an Operational Technology Breach\n\n**[paraflare.com/attack-lifecycle-detection-of-an-operational-technology-breach/](https://paraflare.com/attack-lifecycle-detection-of-an-operational-technology-breach/)**\n\nMelanie Ninovic\n\n**Melanie Ninovic**\n\n_Digital Forensics & Incident Response Consultant at ParaFlare_\n\nDec 6, 2021\n\n5 min read.\n\n_FireEye Mandiant released a red teaming case study in April 2021 that explores the tactics, techniques, and_\n_procedures (TTPs) used to penetrate an information technology (IT) network and ultimately gain access to the_\n_operational technology (OT) network. ParaFlare is expanding on this research to provide useful detection and_\n_response methods to those responsible for securing a technology-enabled environment._\n\nRegardless of whether your organisation deals with OT or not, the detections explored within this article relate to\ncommonly found tools or techniques used against an IT environment, such as phishing emails, Remote Desktop\nProtocol (RDP), mimikatz, and Cobalt Strike. Threat actors with clear motives will live off the land and use already\nexisting tools, or those that are publicly available, to further compromise a network whether it be in the IT or OT\nspace.\n\n## Attack Lifecycle\n\n\n-----\n\nIn FireEye Mandiant s case study, the following graphic was provided to demonstrate what phases of the attack\nlifecycle are conducted in which part of an organisation’s network. There is a clear path to the OT environment, but\nthis requires a series of successfully executed activities before completing their mission; all of which is detectable\nwithin your IT environment.\n\nCredit: https://www.fireeye.com/blog/threat-research/2021/04/hacking-operational-technology-for-defense-lessonslearned.html\n\n## Detections\n\nParaFlare’s operations team has dissected the case study’s lifecycle into useful detections that we are using to\nprotect our customers, and provide a head start for organisations who are susceptible to similar breaches. This will\nmostly look at endpoint and network signatures that we can detect from the IT side of the environment, as these will\nnot, due to their nature, generally be available in OT infrastructure.\n\n**1. Initial compromise**\n\nIn this case study, one set of emails contained an embedded link to a malicious file hosted on the internet, and the\nother had a malicious file attached to the email. Detection strategies include:\n\nEndpoint Detection and Response (EDR) and Anti-Virus signature and behavioural alerts for downloading a\nmalicious document, clicking a malicious link, and the activity that followed.\nNetwork Detection. If your organisation is capturing network traffic via Zeek, files.log will be able to detect any\nfiles being downloaded with common phishing extensions like .docx, .pdf etc. The Zeek http.log will also\ncapture important data on files traversing the network, such as 'resp_filenames’ and ‘resp_mime_types’.\n\nProxy logs will be able to show:\n\nHTTP GET request to the malicious link that was embedded in the email.\nHTTP GET request to the malicious document downloaded to the victim’s machine.\nMIME or content types can be filtered to those commonly used for phishing campaigns like ‘application/zip’,\n‘application/pdf’, ‘application/msword’, and ‘application/vnd.openxmlformats/%’.\n\n**2. Establish foothold**\n\nThe red team used Cobalt Strike’s Command and Control (C2) protocol to establish their foothold. We can detect\nthis by:\n\nmonitoring ‘ESTABLISHED’ connections to remote IP addresses to detect C2 beaconing.\nmonitoring HTTP POST requests to remote IP addresses with encrypted binary blobs; this generally includes\ninformation about the compromised host such as its hostname.\nlooking for base64 encoded code within HTTP GET and POST requests, in the ‘data’ field.\n\n**3. Internal reconnaissance**\n\nldapsearch was used to enumerate information in the enterprise domain. This is a Linux based tool that would be\ndifficult to detect unless you are monitoring processes or bash history.\n\nMonitoring Linux processes can be done via top, ps -aux, lsof, and netstat.\n\n\n-----\n\nActive and passive port scanning was conducted to further understand the enterprise network and determine any\ncommunication paths to the OT environment.\n\nMonitoring or detecting port scans are often difficult as they usually rely on the ICMP protocol. However, a\nnetwork IDS like Snort has inbuilt signatures to detect this type of activity, especially if the threat actor is using\npublicly accessible tools such as nmap.\nFor initial reconnaissance from the external network, nmap would show up in HTTP logs with ‘nmap’ in the\nuser agent string.\n\nKeystroke logging via Cobalt Strike’s C2 was also used to gather information relating to hostnames, IP addresses,\nusernames, and passwords to internal systems within the organisation. This type of reconnaissance later enabled a\nremote desktop session to the OT network.\n\nKeyloggers can be found by monitoring the running processes on the host.\nEstablished and listening network connections should also be monitored as the logs would be sent to a\nremote IP address controlled by the threat actor.\n\n**4. Persistence**\nMimikatz was used to extract credentials for local user accounts and those of the domain administrators. As threat\nactors know mimikatz.exe will create P1 alerts, they often change the name of the binary. Therefore, ParaFlare\nrecommends using command line parameters to detect mimikatz execution:\n\nmimikatz.exe “log log.txt” “privilege::debug” “sekurlsa::logonpasswords” “exit”\nThe parameter ‘sekurlsa’ is more difficult to change, so having a rule for this string would be more effective to\ndetect this activity\nIf you are capturing System.evtx, you will be able to detect the new service that Mimikatz will create by\nmonitoring EID 7045, and EID 7040 will log the start and stop of that service.\n\nPowerSploit, based off PowerShell was used in this case study to exploit common security misconfigurations. It has\nmany other features, but they all mostly rely on PowerShell’s script block.\n\nScript Block Logging is logged under EID 4104 in the ‘Windows PowerShell’ event log. It will also be captured\nin the Security event log under EID 4688 (new process creation).\nIn the case of DLL injections, one of the PowerSploit modules, you can detect this by alerting on processes\nthat spawn rundll32.exe. This is made easier if you have Process Tracking audit events enabled to log each\nnew process creation.\n\n**5. Lateral movement**\nWMImplant was used to move laterally from one system to another in the internal IT network.\n\nEnable event log Microsoft-Windows-WMI-Activity/Operational.\nMonitor and alert on EID 5861 (WMI) and EID 4104 (Script Block Logging).\nMonitor for WMIPrvSe.exe process creation as this is required for WMI-based tools to execute.\n\nSMB was utilised to move from the patch management server in the DMZ to the Windows-based intermediary\nsystems in the OT network.\n\nSet up alerting for ‘ESTABLISHED’ network connections from one internal IP address to another. This can be\ndone through Sysmon, Zeek, or other network monitoring tools.\n\n## Response\n\nParaFlare’s DFIR team has written some queries (based off OSQuery) to assist organisations in their own threat\nhunting capabilities. Additionally, we explore some event logs and other forensic artifacts requiring analysis to\nidentify malicious activity relating to this case study.\n\n\n-----\n\n**1. Initial compromise**\nEvent logs can be examined to identify any Microsoft Office files that contained embedded macros from a phishing\nattempt:\n\nC:\\Windows\\System32\\winevt\\Logs\\OAlerts.evtx will display informational alerts from Microsoft Office files.\nThese are the pop ups that are displayed whilst using Microsoft Office files, like ‘Save As’, ‘this workbook\ncontains links to one or more external sources’, and ‘Start application CMD.EXE’. Search within this event log\nfor keywords such as cmd, powershell, or the term ‘macro’.\n\nWeb browser history, looking for a malicious document download or accessing a malicious link:\n\nChrome: C:\\Users\\<username>\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\History\nFirefox: C:\\Users\\<username>\\Appplication Data\\Mozilla\\Firefox\\Profiles\\places.sqlite\nInternet Explorer: C:\\Users\\<username>\\AppData\\Local\\Microsoft\\Windows\\WebCache\\WebCacheV01.dat\n\nFor executed programs and opened files per user, analyse C:\\Users\\<username>\\NTUSER.DAT:\n\nNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU\nNTUSER.DAT\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs\n\n**2. Establish foothold**\nTo detect Cobalt Strike, we can look at network connections and sockets via OSQuery:\n\n```SELECT processes.name, processes.path, processes.cmdline, listening_ports.address,\nllistening_ports.pid, listening_ports.port, listening_ports.protocol FROM listening_ports JOIN processes ON\nlistening_ports.pid = processes.pid WHERE listening_ports.address = “0.0.0.0”;```\n```SELECT sockets.pid, processes.name, sockets.path, sockets.remote_address, sockets.remote_port,\nsockets.state FROM process_open_sockets sockets JOIN processes ON sockets.pid = processes.pid\nWHERE sockets.remote_port NOT LIKE ‘0’ ORDER BY sockets.remote_port ASC;```\n\n**3. Persistence**\nFor mimikatz to run successfully, the threat actor will need to enable WDigest. We can determine this via OSQuery,\nsince we know it is enabled if the data field is set to 1:\n\n```SELECT * FROM registry WHERE path =\n‘HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest\\UseLogonCredential’\nAND data = 1;```\n\nMimikatz will also have to install a service. Using OSQuery, list all automatically executing services:\n\n```SELECT name, display_name, status, path, user_account FROM services WHERE start_type =\n“AUTO_START” AND path NOT LIKE “%System32\\svchost.exe%”;```\n\n**4. Lateral movement**\nSMB activity can be detected via OSQuery by looking at processes and open pipes:\n\n```SELECT proc.path as processPath, proc.pid, proc.parent as ppid, proc.cwd as currentWorkingDirectory,\npipe.pid as pipePid, pipe.name AS pipename FROM processes proc JOIN pipes pipe ON\nproc.pid=pipe.pid;```\n\nWMImplant activity can be identified via OSQuery’s multiple WMI based tables:\n\n```SELECT name, query, relative_path FROM wmi_event_filters WHERE name NOT LIKE 'SCM%';```\n```SELECT * FROM wmi_filter_consumer_binding WHERE consumer NOT LIKE '%SCM%';```\n```SELECT name, scripting_engine, script_file_name, class, relative_path FROM\nwmi_script_event_consumers;```\n\n\n-----\n\n## Other recommendations\n\nParaFlare recognises that simple lapses in security may have dire consequences later down the track. Here are\nsome instances of this from FireEye Mandiant’s report:\n\nOperational manuals with plaintext usernames and passwords provide easy access for any threat actor\nlooking for this information. We recommend at minimum to encrypt this material, but further to the point, not\ndisplaying plaintext credentials in any document.\nDisable macros within the Microsoft Office suite for files that have been received from the Internet.\nSensitive documents including OT system and network designs should only be accessible to those who\nrequire access. This is known as the principle of least privilege. More to this, these types of documents\nshould be password protected. Ensure logging is enabled and monitored. This should include:\n\nPowerShell’s v5 Script Block Logging to allow for alerting on new commands being executed within the\nenvironment. This can be done through the Group Policy by going to Administrative Templates ->\nWindows Components -> Windows PowerShell -> Turn on PowerShell Script Block Logging. EID 4103\nand 4104 to inspect script blocks.\nSecurity event log captures new process creation, which analysts can use to detect malicious scripts\nand command line arguments by examining EID 4688. To enable this in Group Policy: Security Settings\n-> Audit Policy -> Audit Process Tracking.\nMicrosoft-Windows-WMI-Activity/Operational: EID 5857 shows wmiprvse execution and path to provider\nDLL’s.\n\n## References\n\nFor more information on this case study, please visit the following link:\n\nFireEye Mandiant Research: https://www.fireeye.com/blog/threat-research/2021/04/hacking-operationaltechnology-for-defense-lessons-learned.html\n\nParaFlare is here to support our customers, new or existing, with the content within this article and any other\nqueries you may have. Please reach out to us if you have any questions.\n\n[Have a comment? Join the conversation on LinkedIn](https://www.linkedin.com/company/paraflare)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-12-06 - Attack Lifecycle Detection of an Operational Technology Breach.pdf"
    ],
    "report_names": [
        "2021-12-06 - Attack Lifecycle Detection of an Operational Technology Breach.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536151,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1653757124,
    "ts_modification_date": 1653757124,
    "files": {
        "pdf": "https://archive.orkl.eu/3fdd82556b7d18d91731ea8dbca049a49a5940d3.pdf",
        "text": "https://archive.orkl.eu/3fdd82556b7d18d91731ea8dbca049a49a5940d3.txt",
        "img": "https://archive.orkl.eu/3fdd82556b7d18d91731ea8dbca049a49a5940d3.jpg"
    }
}