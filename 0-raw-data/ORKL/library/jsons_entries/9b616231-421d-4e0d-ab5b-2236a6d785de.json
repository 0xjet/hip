{
    "id": "9b616231-421d-4e0d-ab5b-2236a6d785de",
    "created_at": "2023-01-12T15:07:00.145683Z",
    "updated_at": "2025-03-27T02:06:05.677418Z",
    "deleted_at": null,
    "sha1_hash": "7b9cf2c26ed7e1176642b7486edcaf44ebb97672",
    "title": "2019-12-18 - IcedID PNG Extractor",
    "authors": "",
    "file_creation_date": "2022-05-28T19:49:26Z",
    "file_modification_date": "2022-05-28T19:49:26Z",
    "file_size": 75770,
    "plain_text": "# psrok1/icedid-reconstruct.py\n\n**[gist.github.com/psrok1/e6bf5851d674edda03a201e7f24a5e6b](https://gist.github.com/psrok1/e6bf5851d674edda03a201e7f24a5e6b)**\n\n\"\"\"\n\nPy3 version of IcedID custom steganographic loader (PNG parser & PE reconstructor)\n\nInspired by\nhttps://github.com/hasherezade/funky_malware_formats/tree/master/iced_id_parser\n\nAuthored by @nazywam and @psrok1.\n\npip3 install malduck lief\n\n\"\"\"\n\nimport sys\n\nimport malduck\n\nfrom lief import PE\n\nclass IcedidSection(malduck.Structure):\n\n_pack_ = 1\n\n\n-----\n\n_fields_ = [\n\n(\"VirtualOffset\", malduck.DWORD),\n\n(\"VirtualSize\", malduck.DWORD),\n\n(\"RawOffset\", malduck.DWORD),\n\n(\"RawSize\", malduck.DWORD),\n\n(\"Characteristics\", malduck.BYTE)\n\n]\n\nclass IcedidHeader(malduck.Structure):\n\n_pack_ = 1\n\n_fields_ = [\n\n(\"ImageBase\", malduck.QWORD),\n\n(\"ImageSize\", malduck.DWORD),\n\n(\"EntryPoint_va\", malduck.DWORD),\n\n(\"ImportDir_va\", malduck.DWORD),\n\n(\"RelocDir_va\", malduck.DWORD),\n\n(\"RelocDir_size\", malduck.DWORD),\n\n(\"SectionCount\", malduck.DWORD)\n\n]\n\ndef decrypt_image(path: str) -> bytes:\n\np = malduck.procmem.from_file(path)\n\nidat_off = next(p.findp(b'IDAT'))\n\nidat_len = p.uint32p(idat_off - 4)\n\ndata = p.readp(idat_off + 4, idat_len)\n\ndecrypted = malduck.rc4(data[:8], data[8:])\n\nreturn decrypted\n\n\n-----\n\ndef reconstruct(payload: bytes) -> bytes:\n\np = malduck.procmem(payload)\n\ndata_offset = offset = 0x1188\n\nheader_data = p.readp(offset, IcedidHeader.sizeof())\n\nheader = IcedidHeader.parse(header_data)\n\noffset += IcedidHeader.sizeof()\n\nsections_data = p.readp(offset, IcedidSection.sizeof() * header.SectionCount)\n\nsections = [IcedidSection.parse(data) for data in malduck.chunks(sections_data,\nIcedidSection.sizeof())]\n\npe = PE.Binary('icedid_binary', PE.PE_TYPE.PE32)\n\npe.optional_header.imagebase = header.ImageBase\n\npe.optional_header.addressof_entrypoint = header.EntryPoint_va\n\nsections = sorted(sections, key=lambda s: s.VirtualOffset)\n\nfor idx, sec in enumerate(sections):\n\nsection = PE.Section('')\n\ncontent = p.readp(data_offset + sec.RawOffset, sec.RawSize)\n\nsection.content = list(content)\n\nsection.virtual_address = sec.VirtualOffset\n\nsection.characteristics = 0xE0000000\n\nif idx != len(sections) - 1:\n\nsection.virtual_size = sections[idx + 1].VirtualOffset - sec.VirtualOffset\n\npe.add_section(section)\n\n\n-----\n\npe.data_directory(PE.DATA_DIRECTORY.IMPORT_TABLE).rva = header.ImportDir_va\n\npe.data_directory(PE.DATA_DIRECTORY.BASE_RELOCATION_TABLE).rva =\nheader.RelocDir_va\n\npe.data_directory(PE.DATA_DIRECTORY.BASE_RELOCATION_TABLE).size =\nheader.RelocDir_size\n\nbuilder = PE.Builder(pe)\n\nbuilder.build()\n\nreturn bytes(builder.get_build())\n\nif __name__ == '__main__':\n\nif len(sys.argv) < 3:\n\nprint(\"Usage: ./reconstruct.py [pngfile] [outfile]\")\n\nelse:\n\ninpath = sys.argv[1]\n\npayload = decrypt_image(inpath)\n\ndata = reconstruct(payload)\n\nwith open(sys.argv[2], \"wb\") as f:\n\nf.write(data)\n\nprint(\"[*] Stored {} bytes in {}\".format(len(data), sys.argv[2]))\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-12-18 - IcedID PNG Extractor.pdf"
    ],
    "report_names": [
        "2019-12-18 - IcedID PNG Extractor.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536020,
    "ts_updated_at": 1743041165,
    "ts_creation_date": 1653767366,
    "ts_modification_date": 1653767366,
    "files": {
        "pdf": "https://archive.orkl.eu/7b9cf2c26ed7e1176642b7486edcaf44ebb97672.pdf",
        "text": "https://archive.orkl.eu/7b9cf2c26ed7e1176642b7486edcaf44ebb97672.txt",
        "img": "https://archive.orkl.eu/7b9cf2c26ed7e1176642b7486edcaf44ebb97672.jpg"
    }
}