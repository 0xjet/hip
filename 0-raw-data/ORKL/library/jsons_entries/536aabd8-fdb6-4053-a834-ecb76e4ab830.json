{
    "id": "536aabd8-fdb6-4053-a834-ecb76e4ab830",
    "created_at": "2023-01-12T15:09:01.735718Z",
    "updated_at": "2025-03-27T02:08:00.295129Z",
    "deleted_at": null,
    "sha1_hash": "70859428665053f3ce4ad5dca4b8faef0f8c60a7",
    "title": "2019-04-11 - Ave_Maria Malware- there's more than meets the eye",
    "authors": "",
    "file_creation_date": "2022-05-28T17:57:21Z",
    "file_modification_date": "2022-05-28T17:57:21Z",
    "file_size": 1574724,
    "plain_text": "# Ave_Maria Malware: there's more than meets the eye\n\n**reaqta.com/2019/04/ave_maria-malware-part1/**\n\n## Introduction\n\nAVE_MARIA, a malware used in phishing campaigns and so far identified only as an infostealer, appears to be more complex and insidious, offering a wide range of capabilities, from\nprivilege escalation to camera exfiltration, RDP connections, email extraction and more. For\nthe past few months we have been monitoring various phishing campaign delivering\nAVE_MARIA and we are now able to prove that AVE_MARIA is in fact a complete and multipurpose malware.\n\nThis article is the first of a series of 2 in which we will analyse the capabilities of AVE_MARIA…\nand more.\n\n## AVE_MARIA Initial Vector\n\nFor his analysis we will take as an example the document with the following SHA-256:\n_baaa65730d47c21a56bfcdfaced6b888b9590a96e1fd19df9c18115c0b8d1747 (you can check_\nthe behavior from ReaQta-Hive on [VirusTotal, click on “Detailed Report“).](https://www.virustotal.com/#/file/baaa65730d47c21a56bfcdfaced6b888b9590a96e1fd19df9c18115c0b8d1747/behavior)\n\nThe document doesn’t contain any malicious macro nor any particular luring content that asks\nthe user to click in order to access the content. In fact the document contains an embedded\n[object that uses the Microsoft Equation Editor exploit, to start the infection.](https://upstream.rqt.io/2018/03/spear-phishing-campaign-leveraging-msxsl/)\n\n\n-----\n\nSpear-phishing document using CVE-2017-11882\n\n## Infection\n\n\n-----\n\nAve Maria Infection Pipeline\nAVE_MARIA infection chain is convoluted and it can be summarised as follows:\n\nThe malicious RTF exploits CVE-2017-11882\n_eqnedt32.exe (Microsoft Equation Editor) downloads and executes the AVE_MARIA_\nmalware\n**AVE_MARIA starts another instance of itself then it downloads a second malware:**\n**Lokibot**\nAVE_MARIA performs persistence using the registry\nIt runs a UAC bypass to escalate its privileges\nIt modifies Windows Defender settings by excluding a directory from scanning\nIt enables inbound RDP connections\n\n\n-----\n\ncomplete behavioural tree\n\n### AVE_MARIA First stage\n\n[The storyline reconstructed via ReaQta-Hive shows that after a successful exploitation the](https://upstream.rqt.io/hive/)\n_eqnedt32.exe (Microsoft Equation Editor) process downloads (#1) and executes (#2) the_\ndropped AVE_MARIA malware.\n\nIn an attempt to hide its presence, the main process disguises its name by mispelling that of a\ncommon Windows process, in this case: scvhost.exe (original: svchost.exe).\n\n\n-----\n\nFirst stage\nThe malware duplicates itself in a new directory (#3), %appdata%, and it establishes\npersistence in the registry via HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run (#4).\n\n### AVE_MARIA Second stage\n\nThe malware uses different threads during the infection process, to simplify the analysis we\ndivide the second stage in 2 different parts.\n\n**Part 1 – The Lokibot case**\n\nIn this first part we see the main AVE_MARIA malicious process (pid 1072) downloading\nanother executable (analysis box #1 and #2) from:\n```\nh**p://secured.icbegypt.com/ssl.exe\n\n```\nand executing it (#4).\n\n\n-----\n\nsecond stage – part 1\nThe combination of AVE_MARIA and [Lokibot led us to keep analysing this malware to obtain](https://www.sans.org/reading-room/whitepapers/malicious/loki-bot-information-stealer-keylogger-more-37850)\nfurther information.\n\n**Part 2 – Privilege Escalation and RDP**\n\nNow for the second part: the malicious process spawns cmd.exe, that is used to finalize the\nprivilege escalation.\n\n\n-----\n\nsecond stage – part 2\nIn this case the privilege escalation leverages on pkgmgr.exe (#2) to load a malicious dll,\n_dismcore.dll (#1), that in turn spawns a HIGH privilege instance of the malware (#3) seen in_\nthe picture with pid 4512.\n\nprivilege escalation detail\nAfter obtaining the HIGH integrity level, the malware excludes the entire C: drive from\nWindows Defender by using powershell.exe and the cmdlet Add-MpPreference (#4).\n```\npowershell Add-MpPreference -ExclusionPath C:\\\n\n```\nLater on the activity continues with the download of another executable (analysis box #5 and\n#6) that is eventually started (#7):\n```\nh**p://5.206.225.104/dll/upnp.exe\n\n```\nThis last executable, that we will call upnp.exe, is responsible for 2 tasks:\n\n1. Enabling inbound connection to the RDP port 3389.\n2. Bypassing NAT by leveraging on the Simple Service Discovery Protocol in order to\n\ncreate a port forward via UPnP.\n\nThe first task is easily completed by running the netsh.exe Windows utility with the following\ncommandline (#8):\n```\nnetsh advfirewall firewall add rule name=\"3389\" dir=in action=allow protocol=TCP\nlocalport=3389\n\n```\n\n-----\n\nThe second task is completed by issuing a UPnP request to the router in order to open a port\nfor communication as it can be seen from the analysis box #9 where an SSDP connection is\nestablished towards a machine having address:\n```\n192.168.20.16:2869\n\n```\nThe port 2869 is used for Service Discovery(SSDP).\nFrom Wikipedia:\n\nThe Simple Service Discovery Protocol (SSDP) is a [network protocol based on](https://en.wikipedia.org/wiki/Network_protocol)\nthe [Internet protocol suite for advertisement and discovery of network services and](https://en.wikipedia.org/wiki/Internet_protocol_suite)\npresence information.\n\n[…] Microsoft uses port number 2869 for event notification and event subscriptions. [..]\n\nThis was another good reason to keep looking into AVE_MARIA to better understand the\ncapabilities of this “info-stealer”.\n\n## Final Stage\n\nAfter completing the infection, the malware waits to receive new commands from its C2. While\nwaiting the malware also acts as a keylogger, recording to file – and exfiltrating to the C2 –\neverything typed by the user.\n\nkeylogger in action\n\n\n-----\n\nKeylogger directory\nAVE_MARIA offers a wide range of features:\n\n**Privilege Escalation, support from Windows 7 to Windows 10**\nPersistence\nCode Injection\nOffline Keylogger\nCamera Exfiltration\nProcesses Management: enumeration, termination\nFile Management: creation, download, exfiltration, deletion\nDownload and Execution\nRDP using rdpwrap\nInfo-stealer support:\n\nGoogle Chrome\nFirefox\nInternet Explore\nOutlook\nThunderbird\nFoxmail\nCleanup\n\nWe will analyse in more detail such capabilities in the next post.\n\n\n-----\n\n## C2\n\nWe have identified several domains used by the same vector, in fact different components use\ndifferent C2 or drop zones to carry out their activities.\n\nAve Maria Servers\nThe dropped Lokibot sends POST requests to the following C2:\n```\nh**p://89.46.222.77/MaX/fre.php\n\n```\n**AVE_MARIA downloads several components (used to access passwords and to issue the**\nUPnP request) from the same server, we have noticed a consistent use of the following\naddress in different campaigns:\n```\nh**p://5.206.225.104/dll/softokn3.dll\nh**p://5.206.225.104/dll/msvcp140.dll\nh**p://5.206.225.104/dll/mozglue.dll\nh**p://5.206.225.104/dll/vcruntime140.dll\nh**p://5.206.225.104/dll/freebl3.dll\nh**p://5.206.225.104/dll/nss3.dll\n\n```\nLast but not least, this is the dropurl used in the analyzed sample:\n```\nh**p://secured.icbegypt.com\n\n```\nThat, at the time of writing this report, resolves to:\n```\n89.46.223.202:80\n\n```\nThis URL is used by the exploit to download both AVE_MARIA payload and the Lokibot\nexecutables.\n\nCuriously, this same domain is also delivering another malware via Word Documents and HTA\nFiles, in this case it appears to be FORMBOOK as confirmed also by an independent\nresearcher on Twitter.\n\n\n-----\n\nFORMBOOK Storyline\n\n2 different formbook campaigns so far today. Both using same site\n[https://t.co/XMCPldsB2n](https://t.co/XMCPldsB2n) [https://t.co/Hf8Sd90BpE](https://t.co/Hf8Sd90BpE) [pic.twitter.com/8jRZhqO8Zf](https://t.co/8jRZhqO8Zf)\n\n[— My Online Security (@dvk01uk) March 29, 2019](https://twitter.com/dvk01uk/status/1111567009844740097?ref_src=twsrc%5Etfw)\n\nIn order to achieve communication with the attacker, AVE_MARIA relies on a dynamic DNS\nservice:\n```\nh**p://maxibrainz.warzonedns.com:2580\n\n```\nThat currently resolves to:\n```\n91.192.100.61:2580\n\n```\nWe have identified this domain in other campaigns and we will provide more information in the\nnext post.\n\n## Conclusions\n\nThe analysis presented shows that AVE_MARIA is not just an info-stealer, in fact it comes with\ndifferent capabilities beyond those of an info-stealer and it also appears to work in conjunction\nwith other threats, such as in this case Lokibot.\n\nIn the next post we will provide further details on how AVE_MARIA operates… and more.\n\n## Mitre ATT&CK\n\n**_ID_** **_Tecnique_** **_Tactics_**\n\n\n-----\n\n**T1036** Masquerading Defense Evasion\n\n**T1105** Remote File Copy Command And Control, Lateral Movement\n\n**T1043** Commonly Used Port Command And Control\n\n**T1060** Registry Run Keys Persistence\n\n**T1057** Process Discovery Discovery\n\n**T1065** Uncommonly Used Port Command And Control\n\n**T1088** Bypass User Access Control Defense Evasion, Privilege Escalation\n\n**T1086** Powershell Execution\n\n**T1106** Execution through API Execution\n\n**T1055** Process Injection Defense Evasion, Privilege Escalation\n\n**T1089** Disabling Security Tools Defense Evasion\n\n**T1076** Remote Desktop Protocol Lateral Movement\n\n**T1022** Data Encrypted Exfiltration\n\n## IOCs\n\n**_IOC_** **_Description_**\n\n**baaa65730d47c21a56bfcdfaced6b888b9590a96e1fd19df9c18115c0b8d1747** _Spear-_\n_phishing_\n_document_\n\n**003fd2404d515bf67c01f632014179414c8f28cfefd18fb5453c05e058825b0e** _Ave_Maria_\n_executable_\n\n**2fb2005c600243c020a5282cb20f5e5d58cd97fb1a87efb72c7e0641613be292** _Lokibot_\n_executable_\n\n**fc0c90044b94b080f307c16494369a0796ac1d4e74e7912ba79c15cca241801c** _Privesc Dll_\n_dismcore.dll_\n\n**0244cbf1fbf8809c335b9bbd8142c72e3bbb36881e0aacfba6000e0aaa048ba9** _upnp.exe_\n_(RDP)_\n_executable_\n\n**47745440509f8a374c7ce8c0c8b85213b1a40e2b86dc2cd77cb254426e1e2c7c** _hta file_\n_(Formbook)_\n\n\n-----\n\n**c4e474e869076cbf955d57568015fe56732e0b3af1592f03e023063ac2875030** _Formbook_\n_executable_\n\n**secured.icbegypt.com** _drop url_\n\n**89.46.223.202** _drop ip_\n\n**maxibrainz.warzonedns.com:2580** _AVE_MARIA_\n_C2 domain_\n\n**91.192.100.61:2580** _AVE_MARIA_\n_C2 ip_\n\n**89.46.222.77/MaX/fre.php** _Lokibot C2_\n\n**5.206.225.104** _AVE_MARIA_\n_components_\n_drop ip_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-04-11 - Ave_Maria Malware- there's more than meets the eye.pdf"
    ],
    "report_names": [
        "2019-04-11 - Ave_Maria Malware- there's more than meets the eye.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673536141,
    "ts_updated_at": 1743041280,
    "ts_creation_date": 1653760641,
    "ts_modification_date": 1653760641,
    "files": {
        "pdf": "https://archive.orkl.eu/70859428665053f3ce4ad5dca4b8faef0f8c60a7.pdf",
        "text": "https://archive.orkl.eu/70859428665053f3ce4ad5dca4b8faef0f8c60a7.txt",
        "img": "https://archive.orkl.eu/70859428665053f3ce4ad5dca4b8faef0f8c60a7.jpg"
    }
}