{
    "id": "ae08b79e-bbcd-4aa0-9147-a5f62085c052",
    "created_at": "2023-01-12T15:01:49.022699Z",
    "updated_at": "2025-03-27T02:11:51.909862Z",
    "deleted_at": null,
    "sha1_hash": "9d709f6317f690bf6f8e6b23c2fadf469b1e97a2",
    "title": "2022-02-24 - SockDetour - a Silent Fileless Socketless Backdoor - Targets US Defense Contractors",
    "authors": "",
    "file_creation_date": "2022-05-25T14:28:42Z",
    "file_modification_date": "2022-05-25T14:28:42Z",
    "file_size": 467447,
    "plain_text": "# SockDetour – a Silent, Fileless, Socketless Backdoor – Targets U.S. Defense Contractors\n\n**unit42.paloaltonetworks.com/sockdetour**\n\nBy [Unit 42](https://unit42.paloaltonetworks.com/author/unit42/)\n\nFebruary 24, 2022 at 6:00 AM\n\n[Category: Malware](https://unit42.paloaltonetworks.com/category/malware-2/)\n\nTags: [APT,](https://unit42.paloaltonetworks.com/tag/apt/) [backdoor,](https://unit42.paloaltonetworks.com/tag/backdoor/) [CVE-2021-28799,](https://unit42.paloaltonetworks.com/tag/cve-2021-28799/) [CVE-2021-40539,](https://unit42.paloaltonetworks.com/tag/cve-2021-40539/) [CVE-2021-44077,](https://unit42.paloaltonetworks.com/tag/cve-2021-44077/) [TiltedTemple,](https://unit42.paloaltonetworks.com/tag/tiltedtemple/) [Windows](https://unit42.paloaltonetworks.com/tag/windows/)\n\n[This post is also available in: 日本語 (Japanese)](https://unit42.paloaltonetworks.jp/sockdetour/)\n\n## Executive Summary\n\n\nFebruary 24, 2022\n\n\nUnit 42 has been tracking an APT campaign we name TiltedTemple, which we first identified in connection with its use of the Zoho\n[ManageEngine ADSelfService Plus vulnerability CVE-2021-40539 and ServiceDesk Plus vulnerability CVE-2021-44077. The threat actors](https://www.manageengine.com/products/self-service-password/kb/how-to-fix-authentication-bypass-vulnerability-in-REST-API.html)\ninvolved use a variety of techniques to gain access to and persistence in compromised systems and have successfully compromised more than a\ndozen organizations across the technology, energy, healthcare, education, finance and defense industries. In conducting further analysis of this\ncampaign, we identified another sophisticated tool being used to maintain persistence, which we call SockDetour.\n\nA custom backdoor, SockDetour is designed to serve as a backup backdoor in case the primary one is removed. It is difficult to detect, since it\noperates filelessly and socketlessly on compromised Windows servers. One of the command and control (C2) infrastructures that the threat\nactor used for malware distribution for the TiltedTemple campaign hosted SockDetour along with other miscellaneous tools such as a memory\ndumping tool and several webshells. We are tracking SockDetour as one campaign within TiltedTemple, but cannot yet say definitively whether\nthe activities stem from a single or multiple threat actors.\n\nBased on Unit 42’s telemetry data and the analysis of the collected samples, we believe the threat actor behind SockDetour has been focused on\ntargeting U.S.-based defense contractors using the tools. Unit 42 has evidence of at least four defense contractors being targeted by this\ncampaign, with a compromise of at least one contractor.\n\nUnit 42 also believes it is possible that SockDetour has been in the wild since at least July 2019. We did not find any additional SockDetour\nsamples on public repositories, meaning that the backdoor successfully stayed under the radar for a long time.\n\nFull visualization of the techniques observed, relevant courses of action and indicators of compromise (IoCs) related to this report can be found\n[in the Unit 42 ATOM viewer.](https://unit42.paloaltonetworks.com/atoms/tiltedtemple/)\n\n[Palo Alto Networks customers are protected from the threats described in this blog by Cortex XDR and WildFire, and can use AutoFocus for](https://www.paloaltonetworks.com/cortex/cortex-xdr)\ntracking related entities. Additionally, the YARA rule we attached at the end of this blog post can be used to detect SockDetour in memory.\n\nVulnerabilities Discussed [CVE-2021-40539,](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-40539) [CVE-2021-44077,](https://www.manageengine.com/products/service-desk/security-response-plan.html) [CVE-2021-28799](https://unit42.paloaltonetworks.com/ech0raix-ransomware-soho/)\n\nOperating System Affected Windows\n\nRelated Unit 42 Topics [TiltedTemple,](https://unit42.paloaltonetworks.com/tag/tiltedtemple/) [APT,](https://unit42.paloaltonetworks.com/tag/APT/) [backdoors](https://unit42.paloaltonetworks.com/tag/backdoor/)\n\n## Table of Contents\n\n\n-----\n\nac g ou d o t e ted e p e Ca pa g\nSockDetour Targets US Defense Industry\nSockDetour Hosted by Compromised Home and SOHO NAS Server\nAnalysis of SockDetour\nClient Authentication and C2 Communication\nPlugin Loading Feature\nConclusion\nProtections and Mitigations\nIndicators of Compromise\n\n## Background on the TiltedTemple Campaign\n\nTiltedTemple is the name Unit 42 gives to a campaign being conducted by an advanced persistent threat (APT) or APTs, leveraging a variety of\ninitial access vectors, to compromise a diverse set of targets globally. Our initial publications on TiltedTemple focused on attacks that occurred\n[through compromised ManageEngine ADSelfService Plus servers and through ManageEngine ServiceDesk Plus.](https://unit42.paloaltonetworks.com/manageengine-godzilla-nglite-kdcsponge/)\n\nThe TiltedTemple campaign has compromised organizations across the technology, energy, healthcare, education, finance and defense\nindustries and conducted reconnaissance activities against these industries and others, including infrastructure associated with five U.S. states.\n\nWe found SockDetour hosted on infrastructure associated with TiltedTemple, though we have not yet determined whether this is the work of a\nsingle threat actor or several.\n\n## SockDetour Targets US Defense Industry\n\nWhile the TitledTemple campaign was initially identified as starting in August 2021, we have recently discovered evidence that SockDetour was\ndelivered from an external FTP server to a U.S.-based defense contractor’s internet-facing Windows server on July 27, 2021.\n\nThe FTP server also hosted other miscellaneous tools used by the threat actor, such as a memory dumping tool and ASP webshells.\n\nAfter analyzing and tracking these indicators, we were able to discover that at least three other U.S.-based defense contractors were targeted by\nthe same actor.\n\n## SockDetour Hosted by Compromised Home and SOHO NAS Server\n\nThe FTP server that hosted SockDetour was a compromised Quality Network Appliance Provider (QNAP) small office and home office (SOHO)\nnetwork-attached storage (NAS) server. The NAS server is known to have multiple vulnerabilities, including a remote code execution\nvulnerability, [CVE-2021-28799. This vulnerability was leveraged by various ransomware families in massive infection campaigns in April 2021.](https://unit42.paloaltonetworks.com/ech0raix-ransomware-soho/)\nWe believe the threat actor behind SockDetour likely also leveraged these vulnerabilities to compromise the NAS server. In fact, the NAS server\nwas already infected with QLocker from the previous ransomware campaigns.\n\n## Analysis of SockDetour\n\nSockDetour is a custom backdoor compiled in 64-bit PE file format. It is designed to serve as a backup backdoor in case the primary one is\ndetected and removed. It works on Windows operating systems that are running services with listening TCP ports. It hijacks network\nconnections made to the pre-existing network socket and establishes an encrypted C2 channel with the remote threat actor via the socket.\nThus, SockDetour requires neither opening a listening port from which to receive a connection nor calling out to an external network to\nestablish a remote C2 channel. This makes the backdoor more difficult to detect from both host and network level.\n\nIn order for SockDetour to hijack an existing process’s socket, it needs to be injected into the process’s memory. For this reason, the threat\n[actor converted SockDetour into a shellcode using an open source shellcode generator called Donut framework, then used the PowerSploit](https://github.com/TheWover/donut)\nmemory injector to inject the shellcode into target processes. The samples we found contained hardcoded target processes’ IDs, which means\nthe threat actor manually chose injection target processes from compromised servers.\n\n[After SockDetour is injected into the target process, the backdoor leverages the Microsoft Detours library package, which is designed for the](https://github.com/microsoft/Detours)\nmonitoring and instrumentation of API calls on Windows to hijack a network socket. Using the DetourAttach() function, it attaches a hook to\nthe Winsock accept() function. With the hook in place, when new connections are made to the service port and the Winsock accept() API\nfunction is invoked, the call to the accept() function is re-routed to the malicious detour function defined in SockDetour.\n\nOther non-C2 traffic is returned to the original service process to ensure the targeted service operates normally without interference.\n\nWith such implementation, SockDetour is able to operate filelessly and socketlessly in compromised Windows servers, and serves as a backup\nbackdoor in case the primary backdoor is detected and removed by defenders.\n\n\n-----\n\nFigure 1. SockDetour Workflow\n\n## Client Authentication and C2 Communication\n\nAs SockDetour hijacks all the connections made to the legitimate service port, it first needs to verify the C2 traffic from incoming traffic that is\nmixed with legitimate service traffic, then authenticate to make sure the C2 connection is made from the right client.\n\nSockDetour achieves the verification and authentication of the C2 connection with the following steps.\n\n1. First, expect to receive 137 bytes of data from a client for authentication. The authentication data is as shown in the structure in Table 1.\n\n**_17 03 03_** **_AA BB_** **_CC DD EE FF_** **_128-byte data block_**\n\n\n_Fixed header value to disguise TLS_\n_traffic_\n\n\n_Payload data_\n_size_\n\n\n_Four-byte variable used for client_\n_authentication_\n\n\n_Data signature for client authentication_\n_data block_\n\n\n_Table 1. SockDetour client authentication data structure._\n\n2. Read the first nine bytes of data. This data is received using the recv() function with the MSG_PEEK option so that it will not interfere with\nthe legitimate service’s traffic by removing data from the socket queue.\n\n3. Verify that the data starts with 17 03 03, which is commonly seen as a record header for TLS transactions when encrypted data is being\ntransferred. However, this is abnormal for normal TLS – a TLS-encrypted transaction would not normally show up without proper TLS\nhandshakes.\n\nFigure 2. SockDetour receives data with the MSG_PEEK option and verifies the data.\n\n4. Check that the size of payload data AA BB is less than or equal to 251.\n\n5. Check that the four bytes of payload CC DD EE FF satisfy the conditions below:\n\n1. The result is 88 a0 90 82 after bitwise AND with 88 a0 90 82\n2. The result is fd f5 fb ef after bitwise OR with fd f5 fb ef\n\n6. Read the whole 137 bytes of data from the same data queue with the MSG_PEEK option for further authentication.\n\n7. Build a 24-byte data block as shown in Table 2.\n\n\n-----\n\n**_08 1c c1 78 d4 13 3a d7 0f ab_** **_CC DD EE FF_** **_b3 a2 b8 ae 63 bb 03 e8 ff 3b_**\n\n10 bytes hardcoded in SockDetour Four bytes received from the client for authentication 10 bytes hardcoded in SockDetour\n\n_Table 2. 24-byte data block to be verified for client authentication._\n\n8. This 24-byte data block is hashed and verified using an embedded public key against the 128-byte data signature in Table 1, which the threat\nactor would have created by signing the hash of the same 24-byte data block using the corresponding private key.\n\nThis completes the client authentication step. After successful authentication, SockDetour takes over the TCP session using the recv() function\nwithout the MSG_PEEK option as this session is now verified to be for the backdoor.\n\nNext, SockDetour creates a 160-bit session key using a hardcoded initial vector value bvyiafszmkjsmqgl, then sends it to the remote client using\nthe following data structure.\n\n**_17 03 03_** **_AA BB_** **_CC DD EE FF_** **_session_key_** **_random_padding_**\n\n_Fixed header value to disguise TLS traffic_ Payload data size Session key length 160-bit session key Random padding\n\n_Table 3. SockDetour sending session key to client._\n\nIn common encryption protocols such as TLS, the session key is encrypted with a public key before transferring. However, in this case, the\nmalware author has seemingly forgotten the step and transfers the key in plain text.\n\nNow with the session key shared between SockDetour and the remote client, the C2 connection is made encrypted over the hijacked socket.\n\n## Plugin Loading Feature\n\nAs a backup backdoor, SockDetour serves only one feature of loading a plugin DLL. After the session key sharing, SockDetour receives four\nbytes of data from the client, which indicates the length of data SockDetour will receive for the final payload delivery stage. The size is expected\nto be smaller or equal to five MB.\n\nThe final payload data received is encrypted using the shared session key. After decryption, the received data is expected to be in JSON format\nwith two objects app and args. app contains a base 64-encoded DLL, and args contains an argument to be passed to the DLL. SockDetour loads\nthis plugin DLL in newly allocated memory space, then calls an export function with the name ThreadProc with a function argument in the\nfollowing JSON structure.\n\n\n1\n2\n3\n4\n5\n\n\n{\n\"sock\": hijacked_socket,\n\"key\": session_key,\n\"args\": arguments_received_from_client\n}\n\n\nWhile plugin DLL samples were not discovered, the above function argument suggests that the plugin also likely communicates via the hijacked\nsocket and encrypts the transaction using the session key. Thus, we surmise it operates as stealthily as SockDetour does.\n\n## Conclusion\n\nSockDetour is a backdoor that is designed to remain stealthily on compromised Windows servers so that it can serve as a backup backdoor in\ncase the primary one fails. It is filelessly loaded in legitimate service processes and uses legitimate processes’ network sockets to establish its\nown encrypted C2 channel.\n\nWhile it can be easily altered, the compilation timestamp of the SockDetour sample we analyzed suggests that it has likely been in the wild\nsince at least July 2019 without any update to the PE file. Plus, we did not find any additional SockDetour samples on public repositories. This\nsuggests that the backdoor successfully stayed under the radar for a long time.\n\nThe plugin DLL remains unknown, but it is also expected to operate very stealthily by being delivered via the SockDetour’s encrypted channel,\nbeing loaded filelessly in memory and communicating via hijacked sockets.\n\nAs an additional note, the type of NAS server that we found hosting SockDetour is typically used by small businesses. This example serves as a\ncritical reminder to patch this type of server frequently when fixes are released.\n\n## Protections and Mitigations\n\n[Cortex XDR protects endpoints and accurately identifies the memory injector as malicious. Additionally, Cortex XDR has several detections for](https://unit42.paloaltonetworks.com/tiltedtemple-manageengine-servicedesk-plus/#:~:text=with%20this%20campaign%3A-,Threat%20Prevention,-provides%20protection%20against)\nlateral movement and credential theft tactics, techniques and procedures (TTPs) employed by this actor set.\n\n[WildFire cloud-based threat analysis service accurately identifies the injector used in this campaign as malicious.](https://www.paloaltonetworks.com/products/secure-the-network/wildfire)\n\n\n-----\n\nuto ocus custo e s ca t ac Soc etou act v ty v a t e Soc etou tag.\n\nWe advise server administrators to keep Windows servers up to date.\n\nThe YARA rule attached at the end of this blog can be used to detect the presence of SockDetour in memory.\n\nOrganizations should conduct an incident response investigation if they think they are compromised by SockDetour. If you think you may have\n[been compromised or have an urgent matter, get in touch with the Unit 42 Incident Response team or call North America Toll-Free:](http://start.paloaltonetworks.com/contact-unit42.html)\n866.486.4842 (866.4.UNIT42), EMEA: +31.20.299.3130, APAC: +65.6983.8730 or Japan: +81.50.1790.0200.\n\n## Indicators of Compromise\n\n### SockDetour PE\n\n0b2b9a2ac4bff81847b332af18a8e0705075166a137ab248e4d9b5cbd8b960df\n\n### PowerSploit Memory Injectors Delivering SockDetour\n\n80ed7984a42570d94cd1b6dcd89f95e3175a5c4247ac245c817928dd07fc9540\n\nbee2fe0647d0ec9f2f0aa5f784b122aaeba0cddb39b08e3ea19dd4cdb90e53f9\n\na5b9ac1d0350341764f877f5c4249151981200df0769a38386f6b7c8ca6f9c7a\n\n607a2ce7dc2252e9e582e757bbfa2f18e3f3864cb4267cd07129f4b9a241300b\n\n11b2b719d6bffae3ab1e0f8191d70aa1bade7f599aeadb7358f722458a21b530\n\ncd28c7a63f91a20ec4045cf40ff0f93b336565bd504c9534be857e971b4e80ee\n\nebe926f37e7188a6f0cc85744376cdc672e495607f85ba3cbee6980049951889\n\n3ea2bf2a6b039071b890f03b5987d9135fe4c036fb77f477f1820c34b341644e\n\n7e9cf2a2dd3edac92175a3eb1355c0f5f05f47b7798e206b470637c5303ac79f\n\nbb48438e2ed47ab692d1754305df664cda6c518754ef9a58fb5fa8545f5bfb9b\n\n### Public Key Embedded in SocketDetour\n\n-----BEGIN PUBLIC KEY----MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDWD9BUhQQZkagIIHsCdn/wtRNXcYoEi3Z4PhZkH3mar20EONVyXWP/YUxyUmxD+aT\n----END PUBLIC KEY----\n### YARA Rule for Detecting SockDetour in Memory\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nrule apt_win_sockdetour\n{\nmeta:\nauthor = \"Unit 42 - PaloAltoNetworks\"\ndate = \"2022-01-23\"\ndescription = \"Detects SockDetour in memory or in PE format\"\nhash01 = \"0b2b9a2ac4bff81847b332af18a8e0705075166a137ab248e4d9b5cbd8b960df\"\n\nstrings:\n$public_key =\n\"MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDWD9BUhQQZkagIIHsCdn/wtRNXcYoEi3Z4PhZkH3mar20EONVyXWP/YUxyUmxD\n$json_name_sequence = {61 70 70 00 61 72 67 73 00 00 00 00 73 6F 63 6B 00 00 00 00 6B 65 79 00 61 72 67 73 00 00}\n$verification_bytes = {88 [4] A0 [4] 90 [4] 82 [4] FD [4] F5 [4] FB [4] EF}\n$data_block = {08 [4] 1C [4] C1 [4] 78 [4] D4 [4] 13 [4] 3A [4] D7 [4] 0F [4] AB [4] B3 [4] A2 [4] B8 [4] AE [4] 63 [4] BB [4] 03 [4] E8 [4] FF [4] 3\n$initial_vector = {62 [4] 76 [4] 79 [4] 69 [4] 61 [4] 66 [4] 73 [4] 7A [4] 6D [4] 6B [4] 6A [4] 73 [4] 6D [4] 71 [4] 67 [4] 6C}\n\ncondition:\nany of them\n}\n\n\n**Get updates from Palo Alto Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-24 - SockDetour - a Silent Fileless Socketless Backdoor - Targets US Defense Contractors.pdf"
    ],
    "report_names": [
        "2022-02-24 - SockDetour - a Silent Fileless Socketless Backdoor - Targets US Defense Contractors.pdf"
    ],
    "threat_actors": [
        {
            "id": "0a80df4d-5ab7-4ca3-809d-8ef7b5a54f1f",
            "created_at": "2023-11-21T02:00:07.386886Z",
            "updated_at": "2025-03-27T02:00:03.248375Z",
            "deleted_at": null,
            "main_name": "TiltedTemple",
            "aliases": [
                "DEV-0322",
                "Circle Typhoon"
            ],
            "source_name": "MISPGALAXY:TiltedTemple",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535709,
    "ts_updated_at": 1743041511,
    "ts_creation_date": 1653488922,
    "ts_modification_date": 1653488922,
    "files": {
        "pdf": "https://archive.orkl.eu/9d709f6317f690bf6f8e6b23c2fadf469b1e97a2.pdf",
        "text": "https://archive.orkl.eu/9d709f6317f690bf6f8e6b23c2fadf469b1e97a2.txt",
        "img": "https://archive.orkl.eu/9d709f6317f690bf6f8e6b23c2fadf469b1e97a2.jpg"
    }
}