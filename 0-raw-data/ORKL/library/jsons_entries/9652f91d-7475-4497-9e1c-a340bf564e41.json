{
    "id": "9652f91d-7475-4497-9e1c-a340bf564e41",
    "created_at": "2023-01-12T15:10:58.489521Z",
    "updated_at": "2025-03-27T02:09:18.284937Z",
    "deleted_at": null,
    "sha1_hash": "d4e905f3d556e0d4b82cc0a108f7bbe134f2081e",
    "title": "2022-07-21 - LockBit 3.0 Update - Unpicking the Ransomware’s Latest Anti-Analysis and Evasion Techniques",
    "authors": "",
    "file_creation_date": "2022-08-18T03:30:33Z",
    "file_modification_date": "2022-08-18T03:30:33Z",
    "file_size": 1240565,
    "plain_text": "# LockBit 3.0 Update | Unpicking the Ransomware’s Latest Anti-Analysis and Evasion Techniques\n\n**[sentinelone.com/labs/lockbit-3-0-update-unpicking-the-ransomwares-latest-anti-analysis-and-evasion-techniques/](https://www.sentinelone.com/labs/lockbit-3-0-update-unpicking-the-ransomwares-latest-anti-analysis-and-evasion-techniques/)**\n\nJim Walter\n\n**By Jim Walter & Aleksandar Milenkoski**\n\nLockBit 3.0 ransomware (aka LockBit Black) is an evolution of the prolific LockBit\nransomware-as-a-service (RaaS) family, which has roots that extend back to [BlackMatter](https://www.cisa.gov/uscert/ncas/alerts/aa21-291a)\n[and related entities. After critical bugs were discovered in LockBit 2.0 in March 2022, the](https://techcommunity.microsoft.com/t5/security-compliance-and-identity/part-1-lockbit-2-0-ransomware-bugs-and-database-recovery/ba-p/3254354)\nauthors began work on updating their encryption routines and adding several new features\ndesigned to thwart researchers. In June 2022, LockBit 3 caught the interest of the media as\nthe ransomware operators announced they were offering a ‘bug bounty’ to researchers. In\nthis post, we provide an overview of the LockBit 3.0 ransomware update and offer a technical\ndive for researchers into LockBit 3.0’s anti-analysis and evasion features.\n\n## LockBit 3.0 Changes and New Features Since LockBit 2.0\n\nAround June of 2022, operators and affiliates behind LockBit ransomware began the shift to\nLockBit 3.0. Adoption of LockBit 3.0 by affiliates has been rapid, and numerous victims have\nbeen identified on the new “Version 3.0” leak sites, a collection of public blogs naming noncompliant victims and leaking extracted data.\n\n\n-----\n\nLockBit 3 ransomware leaks site\nIn order to improve resilience, the operators have been aggressive with regards to standing\nup multiple mirrors for their leaked data and publicizing the site URLs.\n\nLockBit has also added an instant search tool to their leaks site.\n\nUpdated LockBit leak site with new Search feature\nThe authors of LockBit 3.0 have introduced new management features for affiliates and\nadded Zcash for victim payments in addition to Monero and Bitcoin.\n\n\n-----\n\nThe ransomware authors also claim to have opened a public bug bounty program.\nOstensibly, this appears to be an effort to improve the quality of the malware, and financially\nreward those that assist.\n\nLockbit ransomware group announced today Lockbit 3.0 is officially released with the\nmessage: \"Make Ransomware Great Again!\"\n\nAdditionally, Lockbit has launched their own Bug Bounty program paying for PII on\nhigh-profile individuals, web security exploits, and more…\n[pic.twitter.com/ByNFdWe4Ys](https://t.co/ByNFdWe4Ys)\n\n[— vx-underground (@vxunderground) June 26, 2022](https://twitter.com/vxunderground/status/1541156954214727685?ref_src=twsrc%5Etfw)\n\nOn top of that, there is a purported $1 million reward on offer to anyone who can uncover the\nidentity of the program affiliate manager. Understandably, given the criminal nature of the\noperators, would-be researchers may find that reporting bugs to a crimeware outfit may not\nlead to the promised payout but could lead to criminal charges from law enforcement.\n\n## LockBit 3.0 Payloads and Encryption\n\nThe updated LockBit payloads retain all the prior functionality of LockBit 2.0.\n\nInitial delivery of the LockBit ransomware payloads is typically handled via 3rd party\nframeworks such as Cobalt Strike. As with LockBit 2.0, we have seen infections occur down\n[the chain from other malware components as well, such as a SocGholish infection dropping](https://www.sentinelone.com/labs/wastedlocker-ransomware-abusing-ads-and-ntfs-file-attributes/)\nCobalt Strike, which in turn delivers the LockBit 3 ransomware.\n\nThe payloads themselves are standard Windows PE files with strong similarities to prior\ngenerations of LockBit as well as BlackMatter ransomware families.\n\n\n-----\n\nPEStudio view of LockBit 3.0 Payload\nLockBit ransomware payloads are designed to execute with administrative privileges. In the\nevent that the malware does not have the necessary privileges, a UAC bypass will be\n[attempted (CMSTP).](https://attack.mitre.org/techniques/T1218/003/)\n\nLockBit 3.0 achieves persistence via installation of System Services. Each execution of the\npayload will install multiple services. We have observed the following service names in\nconjunction with LockBit 3.0 ransomware payloads.\n```\nSecurityHealthService\n\nSense\n\nsppsvc\n\nWdBoot\n\nWdFilter\n\nWdNisDrv\n\nWdNisSvc\n\nWinDefend\n\nwscsvc\n\nvmicvss\n\nvmvss\n\nVSS\n\nEventLog\n\n\n```\nAs with previous versions, LockBit 3.0 will attempt to identify and terminate specific services\nif found. The following service names are targeted for termination in analyzed LockBit 3.0\nsamples:\n\n\n-----\n\n```\nbackup\n\nGxBlr\n\nGxCIMgr\n\nGxCVD\n\nGxFWD\n\nGxVss\n\nmemtas\n\nmepocs\n\nmsexchange\n\nsophos\n\nsql\n\nsvc$\n\nveeam\n\nvss\n\n```\nIn addition, the following processes are targeted for termination:\n```\nagntsvc\n\ndbeng50\n\ndbsnmp\n\nencsvc\n\nexcel\n\nfirefox\n\ninfopath\n\nisqlplussvc\n\nmsaccess\n\nmspub\n\nmydesktopqos\n\nmydesktopservice\n\nnotepad\n\nocautoupds\n\nocomm\n\nocssd\n\nonenote\n\noracle\n\noutlook\n\npowerpnt\n\nregistry\n\nsqbcoreservice\n\nsteam\n\nsynctime\n\ntbirdconfig\n\nthebat\n\nthunderbird\n\nvisio\n\nwinword\n\nwordpad\n\nxfssvccon\n\n\n```\nLockBit 3.0 writes a copy of itself to the `%programdata% directory, and subsequently`\nlaunches from this process.\n\n\n-----\n\nThe encryption phase is extremely rapid, even when spreading to adjacent hosts. The\nransomware payloads were able to fully encrypt our test host in well under a minute.\n\nOn execution, the LockBit 3.0 ransomware will drop newly-formatted ransom notes along\nwith a change to the desktop background. Interestingly, notepad and wordpad are included in\nthe list of prescribed processes as noted above. Therefore, if a victim attempts to open the\nransom note immediately after it is dropped, it will promptly close since the process is\nblocked until the ransomware completes its execution.\n\nThe new LockBit 3.0 ransomware desktop wallpaper is a simple text message on a black\nbackground.\n\nLockBit 3.0 Desktop Wallpaper\nThe extension appended to newly encrypted files will also differ per campaign or sample.\nFor example, we have seen “HLJkNskOq” and “futRjC7nx”. Both encrypted files and the\nransom notes will be prepended with the campaign-specific string.\n```\nfutRjC7nx.README\n\nHLJkNskOq.README\n\n\n```\nDuring our analysis, we observed infected machines shutting down ungracefully\napproximately 10 minutes after the ransomware payload was launched. This behavior may\nvary per sample, but it is worth noting.\n\nPost-infection, LockBit 3.0 victims are instructed to make contact with their attacker via their\nTOR-based “support” portal.\n\n\n-----\n\nLockBit 3.0 Ransom Note Excerpt\n\n## LockBit 3 Anti-Analysis & Evasion\n\nThe LockBit 3.0 ransomware uses a variety of anti-analysis techniques to hinder static and\n[dynamic analysis, and exhibits similarities to the BlackMatter ransomware in this regard.](https://www.youtube.com/watch?v=aDtoxdLhTTk)\nThese techniques include code packing, obfuscation and dynamic resolution of function\naddresses, function trampolines, and anti-debugging techniques. In this section, we cover\nsome of the anti-analysis techniques that LockBit 3.0 uses.\n\nLockBit 3.0 payloads require a specific passphrase to execute. The passphrase is unique to\neach sample or campaign and serves to hinder dynamic and sandbox analysis if the\npassphrase has not been recovered along with the sample. A similar technique has been\n[used by Egregor and](https://www.sentinelone.com/labs/egregor-raas-continues-the-chaos-with-cobalt-strike-and-rclone/) [BlackCat ransomware. The passphrase is provided upon execution via](https://www.sentinelone.com/labs/blackcat-ransomware-highly-configurable-rust-driven-raas-on-the-prowl-for-victims/)\nthe `-pass parameter. For example,`\n```\nlockbit.exe -pass XX66023ab2zyxb9957fb01de50cdfb6\n\n\n```\nEncrypted content located in the LockBit 3.0 payload is decrypted at runtime using an XOR\nmask. The images below show the content of the ransomware’s `.text executable segment`\nbefore (label 1) and after (label 2) the ransomware has decrypted the segment content. The\n```\n.text segment starts at the virtual address 0x401000.\n\n```\n\n-----\n\nThe content of the ransomware’s .text\n\nexecutable segment\nLockBit 3.0 also first stores in heap memory and then uses trampolines for executing\nfunctions, for example, the Windows system calls `NtSetInformationThread and`\n```\nZwProtectVirtualMemory . The ransomware obfuscates the function addresses that the\n\n```\ntrampolines execute using the XOR and/or bit rotation obfuscation technique.\n\n\n-----\n\nSome of the function trampolines\n\nLockBit 3.0 implements\nSeveral techniques are implemented for detecting the presence of a debugger and hindering\ndynamic analysis. For example, the ransomware evaluates whether heap memory\nparameters that indicate the presence of a debugger are set. Such flags are\nHEAP_TAIL_CHECKING_ENABLED (0x20) and\nHEAP_VALIDATE_PARAMETERS_ENABLED (0x40000000).\n\nLockBit 3.0 examines the `ForceFlags value in its PEB (Process Environment Block) to`\nevaluate whether HEAP_VALIDATE_PARAMETERS_ENABLED is set.\n\nLockBit 3.0 evaluates whether\n\nHEAP_VALIDATE_PARAMETERS_ENABLED is set\nThe ransomware also evaluates whether the `0xABABABAB byte signature is present at the`\nend of heap memory blocks that it has previously allocated. The presence of this byte\nsignature means that HEAP_TAIL_CHECKING_ENABLED is set.\n\nLockBit 3.0 evaluates whether\n\nHEAP_TAIL_CHECKING_ENABLED is set\n\n\n-----\n\n[The LockBit 3.0 ransomware executes the NtSetInformationThread function through a](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntsetinformationthread)\ntrampoline, such that the `ThreadHandle and` `ThreadInformationClass function`\nparameters have the values of 0xFFFFFFFE and 0x11 ( ThreadHideFromDebugger ). This\nstops the flow of events from the current ransomware’s thread to an attached debugger,\nwhich effectively hides the thread from the debugger and hinders dynamic analysis.\n\nLockBit 3.0 executes NtSetInformationThread\nIn addition, LockBit scrambles the implementation of the `DbgUiRemoteBreakin function to`\ndisable debuggers trying to attach to the ransomware process. When it executes, LockBit 3.0\nransomware:\n\nResolves the address of `DbgUiRemoteBreakin .`\nExecutes the `ZwProtectVirtualMemory function through a trampoline to apply the`\nPAGE_EXECUTE_READWRITE (0x40) protection to the first 32 bytes of the memory\nregion where the implementation of `DbgUiRemoteBreakin resides. This makes the`\nbytes writable.\nExecutes the `SystemFunction040` [(RtlEncryptMemory) function through a trampoline](https://docs.microsoft.com/en-us/windows/win32/api/ntsecapi/nf-ntsecapi-rtlencryptmemory)\nto encrypt the bytes that the ransomware has previously made writable. This scrambles\nthe implementation of the `DbgUiRemoteBreakin function and disables debuggers to`\nattach to the ransomware process.\n\n\n-----\n\nLockBit 3.0 modifies the implementation of the DbgUiRemoteBreakin function\n\nThe images below depict the implementation of the `DbgUiRemoteBreakin function before`\n(label 1) and after (label 2) the LockBit 3.0 ransomware has modified the implementation of\nthe function.\n\n\n-----\n\nThe implementation of the\n\n_DbgUiRemoteBreakin function_\n\n## Conclusion\n\nLockBit has fast become one of the more prolific ransomware-as-a-service operators out\n[there, taking over from Conti after the latter’s fractious fallout in the wake of the](https://www.sentinelone.com/labs/conti-unpacked-understanding-ransomware-development-as-a-response-to-detection/) Russian\ninvasion of Ukraine.\n\n\n-----\n\nLockBit s developers have shown that they are quick to respond to problems in the product\nthey are offering and that they have the technical know-how to keep evolving. The recent\nclaim to be offering a ‘bug bounty’, whatever its true merits, displays a savvy understanding\nof their own audience and the media landscape that surrounds the present tide of crimeware\nand enterprise breaches.\n\nShort of intervention by law enforcement, we expect to see LockBit around for the forseeable\nfuture and further iterations of what is undoubtedly a very successful RaaS operation. As\nwith all ransomware, prevention is better than cure, and defenders are encouraged to ensure\nthat they have [comprehensive ransomware protection in place. SentinelLabs will continue to](https://www.sentinelone.com/platform/)\noffer updates and reports on LockBit activity as it develops.\n\n## Indicators of Compromise\n\n**SHA256**\n\nf9b9d45339db9164a3861bf61758b7f41e6bcfb5bc93404e296e2918e52ccc10\n\na56b41a6023f828cccaaef470874571d169fdb8f683a75edd430fbd31a2c3f6e\n\nd61af007f6c792b8fb6c677143b7d0e2533394e28c50737588e40da475c040ee\n\n**SHA1**\n\nced1c9fabfe7e187dd809e77c9ca28ea2e165fa8\n\n371353e9564c58ae4722a03205ac84ab34383d8c\n\nc2a321b6078acfab582a195c3eaf3fe05e095ce0\n\n**.ONION domains**\n\nlockbitapt2d73krlbewgv27tquljgxr33xbwwsp6rkyieto7u4ncead[.]onion\n\nlockbitapt2yfbt7lchxejug47kmqvqqxvvjpqkmevv4l3azl3gy6pyd[.]onion\n\nlockbitapt34kvrip6xojylohhxrwsvpzdffgs5z4pbbsywnzsbdguqd[.]onion\n\nlockbitapt5x4zkjbcqmz6frdhecqqgadevyiwqxukksspnlidyvd7qd[.]onion\n\nlockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd[.]onion\n\nlockbitapt72iw55njgnqpymggskg5yp75ry7rirtdg4m7i42artsbqd[.]onion\n\nlockbitaptawjl6udhpd323uehekiyatj6ftcxmkwe5sezs4fqgpjpid[.]onion\n\nlockbitaptbdiajqtplcrigzgdjprwugkkut63nbvy2d5r4w2agyekqd[.]onion\n\nlockbitaptc2iq4atewz2ise62q63wfktyrl4qtwuk5qax262kgtzjqd[.]onion\n\nlockbit7z2jwcskxpbokpemdxmltipntwlkmidcll2qirbu7ykg46eyd[.]onion\n\nlockbitsupa7e3b4pkn4mgkgojrl5iqgx24clbzc4xm7i6jeetsia3qd[.]onion\n\nlockbitsupdwon76nzykzblcplixwts4n4zoecugz2bxabtapqvmzqqd[.]onion\n\nlockbitsupn2h6be2cnqpvncyhj4rgmnwn44633hnzzmtxdvjoqlp7yd[.]onion\n\nlockbitsupo7vv5vcl3jxpsdviopwvasljqcstym6efhh6oze7c6xjad[.]onion\nlockbitsupq3g62dni2f36snrdb4n5qzqvovbtkt5xffw3draxk6gwqd[.]onion\n\nlockbitsupqfyacidr6upt6nhhyipujvaablubuevxj6xy3frthvr3yd[.]onion\n\n\n-----\n\nlockbitsupt7nr3fa6e7xyb73lk6bw6rcneqhoyblniiabj4uwvzapqd[.]onion\nlockbitsupuhswh4izvoucoxsbnotkmgq6durg7kficg6u33zfvq3oyd[.]onion\n\nlockbitsupxcjntihbmat4rrh7ktowips2qzywh6zer5r3xafhviyhqd[.]onion\n\n**MITRE ATT&CK**\n\n[T1547.001 – Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder](https://attack.mitre.org/techniques/T1547/001/)\n\n[T1543.003 – Create or Modify System Process: Windows Service](https://attack.mitre.org/techniques/T1543/003/)\n\n[T1055 – Process Injection](https://attack.mitre.org/techniques/T1055/)\n\n[T1070.001 – Indicator Removal on Host: Clear Windows Event Logs](https://attack.mitre.org/techniques/T1070/001/)\n\n[T1622 – Debugger Evasion](https://attack.mitre.org/techniques/T1622/)\n\n[T1548.002 – Abuse Elevation Control Mechanism: Bypass User Account Control](https://attack.mitre.org/techniques/T1548/002/)\n\n[T1485 – Data Destruction](https://attack.mitre.org/techniques/T1485/)\n\n[T1489 – Service Stop](https://attack.mitre.org/techniques/T1489/)\n\n[T1490 – Inhibit System Recovery](https://attack.mitre.org/techniques/T1490/)\n\n[T1003.001 – OS Credential Dumping: LSASS Memory](https://attack.mitre.org/techniques/T1003/001/)\n\n[T1078.002 – Valid Accounts: Domain Accounts](https://attack.mitre.org/techniques/T1078/002/)\n\n[T1078.001 – Valid Accounts: Default Accounts](https://attack.mitre.org/techniques/T1078/001/)\n\n[T1406.002 – Obfuscated Files or Information: Software Packing](https://attack.mitre.org/techniques/T1406/002/)\n\n[T1218.003 – System Binary Proxy Execution: CMSTP](https://attack.mitre.org/techniques/T1218/003/)\n\n[T1047 – Windows Management Instrumentation](https://attack.mitre.org/techniques/T1047/)\n\n[T1119 – Automated Collection](https://attack.mitre.org/techniques/T1119/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-07-21 - LockBit 3.0 Update - Unpicking the Ransomware’s Latest Anti-Analysis and Evasion Techniques.pdf"
    ],
    "report_names": [
        "2022-07-21 - LockBit 3.0 Update - Unpicking the Ransomware’s Latest Anti-Analysis and Evasion Techniques.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536258,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1660793433,
    "ts_modification_date": 1660793433,
    "files": {
        "pdf": "https://archive.orkl.eu/d4e905f3d556e0d4b82cc0a108f7bbe134f2081e.pdf",
        "text": "https://archive.orkl.eu/d4e905f3d556e0d4b82cc0a108f7bbe134f2081e.txt",
        "img": "https://archive.orkl.eu/d4e905f3d556e0d4b82cc0a108f7bbe134f2081e.jpg"
    }
}