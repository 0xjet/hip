{
    "id": "dbfe33e1-6054-42cc-84b8-d2e748362fc0",
    "created_at": "2023-01-12T14:58:57.73453Z",
    "updated_at": "2025-03-27T02:05:44.519038Z",
    "deleted_at": null,
    "sha1_hash": "851fb8199000fdee88f1850e84fe64eaf0b33b74",
    "title": "2020-08-27 - Smokeloader Analysis and More Family Detections",
    "authors": "",
    "file_creation_date": "2022-05-27T22:59:57Z",
    "file_modification_date": "2022-05-27T22:59:57Z",
    "file_size": 456677,
    "plain_text": "# Smokeloader Analysis and More Family Detections\n\n**hatching.io/blog/tt-2020-08-27/**\n\n2020-08-27\n\ntriage\n\nWritten by\n\nPete Cowman\n\nIn this week’s Triage Thursday blog, we’ll cover a number of minor updates to family\n[classification introduced in the past week, and @Casperinous goes](https://twitter.com/Casperinous) under-the-hood with\nrecent changes observed in SmokeLoader samples.\n\nOver the past few days we have released another batch of smaller detection updates,\naffecting several families. The main focus has been on ransomware and stealers, adding\nfamily-specific detection for samples recently seen in the wild.\n\n\n-----\n\nRead on below for more information on each of these topics.\n\n[Not signed up yet? Head over to https://tria.ge/ and register right away!](https://tria.ge/)\n\n## SmokeLoader Analysis\n\nSmokeloader is a downloader/backdoor which has been active since 2011. Over the years it\nhas evolved both its capabilities and the variety of malware it downloads to the infected host.\nIn this post we will have a look at what’s changed since the most recent analysis by\nCheckpoint and present the new features introduced in 2020.\n\n**Smokeloader Analyses:**\n\n[200827-m1jren2nas](https://tria.ge/200827-m1jren2nas/behavioral1)\n[200827-6x7fdlj8y2](https://tria.ge/200827-6x7fdlj8y2/behavioral1)\n[200827-v6tcrvw9es](https://tria.ge/200827-v6tcrvw9es/behavioral1)\n\n### New Anti-VM methods\n\n**Detection of unsigned drivers**\n\nSmokeloader introduced 2 new anti-VM checks closely associated with the gaming\ncommunity.\n\nThe first one checks if the executable’s path contains the string `[A-F0-9]{4}.vmt . Also, if`\nthe architecure of the system is 64-bit, `NtQuerySystemInformation is called with the first`\nargument set to `0x67 ( SystemCodeIntegrityInformation ). After the call,` `ESI points`\nto the `SYSTEM_CODEINTEGRITY_INFORMATION . The check` `[ESI+4] confirms if the struct’s`\n```\nCodeIntegrityOptions member is equal to 0x2 . Based on some public information it is\n\n```\nassumed that this check is intended to detect the Driver Signing Policy of the infected host if the value is indeed equal with `0x2 an unsigned kernel driver can be installed, a common`\nconfiguration for sandboxes.\n\nThe check is not well implemented - instead of comparing if the variable is equal with `0x2,`\nit should be using a `TEST instruction to figure out if the` `0x2 flag is used.`\n\n\n-----\n\n**Detection of loaded DLLs**\n\nSmokeloader also extended the list of loaded DLLs that it checks for. Going by previous\nanalyses Smokeloader was only checking for sbiedll, but it was observed that in 2020 it is\nalso looking for:\n\naswhook\nsnxhw\n\n**Detection of processes associated with virtualization software**\n\nSomething that is common in various packers/loaders is checking the running processes\nagainst an array of predefined strings, in order to check virtualized environments.\nSmokeloader has implemented the same check, by calling `NtQuerySystemInformation`\nwith the first parameter set to `0x5 ( SystemProcessInformation ) in order to get all the`\nrunning processes. Then there is a loop where every process is converted to lowercase and\nis checked with `wcsstr to see if it contains the following strings:`\n\nL\"qemu-ga.exe”\nL\"qga.exe”\nL\"windanr.exe”\nL\"vboxservice.exe”\nL\"vboxtray.exe”\nL\"vmtoolsd.exe”\nL\"prl_tools.exe”\n\n\n-----\n\n**Detection of files associated with virtualization software**\n\nAnother technique employed by Smokeloader is checking the `System32 folder for files that`\nare associated with virtualization software. This is again done by calling\n```\nNtQuerySystemInformation with the first argument 0xB ( SystemModuleInformation ).\n\n```\nThen, following the previous logic, there is a loop where every file in the aforementioned\nlocation is converted to lowercase and checked by calling `strstr if it contains the following`\nstrings:\n\n“vmci.s”\n“vmusbm”\n“vmmous”\n“vm3dmp”\n“vmrawd”\n“vmmemc”\n“vboxgu”\n“vboxsf”\n“vboxmo”\n“vboxvi”\n“vboxdi”\n“vioser”\n\nAfter successfully passing the aforementioned checks, Smokeloader must determine the\nsystem’s architecture. This is done by using the `gs register and a test instruction. For our`\nown convenience, we patched the check in order for Smokeloader to decompress the 32-bit\npayload and continue the analysis. While it was common for Smokeloader to utilize\nPropagate to inject the payload in `explorer.exe, in the 2020 version it is still injecting into`\nthis process but it using a more typical combination of NtCreateSection,\n```\nNtMapViewOfSection and RtlCreateUserThread to start the execution.\n\n```\n\n-----\n\n### Changes in the payload\n\n**Increased size of random data buffer**\n\n[Smokeloader introduced the usage of randomly generated data in 2019, possibly in order to](https://research.checkpoint.com/2019/2019-resurgence-of-smokeloader/)\nfool IDS/IPS systems. The size of the buffer is calculated randomly but is set to be at most\n```\n0x104 . Then, the number is used to allocate heap space and fill it with randomly generated\n\n```\nlowercase letters. The generated string is appended at the end of the packet structure.\n\n### Change in communication traffic\n\nAs was [discovered in early March, the communication packet structure of Smokeloader has](https://twitter.com/ESETresearch/status/1236925773778489344?s=20)\nbeen extended by `0x10 bytes. In the new struct, after the` `bot_id member, there is a new`\nfield allocated to hold the name of the infected host. There is also now a check to either\nappend the random data or the additional data at the end of the `pkc struct. The new struct`\nis now defined like this:\n\n\n-----\n\n```\nstruct pkc {\n   WORD magic\n   BYTE[40] bot_id\n   BYTE[16] comp_name\n   BYTE[6] botnet_id\n   BYTE os_ver\n   BYTE sec_flag_1\n   BYTE sec_flag_2\n   WORD comm_id\n   DWORD task_idx\n   DWORD tmp_path_run\n   BYTE[n] extra_data\n}\n\n```\n\n-----\n\nIn some cases SmokeLoader was observed to be using decoy C2 to put off analysts. In\nthese instances the sample stored a fake value using its standard encryption technique\nwhich would be dumped by static extractors, and the actual C2 was simply stored as a\nplaintext string. Triage can now distinguish between the fake and real C2 strings and only\n[reports the legitimate ones in the report. This analysis is a good example of this behaviour.](https://tria.ge/200814-2lq9gr85q2/behavioral1)\n\n\n-----\n\n## Ransomware Support\n\nRansomware is extremely active these days and new variants and families are constantly\nbeing released, with even relatively basic ones sometimes managing to achieve infections in\nthe wild. This week we’ve added support for a number of these which have gained attention\nover recent weeks.\n\n**LockBit and BigLock Analysis:**\n\n[200827-dmry7lp4cs](https://tria.ge/200827-dmry7lp4cs/behavioral1)\n\nThe sample referenced above came to our attention recently as a slightly unusual case. It\ndrops multiple families, including 2 different ransomware - Lockbit and BigLock. Lockbit is run\nfirst, encrypting files with it’s distinctive `.lockbit extension, then another re-encrypts the`\nfiles with a second layer.\n\nFor Lockbit, ransom note extraction has been improved to now also dump details like\nTelegram contacts, and we have fixed an issue that was preventing some URLs being\ndumped from certain variants of the note.\n\nWe have also added support for BigLock, a family we previously did not have family\nclassification for. The note and family tag should now be correctly displayed in the report.\n\nAlong with this, we have improved/added detection and ransom note support for:\n\n[DarkSide ransomware](https://www.bleepingcomputer.com/news/security/darkside-new-targeted-ransomware-demands-million-dollar-ransoms/)\n\n[Conti ransomware](https://www.zdnet.com/article/conti-ryuk-joins-the-ranks-of-ransomware-gangs-operating-data-leak-sites/)\n\n[200826-jdzf5d33aa](https://tria.ge/reports/200826-jdzf5d33aa/)\n[200826-k8ykljftvn](https://tria.ge/reports/200826-k8ykljftvn/)\n[JackPot Ransomware](https://twitter.com/GrujaRS/status/1298510932340072449)\n\n[200826-3jfzxsp9yx](https://tria.ge/200826-3jfzxsp9yx/)\n[DeathRansom](https://www.fortinet.com/blog/threat-research/death-ransom-new-strain-ransomware)\n\n[200803-bktwtzlfze](https://tria.ge/200803-bktwtzlfze/behavioral1)\n\n## Infostealers\n\nWe have added a number of yara rules and other detections for a few infostealer families.\nWhere possible we have also used behaviour to identify them, but often one infostealer’s\nactions look much like another, so our focus has generally been on static techniques.\n\n### 404Keylogger\n\n\n-----\n\n[Infostealer which has been exploiting COVID-19 related lures to gain infections. First](https://www.lastline.com/labsblog/infostealers-weaponizing-covid-19/)\nappeared around August 2019.\n\n**Analyses:**\n\n[200818-t1jk5m8sc6](https://tria.ge/200818-t1jk5m8sc6/behavioral1)\n[200624-gbxe29kehe](https://tria.ge/200624-gbxe29kehe/behavioral1)\n\n### Kutaki\n\nKeylogger with some other basic infostealer functionality like taking screenshots and\nharvesting data on the clipboard. Includes a range of anti-VM and anti-analysis techniques,\n[although mostly a bit dated.](https://cofense.com/kutaki-malware-bypasses-gateways-steal-users-credentials/)\n\n**Analyses:**\n\n[200805-k11vh8yarj](https://tria.ge/200805-k11vh8yarj/behavioral1)\n[200805-arnebas9fa](https://tria.ge/200805-arnebas9fa/behavioral1)\n\n### XpertRAT\n\nBackdoor/stealer which can carry out a wide range of operations on an infected machine\ndepending on the instructions received. Can also act as a dropper for other families.\n\n**Analyses:**\n\n[200624-3pqyjfy64j](https://tria.ge/200624-3pqyjfy64j/behavioral1)\n[200817-h4pjdtget2](https://tria.ge/200817-h4pjdtget2/behavioral1)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-08-27 - Smokeloader Analysis and More Family Detections.pdf"
    ],
    "report_names": [
        "2020-08-27 - Smokeloader Analysis and More Family Detections.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535537,
    "ts_updated_at": 1743041144,
    "ts_creation_date": 1653692397,
    "ts_modification_date": 1653692397,
    "files": {
        "pdf": "https://archive.orkl.eu/851fb8199000fdee88f1850e84fe64eaf0b33b74.pdf",
        "text": "https://archive.orkl.eu/851fb8199000fdee88f1850e84fe64eaf0b33b74.txt",
        "img": "https://archive.orkl.eu/851fb8199000fdee88f1850e84fe64eaf0b33b74.jpg"
    }
}