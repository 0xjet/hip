{
    "id": "a952b664-cfea-4f93-be52-bbd98dcf84d4",
    "created_at": "2023-01-12T15:02:19.411932Z",
    "updated_at": "2025-03-27T02:15:35.772264Z",
    "deleted_at": null,
    "sha1_hash": "a07a31bc241bac2346f864018ce5ae7f0aeedfdf",
    "title": "2020-02-02 - Agent Tesla amps up information stealing attacks",
    "authors": "",
    "file_creation_date": "2022-05-28T01:22:08Z",
    "file_modification_date": "2022-05-28T01:22:08Z",
    "file_size": 2119825,
    "plain_text": "# Agent Tesla amps up information stealing attacks\n\n**[news.sophos.com/en-us/2021/02/02/agent-tesla-amps-up-information-stealing-attacks/](https://news.sophos.com/en-us/2021/02/02/agent-tesla-amps-up-information-stealing-attacks/)**\n\nFebruary 2, 2021\n\nThe Agent Tesla family of remote access trojan (RAT) malware has been active for over\nseven years, yet it remains one of the most common threats to Windows users. A variety of\nattackers use the malware to steal user credentials and other information from victims\nthrough screenshots, keyboard logging, and clipboard capture.\n\nBecause the malware’s compiler hard-codes operator-specific variables at build time, Agent\nTesla behavior can vary widely—and the malware continues to evolve. Recent changes\nincreased the number of applications targeted for credential theft, including web browsers,\nemail clients, virtual private network clients, and other software that store user names and\npasswords. The evolution of the tool also extends to its delivery package, with one version\nthat now targets Microsoft’s Anti-Malware Software Interface (AMSI) in an attempt to defeat\nendpoint protection software.\n\nSophosLabs has tracked multiple actors using Agent Tesla, including the ones behind the\n[RATicate campaigns we began investigating in November of 2019. We’ve continued to see](https://news.sophos.com/en-us/2020/05/14/raticate/)\nnew variants in a growing number of attacks over the past 10 months; as recently as\nDecember of 2020, Agent Tesla accounted for 20 percent of malware email attachments\ndetected in Sophos customer telemetry.\n\nIn this report, we will delve into the two currently active versions we’ve identified, which\nwe’ve identified as Agent Tesla version 2 and version 3. The differences between the two\ndemonstrate how the RAT has evolved, employing multiple types of defense evasion and\nobfuscation to avoid detection—including options to install and use the Tor anonymizing\n\n\n-----\n\nnetwork client, and the Telegram messaging API, for command and control (C2)\ncommunications. The differences we see between v2 and v3 of Agent Tesla appear to be\nfocused on improving the success rate of the malware against sandbox defenses and\nmalware scanners, and on providing more C2 options to their attacker customers.\n\n## Build-a-bot\n\nBoth current versions of Agent Tesla use a set of global variables that determine the\nfunctionality and behavior of the malware. The attacker provides the values for these\nvariables in the form of a configuration file that govern a wide variety of behaviors, such as\nthe delay time between C2 attempts (shown below).\n\nSome of the configuration variables that drive Agent Tesla’s behavior.\nThe variables common to both versions of Agent Tesla determine which network protocol is\nto be used for C2 communications, based on an integer value set by the configuration file.\nThey also can enable or disable the following behaviors:\n\nPersistence (allowing the RAT to restart when the operating system is rebooted)\nActivation of a remote uninstall feature\nCollection of the infected host’s IP address\nSending a success message to the C2 after installation\n\n\n-----\n\nWhether or not to steal data via screenshots\nWhether or not to log keystrokes (and, in Agent Tesla v3, steal the contents of the\nWindows system clipboard).\nIn Agent Tesla v3, whether or not to deploy a Tor client to conceal communications.\n\nThe RAT’s compiler encodes these options into the executable that’s delivered to the victim.\n\n## Special delivery\n\nAgent Tesla usually arrives in a malicious spam email as an attachment. In the example\nbelow, the malware that drops Agent Tesla is disguised as a .zip compressed file attachment\nthat the attacker claims contains a catalog for the recipient to review:\n\nA\n\nmalicious email carrying an Agent Tesla packer (source: VirusTotal)\nMore recent versions of Agent Tesla use a number of methods to both make sandbox and\nstatic analysis more difficult and evade endpoint detection. Going beyond the use of packers\nto obfuscate code, these multi-stage malware installers also pull in components hosted (in\nsome cases) in plain view on legitimate websites. The Agent Tesla installer also attempts to\noverwrite code in Microsoft’s AMSI.\n\n\n-----\n\nThe\n\nworkflow of the new multi-stage Agent Tesla installer.\nThe first stage is a .NET-based downloader, which grabs chunks of base64-encoded,\nobfuscated code for the second stage from websites such as Pastebin and a Pastebin clone\ncalled Hastebin. The base64-encoded chunks are delimited from the rest of the HTML\ncontent by three “@” symbols, before and after the chunk, as shown in the sample below:\n\nAn example of a response to a download request by Agent Tesla’s multi-stage downloader.\n[The downloader also tries to get the memory address of AmsiScanBuffer—calling](https://docs.microsoft.com/en-us/windows/win32/api/amsi/nf-amsi-amsiscanbuffer)\n[Windows’ amsi.dll with the Windows LoadLibraryA function to get the DLL’s base address,](https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)\nand then **[GetProcAddress using that base address and the “AmsiScanBuffer” procedure](https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)**\nname to get the address of the function.\n\n\n-----\n\nOnce Agent Tesla gets the address of AmsiScanBuffer, it patches the first 8 bytes of this\nfunction in memory:\n\nThese are the patched x86 instructions these opcodes refer to:\n```\n.data:00000000  B8 57 00 07 80    mov eax, 0x80070057\n.data:00000005  C2 18 00       ret 0x18\n\n```\nThe effect of this patch to the AmsiScanBuffer routine forces AMSI to return an error (code\n0x80070057), making all the AMSI scans of memory appear to be invalid. This sabotages\nendpoint protection software dependent on AMSI, by essentially making them skip further\nAMSI scans for dynamically loaded assemblies within the Agent Tesla process. Since this\nhappens early in the first stage downloader’s execution, it renders ineffective any AMSI\nprotection against the subsequent components of the downloader, the second-stage loader,\nand the Agent Tesla payload itself.\n\nAfter downloading the chunks, the downloader stage joins and decodes them, then decrypts\nthem with a simple algorithm. The decoded and decrypted buffer is the second stage—a\nloader that carries the final Agent Tesla payload.\n\n\n-----\n\nThe second stage uses a series of steps to avoid sandbox analysis through debugging. First,\nusing the Microsoft .NET Debugger class, it checks to see if a debugger is attached by\n[checking the Debugger.IsAttached property, and then checks to see if logging is enabled by](https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.debugger.isattached?view=netcore-3.1)\nusing the [Debugger.IsLogging method. Then, using the](https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.debugger.islogging?view=netcore-3.1) [NtSetInformationThread Windows](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntsetinformationthread)\nAPI function, it sets the ThreadHideFromDebugger field in order to hide the thread from the\ndebugger. Once this value is set, the debugger never gets information from the thread, and\nthe practical effect is that it detatches the debugger.\n\nThis technique is hardly new, but it remains very effective.\n\n## Tesla uncoils\n\nOverall, the functionality of Agent Tesla v2 and v3 is largely the same, with a few notable\ndifferences noted below :\n\nA\n\ncomparison of the behaviors and workflow of Agent Tesla V2 and V3, with areas of difference\nin V3 highlighted. (Click to enlarge)\nThe first thing both versions of Agent Telsa do when activated is to check for (and kill) any\nother running instances of Agent Tesla—a step taken to ensure that the originally deployed\ncopy is removed if the bot is configured to establish persistence.\n\nIt then initializes additional, dynamically-set global variables (such as an identifying number\nand name) and the folder to be used for installation. These vary from sample to sample.\n\n\n-----\n\nThe malware then performs another sandbox evasion technique, initializing a timer that is\nused to check if the code is being executed on a sandbox. The timer has a procedure that\nuses [GetLastInputInfo to retrieve and compare user input; if there’s no user input detected,](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getlastinputinfo)\nAgent Tesla shuts down.\n\n## Choosing a carrier\n\nBoth v2 and v3 of Agent Tesla can be configured to communicate over HTTP, SMTP, and\nFTP. Agent Tesla v3 adds the Telegram chat protocol as an option. Each follows a slightly\ndifferent path to push stolen data back to the attacker:\n\nHTTP: Directly sends data to a web panel controlled by the attacker.\nSMTP: Sends data using a stolen mail account to a mail server controlled by the\nattacker.\nFTP: Uploads data to an FTP server controlled by the attacker. (Rarely used, this\nmethod might permit anyone to recover the stolen information from that server because\nthe address of the FTP server as well as the username and password are encoded into\nthe malware binary.)\nTELEGRAM: Sends the exfiltrated data to a private Telegram chat room.\n\nThe attacker chooses one of these C2 communications channels as part of the pre-build\nconfiguration process; in the majority of cases we’ve observed, the attacker uses SMTP for\ncommunication with the C2 server, possibly because it is more secure for the operator, and\nrequires less infrastructure. (The attacker only needs an email account for SMTP, while the\nHTTP method would require the attacker to establish and maintain a web server running a\ncontrol panel.)\n\nAgent Tesla code checking the value of the C2 protocol variable to select communications\ntype.\nThe HTTP C2 method does have certain benefits for the attacker, however. The HTTP C2\nprotocol is the only one that supports remote execution of any of Agent Tesla’s functions.\nWhile the information-stealing behavior of Agent Tesla is largely the same across all C2\n\n\n-----\n\ncommunications protocols, there are two that only work with HTTP: a remote uninstall\nfeature, and a feature that lets the operator know the bot has been installed successfully.\n\nIn Agent Tesla v2, an additional variable (which we refer to in our analysis as “keepalive”)\nalso determines whether these features work; The malware’s developers apparently decided\nthis variable was redundant and eliminated it in Agent Tesla v3. Even the new Telegram chat\nprotocol is one-way only.\n\nAn overview of Agent Tesla’s command and control traffic for each available network\nprotocol.In both versions of Agent Tesla, if HTTP is selected as the C2 protocol, the malware\nsends an empty HTTP message to the C2 server.\n\nThe reversed Agent Tesla code that sends an HTTP ACK message to signal installation of\nthe malware\n\n\n-----\n\nThe setting also enables a timer that sends empty HTTP messages each time it is triggered\nto keep the session with the C2 server active, and another timer that periodically checks to\nsee if the malware’s operator has issued a command that it should uninstall itself from the\ninfected system.\n\nThe “keepalive” code that sends periodic empty messages to the Agent Tesla C2 server.\n\nReversed uninstall code in Agent Tesla.\nThe HTTP C2 channel is also the only one that encrypts its content. While it does not\ninherently use HTTPS, the content of the C2 traffic is Triple DES encrypted, using a key set\nin the configuration file.\n\nAgent Tesla v3 adds another enhancement to HTTP communications—the alternative of\nusing a Tor proxy. If selected in the configuration file, the malware downloads and installs a\nTor client from the official Tor site. If the Tor client is already present, it kills the process\nbefore installing the new one, and writes a torrc configuration file from encrypted strings\nhardcoded into the malware.\n\nCode in Agent Tesla v3 that retrieves a Tor client.\n\n## Setting malware persistence\n\n\n-----\n\nIf the malware s operator has set the persistence to true in the configuration, the malware\ncopies itself to a folder and sets that folder’s attributes to “Hidden” and “System” in order to\nconceal it from view in Windows Explorer. It also puts the installation folder path into the\nWindows Registry’s SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run and\n**SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\StartupApproved\\Run keys.**\n\nA\n\nsnippet of reversed code from Agent Tesla showing how the RAT establishes persistence on\nan infected WIndows system.\n\n## Taking fingerprints\n\nIn Agent Tesla v3, the same variable that enables persistence also triggers collection of the\ninfected system’s external IP address—one data point the malware uses to fingerprint its\nhost for identification by its operator. The malware does this by using the public web API of\n[ipify.org.](https://www.ipify.org/)\n\nCode in Agent Tesla v3 that obtains the host’s external IP address.\nOther than the IP address, the fingerprinting data Agent Tesla v3 collects is the same as that\nin v2:\n\n\n-----\n\nProcessor name (taken from the Windows Management Interface s\n[Win32_Processor.Name class)](https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-processor)\nTotal memory (via .NET’s [ComputerInfo().TotalPhysicalMemory)](https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualbasic.devices.computerinfo.totalphysicalmemory?view=net-5.0)\nOperating System (with .NET’s [ComputerInfo().OSFullName)](https://docs.microsoft.com/en-us/dotnet/api/microsoft.visualbasic.devices.computerinfo.osfullname?view=net-5.0)\nUser name (with .NET’s [SystemInformation.UserName property)](https://docs.microsoft.com/en-us/dotnet/api/system.windows.forms.systeminformation.username?view=net-5.0)\n[Computer name (with .NET’s SystemInformation.ComputerName property)](https://docs.microsoft.com/en-us/dotnet/api/system.windows.forms.systeminformation.computername?view=net-5.0)\nCurrent date and time (with .NET’s [DateTime.Now)](https://docs.microsoft.com/en-us/dotnet/api/system.datetime.now?view=net-5.0)\n\nReversed\n\ncode from Agent Telsa’s host fingerprinting function.\n\n## Stealing the keys\n\nAgent Tesla gathers user credentials. In Agent Tesla v3, the number of applications targeted\nfor credential harvesting has been expanded considerably—the current list of applications\ntargeted includes, but is not limited to:\n\nOpera Browser\nYandex Browser\nChromium\nChrome\n\n\n-----\n\nFirefox\nOpenVPN\nFTPNavigator\nWinSCP\nOperaMail\nOutlook\nSmartFTP\nWinVNC4\n\nAgent Tesla bundles the stolen credentials with the host fingerprint data, and transmits them\nback to the C2 once during execution. The malware doesn’t repeat this process unless it has\nbeen configured for persistence and the infected system restarts.\n\nThe credential-stealing function also includes code which launches a separate thread to\nexfiltrate browser cookies. While this code is present in all the samples of Agent Tesla from\nboth v2 and v3, it isn’t always used. Also, this feature is not set from the configuration file—\nso, perhaps, it’s a premium feature attackers must buy from Agent Tesla’s developer.\n\n## Screenshot exfiltration\n\nIf this option is enabled, a timer is initialized that captures an image of the infected system’s\nscreen via .NET libraries.\n\nAgent Tesla’s screenshot code relies on .NET libraries.\nThe function then sends the image to the C2 as JPEG images over the configured network\nprotocol. As with the keyboard capture dumps, this routine is also initialized on a timer.\n\n\n-----\n\nThe screenshot exfiltration code in Agent Tesla.\n\n## Keystroke capture\n\nIf the hookkeyboard setting is enabled, the malware records all keystrokes and periodically\nsends the logs to the C2 server on a schedule. In Agent Telsa v3, the developers can now\ncapture data from the Windows clipboard; this data is sent back to the C2 by the same timer.\n\nKeyboard log exfiltration code in Agent Tesla.\n\n## Insulating from attack\n\nThe most common delivery method for Agent Tesla is malicious spam—such as the emails\nwe highlighted in our RATicate research. Agent Tesla remains a consistent threat—for many\nmonths, it has remained among the top families of malware in malicious attachments caught\nby Sophos. Because of this sustained stream of Agent Tesla attacks, we believe that the\nmalware will continue to be updated and modified by its developers to evade endpoint and\nemail protection tools.\n\nThe email accounts used to spread Agent Tesla are often legitimate accounts that have been\ncompromised. Organizations and individuals should, as always, treat email attachments from\nunknown senders with caution, and verify attachments before opening them. Sophos\nendpoint protection detects Agent Tesla’s installer malware and the RAT itself, both through\n\n\n-----\n\nmachine learning and detection signatures, and protects against AMSI bypass attacks by\npreventing removal of AMSI registration. Indicators of compromise for Agent Tesla are\nposted on [SophosLabs’ GitHub page.](https://github.com/sophoslabs/IoCs/blob/master/Troj-AgentTesla.csv)\n\n**SophosLabs would like to acknowledge Sivagnanam Gn and Michael Wood for their**\n**contributions to this report.**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-02-02 - Agent Tesla amps up information stealing attacks.pdf"
    ],
    "report_names": [
        "2020-02-02 - Agent Tesla amps up information stealing attacks.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "0d07b30c-4393-4071-82fb-22f51f7749e0",
            "created_at": "2022-10-25T16:07:24.097096Z",
            "updated_at": "2025-03-27T02:02:10.106625Z",
            "deleted_at": null,
            "main_name": "RATicate",
            "aliases": [],
            "source_name": "ETDA:RATicate",
            "tools": [
                "AgenTesla",
                "Agent Tesla",
                "AgentTesla",
                "BetaBot",
                "BlackRAT",
                "BlackRemote",
                "Bladabindi",
                "CloudEyE",
                "ForeIT",
                "Formbook",
                "GuLoader",
                "Jorik",
                "Loki",
                "Loki.Rat",
                "LokiBot",
                "LokiPWS",
                "NSIS",
                "Negasteal",
                "NetWeird",
                "NetWire",
                "NetWire RAT",
                "NetWire RC",
                "NetWired RC",
                "Neurevt",
                "Nullsoft Scriptable Install System",
                "Origin Logger",
                "Recam",
                "Remcos",
                "RemcosRAT",
                "Remvio",
                "Socmer",
                "ZPAQ",
                "njRAT",
                "vbdropper",
                "win.xloader"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535739,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653700928,
    "ts_modification_date": 1653700928,
    "files": {
        "pdf": "https://archive.orkl.eu/a07a31bc241bac2346f864018ce5ae7f0aeedfdf.pdf",
        "text": "https://archive.orkl.eu/a07a31bc241bac2346f864018ce5ae7f0aeedfdf.txt",
        "img": "https://archive.orkl.eu/a07a31bc241bac2346f864018ce5ae7f0aeedfdf.jpg"
    }
}