{
    "id": "9bab5507-08b0-439c-9aee-571fe60bfe30",
    "created_at": "2023-01-12T15:03:42.767063Z",
    "updated_at": "2025-03-27T02:06:13.984151Z",
    "deleted_at": null,
    "sha1_hash": "f01f5cbc8eba7fb7af3c698ed769c42ea5f485a6",
    "title": "2022-12-08 - Compromised Cloud Compute Credentials- Case Studies From the Wild",
    "authors": "",
    "file_creation_date": "2022-12-29T00:28:23Z",
    "file_modification_date": "2022-12-29T00:28:23Z",
    "file_size": 1747847,
    "plain_text": "# Compromised Cloud Compute Credentials: Case Studies From the Wild\n\n**[unit42.paloaltonetworks.com/compromised-cloud-compute-credentials/](https://unit42.paloaltonetworks.com/compromised-cloud-compute-credentials/)**\n\nDror Alon December 8, 2022\n\nBy [Dror Alon](https://unit42.paloaltonetworks.com/author/dror-alon/)\n\nDecember 8, 2022 at 3:00 PM\n\n[Category: Cloud](https://unit42.paloaltonetworks.com/category/cloud/)\n\nTags: [AWS,](https://unit42.paloaltonetworks.com/tag/aws/) [Cloud Security,](https://unit42.paloaltonetworks.com/tag/cloud-security/) [Cortex XDR,](https://unit42.paloaltonetworks.com/tag/cortex-xdr/) [cryptomining,](https://unit42.paloaltonetworks.com/tag/cryptomining/) [Google Cloud,](https://unit42.paloaltonetworks.com/tag/google-cloud/) [IAM,](https://unit42.paloaltonetworks.com/tag/iam/) incident\nresponse, [Prisma Cloud](https://unit42.paloaltonetworks.com/tag/prisma-cloud/)\n\nThis post is also available in: 日本語 [(Japanese)](https://unit42.paloaltonetworks.jp/compromised-cloud-compute-credentials/)\n\n## Executive Summary\n\nCloud breaches often stem from misconfigured storage services or exposed credentials. A\ngrowing trend of attacks specifically targets cloud compute services to steal associated\ncredentials and illicitly gain access to cloud infrastructure. These attacks could cost targeted\norganizations both in terms of unexpected charges for extra cloud resources added by the\nthreat actor, as well as time required to remediate the damage.\n\n\n-----\n\nThis blog highlights two examples of cloud compute credentials attacks in the wild. While the\ninitial access phase is important, we will focus on the post-breach actions executed during\nthe attack, and share the flow of these two attacks against the cloud infrastructure. The\nattack flows show how threat actors abuse stolen compute credentials to pursue a variety of\nattack vectors (such as cryptomining, data theft, etc.) and abuse cloud services in\nunexpected ways.\n\nTo detect the attacks described below, cloud logging and monitoring best practices as\n[outlined by Amazon Web Services (AWS) and](https://aws.amazon.com/blogs/mt/aws-cloudtrail-best-practices/) [Google Cloud are essential, as they provide](https://cloud.google.com/logging/docs/audit/best-practices)\nvisibility into activity at the cloud infrastructure level. This emphasizes how important it is to\nfollow Amazon Web Services and Google Cloud logging and monitoring best practices.\n\nPalo Alto Networks helps organizations address security issues in the cloud with Cortex XDR\nfor cloud, which detects cloud attacks such as cloud compute credentials theft and Prisma\nCloud, which manages identity entitlement with least privilege entitlements.\n\nRelated Unit 42 Topics [Cloud,](https://unit42.paloaltonetworks.com/category/cloud/) [phishing,](https://unit42.paloaltonetworks.com/tag/phishing/) [cloud security,](https://unit42.paloaltonetworks.com/tag/cloud-security/) [coin miner](https://unit42.paloaltonetworks.com/tag/coin-miner/)\n\n## Table of Contents\n\nKey Principle of Working in the Cloud\n\nAttack Case 1: Compromised AWS Lambda Credentials Led to Phishing Attack\n\nAttack Flow\n\nAdditional Insights for Detection\n\nAttack Case 2: A Compromised Google Cloud App Engine Service Account Deploying\nCryptomining Instances\n\nAttack Flow\n\nAdditional Insights for Detection\n\nConclusion: Compute Token Theft Is a Growing Threat\n\n## Key Principle of Working in the Cloud\n\nBefore diving in, we should understand a very basic and important rule of working in the\n[cloud. An entity, whether a human or a compute workload, needs legitimate and associated](https://www.webopedia.com/definitions/workload/)\ncredentials to access a cloud environment at the infrastructure level. The credentials are\nused for authentication (to verify the entity’s identity) and authorization (to verify what the\nentity is allowed to do).\n\nAs a best practice, when a compute workload executes API calls in the cloud (e.g., to query\na storage service), the workload’s associated credentials should be dedicated only to it. They\nshould also be used only by that workload or human, and not by anyone else.\n\n\n-----\n\nAs we will see in both examples, an important security principle that can help reduce risk in\n[cloud compute credentials attacks is least privilege access. In particular, this means that the](https://www.paloaltonetworks.com/cyberpedia/what-is-least-privilege-access)\nprivileges associated with those credentials should be scoped down to the minimum set\nactually required by the code using them.This limits the actions an attacker can take when\ncompute credentials are stolen.\n\n## Attack Case 1: Compromised AWS Lambda Credentials Led to Phishing Attack\n\n[An attacker was able to execute API calls on the behalf of the Lambda function by stealing](https://aws.amazon.com/lambda/features/#:~:text=AWS%20Lambda%20is%20a%20serverless,cart%20on%20an%20ecommerce%20website.)\nthe Lambda’s credentials. This allowed the attacker to execute multiple API calls and\nenumerate different services in the cloud environment, as shown in Figure 1. While most of\nthese API calls were not allowed due to lack of privileges, the attack resulted in a phishing\nattack launched from a AWS Simple Email Service (SES) that the threat actor created.\n\nFigure 1. An attacker enumerating the cloud environment using a compromised Lambda\nfunction’s credentials.\nThis phishing attack not only resulted in unexpected costs for the organization, it also\nexposed other organizations to extra risk as well.\n\nWhile the outcome of this attack caused substantial impact, it could have been greater. In\nthis case the victim didn’t have an active SES, but if they had, the attacker could have\nabused it to launch an attack on the victim’s organization or they could even have used a\nlegitimate email account for the phishing attack.\n\nDue to the variety of cloud services used by organizations, it can be difficult to predict where\na cloud attack will end. Going from cloud to phishing was not necessarily an expected path.\n\n### Attack Flow\n\n\n-----\n\nAn attacker was able to exfiltrate the Lambda’s environment variables and export them into\ntheir attacking machine (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY,\nAWS_SESSION_TOKEN).\n\nAs the credentials were exfiltrated, the attack was launched with the following steps:\n\n**> WHOAMI - 2022-05-20T20:35:49 UTC**\n\nThe attack started with the GetCallerIdentity command. This command is equivalent to\nwhoami, as it provides information about the entity the credentials are associated with. From\nthe response, the attacker can gain additional information such as the account ID and the\ncredentials type that was stolen. They cannot, however, determine anything about the\nprivileges associated with the identity.\n\n**> Identify and Access Management (IAM) Enumeration - 2022-05-20T20:35:55 UTC**\n\nThe next phase of the attack was an identity and access management (IAM) enumeration.\nIAM is considered to be a crown jewel for an attack. By gaining access to IAM, an attacker\ncan elevate permissions and gain persistence on the victim’s account.\n\nThe IAM enumeration included two API calls, which were denied due to lack of permissions:\n\nListAttachedRolePolicies\nListRolePolicies\n\nIt is fair to assume that the attacker noticed the lack of permission and therefore terminated\nthe IAM enumeration after only two commands (possibly to avoid making unnecessary\nnoise).\n\n**> General Enumeration 2022-05-20T20:39:59 UTC**\n\nAfter failing to enumerate IAM, the attacker started an enumeration on different services in\ndifferent regions. This technique is much noisier as the attacker is trying to learn the\narchitecture of the targeted account and, more importantly, gain access to sensitive\ninformation that could exist in the cloud account.\n\nSome of the main services and API calls that were executed were:\n\nStorage Enumeration\n\nListBuckets\nGetBucketCors\nGetBucketInventoryConfiguration\nGetBucketPublicAccessBlock\nGetBucketMetricsConfiguration\n\n\n-----\n\nGetBucketPolicy\nGetBucketTagging\n\nEC2 Enumeration\n\nGetConsoleScreenshot\nGetLaunchTemplateData\nDescribeInstanceTypes\nDescribeBundleTasks\nDescribeInstanceAttribute\nDescribeReplaceRootVolumeTasks\n\nNetwork Enumeration\n\nDescribeCarrierGateways\nDescribeVpcEndpointConnectionNotifications\nDescribeTransitGatewayMulticastDomains\nDescribeClientVpnRoutes\nDescribeDhcpOptions\nGetTransitGatewayRouteTableAssociations\n\nLogging Enumeration\n\nGetQueryResults\nGetBucketLogging\nGetLogRecord\nGetFlowLogsIntegrationTemplate\nDescribeLogGroups\nDescribeLogStreams\nDescribeFlowLogs\nDescribeSubscriptionFilters\nListTagsLogGroup\n\nBackup Enumeration\n\nGetPasswordData\nGetEbsEncryptionByDefault\nGetEbsDefaultKmsKeyId\nGetBucketReplication\nDescribeVolumes\nDescribeVolumesModifications\nDescribeSnapshotAttribute\nDescribeSnapshotTierStatus\nDescribeImages\n\n\n-----\n\nSES Enumeration\n\nGetAccount\nListIdentities\n\nGeneral Enumeration\n\nDescribeRegions\nDescribeAvailabilityZones\nDescribeAccountAttributes\n\n**> Backdoor 2022-05-20T20:43:22 UTC**\n\nWhile failing to enumerate IAM, the attacker tried (unsuccessfully) to create a new user by\nexecuting the CreateUser command.\n\n**> From the Cloud to a Phishing Attack 2022-05-20T20:44:40 UTC**\n\nAs most of the API calls during the enumeration resulted in permission denied, the attacker\nwas able to successfully enumerate SES. Therefore, the attacker launched a phishing attack\nby abusing the cloud email service, which included executing commands such as\nVerifyEmailIdentity and UpdateAccountSendingEnabled.\n\n**> Defense Evasion 2022-05-20T23:07:06 UTC**\n\nFinally, the attacker tried to hide some of his activities by deleting the SES identity by\nexecuting the DeleteIdentity command.\n\n## Additional Insights for Detection\n\nA very important indicator of compromise (IoC) for this attack was the IP address\n50.82.94[.]112.\n\nAPI calls from the Lambda function are typically executed from its IP with the credentials\n(including AccessKeyId) that were generated for the Lambda. Therefore, every API call with\nthat AccessKeyId is considered to be the Lambda function. However, during the attack, the\nthreat actor was able to steal the Lambda's credentials, allowing the attacker to impersonate\nit.\n\nBecause of this, the IP is the key IoC as it is the way to detect that this is not the Lambda.\nThe attacker was using the stolen credentials to impersonate and execute API calls on\nbehalf of the Lambda function, but they were doing so from an IP address that wasn't\nattached to the Lambda, nor did it belong to the cloud environment.\n\n\n-----\n\n## Attack Case 2: A Compromised Google Cloud App Engine Service Account Deploying Cryptomining Instances\n\nAn attacker was able to steal the credentials for a Google Cloud App Engine service account\n(SA). There are many ways that attackers can accomplish this that are not necessarily\nrelated to any vulnerability in the cloud service provider. In many cases, for example, users\nstore credentials in insecure locations or use easily guessed or brute-forced passwords.\n\nIn this case, the stolen SA was the default SA, which had a highly privileged role (Project\nEditor). This allowed the threat actor to launch an attack that ended with the creation of\nmultiple high-core CPU virtual machines (VMs) for cryptomining purposes, as shown in\nFigure 2.\n\nFigure 2. An attacker abusing a compromised App Engine SA to allocate multiple cloud\ninstances for mining.\nWhen the threat actor launched thousands of VMs in the victim’s environment, it significantly\nincreased their expected costs. Even if someone had noticed an attack like this in their\nenvironment after a short period of time, it would still have had a substantial cost impact.\n\n### Attack Flow\n\nGoogle App Engine is a Google Cloud fully managed serverless platform, and the service\naccount is the token. When the user creates an App Engine instance, the cloud provider\ncreates a default SA and attaches it to the created App Engine.\n\nThis App Engine default SA has the editor role in the project. The editor role is highly\nprivileged, which is a key factor the attacker took advantage of. This role allowed execution\nof high-privilege API calls, such as the following:\n\nCompute workload launch\nFirewall (FW) rule modification\n\n\n-----\n\nSA key creation\n\n**> Privilege Escalation 2022-06-16T12:21:17.624 UTC**\n\nThe attack started with an attempt to escalate privileges. As mentioned above, by default the\nApp Engine’s SA has editor permissions on the project. With these permissions, the attacker\ntried to add the compute/admin role by adding the following object into the IAM policy:\n\nAs we can see, the appspot in the SA domain prefix indicates this SA belongs to an App\nEngine service.\n\n**> Allow Any/Any 2022-06-16T12:21:29.406 UTC**\n\nNext the attacker modified the FW rules on the project level. First, the attacker attempted to\ncreate a subnet (named default). Then, the attacker added the rule below into that subnet:\n\n[This action furthers the attacker’s goal of mining cryptocurrency. To enable unlimited](https://www.paloaltonetworks.com/blog/security-operations/stopping-cryptojacking-attacks-with-and-without-an-agent/)\ncryptocurrency mining, the attacker removed any limitation on the networking level.\n\nIt is important to note the priority field. By setting this to zero, the attacker’s rule is set to the\nhighest priority, meaning it will take effect first in the order of the existing FW rules.\n\n**> An Army of Miners 2022-06-16T12:21:38.916 UTC**\n\nOnce setup was complete, the main phase of the attack began, launching VMs in multiple\nregions.\n\nWhile the attacker could have created high CPU machines, in this case the attacker instead\ncreated a standard VM (e.g., n1-standard-2) equipped with four high performance GPUs\n(e.g., nvidia-tesla-p100):\n\n\n-----\n\nOverall, more than 1,600 VMs were created during this attack.\n\n**> Backdoor 2022-06-16T13:25:56.037 UTC**\n\nThe attacker assumed the SA key used for the attack would be detected and revoked, and\ntherefore created multiple SA keys (for later usage) by executing the\ngoogle.iam.admin.v1.CreateServiceAccountKey API call.\n\n## Additional Insights for Detection\n\nAs in the first case we discussed, the IP is an important IoC. In this case, the attack was\nlaunched from multiple IPs (nine different IPs overall), some of which were active Tor exit\nnodes.\n\nAgain, we expect the App Engine’s SA to be used from an IP within the cloud environment. It\ndefinitely should not be used from a Tor exit node.\n\n\n-----\n\nFirewall rule modification is a common and popular technique used in attacks like these.\nMany organizations enforce network traffic rules that deny access to active mining pools, so\nattackers must modify firewall rules to accomplish their goals.\n\nLastly, by editing a network named default, the attacker tried to avoid detection. Unless this\noption is disabled, by default each new project is created with a default network. It seems the\nattacker was trying to take advantage of this, thus avoiding having to create their own\nnetwork.\n\n## Conclusion: Compute Token Theft Is a Growing Threat\n\nThe theft of a compute workload’s token is the common denominator for both cases we’ve\ndiscussed. While both examples above involve serverless services, this attack vector is\nrelevant to all compute services.\n\nIt is important to emphasize that this type of attack could occur from different attack paths –\n[including application vulnerabilities or zero-day exploits such as Log4Shell – not only from](https://www.paloaltonetworks.com/log4shell)\nmisconfigurations or poor cloud security posture management (CSPM).\n\nTo handle such attacks, cloud audit logs are essential, both for detection and for investigation\nand response (IR). Cloud audit monitoring is even more critical for serverless workloads\nwhere agents cannot be installed, thus making it harder to stop such attacks.\n\n[Logging and monitoring best practices provided by AWS and](https://aws.amazon.com/blogs/mt/aws-cloudtrail-best-practices/) [Google Cloud give clear](https://cloud.google.com/logging/docs/audit/best-practices)\nguidance for how to prevent such cases. The AWS [GuardDuty service could also help with](https://aws.amazon.com/guardduty/)\ndetecting and alerting on similar attacks, such as EC2 instance credentials used from\nanother AWS account. An additional prevention method is to configure an interface endpoint\npolicy for Lambda to limit the usage of Lambda only within a VPC.\n\nPalo Alto Networks customers receive protections from compute token theft with:\n\n[Cortex XDR for cloud, which provides SOC teams with a full incident story across the](https://www.paloaltonetworks.com/cortex/cloud-detection-and-response)\nentire digital domain by integrating activity from cloud hosts, cloud traffic, and audit logs\ntogether with endpoint and network data.\n[Prisma Cloud, which assists organizations in managing identity entitlement, addresses](https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin/prisma-cloud-iam-security)\nthe security challenges of managing IAM in cloud environments. Prisma Cloud IAM\nsecurity capabilities automatically calculate effective permissions across cloud service\nproviders, detect overly permissive access, and suggest corrections to reach least\nprivilege entitlements.\n\nFind out how you can protect your organization from cloud environment attacks with Unit 42\nCloud Incident Response services to investigate and respond to attacks and Cyber Risk\nManagement Services to assess your security posture before an attack takes place.\n\n\n-----\n\n**Learn How to Detect Cloud Threats at Ignite 22**\n[Attend the session “Unearth advanced threats using your network and cloud data,” at Palo](https://reg.paloaltonetworks.com/flow/paloaltonetworks/ignite22/sessioncatalog/page/view?search.sessiontracks=option_1662500129090&_ga=2.42431329.511218743.1666629774-446934889.1594421039&tab.day=20221214)\nAlto Networks Ignite ’22, the security conference of the future, to find out how to detect\ncompromised cloud compute tokens. Our researchers will show you how to investigate and\n[respond to cloud attacks with a live demonstration. Register now!](https://reg.ignite.paloaltonetworks.com/flow/paloaltonetworks/ignite22/start/page/main)\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-12-08 - Compromised Cloud Compute Credentials- Case Studies From the Wild.pdf"
    ],
    "report_names": [
        "2022-12-08 - Compromised Cloud Compute Credentials- Case Studies From the Wild.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535822,
    "ts_updated_at": 1743041173,
    "ts_creation_date": 1672273703,
    "ts_modification_date": 1672273703,
    "files": {
        "pdf": "https://archive.orkl.eu/f01f5cbc8eba7fb7af3c698ed769c42ea5f485a6.pdf",
        "text": "https://archive.orkl.eu/f01f5cbc8eba7fb7af3c698ed769c42ea5f485a6.txt",
        "img": "https://archive.orkl.eu/f01f5cbc8eba7fb7af3c698ed769c42ea5f485a6.jpg"
    }
}