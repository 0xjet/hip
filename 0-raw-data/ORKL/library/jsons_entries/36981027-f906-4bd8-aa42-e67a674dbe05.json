{
    "id": "36981027-f906-4bd8-aa42-e67a674dbe05",
    "created_at": "2022-10-25T16:48:25.139255Z",
    "updated_at": "2025-03-27T02:16:59.235715Z",
    "deleted_at": null,
    "sha1_hash": "5d2af87272d8cc9f07fa15a7dbaf65a27d9215be",
    "title": "MAR-17-352-01 HatMan—Safety System Targeted Malware",
    "authors": "",
    "file_creation_date": "2017-12-18T14:03:38Z",
    "file_modification_date": "2017-12-19T11:26:28Z",
    "file_size": 449402,
    "plain_text": "### MALWARE ANALYSIS REPORT\n\n#### MAR-17-352-01 HATMAN—SAFETY SYSTEM TARGETED MALWARE\n\nDecember 18, 2017\n\n\n**SUMMARY**\n\n\nThe HatMan malware affects Triconex controllers by modifying in-memory firmware to add\nadditional programming. The extra functionality allows an attacker to read/modify memory\ncontents and execute custom code on demand through receiving specially crafted network\npackets. HatMan consists of two pieces: a PC-based component to communicate with the safety\ncontroller and a malicious binary component that is downloaded to the controller. Safety\ncontrollers are used in a large number of environments, and the capacity to disable, inhibit, or\nmodify the ability of a process to fail safely can potentially result in physical consequences. This\nreport discusses the components and capabilities of the malware and some potential mitigations.\nMedia reporting also refers to this malware as both TRITON and TRISIS.\n\n\n**A NOTE ON THE ANALYSIS**\n\n\nThis report will discuss the malware as though it is entirely functional. We are aware that the\nmalware may currently have bugs—due to descriptions of how it is behaving—that prevent it\nfrom effecting its desired changes. Though this report presents a “worst case scenario,” it should\nbe considered accurate. We have no reason to suspect that the malware’s creators have not fixed\nits bugs, or that a functional copy does not exist somewhere that we have not yet seen. We have\nand will continue to work with Schneider Electric—the manufacturer of the targeted safety\ncontroller—to test our hypotheses and the malware, and we will update the report when we can\nconfirm any additional information.\n\n\n-----\n\n**ANALYSIS**\n\n\nHatMan follows Stuxnet and Industroyer/CrashOverride, but surpasses them with the ability to\ndirectly interact with, remotely control, and compromise a safety system—a nearly\nunprecedented feat. This report will discuss the malware’s context, components, and capabilities.\n\n\nCONTEXT: WHAT ARE SAFETY SYSTEMS?\n\n\nSafety systems or PLCs are specialized hardware—similar to traditional PLCs—with a strong\nemphasis on reliability and predictable failure.[1 ]Unlike PLCs, safety PLCs often have redundant\ncomponents, such as multiple main processors; watchdog capabilities to self-diagnose anomalies;\nand robust failure detection on inputs and outputs. They are normally used to provide a way for a\nprocess to safely shut down when it has encountered unsafe operating conditions, and provide a\nhigh degree of safety and reliability with important monitoring capabilities for process engineers.\n\n\nCOMPONENTS\n\n\nHatMan consists of two parts: a more traditional PC-based component that interacts with the\nsafety PLCs, and a binary component that compromises the end device when downloaded. All of\nthese could potentially appear within the safety system environment, possibly in similar file\nsystem locations as TriStation TS1131 software installations.\n\nThe PC-based component consists of three pieces in the form observed:\n\n  - An executable that programs a Triconex device without the TriStation software,\n\n  - A native[2 ]shellcode program that injects a payload into the in-memory copy of the\nTriconex firmware,[3 ]and\n\n  - A native shellcode payload that performs malicious actions.\n\n1 Safety systems are designed such that if they were to fail, they would fail in an entirely predictable manner, so that\nthe worst case scenario is fully known.\n\n2 The shellcode here is PowerPC, where newer Triconex devices (if targeted in other versions), would be ARM.\n\n3 The persistent copy of the firmware is immutable, as it is stored in PROM.\n\n\n-----\n\n**REPROGRAMMING THE SAFETY PLC**\n\nIn its current iteration, the component that programs the Triconex controllers is written entirely\nin Python.[4 ]The modules that implement the communication protocol and other supporting\ncomponents are found in a separate file—library.zip—while the main script that employs this\nfunctionality is compiled into a standalone Windows executable—trilog.exe—that includes a\nPython environment.\n\nThis Python script communicates using four Python modules—TsBase, TsLow, TsHi,\nand TS_cnames—that collectively implement the TriStation network protocol (“TS”, via UDP\n1502); this is the protocol that the TriStation TS1131 software uses to communicate with\nTriconex safety PLCs. Although this protocol is undocumented, it is similar to the officially\ndocumented, user application Triconex System Access Application (TSAA) protocol,[5 ]and could\nfeasibly have been reverse engineered from knowing this, other manufacturers’ documentation,\nand watching traffic between the programming workstation and safety PLC. In addition, this\nprotocol does not require any authentication or encryption, although ACLs may be configured on\nthe PLC.[6 ]The Python script is also capable of autodetecting Triconex controllers on the network\nby sending a specific UDP broadcast packet over Port 1502.\n\nIn addition to their implementation of the TriStation protocol, the Python modules also expose a\nset of methods to interact with the compromised safety PLC. These use a specific network\ncommand with some specially crafted data to pass messages to the implant in order to expose the\nfunctionality of the malicious modifications to an attacker on a computer on the safety network,\nregardless of key switch position.\n\nThe general execution flow of the Python script can be seen in the flow diagram below. It begins\nwith connecting to a Triconex controller using an IP address provided as an argument. Once it\nhas connected, it sets an argument for itself by appending a small program, running it, and then\nchecking to ensure it succeeded. It then overwrites the program with a small dummy program if\n\n4 However, it would be relatively trivial to rewrite this component into any other language.\n\n5 The TSAA protocol can be used for reading and writing data points and other user-application-level tasks from a\nthird-party program, rather than using Schneider software.\n\n6 That being said, ACLs are not an effective mitigation strategy, as it is solely based on IP address; thus, the attacker\ncould still use the programming workstation to compromise the PLC. In addition, later Triconex devices have X.509\nsigning for programming—this is also not a bulletproof mitigation strategy, as it is very feasible for the authors to\nupdate their script to employ these certificates (resident on the programming workstation) to sign any updates they\npush, circumventing the measure. At best, this would be a stop-gap.\n\n\n-----\n\nits “clean” flag is set. Following this, it builds the malicious payload and overwrites the same\nprogram slot with this new code. Then it runs the malicious payload, waits for it to finish, and\nverifies it succeeded. Finally, it overwrites the malicious program with the same dummy program\nif the same “clean” flag is set.\n\n.-~ ......, CnrrnP.r.t to thP. '>Pl ~,gumP.nt by\n/ Trilog.exe \\ T rico nex device at down load ing\n\\ ',, / th p providP.d IP prog -.~m\n\nCon~lr uel rm, licio u,\n\nDow nload ma licious Overwrite with\n\nprog ram to\n\nprogram lu device e mp lv program\n\ndown load\n\n**,_---------1~0**\n\n# I -~,,\n\n**O** **ver** **wrile w ilh** _/_ \\\n\nEnd I\n\n**P. n, otv prngr illl')**,,,,, I\n\n'\n\nNo---------[t ]\n\nThe script embedded in the PC component does not interact with the command modified by the\nmalicious payload, but it is feasible and likely that a separate script was used to actually interact\nwith the compromised safety controller as needed.\n\n**THE MALICIOUS PAYLOAD**\n\nThe malicious shellcode is split into two separate pieces—inject.bin and imain.bin. The\nformer is more generic code that handles injecting the payload into the running firmware, while\nthe latter is the payload that actually performs the additional, malicious functionality. Both\nbinary components are PowerPC bytecode—the same as the firmware and any applications\ncompiled for and downloaded to the safety controller.\n\nThe injector masquerades as a normal, compiled PowerPC program for the Triconex device. It\nuses the argument value written by the first program downloaded by the Python script (described\npreviously); however, unlike the earlier program that heuristically determines a location for the\nargument, it assumes that this value exists at a particular address. This address is within the\nstructure handed back from the TS protocol “get control program status” command. As the\ninjector runs, it uses this control field several ways: as an input argument that specifies the\nnumber of cycles to idle before attempting to inject the payload; as a step counter to track and\ncontrol execution progress; and as a field for writing debug information upon failure. This allows\nthe attackers to monitor the status of and debug problems with the injector as it runs.\n\n\n.-~ ...... , CnrrnP.r.t to thP. '>Pl ~,gumP.nt by\n/ Trilog.exe \\ T rico nex device at down load ing\n\\ ',, / th p providP.d IP prog -.~m\n\nCon~lr uel rm, licio u,\n\nDow nload ma licious Overwrite with\n\nprog ram to\n\nprogram lu device e mp lv program\n\ndown load\n\n**,_---------1~0**\n\n# I -~ ,,\n\n**O** **ver** **wrile w ilh** _/_ \\\n\nEnd I\n\n**P. n, otv prngr illl')** ,, ,,, I\n\n'\n\nNo---------[t ]\n\n\n-----\n\nThis shellcode component follows the general execution path shown in the flow chart below.\nDuring each cycle, the program runs and branches based on the control value stored in the\ncontrol field. It begins by waiting a number of cycles based on the counter portion of the control\nfield then proceeds to the later steps. The next two steps perform checks using a system call,\nmatching an output value against an expected constant. The fourth step performs a similar system\ncall check and then, if that check passes, copies the payload into memory, changes a function\npointer to the address of the copied payload, and returns.\n\nWhile Counter > 0\n\nInject.bin Step #1 Decrement Counter\n\nSyscall check\n\nStep #2 Match?\n\niteration #1\n\nYes\n\nCheck control Syscall check\n\nStep #3 Match?\n\nfield iteration #2\n\nYes\n\nSyscall check\n\nStep #4 Match?\n\niteration #3\n\nYes\n\nFailure Inject payload\n\nNo\n\nEnd\n\nAt the time of writing, research is ongoing to determine exactly what effects the intermediate\nsystem call checks and/or actions produce upon the device.\n\nOnce the injector has finished running, it will have modified a function pointer that is used in\nprocessing a specific network command (“get main processor diagnostic data”) such that, when\nthat command is received, the payload is executed first prior to normal processing.\n\nThe second component of the malicious program—the payload, imain.bin—is designed to take\na TriStation protocol “get main processor diagnostic data” command, look for a specially crafted\npacket body, and perform custom actions on demand. It is able to read and write memory on the\nsafety controller and execute code at an arbitrary address within the firmware. In addition, if the\n\n\nCheck control\nfield\n\n\nStep #1\n\n\nStep #3\n\n\nDecrement Counter\n\n\nSyscall check\niteration #2\n\n\nFailure\n\n\nMatch?\n\n\nEnd\n\n\n-----\n\nmemory address it writes to is within the firmware region, it disables address translation,[7 ]writes\nthe code at the provided address, flushes the instruction cache, and re-enables address translation.\nBased on our understanding of the Triconex device, this allows the malware to make changes to\nthe running firmware; however, it appears these changes will be persistent only in memory.\n\n\n**IMPLICATIONS**\n\n\nAlthough by itself HatMan does not do anything catastrophic—safety systems do not directly\ncontrol the process, so a degraded safety system will not cause a correctly functioning process to\nmisbehave—it could be very damaging when combined with malware that impacts the process in\ntandem. Were both to be degraded simultaneously, physical harm could be effected on persons,\nproperty, or the environment.\n\nIt is safe to say that while HatMan would be a valuable tool for ICS reconnaissance, it is likely\ndesigned to degrade industrial processes or worse. Overall, the construction of the different\ncomponents would indicate a significant knowledge about ICS environments—specifically\nTriconex controllers—and an extended development lifecycle to refine such an advanced attack.\n\n\n**DETECTION**\n\n\nNCCIC is working with Schneider Electric to develop an effective method for both detection and\nmitigation of the known samples in the short term. Schneider Electric is evaluating the\npossibility of longer-term strategies for detection and mitigation as well.\n\nIn addition, a YARA rule that matches the three binary components—trilog.exe, inject.bin,\nand imain.bin—is included as an appendix. This is not necessarily a reliable method for\ndetection, as the files may or may not be present on any workstation, and such a rule cannot be\nused on a Triconex controller itself; however, it could be useful for detection with agent-based\ndetection systems or for scanning for artifacts.\n\n7 This is also known as putting the processor into “real mode”.\n\n\n-----\n\n**MITIGATIONS**\n\n\nThere are a number of possible mitigations that can reduce the chance of Triconex devices being\ncompromised. Currently, none of these are complete solutions to the problem, as none will\nprevent the malware under all circumstances. The following are possible mitigations:\n\n- _Ensure Triconex devices connect only to networks required for their proper function._\n\nIf possible, remove Triconex devices from any networks to which they do not need a\npersistent connection; however, if historians or other applications that rely on real-time\ninformation from safety controllers are needed, this might not be possible.\n\n- _Only switch the key to “PROGRAM” when necessary._\n\nWhen a Triconex device has its key set to “RUN” or “REMOTE”, it is unable to be\nprogrammed; thus, only moving the key to “PROGRAM” whenever the device must be\nprogrammed will reduce the likelihood that it can be compromised. That being said, many\nprocesses may be in flux due to changes in the environment, so safety systems may need to\nbe reprogrammed with some frequency; thus, it is rarely possible to never move the key from\n“RUN”. This is not only a way to reduce the chances of being infected, but also best practice.\n\n- _Avoid connecting TriStation workstations to a larger network, avoid using removable media_\n_to transfer programs, and follow best practices for updating workstations._\n\nThe malicious program must be transmitted to a machine—likely a TriStation workstation—\nthat is connected to the same network as the Triconex device. These machines must be\ntreated with caution to prevent malware spreading to them. If there is no path in, the malware\nwe analyzed cannot jump through a workstation onto the safety PLC. This recommendation\nfollows the best practices DHS NCCIC/ICS-CERT has previously detailed for control\nsystems workstations in the “Defense in Depth” document.[8 ]Any other guidance provided in\nthis document should also be considered.\n\n[8 This document may be found on the ICS-CERT web site.](https://ics-cert.us-cert.gov/sites/default/files/recommended_practices/NCCIC_ICS-CERT_Defense_in_Depth_2016_S508C.pdf)\n\n\n-----\n\nSchneider Electric has published a security notification (SEVD-2017-347-01)[9 ]that recommends\na variety of mitigations to decrease the chances of infection that are more tailored toward their\nspecific systems. Several key points are mentioned here:\n\n - Safety systems must always be deployed on isolated networks using zones and conduits as\ndefined in IEC-62443;\n\n - Physical controls should be in place so no unauthorized person has access to the plant,\nequipment rooms, safety controllers, safety peripheral equipment or the safety network;\n\n - All controllers should reside in locked cabinets;\n\n - All TriStation terminals (Triconex programming software) should be kept in locked\ncabinets and should never be connected to any network other than the safety network;\n\n - Operator stations should be configured to display an alarm whenever the Tricon keyswitch\nis in the “Program Mode” with the key removed and secured; and\n\n - Enhanced security features in TriStation, as well as the Triconex communication modules,\nshould be enabled.\n\n[9. https://www.schneider-electric.com/en/download/document/SEVD-2017-347-01/](https://www.schneider-electric.com/en/download/document/SEVD-2017-347-01/)\n\n\n-----\n\n**APPENDIX: YARA RULES**\n\n\nThe following is a YARA rule that matches the binary components of the HatMan malware. The\n[YARA rule is available at: https://ics-cert.us-cert.gov/sites/default/files/file attach/MAR-17-352­](https://ics-cert.us-cert.gov/sites/default/files/file_attach/MAR-17-352-01.yara)\n[01.yara](https://ics-cert.us-cert.gov/sites/default/files/file_attach/ICS-ALERT-14-281-01E.yara)\n```\n/*\n * DESCRIPTION: YARA rules to match the known binary components of the HatMan\n * malware targeting Triconex safety controllers. Any matching\n * components should hit using the \"hatman\" rule in addition to a\n * more specific \"hatman_*\" rule.\n * AUTHOR: DHS/NCCIC/ICS-CERT\n */\n\n```\n```\n/* Globally only look at small files. */\n\n```\n```\nprivate global rule hatman_filesize : hatman {\n  condition:\n    filesize < 100KB\n}\n\n```\n```\n/* Private rules that are used at the end in the public rules. */\n\n```\n```\nprivate rule hatman_setstatus : hatman {\n  strings:\n    $preset   = { 80 00 40 3c 00 00 62 80 40 00 80 3c 40 20 03 7c\n             ?? ?? 82 40 04 00 62 80 60 00 80 3c 40 20 03 7c\n             ?? ?? 82 40 ?? ?? 42 38   }\n  condition:\n    $preset\n}\nprivate rule hatman_memcpy : hatman {\n  strings:\n    $memcpy_be = { 7c a9 03 a6 38 84 ff ff 38 63 ff ff 8c a4 00 01\n             9c a3 00 01 42 00 ff f8 4e 80 00 20  }\n    $memcpy_le = { a6 03 a9 7c ff ff 84 38 ff ff 63 38 01 00 a4 8c\n             01 00 a3 9c f8 ff 00 42 20 00 80 4e  }\n  condition:\n    $memcpy_be or $memcpy_le\n}\nprivate rule hatman_dividers : hatman {\n  strings:\n\n```\n\n-----\n\n```\n    $div1 = { 9a 78 56 00 }\n    $div2 = { 34 12 00 00 }\n  condition:\n    $div1 and $div2\n}\nprivate rule hatman_nullsub : hatman {\n  strings:\n    $nullsub   = { ff ff 60 38 02 00 00 44 20 00 80 4e }\n  condition:\n    $nullsub\n}\nprivate rule hatman_origaddr : hatman {\n  strings:\n    $oaddr_be  = { 3c 60 00 03 60 63 96 f4 4e 80 00 20 }\n    $oaddr_le  = { 03 00 60 3c f4 96 63 60 20 00 80 4e }\n  condition:\n    $oaddr_be or $oaddr_le\n}\nprivate rule hatman_origcode : hatman {\n  strings:\n    $ocode_be  = { 3c 00 00 03 60 00 a0 b0 7c 09 03 a6 4e 80 04 20 }\n    $ocode_le  = { 03 00 00 3c b0 a0 00 60 a6 03 09 7c 20 04 80 4e }\n  condition:\n    $ocode_be or $ocode_le\n}\nprivate rule hatman_mftmsr : hatman {\n  strings:\n    $mfmsr_be  = { 7c 63 00 a6 }\n    $mfmsr_le  = { a6 00 63 7c }\n    $mtmsr_be  = { 7c 63 01 24 }\n    $mtmsr_le  = { 24 01 63 7c }\n  condition:\n    ($mfmsr_be and $mtmsr_be) or ($mfmsr_le and $mtmsr_le)\n}\nprivate rule hatman_loadoff : hatman {\n  strings:\n    $loadoff_be = { 80 60 00 04 48 00 ?? ?? 70 60 ff ff 28 00 00 00\n             40 82 ?? ?? 28 03 00 00 41 82 ?? ??  }\n    $loadoff_le = { 04 00 60 80 ?? ?? 00 48 ff ff 60 70 00 00 00 28\n             ?? ?? 82 40 00 00 03 28 ?? ?? 82 41  }\n  condition:\n    $loadoff_be or $loadoff_le\n}\n\n```\n\n-----\n\n```\nprivate rule hatman_injector_int : hatman {\n  condition:\n    hatman_memcpy and hatman_origaddr and hatman_loadoff\n}\nprivate rule hatman_payload_int : hatman {\n  condition:\n    hatman_memcpy and hatman_origcode and hatman_mftmsr\n}\n\n```\n```\n/* Actual public rules to match using the private rules. */\n\n```\n```\nrule hatman_compiled_python : hatman {\n  condition:\n    hatman_nullsub and hatman_setstatus and hatman_dividers\n}\nrule hatman_injector : hatman {\n\n```\n```\ncondition:\n\n```\n```\n    hatman_injector_int and not hatman_payload_int\n}\nrule hatman_payload : hatman {\n\n```\n```\ncondition:\n\n```\n```\n    hatman_payload_int and not hatman_injector_int\n}\nrule hatman_combined : hatman {\n\n```\n```\ncondition:\n\n```\n```\n    hatman_injector_int and hatman_payload_int and hatman_dividers\n}\nrule hatman : hatman {\n  meta:\n    author = \"DHS/NCCIC/ICS-CERT\"\n    description = \"Matches the known samples of the HatMan malware.\"\n  condition:\n    hatman_compiled_python or hatman_injector or hatman_payload\n       or hatman_combined\n}\n\n```\n\n-----\n\n**ICS-CERT CONTACT**\n\n\nFor any questions related to this report, please contact NCCIC Customer Service at:\n\nU.S. Toll Free: (888) 282-0870\n[Email: ncciccustomerservice@hq.dhs.gov](mailto:ncciccustomerservice@hq.dhs.gov)\n\n[Click this link for information on industrial control systems security information and incident](https://ics-cert.us-cert.gov/Report-Incident?)\n[reporting.](https://ics-cert.us-cert.gov/Report-Incident?)\n\nICS-CERT continuously strives to improve its products and services. You can help by answering\n[a short series of questions about this product on the Feedback page.](https://www.us-cert.gov/forms/feedback)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "6fc23d14-23a6-4870-8fad-b291b182596f",
            "created_at": "2022-10-25T16:07:18.480113Z",
            "updated_at": "2022-10-25T16:07:18.480113Z",
            "deleted_at": null,
            "name": "ETDA",
            "url": "https://apt.etda.or.th",
            "description": "Threat Group Cards: A Threat Actor Encyclopedia",
            "reports": null
        },
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        },
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://ics-cert.us-cert.gov/sites/default/files/documents/MAR-17-352-01%20HatMan%E2%80%94Safety%20System%20Targeted%20Malware_S508C.pdf",
        "https://papers.vx-underground.org/papers/ICS SCADA/Triton/HatMan - Safety System Targeted Malware (MAR-17-352-01).pdf"
    ],
    "report_names": [
        "MAR-17-352-01%20HatMan%E2%80%94Safety%20System%20Targeted%20Malware_S508C.pdf",
        "HatMan - Safety System Targeted Malware (MAR-17-352-01).pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "f9806b99-e392-46f1-9c13-885e376b239f",
            "created_at": "2023-01-06T13:46:39.431871Z",
            "updated_at": "2025-03-27T02:00:03.08926Z",
            "deleted_at": null,
            "main_name": "Watchdog",
            "aliases": [
                "Thief Libra"
            ],
            "source_name": "MISPGALAXY:Watchdog",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716505,
    "ts_updated_at": 1743041819,
    "ts_creation_date": 1513605818,
    "ts_modification_date": 1513682788,
    "files": {
        "pdf": "https://archive.orkl.eu/5d2af87272d8cc9f07fa15a7dbaf65a27d9215be.pdf",
        "text": "https://archive.orkl.eu/5d2af87272d8cc9f07fa15a7dbaf65a27d9215be.txt",
        "img": "https://archive.orkl.eu/5d2af87272d8cc9f07fa15a7dbaf65a27d9215be.jpg"
    }
}