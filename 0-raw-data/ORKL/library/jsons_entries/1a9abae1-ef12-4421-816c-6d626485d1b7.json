{
    "id": "1a9abae1-ef12-4421-816c-6d626485d1b7",
    "created_at": "2023-01-12T15:08:13.536731Z",
    "updated_at": "2025-03-27T02:15:55.618303Z",
    "deleted_at": null,
    "sha1_hash": "69dd36ba961f76af0ade458f98c8af2dda2e3978",
    "title": "2014-07-15 - Unit 42 Technical Analysis- Seaduke",
    "authors": "",
    "file_creation_date": "2022-05-28T02:12:22Z",
    "file_modification_date": "2022-05-28T02:12:22Z",
    "file_size": 317531,
    "plain_text": "# Unit 42 Technical Analysis: Seaduke\n\n**[unit42.paloaltonetworks.com/unit-42-technical-analysis-seaduke/](https://unit42.paloaltonetworks.com/unit-42-technical-analysis-seaduke/)**\n\nJosh Grunzweig July 14, 2015\n\nBy [Josh Grunzweig](https://unit42.paloaltonetworks.com/author/joshgruznweig/)\n\nJuly 14, 2015 at 9:47 AM\n\n[Category: Malware,](https://unit42.paloaltonetworks.com/category/malware-2/) [Threat Prevention,](https://unit42.paloaltonetworks.com/category/threat-prevention-2/) [Unit 42](https://unit42.paloaltonetworks.com/category/unit42/)\n\nTags: [Duke malware,](https://unit42.paloaltonetworks.com/tag/duke-malware/) [forkmeiamfamous,](https://unit42.paloaltonetworks.com/tag/forkmeiamfamous/) [Seaduke,](https://unit42.paloaltonetworks.com/tag/seaduke/) [Symantec,](https://unit42.paloaltonetworks.com/tag/symantec/) [Trojan](https://unit42.paloaltonetworks.com/tag/trojan/)\n\n[Earlier this week Symantec released a blog post detailing a new Trojan used by the ‘Duke’ family of](http://www.symantec.com/connect/blogs/forkmeiamfamous-seaduke-latest-weapon-duke-armory)\nmalware. Within this blog post, a payload containing a function named ‘forkmeiamfamous’ was\nmentioned. While performing some research online, Unit 42 was able to identify the following\n[sample, which is being labeled as ‘Trojan.Win32.Seadask’ by a number of anti-virus companies.](https://www.virustotal.com/en/file/3eb86b7b067c296ef53e4857a74e09f12c2b84b666fc130d1f58aec18bc74b0d/analysis/)\n\nMD5 A25EC7749B2DE12C2A86167AFA88A4DD\n\nSHA1 BB71254FBD41855E8E70F05231CE77FEE6F00388\n\nSHA256 3EB86B7B067C296EF53E4857A74E09F12C2B84B666FC130D1F58AEC18BC74B0D\n\n\nCompile\nTimestamp\n\n\n2013-03-23 22:26:55\n\n\nFile type PE32 executable (GUI) Intel 80386, for MS Windows, UPX compressed\n\nOur analysis has turned up more technical details and indicators on the malware itself that aren’t\nmentioned in Symantec’s post. Here are some of our observations:\n\n## First Layer of Obfuscation\n\nOnce the UPX packer is removed from the malware sample, it becomes quickly apparent that we’re\n[dealing with a sample compiled using PyInstaller. This program allows an individual to write a](https://github.com/pyinstaller/pyinstaller/wiki)\nprogram using the Python scripting language and convert it into an executable for the Microsoft\nWindows, Linux, Mac OSX, Solaris, or AIX platform. The following subset of strings that were found\nwithin the UPX-unpacked binary confirms our suspicions.\n\nsys.path.append(r\"%s\")\ndel sys.path[:]\nimport sys\nPYTHONHOME\nPYTHONPATH\nError in command: %s\nsys.path.append(r\"%s?%d\")\n\n\n-----\n\n_MEI%d\nINTERNAL ERROR: cannot create temporary directory!\nWARNING: file already exists but should not: %s\nError creating child process!\nCannot GetProcAddress for PySys_SetObject\nPySys_SetObject\n\nBecause the sample was written in Python originally, we’re able to extract the underlying code. A\n[tool such as ‘PyInstaller Extractor’ can be used to extract the underlying pyc files present within the](http://sourceforge.net/projects/pyinstallerextractor/)\nbinary.\n\nFigure 1. Extracted Python files from Seaduke\n\n[We can then use a tool such as uncompyle2 to convert the Python byte-code into the original](https://github.com/wibiti/uncompyle2)\nsource code. Once this process is completed, we quickly realize that the underlying Python code\nhas been obfuscated.\n\n\n-----\n\nFigure 2. Obfuscated Python code\n\n## Second Layer of Obfuscation\n\nTracing through the obfuscated code, we identify an ‘exec(ZxkBDKLakV)’ statement, which will\npresumably execute some Python code. Tracing further, we discover that this string is generated\nvia appending a number of strings to the ‘ZxkBDKLakV’ variable. Finally, we find that after this\nstring is created, it is base64-decoded and subsequently decompressed using the ZLIB library.\n\n\n-----\n\nFigure 3. Second layer of obfuscation identified\n\nThe following simple Python code can be used to circumvent this layer of obfuscation:\n\n\n-----\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\nimport sys, re, base64, zlib\n\nif len(sys.argv) != 2:\nprint \"Usage: python %s [file]\" % __file__\nsys.exit(1)\n\nf = open(sys.argv[1], 'rb')\nfdata = f.read()\nf.close()\n\n# Set this accordingly\nvariable = \"ZxkBDKLakV\"\n\nregex = \"%s \\+= ([a-zA-Z0-9]+)\\n\" % variable\nout = \"\"\nfor x in re.findall(regex, fdata):\nregex2 = \"%s = \\\"([a-zA-Z0-9\\+\\/]+)\\\"\" % x\nfor x1 in re.findall(regex2, fdata):\nout += x1\n\no = base64.b64decode(out)\nprint zlib.decompress(o)\n\n\nThe remaining Python code still appears to be obfuscated, however, overall functionality can be\nidentified.\n\n## Final Payload\n\nAs we can see below, almost all variable names and class names have been obfuscated using long\nunique strings.\n\nFigure 4. Obfuscation discovered in final payload\n\nUsing a little brainpower and search/replace, we can begin identifying and renaming functionality\n[within the malware. A cleaned up copy of this code can be found on GitHub. One of the first things](https://github.com/pan-unit42/iocs/blob/master/seaduke/decompiled.py)\nwe notice is a large blob of base64-encoded data, which is additionally decompressed using ZLIB.\nOnce we decode and decompress this data, we are rewarded with a JSON object containing\nconfiguration data for this malware:\n\n\n-----\n\nFigure 5. Base64-encoded / ZLIB compressed data\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\n{\n\"first_run_delay\": 0,\n\"keys\": {\n\"aes\": \"KIjbzZ/ZxdE5KD2XosXqIbEdrCxy3mqDSSLWJ7BFk3o=\",\n\"aes_iv\": \"cleUKIi+mAVSKL27O4J/UQ==\"\n},\n\"autoload_settings\": {\n\"exe_name\": \"LogonUI.exe\",\n\"app_name\": \"LogonUI.exe\",\n\"delete_after\": false\n},\n\"host_scripts\": [\"http://monitor.syn[.]cn/rss.php\"],\n\"referer\": \"https://www.facebook.com/\",\n\"user_agent\": \"SiteBar/3.3.8 (Bookmark Server; http://sitebar.org/)\",\n\"key_id\": \"P4BNZR0\",\n\"enable_autoload\": false\n}\n\n\nThis configuration object provides a number of clues and indicators about the malware itself. After\nthis data is identified, we begin tracing execution of the malware from the beginning. When the\nmalware is initially run, it will determine on which operating system it is running. Should it be\nrunning on a non-Windows system, we see a call to the infamous ‘forkmeiamfamous’ method. This\nmethod is responsible for configuring a number of Unix-specific settings, and forking the process.\n\n\n-----\n\nFigure 6. Main execution of malware\n\nContinuing along, we discover that this malware has the ability to persist using one of the following\ntechniques:\n\n1. Persistence via PowerShell\n2. Persistence via the Run registry key\n3. Persistence via a .lnk file stored in the Startup directory\n\nThe malware copies itself to a file name referenced in the JSON configuration.\n\nFigure 7. Persistence techniques\n\nAfter the malware installs itself, it begins making network requests. All network communications are\nperformed over HTTP for this particular sample; however, it appears to support HTTPS as well.\nWhen the malware makes the initial outbound connection, a specific Cookie value is used.\n\n\n-----\n\nFigure 8. Initial HTTP request made\n\nIn actuality, this Cookie value contains encrypted data. The base64-encoded data is parsed from\nthe Cookie value (padding is added as necessary).\n\nEBJhZTlKiqN8nYWejKh7UpDycPlcrGMEcTE=\n\nThe resulting decoded data is shown below.\n\n\\x10\\x12ae9J\\x8a\\xa3|\\x9d\\x85\\x9e\\x8c\\xa8{R\\x90\\xf2p\\xf9\\\\\\xacc\\x04q1\n\nThe underlying data has the following characteristics.\n\nFigure 9. Cookie data structure\n\nXORing the first single character against the second character identifies the length of the random\nstring. Using the above example, we get the following.\n\nFirst Character : '\\x10'\nSecond Character : '\\x12'\nString Length (16 ^ 18) : 2\nRandom String  : 'ae'\nEncrypted Data  : '9J\\x8a\\xa3|\\x9d\\x85\\x9e\\x8c\\xa8{R\\x90\\xf2p\\xf9\\\\\\xacc\\x04q1'\n\nFinally, the encrypted data is encrypted using the RC4 algorithm. The key is generated by\nconcatenating the previously used random string with the new one, and taking the SHA1 hash of\nthis data.\n\n\n-----\n\nThis same key is used to decrypt any response data provided by the server. The server attempts to\nmimic a HTML page and provides base64-encoded data within the response, as shown below.\n\nFigure 10. Server response\n\nData found within tags in the HTML response is joined together and the white space is removed.\nThis data is then base64-decoded with additional characters (‘-_’) prior to being decrypted via RC4\nusing the previously discussed key. After decryption occurs, the previous random string used in key\ngeneration is updated with the random string. In doing so, the attackers have ensured that no\nindividual HTTP session can be decrypted without seeing the previous session. If the decrypted\ndata does not produce proper JSON data, Seaduke will discard it and enter a sleep cycle.\n\nOtherwise, this JSON data will be parsed for commands. The following commands have been\nidentified in Seaduke.\n\nCommand Description\n\ncd Change working directory to one specified\n\npwd Return present working directory\n\ncdt Change working directory to %TEMP%\n\nautoload Install malware in specified location\n\n\n-----\n\nmigrate Migrate processes\n\nclone_time Clone file timestamp information\n\ndownload Download file\n\nexecw Execute command\n\nget Get information about a file\n\nupload Upload file to specified URL\n\nb64encode Base64-encode file data and return result\n\neval Execute Python code\n\nset_update_interval Update sleep timer between main network requests\n\nself_exit Terminate malware\n\nseppuku Terminate and uninstall malware\n\nIn order for the ‘self_exit’ or ‘seppuku’ commands to properly execute, the attackers must supply a\nsecondary argument of ‘YESIAMSURE’.\n\n## Conclusion\n\nOverall, Seaduke is quite sophisticated. While written in Python, the malware employs a number of\ninteresting techniques for encrypting data over the network and persisting on the victim machine.\nWildFire customers are protected against this threat. Additionally, Palo Alto Networks properly\ncategorizes the URL used by Seaduke as malicious.\n\n**Get updates from**\n\n**Palo Alto**\n\n**Networks!**\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement.](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2014/2014-07-15 - Unit 42 Technical Analysis- Seaduke.pdf"
    ],
    "report_names": [
        "2014-07-15 - Unit 42 Technical Analysis- Seaduke.pdf"
    ],
    "threat_actors": [
        {
            "id": "46b3c0fc-fa0c-4d63-a38a-b33a524561fb",
            "created_at": "2023-01-06T13:46:38.393409Z",
            "updated_at": "2025-03-27T02:00:02.822155Z",
            "deleted_at": null,
            "main_name": "APT29",
            "aliases": [
                "The Dukes",
                "Minidionis",
                "Grizzly Steppe",
                "G0016",
                "Blue Kitsune",
                "BlueBravo",
                "SeaDuke",
                "Cloaked Ursa",
                "YTTRIUM",
                "ATK7",
                "Nobelium",
                "UAC-0029",
                "Group 100",
                "COZY BEAR",
                "IRON HEMLOCK",
                "TA421",
                "ITG11"
            ],
            "source_name": "MISPGALAXY:APT29",
            "tools": [
                "QUARTERRIG",
                "SNOWYAMBER",
                "HALFRIG"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673536093,
    "ts_updated_at": 1743041755,
    "ts_creation_date": 1653703942,
    "ts_modification_date": 1653703942,
    "files": {
        "pdf": "https://archive.orkl.eu/69dd36ba961f76af0ade458f98c8af2dda2e3978.pdf",
        "text": "https://archive.orkl.eu/69dd36ba961f76af0ade458f98c8af2dda2e3978.txt",
        "img": "https://archive.orkl.eu/69dd36ba961f76af0ade458f98c8af2dda2e3978.jpg"
    }
}