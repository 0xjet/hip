{
    "id": "fc3a5b70-f743-454c-a302-a8e219bdb674",
    "created_at": "2023-01-12T15:02:28.363681Z",
    "updated_at": "2025-03-27T02:15:46.135179Z",
    "deleted_at": null,
    "sha1_hash": "57b902635cd936274552c4a43592a445e7ffcd37",
    "title": "2016-09-13 - The curious case of BLATSTING's RSA implementation",
    "authors": "",
    "file_creation_date": "2022-05-28T04:50:32Z",
    "file_modification_date": "2022-05-28T04:50:32Z",
    "file_size": 109177,
    "plain_text": "# The curious case of BLATSTING's RSA implementation\n\n**laanwj.github.io/2016/09/13/blatsting-rsa.html**\n\n## Laanwj's blog\n\nRandomness\n\n[Blog](https://laanwj.github.io/) [About](https://laanwj.github.io/about)\nAmong BLATSTING’s modules is one named `crypto_rsa . According to the name one’d`\nexpect it to implement the [well-known asymmetric cryptosystem going under that name.](https://en.wikipedia.org/wiki/RSA_(cryptosystem))\n\n### RSA\n\nOne’d expect an encryption operation\n```\no = m^e (mod n)\n\n```\nand a matching decryption operation\n```\no = m^d (mod n)\n\n```\nwhere m is the message, n is the RSA modulus (p times q), and e and d are the encryption\nand decryption exponent respectively, parameters computed during key generation and\nstored in a public or private key structure.\n\n### The interface\n```\ncrypto_rsa offers four functions:\n\n```\n\n-----\n\n```\ni01020000 crypto_rsa\n + 0x14: 2 args create_ctx(keyblock,size)\n   Allocates a context, endian-swaps and copies the key data.\n + 0x18: 4 args encrypt(ctx, inptr, outptr, inlen)\n   Performs (supposedly) RSA encryption using a fixed exponent e=65537\n + 0x1c: 0 args dummy()\n   Unimplemented, just \"ret\"\n + 0x20: 1 args free_ctx(ctx)\n   Frees the context ctx\n\n```\nApparently the interface only offers encryption, likely used for signature verification. The\nkeyblock is a structure of 544 bytes containing a (up to 1024 bit) RSA key, with various\nbignum parameters represented by arrays of 32-bit integers;\n```\nstruct key_block {\n  uint32_t n[32];  // modulus\n  uint32_t unk0[32]; // Unused\n  uint32_t x[32];  // ?\n  uint32_t unk1[32]; // Unused\n  uint32_t unk2;   // Unused\n  uint32_t fudge;  // ?\n  uint32_t padding[6];\n};\n\n```\nThe fixed exponent e is not encoded in this structure.\n\nBut what are those extra fields for, x and fudge?\n\n### Curioser and curioser\n\nHere’s a Python version of what `encrypt does:`\n\n\n-----\n\n```\ndef weirdmod(a, b, fudge): # function at 0x08000cd4\n  # tally: 32 integer multiplications, 32 bn_muls, 32 bn_adds, 1 bn_compare, 1\nbn_sub\n  v = a\n  for i in range(32):\n    v = ((((fudge * (v&0xffffffff))&0xffffffff) * b) + v) >> 32\n  if v > b:\n    v -= b\n  return v\n# RSA according to BLATSTING\ndef bs_rsa_encrypt(ctx, temp): # function factored out for clarity\n  # pre-multiplication\n  temp = weirdmod(temp * ctx.x, ctx.n, ctx.fudge)\n  # m ** 65537 mod n\n  to = temp\n  for i in range(16): \n    to = weirdmod(to * to, ctx.n, ctx.fudge)\n  temp = weirdmod(temp * to, ctx.n, ctx.fudge)\n  return weirdmod(temp, ctx.n, ctx.fudge)\ndef bs_rsa_encrypt_outer(ctx, inptr, outptr, len): # function at 0x08000170\n  temp = memcpy_bswap4_in(inptr, len)\n  temp = bs_rsa_encrypt(ctx, temp)\n  memcpy_bswap4_out(outptr, temp, len)\n\n```\nBroadly it looks like a RSA encrypt operation with a hard-coded exponent of `65537 (which`\n[is standard), except that an unconventional pre-multiplication with x is done. After each](http://www.ietf.org/rfc/rfc4871.txt)\noperation a mod is applied to bring the result back within the range [0..n-1].\n\nBut wait: note that `weird_mod does not actually, as would be first expected, implement a`\nmodulus operator. I’m honestly not sure what it is. Unlike mod, applying it repeatedly to a\nvalue does not yield the same result, applying it to 1 does not yield 1. What use would they\nhave for such a a mutilated version of RSA?\n\n### Call site\n\n[The only place where this module is used from is TADAQUEOUS, from the hooked function](https://laanwj.github.io/2016/09/01/tadaqueos.html)\n```\n__add_ipsec_sa . It supplies the following parameters:\n\n```\n\n-----\n\n```\nclass Context:\n  n =\n0xd257c42f17e16815bef4c2f3fede55b5b7ed35fa4ae040aac0515a7bc662f564ac4e98272b61c24b6665\n  unk0 =\n0x2da83bd0e81e97ea410b3d0c0121aa4a4812ca05b51fbf553faea584399d0a9b53b167d8d49e3db4999a\n  x =\n0x76bc66dabca44047215cedfe4b6182cee4a9af38201d5b83ea8b3ab5ad7a05e835327be2337d8c302adb\n  unk1 = 0\n  unk2 = 1\n  fudge = 0xbb4d023f\n\n### Surprise\n\n```\nSo imagine my surprise when I tried it out and compared, using the above parameters:\n```\n# Conventional RSA\ndef rsa_encrypt(ctx, m):\n  return pow(m, 65537, ctx.n)\n# Try with random 1024-bit value\nctx = Context()\nm = random.randint(0, (1<<1024)-1)\n# Compare results\nassert(rsa_encrypt(ctx, m) == bs_rsa_encrypt(ctx, m))\n\n```\nThe result matches convential RSA without pre-multiplication and with a normal expmod\noperator! So it is some kind of optimization, but I had not seen it before, which doesn’t say\nthat much, but it’s not part of e.g. OpenSSL. Edit: it is, according to k240df and martins_m on\n_reddit this is Montgomery reduction which is in OpenSSL under_ `crypto/bn/bn_mont.c .`\n_The thought came up when writing this that it was Montgomery reduction but I did not_\n_recognize it as such._\n\nI’m not up to date with the state of the art is with regard to efficient bignum arithmetic.\nAssuming 1024-bit numbers: A naive modulus implementation based on long division would\ntake up to 1024 bignum comparisons and 1024 bignum subtractions, whereas the\n```\nweird_mod operation takes 32 integer multiplications, 32 bignum muls, 32 bignum adds, 1\n\n```\nbignum compare, and 1 bignum sub. Whether it is a win depends on how bignum\nmultiplication is implemented. A naive bignum multiplication would take up to 32*32 integer\nmultiplications and 32 bignum adds in which case it would not really help. I have not studied\nthe particular `bn_mul implementation in BLATSTING (address` `0x080004a0 *).`\n\nIndependent of the performance characteristics, I think this alternative implementation is\nworth highlighting, as it is in things like this that the Equation Group keeps true to their name.\nIt looks like a form of [Barrett reduction, turning divisions into multiplies, and precomputing a](https://en.wikipedia.org/wiki/Barrett_reduction)\n\n\n-----\n\nmultiplicant over the exact number of modular reductions required. Edit: apparently this is a\n[well-known optimization called Montgomery Reduction. Disappointing, I had hoped to catch](https://en.wikipedia.org/wiki/Montgomery_modular_multiplication)\nat least some crypto magic in the act.\n\n- All mentioned memory addresses are as shown by radare2, which loads the ELF part of\nFirewall/BLATSTING/BLATSTING_201381/LP/lpconfig/m01020000/m01020000.impmod at 0x08000000.\n\nWritten on September 13, 2016\n\nTags: [eqgrp](https://laanwj.github.io/tags/#eqgrp) [malware](https://laanwj.github.io/tags/#malware) [cryptography](https://laanwj.github.io/tags/#cryptography)\n[Filed under Reverse-engineering](https://laanwj.github.io/categories/#reverse-engineering)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2016/2016-09-13 - The curious case of BLATSTING's RSA implementation.pdf"
    ],
    "report_names": [
        "2016-09-13 - The curious case of BLATSTING's RSA implementation.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "08623296-52be-4977-8622-50efda44e9cc",
            "created_at": "2023-01-06T13:46:38.549387Z",
            "updated_at": "2025-03-27T02:00:02.859535Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "Tilded Team",
                "EQGRP",
                "G0020"
            ],
            "source_name": "MISPGALAXY:Equation Group",
            "tools": [
                "EquationLaser",
                "EquationDrug",
                "DoubleFantasy",
                "TripleFantasy",
                "GrayFish"
            ],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "2d9fbbd7-e4c3-40e5-b751-27af27c8610b",
            "created_at": "2024-05-01T02:03:08.144214Z",
            "updated_at": "2025-03-27T02:05:17.419705Z",
            "deleted_at": null,
            "main_name": "PLATINUM COLONY",
            "aliases": [
                "Equation Group "
            ],
            "source_name": "Secureworks:PLATINUM COLONY",
            "tools": [
                " EquationDrug",
                " EquationLaser",
                " Fanny",
                " GrayFish",
                " TripleFantasy",
                "DoubleFantasy"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "73287b62-af12-4c8b-98db-c6ba386cbb28",
            "created_at": "2023-01-06T13:46:39.257688Z",
            "updated_at": "2025-03-27T02:00:03.033375Z",
            "deleted_at": null,
            "main_name": "GOLD GALLEON",
            "aliases": [],
            "source_name": "MISPGALAXY:GOLD GALLEON",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "e0fed6e6-a593-4041-80ef-694261825937",
            "created_at": "2022-10-25T16:07:23.593572Z",
            "updated_at": "2025-03-27T02:02:09.879892Z",
            "deleted_at": null,
            "main_name": "Equation Group",
            "aliases": [
                "APT-C-40",
                "Platinum Colony",
                "Tilded Team"
            ],
            "source_name": "ETDA:Equation Group",
            "tools": [
                "Bvp47",
                "DEMENTIAWHEEL",
                "DOUBLEFANTASY",
                "DanderSpritz",
                "DarkPulsar",
                "DoubleFantasy",
                "DoubleFeature",
                "DoublePulsar",
                "Duqu",
                "EQUATIONDRUG",
                "EQUATIONLASER",
                "EQUESTRE",
                "Flamer",
                "GRAYFISH",
                "GROK",
                "OddJob",
                "Plexor",
                "Prax",
                "Regin",
                "Skywiper",
                "TRIPLEFANTASY",
                "Tilded",
                "UNITEDRAKE",
                "WarriorPride",
                "sKyWIper"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535748,
    "ts_updated_at": 1743041746,
    "ts_creation_date": 1653713432,
    "ts_modification_date": 1653713432,
    "files": {
        "pdf": "https://archive.orkl.eu/57b902635cd936274552c4a43592a445e7ffcd37.pdf",
        "text": "https://archive.orkl.eu/57b902635cd936274552c4a43592a445e7ffcd37.txt",
        "img": "https://archive.orkl.eu/57b902635cd936274552c4a43592a445e7ffcd37.jpg"
    }
}