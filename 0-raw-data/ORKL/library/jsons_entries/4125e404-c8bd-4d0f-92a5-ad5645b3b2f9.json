{
    "id": "4125e404-c8bd-4d0f-92a5-ad5645b3b2f9",
    "created_at": "2023-01-12T15:07:20.8362Z",
    "updated_at": "2025-03-27T02:05:39.815242Z",
    "deleted_at": null,
    "sha1_hash": "d53ba645b441f6142b6ae3b54ba3e3ccd1b91943",
    "title": "2018-12-30 - Retefe unpacker",
    "authors": "",
    "file_creation_date": "2022-05-28T23:43:35Z",
    "file_modification_date": "2022-05-28T23:43:35Z",
    "file_size": 769716,
    "plain_text": "# Retefe unpacker\n\n**github.com/Tomasuh/retefe-unpacker**\n\nTomasuh\n\n**layout** **title** **date** **comments** **categories**\n\npost Retefe unpacker 2018-12-28 true\n\nThis is a writeup on how to implement an unpacker for current versions (at the time of\npublication) of the banking malware Retefe.\n\nResources about the threat:\n\n[Retefe banking Trojan leverages EternalBlue exploit in Swiss campaigns](https://www.proofpoint.com/us/threat-insight/post/retefe-banking-trojan-leverages-eternalblue-exploit-swiss-campaigns)\n[The Retefe Saga](https://www.govcert.admin.ch/blog/33/the-retefe-saga)\n[Reversing Retefe](https://www.govcert.admin.ch/blog/35/reversing-retefe)\n[New version of Retefe Banking Trojan Uses EternalBlue](https://www.mysonicwall.com/sonicalert/searchresults.aspx?ev=article&id=1094)\n\nHistorically there seems to be some variance of ways the malware has stored it's Javascript\npayload. Some sources mentions self extracting ZIP files and other XORed data. The current\nversion makes use of a 4 byte XOR key which is generated based on the scripts length and\na few mathematical operations performed on it. The post [Reversing Retefe from about two](https://www.govcert.admin.ch/blog/35/reversing-retefe)\nmonths back (2018-11-08) shows use of a one byte XOR key which indicates that the threat\nactor has changed its code base after the release of that post. This post is made with the\nintention to shed some light on the current way the threat Retefe stores its payload.\n\n\n-----\n\nLooking at the mapped binary image with IDA shows a large amount of unexplored data that\nis in the `.data segment.`\n\nBrowsing the `.data segment with Binary Ninja shows a large segment of data whose top is`\nreferenced in a copy instruction:\n\nThe copy instruction is part of a function that passes the address of this copied data as an\nargument to a decoding function together with the length of the buffer:\n\nThe `decoder function passes the` `buffer length and another` `int to a function that`\ntakes `buffer length to the power of that` `int . Then a shift and subtraction is performed.`\nThe result is the XOR key that is used to decode the buffer.\n\n\n-----\n\nLater on the decode operation is performed:\n\nThat the data actually becomes decoded can be verified with a debugger, watching the\nmemory of the buffer after the decoder function has ran:\n\n\n-----\n\nWith the above research its possible to write an unpacker.\n\nThe actions performed by the unpacker:\n\nUse yara rules to find buffer location buffer length, number of shifts, subtraction value\nand power to value of it.\nCalculate the buffer RVA as the extracted location is relative to the LEA instruction that\nreferences it\nCalculate XOR array based on values extracted with the help of the yara rules\nExtract and decode the script\n\n[The sourcecode to do this is available in this github repo.](https://github.com/Tomasuh/retefe_unpacker)\n\nRecent hashes that it has been confirmed to work on:\n```\n352b78b8ed38be7ada1d9f4d82352da5015a853bf3c3bdb8982e4977d98f981c\n5c548447203104e9a26c355beaf2367a8fa4793a1b0d3668701ee9ba120b9a7b\n1a3f25f4067e50aa113dfd9349fc4bdcf346d2e589ed6b4cebbc0a33e9eea50d\n\n```\nExample run:\n\n\n-----\n\nScreenshots in this post are based on the sample\n```\n1a3f25f4067e50aa113dfd9349fc4bdcf346d2e589ed6b4cebbc0a33e9eea50d .\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2018/2018-12-30 - Retefe unpacker.pdf"
    ],
    "report_names": [
        "2018-12-30 - Retefe unpacker.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536040,
    "ts_updated_at": 1743041139,
    "ts_creation_date": 1653781415,
    "ts_modification_date": 1653781415,
    "files": {
        "pdf": "https://archive.orkl.eu/d53ba645b441f6142b6ae3b54ba3e3ccd1b91943.pdf",
        "text": "https://archive.orkl.eu/d53ba645b441f6142b6ae3b54ba3e3ccd1b91943.txt",
        "img": "https://archive.orkl.eu/d53ba645b441f6142b6ae3b54ba3e3ccd1b91943.jpg"
    }
}