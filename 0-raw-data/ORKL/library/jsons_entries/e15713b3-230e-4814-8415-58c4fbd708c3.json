{
    "id": "e15713b3-230e-4814-8415-58c4fbd708c3",
    "created_at": "2023-01-12T15:06:55.345311Z",
    "updated_at": "2025-03-27T02:16:14.189151Z",
    "deleted_at": null,
    "sha1_hash": "0db4fda2bd7cd915c8079ed078ddd32612cf4f33",
    "title": "2020-06-07 - Dealing with Obfuscated Macros Statically - NanoCore",
    "authors": "",
    "file_creation_date": "2022-05-25T14:16:25Z",
    "file_modification_date": "2022-05-25T14:16:25Z",
    "file_size": 330436,
    "plain_text": "# Dealing with Obfuscated Macros, Statically – NanoCore\n\n**[zero2auto.com/2020/06/07/dealing-with-obfuscated-macros](https://zero2auto.com/2020/06/07/dealing-with-obfuscated-macros/)**\n\n0verfl0wz2a June 7, 2020\n\n_Author: Zero2Automated Course Team (Theory from courses.zero2auto.com)_\n\nWhen analyzing Maldocs, you will mostly be dealing with obfuscated macros, and until a new\nvulnerability (or “feature”) is discovered and exploited, that is unlikely to change. Therefore,\nit’s quite important to know how to analyze these macros, both statically, and dynamically.\nDynamic analysis is by far the easiest, as it means you can avoid the eye-watering levels of\nobfuscation malware authors put into their macros, but it does mean you need to a) have the\nresources to detonate it safely, and b) hope there is no anti-analysis in it.\n\nWhen it comes to neglecting static analysis, a lot of information is missed out, such as\npossible commonalities in the scripts, as well as techniques used by the threat actors; both\ncommon and uncommon. This information can be quite crucial for Threat Intel, as it allows\nyou to attribute functionality and design to different threat groups, say for example one of the\nmany pushing ISFB. Being able to understand commonalities in macros also allows you to\nimplement auto-IOC extractors, meaning you can point a script at a Maldoc, have it extract\nthe payload URL, immediately download that payload, and so on – assuming they use the\nsame code obfuscator using the same tricks.\n\nAside from that, you get to pick up some neat VBA tricks too, that, while not very useful as an\nanalyst, if you were to transition over to an offensive position, you would have a great idea of\nhow to emulate malicious threat actors, increasing your effectiveness.\n\nSo, enough with the intro, let’s take a look at how best to reverse engineer obfuscated macros,\nstatically. To do this, I will be reversing a malicious Nanocore document.\n\n\n-----\n\nThere are a few different methods that macros use to execute without the user specifically\ncalling them – these methods are the auto_*() and Document_*() functions, such as\n**auto_open() and Document_Close(), which as you may have guessed, execute upon**\ndocument open, and document close. These are the first things you should look for when\ndealing with malicious documents, as they are the first functions to execute, meaning you can\nfollow execution a lot easier.\n\nOnce you have identified and located the “entry point” function, your next task is to identify\nthe obfuscation used. The difficulty of this depends on how much effort the attackers put into\nit – if their entire payload is stored inside the macros, you better believe they will put as\nmuch obfuscation into it as possible (such as the MuddyWater APT), but in the case of\nNanocore, they only need it to download their payload, so the obfuscation is fairly easy to\nrecognize. In this case, the obfuscation is just junk string and function names added to the\nmacros, and so the best thing to do here is to rename everything you see (CTRL+F in Sublime\n\n\n-----\n\nText, and then Find All to edit every instance). Now you ve identified the obfuscation/what\nexactly is obfuscated and what isn’t, you can go about removing those specific strings, either\nmanually, or automatically using Regex and something like Python.\n\nIn cases where you have values that look like they’re possibly important, I recommend using\na brilliant tool: CTRL+F – most of the time, obfuscators will add a line of junk code, and\nthen never reference that line again. Therefore, if there is only one mention to a variable\ninside of a macro, there is a high probability that it is just junk.\n\nOnce you’ve removed all of the obfuscated junk code, the next step is to simply clean up the\ncode by adding indents, removing blank lines, shortening variable/function names etc., to\nmake the code much easier to read. Once this has been done, it’s time to start understanding\n\n\n-----\n\nthe code!\n\nWhen deobfuscating these macros, I went with naming variables and functions literally,\nrather than working out what they were used for first. As a result, we don’t have to deal with\nany obfuscation, and after looking over the code for a few minutes we can work out what each\nfunction does.\n\nWith everything named correctly based on functionality, we can fully understand how the\nmacro operates; first it will get the path to the Templates folder, and append what is most\nlikely the name of the file it will create. Then it will perform a GET request to the encrypted\nURL, and save the response to the file path. The macro will then execute the file from disk.\n\n\n-----\n\nAnd that brings an end to our short analysis! We could go about reversing the decryption\nroutine, but that wasn’t the focus of this particular topic, it was more about deobfuscation\nthan analyzing!\n\nSo, to recap, when reversing obfuscated macros:\n\n1. Locate the entry point function\n2. Identify the obfuscation used (junk code, functions, etc.) and the differences between\n\njunk and actual code (format of string, number of references in code, etc.)\n3. Remove the junk code from the macro\n4. Clean up the remaining code\n\n5. Analyze it!\n\n_Interested in learning more about obfuscated macros, exploited Word Documents, and a_\n_huge number of other malware analysis and reverse engineering topics? Check out our_\n**_Advanced Malware Analysis Course,_** **_[Zero2Automated!](http://courses.zero2auto.com/)_**\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-06-07 - Dealing with Obfuscated Macros Statically - NanoCore.pdf"
    ],
    "report_names": [
        "2020-06-07 - Dealing with Obfuscated Macros Statically - NanoCore.pdf"
    ],
    "threat_actors": [
        {
            "id": "2ed8d590-defa-4873-b2de-b75c9b30931e",
            "created_at": "2023-01-06T13:46:38.730137Z",
            "updated_at": "2025-03-27T02:00:02.903261Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "Boggy Serpens",
                "Mango Sandstorm",
                "TEMP.Zagros",
                "Static Kitten",
                "G0069",
                "TA450",
                "Earth Vetala",
                "Seedworm",
                "COBALT ULSTER",
                "ATK51"
            ],
            "source_name": "MISPGALAXY:MuddyWater",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "31e69945-6c1e-40c3-ba8e-a77e81dd142a",
            "created_at": "2024-05-01T02:03:08.047377Z",
            "updated_at": "2025-03-27T02:05:17.326452Z",
            "deleted_at": null,
            "main_name": "COBALT ULSTER",
            "aliases": [
                "ENT-11 ",
                "ITG17 ",
                "MERCURY ",
                "Mango Sandstorm ",
                "MuddyWater ",
                "STAC 1171 ",
                "Seedworm ",
                "Static Kitten ",
                "TEMP.Zagros ",
                "UNC3313 ",
                "Yellow Nix ",
                "Earth Vetala "
            ],
            "source_name": "Secureworks:COBALT ULSTER",
            "tools": [
                " Canopy",
                " CrackMapExec",
                " CredNinja",
                " Empire",
                " FORELORD",
                " Koadic",
                " LaZagne",
                " Ligolo",
                " MKL64",
                " Metasploit",
                " Mimikatz",
                " MiniDump",
                " Mori",
                " MuddyC2Go",
                " MuddyC3",
                " PhonyC2",
                " Plink",
                " PowGoop",
                " PowerStats",
                " RemoteUtilities",
                " Revsocks",
                " ScreenConnect",
                " SimpleHelp",
                " Small Sieve",
                " Syncro",
                " Venom Proxy",
                " WMIExec",
                "AnyDesk"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "02e1c2df-8abd-49b1-91d1-61bc733cf96b",
            "created_at": "2022-10-25T15:50:23.308924Z",
            "updated_at": "2025-03-27T02:00:55.437268Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "MuddyWater",
                "Earth Vetala",
                "Static Kitten",
                "Seedworm",
                "TEMP.Zagros",
                "Mango Sandstorm",
                "TA450"
            ],
            "source_name": "MITRE:MuddyWater",
            "tools": [
                "STARWHALE",
                "POWERSTATS",
                "Out1",
                "PowerSploit",
                "Small Sieve",
                "Mori",
                "Mimikatz",
                "LaZagne",
                "PowGoop",
                "CrackMapExec",
                "ConnectWise",
                "SHARPSTATS",
                "RemoteUtilities",
                "Koadic"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "3c430d71-ab2b-4588-820a-42dd6cfc39fb",
            "created_at": "2022-10-25T16:07:23.880522Z",
            "updated_at": "2025-03-27T02:02:10.010443Z",
            "deleted_at": null,
            "main_name": "MuddyWater",
            "aliases": [
                "ATK 51",
                "Boggy Serpens",
                "Cobalt Ulster",
                "ITG17",
                "Mango Sandstorm",
                "MuddyWater",
                "Operation BlackWater",
                "Operation Earth Vetala",
                "Operation Quicksand",
                "Seedworm",
                "Static Kitten",
                "T-APT-14",
                "TA450",
                "TEMP.Zagros",
                "Yellow Nix"
            ],
            "source_name": "ETDA:MuddyWater",
            "tools": [
                "Agentemis",
                "BugSleep",
                "CLOUDSTATS",
                "ChromeCookiesView",
                "Cobalt Strike",
                "CobaltStrike",
                "CrackMapExec",
                "DELPHSTATS",
                "EmPyre",
                "EmpireProject",
                "FruityC2",
                "Koadic",
                "LOLBAS",
                "LOLBins",
                "LaZagne",
                "Living off the Land",
                "MZCookiesView",
                "Meterpreter",
                "Mimikatz",
                "MuddyC2Go",
                "MuddyRot",
                "Mudwater",
                "POWERSTATS",
                "PRB-Backdoor",
                "PhonyC2",
                "PowGoop",
                "PowerShell Empire",
                "PowerSploit",
                "Powermud",
                "QUADAGENT",
                "SHARPSTATS",
                "SSF",
                "Secure Socket Funneling",
                "Shootback",
                "Smbmap",
                "Valyria",
                "chrome-passwords",
                "cobeacon",
                "prb_backdoor"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536015,
    "ts_updated_at": 1743041774,
    "ts_creation_date": 1653488185,
    "ts_modification_date": 1653488185,
    "files": {
        "pdf": "https://archive.orkl.eu/0db4fda2bd7cd915c8079ed078ddd32612cf4f33.pdf",
        "text": "https://archive.orkl.eu/0db4fda2bd7cd915c8079ed078ddd32612cf4f33.txt",
        "img": "https://archive.orkl.eu/0db4fda2bd7cd915c8079ed078ddd32612cf4f33.jpg"
    }
}