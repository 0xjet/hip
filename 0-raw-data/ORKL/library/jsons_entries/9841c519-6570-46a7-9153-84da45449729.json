{
    "id": "9841c519-6570-46a7-9153-84da45449729",
    "created_at": "2023-01-12T15:00:45.507484Z",
    "updated_at": "2025-03-27T02:15:35.663469Z",
    "deleted_at": null,
    "sha1_hash": "74b9d411330ef3eb7c4b65c73b05dfa3771013d7",
    "title": "2022-02-02 - Sandboxing Antimalware Products for Fun and Profit",
    "authors": "",
    "file_creation_date": "2022-05-28T05:07:57Z",
    "file_modification_date": "2022-05-28T05:07:57Z",
    "file_size": 218615,
    "plain_text": "# Sandboxing Antimalware Products for Fun and Profit\n\n**[elastic.github.io/security-research/whitepapers/2022/02/02.sandboxing-antimalware-products-for-fun-and-profit/article/](https://elastic.github.io/security-research/whitepapers/2022/02/02.sandboxing-antimalware-products-for-fun-and-profit/article/)**\n\n[Windows Internals](https://elastic.github.io/security-research/tags/#windows-internals) [Vulnerability](https://elastic.github.io/security-research/tags/#vulnerability)\n\n**Gabriel Landau ·** [@gabriellandau 2022-02-02](https://github.com/gabriellandau)\n\n\n-----\n\nThis article demonstrates a flaw that allows attackers to bypass a Windows security\nmechanism which protects anti-malware products from various forms of attack. This is of\nparticular interest because we build and maintain two anti-malware products that benefit from\nthis protection.\n\n## Protected Anti-Malware Services¶\n\nWindows 8.1 [introduced a concept of Protected Antimalware Services. This enables](https://docs.microsoft.com/en-us/windows/win32/services/protecting-anti-malware-services-)\nspecially-signed programs to run such that they are immune from tampering and termination,\n[even by administrative users. Microsoft’s documentation (archived) describes this as:](https://web.archive.org/web/20211019010629/https://docs.microsoft.com/en-us/windows/win32/services/protecting-anti-malware-services-)\n\nIn Windows 8.1, a new concept of protected service has been introduced to allow antimalware user-mode services to be launched as a protected service. After the service is\nlaunched as protected, Windows uses code integrity to only allow trusted code to load\ninto the protected service. Windows also protects these processes from code injection\nand other attacks from admin processes.\n\nThe goal is to prevent malware from instantly disabling your antivirus and then running amok.\nFor the rest of this article, we call them Protected Process Light (PPL (Protected Process\nLight)). For more depth, [Alex Ionescu goes into great detail on protected processes in his](https://twitter.com/aionescu)\n[talk at NoSuchCon 2014.](https://www.youtube.com/watch?v=35L_qJNMu1A)\n\nTo be able to run as a PPL (Protected Process Light), an anti-malware vendor must apply to\nMicrosoft, prove their identity, sign binding legal documents, implement an Early Launch AntiMalware (ELAM (Early Launch Anti-Malware)) driver, run it through a test suite, and submit it\nto Microsoft for a special Authenticode signature. It is not a trivial process. Once this process\nis complete, the vendor can use this [ELAM (Early Launch Anti-Malware) driver to have](https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo)\nWindows protect their anti-malware service by running it as a PPL (Protected Process Light).\n\nYou can see PPL (Protected Process Light) in action yourself by running the following from\nan elevated administrative command prompt on a default Windows 10 install:\n\nProtected Process Light in Action\nAs you can see here, even a user running as SYSTEM (or an elevated administrator) with\n\n`SeDebugPrivilege cannot terminate the` PPL (Protected Process Light) Windows Defender\nanti-malware Service ( MsMpEng.exe ). This is because non-PPL (Protected Process Light)\nprocesses like `taskkill.exe cannot obtain handles with the` `PROCESS_TERMINATE`\naccess right to [PPL (Protected Process Light) processes using APIs such as OpenProcess.](https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess)\n\nIn summary, Windows attempts to protect PPL (Protected Process Light) processes from\nnon-PPL (Protected Process Light) processes, even those with administrative rights. This is\nboth documented and implemented. That being said, with `PROCESS_TERMINATE blocked,`\nlet’s see if there are other ways we can interfere with it instead.\n\n\n-----\n\n## Windows Tokens¶\n\nA Windows token can be thought of as a security credential. It says who you are and what\nyou’re allowed to do. Typically when a user runs a process, that process runs with their token\nand can do anything the user can do. Some of the most important data within a token\ninclude:\n\nUser identity\nGroup membership (e.g. Administrators)\nPrivileges (e.g. SeDebugPrivilege)\nIntegrity level\n\nTokens are a critical part of Windows authorization. Any time a Windows thread accesses a\n[securable object, the OS performs a security check. It compares the thread’s effective token](https://docs.microsoft.com/en-us/windows/win32/secauthz/securable-objects)\nagainst the [security descriptor of the object being accessed. You can read more about](https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptors)\n[tokens in the Microsoft access token documentation and the Elastic blog post that introduces](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens)\nWindows tokens.\n\n### Sandboxing Tokens¶\n\nSome applications, such as web browsers, have been repeated targets of exploitation. Once\nan attacker successfully exploits a browser process, the exploit payload can perform any\naction that the browser process can perform. This is because it shares the browser’s token.\n\nTo mitigate the damage from such attacks, web browsers have moved much of their code\ninto lower-privilege worker processes. This is typically done by creating a restricted security\ncontext called a sandbox. When a sandboxed worker needs to perform a privileged action on\nthe system, such as saving a downloaded file, it can ask a non-sandboxed “broker” process\nto perform the action on its behalf. If the sandboxed process is exploited, the goal is to limit\nthe payload’s ability to cause harm to only resources accessible by the sandbox.\n\nWhile modern sandboxing involves several components of OS security, one of the most\nimportant is a low-privilege, or restricted, token. New sandbox tokens can be created with\nAPIs such as `CreateRestrictedToken. Sometimes a sandboxed process needs to lock`\n[itself down after performing some initialization. The AdjustTokenPrivileges and](https://docs.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-adjusttokenprivileges)\n```\nAdjustTokenGroups APIs allow this adjustment. These APIs enable privileges and groups to\n\n```\nbe “forfeit” from an existing process’s token in such a way that they cannot be restored\nwithout creating a new token outside the sandbox.\n\nOne [commonly used sandbox today is part of Google Chrome. Even some security products](https://chromium.googlesource.com/chromium/src/+/master/docs/design/sandbox.md)\nare getting into sandboxing these days.\n\n### Accessing Tokens¶\n\n\n-----\n\n[Windows provides the OpenProcessToken API to enable interaction with process tokens.](https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocesstoken)\nMSDN (Microsoft Developer Network) states that one must have the\n```\nPROCESS_QUERY_INFORMATION right to use OpenProcessToken . Since a non-protected\n\n```\nprocess can only get `PROCESS_QUERY_LIMITED_INFORMATION access to a` PPL (Protected\nProcess Light) process (note the `LIMITED ), it is seemingly impossible to get a handle to a`\nPPL (Protected Process Light) process’s token. However, MSDN (Microsoft Developer\nNetwork) is incorrect in this case. With only `PROCESS_QUERY_LIMITED_INFORMATION, we`\n[can successfully open the token of a protected process. James Forshaw explains this](https://twitter.com/tiraniddo)\n[documentation discrepancy in more depth, showing the underlying de-compiled kernel code.](https://www.tiraniddo.dev/2017/05/reading-your-way-around-uac-part-2.html)\n\nTokens are themselves securable objects. As such, regular access checks still apply. The\neffective token of the thread attempting to access the token is checked against the security\ndescriptor of the token being accessed for the requested access rights ( TOKEN_QUERY,\n```\nTOKEN_WRITE, TOKEN_IMPERSONATE, etc). For more detail about access checks, see the\n\n```\n[Microsoft article, “How Access Checks Work.”](https://docs.microsoft.com/en-us/windows/win32/secauthz/how-dacls-control-access-to-an-object)\n\n## The Attack¶\n\n[Process Hacker provides a nice visualization of token security descriptors. Taking a look at](https://github.com/processhacker/processhacker/releases/tag/v2.39)\nWindows Defender’s ( MsMpEng.exe ) token, we see the following Discretionary Access\nControl List (DACL (Discretionary Access Control List)):\n\n\n-----\n\nNote that the SYSTEM user has full control over the token. This means, unless some other\n[mechanism is protecting the token, a thread running as SYSTEM can modify the token.](https://powersploit.readthedocs.io/en/latest/Privesc/Get-System/)\nWhen such modification is possible, it violates the desired “PPL (Protected Process Light) is\nprotected from administrators” design goal.\n\n### Demo¶\n\nAlas, there is no other mechanism protecting the token. Using this technique, an attacker can\nforcefully remove all privileges from the `MsMpEng.exe token and reduce it from` system to\nuntrusted integrity. Being nerfed to untrusted integrity prevents the victim process from\naccessing most securable resources on the system, quietly incapacitating the process\nwithout terminating it.\n\nIn this video, the attacker could have further restricted the token, but the privilege and\nintegrity changes were sufficient to prevent `MsMpEng.exe from detecting and blocking a`\nMimikatz execution. We felt this illustrated a valid proof of concept.\n\n## Defense¶\n\nNewer versions of Windows include an undocumented feature called “trust labels.” Trust\n[labels are part of the System Access Control List (SACL), an optional component of every](https://docs.microsoft.com/en-us/windows/win32/ad/retrieving-an-objectampaposs-sacl)\nsecurity descriptor. Trust labels allow Windows to restrict specific access rights to certain\n[types of protected processes. For example, Windows protects the](https://www.elastic.co/blog/protecting-windows-protected-processes) `\\KnownDlls object`\ndirectory from [modification by malicious administrators using a trust label. We can see this](https://www.elastic.co/blog/detect-block-unknown-knowndlls-windows-acl-hardening-attacks-cache-poisoning-escalation)\nwith [WinObjEx64:](https://github.com/hfiref0x/WinObjEx64)\n\nLike `\\KnownDlls, tokens are securable objects, and thus it is possible to protect them`\nagainst modification by malicious administrators. Elastic Security does this, in fact, and is\nimmune to this attack, by denying `TOKEN WRITE access to processes with a trust label`\n\n\n-----\n\nbelow Anti-Malware Light. Because this protection is applied at runtime, however, there is\nstill a brief window of vulnerability until it can apply the trust label.\n\nIdeally, Windows would apply such a trust label to each PPL (Protected Process Light)\nprocess’s token as it is created. This would eliminate the race condition and fix the\nvulnerability in the PPL (Protected Process Light) mechanism. There is precedent. With a\nkernel debugger, we can see that Windows is already protecting the System process’ token\non Windows (21H1 shown below) with a trust label:\n\nThe `SYSTEM_PROCESS_TRUST_LABEL_ACE_TYPE access control entry limits access to`\n```\nREAD_CONTROL, TOKEN_QUERY, and TOKEN_QUERY_SOURCE ( 0x00020018 ) unless the\n\n```\ncaller is a `WinTcb protected process (SID` `S-1-19-1024-8192 ). That SID can be`\ninterpreted as follows:\n\n1: [Revision 1](https://github.com/gabriellandau/ctypes-windows-sdk/blob/0a5bfaa9385391038a7d31928b14d6fe5b76fa97/cwinsdk/um/winnt.py#L1794)\n19: `SECURITY_PROCESS_TRUST_AUTHORITY`\n[1024: SECURITY_PROCESS_PROTECTION_TYPE_FULL_RID](https://github.com/gabriellandau/ctypes-windows-sdk/blob/0a5bfaa9385391038a7d31928b14d6fe5b76fa97/cwinsdk/um/winnt.py#L2100)\n[8192: SECURITY_PROCESS_PROTECTION_LEVEL_WINTCB_RID](https://github.com/gabriellandau/ctypes-windows-sdk/blob/0a5bfaa9385391038a7d31928b14d6fe5b76fa97/cwinsdk/um/winnt.py#L2104)\n\n### Mitigation¶\n\n[Alongside this article, we are releasing an update to the PPLGuard proof-of-concept that](https://github.com/elastic/PPLGuard)\nprotects all running anti-malware PPL (Protected Process Light) processes against this\nattack. It includes example code that anti-malware products can employ to protect\nthemselves. Here it is in action, protecting Defender:\n\n## Disclosure¶\n\n[We disclosed this vulnerability and proposed fixes to the Microsoft Security Response Center](https://www.microsoft.com/en-us/msrc?rtc=1)\n(MSRC (Microsoft Security Response Center)) on 2022-01-05. They responded on 2022-0124 that they have classified it as moderate severity, and will not address it with a security\nupdate. However, they may address it in a future version of Windows.\n\n## Conclusion¶\n\nIn this article, we disclosed a flaw in the Windows Protected Process Light (PPL (Protected\nProcess Light)) mechanism. We then demonstrated how malware can use this flaw to\nneutralize PPL (Protected Process Light) anti-malware products. Finally, we showed a simple\nACL fix (with sample code) that anti-malware products can employ to defend against this\nattack. Elastic Security already incorporates this fix, but we hope that Windows implements it\n(or something equivalent) by default in the near future.\n\nLast update: February 8, 2022\nCreated: February 2, 2022\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-02 - Sandboxing Antimalware Products for Fun and Profit.pdf"
    ],
    "report_names": [
        "2022-02-02 - Sandboxing Antimalware Products for Fun and Profit.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535645,
    "ts_updated_at": 1743041735,
    "ts_creation_date": 1653714477,
    "ts_modification_date": 1653714477,
    "files": {
        "pdf": "https://archive.orkl.eu/74b9d411330ef3eb7c4b65c73b05dfa3771013d7.pdf",
        "text": "https://archive.orkl.eu/74b9d411330ef3eb7c4b65c73b05dfa3771013d7.txt",
        "img": "https://archive.orkl.eu/74b9d411330ef3eb7c4b65c73b05dfa3771013d7.jpg"
    }
}