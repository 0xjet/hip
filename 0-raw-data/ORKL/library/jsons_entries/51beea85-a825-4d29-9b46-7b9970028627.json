{
    "id": "51beea85-a825-4d29-9b46-7b9970028627",
    "created_at": "2023-01-12T15:03:44.750031Z",
    "updated_at": "2025-03-27T02:09:07.908431Z",
    "deleted_at": null,
    "sha1_hash": "ed81bc6c22d64f739a8bd8bb79e396d25a64e565",
    "title": "2021-08-05 - Cryptominer ELFs Using MSR to Boost Mining Process",
    "authors": "",
    "file_creation_date": "2022-05-28T19:28:02Z",
    "file_modification_date": "2022-05-28T19:28:02Z",
    "file_size": 1278824,
    "plain_text": "# Cryptominer ELFs Using MSR to Boost Mining Process\n\n**[uptycs.com/blog/cryptominer-elfs-using-msr-to-boost-mining-process](https://www.uptycs.com/blog/cryptominer-elfs-using-msr-to-boost-mining-process)**\n\n_Original research by Siddarth Sharma_\n\nThe Uptycs Threat Research Team recently observed Golang-based worm dropping\ncryptominer binaries which use the MSR (Model Specific Register) driver to disable hardware\nprefetchers and increase the speed of the mining process by 15%.\n\nThe Golang-based worm which targets vulnerable *nix servers exploit known vulnerabilities\nin the popular web servers in order to spread itself and the embedded miner. The new\nvariants of the worm were identified in June 2021 by our threat intelligence systems. Though\n[some of the functionalities were similar to the malware discussed by the security firm Intezer](https://www.intezer.com/blog/research/new-golang-worm-drops-xmrig-miner-on-servers/)\nlast year, the newer variants of this malware had a bunch of activities up its sleeve.\n\nIn this blog, we will detail the usage of MSR to disable the hardware prefetcher in the\ncryptomining malwares. We will also cover certain new techniques employed by the\nattackers in the attack kill chain for the persistence and dropping of the worm into certain\nsensitive directories on the vulnerable servers.\n\n## Hardware Prefetcher and the MSR\n\nHardware prefetcher is a technique in which the processors prefetch data based on the past\naccess behaviour by the core. The processor (or the CPU) by using hardware prefetcher,,\nstores instructions from the main memory into the L2 cache. However, on multicore\nprocessors, the use of aggressive hardware prefetching causes hampering and results in\noverall degradation of system performance.\n\nMSR registers in processor architecture are used to toggle certain CPU features and\ncomputer performance monitoring. By manipulating the MSR registers, hardware prefetchers\ncan be disabled.\n\n\n-----\n\n## Miners Using MSR to Disable Hardware Prefetcher\n\nA miner running with root privileges can disable the prefetcher. This is done to boost the\nminer execution performance, thereby increasing the speed of the mining process. We have\nseen Xmrig miners in our threat intelligence systems using MSR to disable the hardware\nprefetcher.\n\n[Xmrig miners use the RandomX algorithm which generates multiple unique programs that](https://github.com/tevador/RandomX)\nare generated by data selected from the dataset generated from the hash of a key block. The\ncode to be run inside the VM is generated randomly and the resultant hash of its outcome is\nused as proof of work.\n\nAs RandomX programs are run in a VM, this operation is generally memory intensive.\nHence, the miner disables the hardware prefetcher using the MSR. According to the\n[documentation of Xmrig, disabling the hardware prefetcher increases the speed upto 15%.](https://github.com/xmrig/xmrig/blob/master/doc/CPU.md#wrmsr)\n\nThe miner uses the modprobe msr command to load the msr driver (see Figure 1).\n\nFigure 1: Command used to load msr driver\n\nThis is done because in modular kernels the msr driver is not automatically loaded. Once the\nmsr driver gets loaded, a pseudo file is created in /dev/cpu/ (/dev/cpu/CPUNUM/msr). This\nprovides an interface to read and write the model-specific registers (MSRs) of an x86 CPU.\nThe miner accesses /dev/cpu/CPUNUM/msr to modify the existing value of the msr with the\nnew value as shown below (see Figure 2).\n\nFigure 2: MSR file modification\n\nFor disabling hardware prefetcher, the miner accesses the /dev/CPU/CPUNUM/msr special\ncharacter file to read the old value of msr and then modifies it using pwrite system call in\nchunks of 8 bytes. The pseudo-code of this activity is shown below (see Figure 3).\n\n\n-----\n\nFigure 3: Pseudo-code\n\nAlso, the “wrmsr” set to true in the miner config for enabling MSR feature is shown below\n(see Figure 4).\n\nFigure:4 Config file:Miner\n\n## Wormed cyptominer: attack kill chain\n\n1. The attack kill chain of the wormed cryptominer starts with a Shell script which\n\ndownloads the Golang worm using curl utility.\n2. The worm scans and exploits existing server based vulnerabilities like CVE-2020\n14882 and [CVE-2017-11610 from the victim machine.](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11610#:~:text=The%20XML%2DRPC%20server%20in,1%2C%203.1.&text=3%20allows%20remote%20authenticated%20users,to%20nested%20supervisord%20namespace%20lookups.)\n3. After having access to a vulnerable server, the worm downloads another shell script\n\nwhich downloads a copy of the same Golang worm.\n4. The worm also writes multiple copies of itself to various sensitive directories like\n\n/boot,/efi,/grub and later drops Xmrig miner ELF in /tmp location.\n5. The miner disables the hardware prefetcher by using MSR to boost the mining\n\nprocess.\n\nThe shell-script we analysed (hash:\n28e9b06e5a4606c9d806092a8ad78ce2ea7aa1077a08bcf3ec1d8e3d19714f08) involved\nseveral defense evasive techniques like firewall altering, disabling monitoring agents which\n[we have detailed in our previous blog. Alongside this, the script also used the ‘sed -i’](https://www.uptycs.com/blog/evasive-techniques-used-by-malicious-linux-shell-scripts)\ncommand to modify the /etc/hosts file with the nanopool URL as shown in the below figure\n(see Figure 5).\n\n\n-----\n\nFigure 5: /etc/hosts modification\n\nThe script finally downloads the first stage worm sample from 194.145.227[.]21 as shown\nbelow (see Figure 6).\n\nFigure 6: Shell script network traffic - Downloading Worm\n\n## First stage payload: Worm\n\nThe Worm (163ef20a1c69bcb29f436ebf1e8a8a2b6ab6887fc48bfacd843a77b7144948b9)\n[was compiled in Golang and UPX packed. The worm used the go-bindata package to embed](https://github.com/go-bindata/go-bindata)\nXmrig miner inside itself as shown below (see Figure 7).\n\n\n-----\n\nFigure 7: Embedded XMRig miner\n\n## Vulnerabilities exploited by the Worm\n\nAfter getting downloaded in the victim system, the worm first scans for vulnerable servers\nfrom the victim system to exploit certain known web server vulnerabilities like CVE-202014882 and CVE-2017-11610. The scanner package used by the worm for scanning remote\nvulnerable servers is shown below (see Figure 8).\n\nFigure 8: Scanner modules\n\nThe majority of the worm samples exploited the following vulnerabilities:\n\n\n-----\n\n[1. CVE-2020-14882 - A classic path traversal vulnerability used for exploiting vulnerable](https://nvd.nist.gov/vuln/detail/CVE-2020-14882)\n\nweb logic servers. It seemed like the attacker tried to bypass the authorization\nmechanism by changing the URL and performing a path traversal using double\nencoding on /console/images (see Figure 9).\n\nFigure 9: Worm exploiting Path traversal vulnerability\n\n[1. CVE-2017-11610 - A Remote Code Authentication (RCE) vulnerability in the XMLRPC](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11610#:~:text=The%20XML%2DRPC%20server%20in,1%2C%203.1.&text=3%20allows%20remote%20authenticated%20users,to%20nested%20supervisord%20namespace%20lookups.)\n\ninterface in supervisord. XMLRPC is an interface which is provided by the wordpress.\nThe encoded payload in <param> used by the attacker in the XMLRPC exploit is\nshown below (see Figure 10).\n\nFigure 10: Encoded payload in <param>\n\nAfter successful exploitation, the worm uses base64 encoded command that downloads the\nshell-script (hash:\ndfbe48ade0b70bd999abaf68469438f528b0e108e767ef3a99249a4a8cfa0176) on the remote\nvulnerable servers from the C2 using a base64 encoded command (see Figure 11).\n\nFigure 11: Post exploitation command to deploy worm\n\nThis shell script (ldr.sh) downloads the worm from the C2 to deploy XMrig miner on the\nservers via the worm again (see Figure 12).\n\nFigure 12: Shell-script downloading the worm\n\n## Worm dropping Xmrig miner into /tmp\n\n\n-----\n\nThe worm deploys the embedded Xmrig miner to the /tmp location on the victim server. For\nthis action, the worm first creates a directory in /tmp by the name u0jhm2. After changing the\npermission using fchmod utility, it gets executed (see Figure 13).\n\nFigure 13: Worm dropping miner in /tmp\n\nAfter execution of the miner, the miner binary(kthreaddk) gets removed using unlinkat syscall\n\n- unlinkat(AT_FDCWD, \"/tmp/u0jhm2/kthreaddk\", 0).\n\nThe worm also writes copies of itself to certain sensitive directories like /boot, /boot/grub,\n/boot,efi, /X11 (see Figure:14,15).\n\nFigure 14: Worm binary copying itself to /boot\n\nFigure 15: Worm binary copying itself to /boot/efi\n\n## Persistence\n\nAfter writing itself to sensitive directories, the worm registers itself into the crontabs and\nuses fchmod to change permissions of the cron registered file, tmp.6GnMiL which later gets\nrenamed as root (see Figure 16).\n\nFigure 16:Writing to Cron and later changing the permission\n\n\n-----\n\nOur threat intelligence systems identified seven similar samples of the Golang-based\nwormed cryptominer. Though the functionality and working of the binaries were the same,\nsome of the worm samples register different paths like /dev/dri/bypath/<file_name>,/boot/<file_name> in crontab.\n\n## Uptycs EDR detections\n\n[Uptycs EDR armed with YARA process scanning detected the Xmrig cryptominer and the](https://www.uptycs.com/product-attacksurface-endpoints-servers)\nMSR modification with a threat score of 10/10 (see Figure 17).\n\nFigure 17: Uptycs EDR detection for MSR modification and other malicious activities\n\nAdditionally, [Uptycs EDR contextual detection provides additional details about the detected](https://www.uptycs.com/product-attacksurface-endpoints-servers)\nmalware. Users can navigate to the toolkit data section in the detection alert and click on the\nname to find out the behavior and working of Xmrig as shown in the figure below (see Figure\n18).\n\n\n-----\n\nFigure 18: Toolkit data showing attribution\n\n## Conclusion\n\nWith the rise and sky-high valuation of Bitcoin and several other cryptocurrencies,\ncryptomining-based attacks have continued to dominate the threat landscape. Wormed\ncyptominer attacks have a greater threshold as they write multiple copies and also spread\nacross endpoints in a corporate network. Alongside the mining process, modification of the\nMSR registers can lead to fatal performance issues of the corporate resources. The Uptycs\nEDR solution offers the added benefit of taking a deep dive into the events logged, providing\nmore insights of an attack.\n\nThe Indicators of Compromise (IOCs) associated with wormed cryptomier are available on\nGithub.\n\n## IOCs\n\nC2: 194[.]145.227.21:5443\n\n**Shell script**\n\n28e9b06e5a4606c9d806092a8ad78ce2ea7aa1077a08bcf3ec1d8e3d19714f08\n\ndfbe48ade0b70bd999abaf68469438f528b0e108e767ef3a99249a4a8cfa0176\n\n**Worm**\n\n41dbb7871093a6be9acc7327bc7a7757df2f157912ff5649b01390307283bb53\n\n163ef20a1c69bcb29f436ebf1e8a8a2b6ab6887fc48bfacd843a77b7144948b9\n\nde263e5ad81bb5e2be7d57c7e201fe172108d987562a98897736d8c9235661a2\n\n\n-----\n\n67bb4acf52cc57f62f84161e068e254dba6b4058c04a5d707c057492bd208659\n\nb22e47e11ff7aefc271bff1cbd2c904d8c4208f494208357a949242f6926dfc9\n\n1b2909eda77c14b559b06a68a794868989b7e38c9ca185a3180c63e5c38622b5\n\nf17b64733fa1ba60dda283bd4f6e6ce74fc921028e95c4c1a2079be39084085e\n\n0d3b0dc5ea6643d36d745fcaa177eba88200b2b16596111e140f59092070594f\n\n**Miner**\n\nba518af59262e878d31c71020ebfcbd50dfadf1e7c47a340003c80284681794b\n\nTag(s): [threat hunting,](https://www.uptycs.com/blog/tag/threat-hunting) [threat research](https://www.uptycs.com/blog/tag/threat-research)\n\n## Uptycs Threat Research\n\nResearch and updates from the Uptycs Threat Research team.\n\nConnect with the author\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-05 - Cryptominer ELFs Using MSR to Boost Mining Process.pdf"
    ],
    "report_names": [
        "2021-08-05 - Cryptominer ELFs Using MSR to Boost Mining Process.pdf"
    ],
    "threat_actors": [
        {
            "id": "eb3f4e4d-2573-494d-9739-1be5141cf7b2",
            "created_at": "2022-10-25T16:07:24.471018Z",
            "updated_at": "2025-03-27T02:02:10.24394Z",
            "deleted_at": null,
            "main_name": "Cron",
            "aliases": [],
            "source_name": "ETDA:Cron",
            "tools": [
                "Catelites",
                "Catelites Bot",
                "CronBot",
                "TinyZBot"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535824,
    "ts_updated_at": 1743041347,
    "ts_creation_date": 1653766082,
    "ts_modification_date": 1653766082,
    "files": {
        "pdf": "https://archive.orkl.eu/ed81bc6c22d64f739a8bd8bb79e396d25a64e565.pdf",
        "text": "https://archive.orkl.eu/ed81bc6c22d64f739a8bd8bb79e396d25a64e565.txt",
        "img": "https://archive.orkl.eu/ed81bc6c22d64f739a8bd8bb79e396d25a64e565.jpg"
    }
}