{
    "id": "717c2bd3-afa3-42de-bdb4-8f84364f20a0",
    "created_at": "2023-01-12T15:04:04.415728Z",
    "updated_at": "2025-03-27T02:16:26.56569Z",
    "deleted_at": null,
    "sha1_hash": "6fc5d895f86110c0c440cfa14ec2801ccb3a873e",
    "title": "2021-11-11 - BazarLoader ‘call me back’ attack abuses Windows 10 Apps mechanism",
    "authors": "",
    "file_creation_date": "2022-05-27T21:52:01Z",
    "file_modification_date": "2022-05-27T21:52:01Z",
    "file_size": 1445728,
    "plain_text": "# BazarLoader ‘call me back’ attack abuses Windows 10 Apps mechanism\n\n**[news.sophos.com/en-us/2021/11/11/bazarloader-call-me-back-attack-abuses-windows-10-apps-mechanism/](https://news.sophos.com/en-us/2021/11/11/bazarloader-call-me-back-attack-abuses-windows-10-apps-mechanism/)**\n\nAndrew Brandt November 11, 2021\n\nThe emails that flooded into inboxes last week came from someone named Adam Williams,\nwho sounded annoyed. “Andrew Brandt, i am on my way to the Sophos office. Why you\ndidn’t inform us about Customer Complaint (in PDF) on you? Please call me back now.” the\nemail addressed to me read.\n\nI later heard from my colleague Chet that he had also received an email from an Adam\nWilliams, but with a different email address in the From: header.\n\n\n-----\n\nBut the messages did not come from the Sophos Main Manager Assistant, because such a\nrole doesn’t even exist. It originated with a threat actor. The payloads, belonging to a\nmalware family variously known as BazarBackdoor and BazarLoader, were delivered by\nabusing a novel mechanism – at least, one that my colleagues and I were unfamiliar with:\nThe Windows 10 Apps installer process.\n\nThe spam targeted people around the world. Many customers correctly identified them as a\nmalicious spam and reported them to us. While the attacker’s websites were still operational\n(Microsoft turned off the pages hosting the malicious files late in the evening of November 4),\nI pulled down several samples of the files and then stepped through the attack while\nrecording the network traffic, collecting behavioral data from the machine, and taking\nscreenshots.\n\nHere’s what we found.\n\n## A careful lure\n\nThe messages themselves were very short, but they were crafted with an understanding of\nthe human psychology behind the adrenaline-rush of fear, and had been personalized with\nboth the name of the recipient and the targeted organization in both the subject line and the\nbody. The spam trope here – a complaint, filed against you, and the insinuation that you’ve\nbeen attempting to cover it up.\n\nThe messages urge the recipient to click through to a website that, purportedly, is where the\ncomplaint has been posted for you to review.\n\nThe link points to an ms-appinstaller object\n\n\n-----\n\nBut there s something amiss with this link: Instead of being prefixed with the expected\n**https:// the link instead begins with what was (for me, at least) an unfamiliar ms-**\n**appinstaller: prefix. In the course of running through an actual infection I realized that this**\nconstruction of a URL triggers the browser (in my case, Microsoft’s Edge browser on\nWindows 10) to invoke a tool used by the Windows Store application, called AppInstaller.exe,\nto download and run whatever’s on the other end of that link.\n\nWhat’s interesting about this is that there are actually two stages, apparently, to this phase of\nthe attack. The link points to a 482-byte text file named Adobe.appinstaller. The contents of\nthat file is just plain text, in xml format, that points to a URL where a larger file containing the\nmalware, named Adobe_1.7.0.0_x64.appbundle, was located.\n\nThe attackers used two different web addresses for hosting this fake “PDF download” page\nthroughout the day. Both pages were hosted in Microsoft’s cloud storage, which perhaps\nlends it a sense of (unearned) authenticity, and both the .appinstaller and .appbundle files\nwere hosted in the root of each webpage’s storage.\n\nThe website also hosted all the payload components\nBut we can’t learn how attacks work by doing the right thing, so of course, we clicked Open,\nwhich you should never do.\n\nWhen I did that, Edge prompted me with a warning that This site is trying to open App\n_Installer. Since this site’s subdomain was adobeview and the root domain was windows.net,_\nit stands to reason that a user who is unaware of how an arcane aspect of the operating\nsystem works could easily be fooled into not only clicking the Open button in that dialog box\nbut might also fill in the Always Allow checkbox.\n\n\n-----\n\nThroughout the morning, I repeatedly retrieved the .appbundle file itself, directly, getting\nseveral different versions. But to learn the real magic of how this attack works I needed to let\nit play itself out, so I just took the same steps a potential victim might take, and just clicked\nthe link in the page.\n\n## When appinstaller attacks\n\nThe initial file referenced in the webpage was this .appinstaller. As you can see, it contains\nnot only a link to the actual payload (the .appxbundle URL at the bottom) but also information\nabout a publisher’s digital signature. In this case, the malicious appinstaller indicates that the\n.appxbundle was digitally signed by a company calling itself Systems Accounting Limited,\nbased in the UK. The certificate was issued just a few months ago. Sophos has contacted\nSectigo to alert them about this abuse of the certificate they issued.\n\n\n-----\n\n(Out of curiosity, I did check and\n\nthere is, in fact, a business registered in the UK’s Companies House by that name and in the\nsame county listed in the digital certificate referenced in this file. However, the company’s\nregistered address points to a private residential home, raising serious doubt that this\ncompany had anything to do with the attack. The domain systems-accounting.com,\nembedded in the certificate’s admin, is hosted on an IP address on which every other\ndomain hosted there has a .ru TLD.)\n\nClicking Open in the App Installer warning dialog prompts the browser to invoke\nAppInstaller.exe, which downloads the .appinstaller file, then the .appxbundle linked inside of\nit.\n\n\n-----\n\nWhen the .appxbundle file has been downloaded, the installer prompts the user to begin\ninstalling it. The process only took a few seconds.\n\nTaking a closer look inside of the .appxbundle file, which is just a .zip archive containing\nseveral other files, the AppsManifest.xml file contains the textual information shown on the\ninstallation screen. It also clearly references the certificate from Systems Accounting Limited,\nbut the framework doesn’t show (or validate) that certificate’s information on this screen. In\nfact, the attacker simply added individual display properties for the program’s name (“Adobe\nPDF Component”), publisher (“Adobe Inc.”), and an Adobe Acrobat logo graphic stored in a\nsubfolder.\n\nThe manifest file clearly shows the signing certificate name Systems Accounting Limited,\nalongside a properties value that falsely identifies the publisher as Adobe\n\n\n-----\n\nThe .appxbundle file contains a malicious executable nested in the\n**Adobe_1.7.0.0_x64.appx file stored inside of it. That file is also a .zip archive, and contains**\nmany of the same xml files, as well as a subfolder named UpdateFix inside of which is the\nmalicious payload, SecurityFix.exe.\n\nEven though the .appxbundle contains the signing certificate assigned to Systems\nAccounting Limited, the SecurityFix.exe payload is not, itself, signed. The certificate\nreferences a domain (systems-accounting.com) that was registered on September 8, and the\ncode signing certificate was issued on September 21.\n\n## Injection games\n\nAfter the dog-and-pony show of the fake installer running, the system ran the SecurityFix\nexecutable, which downloaded a DLL (from the same server that hosted the .appxbundle file)\ninto the %temp% directory and then runs it using regsvr32.exe. It ran for a few seconds, then\nspawned a child process of itself running the same way, but with random-looking function\ncalls at the end of the command.\n\nSecurityFix.exe pulls down and runs the first instance of the malicious DLL\nIt’s not easy to see unless you’re using an alternative Task Manager tool (like Process\nExplorer), but the DLL ran for a few seconds and then spawned yet another a child process\nof itself, using a program called Timeout.exe. Timeout is a legitimate Windows console\napplication used for manually configuring a delay starting another program. In this case, it\nwaited 8 seconds and then ran the same regsvr32 command, with the same random function\ncalls, and with an additional “& exit” at the end of the command.\n\nAnd then that execution spawns yet another child process, in which the attackers have used\na different timeout method to delay execution: The choice.exe console command lets you\nspecify a timeout just like Timeout.exe does. With a 7 second delay, it runs for the fifth time in\nrapid succession.\n\nBy this time, the DLL terminates and an instance of the Edge browser (Chromium version)\nspawns, with the code injected into a headless instance of msedge.exe. The malware is now\nfully installed, and begins beaconing to its command-and-control servers.\n\n\n-----\n\n## Telephone game with cookies\n\nThe malware that eventually was installed is BazarBackdoor. We know this because of a few\nthings: The malware has a distinctive style in the patterns it follows for its command-andcontrol traffic, and the detections we’ve developed that read its in-memory behavior\npositively identified it by the definition name Mem/BazarLd-C.\n\nLike many other malware, BazarBackdoor (and its related sibling BazarLoader)\ncommunicates over HTTPS, but the way that it transmits and receives instructions are\ndistinctive. And it generates a lot of noisy, unnecessary traffic — to pages that don’t exist —\non unrelated websites (such as Intel, shown at the bottom of the screen below), usually with\na query string that has five or six numbers at the end.\n\nIn brief, the malware uses “cookies” in the HTTPS GET or POST headers to transmit\ninformation to the server, and receives commands from the C2 in the form of one or more\n“Set-Cookie” response headers.\n\nCookie data transmitted in the GET request’s header exfiltrates information from the infected\ndevice\n\n\n-----\n\nDuring this attack, the malware used specific URI paths – the same one for all the requests.\nThe sample I ran for an extended period used /segment/billion, but other industry analysts\nshared that their samples used the URI paths of /recite/drink or /mission/revolt or\n**/discreet/marble or /note/actual.**\n\nSet-Cookie items in the response headers from C2 check-ins contain instructions for the bot\nIn this instance, the C2 sent a series of commands in quick succession that performed a\nnumber of different profiling activities on the infected system. It was pretty easy to see this\nhappening because the headless Edge process kept spawning instances of PowerShell or\nother tools.\n\nA sequence of PowerShell commands executed by the malware, which had been injected\ninto the Edge browser, profiles the hard disks, processor and motherboard, and RAM on the\ninfected system\nThese three queries profiled the hard drive, processor information, and RAM on the system.\nThe malware, running in the context of the headless Edge process, also ran other\ncommands like net view /all to learn more about servers on the network where it’s installed.\n\nA PowerShell command retrieves the public-facing IP address of the network where the\ninfected computer is running from one or more websites at random\n\n\n-----\n\nAnd this very long PowerShell command chooses one or more of these URLs, at random,\nand uses it to identify the public-facing IP address of the network where the system is\nlocated.\n\nThe PowerShell command used to identify the public-facing IP address. It was too long to\nshow the entire command in the Process Explorer screenshot, above.\n\n## Avoidance and detection\n\nMalware that comes in AppX packages is novel, but now that the process has been\ndemonstrated, it’s likely to be here to stay. These apps are supposed to be digitally signed\nwith certificates, but it doesn’t appear that there’s any mechanism to make a sanity check\nbetween what’s on the certificate and the code it’s supposed to certify.\n\nA map of the relationship of web hosts to malware payloads. Data: VirusTotal\nOur advice might be to ignore emails from random addresses which claim to originate from\nwithin your company, but that’s a problem the spammers are likely to solve, probably by\nforging the From: addresses. The right thing to do would be to check with someone in the\nrelevant department, perhaps HR, if you suspect the email might be legitimate, and to ignore\nit if it has these signs of obvious forgery.\n\n\n-----\n\nObviously, Microsoft needs to work on the mechanism that validates not only whether code\ncontains an authentic digital certificate, but if there’s any logical connection between the\ncertificate and the organization purportedly behind the program. Right now, that mechanism\ndoesn’t offer any guarantees – and in fact may make it easier for an attacker to just pretend\nto be any company they want.\n\nUsers of Sophos endpoint products will be protected from this malware at multiple stages of\nthe process: The SophosXL reputation service is blocking the source and C2 addresses, and\nendpoint protection will detect various elements of this infection as Troj/Bazar-T, Troj/Bazar**S, Troj/DwnLd-TA, Troj/DwnLd-TE, Troj/MSIL-RYU, Troj/MSIL-RYT, and/or Troj/MSIL-**\n**RXW if the files are found on disk, pre-execution, or as Mem/BazarLdr-C if it evades static**\ndetection, and through behavioral detection of unexpected PowerShell commands running in\nthe context of a browser process.\n\n[SophosLabs has published IoCs relating to this attack on its Github page, and wishes to](https://github.com/sophoslabs/IoCs/blob/master/Troj-BazarBackdoor.csv)\nthank Microsoft and Sectigo for a prompt response to the attack method.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-11-11 - BazarLoader ‘call me back’ attack abuses Windows 10 Apps mechanism.pdf"
    ],
    "report_names": [
        "2021-11-11 - BazarLoader ‘call me back’ attack abuses Windows 10 Apps mechanism.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "6abcc917-035c-4e9b-a53f-eaee636749c3",
            "created_at": "2022-10-25T16:07:23.565337Z",
            "updated_at": "2025-03-27T02:02:09.868522Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Bronze University",
                "Charcoal Typhoon",
                "Chromium",
                "Red Dev 10",
                "Red Scylla"
            ],
            "source_name": "ETDA:Earth Lusca",
            "tools": [
                "Agentemis",
                "AntSword",
                "BIOPASS",
                "BIOPASS RAT",
                "BadPotato",
                "Behinder",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "Doraemon",
                "FRP",
                "Fast Reverse Proxy",
                "FunnySwitch",
                "HUC Port Banner Scanner",
                "KTLVdoor",
                "Mimikatz",
                "NBTscan",
                "POISONPLUG.SHADOW",
                "PipeMon",
                "RbDoor",
                "RibDoor",
                "RouterGod",
                "SAMRID",
                "ShadowPad Winnti",
                "SprySOCKS",
                "WinRAR",
                "Winnti",
                "XShellGhost",
                "cobeacon",
                "fscan",
                "lcx",
                "nbtscan"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "d53593c3-2819-4af3-bf16-0c39edc64920",
            "created_at": "2022-10-27T08:27:13.212301Z",
            "updated_at": "2025-03-27T02:00:55.529662Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "Earth Lusca",
                "TAG-22",
                "Charcoal Typhoon",
                "CHROMIUM",
                "ControlX"
            ],
            "source_name": "MITRE:Earth Lusca",
            "tools": [
                "Mimikatz",
                "PowerSploit",
                "Tasklist",
                "certutil",
                "Cobalt Strike",
                "Winnti for Linux",
                "Nltest",
                "NBTscan",
                "ShadowPad"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535844,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653688321,
    "ts_modification_date": 1653688321,
    "files": {
        "pdf": "https://archive.orkl.eu/6fc5d895f86110c0c440cfa14ec2801ccb3a873e.pdf",
        "text": "https://archive.orkl.eu/6fc5d895f86110c0c440cfa14ec2801ccb3a873e.txt",
        "img": "https://archive.orkl.eu/6fc5d895f86110c0c440cfa14ec2801ccb3a873e.jpg"
    }
}