{
    "id": "bb4f84f0-f5fa-4721-a954-4fe8c023f950",
    "created_at": "2023-01-12T15:05:10.064783Z",
    "updated_at": "2025-03-27T02:05:43.010309Z",
    "deleted_at": null,
    "sha1_hash": "664bae30be94aaf1da60e11c697ed8f983e66820",
    "title": "2021-08-06 - IIStealer- A server‑side threat to e‑commerce transactions",
    "authors": "",
    "file_creation_date": "2022-05-28T02:46:32Z",
    "file_modification_date": "2022-05-28T02:46:32Z",
    "file_size": 1065480,
    "plain_text": "# IIStealer: A server‑side threat to e‑commerce transactions\n\n**[welivesecurity.com/2021/08/06/iistealer-server-side-threat-ecommerce-transactions/](https://www.welivesecurity.com/2021/08/06/iistealer-server-side-threat-ecommerce-transactions/)**\n\nAugust 6, 2021\n\nThe first in our series on IIS threats looks at a malicious IIS extension that intercepts server\ntransactions to steal credit card information\n\n[Zuzana Hromcová](https://www.welivesecurity.com/author/zhromcova/)\n6 Aug 2021 - 03:00PM\n\nThe first in our series on IIS threats looks at a malicious IIS extension that intercepts server\ntransactions to steal credit card information\n\n\n-----\n\nESET researchers have discovered and analyzed a previously undocumented trojan that\nsteals payment information from e-commerce websites’ customers. The trojan, which we\nnamed IIStealer, is detected by ESET security solutions as Win64/BadIIS.\n\n_This blogpost is the first installment in our series where ESET researchers put IIS web_\n_server threats under the microscope, with the other two parts discussing IIS malware used_\n_for_ _[cyberespionage and](https://www.welivesecurity.com/2021/08/09/iispy-complex-server-side-backdoor-antiforensic-features/)_ _[SEO fraud, respectively. For a comprehensive guide to how to](https://www.welivesecurity.com/2021/08/11/iiserpent-malware-driven-seo-fraud-service/)_\n_detect, analyze and remove IIS malware, refer to our white paper Anatomy of native IIS_\n_malware, where IIStealer is featured as one of the studied families (Group 5)._\n\n[Anatomy of native IIS malware](https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf)\n\n[Download Research Paper](https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf)\n\n## Attack overview\n\nIIStealer is implemented as a malicious extension for Internet Information Services (IIS),\nMicrosoft web server software. Being a part of the server, IIStealer is able to access all the\nnetwork communication flowing through the server and steal data of interest to the attackers\n– in this case, payment information from e-commerce transactions.\n\nAs illustrated in Figure 1, IIStealer operates by intercepting regular traffic between the\ncompromised server and its clients (the seller and the buyers), targeting HTTP POST\nrequests made to specific URI paths: /checkout/checkout.aspx or /checkout/Payment.aspx.\n\nWhenever a legitimate website visitor makes a request to these checkout pages (1),\nIIStealer logs the HTTP request body into a log file (2), without, in any way, interfering with\nthe HTTP reply generated by the components of the legitimate website (3).\n\nAdversaries can then exfiltrate the collected data by making a special HTTP request to the\ncompromised IIS server: once IIStealer detects a request made to a specific URI\n(/privacy.aspx) with an attacker password included in the X-IIS-Data header (4), it embeds\nthe collected data in the HTTP response for that request (5,6).\n\n\n-----\n\n_Figure 1. IIStealer: collection and exfiltration mechanisms_\n\nWith these capabilities, IIStealer is able to steal credit card information sent to e-commerce\n[websites that don’t use third-party payment gateways. Note that SSL/TLS and encrypted](https://en.wikipedia.org/wiki/Payment_gateway)\ncommunication channels don’t secure these transactions against IIStealer, as the malware\ncan access all data handled by the server – which is where the credit card information is\nprocessed in its unencrypted state.\n\nThe samples of this malware that we analyzed seem to be tailored for specific e-commerce\nwebsites (with hardcoded checkout page URIs). According to our telemetry, targeted were a\nsmall number of IIS servers in the USA, between September 2020 and January 2021, but\nthis is likely affected by our limited visibility into IIS servers – it is still common for\nadministrators to not use any security software on these servers.\n\n## Technical analysis\n\nIIStealer is implemented as a malicious, native IIS module – a C++ DLL dropped in the\n%windir%\\system32\\inetsrv\\ folder on the compromised IIS server and configured in the\n%windir%\\system32\\inetsrv\\config\\ApplicationHost.config file. In some cases, IIStealer is\ndeployed under the name dir.dll and, as seen in Figure 2, uses a forged VERSIONINFO\nresource to mimic a legitimate Windows IIS module called dirlist.dll.\n\n\n-----\n\n_Figure 2. IIStealer s VERSIONINFO resource (left) mimics legitimate dirlist.dll module (right)_\n\nBecause it is an IIS module, IIStealer is loaded automatically by the IIS Worker Process\n(w3wp.exe), which handles the requests sent to the IIS web server – this is how IIStealer\nachieves persistence, and how it can affect the processing of incoming requests.\n\nWe don’t have any information about how the malware is spread, but we know that\n[administrative privileges are required to install it as a native IIS module, which narrows](https://docs.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview)\ndown the candidates for the initial compromise. A configuration weakness or vulnerability in\na web application, or the server itself, are likely culprits.\n\nAs for its technical characteristics, IIStealer implements a core class inherited from\n[CHttpModule (module class) and overrides the CHttpModule::OnPostBeginRequest method](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/chttpmodule-class)\nwith its malicious code. As with all native IIS modules, IIStealer exports a function named\n[RegisterModule (see Figure 3), where it instantiates the module class and registers its](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/pfn-registermodule-function)\nmethods for server events – more specifically, it registers for the RQ_BEGIN_REQUEST\n[post-event notification that is generated every time the server starts processing an inbound](https://docs.microsoft.com/en-us/iis/web-development-reference/native-code-api-reference/request-processing-constants)\nHTTP request. As a result, the OnPostBeginRequest method is called with each new\nrequest, which allows IIStealer to affect the request processing.\n\n_Figure 3. IIStealer’s RegisterModule entry point_\n\nIn the OnPostBeginRequest handler, IIStealer filters incoming HTTP requests by request\nURIs. All POST requests made to /checkout/checkout.aspx or /checkout/Payment.aspx are\nlogged – along with their full HTTP bodies – into a file named C:\\Windows\\Temp\\cache.txt.\nThese requests are made by legitimate visitors of the compromised e-commerce websites\nand can contain sensitive information such as personal details and credit card numbers.\n\n\n-----\n\nThe collected data can be exfiltrated via a specifically crafted HTTP request from the\nattacker. This request must have an X-IIS-Data HTTP header set to a hardcoded, 32-byte\nalphanumeric password (that we have chosen not to disclose), and must be sent to a URL\npath specified in the malware sample:\n\n/privacy.aspx\n/checkout/Payment.aspx\n\nOnce the malicious module detects such a request, it uses the IHttpResponse::Clear\nmethod to delete any HTTP response prepared by the IIS server, and copies the\nunencrypted contents of the log file into the HTTP response body using the\nIHttpResponse::WriteEntityChunks API function, as seen in Figure 4.\n\n\n-----\n\n_Figure 4. IIStealer replaces the HTTP response body with its own data_\n\nThis allows the operators of IIStealer to access and exfiltrate the collected data by simply\nsending a special request to the compromised IIS server – there is no need for the malware\nto implement additional C&C channels, or embed any C&C server domains in its\nconfiguration.\n\n## Mitigation\n\nIIStealer is a server-side threat that eavesdrops on the communications between a\ncompromised e-commerce website and its customers, with the goal of stealing sensitive\npayment information – but of course, malicious IIS modules can also target credentials and\nother information. Even though SSL/TLS is vital in securing the transmission of the data\nbetween the client and the server, it doesn’t prevent this attack scenario as IIStealer is a\npart of the server. This should be disturbing for all serious web portals that want to protect\ntheir visitors’ data, including authentication and payment information.\n\nThe best way to harden an IIS server against IIStealer and other threats is to:\n\nUse dedicated accounts with strong, unique passwords for the administration of the\nIIS server.\nRegularly patch your OS, and carefully consider which services are exposed to the\ninternet, to reduce the risk of server exploitation.\nOnly install native IIS modules from trusted sources.\nConsider using a web application firewall, and/or endpoint security solution on your IIS\nserver.\nRegularly check the configuration file\n%windir%\\system32\\inetsrv\\config\\ApplicationHost.config, as well as the\n%windir%\\system32\\inetsrv\\ and %windir%\\SysWOW64\\inetsrv folders to verify that\nall the installed native modules are legitimate (signed by a trusted provider, or\ninstalled on purpose).\n\nFor web developers: Even if you don’t have control over the IIS server where your web\nservice is hosted, you can still take steps to reduce the impact on users of your web service\nin the case of a compromise, especially:\n\nDo not send the password itself to the server (not even over SSL/TLS); use a protocol\nsuch as [Secure Remote Password (SRP) to authenticate users without the need for](https://en.wikipedia.org/wiki/Secure_Remote_Password_protocol)\nthe unencrypted password to be transmitted to the server, nor data that could be used\nto reauthenticate. IIS infostealers are a good example of why server-side hashing is\nnot good enough.\nAvoid unnecessarily sending sensitive information from the web application; use\npayment gateways.\n\n\n-----\n\nIf you identify a successful compromise: notify all parties involved in any security\nbreach so they can take quick action.\n\nFor consumers: from the visitor’s perspective, it is impossible to know whether an IIS server\nis compromised, but these tips will help you reduce the risk:\n\nBe careful about where you enter your credit card number. Consider using payment\ngateways by trusted third-party providers on e-commerce websites whose reputation\nis unknown to you: with payment gateways, such websites won’t handle the sensitive\npayment information.\nKeep an eye on your credit statement for small or unusual payments: often small\namounts are processed to test whether the cards are valid.\nIf you spot something unusual, notify your bank immediately.\n\n_Additional technical details on the malware, Indicators of Compromise and YARA rules can_\n_[be found in our comprehensive white paper, and on](https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Anatomy-Of-Native-Iis-Malware-wp.pdf)_ _[GitHub. For any inquiries, or to make](https://github.com/eset/malware-ioc/tree/master/badiis)_\n_[sample submissions related to the subject, contact us at: threatintel@eset.com.](http://10.10.0.46/mailto:threatintel@eset.com)_\n\n**_Read next:_**\n_[Anatomy of native IIS malware](https://www.welivesecurity.com/2021/08/06/anatomy-native-iis-malware/)_\n_[IISpy: A complex server‑side backdoor with anti‑forensic features](https://www.welivesecurity.com/2021/08/09/iispy-complex-server-side-backdoor-antiforensic-features/)_\n_[IISerpent: Malware‑driven SEO fraud as a service](https://www.welivesecurity.com/2021/08/11/iiserpent-malware-driven-seo-fraud-service/)_\n\n## Indicators of Compromise (IoCs)\n\n### ESET detection names\n\nWin64/BadIIS.F\n\nWin64/BadIIS.O\n\n### SHA-1\n\n706EAB59C20FCC9FBC82C41BF955B5C49C644B38\n\n7A2FA07A7DC05D50FE8E201A750A3DC7F22D6549\n\nA1C5E7424E7C4C4C9902A5A1D97F708C6BB2F53A\n\n### Filenames and paths\n\ndir.dll\nisapicache___.dll\n\nisapicache_.dll_\n\nC:\\Windows\\Temp\\cache.txt\n\n## Network indicators\n\n\n-----\n\n### Targeted URIs\n\n/checkout/checkout.aspx\n\n/checkout/Payment.aspx\n\n/privacy.aspx\n\n### HTTP header\n\nX-IIS-Data\n\n## MITRE ATT&CK techniques\n\n_[Note: This table was built using version 9 of the MITRE ATT&CK framework.](https://attack.mitre.org/resources/versions/)_\n\n**Tactic** **ID** **Name** **Description**\n\n\nResource\nDevelopment\n\n\n[T1587.001](https://attack.mitre.org/versions/v9/techniques/T1587/001/) Develop Capabilities:\nMalware\n\n\nIIStealer is a custom-made malware\nfamily.\n\nIIS server (and by extension,\nIIStealer) persists as a Windows\nservice.\n\nIIStealer is loaded by IIS Worker\nProcess (w3wp.exe) when the IIS\nserver receives an inbound HTTP\nrequest.\n\nIIStealer has been deployed under\nthe name dir.dll, in an attempt to\nmimic a legitimate Microsoft IIS\nmodule called dirlist.dll.\n\n\nExecution [T1569.002](https://attack.mitre.org/versions/v9/techniques/T1569/002/) System Services:\nService Execution\n\nPersistence [T1546](https://attack.mitre.org/versions/v9/techniques/T1546/) Event Triggered\nExecution\n\n\nDefense\nEvasion\n\n\n[T1036.005](https://attack.mitre.org/versions/v9/techniques/T1036/005/) Masquerading:\nMatch Legitimate\nName or Location\n\n\n[T1027](https://attack.mitre.org/versions/v9/techniques/T1027/) Obfuscated\nFiles or\nInformation\n\n\nIIStealer uses string\nstacking in an\nattempt to avoid\nsome string-based\ndetection.\n\n\nCredential\nAccess\n\n\n[T1056](https://attack.mitre.org/versions/v9/techniques/T1056/) Input Capture IIStealer intercepts network traffic\nbetween the IIS server and its\nclients to collect sensitive\ninformation such as credit card\ndetails.\n\n\nCollection [T1119](https://attack.mitre.org/versions/v9/techniques/T1119/) Automated Collection IIStealer automatically collects\ninformation from inbound HTTP\nrequests, such as credit card\ndetails.\n\n\n-----\n\n**Tactic** **ID** **Name** **Description**\n\n\n[T1074.001](https://attack.mitre.org/versions/v9/techniques/T1074/001/) Data\nStaged:\nLocal Data\nStaging\n\n\nIIStealer uses a local\nfile to stage collected\ninformation.\n\n\nCommand\nand Control\n\n\n[T1071.001](https://attack.mitre.org/versions/v9/techniques/T1071/001/) Application Layer\nProtocol: Web\nProtocols\n\n\nExfiltration [T1041](https://attack.mitre.org/versions/v9/techniques/T1041/) Exfiltration Over C2\nChannel\n\n6 Aug 2021 - 03:00PM\n\n\nAdversaries send HTTP requests to\nthe compromised IIS server to\ncontrol IIStealer.\n\nIIStealer uses its C&C channel to\nexfiltrate collected data: HTTP\nrequests are sent by the adversary\nto the compromised IIS server.\n\n\n### Sign up to receive an email update whenever a new article is published in our Ukraine Crisis – Digital Security Resource Center\n\n Newsletter\n\n Discussion\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-08-06 - IIStealer- A server‑side threat to e‑commerce transactions.pdf"
    ],
    "report_names": [
        "2021-08-06 - IIStealer- A server‑side threat to e‑commerce transactions.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535910,
    "ts_updated_at": 1743041143,
    "ts_creation_date": 1653705992,
    "ts_modification_date": 1653705992,
    "files": {
        "pdf": "https://archive.orkl.eu/664bae30be94aaf1da60e11c697ed8f983e66820.pdf",
        "text": "https://archive.orkl.eu/664bae30be94aaf1da60e11c697ed8f983e66820.txt",
        "img": "https://archive.orkl.eu/664bae30be94aaf1da60e11c697ed8f983e66820.jpg"
    }
}