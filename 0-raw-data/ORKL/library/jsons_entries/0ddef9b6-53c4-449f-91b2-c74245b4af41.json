{
    "id": "0ddef9b6-53c4-449f-91b2-c74245b4af41",
    "created_at": "2023-01-12T15:03:54.975027Z",
    "updated_at": "2025-03-27T02:06:15.432711Z",
    "deleted_at": null,
    "sha1_hash": "53b5ebe67835d52d73e79d52f96a7ef6579d5d7d",
    "title": "2021-04-28 - VB6 P-Code Obfuscation",
    "authors": "",
    "file_creation_date": "2022-05-29T10:48:17Z",
    "file_modification_date": "2022-05-29T10:48:17Z",
    "file_size": 1649447,
    "plain_text": "# VB6 P-Code Obfuscation\n\n**decoded.avast.io/davidzimmer/vb6-p-code-obfuscation/**\n\nby [David ZimmerApril 28, 20216 min read](https://decoded.avast.io/author/davidzimmer/)\n\n\nApril 28, 2021\n\n\nCode obfuscation is one of the cornerstones of malware. The harder code is to analyze the\nlonger attackers can fly below the radar and hide the full capabilities of their creations.\n\nCode obfuscation techniques are very old and take many many forms from source code\nmodifications, opcode manipulations, packer layers, virtual machines and more.\n\nObfuscations are common amongst native code, script languages, `.NET IL, and` `Java`\n```\nbyte code .\n\n```\nAs a defender, itâ€™s important to be able to recognize these types of tricks, and have tools\nthat are capable of dealing with them. Understanding the capabilities of the medium is\nparamount to determine what is junk, what is code, and what may simply be a tool error in\ndata display.\n\nOn the attackers side, in order to develop a code obfuscation there are certain prerequisites\nrequired. The attacker needs tooling and documentation that allows them to craft and debug\nthe complex code flow.\n\nFor binary implementations such as `native code or` `IL, this would involve specs of the`\ntarget file format, documentation on the opcode instruction set, disassemblers, assemblers,\nand a capable debugger.\n\nOne of the code formats that has not seen common obfuscation has been the `Visual`\n```\nBasic 6 P-Code byte streams. This is a proprietary opcode set, in a complex file format,\n\n```\nwith limited tooling available to work with it.\n\nIn the course of exploring this instruction set certain questions arose:\n\nCan `VB6 P-Code be obsfuscated at the byte stream layer?`\nHas this occurred in samples in the wild?\n\n\n-----\n\nWhat would this look like?\nDo we have tooling capable of handling it?\n\n## Background\n\nBefore we continue, we will briefly discuss the `VB6 P-Code format and the tools`\navailable for working with it.\n```\nVB6 P-Code is a proprietary, variable length, binary instruction set that is interpreted by\n\n```\nthe `VB6 Virtual Machine ( msvbvm60.dll ).`\n\nIn terms of documentation, Microsoft has never published details of the `VB6 file format`\nor opcode instruction set. The opcode handler names were gathered by reversers from the\ndebug symbols leaked with only a handful of runtimes.\n\nAt one time there was a reversing community, vb-decompiler.theautomaters.com, which\nwas dedicated to the `VB6 file format and P-Code instruction set. Mirrors of this message`\nboard are still available today [1].\n\nOn the topic of tooling the main disassemblers are `p32Disasm,` `VB-Decompiler,` `Semi-`\n```\nVbdecompiler and the WKTVBDE P-Code debugger.\n\n```\nOf these only Semi-Vbdecompiler shows you the full argument byte stream, the rest display\nonly the opcode byte. While several private P-Code debuggers exist, `WKTVBDE is the only`\npublic tool with debugging capabilities at the P-Code level.\n\nIn terms of opcode meanings. This is still widely undocumented at this point. Beyond\nintuition from their names you would really have to compile your own programs from source,\ndisassemble them, disassemble the opcode handlers and debug both the native runtime\nand P-Code to get a firm grasp of whats going on.\n\nAs you can glimpse, there is a great deal of information required to make sense of P-Code\ndisassembly and it is still a pretty dark art for most reversers.\n\n## Do VB6 obfuscators exist?\n\nWhile doing research for this series of blog posts we started with an initial sample set of\n```\n25,000 P-Code binaries which we analyzed using various metrics.\n\n```\nCommon tricks `VB6 malware uses to obfuscate their intent include:`\n\njunk code insertion at source level\ninclusion of large bodies of open source code to bulk up binary\nrandomized internal object and method names\n\nmostly commonly done at pre-compilation stage\nsome tools work post compilation.\n\n\n-----\n\nall manner of encoded strings and data hiding\nnative code blobs launched with various tricks such as `CallWindowProc`\n\nTo date, we have not yet documented P-Code level manipulations in the wild.\n\nDue to the complexity of the vector, P-Code obsfuscations could have easily gone\nundetected to date which made it an interesting area to research. Hunting for samples will\ncontinue.\n\n## Can VB P-Code even be obfuscated and what would that look like?\n\nIn the course of research, this was a natural question to arise. We also wanted to make\nsure we had tooling which could handle it.\n\nConsider the following `VB6 source:`\n\nThe default P-Code compilation is as follows:\n\n\n-----\n\nAn obsfuscated sample may look like the following:\n\n\n-----\n\nFrom the above we see multiple opcode obfuscation tricks commonly seen in native code.\n\nIt has been verified that this code runs fine and does not cause any problems with the\nruntime. This mutated file has been made available on `Virustotal in order for vendors to`\ntest the capabilities of their tooling [2].\n\nTo single out some of the tricks:\n\nJump over junk:\n\n\n-----\n\nJumping into argument bytes:\n\nAt runtime what executes is:\n\nDo nothing sequences:\n\nInvalid sequences which may trigger fatal errors in disassembly tools:\n\n\n-----\n\n## Detection\n\nThe easiest markers of P-Code obfuscation are:\n\njumps into the middle of other instructions\nunmatched for/next opcodes counts\ninvalid/undefined opcodes\nunnatural opcode sequences not produced by the compiler\nerrors in argument resolution from randomized data\n\nSome junk sequences such as `Not Not can show up normally depending on how a`\nroutine was coded.\n\nThis level of detection will require a competent, error-free, disassembly engine that is aware\nof the full structures within the `VB6 file format.`\n\n## Conclusion\n\nCode obfuscation is a fact of life for malware analysts. The more common and well\ndocumented the file format, the more likely that obfuscation tools are wide spread in the\nwild.\n\nThis reasoning is likely why complex formats such as `.NET and` `Java had many public`\nobfuscators early on.\n\nThis research proves that `VB6 P-Code obfuscation is equally possible and gives us the`\nopportunity to make sure our tools are capable of handling it before being required in a time\nconstrained incident response.\n\nThe techniques explored here also grant us the insight to hunt for advanced threats which\nmay have been already using this technique and had flown under the radar for years.\n\nWe encourage researchers to examine the mutated sample [ 2 ] and make sure that their\nframeworks can handle it without error.\n\n\n-----\n\n## References\n\n[1] vb-decompiler.theautomaters.com mirror\n\n[http://sandsprite.com/vb-reversing/vb-decompiler/](http://sandsprite.com/vb-reversing/vb-decompiler/)\n\n[2] Mutated P-Code sample SHA256 and VirusTotal link\n\n[a109303d938c0dc6caa8cd8202e93dc73a7ca0ea6d4f3143d0e851cd39811261](https://www.virustotal.com/gui/file/a109303d938c0dc6caa8cd8202e93dc73a7ca0ea6d4f3143d0e851cd39811261/details)\n\n[Tagged ashidding,](https://decoded.avast.io/tag/hidding/) [malware,](https://decoded.avast.io/tag/malware/) [obfuscation,](https://decoded.avast.io/tag/obfuscation/) [P-Code,](https://decoded.avast.io/tag/p-code/) [Research,](https://decoded.avast.io/tag/research/) [series,](https://decoded.avast.io/tag/series/) [VB](https://decoded.avast.io/tag/vb/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-28 - VB6 P-Code Obfuscation.pdf"
    ],
    "report_names": [
        "2021-04-28 - VB6 P-Code Obfuscation.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535834,
    "ts_updated_at": 1743041175,
    "ts_creation_date": 1653821297,
    "ts_modification_date": 1653821297,
    "files": {
        "pdf": "https://archive.orkl.eu/53b5ebe67835d52d73e79d52f96a7ef6579d5d7d.pdf",
        "text": "https://archive.orkl.eu/53b5ebe67835d52d73e79d52f96a7ef6579d5d7d.txt",
        "img": "https://archive.orkl.eu/53b5ebe67835d52d73e79d52f96a7ef6579d5d7d.jpg"
    }
}