{
    "id": "6fa87287-c85f-410a-8532-7d722c90daab",
    "created_at": "2022-10-25T16:48:16.84246Z",
    "updated_at": "2025-03-27T02:15:41.701531Z",
    "deleted_at": null,
    "sha1_hash": "dfd64e9a601283c76ae3f28875166695dc354a21",
    "title": "The Darkhotel Apt A Story Of Unusual Hospitality v1.0",
    "authors": "Kaspersky",
    "file_creation_date": "2014-11-10T11:05:41Z",
    "file_modification_date": "2014-11-10T11:06:05Z",
    "file_size": 3693040,
    "plain_text": "# The Darkhotel APT A Story of Unusual Hospitality\n\n##### Version 1.0 November, 2014\n\n#### Global Research and Analysis Team\n\n\n-----\n\n## Contents\n\nExecutive Summary.................................................................................................3\n\nIntroduction.............................................................................................................4\n\nAnalysis....................................................................................................................5\nDelivery - Hotels/Business Centers and Indiscriminate Spread.....................5\nHotels and Business Centers Spread.........................................................5\nAbusing Network Infrastructure...................................................................6\nIndiscriminate Spread..................................................................................7\nDarkhotel Spear-phishing Campaigns........................................................8\nRecent 0-day Deployment...........................................................................9\nDigital Certificates and Delegitimizing Certificate Authority Trust...................9\nCracking the keys...................................................................................... 12\nOther Tapaoux Certificates........................................................................ 12\nEnhanced Keyloggers and Development...................................................... 13\nKeylogger Code.......................................................................................... 13\n\nInteresting Malware Components....................................................................... 15\nSmall Downloader.......................................................................................... 15\nInformation Stealer......................................................................................... 16\nTrojan.Win32.Karba.e..................................................................................... 17\nTrojan-Dropper & Injector (infected legitimate files)..................................... 17\nSelective Infector............................................................................................ 18\nCampaign Codes............................................................................................. 18\n\nInfrastructure and Victims................................................................................... 19\nSinkhole Domains........................................................................................... 19\nVictim Locations - KSN and Sinkhole Data.................................................... 20\nKSN Data................................................................................................... 20\nSinkhole Data............................................................................................ 22\nAvailable ddrlog Victim Data........................................................................... 22\nC2 Communications and Structure............................................................... 24\nVictim Management........................................................................................ 25\nResearcher Activity.................................................................................... 26\n\nConclusions.......................................................................................................... 27\n\n\n-----\n\n## Executive Summary\nThe Darkhotel APT is a threat actor possessing a seemingly inconsistent and contradictory set of characteristics, some advanced and some fairly rudimentary. Inhospitably operating for almost a decade, the threat actor is currently active. The\nactor’s offensive activity can be tied to specific hotel and business center Wi‑Fi\nand physical connections, some of it is also tied to p2p/file sharing networks,\nand they have been known to spear-phish targets as well. Darkhotel tools are\ndetected as “Tapaoux”, “Pioneer”, “Karba”, and “Nemim”, among other names.\nThe following list presents a set of characteristics for the crew:\n\n- operational competence to compromise, mis-use, and maintain access to\nglobal scale, trusted commercial network resources with strategic precision\nfor years\n\n- advanced mathematical and crypto-analytical offensive capabilities, along\nwith no regard for undermining the trust extended to the Certificate Authorities\nand the PKI\n\n- indiscriminately infect systems with some regional clarity over trusted and\nuntrusted resources to build and operate large botnets\n\n- well-developed low level keyloggers within an effective and consistent toolset\n\n- a focus throughout campaigns on specific victim categories and tagging them\n\n- a larger, dynamic infrastructure built of apache webservers, dynamic dns\nrecords, crypto libraries, and php webapps\n\n- regular 0-day access - recent deployment of an embedded Adobe Flash 0-day\nspear-phishing exploit, and infrequent deployment of other 0-day resources to\nsustain larger campaigns over several years\n\n\n-----\n\n## Introduction\nWhen unsuspecting guests, including situationally aware corporate executives and\nhigh-tech entrepreneurs, travel to a variety of hotels and connect to the internet,\nthey are infected with a rare APT Trojan posing as any one of several major software\nreleases. These might be GoogleToolbar, Adobe Flash, Windows Messenger, etc.\nThis first stage of malware helps the attackers to identify more significant victims,\nleading to the selective download of more advanced stealing tools.\n\nAt the hotels, these installs are selectively distributed to targeted individuals. This\ngroup of attackers seems to know in advance when these individuals will arrive\nand depart from their high-end hotels. So, the attackers lay in wait until these\ntravelers arrive and connect to the Internet.\n\nThe FBI issued advisories about similar hotel incidents; Australian government officials produced similar, newsworthy accounts when they were infected. While an FBI\nannouncement related to attacks on hotel guests overseas appeared in May 2012,\nrelated Darkhotel samples were already circulating back in 2007. And available\nDarkhotel server log data records connections as early as Jan 1, 2009. Additionally, seeding p2p networks with widely spread malware and 0-day spear-phishing\nattacks demonstrate that the Darkhotel APT maintains an effective toolset and a\nlong-running operation behind the questionable hospitality it shows its guests.\n\n\n-----\n\n## Analysis\n\n##### Delivery - Hotels/Business Centers and Indiscriminate Spread\n\n###### Hotels and Business Centers Spread\nThe Darkhotel APT’s precise malware spread was observed in several hotels’\nnetworks, where visitors connecting to the hotel’s Wi-Fi were prompted to install\nsoftware updates to popular software packages.\n\nOf course, these packages were really installers for Darkhotel APT’s backdoors,\nadded to legitimate installers from Adobe and Google. Digitally signed Darkhotel\nbackdoors were installed alongside the legitimate packages.\n\nThe most interesting thing about this delivery method is that the hotels require\nguests to use their last name and room number to login, yet only a few guests\nreceived the Darkhotel package. When visiting the same hotels, our honeypot\nresearch systems couldn’t attract a Darkhotel attack. This data is inconclusive,\nbut it points to misuse of check in information\n\n\n-----\n\n###### Abusing Network Infrastructure\nThe Darkhotel actor maintained an effective intrusion set at hotel networks,\nproviding ample access to unexpected points of attack over several years. These\nstaging points also provide the attackers with access to check-in/check-out and\nidentity information of visitors to high-end and luxury hotels.\n\nAs a part of an ongoing investigation, our research led us to embedded iframes\nwithin hotel networks that redirected individuals’ web browsers to phony installers. The attackers were very careful with the placement of these iframes and\nexecutables on trusted resources - the hotels’ network login portals themselves.\nThe attackers were also very careful to immediately delete all traces of their\ntools as soon as an attack was carried out successfully. Those portals are now\nreviewed, cleaned and undergoing a further review and hardening process. We\nobserved traces of a couple of these incidents in late 2013 and early 2014 on\na victim hotel’s network. The attackers set up the environment and hit their\nindividual targets with precision. As soon as their target’s stay was over and\nthe attack-frame was closed, the attackers deleted their iframe placement and\nbackdoored executables from the hotel network. The attackers successfully deleted traces of their work from earlier attacks in another hotel, but their offensive\ntechniques were the same. Outside reports of the same activity at other hotels\nprovide enough data to confirm the same careful operations there.\n\nThe attack technique blurs the line between a couple of common APT tactics;\nfairly inaccurate “watering holes” or “strategic web compromises” and more\naccurate spearphishing techniques. In this case, the Darkhotel attackers wait\nfor their victim to connect to the Internet over the hotel Wi-Fi or the cable in their\nroom. There is a very strong likelihood the targets will connect over these resources, and the attackers rely on that likelihood, much like at a watering hole. But the\nattackers also maintain truly precise targeting information over the victim’s visit,\nmuch like they would know a victim’s email address and content interests in a\nspearphishing attack. While setting up the attack, the Darkhotel attackers knew\nthe target’s expected arrival and departure times, room number, and full name,\namong other data. This data enables the attackers to present the malicious\niframe precisely to that individual target. So, here we have yet another unique\ncharacteristic of this attacker - they employ a loosely certain but highly precise\noffensive approach.\n\n\n-----\n\n###### Indiscriminate Spread\nAn example of the Darkhotel APT’s indiscriminate malware spreading is demonstrated by the way it seeds Japanese p2p sharing sites, where the malware\nis delivered as a part of a large (approximately 900mb) rar archive. The archive\nis also spread over bittorrent, as detailed below. Darkhotel uses this method to\ndistribute their Karba Trojan. These Japanese archives, translated for Chinese\nspeaking viewers, appear to be sexual in nature, part of an anime sex/military\ncomic scene, exposing the likely interests of potential targets.\n\nThis Darkhotel package was downloaded over 30,000 times in less than\nsix months. The p2p bittorrent Darkhotel offering is listed here, posted on\n2013.11.22. It was spread throughout 2014.\n\n(一般コミック) [古味直志] ニセコイ 第01­09巻.rar\n\nThis torrent serves up an almost 900 mb file. The rar archive decompresses to\na directory full of encrypted zips, the associated decryptor and a password file for\ndecrypting the zips. But what looks like the AxDecrypt.exe decryptor is bound to\nboth the true decryptor and the dropper for the Darkhotel Catch.exe Karba Trojan.\nWhen a user downloads the torrent and decrypts the zip files, the trojan surreptitiously is installed and run on the victim system.\n\nCatch.exe, detected as Backdoor.Win32.Agent.dgrn, communicates with the following Darkhotel command and control servers:\n\nmicrodelta.crabdance.com\nmicroyours.ignorelist.com\nmicronames.jumpingcrab.com\nmicrochisk.mooo.com\ni lb ft\n\n\n-----\n\nOther examples of this Darkhotel backdoor bound within a shared torrent include\nadult content Japanese anime and more. There are tens of thousands of downloads of these individual torrents.\n\n“torrent\\[hgd资源组][漫画]comic1☆7漫画合集③+④+⑤+特典[5.08g][绅士\n向][总第四十三弹]（七夕节快乐！）\\汉化\\(comic1☆7) [莉零 (小鹿りな, 古\n代兵器)] 凌 ­shinogi­ (闪乱カグラ) [中文] “\n\nand\n\n“動漫\\[hgd资源组][漫画]comic1☆7漫画合集③+④+⑤+特典[5.08g][绅士向][\n总第四十三弹]（七夕节快乐！）\\汉化”)\n\nThe associated Darkhotel backdoor was hosted on bittorrent, emule, etc, under\na variety of comic names. Examples include comics and anime offerings. Related\nDarkhotel command and control server domains include:\n\nmicroblo5.mooo.com\nmicroyours.ignorelist.com\nmicronames.jumpingcrab.com\nmicrochisk.mooo.com\nmicroalba.serveftp.com\n\n###### Darkhotel Spear-phishing Campaigns\nDarkhotel campaigns involving typical spear-phished Tapaoux implants publicly\nappeared in bits and pieces several times over the past five years. These subproject\nefforts targeted defense industrial base (DIB), government, and NGO organizations.\nEmail content on topics like nuclear energy and weaponry capabilities was used as\n[a lure. Early accounts were posted on contagio describing attacks on NGO organi-](http://contagiodump.blogspot.com/2010/04/apr-23-link-hta-w-trojanwin32tapaouxa.html)\nzations and government policy makers. This spear-phishing activity continues into\n2014. The attacks follow the typical spear-phishing process and in the past couple of\nmonths, exploited systems retrieved downloader executables from web servers like\nhxxp://office­revision.com/update/files22/update.exe or hxxp://trade­inf.com/mt/\nduspr.exe\n\nOver the past few years the group has emailed links that redirect targets’ browsers to Internet Explorer 0-day exploits. Sometimes the attachment itself includes\nan Adobe 0-day exploit.\n\n\n-----\n\n###### Recent 0-day Deployment\nThis crew occasionally deploys 0-day exploits, but burns them when required. In\nthe past few years, they deployed 0-day spear-phishing attacks targeting Adobe\nproducts and Microsoft Internet Explorer, including cve­2010­0188. In early 2014,\nour researchers exposed their use of cve­2014­0497, a Flash 0-day described on\n[Securelist in early February.](http://securelist.com/blog/incidents/58244/cve-2014-0497-a-0-day-vulnerability/)\n\nThe crew spear-phished a set of target systems connected to the Internet through\nChinese ISPs, and developed capabilities within the 0-day exploits to handle\nhardened Windows 8.1 systems. It’s interesting that the Flash objects were\nembedded in Korean documents titled “List of the latest Japanese AV wind and\nhow to use torrents.docx” (loose English translation). The dropped downloader\n(d8137ded710d83e2339a97ee78494c34) delivered malcode similar to the\n“Information Stealer” component functionality summarized below, and detailed\nin Appendix D.\n\n##### Digital Certificates and Delegitimizing Certificate Authority Trust\nThe Darkhotel actors typically sign their backdoors with digital certificates of one\nkind or another. However, the certificates originally chosen by this crew are very\ninteresting because of their weak keys and likely abuse by attackers. Here is a\nlisting of the certs that were commonly used to sign Darkhotel malcode, requiring\nadvanced mathematical capabilities to factorize the keys at the time. They are\nnot the only certificates used by the group. More recent activity suggests that the\ngroup has stolen certificates to sign their code.\n\nSubordinate\nCA Root CA/Issuer Owner Status Valid From Valid To\nGTE Digisign Server ID flexicorp.jaring.my sha1/ Expired 12/17/2008 12/17/2010\nCyberTrust (Enrich) RSA (512 bits)\n\nGTE Cybertrust inpack.syniverse.my Revoked 2/13/2009 2/13/2011\nCyberTrust SureServer CA sha1/RSA (512 bits)\n\nGTE Cybertrust inpack.syniverse.com Revoked 2/13/2009 2/13/2011\nCyberTrust SureServer CA sha1/RSA (512 bits)\n\n\nGTE Anthem Inc ahi.anthem.com sha1/\nCyberTrust Certificate Auth RSA (512 bits)\n\n\nInvalid Sig. 1/13/2010 1/13/2011\n\n\n-----\n\nSubordinate\nCA Root CA/Issuer Owner Status Valid From Valid To\nGlobalSign Deutsche Telekom www.kuechentraum2 Revoked 10/20/2008 10/25/2009\nCA 5 4.de\n\nsha1/RSA (512 bits)\n\n\nGTE Digisign Server ID payments.bnm.gov.m y\nCyberTrust (Enrich) sha1/RSA (512 bits)\n\n\nInvalid Sig. 12/7/2009 12/7/2010\n\n\nGTE TaiCA Secure CA esupplychain.com.tw Expired 7/2/2010 7/17/2011\nCyberTrust sha1/RSA (512 bits)\n\n\nGTE Digisign Server ID mcrs2.digicert.com. my\nCyberTrust (Enrich) sha1/RSA (512 bits)\n\nGTE Cybertrust agreement.syniverse.\nCyberTrust SureServer CA com sha1/RSA (512 bits)\n\nGTE Cybertrust ambermms.syniverse.\nCyberTrust SureServer CA com\n\nsha1/RSA (512 bits)\n\n\nEquifax\nSecure\neBusiness\nCA­1\n\n\nEquifax Secure secure.hotelreykjavik.i s\neBusiness CA­1 md5/RSA (512 bits)\n\n\nGTE Cybertrust stfmail.ccn.ac.uk sha1/\nCyberTrust Educational CA RSA (512 bits)\n\nGTE Digisign Server ID webmail.jaring.my sha1/\nCyberTrust (Enrich) RSA (512 bits)\n\nGTE Cybertrust skillsforge.londonmet.\nCyberTrust Educational CA ac.uk\n\nsha1/RSA (512 bits)\n\nGTE Digisign Server ID anjungnet.mardi.gov. my\nCyberTrust (Enrich) sha1/RSA (512 bits)\n\nGTE Anthem Inc dl­ait­middleware@an\nCyberTrust Certificate Authority them.com\n\nsha1/RSA (512 bits)\n\nGTE Cybertrust ad­idmapp.cityofbrist\nCyberTrust Educational CA ol.ac.uk\n\nsha1/RSA (512 bits)\n\nVerisign Verisign Class 3 secure2.eecu.com sha1/\nSecure OFX CA G3 RSA (512 bits)\n\nRoot Agency Root Agency Microsoft\n\nmd5/RSA (1024 bits)\n\n\nInvalid Sig 3/28/2010 3/28/2012\n\nInvalid Sig 2/13/2009 2/13/2011\n\nInvalid Sig. 2/16/2009 2/16/2011\n\nInvalid Sig 2/27/2005 3/30/2007\n\nInvalid Sig. 11/12/2008 11/12/2011\n\nInvalid Sig 6/1/2009 6/1/2011\n\nInvalid Sig 1/16/2009 1/16/2012\n\nInvalid Sig 9/29/2009 9/29/2011\n\nInvalid Sig 4/22/2009 4/22/2010\n\nInvalid Sig 9/11/2008 9/11/2011\n\nInvalid Sig 10/25/2009 10/26/2010\n\nInvalid Sig 6/9/2009 12/31/2039\n\n\n-----\n\nSubordinate\nCA Root CA/Issuer Owner Status Valid From Valid To\nGTE CyberTrust trainingforms.syniverse. Invalid Sig 2/17/2009 2/17/2011\nCybertrust SureServer CA com\n\nsha1/RSA (512 bits)\n\nAll related cases of signed Darkhotel malware share the same Root Certificate\nAuthority and Intermediate Certificate Authority that issued certificates with\nweak md5 keys (RSA 512 bits). We are confident that our Darkhotel threat actor\nfraudulently duplicated these certificates to sign its malware. These keys were\n[not stolen. Many of the certificates were noted in a 2011 Fox­IT post “RSA­512](http://blog.fox-it.com/2011/11/21/rsa-512-certificates-abused-in-the-wild/)\n[Certificates Abused in the Wild”.](http://blog.fox-it.com/2011/11/21/rsa-512-certificates-abused-in-the-wild/)\n\nTo further support this speculation please note the non­specific Microsoft Security\nAdvisory below, the Mozilla advisory addressing the issue at the time, and the\nEntrust responses.\n\n[From Microsoft’s security advisory from Thursday, November 10, 2011:](http://technet.microsoft.com/en)\n\n“Microsoft is aware that DigiCert Sdn. Bhd, a Malaysian subordinate certification authority (CA) under Entrust and GTE CyberTrust, has issued 22 certificates with weak 512 bit keys. These weak encryption keys, when broken, could\nallow an attacker to use the certificates fraudulently to spoof content, perform\nphishing attacks, or perform man­in­the­middle attacks against all Web browser\nusers including users of Internet Explorer. While this is not a vulnerability in a\nMicrosoft product, this issue affects all supported releases of Microsoft Windows.\n\nThere is no indication that any certificates were issued fraudulently. Instead,\ncryptographically weak keys have allowed some of the certificates to be duplicated and used in a fraudulent manner.\n\nMicrosoft is providing an update for all supported releases of Microsoft Windows\nthat revokes the trust in DigiCert Sdn. Bhd. The update revokes the trust of the\nfollowing two intermediate CA certificates: Digisign Server ID – (Enrich), issued by\nEntrust.net Certification Authority (2048) Digisign Server ID (Enrich), issued by\nGTE CyberTrust Global Root”\n\n[From Mozilla’s 2011 response:](https://blog.mozilla.org/security/2011/11/03/revoking-trust-in-digicert-sdn-bhd-intermediate-certificate-authority/)\n\n“While there is no indication they were issued fraudulently, the weak keys have\nallowed the certificates to be compromised. Furthermore, certificates from this\nCA contain several technical issues. They lack an EKU extension specifying their\nintended usage and they have been issued without revocation information.”\n\n\n-----\n\n[From Entrust’s response:](http://www.entrust.net/advisories/malaysia.htm)\n\n“There is no evidence that the Digicert Malaysia certificate authorities have been\ncompromised.”\n\n###### Cracking the keys\nHere are some notes on the costs and technical requirements of attacking these\ncertificates.\n\nThe computing power required to crack and factor an RSA 512 bit key was $5000\n[and the period of time required was about 2 weeks. (see http://lukenotricks.](http://lukenotricks.blogspot.co.at/2010/03/rsa-512-factoring-service-two-weeks.html)\n[blogspot.co.at/2010/03/rsa­512­factoring­service­two­weeks.html)](http://lukenotricks.blogspot.co.at/2010/03/rsa-512-factoring-service-two-weeks.html)\n\n[In October 2012, Tom Ritter reported that it would cost about $120­-$150, per-](https://twitter.com/TomRittervg/status/263652369257070593)\nhaps even as little as $75.\n\nGoing even further back, there was much discussion about the technical methods of cracking these keys:\n[DJ Bernstein’s 2001 paper on building a machine reducing the cost of integer](http://cr.yp.to/papers/nfscircuit.pdf)\nfactorization with Number Field Sieve techniques, breaking 1024 bit RSA keys.\n\n[RSA’s reaction and 2002 statement on whether or not 1024 bit RSA keys are](http://www.emc.com/emc-plus/rsa-labs/historical/has-the-rsa-algorithm-been-compromised.htm)\nbroken: “NIST offered a table of proposed key sizes for discussion at its key management workshop in November 2001 [7]. For data that needs to be protected no\nlater than the year 2015, the table indicates that the RSA key size should be at\nleast 1024 bits. For data that needs to be protected longer, the key size should be\nat least 2048 bits.”\n\n###### Other Tapaoux Certificates\nRecent Tapaoux attacks and backdoors include malware signed with strong\nSHA1/RSA 2048 bit certificates, suggesting certificate theft.\n\nSubordinate\nCA Root CA/Issuer Owner Status Valid From Valid To\nthawte thawte Primary Xuchang Hongguang Revoked 7/18/2013 7/16/2014\nRoot CA Technology Co.,Ltd.\nsha1/RSA (2048bits)\n\n\nthawte thawte Primary Ningbo Gaoxinqu\nRoot CA zhidian Electric Power\nTechnology Co., Ltd.\n\nsha1/RSA (2048bits)\n\n\nRevoked 11/5/2013 11/5/2014\n\n\n-----\n\n##### Enhanced Keyloggers and Development\nOne of the most interesting components that we discovered as a part of this campaign was the use of a digitally­signed advanced keylogger. It is clean, well­written,\nkernel level malcode. The languages of its strings are a mix of English and Korean. It\n[is signed with the familiar “belinda.jablonski@syniverse.com” digital certificate.](mailto:belinda.jablonski@syniverse.com)\n\nThis keylogger is dropped by code running within svchost.exe on WinXP SP3,\nwhich maintains an interesting debug string:\nd:\\KerKey\\KerKey(일반)\\KerKey\\release\\KerKey.pdb\n\nNote 일반 means “General” in Korean\n\nIt probably was developed as a part of a mid-to-late 2009 project:\ne:\\project\\2009\\x\\total_source\\32bit\\ndiskpro\\src\\ioman.c\n\n###### Keylogger Code\nThis driver package is built to resemble a legitimate low-level Microsoft system\ndevice. It is installed as a system kernel driver “Ndiskpro” service, described as\na “Microcode Update Device”. It is slightly surprising that no rootkit functionality\nhides this service:\n\nWhen loaded, the NDISKPRO.SYS driver hooks both INT 0x01 and INT 0xff, and\nretrieves keystroke data directly from port 0x60, the motherboard keyboard controller itself. It buffers, then communicates logged user data to the running user\nmode component. This component then encrypts and writes the retrieved values\nondisk to a randomly named .tmp, file like ffffz07131101.tmp. This file is located\nin the same directory as the original dropper, which maintains persistence across\nreboots with a simple addition to the HKCU run key.\n\n\n-----\n\nThis keylogger module encrypts and stores gathered data in a log file, as mentioned previously. Its encryption algorithm is similar to RC4. The interesting part is\nthat the module randomly generates the key and stores it in an unexpected place:\nin the middle of the log file name. Hence, the numeric part of the filename is used\nas a seed for the pseudorandom number generator. The rand function is statically\nlinked to ensure same results on different computers.\n\n\n-----\n\n## Interesting Malware Components\nThe Darkhotel toolset consists of multiple components that have been slightly\nmodified over time. These tools are dropped by hotel installers spoofing legitimate software installers, bound within torrent bundles, or dropped by exploits or\nhypertext linked from spear-phishing emails.\n\nMore advanced tools, like the keylogger decribed above, are later downloaded to\nthe victim system by one of these implants. In a recent case, word docs embedded with 0-day flash swf files either dropped these backdoors or downloaded and\nexecuted backdoors from remote web servers. These tools pull down the keylogger, steal information from the system, or download other tools.\n\n- small downloader\n\n- information stealer\n\n- Trojan\n\n- dropper and self­injector\n\n- selective infector\nThe most interesting behaviors of these components include\n\n- highly unusual conditional 180 day command and control communications\ndelay\n\n- self­kill routines when the system default codepage is set to Korean\n\n- enhanced Microsoft IntelliForm authentication theft handling\n\n- infostealer module Internet Explorer, Firefox, and Chrome support\n\n- campaign or stage ID maintenance\n\n- virtual machine execution sensitivity\n\n- selective viral infection routines to focus the spread of malware within organizations\n\n- signed malcode (previously noted)\n\n##### Small Downloader\nThis module is quite small (27Kb) and comes as a part of WinRar SFX file that drops\nand starts the module from %APPDATA%\\Microsoft\\Crypto\\DES64v7\\msieckc.exe.\nThis module is designed to update malicious components through recurring checks\nat the C&C server. It is also capable of removing some older components, the names\nof which are hardcoded in the body of the malware. The module adds autorun registry\nsettings to enable an automatic start during system boot\n\n\n-----\n\nOne of the most interesting functions of this executable is its unusual delay and\npersistence. If a special file exists on the system, the module will not start calling\nback to C&C server until the special file is 180 days old. So, if some other critical\nmalicious component was removed during this period, current module backs up\nand restores access to the system within 6 months.\n\nThe component gathers system information and sends it to the Darkhotel command and control servers as detailed in Appendix D.\n\n##### Information Stealer\nThis module is relatively large (455Kb) and comes as a part of a WinRar SFX file\nthat drops and starts the module from %APPDATA%\\Microsoft\\Display\\DmaUp3.\nexe. The main purpose of the module is to collect various secrets stored on a local system and upload them to Darkhotel command and control servers:\n\n- Cached passwords from Internet Explorer 6/7/8/9 (Windows Protected Storage)\n\n- Mozilla Firefox stored secrets (<12.0)\n\n- Chrome stored secrets\n\n- Gmail Notifier credentials\n\n- Intelliform­handled data and credentials:\n\n◦◦ Twitter\n◦◦ Facebook\n◦◦ Yandex\n◦◦ Qip\n◦◦ Nifty\n◦◦ Mail.ru\n◦◦ 126.com email\n◦◦ Zapak\n◦◦ Lavabit (encrypted email service now shut down)\n◦◦ Bigstring\n◦◦ Gmx\n◦◦ Sohu\n◦◦ Zoho\n◦◦ Sina\n◦ Care2\n\n\n-----\n\n◦◦ Fastmail\n◦◦ Inbox\n◦◦ Gawab (middle­eastern email service)\n◦◦ 163.com\n◦◦ Lycos\n◦◦ Lycos mail\n◦◦ Aol login\n◦◦ Yahoo! logins\n◦◦ Yahoo! Japan logins\n◦◦ Microsoft Live logins\n◦◦ Google login credentials\nThis module is designed to terminate itself on Windows with the system default codepage set to Korean.\n\n##### Trojan.Win32.Karba.e\nThis malware is 220Kb in size. It was built as MFC framework application with a\nlot of extra calls that should have complicated the analysis of the sample. It mimics a GUI desktop application but it does not create any visible windows or dialogs\nto interact with local users. The Trojan collects data about the system and anti­\nmalware software installed on it, and uploads that data to Darkhotel command\nand control servers. More technical details are provided in Appendix D.\n\n##### Trojan-Dropper & Injector (infected legitimate files)\nThis malware is 63kb in size. It is bound to a variety of other software packages\nthat vary in name, but the host package is consistently detected as “Virus.Win32.\nPioneer.dx”. It drops the igfxext.exe “selective infector” component to disk and\nruns it.\n\n\n-----\n\n##### Selective Infector\nThis component is a virus, and is used to selectively infiltrate into other computers via USB or network shares.\n\nFirst, the virus retrieves all available disks and starting from disk number 4 (D:\\)\nto disk number 20 (Z:\\), finds executable files and infects them. The code simply\nbrute forces the list of mapped removable drives.\n\nDuring its infection routine, the infector changes the entrypoint of executable\nfiles, creates an .rdat section, and inserts a small loader in the section, then puts\nits main payload in the overlay. Every infected file has functionality described in\nTrojan­Dropper & Injector section, so it can collect information about the computer, send it to the C2 and download other Darkhotel components as commanded.\nObserved downloaded components are signed with a familiar expired certificate\n[from www.esupplychain.com.tw, issued by Cybertrust SureServer CA.](http://www.esupplychain.com.tw/)\n\nAgain, further technical details are provided in Appendix D.\n\n##### Campaign Codes\nAlmost every backdoor in this set maintains an internal campaign code or id, used\nin initial c2 communications as described above. Some IDs appear to be related to\ngeographic interests, others do not seem obvious. We gathered a list of Darkhotel\ncampaign IDs shown below. Internal IDs and c2 resources overlap across these components, there is no pattern of distribution according to connectback resources. The\nmost common id is “DEXT87”:\n\n\nDEXT87\nstep2-auto\ndome1-auto\nstep2-down\nJava5.22\nC@RNUL-auto\ndome-down\nM1Q84K3H\nNKEX#V1.Q-auto\n\n\nNKstep2-auto\nPANA(AMB)-auto\n\nPANA#MERA\nSOYA#2-auto\nstep2-down-u\n[(ULT)Q5SS@E.S-down](mailto:Q5SS%40E.S?subject=)\n\nVER1.5.1\nVICTORY\nWINM#V1.Q\n\n\n-----\n\n## Infrastructure and Victims\nThis infrastructure team appears to employ a lesser skillset than top notch\ncampaigns, maintaining weak server configurations with limited monitoring and\ndefensive reactions, and making some simple mistakes. However, they are effective at maintaining a fully available infrastructure to support new and existing\ninfections.\n\nOverall, victims in our sinkhole logs and KSN data were found across the globe,\nwith the majority in Japan, Taiwan, China, Russia, Korea and Hong Kong.\n\n##### Sinkhole Domains\nThe following C&C domains have been sinkholed and redirected to the Kaspersky\nSinkhole Server\n\n\n42world.net\nacademyhouse.us\nadobeplugs.net\namanity50.biz\nautocashhh.hostmefree.org\nautochecker.myftp.biz\nautoshop.hostmefree.org\nautoupdatfreeee.coolwwweb.com\ncheckingvirusscan.com\ndailyissue.net\ndailypatch­-rnr2008.net\nfenraw.northgeremy.info\ngeneralemountina.com\ngoathoney.biz\n\n\njpnspts.biz\njpqueen.biz\nmechanicalcomfort.net\nmicromacs.org\nncnbroadcasting.reportinside.net\nneao.biz\nprivate.neao.biz\nreportinside.net\nself­-makeups.com\nself-­makingups.com\nsourcecodecenter.org\nsupport­forum.org\nupdatewifis.dyndns­-wiki.com\n\n\n-----\n\n##### Victim Locations - KSN and Sinkhole Data\n\n###### KSN Data\nOur Kaspersky Security Network detected Darkhotel infections across thousands\nof machines, mostly related to the Darkhotel p2p campaigns. These geolocation\nestimates probably provide the most accurate picture of where Darkhotel activity\nis occurring.\n\n\n-----\n\nHere is a pie chart to better visualize the proportions of attack activity throughout\nthe world. As you can see, over 90% of it occurs in the top five countries: Japan,\nfollowed by Taiwan, China, Russia and Korea.\n\n\n-----\n\n###### Sinkhole Data\nBecause the operators very actively build up new command and control servers, it is difficult to sinkhole enough domains to get an accurate overall picture\nof victim system location based on this data. Also, many researcher systems are\nconnected to the sinkholed domains. However, this graph of current sinkhole\ncallbacks presents a low confidence distribution of victim geolocation, with India,\nJapan, Ireland, Korea, China and Taiwan in the top slots. Removing India and\nIreland, the set more closely matches our KSN data.\n\n##### Available ddrlog Victim Data\nMany of these c2s maintain a common directory path that serves a ddrlog. The\nddrlogs appear to maintain callback data that the attackers want to set aside in\nerror logs. Many of the callback URLs have errors, many are from unwanted IP\nranges, and others are clearly unwanted researcher sandbox system callbacks.\n\nA description of the detailed connectback URL values and their xor/base64\nencoding scheme is included in the “Interesting Malware Trojan.Win32.Karba.e”\ntechnical notes in Appendix D.\n\nThe Darkhotel c2 maintain these directory structures to store and serve ddrlog\ncontent:\n\n- /bin/error/ddrlog\n\n- /patch/error/ddrlog\n\n\n-----\n\nThe following structures appear to be common across servers, but do not produce ddrlog and do not maintain an /error/ directory:\n\n- /u2/\n\n- /u3/\n\n- /patch2/\n\n- /major/\n\n- inor/\n\n- /asp/\n\n- /update3/\nTwo ddrlog files report entries starting January 1, 2009 at 9:16 a.m.\n\n- autozone.000space.com\n\n- genuinsman.phpnet.us\nAll of the logs maintain a significant number of entries, almost 50,000, with a\nsimple stamp “B” or “L”. Those records are formatted in the following manner:\n\n2009.01.01 09:16:00 150.70.xxx.xx ­> B\n\n2009.01.01 09:16:33 150.70.xxx.xx ­> B\n\n2009.01.01 09:14:52 220.108.x.xxx ­> L\n\n2009.01.01 09:16:04 112.70.xx.xx ­> L\n\nOnly 120 IP addresses perform the “B” checkin, and 90% of these are from the\nrange 150.70.97.x. This entire range is owned by Trend Micro in Tokyo, JP.\n\nA handful of the remaining addresses, like 222.150.70.228, appear to come\nfrom other ranges owned by Trend Micro in JP. One outlier comes from an El Salvadoran ISP, and another is connected to a Japanese ISP. Approximately 20,000\nIP addresses perform the “L” checkin.\n\nOther ddrlogs may include “A” tags as well.\n\nThe “A” tag labels unwanted checkins from untargeted locations, like Hungary\nand Italy. The “B” tag labels unwanted checkins from Trend Micro IP ranges.\n\nThe “L” tag labels unwanted checkins from a variety of ranges, but includes odd\nIP like the loopback address, 127.0.0.1, clearly an error.\n\nEntries in these logs include callback URLs that have spaces and unusual characters that do not conform to the required base64 character dictionary.\n\n\n-----\n\n##### C2 Communications and Structure\nTypical main page:\n\nFor begatrendstone.com, we have the following directory structure:\n\n/bin\n\n­read_i.php (main C&C script)\n­login.php (unknown, replies “Wrong ID()”)\n/bin/error (error logs stored here)\n\n­ddrlog\n/bin/tmp\n/bin/SElhxxwiN3pxxiAPxxc9\n-all.gif\n/i\n\n  - encrypted stolen victim system content\n/L\n/f\n\nFor auto2116.phpnet.us, we have the following directory structure:\n\n/patch\n\n­chkupdate.php (main command and control script)\n/patch/error\n\n­ddrlog\n\nThe group encrypts victim data on their servers with single user/passkey combinations across multiple victims. When an unauthorized user attempts to access a\nDarkhotel web interface for victim management without the correct passkey, the\nhtml page and table layout renders properly, but all the data values on the page\nare returned as garbled ciphertext.\n\n\n-----\n\n##### Victim Management\nNew victim systems appear to be systematically vetted. The attackers maintain\na web interface to vet these new victim systems. The attackers first and foremost\nlist and sort victim systems according to their latest c2 check­in. Collected data\nprobably is presented in order of importance:\n\n1. user’s logon name\n2. system CPU and OS\n3. “Ping sec”, or how far the victim system is from the c2\n4. “In”, or the process that the attackers’ dll code executes within\n5. Vac: ??\n6. system LAN IP\n7. network WAN IP\nHere is an example of one of these web pages:\n\n\n-----\n\n###### Researcher Activity\nClearly, some automated analysis activity involving researchers’ sandbox tools\nare filling up these logs. From June 2013 to April 2014 (approximately an 11\nmonth period), in only 15 ddrlog files, we observe almost 7,000 connections from\nresearch sandbox systems. The network connections provide a1= through a3=\nvalues identifying a QEMU based sandbox, all sourced from only 485 WAN IP addresses. Under 30 lan IPs are recorded, all in the same 172.16.2.14­126 range.\nThis system(s) uses a “Dave” user account and “HOME­OFF­D5F0AC” Windows\nsystem name.\n\nThese characteristics correspond with network activity generated by GFI Software’s “CWsandbox” tools, now owned by “ThreatTrack Security”.\n\n\n-----\n\n## Conclusions\nFor the past seven years, a strong threat actor named Darkhotel, also known as\nTapaoux, has carried out a number of successful attacks against a wide range of\nvictims from around the world. It employs methods and techniques which go well\nbeyond typical cybercriminal behavior.\n\nThe Darkhotel crew’s skillset allows it to launch interesting cryptographical attacks, for instance factoring 512 bit RSA keys. Its use of 0-days is another indicator of a strong threat actor.\n\nThe targeting of top executives from various large companies around the world\nduring their stay at certain “Dark Hotels” is one of the most interesting aspects of\nthis operation. The exact method of targeting is still unknown - for instance, why\nsome people are targeted while others are not. The fact that most of the time the\nvictims are top executives indicates the attackers have knowledge of their victims\nwhereabouts, including name and place of stay. This paints a dark, dangerous\nweb in which unsuspecting travelers can easily fall. While the exact reason why\nsome hotels function as an attacker vector are unknown, certain suspicions exist, indicating possibly a much larger compromise. We are still investigating this\naspect of the operation and will publish more information in the future.\n\nA further interesting trait is the deployment of multiple types of campaigns, both\ntargeted and botnet. This is becoming more and more common on the APT scene,\nwhere targeted attacks are used to compromise high profile victims and botnet\nstyle operations are used for massive surveillance or performing other tasks such\nas launching DDoS attacks on hostile parties or simply upgrading victims to more\nsophisticated espionage tools.\n\nWe expect the Darkhotel crew to continue their activities against DIB, Government and NGO sectors. The appendix released with this paper provides technical\nindicators of compromise which should help victims identify the malicious traffic\nand enable targets to protect themselves better against attack.\n\n\n-----\n\n##### Kaspersky Lab HQ\n\n39A/3 Leningradskoe Shosse\nMoscow, 125212\nRussian Federation\n\n[more contact details](http://www.kaspersky.com/about/contactinfo/contacts_global_hq)\n\nTel: +7-495-797-8700\nFax: \u0007+7-495-797-8709\n\nE-mail: [info@kaspersky com](mailto:info%40kaspersky.com?subject=)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "d63ae2b7-445f-460d-965d-2676dacdb6de",
            "created_at": "2022-10-25T15:59:19.552139Z",
            "updated_at": "2022-10-25T15:59:19.552139Z",
            "deleted_at": null,
            "name": "APTnotes",
            "url": "https://github.com/aptnotes/data",
            "description": "APTnotes data",
            "reports": null
        },
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://app.box.com/s/rqk4up23y49pe1zalfmstkj4zb1dxbja",
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2014/2014.11.10.Darkhotel/darkhotel_kl_07.11.pdf"
    ],
    "report_names": [
        "darkhotel_kl_07.11"
    ],
    "threat_actors": [
        {
            "id": "1dadf04e-d725-426f-9f6c-08c5be7da159",
            "created_at": "2022-10-25T15:50:23.624538Z",
            "updated_at": "2025-03-27T02:00:55.508759Z",
            "deleted_at": null,
            "main_name": "Darkhotel",
            "aliases": [
                "Darkhotel",
                "DUBNIUM",
                "Zigzag Hail"
            ],
            "source_name": "MITRE:Darkhotel",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "b13c19d6-247d-47ba-86ba-15a94accc179",
            "created_at": "2024-05-01T02:03:08.149923Z",
            "updated_at": "2025-03-27T02:05:17.422065Z",
            "deleted_at": null,
            "main_name": "TUNGSTEN BRIDGE",
            "aliases": [
                "DUBNIUM ",
                "DarkHotel ",
                "CTG-1948 "
            ],
            "source_name": "Secureworks:TUNGSTEN BRIDGE",
            "tools": [
                "Nemim"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "2b4eec94-7672-4bee-acb2-b857d0d26d12",
            "created_at": "2023-01-06T13:46:38.272109Z",
            "updated_at": "2025-03-27T02:00:02.790029Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "DUBNIUM",
                "Fallout Team",
                "Luder",
                "Tapaoux",
                "Shadow Crane",
                "APT-C-06",
                "SIG25",
                "Karba",
                "Nemim",
                "Nemin",
                "G0012",
                "ATK52",
                "T-APT-02",
                "TUNGSTEN BRIDGE",
                "Zigzag Hail"
            ],
            "source_name": "MISPGALAXY:DarkHotel",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c0cedde3-5a9b-430f-9b77-e6568307205e",
            "created_at": "2022-10-25T16:07:23.528994Z",
            "updated_at": "2025-03-27T02:02:09.847683Z",
            "deleted_at": null,
            "main_name": "DarkHotel",
            "aliases": [
                "APT-C-06",
                "ATK 52",
                "CTG-1948",
                "Dubnium",
                "Fallout Team",
                "Higaisa",
                "Luder",
                "Operation DarkHotel",
                "Operation Daybreak",
                "Operation Inexsmar",
                "Operation PowerFall",
                "Operation The Gh0st Remains the Same",
                "SIG25",
                "Shadow Crane",
                "T-APT-02",
                "Tungsten Bridge",
                "Zigzag Hail"
            ],
            "source_name": "ETDA:DarkHotel",
            "tools": [
                "Asruex",
                "DarkHotel",
                "DmaUp3.exe",
                "GreezeBackdoor",
                "Karba",
                "Nemain",
                "Nemim",
                "Ramsay",
                "Retro",
                "Tapaoux",
                "Trojan.Win32.Karba.e",
                "Virus.Win32.Pioneer.dx",
                "igfxext.exe",
                "msieckc.exe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716496,
    "ts_updated_at": 1743041741,
    "ts_creation_date": 1415617541,
    "ts_modification_date": 1415617565,
    "files": {
        "pdf": "https://archive.orkl.eu/dfd64e9a601283c76ae3f28875166695dc354a21.pdf",
        "text": "https://archive.orkl.eu/dfd64e9a601283c76ae3f28875166695dc354a21.txt",
        "img": "https://archive.orkl.eu/dfd64e9a601283c76ae3f28875166695dc354a21.jpg"
    }
}