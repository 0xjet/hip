{
    "id": "0e2b8382-40c8-4dc3-a273-1fc0367482a2",
    "created_at": "2023-01-12T15:02:29.960132Z",
    "updated_at": "2025-03-27T02:06:03.735612Z",
    "deleted_at": null,
    "sha1_hash": "bf92b82038755fc5315ecfe544025f77767c0621",
    "title": "2020-01-17 - Unpacking Pyrogenic-Qealler using Java agent -Part 0x2",
    "authors": "",
    "file_creation_date": "2022-05-28T19:20:26Z",
    "file_modification_date": "2022-05-28T19:20:26Z",
    "file_size": 868399,
    "plain_text": "# Unpacking Pyrogenic/Qealler using Java agent -Part 0x2\n\n**[securityinbits.com/malware-analysis/unpacking/unpacking-pyrogenic-qealler-using-java-agent-part-0x2/](https://www.securityinbits.com/malware-analysis/unpacking/unpacking-pyrogenic-qealler-using-java-agent-part-0x2/)**\n\nJanuary 17, 2020\n\n## Introduction to Java agent\n\nA Java agent is used to instrument programs running on the JVM and it can modify the Java\nbytecode at runtime without source code. In this post we will be using a Java agent to dump\nthe classes during runtime without any bytecode modification but for more details please\ncheck this Java Agents Tutorial [1]. These are the minimum requirement for Java agent to\nwork:\n\n1. Java agent class file should have a premain method which acts as the entry-point.This\n\nmethod is executed before the real java application main method, premain method itâ€™s\nlike TLS callback.\n2. MANIFEST.MF should be defined with the Premain-Class attribute, which will point to\n\nclass name with premain method. Another important point is there must be a new line\n**at the end of the MANIFEST file. Otherwise, the last header is ignored.**\n3. javaagent parameter should be specified to load java agent jar file with premain\n\nmethod e.g . java -javaagent:dumper.jar -jar malware.jar\n\n## Unpacking using Java agent\n\n\n**dumper.java & MANIFEST.mf are used to build Java agent dumper.jar. dumper.java code**\nis copied from Reversing an obfuscated java malware pdf [2] and I will highly recommend to\ngo through the pdf[2] to understand the different methods which can be used to analyse Java\nmalware.\n\n_grade_\n\n\n[Note: All java, MANIFEST and jar files are uploaded to GitHub repo[3].](https://github.com/Securityinbits/blog-posts/tree/master/java_agent)\n\n**_dumper.java_**\n\n\n-----\n\n```\nimport java.io. ;\nimport java.lang.instrument.*;\nimport java.security.*;\n// This code is copied from \"Reversing an obfuscated java malware by Extreme Coders\"\npublic class dumper {\n  //A java agent must have a premain method which acts as the entry-point\n  public static void premain(String agentArgs, Instrumentation inst) {\n    System.out.println(\"agent loaded\");\n    // Register out trasnformer\n    inst.addTransformer(new transformer());\n  }\n}\nclass transformer implements ClassFileTransformer {\n  // The transform method is called for each non-system class as they are being\nloaded\n  public byte[] transform(ClassLoader loader, String className,\n    Class < ? > classBeingRedefined, ProtectionDomain protectionDomain,\n    byte[] classfileBuffer) throws IllegalClassFormatException {\n    if (className != null) {\n      // Skip all system classes\n      if (!className.startsWith(\"java\") &&\n        !className.startsWith(\"sun\") && !className.startsWith(\"javax\") &&\n!className.startsWith(\"com\") && !className.startsWith(\"jdk\") &&\n!className.startsWith(\"org\")) {\n        System.out.println(\"Dumping: \" + className);\n        // Replace all separator characters with _\n        String newName = className.replaceAll(\"/\", \"_\") + \".class\";\n        try {\n          FileOutputStream fos = new FileOutputStream(newName);\n          fos.write(classfileBuffer);\n          fos.close();\n        } catch (Exception ex) {\n          System.out.println(\"Exception while writing: \" + newName);\n        }\n      }\n    }\n    // We are not modifying the bytecode in anyway, so return it as-is\n    return classfileBuffer;\n  }\n}\n\n```\n**_MANIFEST.mf_**\n```\nManifest-Version: 1.0\nPremain-Class: dumper\n\n```\n_grade_\n\nNote: If you know the basic of Java or any other object oriented programming language then\nit will be much easier to understand this dumped unpacked code.\n\n\n-----\n\n[1. Uploaded the jar file in GitHub repo[ ]which is generated using following command:](https://github.com/Securityinbits/blog-posts/tree/master/java_agent)\n\n```\njavac dumper.java\n\n```\n```\njar cmf MANIFEST.MF dumper.jar dumper.class transformer.class\n\n```\n\n-----\n\n2. Execute this command `java -javaagent:dumper.jar -jar`\n```\n BankPaymAdviceVend_LLCRep.jar to run the malware with java agent and it will\n\n```\ndump all the accessed classes at runtime to the current working directory.\n\nPyrogenic java agent cmdline\n\n\n-----\n\nPyrogenic malware classes with comment\n\n3. Please decompile all the dumped class files which start with q0b4 and j/t/e package\n\nname files using ByteCodeViewer FernFlower Java decompiler. One of the easiest way\nis to zip all classes and then use BCV. Then, import decompiled java source files from\nBCV into any Java IDE, this will help you in code navigation.\n\n\n-----\n\n4. Start from the bottom and go up in the above pic then you will find the first proper\n\npackage name q0b4/bootstrap/templates/Header which can be our starting point for\nunpacked code. We are Reverse engineers, we always start in reverse order :).\n5. Below pic shows all the unpacked classes dumped using Java agent dumper.jar. It\n\nstarts from Header.java which uses a decrypt function to AES decrypt the classes at\nruntime and invoke the main method. It invokes j.t.e.Main package main method.\n\nDumped Classes List with Header.java\n\n_grade_\n\nOther approach is to dump all the classes present in obfuscatedEntryList using for loop and\ncontinue analysis\n\n## Dumped class file analysis\n\nMalware authors divided the source code in multiple sensible packages. They have made\nour job easier by giving proper names to functions, variables and classes. We will go through\nsome of the classes Main, Server, MainEx and one util IPAddress class, as it will take too\nmuch time to go through each one of them.\n\nMain & Server class\n\n\n-----\n\n**_Main class invokes the loadLibrary method which sends the cmd to CC using_**\n**_sendCmd method._**\n\nPyrogenic Main class with loadLibrary\n\n\n-----\n\n**_Server class contains function loadLibrary which is used above and_**\n**_pushCredentials which is used to send the stolen credential to CC._**\n\nPyrogenic Server class with functions\n\n\n-----\n\n**_Server class contain the following list of available library and cmds:_**\n```\n      public static final int PYTHON = 162144;\n      public static final int SQLITE = 4353152;\n      public static final int JNA = 224288;\n      public static final int JNA_PLATFORM = 3048576;\n      public static final int JNA_4 = 307200;\n      public static final int JNA_PLATFORM_4 = 308224;\n      public static final int BCPROV = 310272;\n      public static final int INI4J = 311296;\n      public static final int XML = 312320;\n      public static final int JSON = 313344;\n      public static final int W3DOM = 314368;\n      public static final int Q4_PASS_LIB = 315392;\n      public static final int JPOWERSHELL = 316416;\n      private static final int LIBRARY_CMD = 16384;\n      private static final int CREDENTIAL_CMD = 32768;\n      private static final byte[] SEED =\n      \"uisdfysdgfbsdyufbsiybfsdyb733grfsudbfjh\".getBytes();\n      private static final int MAX_TRY_COUNT = 20;\n\n```\nPyrogenic Server class with cmd\n\nMalware author didnâ€™t pack all the required Java libraries in the jar but it is requested when\nneeded at runtime. This significantly decreased the malware size to 153.27 Kb. Letâ€™s discuss\nsome of the library and commands used:\n\n\n-----\n\n1.\n\n1.\n\nMainEx class\n\n\n1. Server JNA, JNA_4, JNA_PLATFORM, JNA_PLATFORM_4 â€“ JNA (Java\n\nNative Access ) provides simplified access to native library methods without\nrequiring any additional JNI or native code. For example you can call printf,\nGetSystemTime Windows API function directly from Java Code.\n2. INI4j â€“ Java API for handling configuration files in Windows .ini format\n3. JPOWERSHELL â€“ Simple Java API that allows programs to interact with\n\nPowerShell console. It may be used when malware invokes any PowerShell\ncommands.\n4. Q4_PASS_LIB â€“ May be Qealler v4 Password Library loaded first using\n```\n  list.add(server.loadLibrary(315392));\n\n```\n5. LIBRARY_CMD â€“ May be used to load the clean dll used sqlitejdbc.dll and\n\njnidispatch.dll\n6. CREDENTIAL_CMD â€“ This cmd is used to pushCredentials to CC\n\n\n-----\n\n**j.t.e.Main main method invokes the j.t.e.MainEx main method as shown above in**\n**Main class. It sent credential and system info in JSON format to CC. All the**\ncommunication are AES encrypted using EncryptedCipherOutputStream and\n**_EncryptedCipherInputStream which extends CipherOutputStream &_**\n**_CipherInputStream respectively._**\n\nPyrogenic MainEx main method\n\n\n-----\n\n**_MainEx class contains two important methods: run() and getSysinfo() as shown_**\nbelow.\n\nPyrogenic MainEx credential stealer method\n\nMalware steal credential from list of software mentioned in the run() method\n```\n      this.addAll(ChromiumBased.chromiumBasedBrowsers);\n      this.addAll(MozillaBased.mozillaBasedBrowsers);\n      this.add(new IExplorer());\n      this.add(new UCBrowser());\n      this.add(new Composer());\n      this.add(new Credman());\n      this.add(new Outlook());\n      this.add(new Pidgin());\n      this.add(new PostgreSQL());\n      this.add(new Squirrel());\n      this.add(new Tortoise());\n\n```\n**getSysinfo() collect osName, osVersion, osArch, javaHome, userName,**\nuserHome, availableProcessor, freeMemory, totalMemory, localIpAddress &\nglobalIpAddress in JSON format which is encrypted and sent to CC with other\ninfo.\n\nIPAddress class\n\n\n-----\n\n**_IPAddress class is one of the classes present in package j.t.e.core.utils which_**\ngets the IP address of the infected system and sends it to CC with other system\ninfo. It uses http://bot.whatismyipaddress.com for collecting the public IP of\ninfected systems.\n\n\n-----\n\nPyrogenic IPAddress util class\n\n## When will it fail?\n\nUnpacking using Java agent will be unable to dump all the classes at runtime due to\nfollowing conditions:\n\nWhen malware is unable to interact with CC then it will not be able to exhibit complete\nbehaviour.\nMalware is using some anti analysis technique e.g checking for vmware etc.\nMalware is unable to run due to some supporting files, command line etc.\n\n## Conclusion\n\nUnpacking using a Java agent is quite simple and can speed up your analysis, you can use\nthe dumper.jar uploaded in Github [3]. This method can be used in any Java based malware.\nWe have also gone through some of the dumped Pyrogenic/Qealler source code to\nunderstand the stealer functionality. In the last [part 0x3 we find similarity between](https://www.securityinbits.com/malware-analysis/similarity-between-qealler-pyrogenic-variants-part-0x3/)\nQealler/Pyrogenic variants based on static code analysis.\n\n[Hope you enjoyed this post, please Follow @Securityinbits me on Twitter to get the latest](https://twitter.com/Securityinbits?ref_src=twsrc%5Etfw)\nupdate about my malware analysis & DFIR journey. Happy Reversing ðŸ˜Š\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-01-17 - Unpacking Pyrogenic-Qealler using Java agent -Part 0x2.pdf"
    ],
    "report_names": [
        "2020-01-17 - Unpacking Pyrogenic-Qealler using Java agent -Part 0x2.pdf"
    ],
    "threat_actors": [
        {
            "id": "9f101d9c-05ea-48b9-b6f1-168cd6d06d12",
            "created_at": "2023-01-06T13:46:39.396409Z",
            "updated_at": "2025-03-27T02:00:03.074969Z",
            "deleted_at": null,
            "main_name": "Earth Lusca",
            "aliases": [
                "CHROMIUM",
                "ControlX",
                "Red Dev 10",
                "RedHotel",
                "Red Scylla",
                "TAG-22",
                "BRONZE UNIVERSITY",
                "AQUATIC PANDA",
                "Charcoal Typhoon",
                "BountyGlad"
            ],
            "source_name": "MISPGALAXY:Earth Lusca",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1673535749,
    "ts_updated_at": 1743041163,
    "ts_creation_date": 1653765626,
    "ts_modification_date": 1653765626,
    "files": {
        "pdf": "https://archive.orkl.eu/bf92b82038755fc5315ecfe544025f77767c0621.pdf",
        "text": "https://archive.orkl.eu/bf92b82038755fc5315ecfe544025f77767c0621.txt",
        "img": "https://archive.orkl.eu/bf92b82038755fc5315ecfe544025f77767c0621.jpg"
    }
}