{
    "id": "dc69bc70-4ef6-499b-927c-030c499155e1",
    "created_at": "2023-01-12T15:10:11.869286Z",
    "updated_at": "2025-03-27T02:08:40.162365Z",
    "deleted_at": null,
    "sha1_hash": "eddb5ea37884d76d97d95af4ed9b8197e30fd9a4",
    "title": "2021-01-29 - Cleaning up after Emotet- the law enforcement file",
    "authors": "",
    "file_creation_date": "2022-05-28T23:08:24Z",
    "file_modification_date": "2022-05-28T23:08:24Z",
    "file_size": 1405813,
    "plain_text": "# Cleaning up after Emotet: the law enforcement file\n\n**[blog.malwarebytes.com/threat-analysis/2021/01/cleaning-up-after-emotet-the-law-enforcement-file/](https://blog.malwarebytes.com/threat-analysis/2021/01/cleaning-up-after-emotet-the-law-enforcement-file/)**\n\nThreat Intelligence Team January 29, 2021\n\n**_Update 2021-04-25:_**\n\nToday at 1:00 PM, our [#Emotet-infected machine that had received the special law](https://twitter.com/hashtag/Emotet?src=hash&ref_src=twsrc%5Etfw)\nenforcement file triggered its uninstallation routine.\n\n[More details here: https://t.co/LfdPaNXiFm](https://t.co/LfdPaNXiFm) [pic.twitter.com/ewTGpg17Ba](https://t.co/ewTGpg17Ba)\n\n[— Malwarebytes Threat Intelligence (@MBThreatIntel) April 25, 2021](https://twitter.com/MBThreatIntel/status/1386413655659479043?ref_src=twsrc%5Etfw)\n\n_This blog post was authored by Hasherezade and Jérôme Segura_\n\nEmotet has been the most wanted malware for several years. The large botnet is responsible\nfor sending millions of spam emails laced with malicious attachments. The once banking\nTrojan turned into loader was responsible for costly compromises due to its relationship with\nransomware gangs.\n\n[On January 27, Europol announced a global operation to take down the botnet behind what it](https://www.europol.europa.eu/newsroom/news/world%E2%80%99s-most-dangerous-malware-emotet-disrupted-through-global-action)\ncalled the most dangerous malware by gaining control of its infrastructure and taking it down\nfrom the inside.\n\nShortly thereafter, Emotet controllers started to deliver a special payload that had code to\nremove the malware from infected computers. This had not been formally clarified just yet\nand some details around it were not quite clear In this blog we will review this update and\n\n\n-----\n\nhow it is meant to work.\n\n## Discovery\n\n[Shortly after the Emotet takedown, a researcher observed a new payload pushed onto](https://twitter.com/milkr3am/status/1354459859912192002?s=20)\ninfected machines with a code to remove the malware at a specific date.\n\nThat updated bot contained a cleanup routine responsible for uninstalling Emotet after the\n[April 25 2021 deadline. The original report mentioned March 25 but since the months are](https://twitter.com/MBThreatIntel/status/1354842730711502850?s=20)\ncounted from 0 and not from 1, the third month is in reality April.\n\n[This special update was later confirmed in a press release by the U.S. Department of Justice](https://www.justice.gov/opa/pr/emotet-botnet-disrupted-international-cyber-operation)\n[in their affidavit.](https://www.justice.gov/opa/press-release/file/1361276/download)\n\nOn or about Janury 26, 2021, leveraging their access to Tier 2 and Tier 3 servers,\nagents from a trusted foreign law enforcement partner, with whom the FBI is\ncollaborating, replaced Emotet malware on servers physically located in their\njurisdiction with a file created by law enforcement\n\n[BleepingComputer mentions that the foreign law enforcement partner is Germany’s Federal](https://www.bleepingcomputer.com/news/security/europol-emotet-malware-will-uninstall-itself-on-april-25th/)\nCriminal Police (Bundeskriminalamt or BKA).\n\nIn addition to the cleanup routine, which we describe in the next section, this “law\nenforcement file” contains an alternative execution path that is followed if the same sample\nruns before the given date.\n\n## The uninstaller\n\nThe [payload is a 32 bit DLL. It has a self-explanatory name (EmotetLoader.dll) and 3 exports](https://www.virustotal.com/gui/file/a9c68d527223db40014d067cf4fdae5be46cca67387e9cfdff118276085f23ef/detection)\nwhich all lead to the same function.\n\n\n-----\n\nIf we look inside this exported function, we can see 3 subroutines:\n\nThe first one is responsible for the aforementioned cleanup. Inside, we can find the date\ncheck:\n\n\n-----\n\nIf the deadline already passed, the uninstall routine is called immediately. Otherwise the\nthread is run repeatedly doing the same time check, and eventually calling the deletion code\nif the date has passed.\n\nThe current time is compared with the deadline in a loop. The loop exits only if the deadline\nis passed, and then proceeds to the uninstallation routine.\n\nThe uninstall routine itself is very simple. It deletes the service associated with Emotet,\ndeletes the run key, attempts (but fails) to move the file to %temp% and then exits the\nprocess.\n\n\n-----\n\nInside\n\nthe function: “uninstall_emotet”\nAs we know by observing the regular Emotet, it achieves persistence in two alternative ways.\n\nRun key\n\nMicrosoft\\CurrentVersion\\Run\nThis type of installation does not require elevation. In such a case, the Emotet DLL is copied\ninto `%APPDATA%\\[random dir name]\\[random DLL name].[random extention] .`\n\nSystem Service\n\n\n-----\n\nHKLM\\System\\CurrentControlSet\\Service\\<emotet random name>\nIf the sample was run with Administrator privileges, it installs itself as a system service.. The\noriginal DLL is copied into `C:\\Windows\\SysWow64\\[random dir name]\\[random DLL`\n```\nname].[random extention] .\n\n```\nFor this reason, the cleanup function has to take both scenarios into account.\n\nWe noticed the developers made a mistake in the code that’s supposed to move the law\nenforcement file into the %temp% directory:\n```\nGetTempFileNameW(Buffer, L\"UPD\", 0, TempFileName)\n\n```\n[The “0” should have been a “1” because according to the documentation, if uUnique is not](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-gettempfilenamea)\n_zero, you must create the file yourself. Only a file name is created, because_\n_GetTempFileName is not able to guarantee that the file name is unique._\n\nThe intention was to generate a temporary path, but because of using the wrong value in the\nparameter uUnique, not only was the path generated, but the file was also created. That lead\nto the further name collision and as a result, the file was not moved.\n\nHowever, this does not change the fact that the malware has been neutered and is harmless\nsince it won’t run as its persistence mechanisms have been removed.\n\nIf the aforementioned deletion routine was called immediately, the other two functions from\nthe initial export are not getting run (the process terminates at the end of the routine, calling\n```\nExitProcess ). But this happens only if the sample has been run after April 25.\n\n## The alternative execution path\n\n```\n\n-----\n\nNow let s take a look at what happens in the alternative scenario when the uninstall routine\nisn’t immediately called.\n\nAfter the waiting thread is run, the execution reaches two other functions. The first one\nenumerates running processes, and searches for the parent process of the current one.\n\nThen it checks the process name if it is “explorer.exe” or “services.exe”, followed by reading\nparameters given to the parent.\n\n**Running the next stage**\n\nThe next routine decrypts and loads a second stage payload from the hardcoded buffer.\n\n\n-----\n\nThe hardcoded buffer is decrypted with the above loop, and then executed\nRedirection of the flow to the decrypted buffer (via “ call edi “):\n\n\n-----\n\nThe next PE is revealed: [X.dll:](https://www.virustotal.com/gui/file/91fd082ae790d4a211b918996e437b9daf5406ec9820a5d8cc90a52da458a937/detection)\n\n\n-----\n\nAfter decrypting the payload, the execution is redirected to the beginning of the revealed\nbuffer that starts with a jump:\n\nThis jump leads to a reflective loader routine. After mapping the DLL to a virtual format, in\nthe freshly allocated area in the memory, the loader redirects the execution there.\n\nFirst, the `DllMain of X.dll is called (it is used for the initialization only). Then, the execution`\nis redirected to one of the exported functions – in the currently analyzed case it is\n```\nControl_RunDll .\n\n```\nThe execution is continued by the second dll (X.dll). The functions inside this module are\nobfuscated.\n\n\n-----\n\nThe payload that is called now looks very similar to the regular Emotet payload. Analogical\n[DLL, and also named X.dll such as: this one could be found in earlier Emotet samples](https://www.virustotal.com/gui/file/8e991423fbbe65fe96b933fedf22f3abef3e8a01529bd1e31628089806687a36/detection)\n[(without the cleanup routine), for example in this sample.](https://www.virustotal.com/gui/file/92f54f5bacf00591631bbe5650e138c865beee4f1579a97cbb91d5a0e7c9ab34/behavior/Lastline)\n\n**The second stage payload: X.dll**\n\n[The second stage payload X.dll is a typical Emotet DLL, loaded in case the hardcoded](https://www.virustotal.com/gui/file/91fd082ae790d4a211b918996e437b9daf5406ec9820a5d8cc90a52da458a937/detection)\ndeadline didn’t pass yet.\n\nThis DLL is heavily obfuscated and all the used APIs are loaded dynamically. Also their\nparameters are not readable – they are dynamically calculated before use, sometimes with\nthe help of a long chain of operations involving many variables:\n\n\n-----\n\nThis type of obfuscation is typical for Emotet’s payloads, and it is designed to confuse\nresearchers. Yet, [thanks to tracing we were able to reconstruct what APIs are being called at](https://github.com/hasherezade/tiny_tracer)\nwhat offsets.\n\nThe payload has two alternative paths of execution. First it checks if it was already installed.\nIf not, it follows [the first execution path, and proceeds to install itself. It generates a random](https://gist.github.com/hshrzd/5aa04f98a0e19900ded5ad2d21a92b06#file-x-dll_install-tag)\ninstallation name, and moves itself under this name into a specific directory, at the same time\nadding persistence. Then it re-runs itself from the new location.\n\nIf the payload detects that it was run from the destination path, it takes an alternative\nexecution path instead. It [connects to the C2 and communicates with it.](https://gist.github.com/hshrzd/5aa04f98a0e19900ded5ad2d21a92b06#file-x-dll_run-tag-L1460)\n\n\n-----\n\nThe current sample sends a request to one of the sinkholed servers. Content:\n```\nL\"DNT: 0\\r\\nReferer: 80.158.3.161/i8funy5rv04bwu1a/\\r\\nContent-Type: multipart/formdata; boundary=--------------------GgmgQLhRJIOZRUuEhSKo\\r\\n\"\n\n```\nThe following image shows web traffic from a system infected via a malicious document\ndownloading the special update file and reaching back to the command and control server\nowned by law enforcement:\n\n## Motives behind the uninstaller\n\n\n-----\n\nThe version with the uninstaller is now pushed via channels that were meant to distribute the\noriginal Emotet. Although currently the deletion routine won’t be called yet, the infrastructure\nbehind Emotet is already controlled by law enforcement, so the bots are not able to perform\ntheir malicious action.\n\nFor victims with an existing Emotet infection, the new version will come as an update,\nreplacing the former one. This is how it will be aware of its installation paths and able to\nclean itself once the deadline has passed.\n\nPushing code via a botnet, even with good intentions, has always been a thorny topic mainly\nbecause of the legal ramifications such actions imply. The DOJ affidavit makes a note of how\nthe “Foreign law enforcement agents, not FBI agents, replaced the Emotet malware, which is\nstored on a server located overseas, with the file created by law enforcement”.\n\nThe lengthy delay for the cleanup routine to activate may be explained by the need to give\nsystem administrators time for forensics analysis and checking for other infections.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-29 - Cleaning up after Emotet- the law enforcement file.pdf"
    ],
    "report_names": [
        "2021-01-29 - Cleaning up after Emotet- the law enforcement file.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536211,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653779304,
    "ts_modification_date": 1653779304,
    "files": {
        "pdf": "https://archive.orkl.eu/eddb5ea37884d76d97d95af4ed9b8197e30fd9a4.pdf",
        "text": "https://archive.orkl.eu/eddb5ea37884d76d97d95af4ed9b8197e30fd9a4.txt",
        "img": "https://archive.orkl.eu/eddb5ea37884d76d97d95af4ed9b8197e30fd9a4.jpg"
    }
}