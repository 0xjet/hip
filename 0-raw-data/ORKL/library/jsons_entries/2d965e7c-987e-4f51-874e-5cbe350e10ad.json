{
    "id": "2d965e7c-987e-4f51-874e-5cbe350e10ad",
    "created_at": "2023-01-12T15:04:31.319474Z",
    "updated_at": "2025-03-27T02:05:51.691708Z",
    "deleted_at": null,
    "sha1_hash": "3ecc56d1e53f357f75d5c76c5a094b1ef939f43d",
    "title": "2021-04-26 - Shlayer malware abusing Gatekeeper bypass on macOS",
    "authors": "",
    "file_creation_date": "2022-05-27T21:50:07Z",
    "file_modification_date": "2022-05-27T21:50:07Z",
    "file_size": 427530,
    "plain_text": "# Shlayer malware abusing Gatekeeper bypass on macOS\n\n**[jamf.com/blog/shlayer-malware-abusing-gatekeeper-bypass-on-macos/](https://www.jamf.com/blog/shlayer-malware-abusing-gatekeeper-bypass-on-macos/)**\n\n[Jamf Blog](https://www.jamf.com/blog/)\n\nApril 26, 2021 by Jaron Bradley\n\n[Jamf Protect,](https://www.jamf.com/blog/category/jamf-protect/) [Enterprise,](https://www.jamf.com/blog/category/enterprise/) [Education,](https://www.jamf.com/blog/category/education/) [Government,](https://www.jamf.com/blog/category/government/) [Healthcare,](https://www.jamf.com/blog/category/healthcare/) [Security](https://www.jamf.com/blog/category/security/)\nShlayer malware detected allows an attacker to bypass Gatekeeper, Notarization and File\nQuarantine security technologies in macOS. The exploit allows unapproved software to run\non Mac and is distributed via compromised websites or poisoned search engine results.\n\nIn a [recent blog post, Objective-See covered that prior to macOS 11.3, an attacker could](https://objective-see.com/blog/blog_0x64.html)\ncraft a fake application bundle using a script as the primary executable allowing them to\nbypass File Quarantine, Gatekeeper and Notarization on the macOS platform. All of which\nare technologies in place to prevent unapproved software from running on macOS.\n\nTo make the situation more urgent, the Jamf Protect detections team observed this exploit\nbeing used in the wild by a variant of the Shlayer adware dropper. The variant observed has\n[strong ties to a sample previously written about by Intego Security. In fact, both malware](https://www.intego.com/mac-security-blog/new-mac-malware-reveals-google-searches-can-be-unsafe/)\nsamples are nearly identical. The major difference, in this case, is that the variant has been\nrepackaged to use a format necessary for carrying out the Gatekeeper bypass vulnerability.\nThe Jamf Protect detection team identified samples found to be abusing this vulnerability as\nearly as January 9th, 2021.\n\nThe details behind how the vulnerability can be abused by attackers are:\n\n\n-----\n\n1. An attacker manually crafts an application bundle by using a script as the main\n\nexecutable. (example:myapplication.app/Contents/MacOS/myapplication where\n“myapplication” is a bash script). For this to work, the script name must match the\napplication name and they must not create an Info.plist file.\n2. The application can then be placed in a dmg for distribution.\n3. When the dmg is mounted and the application is double-clicked, the combination of a\n\nscript-based application with no Info.plist file executes without any quarantine,\nsignature or notarization verification. This will work on any system running macOS\nversions 10.15 to 11.2.\n\n[Previous variants of this malware are known to spread via poisoned search engine results -](https://en.wikipedia.org/wiki/Spamdexing)\nthis variant is no exception. This is an approach where the malicious actors spreading the\nmalware create web pages with content tailored to appear in search results for common\nqueries or hijack legitimate websites without the knowledge of the owner. Since most search\nengines automate the indexing and ranking, this leads to them inadvertently publishing links\nto the malicious or hijacked sites hosting malware. In a real-world example, users could\npotentially stumble upon malware when searching for any commonly used terms. This is an\nexample of a user searching for “Alexa and Disney” on Google Search in April 2021.\n\n\n-----\n\n_Screenshot of Google results when searching “alexa and disney” taken by Jamf on_\n_April 12, 2021._\n\nBy clicking on a compromised result, in this case, the highlighted link above, the user is\nredirected to a new webpage asking them to download an unsolicited software application\nthat looks similar to a real alert to update out-of-date software. This of course is not\nsomething specific to Amazon, Disney, or Google, but rather malicious actors abusing search\nengine indexing and/or compromising web pages.\n\n\n-----\n\n_Screenshot of fake installer taken by Jamf on April 12, 2021. Adobe Flash Player_\n_reached End of Life on 12/31/2020_\n\nAn older variant of the Shlayer malware would deliver a dmg file that held a system link to a\nshell script. This shell script would have an installer logo attached to it, providing to the user\nthe appearance of legitimacy. The mounted dmg also provided instructions to right-click the\nfile and select “Open”, in an attempt to convince the user to install the malicious application.\nAnd while executing the file in this manner is allowed by Apple’s design, a consequence of\nthis method allows applications - both trusted and malicious - to be opened while bypassing\nGatekeeper’s checks altogether, leading in this instance to infecting the Mac.\n\n\n-----\n\n_The old variant of Shlayer attempting to convince a user to right-click and open the_\n_malware._\n\nThis new variant found no longer requires the right-click method since the malware comes\npackaged in the format required to abuse CVE-2021-30657.\n\n## The new Gatekeeper bypass step-by-step\n\nAfter mounting the dmg and opening the installer, the user is displayed the following\napplication:\n\nIn further investigating of the application’s layout, more detail is revealed.\n\n\n-----\n\nThe image displayed to the user after mounting the DMG appears to be the “Install” file. In\nactuality, it is just a system link that points to the 1302.app application bundle, or the\nmalicious application itself. By double-clicking the “Install” image in Figure C, the system\nactually executes the 1302.app, where 1302.app/Contents/MacOS/1302 is just a bash script.\n\nDue to the file path layout in which this script is set up, double-clicking the install icon\nexecutes the script held within 1302.app and bypasses the checks performed by\nGatekeeper, described in further detail in CVE-2021-30657.\n\n### Interested in seeing how Jamf protects your devices from this and other\n malware?\n\n[Request Trial](https://www.jamf.com/request-trial/jamf-protect/)\n\n## Additional malware behaviors\n\nAs mentioned previously, the contents of the bash script itself have been seen in variants of\nthis malware before. The script begins by invoking the “mktemp -t Installer” command to\ncreate a unique filename. In this case,“Installer.XXXXXXXX” is created in a temporary\ndirectory. The trailing “X’s” in the filename are automatically generated using the current\nprocess number and/or a letter combination unique to this file instance.\n\n_Truncated Output of Bash Script Contained Within 1302.app_\n\nIn a clever attempt to mask its presence from detection, the malware hides a zipped\nexecutable at the bottom of the script itself as seen above in Figure E\n\n\n-----\n\nA secondary command, tail -c 58853 $0 | funzip -1uD9jgw > ${TEMP_NAME} performs the\nfollowing actions:\n\nTail - Take the last 58853 bytes of the running script.\n\nFunzip - Treat those bytes as a zip file and unzip it using the supplied password.\n\n>${TEMP_NAME} - Write the newly unzipped file to the disk at the aforementioned temp file\nlocation.\n\nThe unzipped executable file is invoked with the command “nohup,” which instructs the\nprocess to ignore any HUP, or hangup signals. This is often used by attackers to run\nprograms in the background. The final unzipped payload is a sample of the Bundlore\nadware, but this final payload may vary across different Shlayer samples.\n\n## Patched by Apple\n\nApple has patched this vulnerability in the 11.3 version of macOS. When this same malware\nis executed on a patched version of macOS, the user will see a pop-up message stating that\nthe software “cannot be opened because the developer cannot be identified.” Since the\nmalicious application is not notarized or signed with a valid developer’s certificate, the\nmessage will prompt the user to eject the mounted DMG containing the app bundle.\n\n## Conclusion\n\nShlayer continues to reintroduce itself with innovative ways to infect macOS-based systems.\nJamf Protect provides behavioral analytics to detect built-in scripting languages being\nexecuted as though they are app bundles. This should help users discover malware abusing\n\n\n-----\n\nthis technique on Mac computers running macOS versions prior to 11.3, as well as other\nsuspicious applications. Jamf Protect defends against known malware samples of Shlayer,\n[including the adware variants that it drops. Jamf recommends users “patch fast and patch](https://www.jamf.com/blog/even-for-iphone-patch-fast-and-often/)\noften” to keep their Mac up-to-date by upgrading macOS to versions 11.3, which is available\nnow through the Mac App Store and provides the latest protection against the vulnerabilities\ndiscussed in this article.\n\n## Indicators of Compromise\n\nFiles Hashes:\n\nAdobeFlashPlayer.dmg → 55869270ed20956e5c3e5533fb4472e4eb533dc2\n1302.app/Contents/MacOS/1302 → 085a136c03f8b024a173068768c67b1a5ad928c1\nBundlore Dropped Executable → 20ac95c44549710a434902267394525333e96c0b\n\nDomains Serving Malware:\n\nhxxps://supportversion[.]yourlinkforplaceforupgrading[.]info\n\n### Protect your environment today\n\n[Request Trial](https://www.jamf.com/request-trial/jamf-protect/)\n_[Additional coverage of this and Apple's bug bounty program may be found at The](https://www.washingtonpost.com/technology/2021/09/09/apple-bug-bounty/)_\n_Washington Post._\n\nJaron Bradley\n\nOther authors:\nStuart Ashenbrenner, Ferdous Saljooki\n\nSubscribe to the Jamf Blog\nHave market trends, Apple updates and Jamf news delivered directly to your inbox.\n\nTo learn more about how we collect, use, disclose, transfer, and store your information,\n[please visit our Privacy Policy.](https://www.jamf.com/privacy-policy/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-04-26 - Shlayer malware abusing Gatekeeper bypass on macOS.pdf"
    ],
    "report_names": [
        "2021-04-26 - Shlayer malware abusing Gatekeeper bypass on macOS.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535871,
    "ts_updated_at": 1743041151,
    "ts_creation_date": 1653688207,
    "ts_modification_date": 1653688207,
    "files": {
        "pdf": "https://archive.orkl.eu/3ecc56d1e53f357f75d5c76c5a094b1ef939f43d.pdf",
        "text": "https://archive.orkl.eu/3ecc56d1e53f357f75d5c76c5a094b1ef939f43d.txt",
        "img": "https://archive.orkl.eu/3ecc56d1e53f357f75d5c76c5a094b1ef939f43d.jpg"
    }
}