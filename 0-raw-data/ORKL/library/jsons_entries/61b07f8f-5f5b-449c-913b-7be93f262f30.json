{
    "id": "61b07f8f-5f5b-449c-913b-7be93f262f30",
    "created_at": "2023-01-12T15:09:23.328749Z",
    "updated_at": "2025-03-27T02:06:13.976009Z",
    "deleted_at": null,
    "sha1_hash": "99b22eb6f9b8ea2078271704a6285006ce6d86ec",
    "title": "2022-09-30 - Dissecting BlueSky Ransomware Payload",
    "authors": "",
    "file_creation_date": "2022-10-02T12:26:27Z",
    "file_modification_date": "2022-10-02T12:26:27Z",
    "file_size": 1592195,
    "plain_text": "# Dissecting BlueSky Ransomware Payload\n\n**yoroi.company/research/dissecting-bluesky-ransomware-payload/**\n\n09/30/2022\n\n## Introduction\n\n\nSeptember 30, 2022\n\n\nBlueSky is a ransomware firstly spotted in May 2022 and it gained the attention of the threat researchers for\ntwo main reasons: the first one is that the group behind the ransomware doesn’t adopt the double-extortion\nmodel; the second one is that their targets are even normal users because the ransomware has been\ndiscovered inside cracks of programs and videogames.\n\nFor these reasons, we at Yoroi malware ZLab decided to keep track of the threat, following the distribution of\nthe samples, and we decided to provide a technical analysis of the ransomware payload.\n\n\n-----\n\nFigure 1: Bluesky Control Flow\n\nTechnical Analysis\n\nHash 9e302bb7d1031c0b2a4ad6ec955e7d2c0ab9c0d18d56132029c4c6198b91384f\n\nThreat Ransomware\n\n\nBrief\nDescription\n\n\nBlueSky Ransomware\n\n\nSSDEEP 1536:G+5geBR2Q+a8M124Zl2i5SADBDg8trv4t9MBY5ySvV:GDeBgQ+a8M12Y2i59hrvWMBGvV\n\n### The API Loading Scheme\n\nThe sample starts by walking the PEB (Process Environment Block) to dynamically load the APIs. It is a\ncommon technique to not statically show them in the import table, it walks one of the three linked lists located\nin the PEB_LDR_DATA such as InLoadOrderModuleList. In this way, the sample is able to enumerate the\nmodules contained inside the linked list and to compare them with the hashed names hidden inside the code in\norder to correctly import the desired ones. In this case, the APIs are hashed with djb2 algorithm.\n\n\n-----\n\nFigure 2: Dynamically loading APIs\n\nThe following figure shows the routines to dynamically load the function:\n\n\n-----\n\nFigure 3: \"mw_load_function routine\"\n\n### The obfuscated Stack Strings\n\nInstead, other critical strings are obfuscated through the stackstrings method and a simple routine to encrypt\nthem\n\n\n-----\n\nFigure 4: Strings Decryption Routine\n\nHowever, the algorithm is easy to revert, and we developed an easy script to decrypt the stackstrings:\n```\nstring = [123,82,90,123,45,56,32,88,94]\n\ndecrypted = \"\"\n\nfor i in string:\n\n  decrypted += chr((34 * (i - 94) % 127 + 127) % 127)\n\nprint(decrypted)\n\n### Anti-Debug Technique\n\n```\nOnce resolved the first functions, the sample calls NtSetInformationThread with ThreadHideFromDebugger\nhiding the thread and if any breakpoint is placed causing the crash of the process, you can read more about\n[this anti-debug technique here](https://anti-debug.checkpoint.com/techniques/interactive.html#ntsetinformationthread)\n\nFigure 5: NtSetInformationThread\n\nanti-debug\nPrivilege Escalation\n\n\n-----\n\nWhile analyzing the sample, we also found similarities with Conti Ransomware in how the strings are\nobfuscated and some other routines, like how BlueSky removes the shadow copies through the WMI COM\nInterface. It abuses the “ICMLuaUtil COM Interface (3E5FC7F9-9A51-4367-9063-A120244FBEC7)”. However,\nthis technique is a well-known and documented technique publicly available on the internet, adopted both in\nintrusion and malware development operations.\n\nFigure 6: Bypassing UAC via ICMLuaUtil\n\nThe sample calls RtlAdjustPrivilege API call with the token “SeDebugPrivilege”, in order to gain the privilege to\narbitrary manipulate every file and process.\n\nFigure 7: Evidence of privilege escalation method\n\n### Generating the Victim ID\n\nBlueSky proceeds by generating the victim ID by hashing with MD5 the following system info:\n\nMachineGuid (4 Bytes)\nDigitalProductId\nInstallDate\nC:\\ Serial Number\n\n\n-----\n\nThen the hash is passed to the following custom routine:\n\nFigure 8: Hash custom routine\n\nThe sample proceeds creating a mutex “Global\\\\{generated_id}” in this case being\n“Global\\1580B4213F8F3E90E4E0E3CD1F6FAC52”\n\nFigure 9: Mutex Creation\n\n### The Encryption Routine\n\nNow it’s time to encrypt the files. The first operation of the sample is to aquire a handle to the cryptographic\nprovider PROV_RSA_FULL by calling CryptAcquireContextA:\n\n\n-----\n\nFigure 10: Acquiring a handle to\n\nPROV_RSA_FULL\nBlueSky stores the information related to the encryption, in the registry key\n“HKCU\\SOFTWARE\\1580B4213F8F3E90E4E0E3CD1F6FAC52\\”. To store the recovery information, it uses\n“ChaCha20 + Curve25519 + RC4 (on RECOVERYBLOB)”, meanwhile “ChaCha20 + Curve25519” for the\nencryption\n\nFigure 11: BlueSky Recovery Information\nBelow the encryption routine:\n\n\n-----\n\nFigure 12: Encryption routine\nBlueSky creates a list of the excluded files inside the code. The list is the following:\n\n**Extensions (ldf, scr, icl, 386, cmd, ani, adv, theme, msi, rtp, diagcfg, msstyles, bin, hlp, shs, drv, wpx, bat,**\nrom, msc, lnk, cab, spl, ps1, msu, ics, key, msp, com, sys, diagpkg, nls, diagcab, ico, lock, ocx, mpa, cur,\ncpl, mod, hta, exe, ini, icns, prf, dll, bluesky, nomedia, idx)\n\n**Directories ($recycle.bin, $windows.~bt, $windows.~ws, boot, windows, windows.old, system volume**\ninformation, perflogs, programdata, program files, program files (x86), all users, appdata, tor browser)\n**Filenames (# decrypt files bluesky #.txt, # decrypt files bluesky #.html, ntuser.dat, iconcache.db,**\nntuser.dat.log, bootsect.bak, autorun.inf, bootmgr, ntldr, thumbs.db)\n\n### Exception Handling and other features\n\n\n-----\n\nThe sample implements also some interesting Exception Handling features in order to avoid the system crash.\nIn detail, before proceeding to the encryption BlueSky checks if after calling CreateFileW the LastErrorValue is\n**[ERROR_SHARING_VIOLATIONif true, the sample calls NtQueryInformatonFile retrieving the](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ne-wdm-_file_information_class)**\n**FileProcessIdsUsingFileInformation which contains a list of the PIDs which use the file. If the PID isn’t equal**\nto itself or the PID of explorer.exe retrieved before, it calls NtQueryInformatonProcess with\n**ProcessInformationClass set to 29 (ProcessBreakOnTermination) to retrieve a value indicating whether the**\nprocess is considered critical. In this case, the malware skips that file and keeps encrypting others.\n\nFigure 13: Checking file availability\n\nThe sample can prevent the system from entering sleep or turning off the display by calling\n**SetThreadExecutionState to ES_CONTINUOUS**\n\nFigure 14: Preventing sleep mode\n\nAt the end of the encryption, the ransom note points to the blog of the attackers:\n\n\n-----\n\nFigure 15: BlueSky Ransomware Website\n\n## Conclusion\n\nBlusky ransomware is a proof that even nowadays cyber criminals use basic and highly effective social\nengineering techniques. When we are looking for a cracked software, we have to know that there is always a\nprice and in this case it’s a ransomware with a high ransom.\n\nSo, it is necessary to sensibilize people to avoid installing cracked software, not only inside the company\nperimeter, but also inside the home devices. It is a simple but effective preventive measure to defend against\nsimilar threats.\n\nThe attention for emerging threats is one of the core activities of Yoroi and we think that BlueSky needs to be\nobserved with attention.\n\n## Yara Rules\n\n\n-----\n\n```\n       y_\n{\n\n meta:\n\n  author = \"Yoroi Malware ZLab\"\n\n  description = \"Rule for BlueSky Ransomware\"\n\n  last_updated = \"2022-09-14\"\n\n  tlp = \"WHITE\"\n\n  category = \"informational\"\n\n  hash = \"9e302bb7d1031c0b2a4ad6ec955e7d2c0ab9c0d18d56132029c4c6198b91384f\"\n\n strings:\n\n   //sub_00407a30\n\n  $1 = {55 8b ec 83 ec ?? 56 e8 ?? ?? ?? ?? 85 c0 0f 84 ?? ?? ?? ?? 0f 10 05 ?? ?? ?? ?? 68 ?? ?? ??\n?? 68 ?? ?? ?? ?? 0f 11 4? ?? 68 ?? ?? ?? ?? 0f 10 05 ?? ?? ?? ?? c7 4? ?? ?? ?? ?? ?? c7 4? ?? ?? ??\n?? ?? 0f 11 4? ?? e8 ?? ?? ?? ?? 0f 10 4? ?? 83 c4 ?? 8b d0 8d 4? ?? 50 83 ec ?? 8b cc 6a ?? 6a ?? 83\nec ?? 0f 11 01 8b c4 0f 10 4? ?? 0f 11 00 ff d2 85 c0 0f 88 ?? ?? ?? ?? 68 ?? ?? ?? ?? 68 ?? ?? ?? ??\n68 ?? ?? ?? ?? e8 ?? ?? ?? ?? 83 c4 ?? 8d 4? ?? 51 ff d0 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? 68 ?? ?? ?? ??\ne8 ?? ?? ?? ?? 83 c4 ?? 8d 4? ?? 51 ff d0 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? e8 ?? ?? ?? ??\n83 c4 ?? 8d 4d c8 51 ff d0 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? e8 ?? ?? ?? ?? 83 c4 ?? 8d 4?\n?? 51 ff d0 0f 10 4? ?? 8b 4? ?? 83 ec ?? 8b c4 83 ec ?? 8b 11 0f 11 00 8b c4 83 ec ?? 0f 10 4? ?? 0f\n11 00 8b c4 83 ec ?? 0f 10 4? ?? 0f 11 00 8b c4 0f 10 4? ?? 51 0f 11 00 ff 52 28 68 ?? ?? ?? ?? 68 ??\n?? ?? ?? 68 ?? ?? ?? ?? 8b f0 e8 ?? ?? ?? ?? 83 c4 ?? 8d 4? ?? 51 ff d0 68 ?? ?? ?? ?? 68 ?? ?? ?? ??\n68 ?? ?? ?? ?? e8 ?? ?? ?? ?? 83 c4 ?? 8d 4? ?? 51 ff d0 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? 68 ?? ?? ?? ??\ne8 ?? ?? ?? ?? 83 c4 ?? 8d 4? ?? 51 ff d0 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? e8 ?? ?? ?? ??\n83 c4 ?? 8d 4? ?? 51 ff d0 85 f6 78 ?? 8b 4? ?? 8d 5? ?? 52 68 ?? ?? ?? ?? 50 8b 08 ff 5? ?? 85 c0 78\n?? 8b 4? ?? 6a ?? ff 7? ?? 8b 08 50 ff 5? ?? 8b 4? ?? 85 c9 74 ?? 8b 01 51 ff 5? ?? 8b 4? ?? 85 c9 74\n?? 8b 01 51 ff 50 08 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? e8 ?? ?? ?? ?? 83 c4 ?? ff d0 5e 8b\ne5 5d c3}\n\n condition:\n\n  uint16(0) == 0x5A4D and $1\n\n}\n\n```\n_This blog post was authored by Luigi Martire, Carmelo Ragusa of Yoroi Malware ZLAB_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-09-30 - Dissecting BlueSky Ransomware Payload.pdf"
    ],
    "report_names": [
        "2022-09-30 - Dissecting BlueSky Ransomware Payload.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536163,
    "ts_updated_at": 1743041173,
    "ts_creation_date": 1664713587,
    "ts_modification_date": 1664713587,
    "files": {
        "pdf": "https://archive.orkl.eu/99b22eb6f9b8ea2078271704a6285006ce6d86ec.pdf",
        "text": "https://archive.orkl.eu/99b22eb6f9b8ea2078271704a6285006ce6d86ec.txt",
        "img": "https://archive.orkl.eu/99b22eb6f9b8ea2078271704a6285006ce6d86ec.jpg"
    }
}