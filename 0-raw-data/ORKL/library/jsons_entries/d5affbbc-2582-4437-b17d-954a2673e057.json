{
    "id": "d5affbbc-2582-4437-b17d-954a2673e057",
    "created_at": "2023-01-12T15:09:39.84417Z",
    "updated_at": "2025-03-27T02:16:58.155875Z",
    "deleted_at": null,
    "sha1_hash": "5312cf0e28106942e3412cc9fddf90a4a6d8e10f",
    "title": "2022-03-27 - Conti ransomware source code investigation - part 1",
    "authors": "",
    "file_creation_date": "2022-10-02T12:23:30Z",
    "file_modification_date": "2022-10-02T12:23:30Z",
    "file_size": 1910552,
    "plain_text": "# Conti ransomware source code investigation - part 1.\n\n**[cocomelonc.github.io/investigation/2022/03/27/malw-inv-conti-1.html](https://cocomelonc.github.io/investigation/2022/03/27/malw-inv-conti-1.html)**\n\nMarch 27, 2022\n\n4 minute read\n\n﷽\n\nHello, cybersecurity enthusiasts and white hackers!\n\nA Ukrainian security researcher has leaked newer malware source code from the Conti\nransomware operation in revenge for the cybercriminals siding with Russia on the invasion of\nUkraine.\n\nAs you can see the last modified dates being January 25th, 2021.\n\n## what’s Conti ransomware?\n\n\n-----\n\nContiLocker is a ransomware developed by the Conti Ransomware Gang, a Russianspeaking criminal collective with suspected links with Russian security agencies. Conti is\nalso operates a ransomware-as-a-service (RaaS) business model.\n\n## structure\n\nThe source code leak is a Visual Studio solution (contains `conti_v3.sln ):`\n\nthat allows anyone with access to compile the ransomware locker:\n\n\n-----\n\nand decryptor:\n\n\n-----\n\n## AV engines evasion\n\nThe first thing that usually attracts me to professionally written malware is the action by\nwhich this malware itself evasion AV engines and hides its activity.\n\nTo see the mechanism of communication with WinAPI, I look in the folder `api :`\n\n\n-----\n\nSo, looking at the file `getapi.cpp . First of all see:`\n\nAs you can see, to convert RVA (Relative Virtual Address) to VA (Virtual Address) conti used\nthis macro.\n\nThen, find function `GetApiAddr which find Windows API function address by comparing it’s`\nhash:\n\n\n-----\n\nthat is, Conti uses one of the simplest but effective AV engines bypass tricks, I wrote about\n[this in a previous post.](https://cocomelonc.github.io/tutorial/2022/03/22/simple-av-evasion-5.html)\n\nAnd what hashing algorithm is used by conti?\n\n\n-----\n\n_[MurmurHash is a non-cryptographic hash function and was written by Austin Appleby.](https://github.com/aappleby/smhasher/blob/master/src/MurmurHash3.cpp)_\n\nAfter that, the `api module is invoked to execute an anti-sandbox technique with the`\npurpose of disable all the possible hooking’s on known DLLs. In fact, the following DLLs are\nloaded through the just resolved `LoadLibraryA API:`\n\n\n-----\n\n## threading\n\nWhat about module `threadpool ?. Each thread allocates its own buffer for the upcoming`\nencryption and initialize its own cryptography context through the `CryptAcquireContextA`\nAPI and an RSA public key.:\n\n\n-----\n\nThen, each thread waits in an infinite loop for a task in the `TaskList queue. In case a new`\ntask is available, the filename to encrypt is extracted from the task:\n\n## encryption\n\nThe encryption for a specific file starts with a random key generation using the\n```\nCryptGenRandom API:\n\n```\n\n-----\n\nof a `32 -bytes key and another random generation of an` `8 -bytes IV.`\n\n[And as you can see, conti used ChaCha stream cipher which developed by D.J.Bernstein.](https://en.wikipedia.org/wiki/Salsa20)\n```\nCheckForDataBases method is invoked to check for a possible full or partial encryption:\n\n```\n\n-----\n\nagainst the following extensions:\n\n\n-----\n\n```\n.4dd, .4dl, .accdb, .accdc, .accde, .accdr, .accdt, .accft, .adb, .ade,\n.adf, .adp, .arc, .ora, .alf, .ask, .btr, .bdf, .cat, .cdb, .ckp, .cma,\n.cpd, .dacpac, .dad, .dadiagrams, .daschema, .db, .db-shm, .db-wal, .db3,\n.dbc, .dbf, .dbs, .dbt, .dbv, .dbx, .dcb, .dct, .dcx, .ddl, .dlis, .dp1,\n.dqy, .dsk, .dsn, .dtsx, .dxl, .eco, .ecx, .edb, .epim, .exb, .fcd, .fdb,\n.fic, .fmp, .fmp12, .fmpsl, .fol, .fp3, .fp4, .fp5, .fp7, .fpt, .frm, .gdb,\n.grdb, .gwi, .hdb, .his, .ib, .idb, .ihx, .itdb, .itw, .jet, .jtx, .kdb,\n.kexi, .kexic, .kexis, .lgc, .lwx, .maf, .maq, .mar, .mas.mav, .mdb, .mdf,\n.mpd, .mrg, .mud, .mwb, .myd, .ndf, .nnt, .nrmlib, .ns2, .ns3,.ns4, .nsf,\n.nv, .nv2, .nwdb, .nyf, .odb, .ogy, .orx, .owc, .p96, .p97, .pan, .pdb, .p\ndm, .pnz, .qry, .qvd, .rbf, .rctd, .rod, .rodx, .rpd, .rsd, .sas7bdat, .sbf,\n.scx, .sdb, .sdc, .sdf, .sis, .spg, .sql, .sqlite, .sqlite3, .sqlitedb, .te,\n.temx, .tmd, .tps, .trc, .trm, .udb, .udl, .usr, .v12, .vis, .vpd, .vvv,\n.wdb, .wmdb, .wrk, .xdb, .xld, .xmlff, .abcddb, .abs, .abx, .accdw, .adn,\n.db2, .fm5, .hjt, .icg, .icr, .kdb, .lut, .maw, .mdn, .mdt\n\n```\nAnd `CheckForVirtualMachines method is invoked to check for a possible partial`\nencryption ( 20% ):\n\n\n-----\n\nthe following extensions:\n```\nvdi, .vhd, .vmdk, .pvm, .vmem, .vmsn, .vmsd, .nvram, .vmx, .raw, .qcow2,\n.subvol, .bin, .vsv, .avhd, .vmrs, .vhdx, .avdx, .vmcx, .iso\n\n```\nand in other cases, the following pattern is followed:\n\nif the file size is lower than `1048576 bytes (1.04 GB) - perform a full encryption`\nif the file size is `< 5242880 bytes (5.24 GB) and` `> 1048576 bytes (1.04 GB) -`\npartial encryption: only headers\n\n\n-----\n\nelse, `50% partial encryption:`\n\n\n-----\n\n## obfuscation\n\nIn addition, an interesting module was found in the source codes: `obfuscation :`\n\n[which can generate obfuscated code via ADVObfuscator. For example strings:](https://github.com/andrivet/ADVobfuscator)\n\n\n-----\n\nThat’s all today. In the next part I will investigate `network_scanner and` `filesystem`\nmodules.\n\n## conclusion\n\nOn `February 25th, 2022, Conti released a statement of full support for the Russian`\ngovernment - coupled with a stern warning addressed at anyone who might consider\nretaliating against Russia via digital warfare.\n\nContiLeaks is a turning point in the cybercrime ecosystem, and in this case, we can expect a\nlot of changes in how cybercriminal organizations operate. From the one side less mature\ncybercriminal orgs might be very powerful and instead more sophischated gangs will learn\nfrom Conti’s mistakes.\n\nI hope this post spreads awareness to the blue teamers of this interesting malware\ntechniques, and adds a weapon to the red teamers arsenal.\n\n[Carbanak](https://en.wikipedia.org/wiki/Carbanak)\n[GetApiAddr implementation in Carberp malware](https://github.com/hryuk/Carberp/blob/master/source%20-%20absource/pro/all%20source/RemoteCtl/DrClient/GetApi.cpp)\n[Carbanak source code](https://github.com/Aekras1a/Updated-Carbanak-Source-with-Plugins)\n[MurmurHash by Austin Appleby](https://github.com/aappleby/smhasher/blob/master/src/MurmurHash3.cpp)\n\n\n-----\n\n[ADVObfuscator](https://github.com/andrivet/ADVobfuscator)\n[ChaCha cipher](https://en.wikipedia.org/wiki/Salsa20)\n[theZoo repo in Github](https://github.com/ytisf/theZoo)\n\nThis is a practical case for educational purposes only.\n\nThanks for your time happy hacking and good bye!\n\n_PS. All drawings and screenshots are mine_\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-03-27 - Conti ransomware source code investigation - part 1.pdf"
    ],
    "report_names": [
        "2022-03-27 - Conti ransomware source code investigation - part 1.pdf"
    ],
    "threat_actors": [
        {
            "id": "c9617bb6-45c8-495e-9759-2177e61a8e91",
            "created_at": "2022-10-25T15:50:23.405039Z",
            "updated_at": "2025-03-27T02:00:55.462193Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Carbanak",
                "Anunak"
            ],
            "source_name": "MITRE:Carbanak",
            "tools": [
                "Carbanak",
                "Mimikatz",
                "PsExec",
                "netsh"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "f4f16213-7a22-4527-aecb-b964c64c2c46",
            "created_at": "2024-06-19T02:03:08.090932Z",
            "updated_at": "2025-03-27T02:05:17.387119Z",
            "deleted_at": null,
            "main_name": "GOLD NIAGARA",
            "aliases": [
                "Carbanak",
                "Carbon Spider ",
                "FIN7 ",
                "Navigator ",
                "Sangria Tempest ",
                "TelePort Crew ",
                "Calcium "
            ],
            "source_name": "Secureworks:GOLD NIAGARA",
            "tools": [
                " Carbanak",
                " Cobalt Strike",
                " DICELOADER",
                " DRIFTPIN",
                " GGLDR",
                " GRIFFON",
                " JSSLoader",
                " Meterpreter",
                " OFFTRACK",
                " PILLOWMINT",
                " POWERTRASH",
                " SUPERSOFT",
                " TAKEOUT",
                " TinyMet",
                "Bateleur"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "bb8702c5-52ac-4359-8409-998a7cc3eeaf",
            "created_at": "2023-01-06T13:46:38.405479Z",
            "updated_at": "2025-03-27T02:00:02.82533Z",
            "deleted_at": null,
            "main_name": "FIN7",
            "aliases": [
                "JokerStash",
                "ATK32",
                "G0046",
                "Coreid",
                "Carbanak",
                "Sangria Tempest",
                "CARBON SPIDER",
                "GOLD NIAGARA",
                "G0008",
                "ELBRUS",
                "Carbon Spider"
            ],
            "source_name": "MISPGALAXY:FIN7",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "b69037ec-2605-4de4-bb32-a20d780a8406",
            "created_at": "2023-01-06T13:46:38.790766Z",
            "updated_at": "2025-03-27T02:00:02.919758Z",
            "deleted_at": null,
            "main_name": "MUSTANG PANDA",
            "aliases": [
                "TEMP.HEX",
                "TA416",
                "TANTALUM",
                "Twill Typhoon",
                "Earth Preta",
                "Stately Taurus",
                "LuminousMoth",
                "Polaris",
                "BRONZE PRESIDENT",
                "HoneyMyte",
                "Red Lich"
            ],
            "source_name": "MISPGALAXY:MUSTANG PANDA",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "9baa7519-772a-4862-b412-6f0463691b89",
            "created_at": "2022-10-25T15:50:23.354429Z",
            "updated_at": "2025-03-27T02:00:55.45162Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Mustang Panda",
                "TA416",
                "RedDelta",
                "BRONZE PRESIDENT"
            ],
            "source_name": "MITRE:Mustang Panda",
            "tools": [
                "Cobalt Strike",
                "RCSession",
                "NBTscan",
                "PoisonIvy",
                "PlugX"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "2ee03999-5432-4a65-a850-c543b4fefc3d",
            "created_at": "2022-10-25T16:07:23.882813Z",
            "updated_at": "2025-03-27T02:02:10.0116Z",
            "deleted_at": null,
            "main_name": "Mustang Panda",
            "aliases": [
                "Bronze President",
                "Camaro Dragon",
                "Earth Preta",
                "HoneyMyte",
                "Mustang Panda",
                "Operation SMUGX",
                "Operation SmugX",
                "PKPLUG",
                "Red Lich",
                "Stately Taurus",
                "TEMP.Hex"
            ],
            "source_name": "ETDA:Mustang Panda",
            "tools": [
                "9002 RAT",
                "AdFind",
                "Agent.dhwf",
                "Agentemis",
                "CHINACHOPPER",
                "China Chopper",
                "Chymine",
                "ClaimLoader",
                "Cobalt Strike",
                "CobaltStrike",
                "DCSync",
                "DOPLUGS",
                "Darkmoon",
                "Destroy RAT",
                "DestroyRAT",
                "Farseer",
                "Gen:Trojan.Heur.PT",
                "HOMEUNIX",
                "Hdump",
                "HenBox",
                "HidraQ",
                "Hodur",
                "Homux",
                "HopperTick",
                "Hydraq",
                "Impacket",
                "Kaba",
                "Korplug",
                "LadonGo",
                "MQsTTang",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "NBTscan",
                "NetSess",
                "Netview",
                "Orat",
                "POISONPLUG.SHADOW",
                "PUBLOAD",
                "PVE Find AD Users",
                "PlugX",
                "Poison Ivy",
                "PowerView",
                "QMAGENT",
                "RCSession",
                "RedDelta",
                "Roarur",
                "SPIVY",
                "ShadowPad Winnti",
                "SinoChopper",
                "Sogu",
                "TIGERPLUG",
                "TONEINS",
                "TONESHELL",
                "TVT",
                "TeamViewer",
                "Thoper",
                "TinyNote",
                "WispRider",
                "WmiExec",
                "XShellGhost",
                "Xamtrav",
                "Zupdax",
                "cobeacon",
                "nbtscan",
                "nmap",
                "pivy",
                "poisonivy"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "ed3810b7-141a-4ed0-8a01-6a972b80458d",
            "created_at": "2022-10-25T16:07:23.443259Z",
            "updated_at": "2025-03-27T02:02:09.801771Z",
            "deleted_at": null,
            "main_name": "Carbanak",
            "aliases": [
                "Anunak",
                "Carbanak",
                "Carbon Spider",
                "ELBRUS",
                "Gold Waterfall",
                "Sangria Tempest"
            ],
            "source_name": "ETDA:Carbanak",
            "tools": [
                "AVE_MARIA",
                "Agentemis",
                "AmmyyRAT",
                "Antak",
                "Anunak",
                "Ave Maria",
                "AveMariaRAT",
                "BABYMETAL",
                "BIRDDOG",
                "Backdoor Batel",
                "Batel",
                "Bateleur",
                "BlackMatter",
                "Boostwrite",
                "Cain & Abel",
                "Carbanak",
                "Cl0p",
                "Cobalt Strike",
                "CobaltStrike",
                "DNSMessenger",
                "DNSRat",
                "DNSbot",
                "DRIFTPIN",
                "DarkSide",
                "FOXGRABBER",
                "FlawedAmmyy",
                "HALFBAKED",
                "JS Flash",
                "KLRD",
                "MBR Eraser",
                "Mimikatz",
                "Nadrac",
                "Odinaff",
                "POWERPIPE",
                "POWERSOURCE",
                "PsExec",
                "SQLRAT",
                "Sekur",
                "Sekur RAT",
                "SocksBot",
                "SoftPerfect Network Scanner",
                "Spy.Agent.ORM",
                "TEXTMATE",
                "TeamViewer",
                "TiniMet",
                "TinyMet",
                "Toshliph",
                "VB Flash",
                "WARPRISM",
                "avemaria",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536179,
    "ts_updated_at": 1743041818,
    "ts_creation_date": 1664713410,
    "ts_modification_date": 1664713410,
    "files": {
        "pdf": "https://archive.orkl.eu/5312cf0e28106942e3412cc9fddf90a4a6d8e10f.pdf",
        "text": "https://archive.orkl.eu/5312cf0e28106942e3412cc9fddf90a4a6d8e10f.txt",
        "img": "https://archive.orkl.eu/5312cf0e28106942e3412cc9fddf90a4a6d8e10f.jpg"
    }
}