{
    "id": "c5eb7f90-3140-42a1-9a4f-63a3091930a1",
    "created_at": "2023-01-12T15:09:02.768617Z",
    "updated_at": "2025-03-27T02:09:30.017011Z",
    "deleted_at": null,
    "sha1_hash": "df6beef5966c632906faef04bcd02f59a7d5cd3a",
    "title": "2021-01-08 - A Golden SAML Journey- SolarWinds Continued",
    "authors": "",
    "file_creation_date": "2022-05-28T05:03:40Z",
    "file_modification_date": "2022-05-28T05:03:40Z",
    "file_size": 762997,
    "plain_text": "# A Golden SAML Journey: SolarWinds Continued\n\n**[splunk.com/en_us/blog/security/a-golden-saml-journey-solarwinds-continued.html](https://www.splunk.com/en_us/blog/security/a-golden-saml-journey-solarwinds-continued.html)**\n\nBy [Marcus LaFerrera January 08, 2021](https://www.splunk.com/en_us/blog/author/mlaferrera.html)\nTL;DR: In this blog post we will review what SAML is, how what is old is\nnew again, and how you can start detecting and mitigating SAML\nattacks. Our focus for detection is intended as scaffolding to get you\nstarted, rather than a solution that will work for everyone and all\n[installations. We won’t spend much time going over Sunburst or](https://www.splunk.com/en_us/blog/security/sunburst-backdoor-detections-in-splunk.html)\n[Supernova, instead, we will focus on some lessons learned and how we](https://www.splunk.com/en_us/blog/security/detecting-supernova-malware-solarwinds-continued.html)\ncan better position ourselves against future attacks.\n\n\nJanuary 8, 2021\n\n\n-----\n\n## What is SAML?\n\n[Security Assertion Markup Language (SAML) is a method for exchanging authentication and](https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language)\nauthorization between trusted parties. It’s essentially an XML schema that allows for federated Single\nSign-On (SSO) to work. At least, this is how it’s most commonly used today. The basic construct is\nwhen a client attempts to authenticate with a service provider, they are redirected to an authentication\nserver. Once authenticated, they are provided a cryptographically signed response that the client then\nprovides back to the service provider. Once received, the response is validated thanks to the magic of\ncryptography. At least, that’s how it’s supposed to work and keep us (and our data) safe.\n\nIf this is confusing, take a look at this flow chart from [Sygnia:](https://www.sygnia.co/golden-saml-advisory)\n\n[(Image credited to Sygnia)](https://www.sygnia.co/golden-saml-advisory)\n\n\n-----\n\nWithout SAML, our system administrators would have to create countless new accounts for each\nservice we all need to do our jobs. That means we’d have to remember multiple usernames and\npasswords for each service (because, you never reuse passwords, right?) and also have to ensure\nthey are periodically updated. It would be an administrative nightmare for system admins and users\nalike. Thankfully, technology has saved the day and allowed us all to rest easy at night.\n\n## A Brief History of Golden SAML\n\nWell, that was nice while it lasted. As with any technology, there are weaknesses that our adversaries\n[will work very hard to find and exploit. Way back in 2017, CyberArk published a blog post detailing a](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)\nnew attack technique called Golden SAML. In this blog post, they detailed a technique that allows an\nadversary to generate their own SAML response with the content and authorizations they deem\nnecessary. Now, there are a few gotchas that the adversary needs to figure out first. Namely, they\nneed access to the certificates used to sign the SAML objects. This generally means they need a\nfoothold into the network and privileged access to extract the certificates. Multiple tools are available\nthat will help the adversary extract the needed certificates to include certutil.exe, PowerShell,\nADFSDump, and the ever-popular Mimikatz (don’t worry, we detail how to detect this in a bit). All the\nadversary needs to do is run their preferred tool to extract the certificates and they are well on their\nway to Golden SAML bliss.\n\n[Sygnia has another great visual representation of what a Golden SAML attack would look like.](https://www.sygnia.co/golden-saml-advisory)\n\n\n-----\n\n[(Image credited to Sygnia)](https://www.sygnia.co/golden-saml-advisory)\n\nWhy is this such a big deal? Now that the adversary has access to the extracted certificates, they can\nimpersonate just about any user and privilege in the organization. Not only that, but they can do it from\nanywhere in the world. Additionally, the adversary will be able to bypass Multi-Factor Authentication\n(MFA) protections. Why, you ask? Because the actual authentication server is being removed from the\nprocess entirely. The adversary has forged a valid response from the authentication server, completely\nbypassing MFA.\n\n## Golden SAML and the SolarWinds Cyberattack\n\n\n-----\n\nYou may be wondering what any of this has to do with the SolarWinds attack. Well, the SolarWinds\n[Orion compromise resulted in the first recorded use of Golden SAML in the wild. Nearly three years](https://www.cyberark.com/resources/threat-research-blog/golden-saml-revisited-the-solorigate-connection)\nafter it was first documented as a viable post-exploitation technique, this was the first time anyone had\ndetected it. That either speaks to the effectiveness, flexibility, and stealthiness of this technique, or the\ndetermination and tradecraft of this actor. Probably both.\n\n## What Data Do I Need?\n\nIn our examples, we will be focusing on a Windows environment that leverages Active Directory\nFederation Services (ADFS) for SAML. ADFS security and audit logs will help provide additional\ninsight into potential Golden SAML attacks. More on that in a bit though. Additionally, some queries\nmay need to be customized to your environment, depending on the Splunk TA’s that are installed and\nconfigured. One thing to keep in mind, just because our examples are limited to a Windows\nenvironment and ADFS, doesn’t mean this attack vector is. Golden SAML attacks are possible with\njust about any SAML provider.\n\nBut first, a few caveats. This is not a simple endeavor. Detecting this activity can be extremely difficult\nand require data from multiple sources across an enclave, both internal and external. We will work\ntowards providing examples that can help you detect this type of attack.\n\nNow that we have that out of the way, let’s go over some Windows Events that we’ll need to find this\nactivity.\n\n### Windows Event Codes\n\nIn order to detect SAML attacks against Microsoft infrastructure, you will need (not surprisingly)\nMicrosoft logs. Now we are going to post some links/ideas below on how to enable and collect the\nevents you need to detect Golden SAML excitement. Think of them as “Splunkspiration”. It may not\nwork for you out of the box, but it should get you along the right path. Depending on the detection\nmethodology, there are several Windows Events that need to be collected for detection to be feasible.\nKeep in mind that you’ll probably want some adult supervision (SysAdmin) around before making any\nsystem changes. YMMV and there are some requirements (like Windows 2016 or later and sysmon\ninstalled) to actually be able to get them!\n\nOh, and since this is a Splunk blog, we’ll assume you’re using the Splunk Universal Forwarder to\n[ingest Windows events into Splunk.](https://docs.splunk.com/Documentation/Splunk/8.1.1/Data/MonitorWindowseventlogdata)\n\n### ADFS Event IDs\n\nThese are perhaps the most important Windows Events to collect, and unfortunately, several are not\n[enabled by default. You can find additional information on enabling these events from this blog post](https://dirteam.com/sander/2019/08/15/howto-enable-auditing-and-logging-for-ad-fs-servers-and-the-ad-fs-farm/)\n[and PowerShell Gallery, and documentation for them here and](https://www.powershellgallery.com/packages/ADFSToolbox/1.0.2/Content/eventsModule%5CAdfsEventsModule.psm1) [here.](https://social.technet.microsoft.com/wiki/contents/articles/14250.certificate-services-lifecycle-notifications.aspx)\n\n[1200 (AD FS-Admin): The Federation Service validated a new credential](https://adfshelp.microsoft.com/AdfsEventViewer/GetAdfsEventList)\n[1202 (AD FS-Admin): The Federation Service issued a valid token](https://adfshelp.microsoft.com/AdfsEventViewer/GetAdfsEventList)\n[307 (AD FS-Admin): The Federation Service configuration was changed](https://adfshelp.microsoft.com/AdfsEventViewer/GetAdfsEventList)\n[510 (AD FS-Admin): Additional information](https://adfshelp.microsoft.com/AdfsEventViewer/GetAdfsEventList)\n[1007 (Microsoft-Windows-CertificateServicesClient-Lifecycle-System): Certificate Exported](https://social.technet.microsoft.com/wiki/contents/articles/14250.certificate-services-lifecycle-notifications.aspx)\n\n\n-----\n\nNow, we don t by default collect the event logs that these show up in, so we need to add them to a\nSplunk TA configuration — for example, you could add them to the inputs.conf in the Splunk Add-on\nfor Windows. First, add a stanza to enable the proper Certificate Services log (this one only brings in\n1007 — remove the whitelist directive if you want the other Certificate Services goodness):\n```\n[WinEventLog://CertificateServicesClient-Lifecycle-System/Operational]\ndisabled = 0\nstart_from = oldest\ncurrent_only = 0\ncheckpointInterval = 5\nrenderXml=true\nwhitelist = $XmlRegex=’(?:1007).+’\n\n```\nAnd just in case you thought that was the only tweak, think again. Active Directory Federation Services\nhas its own log for events. So we need to add another stanza to inputs.conf (on our forwarder):\n```\n[WinEventLog://AD FS/Admin]\ndisabled = 0\nstart_from = oldest\ncurrent_only = 0\ncheckpointInterval = 5\nrenderXml=true\n\n```\nBoth of these inputs.conf examples were tested on a Windows 2019 Server.\n\n### Domain Controller Event IDs\n\nTo gather the needed events from the Domain Controller(s), we will have to enable them via the Local\nSecurity Policy snap-in, or via Group Policy. More information on the settings can be found in\n[Microsoft’s documentation.](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-kerberos-service-ticket-operations)\n\n[4769 (Security): A Kerberos service ticket was requested](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4769)\n\n### Endpoint Event IDs\n\nAll of the below Event IDs will help identify command line execution or powershell for certification\nextraction. Need help getting the PowerShell events into Splunk? We’ve [got you covered there (the](https://docs.splunk.com/Documentation/UBA/5.0.4/GetDataIn/AddPowerShell)\ndocumentation is from UBA, but don’t worry it works for any logging of PowerShell.)\n\n[4688 (Security) (and make sure you enable process arguments.)](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688)\n[4103 (PowerShell) (slide 79ish, here)](https://conf.splunk.com/files/2019/slides/SEC2007.pdf)\n4104 (PowerShell) (see above)\n[18 (Sysmon)](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon#event-id-18-pipeevent-pipe-connected)\n\n## How Can Golden SAML Be Detected?\n\n\n-----\n\nI m glad you asked! We have a few opportunities to detect related activity. Let s take a look at how we\n[can find some in Splunk using the methodology that Sygnia discussed in a recent advisory. Also, keep](https://www.splunk.com/en_us/software/splunk-enterprise.html)\nin mind these are example queries to help you along. Detecting this activity in an enterprise can be\nchallenging, so YMMV with the following queries and they will probably need some massaging to get\nworking correctly in your environment. Note that they all assume you are using XML-formatted\nWindows logs (but can be adjusted for Classic format.)\n\n**1. Search for certificate exports in ADFS event logs**\nIn order for this attack to be successful, the adversary must export the appropriate certificates from an\nADFS server. This should be fairly rare as there are few reasons to export certificates legitimately. We\ncan search for this activity in the Windows Event Logs for the ADFS server for the Event ID 1007.\n```\nsourcetype=xmlwineventlog \nsource=\"xmlwineventlog:CertificateServicesClient-Lifecycle-System/Operational\" \nEventCode=\"1007\"\n\n```\nAdditionally, we can search for indications that ADFS certificates were exported from the commandline or PowerShell. These commands can be executed from anywhere, to include servers or clients.\nSo be sure your queries aren’t limited to just the ADFS server.\n\nFirst, let’s look for certificate exports via PowerShell\n```\nindex=main sourcetype=xmlwineventlog \nsource=\"xmlwineventlog:Microsoft-Windows-PowerShell/Operational\" \nEventCode IN (4104, 4103) ScriptBlockText IN \n(\"*Export-PfxCertificate*\", \"*certutil -exportPFX*\" )\n\n```\nWe can also look for any indication by the use of certutil.exe\n```\nindex=main sourcetype=xmlwineventlog \nsource=\"xmlwineventlog:Security\" EventCode=4688 \nCommandLine=\"*certutil.exe -exportPFX*\"\n\n```\nLast, let’s look for the methods used by Mimikatz and ADFSDump. Please note that this pipe is\npopular, so we will want to see which process (images) are not commonly used and dig into them\nfurther.\n```\nindex=main sourcetype=\"xmlwineventlog:microsoft-windows-sysmon/operational\" \nEventCode=18 PipeName=\"\\microsoft##wid\\tsql\\query\" \n| stats count by Image \n| sort count\n\n```\n**2. Identify abnormal authentication events**\n**Note: This technique will only work on Windows Server 2016 or greater. Event IDs 1200 and 1202 did**\nnot exist in prior versions of Windows.\n\nValid SAML authentication events will generate multiple security events on the ADFS and DC servers,\nas well as the service we are authenticating to. We will look for all three of the following Event IDs on\nour ADFS and DC in the Windows Security Events logs.\n\n\n-----\n\n1200 - The Federation Service issued a valid token\n1202 - The Federation Service validated a new credential\n4769 - A Kerberos service ticket was requested\n\nWe will then look to correlate these events with authentication events from the service the user\nattempted to authenticate to (the service provider). In this use case, we will check for authentication\nattempts to Azure AD Sign-in logs.\n\nGolden SAML attacks will lack ADFS (and most likely DC) authentication logs, since the adversary is\nconveniently forging the SAML response, effectively removing them from the authentication process.\nWe should however still see a “successful” authentication from the service provider since they did\nreceive a signed SAML response, even though it was forged by the adversary.\n```\nsourcetype=xmlwineventlog source=\"xmlwineventlog:Security\" \nEventCode IN (1200, 1202, 4769) \n`comment(\"Look for these three event codes in Windows Security Event Logs\")`\n  [ search sourcetype=ms:aad:signin status.errorCode=0\n  | eval Account_Name=mvindex(split(userPrincipalName,\"@\"),0) \n`comment(\"Drop the @domain part from the userPrincipalName\")`\n  | fields Account_Name ] \n`comment(\"Build a list of account names from log in attempts through Azure AD to correlate\nagainst Windows Security Event Logs\")`\n| eval Account_Name=mvindex(Account_Name,-1) \n`comment(\"Only use the last Account_Name value from the Windows Event Log, which should filter\nout situations where Account_Name is - or a host value\")`\n| eval Account_Name=mvindex(split(Account_Name,\"@\"),0) \n`comment(\"Drop the @domain part from the Account_Name\")`\n| transaction dest Account_Name maxspan=2s maxevents=3 \n`comment(\"Create a single event with the same dest and Account_Name that occur within 2\nseconds and limited to three events\")`\n| eval mcount=mvcount(EventCode) \n`comment(\"Count the number of unique event codes for each account name\")`\n| where mcount<3 \n`comment(\"Look for events where there is an absence of all three event codes\")`\n| table _time Account_Name EventCode\n\n```\n**3. Monitor for ADFS Trust Modifications**\nRather than extract the required certificates from a trusted ADFS server, the adversary may prefer to\nadd a new trusted ADFS server that they control. We will look for Event ID 307 (The Federation\nService configuration was changed) and correlate with Event ID 510 with the same instance id.\nConfiguration changes for federations don’t frequently occur in many organizations so use this as a\nstarting point and adjust as you see fit.\n```\nsourcetype=xmlwineventlog source=\"xmlwineventlog:AD FS/Admin\" \nEventCode IN (307, 510)\n\n```\n\n-----\n\n## Mitigation Recommendations\n\nAs with any technology, following best practice guides and recommendations are always the best path\nforward. If you are using Active Directory Federated Services (ADFS), Microsoft provides an excellent\nresource for securing it. Considering how critical ADFS is to many organizations, implementing as\nmany security measures as possible is always highly recommended, perhaps none more so than\nleveraging a Hardware Security Module (HSM) for generating and storing certificates. HSM has the\nadded benefit of securely storing your keys, as well as all cryptographic functions, on a physical\ndevice. Why is this so important? It negates the ability for an adversary to extract that ever-important\nprivate key, effectively mitigating (or at least raising the bar and cost of) the adversary’s ability to\nconduct a Golden SAML attack.\n\n## Conclusion\n\nToday we went over what SAML is, how a Golden SAML attack works, and some example detection\nmethodologies as well as pertinent data sources. We also briefly went over high-level\nrecommendations to help mitigate this type of attack in the future. All of this content is meant to help\nyou forge a path forward and improve your overall security posture. This won’t be the last time we see\nan adversary leveraging Golden SAML to ensure persistence in a victims network. If anything, the\nprominence of this attack has almost certainly highlighted the effectiveness of this technique which\nmay result in more adversaries bringing it into their toolbox.\n\n**For more information on this and other content related to Solarwinds, check out our**\n**[SolarWinds Cyberattack response site.](https://www.splunk.com/en_us/cyber-security/solarwinds-cyberattack-response.html)**\n\n[I’d also like to make a special mention and thank John Stoner,](https://www.splunk.com/en_us/blog/author/jstoner.html) [Lily Lee,](https://www.wicyssiliconvalley.org/Wonder-Women-in-Cybersecurity/Lily-Lee) [James Brodsky, and](https://www.splunk.com/en_us/blog/author/jbrodsky.html) Ryan\nKovar here at Splunk. They were instrumental in pulling this blog post together, creating the queries,\nand ensuring logic prevailed.\n\n\n-----\n\nPosted by\n\n**[Marcus LaFerrera](https://www.splunk.com/en_us/blog/author/mlaferrera.html)**\n\nUS | JP | Pentagon | DARPA | Splunk\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-01-08 - A Golden SAML Journey- SolarWinds Continued.pdf"
    ],
    "report_names": [
        "2021-01-08 - A Golden SAML Journey- SolarWinds Continued.pdf"
    ],
    "threat_actors": [
        {
            "id": "aa73cd6a-868c-4ae4-a5b2-7cb2c5ad1e9d",
            "created_at": "2022-10-25T16:07:24.139848Z",
            "updated_at": "2025-03-27T02:02:10.120505Z",
            "deleted_at": null,
            "main_name": "Safe",
            "aliases": [],
            "source_name": "ETDA:Safe",
            "tools": [
                "DebugView",
                "LZ77",
                "OpenDoc",
                "SafeDisk",
                "TypeConfig",
                "UPXShell",
                "UsbDoc",
                "UsbExe"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536142,
    "ts_updated_at": 1743041370,
    "ts_creation_date": 1653714220,
    "ts_modification_date": 1653714220,
    "files": {
        "pdf": "https://archive.orkl.eu/df6beef5966c632906faef04bcd02f59a7d5cd3a.pdf",
        "text": "https://archive.orkl.eu/df6beef5966c632906faef04bcd02f59a7d5cd3a.txt",
        "img": "https://archive.orkl.eu/df6beef5966c632906faef04bcd02f59a7d5cd3a.jpg"
    }
}