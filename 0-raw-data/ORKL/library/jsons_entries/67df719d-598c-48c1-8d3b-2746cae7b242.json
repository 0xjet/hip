{
    "id": "67df719d-598c-48c1-8d3b-2746cae7b242",
    "created_at": "2022-10-25T16:48:18.26267Z",
    "updated_at": "2025-03-27T02:05:22.207663Z",
    "deleted_at": null,
    "sha1_hash": "0ad6206e04c47801fb86b4a530d7d09dd4a391c1",
    "title": "Investigating PowerShell Attacks",
    "authors": "",
    "file_creation_date": "2014-07-19T10:23:50Z",
    "file_modification_date": "2014-07-19T18:04:00Z",
    "file_size": 1908038,
    "plain_text": "# Investigating PowerShell Attacks\n\n#### Defcon 2014 (Pre-Conference Draft)\n\n\n-----\n\n## Background Case Study\n\n\n###### Attacker Client\n\n### � Fortune 100 organization � Compromised for > 3 years\n\n#### � Active Directory � Authenticated access to corporate VPN\n\n\n###### WinRM, SMB, NetBIOS Victim workstations, servers\n\n### � Command-and-control via\n\n#### � Scheduled tasks � Local execution of PowerShell scripts � PowerShell Remoting\n\n\n**Victim**\n\n###### SMB,\n\n**VPN**\n\n\n###### WinRM, SMB, NetBIOS\n\n\n-----\n\n## Why PowerShell?\n\n\n### It can do almost anything…\n\n###### Execute commands Download files from the internet\n\n Reflectively load / inject code Interface with Win32 API\n\n Enumerate files Interact with the registry\n\n Interact with services Examine processes\n\n Retrieve event logs Access .NET framework\n\n\n###### Download files from the internet\n\n\n###### Interface with Win32 API\n\n\n###### Reflectively load / inject code\n\n\n###### Interact with services\n\n\n###### Execute commands\n\n\n###### Interface with Win32 API\n\n\n###### Interact with the registry\n\n\n###### Retrieve event logs\n\n\n###### Execute commands\n\n\n###### Retrieve event logs\n\n\n-----\n\n## PowerShell Attack Tools\n\n\n#### � PowerSploit\n\n##### � Reconnaissance � Code execution � DLL injection � Credential harvesting � Reverse engineering\n#### � Nishang\n\n\n#### � Posh-SecMod � Veil-PowerView � Metasploit � More to come…\n\n\n-----\n\n-----\n\n## Investigation Methodology\n\n\n###### WinRM\n\n\n###### WinRM\n\n\n###### evil.ps1\n\n\n###### Local PowerShell script\n\n\n###### WinRM\n\n\n###### PowerShell Remoting\n\n Event Logs\n\n Sources of Evidence\n\n\n###### backdoor.ps1\n\n\n###### backdoor.ps1\n\n\n###### Persistent PowerShell\n\n\n###### Network\n Registry File System Event Logs Memory Traffic\n\n\n###### evil.ps1\n\n\n-----\n\n## Attacker Assumptions\n\n\n### � Has admin (local or domain) on target system � Has network access to needed ports on target system � Can use other remote command execution methods to:\n\n#### � Enable execution of unsigned PS scripts � Enable PS remoting\n\n\n-----\n\n|Version Reference|Col2|Col3|Col4|\n|---|---|---|---|\n||2.0|3.0|4.0|\n||Default (SP1) Default (R2 SP1)|Requires WMF 3.0 Update Requires WMF 3.0 Update Default|Requires WMF 4.0 Update Requires WMF 4.0 Update Requires WMF 4.0 Update Default|\n\n\n## Version Reference\n\n\n###### 2.0\n\n\n-----\n\n## Memory Analysis\n\n\n-----\n\n## Memory Analysis\n\n\n### � Scenario: Attacker interacts with target host through PowerShell remoting � What’s left in memory on the accessed system? � How can you find it? � How long does it persist?\n\n\n-----\n\n###### svchost.exe (DcomLaunch)\n\n wsmprovhost.exe\n\n evil.exe\n\n wsmprovhost.exe\n\n Get-ChildItem C:\\ svchost.exe (WinRM)\n\n Kernel\n\n\nInvoke-Command\n{c:\\evil.exe}\n\n\nInvoke-Mimikatz.ps1\n\n\n###### Remote Host\n\n\n## WinRM Process Hierarchy\n\n\n-----\n\n###### svchost.exe (DcomLaunch)\n\n Cmd history\n wsmprovhost.exe\n\n evil.exe\n\n Cmd history\n wsmprovhost.exe\n\n Get-ChildItem C:\\ svchost.exe (WinRM)\n\n Kernel\n\n\n## Remnants in Memory\n\n\n###### evil.exe\n\n\n-----\n\n## Example: In-Memory Remnants\n\n\n###### SOAP in WinRM service memory, after interactive PsSession with command:\n\n echo teststring_pssession > c:\\testoutput_possession.txt\n\n\n-----\n\n## Example: In-Memory Remnants\n\n\n###### WinRM service memory - Invoke-Mimikatz.ps1 executed remotely on target host\n\n\n-----\n\n## What to Look For?\n\n\n### � XML / SOAP strings\n###### /wsman.xsd <rsp:Command> <rsp:CommandLine> <rsp:Arguments> <S N=\"Cmd“>\n### � Known attacker filenames � View context around hits � Yes, this is painful\n\n\n###### <rsp:CommandResponse><rsp:CommandId>\"\"xmlns:r sp=\"http://schemas.microsoft.com/wbem/wsman/1 /windows/shell\"\"\"C80927B1-C741-4E99-9F97- CBA80F23E595</a:MessageID><w:Locale xml:lang=\"en-US\" s:mustUnderstand=\"false\" /><p:DataLocale xml:lang=\"en-US\" s:mustUnderstand=\"false\" /><p:SessionId\"/w:OperationTimeout></s:Header ><s:Body><rsp:CommandLine xmlns:rsp=\"http://schemas.microsoft.com/wbem/ wsman/1/windows/shell\" CommandId=\"9A153F8A- AA3C-4664-8600- AC186539F107\"><rsp:Command>prompt\"\"/rsp:Comma nd><rsp:Arguments>AAAAAAAAAFkAAAAAAAAAAAMAAAa jAgAAAAYQAgC2Yc+EDBrbTLq08PrufN+rij8VmjyqZEaG AKwYZTnxB++7vzxPYmogUmVmSWQ9IjAiPjxNUz48T2JqI E49IlBvd2VyU2hlbGwiIFJlZklkPSIxIj48TVM+PE9iai BOPSJDbWRzIiBSZWZJZD0iMiI+PFROIFJlZklkPSIwIj4 8VD5TeXN0ZW0uQ29sbG . . .\n\n\n-----\n\n## How Long Will Evidence Remain?\n\n\n\n###### • Best source of intact evidence wsmprovhost.exe\n • Only lasts until PS session exits\n\n • Fragments of evidence\n svchost.exe for\n\n • Retention depends on # of remoting sessions\n WinRM\n\n • May last until reboot\n\n • Fragments of evidence Kernel pool\n • Brief lifespan, depends on system utilization\n\n • Fragments of evidence\n Pagefile • Brief lifespan, depends on system utilization\n\n\n\n###### • Fragments of evidence\n • Brief lifespan, depends on system utilization\n • May last beyond reboot\n\n\n\n###### • Best source of intact evidence\n • Only lasts until PS session exits\n\n\n-----\n\n## Memory Analysis Summary\n\n\n### � Timing is everything � Challenging to recover evidence � Many variables\n\n#### � System uptime � Memory utilization � Volume of WinRM activity\n\n\n-----\n\n## Event Logs\n\n\n-----\n\n## Event Logs\n\n\n### � Scenario: Attacker interacts with target host through\n\n#### � Local PowerShell execution � PowerShell remoting\n### � Which event logs capture activity? � Level of logging detail? � Differences between PowerShell 2.0 and 3.0?\n\n\n-----\n\n## PowerShell Event Logs\n\n\n### � Application Logs\n\n#### � Windows PowerShell.evtx � Microsoft-Windows- PowerShell/Operational.evtx � Microsoft-Windows- WinRM/Operational.evtx\n### � Analytic Logs\n\n#### � Microsoft-Windows- PowerShell/Analytic.etl � Microsoft-Windows- WinRM/Analytic.etl\n\n\n-----\n\n## PowerShell 2.0 Event Logging\n\n\n### � What you do get\n\n#### � Start & stop times of activity � Loaded providers � User account context\n### � What you don’t get\n\n#### � Detailed history of executed commands � Console input / output\n### � Analytic logs help (somewhat)\n\n#### � Disabled by default � High volume of events � Encoding & fragmentation\n\n\n-----\n\n## Local PowerShell Execution\n\n\n###### EID 400: Engine state is changed from None to Available.\n\n\n###### PowerShell\n\n\n###### EID 403: Engine state is changed from Available to Stopped.\n\n\n###### Start & stop times of PowerShell session\n\n\n-----\n\n## Local PowerShell Execution\n\n\n###### EID 40961: PowerShell console is starting up\n\n\n###### Start time of PowerShell session\n\n\n###### PowerShell Operational**\n\n\n###### EID 4100: Error Message = File C:\\temp\\test.ps1 cannot be loaded because running scripts is disabled on this system\n\n\n###### Error provides path to PowerShell script\n\n\n###### ** Events exclusive to PowerShell 3.0 or greater\n\n\n###### Error provides path to PowerShell script\n\n\n-----\n\n## Local PowerShell Execution\n\n\n###### EID 7937: Command test.ps1 is Started.\n\n\n###### EID 7937: Command test.ps1 is Started.\n\n\n###### PowerShell Analytic**\n\n\n###### What executed? (arguments not logged)\n\n\n###### EID 7937: Command dropper.exe is Started\n\n\n###### EID 7937: Command dropper.exe is Started\n\n\n###### ** Events exclusive to PowerShell 3.0 or greater\n\n\n###### EID 7937: Command Write-Output is Started.\n\n\n-----\n\n## Remoting (Accessed Host)\n\n\n###### Start time of PowerShell session\n\n\n###### Start time of PowerShell session\n\n\n###### PowerShell\n\n\n###### EID 400: Engine state is changed from None to Available.\n\n\n###### Indicates use of PowerShell remoting\n\n\n-----\n\n## Remoting (Accessed Host)\n\n\n###### EID 169: User CORP\\MattH authenticated successfully using NTLM\n\n\n###### EID 169: User CORP\\MattH authenticated successfully using NTLM\n\n\n###### Who connected via remoting\n\n\n###### Who connected via remoting\n\n\n###### WinRM Operational\n\n\n###### EID 134: Sending response for operation DeleteShell\n\n\n###### EID 134: Sending response for operation DeleteShell\n\n\n###### Timeframe of remoting activity\n\n\n-----\n\n## Remoting (Accessed Host)\n\n\n###### EID 32850: Request 7873936. Creating a server remote session. UserName: CORP\\JohnD\n\n\n###### Who connected via remoting\n\n\n###### Who connected via remoting\n\n\n###### PowerShell Analytic\n\n\n###### EID 32867: Received remoting fragment\n […] Payload Length: 752 Payload Data: 0x020000000200010064D64FA51E7C784 18483DC[…] \n\n\n###### EID 32867: Received remoting fragment\n […] Payload Length: 752 Payload Data: 0x020000000200010064D64FA51E7C784 18483DC[…] \n\n\n###### Encoded contents of remoting I/O\n\n\n###### Encoded contents of remoting I/O\n\n\n-----\n\n###### Invoke-Command {Get-ChildItem C:\\}\n\n\n-----\n\n###### Invoke-Command {Get-ChildItem C:\\}\n\n\n-----\n\n###### Invoke-Command {Get-ChildItem C:\\}\n\n\n-----\n\n## Other Logging Solutions for PS 2.0\n\n\n### � Set global profile to log console command activity\n\n %windir%\\system32\\WindowsPowerShell\\v1.0\\ profile.ps1\n\n � Use Start-Transcript cmdlet\n\n#### � Records all session input / output to text file\n### � Overwrite default prompt function\n\n#### � Intercept commands and add to event log\n### � Only works for local PowerShell execution � Can run PowerShell without loading profiles\n\n\n-----\n\n## Other Logging Solutions for PS 2.0\n\n\n-----\n\n## PowerShell 3.0: Module Logging\n\n\n###### Solves (almost) all our logging problems!\n\n\n###### Computer Configuration →  Administrative Templates →  Windows Components →  Windows PowerShell → Turn on Module Logging\n\n\n-----\n\n## Module Logging Examples\n\n\n###### Get-ChildItem c:\\temp -Filter *.txt -Recurse | Select-String password\n\n\n###### Microsoft-Windows-PowerShell/Operational (EID 4103)\n\n ParameterBinding(Get-ChildItem): name=\"Filter\"; value=\"*.txt\" ParameterBinding(Get-ChildItem): name=\"Recurse\"; value=\"True\" ParameterBinding(Get-ChildItem): name=\"Path\"; value=\"c:\\temp\" ParameterBinding(Select-String): name=\"Pattern\"; value=\"password\" ParameterBinding(Select-String): name=\"InputObject\";\n\n##### ...\n###### Command Name = Get-ChildItem\n\n**Logged upon command execution**\n\n###### ParameterBinding(Out-Default): name=\"InputObject\"; value=\"C:\\temp\\creds.txt:2:password: secret\" ParameterBinding(Out-Default): name=\"InputObject\"; value=\"C:\\temp\\creds.txt:5:password: test\"\n\n**L** **d** **d** **t** **t**\n\n\n###### ParameterBinding(Get-ChildItem): name=\"Filter\"; value=\"*.txt\" ParameterBinding(Get-ChildItem): name=\"Recurse\"; value=\"True\" ParameterBinding(Get-ChildItem): name=\"Path\"; value=\"c:\\temp\" ParameterBinding(Select-String): name=\"Pattern\"; value=\"password\" ParameterBinding(Select-String): name=\"InputObject\"; value=\"creds.txt\"\n##### ...\n###### Command Name = Get-ChildItem User = CORP\\MHastings\n\n\n###### ParameterBinding(Out-Default): name=\"InputObject\"; value=\"C:\\temp\\creds.txt:2:password: secret\" ParameterBinding(Out-Default): name=\"InputObject\"; value=\"C:\\temp\\creds.txt:5:password: test\"\n\n\n###### Get-ChildItem c:\\temp -Filter *.txt -Recurse | Select-String password\n\n\n-----\n\n## Module Logging Examples\n\n\n###### Invoke-Mimikatz.ps1 via remoting\n\n\n###### Detailed “per- command”  logging\n\n\n-----\n\n###### Invoke-Mimikatz.ps1 via remoting\n\n\n-----\n\n## Persistence\n\n\n-----\n\n## PowerShell Persistence\n\n\n### � Scenario: Attacker configures system to load malicious PS upon startup / logon � Why persist?\n\n#### � Backdoors � Keyloggers\n### � What are common PS persistence mechanisms? � How to find them?\n\n\n-----\n\n## Common Techniques\n\n\n### � Registry “autorun” keys � Scheduled tasks � User “startup” folders � Easy to detect\n\n#### � Autorun review � Registry timeline analysis � File system timeline analysis � Event log review\n\n\n###### At1.job\n At1.job\n\n**At1.job**\n\n\n-----\n\n## Persistence via WMI\n\n\n###### Use WMI to automatically launch PowerShell upon a common event\n\n\n###### Namespace: “root\\subscription”\n\n EventFilter Filter name, event query\n\n CommandLineEventConsumer Consumer name, path to powershell.exe\n\n FilterToConsumerBinding Filter name, consumer name\n\n\n###### Set-WmiInstance\n\n\n-----\n\n## Event Filters\n\n\n### � Query that causes the consumer to trigger\n\n###### SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 240 AND TargetInstance.SystemUpTime < 325\n\n Run within minutes of startup\n\n SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_LocalTime' AND TargetInstance.Hour = 12 AND TargetInstance.Minute = 00 GROUP WITHIN 60\n\n Run at 12:00\n\n\n###### SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 240 AND TargetInstance.SystemUpTime < 325\n\n\n###### SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_LocalTime' AND TargetInstance.Hour = 12 AND TargetInstance.Minute = 00 GROUP WITHIN 60\n\n\n-----\n\n## Event Consumers\n\n\n### � Launch “PowerShell.exe” when triggered by filter � Where does the evil PS code load from?\n\n###### sal a New-Object;iex(a IO.StreamReader((a IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64 String('7L0HYBxJliUmL23Ke39K9UrX4HShCIBgEyTYkEAQ7MGIzeaS7B1pRyMpqyq BymVWZV1mFkDM7Z28995777333nvvvfe6O51OJ/ff/z9cZmQBbPbOStrJniGAqsgfP3 58Hz8ivlsXbb795bpdrdv0o2/nZVml363qcvbR/xMAAP//'),[IO.Compression.Co mpressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()\n\n##### Stored in user or system-wide “profile.ps1”\n\n###### Set-WmiInstance -Namespace \"root\\subscription\" -Class 'CommandLineEventConsumer' -Arguments @{ name='TotallyLegitWMI';CommandLineTemplate=\"$($Env:SystemRoot)\\Syst em32\\WindowsPowerShell\\v1.0\\powershell.exe - NonInteractive\";RunInteractively='false'}\n\n##### Added to Consumer Command-Line Arguments (length limit, code must be base64’d)\n\n\n###### sal a New-Object;iex(a IO.StreamReader((a IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64 String('7L0HYBxJliUmL23Ke39K9UrX4HShCIBgEyTYkEAQ7MGIzeaS7B1pRyMpqyq BymVWZV1mFkDM7Z28995777333nvvvfe6O51OJ/ff/z9cZmQBbPbOStrJniGAqsgfP3 58Hz8ivlsXbb795bpdrdv0o2/nZVml363qcvbR/xMAAP//'),[IO.Compression.Co mpressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()\n\n\n###### Set-WmiInstance -Namespace \"root\\subscription\" -Class 'CommandLineEventConsumer' -Arguments @{ name='TotallyLegitWMI';CommandLineTemplate=\"$($Env:SystemRoot)\\Syst em32\\WindowsPowerShell\\v1.0\\powershell.exe - NonInteractive\";RunInteractively='false'}\n\n\n-----\n\n## Enumerating WMI Objects with PowerShell\n\n\n### � Get-WMIObject –Namespace root\\Subscription -Class __EventFilter � Get-WMIObject -Namespace root\\Subscription -Class __EventConsumer � Get-WMIObject -Namespace root\\Subscription -Class __FilterToConsumerBinding\n\n\n-----\n\n## PS WMI Evidence: File System\n\n\n**sal a New-Object;iex(a IO.StreamReader((a**\n**IO.Compression.DeflateStream([IO.MemoryStr**\n**eam][Convert]::FromBase64String('7L0HYBxJl**\n**iUmL23Ke39K9UrX4HShCIBgEyTYkEA...**\n\n\n-----\n\n|Key|Col2|Value|Col4|Data|\n|---|---|---|---|---|\n|HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\WBEM\\ ESS\\//./root/CIMV2\\Win32ClockProvider||[N/A]||[N/A]|\n|Key Last Modified|||||\n|06/04/14 01:30:03 UTC|||||\n\n\n## PS WMI Evidence: Registry\n\n\n###### Created only when setting a time-based WMI filter (many other types of triggers may be used)\n\n\n-----\n\n## PS WMI Evidence: Other Sources\n\n\n### � SysInternals AutoRuns (v12) � Memory: WMI filter & consumer names\n\n#### � svchost.exe (WinMgmt service) � WmiPrvse.exe\n### � Event logs: WMI Trace\n\n#### � Too noisy\n\n\n-----\n\n## Conclusions\n\n\n-----\n\n## Other Sources of Evidence\n\n\n### � Refer to whitepaper � Prefetch file for “PowerShell.exe”\n\n#### � Local execution only � Scripts in Accessed File list\n### � Registry\n\n#### � PowerShell “ExecutionPolicy” setting\n### � Network traffic analysis (WinRM)\n\n#### � Port 5985 (HTTP) / port 5986 (HTTPS) � Payload always encrypted � Identify anomalous netflows\n\n\n-----\n\n## Lessons Learned\n\n\n### � Upgrade to PS 3.0 and enable Module Logging if possible � Baseline legitimate usage in environment\n\n#### � ExecutionPolicy setting � Remoting enabled � Script naming conventions, paths � Which users � Source systems � Destination systems\n### � Recognize artifacts of anomalous usage\n\n\n-----\n\n## Acknowledgements\n\n\n### � Matt Graeber � Joseph Bialek � Chris Campbell � Lee Holmes � David Wyatt\n\n\n### � David Kennedy � Josh Kelley � All the other PowerShell authors, hackers, and researchers!\n\n\n-----\n\n## Questions?\n\n\n### ryan.kazanciyan@mandiant.com\n @ryankaz42\n\n matt.hastings@mandiant.com\n @HastingsVT\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.defcon.org/images/defcon-22/dc-22-presentations/Kazanciyan-Hastings/DEFCON-22-Ryan-Kazanciyan-Matt-Hastings-Investigating-Powershell-Attacks.pdf"
    ],
    "report_names": [
        "DEFCON-22-Ryan-Kazanciyan-Matt-Hastings-Investigating-Powershell-Attacks.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1666716498,
    "ts_updated_at": 1743041122,
    "ts_creation_date": 1405765430,
    "ts_modification_date": 1405793040,
    "files": {
        "pdf": "https://archive.orkl.eu/0ad6206e04c47801fb86b4a530d7d09dd4a391c1.pdf",
        "text": "https://archive.orkl.eu/0ad6206e04c47801fb86b4a530d7d09dd4a391c1.txt",
        "img": "https://archive.orkl.eu/0ad6206e04c47801fb86b4a530d7d09dd4a391c1.jpg"
    }
}