{
    "id": "bd033334-b118-48bd-9fee-b9c603e7f961",
    "created_at": "2022-10-25T16:48:16.445143Z",
    "updated_at": "2025-03-27T02:16:20.785666Z",
    "deleted_at": null,
    "sha1_hash": "bf1e6d61f88eae47312b6fe8208fa32a7f12caea",
    "title": "",
    "authors": "",
    "file_creation_date": "2020-06-18T03:46:15Z",
    "file_modification_date": "2020-06-18T03:46:15Z",
    "file_size": 692675,
    "plain_text": "# AcidBox: Rare Malware Repurposing Turla Group Exploit Targeted Russian Organizations\n\n**[unit42.paloaltonetworks.com/acidbox-rare-malware](https://unit42.paloaltonetworks.com/acidbox-rare-malware/)**\n\nDominik Reichel, Esmid Idrizovic June 17, 2020\n\n## Executive Summary\n\n[When the news broke in 2014 about a new sophisticated threat actor dubbed the Turla](https://www.gdatasoftware.com/blog/2014/02/23968-uroburos-highly-complex-espionage-software-with-russian-roots)\n[Group, which the Estonian foreign intelligence service believes has Russian origins and](https://www.valisluureamet.ee/pdf/raport-2018-ENG-web.pdf)\noperates on behalf of the FSB, its kernelmode malware also became the first publiclydescribed case that abused a third-party device driver to disable Driver Signature\nEnforcement (DSE). This security mechanism was introduced in Windows Vista to\nprevent unsigned drivers from loading into kernel space. Turla exploited the signed\nVirtualBox driver, VBoxDrv.sys v1.6.2, to deactivate DSE and load its unsigned payload\ndrivers afterward.\n\nThere is some confusion about this exploit, however, as it’s often generally referred to as\n[CVE-2008-3431. The exploit used by Turla actually abuses two vulnerabilities — of which,](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-3431)\nonly one was ever fixed in the aforementioned CVE. The other vulnerability was found by\nTurla and is used in the first version of their exploit, along with CVE-2008-3431. The\n[second version of their exploit, presumably introduced in 2014 of their kernelmode](https://www.kernelmode.info/forum/viewtopic4989.html?f=16&t=3193&start=50#p26173)\nmalware, only uses the unpatched vulnerability, which we discuss in greater detail later.\n\nIn February 2019, Unit 42 found that a yet-to-be-known threat actor — unbeknownst to\nthe infosec community — discovered that the second unpatched vulnerability can not only\nexploit VirtualBox VBoxDrv.sys driver v1.6.2, but also all other versions up to v3.0.0.\nFurthermore, our research shows that this unknown actor exploited VirtualBox driver\nversion 2.2.0 to target at least two different Russian organizations in 2017, which we are\nrevealing for the first time. We anticipate this was done because the driver version 2.2.0\n\n\n-----\n\nwasn’t known to be vulnerable and thus most likely is not on the radar of security\ncompanies being exploited. Since no other victims have been found, we believe this is a\nvery rare malware used in targeted attacks only.\n\nThe actors used a previously unknown malware family that we have dubbed AcidBox due\nto the first part being an anagram of the malware’s driver device name and the second\npart taken from VirtualBox. Because of the malware’s complexity, rarity, and the fact that\nit’s part of a bigger toolset, we believe it was used by an advanced threat actor for targeted\nattacks and it’s likely that this malware is still being used today if the attacker is still\nactive. However, we anticipate that it was rewritten to a certain extent. Based on the\ninformation we have, we don’t believe this unknown threat actor is tied to Turla, except\nfor the used exploit.\n\nPalo Alto Networks customers are protected from this threat. Our threat prevention\nplatform with WildFire identifies this malware as malicious. AutoFocus customers can\ntrack malware activity by using the AcidBox tag. We also created an Adversary Playbook\n[for this attack, which can be found here.](https://pan-unit42.github.io/playbook_viewer/?pb=temp-acidbox)\n\n### The Unknown Threat Actor\n\nIn February 2019, we discovered a sample of AcidBox (SHA256:\neb30a1822bd6f503f8151cb04bfd315a62fa67dbfe1f573e6fcfd74636ecedd5) uploaded to\nVirusTotal, which contained a string known to be used in Turla’s VirtualBox exploit. A\ndeeper analysis of the sample revealed it’s the main worker module as part of a\nsophisticated malware that we couldn’t tie to any known threat actor.\n\nIn collaborating with our colleagues at Dr.Web, we learned that this sample was used in a\ntargeted attack on an unspecified entity in Russia back in 2017. Thankfully, they shared\nthree additional samples of the same malware family. Two of those usermode samples are\nmodules that load the main worker from the Windows registry and one is the kernelmode\npayload driver embedded in the main worker sample. Moreover, we contacted Kaspersky\nsince the company is headquartered in Russia, which found only one additional sample in\ntheir databases that was also the usermode loader version. We also contacted ESET,\nwhich didn’t find any victims infected with this malware, just like in our own case. For\nthis reason, we conclude it’s a very rare malware used in targeted attacks only.\n\nWhat all the samples have in common are the compilation timestamps of May 9, 2017.\nThis date seems legitimate, as the sample found by Kaspersky appeared in June 2017 in\ntheir databases. Therefore, we conclude that the campaign which involved this malware\ntook place in 2017. We couldn’t find any newer samples and thus it’s unknown if AcidBox\nis still in use or has been further developed.\n\nWe compared the specific characteristics of the samples to all publicly-known malware,\n[but couldn’t find any clear overlaps. There are some very loose similarities to Remsec](https://securelist.com/faq-the-projectsauron-apt/75533/)\nmalware attributed to ProjectSauron, like:\n\n\n-----\n\nDWORD size data marker values\nExport function names made of 2/3 words\nMS Visual C/C++ compiler used\nVarious import API functions overlaps\nUse of vulnerable 3rd party driver to load own unsigned driver\nZlib compression used\nSensitive data encrypted in the resource section\n\nHowever, based on these facts alone, it’s not possible to attribute the samples to the\nProjectSauron threat actor. We think it’s more likely this is a yet unknown threat actor.\n\n### The VirtualBox Exploit and Turla’s Versions\n\n[The original vulnerability described in CVE-2008-3431 was found by Core Security in](https://www.coresecurity.com/content/virtualbox-privilege-escalation-vulnerability)\n2008 and affected VBoxDrv.sys less or equal version 1.6.2. It was fixed in version 1.6.4\nand thus couldn’t be exploited anymore.\n\nFigure 1. Vulnerable and patched VirtualBox device dispatch handler routines on the left and\n\nright, respectively\n\nThe vulnerability is located in the dispatch device control routine called\nVBoxDrvNtDeviceControl. On versions prior to 1.6.4, you can call the usermode\nDeviceIoControl API function and send one of the following control codes together with a\nkernel address you want to overwrite as the input/output buffer:\n\nSUP_IOCTL_FAST_DO_RAW_RUN\nSUP_IOCTL_FAST_DO_HM_RUN\nSUP_IOCTL_FAST_DO_NOP\n\nThe kernel address is passed down to the control handler (see Figure 1 left, line 28)\nwithout any check or validation and is filled with the return value of supdrvIOCtlFast (see\nFigure 1 left, line 24). This is where the vulnerability digging from CoreSecurity stops and\nwhere Turla continues. In the original exploit, the return value from supdrvIOCtlFast isn’t\n\n\n-----\n\ncontrolled and thus it will be a random value written to your kernel address. Turla’s\nexploit controls the return value by overwriting the function pointer of supdrvIOCtlFast\nto redirect execution to a small shellcode, which returns the needed value. This was\n[described in great detail in a couple of articles and the complete reverse-engineered](https://www.kernelmode.info/forum/viewtopic7377.html?f=16&t=3193&start=10#p22357)\n[exploit code is also available.](https://github.com/hfiref0x/DSEFix)\n\nThe patched version 1.6.4 (see Figure 1 right) doesn’t use the UserBuffer pointer anymore,\nwhich could be abused by passing a kernel address. Additionally, it checks if the rc\nvariable is equal or bigger than zero — which isn’t needed for the patch, but more like a\nsanity check.\n\nWith this patch, the original vulnerability to overwrite a kernel address was fixed. The\nother vulnerability that lets you control the function pointer of supdrvIOCtlFast remained\nunpatched. Of course, that’s because it wasn’t discovered by Core Security at the time, but\nonly a few years later by the Turla threat actor.\n\nWhile Turla still uses the vulnerable VirtualBox driver v.1.6.2 to date, it only makes use of\n[the unpatched vulnerability. The reason why and how it uses it was described by Lastline,](https://www.lastline.com/labsblog/turla-apt-group-gives-their-kernel-exploit-a-makeover/)\nand also the reverse-engineered exploit code is available in a project named Turla Driver\nLoader.\n\nThe secret is the exact same exploit, with only a small modification — which we won’t\ndisclose here — can be used on all VBoxDrv.sys versions up to 3.0.0. This was also figured\nout by an unknown threat actor. While VirtualBox versions smaller than 4.0 aren’t\navailable on the official website anymore, they can still be found on some software\ndownload sites.\n\nStarting from version 3.0.0, some structures and routines have changed so the exploit\ndoes not work anymore. However, it can’t be ruled out that in later versions it’s still\npossible to exploit the same vulnerability with some more adjustments.\n\nWhat’s also interesting is that not even the Turla authors themself seem to have realized\nthat. They still use the old VBoxDrv.sys v.1.6.2 in their otherwise stealthy exploit. This\ndriver is widely known to be used for malicious or various otherwise dubious purposes,\nfor example, in-game cheats.\n\n### Technical Analysis of AcidBox\n\nThe malware is a complex modular toolkit of which we have only a part of it. In total, we\nhave found four 64-bit usermode DLLs and an unsigned kernelmode driver (SHA256:\n3ef071e0327e7014dd374d96bed023e6c434df6f98cce88a1e7335a667f6749d). Three out\nof the four usermode samples have identical functionality and are loaders for the main\nworker module. They only differ in their file descriptions and the embedded and\n[encrypted registry path. These loaders are created as security support providers (further](https://docs.microsoft.com/en-us/windows/win32/secauthn/custom-security-packages)\nSSP). A SSP is a DLL that exports at least the function SpLsaModeInitialize and usually\nprovides security mechanisms such as authentication between client/server applications.\n[There are a couple of standard SSPs provided in Windows such as Kerberos (kerberos dll)](https://docs.microsoft.com/en-us/windows/win32/secauthn/kerberos-ssp-ap)\n\n\n-----\n\n[or NTLM (msv1_0.dll). You can abuse the SSP interface for malware persistency and also](https://docs.microsoft.com/en-us/windows/win32/secauthn/msv1-0-authentication-package)\nfor injection purposes. In order to maintain persistency, you have to put your SSP DLL\ninto the Windows system directory and add the name of your DLL to a certain registry\nvalue. Upon a system restart, your DLL gets loaded into the Windows lsass.exe process\nand is executed. If you just want your SSP DLL to be injected into lsass.exe, you can call\n[the API function AddSecurityPackage which triggers immediate loading. Of course, you](https://docs.microsoft.com/en-us/windows/win32/api/sspi/nf-sspi-addsecuritypackagea)\nneed at least admin privileges for both of these methods. The first case of a malware\n[abusing the SSP interface was mentioned by Matt Graeber in 2014. Since then, this](http://docplayer.net/20839173-Analysis-of-malicious-security-support-provider-dlls.html)\n[persistence and injection trick has become wider known, but it’s still rarely used in](https://attack.mitre.org/techniques/T1101/)\nmalware.\n\nIn case of the three AcidBox SSP DLLs, they don’t make use of any security related\noperations, but purely abuse this interface for injection purposes and most likely also for\npersistence. The three SSPs have different file names that are similar to the standard\npackages provided in Windows (msv1_0.dll, pku2u.dll, wdigest.dll):\n\nmsv1_1.dll (SHA256:\nb3166c417d49e94f3d9eab9b1e8ab853b58ba59f734f774b5de75ee631a9b66d)\npku.dll (SHA256:\n3ad20ca49a979e5ea4a5e154962e7caff17e4ca4f00bec7f3ab89275fcc8f58c)\nwindigest.dll (SHA256:\n003669761229d3e1db0f5a5b333ef62b3dffcc8e27c821ce9018362e0a2df7e9)\n\nFigure 2. Standard SSP DLLs provided in Windows 7 present in the “Security Packages” value\n\nFor this reason, we conclude the AcidBox SSPs also abuse the interface for persistence.\nHowever, as we don’t have the component which installs the SSP DLLs, we don’t know for\nsure. What we know is that the SSP interface is used for injection into lsass.exe, as they\ncheck at the beginning whether the process path they’re loaded into matches the one\n\n\n-----\n\nwhich is embedded into every sample in the resource section\n(C:\\WINDOWS\\SYSTEM32\\lsass.exe). This process path is contained in the resource\n4097 which we describe later how it is hidden via steganography.\n\nThe purpose of the AcidBox SSP DLLs is to load the main worker module from a registry\nvalue contained in resource 256 of each sample. We don’t know how the main worker\nDLL was stored in the registry, but we believe it was done by the same missing\ncomponent which installed the SSP DLLs. We also assume that the three SSP DLLs are\nfrom three different systems as one of those samples has a different registry key\nembedded. Also, as these modules are the only visible part on a system — with the main\nworker module being loaded remains encrypted in the registry — they likely differ in\nsome way like their chosen file name. The main worker is stored in the registry encrypted\nwithin a data blob that contains various other metadata such as the CRC32 hash of the\ndata blob or magic byte sequences which indicate different types of contained data.\n\nAfter the main worker DLL gets decrypted by a SSP DLL from the registry via simply\nXORing the data with key 0xCA, it gets prepared to be loaded from memory. It does so by\ncreating a thread for the module and uses the exported function UpdateContext of the\nmain worker as its start address. The main worker module then loads the unsigned\nmalware driver via the VirtualBox exploit and waits for commands from one or more\ncomponents that we don’t have. These commands include the loading of additional\npayloads from the registry from kernel space via the driver or the installation of new SSP\nDLLs.\n\nThe main worker has 2 export functions named InitMainStartup and UpdateContext. The\nfollowing strings are present in cleartext:\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n26\n\n\n%s\\%s\n\n%s\\%s{%s}\n\n%s\\[[%s]]\n\n%s.dll\n\n%s%s%s.dll\n\n\\\\.\\PCIXA_CFGDEV\n\nInitEntry\n\nInitExit\n\nThe Magic Word!\n\nntoskrnl.exe\n\nntkrn\n\nntkrp\n\nhal.dll\n\nntoskrnl\n\nntkrnlpa.exe\n\n%s%s%s\n\nGroup\n\nCount\n\nNextInstance\n\nRoot\\LEGACY_NULL\\0000\n\n\nThe following additional strings are stack obfuscated:\n\n\n-----\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n\nSeLoadDriverPrivilege\n\n%s\\%c*.dll\n\nSystem\\CurrentControlSet\\Control\\\n\nNtQueryInformationThread\n\nBFE_Notify_Event_\n\nMicrosoft\\Cryptography\n\nntdll.dll\n\n\\Registry\\Machine\\\n\nSOFTWARE\n\nGlobal\n\n%s\\%s\n\nSecurity Packages\n\nkernel32.dll\n\nSOFTWARE\n\n\\Registry\\Machine\\\n\nMachineGuid\n\nntdll.dll\n\n\nThere are also XOR-encoded DLL and function names, which later get dynamically\nresolved and used:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n\nntdll.RtlGetVersion\n\nntdll.ZwLoadDriver\n\nntdll.ZwUnloadDriver\n\nntdll.ZwQuerySystemInformation\n\nkernel32.DeviceIoControl\n\nkernel32.GetSystemDirectoryA\n\n\n-----\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n26\n\n27\n\n28\n\n29\n\n30\n\n31\n\n32\n\n33\n\n34\n\n\nntdll.RtlAnsiStringToUnicodeString\n\nntdll.ZwClose\n\nntdll.ZwCreateFile\n\nntdll.ZwQueryInformationFile\n\nntdll.ZwReadFile\n\nntdll.ZwWriteFile\n\nkernel32.GetSystemDirectoryA\n\nkernel32.GetSystemDirectoryW\n\nkernel32.BaseThreadInitThunk\n\nkernel32.LZDone\n\nadvapi32.CryptAcquireContextA\n\nadvapi32.CryptGenRandom\n\nadvapi32.CryptReleaseContext\n\nntdll.RtlRbInsertNodeEx\n\nntdll.RtlRbRemoveNode\n\nntdll.RtlAcquireSRWLockExclusive\n\nntdll.RtlReleaseSRWLockExclusive\n\nntdll.RtlEnterCriticalSection\n\nntdll.RtlPcToFileHeader\n\nntdll.RtlGetVersion\n\nntdll.RtlUpcaseUnicodeChar\n\nntdll.RtlAnsiStringToUnicodeString\n\nntdll.LdrLockLoaderLock\n\nntdll.LdrUnlockLoaderLock\n\nntdll.ZwClose\n\nntdll.ZwCreateSection\n\nntdll.ZwMapViewOfSection\n\nntdll.ZwUnmapViewOfSection\n\n\n-----\n\nAll the functionality is contained in the two export functions, while DllMain does not\ncontain any relevant code. What stands out is the extensive use of custom DWORD-size\nstatus codes throughout the code. Decompiled code example with status codes in result\nvariable:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n\n…\n\nif ( !a1 || !a2 || !(_DWORD)v3 )\n\n{\n\nresult = 0xA0032B02;\n\ngoto LABEL_45;\n\n}\n\nif ( strlen(a1) <= 1 )\n\ngoto LABEL_65;\n\nresult = get_kernel32_path(a1, &v43, &v37, &v41);\n\nif ( result )\n\ngoto LABEL_45;\n\nif ( (unsigned int)v3 < 0x1C )\n\n{\n\nLABEL_65:\n\nresult = 0xA0032B02;\n\ngoto LABEL_45;\n\n}\n\npBuffer = allocate_buffer(v13, (unsigned int)v3, 0i64, v11, 0, 1);\n\nbuffer = pBuffer;\n\nif ( !pBuffer )\n\n{\n\nLABEL_9:\n\nresult = 0xA0032B04;\n\ngoto LABEL_45;\n\n}\n\n\n-----\n\n26\n\n27\n\n28\n\n29\n\n30\n\n31\n\n32\n\n\nif ( memcpy_s(pBuffer, v3, a2, v3) )\n\n{\n\nLABEL_11:\n\nresult = 0xA0032B06;\n\ngoto LABEL_45;\n\n}\n\n…\n\n\nThe main worker sample contains five icon resources with valid icons named 16, 256,\n4097, 8193 and 12289. The names indicate different icon resolutions, but the icons only\ndiffer in the encrypted data appended to them which can be considered as a form of\nsteganography. This data is encrypted with a custom algorithm and additionally zlib\ncompressed. The same method is used within the SSP DLLs. A Python script for\ndecryption and decompression can be found in the Appendix. After decryption, the data\nblob has the following structure:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n\nstruct data_blob {\n\nDWORD marker;  // Marker bytes (0x9A65659A)\n\nDWORD crc32;  // CRC32 value of decrypted or zlib uncompressed\n\nbytes\n\nDWORD size;   // Size of decrypted or zlib uncompressed bytes\n\nDWORD option;  // Information if data is encrypted or zlib\n\ncompressed; 0x1 = encrypted, 0x2 = zlib compressed\n\nchar data[];  // Encrypted or zlib compressed data\n\n};\n\n\nThe decrypted data is as follows.\n\nResource 16:\n\n\n1\n\n2\n\n\nSystem\\CurrentControlSet\\Control\\Class\\{4D36E97D-E325-11CE-BFC1-08002B\n\nE10318}\\0003\\DriverData\n\n\nResource 256:\n\n\n-----\n\n1\n\n2\n\n\nSystem\\CurrentControlSet\\Control\\Class\\{4D36E96A-E325-11CE-BFC1-08002B\n\nE10318}\\0000\\DriverData\n\n\nResources 16 and 256 are the Windows registry keys that contain the decryption key for\nthe embedded driver in resource 8193 and additional payloads that are likely going to be\ninjected by the AcidBox driver.\n\nResource 4097:\n\n1 C:\\WINDOWS\\SYSTEM32\\lsass.exe\n\nThis resource contains the path of the process each sample uses to verify it is being loaded\ninto the correct process. Resource 8193 contains the unsigned kernelmode payload driver,\nwhich is also encrypted with RSA. The driver is realized as a kernelmode DLL with two\nexport functions InitEntry and InitExit. It contains the following cleartext strings:\n\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n\nntoskrnl.exe\n\nntkrn\n\nntkrp\n\nhal.dll\n\nntoskrnl\n\nntkrnlpa.exe\n\ncsrss.exe\n\nPsCreateSystemThread\n\n\\Device\\VBoxDrv\n\n\\DosDevices\\PCIXA_CFGDEV\n\n\\Windows\\ApiPort\n\n\\Sessions\\%u\\Windows\\ApiPort\n\n\\Sessions\\xxxxxxxx\\Windows\\ApiPort\n\n\\Device\\PCIXA_CFG\n\n\\DosDevices\\PCIXA_CFGDEV\n\n\n-----\n\nResource 12289 contains the VirtualBox VBoxDrv.sys driver v2.2.0.0 signed by Sun\nMicrosystems, which we previously described is also vulnerable.\n\nFigure 3. Signed vulnerable VBoxDrv.sys driver version 2.2.0.0\n\n### A Little Forensic Tidbit in the PE header\n\nWhile studying the samples, PE header characteristics — an often overseen forensic\nindicator — caught our attention. This little known fact can be found in the export\ndirectory and can be helpful for attributing malware samples. All of the AcidBox samples\ncontain gaps between the single exported function entries:\n\nFigure 4. Export directories of AcidBox samples with gaps between the export function entries\n\n\n-----\n\nEvery AcidBox sample has a NumberOfFunctions value in the export directory that is\nbigger than the NumberOfNames value. This isn’t something unusual, as not every\nexported function has to have a name too. Unnamed functions can be also called by their\n[ordinal values. What is uncommon, however, is that the function entries which are](https://docs.microsoft.com/en-us/cpp/build/exporting-functions-from-a-dll-by-ordinal-rather-than-by-name?view=vs-2019)\nunnamed are also zeroed out, thus not used.\n\n[This is the result when you use your own DEF file instead of __declspec(dllexport) to](https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-def-files?view=vs-2019)\ndescribe the attributes of your DLL file. When you use a DEF file, you can choose which\nordinal your export function will have. This is not possible with __declspec(dllexport) as\nthe Visual Studio compiler always counts your functions starting from one.\n\nUsing a DEF file instead of __declspec(dllexport) has some advantages. You are able to\n[export functions by ordinals and you can also redirect functions among other things. The](https://docs.microsoft.com/en-us/cpp/build/reference/exports?view=vs-2019)\ndisadvantage is that you have to maintain an additional file within your project.\n\nIn the case of the AcidBox samples, we can conclude a couple of things. First, the author\nuses a DEF file, although he doesn’t make use of its advantages. This could indicate it’s a\nhabit of the author to use DEF files. Second, the function ordinals seem to be chosen in\nsteps of two integers. A possible explanation could be that the unused ordinals were once\nused for functions too. And last, if we assume the author really has chosen to make two\ninteger steps, then in the usermode DLLs, one export function was removed. We can see\nthat ordinal 3 is unused, leaving a bigger gap than one integer. All this information can be\nuseful for malware attribution.\n\n## Conclusion\n\nA new advanced malware, dubbed AcidBox, was used by an unknown threat actor in 2017\nthat went undetected until now. It uses a known VirtualBox exploit to disable Driver\nSignature Enforcement in Windows, but with a new twist: While it’s publicly known that\nVirtualBox driver VBoxDrv.sys v1.6.2 is vulnerable and used by Turla, this new malware\nuses the same exploit but with a slightly newer VirtualBox version.\n\nSometimes, you are still able to find a technically interesting Windows malware that uses\na new technique. This has become quite a rarity in today’s threat landscape where\neverything is either a copy of a copy of a copy or technically underwhelming. While\nAcidBox doesn’t use any fundamentally new methods, it breaks the myth that only\nVirtualBox VBoxDrv.sys 1.6.2 can be used for Turla’s exploit. Appending sensitive data as\nan overlay in icon resources, abusing the SSP interface for persistence and injection and\npayload storage in the Windows registry puts it into the category of interesting malware.\n\nThe samples we dubbed AcidBox are only part of a bigger toolkit which we, unfortunately,\ncould not identify. However, we provide two Yara rules for detection and threat hunting.\nAdditionally, if you happen to find an additional sample, or are even infected, you can use\nthe provided Python script to extract the sensitive data appended to the icon resources.\n[All of these can be found here at Unit 42’s GitHub repository.](https://github.com/pan-unit42/iocs/tree/master/AcidBox)\n\n\n-----\n\nIf you have any further information about this threat, don’t hesitate to contact us.\n\nPalo Alto Networks customers are protected from this malware. Our threat prevention\nplatform with WildFire identifies this malware as malicious. AutoFocus customers can\n[investigate this activity with the tag AcidBox.](https://autofocus.paloaltonetworks.com/#/tag/Unit42.AcidBox)\n\n[We would like to thank Dr.Web, Kaspersky, ESET and hFireF0X for their collaboration.](https://twitter.com/hfiref0x)\n\n### IOCs\n\n**Files in Windows system32 directory**\n\nmsv1_1.dll\n\npku.dll\n\nwindigest.dll\n\n**Mutexes**\n\nGlobal\\BFE_Event_{xxxxxxxxxxxx–xxxx-xxxxxxxx-xxxxxxxx}\n\nGlobal\\{xxxxxxxxxxxx–xxxx-xxxxxxxx-xxxxxxxx}\n\nThe malware takes the MachineGuid stored in the registry and reshuffles the single\ncharacters alternating from the end to the beginning and vice versa in steps of two. For\nexample, the MachineGuid string a9982d3e-c859-4702-c761-df7eea468ade gets\ntransferred into e9a86daeecf5–67c2-07419d87-e34289da and appended to the above\ntemplates.\n\n**Windows Registry**\n\nHKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Class\\{4D36E97DE325-11CE-BFC1-08002BE10318}\\0003\\DriverData (REG_BINARY type)\n\nHKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Class\\{4D36E96AE325-11CE-BFC1-08002BE10318}\\0000\\DriverData (REG_BINARY type)\n\nHKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Class\\{4D36E969E325-11CE-BFC1-08002BE10318}\\0000\\DriverData (REG_BINARY type)\n\n**Sample Hashes**\n\nMain worker DLL:\n\neb30a1822bd6f503f8151cb04bfd315a62fa67dbfe1f573e6fcfd74636ecedd5\n\nKernelmode driver:\n\n3ef071e0327e7014dd374d96bed023e6c434df6f98cce88a1e7335a667f6749d\n\nSSP DLL modules:\n\n\n-----\n\n003669761229d3e1db0f5a5b333ef62b3dffcc8e27c821ce9018362e0a2df7e9\n\nb3166c417d49e94f3d9eab9b1e8ab853b58ba59f734f774b5de75ee631a9b66d\n\n3ad20ca49a979e5ea4a5e154962e7caff17e4ca4f00bec7f3ab89275fcc8f58c\n\nBenign VirtualBox VBoxDrv.sys driver v2.2.0 (signed by “Sun Microsystems, Inc.”):\n\n78827fa00ea48d96ac9af8d1c1e317d02ce11793e7f7f6e4c7aac7b5d7dd490f\n\n### Get updates from Palo Alto Networks!\n\nSign up to receive the latest news, cyber threat intelligence and research from us\n\n[By submitting this form, you agree to our Terms of Use and acknowledge our Privacy](https://www.paloaltonetworks.com/legal-notices/terms-of-use)\nStatement.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "5d2b9e7f-cf43-4b54-ba18-065aa3003611",
            "created_at": "2022-10-25T16:06:24.199525Z",
            "updated_at": "2022-10-25T16:06:24.199525Z",
            "deleted_at": null,
            "name": "CyberMonitor",
            "url": "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections",
            "description": "APT & Cybercriminals Campaign Collection",
            "reports": null
        }
    ],
    "references": [
        "https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections/raw/master/2020/2020.06.17.AcidBox/AcidBox_%20Rare%20Malware%20Repurposing%20Turla%20Group%20Exploit%20Targeted%20Russian%20Organizations.pdf"
    ],
    "report_names": [
        "AcidBox_ Rare Malware Repurposing Turla Group Exploit Targeted Russian Organizations"
    ],
    "threat_actors": [
        {
            "id": "a0d369c1-f0b7-4c70-a3a5-77aabbd17979",
            "created_at": "2022-10-25T15:50:23.311311Z",
            "updated_at": "2025-03-27T02:00:55.438117Z",
            "deleted_at": null,
            "main_name": "Strider",
            "aliases": [
                "ProjectSauron"
            ],
            "source_name": "MITRE:Strider",
            "tools": [
                "Remsec"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "99845f58-2c39-46f7-8369-bb621ebb7002",
            "created_at": "2022-10-25T16:07:24.238844Z",
            "updated_at": "2025-03-27T02:02:10.14785Z",
            "deleted_at": null,
            "main_name": "Strider",
            "aliases": [
                "ProjectSauron"
            ],
            "source_name": "ETDA:Strider",
            "tools": [
                "Backdoor.Remsec",
                "ProjectSauron",
                "Remsec"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "c1ac2a5e-0225-47a4-8ac5-5fa898c96bde",
            "created_at": "2023-01-06T13:46:38.472883Z",
            "updated_at": "2025-03-27T02:00:02.84253Z",
            "deleted_at": null,
            "main_name": "ProjectSauron",
            "aliases": [
                "Sauron",
                "Project Sauron",
                "G0041"
            ],
            "source_name": "MISPGALAXY:ProjectSauron",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "a97cf06d-c2e2-4771-99a2-c9dee0d6a0ac",
            "created_at": "2022-10-25T16:07:24.349252Z",
            "updated_at": "2025-03-27T02:02:10.184406Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "ATK 13",
                "Belugasturgeon",
                "Blue Python",
                "CTG-8875",
                "Group 88",
                "ITG12",
                "Iron Hunter",
                "Krypton",
                "Makersmark",
                "Operation Epic Turla",
                "Operation Moonlight Maze",
                "Operation Penguin Turla",
                "Operation Satellite Turla",
                "Operation Skipper Turla",
                "Operation Turla Mosquito",
                "Operation WITCHCOVEN",
                "Pacifier APT",
                "Pensive Ursa",
                "Popeye",
                "SIG15",
                "SIG2",
                "SIG23",
                "Secret Blizzard",
                "TAG-0530",
                "Turla",
                "UNC4210",
                "Venomous Bear",
                "Waterbug"
            ],
            "source_name": "ETDA:Turla",
            "tools": [
                "ASPXSpy",
                "ASPXTool",
                "ATI-Agent",
                "AdobeARM",
                "Agent.BTZ",
                "Agent.DNE",
                "BigBoss",
                "COMpfun",
                "Chinch",
                "Cloud Duke",
                "CloudDuke",
                "CloudLook",
                "Cobra Carbon System",
                "ComRAT",
                "DoublePulsar",
                "EmPyre",
                "EmpireProject",
                "Epic Turla",
                "EternalBlue",
                "EternalRomance",
                "GoldenSky",
                "Group Policy Results Tool",
                "HTML5 Encoding",
                "HyperStack",
                "IcedCoffee",
                "IronNetInjector",
                "KSL0T",
                "Kapushka",
                "Kazuar",
                "KopiLuwak",
                "Kotel",
                "LOLBAS",
                "LOLBins",
                "LightNeuron",
                "Living off the Land",
                "Maintools.js",
                "Metasploit",
                "Meterpreter",
                "MiamiBeach",
                "Mimikatz",
                "MiniDionis",
                "Minit",
                "NBTscan",
                "NETTRANS",
                "NETVulture",
                "Neptun",
                "NetFlash",
                "NewPass",
                "Outlook Backdoor",
                "Penquin Turla",
                "Pfinet",
                "PowerShell Empire",
                "PowerShellRunner",
                "PowerShellRunner-based RPC backdoor",
                "PowerStallion",
                "PsExec",
                "PyFlash",
                "QUIETCANARY",
                "Reductor RAT",
                "RocketMan",
                "SMBTouch",
                "SScan",
                "Satellite Turla",
                "SilentMoon",
                "Sun rootkit",
                "TTNG",
                "TadjMakhal",
                "Tavdig",
                "TinyTurla",
                "TinyTurla Next Generation",
                "TinyTurla-NG",
                "Topinambour",
                "Tunnus",
                "Turla",
                "Turla SilentMoon",
                "TurlaChopper",
                "Uroburos",
                "Urouros",
                "WCE",
                "WITCHCOVEN",
                "WhiteAtlas",
                "WhiteBear",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "Wipbot",
                "WorldCupSec",
                "XTRANS",
                "certutil",
                "certutil.exe",
                "gpresult",
                "nbtscan",
                "nbtstat",
                "pwdump"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "8aaa5515-92dd-448d-bb20-3a253f4f8854",
            "created_at": "2024-06-19T02:03:08.147099Z",
            "updated_at": "2025-03-27T02:05:17.408118Z",
            "deleted_at": null,
            "main_name": "IRON HUNTER",
            "aliases": [
                "Belugasturgeon ",
                "Blue Python ",
                "CTG-8875 ",
                "ITG12 ",
                "KRYPTON ",
                "MAKERSMARK ",
                "Pensive Ursa ",
                "Secret Blizzard ",
                "Turla",
                "UAC-0003 ",
                "UAC-0024 ",
                "UNC4210 ",
                "Venomous Bear ",
                "Waterbug ",
                "ATK13 "
            ],
            "source_name": "Secureworks:IRON HUNTER",
            "tools": [
                " ComRAT",
                " Kazuar",
                " KopiLuwak",
                " LightNeuron",
                " Mosquito",
                " Nautilus",
                " Neuron",
                " Penquin",
                " PoisonFrog",
                " PyFlash",
                " Skipper",
                " Snake",
                " Tavdig",
                " TinyTurla",
                " Tunnus",
                "Carbon-DLL"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "a97fee0d-af4b-4661-ae17-858925438fc4",
            "created_at": "2023-01-06T13:46:38.396415Z",
            "updated_at": "2025-03-27T02:00:02.823045Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Uroburos",
                "Hippo Team",
                "Pacifier APT",
                "MAKERSMARK",
                "ATK13",
                "UAC-0003",
                "IRON HUNTER",
                "Waterbug",
                "TAG_0530",
                "KRYPTON",
                "Popeye",
                "SIG23",
                "UAC-0144",
                "G0010",
                "Blue Python",
                "VENOMOUS Bear",
                "Group 88",
                "Pfinet",
                "ITG12",
                "UNC4210",
                "Secret Blizzard",
                "UAC-0024"
            ],
            "source_name": "MISPGALAXY:Turla",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d11c89bb-1640-45fa-8322-6f4e4053d7f3",
            "created_at": "2022-10-25T15:50:23.509601Z",
            "updated_at": "2025-03-27T02:00:55.487991Z",
            "deleted_at": null,
            "main_name": "Turla",
            "aliases": [
                "Turla",
                "IRON HUNTER",
                "Group 88",
                "Waterbug",
                "WhiteBear",
                "Krypton",
                "Venomous Bear",
                "Secret Blizzard",
                "BELUGASTURGEON"
            ],
            "source_name": "MITRE:Turla",
            "tools": [
                "PsExec",
                "nbtstat",
                "ComRAT",
                "netstat",
                "certutil",
                "KOPILUWAK",
                "IronNetInjector",
                "LunarWeb",
                "Arp",
                "Uroburos",
                "PowerStallion",
                "Kazuar",
                "Systeminfo",
                "LightNeuron",
                "Mimikatz",
                "Tasklist",
                "LunarMail",
                "HyperStack",
                "NBTscan",
                "TinyTurla",
                "Penquin",
                "LunarLoader"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666716496,
    "ts_updated_at": 1743041780,
    "ts_creation_date": 1592451975,
    "ts_modification_date": 1592451975,
    "files": {
        "pdf": "https://archive.orkl.eu/bf1e6d61f88eae47312b6fe8208fa32a7f12caea.pdf",
        "text": "https://archive.orkl.eu/bf1e6d61f88eae47312b6fe8208fa32a7f12caea.txt",
        "img": "https://archive.orkl.eu/bf1e6d61f88eae47312b6fe8208fa32a7f12caea.jpg"
    }
}