{
    "id": "ba060a00-c31a-4513-b0a7-911f669bf0d7",
    "created_at": "2023-01-12T15:01:23.033225Z",
    "updated_at": "2025-03-27T02:09:24.528257Z",
    "deleted_at": null,
    "sha1_hash": "81b849c4978e22c8403cf9dc77cf213ed57ad26a",
    "title": "2022-04-21 - Nokoyawa Ransomware - New Karma-Nemty Variant Wears Thin Disguise",
    "authors": "",
    "file_creation_date": "2022-05-28T23:34:40Z",
    "file_modification_date": "2022-05-28T23:34:40Z",
    "file_size": 642461,
    "plain_text": "# Nokoyawa Ransomware | New Karma/Nemty Variant Wears Thin Disguise\n\n**[sentinelone.com/labs/nokoyawa-ransomware-new-karma-nemty-variant-wears-thin-disguise/](https://www.sentinelone.com/labs/nokoyawa-ransomware-new-karma-nemty-variant-wears-thin-disguise/)**\n\nAntonis Terefos\n\n## Executive Summary\n\nAt the beginning of February 2022, SentinelLabs observed two samples of a new\n[Nemty variant dubbed “Nokoyawa” (sample 1,](https://virustotal.com/gui/file/e097cde0f76df948f039584045acfa6bd7ef863141560815d12c3c6e6452dce4) [2).](https://www.virustotal.com/gui/file/fefd1117c2f0ab88d8090bc3bdcb8213daf8065f12de1ee6a6c641e888a27eab)\nSentinelLabs consider Nokoyawa to be an evolution of the previous Nemty strain,\nKarma.\nThe developers have attempted to enhance code responsible for excluding folders from\nencryption, but SentinelLabs analysis finds that the algorithm contains logical flaws.\nIn March, [TrendMicro suggested this ransomware bore some relation to Hive. We](https://www.trendmicro.com/en_us/research/22/c/nokoyawa-ransomware-possibly-related-to-hive-.html)\nassess that Hive and Nokoyawa are different and that the latter is not a rebrand of Hive\nRaaS.\n\n## Overview\n\n[In this post, we take a broader look at the similarities between Nokoyawa and Karma](https://www.sentinelone.com/labs/karma-ransomware-an-emerging-threat-with-a-hint-of-nemty-pedigree/)\n[ransomware. Previous researchers have highlighted similarities in the attack chain between](https://www.trendmicro.com/en_us/research/22/c/nokoyawa-ransomware-possibly-related-to-hive-.html)\n[Nokoyawa and Hive ransomware, concluding that “Nokoyawa is likely connected with Hive,](https://www.sentinelone.com/blog/hive-ransomware-deploys-novel-ipfuscation-technique/)\nas the two families share some striking similarities in their attack chain, from the tools used\n\n\n-----\n\nto the order in which they execute various steps. Our analysis contradicts that finding, and\n[we assess Nokoyawa is clearly an evolution of Karma (Nemty), bearing no major code](https://www.sentinelone.com/labs/karma-ransomware-an-emerging-threat-with-a-hint-of-nemty-pedigree/)\nsimilarities to Hive.\n\n## Nokoyawa and Karma Variant Similarities\n\nBoth Nokoyawa and Karma variants manage multi-threaded encryption by creating an\n[input/output (I/O) completion port (CreateIoCompletionPort), which allows communication](https://docs.microsoft.com/en-us/windows/win32/fileio/createiocompletionport)\nbetween the thread responsible for the enumeration of files and the sub-threads (“2 *\nNumberOfProcessors”) responsible for the file encryption.\n\nNokyoawa (left) vs Karma, initialization of encryption threads\n[In both cases, public keys for the encryption and ransom note are encoded with Base64.](https://www.sentinelone.com/blog/guide-encode-decoded-base64/)\n\nLike Karma, Nokoyawa accepts different command line parameters, although in the latter\nthey are documented by the developer via a `-help command.`\n\nNokoyawa command line support\nAside from the `-help command, three other commands ( -network,` `-file, and` `-dir )`\nare also provided.\n\n**Parameter** **Functionality**\n\n_-help_ Prints command line options for execution of ransomware.\n\n\n-----\n\n_-network_ Encrypts local and network shares.\n\n_-file_ Encrypts specified file.\n\n_-dir_ Encrypts specified directory.\n\nIf the ransomware is executed without any parameter, it then encrypts the machine without\nenumerating and encrypting network resources.\n\nOne new parameter not observed in the Karma version is `-network, which is responsible`\nfor encrypting network shares. Network enumeration is achieved by calling\n[WNetOpenEnumW,](https://docs.microsoft.com/en-us/windows/win32/api/winnetwk/nf-winnetwk-wnetopenenumw) [WNetEnumResourceW, and](https://docs.microsoft.com/en-us/windows/win32/api/winnetwk/nf-winnetwk-wnetenumresourcew) [WNetCloseEnum.](https://docs.microsoft.com/en-us/windows/win32/api/winnetwk/nf-winnetwk-wnetcloseenum)\n\nThere are no significant similarities between the ransom notes except the use of email for\ncontact points. Karma variants contained an `.onion link that was also present in the`\nKarma ransom note. We did not find any `.onion links in Nokoyawa code or ransom note.`\n\nThe Nokyoawa ransom note:\n```\nDear usernamme, your files were encrypted, some are compromised.\nBe sure, you can't restore it without our help.\nYou need a private key that only we have.\nContact us to reach an agreement or we will leak your black shit to media:\n[email protected]\n[email protected]\n\n```\n亲爱的用户名，您的文件已加密，有些已被泄露。\n请确保，如果没有我们的帮助，您将无法恢复它。\n您需要一个只有我们拥有的私钥。\n联系我们以达成协议，否则我们会将您的黑屎泄露给媒体：\n```\n[email protected]\n[email protected]\n\n```\nThe Karma ransom note:\n\n\n-----\n\n```\nYour network has been breached by Karma ransomware group.\nWe have extracted valuable or sensitive data from your network and encrypted the data\non your systems.\nDecryption is only possible with a private key that only we posses.\nOur group's only aim is to financially benefit from our brief acquaintance,this is a\nguarantee that we will do what we promise.\nScamming is just bad for business in this line of work.\nContact us to negotiate the terms of reversing the damage we have done and deleting\nthe data we have downloaded.\nWe advise you not to use any data recovery tools without leaving copies of the\ninitial encrypted file.\nYou are risking irreversibly damaging the file by doing this.\nIf we are not contacted or if we do not reach an agreement we will leak your data to\njournalists and publish it on our website.\nhttp://3nvzqyo6l4wkrzumzu5aod7zbosq4ipgf7ifgj3hsvbcr5vcasordvqd.onion/\nIf a ransom is payed we will provide the decryption key and proof that we deleted you\ndata.\nWhen you contact us we will provide you proof that we can decrypt your files and that\nwe have downloaded your data.\nHow to contact us:\n[email protected]\n[email protected]\n[email protected]\n\n```\nThe ransom note filename uses a similar format as the previous versions:\n```\n<ransom_extension>_<note_name>.txt .\n\n```\n**Nokoyawa** **Karma**\n\nransom_extension “NOKOYAWA” “KARMA” & “KARMA_V2”\n\nnote_name “_readme.txt” “-ENCRYPTED.txt”\n\nThe `<ransom_extension> string has been used for many different functions, including:`\n\nfile extension of encrypted files\nappended as data to an encrypted file\nransom note filename part\nmutex (the NOKOYAWA variant is observed to not make use of Mutexes)\nto denote files to be excluded from further processing (e.g., to avoid running in a loop)\n\n## Nokoyawa’s Flawed Encryption Routine\n\n\n-----\n\nDuring the file and folder enumeration, the new variant creates a hash of the enumerated\nfolder and compares it to those of excluded folders. However, this custom hashing algorithm\nappears to have flaws as it doesn’t seem logical nor does it appear to work as expected.\n\nBelow is a Python representation of the hashing algorithm.\n```\ndef nokoyawa_dir_hashing(folder):\n  folder_len = len(folder)\n  # to unicode\n  folder = '\\x00'.join([c for c in folder])\n  # initial hash value\n  nhash = 0x1505\n  i = 0\n  while i < folder_len:\n    c = ord(folder[i])\n    # to capital\n    c = c if c < 0x61 else c - 0x20\n    # hashing\n    nhash = ((nhash << 5) + nhash) + c\n    # flawed logic, taking only null bytes after 1st character.\n    i += 2 if not c else 1\n  return nhash & 0xFFFFFFFF\n\n```\nThe implementation of this flawed hashing algorithm in some cases results in excluding\nmultiple folders. Logically, one would expect there to be a 1:1 correlation between a hash\nand the folder to be excluded. However, the flawed code effectively makes it possible for\nmultiple folders to be excluded based on a single hash. This code does not appear in Karma\nvariants, which instead contain hardcoded strings denoting which folders to ignore during\nencryption.\n\nThe following table shows which folders the developers intended to skip during encryption.\n\n**Hash** **Folders Intended To Be Excluded**\n\n0x11f299b5 program files\n\n0x78fb3995 program files (x86)\n\n0x7c80b426 appdata\n\n0x7c8cc47c windows\n\n0xc27bb715 programdata\n\n0xd6f02889 $recycle.bin\n\nFor extensions, the ransomware doesn't have any hashing algorithm and compares the raw\nstrings with the extracted extension of the file. The excluded extensions are `.exe,` `.dll,`\nand `.lnk . Files containing \"NOKOYAWA\" are also excluded.`\n\n\n-----\n\nBoth Nokoyawa and Karma variants dynamically load `bcrypt.dll and call`\n[BCryptGenRandom in order to generate 0x20 random bytes. They generate an ephemeral](https://docs.microsoft.com/en-us/windows/win32/api/bcrypt/nf-bcrypt-bcryptgenrandom)\nSect233r1 key pair using the generated random bytes as the seed. The malware then uses\nthe private ephemeral key and the public embedded key to generate a shared Salsa20 key,\nwhich is subsequently used for the file encryption. The Salsa20 nonce is hardcoded as\n```\n“lvcelvce” in Nokoyawa, whereas in the Karma version it was \"11111111\" .\n\n```\nAn I/O completion packet is sent to the thread responsible for encryption. The packet\nincludes the following:\n\nFile handle\nFile size\nFile data\nSalsa20 key\nSalsa nonce\npublic ephemeral key\n\nThe encryption thread has a switch containing four cases, as follows:\n\n**Case 1: Writes encrypted content and decryption struct to file and appends**\n\"extension\"/\"variant name\".\n**Case 2: Calculates validation SHA1 hash and encrypts file data with Salsa20.**\n**Case 3: Closes File Handle and moves files with the new extension.**\n**Case 4: Exits.**\n\nIn both variants, the initial switch case is \"2\".\n\nInitial case, encryption thread\n\n\n-----\n\nEncryption thread case handler\nDuring Case 2, the malware adds a SHA1 checksum, which is possibly validated during the\ndecryption phase. The method runs through the following logic:\n\nAllocates 0x13 bytes (0x14 required for SHA1)\nXORs Salsa key with a buffer of \"6\".\nConcatenates file data to XORed Salsa key\nCalculates SHA1.\nXORs Salsa key with a buffer of \"\\\".\nConcatenates SHA1 hash to the second XORed Salsa key.\nCalculates validation SHA1.\nValidation SHA1 hash first 0x13 bytes are added to the encrypted file struct\n\nFiles encrypted by Nokoyawa will have the following structure.\n```\nstruct nokoyawa_encrypted_file\n{\n  BYTE encrypted_file_data[file_size], // using salsa20\n  BYTE public_ephemeral_key[0x40], // Sect233r1\n  BYTE validation_hash[0x13], // last byte is chopped\n  STRING ransomware_extension\n}\n\n```\nThe private key required for decryption is held by the attacker. When made available to the\nvictim, the decryption routine reads the struct, extracts the public ephemeral key and\ngenerates the Salsa 20 key using the private key. The encrypted data is then decrypted with\nthe key and validated by replicating the validated hash.\n\n## Conclusion\n\nNokoyawa code similarity and structure suggest it to be an evolution of the previous Nemty\nstrain, Karma. This appears to be another attempt from the developer to confuse attribution.\nAt this time, the actor appears not to have or provide any onion leak page.\n\n\n-----\n\nSentinelLabs could not validate previous research suggesting Nokoyawa is related to Hive.\nGiven the lack of code similarities between the two and the lack of further correlating data,\nwe can only suggest that earlier researchers' findings may be explained by the possibility of\nan affiliate using both Hive and Nokoyawa.\n\nSentinelLabs continues to follow and analyze the development of Nemty ransomware\nvariants.\n\n## Indicators of Compromise\n\n**Karma Ransomware SHA1**\n\n960fae8b8451399eb80dd7babcc449c0229ee395\n\n**Nokoyawa Ransomware SHA1**\n\n2904358f825b6eb6b750e13de43da9852c9a9d91\n\n2d92468b5982fbbb39776030fab6ac35c4a9b889\n\n32c2ecf9703aec725034ab4a8a4c7b2944c1f0b7\n\n**Nokoyawa Ransom Note Email Addresses**\n\n[[email protected]](https://www.sentinelone.com/cdn-cgi/l/email-protection)\n\n[[email protected]](https://www.sentinelone.com/cdn-cgi/l/email-protection)\n\n[[email protected]](https://www.sentinelone.com/cdn-cgi/l/email-protection)\n\n[[email protected]](https://www.sentinelone.com/cdn-cgi/l/email-protection)\n\n**Nokoyawa YARA Rule**\n\n\n-----\n\n```\nrule Nokoyawa_Nemty\n{\n  meta: \n    author = \"@Tera0017\"\n    description = \"Nokoyawa, Nemty/Karma ransomware variant\"  \n    Reference = \"https://www.sentinelone.com/labs/nokoyawa-ransomware-new-karmanemty-variant-wears-thin-disguise/\"\n  strings:\n    $code1 = {B8 (41| 43) 00 00 00 [10-30] 83 F8 5A}\n    $code2 = {48 8B 4C 24 08 F0 0F C1 01 03 44 24 10}   \n    $code3 = {83 E8 20 88 [7] 48 C1 E0 05 48 03 44 24}\n    $code4 = {48 C7 44 24 ?? 05 15 00 00}\n    $string1 =\n\"RGVhciB1c2VybmFtbWUsIHlvdXIgZmlsZXMgd2VyZSBlbmNyeXB0ZWQsIHNvbWUgY\" ascii\n    $string2 = \"-network\" fullword wide\n    $string3 = \"-help\" fullword wide\n    $winapi1 = \"PostQueuedCompletionStatus\" fullword ascii\n    $winapi2 = \"GetSystemInfo\" fullword ascii\n    $winapi3 = \"WNetEnumResourceW\" fullword ascii\n    $winapi4 = \"GetCommandLineW\" fullword ascii\n    $winapi5 = \"BCryptGenRandom\" fullword ascii\n  condition:\n    all of ($winapi*) and 4 of ($code*, $string*)\n}\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-04-21 - Nokoyawa Ransomware - New Karma-Nemty Variant Wears Thin Disguise.pdf"
    ],
    "report_names": [
        "2022-04-21 - Nokoyawa Ransomware - New Karma-Nemty Variant Wears Thin Disguise.pdf"
    ],
    "threat_actors": [
        {
            "id": "20c759c2-cd02-45bb-85c6-41bde9e6a7cf",
            "created_at": "2024-01-18T02:02:34.189827Z",
            "updated_at": "2025-03-27T02:02:09.937024Z",
            "deleted_at": null,
            "main_name": "HomeLand Justice",
            "aliases": [
                "Karma",
                "Storm-842",
                "Void Manticore"
            ],
            "source_name": "ETDA:HomeLand Justice",
            "tools": [
                "BABYWIPER",
                "BiBi Wiper",
                "BiBi-Linux Wiper",
                "BiBi-Windows Wiper",
                "Cl Wiper",
                "LowEraser",
                "No-Justice Wiper",
                "Plink",
                "PuTTY Link",
                "RevSocks",
                "W2K Res Kit"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535683,
    "ts_updated_at": 1743041364,
    "ts_creation_date": 1653780880,
    "ts_modification_date": 1653780880,
    "files": {
        "pdf": "https://archive.orkl.eu/81b849c4978e22c8403cf9dc77cf213ed57ad26a.pdf",
        "text": "https://archive.orkl.eu/81b849c4978e22c8403cf9dc77cf213ed57ad26a.txt",
        "img": "https://archive.orkl.eu/81b849c4978e22c8403cf9dc77cf213ed57ad26a.jpg"
    }
}