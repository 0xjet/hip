{
    "id": "bc2631bc-43f3-4388-9a25-d800372f1ae3",
    "created_at": "2023-01-12T15:06:24.118072Z",
    "updated_at": "2025-03-27T02:08:40.892882Z",
    "deleted_at": null,
    "sha1_hash": "3d7847ee4db103d515a9966206090157fce906f8",
    "title": "2021-07-16 - Mars-Deimos- From Jupiter to Mars and Back again (Part Two)",
    "authors": "",
    "file_creation_date": "2022-05-27T23:16:36Z",
    "file_modification_date": "2022-05-27T23:16:36Z",
    "file_size": 1921860,
    "plain_text": "# Mars-Deimos: From Jupiter to Mars and Back again (Part Two)\n\n**[binarydefense.com/mars-deimos-from-jupiter-to-mars-and-back-again-part-two/](https://www.binarydefense.com/mars-deimos-from-jupiter-to-mars-and-back-again-part-two/)**\n\nJuly 16, 2021\n\n_[Note: this post was originally shared on https://squiblydoo.blog/ by a member of the Binary](https://squiblydoo.blog/)_\n_Defense Team. In order to ensure this research is visible to a broader audience, this_\n_employee agreed to let us share it here._\n\nDropper\n[SHA256: a871b7708b7dc1eb6fd959946a882a5af7dafc5ac135ac840cfbb60816024933](https://www.virustotal.com/gui/file/a871b7708b7dc1eb6fd959946a882a5af7dafc5ac135ac840cfbb60816024933/community)\n\nBackdoor\n[SHA256: cc17391dde8a9f3631705c01a64da0989b328760e583009e869a7fff315963d7](https://www.virustotal.com/gui/file/cc17391dde8a9f3631705c01a64da0989b328760e583009e869a7fff315963d7/detection)\n\nIn May, [I published an analysis of the persistence mechanism for Mars-Deimos and had](https://squiblydoo.blog/2021/05/02/mars-deimos-solarmarker-jupyter-infostealer-part-1/)\nintended to publish further analysis regarding that individual sample; however, there have\nbeen many changes to the distributed malware since that time.\n\nAs a reminder and abbreviated summary, a particular malware author or group of authors\nhad started using a malware which appeared to be tracked internally by the authors as MarsDeimos and I documented the persistence mechanism of that malware. The malware family\nis also tracked by researchers under other names as well: Jupyter, Solarmarker, Yellow\nCockatoo, and Polazert.\n\n\n-----\n\nJupyter had been documented by a few organizations as being able to steal browser cookies\nand passwords from browsers. However, the authors also distributed a malware named\nMars-Deimos, which differed substantially from Jupyter.\n\nMars-Deimos has functionality for collecting information about the victim computer,\nencrypting the information and submitting it back to the Command and Control server (C2). It\nalso has functionality to download and execute code.\n\nThe function table from dnSpy when analysing Mars-Deimos\nThis article will focus on the distribution system for this malware author and some recent\nchanges and techniques that have been seen by the malware family.\n\n## Distribution System for Mars-Deimos\n\nThe malware is downloaded the following way:\n\nA victim does a Google search for a template of a document, a search result is a Google Site\n(sites.google.com), and the Google Site offers them a PDF or DOC version of the template.\n\nNOTE: You’ll see randomly named documents like in the picture below: “Invoice PDF to\nExcel” or “Indeed Resume File Format”. All of these are completely randomized and the\nnames don’t matter for the sake of the malware. In fact, you can change the URL and give it\na custom name if you want—again it doesn’t matter—the same malware gets dropped.\n\n\n-----\n\nGoogle Site which hosts links to the malware\nThe user will select to download a PDF or DOC. By clicking one of the links, the victim will be\nsent off of the Google Site in order to download the malware. The distribution system also\nhas features in place to prevent users from making too many downloads.\n\nFor several months, the download page was a spoofed Microsoft website.\n\n**NOTE: For security training, users should at least be aware of the idea of “Red Flags.” I**\nbelieve this is a common idea in our world and it is important to apply it to cybersecurity as\nwell in our training sessions. If they find something that seems off—like a Google Site\nleading to a Microsoft website—they should be encouraged to be skeptical.\n\n\n-----\n\nSpoofed Microsoft Website. Take note of the URL “enpfereschemry.tk”\nThe current download site is a spoofed Google Drive. Between the download button and the\nGoogle Drive site, the user is passed through some oddly named sites. In this instance,\nthose sites should be red-flags for the user as they are unusual for Google sites and Google\nDrive.\n\nThe user is then presented with a download button to download the “template” or “document”\nthey are requesting. Many modern browsers will give a warning about the download as the\nbrowser recognizes it as an executable.\n\n\n-----\n\nSpoofed Google Drive website. Take note of the URL “badibebiro.tk”\nTheir distribution system is very dynamic and very extensive. There are at least 60,000\nGoogle Sites that lead to the malware and I have documented ~1,000 unique domains\ncontrolled by the authors. The URLs on the Google Site are updated through JavaScript to\nassign the appropriate URL to the buttons on the page.\n\n## The Malware Binary\n\nWhen the malware is downloaded, its icon is set to be that of a PDF file. The file is ~107 MB\nin size in order to prevent being uploaded to most automated malware analysis sites. (Most\nmalware analysis sites which are free or paid have a size restriction of 100MB.)\n\nThe malware is often created and formed using the program InnoSetup. Unpacking the\nInnoSetup installer reveals junk data files which the authors themselves had named “waste.”\nThese “waste” files are simply to make the executable a large size. In addition to the waste is\na decoy PDF program.\n\nThe malware authors have recently been seen deviating from InnoSetup. One recent binary\nwas built with Delphi 7 and includes PowerShell executed from the compiled binary. The\nPowerShell reads and executes a temporary file. It is consistent with the scripts they use in\nother parts of their malware deployment:\n\n\n-----\n\nPowershell executed when the malware is run\n\nStep one: set $xp to a file dropped into AppData\\Local\\Temp\\\nStep two: set $xk to a key\nStep three: read the file $xp into the variable $xb, converting it from Base64\nStep four: delete temporary file\nStep five: decode the file $xb using the key and using -bxor through a set of two forloops\nStep six: set the encoding to UTF8 for the variable $xb\nStep seven: execute the code from the decoded variable in memory.\n\nAt this point in time, it appears very few virus detection systems detect this behavior from the\nexecutable. However, this type of behavior should be caught by an Endpoint Detection and\nResponse (EDR) system that is being monitored by SOC analysts or System Administrators.\n[Organizations should be using PowerShell script logging for catching PowerShell execution:](https://www.fireeye.com/blog/threat-research/2016/02/greater_visibilityt.html)\nPowerShell script logging can be made to save information regarding what PowerShell is\nexecuted on a system allowing for an analysis of what had been executed.\n\nThe executed code from this malware sets in motion the loading of an info-stealing malware\nand sets a persistence mechanism. The most recent executables sleep for 30 minutes prior\nto starting the info-stealing malware.\n\n## Mars-Deimos Malware Persistence\n\nPreviously, the malware’s persistence was managed by changing shortcuts to call the\nmalware when the shortcuts were executed. That is, the shortcut would perform its original\nfunction and execute a malicious .bat/.cmd script to load the malware into memory. In lieu of\nchanging shortcuts, recent revisions have dropped a .lnk file in the user’s Start\nMenu\\Programs\\Startup directory. With the .lnk file being placed in this directory, it will be\nexecuted on startup and start the backdoor. EDR systems and System Administrators should\nmonitor this directory as it is frequently used by malware.\n\nThe file path used by the malware will use toggle case (capitalization of letters in the middle\nof a word) for words like “Windows” in order to avoid some detection techniques and will look\nsomething like this:\n```\n\"C:\\Users\\*****\\AppData\\Roaming\\miCrOsofT\\wINDoWS\\stARt\nmeNU\\PRogrAMS\\startUp\\a19392f921e4f9a03b0a25110d2ab.LnK\"\n\n```\n\n-----\n\nNewer revisions have stopped using a .bat/.cmd file and have used a random extension\nname. The file the .lnk points to is normally in a user’s AppData\\Roaming or\nAppData\\Roaming\\Microsoft directory. The folder will be a randomly named directory: older\nversions use 4 characters, newer versions use around 14 characters.\n\nAn image of a randomly named directory with randomly named files, with randomly named\nextensions\nThe .lnk file in this instance points to the highlighted file in the image above. It uses a name\nstarting with “AJftzy”. When the .bat/.cmd script was used, it had been saved in this directory;\nhowever, the files that are now created appear to be decoy files and the real persistence is\nused by the file extension.\n\nPowerShell is used by the malware to register the randomized file extension, in this case it\nis”.xmJqGtrIkQlFig”, and in turn the file extension points to another class in the registry (\n“xmJqGtrlkQlFig_auto_file”).\n\nAn\n\nimage of the registry key created by the malware\nThis registry class is set to execute PowerShell when the file extension is used. The\nPowerShell decodes and loads the Mars.Deimos malware into memory and launches it.\n\n\n-----\n\nThe registry key details for the class and command registered by the malware\n\n## Mars-Deimos Functionality\n\nIn a previous version of this post, I hadn’t seen the binary loaded through the registry key.\nInstead, I had only seen the binary loaded by the executable after the 30-minute sleep. In\ncontrast to my previous understanding, the malware actually loads an info-stealing malware\nand then uses Mars-Deimos for a persistent backdoor.\n\nIn recent versions, the malware has used two different binaries: “F.G.” or Jupyter for the infostealer. The process for starting the binary is nearly identical to starting Mars-Deimos: the\nbinary is read from an obfuscated file in a temporary directory, System.Reflection.Assembly\nis used to load the binary into memory, and a function native to the binary (like “Run” or\n“Interact”) is used to execute it.\nIn contrast to Mars-Deimos and Jupyter, the F.G. malware appears to check to see what\nbrowsers are installed based on their default directories. If they exist, it will use\nSystem.Threading to start new threads. Based on my beginning analysis, it also appears to\ncopy the content of forms in order to pass those back to the C2.\n\n\n-----\n\nCurrent binary’s functions as seen from dnSpy\nThe authors appear to be maintaining Jupyter, Mars.Deimos and F.G., and using them\ntactically in different distributions of the malware. They each have their own purpose and it\nappears that each are being updated and used as deemed appropriate.\n\n\n-----\n\n## Detection of Mars-Deimos Malware\n\nThe malware is most reliably caught by EDR systems. During my research for the last few\nmonths, many antivirus systems have failed to recognize and adapt to detecting new\nversions of the malware; however, other researchers have quickly identified infected systems\nthrough their monitoring systems. The main attributes seen quickly by EDR systems come\nfrom the PowerShell executed by the malware.\n\nThe current versions of the malware use specific high-fidelity indicators of malicious activity.\nFirst, the PowerShell execution uses obfuscated variable names. These obfuscated variable\nnames are a red-flag of malicious activity. If you are unfamiliar with the obfuscation of\n[variables, please review my previous blog post regarding this malware. Second, the malware](https://binarydefense.com/mars-deimos-solarmarker-jupyter-infostealer-part-1/)\nconsistently uses IEX and System.Reflection.Assembly for executing the malware. These\nare both are means of executing and loading code on a system and are rare for legitimate\nprocesses to use. Watching for the use of these two functions has been a high-quality means\nfor detecting the malware. The PowerShell execution is called both in the initial infection and\nthrough the persistence mechanism, so if an organization begins to monitor for the use of the\nPowerShell, they should detect both new and past infections.\n\nThe malware can also be detected using YARA rules. The most consistent YARA rule for\ndetecting this malware has been based on the DLL backdoor as it appears the name of the\nDLL follows a consistent pattern across versions of the malware. The YARA Rule created by\nLuke Acha is able to identify the processes which have loaded the DLL. For those unfamiliar\nwith using YARA Rules, consider using the YARA Memory Scanner from Binary Defense’s\nGitHub repository. This scanner can be given a YARA rule or the URL to a YARA rule and it\ncan scan a system to detect if the malware is present in memory.\n\nFor example, the following PowerShell will run the YaraMemoryScanner script, download the\nYARA rule to check for this malware family, and scan the current running processes:\n```\n.\\YaraMemoryScanner.ps1\nhttps://raw.githubusercontent.com/securitymagic/yara/main/Jupyter%20Malware/JupyterDll\n\n```\nThe output of the YaraMemoryScanner will display the Process ID, Process Name and\nexecution path of the processes and save the information in a text file. If any results are\nreturned, the user should review the processes in order to confirm the malware infection.\nInfected hosts should have a file named “solarmarker.dat” in the user’s AppData\\Roaming\ndirectory: this file is used as a host identifier by the malware.\n\n## Summary\n\nThe malware dropped by this distribution system appears use a few different varieties:\nJupyter, Mars-Deimos, and F.G. Each of these appear to have very different functionality and\nappear to be used tactically by the author to achieve different goals. The author changes\n\n\n-----\n\ntheir tactics regularly to avoid detection. Due to the frequent changes, antivirus often fails to\ndetect the malware but the malware can be detected through means of monitoring\nPowerShell execution on a host.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-16 - Mars-Deimos- From Jupiter to Mars and Back again (Part Two).pdf"
    ],
    "report_names": [
        "2021-07-16 - Mars-Deimos- From Jupiter to Mars and Back again (Part Two).pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673535984,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1653693396,
    "ts_modification_date": 1653693396,
    "files": {
        "pdf": "https://archive.orkl.eu/3d7847ee4db103d515a9966206090157fce906f8.pdf",
        "text": "https://archive.orkl.eu/3d7847ee4db103d515a9966206090157fce906f8.txt",
        "img": "https://archive.orkl.eu/3d7847ee4db103d515a9966206090157fce906f8.jpg"
    }
}