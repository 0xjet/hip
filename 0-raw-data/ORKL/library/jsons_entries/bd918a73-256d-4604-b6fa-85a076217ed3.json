{
    "id": "bd918a73-256d-4604-b6fa-85a076217ed3",
    "created_at": "2023-01-12T15:06:53.332433Z",
    "updated_at": "2025-03-27T02:11:33.877185Z",
    "deleted_at": null,
    "sha1_hash": "138b7b84f7b868403a95d4838972112aef350bee",
    "title": "2020-05-11 - Zeus Sphinx Back in Business- Some Core Modifications Arise",
    "authors": "",
    "file_creation_date": "2022-10-02T12:20:03Z",
    "file_modification_date": "2022-10-02T12:20:03Z",
    "file_size": 3875776,
    "plain_text": "# Zeus Sphinx Back in Business: Some Core Modifications Arise\n\n**[securityintelligence.com/posts/zeus-sphinx-back-in-business-some-core-modifications-arise/](https://securityintelligence.com/posts/zeus-sphinx-back-in-business-some-core-modifications-arise/)**\n\n[Malware\nMay 11, 2020](https://securityintelligence.com/category/x-force/malware-threat/)\nBy [Nir Shwarts co-authored by\nLimor Kessem\n8 min read](https://securityintelligence.com/author/nir-shwarts/)\n\n\n-----\n\nThe Zeus Sphinx banking Trojan is financial malware that was built upon the existing and\nleaked codebase of the forefather of many other Trojans in this class: Zeus v2.0.8.9. Over\n[the years, Sphinx has been in different hands, initially offered as a commodity in](https://securityintelligence.com/uk-banks-hit-with-new-zeus-sphinx-variant-and-renewed-kronos-banking-trojan-attacks/)\n[underground forums and then suspected to be operated by various closed gangs.](https://securityintelligence.com/zeus-sphinx-pushes-empty-configuration-files-what-has-the-sphinx-got-cooking/)\n\n[After a lengthy hiatus, this malware began stepping up attack campaigns starting in late 2019](https://securityintelligence.com/posts/zeus-sphinx-trojan-awakens-amidst-coronavirus-spam-frenzy/)\nand increased its spreading power in the first quarter of 2020 via malspam featuring\ncoronavirus relief payment updates.\n\nWith Sphinx back in the financial cybercrime arena, IBM X-Force wrote the following\ntechnical analysis of the Sphinx Trojan’s current version, which was first released into the\nwild in late 2019. We will be covering the following components, shedding light on parts of\nthe malware that were modified in this version, as other parts likely remained the same:\n\nPersistence mechanism\nInjection tactics\nBot configuration\nHidden configuration nuggets\nBot identification method\nSphinx’s naming algorithms\n\nLet’s dive in.\n\n## Establishing Persistence\n\nAlmost any malware nowadays seeks to establish persistence on infected devices, both\ndesktop and mobile, with the goal of surviving system reboots. Sphinx establishes\npersistence using a very common method: adding a Run key to the Windows Registry. This\ntactic has been used by Sphinx since its earliest versions, released in 2015.\n\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n\n_Figure 1: Run key set for Sphinx’s executable payload_\n\nSince Sphinx’s malicious payload can come in two different formats, an executable file or a\ndynamic link library (DLL), it also sets the Registry Run key according to the format being\ninstalled. For the DLL format, we would see the following string type created:\n\n_Figure 2: Run key set for a Sphinx DLL_\n\n\n-----\n\nThe malicious DLL s entry point is named DllRegisterServer, which is usually an entry point\nfor a COM module. When malware elects to use generic system names for its resources, it is\ndone to blend in with the other benign elements in the operating system (OS).\n\n## Sphinx’s Code Injection Choice: Process Injection\n\nSince its main function is to grab user credentials and other personal information from online\nbanking sessions, Zeus Sphinx is designed with the ability to hook browser functions. Before\ngaining the ability to hook these types of functions, Sphinx has to ensure its stealthy ongoing\noperations on the OS. It does this by injecting malicious code into other processes first.\n\nThe tactic Sphinx uses is a process injection technique:\n\n1. Sphinx calls on the CreateProcessA function, which creates a new process and its\n\nprimary thread. The function’s parameters are msiexec.exe for the new process name\nand the suspend flag applied as the process state. This is another part of the\nmalware’s stealth mechanism, as msiexec.exe usually stands for the name of a\nlegitimate Windows Installer process that is responsible for installation, storage and\nremoval of programs.\n\n\n-----\n\n_Figure 3: Sphinx s process injection_\n\n1. It calls the WriteProcessMemory function to inject a payload into the msiexec.exe\n\nprocess.\n2. Next, Sphinx changes the execution point of the targeted process to start from the\n\ninjected payload, using GetThreadContext and SetThreadContext functions.\n_GetThreadContext is used to get the current extended instruction pointer of the remote_\nprocess. SetThreadContext is used to set the current extended instruction pointer of\nthe remote process.\n\nThe extended instruction pointer holds the address of the next instruction.\n\n_Figure 4: Sphinx’s process injection_\n\n## Bot Configuration\n\nThe bot’s encrypted configuration is embedded within the injected executable in\n_msiexec.exe._\n\nWhat makes it rather easy to decrypt is that both the configuration and its decryption key\nreside near each other in a hardcoded address location. The following function decrypts the\nconfiguration using the hardcoded addresses of each component:\n\n\n-----\n\n_Figure 5: Bot configuration decryption process_\n\nLet’s take a look at the main components of a January 2020 campaign configuration. It\nbegan with noting the malware’s variant ID by using Russian language words that translate\nto “2020 Upgrade” (obnovlenie2020).\n\nNext, we see the attacker’s command-and-control (C&C) server domain list. Sphinx does not\nuse a domain generation algorithm (DGA).\n\nThese elements can help defenders better protect networks against Sphinx infections by\nmonitoring or blocking any communications to the listed C&C servers. The RC4 key itself is\nan important element to those looking to analyze the malware since it is the same key that\nSphinx uses to encrypt and decrypt most of its data.\n\n\n-----\n\nPlease note that the key inside the configuration is different from the key used to decrypt the\nconfiguration itself.\n\nIn the following image, we can see an example of two different Sphinx configurations.\n\n_Figure 6: Sphinx configuration excerpts from January 2020 Campaign_\n\nTaking into consideration the date they first appeared in the wild, similar C&C domains and\nthe same RC4 key they contain, we can conclude that both configurations are related to the\nsame campaign. On the left, a configuration fetched by an executable-type payload and on\nthe right, one fetched by a DLL-type payload — both are from a January 2020 campaign.\n\nSphinx configurations are modified as campaigns are launched, changing the C&C\naddresses and the RC4 keys. In the following image, we can see a newer configuration\nfetched from an April 2020 campaign.\n\n\n-----\n\n_Figure 7: A different Sphinx configuration excerpt from an April 2020 campaign_\n\nPlease note the main differences from the January 2020 configurations: a different RC4 key,\na smaller and different set of C&C domains, a changed variant ID and the precise date of\npublish were added.\n\n## Bot Identification\n\nOnce infected by Sphinx, every device sends information home and is defined in the botnet\nby a bot ID to ensure control and updates through the attacker’s server. To do that, Sphinx\nuses an algorithm that includes the following elements from the infected device:\n\nVolume C GUID\nComputer Name\nWindows Version\nWindows Install Date\nDigital Product ID\n\nWe can see the generated string when we run Sphinx dynamically as well:\n\n\n-----\n\n_Figure 8: Sphinx creating Bot ID string_\n\nAfter creating the bot ID, it’s encrypted with an RC4 stream cipher using the key derived from\nthe bot’s configuration and then stored in the Registry with other binary data.\n\nFor example, a key created for storing this information:\n\n_HKCU\\Software\\Microsoft\\bmqhcn\\gwehhxf_\n\nThe name of the key depends on the variant of the malware and is produced by encoding\nsome constants.\n\nLooking at the function’s output before the result is encrypted reveals Sphinx’s bot ID layout:\n\n[VOLUME_C_GUID][COMPUTER_NAME][2EBFF1F4][0ADE2A62]\n\n[VOLUME_C_GUID] – Bot’s volume C GUID\n\n[COMPUTER_NAME] – Bot’s computer name\n\n[2EBFF1F4] – A hash of the operating system version.\n\n[0ADE2A62] – A hash of InstallDate and DigitalProductID registry values.\nBoth hashes mentioned above are computed using a Sphinx internal hash function.\n\n## Sphinx’s Naming Algorithms\n\nMalware codes often use a naming algorithm to create different names for files and\nresources on each infected device. They do this to evade static detection that might search\nfor a certain file name as an indicator of compromise (IoC).\n\nIn Sphinx’s case, one naming algorithm is used to create files and resource names and a\n[different one is used to create a unique mutex object name.](https://isc.sans.edu/diary/How+Malware+Generates+Mutex+Names+to+Evade+Detection/19429/)\n\n### File/Resource Name Generator\n\nBeginning with the algorithm used to create file and resource names, to create what would\nappear to be random names, Sphinx uses a pseudo-random number generator (PRNG)\n[named MT19937 (also known as the Mersenne Twister). Let’s look at how Zeus Sphinx](https://www.sciencedirect.com/topics/computer-science/mersenne-twister)\nimplements this PRNG to create names for its resources.\n\n\n-----\n\nThe Sphinx naming algorithm function takes four parameters to create its names: maximum\nlength, minimum length, output buffer pointer and a binary option to upper or not the first\ncharacter. As shown in the next example, these parameters are hardcoded, which can help\nwrite more regular expressions (RegEx) for detecting such names.\n\n_Figure 9: Sphinx’s naming algorithm_\n\nLet’s look at the naming_algo function:\n\nSphinx starts the process by decoding two hardcoded strings, which amount to 25 of\nthe 26 English language characters:\n\nAeiouy\nbcdfghklmnpqrstvwxz\nIt uses randomization for choosing the output (name) size and loops through additional\nsteps to build it.\nIt randomly selects one of the two initial strings.\nIt randomly chooses one character from the selected string.\nIt appends the character to what’s going to eventually compose the generated name.\nIf the name has not yet met the selected length requirement, it loops back and repeats\nthe process.\n\n_Figure 10: Choosing between the “aeiouy” or “bcdfghklmnpqrstvwxz” strings_\n\n### Mutex Name Generator\n\nLike other malware, Sphinx generates mutex names upon execution. Mutex names are often\nsearched by security tools and researchers as a way to gather IoCs. Therefore, it can be a\nbetter way for malware to hide on infected devices if its mutex name is harder to find. The\nuse of a unique mutex name also helps prevent the malware from infecting the same\nmachine twice.\n\n\n-----\n\nIn Sphinx s case, the mutex name is always a unique string created per machine, and the\nalgorithm used to create it is relatively complicated.\n\nTo start, Sphinx uses two system data components for building its mutex names:\n\nThe device’s volume C globally unique identifier (GUID)\n[The current user’s security identifier (SID)](https://support.microsoft.com/en-us/help/243330/well-known-security-identifiers-in-windows-operating-systems)\n\nTo fetch the first value, it uses the Windows function\n_GetVolumeNameForVolumeMountPointW._\n\n_Figure 11: Sphinx composing its unique mutex name_\n\nTo fetch the second value, it uses two functions: OpenProcessToken and\n_GetTokenInformation._\n\n\n-----\n\n_Figure 12: Sphinx composing its unique mutex name_\n\nNext, to generate a unique name, Sphinx takes the following steps:\n\n1. It creates a hash of the infected device’s SID value that it obtained earlier on.\n\n_Figure 13: Sphinx composing its unique mutex name_\n\n1 It uses the GUID to encode the SID’s hash\n\n\n-----\n\nThis function is called seven times, with varying constants being used. Then, some of the\nnames are randomly selected to become mutex names.\n\n_Figure 14: Sphinx generates seven different mutex names on each device_\n\nTechnically, there could be seven different mutex names created on each device, which\nSphinx checks for to ensure that the device is not already running the malware.\n\n1. Next, using the key derived from the bot’s configuration, the mutex is encrypted with an\n\nRC4 cipher.\n\n_Figure 15: Sphinx encrypts mutex name_\n\n1. To make its mutex names blend in with other system elements, it calls on the function\n\n_ole32!StringFromGUID2, making the names look like GUIDs._\n\nBelow is an example of two mutex names created within msiexec.exe:\n\n\n-----\n\n_Figure 16: Examples of Sphinx mutex names generated through its process_\n\n## Sphinx Is Back in Business\n\nThe Sphinx Trojan emerged in 2015, at which point its main focus was banks in North\nAmerica. Over the years, different operators of this malware launched it into campaigns in\nother parts of the world, such as [the U.K., then](https://securityintelligence.com/uk-banks-hit-with-new-zeus-sphinx-variant-and-renewed-kronos-banking-trojan-attacks/) [Brazil, then](https://securityintelligence.com/brazil-cant-catch-a-break-after-panda-comes-the-sphinx/) [Canada and Australia. Most](https://securityintelligence.com/around-the-world-with-zeus-sphinx-from-canada-to-australia-and-back/)\nrecently, Sphinx was implemented in infection campaigns targeting users in Japan.\n\nWhile Sphinx has been an on-and-off type of operation over the years, it appears it is now\non-again, with version updates and new infection campaigns that are back to targeting North\nAmerican banks.\n\nWhile less common in the wild than Trojans like TrickBot, for example, Sphinx’s underlying\nZeus DNA has been an undying enabler of online banking fraud. Financial institutions must\nreckon with its return and spread to new victims amid the current pandemic.\n\nSphinx is just one more threat we regularly cover. To learn more about emerging threats and\n[campaigns, please join us on X-Force Exchange. Our research team also regularly releases](https://exchange.xforce.ibmcloud.com/#/)\n[blogs on Security Intelligence to keep you up to date on what we see in the wild.](https://securityintelligence.com/category/x-force/)\n\n[Nir Shwarts](https://securityintelligence.com/author/nir-shwarts/)\nMalware Research-Reverse Engineering, IBM Security\n\nNir Shwarts is a contributor for SecurityIntelligence.\n\n\n-----\n\n-----\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-05-11 - Zeus Sphinx Back in Business- Some Core Modifications Arise.pdf"
    ],
    "report_names": [
        "2020-05-11 - Zeus Sphinx Back in Business- Some Core Modifications Arise.pdf"
    ],
    "threat_actors": [
        {
            "id": "e90ec9cb-9959-455d-b558-4bafef64d645",
            "created_at": "2022-10-25T16:07:24.222081Z",
            "updated_at": "2025-03-27T02:02:10.14365Z",
            "deleted_at": null,
            "main_name": "Sphinx",
            "aliases": [
                "APT-C-15"
            ],
            "source_name": "ETDA:Sphinx",
            "tools": [
                "AnubisSpy",
                "Backdoor.Oldrea",
                "Bladabindi",
                "Fertger",
                "Havex",
                "Havex RAT",
                "Jorik",
                "Oldrea",
                "PEACEPIPE",
                "njRAT",
                "yellowalbatross"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536013,
    "ts_updated_at": 1743041493,
    "ts_creation_date": 1664713203,
    "ts_modification_date": 1664713203,
    "files": {
        "pdf": "https://archive.orkl.eu/138b7b84f7b868403a95d4838972112aef350bee.pdf",
        "text": "https://archive.orkl.eu/138b7b84f7b868403a95d4838972112aef350bee.txt",
        "img": "https://archive.orkl.eu/138b7b84f7b868403a95d4838972112aef350bee.jpg"
    }
}