{
    "id": "73268b42-56f5-4f9e-b233-02124556f96b",
    "created_at": "2023-01-12T15:09:08.263055Z",
    "updated_at": "2025-03-27T02:11:33.497298Z",
    "deleted_at": null,
    "sha1_hash": "2e3381f43eeb221d08e30800f7a4f10660e4571c",
    "title": "2020-11-05 - Agent Tesla- A Day in a Life of IR",
    "authors": "",
    "file_creation_date": "2022-05-28T01:57:50Z",
    "file_modification_date": "2022-05-28T01:57:50Z",
    "file_size": 3658669,
    "plain_text": "# Agent Tesla: A Day in a Life of IR\n\n**blog.morphisec.com/agent-tesla-a-day-in-a-life-of-ir**\n\n[Tweet](https://twitter.com/share)\n\n## Introduction\n\n\n-----\n\nThe Agent Tesla information stealer has been around since 2014. During the last two to\nthree years, it's also had a significant distribution growth factor partially due to the fact that\ncracked versions of it have been leaked.\n\nIt has been adapted by many advanced and less-sophisticated adversaries; as a result we\ncan clearly identify a growing number of modified Tesla variants.\n\nThis year marks a significant change from previous years in the distribution techniques that\nare leveraged for Agent Tesla. We have seen this information stealer delivered through\nexploits, COVID-19 phishing campaigns, integrating advanced steganography, implementing\ndifferent innovative obfuscation techniques, and more.\n\nThe following technical analysis covers a single Agent Tesla attack chain investigation after\nmultiple attack attempts on a Morphisec customer were prevented at the end of October.\nThis was particularly interesting because of the use of multiple advanced techniques that you\nrarely see combined into a single chain. Some of these advanced techniques that we will\ncover in this blog include:\n\nUse of a compromised sender email address\n**Double use of exploits to deliver the agent downloader**\nUse of advanced DeepSea obfuscator\nUse of double steganography obfuscation to deliver agent loader\nUse of Frenchy shellcode and .Net delegation for whitelisting bypass\nExecuting the dark stealer from memory\n\n## Technical Details\n\n Spearphishing\n\nThe attack chain started with a phishing email mentioning an RFQ for a new order. This\nmight have triggered suspicion for a more security aware employee, but in this case, the\nvictim was used to receiving similar emails and took the bait.\n\nFurthermore, the advanced gateway solution designed to prevent or quarantine documents\nwith a suspected DDE exploit (this will be discussed later) worked, but the user was\nconvinced that the email was legitimate and released it from quarantine because the user is\nused to receiving RFQs.\n\nIn this case, the email was sent from a trusted third party through either a compromised\nemail or a vulnerable domain that allows spoofing emails.\n\n## DDE exploit\n\n\n-----\n\nThe attached RFQ document is a known macro-less DDE exploit that will download its next\nstage document from a C2. In order to reduce the risk of detection, the attackers\n[implemented a known technique to avoid the use of “DDE” as part of the text and to delay](https://staaldraad.github.io/2017/10/23/msword-field-codes/#no-dde)\nthe download until after protected mode is disabled.\n\n\n-----\n\n## Equation Editor Exploit\n\nDocument.doc implements a second exploit in the chain identified by the following CVEs:\nCVE-2018-0802, CVE-2017-11882, a memory corruption vulnerability. The content of this\nnew document automatically replaces the content of the original document. While Patches\nalready exist for those vulnerabilities, many endpoints were still unpatched due to operational\nconstraints. This reality makes this CVE highly popular even today.\n\n\n-----\n\n## Agent Tesla Loader 1\n\nFollowing a successful exploitation of the Microsoft Equation Editor vulnerability, a thin\n~500KB loader is downloaded from the same C2 by the equation editor process. The loader\nis slightly obfuscated with a DeepSea obfuscator.\n\n[As was previously published, the Tesla loader started to abuse steganography techniques to](https://blog.talosintelligence.com/2019/07/sweed-agent-tesla.html)\nimplement its next stage by hiding its executable in a PNG image; only this time the image\nlooks significantly different.\n\nFirst decryption of the PNG resource:\n\nSurprisingly, the developers of this Tesla loader implemented an additional\nsteganography layer on top of the previously described technique to avoid heuristic detection\nof image resource based on metadata or entropy.\n\n\n-----\n\nThe leads to a second steganography layer, which already resembles embedded executable\nimages we know:\n\n## Agent Tesla Loader 2\n\n\n-----\n\nThe decrypted image is not the final result, instead it leads us to one more loader that is also\nobfuscated by an unknown obfuscator.\n\nThis .Net assembly is loaded in memory within vbc.exe (the first loader) as soon as it's\ndecrypted from the image.\n\nThis assembly has multiple functionalities that can be executed based on the predefined\nconfiguration parameters, such as:\n\nRemoving its zone identifier before the execution of the next stage and to avoid\nscanning and tracing back to origin.\n\nUsing choice for delayed execution of self removal\n\n\n-----\n\nValidation that only a single instance is running on the machine\n\nPersistency\n\nScheduled Task\n\nRegistry\n\nPossible installation of the assembly in different user paths\n\n\n-----\n\nFinally this second loader implements a basic decryption following the extraction of its byte\narray from the resource.\n\nAs soon as the next stage has been extracted, it is injected into a legitimate RegAsm\napplication using delegation and a known hollowing technique, which is implemented by the\nFrenchy shellcode framework.\n\n## Frenchy Shellcode Loader\n\nAs the hollowing mechanism is implemented by native code using a known Frenchy\nshellcode framework, there was a need to implement a code injection technique that was\nless likely to be picked up by some vendors. Instead of using a regular “CreateThread” type\nof method for redirecting the flow to an allocated shellcode, attackers use delegation to\nachieve the same thing – this is definitely not a new technique but it is less popular than a\nsimple callback native function.\n\n[The executed shellcode is identified as a Frenchy shellcode. Morphisec Labs has tracked](https://blog.morphisec.com/lokibot-with-autoit-obfuscator-frenchy-shellcode)\nmany Tesla variants that use Frenchy shellcode since January 2020 (although with a lot\nfewer staging layers). The shellcode maps “known” DLL sections into memory to avoid\nmonitoring by runtime hooking, then it creates the target process in suspended mode\n(RegAsm). It then maps a section into the legitimate process and it copies the previously decrypted executable into this section. Finally it executes the resume thread with new context\nthat leads to the execution of the Dark stealer.\n\n\n-----\n\n## Decrypted Tesla Dark Stealer\n\nThe final payload that runs within the RegAsm is the main Agent Tesla Dark Stealer module,\nit is also obfuscated using an unknown obfuscator.\n\n\n-----\n\nAll the different configuration strings such as browser names can easily be extracted by\nsimple xor manipulation of the executable bytes.\n\n[The decrypted strings have been uploaded to pastebin.](https://pastebin.com/raw/rueUS7kR)\n\nVirusTotal graph analysis on the IP reveals additional downloaders and multiple different\nEquation Editor exploits downloaded within the last couple of months.\n\n\n-----\n\nHere is the MITRE ATT&CK matrix with the techniques deployed by this Agent Tesla attack\nhighlighted for reference.\n\n## Conclusions:\n\n\n-----\n\nAgent Tesla may be an older information stealer, given its launch in 2014, but recent\nupgrades that allow it to evade detection make it more powerful than ever. The attack\ndescribed above makes it abundantly clear that Agent Tesla remains a force, especially\ngiven the addition of the above described techniques that make this infostealer capable of\nbypassing modern security controls to deliver its payload.\n\nMorphisec customers can remain confident, however, that they are protected against Agent\nTesla through the zero trust security power of moving target defense.\n\n## Blog IOCs:\n\n8267259394D54FC644A18AAA8A8A5D0C68624B6D (PO - RFQ # 097663899 NEW\nORDER.docx)\n\nhxxp://192.3.141[.]134/document.doc\n\nhxxp://192.3.141[.]134/bub.exe (vbs.exe)\n\nEF4C32312CE60C3CAB620AF37D77E793FA245A4F\n\n## Older IOCs:\n\n216.170.126[.]109\n\nhxxp://bsskillthdyemmulatorsdevelovercomun6bfs.duckdns[.]org/document/invoice_557711.doc\n\nef9b7e4604bd2c6755e2d7de3c65e5b04169c8e46e568058a29b94a4c6a7feee\n\nc602d323aab8dad524c191d31311f1e5acd24375ef72fdce83daaee592096dcd\n\ndf7aab11877cbf24a6a53fdf6b73dc72f16be4063803f5864db16d1e246c4e97\n\n555eefb79aa7973b4d497202383f8d15889157a8e8d0d858d53ea23ef4821b3d\n\n140103ff9a664823d2e532a35ba7ac8309d071875b4d06b5f6b275fd7fbc090a\n\n\n-----\n\n[Contact SalesInquire via Azure](http://10.10.0.46/mailto:sales@morphisec.com)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-11-05 - Agent Tesla- A Day in a Life of IR.pdf"
    ],
    "report_names": [
        "2020-11-05 - Agent Tesla- A Day in a Life of IR.pdf"
    ],
    "threat_actors": [
        {
            "id": "b740943a-da51-4133-855b-df29822531ea",
            "created_at": "2022-10-25T15:50:23.604126Z",
            "updated_at": "2025-03-27T02:00:55.505366Z",
            "deleted_at": null,
            "main_name": "Equation",
            "aliases": [
                "Equation"
            ],
            "source_name": "MITRE:Equation",
            "tools": null,
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "fe3d8dee-3bee-42e6-8f16-b6628b6189ae",
            "created_at": "2023-01-06T13:46:39.039285Z",
            "updated_at": "2025-03-27T02:00:02.98336Z",
            "deleted_at": null,
            "main_name": "SWEED",
            "aliases": [],
            "source_name": "MISPGALAXY:SWEED",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "f2c53785-fb8b-460d-ba73-7fbfba36f0f5",
            "created_at": "2022-10-25T16:07:24.247949Z",
            "updated_at": "2025-03-27T02:02:10.150345Z",
            "deleted_at": null,
            "main_name": "Sweed",
            "aliases": [],
            "source_name": "ETDA:Sweed",
            "tools": [
                "AgenTesla",
                "Agent Tesla",
                "AgentTesla",
                "ForeIT",
                "Formbook",
                "Loki",
                "Loki.Rat",
                "LokiBot",
                "LokiPWS",
                "Negasteal",
                "Origin Logger",
                "RDP",
                "Remote Desktop Protocol",
                "ZPAQ",
                "win.xloader"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536148,
    "ts_updated_at": 1743041493,
    "ts_creation_date": 1653703070,
    "ts_modification_date": 1653703070,
    "files": {
        "pdf": "https://archive.orkl.eu/2e3381f43eeb221d08e30800f7a4f10660e4571c.pdf",
        "text": "https://archive.orkl.eu/2e3381f43eeb221d08e30800f7a4f10660e4571c.txt",
        "img": "https://archive.orkl.eu/2e3381f43eeb221d08e30800f7a4f10660e4571c.jpg"
    }
}