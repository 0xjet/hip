{
    "id": "f679e869-ed65-4b91-804e-448275fbae46",
    "created_at": "2023-01-12T15:06:58.219245Z",
    "updated_at": "2025-03-27T02:08:41.148471Z",
    "deleted_at": null,
    "sha1_hash": "2dea1a513bb89b2b9916c200f57d00a282618c12",
    "title": "2021-07-17 - Meet WiFiDemon – iOS WiFi RCE 0-Day Vulnerability, and a Zero-Click Vulnerability That Was Silently Patched",
    "authors": "",
    "file_creation_date": "2022-05-28T23:13:30Z",
    "file_modification_date": "2022-05-28T23:13:30Z",
    "file_size": 2733547,
    "plain_text": "# Meet WiFiDemon – iOS WiFi RCE 0-Day Vulnerability, and a Zero-Click Vulnerability That Was Silently Patched\n\n**blog.zecops.com/research/meet-wifidemon-ios-wifi-rce-0-day-vulnerability-and-a-zero-click-vulnerability-that-was-**\nsilently-patched/\n\nBy ZecOps Research Team July 17, 2021\n\n## The TL;DR Version:\n\nZecOps Mobile EDR Research team investigated if the recently announced WiFi formatstring bug in wifid was exploited in the wild.\n\nThis research led us to interesting discoveries:\n\nRecently a silently patched 0-click WiFi proximity vulnerability on iOS 14 – iOS 14.4\nwithout any assigned CVE\nThat the publicly announced WiFi Denial of Service (DoS) bug, which is currently a\n0day, is more than just a DoS and actually a RCE!\nAnalysis if any of the two bugs were exploited across our cloud user-base.\n\n## Introduction\n\nThere’s a new WiFi vulnerability in-town. You probably already saw it, but didn’t realize the\nimplication. The recently disclosed ‘non-dangerous’ WiFi bug – is potent.\n\n\n-----\n\nThis vulnerability allows an attacker to infect a phone/tablet without any interaction with an\nattacker. This type of attack is known as “0-click” (or “zero-click”). The vulnerability was only\npartially patched.\n\n### 1. Prerequisites to the WiFiDemon 0-Click Attack:\n\nRequires the WiFi to be open with Auto-Join (enabled by default)\nVulnerable iOS Version for 0-click: Since iOS 14.0\nThe 0-Click vulnerability was patched on iOS 14.4\n\n**Solutions:**\n\nUpdate to the latest version, 14.6 at the time of writing to avoid risk of WiFiDemon in its\n0-click form.\nConsider disabling WiFi Auto-Join Feature via Settings->WiFi->Auto-Join Hotspot>Never.\nPerform risk and compromise assessment to your mobile/tablet security using ZecOps\nMobile EDR in case you suspect that you were targeted.\n\n### 2. Prerequisites to the WiFi 0Day Format Strings Attack:\n\nUnlike initial research publications, at the time of writing, the WiFi Format Strings seem to be\na Remote Code Execution (RCE) when joining a malicious SSID.\n\n**Solutions:**\n\nDo not join unknown WiFis.\nConsider disabling WiFi Auto-Join Feature via Settings->WiFi->Auto-Join Hotspot>Never.\nPerform risk and compromise assessment to your mobile/tablet security using ZecOps\nMobile EDR in case you suspect that you were targeted.\nThis vulnerability is still a 0day at the time of writing, July 4th. iOS 14.6 is\n**VULNERABLE when connecting to a specially crafted SSID.**\nWait for an official update by Apple and apply it as soon as possible.\n\n## Wi-Fi-Demon ?\n\nwifid is a system daemon that handles protocol associated with WIFI connection. Wifid runs\nas root. Most of the handling functions are defined in the CoreWiFi framework, and these\nservices are not accessible from within the sandbox. wifid is a sensitive daemon that may\nlead to whole system compromise.\n\n[Lately, researcher Carl Schou (@vm_call) discovered that wifid has a format string problem](https://www.twitter.com/vm_call)\nwhen handling SSID.\n\n\n-----\n\nhttps://www.forbes.com/sites/kateoflahertyuk/2021/06/20/new-iphone-bug-breaks-your-wifiheres-the-fix\n\nThe original tweet suggests that this wifid bug could permanently disable iPhone’s WiFi\nfunctionality, as well as the Hotspot feature. This “WiFi” Denial of Service (DoS) is happening\nsince wifid writes known wifi SSID into the following three files on the disk:\n\n/var/preferences/com.apple.wifi.known-networks.plist\n/var/preferences/SystemConfiguration/com.apple.wifi-networks.plist.backup\n/var/preferences/SystemConfiguration/com.apple.wifi-private-mac-networks.plist\n\nEvery time that wifid respawns, it reads the bad SSID from a file and crashes again. Even a\nreboot cannot fix this issue.\n\nHowever, this bug can be “fixed” by taking the following steps according to Forbes:\n\n“The fix is simple: Simply reset your network settings by going to Settings > General > Reset\n\n- Reset Network Settings.”\n\nThis bug currently affects the latest iOS 14.6, and Apple has not yet released any fixes for\nthis bug.\n\n## Further Analysis Claims: This is Only a Denial of Service\n\nFollowed by another researcher Zhi @CodeColorist published a quick analysis.\n\n[https://blog.chichou.me/2021/06/20/quick-analysis-wifid/](https://blog.chichou.me/2021/06/20/quick-analysis-wifid/)\n\nHis conclusion was:\n\n“For the exploitability, it doesn’t echo and the rest of the parameters don’t seem like\n**to be controllable. Thus I don’t think this case is exploitable.**\n\nAfter all, to trigger this bug, you need to connect to that WiFi, where the SSID is visible\nto the victim. A phishing Wi-Fi portal page might as well be more effective.”\n\n## The Plot Thickens\n\nWe checked [ZecOps Mobile Threat Intelligence to see if this bug was exploited in the past.](https://www.zecops.com/)\nWe noticed that two of our EMEA users had an event related to this bug. Noteworthy, we\nonly have access to our cloud data, and couldn’t check other on-premises clients – so we\nmight be missing other events.\n\nWe asked ourselves:\n\n\n-----\n\n1. Why would a person aware of dangerous threats connect to a network with such an\n\nodd name “%s%s…”. – Unlikely.\n2. Why would an attacker bring a tactical team to target a VIP, only to cause DoS – It still\n\ndoes not make sense.\n\n## Remotely exploitable, 0-click, under the hood!\n\nFurther analysis revealed that:\n\n1. Attackers did not need to force the user to connect. This vulnerability could be\n\nlaunched as a 0click, without any user interaction. A victim only needed to have your\n**WiFi turned on to trigger the vulnerable code.**\n2. This is not a DoS, but an actual RCE vulnerability for both the recently patched 0-click\n\nformat-strings vulnerability, and the malicious SSID format-strings 0-day vulnerability.\n\n[This 0-click bug was patched on iOS 14.4 and credits “an anonymous researcher” for](https://support.apple.com/en-us/HT212146)\nassisting. Although this is a potent 0-click bug, a CVE was not assigned.\n\n## Technical Details: Analysis of a Zero-Click WiFi Vulnerability – WiFiDemon\n\nLet’s do a deeper dive into the technical details behind this vulnerability:\n\nConsidering the possible impact of triggering this vulnerability as a 0-click, as well as the\npotential RCE implications, we investigated the wifid vulnerability in depth.\n\nWhen we tested this format-strings bug on an older version, similar to our clients, we noticed\nthat wifid has intriguing logs when it is not connected to any wifi.\n\n\n-----\n\nThese logs contain SSID, which indicates that it may be affected by the same format string\nbug.\n\nWe tested it and Voilà, it is affected by the same format string bug – meaning that this is a\nzero-click vulnerability and can be triggered without an end-user connecting to a strange\nnamed wifi.\n\nThis log is related to a common smart device behavior: Automatically scan and join known\nnetworks.\n\n## Zero-Click – Even When The Screen is Off\n\nThe iPhone scans WiFi to join every ~3 seconds while the user is actively using the phone.\nFurthermore, even if the user’s phone screen has been turned off, it still scans for WiFi but at\na relatively lower frequency. The waiting time for the following scan will be longer and longer,\nfrom ~10 seconds to 1+ minute.\n\nAs long as the WiFi is turned on this vulnerability can be triggered. If the user is connected to\nan existing WiFi network, an attacker can launch another attack to disconnect/de-associate\nthe device and then launch this 0-click attack. Disconnecting a device from a WiFi is welldocumented and we’ll not cover it as part of the scope for this blog.\n\nThis 0-click vulnerability is powerful: if the malicious access point has password protection\nand the user never joins the wifi, nothing will be saved to the disk. After turning off the\nmalicious access point, the user’s WIFI function will be normal. A user could hardly notice if\nthey have been attacked.\n\n## Exploiting this Vulnerability\n\nWe further analyzed whether this vulnerability can be exploited, and how:\n\n\n-----\n\nThis post assumes that the reader is aware of the concept of format-string bugs and how to\nexploit them. However, this bug is slightly different from the “traditional” printf format string\nbugs because it uses [NSString stringWithFormat:] which was implemented by Apple, and\nApple removed the support for %n for security reasons. That’s how an attacker would have\nbeen able to write to the memory in an exploitation of a traditional format string bug.\n\n## Where You AT? – %@ Is Handy!\n\nSince we cannot use %n, we looked for another way to exploit this 0-click N-Day, as well as\nthe 1-click 0-day wifid bug. Another possible use is %@, which is uniquely used by\nObjective-C.\n\nSince the SSID length is limited to 32 bytes, we can only put up to 16 Escape characters in a\nsingle SSID. Then the Escape characters we placed will process the corresponding data on\nthe stack.\n\nA potential exploit opportunity is if we can find an object that has been released on the stack,\nin that case, we can find a spray method to control the content of that memory and then use\n**%@ to treat it as an Objective-C object, like a typical Use-After-Free that could lead to code**\nexecution.\n\n## Step 1: Find Possible Spraying Opportunities on the Stack\n\nFirst, we need to design an automatic method to detect whether it is possible to tweak the\ndata on the stack. lldb breakpoint handling script perfectly fits that purpose. Set a breakpoint\nright before the format string bug and link to a lldb script that will automatically scan and\nobserve changes in the stack.\n\n\n-----\n\n## Step 2: Find an Efficient Spraying Method\n\nThen we need a spray method that can interfere with wifid’s memory over the air.\n\nAn interesting strategy is called Beacon Flooding Attack. It broadcasts countless Beacon\nframes and results in many access points appearing on the victim’s device.\n\nTo perform a beacon flooding attack, you need a wireless Dongle that costs around $10 and\na Linux VM. Install the corresponding dongle firmware and a tool called mdk3. For details,\n[please refer to this article.](https://medium.com/infosec-adventures/beacon-flooding-attack-a4baadc2242b)\n\n\n-----\n\nAs part of the beacon frame mandatory field, SSID can store a string of up to 32 bytes. wifid\nassigns a string object for each detected SSID. You can observe that from the log. This is the\nmost obvious thing we can use for spray\n\n\n-----\n\nNow attach a debugger to wifid and start flooding the device with a list of SSIDs that can be\neasily recognized. Turn on the iOS wifi feature and wait until it begins automatically scanning\nfor available WiFi. The breakpoint will get triggered and check through the stack to find\ntraces of spray. Below is the output of the lldb script:\n\nThe thing that caught our eye is the pointer stored at stack + offset 0x18. Since the SSID can\nstore up to 32 bytes, the shortest format string escape character such as %x will occupy two\nbytes, which means that we can reach the range of 16 pointers stored on the stack with a\nsingle SSID at most. So stack + offset 0x18 could be reached by the fourth escape\ncharacter. And the test results tell us that data at this offset could be controlled by the\ncontent we spray.\n\n\n-----\n\n## Step 3 – Test the Ability to Remotely Control the Code Execution Flow\n\nSo in the next test, we kept the Beacon Flooding Attack running, meanwhile we built a\nhotspot named “DDDD%x%x%x%@”. Notice that %@ is the fourth escape character.\nUnsurprisingly, wifid crashes as soon as it reads the name, and it automatically respawns\nand crashes again as long as the hotspot is still on.\n\nChecking the crash, it appears that the x15 register is easily affected.\n\nNow analyze where it crashed. As the effect of %@ format specifier, it’s trying to print\nObjective-C Object.\n\n\n-----\n\nThe code block highlighted in yellow is the desired code execution flow. x0 is the pointer\nstored at stack + offset 0x18. We try to control its content through the spray and lead the\nsituation to the typical Use-After-Free scenario. x9 is the data x0 points to. It represents isa\npointer, which is the first member of the objc object data structure. As you can see in the\nfigure, control x9 is critical to reaching that objc_msgSend call at the bottom. With more\ntests, we confirmed that stack + offset 0x18 indeed can be affected by the spray.\n\nNow things have become more familiar. Pass a controlled/fake Objc object to\n**objc_msgSend to achieve arbitrary code execution. The next challenge is finding a way to**\nspray memory filled with ROP/JOP payload.\n\n\n-----\n\n## Step 4 – Achieving Remote Code Execution\n\nwifid deals with a lot of wireless features. Spraying large memory wirelessly is left as an\nexercise for the reader. Locally, this bug can be used to build a partial sandbox escape to\nhelp achieve jailbreaking.\n\n## Attacks-In-The-Wild?\n\nIronically, the events that triggered our interest in this vulnerability were not related to an\nattack and the two devices were only subject to a denial of service issue that was fixed on\niOS 14.6.\n\nHowever, since this vulnerability was widely published, and relatively easy to notice, we are\nhighly confident that various threat actors have discovered the same information we did, and\nwe would like to encourage an issuance of a patch as soon as possible.\n\nZecOps Mobile EDR Customers will identify attacks leveraging these vulnerabilities with the\ntag “WiFiDemon”.\n\n## Generating an Alert Using ZecOps Mobile EDR\n\nWe have added generic rules for detection of successful exploitation to our customers.\n\nWe also provided instructions to customers on how to create a rule to see failed spraying /\nASLR bypass attempts.\n\n## To summarize:\n\nA related vulnerability was exploitable as a 0-click until iOS 14.4. CVE was not\nassigned and the vulnerability was silently patched. The patch thanks an anonymous\nresearcher.\nThe publicly announced WiFi vulnerability is exploitable on 14.6 when connecting a\nmaliciously crafted SSID.\nWe highly recommend issuing a patch for this vulnerability.\nOlder devices: e.g. iPhone 5s are still on iOS 12.X which is not vulnerable to the 0-click\nvulnerability.\n\n[If you’d like to check your phone and monitor it – feel free to reach out to us here to discuss](https://www.zecops.com/contact/free-trial)\n[how we can help you increase your mobile visibility using ZecOps Mobile EDR.](https://www.zecops.com/our-solution)\n\n[We would like to thank @08tc3wbb (follow),](https://twitter.com/08tc3wbb) [@ihackbanme (follow) and SYMaster for assisting](https://www.twitter.com/ihackbanme)\nwith this blog.\n\n## iOS 14.7 fix\n\n\n-----\n\nThe fix on iOS 14.7 is as follows, it s pretty straightforward, adding %s as format-string and\nthe SSID included string as a parameter solves the issue.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-17 - Meet WiFiDemon – iOS WiFi RCE 0-Day Vulnerability, and a Zero-Click Vulnerability That Was Silently Patched.pdf"
    ],
    "report_names": [
        "2021-07-17 - Meet WiFiDemon – iOS WiFi RCE 0-Day Vulnerability, and a Zero-Click Vulnerability That Was Silently Patched.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1673536018,
    "ts_updated_at": 1743041321,
    "ts_creation_date": 1653779610,
    "ts_modification_date": 1653779610,
    "files": {
        "pdf": "https://archive.orkl.eu/2dea1a513bb89b2b9916c200f57d00a282618c12.pdf",
        "text": "https://archive.orkl.eu/2dea1a513bb89b2b9916c200f57d00a282618c12.txt",
        "img": "https://archive.orkl.eu/2dea1a513bb89b2b9916c200f57d00a282618c12.jpg"
    }
}