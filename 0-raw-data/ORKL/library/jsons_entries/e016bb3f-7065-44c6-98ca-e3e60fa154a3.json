{
    "id": "e016bb3f-7065-44c6-98ca-e3e60fa154a3",
    "created_at": "2023-01-12T15:05:54.482Z",
    "updated_at": "2025-03-27T02:14:02.775641Z",
    "deleted_at": null,
    "sha1_hash": "b1125c19d968120d65d1b6e12b35edf7fa527a22",
    "title": "2019-05-29 - HiddenWasp Malware Stings Targeted Linux Systems",
    "authors": "",
    "file_creation_date": "2022-05-28T19:04:52Z",
    "file_modification_date": "2022-05-28T19:04:52Z",
    "file_size": 3413740,
    "plain_text": "# HiddenWasp Malware Stings Targeted Linux Systems\n\n**[intezer.com/blog-hiddenwasp-malware-targeting-linux-systems/](https://www.intezer.com/blog-hiddenwasp-malware-targeting-linux-systems/)**\n\nMay 29, 2019\n\nWritten by Ignacio Sanmillan - 29 May 2019\n\n## Get Free Account\n\nJoin Now\n\n## Top Blogs\n\n**[How to Write YARA Rules That Minimize False Positives](https://www.intezer.com/blog/threat-hunting/yara-rules-minimize-false-positives/)**\n\nGenerate Advanced YARA Rules Based on Code Reuse Incorporating YARA into daily\nsecurity operations can... [Read more](https://www.intezer.com/blog/threat-hunting/yara-rules-minimize-false-positives/)\n\n**[Boost Your SOC Skills: How to Detect Good Apps Gone Bad](https://www.intezer.com/blog/malware-analysis/how-to-detect-legitimate-apps-used-by-attackers/)**\n\nThreat actors have a wide range of tools and techniques they can use in cyber... [Read more](https://www.intezer.com/blog/malware-analysis/how-to-detect-legitimate-apps-used-by-attackers/)\n\n\n-----\n\n**[TeamTNT Cryptomining Explosion üß®](https://www.intezer.com/blog/malware-analysis/teamtnt-cryptomining-explosion/)**\n\nThis post was originally published as a white paper in September 2021. Get the full... Read\nmore\n\n**Overview**\n\n**‚Ä¢ Intezer has discovered a new, sophisticated malware that we have named ‚ÄúHiddenWasp‚Äù,**\ntargeting Linux systems.\n\n**‚Ä¢ The malware is still active and has a zero-detection rate in all major anti-virus systems.**\n\n**[‚Ä¢ Unlike common Linux malware, HiddenWasp is not focused on crypto-mining or DDoS](https://www.intezer.com/blog/linux/elf-malware-analysis-101-linux-threats-no-longer-an-afterthought/)**\nactivity. It is a trojan purely used for targeted remote control.\n\n**‚Ä¢ Evidence shows in high probability that the malware is used in targeted attacks for victims**\nwho are already under the attacker‚Äôs control, or have gone through a heavy\nreconnaissance.\n\n**‚Ä¢ HiddenWasp authors have adopted a large amount of code from various publicly available**\nopen-source malware, such as Mirai and the Azazel rootkit. In addition, there are some\nsimilarities between this malware and other Chinese malware families, however the\nattribution is made with low confidence.\n\n**‚Ä¢ We have detailed our recommendations for preventing** **and** **responding** **to this threat.**\n\n**1. Introduction**\n\nAlthough the Linux threat ecosystem is crowded with IoT DDoS botnets and crypto-mining\nmalware, it is not very common to spot trojans or backdoors in the wild.\n\nUnlike Windows malware, Linux malware authors do not seem to invest too much effort\nwriting their implants. In an open-source ecosystem there is a high ratio of publicly available\ncode that can be copied and adapted by attackers.\n\nIn addition, Anti-Virus solutions for Linux tend to not be as resilient as in other platforms.\nTherefore, threat actors targeting Linux systems are less concerned about implementing\nexcessive evasion techniques since even when reusing extensive amounts of code, threats\ncan relatively manage to stay under the radar.\n\nNevertheless, malware with strong evasion techniques do exist for the Linux platform.\nThere is also a high ratio of publicly available open-source malware that utilize strong\nevasion techniques and can be easily adapted by attackers.\n\nWe believe this fact is alarming for the security community since many implants today have\nvery low detection rates, making these threats difficult to detect and respond to.\n\n\n-----\n\nWe have discovered further undetected Linux malware that appear to be enforcing\nadvanced evasion techniques with the use of rootkits to leverage trojan-based implants.\n\nIn this blog we will present a technical analysis of each of the different components that\nthis new malware, HiddenWasp, is composed of. We will also highlight interesting codereuse connections that we have observed to several open-source malware.\n\nThe following images are screenshots from VirusTotal of the newer undetected malware\nsamples discovered:\n\n**2. Technical Analysis**\n\nWhen we came across these samples we noticed that the majority of their code was\nunique:\n\n\n-----\n\n[Similar to the recent Winnti Linux variants reported by Chronicle, the infrastructure of this](https://medium.com/chronicle-blog/winnti-more-than-just-windows-and-gates-e4f03436031a)\nmalware is composed of a user-mode rootkit, a trojan and an initial deployment script. We\nwill cover each of the three components in this post, analyzing them and their interactions\nwith one another.\n\n**2.1 Initial Deployment Script:**\n\nWhen we spotted these undetected files in VirusTotal it seemed that among the uploaded\nartifacts there was a bash script along with a trojan implant binary.\n\nWe observed that these files were uploaded to VirusTotal using a path containing the name\nof a Chinese-based forensics company known as Shen Zhou Wang Yun Information\nTechnology Co., Ltd.\n\nFurthermore, the malware implants seem to be hosted in servers from a physical server\nhosting company known as ThinkDream located in Hong Kong.\n\n\n-----\n\nAmong the uploaded files, we observed that one of the files was a bash script meant to\ndeploy the malware itself into a given compromised system, although it appears to be for\ntesting purposes:\n\n\n-----\n\nThanks to this file we were able to download further artifacts not present in VirusTotal\nrelated to this campaign. This script will start by defining a set of variables that would be\nused throughout the script.\n\nAmong these variables we can spot the credentials of a user named ‚Äòsftp‚Äô, including its\nhardcoded password. This user seems to be created as a means to provide initial\npersistence to the compromised system:\n\nFurthermore, after the system‚Äôs user account has been created, the script proceeds to clean\nthe system as a means to update older variants if the system was already compromised:\n\n\n-----\n\nThe script will then proceed to download a tar compressed archive from a download server\naccording to the architecture of the compromised system. This tarball will contain all of the\ncomponents from the malware, containing the rootkit, the trojan and an initial deployment\nscript:\n\n\n-----\n\nAfter malware components have been installed, the script will then proceed to execute the\ntrojan:\n\n\n-----\n\nWe can see that the main trojan binary is executed, the rootkit is added to LD_PRELOAD\npath and another series of environment variables are set such as the ‚ÄòI_AM_HIDDEN‚Äô. We\nwill cover throughout this post what the role of this environment variable is. To finalize, the\nscript attempts to install reboot persistence for the trojan binary by adding it to /etc/rc.local.\n\nWithin this script we were able to observe that the main implants were downloaded in the\nform of tarballs. As previously mentioned, each tarball contains the main trojan, the rootkit\nand a deployment script for x86 and x86_64 builds accordingly.\n\nThe deployment script has interesting insights of further features that the malware\nimplements, such as the introduction of a new environment variable ‚ÄòHIDE_THIS_SHELL‚Äô:\n\n\n-----\n\nWe found some of the environment variables used in a open-source rootkit known as\n[Azazel.](https://github.com/chokepoint/azazel/search?q=HIDE_THIS_SHELL&unscoped_q=HIDE_THIS_SHELL)\n\nIt seems that this actor changed the default environment variable from Azazel, that one\nbeing HIDE_THIS_SHELL for I_AM_HIDDEN. We have based this conclusion on the fact\nthat the environment variable HIDE_THIS_SHELL was not used throughout the rest of the\ncomponents of the malware and it seems to be residual remains from Azazel original code.\n\nThe majority of the code from the rootkit implants involved in this malware infrastructure are\nnoticeably different from the original Azazel project. Winnti Linux variants are also known to\nhave reused code from this open-source project.\n\n**2.2 The Rootkit:**\n\nThe rootkit is a user-space based rootkit enforced via LD_PRELOAD linux mechanism.\n\nIt is delivered in the form of an ET_DYN stripped ELF binary.\n\nThis shared object has an DT_INIT dynamic entry. The value held by this entry is an\naddress that will be executed once the shared object gets loaded by a given process:\n\n\n-----\n\nWithin this function we can see that eventually control flow falls into a function in charge to\nresolve a set of dynamic imports, which are the functions it will later hook, alongside with\ndecoding a series of strings needed for the rootkit operations.\n\n\n-----\n\nWe can see that for each string it allocates a new dynamic buffer, it copies the string to it to\nthen decode it.\n\nIt seems that the implementation for dynamic import resolution slightly varies in comparison\n[to the one used in Azazel rootkit.](https://github.com/chokepoint/azazel/blob/master/config.py)\n\nWhen we wrote the script to simulate the cipher that implements the string decoding\nfunction we observed the following algorithm:\n\n\n-----\n\n[We recognized that a similar algorithm to the one above was used in the past by Mirai,](https://github.com/jgamblin/Mirai-Source-Code/blob/master/mirai/bot/scanner.c#L963)\nimplying that authors behind this rootkit may have ported and modified some code from\nMirai.\n\nAfter the rootkit main object has been loaded into the address space of a given process and\nhas decrypted its strings, it will export the functions that are intended to be hooked. We can\nsee these exports to be the following:\n\n\n-----\n\nFor every given export, the rootkit will hook and implement a specific operation accordingly,\nalthough they all have a similar layout. Before the original hooked function is called, it is\nchecked whether the environment variable ‚ÄòI_AM_HIDDEN‚Äô is set:\n\n\n-----\n\nWe can see an example of how the rootkit hooks the function fopen in the following\nscreenshot:\n\n\n-----\n\nWe have observed that after checking whether the ‚ÄòI_AM_HIDDEN‚Äô environment variable is\nset, it then runs a function to hide all the rootkits‚Äô and trojans‚Äô artifacts. In addition,\nspecifically to the fopen function it will also check whether the file to open is ‚Äò/proc/net/tcp‚Äô\nand if it is it will attempt to hide the malware‚Äôs connection to the cnc by scanning every entry\nfor the destination or source ports used to communicate with the cnc, in this case 61061.\n[This is also the default port in Azazel rootkit.](https://github.com/chokepoint/azazel/blob/master/config.py)\n\n\n-----\n\nThe rootkit primarily implements artifact hiding mechanisms as well as tcp connection hiding\nas previously mentioned. Overall functionality of the rootkit can be illustrated in the following\ndiagram:\n\n\n-----\n\n**2.3 The Trojan:**\n\nThe trojan comes in the form of a statically linked ELF binary linked with stdlibc++. We\nnoticed that the trojan has code connections with ChinaZ‚Äôs Elknot implant in regards to\nsome common MD5 implementation in one of the statically linked libraries it was linked with:\n\n\n-----\n\nIn addition, we also see a high rate of shared strings with other known ChinaZ malware,\nreinforcing the possibility that actors behind HiddenWasp may have integrated and modified\nsome MD5 implementation from Elknot that could have been shared in Chinese hacking\nforums:\n\n\n-----\n\nWhen we analyze the main we noticed that the first action the trojan takes is to retrieve its\nconfiguration:\n\n\n-----\n\nThe malware configuration is appended at the end of the file and has the following\nstructure:\n\n\n-----\n\nThe malware will try to load itself from the disk and parse this blob to then retrieve the static\nencrypted configuration.\n\n\n-----\n\nOnce encryption configuration has been successfully retrieved the configuration will be\ndecoded and then parsed as json.\n\nThe cipher used to encode and decode the configuration is the following:\n\n\n-----\n\nThis cipher seems to be an RC4 alike algorithm with an already computed PRGA generated\nkey-stream. It is important to note that this same cipher is used later on in the network\ncommunication protocol between trojan clients and their CNCs.\n\nAfter the configuration is decoded the following json will be retrieved:\n\nMoreover, if the file is running as root, the malware will attempt to change the default\nlocation of the dynamic linker‚Äôs LD_PRELOAD path. This location is usually at\n/etc/ld.so.preload, however there is always a possibility to patch the dynamic linker binary to\nchange this path:\n\n\n-----\n\nPatch_ld function will scan for any existent /lib paths. The scanned paths are the following:\n\nThe malware will attempt to find the dynamic linker binary within these paths. The dynamic\nlinker filename is usually prefixed with ld-<version number>.\n\n\n-----\n\nOnce the dynamic linker is located, the malware will find the offset where the\n/etc/ld.so.preload string is located within the binary and will overwrite it with the path of the\nnew target preload path, that one being /sbin/.ifup-local.\n\nTo achieve this patching it will execute the following formatted string by using the xxd hex\neditor utility by previously having encoded the path of the rootkit in hex:\n\nOnce it has changed the default LD_PRELOAD path from the dynamic linker it will deploy a\nthread to enforce that the rootkit is successfully installed using the new LD_PRELOAD path.\nIn addition, the trojan will communicate with the rootkit via the environment variable\n\n\n-----\n\nI_AM_HIDDEN to serialize the trojan s session for the rootkit to apply evasion mechanisms\non any other sessions.\n\nAfter seeing the rootkit‚Äôs functionality, we can understand that the rootkit and trojan work\ntogether in order to help each other to remain persistent in the system, having the rootkit\nattempting to hide the trojan and the trojan enforcing the rootkit to remain operational. The\nfollowing diagram illustrates this relationship:\n\n\n-----\n\nContinuing with the execution flow of the trojan, a series of functions are executed to\nenforce evasion of some artifacts:\n\nThese artifacts are the following:\n\nBy performing some OSINT regarding these artifact names, we found that they belong to a\n[Chinese open-source rootkit for Linux known as Adore-ng hosted in GitHub:](https://github.com/yaoyumeng/adore-ng)\n\n\n-----\n\nThe fact that these artifacts are being searched for suggests that potentially targeted Linux\nsystems by these implants may have already been compromised with some variant of this\nopen-source rootkit as an additional artifact in this malware‚Äôs infrastructure. Although those\npaths are being searched for in order to hide their presence in the system, it is important to\nnote that none of the analyzed artifacts related to this malware are installed in such paths.\n\nThis finding may imply that the target systems this malware is aiming to intrude may be\nalready known compromised targets by the same group or a third party that may be\ncollaborating with the same end goal of this particular campaign.\n\nMoreover, the trojan communicated with a simple network protocol over TCP. We can see\nthat when connection is established to the Master or Stand-By servers there is a handshake\nmechanism involved in order to identify the client.\n\n\n-----\n\nWith the help of this function we where able to understand the structure of the\ncommunication protocol employed. We can illustrate the structure of this communication\nprotocol by looking at a pcap of the initial handshake between the server and client:\n\n\n-----\n\nWe noticed while analyzing this protocol that the Reserved and Method fields are always\nconstant, those being 0 and 1 accordingly. The cipher table offset represents the offset in\nthe hardcoded key-stream that the encrypted payload was encoded with. The following is\nthe fixed keystream this field makes reference to:\n\nAfter decrypting the traffic and analyzing some of the network related functions of the trojan,\nwe noticed that the communication protocol is also implemented in json format. To show\nthis, the following image is the decrypted handshake packets between the CNC and the\ntrojan:\n\nAfter the handshake is completed, the trojan will proceed to handle CNC requests:\n\n\n-----\n\nDepending on the given requests the malware will perform different operations accordingly.\nAn overview of the trojan‚Äôs functionalities performed by request handling are shown below:\n\n**2.3. Prevention and Response**\n\n**Prevention: Block Command-and-Control IP addresses detailed in the IOCs section.**\n\n**[Response: We have provided a YARA rule intended to be run against in-memory artifacts](https://github.com/intezer/yara-rules/blob/master/HiddenWasp.yar)**\nin order to be able to detect these implants.\n\nIn addition, in order to check if your system is infected, you can search for ‚Äúld.so‚Äù files ‚Äî if\nany of the files do not contain the string ‚Äò/etc/ld.so.preload‚Äô, your system may be\ncompromised. This is because the trojan implant will attempt to patch instances of ld.so in\norder to enforce the LD_PRELOAD mechanism from arbitrary locations.\n\n**4. Summary**\n\nWe analyzed every component of HiddenWasp explaining how the rootkit and trojan\nimplants work in parallel with each other in order to enforce persistence in the system\n\n\n-----\n\nWe have also covered how the different components of HiddenWasp have adapted pieces\nof code from various open-source projects. Nevertheless, these implants managed to\nremain undetected.\n\nLinux malware may introduce new challenges for the security community that we have not\nyet seen in other platforms. The fact that this malware manages to stay under the radar\nshould be a wake up call for the security industry to allocate greater efforts or resources to\ndetect these threats.\n\nLinux malware will continue to become more complex over time and currently even\ncommon threats do not have high detection rates, while more sophisticated threats have\neven lower visibility.\n\n**IOCs**\n\n103.206.123[.]13\n103.206.122[.]245\nhttp://103.206.123[.]13:8080/system.tar.gz\nhttp://103.206.123[.]13:8080/configUpdate.tar.gz\nhttp://103.206.123[.]13:8080/configUpdate-32.tar.gz\ne9e2e84ed423bfc8e82eb434cede5c9568ab44e7af410a85e5d5eb24b1e622e3\nf321685342fa373c33eb9479176a086a1c56c90a1826a0aef3450809ffc01e5d\nd66bbbccd19587e67632585d0ac944e34e4d5fa2b9f3bb3f900f517c7bbf518b\n0fe1248ecab199bee383cef69f2de77d33b269ad1664127b366a4e745b1199c8\n2ea291aeb0905c31716fe5e39ff111724a3c461e3029830d2bfa77c1b3656fc0\nd596acc70426a16760a2b2cc78ca2cc65c5a23bb79316627c0b2e16489bf86c0\n609bbf4ccc2cb0fcbe0d5891eea7d97a05a0b29431c468bf3badd83fc4414578\n8e3b92e49447a67ed32b3afadbc24c51975ff22acbd0cf8090b078c0a4a7b53d\nf38ab11c28e944536e00ca14954df5f4d08c1222811fef49baded5009bbbc9a2\n8914fd1cfade5059e626be90f18972ec963bbed75101c7fbf4a88a6da2bc671b\n\n**Ignacio Sanmillan**\nNacho is a security researcher specializing in reverse engineering and malware analysis.\nNacho plays a key role in Intezer\\'s malware hunting and investigation operations, analyzing\nand documenting new undetected threats. Some of his latest research involves detecting\nnew Linux malware and finding links between different threat actors. Nacho is an adept ELF\nresearcher, having written numerous papers and conducting projects implementing state-ofthe-art obfuscation and anti-analysis techniques in the ELF file format.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2019/2019-05-29 - HiddenWasp Malware Stings Targeted Linux Systems.pdf"
    ],
    "report_names": [
        "2019-05-29 - HiddenWasp Malware Stings Targeted Linux Systems.pdf"
    ],
    "threat_actors": [
        {
            "id": "f809bfcb-b200-4988-80a8-be78ef6a52ef",
            "created_at": "2023-01-06T13:46:39.186988Z",
            "updated_at": "2025-03-27T02:00:03.016358Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "Adept Libra"
            ],
            "source_name": "MISPGALAXY:TeamTNT",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "c3ca592f-0669-49bd-ab5c-310007ab2fb4",
            "created_at": "2022-10-25T15:50:23.334495Z",
            "updated_at": "2025-03-27T02:00:55.445098Z",
            "deleted_at": null,
            "main_name": "TeamTNT",
            "aliases": [
                "TeamTNT"
            ],
            "source_name": "MITRE:TeamTNT",
            "tools": [
                "Peirates",
                "MimiPenguin",
                "LaZagne",
                "Hildegard"
            ],
            "source_id": "MITRE",
            "reports": null
        },
        {
            "id": "4c68ccd0-caba-4189-9ead-86ac4c2d9b70",
            "created_at": "2024-05-01T02:03:07.930196Z",
            "updated_at": "2025-03-27T02:05:17.251237Z",
            "deleted_at": null,
            "main_name": "BRONZE ATLAS",
            "aliases": [
                "Axiom",
                "BARIUM ",
                "Blackfly ",
                "CTG-2633",
                "GREF",
                "Group 72 ",
                "Red Kelpie ",
                "TG-2633 ",
                "Wicked Panda ",
                "Winnti",
                "APT41 "
            ],
            "source_name": "Secureworks:BRONZE ATLAS",
            "tools": [
                " CCleaner v5.33 backdoor",
                " ChinaChopper",
                " Cobalt Strike",
                " Dicey MSDN",
                " ForkPlayground",
                " HUC Proxy Malware (Htran)",
                " Mimikatz",
                " PipeMon",
                " PlugX",
                " PortReuse",
                " Powershell Empire",
                " RCMD",
                " RbDoor",
                " SPEEDBOAT",
                " ShadowPad",
                " Sidewalk",
                " Speculoos",
                " TeamViewer",
                " Winnkit",
                " Winnti",
                " reg save",
                " vssadmin",
                "Acehash"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1673535954,
    "ts_updated_at": 1743041642,
    "ts_creation_date": 1653764692,
    "ts_modification_date": 1653764692,
    "files": {
        "pdf": "https://archive.orkl.eu/b1125c19d968120d65d1b6e12b35edf7fa527a22.pdf",
        "text": "https://archive.orkl.eu/b1125c19d968120d65d1b6e12b35edf7fa527a22.txt",
        "img": "https://archive.orkl.eu/b1125c19d968120d65d1b6e12b35edf7fa527a22.jpg"
    }
}