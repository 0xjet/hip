{
    "id": "e3af5a25-5a7c-404d-9e6d-f2884b2a6b82",
    "created_at": "2023-01-12T15:01:53.822504Z",
    "updated_at": "2025-03-27T02:05:42.928929Z",
    "deleted_at": null,
    "sha1_hash": "8a746bec6cf6b5aa0e7ca5046e166afed4b77027",
    "title": "2021-07-14 - XLS Entanglement",
    "authors": "",
    "file_creation_date": "2022-05-28T02:47:38Z",
    "file_modification_date": "2022-05-28T02:47:38Z",
    "file_size": 1365578,
    "plain_text": "# XLS Entanglement - BC Security\n\n**bc-security.org/post/xls-entanglement/**\n\nJuly 14, 2021\n\nVBA tradecraft is constantly evolving and this past winter, I came across some articles from\nAdepts of 0xCC. Specifically, their article Hacking in an Epistolary Way: Implementing\nKerberoast in Pure VBA caught my attention and I wanted to try and see if it would be\npossible to create a pure VBA implementation of a C2 architecture. I developed some\nrudimentary POC that I am going to share here.\n\n## Offensive VBA\n\nFirst, we will go over what makes VBA a somewhat powerful option and then we will discuss\n[a new technique that we are calling XLS entanglement. We are also publishing a whitepaper](https://github.com/BC-SECURITY/Offensive-VBA-and-XLS-Entanglement/blob/main/XLS_Entanglement_Whitepaper.pdf)\nthat goes into more detail about how this attack works.\n\nWhile VBA is an infamously disparaged language by programmers, that does not change the\nfact that it also has many of the capabilities that attackers value in targeting modern\nWindows environments. Specifically, it has access to COM interfaces and can directly\ninterface with the WIN32 API, meaning that most attacks can be reimplemented in pure VBA.\nFor example, the aforementioned Adepts of 0xCC’s kerberoasting implementation. Their\nVBA implementation relies on the use of the Declare function, which allows for VBA to call\n\n\n-----\n\nfunctions from any registered DLL. More importantly, Declare provides access to powerful\nfunctions inside Windows and is a natively included capability for Office products with\n[documentation and examples provided by Microsoft.](https://docs.microsoft.com/en-us/office/client-developer/excel/how-to-access-dlls-in-excel)\n\nIn fact, VBA has nearly every capability that other offensive languages offer, except the ability\nto reflectively load code. Reflection is a key method allowing attackers to create modularized\ncode that can be retrieved remotely and executed without the need to send it all at\nonce. Without the ability to do this, VBA would be extremely limited as an offensive\nlanguage. Fortunately, there is a workaround to create pseudo-reflection by exposing the\nVBA project and dynamically adding modules.\n\n_Note: Outlook is a notable exception as the only Office application that does not allow access_\n_to the VBA project._\n\nBelow shows how after exposing the VBA project, we could read a string from a cell and then\nexecute it.\n\nThere is one major limitation of this method, there a registry key that must be modified in\norder to access the VBA project. HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Office\\\n_<version>\\<product>\\Security\\AccessVBOM_\n\nThis registry key must be set to 1 for the pseudo-reflection method to work. This is a\nuserland key, so it may be edited without elevated privileges but is a detection chokepoint\nthat can be easily monitored. Microsoft has also prevented a macro project from being able\nto modify this key for itself. For example, if an Excel project were to run a macro to modify\n\n\n-----\n\nthis key, the Excel project would still be unable to modify itself. One potential solution for this\nwould be to use SendKeys to move through the menus and manually turn this off. But that\nwould be incredibly obvious to the user and SendKeys is not the most reliable. However, it\nturns out that as long as the process that changes the registry key is not a child process of\nour Office product, then we can edit the registry, which includes other office products! So a\nWord document can edit the registry key for Excel and vice versa.\n\nAs a result, we have some interesting tradecraft available to us because Office products can\nalso launch other Office products and add modules to them. This includes opening the Office\nproduct in a hidden window. Here is an example of modifying a registry key and then running\nHello world as a pop-up.\n\nThe [GitHub repo that is being published today contains an interesting use case on how this](https://github.com/BC-SECURITY/Offensive-VBA-and-XLS-Entanglement)\nenables us to turn Outlook into a functioning C2, while only requiring us to launch Excel or\nWord to execute arbitrary code. We no longer need to launch PowerShell or cmd.exe and\ndon’t have to wait for our beacons to reach back to us, as we can simply send an email to\n[execute our payload. The whitepaper contains more information on how this would work. But](https://github.com/BC-SECURITY/Offensive-VBA-and-XLS-Entanglement/blob/main/XLS_Entanglement_Whitepaper.pdf)\nfor this blog post, I want to focus on a new technique that we are calling XLS Entanglement.\n\n## XLS Entanglement\n\nXLS Entanglement is a novel technique in which a malicious macro-enabled Excel document\ncan be hosted in OneDrive and be used to execute arbitrary dynamic VBA code on a paired\nmachine. This attack effectively allows the Excel document to host a rudimentary C2. It gets\nthe Entanglement name from the fact that all the attacker updates are immediately reflected\non the victim’s computer. There is no need to run any additional architecture or spawn any\nother processes once the document has been opened and looks something like below.\n\n\n-----\n\nThis attack abuses the collaborative co-authoring ability of OneDrive or SharePoint hosted\ndocuments. Microsoft was seemingly aware of the potential abuse for this and explicitly\ndisabled co-authoring for macro-enabled Word and PowerPoint documents. However, that is\nnot true for Excel documents. Microsoft has made some efforts to prevent this from being\nabused by blocking many of the common event triggers that are used offensively. For\nexample, timing triggers that use Application.ontime are blocked from execution and\nchanges initiated by a different user will not cause change event triggers to execute. This\nrequires the use of an alternative trigger, and in this case, we create a “Listener” by using a\nnon-blocking loop that monitors a cell in the Excel document waiting for a change.\n\nEntanglement Listener Macro\n\n\n-----\n\nThis remote trigger grants the ability to arbitrarily execute a macro on-demand, but does not\nprovide many advantages compared to standard auto-execution attacks. Instead, a better\noption would be to not only trigger a macro, but arbitrarily update the code as well. Since the\nvictim already has a collaboratively edited document, the preferred place to start is by simply\nediting the code in the macros already in the document. However, Microsoft has intentionally\nmade it so that when a remote user updates macro code in real-time, co-authoring is\nstopped and updates are prevented until the local user re-opens the document.\n\nInterestingly enough, using the VBA project as we talked about above does not cause the\ndocument to be locked out in the same way that modifying the code directly does. So using\nthe same injection code from above, we can do something like the code below.\n\nThe result is that once a victim has opened the document, then the attacker would have an\nExcel document interface to the target machine.\n\n\n-----\n\nAt this point, they don’t even need to have Office installed on the computer they are\noperating from. It can be managed entirely from the web-based Office 365 applications. This\nattack does still have to contend with the AccessVBOM registry key restrictions and it would\nalso raise a victim’s eyebrows to see a bunch of code popping up on the screen of the\ndocument they just opened. So they are likely to close the document relatively quickly.\nInstead, we could send the target a phishing document that will update the required registry\nkey and then launch the entangled XLS document. Sounds like a great plan! Right?\n\nThis is where we hit a snag. For some unknown reason OneDrive Personal and OneDrive for\nBusiness are completely incompatible products. In fact, this is one of the most requested\n[features on the Microsoft UseVoice website and Microsoft has said they are considering it.](https://onedrive.uservoice.com/forums/913531-onedrive-sharing-collaboration/suggestions/15040281-sharing-between-onedrive-personal-and-onedrive-for)\n\n\n-----\n\nWhy does this matter? Well, it’s not possible to share documents for co-authoring to random\npeople with OneDrive for Business. The recipient has to be added to the organization’s\naccess list, which involves requesting the person to accept the invitation to join the\norganization. As a result, we have to hope that the target has a personnel account logged on\ntheir computer, or we need a way to log them into an account. The good news is that we can\nautomate the login process through VBA. The bad news (or well good from a defender\nperspective) is that the POC in the repo is unable to hide the login window completely, which\nmeans that we would likely be constrained to waiting for evening time when the user is\n\n\n-----\n\nunlikely to be at their computer and then triggering the login process. This blog is already\n[getting long, so I will refer you back to the whitepaper and GitHub repo for more detailed](https://github.com/BC-SECURITY/Offensive-VBA-and-XLS-Entanglement/blob/main/XLS_Entanglement_Whitepaper.pdf)\nexplanations on the whole process.\n\n## Full-Attack Path\n\nThe workaround to cross between OneDrive for Business and standard OneDrive is to create\na new Excel document that will make the call to open the co-authoring document and drop it\ninto a trusted location for the macros to automatically execute. This has to be done because\nOffice Applications are single-threaded and attempting to open the co-authoring document\nfrom the phishing email will block the macro from automating the login process. Alternatively,\nanother process such as PowerShell could be launched without a child relationship to open\nthe remote Excel document without dropping an excel document to disk but for this POC the\ngoal was to conduct the entire process in VBA.\n\nNow there are several default trusted locations that are user-editable. Two examples of the\nmost commonly used directories are %APPDATA%\\Microsoft\\Excel\\XLSTART and\n**_%APPDATA%\\Microsoft\\Excel\\Templates. Alternatively, you can modify the registry key to_**\nallow for VBA execution from any location.\n\n\n-----\n\nNext, we will want to use Shell to launch the Excel doc as a new process. This will allow us\nto hijack the login sequence without blocking the macro execution. Then once the Excel\nwindow is launched, the script will use SendKeys to send the credentials. This method uses\nthe Win32 API and only requires the use of a OneDrive account. Meaning, a throwaway\naccount can be used for Entanglement and once the victim has been authenticated to the\nmalicious OneDrive account, it will allow for further execution of malicious activities.\n\nNow let’s assemble the entire attack chain:\n\n1. The victim receives a phishing email with a malicious document\n2. Victim launches malicious document\n3. The malicious document creates a new document for XLS Entanglement\n4. The malicious document send login credentials to the XLS Entanglement document\n5. The XLS Entanglement document begins receiving taskings through the C2\n6. The attacker provides malicious commands through their end of the XLS Entanglement\n\nThe proof of concept demonstrates the capability to use VBA and Office products as an endto-end C2, but the XLS Entanglement attack could also be deployed in conjunction with a\ncompromised Azure Persistent Refresh Token (PRT) as outlined in Dirk-jan Mollema’s\n[research. This would significantly simplify deployment as it would be hosted on a OneDrive](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)\nor Sharepoint that all users would already have access to. It would also allow the C2 to be\nentirely deployed within the victim organization’s infrastructure. Co-Authoring represents a\nfascinating attack surface that remains relatively unexplored, partly due to the difficulty of\nsharing with an unknown recipient. As token compromise becomes more explored, there will\nlikely be an increase in these types of attacks.\n\nWritten by: [Hubbl3](https://www.bc-security.org/post/author/hubbl3/)\n\n\n-----\n\nTagged as: [Windows,](https://www.bc-security.org/post/tag/windows/) [xls,](https://www.bc-security.org/post/tag/xls/) [entanglement,](https://www.bc-security.org/post/tag/entanglement/) [office.](https://www.bc-security.org/post/tag/office/)\n\nPrevious post\n\n[Cyber Security Cx01N](https://www.bc-security.org/post/category/cyber-security/)\n\n[Overview of Empire 4.0 and C#](https://www.bc-security.org/post/overview-of-empire-4-0-and-c/)\n\nThe release of Empire 4.0 is just around the corner and we wanted to take some time to\nwalkthrough some of its new features. So what is Empire 4.0? It ...\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2021/2021-07-14 - XLS Entanglement.pdf"
    ],
    "report_names": [
        "2021-07-14 - XLS Entanglement.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535713,
    "ts_updated_at": 1743041142,
    "ts_creation_date": 1653706058,
    "ts_modification_date": 1653706058,
    "files": {
        "pdf": "https://archive.orkl.eu/8a746bec6cf6b5aa0e7ca5046e166afed4b77027.pdf",
        "text": "https://archive.orkl.eu/8a746bec6cf6b5aa0e7ca5046e166afed4b77027.txt",
        "img": "https://archive.orkl.eu/8a746bec6cf6b5aa0e7ca5046e166afed4b77027.jpg"
    }
}