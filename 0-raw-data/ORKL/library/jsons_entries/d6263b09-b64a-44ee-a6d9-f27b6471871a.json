{
    "id": "d6263b09-b64a-44ee-a6d9-f27b6471871a",
    "created_at": "2023-02-02T02:07:34.656579Z",
    "updated_at": "2025-03-27T02:17:14.703192Z",
    "deleted_at": null,
    "sha1_hash": "4a86443c181ea9b0bc2c0112a0d50dc677174a99",
    "title": "2022-12-06 - Deep Dive Into a BackdoorDiplomacy Attack – A Study of an Attacker’s Toolkit",
    "authors": "",
    "file_creation_date": "2023-02-01T07:38:54Z",
    "file_modification_date": "2023-02-01T07:38:54Z",
    "file_size": 590842,
    "plain_text": "# Deep Dive Into a BackdoorDiplomacy Attack – A Study of an Attacker’s Toolkit\n\n**[businessinsights.bitdefender.com/deep-dive-into-a-backdoordiplomacy-attack-a-study-of-an-attackers-toolkit](https://businessinsights.bitdefender.com/deep-dive-into-a-backdoordiplomacy-attack-a-study-of-an-attackers-toolkit)**\n\nMartin Zugec\n\n\n-----\n\nBy **[Martin Zugec\n/ Dec 06, 2022](https://businessinsights.bitdefender.com/author/martin-zugec)**\nA China-linked cyber espionage operation targeting multiple telecom providers in the Middle\nEast was recently discovered by Bitdefender Labs. A wide range of tools were used for this\noperation, both open-source and custom-built. Download the full research paper: \"Cyber[Espionage in the Middle East: Investigating a New BackdoorDiplomacy Threat Actor](https://www.bitdefender.com/blog/labs/backdoor-diplomacy-wields-new-tools-in-fresh-middle-east-campaign)\n[Campaign\" if you want to dive deeper. We attribute this operation to BackdoorDiplomacy, a](https://attack.mitre.org/groups/G0135/)\nknown advanced persistent threat group (APT).\n\nAn [APT is a sustained, sophisticated cyber-attack which employs a complex set of tactics,](https://businessinsights.bitdefender.com/what-is-an-apt?hsLang=en-us)\ntechniques, and procedures. These threat actors are often well-funded, experienced, and\nsponsored (or at least ignored) by the countries they are operating from. While these groups\ntypically target high-value targets, they often leverage smaller companies that are part of the\nsupply chain of their intended target (we wrote about this practice before in the Deep Dive\ninto a Corporate Espionage Operation article).\n\nAside from the level of sophistication, another attribute that defines an ATP attack is the goal\nof remaining undetected for an extended period. Defense evasion used to be one of the\ndefining attributes of APT threat actors, but other groups of threat actors have adopted the\n[same tactic. With the rising popularity of the Ransomware-as-a-Service (RaaS) profit sharing](https://businessinsights.bitdefender.com/what-is-raas-and-why-is-it-so-dangerous?hsLang=en-us)\nmodel, ransomware threat actors require more time to prepare for an attack. Ransomware\naffiliates – those responsible for operationalizing the malware - use this time to collect and\nexfiltrate valuable data or locate information that can help them properly calculate the\nmaximum potential ransom.\n\n\n-----\n\nOne of the most popular techniques used by ransomware affiliates to avoid detection is the\nliving-off-the-land approach. Instead of deploying commodity malware that risks detection by\nmodern prevention security controls, threat actors are using binaries, scripts, or libraries that\nare already on the target system (or can be downloaded without raising suspicion). You can\n[find a list of binaries and their unexpected use for offensive purposes at project LOLBAS.](https://lolbas-project.github.io/)\n\nBut cybersecurity is a never-ending game of cat and mouse. As attackers advance their\ntechniques, businesses around the world continue to adopt effective methods to mitigate the\nlonger dwell time of adversaries such as ransomware affiliates. Businesses are adopting\ndetection and response capabilities, either as a service (MDR) or as a product (XDR).\n[Modern detection and response solutions like Bitdefender XDR (see our demo) are highly](https://youtu.be/ReBDrsyyiSY?t=125)\neffective at detecting and reporting when these benign tools are used for malicious purposes\nby threat actors. While living-off-the-land remains an effective technique for ransomware\naffiliates – especially in environments which lack elementary detection and response\ncapabilities - modern APT threat actors have had to up their game to stay ahead.\n\n_Detection and Response capabilities are now commonly adopted by small and mid-sized_\n_companies. Source: Bitdefender Cybersecurity Posture Survey 2022_\n\nTo counter the rising popularity and effectiveness of detection and response tools, APTs use\nan array of customized attack tools that are designed to avoid detection. Many APT groups\nhave a strong financial foundation with access to professional developers and security\n\n\n-----\n\nconsultants. Some groups are now advancing into developing custom-made tools for\ntargeting ICS/SCADA devices; developing more traditional malware is no challenge for them.\n[As we have seen in the recent “Advanced Threat Protection – Enterprise” evaluation by AV-](http://xn--ivg/?hsLang=en-us)\nComparatives, APT payloads are often detected only after the code is executed.\n\nIn this deep dive, we present our analysis of the recent operation by APT group\nBackdoorDiplomacy targeting telecom providers based in the Middle East. During this attack,\nthreat actors deployed a range of tools, many of which were heavily customized or seemingly\nnovel as they had not been encountered before. We share this research to help other\ncompanies to identify blind spots and increase cyber-resilience.\n\n## Anatomy of an attack\n\nThe complete anatomy of an attack, including all known indicators of compromise (IOCs), is\navailable in the full research paper: \"Cyber-Espionage in the Middle East: Investigating a\nNew BackdoorDiplomacy Threat Actor Campaign\". The following is a summary of this\nresearch. Detailed descriptions of many of the tools used during this attack are included in\nthe full report. Since we observed modifications to the code of some of these tools during this\nincident, they continue to be under active development:\n\nIrafau Backdoor\nQuarian Backdoor\nPinkman Agent\nImpersoni-fake-ator\n\n### Initial compromise\n\nThe initial infection vector was an instance of an Exchange server exploited via a known\n[unpatched vulnerability ProxyShell – a combination of vulnerabilities CVE-2021-31207](https://www.techtarget.com/whatis/feature/Everything-you-need-to-know-about-ProxyShell-vulnerabilities)\n[(authentication bypass), CVE-2021-34523 (escalation of privileges), and CVE-2021-34473](https://nvd.nist.gov/vuln/detail/CVE-2021-34523)\n(remote code execution). This is one of the top 15 routinely exploited vulnerabilities (source:\nCISA), allowing a threat actor to execute arbitrary code. Surprisingly, weaponizing wellknown vulnerabilities is still an effective method for nation-state actors to compromise\nnetworks. This is a low-cost/high-value attack vector, and according to the latest Data Breach\nInvestigations Report, over 30% of web application attacks are related to espionage (a\nsignificantly higher number than any other attack vector). When prioritizing your security\nstrategy, make sure these routinely exploited vulnerabilities are handled as a top priority.\n\nThe attack started with an email, but this was not a traditional phishing attack. The malicious\npayload was included as an attachment, and once this email was received and processed by\nthe Exchange server, the vulnerability was exploited (without anyone clicking on the\nattachment or even seeing the email). The subject of the email and the attachment name\nsuggests that a public proof of concept for ProxyShell exploit was used.\n\n\n-----\n\nAfter gaining access to this system, threat actors deployed two web shells on the\ncompromised Exchange server. A web shell is a malicious shell-like interface (usually written\nin web development languages such as JSP, PHP…) that is used to access a web server\nremotely, providing a threat actor with access even after the exploited vulnerability is fixed.\n[For this operation, two types of webshells were used: ReGeorg, and another](https://github.com/sensepost/reGeorg) C# open-source\nwebshell.\n\n### Reconnaissance, credential access, and privilege escalation\n\nAfter the initial foothold was established, threat actors continued with system discovery,\nidentifying and locating other machines and file shares on the network. For initial\nreconnaissance, threat actors used a combination of built-in utility tools (including\n```\nhostname.exe, netstat.exe, net.exe, and others), Active Directory discovery utilities\n\n```\n(ldifde.exe and csvde.exe), and open-source scanners and other publicly available\n[software (port scanner NimScan, IPv4/IPv6 scanner](https://github.com/elddy/NimScan) [SoftPerfect Network Scanner, NetBIOS](https://www.softperfect.com/products/networkscanner/)\nscanner NBTscan, and others).\n\nThreat actors also collected information about users and groups – basic user information\nwas extracted from the Exchange server by PowerShell (Get-User -ResultSize Unlimited\n```\n| Select-Object -Property Name), with interest in Active Directory members of groups\n\n```\n“Domain Admins”, “Remote Desktop Users”, and other custom groups.\n\nCredentials were extracted from the registry by running the following commands:\n```\n   reg save hklm\\sam sam.hive\n   reg save hklm\\security security.hive\n   reg save hklm\\system system.hive\n\n```\nTo capture more credentials, threat actors enabled the Digest Authentication Protocol\n(WDigest) in the registry. This is a legacy protocol used in Windows Server 2003 and older\noperating systems that requires storing clear-text passwords in the memory. By enabling this\nprotocol, threat actors can harvest not only password hashes, but also clear text passwords\nfor all users authenticated against a server with this protocol enabled. Other tools for\nmanipulating and extracting credentials were saved in %Public% folder, including\n[secretsdump.py from Impacket,](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py) [set_empty_pw.py (ZeroLogon), and ProcDump from](https://github.com/risksense/zerologon/blob/master/set_empty_pw.py)\nSysinternals.\n\nFor privilege escalation, threat actors used a custom tool %LocalAppData%\\VMware\\t.exe.\nThis binary loader extracted and executed, in memory, the payload - a privilege escalation\n[code based on vulnerability CVE-2018-8440. This is a binary loader written in the Nim](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2018-8440)\nprogramming language. Nim is not commonly used – threat actors probably chose it to avoid\n\n\n-----\n\ndetection by security teams that are not familiar with this language. The new programming\nlanguage produces bytecode sequences that are unknown to many detection tools, and this\nis one of the common tactics to help avoid detection.\n\n### Lateral movement\n\nAfter collecting basic information about machines, networks, and users, threat actors\nimproved the reconnaissance process with a custom tool c:\\windows\\com\\taskmgr.exe\n(SHA256: ba757a4d3560e18c198110ac2f3d610a9f4ffb378f29fd29cd91a66e2529a67c). This\ntool uses a list of computers and a list of credentials obtained previously to gather more\ninformation, execute remote commands, and collect more data.\n\nThis tool is designed to work in both workgroup and domain environments and supports\nremote execution based on PsExec, WMI (using wmic.exe), or using remote Scheduled\nTasks (using at.exe). After connecting to each of the machines defined in a local\nconfiguration file, this utility will copy a local batch script to a remote machine, execute this\ncustom script, and download the output file with extracted information.\n\nThe script executes multiple commands, such as tasklist /svc, ipconfig /all, ipconfig\n```\n/displaydns, netstat -ano, net start, systeminfo, and net user, net localgroup\nadministrators. It also includes commands for listing the registry key for Internet settings,\n\n```\nRun registry keys, and content of c:\\Users directory. The output of all commands is\nredirected to the local file, which is then retrieved by the tool. An overview of this tool,\nincluding all the command line parameters and internal logic, are included in the full report.\n\nThe threat actors used also other tools for lateral movement, including schtasks.exe,\nstandalone psexec.exe, sharp-wmiexec.exe, and smbexec.py.\n\n### Persistence and defense evasion\n\nPersistence was established using multiple methods to provide threat actors with access to\nsystems, including changed credentials, restarts, or other interruptions, for redundancy\nshould one of their methods fail.\n\nThe first, and most obvious method to establish persistence is through registry Run keys\n(both HKLM and HKCU) for multiple separate executables, using registry value names like\n```\nAcroRd, Userinit, updatesrv, siem or vmnat.\n\n```\nThe second method involves the creation of multiple services, using the command sc.exe.\nService names included NetSvc and AppMgmt.\n\nThe final method of persistence relies on the WMI event subscription. Custom namespace\n```\nroot\\Microsoft is created, with an event that is triggered only during a short window after\n\n```\nthe startup (more than 5 minutes, but less than 6 minutes).\n\n\n-----\n\nFor evading defense, the threat actors used multiple loaders like the one presented in the\nPrivilege Escalation section (t.exe), and VMProtect packed binaries. VMProtect is a\nlegitimate software protection solution that includes anti-cracking functionality, such as\ndebuggers or virtualization detection.\n\nOther techniques include DLL sideloading (a technique that we have recently covered in\n[“Tech Explainer | What is DLL Sideloading?” article), adding exclusions to Windows](https://businessinsights.bitdefender.com/tech-explainer-what-is-dll-sideloading?hsLang=en-us)\nDefender, and timestomping (tampering with timestamps on the NTFS filesystem to hide file\nchanges).\n\n### Data exfiltration\n\nAlthough the aim of the attack is hard to establish, there are a few artifacts that suggest the\nintent of cyber-espionage. The first evidence is the use of PowerShell cmdlets Get-Mailbox\nand Get-MessageTrackingLog on the Exchange server for obtaining email content and\nmetadata.\n\n[To exfiltrate data, another tool based on the open source sftp project was used. This tool](https://github.com/pkg/sftp)\ndownloaded a rar.exe executable, and then uploaded the archive to the same server. The\nRAR utility was used multiple times for compressing files such as discovery results, emails,\nand log files with keystrokes.\n\nAnother piece of evidence in favor of the hypothesis that we are dealing with an espionage\noperation is the use of a keylogger. The malicious component (duser.dll) was loaded by\n[the legitimate credwiz.exe binary (one of the instances of the DLL sideloading technique).](https://businessinsights.bitdefender.com/tech-explainer-what-is-dll-sideloading?hsLang=en-us)\nThe log file generated by this keylogger is not encrypted – it contains the timestamp, the\nwindow name, and the typed keystrokes.\n\nFinally, our research suggests that this operation was likely performed by a group specialized\nin cyber espionage, known as BackdoorDiplomacy. This group has previously targeted\ntelecommunication companies and Ministries of Foreign Affairs in the Chinese sphere of\ninterest, including the Middle East and Africa. The attribution is based on infrastructure and\ntactics, techniques, and procedures (TTP) common to the current operation and others\nknown to the public. For instance, the already known IP address 43.251.105[.]139 was\nused. The domains uc.ejalase[.]org and mci.ejalase[.]org pointed to IP addresses that\nare related to other domains used in the past. One of such domains we believe is\n```\nsupport.vpnkerio[.]com as there are other subdomains of vpnkerio[.]com connected to\n\n```\nthe mentioned threat actor.\n\n## Conclusion & recommendations\n\n\n-----\n\nThe best protection against modern cyber-attacks is a defense-in-depth architecture. Start\nwith reducing your attack surface, focusing on patch management (not only for Windows but\nfor all applications and internet-exposed services), and detection of misconfigurations. Read\nour [technical brief to learn about GravityZone Patch Management solution.](https://www.bitdefender.com/content/dam/bitdefender/resources/technical-brief/Bitdefender-Patch-Management-Technical-Brief-en.pdf)\n\nThe next security layer is reliable world-class prevention controls to eliminate most security\nincidents, using multiple layers of security, including IP/URL reputation for all endpoints, and\nprotection against fileless attacks.\n\nImplementing IP, domain, and URL reputation, powered by Bitdefender threat intelligence\nsolution, is one of the most effective methods to stop automated vulnerability exploits.\n[According to analysis in the Data Breach Investigations Report 2022, only 0.4% of the IPs](https://www.verizon.com/business/resources/reports/dbir/)\nthat attempted RCEs were not seen in one of the previous attacks. Block bad IPs, domains,\nor URLs on all devices, including endpoints, and prevent a security breach in your business\nenvironment.\n\nFinally, for the few incidents that get through your defenses, lean on security operations,\n[either in-house or through a managed service, and leverage strong detection and response](https://www.youtube.com/watch?v=TRp7uLYLGiQ)\ntools. Modern threat actors often spend weeks or months doing active reconnaissance on\nnetworks, generating alerts, and relying on the absence of detection and response\ncapabilities.\n\n[Learn more about Gravityzone Extended Detection and Response (XDR).](https://www.bitdefender.com/business/gravityzone-platform/xdr-extended-detection-and-response.html)\n\n_We would like to thank Victor Vrabie, Adrian Schipor, and Cristina Vatamanu from the_\n_Bitdefender Labs team for their help with putting this report together._\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-12-06 - Deep Dive Into a BackdoorDiplomacy Attack – A Study of an Attacker’s Toolkit.pdf"
    ],
    "report_names": [
        "2022-12-06 - Deep Dive Into a BackdoorDiplomacy Attack – A Study of an Attacker’s Toolkit.pdf"
    ],
    "threat_actors": [
        {
            "id": "709ceea7-db99-405e-b5a7-a159e6c307e0",
            "created_at": "2022-10-25T16:07:23.373699Z",
            "updated_at": "2025-03-27T02:02:09.768341Z",
            "deleted_at": null,
            "main_name": "BackdoorDiplomacy",
            "aliases": [],
            "source_name": "ETDA:BackdoorDiplomacy",
            "tools": [],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "3b56d733-88da-4394-b150-d87680ce67e4",
            "created_at": "2023-01-06T13:46:39.287189Z",
            "updated_at": "2025-03-27T02:00:03.040775Z",
            "deleted_at": null,
            "main_name": "BackdoorDiplomacy",
            "aliases": [
                "BackDip",
                "CloudComputating",
                "Quarian"
            ],
            "source_name": "MISPGALAXY:BackdoorDiplomacy",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "17b1b76b-16da-4c4f-8b32-f6fede3eda8c",
            "created_at": "2022-10-25T16:07:23.750796Z",
            "updated_at": "2025-03-27T02:02:09.961401Z",
            "deleted_at": null,
            "main_name": "Ke3chang",
            "aliases": [
                "APT 15",
                "BackdoorDiplomacy",
                "Bronze Davenport",
                "Bronze Idlewood",
                "Bronze Palace",
                "CTG-9246",
                "GREF",
                "Ke3chang",
                "Metushy",
                "Nylon Typhoon",
                "Operation Ke3chang",
                "Operation MirageFox",
                "Playful Dragon",
                "Playful Taurus",
                "Red Vulture",
                "Royal APT",
                "Social Network Team",
                "Vixen Panda"
            ],
            "source_name": "ETDA:Ke3chang",
            "tools": [
                "Agentemis",
                "Anserin",
                "BS2005",
                "BleDoor",
                "CarbonSteal",
                "Cobalt Strike",
                "CobaltStrike",
                "DarthPusher",
                "DoubleAgent",
                "EternalBlue",
                "GoldenEagle",
                "Graphican",
                "HenBox",
                "HighNoon",
                "IRAFAU",
                "Ketrican",
                "Ketrum",
                "LOLBAS",
                "LOLBins",
                "Living off the Land",
                "MS Exchange Tool",
                "Mebroot",
                "Mimikatz",
                "MirageFox",
                "NBTscan",
                "Okrum",
                "PluginPhantom",
                "PortQry",
                "ProcDump",
                "PsList",
                "Quarian",
                "RbDoor",
                "RibDoor",
                "Royal DNS",
                "RoyalCli",
                "RoyalDNS",
                "SAMRID",
                "SMBTouch",
                "SilkBean",
                "Sinowal",
                "SpyWaller",
                "Theola",
                "TidePool",
                "Torpig",
                "Turian",
                "Winnti",
                "XSLCmd",
                "cobeacon",
                "nbtscan",
                "netcat",
                "spwebmember"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "401a2035-ed5a-4795-8e37-8b7465484751",
            "created_at": "2022-10-25T15:50:23.616232Z",
            "updated_at": "2025-03-27T02:00:55.506403Z",
            "deleted_at": null,
            "main_name": "BackdoorDiplomacy",
            "aliases": [
                "BackdoorDiplomacy"
            ],
            "source_name": "MITRE:BackdoorDiplomacy",
            "tools": [
                "Turian",
                "China Chopper",
                "Mimikatz",
                "NBTscan",
                "QuasarRAT"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1675303654,
    "ts_updated_at": 1743041834,
    "ts_creation_date": 1675237134,
    "ts_modification_date": 1675237134,
    "files": {
        "pdf": "https://archive.orkl.eu/4a86443c181ea9b0bc2c0112a0d50dc677174a99.pdf",
        "text": "https://archive.orkl.eu/4a86443c181ea9b0bc2c0112a0d50dc677174a99.txt",
        "img": "https://archive.orkl.eu/4a86443c181ea9b0bc2c0112a0d50dc677174a99.jpg"
    }
}