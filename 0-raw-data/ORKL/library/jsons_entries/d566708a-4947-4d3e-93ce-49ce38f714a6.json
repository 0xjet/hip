{
    "id": "d566708a-4947-4d3e-93ce-49ce38f714a6",
    "created_at": "2023-01-12T15:09:33.585043Z",
    "updated_at": "2025-03-27T02:05:37.316464Z",
    "deleted_at": null,
    "sha1_hash": "4e592d999bc5825ff6776edddbe00a4fe4e0504c",
    "title": "2020-07-24 - Exorcist Ransomware - From triaging to deep dive",
    "authors": "",
    "file_creation_date": "2022-05-29T01:10:13Z",
    "file_modification_date": "2022-05-29T01:10:13Z",
    "file_size": 8677454,
    "plain_text": "# Exorcist Ransomware analysis writeup | Medium\n\n**[medium.com/@velasco.l.n/exorcist-ransomware-from-triaging-to-deep-dive-5b7da4263d81](https://medium.com/@velasco.l.n/exorcist-ransomware-from-triaging-to-deep-dive-5b7da4263d81)**\n\nLeandro Velasco July 24, 2020\n\n[Leandro Velasco](https://medium.com/@velasco.l.n?source=post_page-----5b7da4263d81--------------------------------)\n\nJul 24, 2020\n\n\n11 min read\n\n## Exorcist Ransomware — From triaging to deep dive\n\n TL;DR\n\nOn Monday 20th while hunting for some REvil samples I stumbled upon a newly introduced\nransomware as a service called Exorcist. This ransomware is distributed via Pastebin\nembedded in a powershell script that loads it directly in memory. This script is based on\n“Invoke-ReflectivePEInjection.ps1” script by Joe Bialek (@JosephBialek), but it is optimised\nwith an additional function to pass a base64 encoded executable to the main function. This\npowershell script is possibly generated using the Empire framework. The same technique is\nused by some of the Sodinokibi/REvil affiliates, and in the past by Buran.\n\nThe ransomware is not obfuscated and the majority of the strings are in plaintext stored in\nthe “.rdata” section of the executable. The first thing that the malware does is to check the\ngeo location of the system using the language and the keyboard layout. If the results yield\none of the Commonwealth of Independent States (CIS) it quits on the spot. Then the\nransomware execute a series of commands to disable and remove backups and kill\nprocesses that might interfere with the system encryption. Once it is done with the\ncommands, it writes to disk the RSA public key, the session private key and the extension.\nThis information is not written into a file in a straightforward manner, instead it is written in\ndifferent [Alternate Data Streams on the file “%temp%\\\\boot.sys”.Then it extracts information](https://www.howtogeek.com/howto/windows-vista/stupid-geek-tricks-hide-data-in-a-secret-text-file-compartment/)\nfrom the system such as username, hostname, OS version, keyboard layout, etc. and sends\nthem via http to the server “http://217.8.117[.]26/gateinfo”. Next it gets the amount of cpu on\nthe systems and starts multiple threats to encrypt the system files. Some directories and file\nextensions are excluded to avoid rendering the system unusable. Once done with the\nencryption another http packet is sent to the same server this time to the url\n“http://217.8.117[.]26/gatedrivers”. Lastly, the wallpaper of the system is changed and the\n\n\n-----\n\nransom notes are dropped in the form of hta scripts with the name convention <extension>decrypt.hta”. In these notes we can find the instructions to recover the system that consist of\nthe urls “http://217.8.117[.]26/pay”. “http://4dnd3utjsmm2zcsb[.]onion/pay”, and the\n“Authorization Key”.\n\nExorcist Ransom Note\nThis information will be needed to “sign in” the payment portal shown in the following\nscreenshot:\n\nFor the IOCs go to the bottom of the page =D\n\n## Exorcist Ransomware Triaging\n\nOnce the payload is extracted (base64 encoded) from the powershell loader, we get a PE32\n[executable. From a quick scan of the file using Assemblyline we get the following interesting](https://github.com/CybercentreCanada/assemblyline-core)\ninsights:\n\n\n-----\n\nSo at a first glance we can see that there are some well known executable names extracted,\nnormally seen in ransomware and coin miners either to prevent processes from allowing\naccess to files that will be encrypted or to free resources to mine more effectively.\n\nBased on the API names extracted from the sample we can say it has some network\ncapabilities as well as some cryptography ones. This is looking more and more like a\nransomware!\n\nLastly we see there is a url extracted from the sample “http://217.8.117[.]26/pay”. If we check\nwhat we found on that website (in a secure manner ;) ) we find the following:\n\n\n-----\n\nOur suspicion was correct, it was ransomware after all!! But what else does this ransomware\n[do? Let’s take a look at its capabilities using the newest tool from Fireeye capa.](https://github.com/fireeye/capa)\n\n\n-----\n\nSo, it seems that indeed this ransomware sends data via http and executes some tricks to\ncheck the system to not run on the wrong country ;). Now we are ready for a more serious\ndeep dive!\n\n## Exorcist Ransomware Deep Dive\n\n\n-----\n\nNow it is time to get into the details of this malware. First we are going to take a look at the\nfile from a static point of view by analysing its strings, API calls, and code. And then to\ncomplete our analysis and better understand the inner workings of the malware we are going\nto study it from a dynamic point of view.\n\n## Static analysis\n\nLoading the executable on PEstudio helps us to confirm some of the hypothesis we made\nduring the triage and also shows us some interesting aspect of the sample that we haven’t\nseen so far.\n\n\n-----\n\n-----\n\n-----\n\nSo, some quick takeaways from the analysis so far:\n\n1. Samples does not obfuscate strings.\n2. It will exclude given directories and files with the extensions shown above to not render\n\nthe system unusable.\n3. As expected, the ransomware will get rid of the Shadow copies of the files to avoid the\n\neasy restoring of files.\n4. It most likely will attempt to stop processes in a predefined list.\n\nLet’s get our hands dirty and look at the code to discover some more capabilities of this\nransomware. For this we are going to load the sample to the free version of IDA.\n\n\n-----\n\nSo, one of the first thing is does is creating a mutex to avoid running multiple times on the\nsystem. Let’s check what else we find next to the hardcoded mutex string.\n\n\n-----\n\nHere we can see some interesting strings that we have overlooked before. Seems that there\nare some countries listed that are most likely used together with the “get keyboard layout”\ncapability seen before to decide if this sample should run or quit. Let’s confirm this theory!\n\n\n-----\n\n-----\n\n[The Ransomware uses the API “GetLocaleInfo” and “GetKeyboardLayoutList” to determine](https://docs.microsoft.com/en-us/windows/win32/api/winnls/nf-winnls-getlocaleinfoa)\nthe geo location of the system and check if it should continue running or not. Let’s verify\nanother hypothesis we had. Does the ransomware kill the processes displayed in the strings\nbefore start encrypting? For this we are going to pivot from the un-obfuscated strings to the\ncode.\n\n\n-----\n\n-----\n\nFrom analysing the routine we see that it is divided in two main sections, the first one running\na set of predefined commands to disabled and remove shadow copies and backups, and a\nsecond one that goes through the list of processes and calls “taskkill” for each of them.\n\n\n-----\n\n-----\n\nAnother way to browse through the code is to use the IDA feature Xref from graph. This can\nbe done because the sample is not obfuscated, and the windows API calls are been referred\nexplicitly. Using this tool we can guide our analysis following the Windows API calls of\ninterest\n\nWell…I said we could use it, not that it was small nor easy ;). However, if we zoom into it, we\ncan have a good understating of the different functions and have a gist of their purpose. For\nexample:\n\n\n-----\n\nHere we see the “ShellExecuteW ”API call (always interesting to see what the sample might\ntry to execute) that is called right before exiting. If we go where it is called, we end up in the\nfollowing routine :\n\n[The routine consists of calling the API “GetModuleFileName” with “hmodule” Null to get the](https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea)\npath of the executable file of the current process. Then, it prepares a command line that\nwould look like execute the command and then exits.\n\n\n-----\n\nBy looking at the XRef graph we also notice some classic Windows API calls used to send\nhttp packets over the network. If we follow the references we find the following routine :\n\n\n-----\n\nBy exploring this routine, we see that a post request is done. But now the question is what\ninformation is been sent. In the next section we are going to find out exactly what is been\nsent via the post http request.\n\nIn order to fast forward the analysis, confirm some hypothesis, and discover new\n[functionality, we will start the sample in the x32/64 debugger while having Procmon and](https://x64dbg.com/#start)\n[FakeNet running next to it to get more insights.](https://github.com/fireeye/flare-fakenet-ng)\n\n## Dynamic analysis\n\nNow that our ransomware is running in a controlled environment we can see in more details\nhow the different commands and processes are been killed by it.\n\n\n-----\n\nLet’s continue where we left trying to understand what is sent to the server over an http post\nrequest. In the following screenshot we can see how the IP and Port are decoded from the\nstring stored in the “.rdata” section of the executable.\n\nOnce it has that information the malware will start preparing the request. This means setting\nup the headers and the content that will be sent. Once done it will call the API call\n“HttpSendRequest” to send the http request. Using FakeNet we received that request and\nrespond with a fake site to emulate the “C2”.\n\n\n-----\n\nAs the picture shows the ransomware sends a big blob encoded in base64 to the c2 server\nat “http://217.8.117[.]26/gateinfo”. But where is this information coming from? For this we\nneed to go back to the code an analyse what happened so far.\n\n\n-----\n\nIn this function we see that there is a template for a json file were some details about the\nsystem are gathered and later appended to the json temple string. Examples of details that\nare gathered include but are not limited to:\n\nGetCurrentHwProfileA\n\n\n-----\n\nGen_token (some crypto API calls are involved)\nQuery the registry key “”\nGetUsername\nGetComputername\nGetLocale\nEtc.\n\nOnce it finished querying the system it generates a json that looks as follows:\n\nAfter the information is gathered, we see that some encryption is initialised (creating\nencryption keys, specifying algorithms, etc) but some of the information used is queried from\na file that was written in “%temp%\\\\boot.sys” in an earlier stage. The most interesting aspect\nof this, is that the information is not read from the file itself, instead it queries the file using\nthe convention “filename.ext:string”. This means that this ransomware is using Alternate\n[Data Streams to hide information. Using the ADS-spy tool we can inspect the content that is](https://www.bleepingcomputer.com/download/ads-spy/)\nbeen read by the malware.\n\n\n-----\n\n-----\n\nHidden in this file we can find the generated unique extension, the RSApublic key, and the\nPrivate Session Key. Once these values are retrieved the encryption of the json string takes\nplace.\n\n\n-----\n\n-----\n\nThe json string is encrypted with AES CBC and the symmetric key encrypted the with the\npublic RSA key. In the following screenshot we can see the json string in plaintext and then\nencrypted.\n\n\n-----\n\nAfter encryption, the json is base6 4encoded and then added to the http post request as\nalready shown.\n\nWhat about the file encryption? After all, this is a ransomware, right? So once the first\nbeacon is sent to the server the ransomware starts the file encryption in a multithreaded\nfashion. This can be seen in the following screenshots:\n\n\n-----\n\n-----\n\n-----\n\nOnce it finished it sends yet again another beacon with data to the server but this time to\n“http://217.8.117[.]26/gatedrivers”. In the following picture we can find an example of a\nransom note that is left in every directory. The name convention for them is “<extension>decrypt.hta”\n\nSo this will be all for now, there are quite some more interesting aspects to research into like\nhow the file encryption is performed at a cryptographic level, how are some of the other\ninteresting strings (powershell get host by address) used, does this ransomware implement\npersistence mechanisms, etc. Feel free to contact me for comments and questions.\nConstructive feedback is always welcomed!\n\n## IOCs\n\n\n-----\n\nSamples:\n```\nhttps://bazaar.abuse.ch/sample/a7e27cc38a39ff242da39d05e04b95ea9b656829dfe2e90e8226351\n\n```\nMD5:\n```\n79385ed97732aee0036e67824de18e28f4009abe9f41da41e48340c96e29d62cfa4c4ac8b9c1b14951ae8a\n\n```\nSHA256:\n```\n8d684a790a5683b8decde9fb5a819c4a164d3032723a151a30ff26d3c2b1aabf6db3aae21a6d80857c85f5\n\n```\nURLs:\n```\nhttp://217.8.117[.]26/gateinfohttp://217.8.117[.]26/gatedrivershttp://4dnd3utjsmm2zcsb\n\n```\nIPs:\n```\n217.8.117[.]26\n\n```\n[Tria.ge Sandbox reports:](https://tria.ge/)\n```\nhttps://tria.ge/reports/200724-gmz55kbvr2/behavioral1https://tria.ge/reports/2007242v2mzfsjwx/behavioral1https://tria.ge/reports/200724kfjg2xf1b2/behavioral1https://tria.ge/reports/20072464rls1gjl2/behavioral1https://tria.ge/reports/200724b5zwteacds/behavioral1https://tria.ge/reports/20072415z7parj4x/behavioral1https://tria.ge/reports/200724-zxydprrjys/behavioral1\n\n## Acknowledgements:\n\n```\n[Special thanks to @rikvduijn and](https://twitter.com/rikvduijn) [@ValthekOn for helping me figure some of the details out](https://twitter.com/ValthekOn)\nand my team at [@kpnsecurity for supporting my crazy projects and reviewing this writeup =D](https://twitter.com/kpnsecurity)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2020/2020-07-24 - Exorcist Ransomware - From triaging to deep dive.pdf"
    ],
    "report_names": [
        "2020-07-24 - Exorcist Ransomware - From triaging to deep dive.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536173,
    "ts_updated_at": 1743041137,
    "ts_creation_date": 1653786613,
    "ts_modification_date": 1653786613,
    "files": {
        "pdf": "https://archive.orkl.eu/4e592d999bc5825ff6776edddbe00a4fe4e0504c.pdf",
        "text": "https://archive.orkl.eu/4e592d999bc5825ff6776edddbe00a4fe4e0504c.txt",
        "img": "https://archive.orkl.eu/4e592d999bc5825ff6776edddbe00a4fe4e0504c.jpg"
    }
}