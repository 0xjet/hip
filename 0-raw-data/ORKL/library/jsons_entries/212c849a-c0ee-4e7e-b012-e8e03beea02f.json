{
    "id": "212c849a-c0ee-4e7e-b012-e8e03beea02f",
    "created_at": "2023-05-06T02:09:31.848696Z",
    "updated_at": "2025-03-27T02:16:01.177178Z",
    "deleted_at": null,
    "sha1_hash": "56ea0c63f7bb7a53097698bb70b371cdbd638c23",
    "title": "2015-03-10 - The DGA of Pykspa",
    "authors": "",
    "file_creation_date": "2023-05-05T01:55:04Z",
    "file_modification_date": "2023-05-05T01:55:04Z",
    "file_size": 461301,
    "plain_text": "# The DGA of Pykspa - \"you skype version is old\"\n\n**bin.re/blog/the-dga-of-pykspa/**\n\n## The DGA of Pykspa\n\n\"you skype version is old\"\nPykspa (also known as *Pykse*, Skyper* or SkypeBot*) is a worm that spreads via Skype,\n_see “Take a Deep Breath: a Stealthy, Resilient and Cost-Effective Botnet Using Skype” by_\n_Antonio Nappa et al. and_ _[“Recognising Botnets in Organisations” by Barry Weymes. The](http://www.ru.nl/publish/pages/578936/thesis_final_censored-bweymes.pdf)_\nmalware has a hardcoded list of chat messages which it sends to contacts of the infected\nSkype user, trying to lure them into clicking on links that install Pykspa on their computer.\nExamples of the chat messages from my sample are:\n\nyou skype version is old Pykspa\n\nI saw you last week. I would like to speak with you Pykspa\n\n\n-----\n\ni lost my job..\ni am idiot..\n\ni want to die.. Pykspa\n\n[This file lists all chat messages in English. All messages are translated, albeit poorly, to the](https://bin.re/blog/the-dga-of-pykspa/assets/chat_messages.txt)\nfollowing languages: German, Russian, Ukranian, Romanian, Danish, Polish, Italian, Latvian,\n_French, Slovak, Lithuanian, Spanish, Norwegian, Estonian, Swedish, Czech._\n\nSince at least October 2013, Pykspa comes with a Domain Generation Algorithm (DGA) to\ncontact its Command and Control (C&C) servers. Here is an example of the traffic generated\non February 16th, 2015:\n```\n  +--- whatismyip.everdot.org\n\n  |  www.whatismyip.ca\n(1)-+  whatismyipaddress.com\n\n  |  www.showmyipaddress.com\n  +--- www.whatismyip.com\n(2)----> www.google.com\n\n  +--> ejtuxsflbknn.net\n  |  haqwrnonlaj.info <--+\n\n  |  jlbdgfhi.net <------+\n\n  |  hiyumk.net <--------+\n\n  |  ezrmsrnmzddx.net <--+\n\n(3)-+  okqwmayiseaq.com <--+\n\n  |  lchsxgzmwg.info <---+--- (4)\n\n  +--> wrthooba.info    |\n\n  |  wbtkdnfr.info <-----+\n\n  |  bodlmkjkckx.net <---+\n\n  +--> asgwkyaioy.com   |\n\n  |  xcixrwcyesou.net <--+\n\n  |  ofebrbnbmvfa.info <-+\n\n  +--> nazihzsljevt.net  |\n\n     bkmothb.net <-------+\n\n\n```\nThe IP lookup domains (1) are used to determine the IP and location of the host, probably to\nselect the right language for the chat messages. The single call to Google (2) is used to\ndetermine the current date and time. After that follow two sets of interleaved DGA domains.\nThe set (3) likely contains the C&C target, while (4) is probably just added as noise.\n\nBoth (3) and (4) use the same DGA, but with different seeds. This blog post shows the DGA\nof Pykspa, lists the time dependent seeds, and links to some samples on malwr.com that\n[match the DGA and seeds. I analysed this sample from malwr.com, more samples that use](https://malwr.com/analysis/ZDhjNDE0MDZmNjdmNGNkM2JiZmJlN2UyYTE4YTI5ZDM/)\nPykspa’s DGA are listed in Section Samples on Malwr.com:\n\n**MD5**\n6da71b4317dd664544903cbc872308d7\n\n**SHA1**\n\n\n-----\n\ne373766587b78c4ee7cef9d7a7735b3a52cf41bb\n\n**SHA256**\n16cf97e7237828c37c796a8f9e81451f7fc301da7fe2ff66d97ce5b44c7dfb42\n\n**Size**\n1284KB, 1314816 Bytes\n\n**Compile Timestamp**\n2006-12-09 09:18:24 UTC\n\n(Changes 2015-03-11: Also included discussion of the second set of domains.)\n\n## Some of the Preliminary Steps\n\n### Anti-VM\n\nMost of the recent Pykspa samples use VM detection. If the sample feels like it is running\ninside a VM, it immediately shuts down the machine:\n```\n0040DAE6 shutdown:               \n\n0040DAE6         call  shutdown1\n\n0040DAEB         call  shutdown2\n\n0040DAF0\n\n0040DAF0 loc_40DAF0:              \n\n0040DAF0         call  detect_vm\n\n0040DAF5         test  al, al\n\n0040DAF7         jnz   short shutdown\n\n\n```\nThe VM detection is based on the exotic “Visual Property Container Extender” assembly call:\n```\n0040D408 vpcext 7, 0Bh\n\n\n```\nMy VM was unmasked by this call; I therefore patched the call to the VM detection routine\nwith xor eax, eax:\n```\n0040DAF0 loc_40DAF0:              \n\n0040DAF0         xor   eax, eax\n\n0040DAF2         nop\n\n0040DAF3         nop\n\n0040DAF4         nop\n\n0040DAF5         test  al, al\n\n0040DAF7         jnz   short shutdown\n\n\n### Host-IP\n\n```\nThe first network traffic that the sample generates are calls to various IP lookup sites. Pykspa\nprobably uses the information from these sites to geolocate the infected client and choose\nthe appropriate language in Skype chats.\n\n\n-----\n\n### Current Time\n\nNext, Pykspa enters this code snippet:\n\nThese lines first randomly choose one of the following 13 common website (stored at\n```\ntest_domains, see offset 40C214):\n\n```\n\n-----\n\n```\n www.google.com\n\n- www.facebook.com\n\n- www.myspace.com\n\n- www.youtube.com\n\n- www.yahoo.com\n\n- www.youtube.com\n\n- www.wikipedia.org\n\n- www.blogger.com\n\n- www.adobe.com\n\n- www.bbc.co.uk\n\n- www.imdb.com\n\n- www.baidu.com\n\n- www.ebay.com\n\n```\nThe malware then calls the subroutine connectivity_check which makes a HTTP GET\nrequest for the selected domain, e.g.,\n```\nGET / HTTP/1.1\n\nHost: www.blogger.com\n\nAccept: */*\n\nUser-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; ->\n\n -> rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3\n\nConnection: close\n\n\n```\nPykspa extracts the Date field of the HTTP reponse’s header:\n\nThe string is then parsed to get the current date and time. For example, these lines convert\n“Feb” to the month number 2:\n```\n0040FC6F loc_40FC6F:              \n\n0040FC6F         push  offset aFeb  \n\n0040FC74         push  edi      \n\n0040FC75         call  esi ; lstrcmpiA\n\n0040FC77         test  eax, eax\n\n0040FC79         jnz   short loc_40FC84\n\n0040FC7B         mov   [ebp+74h+month], 2\n\n0040FC7F         jmp   loc_40FD3C\n\n```\n\n-----\n\nFor instance, if the response from www.blogger.com is:\n```\nHTTP/1.1 302 Moved Temporarily\n\nP3P: CP=\"This is not a P3P policy! See http://www.google.com/support/accounts/ ->\n\n  -> bin/answer.py?hl=en&answer=151657 for more info.\"\n\nContent-Type: text/html; charset=UTF-8\n\nCache-Control: no-cache, no-store, max-age=0, must-revalidate\n\nPragma: no-cache\n\nExpires: Fri, 01 Jan 1990 00:00:00 GMT\n\nDate: Mon, 09 Mar 2015 11:03:14 GMT\n\n...\n\n\n```\nThen the date is 2015-03-09 11:03:14. The routine connectivity_check returns this date\nin unix timestamp format in eax, or NULL if the date extraction failed. If a date is returned, it\nis saved in variable today at offset 40C224. If the date extraction failed, for example because\ninternet went down, the snippet sleep 3 seconds at 40C22B and retries with a different\ndomain for at most 20 times.\n\nAfter the current time is stored in today, the malware starts a stopwatch in line 40c247 which\nallows it to estimate the current time using only calls to GetTickCount (see Section Seed).\n\n## Callback Loop\n\nAs shown in the beginning of the post, Pykspa generates two sets of interleaved DGA\ndomains. These domains are indistinguishable due to using the same algorithm. However,\nthe two sets use a different seed and are generated under different circumstances.\n\nIn the following I first show which seed is used when and how the seeds are changed. Next, I\nshow how the initial seed is determined based on the current time. I conclude the section by\nshowing how the DGA actually generates domains based on the current seed.\n\n### When are DGA Calls Made\n\nThe callback loop iterates from 0 to 15999:\n```\n00406B7A xor   dga1_nr, dga1_nr\n\n(...)\n\n00406B82 mov   [ebp+index], dga1_nr\n\n00406B85 next_index:\n\n(...)\n\n00406C64         mov   eax, 16000\n\n(...)\n\n00406C7A         inc   [ebp+index]\n\n00406C7D         cmp   [ebp+index], eax\n\n00406C80         jl   next_index\n\n```\n\n-----\n\nThe above loop is wrapped in an infinite loop, which sleeps 1 second before starting the\ncallback loop over:\n```\n.text:00406C86 push  one_second   ; dwMilliseconds\n\n.text:00406C8C call  ds:Sleep\n\n.text:00406C92 jmp   restart_all\n\n\n```\nTo summarize, these are the two loops in pseudo code:\n```\nWHILE True DO\n\n  // Initialize seeds\n\n  FOR index = 0 TO 15999 DO\n\n    // DGA calls\n\n  END FOR\n\n  sleep 1 second\n\nEND WHILE\n\n\n```\n**First Seed - The Useful DGA calls: Whenever the index is divisible by 80, the DGA is**\ncalled based on the first seed:\n```\n00406B85         mov   eax, [ebp+index]\n\n00406B88         push  80\n\n00406B8A         cdq\n\n00406B8B         pop   ecx\n\n00406B8C         idiv  ecx\n\n00406B8E         test  edx, edx\n\n00406B90         jnz   short loc_406BF9\n\n00406B92         mov   ecx, [ebp+seed1]\n\n00406B95         mov   eax, ecx\n\n00406B97         lea   ebx, [dga1_nr+1]\n\n00406B9A         div   ebx\n\n00406B9C         lea   eax, [ecx+edx+1]\n\n00406BA0         push  eax       ; seed\n\n00406BA1         mov   [ebp+seed1], eax\n\n(DGA related lines)\n\n00406BE6         mov   dga1_nr, ebx\n\n\n```\nThese lines decompile to:\n```\nIF index % 80 == 0 THEN\n\n  s = seed1 % (dga1_nr + 1)\n\n  seed1 = seed1 + s + 1\n\n  // DGA call\n\n  dga1_nr = dga1_nr + 1\n\nEND IF\n\n\n```\nThe dga1_nr starts at 0 (see offset 00406B7A). The initial value of the seed will be discussed\nlater on. Because the index runs from 0 to 15999, there are 200 different domains generated\nby seed1.\n\n\n-----\n\n**Second Seed - The Noisy DGA calls: The callback loop can make second DGA calls**\nindependent of the above DGA calls. These second DGA calls are based on an independent\nsecond seed. This seed is changed every iteration, but DGA calls are only made in about 5%\nof all iterations:\n```\n.text:00406BF9 loc_406BF9:\n\n.text:00406BF9 mov   ecx, [ebp+seed2]\n\n.text:00406BFC mov   ebx, [ebp+dga2_nr]\n\n.text:00406BFF mov   eax, ecx\n\n.text:00406C01 xor   edx, edx\n\n.text:00406C03 inc   ebx\n\n.text:00406C04 div   ebx\n\n.text:00406C06 lea   eax, [ecx+edx+1]\n\n.text:00406C0A mov   [ebp+seed2], eax\n\n.text:00406C0D call  _rand\n\n.text:00406C12 push  20\n\n.text:00406C14 cdq\n\n.text:00406C15 pop   ecx\n\n.text:00406C16 idiv  ecx\n\n.text:00406C18 test  edx, edx\n\n.text:00406C1A jnz   short loc_4\n\n\n```\nThese line decompile to this pseudo code:\n```\ns = seed2 % (dga2_nr + 1)\n\nseed2 = seed2 + s + 1\n\nIF rand() % 20 == 0 THEN\n\n  // DGA call\n\nEND IF\n\ndga2_nr = dga2_nr + 1\n\n\n```\nNotice that the seed2 is changed regardless of whether the seed2 is actually used to\ngenerate a new domain. Therefore, there exist 16000 different domains from seed2, of which\nonly about 5% or 800 domains are actually generated and used.\n\nThe rand() call used to determine if a domain is generated or not is based on the current\ntick count:\n```\n.text:00406ABE call  ds:GetTickCount\n\n.text:00406AC4 push  eax\n\n.text:00406AC5 call  set_seed\n\n\n```\nThis makes the rand() function unpredictable. Because each of the domains from the\nsecond seed only has a 5% chance of being used, I assume these domains are meant\nmerely to produce noise and not be registered as actual C&C servers.\n\n### Seed\n\n\n-----\n\nThe intial seeds for both DGA sets are generated almost the same way. First, the current\ntime is determined:\n```\n00406ACA call  get_timestamp\n\n\n```\nThis routine uses the unix timestamp in today, which was determined during the connectivity\ncheck, and adds the number of seconds that passed since then:\n```\n.text:00413F2B get_timestamp proc near\n\n.text:00413F2B call  ds:GetTickCount\n\n.text:00413F31 sub   eax, tick_count_after_connectivity_check\n\n.text:00413F37 xor   edx, edx\n\n.text:00413F39 mov   ecx, 1000\n\n.text:00413F3E div   ecx\n\n.text:00413F40 add   eax, today\n\n.text:00413F46 retn\n\n.text:00413F46 get_timestamp\n\n\n```\nThis gives an estimate of the current time as unix timestamp. This value — in eax — is then\ndivided:\n```\n.text:00406ACF xor   edx, edx\n\n.text:00406AD1 mov   ecx, 1728000  ; 20 days ...\n\n.text:00406AD6 div   ecx\n\n.text:00406AD8 mov   [ebp+time_divided_by_20days], eax\n\n\n```\nThe divisor is the only difference in creating the first and second seed:\n\nFor the first set of domains the divisor is 1728000. This is the number of seconds in 20\n**days.**\nFor the second set of domains the divisor is 86400. This is the number of seconds in 1\n**day.**\n\nThe seed is based on the resulting quotient, and will therefore change once every 20 days\nfor the useful first set of domains, and daily for the noisy second set of domains. The seed\ninitialization continues by creating a 64 bytes long ASCII hex string:\n```\n.text:00406ADB lea   eax, [ebp+hash_string]\n\n.text:00406AE1 push  eax       ; void *\n\n.text:00406AE2 push  4\n\n.text:00406AE4 pop   edi\n\n.text:00406AE5 lea   eax, [ebp+time_divided_by_20days]\n\n.text:00406AE8 push  edi       ; int\n\n.text:00406AE9 push  eax       ; int\n\n.text:00406AEA call  create_hash_string\n\n\n```\nThe routine create_hash_string is complicated and I didn’t reverse engineer the code. It\nprobably is a hash function that returns 256 bytes encoded as a hex string. Pykspa then\ntakes a 4 character substring of this hex string. The start of the substring is determined by\n\n\n-----\n\ntaking the time quotient modulo 50:\n```\n.text:00406AEF mov   eax, [ebp+time_divided_by_20days]\n\n.text:00406AF2 push  edi       ; size_t\n\n.text:00406AF3 push  50\n\n.text:00406AF5 pop   ecx\n\n.text:00406AF6 xor   edx, edx\n\n.text:00406AF8 div   ecx       ; offset at most 49\n\n.text:00406AFA lea   eax, [ebp+edx+hash_string]\n\n.text:00406B01 push  eax       ; substring\n\n\n```\nFor instance, on March 10th, 2015 at 8 pm the hash_string for the first set of domains is:\n```\nb8b8ae799a67ccc2046e97b6935341680e0e830a8920ec393aa8fe12860b9b09\n\n\n```\nThe unix timestamp is 1426017600. Divided by twenty days, this becomes 825, which is 25\nmodulo 50. The malware will therefore use the 4 characters starting at offset 25, i.e., “3534”.\n\nThese four hex characters and the entire 64 character hash are then passed to routine\n```\ncalc_seed that will determine the seed:\n.text:00406B0B lea   eax, [ebp+hash_string]\n\n.text:00406B11 push  eax       ; hash\n\n.text:00406B12 lea   eax, [ebp+seed]\n\n.text:00406B15 push  edi       ; 4\n\n.text:00406B16 push  eax       ; target\n\n.text:00406B17 call  calc_seed\n\n.text:00406B1C mov   eax, [ebp+seed]\n\n.text:00406B1F mov   [ebp+original_seed], eax\n\n\n```\nAgain, this routine is quite complicated. It probably does some sort of decryption of the\nsubstring based on the hash. I couldn’t identify the algorithm, and didn’t have the time to\nreverse the code from scratch. I opted instead to let the code calculate the seeds for me\nusing a small debugger script. The procedure was as follows:\n\n1. Attach a debugger to the malware while inside the callback loop.\n2. Set a first breakpoint at offset 0x00406ACF, this is where the current time has just been\n\nstored in eax.\n3. Set a second breakpoint at offset 0x00406B1F, this is after the first seed has been\n\nstored in eax.\n4. Iterate over all desired timestamps. For each timestamp do the following: (a) Jump to\n\nthe beginning of the callback routine; (b) Run to the first breakpoint and change eax to\nthe desired timestamp; (c) Run to the second breakpoint, get the seed from eax and log\nthe result.\n\nI implemented these steps in the following Immunity Debugger script:\n\n\n-----\n\n```\nimport immlib\n\nimport time\n\nfrom datetime import datetime\n\ndef main(args):\n\n  imm = immlib.Debugger()\n\n  filename = \"seeds.txt\"\n\n  with open(filename, \"w\") as w:\n\n    w.write(\"first time;last time;seed\\n\")\n\n  # addresses\n\n  start_of_callback = 0x00406A7C\n\n  after_get_timestamp = 0x00406ACF\n\n  result = 0x00406B1F\n\n  # time values\n\n  twenty_days = 3600*24*20\n\n  timestamp = time.mktime((2008,1,1,0,0,0,1,1,-1))\n\n  timestamp = int(((timestamp//twenty_days)*twenty_days))\n\n  end_timestamp = time.mktime((2016,1,1,0,0,0,4,1,-1))\n\n  # setting breakpoints\n\n  imm.log(\"setting breakpoints ...\")\n\n  imm.setBreakpoint(after_get_timestamp)\n\n  imm.setBreakpoint(result)\n\n  while timestamp < end_timestamp:\n\n    first_time = datetime.fromtimestamp(timestamp).strftime(\"%Y-%m-%d %H:%M:%S\")\n\n    last_time = datetime.fromtimestamp(timestamp + twenty_days - 1).\\\n\n        strftime(\"%Y-%m-%d %H:%M:%S\")\n\n    imm.log(\"getting seed for {}\".format(first_time))\n\n    imm.setReg('EIP', start_of_callback)\n\n    imm.run()\n\n    imm.setReg('EAX', timestamp)\n\n    imm.run()\n\n    seed = imm.getRegs()['EAX']\n\n    with open(filename, \"a\") as a:\n\n      a.write(\"{};{};{:x}\\n\".format(first_time, last_time, seed))\n\n    timestamp += twenty_days\n\n  return \"done extracting seeds\"\n\n```\nTo generate the seeds of the second set of domains, simply change the breakpoints to\n0x406B27 and 0x406B7C respectively.\n\nThe following table lists all seeds of the useful domains for the years 2014 and 2015,\nincluding the first five domains that the DGA — shown in the following Section — produces:\nThe time periods are in UTC.\n\n**period** **seed** **first domains**\n\n\n-----\n\n**period** **seed** **first domains**\n\n\n2013-12-21 2014-01-10\n\n2014-01-10 2014-01-30\n\n2014-01-30 2014-02-19\n\n2014-02-19 2014-03-11\n\n2014-03-11 2014-03-31\n\n2014-03-31 2014-04-20\n\n2014-04-20 2014-05-10\n\n2014-05-10 2014-05-30\n\n2014-05-30 2014-06-19\n\n2014-06-19 2014-07-09\n\n2014-07-09 2014-07-29\n\n2014-07-29 2014-08-18\n\n2014-08-18 2014-09-07\n\n2014-09-07 2014-09-27\n\n2014-09-27 2014-10-17\n\n2014-10-17 2014-11-06\n\n2014-11-06 2014-11-26\n\n\n4ae6a802 yabbpifwawe.info, eszgwhn.net, fgskxmbql.org,\nycautv.net, dlhcdwfif.info\n\n3896367b jkdcmitej.com, ccnfrsfseht.net, wwlodun.info,\nivdjhcvwvnla.info, clvcgwxp.net\n\n6a2c8eb2 nbmcfivnj.info, wkjywepmjoqx.net, zkkerwhef.com,\nowvydqimfvl.net, gwiogocc.com\n\nf96bf2a5 bvxbdfe.org, msmyftxyd.info, ncnalaomgmw.com,\nxvanur.net, yookeocesq.com\n\nfcef457e zfjobfqorjhm.info, fjzcpepv.net, msseaycyaeak.com,\nzstalto.net, xmfzbtyaewxb.net\n\ndd370744 eugcldt.net, bplvoxgfxb.info, macccwskcmsq.com,\nzwfelqr.net, omizdirtly.info\n\na1c5400f vcsvuay.com, emhebepmd.net, ufakhnixqiwr.info,\nlfsuyhcrlx.info, ymesmsyiymqo.com\n\n9d0d436c wcsjaj.net, hmdfbqzor.info, xigkzlxyfen.com, nfinek.net,\nyicuqmsi.org\n\n7bb24638 wjfbhnjedf.net, tltcpr.info, sbfebsuys.net,\nzrqhcumanzne.info, jilmfepwgrc.com\n\na6b042c lbjafzzofdx.net, ntilnij.info, vcjdxwbxx.com, cyfwjticnep.net,\nassoka.org\n\nf34c4850 usyytuo.net, hnhdxtxbvd.info, wmsuiuckkagu.com,\nrosktbi.net, adgzqqstzn.info\n\nf2509f0b quyeek.com, rprumlqy.net, uuocymsegeog.com,\nrrrkxsp.net, vbkubbxralgs.net\n\nf0978d0e mgojzac.info, tkcapzfbrj.net, uscoccqakswe.org,\njcrwiwvmq.net, kexlgqb.net\n\n44dd4e5f bewbwrj.com, amoudctuy.net, cciksy.com, masvzhrl.net,\nlkirpo.net\n\naac6d7f6 lrvhlp.info, ojxczyten.net, zlyqrojjqhiw.info, yjvmfyxydt.info,\ndrdgnmro.info\n\nf26296b1 nemnthdcpag.org, rdflml.info, oaiwwgaa.com,\nmjzknmuztv.net, wzhpoo.info\n\nc950cbfe vehbkr.info, zfvszoiql.net, lcqgvikjtgv.org, vbthttzj.net,\nkiusqwmsye.org\n\n\n-----\n\n**period** **seed** **first domains**\n\n\n2014-11-26 2014-12-16\n\n2014-12-16 2015-01-05\n\n2015-01-05 2015-01-25\n\n2015-01-25 2015-02-14\n\n2015-02-14 2015-03-06\n\n2015-03-06 2015-03-26\n\n2015-03-26 2015-04-15\n\n2015-04-15 2015-05-05\n\n2015-05-05 2015-05-25\n\n2015-05-25 2015-06-14\n\n2015-06-14 2015-07-04\n\n2015-07-04 2015-07-24\n\n2015-07-24 2015-08-13\n\n2015-08-13 2015-09-02\n\n2015-09-02 2015-09-22\n\n2015-09-22 2015-10-12\n\n2015-10-12 2015-11-01\n\n\n41de3ee2 eiiuvwczrb.info, uhorab.net, uqocygsskk.com,\nltzzjconbftl.net, fsoelqbsd.com\n\nf085a446 bmnudlx.info, dsyxxfvtyy.net, bshtdy.info,\ntoefqwaaeim.info, rkskpjb.net\n\nffc222d4 xwwglbhkjsl.net, tscdrkt.info, pvdldmlteif.org, hldvfrca.net,\nbsvurea.org\n\nf3fc72bb titjxqdwcmd.com, yglkyz.net, qoumyuce.org,\nrwhnxqtqftkb.net, lhheddtsy.com\n\n2ff654d0 ejtuxsflbknn.net, wrthooba.info, asgwkyaioy.com,\nnazihzsljevt.net, tdxbpku.org\n\n54d64257 nlpfgnhcb.com, horfdqdqtia.net, oayeww.org,\njmydflbsel.net, dkvyhta.com\n\nec343337 rwtyvfrddfk.com, imwgaj.net, mkyaeeye.org,\nxkvjbgdknfbt.net, teejnil.org\n\nccd10407 aaqeemgo.com, gilzxjidxj.net, ywumyoiuuigi.org,\nuvfpbbsyv.net, tbvtngvxocp.org\n\n91f7e71c ytaxprtas.net, hstrdnpcoznh.info, nqpmsct.com,\nxulciqvvd.net, ggwjhuxqtklf.info\n\n5cea1d7a veliren.info, xqzupldhuo.net, ooiomymggqom.org,\nucovoaxwi.net, ywmuyucg.org\n\nb6fcd7ef hwumvsr.com, gipqptued.net, gickck.com, lobmdjpw.net,\nnedqtxt.org\n\n7c562f77 uoakekgy.com, ysbcaebxnt.net, oucmkcyaskua.org,\nagvsjmdoz.net, omgsgs.com\n\n4936d2db wgascuec.com, goxolemcot.net, gyykawsgmeki.org,\nuiffdqxsf.net, gauaam.com\n\nb8b2c9e1 uammskmq.org, jqplflktas.info, rybwtr.net, uyznvxlof.info,\ngakcmqiw.com\n\n31b275c5 mcuomg.org, qdzzziyj.info, cyykckimuy.com,\ntufbdpbtbxyr.net, hofzvmd.org\n\na13852 hrlefwvvqqpp.info, dthawyxm.net, aucoakiaicoe.com,\nvoqzaaq.net, ehibnxwshs.info\n\n6f4f5a0 uauyxamffw.net, mhfira.info, ugfuystwx.net,\nffxxnbesitxz.info, hvhkadugb.org\n\n\n-----\n\n**period** **seed** **first domains**\n\n\n2015-11-01 2015-11-21\n\n2015-11-21 2015-12-11\n\n2015-12-11 2015-12-31\n\n2015-12-31 2016-01-20\n\n\n90864d97 egmsooqueq.com, ckcdayqewadl.net, bwrdwuhv.info,\nxkywrr.info, oyiaaweoymgu.com\n\n225a3e31 rgdyrur.org, yfthagxeb.info, rwccjihweor.com, xdhgnb.net,\negymosgwqiue.org\n\nf400ac9c kzdwohdroo.net, joemwm.info, mkuqmkccgo.org,\nlqyxezj.net, mydsxhtrli.info\n\n1f5c0eed lkwokkrehon.org, cwcrlh.info, hcgktapuh.net,\ndgarcqijrdjc.info, zufrrmm.com\n\n\nYou can find more seeds for the useful domains, as well as the seeds for the noisy domains,\n[in the download in the DGA download.](https://bin.re/blog/the-dga-of-pykspa/assets/dga.zip)\n\n### The DGA\n\nFinally, this section shows how the domains are generated based on the current seed. First,\nthe length of the domains is determined and passed to the dga subroutine get_sld (= get\nsecond level domain):\n```\n.text:00406BA4 push  7\n\n.text:00406BA6 pop   ecx\n\n.text:00406BA7 add   eax, dga1_nr\n\n.text:00406BA9 xor   edx, edx\n\n.text:00406BAB div   ecx\n\n.text:00406BAD lea   eax, [ebp+domain]\n\n.text:00406BB0 add   edx, 6\n\n.text:00406BB3 push  edx       ; length\n\n.text:00406BB4 push  eax       ; domain\n\n.text:00406BB5 call  get_sld\n\n\n```\nThis snippet boils down to:\n```\nlength = (seed1 + dga1_nr) % 7 + 6 \n\ndomain = get_sld(length, seed)\n\n\n```\nThe DGA routine to generate the second level domain is quite long, you can see the full\ndisassembly here. The code boils down to this Python snippet:\n\n\n-----\n\n```\ndef get_sld(length, seed):\n\n  domain = \"\"\n\n  modulo = 541 * length + 4\n\n  a = length * length\n\n  for i in range(length):\n\n    index = (a + (seed*((seed % 5) + (seed % 123456) +\n\n      i*((seed & 1) + (seed % 4567))) & 0xFFFFFFFF)) % 26\n\n    a += length;\n\n    a &= 0xFFFFFFFFF\n\n    domain += chr(ord('a') + index)\n\n    seed += (((7837632 * seed * length) & 0xFFFFFFFF) + 82344) % modulo;\n\n  return domain\n\n```\nBecause the seed is passed by value, the assignment in the second to last line won’t change\n```\nseed1 or seed2.\n\n```\nNext, the top level domain is chosen randomly from an array of top level domains:\n```\n.text:00406BBA         add   esp, 0Ch\n\n.text:00406BBD         push  offset a_    ; \".\"\n\n.text:00406BC2         lea   eax, [ebp+hostname]\n\n.text:00406BC5         push  eax       ; lpString1\n\n.text:00406BC6         call  esi ; lstrcatA\n\n.text:00406BC8         mov   eax, [ebp+asdf]\n\n.text:00406BCB         and   eax, 3\n\n.text:00406BCE         imul  eax, 7\n\n.text:00406BD1         add   eax, offset tld ; \"com\"\n\n.text:00406BD6         push  eax       ; lpString2\n\n.text:00406BD7         lea   eax, [ebp+hostname]\n\n.text:00406BDA         push  eax       ; lpString1\n\n.text:00406BDB         call  esi ; lstrcatA\n\n\n```\nWith the tld array:\n\n\n-----\n\n```\n.data:0042E048 tld       db com,0       ; DATA XREF: sub_406A7C+155o\n\n.data:0042E048                     ; sub_406A7C+1D2o\n\n.data:0042E04C         db  0\n\n.data:0042E04D         db  0\n\n.data:0042E04E         db  0\n\n.data:0042E04F         db 'net',0\n\n.data:0042E053         db  0\n\n.data:0042E054         db  0\n\n.data:0042E055         db  0\n\n.data:0042E056         db 'org',0\n\n.data:0042E05A         db  0\n\n.data:0042E05B         db  0\n\n.data:0042E05C         db  0\n\n.data:0042E05D         db 'info',0\n\n.data:0042E062         db  0\n\n.data:0042E063         db  0\n\n.data:0042E064         db 'cc',0\n\n.data:0042E067         db  0\n\n.data:0042E068         db  0\n\n```\nSo the top level domain is picked according to:\n```\ntlds = ['com', 'net', 'org', 'info', 'cc']\n\ntop_level_domain = tlds[(seed1 & 3)]\n\n\n```\nNote that only the first four top level domains are reachable, “cc” can’t be picked.\n\n### Python Code and Summary\n\nThe Python code [in this ZIP download generates the useful domain for any date between](https://bin.re/blog/the-dga-of-pykspa/assets/dga.zip)\n2008 and 2020. It can also generate the noisy domains for the period March 2013 to March\n2020. The script uses the list of seeds stored in dga1_seeds.json and dga2_seeds.json.\nFor instance, to get the four DGA domains from set (3) shown in the introduction:\n```\n$ python dga.py -d 2015-02-16 -n 4\n\nejtuxsflbknn.net\n\nwrthooba.info\n\nasgwkyaioy.com\n\nnazihzsljevt.net\n\n\n```\nTo confirm that the first noisy domain from (4), i.e., haqwrnonlaj.info is covered by the second\nseed (the date is offset by two days, maybe because of timezone differences?):\n```\n$ python dga.py -d 2015-02-18 -n 1000 -s 2 | grep -n haqwrnonlaj.info\n\n8:haqwrnonlaj.info\n\n\n```\nThe following table summarizes the properties of the DGA:\n\n\n**property** **useful domains (first seed)**\n\n\n**noisy domains**\n**(second seed)**\n\n\n-----\n\n**property** **useful domains (first seed)**\n\n\n**noisy domains**\n**(second seed)**\n\n\nseed changes every 20 days changes daily\n\ndomains per seed 200 800\n\ntested domains all 5% per round\n\nsequence one after another skipping over 95% of\ndomains\n\n\nwait time between\ndomains\n\n\nnone same\n\n\ntop level domain .com, .net, .org and .info, picked\nuniformly at random\n\n\nsecond level\ncharacters\n\nsecond level domain\nlength\n\n\nlower case letters, picked uniformly at\nrandom\n\n\nsame\n\nsame\n\n\n6 to 12 characters same\n\n\n## Samples on Malwr.com\n\nThe DGA was probably first used in October 2013. The first reference to a DGA domain on\nGoogle are for the domain “mczvyzye.net”, which was active from October 3rd to 22nd,\n[2013, and is listed in in this analysis. The following table lists samples on malwr.com that](http://software.sonicwall.com/applications/gav/index.asp?ev=v&v_id=5390)\nmatch the DGA and seeding procedure:\n\n**md5** **analysis date** **seed**\n\n[467a8f934ba9ea9b438a2c89c9f18c1b](https://malwr.com/analysis/MTBmNmJjYTU4YzBmNGY4YzhlNmMwN2IwM2M1YmQ3ZDY/) 21 Feb. 2014 0xf96bf2a5L\n\n[f081f266f1800f6192aa662c9cd15da1](https://malwr.com/analysis/NWMxYTA2YjE3OTQwNGJiZGEzMGMyZGQ3M2MyNjUxY2Y/) 21 Feb. 2014 0xf96bf2a5L\n\n[45c750a60992e1f0c433713fbff50734](https://malwr.com/analysis/Zjg3ODQ2Zjk5YzM4NDQ4YzhmMWU2NTc2N2RkOThiMDM/) 21 Feb. 2014 0xf96bf2a5L\n\n[04d5ee33b95c4ec35ee5295fedf155a9](https://malwr.com/analysis/ZDFjMTQ4MDc5M2EzNGVmYmI3OTYyYmZlMzY3N2RkMTk/) 21 Feb. 2014 0xf96bf2a5L\n\n[02a4634b2ad3800f2a8a285933f03946](https://malwr.com/analysis/MTQ4OTZjNjJhZmJlNDhjZWFiNGEwOTc3NzVmMjcwNWI/) 29 May. 2014 0x9d0d436cL\n\n[30ea7bfee0a9a5fa1a94265cba336116](https://malwr.com/analysis/OGFjMmU3Yzc2N2I4NDljNjk0ZWEyNTQzZmM3ZTUyMGY/) 04 Jun. 2014 0x7bb24638\n\n[0f223c93889d60de3eeec997a17a5121](https://malwr.com/analysis/NzEzNzQ5ZWZhMmI5NGUzZmE3OWY4ZGU3NjRlMDk2NmE/) 18 Jun. 2014 0x7bb24638\n\n[1c04b0440ca8fbf2f9e4fdae6783e480](https://malwr.com/analysis/NzIyYTMxMjdmMzQyNDVmNjllNmM5NWJhMjdlMzAxZjM/) 18 Jun. 2014 0x7bb24638\n\n[01d57201b405cc2eec8688ceac6861f6](https://malwr.com/analysis/YmQ2ODJmZWRlZTQ2NDVkMmJlMjZlNWViYjA1YmZlNzE/) 27 Jun. 2014 0xa6b042c\n\n\n-----\n\n**md5** **analysis date** **seed**\n\n[21bbf78287b44331941e99f124326156](https://malwr.com/analysis/MzIyM2E0MTUzNTRmNDQ0NTgyYTZkZGQxMDQ0OTA0NDg/) 03 Jul. 2014 0xa6b042c\n\n[02b9fba52d81bc77f92dd6cbdae2eae1](https://malwr.com/analysis/MjFhMDUxOTkxN2FkNGY0ODk2ZGQ2NzkwMTJiYTg5MmI/) 03 Jul. 2014 0xa6b042c\n\n[10aa6b8873010c2158342d2f96f11fc1](https://malwr.com/analysis/MWVhODMyZmRiZWE2NDgzMWIzZmRjNDk1NDg1ODhkZjE/) 03 Jul. 2014 0xa6b042c\n\n[16a39f6d50deef6614e2e8cabdc56671](https://malwr.com/analysis/YzFkMjFjNmJkYTAxNDgzZjhiZTBkNjY2M2NkYWM5NGE/) 03 Jul. 2014 0xa6b042c\n\n[28cbcc88b68bba309fab8229fdfb3621](https://malwr.com/analysis/NDA2NjMzYTg1ZWVlNDllMDg4ZjgzZDFmNzdlYjFiNmQ/) 04 Jul. 2014 0xa6b042c\n\n[d4fdea06373888645c693ed2c91b9853](https://malwr.com/analysis/YjM1YTIxNjRiYTBiNGFmZThiZjQzMjM1YTlhZmJlMDg/) 08 Jul. 2014 0xa6b042c\n\n[f95f4809d1e239da71935728ae588c05](https://malwr.com/analysis/OTMwMDZhMmM1NmI0NGQ0YmFmMGMzZTk5OGJiNmI3OTQ/) 08 Jul. 2014 0xa6b042c\n\n[57231e30070e9d500ffa25774809c6b1](https://malwr.com/analysis/NTA5OWMzZDU2NjljNDc0MmI0YjljYWUxNzQ3NmI4OGI/) 13 Jul. 2014 0xf34c4850L\n\n[77ce85d6fc611cc533fcc5c235fb71af](https://malwr.com/analysis/ZDE1ZDE1MzA2YWVjNDY5N2JiYTE4ZDFiZjZjMGYxMTc/) 20 Jul. 2014 0xf34c4850L\n\n[83e4b0ca5ebfa9de4adbc58009629d61](https://malwr.com/analysis/MTlmNjQxMjZmZjMxNDE4YTg5YjQ5ODgxMzgwODUwN2Y/) 27 Dec. 2014 0xf085a446L\n\n[c85ddcad47577b294b13ce3c8f0134bb](https://malwr.com/analysis/MGMzZDE5M2JkZjgwNDNlNzhkYjlhYTY4YTFmNTNjZGM/) 14 Jan. 2015 0xffc222d4L\n\n[6da71b4317dd664544903cbc872308d7](https://malwr.com/analysis/ZGI1ZTEyMWZkNGFjNDdkOWI5Y2VlM2ZiZTIzMGU0NDk/) 25 Jan. 2015 0xf3fc72bbL\n\n[1667b27c7ca9662330ad15a9ab34dffc](https://malwr.com/analysis/ZDhjNDE0MDZmNjdmNGNkM2JiZmJlN2UyYTE4YTI5ZDM/) 16 Feb. 2015 0x2ff654d0\n\n[cb07607586d35e8a5832c0149f6c244c](https://malwr.com/analysis/OTQ3ZDU5M2E0M2I2NGU0ZjgxN2ExOTlkN2IzMjM1NTg/) 09 Mar. 2015 0x54d64257\n\n[1667b27c7ca9662330ad15a9ab34dffc](https://malwr.com/analysis/Y2FjMWVjMjVjZjNkNDM1ZGFkMjEyYWY2MDA5ZWRkNzY/) 09 Mar. 2015R 0x54d64257\n\n\n[cb07607586d35e8a5832c0149f6c244c](https://malwr.com/analysis/MDkyYjFiMzcxMWU4NGRhMzlkYmQyZGE1MjgwNzJkYjk/) 09 Mar. 2015R 0x54d64257\n\nR: Reanalysis\n\nMost samples on Malwr were analysed in June and July of 2014, but there are also some\nrecent samples.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2015/2015-03-10 - The DGA of Pykspa.pdf"
    ],
    "report_names": [
        "2015-03-10 - The DGA of Pykspa.pdf"
    ],
    "threat_actors": [
        {
            "id": "f8dddd06-da24-4184-9e24-4c22bdd1cbbf",
            "created_at": "2023-01-06T13:46:38.626906Z",
            "updated_at": "2025-03-27T02:00:02.877001Z",
            "deleted_at": null,
            "main_name": "Tick",
            "aliases": [
                "Stalker Taurus",
                "PLA Unit 61419",
                "Nian",
                "BRONZE BUTLER",
                "REDBALDKNIGHT",
                "STALKER PANDA",
                "G0060"
            ],
            "source_name": "MISPGALAXY:Tick",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        },
        {
            "id": "d4e7cd9a-2290-4f89-a645-85b9a46d004b",
            "created_at": "2022-10-25T16:07:23.419513Z",
            "updated_at": "2025-03-27T02:02:09.790389Z",
            "deleted_at": null,
            "main_name": "Bronze Butler",
            "aliases": [
                "Bronze Butler",
                "CTG-2006",
                "Operation ENDTRADE",
                "RedBaldNight",
                "Stalker Panda",
                "Stalker Taurus",
                "TEMP.Tick",
                "Tick"
            ],
            "source_name": "ETDA:Bronze Butler",
            "tools": [
                "8.t Dropper",
                "8.t RTF exploit builder",
                "8t_dropper",
                "9002 RAT",
                "AngryRebel",
                "Blogspot",
                "Daserf",
                "Datper",
                "Elirks",
                "Farfli",
                "Gh0st RAT",
                "Ghost RAT",
                "HOMEUNIX",
                "HidraQ",
                "HomamDownloader",
                "Homux",
                "Hydraq",
                "Lilith",
                "Lilith RAT",
                "McRAT",
                "MdmBot",
                "Mimikatz",
                "Minzen",
                "Moudour",
                "Muirim",
                "Mydoor",
                "Nioupale",
                "PCRat",
                "POISONPLUG.SHADOW",
                "Roarur",
                "RoyalRoad",
                "ShadowPad Winnti",
                "ShadowWali",
                "ShadowWalker",
                "SymonLoader",
                "WCE",
                "Wali",
                "Windows Credential Editor",
                "Windows Credentials Editor",
                "XShellGhost",
                "XXMM",
                "gsecdump",
                "rarstar"
            ],
            "source_id": "ETDA",
            "reports": null
        },
        {
            "id": "bf0489c5-1c07-41e6-91c9-855ad96ccc6a",
            "created_at": "2022-10-25T16:47:55.541639Z",
            "updated_at": "2025-03-27T02:05:17.253496Z",
            "deleted_at": null,
            "main_name": "BRONZE BUTLER",
            "aliases": [
                "Daserf",
                "Stalker Panda ",
                "Tick ",
                "CTG-2006 "
            ],
            "source_name": "Secureworks:BRONZE BUTLER",
            "tools": [
                " DGet",
                " Daserf",
                " Datper",
                " Gofarer",
                " MSGet",
                " Mimikatz",
                " RarStar",
                " Screen Capture Tool",
                " ShadowPad",
                " T-SMB",
                " WinRAR",
                " Windows Credential Editor",
                " gsecdump",
                " xmm downloader",
                " xxmm",
                "ABK"
            ],
            "source_id": "Secureworks",
            "reports": null
        }
    ],
    "ts_created_at": 1683338971,
    "ts_updated_at": 1743041761,
    "ts_creation_date": 1683251704,
    "ts_modification_date": 1683251704,
    "files": {
        "pdf": "https://archive.orkl.eu/56ea0c63f7bb7a53097698bb70b371cdbd638c23.pdf",
        "text": "https://archive.orkl.eu/56ea0c63f7bb7a53097698bb70b371cdbd638c23.txt",
        "img": "https://archive.orkl.eu/56ea0c63f7bb7a53097698bb70b371cdbd638c23.jpg"
    }
}