{
    "id": "388de644-65b1-4b99-8188-6f3f0aa6388e",
    "created_at": "2022-10-27T08:36:14.086977Z",
    "updated_at": "2025-03-27T02:16:26.56089Z",
    "deleted_at": null,
    "sha1_hash": "81ff6711032c52a95e7c812622b4432600ef83bb",
    "title": "",
    "authors": "",
    "file_creation_date": "2021-06-29T07:29:33Z",
    "file_modification_date": "2021-06-29T07:31:14Z",
    "file_size": 10406101,
    "plain_text": "# Certified Pre-Owned\n\n##### Abusing Active Directory Certificate Services\n\n\nWill Schroeder\nLee Christensen\n\n_Version 1.0.1_\n\n\n-----\n\n#### Revision Summary\n\n|Date|Version|Description|\n|---|---|---|\n|2021-06-22|1.0.1|Updated EKU details for ESC1 and ESC2.|\n|2021-06-17|1.0.0|Initial release.|\n\n\n**2021-06-22** 1.0.1 Updated EKU details for ESC1 and ESC2.\n\n**2021-06-17** 1.0.0 Initial release.\n\n\n-----\n\n**TABLE OF CONTENTS**\n\n**ABSTRACT .............................................................................................................................................................. 1**\n\n**INTRODUCTION ..................................................................................................................................................... 2**\n\n**PRIOR WORK ......................................................................................................................................................... 8**\n\n**BACKGROUND ..................................................................................................................................................... 12**\n\nCERTIFICATE TEMPLATES ............................................................................................................................................... 16\nCERTIFICATE ENROLLMENT............................................................................................................................................. 19\nSUBJECT ALTERNATIVE NAMES AND AUTHENTICATION ........................................................................................................ 29\nAD CS ENUMERATION .................................................................................................................................................. 34\n\n**AD CS TRADECRAFT ............................................................................................................................................. 38**\n\nCERTIFICATE THEFT ...................................................................................................................................................... 38\nACCOUNT PERSISTENCE ................................................................................................................................................. 49\nDOMAIN ESCALATION ................................................................................................................................................... 54\nDOMAIN PERSISTENCE .................................................................................................................................................. 82\n\n**PKI ARCHITECTURE FLAWS ................................................................................................................................... 92**\n\nLACK OF OFFLINE ROOT CA AND TIERED ARCHITECTURE ...................................................................................................... 92\nUNPROTECTED SUBORDINATE CAS .................................................................................................................................. 93\nBREAKING FOREST TRUSTS VIA AD CS ............................................................................................................................. 94\n\n**DEFENSIVE GUIDANCE ......................................................................................................................................... 97**\n\nPREVENTIVE GUIDANCE ................................................................................................................................................. 97\nDETECTIVE GUIDANCE ................................................................................................................................................. 115\nINCIDENT RESPONSE GUIDANCE .................................................................................................................................... 136\nDEFENSIVE GAPS AND CHALLENGES ............................................................................................................................... 137\n\n**CONCLUSION ..................................................................................................................................................... 138**\n\n**ACKNOWLEDGEMENTS ...................................................................................................................................... 140**\n\n\n**BACKGROUND ..................................................................................................................................................... 12**\n\nCERTIFICATE TEMPLATES ............................................................................................................................................... 16\nCERTIFICATE ENROLLMENT............................................................................................................................................. 19\nSUBJECT ALTERNATIVE NAMES AND AUTHENTICATION ........................................................................................................ 29\nAD CS ENUMERATION .................................................................................................................................................. 34\n\n**AD CS TRADECRAFT ............................................................................................................................................. 38**\n\nCERTIFICATE THEFT ...................................................................................................................................................... 38\nACCOUNT PERSISTENCE ................................................................................................................................................. 49\nDOMAIN ESCALATION ................................................................................................................................................... 54\nDOMAIN PERSISTENCE .................................................................................................................................................. 82\n\n**PKI ARCHITECTURE FLAWS ................................................................................................................................... 92**\n\nLACK OF OFFLINE ROOT CA AND TIERED ARCHITECTURE ...................................................................................................... 92\nUNPROTECTED SUBORDINATE CAS .................................................................................................................................. 93\nBREAKING FOREST TRUSTS VIA AD CS ............................................................................................................................. 94\n\n**DEFENSIVE GUIDANCE ......................................................................................................................................... 97**\n\nPREVENTIVE GUIDANCE ................................................................................................................................................. 97\nDETECTIVE GUIDANCE ................................................................................................................................................. 115\nINCIDENT RESPONSE GUIDANCE .................................................................................................................................... 136\nDEFENSIVE GAPS AND CHALLENGES ............................................................................................................................... 137\n\n**CONCLUSION ..................................................................................................................................................... 138**\n\n**ACKNOWLEDGEMENTS ...................................................................................................................................... 140**\n\n\n-----\n\n## Abstract\n\nMicrosoft’s Active Directory Public Key Infrastructure (PKI) implementation, known as Active\nDirectory Certificate Services (AD CS), has largely flown under the radar of both the offensive and\ndefensive communities. AD CS is widely deployed, and provides attackers opportunities for\ncredential theft, machine persistence, domain escalation, and subtle domain persistence. We\npresent relevant background on certificates in Active Directory, detail the abuse of AD CS through\ncertificate theft and active malicious enrollments for user and machine persistence, discuss a set\nof common misconfigurations that can result in domain escalation, and explain a method for\nstealing a Certificate Authority’s private key in order to forge new user/machine “golden”\ncertificates. By bringing light to the security implications of AD CS, we hope to raise awareness\nfor both attackers and defenders alike of the security issues surrounding this complex, widely\ndeployed, and often misunderstood system.\n\n\ndefensive communities. AD CS is widely deployed, and provides attackers opportunities for\ncredential theft, machine persistence, domain escalation, and subtle domain persistence. We\npresent relevant background on certificates in Active Directory, detail the abuse of AD CS through\ncertificate theft and active malicious enrollments for user and machine persistence, discuss a set\nof common misconfigurations that can result in domain escalation, and explain a method for\nstealing a Certificate Authority’s private key in order to forge new user/machine “golden”\ncertificates. By bringing light to the security implications of AD CS, we hope to raise awareness\nfor both attackers and defenders alike of the security issues surrounding this complex, widely\ndeployed, and often misunderstood system.\n\n\n-----\n\n## Introduction\n\nActive Directory security has had a huge surge in interest over the last several years. While several\naspects of Active Directory have received thorough attention from a security perspective, one\narea that has been relatively overlooked is Active Directory Certificate Services (AD CS). AD CS is\nMicrosoft’s PKI implementation that integrates with existing Active Directory forests, and\nprovides everything from encrypting file systems, to digital signatures, to user authentication (a\nlarge focus of this paper), and more. While AD CS is not installed by default for Active Directory\nenvironments, from our experience it is widely deployed.\n\nOur research began when with a single sentence in the Active Directory Technical Specification[1]\n(emphasis ours):\n\n_In the case of DCs, the external authentication information that is used to validate the_\n**_identity of the client making the bind request comes from the client certificate presented_**\n_by the client during the SSL/TLS handshake that occurs in response to the client sending_\n_an LDAP_SERVER_START_TLS_OID extended operation._\n\nThis resulted in the question, “How does one use certificates to authenticate to LDAP?” which led\nus to learning about AD CS and how to perform certificate-based authentication. Further\ninvestigation led us down the rabbit hole of attempting to gain a holistic understanding of AD CS’\ncomponents and their security implications.\n\nThis paper aims to be as comprehensive of a reference as possible on the possible attacks against\nAD CS, as well as defensive guidance on how to prevent and detect these types of abuses. We\nbegin with the background needed to understand how AD CS works, including its integration with\nActive Directory authentication, and then move into various attacks and associated defenses.\nSpecifically, we highlight certificate theft and malicious certificate enrollments for user and\nmachine persistence, a set of common certificate template misconfigurations that result in\ndomain escalation, and a method for stealing a Certificate Authority’s (CA) private key (if it is not\nhardware protected) in order to forge certificates.\n\nThis paper briefly reviews AD CS, including its components and how the certificate enrollment\nprocess works. We discuss the storage of issued certificates and their associated private keys,\nincluding common file formats and how the Windows stores them. This includes information\n\n1 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/126300e8-5ff9-4643-9ac6-97e3f4aa1926\n\n\narea that has been relatively overlooked is Active Directory Certificate Services (AD CS). AD CS is\nMicrosoft’s PKI implementation that integrates with existing Active Directory forests, and\nprovides everything from encrypting file systems, to digital signatures, to user authentication (a\nlarge focus of this paper), and more. While AD CS is not installed by default for Active Directory\nenvironments, from our experience it is widely deployed.\n\nOur research began when with a single sentence in the Active Directory Technical Specification\n(emphasis ours):\n\n_In the case of DCs, the external authentication information that is used to validate the_\n**_identity of the client making the bind request comes from the client certificate presented_**\n_by the client during the SSL/TLS handshake that occurs in response to the client sending_\n_an LDAP_SERVER_START_TLS_OID extended operation._\n\nThis resulted in the question, “How does one use certificates to authenticate to LDAP?” which led\nus to learning about AD CS and how to perform certificate-based authentication. Further\ninvestigation led us down the rabbit hole of attempting to gain a holistic understanding of AD CS’\ncomponents and their security implications.\n\nThis paper aims to be as comprehensive of a reference as possible on the possible attacks against\nAD CS, as well as defensive guidance on how to prevent and detect these types of abuses. We\nbegin with the background needed to understand how AD CS works, including its integration with\nActive Directory authentication, and then move into various attacks and associated defenses.\nSpecifically, we highlight certificate theft and malicious certificate enrollments for user and\nmachine persistence, a set of common certificate template misconfigurations that result in\ndomain escalation, and a method for stealing a Certificate Authority’s (CA) private key (if it is not\nhardware protected) in order to forge certificates.\n\nThis paper briefly reviews AD CS, including its components and how the certificate enrollment\n\n\n-----\n\nabout using Windows’s Data Protection API (DPAPI) in conjunction with the Mimikatz[2] and\nSharpDPAPI[3] toolsets to extract certificates and their private keys.\n\nWe discuss how attackers can leverage certain user and machine certificates to authenticate to\nActive Directory using multiple protocols, constituting a form of credential theft that the\noffensive industry has largely been unaware of until now. Furthermore, we examine how\ncombining the theft of machine certificates in conjunction with Kerberos resource-based\nconstrained delegation (RBCD)[4] can be used for reliable long term machine persistence.\n\nBeyond the theft of existing certificates, we examine how attackers can request or renew\ncertificates for users and computers, providing the same persistence approaches as mentioned\nabove. While issuing requests has always been possible using GUI-based mmc.exe snap-ins and\ncertreq.exe, a weaponized method that satisfied requirements while operating over a command\nand control (C2) channel has not existed. As a result, we built the Certify toolset to fill this gap,\nwhich we will be releasing approximately 45 days after this paper is released. Certify provides a\nwide range of audit and AD CS functionality that we discuss throughout this paper, including the\nability to request new certificates for the currently authenticated user or computer.\n\nWe will then examine a set of common misconfigurations that we have seen in many\nenvironments. Since beginning this research, we have analyzed many networks for these AD CS\nmisconfigurations. In nearly every network so far, AD privilege escalation was possible using one\nof these attacks, and low-privileged users (e.g., members of the “Domain Users” group) almost\nalways had the ability to immediately compromise the Active Directory forest. We also discuss a\nvariant that results from an enrollment CA misconfiguration, as well as a NTLM relay scenario to\nAD CS web enrollment endpoints.\n\nWe then move on to exploring is this statement from Microsoft’s documentation[5]:\n\n_If the CA private key were compromised, the attacker could perform operations as the CA._\n\nWhile this attack has been talked about from a theoretical perspective, we have not found\ndefinitive documentation on weaponization. We will show how to use both the SharpDPAPI and\nMimikatz toolsets to extract a CA’s private key if not hardware protected, and then use that key\nto forge certificates for any principal in the domain. Attackers can use these forged certificates\nto authenticate as any active user/computer in the domain, and these certificates cannot be\nrevoked as long as the CA’s certificate is still valid and trusted. We will discuss forging new\n\n[2 https://github.com/gentilkiwi/mimikatz/](https://github.com/gentilkiwi/mimikatz/)\n\n[3 https://github.com/GhostPack/SharpDPAPI](https://github.com/GhostPack/SharpDPAPI)\n\n[4 https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html)\n\n[5 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn786426(v=ws.11)#protect-ca-private-keys](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn786426(v=ws.11)#protect-ca-private-keys)\n\n\nActive Directory using multiple protocols, constituting a form of credential theft that the\noffensive industry has largely been unaware of until now. Furthermore, we examine how\ncombining the theft of machine certificates in conjunction with Kerberos resource-based\nconstrained delegation (RBCD)[4] can be used for reliable long term machine persistence.\n\nBeyond the theft of existing certificates, we examine how attackers can request or renew\ncertificates for users and computers, providing the same persistence approaches as mentioned\nabove. While issuing requests has always been possible using GUI-based mmc.exe snap-ins and\ncertreq.exe, a weaponized method that satisfied requirements while operating over a command\nand control (C2) channel has not existed. As a result, we built the Certify toolset to fill this gap,\nwhich we will be releasing approximately 45 days after this paper is released. Certify provides a\nwide range of audit and AD CS functionality that we discuss throughout this paper, including the\nability to request new certificates for the currently authenticated user or computer.\n\nWe will then examine a set of common misconfigurations that we have seen in many\nenvironments. Since beginning this research, we have analyzed many networks for these AD CS\nmisconfigurations. In nearly every network so far, AD privilege escalation was possible using one\nof these attacks, and low-privileged users (e.g., members of the “Domain Users” group) almost\nalways had the ability to immediately compromise the Active Directory forest. We also discuss a\nvariant that results from an enrollment CA misconfiguration, as well as a NTLM relay scenario to\nAD CS web enrollment endpoints.\n\nWe then move on to exploring is this statement from Microsoft’s documentation[5]:\n\n_If the CA private key were compromised, the attacker could perform operations as the CA._\n\nWhile this attack has been talked about from a theoretical perspective, we have not found\ndefinitive documentation on weaponization. We will show how to use both the SharpDPAPI and\nMimikatz toolsets to extract a CA’s private key if not hardware protected, and then use that key\n\n\n-----\n\ncertificates using a tool we built called ForgeCert[6], which we will be releasing with Certify on the\npreviously mentioned 45-day delayed schedule.\n\nFinally, we discuss how some organizations do not follow Microsoft’s guidance when it comes to\narchitecting AD CS. Consequently, this results in much less secure and compromise-resilient AD\nCS infrastructure. We will also discuss how even when following Microsoft’s guidance, attackers\ncan possibly abuse shared PKI systems to break the AD forest trust boundary.\n\nMuch of the information in this paper exists sparsely scattered throughout the Internet, albeit\noften in somewhat theoretical forms. However, given the proliferation of AD CS, its core\nintegration with Active Directory forests, and the access longevity it could provide to an attacker,\nit would be unwise to assume that AD CS has not been a target for advanced adversaries for\nyears.\n\nDue to the severity of the misconfigurations, our belief that these issues are likely widespread\n(backed by data from several networks we have analyzed), and the engineering effort involved\nin fixing them, we are refraining from releasing our weaponized toolsets until approximately 45\ndays after this whitepaper is published. Before then, we are releasing a PowerShell tool titled\nPSPKIAudit[7] that utilizes PKISolutions’ PSPKI PowerShell module[8] to enumerate any\nmisconfigured templates. If any are found, we recommend following steps in the _“Defensive_\nGuidance” section.\n\nDue to the number of AD CS abuse techniques identified during our research, we decided to\nbreak each attack technique with an identifier so they can be easily correlated with associated\ndefensive guidance at the end of this paper. These offensive technique IDs are used in the title\nof each section describing a technique, as well as in relevant defensive sections so controls can\neasily be mapped back to offensive techniques.\n\n**Offensive**\n**Description**\n**Technique ID**\n\n**THEFT1** Exporting certificates and their private keys using Window’s Crypto APIs\n\n**THEFT2** Extracting user certificates and private keys using DPAPI\n\n[6 https://github.com/GhostPack/ForgeCert](https://github.com/GhostPack/ForgeCert)\n\n[7 https://github.com/GhostPack/PSPKIAudit](https://github.com/GhostPack/PSPKIAudit)\n\n[8 https://github.com/PKISolutions/PSPKI](https://github.com/PKISolutions/PSPKI)\n\n|Offensive Technique ID|Description|\n|---|---|\n|THEFT1|Exporting certificates and their private keys using Window’s Crypto APIs|\n|THEFT2|Extracting user certificates and private keys using DPAPI|\n\n\narchitecting AD CS. Consequently, this results in much less secure and compromise-resilient AD\nCS infrastructure. We will also discuss how even when following Microsoft’s guidance, attackers\ncan possibly abuse shared PKI systems to break the AD forest trust boundary.\n\nMuch of the information in this paper exists sparsely scattered throughout the Internet, albeit\noften in somewhat theoretical forms. However, given the proliferation of AD CS, its core\nintegration with Active Directory forests, and the access longevity it could provide to an attacker,\nit would be unwise to assume that AD CS has not been a target for advanced adversaries for\nyears.\n\nDue to the severity of the misconfigurations, our belief that these issues are likely widespread\n(backed by data from several networks we have analyzed), and the engineering effort involved\nin fixing them, we are refraining from releasing our weaponized toolsets until approximately 45\ndays after this whitepaper is published. Before then, we are releasing a PowerShell tool titled\nPSPKIAudit[7] that utilizes PKISolutions’ PSPKI PowerShell module[8] to enumerate any\nmisconfigured templates. If any are found, we recommend following steps in the _“Defensive_\nGuidance” section.\n\nDue to the number of AD CS abuse techniques identified during our research, we decided to\nbreak each attack technique with an identifier so they can be easily correlated with associated\ndefensive guidance at the end of this paper. These offensive technique IDs are used in the title\nof each section describing a technique, as well as in relevant defensive sections so controls can\neasily be mapped back to offensive techniques.\n\n**Offensive**\n**Description**\n**Technique ID**\n\n**THEFT1** Exporting certificates and their private keys using Window’s Crypto APIs\n\n\n-----\n\n|THEFT3|Extracting machine certificates and private keys using DPAPI|\n|---|---|\n|THEFT4|Theft of existing certificates via file/directory triage|\n|THEFT5|Using the Kerberos PKINIT protocol to retrieve an account’s NTLM hash|\n|PERSIST1|Account persistence via requests for new authentication certificates for a user|\n|PERSIST2|Account persistence via requests for new authentication certificates for a computer|\n|PERSIST3|Account persistence via renewal of authentication certificates for a user/computer|\n|ESC1|Domain escalation via No Issuance Requirements + Enrollable Client Authentication/Smart Card Logon OID templates + CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT|\n|ESC2|Domain escalation via No Issuance Requirements + Enrollable Any Purpose EKU or no EKU|\n|ESC3|Domain escalation via No Issuance Requirements + Certificate Request Agent EKU + no enrollment agent restrictions|\n|ESC4|Domain escalation via misconfigured certificate template access control|\n|ESC5|Domain escalation via vulnerable PKI AD Object Access Control|\n|ESC6|Domain escalation via the EDITF_ATTRIBUTESUBJECTALTNAME2 setting on CAs + No Manager Approval + Enrollable Client Authentication/Smart Card Logon OID templates|\n\n\n**THEFT5** Using the Kerberos PKINIT protocol to retrieve an account’s NTLM hash\n\n**PERSIST1** Account persistence via requests for new authentication certificates for a\nuser\n\n**PERSIST2** Account persistence via requests for new authentication certificates for a\ncomputer\n\n**PERSIST3** Account persistence via renewal of authentication certificates for a\nuser/computer\n\n**ESC1** Domain escalation via No Issuance Requirements + Enrollable Client\nAuthentication/Smart Card Logon OID templates +\nCT_FLAG_ENROLLEE_SUPPLIES_SUBJECT\n\n**ESC2** Domain escalation via No Issuance Requirements + Enrollable Any Purpose\nEKU or no EKU\n\n**ESC3** Domain escalation via No Issuance Requirements + Certificate Request\nAgent EKU + no enrollment agent restrictions\n\n**ESC4** Domain escalation via misconfigured certificate template access control\n\n**ESC5** Domain escalation via vulnerable PKI AD Object Access Control\n\n\n-----\n\n|ESC7|Vulnerable Certificate Authority Access Control|\n|---|---|\n|ESC8|NTLM Relay to AD CS HTTP Endpoints|\n|DPERSIST1|Domain persistence via certificate forgery with stolen CA private keys|\n|DPERSIST2|Domain persistence via certificate forgery from maliciously added root/intermediate/NTAuth CA certificates|\n|DPERSIST3|Domain persistence via malicious misconfigurations that can later cause a domain escalation|\n\n\nWe also numbered the preventative (PREVENTX) and detective (DETECTX) controls for easier\ncorrelation. Appropriate IDs are at the end of each offensive technique section so attacks can\nalso be easily forward mapped to their associated defensive controls.\n\n|Defensive Technique ID|Description|\n|---|---|\n|PREVENT1|Treat CAs as Tier 0 Assets|\n|PREVENT2|Harden CA settings|\n|PREVENT3|Audit Published templates|\n|PREVENT4|Harden Certificate Template Settings|\n|PREVENT5|Audit NtAuthCertificates|\n|PREVENT6|Secure Certificate Private Key Storage|\n|PREVENT7|Enforce Strict User Mappings|\n\n\n**DPERSIST1** Domain persistence via certificate forgery with stolen CA private keys\n\n**DPERSIST2** Domain persistence via certificate forgery from maliciously added\nroot/intermediate/NTAuth CA certificates\n\n**DPERSIST3** Domain persistence via malicious misconfigurations that can later cause a\ndomain escalation\n\nWe also numbered the preventative (PREVENTX) and detective (DETECTX) controls for easier\ncorrelation. Appropriate IDs are at the end of each offensive technique section so attacks can\nalso be easily forward mapped to their associated defensive controls.\n\n**Defensive**\n**Description**\n**Technique ID**\n\n**PREVENT1** Treat CAs as Tier 0 Assets\n\n**PREVENT2** Harden CA settings\n\n**PREVENT3** Audit Published templates\n\n**PREVENT4** Harden Certificate Template Settings\n\n**PREVENT5** Audit NtAuthCertificates\n\n\n-----\n\n|PREVENT8|Harden AD CS HTTP Enrollment Endpoints|\n|---|---|\n|DETECT1|Monitor User/Machine Certificate Enrollments|\n|DETECT2|Monitor Certificate Authentication Events|\n|DETECT3|Monitor Certificate Authority Backup Events|\n|DETECT4|Monitor Certificate Template Modifications|\n|DETECT5|Detecting Reading of DPAPI-Encrypted Keys|\n|DETECT6|Use Honey Credentials|\n|DETECT7|Miscellaneous|\n\n\n**DETECT2** Monitor Certificate Authentication Events\n\n**DETECT3** Monitor Certificate Authority Backup Events\n\n**DETECT4** Monitor Certificate Template Modifications\n\n**DETECT5** Detecting Reading of DPAPI-Encrypted Keys\n\n**DETECT6** Use Honey Credentials\n\n**DETECT7** Miscellaneous\n\n\n-----\n\n## Prior Work\n\nBenjamin Delpy[9], as is often the case, was years ahead of us with his work on Mimikatz[10] and\nKekeo.[11] As such is the case here as well, with him having added functionality to interact with AD\nCS back in 2016[12]:\n\n_[https://twitter.com/gentilkiwi/status/1117124086604488709](https://twitter.com/gentilkiwi/status/1117124086604488709)_\n\nHis published material[13] primarily discusses certificates in the context of smart card[14]\nauthentication and encrypted file systems[15], but the astute learner can use the concepts he\n\n[9 https://twitter.com/gentilkiwi/](https://twitter.com/gentilkiwi/)\n\n[10 https://github.com/gentilkiwi/mimikatz](https://github.com/gentilkiwi/mimikatz)\n\n[11 https://github.com/gentilkiwi/kekeo/](https://github.com/gentilkiwi/kekeo/)\n\n12 https://twitter.com/gentilkiwi/status/774722617492312064\n\n[13 https://msrnd-cdn-stor.azureedge.net/bluehat/bluehatil/2019/assets/doc/You%20(dis)liked%20mimikatz%20Wait%20for%20kekeo.pdf](https://msrnd-cdn-stor.azureedge.net/bluehat/bluehatil/2019/assets/doc/You%20(dis)liked%20mimikatz%20Wait%20for%20kekeo.pdf)\n\n[14 https://github.com/comaeio/OPCDE/tree/master/2017/From%20mimikatz%20to%20kekeo%2C%20passing%20by%20new%20Microsoft%20security%20technologies%20-%20Benjamin%20Delpy](https://github.com/comaeio/OPCDE/tree/master/2017/From%20mimikatz%20to%20kekeo%2C%20passing%20by%20new%20Microsoft%20security%20technologies%20-%20Benjamin%20Delpy)\n\n[15 https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files](https://github.com/gentilkiwi/mimikatz/wiki/howto-%7E-decrypt-EFS-files)\n\n\nBenjamin Delpy[9], as is often the case, was years ahead of us with his work on Mimikatz[10] and\nKekeo.[11] As such is the case here as well, with him having added functionality to interact with AD\nCS back in 2016[12]:\n\n_[https://twitter.com/gentilkiwi/status/1117124086604488709](https://twitter.com/gentilkiwi/status/1117124086604488709)_\n\n\n-----\n\ndiscusses to abuse all other forms of certificate tradecraft using Mimikatz and Kekeo. We will\ncover various aspects of Mimikatz and Kekeo functionality throughout this paper.\n\nPKI Solutions has several excellent blog posts concerning PKI in AD[16] that we studied as we were\nlearning about AD CS. They also have a great PowerShell module, PSPKI[17], for querying and\ninteracting with AD CS components. PKI solutions also recommended Brian Komar’s book\n“Windows Server 2008 - PKI and Certificate Security[18]” which, while old, proved to still be a\nfantastic resource for understanding AD CS and PKI.\n\nWe also relied heavily on the following open technical specifications provided by Microsoft for\nbackground information and for details about AD CS:\n\n - [MS-CERSOD]: Certificate Services Protocols Overview[19]\n\n - [MS-CRTD]: Certificate Templates Structure[20]\n\n - [MS-CSRA]: Certificate Services Remote Administration Protocol[21]\n\n - [MS-ICPR]: ICertPassage Remote Protocol[22]\n\n - [MS-WCCE]: Windows Client Certificate Enrollment Protocol[23]\n\nChristoph Falta’s GitHub repo[24] covers some details on attacking certificate templates, including\nvirtual smart cards as well as some ideas on ACL based abuses:\n\n_If an attacker gains access (Write/Enroll or WriteDACL) to any template, it is possible to_\n_reconfigure that template to issue certificates for Smartcard Logon. The attacker can even_\n_enroll these certificate for any given user, since the setting that defines the CN of the_\n_certificate is controlled in the template._\n\nCQURE release a post titled “The tale of Enhanced Key (mis)Usage[25]” which covers some Subject\nAlternative Name abuses, including the EDITF_ATTRIBUTESUBJECTALTNAME2 configuration\noption which we will dive into in this paper. They also detail some of the offensive implications\nof host certificate theft (emphasis ours):\n\n[16 https://www.pkisolutions.com/thepkiblog/](https://www.pkisolutions.com/thepkiblog/)\n\n[17 https://github.com/PKISolutions/PSPKI](https://github.com/PKISolutions/PSPKI)\n\n[18 https://www.microsoftpressstore.com/store/windows-server-2008-pki-and-certificate-security-9780735640788](https://www.microsoftpressstore.com/store/windows-server-2008-pki-and-certificate-security-9780735640788)\n\n[19 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-cersod/ec4bb597-9e73-4d2b-a768-621239e21fca](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-cersod/ec4bb597-9e73-4d2b-a768-621239e21fca)\n\n[20 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/4c6950e4-1dc2-4ae3-98c3-b8919bb73822](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/4c6950e4-1dc2-4ae3-98c3-b8919bb73822)\n\n[21 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/40e74714-14bf-4f97-a264-35efbd63a813](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/40e74714-14bf-4f97-a264-35efbd63a813)\n\n[22 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-icpr/9b8ed605-6b00-41d1-9a2a-9897e40678fc](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-icpr/9b8ed605-6b00-41d1-9a2a-9897e40678fc)\n\n[23 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wcce/446a0fca-7f27-4436-965d-191635518466](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wcce/446a0fca-7f27-4436-965d-191635518466)\n\n[24 https://github.com/cfalta/PoshADCS](https://github.com/cfalta/PoshADCS)\n\n[25 https://cqureacademy.com/blog/enhanced-key-usage](https://cqureacademy.com/blog/enhanced-key-usage)\n\n\ncover various aspects of Mimikatz and Kekeo functionality throughout this paper.\n\nPKI Solutions has several excellent blog posts concerning PKI in AD[16] that we studied as we were\nlearning about AD CS. They also have a great PowerShell module, PSPKI[17], for querying and\ninteracting with AD CS components. PKI solutions also recommended Brian Komar’s book\n_Windows Server 2008 - PKI and Certificate Security[18]” which, while old, proved to still be a_\nfantastic resource for understanding AD CS and PKI.\n\nWe also relied heavily on the following open technical specifications provided by Microsoft for\nbackground information and for details about AD CS:\n\n - [MS-CERSOD]: Certificate Services Protocols Overview[19]\n\n - [MS-CRTD]: Certificate Templates Structure[20]\n\n - [MS-CSRA]: Certificate Services Remote Administration Protocol[21]\n\n - [MS-ICPR]: ICertPassage Remote Protocol[22]\n\n - [MS-WCCE]: Windows Client Certificate Enrollment Protocol[23]\n\nChristoph Falta’s GitHub repo[24] covers some details on attacking certificate templates, including\nvirtual smart cards as well as some ideas on ACL based abuses:\n\n_If an attacker gains access (Write/Enroll or WriteDACL) to any template, it is possible to_\n_reconfigure that template to issue certificates for Smartcard Logon. The attacker can even_\n_enroll these certificate for any given user, since the setting that defines the CN of the_\n_certificate is controlled in the template._\n\nCQURE release a post titled “The tale of Enhanced Key (mis)Usage[25]” which covers some Subject\nAlternative Name abuses, including the EDITF_ATTRIBUTESUBJECTALTNAME2 configuration\noption which we will dive into in this paper. They also detail some of the offensive implications\nof host certificate theft (emphasis ours):\n\n\n-----\n\n_When a user’s workstation is compromised, the attacker can potentially steal certificates_\n_along with their private keys (unless additional protection is in a place like by Trusted_\n_Platform Module (TPM))._ **_Then reimage of the workstation and resetting the user’s_**\n**_password(s) is not enough because the attacker may still possess a valid user certificate_**\n**_which allows for network logon using the victim’s identity._**\n\nIn 2016, Keyfactor released a post titled “Hidden Dangers: Certificate Subject Alternative Names\n_(SANs)[26]” also detailing the dangers of EDITF_ATTRIBUTESUBJECTALTNAME2._\n\n@Elkement[27] released two posts, “Sizzle @ hackthebox – Unintended: Getting a Logon Smartcard\n_for the Domain Admin![28]” and “Impersonating a Windows Enterprise Admin with a Certificate:_\n_Kerberos PKINIT from Linux[29]” detailing an unintended solution to a Hack The Box challenge_\ninvolving certificate template abuse. The posts detail the misconfiguration that occurs when\nthere is an overly permissive certificate template with the\n```\nCT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag enabled. We will detail this misconfiguration as\n\n```\nwell as malicious template modification later in this paper.\n\nAs for how these types of template misconfigurations tend to happen, Carl Sörqvist wrote up a\ndetailed, and plausible, scenario in 2020 titled “Supply in the Request Shenanigans[30]”.\nSpecifically, he covers how sysadmins without proper knowledge of the security implications of\ncertificate template settings could accidentally configure a template capable of domain\nauthentication that also allows an alternative subject name specification.\n\nCeri Coburn released an excellent post in 2020 on “Attacking Smart Card Based Active Directory\n_Networks[31]”. In it they detail attacking smart cards (including smartcard pin theft) as well as how_\nPKINIT works in AD. They also pushed a pull request[32] for the Rubeus C# Kerberos abuse toolkit\nthat implemented PKINIT certificate support. This work was a vital piece to the research in this\npaper, as it allows for ticket-granting-ticket (TGT) requests with certificates.\n\nBrad Hill published a whitepaper titled “Weaknesses and Best Practices of Public Key Kerberos\n_with Smart Cards[33]” which provided some good background on Kerberos/PKINIT from a security_\nperspective.\n\n[26 https://blog.keyfactor.com/hidden-dangers-certificate-subject-alternative-names-sans](https://blog.keyfactor.com/hidden-dangers-certificate-subject-alternative-names-sans)\n\n[27 https://twitter.com/elkement](https://twitter.com/elkement)\n\n[28 https://elkement.blog/2019/06/01/sizzle-hackthebox-unintended-getting-a-logon-smartcard-for-the-domain-admin-2/](https://elkement.blog/2019/06/01/sizzle-hackthebox-unintended-getting-a-logon-smartcard-for-the-domain-admin-2/)\n\n[29 https://elkement.wordpress.com/2020/06/21/impersonating-a-windows-enterprise-admin-with-a-certificate-kerberos-pkinit-from-linux/](https://elkement.wordpress.com/2020/06/21/impersonating-a-windows-enterprise-admin-with-a-certificate-kerberos-pkinit-from-linux/)\n\n[30 https://blog.qdsecurity.se/2020/09/04/supply-in-the-request-shenanigans/](https://blog.qdsecurity.se/2020/09/04/supply-in-the-request-shenanigans/)\n\n[31 https://ethicalchaos.dev/2020/10/04/attacking-smart-card-based-active-directory-networks/](https://ethicalchaos.dev/2020/10/04/attacking-smart-card-based-active-directory-networks/)\n\n[32 https://github.com/GhostPack/Rubeus/blob/master/CHANGELOG.md#160---2020-11-06](https://github.com/GhostPack/Rubeus/blob/master/CHANGELOG.md#160---2020-11-06)\n\n[33 https://research.nccgroup.com/wp-content/uploads/2020/07/weaknesses_and_best_practices_of_public_key_kerberos_with_smart_cards.pdf](https://research.nccgroup.com/wp-content/uploads/2020/07/weaknesses_and_best_practices_of_public_key_kerberos_with_smart_cards.pdf)\n\n\n_Platform Module (TPM))._ **_Then reimage of the workstation and resetting the user’s_**\n**_password(s) is not enough because the attacker may still possess a valid user certificate_**\n**_which allows for network logon using the victim’s identity._**\n\nIn 2016, Keyfactor released a post titled “Hidden Dangers: Certificate Subject Alternative Names\n_(SANs)[26]” also detailing the dangers of EDITF_ATTRIBUTESUBJECTALTNAME2._\n\n@Elkement[27] released two posts, “Sizzle @ hackthebox – Unintended: Getting a Logon Smartcard\n_for the Domain Admin![28]” and “Impersonating a Windows Enterprise Admin with a Certificate:_\n_Kerberos PKINIT from Linux[29]” detailing an unintended solution to a Hack The Box challenge_\ninvolving certificate template abuse. The posts detail the misconfiguration that occurs when\nthere is an overly permissive certificate template with the\n```\nCT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag enabled. We will detail this misconfiguration as\n\n```\nwell as malicious template modification later in this paper.\n\nAs for how these types of template misconfigurations tend to happen, Carl Sörqvist wrote up a\ndetailed, and plausible, scenario in 2020 titled “Supply in the Request Shenanigans[30]\nSpecifically, he covers how sysadmins without proper knowledge of the security implications of\ncertificate template settings could accidentally configure a template capable of domain\nauthentication that also allows an alternative subject name specification.\n\nCeri Coburn released an excellent post in 2020 on “Attacking Smart Card Based Active Directory\n_Networks[31]”. In it they detail attacking smart cards (including smartcard pin theft) as well as how_\nPKINIT works in AD. They also pushed a pull request[32] for the Rubeus C# Kerberos abuse toolkit\nthat implemented PKINIT certificate support. This work was a vital piece to the research in this\npaper, as it allows for ticket-granting-ticket (TGT) requests with certificates.\n\nBrad Hill published a whitepaper titled “Weaknesses and Best Practices of Public Key Kerberos\n_with Smart Cards[33]” which provided some good background on Kerberos/PKINIT from a security_\n\n\n-----\n\nSpecial thanks to Mark Gamache[34] for collaborating with us on parts of this work. He\nindependently discovered many of these abuses, reached out to us, and brought many additional\ndetails to our attention while we were performing this research.\n\nAs always, we tried our best to cite the existing work out there that we came across, but we’re\nsure we missed things. Much of what we are presenting here draws from and builds heavily on\nthe above material, with some additional research and weaponization that we will cover.\n\n[34 https://twitter.com/markgamacheNerd](https://twitter.com/markgamacheNerd)\n\n\nsure we missed things. Much of what we are presenting here draws from and builds heavily on\nthe above material, with some additional research and weaponization that we will cover.\n\n\n-----\n\n## Background\n\nMicrosoft defines Active Directory Certificate Services (AD CS) as, “...the server role that allows\n_you to build a public key infrastructure (PKI) and provide public key cryptography, digital_\n_certificates, and digital signature capabilities for your organization.[35]” Windows 2000 introduced_\nthis server role, allowing its deployment in one of two configurations: as a standalone\ncertification authority (CA) or as an enterprise CA that integrates with AD. This paper will cover\nthe Enterprise CA role as we see it commonly deployed in environments. PKI and AD CS are not\nsimple systems, and while we are going to dive into some of its specifics, we want to start with\nan overview of what certificates are, the high-level components of AD CS, and how clients request\ncertificates in AD CS environments.\n\nA certificate is an X.509-formatted digitally signed document used for encryption, message\nsigning, and/or authentication. A certificate typically has various fields, including some of the\nfollowing:\n\n - **Subject - The owner of the certificate.**\n\n - **Public Key - Associates the Subject with a private key stored separately.**\n\n - **NotBefore and NotAfter dates - Define the duration that the certificate is valid.**\n\n - **Serial Number - An identifier for the certificate assigned by the CA.**\n\n - **Issuer - Identifies who issued the certificate (commonly a CA).**\n\n - **SubjectAlternativeName - Defines one or more alternate names that the Subject may go**\nby.\n\n - **Basic Constraints - Identifies if the certificate is a CA or an end entity, and if there are any**\nconstraints when using the certificate.\n\n - **Extended Key Usages (EKUs) - Object identifiers (OIDs) that describe how the certificate**\nwill be used. Also known as Enhanced Key Usage in Microsoft parlance. Common EKU\nOIDs include:\n\n    - Code Signing (OID 1.3.6.1.5.5.7.3.3) - The certificate is for signing executable code.\n\n    - Encrypting File System (OID 1.3.6.1.4.1.311.10.3.4) - The certificate is for\nencrypting file systems.\n\n    - Secure Email (1.3.6.1.5.5.7.3.4) - The certificate is for encrypting email.\n\n    - Client Authentication (OID 1.3.6.1.5.5.7.3.2) - The certificate is for authentication\nto another server (e.g., to AD).\n\n    - Smart Card Logon (OID 1.3.6.1.4.1.311.20.2.2) - The certificate is for use in smart\ncard authentication.\n\n[35 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831740(v=ws.11)](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831740(v=ws.11))\n\n\n_certificates, and digital signature capabilities for your organization.[35]” Windows 2000 introduced_\nthis server role, allowing its deployment in one of two configurations: as a standalone\ncertification authority (CA) or as an enterprise CA that integrates with AD. This paper will cover\nthe Enterprise CA role as we see it commonly deployed in environments. PKI and AD CS are not\nsimple systems, and while we are going to dive into some of its specifics, we want to start with\nan overview of what certificates are, the high-level components of AD CS, and how clients request\ncertificates in AD CS environments.\n\nA certificate is an X.509-formatted digitally signed document used for encryption, message\nsigning, and/or authentication. A certificate typically has various fields, including some of the\nfollowing:\n\n - **Subject - The owner of the certificate.**\n\n - **Public Key - Associates the Subject with a private key stored separately.**\n\n - **NotBefore and NotAfter dates - Define the duration that the certificate is valid.**\n\n - **Serial Number - An identifier for the certificate assigned by the CA.**\n\n - **Issuer - Identifies who issued the certificate (commonly a CA).**\n\n - **SubjectAlternativeName - Defines one or more alternate names that the Subject may go**\nby.\n\n - **Basic Constraints - Identifies if the certificate is a CA or an end entity, and if there are any**\nconstraints when using the certificate.\n\n - **Extended Key Usages (EKUs) - Object identifiers (OIDs) that describe how the certificate**\nwill be used. Also known as Enhanced Key Usage in Microsoft parlance. Common EKU\nOIDs include:\n\n    - Code Signing (OID 1.3.6.1.5.5.7.3.3) - The certificate is for signing executable code.\n\n    - Encrypting File System (OID 1.3.6.1.4.1.311.10.3.4) - The certificate is for\nencrypting file systems.\n\n    - Secure Email (1.3.6.1.5.5.7.3.4) - The certificate is for encrypting email.\n\n\n-----\n\n    - Server Authentication (OID 1.3.6.1.5.5.7.3.1) - The certificate is for identifying\nservers (e.g., HTTPS certificates).\n\n - **Signature Algorithm - Specifies the algorithm used to sign the certificate.**\n\n - **Signature - The signature of the certificates body made using the issuer’s (e.g., a CA’s)**\nprivate key.\n\nThe information included in a certificate binds an identity - the Subject - to the key pair. An\napplication can then use the key pair in operations as proof of the identity of the user.\n\nCAs are responsible for issuing certificates. Upon its creation, the CA first needs to create its own\nprivate-public key pair and certificate that it will use when issuing certificates. The CA generates\nits own root CA certificate by signing a new certificate using its private key (that is, the root CA\ncertificate is self-signed). AD CS will set the certificate’s Subject and Issuer fields to the CA’s\nname, the Basic Constraints to Subject Type=CA, and the NotBefore/NotAfter fields\nto five years (by default). Hosts then add the root CA certificate to their trust store to build a trust\nrelationship with the CA.\n\nAD CS defines CA certificates the AD forest trusts in four locations under the container CN=Public\n**Key Services,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>, each differing by their**\npurpose[36]:\n\n - The Certification Authorities container defines trusted root CA certificates. These CAs are\nat the top of the PKI tree hierarchy and are the basis of trust in AD CS environments. Each\nCA is represented as an AD object inside the container where the objectClass is set to\n```\n   certificationAuthority and the cACertificate property contains the bytes of\n\n```\nthe CA’s certificate. Windows propagates these CA certificates to the _Trusted Root_\n_Certification Authorities certificate store on each Windows machine. For AD to consider a_\ncertificate as trusted, the certificate’s trust chain must eventually end with one of the root\nCA’s defined in this container.\n\n - The Enrollment Services container defines each Enterprise CA (i.e., CAs created in AD CS\nwith the Enterprise CA role enabled). Each Enterprise CA has an AD object with the\nfollowing attributes:\n\n    - An objectClass attribute to pKIEnrollmentService\n\n    - A cACertificate attribute containing the bytes of the CA’s certificate\n\n    - A dNSHostName property sets the DNS host of the CA\n\n[36 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831740(v=ws.11)](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831740(v=ws.11))\n\n\nprivate key.\n\nThe information included in a certificate binds an identity - the Subject - to the key pair. An\napplication can then use the key pair in operations as proof of the identity of the user.\n\nCAs are responsible for issuing certificates. Upon its creation, the CA first needs to create its own\nprivate-public key pair and certificate that it will use when issuing certificates. The CA generates\nits own root CA certificate by signing a new certificate using its private key (that is, the root CA\ncertificate is self-signed). AD CS will set the certificate’s Subject and Issuer fields to the CA’s\nname, the Basic Constraints to Subject Type=CA, and the NotBefore/NotAfter fields\nto five years (by default). Hosts then add the root CA certificate to their trust store to build a trust\nrelationship with the CA.\n\nAD CS defines CA certificates the AD forest trusts in four locations under the container CN=Public\n**Key Services,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>, each differing by their**\npurpose[36]:\n\n - The Certification Authorities container defines trusted root CA certificates. These CAs are\nat the top of the PKI tree hierarchy and are the basis of trust in AD CS environments. Each\nCA is represented as an AD object inside the container where the objectClass is set to\n```\n   certificationAuthority and the cACertificate property contains the bytes of\n\n```\nthe CA’s certificate. Windows propagates these CA certificates to the _Trusted Root_\n_Certification Authorities certificate store on each Windows machine. For AD to consider a_\ncertificate as trusted, the certificate’s trust chain must eventually end with one of the root\nCA’s defined in this container.\n\n - The Enrollment Services container defines each Enterprise CA (i.e., CAs created in AD CS\nwith the Enterprise CA role enabled). Each Enterprise CA has an AD object with the\nfollowing attributes:\n\n\n-----\n\n    - A certificateTemplates field defining the enabled certificate templates. Certificate\ntemplates are a “blueprint” of settings that the CA uses when creating a\ncertificate, and include things such as the EKUs, enrollment permissions, the\ncertificate’s expiration, issuance requirements, and cryptography settings. We will\ndiscuss certificate templates more in detail later.\n\nIn AD environments, clients interact with Enterprise CAs to request a certificate based on\nthe settings defined in a certificate template. Enterprise CA certificates are propagated to\nthe Intermediate Certification Authorities certificate store on each Windows machine.\n\n  - The NTAuthCertificates AD object defines CA certificates that enable authentication to\n\nAD. This object has an objectClass of `certificationAuthority and the object’s`\n```\n   cACertificate property defines an array of trusted CA certificates. AD-joined Windows\n\n```\nmachines propagate these CAs to the _Intermediate Certification Authorities certificate_\nstore on each machine. Client applications can authenticate to AD using a certificate only\nif one the CAs defined by the `NTAuthCertificates object has signed the`\nauthenticating client’s certificate.\n\n - The AIA (Authority Information Access) container holds the AD objects of intermediate\nand cross CAs. Intermediate CAs are “children” of root CAs in the PKI tree hierarchy; as\nsuch, this container exists to aid in validating certificate chains. Like the _Certification_\n_Authorities container, each CA is represented as an AD object in the AIA container where_\nthe `objectClass attribute is set to` `certificationAuthority and the`\n```\n   cACertificate property contains the bytes of the CA’s certificate. These CAs are\n\n```\npropagated to the _Intermediate Certification Authorities certificate store on each_\nWindows machine.\n\nPKI Solutions also has an article describing these containers.[37] One can view the status of the\ncertificates in these containers (and other AD-CS-related containers) by opening the pkiview.msc\nMMC snap-in, right clicking on the _Enterprise PKI object, and clicking_ _Manage AD Containers_\n(Figure 1). Additionally, any LDAP browsing tool such as such as the adsiedit.msc or ldp.exe can\nview the raw information about these containers (Figure 2).\n\n[37 https://www.pkisolutions.com/understanding-active-directory-certificate-services-containers-in-active-directory/](https://www.pkisolutions.com/understanding-active-directory-certificate-services-containers-in-active-directory/)\n\n\ndiscuss certificate templates more in detail later.\n\nIn AD environments, clients interact with Enterprise CAs to request a certificate based on\nthe settings defined in a certificate template. Enterprise CA certificates are propagated to\nthe Intermediate Certification Authorities certificate store on each Windows machine.\n\n  - The NTAuthCertificates AD object defines CA certificates that enable authentication to\n\nAD. This object has an objectClass of `certificationAuthority and the object’s`\n```\n   cACertificate property defines an array of trusted CA certificates. AD-joined Windows\n\n```\nmachines propagate these CAs to the _Intermediate Certification Authorities certificate_\nstore on each machine. Client applications can authenticate to AD using a certificate only\nif one the CAs defined by the `NTAuthCertificates object has signed the`\nauthenticating client’s certificate.\n\n - The AIA (Authority Information Access) container holds the AD objects of intermediate\nand cross CAs. Intermediate CAs are “children” of root CAs in the PKI tree hierarchy; as\nsuch, this container exists to aid in validating certificate chains. Like the _Certification_\n_Authorities container, each CA is represented as an AD object in the AIA container where_\nthe `objectClass attribute is set to` `certificationAuthority and the`\n```\n   cACertificate property contains the bytes of the CA’s certificate. These CAs are\n\n```\npropagated to the _Intermediate Certification Authorities certificate store on each_\nWindows machine.\n\nPKI Solutions also has an article describing these containers.[37] One can view the status of the\ncertificates in these containers (and other AD-CS-related containers) by opening the pkiview.msc\nMMC snap-in, right clicking on the _Enterprise PKI object, and clicking_ _Manage AD Containers_\n(Figure 1). Additionally, any LDAP browsing tool such as such as the adsiedit.msc or ldp.exe can\nview the raw information about these containers (Figure 2).\n\n\n-----\n\nTo obtain a certificate from AD CS, clients go through a process called enrollment. At a high level,\nduring enrollment clients first find an Enterprise CA based on the objects in the _Enrollment_\n_Services container discussed above. Clients then generate a public-private key pair and place the_\npublic key in a certificate signing request (CSR) message along with other details such as the\nsubject of the certificate and the certificate template name. Clients then sign the CSR with their\nprivate key and send the CSR to an Enterprise CA server. The CA server checks if the client can\nrequest certificates. If so, it determines if it will issue a certificate by looking up the certificate\ntemplate AD object specified in the CSR. The CA will check if the certificate template AD object’s\npermissions allow the authenticating account to obtain a certificate. If so, the CA generates a\n\n\n**_Figure 1 - pkiview.msc's view of various AD CS containers_**\n\n**_Figure 2 - Viewing AD CS containers in adsiedit.msc_**\n\nTo obtain a certificate from AD CS, clients go through a process called enrollment. At a high level,\nduring enrollment clients first find an Enterprise CA based on the objects in the _Enrollment_\n_Services container discussed above. Clients then generate a public-private key pair and place the_\npublic key in a certificate signing request (CSR) message along with other details such as the\n\n\n-----\n\ncertificate using the “blueprint” settings defined by the certificate template (e.g., EKUs,\ncryptography settings, and issuance requirements) and using the other information supplied in\nthe CSR if allowed by the certificate’s template settings. The CA signs the certificate using its\nprivate key and then returns it to the client.\n\n**_Figure 3 - Overview of Certificate Enrollment_**\n\nWe will discuss the services AD CS exposes and the whole certificate enrollment process in more\ndetail later.\n\nCertificates issued by CAs can provide encryption (e.g., encrypting file system), digital signatures\n(e.g., code signing), and authentication (e.g., to AD). This paper will focus primarily on certificates\nthat enable AD authentication, but keep in mind that attackers can abuse certificates beyond just\nauthentication.\n\n### Certificate Templates\n\nAD CS Enterprise CAs issue certificates with settings defined by certificate templates. These\ntemplates are collections of enrollment policies and predefined certificate settings and contain\nthings like “How long is this certificate valid for?”, “What is the certificate used for?”, “How is the\n_subject specified?”,_ _“Who can request a certificate?”, and a myriad of other settings. The_\nfollowing screenshot shows editing a certificate template via the Certificate Templates Console\nMMC snap-in certtmpl.msc:\n\n\n**_Figure 3 - Overview of Certificate Enrollment_**\n\nWe will discuss the services AD CS exposes and the whole certificate enrollment process in more\ndetail later.\n\nCertificates issued by CAs can provide encryption (e.g., encrypting file system), digital signatures\n(e.g., code signing), and authentication (e.g., to AD). This paper will focus primarily on certificates\nthat enable AD authentication, but keep in mind that attackers can abuse certificates beyond just\nauthentication.\n\n### Certificate Templates\n\nAD CS Enterprise CAs issue certificates with settings defined by certificate templates. These\ntemplates are collections of enrollment policies and predefined certificate settings and contain\nthings like “How long is this certificate valid for?”, “What is the certificate used for?”, “How is the\n_subject specified?”,_ _“Who can request a certificate?”, and a myriad of other settings. The_\n\n\n-----\n\nAD CS stores available certificate templates as AD objects with an objectClass of\n`pKICertificateTemplate` located in the following container:\n```\nCN=Certificate Templates,CN=Public Key\nServices,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>\n\n```\nAn AD certificate template object’s attributes define its settings, and its security descriptor\ncontrols what principals can enroll in the certificate or edit the certificate template (more on this\nin the following “Enrollment Rights and Protocols” section).\n\nThe pKIExtendedKeyUsage[38] attribute on an AD certificate template object contains an array\nof OIDs enabled in the template. These EKU OIDs affect what the certificate can be used for and\ninclude things like the Encrypting File System (OID 1.3.6.1.4.1.311.10.3.4), Code Signing (OID\n1.3.6.1.5.5.7.3.3), Smart Card Logon (OID 1.3.6.1.4.1.311.20.2.2), Client Authentication (OID\n1.3.6.1.5.5.7.3.2), and many more. PKI Solutions has a breakdown of the EKU OIDs available from\nMicrosoft[39].\n\n[38 https://docs.microsoft.com/en-us/windows/win32/adschema/a-pkiextendedkeyusage](https://docs.microsoft.com/en-us/windows/win32/adschema/a-pkiextendedkeyusage)\n\n[39 https://www.pkisolutions.com/object-identifiers-oid-in-pki/](https://www.pkisolutions.com/object-identifiers-oid-in-pki/)\n\n\n**_Figure 4 - Example Certificate Template Configuration in the Certificate Templates Console_**\n\nAD CS stores available certificate templates as AD objects with an objectClass of\n`pKICertificateTemplate` located in the following container:\n```\nCN=Certificate Templates,CN=Public Key\nServices,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>\n\n```\nAn AD certificate template object’s attributes define its settings, and its security descriptor\ncontrols what principals can enroll in the certificate or edit the certificate template (more on this\nin the following “Enrollment Rights and Protocols” section).\n\nThe pKIExtendedKeyUsage[38] attribute on an AD certificate template object contains an array\nof OIDs enabled in the template. These EKU OIDs affect what the certificate can be used for and\n\n\n-----\n\nOur research focused on EKUs that, when present in a certificate, permit authentication to AD.\nWe originally thought that only the Client Authentication OID enabled this; however, our\nresearch also found that the following OIDs can enable certificate authentication:\n\n**Description** **OID**\n\n**Client Authentication** 1.3.6.1.5.5.7.3.2\n\n**PKINIT Client Authentication*** 1.3.6.1.5.2.3.4\n\n**Smart Card Logon** 1.3.6.1.4.1.311.20.2.2\n\n**Any Purpose** 2.5.29.37.0\n\n**SubCA** (no EKUs)\n\n*The 1.3.6.1.5.2.3.4 OID is not present in AD CS deployments by default and needs to be added\nmanually[40], but it does work for client authentication [41].\n\nBefore Windows Vista, smart cards appeared to have more strict certificate requirements,\nincluding requiring non-empty EKUs[42]. There is a GPO setting titled “Allow certificates with no\nextended key usage certificate attribute[43]” whose documentation makes it sound like you need\nto flip this switch to allow certificate authentication with the All Purpose EKU, Client\nAuthentication EKU, or no EKU in modern environments. However, this is a client side setting\nonly. The CQure Academy post on EKUs[44] details an older description for this GPO that states\nthat it affects which smart card-based certificates will show up on a logon screen, which matches\nthe behavior we’ve seen. So regardless of this GPO value, the scenarios in the table above will\nallow such a certificate to authenticate to AD.\n\n**Sidenote:** For the rest of this paper, when we mention “certificates that allow for\nauthentication”, we mean one of the five EKU scenarios in the above table.\n\n[40 https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/additional-mitigations#deploying-domain-joined-device-certificates](https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/additional-mitigations#deploying-domain-joined-device-certificates)\n\n[41 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/c83e95a4-ac5e-4519-b885-37a4d1b8d08b#:~:text=id-pkinit-kpclientauth](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/c83e95a4-ac5e-4519-b885-37a4d1b8d08b#:%7E:text=id-pkinit-kpclientauth)\n\n[42 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-vista/cc721959%28v=ws.10%29](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-vista/cc721959%28v=ws.10%29)\n\n[43 https://docs.microsoft.com/en-us/windows/security/identity-protection/smart-cards/smart-card-group-policy-and-registry-settings#allow-certificates-with-no-extended-key-usage-certificate-attribute](https://docs.microsoft.com/en-us/windows/security/identity-protection/smart-cards/smart-card-group-policy-and-registry-settings#allow-certificates-with-no-extended-key-usage-certificate-attribute)\n\n[44 https://cqureacademy.com/blog/enhanced-key-usage](https://cqureacademy.com/blog/enhanced-key-usage)\n\n|Description|OID|\n|---|---|\n|Client Authentication|1.3.6.1.5.5.7.3.2|\n|PKINIT Client Authentication*|1.3.6.1.5.2.3.4|\n|Smart Card Logon|1.3.6.1.4.1.311.20.2.2|\n|Any Purpose|2.5.29.37.0|\n|SubCA|(no EKUs)|\n\n\n**Description** **OID**\n\n**Client Authentication** 1.3.6.1.5.5.7.3.2\n\n**PKINIT Client Authentication*** 1.3.6.1.5.2.3.4\n\n**Smart Card Logon** 1.3.6.1.4.1.311.20.2.2\n\n**Any Purpose** 2.5.29.37.0\n\n**SubCA** (no EKUs)\n\n*The 1.3.6.1.5.2.3.4 OID is not present in AD CS deployments by default and needs to be added\nmanually[40], but it does work for client authentication [41].\n\nBefore Windows Vista, smart cards appeared to have more strict certificate requirements,\nincluding requiring non-empty EKUs[42]. There is a GPO setting titled “Allow certificates with no\nextended key usage certificate attribute[43]” whose documentation makes it sound like you need\nto flip this switch to allow certificate authentication with the All Purpose EKU, Client\nAuthentication EKU, or no EKU in modern environments. However, this is a client side setting\nonly. The CQure Academy post on EKUs[44] details an older description for this GPO that states\nthat it affects which smart card-based certificates will show up on a logon screen, which matches\nthe behavior we’ve seen. So regardless of this GPO value, the scenarios in the table above will\nallow such a certificate to authenticate to AD.\n\n\n-----\n\nAn additional EKU OID that we found we could abuse is the Certificate Request Agent OID\n(1.3.6.1.4.1.311.20.2.1). Certificates with this OID can be used to request certificates on behalf\nof another user unless specific restrictions are put in place. We will dive more into this issue in\nthe “Enrollment Agents, Authorized Signatures, and Application Policies” and “Misconfigured\n_Enrollment Agent Templates - ESC3”_ sections.\n\n### Certificate Enrollment\n\n#### Enrollment Rights and Protocols\n\nUsers cannot necessarily obtain a certificate from every defined certificate template. IT\nadministrators first create certificate templates and then an Enterprise CA “publishes” the\ntemplate, making it available to clients to enroll in. Recall, AD CS registers Enterprise CAs in AD\nas objects with an objectClass of pKIEnrollmentService. AD CS specifies that a certificate\ntemplate is enabled on an Enterprise CA by adding the template’s name to the\n```\ncertificatetemplates field of the AD object:\n\n```\n**_Figure 5 - Showing Enabled Certificate Templates with PowerView_**\n\nAD CS defines enrollment rights - which principals can request a certificate – using two security\ndescriptors: one on the certificate template AD object and another on the Enterprise CA itself.\n\nFor certificate templates, the following ACEs in a template’s DACL can result in a principal having\nenrollment rights:\n\n\n### Certificate Enrollment\n\n#### Enrollment Rights and Protocols\n\nUsers cannot necessarily obtain a certificate from every defined certificate template. IT\nadministrators first create certificate templates and then an Enterprise CA “publishes” the\ntemplate, making it available to clients to enroll in. Recall, AD CS registers Enterprise CAs in AD\nas objects with an objectClass of pKIEnrollmentService. AD CS specifies that a certificate\ntemplate is enabled on an Enterprise CA by adding the template’s name to the\n```\ncertificatetemplates field of the AD object:\n\n```\n**_Figure 5 - Showing Enabled Certificate Templates with PowerView_**\n\nAD CS defines enrollment rights - which principals can request a certificate – using two security\ndescriptors: one on the certificate template AD object and another on the Enterprise CA itself.\n\nFor certificate templates, the following ACEs in a template’s DACL can result in a principal having\nenrollment rights:\n\n\n-----\n\n  - **The ACE grants a principal the Certificate-Enrollment extended right. The raw ACE grants**\n\nprincipal the RIGHT_DS_CONTROL_ACCESS[45] access right where the ObjectType[46] is set\nto 0e10c968-78fb-11d2-90d4-00c04f79dc55[47]. This GUID corresponds with the\nCertificate-Enrollment extended right.\n\n  - **The ACE grants a principal the Certificate-AutoEnrollment extended right. The raw ACE**\n\ngrants principal the RIGHT_DS_CONTROL_ACCESS[48] access right where the ObjectType is\nset to a05b8cc2-17bc-4802-a710-e7c15ab866a2[49]. This GUID corresponds with the\nCertificate-AutoEnrollment extended right.\n\n  - **An ACE grants a principal all ExtendedRights.** The raw ACE enables the\n\nRIGHT_DS_CONTROL_ACCESS access right where the ObjectType is set to 000000000000-0000-0000-000000000000. This GUID corresponds with all extended rights.\n\n  - **An ACE grants a principal FullControl/GenericAll.** The raw ACE enables the\n\nFullControl/GenericAll access right.\n\n**_Figure 6 - The default \"User\" certificate template security descriptor granting Domain Users the Certificate-Enrollment_**\n**_extended right_**\n\nIT administrators can configure certificate template permissions using the Certificate Template\nMMC snap-in certtmpl.msc by right clicking on a template, select Properties, and viewing the\nSecurity tab:\n\n[45 MS-ADTS 5.1.3.2 Access Rights, https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/990fb975-ab31-4bc1-8b75-5da132cd4584](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/990fb975-ab31-4bc1-8b75-5da132cd4584)\n\n[46 https://docs.microsoft.com/en-us/windows/win32/secauthz/object-specific-aces](https://docs.microsoft.com/en-us/windows/win32/secauthz/object-specific-aces)\n\n[47 MS-CRTD 2.5.2 Determining Autoenrollment Permission of an End Entity for a Template, https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/211ab1e3-bad6-416d-9d56-8480b42617a4](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/211ab1e3-bad6-416d-9d56-8480b42617a4)\n\n[48 MS-ADTS 5.1.3.2 Access Rights, https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/990fb975-ab31-4bc1-8b75-5da132cd4584](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/990fb975-ab31-4bc1-8b75-5da132cd4584)\n\n[49 MS-CRTD 2.5.2 Determining Autoenrollment Permission of an End Entity for a Template, https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/211ab1e3-bad6-416d-9d56-8480b42617a4](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/211ab1e3-bad6-416d-9d56-8480b42617a4)\n\n\nCertificate-Enrollment extended right.\n\n  - **The ACE grants a principal the Certificate-AutoEnrollment extended right. The raw ACE**\n\ngrants principal the RIGHT_DS_CONTROL_ACCESS[48] access right where the ObjectType is\nset to a05b8cc2-17bc-4802-a710-e7c15ab866a2[49]. This GUID corresponds with the\nCertificate-AutoEnrollment extended right.\n\n  - **An ACE grants a principal all ExtendedRights.** The raw ACE enables the\n\nRIGHT_DS_CONTROL_ACCESS access right where the ObjectType is set to 00000000-\n0000-0000-0000-000000000000. This GUID corresponds with all extended rights.\n\n  - **An ACE grants a principal FullControl/GenericAll.** The raw ACE enables the\n\nFullControl/GenericAll access right.\n\n**_Figure 6 - The default \"User\" certificate template security descriptor granting Domain Users the Certificate-Enrollment_**\n**_extended right_**\n\nIT administrators can configure certificate template permissions using the Certificate Template\nMMC snap-in certtmpl.msc by right clicking on a template, select Properties, and viewing the\nSecurity tab:\n\n\n-----\n\nAn Enterprise CA defines enrollment rights using a security descriptor as well, superseding any\nenrollment rights defined by certificate templates. The security descriptor[50] configured on the\nEnterprise CA defines these rights and is viewable in the Certificate Authority MMC snap-in\n_certsrv.msc by right clicking on the CA → Properties → Security:_\n\n[50 MS-CSRA 3.1.1.7 Permissions, https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/509360cf-9797-491e-9dd1-795f63cb1538](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/509360cf-9797-491e-9dd1-795f63cb1538)\n\n\n**_Figure 7 - Template Enrollment Permissions via the GUI_**\n\nAn Enterprise CA defines enrollment rights using a security descriptor as well, superseding any\nenrollment rights defined by certificate templates. The security descriptor[50] configured on the\nEnterprise CA defines these rights and is viewable in the Certificate Authority MMC snap-in\n_certsrv.msc by right clicking on the CA → Properties → Security:_\n\n\n-----\n\nThis ultimately ends up setting the _Security_ registry value in the key\n```\nHKLM\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\<CA NAME>\n\n```\non the CA server. We have encountered several AD CS servers that grant low-privileged users\nremote access to this key via remote registry:\n\n**_Figure 9 - Remoting Listing an Enterprise CA’s Security Descriptor with reg.exe_**\n\nLow-privileged users can also enumerate this via DCOM using the `ICertAdminD2 COM`\ninterface’s `GetCASecurity method[51]. However, normal Windows clients need to install the`\nRemote Server Administration Tools (RSAT) to use it since the COM interface and any COM\nobjects that implement it are not present on Windows by default.\n\n[51 MS-CSRA 3.1.4.2.6 ICertAdminD2::GetCASecurity (Opnum 36) https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/453e89fc-cf90-4203-a8ca-b836cd464fc4](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/453e89fc-cf90-4203-a8ca-b836cd464fc4)\n\n\n**_Figure 8 - CA that Grants “Authenticated Users” Request Certificates Rights_**\n\nThis ultimately ends up setting the _Security_ registry value in the key\n```\nHKLM\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\<CA NAME>\n\n```\non the CA server. We have encountered several AD CS servers that grant low-privileged users\nremote access to this key via remote registry:\n\n**_Figure 9 - Remoting Listing an Enterprise CA’s Security Descriptor with reg.exe_**\n\nLow-privileged users can also enumerate this via DCOM using the `ICertAdminD2 COM`\ninterface’s `GetCASecurity method[51]. However, normal Windows clients need to install the`\nRemote Server Administration Tools (RSAT) to use it since the COM interface and any COM\n\n\n-----\n\nIf both the Enterprise CA’s and the certificate template’s security descriptors grant the client\ncertificate enrollment privileges, the client can then request a certificate. A client can request a\ncertificate in different ways depending on the AD CS environment’s configuration:\n\n1. Using the Windows Client Certificate Enrollment Protocol[52] (MS-WCCE), a set of\nDistributed Component Object Model (DCOM) interfaces that interact with various AD CS\nfeatures including enrollment. The DCOM server is enabled on all AD CS servers by default\nand is the most common method by which we have seen clients request certificates.\n2. Via the ICertPassage Remote Protocol[53] (MS-ICPR), a remote procedure call (RPC)\nprotocol can operate over named pipes or TCP/IP.\n3. Accessing the certificate enrollment web interface. To use this, the ADCS server needs to\nhave the Certificate Authority Web Enrollment role installed. Once enabled, a user can\nnavigate to the IIS-hosted ASP web enrollment application running at\n```\n   http://<ADCSSERVER>/certsrv/.\n\n```\n4. Interacting with a certificate enrollment service (CES). To use this, a server needs to have\nthe Certificate Enrollment Web Service role installed. Once enabled, a user can access the\nweb service at `https://<CESSERVER>/<CANAME>_CES_Kerberos/service.svc`\nto request certificates. This service works in tandem with a certificate enrollment policy\n(CEP) service (installed via the Certificate Enrollment Policy Web Service role), which\nclients use to list certificate templates at the URL\n```\n   https://<CEPSERVER>/ADPolicyProvider_CEP_Kerberos/service.svc.\n\n```\nUnderneath, the certificate enrollment and policy web services implement MS-WSTEP[54]\nand MS-XCEP [55], respectively (two SOAP-based protocols).\n5. Using the network device enrollment service. To use this, a server needs to have the\nNetwork Device Enrollment Service [56] role installed, which allows clients (namely network\ndevices) to obtain certificates via the Simple Certificate Enrollment Protocol (SCEP)[57].\nOnce enabled, an administrator can obtain a one-time password (OTP) from the URL\n```\n   http://<NDESSERVER>/CertSrv/mscep_admin/. The administrator can then\n\n```\nprovide the OTP to a network device and the device will use the SCEP to request a\ncertificate using the URL http://NDESSERVER/CertSrv/mscep/.\n\nOn a Windows machine, users can request certificates using a GUI by launching certmgr.msc (for\nuser certificates) or _certlm.msc (for computer certificates), expanding the_ _Personal certificate_\n\n[52 [MS-WCCE]: Windows Client Certificate Enrollment Protocol, https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wcce/446a0fca-7f27-4436-965d-191635518466](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wcce/446a0fca-7f27-4436-965d-191635518466)\n\n[53 [MS-ICPR]: ICertPassage Remote Protocol, https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-icpr/9b8ed605-6b00-41d1-9a2a-9897e40678fc](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-icpr/9b8ed605-6b00-41d1-9a2a-9897e40678fc)\n\n[54 [MS-WSTEP]: WS-Trust X.509v3 Token Enrollment Extensions, https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wstep/4766a85d-0d18-4fa1-a51f-e5cb98b752ea](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wstep/4766a85d-0d18-4fa1-a51f-e5cb98b752ea)\n\n[55 [MS-XCEP]: X.509 Certificate Enrollment Policy Protocol, https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-xcep/08ec4475-32c2-457d-8c27-5a176660a210](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-xcep/08ec4475-32c2-457d-8c27-5a176660a210)\n\n[56 https://social.technet.microsoft.com/wiki/contents/articles/9063.active-directory-certificate-services-ad-cs-network-device-enrollment-service-ndes.aspx](https://social.technet.microsoft.com/wiki/contents/articles/9063.active-directory-certificate-services-ad-cs-network-device-enrollment-service-ndes.aspx)\n\n57 https://datatracker.ietf.org/doc/html/draft-nourse-scep-19\n\n\n1. Using the Windows Client Certificate Enrollment Protocol[52] (MS-WCCE), a set of\nDistributed Component Object Model (DCOM) interfaces that interact with various AD CS\nfeatures including enrollment. The DCOM server is enabled on all AD CS servers by default\nand is the most common method by which we have seen clients request certificates.\n2. Via the ICertPassage Remote Protocol[53] (MS-ICPR), a remote procedure call (RPC)\nprotocol can operate over named pipes or TCP/IP.\n3. Accessing the certificate enrollment web interface. To use this, the ADCS server needs to\nhave the Certificate Authority Web Enrollment role installed. Once enabled, a user can\nnavigate to the IIS-hosted ASP web enrollment application running at\n```\n   http://<ADCSSERVER>/certsrv/.\n\n```\n4. Interacting with a certificate enrollment service (CES). To use this, a server needs to have\nthe Certificate Enrollment Web Service role installed. Once enabled, a user can access the\nweb service at `https://<CESSERVER>/<CANAME>_CES_Kerberos/service.svc`\nto request certificates. This service works in tandem with a certificate enrollment policy\n(CEP) service (installed via the Certificate Enrollment Policy Web Service role), which\nclients use to list certificate templates at the URL\n```\n   https://<CEPSERVER>/ADPolicyProvider_CEP_Kerberos/service.svc.\n\n```\nUnderneath, the certificate enrollment and policy web services implement MS-WSTEP[54]\nand MS-XCEP [55], respectively (two SOAP-based protocols).\n5. Using the network device enrollment service. To use this, a server needs to have the\nNetwork Device Enrollment Service [56] role installed, which allows clients (namely network\ndevices) to obtain certificates via the Simple Certificate Enrollment Protocol (SCEP)[57]\nOnce enabled, an administrator can obtain a one-time password (OTP) from the URL\n```\n   http://<NDESSERVER>/CertSrv/mscep_admin/. The administrator can then\n\n```\nprovide the OTP to a network device and the device will use the SCEP to request a\ncertificate using the URL http://NDESSERVER/CertSrv/mscep/.\n\n\n-----\n\nstore → right clicking Certificates → All Tasks → Request New Certificate. This will present the\nuser with certificate templates the Enterprise CA has published that they (or their system) can\nenroll in:\n\n**_Figure 10 - User Certificate Request through certmgr.msc_**\n\nUpon clicking the Enroll button, Windows will request a certificate (by default, using a COM\nobject that implements MS-WCCE) and the certificate will then appear under Personal \n_Certificates after a successful enrollment:_\n\n**_Figure 11 - Requested User Certificate Installed in the Personal Certificate Store_**\n\n\n**_Figure 10 - User Certificate Request through certmgr.msc_**\n\nUpon clicking the Enroll button, Windows will request a certificate (by default, using a COM\nobject that implements MS-WCCE) and the certificate will then appear under Personal \n_Certificates after a successful enrollment:_\n\n\n-----\n\nOn the Enterprise CA side, _certsrv.msc will show the issued certificate under_ _CA_  _Issued_\n_Certificates:_\n\n**_Figure 12 – Viewing an Issued Certificates in certsrv.msc on an Enterprise CA_**\n\nOne can also use the built-in `certreq.exe command or PowerShell’s` `Get-Certificate`\ncommand for certificate enrollment. On non-Windows machines, it is easiest for clients to use\nthe HTTP-based interfaces to request certificates.\n\nAfter a CA has issued a certificate, it can revoke the issued certificates through certsrv.msc. AD\nCS, by default, distributes revoked certificate information using Certificate Revocation Lists\n(CRLs), which are basically just a list of each revoked certificate’s serial number. Administrators\ncan also optionally configure AD CS to support the Online Certificate Status Protocol (OSCP) by\nenabling the Online Responder server role during AD CS installation.\n\nSo, what is happening behind the scenes when a user enrolls in a certificate? In a basic scenario,\na client first generates a public key and associated private key. The client creates a Certificate\nSigning Request (CSR) in which it specifies the public key and the name of the certificate template.\nThe client then signs the CSR with the private key and sends the CSR to the Enterprise CA using\none of the enrollment protocols or interfaces (e.g., MS-WCCE, MS-ICPR, the certificate\nenrollment web service, etc.).\n\nThe Enterprise CA then checks if the client has enrollment privileges at the CA level. If so, the CA\nlooks at the certificate template specified in the CSR and verifies that the client can enroll in the\ngiven template by examining the certificate template AD object’s DACL. If the DACL grants the\nuser the enrollment privileges, the user can enroll. The CA will create and sign a certificate based\non the certificate template’s settings and return the signed certificate to the user.\n\nThe following is a graphic gives an overview of the enrollment process:\n\n\n**_Figure 12 – Viewing an Issued Certificates in certsrv.msc on an Enterprise CA_**\n\nOne can also use the built-in `certreq.exe command or PowerShell’s` `Get-Certificate`\ncommand for certificate enrollment. On non-Windows machines, it is easiest for clients to use\nthe HTTP-based interfaces to request certificates.\n\nAfter a CA has issued a certificate, it can revoke the issued certificates through certsrv.msc. AD\nCS, by default, distributes revoked certificate information using Certificate Revocation Lists\n(CRLs), which are basically just a list of each revoked certificate’s serial number. Administrators\ncan also optionally configure AD CS to support the Online Certificate Status Protocol (OSCP) by\nenabling the Online Responder server role during AD CS installation.\n\nSo, what is happening behind the scenes when a user enrolls in a certificate? In a basic scenario,\na client first generates a public key and associated private key. The client creates a Certificate\nSigning Request (CSR) in which it specifies the public key and the name of the certificate template.\nThe client then signs the CSR with the private key and sends the CSR to the Enterprise CA using\none of the enrollment protocols or interfaces (e.g., MS-WCCE, MS-ICPR, the certificate\nenrollment web service, etc.).\n\nThe Enterprise CA then checks if the client has enrollment privileges at the CA level. If so, the CA\nlooks at the certificate template specified in the CSR and verifies that the client can enroll in the\ngiven template by examining the certificate template AD object’s DACL. If the DACL grants the\nuser the enrollment privileges, the user can enroll. The CA will create and sign a certificate based\n\n\n-----\n\n**_Figure 13 - Overview of Certificate Enrollment_**\n\n#### Issuance Requirements\n\n**Manager Approval**\n\nIn addition to the certificate template and Enterprise CA access control restrictions, there two\ncertificate template settings we have seen used to control certificate enrollment. These are\nknown as issuance requirements:\n\n\n**_Figure 13 - Overview of Certificate Enrollment_**\n\n#### Issuance Requirements\n\n**Manager Approval**\n\nIn addition to the certificate template and Enterprise CA access control restrictions, there two\ncertificate template settings we have seen used to control certificate enrollment. These are\nknown as issuance requirements:\n\n\n-----\n\nThe first restriction is “CA certificate manager approval”, which results in the certificate template\nsetting the CT_FLAG_PEND_ALL_REQUESTS (0x2) bit on the AD object’s msPKI-Enrollment```\nFlag[58] attribute. This puts all certificate requests based on the template into the pending state\n\n```\n(visible in the “Pending Requests” section in certsrv.msc), which requires a certificate manager\nto approve or deny the request before the certificate is issued:\n\n[58 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/ec71fd43-61c2-407b-83c9-b52272dec8a1](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/ec71fd43-61c2-407b-83c9-b52272dec8a1)\n\n\n**_Figure 14 - Certificate issuance Requirements via the Certificate Templates Console_**\n\nThe first restriction is “CA certificate manager approval”, which results in the certificate template\nsetting the CT_FLAG_PEND_ALL_REQUESTS (0x2) bit on the AD object’s msPKI-Enrollment-\n```\nFlag[58] attribute. This puts all certificate requests based on the template into the pending state\n\n```\n(visible in the “Pending Requests” section in certsrv.msc), which requires a certificate manager\nto approve or deny the request before the certificate is issued:\n\n\n-----\n\n**_Figure 15 - Approving a Pending Certificate Request in certsrv.msc_**\n\n**Enrollment Agents, Authorized Signatures, and Application Policies**\n\nThe second set of restrictions shown in the issuance requirements screenshot (Figure 14) are the\nsettings “This number of authorized signatures” and the “Application policy”. The former controls\nthe number of signatures required in the CSR for the CA to accept it. The latter defines the EKU\nOIDs that that the CSR signing certificate must have.\n\nA common use for these settings is for enrollment agents. An enrollment agent is an AD CS term\ngiven to an entity that can request certificates on behalf of another user. To do so, the CA must\nissue the enrollment agent account a certificate containing at least the Certificate Request Agent\nEKU (OID 1.3.6.1.4.1.311.20.2.1). Once issued, the enrollment agent can then sign CSRs and\nrequest certificates on behalf of other users. The CA will issue the enrollment agent a certificate\nas another user only under the following non-comprehensive set of conditions (implemented\nprimarily in default policy module certpdef.dll):\n\n  - The Windows user authenticating to the CA has enrollment rights to the target certificate\ntemplate.\n\n  - If the certificate template’s schema version is 1, the CA will require signing certificates to\nhave the Certificate Request Agent OID before issuing the certificate. The template’s\nschema version is the specified in its AD object’s msPKI-Template-Schema-Version\nproperty.\n\n  - If the certificate template’s schema version is 2:\n\n    - The template must set the “This number of authorized signatures” setting and the\n\nspecified number of enrollment agents must sign the CSR (the template’s mspki`ra-signature` AD attribute defines this setting). In other words, this setting\nspecifies how many enrollment agents must sign a CSR before the CA even\nconsiders issuing a certificate.\n\n\n**_Figure 15 - Approving a Pending Certificate Request in certsrv.msc_**\n\n**Enrollment Agents, Authorized Signatures, and Application Policies**\n\nThe second set of restrictions shown in the issuance requirements screenshot (Figure 14) are the\nsettings “This number of authorized signatures” and the “Application policy”. The former controls\nthe number of signatures required in the CSR for the CA to accept it. The latter defines the EKU\nOIDs that that the CSR signing certificate must have.\n\nA common use for these settings is for enrollment agents. An enrollment agent is an AD CS term\ngiven to an entity that can request certificates on behalf of another user. To do so, the CA must\nissue the enrollment agent account a certificate containing at least the Certificate Request Agent\nEKU (OID 1.3.6.1.4.1.311.20.2.1). Once issued, the enrollment agent can then sign CSRs and\nrequest certificates on behalf of other users. The CA will issue the enrollment agent a certificate\nas another user only under the following non-comprehensive set of conditions (implemented\nprimarily in default policy module certpdef.dll):\n\n  - The Windows user authenticating to the CA has enrollment rights to the target certificate\ntemplate.\n\n  - If the certificate template’s schema version is 1, the CA will require signing certificates to\nhave the Certificate Request Agent OID before issuing the certificate. The template’s\nschema version is the specified in its AD object’s msPKI-Template-Schema-Version\nproperty.\n\n  - If the certificate template’s schema version is 2:\n\n    - The template must set the “This number of authorized signatures” setting and the\n\n\n-----\n\n    - The template’s “Application policy” issuance restriction must be set to “Certificate\nRequest Agent”.\n\nEnrollment Agent certificates are potentially very powerful. As MS-CRTD section 4.2 states[59]:\n\n_“Because an Enrollment Agent is allowed to specify certificates to be issued to_\n_any subject, it can bypass corporate security policy. As a result, administrators_\n_need to be especially careful when allowing subjects to enroll for Enrollment_\n_Agent certificates.”_\n\nEnterprise CAs can place restrictions on enrollment agents at the CA level[60], but we have yet to\nencounter this in a network. For more information on issuance restrictions, see Microsoft’s PKI\ndesign guidance[61].\n\n### Subject Alternative Names and Authentication\n\nA Subject Alternative Name (SAN) is an X.509v3 extension. When added to a certificate, it allows\nadditional identities to be bound to a certificate[62] beyond just the subject of the certificate. A\ncommon use for SANs is supplying additional host names for HTTPS certificates. For example, if\na web server hosts content for multiple domains, each applicable domain could be included in\nthe SAN so that the web server only needs a single HTTPS certificate instead of one for each\ndomain.\n\nThis is all well and good for HTTPS certificates, but when combined with certificates that allow\nfor domain authentication, a dangerous scenario can arise. By default, during certificate-based\nauthentication, one way AD maps certificates to user accounts based on a UPN specified in the\nSAN[63]. If an attacker can specify an arbitrary SAN when requesting a certificate that has an EKU\nenabling client authentication, and the CA creates and signs a certificate using the attackersupplied SAN, the attacker can become any user in the domain. For example, if an attacker can\nrequest a client authentication certificate that has a domain administrator SAN field, and the CA\nissues the certificate, the attacker can authenticate as that domain admin.\n\n59 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/0e7974b3-1550-4b50-808d-2274b0ce11ab\n\n60 https://social.technet.microsoft.com/wiki/contents/articles/10942.ad-cs-security-guidance.aspx#Establish_Restricted_Enrollment_Agents\n\n[61 https://social.technet.microsoft.com/wiki/contents/articles/7421.active-directory-certificate-services-ad-cs-public-key-infrastructure-pki-design-guide.aspx#Issuance_requirements](https://social.technet.microsoft.com/wiki/contents/articles/7421.active-directory-certificate-services-ad-cs-public-key-infrastructure-pki-design-guide.aspx#Issuance_requirements)\n\n[62 https://tools.ietf.org/html/rfc5280#section-4.2.1.6](https://tools.ietf.org/html/rfc5280#section-4.2.1.6)\n\n[63 https://docs.microsoft.com/en-us/windows/security/identity-protection/smart-cards/smart-card-certificate-requirements-and-enumeration#client-certificate-mappings](https://docs.microsoft.com/en-us/windows/security/identity-protection/smart-cards/smart-card-certificate-requirements-and-enumeration#client-certificate-mappings)\n\n\nEnrollment Agent certificates are potentially very powerful. As MS-CRTD section 4.2 states[59]:\n\n_“Because an Enrollment Agent is allowed to specify certificates to be issued to_\n_any subject, it can bypass corporate security policy. As a result, administrators_\n_need to be especially careful when allowing subjects to enroll for Enrollment_\n_Agent certificates.”_\n\nEnterprise CAs can place restrictions on enrollment agents at the CA level[60], but we have yet to\nencounter this in a network. For more information on issuance restrictions, see Microsoft’s PKI\ndesign guidance[61].\n\n### Subject Alternative Names and Authentication\n\nA Subject Alternative Name (SAN) is an X.509v3 extension. When added to a certificate, it allows\nadditional identities to be bound to a certificate[62] beyond just the subject of the certificate. A\ncommon use for SANs is supplying additional host names for HTTPS certificates. For example, if\na web server hosts content for multiple domains, each applicable domain could be included in\nthe SAN so that the web server only needs a single HTTPS certificate instead of one for each\ndomain.\n\nThis is all well and good for HTTPS certificates, but when combined with certificates that allow\nfor domain authentication, a dangerous scenario can arise. By default, during certificate-based\nauthentication, one way AD maps certificates to user accounts based on a UPN specified in the\nSAN[63]. If an attacker can specify an arbitrary SAN when requesting a certificate that has an EKU\nenabling client authentication, and the CA creates and signs a certificate using the attacker-\nsupplied SAN, the attacker can become any user in the domain. For example, if an attacker can\nrequest a client authentication certificate that has a domain administrator SAN field, and the CA\nissues the certificate, the attacker can authenticate as that domain admin.\n\n\n-----\n\nVarious AD CS misconfigurations can allow unprivileged users to supply an arbitrary SAN in a\ncertificate enrollment, resulting in domain escalation scenarios. We explore these scenarios in\nthe “Domain Escalation” section.\n\n#### Kerberos Authentication and the NTAuthCertificates Container\n\nHow does certificate authentication to AD work considering that CA servers are typically separate\nservers from domain controllers? AD supports certificate authentication over two protocols by\ndefault: Kerberos and Secure Channel (Schannel).\n\nFor Kerberos, the technical specification “[MS-PKCA]: Public Key Cryptography for Initial\n_Authentication (PKINIT) in Kerberos Protocol”[64]_ defines the authentication process.\n@_ethicalchaos_ gives a good overview of PKINIT in their smart card post[65]. A brief overview of\nthis process is below.\n\nA user will sign the authenticator for a TGT request using the private key of their certificate and\nsubmit this request to a domain controller. The domain controller performs a number of\nverification steps and issues a TGT if everything passes. These steps are best detailed by\nMicrosoft’s smart card documentation[66] (emphasis ours):\n\n_The KDC validates the user's certificate (time, path, and revocation status) to_\n_ensure that the certificate is from a trusted source. The KDC uses CryptoAPI to_\n_build a certification path from the user's certificate to a root certification_\n_authority (CA) certificate that resides in the root store on the domain controller._\n_The KDC then uses CryptoAPI to verify the digital signature on the signed_\n_authenticator that was included in the preauthentication data fields. The_\n_domain controller verifies the signature and uses the public key from the user's_\n_certificate to prove that the request originated from the owner of the private_\n_key that corresponds to the public key. The KDC also verifies that the issuer is_\n**_trusted and appears in the NTAUTH certificate store._**\n\nThe “NTAUTH certificate store” mentioned here refers to an AD object AD CS installs at the\nfollowing location:\n```\nCN=NTAuthCertificates,CN=Public Key\nServices,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>\n\n```\n[64 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/d0cf1763-3541-4008-a75f-a577fa5e8c5b](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/d0cf1763-3541-4008-a75f-a577fa5e8c5b)\n\n[65 https://ethicalchaos.dev/2020/10/04/attacking-smart-card-based-active-directory-networks/](https://ethicalchaos.dev/2020/10/04/attacking-smart-card-based-active-directory-networks/)\n\n[66 https://docs.microsoft.com/en-us/windows/security/identity-protection/smart-cards/smart-card-certificate-requirements-and-enumeration#smart-card-sign-in-flow-in-windows](https://docs.microsoft.com/en-us/windows/security/identity-protection/smart-cards/smart-card-certificate-requirements-and-enumeration#smart-card-sign-in-flow-in-windows)\n\n\n#### Kerberos Authentication and the NTAuthCertificates Container\n\nHow does certificate authentication to AD work considering that CA servers are typically separate\nservers from domain controllers? AD supports certificate authentication over two protocols by\ndefault: Kerberos and Secure Channel (Schannel).\n\nFor Kerberos, the technical specification “[MS-PKCA]: Public Key Cryptography for Initial\n_Authentication (PKINIT) in Kerberos Protocol”[64]_ defines the authentication process.\n@_ethicalchaos_ gives a good overview of PKINIT in their smart card post[65]. A brief overview of\nthis process is below.\n\nA user will sign the authenticator for a TGT request using the private key of their certificate and\nsubmit this request to a domain controller. The domain controller performs a number of\nverification steps and issues a TGT if everything passes. These steps are best detailed by\nMicrosoft’s smart card documentation[66] (emphasis ours):\n\n_The KDC validates the user's certificate (time, path, and revocation status) to_\n_ensure that the certificate is from a trusted source. The KDC uses CryptoAPI to_\n_build a certification path from the user's certificate to a root certification_\n_authority (CA) certificate that resides in the root store on the domain controller._\n_The KDC then uses CryptoAPI to verify the digital signature on the signed_\n_authenticator that was included in the preauthentication data fields. The_\n_domain controller verifies the signature and uses the public key from the user's_\n_certificate to prove that the request originated from the owner of the private_\n_key that corresponds to the public key. The KDC also verifies that the issuer is_\n**_trusted and appears in the NTAUTH certificate store._**\n\nThe “NTAUTH certificate store” mentioned here refers to an AD object AD CS installs at the\n\n\n-----\n\nMicrosoft explains the significance of this object[67]:\n\n_By publishing the CA certificate to the Enterprise NTAuth store, the_\n_Administrator indicates that the CA is trusted to issue certificates of these types._\n_Windows CAs automatically publish their CA certificates to this store._\n\nSo, what does all this mean? When AD CS creates a new CA (or it renews CA certificates), it\npublishes the new certificate to the NTAuthCertificates object by adding the new certificate\nto the object’s cacertificate attribute:\n\n**_Figure 16 - Viewing an NTAuthCertificates Object that Trusts a Single CA Certificate_**\n\nDuring certificate authentication, the DC can then verify that the authenticating certificate chains\nto a CA certificate defined by the `NTAuthCertificates object. CA certificates in the`\nNTAuthCertificates object must in turn chain to a root CA. The big takeaway here is **_the_**\n**_NTAuthCertificates object is the root of trust for certificate authentication in Active Directory![68]_**\n\nSmart cards are a well-known technology that use Kerberos certificate authentication. A smart\ncard is a physical device that protects the client private key for a certificate at the hardware level.\nVirtual smart cards also exist, though they do not have the same security guarantees. RDP\nsupports authentication with smart cards, but there is one caveat: the certificate template the\nuser enrolls in needs to have the Smart Card Logon (1.3.6.1.4.1.311.20.2.2) OID set in the\n\n[67 https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/import-third-party-ca-to-enterprise-ntauth-store](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/import-third-party-ca-to-enterprise-ntauth-store)\n\n[68 https://twitter.com/gentilkiwi/status/1154685386968506368](https://twitter.com/gentilkiwi/status/1154685386968506368)\n\n\n_Windows CAs automatically publish their CA certificates to this store._\n\nSo, what does all this mean? When AD CS creates a new CA (or it renews CA certificates), it\npublishes the new certificate to the NTAuthCertificates object by adding the new certificate\nto the object’s cacertificate attribute:\n\n**_Figure 16 - Viewing an NTAuthCertificates Object that Trusts a Single CA Certificate_**\n\nDuring certificate authentication, the DC can then verify that the authenticating certificate chains\nto a CA certificate defined by the `NTAuthCertificates object. CA certificates in the`\nNTAuthCertificates object must in turn chain to a root CA. The big takeaway here is **_the_**\n**_NTAuthCertificates object is the root of trust for certificate authentication in Active Directory![68]_**\n\nSmart cards are a well-known technology that use Kerberos certificate authentication. A smart\ncard is a physical device that protects the client private key for a certificate at the hardware level.\n\n\n-----\n\n```\npKIExtendedKeyUsage property. As a sidenote, Christoph Falta’s GitHub repo[69] has\n\n```\ninformation on using virtual smart cards, and MySmartLogon has a nice reference on importing\na .pfx manually into a smart card[70].\n\nLast year, @_ethicalchaos_ made a PR to Rubeus to implement PKINIT abuse[71], and covers more\ndetails on this in depth in their post on attacking smart card based AD networks[72]. This means\nthe one could use Rubeus to request a Kerberos ticket granting ticket (TGT) using a certificate\nthat allows for domain authentication (without needing a physical smart card or the Windows\nCredential Store):\n\n**_Figure 17 - Using Rubeus to Request a TGT with a Certificate_**\n\nThis paper covers how to steal existing certificates and how to further use them with Rubeus\nshortly in the “Certificate Theft” section.\n\n#### Secure Channel (Schannel) Authentication\n\nSchannel is the security support provider (SSP) Windows leverages when establishing TLS/SSL\nconnections. Schannel supports client authentication (amongst many other capabilities),\nenabling a remote server to verify the identity of the connecting user. It accomplishes this using\nPKI, with certificates being the primary credential. During the TLS handshake, the server requests\n\n[69 https://github.com/cfalta/PoshADCS#virtual-smartcards-to-the-rescue](https://github.com/cfalta/PoshADCS#virtual-smartcards-to-the-rescue)\n\n[70 https://www.mysmartlogon.com/knowledge-base/save-pfxp12-file-smart-card/](https://www.mysmartlogon.com/knowledge-base/save-pfxp12-file-smart-card/)\n\n[71 https://github.com/GhostPack/Rubeus/blob/master/CHANGELOG.md#160---2020-11-06](https://github.com/GhostPack/Rubeus/blob/master/CHANGELOG.md#160---2020-11-06)\n\n[72 https://ethicalchaos.dev/2020/10/04/attacking-smart-card-based-active-directory-networks/](https://ethicalchaos.dev/2020/10/04/attacking-smart-card-based-active-directory-networks/)\n\n\nLast year, @_ethicalchaos_ made a PR to Rubeus to implement PKINIT abuse[71], and covers more\ndetails on this in depth in their post on attacking smart card based AD networks[72]. This means\nthe one could use Rubeus to request a Kerberos ticket granting ticket (TGT) using a certificate\nthat allows for domain authentication (without needing a physical smart card or the Windows\nCredential Store):\n\n**_Figure 17 - Using Rubeus to Request a TGT with a Certificate_**\n\nThis paper covers how to steal existing certificates and how to further use them with Rubeus\nshortly in the “Certificate Theft” section.\n\n#### Secure Channel (Schannel) Authentication\n\nSchannel is the security support provider (SSP) Windows leverages when establishing TLS/SSL\nconnections. Schannel supports client authentication (amongst many other capabilities),\n\n\n-----\n\na certificate from the client for authentication. The client, having previously been issued a client\nauthentication certificate from a CA the server trusts, sends its certificate to the server. The\nserver then validates the certificate is correct and grants the user access assuming everything is\nokay. Comodo has a nice simple overview of this process on their blog[73].\n\nWhen an account authenticates to AD using a certificate, the DC needs to somehow map the\ncertificate credential to an AD account. Schannel first attempts to map the credential to a user\naccount use Kerberos’s S4U2Self functionality. If that is unsuccessful, it will follow the attempt to\nmap the certificate to a user account using the certificate’s SAN extension, a combination of the\nsubject and issuer fields, or solely from the issuer, as outlined in section 3.5.2 of the _Remote_\n_Certificate Mapping Protocol (MS-RCMP) specification[74]._\n\nBy default, not many protocols in AD environments support AD authentication via Schannel out\nof the box. WinRM, RDP, and IIS all support client authentication using Schannel, but it requires\nadditional configuration, and in some cases – like WinRM – does not integrate with Active\nDirectory. One protocol that does commonly work – assuming AD CS has been setup - is LDAPS\n(a.k.a., LDAP over SSL/TLS). In fact, what initiated this research was learning from the AD technical\nspecification (MS-ADTS) that client certificate authentication to LDAPS is even possible[75].\n\nBased our experience, not many tools seem to take advantage of client certificate authentication\nto LDAPS. The cmdlet `Get-LdapCurrentUser[76] demonstrates how one can authenticate to`\nLDAP using .NET libraries. The cmdlet performs an LDAP “Who am I?” extended operation to\ndisplay the currently authenticating user:\n\n73 https://comodosslstore.com/blog/what-is-ssl-tls-client-authentication-how-does-it-work.html\n\n74 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rcmp/d16ed463-f75d-47f5-b19f-e026bcf1bffe\n\n75 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/8e73932f-70cf-46d6-88b1-8d9f86235e81\n\n76 https://github.com/leechristensen/Random/blob/master/PowerShellScripts/Get-LdapCurrentUser.ps1\n\n\nokay. Comodo has a nice simple overview of this process on their blog .\n\nWhen an account authenticates to AD using a certificate, the DC needs to somehow map the\ncertificate credential to an AD account. Schannel first attempts to map the credential to a user\naccount use Kerberos’s S4U2Self functionality. If that is unsuccessful, it will follow the attempt to\nmap the certificate to a user account using the certificate’s SAN extension, a combination of the\nsubject and issuer fields, or solely from the issuer, as outlined in section 3.5.2 of the _Remote_\n_Certificate Mapping Protocol (MS-RCMP) specification[74]._\n\nBy default, not many protocols in AD environments support AD authentication via Schannel out\nof the box. WinRM, RDP, and IIS all support client authentication using Schannel, but it requires\nadditional configuration, and in some cases – like WinRM – does not integrate with Active\nDirectory. One protocol that does commonly work – assuming AD CS has been setup - is LDAPS\n(a.k.a., LDAP over SSL/TLS). In fact, what initiated this research was learning from the AD technical\nspecification (MS-ADTS) that client certificate authentication to LDAPS is even possible[75].\n\nBased our experience, not many tools seem to take advantage of client certificate authentication\nto LDAPS. The cmdlet `Get-LdapCurrentUser[76] demonstrates how one can authenticate to`\nLDAP using .NET libraries. The cmdlet performs an LDAP “Who am I?” extended operation to\ndisplay the currently authenticating user:\n\n\n-----\n\n**_Figure 18 - Authenticating to LDAP as Another User using Schannel_**\n\n### AD CS Enumeration\n\nJust like for most of AD, all the information covered so far is available by querying LDAP as a\ndomain authenticated, but otherwise unprivileged, user.\n\nIf we want to enumerate Enterprise CAs and their settings, one can query LDAP using the\n`(objectCategory=pKIEnrollmentService)` LDAP filter on the\n```\nCN=Configuration,DC=<DOMAIN>,DC=<COM> search base (this search base corresponds\n\n```\nwith the Configuration naming context of the AD forest). The results will identify the DNS\nhostname of the CA server, the CA name itself, the certificate start and end dates, various flags,\npublished certificate templates, and more.\n\nTo better facilitate the enumeration and abuse of the various misconfigurations detailed in this\npaper, we built Certify. Certify is a C# tool that can enumerate useful configuration and\ninfrastructure information about of AD CS environments and can request certificates in a variety\nof different ways. We will release Certify approximately 45 days after publishing this paper, and\nwe will be covering various Certify functionality throughout this paper.\n\nCertify’s cas command can enumerate trusted root CA certificates, certificates defined by the\nNTAuthCertificates object, and various information about Enterprise CAs:\n\n\n**_Figure 18 - Authenticating to LDAP as Another User using Schannel_**\n\n### AD CS Enumeration\n\nJust like for most of AD, all the information covered so far is available by querying LDAP as a\ndomain authenticated, but otherwise unprivileged, user.\n\nIf we want to enumerate Enterprise CAs and their settings, one can query LDAP using the\n`(objectCategory=pKIEnrollmentService)` LDAP filter on the\n```\nCN=Configuration,DC=<DOMAIN>,DC=<COM> search base (this search base corresponds\n\n```\nwith the Configuration naming context of the AD forest). The results will identify the DNS\nhostname of the CA server, the CA name itself, the certificate start and end dates, various flags,\npublished certificate templates, and more.\n\nTo better facilitate the enumeration and abuse of the various misconfigurations detailed in this\npaper, we built Certify. Certify is a C# tool that can enumerate useful configuration and\ninfrastructure information about of AD CS environments and can request certificates in a variety\nof different ways. We will release Certify approximately 45 days after publishing this paper, and\nwe will be covering various Certify functionality throughout this paper.\n\nCertify’s cas command can enumerate trusted root CA certificates, certificates defined by the\nNTAuthCertificates object, and various information about Enterprise CAs:\n\n\n-----\n\nOn a domain-joined machine, one can also enumerate Enterprise CAs using certutil.exe ```\nTCAInfo:\n\n```\n**_Figure 20 - Enumerating Certificate Authorities with certutil.exe_**\n\n\n**_Figure 19 - Output from Certify's cas command_**\n\nOn a domain-joined machine, one can also enumerate Enterprise CAs using certutil.exe -\n```\nTCAInfo:\n\n```\n\n-----\n\nCertificate templates are AD objects with an object class of pKICertificateTemplate and\nstore the template’s configuration data. An Enterprise CA “publishes” a template – making it\navailable for clients to enroll in - by adding the template’s name to the\n`certificatetemplates` attribute of an Enterprise CA’s AD object. Using Certify’s `find`\ncommand, one can enumerate Enterprise CAs and return detailed information about the\ncertificate templates each one publishes:\n\n**_Figure 21 - Enterprise CA Information from Certify’s find Command_**\n\n**_Figure 22 - Certificate Template Information from Certify’s find Command_**\n\nThe output of certutil.exe -TCAInfo includes each Enterprise CA’s published certificate\ntemplates. To get detailed information about each available certificate template, one can use\n```\ncertutil -v -dstemplate :\n\n```\n\n**_Figure 21 - Enterprise CA Information from Certify’s find Command_**\n\n\n-----\n\n**_Figure 23 - Enumerating Certificate Templates with certutil_**\n\n\n**_Figure 23 - Enumerating Certificate Templates with certutil_**\n\n\n-----\n\n## AD CS Tradecraft\n\n### Certificate Theft\n\nSetting up working Windows PKI infrastructure in an organization of any size is not the simplest\ntask. If an organization has AD CS installed and configured (and they probably do) they had a\nreason to undergo the engineering effort. This means that if an enterprise CA exists, at least some\nAD users and/or computers likely have certificates issued to them, and some of these certificates\nlikely will have an EKU permitting domain authentication.\n\nSo where, and how, are these certificates stored? Specifically, since a working Windows _.pfx_\ncertificate file is the combination of a public certificate and private key, where and how are both\nthe certificate and its associated private key certificate stored? One option is for private keys is\nto store them on a smart card. In this case, refer to @_ethicalchaos_’s post on attacking\nhardware-based smart cards[77]. If the machine has a Trusted Platform Module (TPM), Windows\ncould store the private key in the TPM if AD CS has a certificate template supporting it[78]. The CA\nserver could also protect its private key using a Hardware Security Module (HSM)[79]. Attacking\nsmart cards, TPMs, and HSMs is outside the scope of this paper.\n\nIn our experience, though, many organizations do not use any hardware-backed storage methods\nand instead use the default settings where the OS stores the keys itself. In this case, Windows\nuses the Data Protection Application Programming Interface (DPAPI) to protect the key material.\nIf you are unfamiliar with DPAPI, we have a post that describes it in depth[80]. The tools we will\ndiscuss to perform certificate theft are built-in Windows commands, GhostPack’s SharpDPAPI[81],\nand various Mimikatz modules.\n\n#### Exporting Certificates Using the Crypto APIs – THEFT1\n\nThe easiest way to extract a user or machine certificate and private key is through an interactive\ndesktop session. If the private key is exportable, one can simply right click the certificate in\n\n_certmgr.msc, and go to All Tasks → Export… to export a password protected .pfx file. One can_\n\n[77 https://ethicalchaos.dev/2020/10/04/attacking-smart-card-based-active-directory-networks/](https://ethicalchaos.dev/2020/10/04/attacking-smart-card-based-active-directory-networks/)\n\n[78 https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/setting-up-tpm-protected-certificates-using-a-microsoft/ba-p/1129055](https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/setting-up-tpm-protected-certificates-using-a-microsoft/ba-p/1129055)\n\n[79 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786417(v=ws.11)](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786417(v=ws.11))\n\n[80 https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107](https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107)\n\n[81 https://github.com/GhostPack/SharpDPAPI](https://github.com/GhostPack/SharpDPAPI)\n\n\n### Certificate Theft\n\nSetting up working Windows PKI infrastructure in an organization of any size is not the simplest\ntask. If an organization has AD CS installed and configured (and they probably do) they had a\nreason to undergo the engineering effort. This means that if an enterprise CA exists, at least some\nAD users and/or computers likely have certificates issued to them, and some of these certificates\nlikely will have an EKU permitting domain authentication.\n\nSo where, and how, are these certificates stored? Specifically, since a working Windows _.pfx_\ncertificate file is the combination of a public certificate and private key, where and how are both\nthe certificate and its associated private key certificate stored? One option is for private keys is\nto store them on a smart card. In this case, refer to @_ethicalchaos_’s post on attacking\nhardware-based smart cards[77]. If the machine has a Trusted Platform Module (TPM), Windows\ncould store the private key in the TPM if AD CS has a certificate template supporting it[78]. The CA\nserver could also protect its private key using a Hardware Security Module (HSM)[79]. Attacking\nsmart cards, TPMs, and HSMs is outside the scope of this paper.\n\nIn our experience, though, many organizations do not use any hardware-backed storage methods\nand instead use the default settings where the OS stores the keys itself. In this case, Windows\nuses the Data Protection Application Programming Interface (DPAPI) to protect the key material.\nIf you are unfamiliar with DPAPI, we have a post that describes it in depth[80]. The tools we will\ndiscuss to perform certificate theft are built-in Windows commands, GhostPack’s SharpDPAPI[81]\nand various Mimikatz modules.\n\n#### Exporting Certificates Using the Crypto APIs – THEFT1\n\nThe easiest way to extract a user or machine certificate and private key is through an interactive\ndesktop session. If the private key is exportable, one can simply right click the certificate in\n\n\n-----\n\naccomplish this programmatically as well. Examples include PowerShell’s `Export-`\n```\nPfxCertificate cmdlet or TheWover’s CertStealer[82] C# project. \n\n```\nUnderneath, these methods use the Microsoft CryptoAPI (CAPI) or more modern Cryptography\nAPI: Next Generation (CNG) to interact with the certificate store. These APIs perform various\ncryptographic services that needed for certificate storage and authentication (amongst other\nuses).\n\nIf the private key is non-exportable, CAPI and CNG will not allow extraction of non-exportable\ncertificates. Mimikatz’s crypto::capi and crypto::cng commands can patch the CAPI and\nCNG to allow exportation of private keys. crypto::capi patches CAPI in the current process\nwhereas crypto::cng requires patching lsass.exe’s memory.\n\n**_Figure 24 – Patching the CAPI and Exporting a Certificate with Mimikatz_**\n\n**Defensive IDs: NONE**\n\n82 https://github.com/TheWover/CertStealer\n\n\ncryptographic services that needed for certificate storage and authentication (amongst other\nuses).\n\nIf the private key is non-exportable, CAPI and CNG will not allow extraction of non-exportable\ncertificates. Mimikatz’s crypto::capi and crypto::cng commands can patch the CAPI and\nCNG to allow exportation of private keys. crypto::capi patches CAPI in the current process\nwhereas crypto::cng requires patching lsass.exe’s memory.\n\n\n-----\n\nDefensively, there are methods for detecting tampering of LSASS’s memory. We will not cover\nthese approaches this paper as they are outside the focus of AD CS. In addition, we have not\nfound great logs for detecting certificate theft when Windows APIs are used to export a\ncertificate.\n\n#### User Certificate Theft via DPAPI – THEFT2\n\nWindows stores certificate private keys using DPAPI. Microsoft breaks out the storage locations\nfor user and machine private keys[83]. When manually decrypting the encrypted DPAPI blobs, a\ndeveloper needs to understand which cryptography API the OS used as the private key file\nstructure differs between the two APIs. When using SharpDPAPI, it automatically accounts for\nthese file format differences.\n\nWindows most commonly stores user certificates in the registry in the key\n`HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\SystemCertificates[84],` though some\npersonal certificates for users are also stored in\n```\n%APPDATA%\\Microsoft\\SystemCertificates\\My\\Certificates\\. The associated user\n\n```\nprivate key locations are primarily at %APPDATA%\\Microsoft\\Crypto\\RSA\\User SID\\ for\nCAPI keys and `%APPDATA%\\Microsoft\\Crypto\\Keys\\ for CNG keys. These structures are`\nsemi-undocumented, though Benjamin Delpy has nicely broken down these structures in\nMimikatz[85] [86]. From these structures, one can derive:\n\n - The DPAPI masterkey needed to decrypt the private key protected blob. This defines the\nuser/machine masterkey (identified by a GUID) needed to decrypt the private key.\n\n - The UniqueName of the private key, also known as the key container name. Windows\nstores certificates in some type of raw format (that we were not able to determine) with\nmetadata prefixed to the actual data of the certificate. Either this UniqueName or the\nprivate key filename is embedded in this metadata and is likely the best way to link private\nkeys to their associated certificates. As we do not have this method built out, the other\n“hackish” way is to compare the decrypted private key components to the public key\ncomponents[87].\n\nTo obtain a certificate and its associated private key, one needs to:\n\n[83 https://docs.microsoft.com/en-us/windows/win32/seccng/key-storage-and-retrieval#key-directories-and-files](https://docs.microsoft.com/en-us/windows/win32/seccng/key-storage-and-retrieval#key-directories-and-files)\n\n84 https://docs.microsoft.com/en-us/windows/win32/seccrypto/system-store-locations#cert_system_store_current_user\n\n[85 https://github.com/gentilkiwi/mimikatz/blob/fe4e98405589e96ed6de5e05ce3c872f8108c0a0/modules/kull_m_key.h#L18-L38](https://github.com/gentilkiwi/mimikatz/blob/fe4e98405589e96ed6de5e05ce3c872f8108c0a0/modules/kull_m_key.h#L18-L38)\n\n[86 https://github.com/gentilkiwi/mimikatz/blob/fe4e98405589e96ed6de5e05ce3c872f8108c0a0/modules/kull_m_key.h#L51-L68](https://github.com/gentilkiwi/mimikatz/blob/fe4e98405589e96ed6de5e05ce3c872f8108c0a0/modules/kull_m_key.h#L51-L68)\n\n[87 https://github.com/GhostPack/SharpDPAPI/blob/a81031fe714fab80339187bc2bd8b22c110a08af/SharpDPAPI/lib/Dpapi.cs#L446-L451](https://github.com/GhostPack/SharpDPAPI/blob/a81031fe714fab80339187bc2bd8b22c110a08af/SharpDPAPI/lib/Dpapi.cs#L446-L451)\n\n\ncertificate.\n\n#### User Certificate Theft via DPAPI – THEFT2\n\nWindows stores certificate private keys using DPAPI. Microsoft breaks out the storage locations\nfor user and machine private keys[83]. When manually decrypting the encrypted DPAPI blobs, a\ndeveloper needs to understand which cryptography API the OS used as the private key file\nstructure differs between the two APIs. When using SharpDPAPI, it automatically accounts for\nthese file format differences.\n\nWindows most commonly stores user certificates in the registry in the key\n`HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\SystemCertificates[84],` though some\npersonal certificates for users are also stored\n```\n%APPDATA%\\Microsoft\\SystemCertificates\\My\\Certificates\\. The associated user\n\n```\nprivate key locations are primarily at %APPDATA%\\Microsoft\\Crypto\\RSA\\User SID\\ for\nCAPI keys and `%APPDATA%\\Microsoft\\Crypto\\Keys\\ for CNG keys. These structures are`\nsemi-undocumented, though Benjamin Delpy has nicely broken down these structures in\nMimikatz[85] [86]. From these structures, one can derive:\n\n - The DPAPI masterkey needed to decrypt the private key protected blob. This defines the\nuser/machine masterkey (identified by a GUID) needed to decrypt the private key.\n\n - The UniqueName of the private key, also known as the key container name. Windows\nstores certificates in some type of raw format (that we were not able to determine) with\nmetadata prefixed to the actual data of the certificate. Either this UniqueName or the\nprivate key filename is embedded in this metadata and is likely the best way to link private\nkeys to their associated certificates. As we do not have this method built out, the other\n“hackish” way is to compare the decrypted private key components to the public key\ncomponents[87].\n\n\n-----\n\n1. Identify which certificate one wants to steal from the user’s certificate store and extract\nthe key store name.\n2. Find the DPAPI masterkey needed to decrypt the associated private key.\n3. Obtain the plaintext DPAPI masterkey and use it to decrypt the private key.\n\nBenjamin Delpy has documented this process with EFS certificates[88], but the same process\napplies to other certificates.\n\nThere are multiple methods to get the plaintext DPAPI masterkey. A domain’s DPAPI backup key[89]\ncan decrypt any domain user’s masterkey file. Mimikatz’s `dpapi::masterkey`\n```\n/in:”C:\\PATH\\TO\\KEY” /rpc command can retrieve an account’s masterkey if Mimikatz is\n\n```\nrun in the target user’s security context. If a user’s password is known, one can decrypt masterkey\nfile using SharpDPAPI’s `masterkeys command or Mimikatz’s` `dpapi::masterkey`\n`/in:”C:\\PATH\\TO\\KEY” /sid:accountSid /password:PASS` command.\n\nTo simplify masterkey file and private key file decryption, SharpDPAPI’s `certificates`\ncommand can be used with the `/pvk,` `/mkfile,` `/password, or` `{GUID}:KEY arguments to`\ndecrypt the private keys and associated certificates, outputting a .pem text file:\n\n[88 https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files](https://github.com/gentilkiwi/mimikatz/wiki/howto-%7E-decrypt-EFS-files)\n\n[89 https://github.com/GhostPack/SharpDPAPI#backupkey](https://github.com/GhostPack/SharpDPAPI#backupkey)\n\n\nBenjamin Delpy has documented this process with EFS certificates[88], but the same process\napplies to other certificates.\n\nThere are multiple methods to get the plaintext DPAPI masterkey. A domain’s DPAPI backup key[89]\ncan decrypt any domain user’s masterkey file. Mimikatz’s `dpapi::masterkey`\n```\n/in:”C:\\PATH\\TO\\KEY” /rpc command can retrieve an account’s masterkey if Mimikatz is\n\n```\nrun in the target user’s security context. If a user’s password is known, one can decrypt masterkey\nfile using SharpDPAPI’s `masterkeys command or Mimikatz’s` `dpapi::masterkey`\n`/in:”C:\\PATH\\TO\\KEY” /sid:accountSid /password:PASS` command.\n\nTo simplify masterkey file and private key file decryption, SharpDPAPI’s `certificates`\ncommand can be used with the `/pvk,` `/mkfile,` `/password, or` `{GUID}:KEY arguments to`\ndecrypt the private keys and associated certificates, outputting a .pem text file:\n\n\n-----\n\n**_Figure 25 – Exporting a Certificate with SharpDPAPI_**\n\nNote the call out for “[!] Certificate can be used for client auth!”, indicating the certificate allows\nfor domain authentication. To convert the .pem to a .pfx, one can use the openssl command\ndisplayed at the end of the SharpDPAPI output:\n```\nopenssl pkcs12 -in cert.pem -keyex -CSP \"Microsoft Enhanced\nCryptographic Provider v1.0\" -export -out cert.pfx\n\n```\n**Defensive IDs:**\n\n  - Detecting Reading of DPAPI-Encrypted Keys - DETECT5\n\n#### Machine Certificate Theft via DPAPI – THEFT3\n\nWindows stores machine certificates in the registry key\n```\nHKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\SystemCertificates[90] and stores private\n\n```\nkeys in several different places depending on the account[91]. Although SharpDPAPI will search all\n\n90 https://docs.microsoft.com/en-us/windows/win32/seccrypto/system-store-locations#cert_system_store_local_machine\n\n[91 https://docs.microsoft.com/en-us/windows/win32/seccng/key-storage-and-retrieval#key-directories-and-files](https://docs.microsoft.com/en-us/windows/win32/seccng/key-storage-and-retrieval#key-directories-and-files)\n\n\n**_Figure 25 – Exporting a Certificate with SharpDPAPI_**\n\nNote the call out for “[!] Certificate can be used for client auth!”, indicating the certificate allows\nfor domain authentication. To convert the .pem to a .pfx, one can use the openssl command\ndisplayed at the end of the SharpDPAPI output:\n```\nopenssl pkcs12 -in cert.pem -keyex -CSP \"Microsoft Enhanced\nCryptographic Provider v1.0\" -export -out cert.pfx\n\n```\n**Defensive IDs:**\n\n  - Detecting Reading of DPAPI-Encrypted Keys - DETECT5\n\n#### Machine Certificate Theft via DPAPI – THEFT3\n\n\n-----\n\nthese locations, the most interesting results tend to come from\n```\n%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\RSA\\MachineKeys\n\n```\n(CAPI) and `%ALLUSERSPROFILE%\\Application Data\\Microsoft\\Crypto\\Keys (CNG).`\nThese private keys are associated with the machine certificate store and Windows encrypts them\nwith the machine’s DPAPI master keys. One cannot decrypt these keys using the domain’s DPAPI\nbackup key, but rather must use the DPAPI_SYSTEM LSA secret on the system which is accessible\nonly by the SYSTEM user. You can do this manually with Mimikatz’ `lsadump::secrets`\ncommand and then use the extracted key to decrypt machine masterkeys. You can also patch\nCAPI/CNG as before and use Mimikatz’ `crypto::certificates` `/export`\n```\n/systemstore:LOCAL_MACHINE command.\n\n```\nSharpDPAPI’s `certificates command with the` `/machine flag (while elevated) will`\nautomatically elevate to SYSTEM, dump the DPAPI_SYSTEM LSA secret, use this to decrypt and\nfound machine DPAPI masterkeys, and use the key plaintexts as a lookup table to decrypt any\nmachine certificate private keys:\n\n**_Figure 26 – Triaging System Certificates with Seatbelt_**\n\nOnce transformed to a `.pfx file, one can use the` `.pfx for domain authentication` _as that_\n_computer account if the appropriate EKU scenario is present. We will cover how to abuse these_\ncertificates in the “Machine Persistence via Certificates - PERSIST2” section.\n\n**Defensive IDs:**\n\n\nonly by the SYSTEM user. You can do this manually with Mimikatz’ `lsadump::secrets`\ncommand and then use the extracted key to decrypt machine masterkeys. You can also patch\nCAPI/CNG as before and use Mimikatz’ `crypto::certificates` `/export`\n```\n/systemstore:LOCAL_MACHINE command.\n\n```\nSharpDPAPI’s `certificates command with the` `/machine flag (while elevated) will`\nautomatically elevate to SYSTEM, dump the DPAPI_SYSTEM LSA secret, use this to decrypt and\nfound machine DPAPI masterkeys, and use the key plaintexts as a lookup table to decrypt any\nmachine certificate private keys:\n\n**_Figure 26 – Triaging System Certificates with Seatbelt_**\n\n\n-----\n\n  - Detecting Reading of DPAPI-Encrypted Keys - DETECT5\n\n#### Finding Certificate Files – THEFT4\n\nSometimes certificates and their private keys are just lying around on file systems, and one does\nnot need to extract them from system stores. For example, we have seen exported certificates\nand their private keys in file shares, in administrators’ `Downloads folder, in source code`\nrepositories, and on servers’ file systems (amongst many other places).\n\nThe most common type of Windows-focused certificate files we have seen are .pfx and .p12\nfiles, with .pkcs12 sometimes showing up but less often. These are PKCS#12 formatted files, a\ngeneral-use archive format for storing one or more cryptographic objects in a single file. This is\nthe format used by Windows when exporting certificates and are usually password protected\nsince the Windows GUI requires a password to be set.\n\nAnother common format is .pem files, which contain base64 encodings of a certificate and its\nassociated private key. As described in the “User Certificate Theft via DPAPI – THEFT2” section,\nopenssl can easily convert between these formats.\n\nWhile the following list is not complete, other potentially interesting certificate-related file\nextensions are:\n\n**.key** Contains just the private key.\n\n**.crt/.cer** Contains just the certificate.\n\n**.csr** Certificate signing request file. This does not contain certificates or\nkeys.\n\n**.jks/.keystore/.keys** Java Keystore. May contain certs + private keys used by Java\napplications.\n\nSo, what is the best way to proactively find these certificate files? Any file share mining\napproaches will work. For example, you can use the Seatbelt command `\"dir C:\\ 10`\n`\\.(pfx|pem|p12)`$ false\"` to search C:\\ folder up to 10 folders deep for .pfx/.pem/.p12\nfiles, or use its FindInterestingFiles command to search users’ folders for these files.\n\n|.key|Contains just the private key.|\n|---|---|\n|.crt/.cer|Contains just the certificate.|\n|.csr|Certificate signing request file. This does not contain certificates or keys.|\n|.jks/.keystore/.keys|Java Keystore. May contain certs + private keys used by Java applications.|\n\n\nnot need to extract them from system stores. For example, we have seen exported certificates\nand their private keys in file shares, in administrators’ `Downloads folder, in source code`\nrepositories, and on servers’ file systems (amongst many other places).\n\nThe most common type of Windows-focused certificate files we have seen are .pfx and .p12\nfiles, with .pkcs12 sometimes showing up but less often. These are PKCS#12 formatted files, a\ngeneral-use archive format for storing one or more cryptographic objects in a single file. This is\nthe format used by Windows when exporting certificates and are usually password protected\nsince the Windows GUI requires a password to be set.\n\nAnother common format is .pem files, which contain base64 encodings of a certificate and its\nassociated private key. As described in the “User Certificate Theft via DPAPI – THEFT2” section,\nopenssl can easily convert between these formats.\n\nWhile the following list is not complete, other potentially interesting certificate-related file\nextensions are:\n\n**.key** Contains just the private key.\n\n**.crt/.cer** Contains just the certificate.\n\n**.csr** Certificate signing request file. This does not contain certificates or\nkeys.\n\n**.jks/.keystore/.keys** Java Keystore. May contain certs + private keys used by Java\napplications.\n\n\n-----\n\nIf you find a PKCS#12 certificate file and it is password protected, you can extract a hash using\npfx2john.py[92] crack it using JohnTheRipper. Hashcat unfortunately does not yet support this\nformat at the time of this paper[93].\n\nYour next questions will probably be, “What can I use this certificate for?” Recall the from the\n“Background” section - these EKU OIDs[94] detail what a certificate can be used for (code signing,\nauthentication, etc.) You can easily list EKUs for a certificate with PowerShell:\n```\n$CertPath = “C:\\path\\to\\cert.pfx”\n\n```\n```\n$CertPass = “P@ssw0rd”\n$Cert = New-Object\nSystem.Security.Cryptography.X509Certificates.X509Certificate2\n@($CertPath, $CertPass)\n\n```\n```\n$Cert.EnhancedKeyUsageList\n\n```\nYou can also use certutil.exe to parse the .pfx with the following command:\n```\ncertutil.exe -dump -v cert.pfx\n\n```\nOne situation that one might come across if really lucky – a CA certificate file itself. How would\none know? One way (of many different ways) is by correlating between the parsed .pfx file,\nSeatbelt information, and Certify information:\n\n[92 https://fossies.org/dox/john-1.9.0-jumbo-1/pfx2john_8py_source.html](https://fossies.org/dox/john-1.9.0-jumbo-1/pfx2john_8py_source.html)\n\n[93 https://github.com/hashcat/hashcat/issues/351#issuecomment-612739264](https://github.com/hashcat/hashcat/issues/351#issuecomment-612739264)\n\n[94 https://www.pkisolutions.com/object-identifiers-oid-in-pki/](https://www.pkisolutions.com/object-identifiers-oid-in-pki/)\n\n\nYour next questions will probably be, “What can I use this certificate for?” Recall the from the\n_Background”_ section - these EKU OIDs[94] detail what a certificate can be used for (code signing,\nauthentication, etc.) You can easily list EKUs for a certificate with PowerShell:\n```\n$CertPath = “C:\\path\\to\\cert.pfx”\n$CertPass = “P@ssw0rd”\n$Cert = New-Object\nSystem.Security.Cryptography.X509Certificates.X509Certificate2\n@($CertPath, $CertPass)\n$Cert.EnhancedKeyUsageList\n\n```\nYou can also use certutil.exe to parse the .pfx with the following command:\n```\ncertutil.exe -dump -v cert.pfx\n\n```\nOne situation that one might come across if really lucky – a CA certificate file itself. How would\none know? One way (of many different ways) is by correlating between the parsed .pfx file,\nSeatbelt information, and Certify information:\n\n\n-----\n\nThe section “Forging Certificates with Stolen CA Certificates - DPERSIST1” also contains other\ntechniques to identify a CA certificate.\n\n**Defensive IDs:**\n\n  - Use Honey Credentials – DETECT6\n\n#### NTLM Credential Theft via PKINIT – THEFT5\n\nThere is an additional offensive bonus that comes from certificate/PKINIT abuse – NTLM\ncredential theft – as summarized in this @gentilkiwi tweet[95]:\n\n[95 https://twitter.com/gentilkiwi/status/826932815518371841](https://twitter.com/gentilkiwi/status/826932815518371841)\n\n\n**_Figure 27 – Correlating Certificates with a CA Thumbprint on the Host and AD_**\n\nThe section “Forging Certificates with Stolen CA Certificates - DPERSIST1” also contains other\ntechniques to identify a CA certificate.\n\n**Defensive IDs:**\n\n  - Use Honey Credentials – DETECT6\n\n#### NTLM Credential Theft via PKINIT – THEFT5\n\nThere is an additional offensive bonus that comes from certificate/PKINIT abuse – NTLM\ncredential theft – as summarized in this @gentilkiwi tweet[95]:\n\n\n-----\n\n**_Figure 28 - Tweet Demonstrating Mimikatz Obtaining NTLM Credentials via PKINIT_**\n\nHow is this happening? In MS-PKCA (Microsoft’s Kerberos PKINIT technical specification) section\n_“1.4 Relationship to Other Protocols” states[96]:_\n\n_“In order to support NTLM authentication [MS-NLMP] for applications_\n_connecting to network services that do not support Kerberos authentication,_\n_when PKCA is used, the KDC returns the user’s NTLM one-way function (OWF)_\n_in the privilege attribute certificate (PAC) PAC_CREDENTIAL_INFO buffer”_\n\nSo, if account authenticates and gets a TGT through PKINIT, there is a built-in “failsafe” that allows\nthe current host to obtain our NTLM hash from the TGT to support legacy authentication. This\n\n96 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/4e5fb325-eabc-4fac-a0da-af2b6b4430cb\n\n\n**_Figure 28 - Tweet Demonstrating Mimikatz Obtaining NTLM Credentials via PKINIT_**\n\nHow is this happening? In MS-PKCA (Microsoft’s Kerberos PKINIT technical specification) section\n_“1.4 Relationship to Other Protocols” states[96]:_\n\n_“In order to support NTLM authentication [MS-NLMP] for applications_\n_connecting to network services that do not support Kerberos authentication,_\n_when PKCA is used, the KDC returns the user’s NTLM one-way function (OWF)_\n\n\n-----\n\ninvolves decrypting a PAC_CREDENTIAL_DATA structure that is a Network Data Representation\n(NDR) serialized representation of the NTLM plaintext. NDR is notoriously a giant pain to deal\nwith outside of C/C++, but luckily for us Benjamin Delpy has already implemented this in Kekeo,\nwith the tgt::pac function:\n\n**_Figure 29 – PKINIT to NTLM with Kekeo_**\n\n**_Figure 30 – PKINIT to NTLM with Kekeo_**\n\n\n**_Figure 29 – PKINIT to NTLM with Kekeo_**\n\n\n-----\n\nKekeo’s implementation will also work with smartcard-protected certs that are currently plugged\nin if you can recover the pin[97]. Other parties are currently integrating this functionality into\nRubeus.\n\nPutting this together with stealing an AD CA’s root certificate, we can forge a certificate for any\nactive user or computer and use this to get their current NTLM plaintext.\n\n**Defensive IDs:**\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n    - Monitor for Kerberos authentication via PKINIT, since the NTLM hash is only\nreturned when PKINIT is used\n\n### Account Persistence\n\n#### Active User Credential Theft via Certificates – PERSIST1\n\nIf an enterprise CA exists, a user can request a cert for any template available to them for\nenrollment. The goal, in the context of user credential theft, is to request a certificate for a\ntemplate that allows authentication to AD as that user. That is, a template that has the following\nproperties:\n\n  - Published for enrollment.\n\n  - Domain Users (or another group the victim user is a member of) are allowed to enroll.\n\n  - Has any of the following EKUs which enable (at a minimum) domain authentication:\n\n    - Smart Card Logon (1.3.6.1.4.1.311.20.2.2)\n\n    - Client Authentication (1.3.6.1.5.5.7.3.2)\n\n    - PKINIT Client Authentication (1.3.6.1.5.2.3.4)\n\n    - Any Purpose EKU (2.5.29.37.0)\n\n    - No EKU set. i.e., this is a (subordinate) CA certificate.\n\n  - Does not require manager approval or “authorized signatures” issuance requirements.\n\nLuckily, there is a stock published template that allows just this, the User template. However,\nwhile this template is default for AD CS, some environments may disable it. How can one go about\nfinding certificate templates available for enrollment?\n\n[97 https://github.com/CCob/PinSwipe](https://github.com/CCob/PinSwipe)\n\n\nactive user or computer and use this to get their current NTLM plaintext.\n\n**Defensive IDs:**\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n    - Monitor for Kerberos authentication via PKINIT, since the NTLM hash is only\nreturned when PKINIT is used\n\n### Account Persistence\n\n#### Active User Credential Theft via Certificates – PERSIST1\n\nIf an enterprise CA exists, a user can request a cert for any template available to them for\nenrollment. The goal, in the context of user credential theft, is to request a certificate for a\ntemplate that allows authentication to AD as that user. That is, a template that has the following\nproperties:\n\n  - Published for enrollment.\n\n  - Domain Users (or another group the victim user is a member of) are allowed to enroll.\n\n  - Has any of the following EKUs which enable (at a minimum) domain authentication:\n\n    - Smart Card Logon (1.3.6.1.4.1.311.20.2.2)\n\n    - Client Authentication (1.3.6.1.5.5.7.3.2)\n\n    - PKINIT Client Authentication (1.3.6.1.5.2.3.4)\n\n    - Any Purpose EKU (2.5.29.37.0)\n\n    - No EKU set. i.e., this is a (subordinate) CA certificate.\n\n  - Does not require manager approval or “authorized signatures” issuance requirements.\n\n\n-----\n\nCertify covers this situation again - the Certify.exe find /clientauth command will query\nLDAP for available templates that match the above criteria:\n\n**_Figure 31 - Enumerating Certificate Templates with Certify_**\n\nAs seen above, the User template is present and matches the criteria. The default User template\nissues certificates that are valid for a year, but we have seen often seen custom templates used\nthat increase the expiration length. As a reminder, if an attacker maliciously enrolls in this type\nof template, the certificate can be used for authentication as that user as long as the certificate\nis valid, even if the user changes their password!\n\n**Sidenote: For any vulnerable templates found, one thing to pay close attention to are the**\n“Enrollment Principals''. As mentioned in the “Enrollment Rights and Protocols” section, for\npublished templates there is a special Certificate-Enrollment extended right that defines the\nprincipals allowed to enroll in the certificate. Certify’s `find` command will enumerate these\nprincipals, along with ACL information for the template. An attacker just needs control of a\nprincipal that has the right to enroll in the template.\n\nIf we have GUI access to a host, we can manually request a certificate through certmgr.msc or\nvia the command-line with certreq.exe. To enroll the current user context in a new certificate\ntemplate using Certify, run `Certify.exe` `request` `/ca:CA-SERVER\\CA-NAME`\n```\n/template:TEMPLATE-NAME :\n\n```\n\n**_Figure 31 - Enumerating Certificate Templates with Certify_**\n\nAs seen above, the User template is present and matches the criteria. The default User template\nissues certificates that are valid for a year, but we have seen often seen custom templates used\nthat increase the expiration length. As a reminder, if an attacker maliciously enrolls in this type\nof template, the certificate can be used for authentication as that user as long as the certificate\nis valid, even if the user changes their password!\n\n**Sidenote: For any vulnerable templates found, one thing to pay close attention to are the**\n“Enrollment Principals''. As mentioned in the “Enrollment Rights and Protocols” section, for\npublished templates there is a special Certificate-Enrollment extended right that defines the\nprincipals allowed to enroll in the certificate. Certify’s `find` command will enumerate these\nprincipals, along with ACL information for the template. An attacker just needs control of a\nprincipal that has the right to enroll in the template.\n\nIf we have GUI access to a host, we can manually request a certificate through certmgr.msc or\nvia the command-line with certreq.exe. To enroll the current user context in a new certificate\ntemplate using Certify, run `Certify.exe` `request` `/ca:CA-SERVER\\CA-NAME`\n```\n/template:TEMPLATE-NAME :\n\n```\n\n-----\n\n**_Figure 32 - Requesting a Certificate Enrollment with Certify_**\n\nThe result will be a certificate + private key .pem formatted block of text. You can transform this\ninto a .pfx compatible with Rubeus using the previously discussed command openssl pkcs12\n```\n-in cert.pem -keyex -CSP \"Microsoft Enhanced Cryptographic Provider\nv1.0\" -export -out cert.pfx\n\n```\nOne can then upload the .pfx to a target and use it with Rubeus to request a TGT for the enrolled\nuser, for as long as the certificate is valid (remember, the default certificate lifetime is one year):\n\n\n**_Figure 32 - Requesting a Certificate Enrollment with Certify_**\n\nThe result will be a certificate + private key .pem formatted block of text. You can transform this\ninto a .pfx compatible with Rubeus using the previously discussed command openssl pkcs12\n```\n-in cert.pem -keyex -CSP \"Microsoft Enhanced Cryptographic Provider\nv1.0\" -export -out cert.pfx\n\n```\nOne can then upload the .pfx to a target and use it with Rubeus to request a TGT for the enrolled\nuser, for as long as the certificate is valid (remember, the default certificate lifetime is one year)\n\n\n-----\n\n**_Figure 33 - Using Rubeus to Request a User TGT with a Certificate_**\n\nSince certificates are an independent primary authentication credential, this certificate will still\nbe usable even if the user resets their password! Combined with the technique outlined in the\n“NTLM Credential Theft via PKINIT – THEFT5” section, an attacker can also persistently obtain the\naccount’s NTLM hash, which the attacker could use to authenticate via pass-the-hash or crack to\nobtain the plaintext password. Overall, this is an alternative method of long-term credential\n**theft that does not touch LSASS and is possible from a non-elevated context!**\n\n**Defensive IDs:**\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n#### Machine Persistence via Certificates - PERSIST2\n\nMachine accounts are just slightly special types of user accounts. If a certificate template\nmatched the requirements from the User template but instead allowed for Domain Computers\nas enrollment principals, an attacker could enroll a compromised system’s machine account. The\ndefault Machine template matches all those characteristics:\n\n\n**_Figure 33 - Using Rubeus to Request a User TGT with a Certificate_**\n\nSince certificates are an independent primary authentication credential, this certificate will still\nbe usable even if the user resets their password! Combined with the technique outlined in the\n_NTLM Credential Theft via PKINIT – THEFT5” section, an attacker can also persistently obtain the_\naccount’s NTLM hash, which the attacker could use to authenticate via pass-the-hash or crack to\nobtain the plaintext password. Overall, this is an alternative method of long-term credential\n**theft that does not touch LSASS and is possible from a non-elevated context!**\n\n**Defensive IDs:**\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n#### Machine Persistence via Certificates - PERSIST2\n\nMachine accounts are just slightly special types of user accounts. If a certificate template\nmatched the requirements from the User template but instead allowed for Domain Computers\nas enrollment principals, an attacker could enroll a compromised system’s machine account. The\ndefault Machine template matches all those characteristics:\n\n\n-----\n\n**_Figure 34 – Certify Showing that Domain Computers Have Access to the Machines Template_**\n\nIf an attacker elevates privileges on compromised system, the attacker can use the SYSTEM\naccount to enroll in certificate templates that grant enrollment privileges to machine accounts.\nCertify accomplishes this with its /machine argument when requesting a certificate, causing it\nto auto-elevate to SYSTEM and then enroll in a certificate template:\n\n**_Figure 35 - Using Certify to Request a Certificate, Authenticating as the Machine Account_**\n\n\n**_Figure 34 – Certify Showing that Domain Computers Have Access to the Machines Template_**\n\nIf an attacker elevates privileges on compromised system, the attacker can use the SYSTEM\naccount to enroll in certificate templates that grant enrollment privileges to machine accounts.\nCertify accomplishes this with its /machine argument when requesting a certificate, causing it\nto auto-elevate to SYSTEM and then enroll in a certificate template:\n\n\n-----\n\nWith access to a machine account certificate, the attacker can then authenticate to Kerberos as\nthe machine account. Using S4U2Self, an attacker can then obtain a Kerberos service ticket to\nany service on the host (e.g., CIFS, HTTP, RPCSS, etc.) as any user. Elad Shamir’s excellent post[98]\nabout Kerberos delegation attacks detailed this attack scenario.\n\nUltimately, this gives an attack a machine persistence method that lasts as long as the certificate\nis valid (for the default Machine template, that means one year). This persistence mechanism\ncontinues working even after the system changes its password (default of every 30 days), will\nsurvive a system wipe (assuming the same machine account name is used after the wipe), and\ndoes not require changing anything on the host OS itself!\n\n**Defensive IDs:**\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n#### Account Persistence via Certificate Renewal - PERSIST3\n\nCertificate templates have a “Validity Period” which determines how long an issued certificate\ncan be used, as well as a “Renewal period” (usually 6 weeks). This is a window of time before the\ncertificate expires where an account can renew it from the issuing certificate authority. While\nthis happens automatically for auto-enrolled certificates[99], normal accounts can do this manually\nas well.\n\nIf an attacker compromises a certificate capable of domain authentication through theft or\nmalicious enrollment, the attacker can authenticate to AD for the duration of the certificate’s\nvalidity period. The attacker, however, can renew the certificate before expiration. This can\nfunction as an extended persistence approach that prevents additional ticket enrollments from\nbeing requested, which can leave artifacts on the CA server itself.\n\n**Defensive IDs: NONE**\n\n### Domain Escalation\n\nBy this point you probably realize that certificates and PKI, especially in AD, are not simple. This\nis an area that not that many people (including us, until recently) have sought to understand from\n\n[98 https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html)\n\n[99 https://blog.keyfactor.com/certificate-auto-enrollment-issuance](https://blog.keyfactor.com/certificate-auto-enrollment-issuance)\n\n\nUltimately, this gives an attack a machine persistence method that lasts as long as the certificate\nis valid (for the default Machine template, that means one year). This persistence mechanism\ncontinues working even after the system changes its password (default of every 30 days), will\nsurvive a system wipe (assuming the same machine account name is used after the wipe), and\ndoes not require changing anything on the host OS itself!\n\n**Defensive IDs:**\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n#### Account Persistence via Certificate Renewal - PERSIST3\n\nCertificate templates have a “Validity Period” which determines how long an issued certificate\ncan be used, as well as a “Renewal period” (usually 6 weeks). This is a window of time before the\ncertificate expires where an account can renew it from the issuing certificate authority. While\nthis happens automatically for auto-enrolled certificates[99], normal accounts can do this manually\nas well.\n\nIf an attacker compromises a certificate capable of domain authentication through theft or\nmalicious enrollment, the attacker can authenticate to AD for the duration of the certificate’s\nvalidity period. The attacker, however, can renew the certificate before expiration. This can\nfunction as an extended persistence approach that prevents additional ticket enrollments from\nbeing requested, which can leave artifacts on the CA server itself.\n\n**Defensive IDs: NONE**\n\n\n-----\n\na security perspective. While there is not anything inherently insecure about AD CS, like with any\nsystem that hasn’t had a huge amount of scrutiny, it’s easy for organizations to misconfigure it in\na way that seriously affects the security of their environment.\n\n#### Misconfigured Certificate Templates - ESC1\n\nThere is a specific set of settings for certificate templates that makes them extremely vulnerable.\nAs in regular-domain-user-to-domain-admin vulnerable. The first scenario (ESC1) that results in\nthis vulnerable configuration is as follows:\n\n  - **The Enterprise CA grants low-privileged users enrollment rights. The Enterprise CA’s**\nconfiguration must permit low-privileged users the ability to request certificates. See the\n_“Enrollment Rights and Protocols” section at the beginning of this paper for more details._\n\n  - **Manager approval is disabled. This setting necessitates that a user with CA “manager”**\npermissions review and approve the requested certificate before the certificate is issued.\nSee the “Manager Approval” section at the beginning of this paper for more details.\n\n  - **No authorized signatures are required. This setting requires any CSR to be signed by an**\nexisting authorized certificate. See the “Enrollment Agents, Authorized Signatures, and\n_Application Policies” section at the beginning of this paper for more details._\n\n  - **An overly permissive certificate template security descriptor grants certificate**\n**enrollment rights to low-privileged users. Having certificate enrollment rights allows a**\nlow-privileged attacker to request and obtain a certificate based on the template.\nEnrollment Rights are granted via the certificate template AD object’s security descriptor.\nIn the discretionary access control list (DACL), the following access control entry (ACE)\nconfigurations permit enrollment:\n\nIn the Certificate Templates Console MMC snap-in, permissions are set under the template’s\nproperties → Security:\n\n\nThere is a specific set of settings for certificate templates that makes them extremely vulnerable.\nAs in regular-domain-user-to-domain-admin vulnerable. The first scenario (ESC1) that results in\nthis vulnerable configuration is as follows:\n\n  - **The Enterprise CA grants low-privileged users enrollment rights. The Enterprise CA’s**\nconfiguration must permit low-privileged users the ability to request certificates. See the\n_“Enrollment Rights and Protocols” section at the beginning of this paper for more details._\n\n  - **Manager approval is disabled. This setting necessitates that a user with CA “manager”**\npermissions review and approve the requested certificate before the certificate is issued.\nSee the “Manager Approval” section at the beginning of this paper for more details.\n\n  - **No authorized signatures are required. This setting requires any CSR to be signed by an**\nexisting authorized certificate. See the “Enrollment Agents, Authorized Signatures, and\n_Application Policies” section at the beginning of this paper for more details._\n\n  - **An overly permissive certificate template security descriptor grants certificate**\n**enrollment rights to low-privileged users. Having certificate enrollment rights allows a**\nlow-privileged attacker to request and obtain a certificate based on the template.\nEnrollment Rights are granted via the certificate template AD object’s security descriptor.\nIn the discretionary access control list (DACL), the following access control entry (ACE)\nconfigurations permit enrollment:\n\nIn the Certificate Templates Console MMC snap-in, permissions are set under the template’s\nproperties → Security:\n\n\n-----\n\n- **The certificate template defines EKUs that enable authentication. Applicable EKUs**\ninclude Client Authentication (OID 1.3.6.1.5.5.7.3.2), PKINIT Client Authentication\n(1.3.6.1.5.2.3.4), Smart Card Logon (OID 1.3.6.1.4.1.311.20.2.2), Any Purpose (OID\n2.5.29.37.0), or no EKU (SubCA). The certificate template’s AD object specifies the EKUs\n\nin its pKIExtendedKeyUsage property, which is an array of strings specifying the OIDs of\n\nthe enabled EKUs. In the Certificate Templates Console MMC snap-in, EKUs are set under\nthe template’s properties → Extensions → Application Policies:\n\n\n**_Figure 36 - Setting a Certificate Template Security Settings_**\n\n  - **The certificate template defines EKUs that enable authentication. Applicable EKUs**\ninclude Client Authentication (OID 1.3.6.1.5.5.7.3.2), PKINIT Client Authentication\n(1.3.6.1.5.2.3.4), Smart Card Logon (OID 1.3.6.1.4.1.311.20.2.2), Any Purpose (OID\n2.5.29.37.0), or no EKU (SubCA). The certificate template’s AD object specifies the EKUs\n\nin its pKIExtendedKeyUsage property, which is an array of strings specifying the OIDs of\n\nthe enabled EKUs. In the Certificate Templates Console MMC snap-in, EKUs are set under\nthe template’s properties → Extensions → Application Policies:\n\n\n-----\n\n  - **The certificate template allows requesters to specify a subjectAltName in the CSR.** Recall\nthat during AD authentication, AD will use the identity specified by a certificate’s\nsubjectAltName (SAN) field if it is present. Consequently, if a requester can specify the\nSAN in a CSR, the requester can request a certificate as anyone (e.g., a domain admin\nuser). The certificate template’s AD object specifies if the requester can specify the SAN\nin its mspki-certificate-name-flag property. The mspki-certificate-name-flag property is a\nbitmask and if the `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag is present, a`\nrequester can specify the SAN. In the Certificate Templates Console MMC snap-in, this\nvalue is set under a template’s properties → Subject Name → Supply in request:\n\n**_Figure 38 - Supply in Request Configuration_**\n\nThese settings allow a low-privileged user to request a certificate with an arbitrary SAN, allowing\nthe low-privileged user to authenticate as any principal in the domain via Kerberos or SChannel.\n\n\n**_Figure 37 – Setting EKUs under Application Policies_**\n\n  - **The certificate template allows requesters to specify a subjectAltName in the CSR.** Recall\nthat during AD authentication, AD will use the identity specified by a certificate’s\nsubjectAltName (SAN) field if it is present. Consequently, if a requester can specify the\nSAN in a CSR, the requester can request a certificate as anyone (e.g., a domain admin\nuser). The certificate template’s AD object specifies if the requester can specify the SAN\nin its mspki-certificate-name-flag property. The mspki-certificate-name-flag property is a\nbitmask and if the `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag is present, a`\nrequester can specify the SAN. In the Certificate Templates Console MMC snap-in, this\nvalue is set under a template’s properties → Subject Name → Supply in request:\n\n\n-----\n\nThe ability to specify a SAN is the crux of this misconfiguration. This is often enabled, for example,\nto allow products or deployment services to generate HTTPS certificates or host certificates on\nthe fly. It is also enabled simply because IT administrators setting up PKI are unaware of its\nimplications. In the Certificates Templates Console MMC snap-in, if administrators enable the\n“Supply in request” option, a warning does appear:\n\n**_Figure 39 - Supply in Request Setting Warning_**\n\nHowever, if an administrator is unfamiliar with PKI, they very likely could click through this\nwarning as they are battling to get things working. Duplicating a template that already exhibits\nthe vulnerable settings also does not result in a warning. In addition, we suspect that when IT\nadministrators create their own certificate templates, they may duplicate the default WebServer\ntemplate that comes with AD CS. The _WebServer_ template has the\n```\nCT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag enabled and then if IT administrators add the\n\n```\n“Client Authentication” or “Smart Card Logon” EKUs, the vulnerable scenario occurs without a\nwarning from the GUI.\n\nThis is not too much of a farfetched idea either as one of the first things IT administrators typically\nwant an AD CS server for is to create HTTPS certificates. Furthermore, many applications use\nSSL/TLS mutual authentication, in which case IT administrators may erroneously enable the\nServer Authentication and Client Authentication EKUs, resulting in a vulnerable configuration.\nCarl Sörqvist also postulated about this scenario in a post titled _“Supply in the Request_\n_Shenanigans”[ 100]._\n\nSo taken all together, if there is a published certificate template that allows for these settings, an\nattacker can request a certificate as anyone in the environment, including a domain administrator\n(or domain controller), and use that certificate to get a legitimate TGT for said user!\n\n[100 https://blog.qdsecurity.se/2020/09/04/supply-in-the-request-shenanigans/](https://blog.qdsecurity.se/2020/09/04/supply-in-the-request-shenanigans/)\n\n\n“Supply in request” option, a warning does appear:\n\n**_Figure 39 - Supply in Request Setting Warning_**\n\nHowever, if an administrator is unfamiliar with PKI, they very likely could click through this\nwarning as they are battling to get things working. Duplicating a template that already exhibits\nthe vulnerable settings also does not result in a warning. In addition, we suspect that when IT\nadministrators create their own certificate templates, they may duplicate the default WebServer\ntemplate that comes with AD CS. The _WebServer_ template has the\n```\nCT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag enabled and then if IT administrators add the\n\n```\n“Client Authentication” or “Smart Card Logon” EKUs, the vulnerable scenario occurs without a\nwarning from the GUI.\n\nThis is not too much of a farfetched idea either as one of the first things IT administrators typically\nwant an AD CS server for is to create HTTPS certificates. Furthermore, many applications use\nSSL/TLS mutual authentication, in which case IT administrators may erroneously enable the\nServer Authentication and Client Authentication EKUs, resulting in a vulnerable configuration.\nCarl Sörqvist also postulated about this scenario in a post titled _“Supply in the Request_\n_Shenanigans”[ 100]._\n\n\n-----\n\nIn other words, this can be a domain user to domain admin escalation vector in many\nenvironments!\n\nIn our experience, this happens quite often. Let’s check out an example demonstrating ESC1.\nBelow is a vulnerable template that we enumerated using Certify.exe find /vulnerable :\n\n**_Figure 40 - Enumerating Vulnerable Certificate Templates with Certify_**\n\nNote that the certificate has the CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag enabled, has\nthe Client Authentication EKU, and grants Domain Users enrollment rights. Now we can request\na certificate, from our currently unelevated context, specifying the /altname as a Domain Admin\n(localadmin in this case):\n\n\n**_Figure 40 - Enumerating Vulnerable Certificate Templates with Certify_**\n\nNote that the certificate has the CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag enabled, has\nthe Client Authentication EKU, and grants Domain Users enrollment rights. Now we can request\na certificate, from our currently unelevated context, specifying the /altname as a Domain Admin\n_localadmin in this case):_\n\n\n-----\n\n**_Figure 41 - Abusing a Vulnerable Certificate Template with Certify_**\n\nAfter openssl transformation, this certificate lets us request a TGT as localadmin which we can\nthen use to access the domain controller:\n\n**_Figure 42 - Rubeus Building the Request_**\n\n\n**_Figure 41 - Abusing a Vulnerable Certificate Template with Certify_**\n\nAfter openssl transformation, this certificate lets us request a TGT as localadmin which we can\nthen use to access the domain controller:\n\n\n-----\n\n**_Figure 43 - Authenticating with an Abused Certificate with Rubeus_**\n\nThe following LDAP query when run against the AD Forest’s configuration schema can be used to\nenumerate certificate templates that do not require approval/signatures, that have a Client\nAuthentication or Smart Card Logon EKU, and have the\n```\nCT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag enabled:\n(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextend\nedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)\n(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate-name-flag:1.2.840.113556.1.4.804:=1))\n\n```\n**Defensive IDs:**\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Enforce Strict User Mappings - PREVENT7\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n\n**_Figure 43 - Authenticating with an Abused Certificate with Rubeus_**\n\nThe following LDAP query when run against the AD Forest’s configuration schema can be used to\nenumerate certificate templates that do not require approval/signatures, that have a Client\nAuthentication or Smart Card Logon EKU, and have the\n```\nCT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag enabled:\n(&(objectclass=pkicertificatetemplate)(!(mspki-enrollment-\nflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-\nsignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextend\nedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)\n(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspki-\ncertificate-name-flag:1.2.840.113556.1.4.804:=1))\n\n```\n**Defensive IDs:**\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Enforce Strict User Mappings - PREVENT7\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n\n-----\n\n#### Misconfigured Certificate Templates - ESC2\n\nThe second abuse scenario (ESC2) is a variation of the first. This scenario occurs under the\nfollowing conditions:\n\n1. **The Enterprise CA grants low-privileged users enrollment rights. Details are the same as**\nin ESC1.\n2. **Manager approval is disabled. Details are the same as in ESC1.**\n3. **No authorized signatures are required. Details are the same as in ESC1.**\n4. **An overly permissive certificate template security descriptor grants certificate**\n**enrollment rights to low-privileged users. Details are the same as in ESC1.**\n5. **The certificate template defines the Any Purpose EKU or no EKU.**\n\nWhile templates with these EKUs can’t be used to request authentication certificates as other\nusers without the CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag being present (i.e., ESC1), an\nattacker can use them to authenticate to AD as the user who requested them and these two EKUs\nare certainly dangerous on their own.\n\nWe were initially a bit unclear about the capabilities of the Any Purpose and subordinate CA\n(SubCA) EKUs, but others reached out and helped us clarify our understanding. An attacker can\nuse a certificate with the Any Purpose EKU for (surprise!) any purpose — client authentication,\nserver authentication, code signing, etc. In contrast, an attacker can use a certificate with no\nEKUs — a subordinate CA certificate — for any purpose as well but could also use it to sign new\ncertificates. As such, using a subordinate CA certificate, an attacker could specify arbitrary EKUs\nor fields in the new certificates.\n\nHowever, if the subordinate CA is not trusted by the NTAuthCertificates object (which it won’t be\nby default), the attacker cannot create new certificates that will work for domain authentication.\nStill, the attacker can create new certificates with any EKU and arbitrary certificate values, of\nwhich there’s plenty the attacker could potentially abuse (e.g., code signing, server\nauthentication, etc.) and might have large implications for other applications in the network like\nSAML, AD FS, or IPSec.\n\nWe feel confident in stating that it’s very bad if an attacker can obtain an **Any Purpose or**\nsubordinate CA (SubCA) certificate, regardless of whether it’s trusted by NTAuthCertificates or\nnot. The following LDAP query when run against the AD Forest’s configuration schema can be\nused to enumerate templates matching this scenario:\n\n\nin ESC1.\n2. **Manager approval is disabled. Details are the same as in ESC1.**\n3. **No authorized signatures are required. Details are the same as in ESC1.**\n4. **An overly permissive certificate template security descriptor grants certificate**\n**enrollment rights to low-privileged users. Details are the same as in ESC1.**\n5. **The certificate template defines the Any Purpose EKU or no EKU.**\n\nWhile templates with these EKUs can’t be used to request authentication certificates as other\nusers without the CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag being present (i.e., ESC1), an\nattacker can use them to authenticate to AD as the user who requested them and these two EKUs\nare certainly dangerous on their own.\n\nWe were initially a bit unclear about the capabilities of the Any Purpose and subordinate CA\n**SubCA) EKUs, but others reached out and helped us clarify our understanding. An attacker can**\nuse a certificate with the Any Purpose EKU for (surprise!) any purpose — client authentication,\nserver authentication, code signing, etc. In contrast, an attacker can use a certificate with no\nEKUs — a subordinate CA certificate — for any purpose as well but could also use it to sign new\ncertificates. As such, using a subordinate CA certificate, an attacker could specify arbitrary EKUs\nor fields in the new certificates.\n\nHowever, if the subordinate CA is not trusted by the NTAuthCertificates object (which it won’t be\nby default), the attacker cannot create new certificates that will work for domain authentication.\nStill, the attacker can create new certificates with any EKU and arbitrary certificate values, of\nwhich there’s plenty the attacker could potentially abuse (e.g., code signing, server\nauthentication, etc.) and might have large implications for other applications in the network like\nSAML, AD FS, or IPSec.\n\nWe feel confident in stating that it’s very bad if an attacker can obtain an **Any Purpose or**\n\n\n-----\n\n```\n(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusag\ne=*))))\n\n```\n**Defensive IDs:**\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Enforce Strict User Mappings - PREVENT7\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n#### Misconfigured Enrollment Agent Templates - ESC3\n\nThe third abuse scenario (ESC3) is like ESC1 and ESC2 but abuses a different EKU and requires an\nadditional step for abuse. Please see the “Enrollment Agents, Authorized Signatures, and\n_Application Policies” section for the necessary background information for this section._\n\nThe Certificate Request Agent EKU (OID 1.3.6.1.4.1.311.20.2.1), known as Enrollment Agent in\nMicrosoft documentation[101], allows a principal to enroll for a certificate on behalf of another\nuser. “Enroll for someone else, isn’t that a security issue?” some may ask. However, this is a\ncommon scenario as described by Microsoft’s documentation. Imagine a smart card user visiting\nan IT administrator in-person for verification, and that administrator then needs to submit a\ncertificate request in behalf that user.\n\nAD CS accomplishes this through a certificate template with the Certificate Request Agent OID\n(1.3.6.1.4.1.311.20.2.1) in its EKUs. The “enrollment agent” enrolls in such a template and uses\nthe resulting certificate to co-sign a CSR on behalf of the other user. It then sends the co-signed\nCSR to the CA, enrolling in a template that permits “enroll on behalf of”, and the CA responds\nwith a certificate belong to the “other” user.\n\nTo abuse this for privilege scalation, a CAs requires at least two templates matching conditions\nbelow.\n\n**Condition 1 - A template allows a low-privileged user to enroll in an enrollment agent certificate.**\n\n[101 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-cersod/97f47d4c-2901-41fa-9616-96b94e1b5435](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-cersod/97f47d4c-2901-41fa-9616-96b94e1b5435)\n\n\n**Defensive IDs:**\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Enforce Strict User Mappings - PREVENT7\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n#### Misconfigured Enrollment Agent Templates - ESC3\n\nThe third abuse scenario (ESC3) is like ESC1 and ESC2 but abuses a different EKU and requires an\nadditional step for abuse. Please see the “Enrollment Agents, Authorized Signatures, and\n_Application Policies” section for the necessary background information for this section._\n\nThe Certificate Request Agent EKU (OID 1.3.6.1.4.1.311.20.2.1), known as Enrollment Agent in\nMicrosoft documentation[101], allows a principal to enroll for a certificate on behalf of another\nuser. “Enroll for someone else, isn’t that a security issue?” some may ask. However, this is a\ncommon scenario as described by Microsoft’s documentation. Imagine a smart card user visiting\nan IT administrator in-person for verification, and that administrator then needs to submit a\ncertificate request in behalf that user.\n\nAD CS accomplishes this through a certificate template with the Certificate Request Agent OID\n(1.3.6.1.4.1.311.20.2.1) in its EKUs. The “enrollment agent” enrolls in such a template and uses\nthe resulting certificate to co-sign a CSR on behalf of the other user. It then sends the co-signed\nCSR to the CA, enrolling in a template that permits “enroll on behalf of”, and the CA responds\nwith a certificate belong to the “other” user.\n\nTo abuse this for privilege scalation, a CAs requires at least two templates matching conditions\n\n\n-----\n\n1. **The Enterprise CA allows low-privileged users enrollment rights. Details are the same as**\nin ESC1.\n2. **Manager approval is disabled. Details are the same as in ESC1.**\n3. **No authorized signatures are required. Details are the same as in ESC1.**\n4. **An overly permissive certificate template security descriptor allows certificate**\n**enrollment rights to low-privileged users. Details are the same as in ESC1.**\n5. **The certificate template defines the Certificate Request Agent EKU. The Certificate**\nRequest Agent OID (1.3.6.1.4.1.311.20.2.1) allows for requesting other certificate\ntemplates on behalf of other principals.\n\n**Condition 2 - Another template permits a low privileged user to use the enrollment agent**\ncertificate to request a certificate on behalf of another user, and the template defines an EKU\nthat allows for domain authentication.\n\n1. **The Enterprise CA allows low-privileged users enrollment rights. Details are the same as**\nin ESC1.\n2. **Manager approval is disabled. Details are the same as in ESC1.**\n3. **The template schema version 1 or is greater than 2 and specifies an Application Policy**\n**Issuance Requirement requiring the Certificate Request Agent EKU.**\n4. **The certificate template defines an EKU that allows for domain authentication.**\n5. **Enrollment agent restrictions are not implemented on the CA.**\n\nHere is an example of a vulnerable template matching Condition 1:\n\n**_Figure 44 - Certificate Request Agent Enabled Template that Anyone can Enroll In_**\n\nAnd here is an example matching Condition 2:\n\n\n5. **The certificate template defines the Certificate Request Agent EKU. The Certificate**\nRequest Agent OID (1.3.6.1.4.1.311.20.2.1) allows for requesting other certificate\ntemplates on behalf of other principals.\n\n**Condition 2 - Another template permits a low privileged user to use the enrollment agent**\ncertificate to request a certificate on behalf of another user, and the template defines an EKU\nthat allows for domain authentication.\n\n1. **The Enterprise CA allows low-privileged users enrollment rights. Details are the same as**\nin ESC1.\n2. **Manager approval is disabled. Details are the same as in ESC1.**\n3. **The template schema version 1 or is greater than 2 and specifies an Application Policy**\n**Issuance Requirement requiring the Certificate Request Agent EKU.**\n4. **The certificate template defines an EKU that allows for domain authentication.**\n5. **Enrollment agent restrictions are not implemented on the CA.**\n\nHere is an example of a vulnerable template matching Condition 1:\n\n\n-----\n\n**_Figure 45 - A Schema Version 2 Template Anyone can Enroll in with Application Policy Issuance Restrictions_**\n\nTo abuse this, Certify can request an enrollment agent certificate (Condition 1):\n\n**_Figure 46 - Requesting an Enrollment Agent Certificate with Certify_**\n\nCertify can then use the enrollment agent certificate to issue a certificate request on behalf of\nanother to a template that allow for domain authentication (Condition 2):\n\n\n**_Figure 45 - A Schema Version 2 Template Anyone can Enroll in with Application Policy Issuance Restrictions_**\n\nTo abuse this, Certify can request an enrollment agent certificate (Condition 1):\n\n**_Figure 46 - Requesting an Enrollment Agent Certificate with Certify_**\n\nCertify can then use the enrollment agent certificate to issue a certificate request on behalf of\nanother to a template that allow for domain authentication (Condition 2):\n\n\n-----\n\nRubeus can then use the certificate to authenticate as the “On Behalf Of” user:\n\n**_Figure 48 - Authenticating with the “on behalf of” Certificate_**\n\nEnterprise CAs can constrain the users who can obtain an enrollment agent certificate, the\ntemplates enrollment agents can enroll in, and which accounts the enrollment agent can act on\nbehalf of by opening _certsrc.msc snap-in_  right clicking on the CA  clicking Properties \nnavigating to the “Enrollment Agents” tab:[102]\n\n[102 https://social.technet.microsoft.com/wiki/contents/articles/10942.ad-cs-security-guidance.aspx#Establish_Restricted_Enrollment_Agents](https://social.technet.microsoft.com/wiki/contents/articles/10942.ad-cs-security-guidance.aspx#Establish_Restricted_Enrollment_Agents)\n\n\n**_Figure 47 – Using Certify to Request a Certificate on Behalf of Another User with an Enrollment Cert_**\n\nRubeus can then use the certificate to authenticate as the “On Behalf Of” user:\n\n**_Figure 48 - Authenticating with the “on behalf of” Certificate_**\n\n\n-----\n\nHowever, the default CA setting is “Do not restrict enrollment agents.” Even when administrators\nenable “Restrict enrollment agents”, the default setting is extremely permissive, allowing\n_Everyone access enroll in all templates as anyone. If Enrollment Agent templates are present in_\nan environment, administrators should constrain them as much as possible using these settings.\n\n**Defensive IDs:**\n\n  - Harden CA Settings - PREVENT2\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n#### Vulnerable Certificate Template Access Control - ESC4\n\nCertificate templates are securable objects in AD, meaning they have a security descriptor that\nspecifies which AD principals have specific permissions over the template.\n\nWe say that a template is misconfigured at the access control level if it has Access Control Entries\n(ACEs) that allow unintended, or otherwise unprivileged, AD principals to edit sensitive security\nsettings in the template.\n\nThat is, if an attacker can chain access to a point that they can actively push a misconfiguration\nto a template that is not otherwise vulnerable (e.g., by enabling the mspki-certificate-name-flag\n\n\n**_Figure 49 – CA Settings Restricting Enrollment Agents (who can Enroll on Behalf of Other Users)_**\n\nHowever, the default CA setting is “Do not restrict enrollment agents.” Even when administrators\nenable “Restrict enrollment agents”, the default setting is extremely permissive, allowing\n_Everyone access enroll in all templates as anyone. If Enrollment Agent templates are present in_\nan environment, administrators should constrain them as much as possible using these settings.\n\n**Defensive IDs:**\n\n  - Harden CA Settings - PREVENT2\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n#### Vulnerable Certificate Template Access Control - ESC4\n\nCertificate templates are securable objects in AD, meaning they have a security descriptor that\nspecifies which AD principals have specific permissions over the template.\n\n\n-----\n\nflag for a template that allows for domain authentication) this results in the same domain\ncompromise scenario as the previous section. This is a scenario explored in Christoph Falta’s\nGitHub repo [103].\n\nThe specific access control rights for template that we should care about from a security\nperspective are “Full Control” and “Write” in the certificate template GUI:\n\n**_Figure 50 - Sensitive Certificate Template DACL Settings_**\n\nHowever, the full rights we care about are:\n\n**Right** **Description**\n\n**Owner** Implicit full control of the object, can edit any properties.\n\n**FullControl** Full control of the object, can edit any properties.\n\n**WriteOwner** Can modify the owner to an attacker-controlled principal.\n\n**WriteDacl** Can modify access control to grant an attacker FullControl.\n\n103 https://github.com/cfalta/PoshADCS\n\n|Right|Description|\n|---|---|\n|Owner|Implicit full control of the object, can edit any properties.|\n|FullControl|Full control of the object, can edit any properties.|\n|WriteOwner|Can modify the owner to an attacker-controlled principal.|\n|WriteDacl|Can modify access control to grant an attacker FullControl.|\n\n\nperspective are “Full Control” and “Write” in the certificate template GUI:\n\n**_Figure 50 - Sensitive Certificate Template DACL Settings_**\n\nHowever, the full rights we care about are:\n\n**Right** **Description**\n\n**Owner** Implicit full control of the object, can edit any properties.\n\n\n-----\n\n|WriteProperty|Can edit any properties.|\n|---|---|\n\n\nYou can build manual parsing for these access control entries, or you can use PKI Solutions’\nPowerShell PKI module[104], specifically the Get-CertificateTemplateAcl[105] cmdlet.\n\nCertify’s `find command enumerates these sensitive access control entries (the BloodHound`\nteam is actively integrating this enumeration as well):\n\n**_Figure 51 - Using Certify to Enumerate a Certificate Template with Vulnerable Access Control_**\n\nFor more information on AD access control from a security perspective, see the “An ACE Up the\n_Sleeve” whitepaper[106]._\n\n**Defensive IDs:**\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n  - Monitor Certificate Template Modifications - DETECT4\n\n[104 https://github.com/PKISolutions/PSPKI](https://github.com/PKISolutions/PSPKI)\n\n[105 https://www.pkisolutions.com/tools/pspki/get-certificatetemplateacl/](https://www.pkisolutions.com/tools/pspki/get-certificatetemplateacl/)\n\n[106 https://specterops.io/assets/resources/an_ace_up_the_sleeve.pdf](https://specterops.io/assets/resources/an_ace_up_the_sleeve.pdf)\n\n\nPowerShell PKI module , specifically the Get-CertificateTemplateAcl cmdlet.\n\nCertify’s `find command enumerates these sensitive access control entries (the BloodHound`\nteam is actively integrating this enumeration as well):\n\n**_Figure 51 - Using Certify to Enumerate a Certificate Template with Vulnerable Access Control_**\n\nFor more information on AD access control from a security perspective, see the “An ACE Up the\n_Sleeve” whitepaper[106]._\n\n**Defensive IDs:**\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n  - Monitor Certificate Authentication Events - DETECT2\n\n\n-----\n\n#### Vulnerable PKI Object Access Control - ESC5\n\nThe web of interconnected ACL based relationships that can affect the security of AD CS is\nextensive. Several objects outside of certificate templates and the certificate authority itself can\nhave a security impact on the entire AD CS system. These possibilities include (but are not limited\nto):\n\n - The CA server’s AD computer object (i.e., compromise through S4U2Self or S4U2Proxy)\n\n - The CA server’s RPC/DCOM server\n\n - Any descendant AD object or container in the container `CN=Public Key`\n\n`Services,CN=Services,CN=Configuration,DC=<COMPANY>,DC=<COM>` (e.g.,\nthe Certificate Templates container, Certification Authorities container, the\nNTAuthCertificates object, the Enrollment Services Container, etc.)\n\nIf a low-privileged attacker can gain control over any of these, the attack can likely compromise\nthe PKI system.\n\n**Defensive IDs:**\n\n  - Harden CA Settings - PREVENT2\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Monitor Certificate Template Modifications - DETECT4\n\n#### EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\nThere is another similar issue, described in the CQure Academy post[107], which involves the\n```\nEDITF_ATTRIBUTESUBJECTALTNAME2 flag. As Microsoft describes, “If this flag is set on the CA,\n\n```\n_any request (including when the subject is built from Active Directory®) can have user defined_\n_values in the subject alternative name.[108]” This means that an attacker can enroll in ANY template_\nconfigured for domain authentication that also allows unprivileged users to enroll (e.g., the\ndefault `User template) and obtain a certificate that allows us to authenticate as a domain admin`\n(or any other active user/machine). As the Keyfactor post describes[109], this setting “just makes it\nwork”, which is why sysadmins likely flip it without fully understanding the security implications.\n\n[107 https://cqureacademy.com/blog/enhanced-key-usage](https://cqureacademy.com/blog/enhanced-key-usage)\n\n[108 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn786426(v=ws.11)#controlling-user-added-subject-alternative-names](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn786426(v=ws.11)#controlling-user-added-subject-alternative-names)\n\n[109 https://blog.keyfactor.com/hidden-dangers-certificate-subject-alternative-names-sans](https://blog.keyfactor.com/hidden-dangers-certificate-subject-alternative-names-sans)\n\n\nextensive. Several objects outside of certificate templates and the certificate authority itself can\nhave a security impact on the entire AD CS system. These possibilities include (but are not limited\nto):\n\n - The CA server’s AD computer object (i.e., compromise through S4U2Self or S4U2Proxy)\n\n - The CA server’s RPC/DCOM server\n\n - Any descendant AD object or container in the container `CN=Public Key`\n\n`Services,CN=Services,CN=Configuration,DC=<COMPANY>,DC=<COM>` (e.g.,\nthe Certificate Templates container, Certification Authorities container, the\nNTAuthCertificates object, the Enrollment Services Container, etc.)\n\nIf a low-privileged attacker can gain control over any of these, the attack can likely compromise\nthe PKI system.\n\n**Defensive IDs:**\n\n  - Harden CA Settings - PREVENT2\n\n  - Harden Certificate Template Settings - PREVENT4\n\n  - Monitor Certificate Template Modifications - DETECT4\n\n#### EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\nThere is another similar issue, described in the CQure Academy post[107], which involves the\n```\nEDITF_ATTRIBUTESUBJECTALTNAME2 flag. As Microsoft describes, “If this flag is set on the CA,\n\n```\n_any request (including when the subject is built from Active Directory®) can have user defined_\n_values in the subject alternative name.[108]” This means that an attacker can enroll in ANY template_\nconfigured for domain authentication that also allows unprivileged users to enroll (e.g., the\ndefault `User template) and obtain a certificate that allows us to authenticate as a domain admin`\n(or any other active user/machine). As the Keyfactor post describes[109], this setting “just makes it\n\n\n-----\n\n**Note: the alternative names here are included in a CSR via the -attrib \"SAN:<X>\" argument**\nto certreq.exe (i.e., “Name Value Pairs”). This is different than the method for abusing SANs in\nESC1 as it stores account information in a certificate attribute vs a certificate extension. We are\nnot sure why it was designed this way.\n\nOrganizations can check if the setting is enabled using the following certutil.exe command:\n```\ncertutil -config \"CA_HOST\\CA_NAME\" -getreg \"policy\\EditFlags\"\n\n```\nUnderneath, this just uses remote registry, so the following command may work as well:\n```\nreg.exe query \\\\<CA_SERVER\n>\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configu\nration\\<CA_NAME>\\PolicyModules\\CertificateAuthority_MicrosoftDefault.P\nolicy\\ /v EditFlags \n\n```\nBoth commands often work as domain authenticated, but otherwise unelevated, user context.\nIn our experience, whether this works is a bit inconsistent (potentially it is because sometimes\nenvironments explicitly disable Remote Registry, but we are unsure).\n\n**_Figure 52 - Unelevated Enumeration of EDITF_ATTRIBUTESUBJECTALTNAME2_**\n\nAnd finally, Certify’s `find command will attempt to check this value for every Certificate`\nAuthority it enumerates:\n\n```\ncertutil -config \"CA_HOST\\CA_NAME\" -getreg \"policy\\EditFlags\"\n\n```\nUnderneath, this just uses remote registry, so the following command may work as well:\n```\nreg.exe query \\\\<CA_SERVER\n>\\HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configu\nration\\<CA_NAME>\\PolicyModules\\CertificateAuthority_MicrosoftDefault.P\nolicy\\ /v EditFlags \n\n```\nBoth commands often work as domain authenticated, but otherwise unelevated, user context.\nIn our experience, whether this works is a bit inconsistent (potentially it is because sometimes\nenvironments explicitly disable Remote Registry, but we are unsure).\n\n**_Figure 52 - Unelevated Enumeration of EDITF_ATTRIBUTESUBJECTALTNAME2_**\n\nAnd finally, Certify’s `find command will attempt to check this value for every Certificate`\nAuthority it enumerates:\n\n\n-----\n\n**_Figure 53 - Checking the Value of EDITF_ATTRIBUTESUBJECTALTNAME2 with Certify_**\n\nTo abuse this, just use the /altname flag with any template that allows for domain auth. In this\ncase let us use the stock User template, which normally doesn’t allow us to specify alternative\nnames, and request a certificate for a DA:\n\n**_Figure 54 - Abusing EDITF_ATTRIBUTESUBJECTALTNAME2 with Certify_**\n\n\n**_Figure 53 - Checking the Value of EDITF_ATTRIBUTESUBJECTALTNAME2 with Certify_**\n\nTo abuse this, just use the /altname flag with any template that allows for domain auth. In this\ncase let us use the stock User template, which normally doesn’t allow us to specify alternative\nnames, and request a certificate for a DA:\n\n\n-----\n\nAs a sidenote, these settings can be set, assuming domain administrative (or equivalent) rights,\nfrom any system:\n```\ncertutil -config \"CA_HOST\\CA_NAME\" -setreg policy\\EditFlags\n+EDITF_ATTRIBUTESUBJECTALTNAME2\n\n```\nIf you find this setting in your environment, you can remove this flag with:\n```\ncertutil -config \"CA_HOST\\CA_NAME\" -setreg policy\\EditFlags EDITF_ATTRIBUTESUBJECTALTNAME2\n\n```\nThis setting is bad. Do not use it. If you want to get an idea of how this even gets set in\nenvironments, Google filetype:pdf EDITF_ATTRIBUTESUBJECTALTNAME2\n\n**Note: the CQure Academy post[110] (in the “Is it right?” section) states that some of these issues**\nwere reported to MSRC on 01/01/2020, and the behavior was determined to be “by design”.\n\n**Defensive IDs:**\n\n  - Harden CA Settings - PREVENT2\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n#### Vulnerable Certificate Authority Access Control - ESC7\n\nOutside of certificate templates, a certificate authority itself has a set of permissions that secure\nvarious CA actions. These permissions can be access from _certsrv.msc, right clicking a CA,_\nselecting properties, and switching to the Security tab:\n\n[110 https://cqureacademy.com/blog/enhanced-key-usage](https://cqureacademy.com/blog/enhanced-key-usage)\n\n\nIf you find this setting in your environment, you can remove this flag with:\n```\ncertutil -config \"CA_HOST\\CA_NAME\" -setreg policy\\EditFlags -\nEDITF_ATTRIBUTESUBJECTALTNAME2\n\n```\nThis setting is bad. Do not use it. If you want to get an idea of how this even gets set in\nenvironments, Google filetype:pdf EDITF_ATTRIBUTESUBJECTALTNAME2\n\n**Note: the CQure Academy post[110] (in the “Is it right?” section) states that some of these issues**\nwere reported to MSRC on 01/01/2020, and the behavior was determined to be “by design”.\n\n**Defensive IDs:**\n\n  - Harden CA Settings - PREVENT2\n\n  - Monitor User/Machine Certificate Enrollments - DETECT1\n\n#### Vulnerable Certificate Authority Access Control - ESC7\n\nOutside of certificate templates, a certificate authority itself has a set of permissions that secure\nvarious CA actions. These permissions can be access from _certsrv.msc, right clicking a CA,_\nselecting properties, and switching to the Security tab:\n\n\n-----\n\n**_Figure 55 - Certificate Authority Permissions from certsrv.msc_**\n\nThis can also be enumerated via PSPKI’s module with `Get-CertificationAuthority |`\n```\nGet-CertificationAuthorityAcl :\n\n```\n**_Figure 56 - Enumerating a Certificate Authority’s ACL through PSPKI_**\n\n\n**_Figure 55 - Certificate Authority Permissions from certsrv.msc_**\n\nThis can also be enumerated via PSPKI’s module with `Get-CertificationAuthority |`\n```\nGet-CertificationAuthorityAcl :\n\n```\n\n-----\n\nThe two main rights here are the _ManageCA right and the_ _ManageCertificates right, which_\ntranslate to the “CA administrator” and “Certificate Manager” (sometimes known as a CA officer)\nrespectively.\n\nThese roles/rights are broken out by Microsoft[111] and in other literature, but it was difficult to\ndetermine the exact security implication for each of these rights. Specifically, it was difficult to\ndetermine how an attacker might abuse these rights remotely. The technical specification “[MS_CSRA]: Certificate Services Remote Administration Protocol”_ section “3.1.1.7 Permissions”[112]\ndetails which associated DCOM methods the _Administrator and_ _Officer rights can perform_\nremotely against a CA. We have not done a complete assessment of all the available DCOM\nmethods, but we will highlight a few interesting results below.\n\nFor the Administrator CA right, the method ICertAdminD2::SetConfigEntry which is used\nto “...used to set the CA's persisted configuration data that is listed in section 3.1.1.10[113]”. Section\n“3.1.1.10 Configuration Data”[114] includes Config_CA_Accept_Request_Attributes_SAN,\nwhich is defined in [MS-WCCE] section 3.2.1.1.4[115] as “A Boolean value that indicates whether\n_the CA accepts request attributes that specify the subject alternative name for the certificate_\n_being requested.” Translation? This is the EDITF_ATTRIBUTESUBJECTALTNAME2 flag described_\nin the previous ESC6 section!\n\nIn 2020, PKISolutions released some additions to PSPKI to enable the direct use of various AD CS\n(D)COM interfaces, including `ICertAdminD2::SetConfigEntry. PKISolutions published a`\npost about this implementation[116], including helpful examples of how to use SetConfigEntry.\n\nSo, putting this all together, if we have a principal with ManageCA rights on a certificate authority,\nwe can use PSPKI to remotely flip the EDITF_ATTRIBUTESUBJECTALTNAME2 bit to allow SAN\nspecification in any template:\n\n[111 https://social.technet.microsoft.com/wiki/contents/articles/10942.ad-cs-security-guidance.aspx#Roles_and_activities](https://social.technet.microsoft.com/wiki/contents/articles/10942.ad-cs-security-guidance.aspx#Roles_and_activities)\n\n[112 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/509360cf-9797-491e-9dd1-795f63cb1538](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/509360cf-9797-491e-9dd1-795f63cb1538)\n\n[113 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/a31ea036-eaec-4b35-a50d-c4fe11843a4b](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/a31ea036-eaec-4b35-a50d-c4fe11843a4b)\n\n[114 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/1b69ebd9-a728-4cd2-ba67-fc5c9f2fc7c8](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/1b69ebd9-a728-4cd2-ba67-fc5c9f2fc7c8)\n\n[115 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wcce/b3ac7b46-8ea7-440d-a4c5-656bb1286d56](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wcce/b3ac7b46-8ea7-440d-a4c5-656bb1286d56)\n\n[116 https://www.pkisolutions.com/powershell-pki-pspki-3-7-enhancements-certification-authority-api-part-1/](https://www.pkisolutions.com/powershell-pki-pspki-3-7-enhancements-certification-authority-api-part-1/)\n\n\nThese roles/rights are broken out by Microsoft[111] and in other literature, but it was difficult to\ndetermine the exact security implication for each of these rights. Specifically, it was difficult to\ndetermine how an attacker might abuse these rights remotely. The technical specification “[MS-\n_CSRA]: Certificate Services Remote Administration Protocol”_ section “3.1.1.7 Permissions”[112]\ndetails which associated DCOM methods the _Administrator and_ _Officer rights can perform_\nremotely against a CA. We have not done a complete assessment of all the available DCOM\nmethods, but we will highlight a few interesting results below.\n\nFor the Administrator CA right, the method ICertAdminD2::SetConfigEntry which is used\nto “...used to set the CA's persisted configuration data that is listed in section 3.1.1.10[113]”. Section\n_3.1.1.10 Configuration Data”[114] includes Config_CA_Accept_Request_Attributes_SAN_\nwhich is defined in [MS-WCCE] section 3.2.1.1.4[115] as “A Boolean value that indicates whether\n_the CA accepts request attributes that specify the subject alternative name for the certificate_\n_being requested.” Translation? This is the EDITF_ATTRIBUTESUBJECTALTNAME2 flag described_\nin the previous ESC6 section!\n\nIn 2020, PKISolutions released some additions to PSPKI to enable the direct use of various AD CS\n(D)COM interfaces, including `ICertAdminD2::SetConfigEntry. PKISolutions published a`\npost about this implementation[116], including helpful examples of how to use SetConfigEntry\n\nSo, putting this all together, if we have a principal with ManageCA rights on a certificate authority,\nwe can use PSPKI to remotely flip the EDITF_ATTRIBUTESUBJECTALTNAME2 bit to allow SAN\nspecification in any template:\n\n\n-----\n\n**_Figure 57 - Setting EDITF_ATTRIBUTESUBJECTALTNAME2 Remotely with PSPKI_**\n\n**_Figure 58 - Confirming EDITF_ATTRIBUTESUBJECTALTNAME2 Modification_**\n\nThis is also possible in a simpler form with PSPKI’s Enable-PolicyModuleFlag[117] cmdlet.\n\nNow let us move on to the _ManageCertificates rights, known as_ _Officer rights in “[MS-CSRA]_\n_3.1.1.7”. There are various methods concerning key archival (aka “key recovery agents”), which_\nwe do not cover in this paper. The ICertAdminD::ResubmitRequest[118] method “...resubmits\n_a specific pending or denied certificate request to the CA.”, which causes a pending request to be_\napproved when performed with Officer rights. The ability to remotely approve pending certificate\nrequests allows an attacker to subvert the \"CA certificate manager approval\" protection detailed\n\n[117 https://www.sysadmins.lv/projects/pspki/enable-policymoduleflag.aspx](https://www.sysadmins.lv/projects/pspki/enable-policymoduleflag.aspx)\n\n[118 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/ffba57d3-f471-4d74-ad37-87114182df30](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-csra/ffba57d3-f471-4d74-ad37-87114182df30)\n\n\n**_Figure 57 - Setting EDITF_ATTRIBUTESUBJECTALTNAME2 Remotely with PSPKI_**\n\n**_Figure 58 - Confirming EDITF_ATTRIBUTESUBJECTALTNAME2 Modification_**\n\nThis is also possible in a simpler form with PSPKI’s Enable-PolicyModuleFlag[117] cmdlet.\n\nNow let us move on to the _ManageCertificates rights, known as_ _Officer rights in “[MS-CSRA]_\n_3.1.1.7”. There are various methods concerning key archival (aka “key recovery agents”), which_\n\n**[118]**\n\n\n-----\n\nin “Harden Certificate Template Settings - PREVENT4” section. This is what PSPKI’s Approve```\nCertificateRequest[119] cmdlet uses under the hood:\n\n```\n**_Figure 59 - Requesting a Certificate that Requires Manager Approval with Certify_**\n\n**_Figure 60 - Approving a Pending Request with PSPKI_**\n\n[119 https://github.com/PKISolutions/PSPKI/blob/4d82f078246eec3b4d55bfe588cde228ec7f1c08/PSPKI/Server/Approve-CertificateRequest.ps1#L27](https://github.com/PKISolutions/PSPKI/blob/4d82f078246eec3b4d55bfe588cde228ec7f1c08/PSPKI/Server/Approve-CertificateRequest.ps1#L27)\n\n\n**_Figure 59 - Requesting a Certificate that Requires Manager Approval with Certify_**\n\n**_Figure 60 - Approving a Pending Request with PSPKI_**\n\n\n-----\n\n**_Figure 61 - Downloading the Issued Certificate with Certify_**\n\n**Defensive IDs:**\n\n  - Miscellaneous – DETECT7\n\n#### NTLM Relay to AD CS HTTP Endpoints – ESC8\n\nAs covered in the “Certificate Enrollment” section, AD CS supports several HTTP-based\nenrollment methods via additional AD CS server roles that administrators can install. These HTTPbased certificate enrollment interfaces are all vulnerable NTLM relay attacks. Using NTLM relay,\nan attacker on a compromised machine can impersonate any inbound-NTLM-authenticating AD\naccount. While impersonating the victim account, an attacker could access these web interfaces\nand request a client authentication certificate based on the `User or` `Machine certificate`\ntemplates.\n\nNTLM relay to the HTTP-based certificate enrollment endpoints is possible because these\nendpoints do not have NTLM relay protections enabled:\n\n  - The web enrollment interface (an older looking ASP application accessible at\n```\n   http://<caserver>/certsrv/), by default only supports HTTP, which cannot protect\n\n```\nagainst NTLM relay attacks. In addition, it explicitly only allows NTLM authentication via\nits Authorization HTTP header, so more secure protocols like Kerberos are unusable.\n\n\n**_Figure 61 - Downloading the Issued Certificate with Certify_**\n\n**Defensive IDs:**\n\n  - Miscellaneous – DETECT7\n\n#### NTLM Relay to AD CS HTTP Endpoints – ESC8\n\nAs covered in the “Certificate Enrollment” section, AD CS supports several HTTP-based\nenrollment methods via additional AD CS server roles that administrators can install. These HTTP-\nbased certificate enrollment interfaces are all vulnerable NTLM relay attacks. Using NTLM relay,\nan attacker on a compromised machine can impersonate any inbound-NTLM-authenticating AD\naccount. While impersonating the victim account, an attacker could access these web interfaces\nand request a client authentication certificate based on the `User or` `Machine certificate`\ntemplates.\n\nNTLM relay to the HTTP-based certificate enrollment endpoints is possible because these\nendpoints do not have NTLM relay protections enabled:\n\n\n-----\n\n  - The Certificate Enrollment Service (CES), Certificate Enrollment Policy (CEP) Web Service,\nand Network Device Enrollment Service (NDES) support negotiate authentication by\ndefault via their Authorization HTTP header. Negotiate authentication support Kerberos\nand NTLM; consequently, an attacker can negotiate down to NTLM authentication during\nrelay attacks. These web services do at least enable HTTPS by default, but unfortunately\nHTTPS by itself does not protect against NTLM relay attacks. Only when HTTPS is coupled\nwith channel binding can HTTPS services be protected from NTLM relay attacks.\nUnfortunately, AD CS does not enable Extended Protection for Authentication on IIS,\nwhich is necessary to enable channel binding.\n\nNTLM relay to AD CS’s web enrollment interfaces provide many advantages to attackers. A\ngeneral issue attackers tend to have when performing NTLM relay attacks is that when an\ninbound authentication occurs and the attacker relays it, there is only a short window of time to\nabuse it. A privileged account may authenticate only once to an attacker’s machine. The\nattacker’s tools can try and keep the NTLM session alive as long as possible, but often the session\nis only usable for a short duration. In addition, the authentication session is restricted – the\nattacker cannot interact with services that enforce NTLM signing.\n\nAn attacker can resolve these limitations, however, by relaying to the AD CS web interfaces. The\nattacker can use NTLM relay to access the AD CS web interfaces and request a client\nauthentication certificate as the victim account. The attacker could then authenticate via\nKerberos or Schannel, or obtain the victim account’s NTLM hash using PKINIT (as discussed in the\n_“NTLM Credential Theft via PKINIT – THEFT5”_ section). This solidifies the attacker’s access to\nvictim account for a long time period (i.e., however long the certificate is valid for) and the\nattacker is free to authenticate to any service using multiple authentication protocols without\nNTLM signing getting in the way.\n\nAnother limitation of NTLM relay attacks is that they require a victim account to authenticate to\nan attacker-controlled machine. An attacker can patiently wait for this occur as part of the normal\noperations on the network, or the attacker can coerce an account to authenticate to a\ncompromised machine. Authentication coercion is possible by many means. Lee Christensen\nhighlighted one such technique, “the printer bug” [120], that works by coercing machine accounts to\nauthenticate to an attacker’s host using the MS-RPRN\n```\nRpcRemoteFindFirstPrinterChangeNotification(Ex) RPC method (implemented in\n\n```\nthe tool SpoolSample[121] and later in the tool Dementor[122] using Impacket).\n\n120 https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory#slide=41\n\n121 https://github.com/leechristensen/SpoolSample/\n\n122 https://github.com/NotMedic/NetNTLMtoSilverTicket/blob/master/dementor.py\n\n\nrelay attacks. These web services do at least enable HTTPS by default, but unfortunately\nHTTPS by itself does not protect against NTLM relay attacks. Only when HTTPS is coupled\nwith channel binding can HTTPS services be protected from NTLM relay attacks.\nUnfortunately, AD CS does not enable Extended Protection for Authentication on IIS,\nwhich is necessary to enable channel binding.\n\nNTLM relay to AD CS’s web enrollment interfaces provide many advantages to attackers. A\ngeneral issue attackers tend to have when performing NTLM relay attacks is that when an\ninbound authentication occurs and the attacker relays it, there is only a short window of time to\nabuse it. A privileged account may authenticate only once to an attacker’s machine. The\nattacker’s tools can try and keep the NTLM session alive as long as possible, but often the session\nis only usable for a short duration. In addition, the authentication session is restricted – the\nattacker cannot interact with services that enforce NTLM signing.\n\nAn attacker can resolve these limitations, however, by relaying to the AD CS web interfaces. The\nattacker can use NTLM relay to access the AD CS web interfaces and request a client\nauthentication certificate as the victim account. The attacker could then authenticate via\nKerberos or Schannel, or obtain the victim account’s NTLM hash using PKINIT (as discussed in the\n_“NTLM Credential Theft via PKINIT – THEFT5”_ section). This solidifies the attacker’s access to\nvictim account for a long time period (i.e., however long the certificate is valid for) and the\nattacker is free to authenticate to any service using multiple authentication protocols without\nNTLM signing getting in the way.\n\nAnother limitation of NTLM relay attacks is that they require a victim account to authenticate to\nan attacker-controlled machine. An attacker can patiently wait for this occur as part of the normal\noperations on the network, or the attacker can coerce an account to authenticate to a\ncompromised machine. Authentication coercion is possible by many means. Lee Christensen\nhighlighted one such technique, “the printer bug” [120], that works by coercing machine accounts to\n\n\n-----\n\n**Note: Newer operating systems have patched the MS-RPRN coerced authentication “feature”.**\nHowever, almost every environment we examine still has Server 2016 machines running, which\nare still vulnerable to this. There are other ways to coerce accounts to authenticate to an attacker\nas well which could assist in local privilege escalation or remote code execution.\n\nUsing “the printer bug”, an attacker can use NTLM relay to impersonate a machine account and\nrequest a client authentication certificate as the victim machine account. If the victim machine\naccount can perform privileged actions such as domain replication (e.g., domain controllers or\nExchange servers), the attacker could use this certificate to compromise the domain. The attacker\ncould also logon as the victim machine account and use S4U2Self as previously described to\naccess the victim machine’s host OS, or use PKINIT to get the machine account’s NT hash and\nthen forge a Kerberos service ticket (a.k.a. the “silver ticket” attack).\n\nIn summary, if an environment has AD CS installed, along with a vulnerable web enrollment\nendpoint and at least one certificate template published that allows for domain computer\nenrollment and client authentication (like the default Machine template), then an attacker can\n**_compromise ANY computer with the spooler service running!_**\n\nCertify’s cas command can enumerate enabled HTTP AD CS endpoints:\n\n**_Figure 62 - Certify Enumerating Enabled AD CS HTTP Endpoints_**\n\nEnterprise CAs also store CES endpoints in their AD object in the msPKI-Enrollment-Servers\nproperty. Certutil.exe and PSPKI can parse and list these endpoints:\n\n\nrequest a client authentication certificate as the victim machine account. If the victim machine\naccount can perform privileged actions such as domain replication (e.g., domain controllers or\nExchange servers), the attacker could use this certificate to compromise the domain. The attacker\ncould also logon as the victim machine account and use S4U2Self as previously described to\naccess the victim machine’s host OS, or use PKINIT to get the machine account’s NT hash and\nthen forge a Kerberos service ticket (a.k.a. the “silver ticket” attack).\n\nIn summary, if an environment has AD CS installed, along with a vulnerable web enrollment\nendpoint and at least one certificate template published that allows for domain computer\nenrollment and client authentication (like the default Machine template), then an attacker can\n**_compromise ANY computer with the spooler service running!_**\n\nCertify’s cas command can enumerate enabled HTTP AD CS endpoints:\n\n**_Figure 62 - Certify Enumerating Enabled AD CS HTTP Endpoints_**\n\n\n-----\n\n**_Figure 63 - Listing CES Endpoints with Certutil_**\n\n**_Figure 64 - List CES Endpoints with PSPKI_**\n\n\n**_Figure 63 - Listing CES Endpoints with Certutil_**\n\n**_Figure 64 - List CES Endpoints with PSPKI_**\n\n**Defensive IDs:**\n\n  - Harden AD CS HTTP Endpoints – PREVENT8\n\n\n-----\n\n### Domain Persistence\n\n**_Figure 65 - Obligatory Meme_**\n\nWith the focus on ADFS attacks and SAML forgery that has resurfaced with the Solarwinds\nincident, we revisited an old pipe dream we have had for years. When an organization installs AD\nCS, by default, AD enables certificate-based authentication. To authenticate using a certificate, a\nCA must issue an account a certificate containing an EKU OID that allows domain authentication\n(e.g., Client Authentication). When an account uses the certificate to authenticate, AD verifies\nthat the certificate chains to a root CA and to a CA certificate specified by the NTAuthCertificates\nobject.\n\nA CA uses its private key to sign issued certificates. If we stole this private key, could we forge our\nown certificates and use them (without a smart card) to authenticate to AD as anyone in the\norganization?\n\n\n**_Figure 65 - Obligatory Meme_**\n\nWith the focus on ADFS attacks and SAML forgery that has resurfaced with the Solarwinds\nincident, we revisited an old pipe dream we have had for years. When an organization installs AD\nCS, by default, AD enables certificate-based authentication. To authenticate using a certificate, a\nCA must issue an account a certificate containing an EKU OID that allows domain authentication\n(e.g., Client Authentication). When an account uses the certificate to authenticate, AD verifies\n\n\n-----\n\nSpoiler: yes. And this has already been possible with Mimikatz/Kekeo for years:\n\n_[https://twitter.com/gentilkiwi/status/1117124090631008256](https://twitter.com/gentilkiwi/status/1117124090631008256)_\n\nI guess we should call these golden certificates?\n\nWe’ll cover the general approach and Mimikatz weaponization before covering the updated and\nstreamlined process with SharpDPAPI/ForgeCert/Rubeus that we developed.\n\n#### Forging Certificates with Stolen CA Certificates - DPERSIST1\n\nAn Enterprise CA has a certificate and associated private key that exist on the CA server itself.\nAlso remember that in large organizations, Enterprise CAs are often separate servers from\ndomain controllers, and often (to some peoples’ surprise) not protected as Tier 0 assets. How\ncan you tell which cert is the CA cert? Well, it will have a few characteristics:\n\n - As mentioned, the certificate exists on the CA server itself, with its private key protected\nby machine DPAPI (unless the OS uses a TPM/HSM/other hardware for protection).\n\n - The Issuer and Subject for the cert are both set to the distinguished name of the CA.\n\n\n_[https://twitter.com/gentilkiwi/status/1117124090631008256](https://twitter.com/gentilkiwi/status/1117124090631008256)_\n\nI guess we should call these golden certificates?\n\nWe’ll cover the general approach and Mimikatz weaponization before covering the updated and\nstreamlined process with SharpDPAPI/ForgeCert/Rubeus that we developed.\n\n#### Forging Certificates with Stolen CA Certificates - DPERSIST1\n\nAn Enterprise CA has a certificate and associated private key that exist on the CA server itself.\nAlso remember that in large organizations, Enterprise CAs are often separate servers from\ndomain controllers, and often (to some peoples’ surprise) not protected as Tier 0 assets. How\n\n\n-----\n\n - CA certificates (and only CA certs) have a “CA Version” extension.\n\n - There are no EKUs.\n\nIn a test lab, this is what the above looks like with Seatbelt, assuming elevation against the remote\nCA server:\n\n**_Figure 66 - Enumerating CA Certificate with Seatbelt_**\n\nThe built-in supported way to extract this certificate private key is with certsrv.msc on the CA\nserver:\n\n\n**_Figure 66 - Enumerating CA Certificate with Seatbelt_**\n\nThe built-in supported way to extract this certificate private key is with certsrv.msc on the CA\nserver:\n\n\n-----\n\n**_Figure 67 - Stealing CA Certificate Using certsrv.msc’s Backup Functionality_**\n\n\n**_Figure 68 – Specifying the Location of the Backup in certsrv.msc_**\n\nThere are other ways to extract the private key besides through a CA back up. The certificate and\nprivate key are not any different crypto-wise from other machine certificates, so if we get\nelevated code execution on the CA server, we can steal them like we did other machine\ncerts/keys (again, assuming the private key is not hardware protected). One can do this using the\n\n\n-----\n\nMimikatz syntax mentioned the “User Certificate Theft via DPAPI – THEFT2” section of this paper,\nor with SharpDPAPI using the command `SharpDPAPI.exe certificates /machine (as`\npreviously shown as well):\n\n**_Figure 69 - Stealing a CA Certificate and Private Key with SharpDPAPI_**\n\nAnd as before, we can then transform this .pem text into a usable .pfx with openssl as we’ve\ndone previously (openssl pkcs12 -in ca.pem -keyex -CSP \"Microsoft Enhanced\n```\nCryptographic Provider v1.0\" -export -out ca.pfx). \n\n```\n**Sidenote: Enter a secure password here, you don’t want to leave a CA certificate lying**\naround unprotected.\n\nWith a CA .pfx file containing the CA certificate and private key, one method to forge certificates\nwould be to import it into a separate offline CA and use Mimikatz’ crypto::scauth function\nto generate and sign a certificate[123]. Alternatively, one could generate the certificate manually\nto ensure granular control over each field and to remove the need to set up a separate system.\nWe took the latter approach and implemented this capability in a tool called ForgeCert[124], a C#\ntool that takes CA root certificate and forges a new certificate for any user we specify. The\nresulting .pfx can be used as previously described to authenticate via SChannel or using Rubeus\nto get a TGT for the forged user:\n\n[123 https://twitter.com/gentilkiwi/status/1117124086604488709](https://twitter.com/gentilkiwi/status/1117124086604488709)\n\n[124 https://github.com/GhostPack/ForgeCert](https://github.com/GhostPack/ForgeCert)\n\n\n**_Figure 69 - Stealing a CA Certificate and Private Key with SharpDPAPI_**\n\nAnd as before, we can then transform this .pem text into a usable .pfx with openssl as we’ve\ndone previously (openssl pkcs12 -in ca.pem -keyex -CSP \"Microsoft Enhanced\n```\nCryptographic Provider v1.0\" -export -out ca.pfx). \n\n```\n**Sidenote: Enter a secure password here, you don’t want to leave a CA certificate lying**\naround unprotected.\n\nWith a CA .pfx file containing the CA certificate and private key, one method to forge certificates\nwould be to import it into a separate offline CA and use Mimikatz’ crypto::scauth function\nto generate and sign a certificate[123]. Alternatively, one could generate the certificate manually\nto ensure granular control over each field and to remove the need to set up a separate system.\nWe took the latter approach and implemented this capability in a tool called ForgeCert[124], a C#\ntool that takes CA root certificate and forges a new certificate for any user we specify. The\n\n\n-----\n\n**_Figure 70 - Forging a New User Certificate with a Stolen CA Certificate with Tool ForgeCert_**\n\n**Note: The target user specified when forging the certificate needs to be active/enabled in AD and**\nable to authenticate since an authentication exchange will still occur as this user. Trying to forge\na certificate for the krbtgt account, for example, will not work.\n\nThis forged certificate will be valid until the end date specified (one year for this example) and as\nlong as the root CA certificate is valid (recall that validity for these starts at five years but is often\nextended to 10+ years). This abuse also is not restricted to just regular user accounts - it will work\nfor machine accounts as well. This means that when combined with S4U2Self, an attacker can\nmaintain persistence on any domain machine for as long as the CA certificate is valid:\n\n\n**_Figure 70 - Forging a New User Certificate with a Stolen CA Certificate with Tool ForgeCert_**\n\n**Note: The target user specified when forging the certificate needs to be active/enabled in AD and**\nable to authenticate since an authentication exchange will still occur as this user. Trying to forge\na certificate for the krbtgt account, for example, will not work.\n\nThis forged certificate will be valid until the end date specified (one year for this example) and as\nlong as the root CA certificate is valid (recall that validity for these starts at five years but is often\nextended to 10+ years). This abuse also is not restricted to just regular user accounts - it will work\nfor machine accounts as well. This means that when combined with S4U2Self, an attacker can\nmaintain persistence on any domain machine for as long as the CA certificate is valid:\n\n\n-----\n\n**_Figure 71 - Forging a New Machine Certificate with a Stolen CA Certificate_**\n\nAnother fun (offensive) bonus is that since we are not going through the normal issuance process,\nthis forged certificate cannot be revoked because the CA is not aware of its existence (so CRLs do\nnot come into play)!\n\n_[https://twitter.com/gentilkiwi/status/1154685386968506368](https://twitter.com/gentilkiwi/status/1154685386968506368)_\n\nForgeCert will be released along with Certify, approximately 45 days after this paper is published.\n\n\n**_Figure 71 - Forging a New Machine Certificate with a Stolen CA Certificate_**\n\nAnother fun (offensive) bonus is that since we are not going through the normal issuance process,\nthis forged certificate cannot be revoked because the CA is not aware of its existence (so CRLs do\nnot come into play)!\n\n\n-----\n\n**Defensive IDs:**\n\n  - Treat CAs as Tier 0 Assets - PREVENT1\n\n  - Monitor Certificate Authority Backup Events - DETECT3\n\n  - Detecting Reading of DPAPI-Encrypted Keys - DETECT5\n\n#### Trusting Rogue CA Certificates - DPERSIST2\n\nRecall the `NTAuthCertificates object covered in the “Kerberos Authentication and the`\n_NTAuthCertificates Container” section. This object defines one or more CA certificates in its_\n```\ncacertificate attribute and AD uses it during authentication. As detailed by Microsoft[125],\n\n```\nduring authentication, the domain controller checks if NTAuthCertificates object contains\nan entry for the CA specified in the authenticating certificate’s Issuer field. If it is, authentication\nproceeds. If the certificate is not in the NTAuthCertificates object, authentication fails.\n\nAn alternative path to forgery is to generate a self-signed CA certificate and add it to the\n```\nNTAuthCertificates object. Attackers can do this if they have control over the\nNTAuthCertificates AD object (in default configurations only Enterprise Admin group\n\n```\nmembers and members of the Domain Admins or Administrators in the forest root’s domain have\nthese permissions). With the elevated access, one can edit the NTAuthCertificates object\nfrom any system with certutil.exe -dspublish -f C:\\Temp\\CERT.crt NTAuthCA[126],\nor using the PKI Health Tool[127]. The specified certificate should work with the previously detailed\nforgery method with ForgeCert to generate certificates on demand.\n\nDuring our testing, we also had to add the certificate to the RootCA directory services store with\ncertutil.exe as well and were then able to get forged certificates working over SChannel.\nHowever, we were unable to get these forged certificates working for PKINIT.\n\nRegardless, it is usually preferable for an attacker to steal the existing CA certificate instead of\ninstalling an additional rogue CA certificate[128].\n\n**Defensive IDs:**\n\n  - Treat CAs as Tier 0 Assets - PREVENT1\n\n  - Audit NTAuthCertificates - PREVENT5\n\n[125 https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/import-third-party-ca-to-enterprise-ntauth-store](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/import-third-party-ca-to-enterprise-ntauth-store)\n\n[126 https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/import-third-party-ca-to-enterprise-ntauth-store#method-2---import-a-certificate-by-using-certutilexe](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/import-third-party-ca-to-enterprise-ntauth-store#method-2---import-a-certificate-by-using-certutilexe)\n\n[127 https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/import-third-party-ca-to-enterprise-ntauth-store#method-1---import-a-certificate-by-using-the-pki-health-tool](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/import-third-party-ca-to-enterprise-ntauth-store#method-1---import-a-certificate-by-using-the-pki-health-tool)\n\n[128 https://twitter.com/gentilkiwi/status/826943014023073792](https://twitter.com/gentilkiwi/status/826943014023073792)\n\n\n\n  - Detecting Reading of DPAPI-Encrypted Keys - DETECT5\n\n#### Trusting Rogue CA Certificates - DPERSIST2\n\nRecall the `NTAuthCertificates object covered in the “Kerberos Authentication and the`\n_NTAuthCertificates Container” section. This object defines one or more CA certificates in its_\n```\ncacertificate attribute and AD uses it during authentication. As detailed by Microsoft[125]\n\n```\nduring authentication, the domain controller checks if NTAuthCertificates object contains\nan entry for the CA specified in the authenticating certificate’s Issuer field. If it is, authentication\nproceeds. If the certificate is not in the NTAuthCertificates object, authentication fails.\n\nAn alternative path to forgery is to generate a self-signed CA certificate and add it to the\n```\nNTAuthCertificates object. Attackers can do this if they have control over the\nNTAuthCertificates AD object (in default configurations only Enterprise Admin group\n\n```\nmembers and members of the Domain Admins or Administrators in the forest root’s domain have\nthese permissions). With the elevated access, one can edit the NTAuthCertificates object\nfrom any system with certutil.exe -dspublish -f C:\\Temp\\CERT.crt NTAuthCA[126]\nor using the PKI Health Tool[127]. The specified certificate should work with the previously detailed\nforgery method with ForgeCert to generate certificates on demand.\n\nDuring our testing, we also had to add the certificate to the RootCA directory services store with\ncertutil.exe as well and were then able to get forged certificates working over SChannel.\nHowever, we were unable to get these forged certificates working for PKINIT.\n\nRegardless, it is usually preferable for an attacker to steal the existing CA certificate instead of\ninstalling an additional rogue CA certificate[128].\n\n**Defensive IDs:**\n\n\n-----\n\n#### Malicious Misconfiguration - DPERSIST3\n\nThe authors have done previous research on permission-based domain and host persistence,\nculminating in the “An ACE Up the Sleeve[129]” whitepaper and “An ACE in the Hole: Stealthy Host\n_Persistence via Security Descriptors[130]” conference talk. In these, we cover AD access control in_\ndepth, and describe how an attacker can make a malicious modification to an AD object or hostbased security descriptor as a subtle domain persistence method.\n\nThere is a myriad of opportunities for persistence via security descriptor modifications of AD CS\ncomponents. Any scenario described in the **“Domain Escalation”** section could be maliciously\nimplemented by an attacker with elevated access, as well as addition of “control rights'' (i.e.,\nWriteOwner/WriteDACL/etc.) to sensitive components. This includes:\n\n - CA server’s AD computer object\n\n - The CA server’s RPC/DCOM server\n\n - Any descendant AD object or container in the container `CN=Public Key`\n\n`Services,CN=Services,CN=Configuration,DC=<COMPANY>,DC=<COM>` (e.g.,\nthe Certificate Templates container, Certification Authorities container, the\nNTAuthCertificates object, etc.)\n\n - AD groups delegated rights to control AD CS by default or by the current organization\n(e.g., the built-in Cert Publishers group and any of its members)\n\nFor example, an attacker with elevated permissions in the domain could add the WriteOwner\npermission to the default User certificate template, where the attacker is the principal for the\nright. To abuse this at a later point, the attacker would first modify the ownership of the User\ntemplate to themselves, and then would set `mspki-certificate-name-flag` to `1 on the`\ntemplate to enable ENROLLEE_SUPPLIES_SUBJECT (i.e., allowing a user to supply a Subject\nAlternative Name in the request). The attacker could then enroll in the template, specifying a\ndomain administrator name as an alternative name, and use the resulting certificate for\nauthentication as the DA.\n\nThe possibilities for creative access-control-based persistence in AD CS are extensive and are\ncompounded by the fact that organizations do not currently have an effective way to audit\npermissions associated with certificate services. Once the BloodHound project integrates nodes\nand edges for AD CS defensive ACL-based auditing should be easier for most organizations.\n\n[129 https://specterops.io/assets/resources/an_ace_up_the_sleeve.pdf](https://specterops.io/assets/resources/an_ace_up_the_sleeve.pdf)\n\n[130 https://www.slideshare.net/harmj0y/an-ace-in-the-hole-stealthy-host-persistence-via-security-descriptors](https://www.slideshare.net/harmj0y/an-ace-in-the-hole-stealthy-host-persistence-via-security-descriptors)\n\n\n_Persistence via Security Descriptors[130]” conference talk. In these, we cover AD access control in_\ndepth, and describe how an attacker can make a malicious modification to an AD object or host-\nbased security descriptor as a subtle domain persistence method.\n\nThere is a myriad of opportunities for persistence via security descriptor modifications of AD CS\ncomponents. Any scenario described in the **“Domain Escalation”** section could be maliciously\nimplemented by an attacker with elevated access, as well as addition of “control rights'' (i.e.,\nWriteOwner/WriteDACL/etc.) to sensitive components. This includes:\n\n - CA server’s AD computer object\n\n - The CA server’s RPC/DCOM server\n\n - Any descendant AD object or container in the container `CN=Public Key`\n\n`Services,CN=Services,CN=Configuration,DC=<COMPANY>,DC=<COM>` (e.g.,\nthe Certificate Templates container, Certification Authorities container, the\nNTAuthCertificates object, etc.)\n\n - AD groups delegated rights to control AD CS by default or by the current organization\n(e.g., the built-in Cert Publishers group and any of its members)\n\nFor example, an attacker with elevated permissions in the domain could add the WriteOwner\npermission to the default User certificate template, where the attacker is the principal for the\nright. To abuse this at a later point, the attacker would first modify the ownership of the User\ntemplate to themselves, and then would set `mspki-certificate-name-flag` to `1 on the`\ntemplate to enable ENROLLEE_SUPPLIES_SUBJECT (i.e., allowing a user to supply a Subject\nAlternative Name in the request). The attacker could then enroll in the template, specifying a\ndomain administrator name as an alternative name, and use the resulting certificate for\nauthentication as the DA.\n\nThe possibilities for creative access-control-based persistence in AD CS are extensive and are\n\n\n-----\n\n**Defensive IDs:**\n\n  - Monitor Certificate Template Modifications - DETECT4\n\n\n-----\n\n## PKI Architecture Flaws\n\n### Lack of Offline Root CA and Tiered Architecture\n\nWe admittedly are not enterprise AD/PKI architects - for more complete recommendations we\nsuggest reading Microsoft’s “Securing PKI: Planning a CA Hierarchy” document, the multi-part\nguide from Ned Pyle at Microsoft titled “Designing and Implementing a PKI[131], or Brian Komar’s\nbook “Windows Server® 2008 PKI and Certificate Security[132]” which has sections dedicated to\ndesigning and implementing proper PKI hierarchies. We will comment on a few key points here.\n\nThroughout this paper, we have shown that an AD CS root Certificate Authority is extremely\nsensitive, and organizations should protect it as much as possible. However, many organizations\nhave single-tiered CA architectures, which introduces inherent risk due to the extreme sensitivity\nof a root CA. According to Microsoft’s Securing PKI: Planning a CA Hierarchy[133] document:\n\n_“This one-tier hierarchy is not recommended for any production scenario_\n_because with this hierarchy, a compromise of this single CA equates to a_\n_compromise of the entire PKI.”_\n\nA more complex CA architecture means that subordinate CA certificates can be revoked without\nhaving to revoke and burn down the root CA.\n\nMost recommendations we have found state that a two-tier CA hierarchy, with a root CA and\none or more “issuing” subordinate CAs, is sufficient for most organizations. Clients should not be\n_receiving certificates directly from root CAs! Most documentation recommends that the root CA_\nfor an organization be kept offline[134], where the root CA server is not connected to the company’s\nnetwork and is often air gapped from all networks in a controlled area. This minimizes the risk of\nattacker’s compromising the private key which, if it occurs, means an organization needs to\nrevoke every certificate ever issued (basically a rebuilding of the PKI infrastructure). Here is\nMicrosoft’s example of such an architecture[135]:\n\n[131 https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/designing-and-implementing-a-pki-part-i-design-and-planning/ba-p/396953](https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/designing-and-implementing-a-pki-part-i-design-and-planning/ba-p/396953)\n\n[132 https://www.oreilly.com/library/view/windows-server-2008/9780735625167/](https://www.oreilly.com/library/view/windows-server-2008/9780735625167/)\n\n[133 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786436(v=ws.11)](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786436(v=ws.11))\n\n[134 https://social.technet.microsoft.com/wiki/contents/articles/2900.offline-root-certification-authority-ca.aspx](https://social.technet.microsoft.com/wiki/contents/articles/2900.offline-root-certification-authority-ca.aspx)\n\n[135 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786436(v=ws.11)](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786436(v=ws.11))\n\n\n### Lack of Offline Root CA and Tiered Architecture\n\nWe admittedly are not enterprise AD/PKI architects - for more complete recommendations we\nsuggest reading Microsoft’s “Securing PKI: Planning a CA Hierarchy” document, the multi-part\nguide from Ned Pyle at Microsoft titled “Designing and Implementing a PKI[131], or Brian Komar’s\nbook “Windows Server® 2008 PKI and Certificate Security[132]” which has sections dedicated to\ndesigning and implementing proper PKI hierarchies. We will comment on a few key points here.\n\nThroughout this paper, we have shown that an AD CS root Certificate Authority is extremely\nsensitive, and organizations should protect it as much as possible. However, many organizations\nhave single-tiered CA architectures, which introduces inherent risk due to the extreme sensitivity\nof a root CA. According to Microsoft’s Securing PKI: Planning a CA Hierarchy[133] document:\n\n_“This one-tier hierarchy is not recommended for any production scenario_\n_because with this hierarchy, a compromise of this single CA equates to a_\n_compromise of the entire PKI.”_\n\nA more complex CA architecture means that subordinate CA certificates can be revoked without\nhaving to revoke and burn down the root CA.\n\nMost recommendations we have found state that a two-tier CA hierarchy, with a root CA and\none or more “issuing” subordinate CAs, is sufficient for most organizations. Clients should not be\n_receiving certificates directly from root CAs! Most documentation recommends that the root CA_\nfor an organization be kept offline[134], where the root CA server is not connected to the company’s\nnetwork and is often air gapped from all networks in a controlled area. This minimizes the risk of\nattacker’s compromising the private key which, if it occurs, means an organization needs to\nrevoke every certificate ever issued (basically a rebuilding of the PKI infrastructure). Here is\nMicrosoft’s example of such an architecture[135]:\n\n\n-----\n\nHowever, organizations must closely protect subordinate CAs as described in the next section.\n\n### Unprotected Subordinate CAs\n\nCAs that are not root CAs are known as subordinate[136] CAs. In AD CS, subordinate CAs enroll by\ndefault in a template named SubCA (display name: “Subordinate Certification Authority”). The\ndefining characteristic of this template is that it has no EKUs, indicating that it is a subordinate\nCA. The default validity period of this template is 5 years, the same as a root CA certificate. The\nroot CA signs the subordinate CA certificate, and then AD CS adds the subordinate CA to the\nNTAuthCertificates and configures it as an Enterprise CA for the Forest. Recall that AD uses CA\ncertificates defined in the NTAuthCertificates AD object’s cacertificate attribute to validate\nsmart card/Kerberos PKINIT authentication. As such, a subordinate CA can sign certificates that\nallow for domain authentication.\n\nTranslation? Certificates issued by subordinate CAs - assuming the issued certificate has an EKU\nallowing for domain authentication – can authenticate users to AD. Therefore, AD privilege\nescalation is possible if a low privileged attacker can enroll in the SubCA template or any other\ntemplate that does not define EKUs (as outlined in the Misconfigured Certificate Templates - ESC2\nsection). Similarly, if the subordinate CA publishes misconfigured certificate templates, AD\ncompromise is possible using the aforementioned escalation techniques.\n\nBeyond that, an attacker can use subordinate CA private keys to forge working domain\nauthentication certificates if a CRL is specified in the forged certificate. This is because during\ncertificate validation, AD CS performs revocation checks against every certificate in the chain\nbelow the root CA.\n\n[136 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831574(v=ws.11)#subordinate-cas](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831574(v=ws.11)#subordinate-cas)\n\n\n**_Figure 72 - Microsoft’s Example Two-Tier CA Architecture_**\n\nHowever, organizations must closely protect subordinate CAs as described in the next section.\n\n### Unprotected Subordinate CAs\n\nCAs that are not root CAs are known as subordinate[136] CAs. In AD CS, subordinate CAs enroll by\ndefault in a template named SubCA (display name: “Subordinate Certification Authority”). The\ndefining characteristic of this template is that it has no EKUs, indicating that it is a subordinate\nCA. The default validity period of this template is 5 years, the same as a root CA certificate. The\nroot CA signs the subordinate CA certificate, and then AD CS adds the subordinate CA to the\nNTAuthCertificates and configures it as an Enterprise CA for the Forest. Recall that AD uses CA\ncertificates defined in the NTAuthCertificates AD object’s cacertificate attribute to validate\nsmart card/Kerberos PKINIT authentication. As such, a subordinate CA can sign certificates that\nallow for domain authentication.\n\nTranslation? Certificates issued by subordinate CAs - assuming the issued certificate has an EKU\nallowing for domain authentication – can authenticate users to AD. Therefore, AD privilege\nescalation is possible if a low privileged attacker can enroll in the SubCA template or any other\ntemplate that does not define EKUs (as outlined in the Misconfigured Certificate Templates - ESC2\nsection). Similarly, if the subordinate CA publishes misconfigured certificate templates, AD\ncompromise is possible using the aforementioned escalation techniques.\n\nBeyond that, an attacker can use subordinate CA private keys to forge working domain\n\n\n-----\n\nTaken all together, this means that organizations should treat subordinate CAs as Tier 0 assets\njust like root CAs. Unfortunately, many third-party vendors - particularly network appliances that\nperform HTTPS interception - advocate for a subordinate CA certificate for the border device to\n“work properly”. Their documentation actively promotes this: ZScaler[137], Palo Alto[138], Fortinet[139],\nSonicWall[140], Digital Scepter[141], Forcepoint[142], and more. This introduces potential leakages of a\nsubordinate CA certificate and means that these devices now must be considered Tier0 assets as\nwell.\n\nThere is a better way. Organizations can setup CA constraints[143], restrictions that constrain the\ntypes of certificates that a subordinate CA can issue. The Microsoft post “HTTPS Inspection and\n_your PKI”[ 144] recommends this approach. Microsoft also states:_\n\n_“A typical subordinate CA can issue an end entity certificate for “ANY” purpose._\n_Applying Application Policy allows restriction on the Enhanced Key Usage for_\n_certificates issued by a subordinate.”[145]_\n\nKeyfactor also has a great post titled “Restricting SSL Intercept and Proxy Sub CA Certificates”[ 146]\nwhich describes why, and how, to implement this type of restriction, concluding with the\nfollowing:\n\n_“If you need a Sub CA certificate for an SSL Intercept or Proxy application,_\n_consider resigning the CSR to apply policy, a path length restriction, and an EKU_\n_restriction to prevent the application from generating certificates with usages_\n_beyond what is necessary. “_\n\n### Breaking Forest Trusts via AD CS\n\nWe have done a fair amount of security research on AD domain trusts[147], including receiving a\nCVE for our work on breaking the forest trust boundary[148]. AD CS introduces a set of\n\n[137 https://help.zscaler.com/zia/signing-csr-using-active-directory-certificate-services](https://help.zscaler.com/zia/signing-csr-using-active-directory-certificate-services)\n\n[138 https://knowledgebase.paloaltonetworks.com/KCSArticleDetail?id=kA10g000000ClWOCA0](https://knowledgebase.paloaltonetworks.com/KCSArticleDetail?id=kA10g000000ClWOCA0)\n\n[139 https://docs.fortinet.com/document/fortigate/6.2.0/cookbook/680736/microsoft-ca-deep-packet-inspection#Create](https://docs.fortinet.com/document/fortigate/6.2.0/cookbook/680736/microsoft-ca-deep-packet-inspection#Create)\n\n[140 https://www.sonicwall.com/support/knowledge-base/how-can-i-create-a-dpi-ssl-certificate-for-the-purpose-of-dpi-ssl-certificate-resigning/170503514073825/](https://www.sonicwall.com/support/knowledge-base/how-can-i-create-a-dpi-ssl-certificate-for-the-purpose-of-dpi-ssl-certificate-resigning/170503514073825/)\n\n[141 https://digitalscepter.com/blog/entry/ssl-decryption-implementation](https://digitalscepter.com/blog/entry/ssl-decryption-implementation)\n\n[142 https://support.forcepoint.com/KBArticle?id=How-to-Create-a-Subordinate-Certificate-Authority](https://support.forcepoint.com/KBArticle?id=How-to-Create-a-Subordinate-Certificate-Authority)\n\n143 https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/constraints-what-they-are-and-how-they-amp-8217-re-used/ba-p/1129048\n\n[144 https://docs.microsoft.com/en-us/archive/blogs/crypto/https-inspection-and-your-pki-2](https://docs.microsoft.com/en-us/archive/blogs/crypto/https-inspection-and-your-pki-2)\n\n[145 https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/constraints-what-they-are-and-how-they-amp-8217-re-used/ba-p/1129048](https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/constraints-what-they-are-and-how-they-amp-8217-re-used/ba-p/1129048)\n\n[146 https://blog.keyfactor.com/restricting-ssl-intercept-and-proxy-sub-ca-certificates](https://blog.keyfactor.com/restricting-ssl-intercept-and-proxy-sub-ca-certificates)\n\n[147 https://medium.com/@harmj0y/a-guide-to-attacking-domain-trusts-ef5f8992bb9d](https://medium.com/@harmj0y/a-guide-to-attacking-domain-trusts-ef5f8992bb9d)\n\n[148 https://posts.specterops.io/not-a-security-boundary-breaking-forest-trusts-cd125829518d](https://posts.specterops.io/not-a-security-boundary-breaking-forest-trusts-cd125829518d)\n\n\njust like root CAs. Unfortunately, many third-party vendors - particularly network appliances that\nperform HTTPS interception - advocate for a subordinate CA certificate for the border device to\n“work properly”. Their documentation actively promotes this: ZScaler[137], Palo Alto[138], Fortinet[139]\nSonicWall[140], Digital Scepter[141], Forcepoint[142], and more. This introduces potential leakages of a\nsubordinate CA certificate and means that these devices now must be considered Tier0 assets as\nwell.\n\nThere is a better way. Organizations can setup CA constraints[143], restrictions that constrain the\ntypes of certificates that a subordinate CA can issue. The Microsoft post “HTTPS Inspection and\n_your PKI”[ 144] recommends this approach. Microsoft also states:_\n\n_“A typical subordinate CA can issue an end entity certificate for “ANY” purpose._\n_Applying Application Policy allows restriction on the Enhanced Key Usage for_\n_certificates issued by a subordinate.”[145]_\n\nKeyfactor also has a great post titled “Restricting SSL Intercept and Proxy Sub CA Certificates”[ 146]\nwhich describes why, and how, to implement this type of restriction, concluding with the\nfollowing:\n\n_“If you need a Sub CA certificate for an SSL Intercept or Proxy application,_\n_consider resigning the CSR to apply policy, a path length restriction, and an EKU_\n_restriction to prevent the application from generating certificates with usages_\n_beyond what is necessary. “_\n\n### Breaking Forest Trusts via AD CS\n\nWe have done a fair amount of security research on AD domain trusts[147], including receiving a\nCVE for our work on breaking the forest trust boundary[148]. AD CS introduces a set of\n\n\n-----\n\nmisconfiguration opportunities and architectural designs that can compromise the security\nboundary of an AD forest.\n\n#### CAs Trusts Breaking Forest Trusts\n\nThe Microsoft documentation “AD CS: Cross-forest Certificate Enrollment with Windows Server\n_2008 R2”[149]_ details how to set up a PKI infrastructure that allows _“...enterprises to deploy a_\n_central PKI in one Active Directory Domain Services (AD DS) forest that issues certificates to_\n_domain members in other forests.” As professionals who have assessed the security of countless_\nAD environments over the past several years, this concept causes us a lot of concern.\n\nMicrosoft defines AD forests as security boundaries[150], meaning that principals external to the\nforest should not be able take control away from administrators within the forest. Organizations\nusing a CA architecture that intentionally bridges this security boundary should do so with a huge\namount of care to prevent cross-forest compromise.\n\nMicrosoft’s implementation documentation[151] recommends setting up a resource forest with one\ncentralized AD CS instance that serves additional other account forests, providing these forests\nwith enrollment services. This is architecturally similar to the Enhanced Security Admin\nEnvironment (ESAE, a.k.a. “red forest”) secured forest architecture, where one secured forest\nhandles various security administration tasks for other forests, though a two-way forest trust is\nrecommended here in the AD CS scenario instead of one-way trusts. Of note, EASE has now been\nretired[152] in preference for cloud-based solutions, but retired recommendations do not mean\nthese architectures do not still exist.\n\nThe setup for cross-forest enrollment is relatively simple. Administrators publish the root CA\ncertificate from the resource forest to the account forests and add the enterprise CA certificates\nfrom the resource forest to the NTAuthCertificates and AIA containers in each account forest[153].\nTo be clear, this means that the CA in the resource forest has complete control over all other\nforests it manages PKI for. If attackers compromise this CA, they can forge certificates for all users\nin the resource and account forests, breaking the forest security boundary.\n\n[149 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff955842(v=ws.10)](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff955842(v=ws.10))\n\n[150 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759073(v=ws.10)#forests-as-security-boundaries](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759073(v=ws.10)#forests-as-security-boundaries)\n\n[151 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/ff955845(v=ws.10)](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/ff955845(v=ws.10))\n\n[152 https://docs.microsoft.com/en-us/security/compass/esae-retirement#why-change-the-recommendation](https://docs.microsoft.com/en-us/security/compass/esae-retirement#why-change-the-recommendation)\n\n[153 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/ff955845(v=ws.10)#deploying-ad-cs-for-cross-forest-certificate-enrollment](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/ff955845(v=ws.10)#deploying-ad-cs-for-cross-forest-certificate-enrollment)\n\n\n#### CAs Trusts Breaking Forest Trusts\n\nThe Microsoft documentation “AD CS: Cross-forest Certificate Enrollment with Windows Server\n_2008 R2”[149]_ details how to set up a PKI infrastructure that allows _“...enterprises to deploy a_\n_central PKI in one Active Directory Domain Services (AD DS) forest that issues certificates to_\n_domain members in other forests.” As professionals who have assessed the security of countless_\nAD environments over the past several years, this concept causes us a lot of concern.\n\nMicrosoft defines AD forests as security boundaries[150], meaning that principals external to the\nforest should not be able take control away from administrators within the forest. Organizations\nusing a CA architecture that intentionally bridges this security boundary should do so with a huge\namount of care to prevent cross-forest compromise.\n\nMicrosoft’s implementation documentation[151] recommends setting up a resource forest with one\ncentralized AD CS instance that serves additional other account forests, providing these forests\nwith enrollment services. This is architecturally similar to the Enhanced Security Admin\nEnvironment (ESAE, a.k.a. “red forest”) secured forest architecture, where one secured forest\nhandles various security administration tasks for other forests, though a two-way forest trust is\nrecommended here in the AD CS scenario instead of one-way trusts. Of note, EASE has now been\nretired[152] in preference for cloud-based solutions, but retired recommendations do not mean\nthese architectures do not still exist.\n\nThe setup for cross-forest enrollment is relatively simple. Administrators publish the root CA\ncertificate from the resource forest to the account forests and add the enterprise CA certificates\nfrom the resource forest to the NTAuthCertificates and AIA containers in each account forest[153]\nTo be clear, this means that the CA in the resource forest has complete control over all other\nforests it manages PKI for. If attackers compromise this CA, they can forge certificates for all users\nin the resource and account forests, breaking the forest security boundary.\n\n\n-----\n\n#### Foreign Principals With Enrollment Privileges\n\nAnother thing organizations need to be careful of in multi-forest environments is Enterprise CAs\npublishing certificates templates that grant _Authenticated Users or foreign principals_\n(users/groups external to the forest the Enterprise CA belongs to) enrollment and edit rights.\nWhen an account authenticates across a trust, AD adds the _Authenticated Users SID to the_\nauthenticating user’s token [154]. Therefore, if a domain has an Enterprise CA with a template that\ngrants Authenticated Users enrollment rights, a user in different forest could potentially enroll in\nthe template. Similarly, if a template explicitly grants a foreign principal enrollment rights, then\na cross-forest access-control relationship gets created, permitting a principal in one forest to\nenroll in a template in another forest. Ultimately both these scenarios increase the attack surface\nfrom one forest to another. Depending on the certificate template settings, an attacker could\nabuse this to gain additional privileges in a foreign domain.\n\n[154https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/dd560679(v=ws.10)#the-problem-of-authenticating-users-from-a-trusted-forest](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/dd560679(v=ws.10)#the-problem-of-authenticating-users-from-a-trusted-forest)\n\n\n(users/groups external to the forest the Enterprise CA belongs to) enrollment and edit rights.\nWhen an account authenticates across a trust, AD adds the _Authenticated Users SID to the_\nauthenticating user’s token [154]. Therefore, if a domain has an Enterprise CA with a template that\ngrants Authenticated Users enrollment rights, a user in different forest could potentially enroll in\nthe template. Similarly, if a template explicitly grants a foreign principal enrollment rights, then\na cross-forest access-control relationship gets created, permitting a principal in one forest to\nenroll in a template in another forest. Ultimately both these scenarios increase the attack surface\nfrom one forest to another. Depending on the certificate template settings, an attacker could\nabuse this to gain additional privileges in a foreign domain.\n\n\n-----\n\n## Defensive Guidance\n\nWe have covered a lot of ground on the offensive side. We are going to do our best to cover\ndefensive advice we know of, starting with preventative guidance and then moving into detective\nmeasures and incident response recommendations.\n\nAt a high level, security and IT infrastructure teams should work together to build prevention,\ndetection, and response playbooks around AD CS, ideally before setting up AD CS and integrating\nit into an AD environment. We have found that there is a general lack of knowledge surrounding\nthe security implications of AD CS, and many teams would not know how to properly respond to\ncompromises involving AD CS. We recommend planning and performing active response\nexercises for as many of the compromises as possible that have been detailed in this paper and\nconsider detailed table-top exercises for response actions that would likely disrupt business\noperations (like rotating a root CA’s private key).\n\nAs previously mentioned, we have broken out each preventative and detective action with IDs\nlike the attack technique breakouts. At the end of each section describing a defensive action, the\nassociated attack IDs are listed, just like the defensive IDs being listed at the end of attack\ndescription sections. We have broadly grouped the recommendations into preventative actions\n(PREVENT#) and detective actions (DETECT#).\n\nWe also highly recommend the book “Windows Server 2008 - PKI and Certificate Security[155]” for\nunderstanding, architecting, and securing Windows PKI systems.\n\n### Preventive Guidance\n\nFor general preventative advice from Microsoft, see their “AD CS Security Guidance”[156] and the\n“Securing PKI: Technical Controls for Securing PKI”[157] documents, and the “Windows Server 2008\n_PKI and Certificate Security[158]” book for more complete guidance._\n\n#### Treat CAs as Tier 0 Assets - PREVENT1\n\nOrganizations should treat CA servers as a Tier 0 assets, securing it just as they would a domain\ncontroller. While many AD architects would think this is obvious, during our assessment of real\n\n[155 https://www.microsoftpressstore.com/store/windows-server-2008-pki-and-certificate-security-9780735640788](https://www.microsoftpressstore.com/store/windows-server-2008-pki-and-certificate-security-9780735640788)\n\n[156 https://social.technet.microsoft.com/wiki/contents/articles/10942.ad-cs-security-guidance.aspx](https://social.technet.microsoft.com/wiki/contents/articles/10942.ad-cs-security-guidance.aspx)\n\n[157 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786426(v=ws.11)](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786426(v=ws.11))\n\n[158 https://www.microsoftpressstore.com/store/windows-server-2008-pki-and-certificate-security-9780735640788](https://www.microsoftpressstore.com/store/windows-server-2008-pki-and-certificate-security-9780735640788)\n\n\ndefensive advice we know of, starting with preventative guidance and then moving into detective\nmeasures and incident response recommendations.\n\nAt a high level, security and IT infrastructure teams should work together to build prevention,\ndetection, and response playbooks around AD CS, ideally before setting up AD CS and integrating\nit into an AD environment. We have found that there is a general lack of knowledge surrounding\nthe security implications of AD CS, and many teams would not know how to properly respond to\ncompromises involving AD CS. We recommend planning and performing active response\nexercises for as many of the compromises as possible that have been detailed in this paper and\nconsider detailed table-top exercises for response actions that would likely disrupt business\noperations (like rotating a root CA’s private key).\n\nAs previously mentioned, we have broken out each preventative and detective action with IDs\nlike the attack technique breakouts. At the end of each section describing a defensive action, the\nassociated attack IDs are listed, just like the defensive IDs being listed at the end of attack\ndescription sections. We have broadly grouped the recommendations into preventative actions\n(PREVENT#) and detective actions (DETECT#).\n\nWe also highly recommend the book “Windows Server 2008 - PKI and Certificate Security[155]” for\nunderstanding, architecting, and securing Windows PKI systems.\n\n### Preventive Guidance\n\nFor general preventative advice from Microsoft, see their “AD CS Security Guidance”[156] and the\n_Securing PKI: Technical Controls for Securing PKI”[157] documents, and the “Windows Server 2008_\n_PKI and Certificate Security[158]” book for more complete guidance._\n\n#### Treat CAs as Tier 0 Assets - PREVENT1\n\n\n-----\n\nnetworks, we have noticed that many organizations do not treat CAs with the same sensitivity\nand they absolutely should be.\n\nThis extends beyond just the root CA. Recall from the Unprotected Subordinate CAs section that\ncertificates issued by subordinate CAs, assuming the issued template allows for domain\nauthentication, can be used to authenticate to the KDC in the domain. So, administrators should\nprotect subordinate CAs as Tier 0 assets, along with any appliance or host possessing a\nsubordinate CA certificate.\n\nMore information on CA architecture is detailed in the “PKI Architecture Flaws” section.\n\nMany of these issues can be identified through either the PSPKIAudit[159] PowerShell toolkit, or\nCertify[160].\n\n**Attack IDs:**\n\n  - Forging Certificates with Stolen CA Certificates - DPERSIST1\n\n  - Trusting Rogue CA Certificates - DPERSIST2\n\n#### Harden CA Settings - PREVENT2\n\nThere are various settings that organizations should audit and harden on the Enterprise CAs.\nThese settings need to be hardened on EVERY CA that is present in an environment for effective\nprevention.\n\nDisable EDITF_ATTRIBUTESUBJECTALTNAME2\n\nTo determine if the EDITF_ATTRIBUTESUBJECTALTNAME2 flag is present in your environment,\nrun any of the following:\n\n`1.` **PSPKIAudit:** `Invoke-PKIAudit`\n`2.` **Certify:** `Certify.exe cas`\n3. **Certutil:** `certutil.exe -config \"CA_HOST\\CA_NAME\" -getreg`\n```\n   \"policy\\EditFlags\"\n\n```\nThis may need to be run from an elevated context if the enumeration fails. If this flag is present\non any CA in your environment, we recommend disabling it as soon as possible. This setting being\n\n[159 https://github.com/GhostPack/PSPKIAudit](https://github.com/GhostPack/PSPKIAudit)\n\n[160 https://github.com/GhostPack/Certify](https://github.com/GhostPack/Certify)\n\n\ncertificates issued by subordinate CAs, assuming the issued template allows for domain\nauthentication, can be used to authenticate to the KDC in the domain. So, administrators should\nprotect subordinate CAs as Tier 0 assets, along with any appliance or host possessing a\nsubordinate CA certificate.\n\nMore information on CA architecture is detailed in the “PKI Architecture Flaws” section.\n\nMany of these issues can be identified through either the PSPKIAudit[159] PowerShell toolkit, or\nCertify[160].\n\n**Attack IDs:**\n\n  - Forging Certificates with Stolen CA Certificates - DPERSIST1\n\n  - Trusting Rogue CA Certificates - DPERSIST2\n\n#### Harden CA Settings - PREVENT2\n\nThere are various settings that organizations should audit and harden on the Enterprise CAs.\nThese settings need to be hardened on EVERY CA that is present in an environment for effective\nprevention.\n\nDisable EDITF_ATTRIBUTESUBJECTALTNAME2\n\nTo determine if the EDITF_ATTRIBUTESUBJECTALTNAME2 flag is present in your environment,\nrun any of the following:\n\n`1.` **PSPKIAudit:** `Invoke-PKIAudit`\n`2.` **Certify:** `Certify.exe cas`\n3. **Certutil:** `certutil.exe -config \"CA_HOST\\CA_NAME\" -getreg`\n\n\n-----\n\npresent means that if there is a domain-authentication-capable certificate template where\napprovals are not enabled, then any user who can enroll in the template can elevate to domain\nadmin privileges. Administrators can disable this setting with the following command:\n```\ncertutil -config \"CA_HOST\\CA_NAME\" -setreg policy\\EditFlags EDITF_ATTRIBUTESUBJECTALTNAME2\n\n```\nIf you must keep this setting enabled in your environment, enable manager approvals for any\ncertificate template that allows for domain authentication:\n\n**_Figure 73 - Constraining Certificate Enrollments with Manager Approvals_**\n\n\nIf you must keep this setting enabled in your environment, enable manager approvals for any\ncertificate template that allows for domain authentication:\n\n\n-----\n\nConstrain Enrollment Agents\n\nIf the environment uses enrollment agents, restrict enrollment agents through the Certificate\nAuthority MMC snap-in (certsrv.msc) by right clicking on the CA → Properties → Enrollment\nAgents. This allows you to restrict which principals can act as enrollment agents, and for which\nusers/templates those agents can enroll on behalf of. For example, to only allow members of the\n_EnrollmentAgents domain group to act as enrollment agents, where those members can only_\nenroll in the User certificate template on behalf of members of the NewEmployees group, the\nconfiguration would be the following:\n\n**_Figure 74 - Restricting Enrollment Agents through certsrv.msc_**\n\n\n_EnrollmentAgents domain group to act as enrollment agents, where those members can only_\nenroll in the User certificate template on behalf of members of the NewEmployees group, the\nconfiguration would be the following:\n\n\n-----\n\nRestrict CA Server Permissions\n\nNetwork defenders should also audit CA servers’ permissions. They can do so by the following\nmeans:\n\n**1.** **PSPKIAudit: Invoke-PKIAudit**\n**2.** **Certify: Certify.exe cas**\n3. **MMC: Administrators can list them manually via the Certificate Authority MMC snap-in**\n\n(certsrv.msc) by right clicking on the CA → Properties → Security. Organizations should\n\nrestrict the “Issue and Manage Certificates” and “Manage CA” permissions to appropriate\nadministrative groups. Attackers can abuse the “Manage CA” right to compromise the\ndomain and can use the “Issue and Manage Certificates” right to subvert approval\nprocesses (see Vulnerable Certificate Authority Access Control - ESC7 for more\ninformation):\n\n**_Figure 75 - Auditing CA Permissions through certsrv.msc_**\n\n\n**2.** **Certify: Certify.exe cas**\n3. **MMC: Administrators can list them manually via the Certificate Authority MMC snap-in**\n\n(certsrv.msc) by right clicking on the CA → Properties → Security. Organizations should\n\nrestrict the “Issue and Manage Certificates” and “Manage CA” permissions to appropriate\nadministrative groups. Attackers can abuse the “Manage CA” right to compromise the\ndomain and can use the “Issue and Manage Certificates” right to subvert approval\nprocesses (see Vulnerable Certificate Authority Access Control - ESC7 for more\ninformation):\n\n\n-----\n\nOptionally, organizations can remove the “Request Certificates” (aka Enroll) permission from\ngroups such as _Domain Users as a preventive measure against some escalation scenarios._\nRemoving enrollment permissions at the CA level will prevent that user/group from enrolling in\nany certificate templates. However, it is generally advised to restrict the enrollment permissions\non the template level.\n\n**Attack IDs:**\n\n  - EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\n  - Vulnerable Certificate Authority Access Control - ESC7\n\n#### Audit Published Templates - PREVENT3\n\nThe “Certificate Enrollment” section mentioned that administrators create templates then\n“publish” them to an Enterprise CA. AD CS specifies that a certificate template is enabled on an\nEnterprise CA by adding the template’s name to the certificatetemplates attribute of the\nEnterprise CA’s AD object. You can enumerate the templates published to a CA through the\nCertificate Authority MMC snap-in (certsrv.msc), expanding a CA and clicking on “Certificate\nTemplates”:\n\n**_Figure 76 - Enumerating Published Certificate Templates for a CA_**\n\nThe following commands can enumerate templates published by an Enterprise CA:\n\n  - **Certify:**\n\n    - `Certify.exe cas - List Enterprise CAs, including published templates:`\n\n    - `Certify.exe find - Show all published templates:`\n\n\n**Attack IDs:**\n\n  - EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\n  - Vulnerable Certificate Authority Access Control - ESC7\n\n#### Audit Published Templates - PREVENT3\n\nThe “Certificate Enrollment” section mentioned that administrators create templates then\n“publish” them to an Enterprise CA. AD CS specifies that a certificate template is enabled on an\nEnterprise CA by adding the template’s name to the certificatetemplates attribute of the\nEnterprise CA’s AD object. You can enumerate the templates published to a CA through the\nCertificate Authority MMC snap-in (certsrv.msc), expanding a CA and clicking on “Certificate\nTemplates”:\n\n**_Figure 76 - Enumerating Published Certificate Templates for a CA_**\n\n\n-----\n\n  - **Certutil: Certutil.exe -TCAInfo [DC=COMPANY,DC=COM]**\n\nAdministrators should remove unused templates from publication on every CA in the\nenvironment to lower the attack surface and opportunities for accidental misconfiguration.\n\n**Attack IDs:**\n\n  - Misconfigured Certificate Templates - ESC1\n\n  - Misconfigured Certificate Templates - ESC2\n\n  - Misconfigured Enrollment Agent Templates - ESC3\n\n  - Vulnerable Certificate Template Access Control - ESC4\n\n  - EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\n  - Vulnerable Certificate Authority Access Control - ESC7\n\n#### Harden Certificate Template Settings - PREVENT4\n\nAs described extensively in the “Domain Escalation” section, there are various combinations of\ncertificate template settings that can result in domain escalation. To audit these settings, run any\nof the following commands and analyze the permissions and configuration of each published\ncertificate template:\n\n  - **PSPKIAudit: Invoke-PKIAudit**\n\n  - **Certify:**\n```\n     o Certify.exe find [/hideAdmins] - Display published templates: \n     o Certify.exe find /vulnerable [/hideAdmins] - Display published\n\n```\ntemplates that potentially could result in domain escalation\n\n  - **Certutil:**\n\n\n\n  - Misconfigured Certificate Templates - ESC1\n\n  - Misconfigured Certificate Templates - ESC2\n\n  - Misconfigured Enrollment Agent Templates - ESC3\n\n  - Vulnerable Certificate Template Access Control - ESC4\n\n  - EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\n  - Vulnerable Certificate Authority Access Control - ESC7\n\n#### Harden Certificate Template Settings - PREVENT4\n\nAs described extensively in the “Domain Escalation” section, there are various combinations of\ncertificate template settings that can result in domain escalation. To audit these settings, run any\nof the following commands and analyze the permissions and configuration of each published\ncertificate template:\n\n  - **PSPKIAudit: Invoke-PKIAudit**\n\n  - **Certify:**\n```\n    o Certify.exe find [/hideAdmins] - Display published templates: \n    o Certify.exe find /vulnerable [/hideAdmins] - Display published\n\n```\ntemplates that potentially could result in domain escalation\n\n  - **Certutil:**\n```\n    o certutil.exe -TCAInfo - Display published templates\n    o certutil.exe -v -dsTemplate - Display template permissions\n\n```\n\n-----\n\n**_Figure 77 – Sample Invoke-PKIAudit Output_**\n\nFor templates that allow SAN specification via the CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT\nflag AND allow for domain authentication, there are a few approaches for mitigation. If the\ntemplate does not actually require SAN specification, the first option is to remove the “Supply in\nRequest” setting under the “Subject Name” settings for any affected template (this will disable\nthe CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag):\n\n\n**_Figure 77 – Sample Invoke-PKIAudit Output_**\n\nFor templates that allow SAN specification via the CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT\nflag AND allow for domain authentication, there are a few approaches for mitigation. If the\ntemplate does not actually require SAN specification, the first option is to remove the “Supply in\nRequest” setting under the “Subject Name” settings for any affected template (this will disable\nthe CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag):\n\n\n-----\n\nAnother option is to enable certificate approvals on the template:\n\n**_Figure 79 - Constraining Certificate Enrollments with Manager Approvals_**\n\nAlso, under “Issuance Requirements”, administrators can configure authorized signatures to\nenact CSR signing restrictions for the template. There is more information on approvals and\nsignatures in the Issuance Requirements section.\n\nIf an organization needs the “Supply in Request” setting enabled, please read Microsoft’s\nguidance on this subject[161] and restrict which users/groups have enrollment privileges to the\ntemplate as much as possible. Administrators can restrict enrollment privileges by modifying the\n\n[161 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786426(v=ws.11)#controlling-user-added-subject-alternative-names](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786426(v=ws.11)#controlling-user-added-subject-alternative-names)\n\n\n**_Figure 78 - Vulnerable “Supply in the request” Subject Name Specification_**\n\nAnother option is to enable certificate approvals on the template:\n\n**_Figure 79 - Constraining Certificate Enrollments with Manager Approvals_**\n\nAlso, under “Issuance Requirements”, administrators can configure authorized signatures to\nenact CSR signing restrictions for the template. There is more information on approvals and\n\n\n-----\n\nsecurity descriptor of the template to only allow carefully controlled groups to enroll,\nremembering that any principal with “Enroll” rights can obtain certificate as any domain user:\n\n**_Figure 80 - Constraining Certificate Enrollments Through Security Descriptor Restrictions_**\n\nWhen auditing template security descriptors, analyze enrollment permissions and the following\nsettings that could grant write access to the template:\n\n  - The owner of the security descriptor\n\n  - FullControl, WriteDacl, WriteOwner, or WriteProperty permissions to the template\n\nWith write access to a template, attackers could reconfigure it to a vulnerable state, hence why\ndefenders should audit those permissions as well.\n\n\n**_Figure 80 - Constraining Certificate Enrollments Through Security Descriptor Restrictions_**\n\nWhen auditing template security descriptors, analyze enrollment permissions and the following\nsettings that could grant write access to the template:\n\n  - The owner of the security descriptor\n\n\n-----\n\nWhen auditing enrollment permissions, for each published template, analyze the EKUs in\n“Enhanced Key Usage” for schema version 1 templates and “Application Policies” for schema\nversion 2 templates. Ensure that the template specifies the minimum number of EKUs necessary\nto function. If a template has “powerful” EKUs - the EKUs are null (i.e., a subordinate CA) or\ncontain All Purpose, Certificate Request Agent, or other sensitive EKUs - restrict the enrollment\nin the certificate to only privileged groups. In addition, review templates with EKUs that enable\ndomain authentication (see the table below) and ensure they are necessary:\n\n|Description|OID|\n|---|---|\n|Client Authentication|1.3.6.1.5.5.7.3.2|\n|PKINIT Client Authentication|1.3.6.1.5.2.3.4|\n|Smart Card Logon|1.3.6.1.4.1.311.20.2.2|\n|Any Purpose|2.5.29.37.0|\n|SubCA|(no EKUs)|\n\n\ndomain authentication (see the table below) and ensure they are necessary:\n\n**Description** **OID**\n\n**Client Authentication** 1.3.6.1.5.5.7.3.2\n\n**PKINIT Client Authentication** 1.3.6.1.5.2.3.4\n\n**Smart Card Logon** 1.3.6.1.4.1.311.20.2.2\n\n**Any Purpose** 2.5.29.37.0\n\n**SubCA** (no EKUs)\n\n\n-----\n\n**Attack IDs:**\n\n  - Misconfigured Certificate Templates - ESC1\n\n  - Misconfigured Certificate Templates - ESC2\n\n  - Misconfigured Enrollment Agent Templates - ESC3\n\n  - Vulnerable Certificate Template Access Control - ESC4\n\n#### Audit NTAuthCertificates - PREVENT5\n\nRecall from the Kerberos Authentication and the NTAuthCertificates Container section that the\nNTAuthCertificates AD object defines CA certificates that enable authentication to AD.\nAdministrators can view these certificates in a variety of ways:\n\n  - **Certify:** `Certify.exe cas`\n\n  - **Certutil: certutil -viewstore**\n```\n   \"ldap:///CN=NtAuthCertificates,CN=Public Key\n\n```\n\n**_Figure 81 - A Template with an EKU that Enables Domain Authentication in the Certificate MMC Snap-in_**\n\n**Attack IDs:**\n\n  - Misconfigured Certificate Templates - ESC1\n\n  - Misconfigured Certificate Templates - ESC2\n\n  - Misconfigured Enrollment Agent Templates - ESC3\n\n  - Vulnerable Certificate Template Access Control - ESC4\n\n#### Audit NTAuthCertificates - PREVENT5\n\nRecall from the Kerberos Authentication and the NTAuthCertificates Container section that the\nNTAuthCertificates AD object defines CA certificates that enable authentication to AD.\nAdministrators can view these certificates in a variety of ways:\n\n\n-----\n\n```\n   Services,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>?cACert\n   ificate?base?objectclass=certificationAuthority\"\n\n```\n  - **MMC: Open pkiview.msc**  Right click on Enterprise CA  Manage AD Containers \nGo to the NTAuthCertificates tab\n\nIf smart card authentication is not in use and the network does not require certificate\nauthentication to AD, consider removing all the certificates from the NTAuthCertificate object.\nThis will prevent authentication to AD using certificates. You can delete certificates from the\nNTAuth store with certutil.exe by running the following from a domain elevated prompt:\n```\ncertutil -viewdelstore \"ldap:///CN=NtAuthCertificates,CN=Public Key\nServices,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>?cACertifica\nte?base?objectclass=certificationAuthority\"\n\n```\n**_Figure 82 - Deleting Certificates from the NTAuth store with certutil.exe_**\n\nAlternatively, administrators can run pkiview.msc  right click on the “Enterprise PKI” node \nselect “Manage AD Containers”  Select a certificate  Click the remove button:\n\n\nauthentication to AD, consider removing all the certificates from the NTAuthCertificate object.\nThis will prevent authentication to AD using certificates. You can delete certificates from the\nNTAuth store with certutil.exe by running the following from a domain elevated prompt:\n```\ncertutil -viewdelstore \"ldap:///CN=NtAuthCertificates,CN=Public Key\nServices,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>?cACertifica\nte?base?objectclass=certificationAuthority\"\n\n```\n**_Figure 82 - Deleting Certificates from the NTAuth store with certutil.exe_**\n\nAlternatively, administrators can run pkiview.msc  right click on the “Enterprise PKI” node \nselect “Manage AD Containers”  Select a certificate  Click the remove button:\n\n\n-----\n\nOrganizations can also enumerate certificates in NTAuth with the PSPKI[162] PowerShell module:\n```\nInstall-Module PSPKI -Scope CurrentUser\nImport-Module PSPKI\nGet-AdPkiContainer -ContainerType NTAuth | Select-Object -Expand\nCertificates | Select-Object -Expand Certificate | select *\n\n```\nPSPKI can remove certificates from the NTAuthCertificates object using its certificate thumbprint:\n```\nGet-AdPkiContainer -ContainerType NTAuth | Remove-AdCertificate Thumbprint \"EC9385E533782453D5C285B2A67311447FB57A6F\" -Dispose\n\n```\n**Attack IDs:**\n\n  - Trusting Rogue CA Certificates - DPERSIST2\n\n[162 https://github.com/PKISolutions/PSPKI](https://github.com/PKISolutions/PSPKI)\n\n\n**_Figure 83 - Viewing Existing Certs in the NTAuth Store with pkiview.msc_**\n\nOrganizations can also enumerate certificates in NTAuth with the PSPKI[162] PowerShell module:\n```\nInstall-Module PSPKI -Scope CurrentUser\nImport-Module PSPKI\nGet-AdPkiContainer -ContainerType NTAuth | Select-Object -Expand\nCertificates | Select-Object -Expand Certificate | select *\n\n```\nPSPKI can remove certificates from the NTAuthCertificates object using its certificate thumbprint:\n```\nGet-AdPkiContainer -ContainerType NTAuth | Remove-AdCertificate -\nThumbprint \"EC9385E533782453D5C285B2A67311447FB57A6F\" -Dispose\n\n```\n\n-----\n\n#### Secure Certificate Private Key Storage - PREVENT6\n\nOrganizations should ideally protect CA private keys at the hardware level to prevent simple theft\nvia DPAPI. Microsoft’s “Securing PKI: Protecting CA Keys and Critical Artifacts”[163] documentation\ndetails how to migrate from software keys to hardware security modules (HSMs), which we highly\nrecommend.\n\nMicrosoft’s Credential Guard documentation does make claims that it will help secure\ncertificates[164] [165], although it is unclear to what extent. We have yet to examine Credential\nGuard’s effectiveness in protecting certificates. For example, using the DPAPI backup protocol\nmay be enough to recover certificates on domain-joined devices (we have not tested it).\nNonetheless, organizations should strive to enable Credential Guard if they can as it provides a\nmyriad of credential protections beyond just certificates.\n\nOn workstations and servers, TPM protection of private keys should also prevent theft via DPAPI\nby malicious actors. Consider enabling certificate TPM attestation[166] in the environment to make\nAD CS only accept certificates with private keys protected by an TPM.\n\n**Attack IDs:**\n\n  - Exporting Certificates Using the Crypto APIs – THEFT1\n\n  - Forging Certificates with Stolen CA Certificates - DPERSIST1\n\n#### Enforce Strict User Mappings - PREVENT7\n\nDuring certificate authentication, AD maps a certificate to an AD account. Kerberos and SChannel\ncommonly use a UPN specified in a certificate’s subject alternative name (SAN) to map the\nauthentication request to an identity in AD. If organizations do not need to use SANs, they can\ndisable SAN user mapping by setting a couple of sparsely documented registry keys.\n\nAt HKLM\\SYSTEM\\CurrentControlSet\\Services\\Kdc on a domain controller, setting the\nDWORD value of `UseSubjectAltName to 0 forces an explicit mapping during Kerberos`\nauthentication. While an attacker can still request (and receive) a certificate with a different SAN,\nattempting to use the certificate for Kerberos authentication will result in error “75\n\n[163 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786417(v=ws.11)](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786417(v=ws.11))\n\n164 https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-considerations#domain-joined-devices-automatically-provisioned-public-key\n\n165 https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/additional-mitigations#protecting-domain-joined-device-secrets\n\n166 https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/manage/component-updates/tpm-key-attestation\n\n\nvia DPAPI. Microsoft’s “Securing PKI: Protecting CA Keys and Critical Artifacts”[163] documentation\ndetails how to migrate from software keys to hardware security modules (HSMs), which we highly\nrecommend.\n\nMicrosoft’s Credential Guard documentation does make claims that it will help secure\ncertificates[164] [165], although it is unclear to what extent. We have yet to examine Credential\nGuard’s effectiveness in protecting certificates. For example, using the DPAPI backup protocol\nmay be enough to recover certificates on domain-joined devices (we have not tested it).\nNonetheless, organizations should strive to enable Credential Guard if they can as it provides a\nmyriad of credential protections beyond just certificates.\n\nOn workstations and servers, TPM protection of private keys should also prevent theft via DPAPI\nby malicious actors. Consider enabling certificate TPM attestation[166] in the environment to make\nAD CS only accept certificates with private keys protected by an TPM.\n\n**Attack IDs:**\n\n  - Exporting Certificates Using the Crypto APIs – THEFT1\n\n  - Forging Certificates with Stolen CA Certificates - DPERSIST1\n\n#### Enforce Strict User Mappings - PREVENT7\n\nDuring certificate authentication, AD maps a certificate to an AD account. Kerberos and SChannel\ncommonly use a UPN specified in a certificate’s subject alternative name (SAN) to map the\nauthentication request to an identity in AD. If organizations do not need to use SANs, they can\ndisable SAN user mapping by setting a couple of sparsely documented registry keys.\n\nAt HKLM\\SYSTEM\\CurrentControlSet\\Services\\Kdc on a domain controller, setting the\nDWORD value of `UseSubjectAltName to 0 forces an explicit mapping during Kerberos`\n\n\n-----\n\nKDC_ERR_CLIENT_NAME_MISMATCH”. More details on the mechanics of PKINIT explicit\nmapping are at “[MS-PKCA] Section 3.1.5.2.1.3 Explicit Mapping”[167]. For this approach to be\neffective, this registry key needs to be set on every domain controller in the environment.\nMicrosoft originally published information about this registry value KB4043463 but removed the\nKB article at some point in the last few years; PKISolutions has thankfully preserved a copy of the\nKB article.[168] Now, the only official documentation is a short paragraph describing the setting[169].\n\nKerberos, though, is not the only security package that supports certificate-based authentication.\nTo fully disable SAN user mapping, organizations also need to disable SAN user mapping for\nSChannel as well. This is controlled by the registry value `CertificateMappingMethods` in the\n`HKLM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL` key. Some\ndocumentation very vaguely describes this registry key[170]. Through reversing engineering\nschannel.dll (see the SslLocalMapCredential and SslMapCertToUserPac methods) and\naccidentally encountering the leaked Server 2003 source code, we eventually found the possible\nbitmask values:\n\n  - 0x1 = SP_REG_CERTMAP_SUBJECT_FLAG\n\n  - 0x2 = SP_REG_CERTMAP_ISSUER_FLAG\n\n  - 0x4 = SP_REG_CERTMAP_UPN_FLAG\n\n  - 0x8 = SP_REG_CERTMAP_S4U2SELF_FLAG\n\nFrom our experimentation, setting this key to either 0x1 or 0x2 successfully blocks the usage of\nSANs via SChannel authentication. However, more investigation is likely needed to ensure this is\na sufficient protection.\n\nWhile setting these keys will not prevent certificate authentication, we have heard of\norganizations using these keys to restrict the forms of certificate authentication allowed.\n\n**Attack IDs:**\n\n  - Misconfigured Certificate Templates - ESC1\n\n  - Misconfigured Certificate Templates - ESC2\n\n  - EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\n[167 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/282ed46a-97c2-4fab-8456-a6bd67b9ba71](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/282ed46a-97c2-4fab-8456-a6bd67b9ba71)\n\n[168 https://mskb.pkisolutions.com/kb/4043463](https://mskb.pkisolutions.com/kb/4043463)\n\n169 https://docs.microsoft.com/en-us/windows-server/security/kerberos/whats-new-in-kerberos-authentication#kdc-support-for-key-trust-account-mapping\n\n[170 https://docs.microsoft.com/en-us/windows-server/security/tls/tls-registry-settings#certificatemappingmethods](https://docs.microsoft.com/en-us/windows-server/security/tls/tls-registry-settings#certificatemappingmethods)\n\n\nMicrosoft originally published information about this registry value KB4043463 but removed the\nKB article at some point in the last few years; PKISolutions has thankfully preserved a copy of the\nKB article.[168] Now, the only official documentation is a short paragraph describing the setting[169]\n\nKerberos, though, is not the only security package that supports certificate-based authentication.\nTo fully disable SAN user mapping, organizations also need to disable SAN user mapping for\nSChannel as well. This is controlled by the registry value `CertificateMappingMethods` in the\n`HKLM\\CurrentControlSet\\Control\\SecurityProviders\\SCHANNEL` key. Some\ndocumentation very vaguely describes this registry key[170]. Through reversing engineering\nschannel.dll (see the SslLocalMapCredential and SslMapCertToUserPac methods) and\naccidentally encountering the leaked Server 2003 source code, we eventually found the possible\nbitmask values:\n\n  - 0x1 = SP_REG_CERTMAP_SUBJECT_FLAG\n\n  - 0x2 = SP_REG_CERTMAP_ISSUER_FLAG\n\n  - 0x4 = SP_REG_CERTMAP_UPN_FLAG\n\n  - 0x8 = SP_REG_CERTMAP_S4U2SELF_FLAG\n\nFrom our experimentation, setting this key to either 0x1 or 0x2 successfully blocks the usage of\nSANs via SChannel authentication. However, more investigation is likely needed to ensure this is\na sufficient protection.\n\nWhile setting these keys will not prevent certificate authentication, we have heard of\norganizations using these keys to restrict the forms of certificate authentication allowed.\n\n**Attack IDs:**\n\n  - Misconfigured Certificate Templates - ESC1\n\n  - Misconfigured Certificate Templates - ESC2\n\n\n-----\n\n#### Harden AD CS HTTP Endpoints – PREVENT8\n\nOrganizations should remove AD CS HTTP endpoints if they are not required. To enumerate which\nHTTP endpoints are enabled, IT administrators can look at the installed AD CS server roles on the\nCA servers:\n\n**_Figure 84 - Removing AD CS Server Roles Using the \"Remove Roles and Features\" Wizard_**\n\nIIS hosts the AD CS HTTP endpoints. As such, organizations could use IIS access logs as one\ntechnique to determine how often each endpoint is used. By default, these logs are located at\n```\nC:\\inetpub\\logs\\LogFiles\\ on the AD CS server. Similarly, detection engineers could use\n\n```\nthe IIS logs as a telemetry source.\n\nIf these endpoints are necessary, enforce HTTPS access to them and restrict NTLM. We present\nthe following ideas but have not tested their viability in a real production environment:\n\n  - Disable NTLM authentication\n\n`o` **At the host level. On AD CS servers, configure GPOs to set Computer Configuration**\n Windows Settings  Security Settings  Local Policies  Security Options \n“Network security: Restrict NTLM: Incoming NTLM traffic” to “Deny All Accounts”\nand add exceptions as necessary using the setting “Network security: Restrict\nNTLM: Add server exceptions in this domain.” The other “Restrict NTLM settings”\nvalue can also be enabled to better audit NTLM usage in an environment.\n`o` **At the IIS level. Disable authentication providers for each IIS application**\nassociated with an AD CS HTTP endpoint. For example, the following screenshot\nshows the removing the default “NTLM” and “Negotiate” Authentication\nproviders from the “CertSrv” application and replacing them with\n“Negotiate:Kerberos”:\n\n\n**_Figure 84 - Removing AD CS Server Roles Using the \"Remove Roles and Features\" Wizard_**\n\nIIS hosts the AD CS HTTP endpoints. As such, organizations could use IIS access logs as one\ntechnique to determine how often each endpoint is used. By default, these logs are located at\n```\nC:\\inetpub\\logs\\LogFiles\\ on the AD CS server. Similarly, detection engineers could use\n\n```\nthe IIS logs as a telemetry source.\n\nIf these endpoints are necessary, enforce HTTPS access to them and restrict NTLM. We present\nthe following ideas but have not tested their viability in a real production environment:\n\n  - Disable NTLM authentication\n\n`o` **At the host level. On AD CS servers, configure GPOs to set Computer Configuration**\n Windows Settings  Security Settings  Local Policies  Security Options \n“Network security: Restrict NTLM: Incoming NTLM traffic” to “Deny All Accounts”\nand add exceptions as necessary using the setting “Network security: Restrict\nNTLM: Add server exceptions in this domain.” The other “Restrict NTLM settings”\nvalue can also be enabled to better audit NTLM usage in an environment.\n\n\n-----\n\n  - If disabling NTLM is infeasible, enforce HTTPS and enable Extended Protection for\nAuthentication[171]:\n\n171 https://msrc-blog.microsoft.com/2009/12/08/extended-protection-for-authentication/\n\n\n**_Figure 85 - Disabling NTLM Authentication Providers for an AD CS IIS Application_**\n\n  - If disabling NTLM is infeasible, enforce HTTPS and enable Extended Protection for\nAuthentication[171]:\n\n\n-----\n\nIn addition, if you find you are vulnerable to this, consider contacting your nearest Microsoft\nrepresentative and question them as to why this insecure default configuration is allowed. As of\nright now, they have no intentions of directly servicing the issue, but it may fix at some\nindeterminate future date.\n\n**Attack IDs:**\n\n  - NTLM Relay to AD CS HTTP Endpoints – ESC8\n\n### Detective Guidance\n\nIf you cannot stop attackers performing these types of actions, the next defensive-in-depth push\nshould be detection. Since the same event could be legitimate in one environment but malicious\nin another, we cannot give a definitive answer as to which events should cause alarm, but we will\nbreak down every event we know about per malicious action we talked about.\n\nWhen collecting these events, we enabled very verbose logging to ensure maximum visibility.\nThis included doing the following:\n\n\n**_Figure 86 - Enabling Extended Protection for Authentication in IIS_**\n\nIn addition, if you find you are vulnerable to this, consider contacting your nearest Microsoft\nrepresentative and question them as to why this insecure default configuration is allowed. As of\nright now, they have no intentions of directly servicing the issue, but it may fix at some\nindeterminate future date.\n\n**Attack IDs:**\n\n  - NTLM Relay to AD CS HTTP Endpoints – ESC8\n\n### Detective Guidance\n\nIf you cannot stop attackers performing these types of actions, the next defensive-in-depth push\nshould be detection. Since the same event could be legitimate in one environment but malicious\nin another, we cannot give a definitive answer as to which events should cause alarm, but we will\n\n\n-----\n\n1. **Enabling all CA audit logs by opening certsrv.msc  right clicking on the CA  Auditing.**\nAD CS unfortunately does not enable any of these logs by default, so it is critical for\nnetwork defenders to enable them on each CA to gain visibility. These settings correspond\nwith the registry key value named AuditFilter[172] located at\nHKLM\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\<CA NAME>.\nEnabling these logs causes AD CS to write events to the Security event log with a task\ncategory of Certification Services.\n\n**_Figure 87 - Enabling All Audit Logs on a CA Using certsrv.msc_**\n\n2. **Enabling Success/Failure logging of all the Windows advanced audit logs under the GPO**\nsetting Computer Configuration  Windows Settings  Security Settings  Advanced\nAudit Policy Configuration\n3. **Enabling Success/Failure logging of all the Windows audit logs under the GPO setting**\nComputer Configuration  Windows Settings  Local Policies  Audit Policy\n\nWe recognize that it is unrealistic for most organizations to enable all Windows and AD CS audit\nlogs. However, we attempt to call out the most relevant events in our detection advice.\n\n#### Monitor User/Machine Certificate Enrollments - DETECT1\n\nWhen an account requests a certificate, the CA generates event ID (EID) 4886 “Certificate\nServices received a certificate request”[173]:\n\n172 Securing PKI: Appendix B: Certification Authority Audit Filter, https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786422(v=ws.11)\n\n[173 https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4886](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4886)\n\n\nHKLM\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\<CA NAME>.\nEnabling these logs causes AD CS to write events to the Security event log with a task\ncategory of Certification Services.\n\n**_Figure 87 - Enabling All Audit Logs on a CA Using certsrv.msc_**\n\n2. **Enabling Success/Failure logging of all the Windows advanced audit logs under the GPO**\nsetting Computer Configuration  Windows Settings  Security Settings  Advanced\nAudit Policy Configuration\n3. **Enabling Success/Failure logging of all the Windows audit logs under the GPO setting**\nComputer Configuration  Windows Settings  Local Policies  Audit Policy\n\nWe recognize that it is unrealistic for most organizations to enable all Windows and AD CS audit\nlogs. However, we attempt to call out the most relevant events in our detection advice.\n\n#### Monitor User/Machine Certificate Enrollments - DETECT1\n\n\n-----\n\nWhen the CA issues the certificate, it creates EID 4887 “Certificate Services approved a certificate\nrequest and issued a certificate”[174]:\n\n[174 https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4887](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4887)\n\n\n**_Figure 88 - Event 4886: Certificate Services Received a Certificate Request_**\n\nWhen the CA issues the certificate, it creates EID 4887 “Certificate Services approved a certificate\nrequest and issued a certificate”[174]:\n\n\n-----\n\nThe event supplies the requester user context, the DNS hostname of the machine they requested\nthe certificate from, and the time they requested the certificate. The attributes fields in these\nevent commonly has values for CDC, RMD, and CCM which correspond to Client DC, Request\nMachine DNS name, and Cert Client Machine, respectively[175].\n\nHowever, a lot of valuable context that is present in a CSR does not get surfaced. For example,\n\n1. The event log does not expose all certificate attributes or extensions. As such, if an\nattacker specifies an alternate user in either of the fields (e.g., in the SAN extension),\nattackers could perform user impersonation and privilege escalation via insecure\ncertificate templates and remain undetected.\n2. The certificate template name does not appear.\n3. CSRs created by Windows applications and services contain information such as process\nnames or HTTP user agents.\n\nAlthough not exposed via the Windows event log, a CA does store the CSR and detailed certificate\ninformation in its database. A CA’s database is a JET/ESE database that lives as a file on the AD\n\n175 https://social.technet.microsoft.com/Forums/en-US/865ab355-4251-4ddc-928f-1d66cefd9dff/custom-request-attributes?forum=winserversecurity\n\n\n**_Figure 89 - Event 4887: Certificate Services Approved a Certificate Request and Issued a Certificate_**\n\nThe event supplies the requester user context, the DNS hostname of the machine they requested\nthe certificate from, and the time they requested the certificate. The attributes fields in these\nevent commonly has values for CDC, RMD, and CCM which correspond to Client DC, Request\nMachine DNS name, and Cert Client Machine, respectively[175].\n\nHowever, a lot of valuable context that is present in a CSR does not get surfaced. For example,\n\n1. The event log does not expose all certificate attributes or extensions. As such, if an\nattacker specifies an alternate user in either of the fields (e.g., in the SAN extension),\nattackers could perform user impersonation and privilege escalation via insecure\ncertificate templates and remain undetected.\n2. The certificate template name does not appear.\n3. CSRs created by Windows applications and services contain information such as process\nnames or HTTP user agents.\n\n\n-----\n\nCS server. One can query this log and obtain the original CSR and other information, but to our\nknowledge, Microsoft has not exposed a programmatic way to get this information in real-time.\n\nOne can query the CA database in multiple ways. Running certutil.exe -v -view will output\nvery detail information about all certificates. Because there are likely thousands of requests in an\nenterprise environment, filtering can occur using the -restrict parameter[176] [177]. For example,\nthe command\n```\ncertutil.exe -v -view -restrict\n\"Disposition=20,Request.SubmittedWhen>=5/21/2021 11:15\nAM,RequesterName=CORP\\itadmin\" -gmt -out requestername,rawrequest\n\n```\nwill show the Windows user that submitted the CSR (-out requestername) and will display\nthe parsed CSRs (-v for verbose output, `-out rawrequest` to show the CSR) for issued\ncertificates (Disposition=20) submitted after May 21, 2021 at 11:15 AM (local time) where\nthe requesting user was CORP\\itadmin, displaying all times in GMT (-gmt).\n\nThe following screenshots highlight data in CSRs that we feel are especially valuable to incident\nresponders and detection engineers. The screenshots show the output from the above\ncertutil.exe command, but regardless of the collection method, we feel this data is valuable. First\nthe output shows the date when the CA received the CSR from the client followed by the base64\nCSR:\n\n**_Figure 90 - Certuil.exe Showing the CSR Submission Date_**\n\nIt then shows the Subject of the certificate and the public key associated with the private key\nthat signed the CSR:\n\n176 https://docs.microsoft.com/en-us/archive/blogs/pki/disposition-values-for-certutil-view-restrict-and-some-creative-samples\n\n177 https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil#-view\n\n\nvery detail information about all certificates. Because there are likely thousands of requests in an\nenterprise environment, filtering can occur using the -restrict parameter[176] [177]. For example,\nthe command\n```\ncertutil.exe -v -view -restrict\n\"Disposition=20,Request.SubmittedWhen>=5/21/2021 11:15\nAM,RequesterName=CORP\\itadmin\" -gmt -out requestername,rawrequest\n\n```\nwill show the Windows user that submitted the CSR (-out requestername) and will display\nthe parsed CSRs (-v for verbose output, `-out rawrequest` to show the CSR) for issued\ncertificates (Disposition=20) submitted after May 21, 2021 at 11:15 AM (local time) where\nthe requesting user was CORP\\itadmin, displaying all times in GMT (-gmt).\n\nThe following screenshots highlight data in CSRs that we feel are especially valuable to incident\nresponders and detection engineers. The screenshots show the output from the above\ncertutil.exe command, but regardless of the collection method, we feel this data is valuable. First\nthe output shows the date when the CA received the CSR from the client followed by the base64\nCSR:\n\n**_Figure 90 - Certuil.exe Showing the CSR Submission Date_**\n\nIt then shows the Subject of the certificate and the public key associated with the private key\nthat signed the CSR:\n\n\n-----\n\nThe output then displays attributes specified in the CSR. This is valuable contextual information\nabout the requester, including **OS version,** **user/process information, and** **the requested**\n**cryptographic service provider (CSP):**\n\n**_Figure 92 - Certutil.exe Showing Client-Supplied CSR Attributes_**\n\nAD CS does not require the requester to supply all these fields; however, if an application uses\nthe Windows COM object to submit a CSR, the COM object will auto-populate these fields.\nDetection engineers can baseline these fields in their environments and alert on anomalous\nvalues (e.g., abnormal OS versions or processes) or anomalous omissions of these values.\n\n\n**_Figure 91 - Certuil.exe Showing the CSR's Subject and Public Key Fields_**\n\nThe output then displays attributes specified in the CSR. This is valuable contextual information\nabout the requester, including **OS version,** **user/process information, and** **the requested**\n**cryptographic service provider (CSP):**\n\n\n-----\n\nThe certutil.exe output ends with showing certificate extensions the client supplies in the CSR.\nParticularly valuable information includes the certificate template name and the optional subject\nalternative name (the CA will only use the SAN if the template has the\n```\nCT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag enabled):\n\n```\n**_Figure 93 - Certificate Attributes when Querying Issued Certificates with Certutil_**\n\nAs shown, certutil.exe can query the CA database to surface this info, but the output is not in a\nnice machine-parseable format. PKISolutions has built a fantastic PowerShell/C# tool called\nPSPKI[178] that one can use to query the CA’s database. Using PSPKI, we built PSPKIAudit [179], a\nPowerShell auditing tool for network defenders that exposes much of the above information.\nPSPKIAudit’s `Get-CertRequest function wraps various PSPKI functionality to return`\ninformation (including SAN presence) about certificate requests:\n\n[178 https://github.com/PKISolutions/PSPKI](https://github.com/PKISolutions/PSPKI)\n\n179 http://github.com/GhostPack/PSPKIAudit\n\n\n**_Figure 93 - Certificate Attributes when Querying Issued Certificates with Certutil_**\n\nAs shown, certutil.exe can query the CA database to surface this info, but the output is not in a\nnice machine-parseable format. PKISolutions has built a fantastic PowerShell/C# tool called\nPSPKI[178] that one can use to query the CA’s database. Using PSPKI, we built PSPKIAudit [179], a\nPowerShell auditing tool for network defenders that exposes much of the above information.\n\n\n-----\n\n**_Figure 94 - PSPKIAudit's Get-CertRequest Showing an Issued Certificate_**\n\nIf a certificate enrollment is determined to be malicious, administrators can revoke the certificate\nthrough _certsrv.msc or PSPKI’s_ _Revoke-Certificate[180] function. Keep in mind that_ `Get-`\n```\nCertRequest has only been tested against PKCS #10 formatted CSRs as they are the most\n\n```\ncommon. However, AD CS also supports requesting certificates with Cryptographic Message\nSyntax (CMS), Certificate Management Messages (CMS), and Netscape KEYGEN Tag Request\nFormat[181].\n\n**Attack IDs: PERSIST1, PERSIST2, ESC1, ESC2, ESC3, ESC4, ESC6**\n\n  - Active User Credential Theft via Certificates – PERSIST1\n\n  - Machine Persistence via Certificates - PERSIST2\n\n  - Misconfigured Certificate Templates - ESC1\n\n  - Misconfigured Certificate Templates - ESC2\n\n  - Misconfigured Enrollment Agent Templates - ESC3\n\n  - Vulnerable Certificate Template Access Control - ESC4\n\n  - EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\n#### Monitor Certificate Authentication Events - DETECT2\n\nRecall that both Kerberos (via PKINIT) and SChannel support certificate-based authentication.\nSome environments rarely use these authentication protocols (particularly SChannel). As such,\nmonitoring for logon events using these protocols can detect abnormal activity in the\nenvironment.\n\nFor Kerberos, when a user authenticates with a certificate, the DC generates event ID 4768 “A\nKerberos authentication ticket (TGT) was requested”[182] in the Security event log. Of note,\n\n[180 https://www.pkisolutions.com/tools/pspki/Revoke-Certificate](https://www.pkisolutions.com/tools/pspki/Revoke-Certificate)\n\n181 https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wcce/e0c8660c-f299-4725-b090-20354b1db9a6\n\n[182 https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768)\n\n\n**_Figure 94 - PSPKIAudit's Get-CertRequest Showing an Issued Certificate_**\n\nIf a certificate enrollment is determined to be malicious, administrators can revoke the certificate\nthrough _certsrv.msc or PSPKI’s_ _Revoke-Certificate[180] function. Keep in mind that_ `Get-`\n```\nCertRequest has only been tested against PKCS #10 formatted CSRs as they are the most\n\n```\ncommon. However, AD CS also supports requesting certificates with Cryptographic Message\nSyntax (CMS), Certificate Management Messages (CMS), and Netscape KEYGEN Tag Request\nFormat[181].\n\n**Attack IDs: PERSIST1, PERSIST2, ESC1, ESC2, ESC3, ESC4, ESC6**\n\n  - Active User Credential Theft via Certificates – PERSIST1\n\n  - Machine Persistence via Certificates - PERSIST2\n\n  - Misconfigured Certificate Templates - ESC1\n\n  - Misconfigured Certificate Templates - ESC2\n\n  - Misconfigured Enrollment Agent Templates - ESC3\n\n  - Vulnerable Certificate Template Access Control - ESC4\n\n  - EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\n#### Monitor Certificate Authentication Events - DETECT2\n\nRecall that both Kerberos (via PKINIT) and SChannel support certificate-based authentication.\nSome environments rarely use these authentication protocols (particularly SChannel). As such,\nmonitoring for logon events using these protocols can detect abnormal activity in the\nenvironment.\n\n\n-----\n\nbecause certificate authentication occurred, the event populates the “Certificate Information”\nfields with the authenticating certificate’s Issuer, Serial Number, and Thumbprint:\n\n**_Figure 95 - Event 4768: A Kerberos Authentication Ticket (TGT) was Requested_**\n\nBaselining normal PKINIT usage and alerting on abnormal usage is one detection strategy.\n\nOne potential detection for forged certificates created from a stolen CA certificate would be to\ngenerate a list of issued certificates and their serial numbers and thumbprints. Then, compare\nthat list with a list generated from EID 4768 to enumerate which users have legitimately issued\ncertificates via PSPKI/PSPKIAudit and compare the certificate serial numbers and certificate\nthumbprints with the list of certificates that any PKINIT TGT requests are only from this group.\n\nWhen a client authenticates using SChannel, the DC can generate various events. By default (i.e.,\nthe CertificateMappingMethods registry key is not set) the DC will attempt to obtain information\nabout the account specified in the certificate using S4U2Self. During this process it will first create\nEID 4769 “A Kerberos service ticket was requested”, requesting a service ticket to itself:\n\n\n**_Figure 95 - Event 4768: A Kerberos Authentication Ticket (TGT) was Requested_**\n\nBaselining normal PKINIT usage and alerting on abnormal usage is one detection strategy.\n\nOne potential detection for forged certificates created from a stolen CA certificate would be to\ngenerate a list of issued certificates and their serial numbers and thumbprints. Then, compare\nthat list with a list generated from EID 4768 to enumerate which users have legitimately issued\ncertificates via PSPKI/PSPKIAudit and compare the certificate serial numbers and certificate\nthumbprints with the list of certificates that any PKINIT TGT requests are only from this group.\n\nWhen a client authenticates using SChannel, the DC can generate various events. By default (i.e.,\nthe CertificateMappingMethods registry key is not set) the DC will attempt to obtain information\nabout the account specified in the certificate using S4U2Self. During this process it will first create\nEID 4769 “A Kerberos service ticket was requested”, requesting a service ticket to itself:\n\n\n-----\n\nThe DC will then create EID 4648 “A logon was attempted using explicit credentials”. Of note in\nthis event, the target account will be the user associated with certificate, the target server is\n“localhost” (i.e., it occurs on the DC), and the event includes the IP address of the host where the\nlogon originated:\n\n\n**_Figure 96 - S4U2Self-related Event During SChannel Authentication_**\n\nThe DC will then create EID 4648 “A logon was attempted using explicit credentials”. Of note in\nthis event, the target account will be the user associated with certificate, the target server is\n“localhost” (i.e., it occurs on the DC), and the event includes the IP address of the host where the\nlogon originated:\n\n\n-----\n\nAssuming the S4U2Self process completes successfully, the DC will generate EID 4624 “An\naccount successfully logged on”, specifying the Authentication Package as `Kerberos (due to`\nS4U2Self) and the Logon Process Name as Schannel. EID 4624 will also include the information\nabout the user specified in the certificate and the originating IP address:\n\n\n**_Figure 97 - EID 4648 that Occurs During S4U2Self_**\n\nAssuming the S4U2Self process completes successfully, the DC will generate EID 4624 “An\naccount successfully logged on”, specifying the Authentication Package as `Kerberos (due to`\nS4U2Self) and the Logon Process Name as Schannel. EID 4624 will also include the information\nabout the user specified in the certificate and the originating IP address:\n\n\n-----\n\nIf S4U2Self fails or administrators have disable it via the CertificateMappingMethods\nregistry key, but then authentication otherwise succeeds, then the DC will generate the\nfollowing 4624 logon event. Note that the Logon Process is Schannel and the Authentication\nPackage is Microsoft Unified Security Protocol Provider[183]\n\n183 https://docs.microsoft.com/en-us/windows/win32/rpc/security-support-providers-ssps\n\n**_Figure 98 - EID 4624 Showing Successful SChannel Authentication via S4U2Self_**\n\nIf S4U2Self fails or administrators have disable it via the CertificateMappingMethods\nregistry key, but then authentication otherwise succeeds, then the DC will generate the\nfollowing 4624 logon event. Note that the Logon Process is Schannel and the Authentication\nPackage is Microsoft Unified Security Protocol Provider[183]\n\n\n-----\n\nIn summary, monitoring the _Logon Process field in logon events (EID 4624) for a value of_\n```\nSchannel seems to be a reliable way to detect Schannel authentication.\n\n```\n**Attack IDs:**\n\n  - NTLM Credential Theft via PKINIT – THEFT5\n\n  - Forging Certificates with Stolen CA Certificates - DPERSIST1\n\n  - Trusting Rogue CA Certificates - DPERSIST2\n\n  - Misconfigured Certificate Templates - ESC1\n\n  - Misconfigured Certificate Templates - ESC2\n\n  - Misconfigured Enrollment Agent Templates - ESC3\n\n  - Vulnerable Certificate Template Access Control - ESC4\n\n  - EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6\n\n\n**_Figure 99 - Logon Event Generate from the Schannel SSP_**\n\nIn summary, monitoring the _Logon Process field in logon events (EID 4624) for a value of_\n```\nSchannel seems to be a reliable way to detect Schannel authentication.\n\n```\n**Attack IDs:**\n\n  - NTLM Credential Theft via PKINIT – THEFT5\n\n  - Forging Certificates with Stolen CA Certificates - DPERSIST1\n\n  - Trusting Rogue CA Certificates - DPERSIST2\n\n  - Misconfigured Certificate Templates - ESC1\n\n\n-----\n\n#### Monitor Certificate Authority Backup Events - DETECT3\n\nThere are two specific AD CS audit events[184] related to the backup of a CA through the certsrv.msc\nGUI, specifically EID 4876 “Certificate Services backup started”[185] and EID 4877 “Certificate\nServices backup completed”[186]:\n\n**_Figure 100 - EID 4876 - Certificate Services Backup Started_**\n\n**_Figure 101 - EID 4877 Certificate Services Backup Completed_**\n\n[184 https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-certification-services](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-certification-services)\n\n[185 https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4876](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4876)\n\n[186 https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4877](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4877)\n\n\nGUI, specifically EID 4876 “Certificate Services backup started” and EID 4877 “Certificate\nServices backup completed”[186]:\n\n**_Figure 100 - EID 4876 - Certificate Services Backup Started_**\n\n\n-----\n\nHowever, these events only fire when a backup the database/database log as well as the private\nkey and CA certificate. i.e., if a user only selects the following when backing up the CA, AD CS will\nnot generate any logs:\n\n**_Figure 102 - Backing Only the CA Private Key via certsrv.msc_**\n\nHowever, backing up the private key and CA certificate will result in other audit events. In\nparticular, the OS generates the following series of events (shown in the screenshots below):\n\n**EID 5058 - Key File Operation. That the subject is the user performing the backup, the**\n_KeyName corresponds with the name of the CA, the_ _KeyType is MachineKey, and the_\n_ClientProcessId is the process performing the export (mmc.exe in this case). The_\n_KeyFilePath and_ _Operation fields correspond with reading the CA’s DPAPI-encrypted_\nprivate key file (see the Exporting Certificates Using the Crypto APIs – THEFT1 and User\nCertificate Theft via DPAPI – THEFT2 sections for more information about private key\nstorage and DPAPI).\n**EID 5061 - Cryptographic operation. This shares many of the fields as EID 5058, just with**\nless detail. The important thing to highlight in this event is that a user (the Subject fields)\nis opening (the Operation field) the CA’s (specified KeyName field) private key.\n**EID 5059 - Key migration operation. The fields in this event are the same as in EID 5058.**\nThe only difference is that the Operation field is “Export of cryptographic key.”\n\n\n**_Figure 102 - Backing Only the CA Private Key via certsrv.msc_**\n\nHowever, backing up the private key and CA certificate will result in other audit events. In\nparticular, the OS generates the following series of events (shown in the screenshots below):\n\n**EID 5058 - Key File Operation. That the subject is the user performing the backup, the**\n_KeyName corresponds with the name of the CA, the_ _KeyType is MachineKey, and the_\n_ClientProcessId is the process performing the export (mmc.exe in this case). The_\n_KeyFilePath and_ _Operation fields correspond with reading the CA’s DPAPI-encrypted_\nprivate key file (see the Exporting Certificates Using the Crypto APIs – THEFT1 and User\nCertificate Theft via DPAPI – THEFT2 sections for more information about private key\nstorage and DPAPI).\n**EID 5061 - Cryptographic operation. This shares many of the fields as EID 5058, just with**\nless detail. The important thing to highlight in this event is that a user (the Subject fields)\n\n\n-----\n\n**_Figure 103 - EID 5058 - Key File Operation_**\n\n**_Figure 104 - EID 5061 Cryptographic Operation_**\n\n\n**_Figure 103 - EID 5058 - Key File Operation_**\n\n**_Figure 104 - EID 5061 Cryptographic Operation_**\n\n\n-----\n\n**_Figure 105 - EID 5059 Key Migration Operation_**\n\n**Attack IDs:**\n\n  - Forging Certificates with Stolen CA Certificates - DPERSIST1\n\n#### Monitor Certificate Template Modifications - DETECT4\n\nCertificate templates should rarely change, as such, detection engineers should monitor them\nclosely and generate alerts if changed unexpectedly. AD CS creates EID 4899 “A Certificate\nServices template was updated” when a template AD object’s attributes change, surfacing the\nAD object attributes that changed:\n\n\n**_Figure 105 - EID 5059 Key Migration Operation_**\n\n**Attack IDs:**\n\n  - Forging Certificates with Stolen CA Certificates - DPERSIST1\n\n#### Monitor Certificate Template Modifications - DETECT4\n\nCertificate templates should rarely change, as such, detection engineers should monitor them\nclosely and generate alerts if changed unexpectedly. AD CS creates EID 4899 “A Certificate\nServices template was updated” when a template AD object’s attributes change, surfacing the\nAD object attributes that changed:\n\n\n-----\n\nAD CS generates EID 4900 “Certificate Services template security was updated” when a certificate\ntemplate AD object’s security descriptor changes:\n\n**_Figure 107 - EID 4900 “Certificate Services template security was updated”_**\n\n\n**_Figure 106 - EID 4899 \"A Certificate Services template was updated\"_**\n\nAD CS generates EID 4900 “Certificate Services template security was updated” when a certificate\ntemplate AD object’s security descriptor changes:\n\n\n-----\n\nIt is important to note that EID 4899 and 4900 are not suitable for real-time detection of template\nmodification. These events only fire when the template AD object changes _and then an_\nenrollment occurs. When an account attempts to enroll in a certificate template, the Enterprise\nCA compares the loaded template cached in its memory with the template in AD and generates\nthe appropriate event if they are different. Since this only occurs when the next enrollment\noccurs, this is not suitable for real-time detection template modification. In addition, during our\ntesting, the Enterprise CA did not generate the events if the AD CS server rebooted after the\ntemplate changed but before another enrollment occurred.\n\nAs an alternative to these events, organizations can apply SACLs to the template AD objects. For\nexample, the following screenshot shows applying a SACL to the _User_ certificate template AD\nobject using adsiedit.msc to monitor anytime an account obtains Write, Delete, WriteDacl, and\nWriteOwner access to the object:\n\n**_Figure 108 - Applying a SACL to the User Certificate Template_**\n\nWhen a user edits the object via LDAP, AD generates EID 4662 “An operation was performed on\nan object”[187]:\n\n187 https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662\n\n\nthe appropriate event if they are different. Since this only occurs when the next enrollment\noccurs, this is not suitable for real-time detection template modification. In addition, during our\ntesting, the Enterprise CA did not generate the events if the AD CS server rebooted after the\ntemplate changed but before another enrollment occurred.\n\nAs an alternative to these events, organizations can apply SACLs to the template AD objects. For\nexample, the following screenshot shows applying a SACL to the _User_ certificate template AD\nobject using adsiedit.msc to monitor anytime an account obtains Write, Delete, WriteDacl, and\nWriteOwner access to the object:\n\n**_Figure 108 - Applying a SACL to the User Certificate Template_**\n\nWhen a user edits the object via LDAP, AD generates EID 4662 “An operation was performed on\nan object”[187]:\n\n\n-----\n\n**_Figure 109 - EID 4662 \"An operation was performed on an object\"_**\n\nNote that the event captures the user performing the action and the type of access. The GUIDs\nin the ObjectType and Properties event correspond with AD schema property, property set, and\nclass GUIDs, and various tools can resolve them to a name[188] [189].\n\n**Attack IDs: ESC4, DPERSIST3**\n\n  - Vulnerable Certificate Template Access Control - ESC4\n\n  - Account Persistence via Certificate Renewal - PERSIST3\n\n#### Detecting Reading of DPAPI-Encrypted Keys - DETECT5\n\nIn 2018, Palantir released a great post on using Windows system access control lists (SACLs) to\nimplement granular auditing, for free, on Windows endpoints[190]. Organization can apply SACLs\nto both DPAPI master key files and the DPAPI-encrypted private key files to audit the processes\nand users that normally directly read these files. We assume only SYSTEM processes primarily\naccess these files, but do not have the data set to yet confirm.\n\nApplying SACLs to DPAPI masterkey and DPAPI-encrypted private key files can detect when a\nprocess uses standard Windows APIs to read the files (the approach SharpDPAPI and Mimikatz\nuse by default), but it would not catch Mimikatz’s patching of CAPI/CNG or other methods of\n\n188 https://github.com/leechristensen/Random/blob/master/PowerShellScripts/ConvertFrom-DsSchemaGuid.ps1\n\n189 https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/deda47e05a981387435894f1143623b0abfbc800/NtObjectManager/DsFunctions.ps1#L86-L359\n\n[190 https://medium.com/@cryps1s/detecting-windows-endpoint-compromise-with-sacls-cd748e10950](https://medium.com/@cryps1s/detecting-windows-endpoint-compromise-with-sacls-cd748e10950)\n\n\n**_Figure 109 - EID 4662 \"An operation was performed on an object\"_**\n\nNote that the event captures the user performing the action and the type of access. The GUIDs\nin the ObjectType and Properties event correspond with AD schema property, property set, and\nclass GUIDs, and various tools can resolve them to a name[188] [189].\n\n**Attack IDs: ESC4, DPERSIST3**\n\n  - Vulnerable Certificate Template Access Control - ESC4\n\n  - Account Persistence via Certificate Renewal - PERSIST3\n\n#### Detecting Reading of DPAPI-Encrypted Keys - DETECT5\n\nIn 2018, Palantir released a great post on using Windows system access control lists (SACLs) to\nimplement granular auditing, for free, on Windows endpoints[190]. Organization can apply SACLs\nto both DPAPI master key files and the DPAPI-encrypted private key files to audit the processes\nand users that normally directly read these files. We assume only SYSTEM processes primarily\naccess these files, but do not have the data set to yet confirm.\n\n\n-----\n\nreading files (e.g., parsing the NTFS file system). Organizations can use this approach to detect\nsome forms of theft of both user/machine certificate private keys and certificate authority\nprivate keys that are not protected by hardware.\n\n**Attack IDs:**\n\n  - User Certificate Theft via DPAPI – THEFT2\n\n  - Machine Certificate Theft via DPAPI – THEFT3\n\n  - Active User Credential Theft via Certificates – PERSIST1\n\n#### Use Honey Credentials – DETECT6\n\nAttackers can search for certificates and private key files that, when used, could benefit the\nattacker when compromising a network. Discovered certificates could permit the attacker to\nauthenticate to AD as another user, forge certificates (in the case of a CA certificate), man-in-themiddle traffic, or sign code using a trusted certificate (amongst many other things).\n\nDefenders can take advantage of attackers seeking certificate and private key files and potentially\ndetect some of their activities using honey credentials. Network defenders can create “honey\ncertificates” and place them in common locations an attacker may search for them, e.g.,\naccessible file shares, in Windows credential stores, or in administrative folders on users’\nmachines. Defenders could place a SACL on the file to detect when someone accesses it or detect\nwhen the certificate is used (e.g., when a file is signed using it or when a user logs on using the\ncertificate).\n\nFor example, detection engineers could create a legitimate account, create a legitimate client\nauthentication certificate for the account, export the certificate and private key as a .pfx file,\nand then place the .pfx file in common locations an attacker may come across it. Detections\ncould be built to detect when the file is accessed (e.g., using SACLs) or when the attacker attempts\nto logon using the certificate (e.g., monitoring EID 4624 logon events for Kerberos PKINIT or\nSchannel logons using the certificate).\n\n**Attack IDs:**\n\n  - Finding Certificate Files – THEFT4\n\n\n\n  - User Certificate Theft via DPAPI – THEFT2\n\n  - Machine Certificate Theft via DPAPI – THEFT3\n\n  - Active User Credential Theft via Certificates – PERSIST1\n\n#### Use Honey Credentials – DETECT6\n\nAttackers can search for certificates and private key files that, when used, could benefit the\nattacker when compromising a network. Discovered certificates could permit the attacker to\nauthenticate to AD as another user, forge certificates (in the case of a CA certificate), man-in-the-\nmiddle traffic, or sign code using a trusted certificate (amongst many other things).\n\nDefenders can take advantage of attackers seeking certificate and private key files and potentially\ndetect some of their activities using honey credentials. Network defenders can create “honey\ncertificates” and place them in common locations an attacker may search for them, e.g.,\naccessible file shares, in Windows credential stores, or in administrative folders on users’\nmachines. Defenders could place a SACL on the file to detect when someone accesses it or detect\nwhen the certificate is used (e.g., when a file is signed using it or when a user logs on using the\ncertificate).\n\nFor example, detection engineers could create a legitimate account, create a legitimate client\nauthentication certificate for the account, export the certificate and private key as a .pfx file,\nand then place the .pfx file in common locations an attacker may come across it. Detections\ncould be built to detect when the file is accessed (e.g., using SACLs) or when the attacker attempts\nto logon using the certificate (e.g., monitoring EID 4624 logon events for Kerberos PKINIT or\nSchannel logons using the certificate).\n\n**Attack IDs:**\n\n\n-----\n\n#### Miscellaneous – DETECT7\n\nOther events that might be of interest[191], but we did not fully dive into:\n\n - 4882: The security permissions for Certificate Services changed[192] - in case attackers are\nmodifying ACLs of the CA itself.\n\n - 4890: The certificate manager settings for Certificate Services changed.[193]\n\n - 4892: A property of Certificate Services changed.[194]\n\nSharpDPAPI’s extraction method or host private keys involves having to elevate to SYSTEM to\nretrieve the DPAPI_SYSTEM LSA secret, which is then used to decrypt the system masterkeys\nneeded for the certificate private keys. Any detection/prevention as far as elevating to SYSTEM\nand dumping LSA secrets would apply here as well.\n\n**Attack IDs:**\n\n  - Vulnerable Certificate Authority Access Control - ESC7\n\n### Incident Response Guidance\n\nIn the event of a breach, traditional incident response often results in the wiping/reprovisioning\nof a user’s system and the reset of their domain password. However, as certificates are valid for\ntheir issued lifetime and the CA server’s certificate lifetime, they survive user password resets.\nThis means that legitimately issued certificates for the user/system may have been stolen, and/or\ncertificates may have been maliciously requested.\n\nThe safest mitigation is to reprovision the affected user a new user account, disable the old user\naccount, audit event logs for attempted authentication events, and wipe the user’s workstation.\nIf this is not possible, the user’s password should be reset, and all certificates issued to that user\nand system should be revoked in AD CS.\n\nUnfortunately, as mentioned previously, it’s relatively difficult to programmatically investigate a\nCertificate Authority’s database to determine if certificate issuances may be fraudulent. It’s also\ndifficult to revoke certificates outside of the _certsrv.msc GUI, however the best toolkit we’ve_\nfound is the previously mentioned PSPKI[195] PowerShell suite from PKISolutions. It contains\n\n[191 https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-certification-services](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-certification-services)\n\n[192 https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4882](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4882)\n\n[193 https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4890](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4890)\n\n[194 https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4892](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4892)\n\n[195 https://github.com/PKISolutions/PSPKI](https://github.com/PKISolutions/PSPKI)\n\n\n\n - 4882: The security permissions for Certificate Services changed[192] - in case attackers are\nmodifying ACLs of the CA itself.\n\n - 4890: The certificate manager settings for Certificate Services changed.[193]\n\n - 4892: A property of Certificate Services changed.[194]\n\nSharpDPAPI’s extraction method or host private keys involves having to elevate to SYSTEM to\nretrieve the DPAPI_SYSTEM LSA secret, which is then used to decrypt the system masterkeys\nneeded for the certificate private keys. Any detection/prevention as far as elevating to SYSTEM\nand dumping LSA secrets would apply here as well.\n\n**Attack IDs:**\n\n  - Vulnerable Certificate Authority Access Control - ESC7\n\n### Incident Response Guidance\n\nIn the event of a breach, traditional incident response often results in the wiping/reprovisioning\nof a user’s system and the reset of their domain password. However, as certificates are valid for\ntheir issued lifetime and the CA server’s certificate lifetime, they survive user password resets.\nThis means that legitimately issued certificates for the user/system may have been stolen, and/or\ncertificates may have been maliciously requested.\n\nThe safest mitigation is to reprovision the affected user a new user account, disable the old user\naccount, audit event logs for attempted authentication events, and wipe the user’s workstation.\nIf this is not possible, the user’s password should be reset, and all certificates issued to that user\nand system should be revoked in AD CS.\n\nUnfortunately, as mentioned previously, it’s relatively difficult to programmatically investigate a\n\n\n-----\n\nseveral useful functions, including the ability to revoke certificates[196]. As mentioned previously,\nPSPKIAudit can be used to investigate requests for specific templates, or requests from specific\nprincipals. The PSPKIAudit toolset being released with this whitepaper helps enable this type of\ninvestigation with its Get-CertRequest function.\n\nIf a Certificate Authority server itself is compromised, or if its private key is in another other way\nexposed, an organization should consider their PKI system completely compromised. There are a\nnumber of response actions that should occur, which are detailed by Microsoft’s “Securing PKI:\n_Compromise Response”[197]_ document. Microsoft has also published the “How to decommission a\n_Windows enterprise certification authority and remove all related objects”[198] which details_\ntechnical steps for decommissioning a CA server. Full incident response guidance around AD CS\ncompromise is out of the scope of this paper.\n\n### Defensive Gaps and Challenges\n\nThe security considerations of AD CS are new material for most of us. While we attempted to\ncover as many bases as we could defensively, we are sure that we missed some preventative or\ndefensive ideas. Also, additional attacks against AD CS are likely to be discovered by ourselves or\nothers as a result of this research.\n\nThe proper detection of maliciously requested certificates, whether they specify alternate SANs\nor not, is a difficult problem. While some event IDs can be used to track certificate requests, the\nevents lack some important information, and baselining/data processing will be needed in large\nenvironments for these detections to be effective. In the future, we hope that Microsoft gives us\nmore detailed and security-focused event auditing for Active Directory Certificate Services, things\nlike including the template and associated information with 4886/4887 events to facilitate event\ncorrelation, and/or including private key backups in the backup event along with more contextual\ninformation for those 4876/4877 events. Alerting organizations to misconfigured template\nconfiguration via event log notification would also be a great addition.\n\nOnce a Certificate Authority (or subordinate Certificate Authority) private key is stolen, we do\nnot currently know of any method of detection for the usage of forged certificates, though we\nhope an approach is possible.\n\n[196 https://www.pkisolutions.com/tools/pspki/Revoke-Certificate/](https://www.pkisolutions.com/tools/pspki/Revoke-Certificate/)\n\n[197 https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786435(v=ws.11)#ca-compromise-response-actions](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn786435(v=ws.11)#ca-compromise-response-actions)\n\n[198 https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/decommission-enterprise-certification-authority-and-remove-objects](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/decommission-enterprise-certification-authority-and-remove-objects)\n\n\nIf a Certificate Authority server itself is compromised, or if its private key is in another other way\nexposed, an organization should consider their PKI system completely compromised. There are a\nnumber of response actions that should occur, which are detailed by Microsoft’s “Securing PKI:\n_Compromise Response”[197]_ document. Microsoft has also published the “How to decommission a\n_Windows enterprise certification authority and remove all related objects”[198] which details_\ntechnical steps for decommissioning a CA server. Full incident response guidance around AD CS\ncompromise is out of the scope of this paper.\n\n### Defensive Gaps and Challenges\n\nThe security considerations of AD CS are new material for most of us. While we attempted to\ncover as many bases as we could defensively, we are sure that we missed some preventative or\ndefensive ideas. Also, additional attacks against AD CS are likely to be discovered by ourselves or\nothers as a result of this research.\n\nThe proper detection of maliciously requested certificates, whether they specify alternate SANs\nor not, is a difficult problem. While some event IDs can be used to track certificate requests, the\nevents lack some important information, and baselining/data processing will be needed in large\nenvironments for these detections to be effective. In the future, we hope that Microsoft gives us\nmore detailed and security-focused event auditing for Active Directory Certificate Services, things\nlike including the template and associated information with 4886/4887 events to facilitate event\ncorrelation, and/or including private key backups in the backup event along with more contextual\ninformation for those 4876/4877 events. Alerting organizations to misconfigured template\nconfiguration via event log notification would also be a great addition.\n\nOnce a Certificate Authority (or subordinate Certificate Authority) private key is stolen, we do\nnot currently know of any method of detection for the usage of forged certificates, though we\n\n\n-----\n\n## Conclusion\n\nActive Directory Certificate Services is not the easiest system to fully understand, implement, nor\nsecure. There are a myriad of moving parts and several settings that, while appearing somewhat\ninconsequential, can drastically affect the security of the entire Active Directory environment. In\nsummary, from an offensive perspective, certificate abuse can grant an attacker:\n\nStealing existing user certificates capable of domain\nauthentication or actively requesting a new certificate\n\n**User Credential Theft (1 year+)**\n\nfrom a user’s context. Survives user password changes\n_and can be done without elevation or touching LSASS!_\n\nStealing existing system certificates capable of domain\nauthentication or actively requesting a new certificate\nfrom a system’s context, combined with resource-based\n\n**Machine Persistence (1 year+)**\n\nconstrained delegation or just S4U2Self. Survives\n_machine password changes and can be done without_\n_touching LSASS!_\n\nMisconfigured certificate templates that allow Subject\nAlternative Name (SAN) specification, vulnerable\nCertificate Request Agent templates, vulnerable\n\n**Domain Escalation Path(s)**\n\ntemplate ACLs, the EDITF_ATTRIBUTESUBJECTALTNAME2\nflag being set, vulnerable CA permissions, or NTLM relay\nto web enrollment endpoints.\n\nStealing the certificate authority’s private key and forging\n**Domain Persistence**\ncertificates.\n\nIt is extremely easy for certificate misconfigurations to arise that allow unprivileged domain users\nto escalate their rights. We have seen a proliferation of these issues in real environments since\nwe began looking in February 2021.\n\nWe reported the “NTLM Relay to AD CS HTTP Endpoints – ESC8” issue to MSRC on May 19th along\nwith all domain escalation scenarios and received a response on June 8th of “We determined\n_your finding is valid but does not meet our bar for a security update release.” They recommended_\n\n|User Credential Theft (1 year+)|Stealing existing user certificates capable of domain authentication or actively requesting a new certificate from a user’s context. Survives user password changes and can be done without elevation or touching LSASS!|\n|---|---|\n|Machine Persistence (1 year+)|Stealing existing system certificates capable of domain authentication or actively requesting a new certificate from a system’s context, combined with resource-based constrained delegation or just S4U2Self. Survives machine password changes and can be done without touching LSASS!|\n|Domain Escalation Path(s)|Misconfigured certificate templates that allow Subject Alternative Name (SAN) specification, vulnerable Certificate Request Agent templates, vulnerable template ACLs, the EDITF_ATTRIBUTESUBJECTALTNAME2 flag being set, vulnerable CA permissions, or NTLM relay to web enrollment endpoints.|\n|Domain Persistence|Stealing the certificate authority’s private key and forging certificates.|\n\n\nsummary, from an offensive perspective, certificate abuse can grant an attacker:\n\nStealing existing user certificates capable of domain\nauthentication or actively requesting a new certificate\n\n**User Credential Theft (1 year+)**\n\nfrom a user’s context. Survives user password changes\n_and can be done without elevation or touching LSASS!_\n\nStealing existing system certificates capable of domain\nauthentication or actively requesting a new certificate\nfrom a system’s context, combined with resource-based\n\n**Machine Persistence (1 year+)**\n\nconstrained delegation or just S4U2Self. Survives\n_machine password changes and can be done without_\n_touching LSASS!_\n\nMisconfigured certificate templates that allow Subject\nAlternative Name (SAN) specification, vulnerable\nCertificate Request Agent templates, vulnerable\n\n**Domain Escalation Path(s)**\n\ntemplate ACLs, the EDITF_ATTRIBUTESUBJECTALTNAME2\nflag being set, vulnerable CA permissions, or NTLM relay\nto web enrollment endpoints.\n\nStealing the certificate authority’s private key and forging\n**Domain Persistence**\ncertificates.\n\nIt is extremely easy for certificate misconfigurations to arise that allow unprivileged domain users\n\n\n-----\n\nenabling Extended Protection for Authentication[199], and stated that they also opened up a bug\nconcerning the template issues and our comments about poor telemetry with the AD CS feature\nteam, who may consider additional design changes in a future release.\n\nFrom a defensive perspective, we strongly recommend organizations audit their AD CS\narchitecture and certificate templates and **_treat CA servers as Tier 0 assets with the same_**\n**_protections as Domain Controllers! It is also not enough to just reset a compromised user's_**\npassword and/or reimage their machine. Passive (and active) certificate theft for domain users\nand computers is trivial given code execution in a user's/computer's context; therefore, any\ncertificates issued for the user/computer must be revoked and well. The **Defensive Guidance**\nsection has more information on how to proactively prevent, detect, and respond to the abuses\ndetailed in this paper.\n\nThe tools the authors developed for this research, Certify (for certification template enumeration\nand request abuse), and ForgeCert (for certificate forgery from CA certs) will be released\napproximately 45 days from the publication date of this paper. The PowerShell toolset to\nenumerate vulnerable templates (PSPKIAudit[200]) is now available.\n\n199 https://msrc-blog.microsoft.com/2009/12/08/extended-protection-for-authentication/\n\n[200 https://github.com/GhostPack/PSPKIAudit](https://github.com/GhostPack/PSPKIAudit)\n\n\nFrom a defensive perspective, we strongly recommend organizations audit their AD CS\narchitecture and certificate templates and **_treat CA servers as Tier 0 assets with the same_**\n**_protections as Domain Controllers! It is also not enough to just reset a compromised user's_**\npassword and/or reimage their machine. Passive (and active) certificate theft for domain users\nand computers is trivial given code execution in a user's/computer's context; therefore, any\ncertificates issued for the user/computer must be revoked and well. The **Defensive Guidance**\nsection has more information on how to proactively prevent, detect, and respond to the abuses\ndetailed in this paper.\n\nThe tools the authors developed for this research, Certify (for certification template enumeration\nand request abuse), and ForgeCert (for certificate forgery from CA certs) will be released\napproximately 45 days from the publication date of this paper. The PowerShell toolset to\nenumerate vulnerable templates (PSPKIAudit[200]) is now available.\n\n\n-----\n\n## Acknowledgements\n\nAll existing work we drew knowledge and inspiration from is listed in the “Prior Work” section.\n\nSpecial thanks to Mark Gamache for co-uncovering many of these abuses and bringing additional\ndetails to our attention.\n\nSpecial thanks to Benjamin Delpy for his existing work in this area and inspiration for us to pursue\nthis research.\n\nSpecial thanks to Ceri Coburn for their contribution to Rubeus that allows for certificate-based\nauthentication without a physical smart card. This greatly facilitated our offensive research.\n\nThank you to Andrew Chiles, Jason Frank, Elad Shamir, and others from SpecterOps for content\nreview.\n\n\nSpecial thanks to Benjamin Delpy for his existing work in this area and inspiration for us to pursue\nthis research.\n\nSpecial thanks to Ceri Coburn for their contribution to Rubeus that allows for certificate-based\nauthentication without a physical smart card. This greatly facilitated our offensive research.\n\nThank you to Andrew Chiles, Jason Frank, Elad Shamir, and others from SpecterOps for content\nreview.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "99fdc3ef-333d-48f5-a4a1-becd788c7b80",
            "created_at": "2022-10-25T15:28:29.802983Z",
            "updated_at": "2022-10-25T15:28:29.802983Z",
            "deleted_at": null,
            "name": "MITRE",
            "url": "https://github.com/mitre-attack/attack-stix-data",
            "description": "MITRE ATT&CK STIX Data",
            "reports": null
        }
    ],
    "references": [
        "https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf"
    ],
    "report_names": [
        "Certified_Pre-Owned.pdf"
    ],
    "threat_actors": [
        {
            "id": "9e767b38-12ae-4ef7-9878-5ce1701066d7",
            "created_at": "2024-05-01T02:03:08.131819Z",
            "updated_at": "2025-03-27T02:05:17.413497Z",
            "deleted_at": null,
            "main_name": "NICKEL ACADEMY",
            "aliases": [
                "COVELLITE ",
                "CTG-2460 ",
                "Diamond Sleet ",
                "Guardians of Peace",
                "HIDDEN COBRA ",
                "High Anonymous",
                "Labyrinth Chollima ",
                "NNPT Group",
                "New Romanic Cyber Army Team",
                "Temp.Hermit ",
                "The Lazarus Group ",
                "UNC577 ",
                "Who Am I?",
                "Whois Team",
                "ZINC ",
                "Black Artemis "
            ],
            "source_name": "Secureworks:NICKEL ACADEMY",
            "tools": [
                " DarkMessenger",
                " Destover",
                " Duuzer",
                " HOPLIGHT",
                " Joanap",
                " KorHigh",
                " LiveJinx",
                " Volgmer",
                "Brambul"
            ],
            "source_id": "Secureworks",
            "reports": null
        },
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1666859774,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1624951773,
    "ts_modification_date": 1624951874,
    "files": {
        "pdf": "https://archive.orkl.eu/81ff6711032c52a95e7c812622b4432600ef83bb.pdf",
        "text": "https://archive.orkl.eu/81ff6711032c52a95e7c812622b4432600ef83bb.txt",
        "img": "https://archive.orkl.eu/81ff6711032c52a95e7c812622b4432600ef83bb.jpg"
    }
}