{
    "id": "8fdf9179-00c5-4d4c-bc31-c2de1de5a21e",
    "created_at": "2022-10-25T16:48:17.000308Z",
    "updated_at": "2025-03-27T02:09:18.06903Z",
    "deleted_at": null,
    "sha1_hash": "29ae5806090f4e3247d509cb94459d1201cd8031",
    "title": "Estudio del análisis de Hive",
    "authors": "",
    "file_creation_date": "2021-12-16T13:59:27Z",
    "file_modification_date": "2021-12-16T14:13:48Z",
    "file_size": 1774501,
    "plain_text": "## Estudio del análisis de Hive\n\n\n-----\n\n**_Diciembre 2021_**\n\n**INCIBE-CERT_ESTUDIO_ANALISIS_HIVE_2021_v1**\n\n\nLa presente publicación pertenece a INCIBE (Instituto Nacional de Ciberseguridad) y está bajo una licencia Reconocimiento-No\ncomercial 3.0 España de Creative Commons. Por esta razón, está permitido copiar, distribuir y comunicar públicamente esta obra\nbajo las siguientes condiciones:\n\n- Reconocimiento. El contenido de este informe se puede reproducir total o parcialmente por terceros, citando su procedencia\ny haciendo referencia expresa tanto a INCIBE o INCIBE-CERT como a su sitio web: [https://www.incibe.es/. Dicho reconocimiento](https://www.incibe.es/)\nno podrá en ningún caso sugerir que INCIBE presta apoyo a dicho tercero o apoya el uso que hace de su obra.\n\n- Uso No Comercial. El material original y los trabajos derivados pueden ser distribuidos, copiados y exhibidos mientras su uso\nno tenga fines comerciales.\n\nAl reutilizar o distribuir la obra, tiene que dejar bien claro los términos de la licencia de esta obra. Alguna de estas condiciones\npuede no aplicarse si se obtiene el permiso de INCIBE-CERT como titular de los derechos de autor. Texto completo de la licencia:\n[https://creativecommons.org/licenses/by-nc-sa/3.0/es/.](https://creativecommons.org/licenses/by-nc-sa/3.0/es/)\n\n\n-----\n\n# Índice\n\n###### ÍNDICE DE FIGURAS ............................................................................................ 3 ÍNDICE DE TABLAS .............................................................................................. 4 1. Sobre este estudio ........................................................................................... 5 2. Organización del documento .......................................................................... 6 3. Introducción ...................................................................................................... 7 4. Informe técnico ................................................................................................. 8\n\n 4.1. Características generales ............................................................................ 8 4.2. Procedimiento de infección .......................................................................... 9 4.3. Análisis detallado ......................................................................................... 9 4.4. Actualizaciones en las muestras más recientes ......................................... 17 4.5. Información sobre el grupo de amenaza .................................................... 25\n\n 5. Referencias ..................................................................................................... 29 Anexo 1: Indicadores de compromiso (IOC) .................................................... 30 Anexo 2: Reglas de detección ........................................................................... 33\n\n Reglas Yara ...................................................................................................... 33 Reglas Sigma .................................................................................................... 35\n\n#### ÍNDICE DE FIGURAS\n\nIlustración 1. Arreglo de cabecera PE para análisis dinámico ........................................................... 9\nIlustración 2. Contenido del fichero hive.bat volcado en disco por la muestra Hive3.exe ............... 10\nIlustración 3. Contenido del fichero shadow.bat volcado en disco por la muestra Hive3.exe ......... 10\nIlustración 4. Árbol de procesos de la muestra Hive3.exe donde se muestra hive.bat en ejecución\n.......................................................................................................................................................... 10\nIlustración 5. Script de volcado en disco por Hive8.exe .................................................................. 10\nIlustración 6. Log en terminal mostrado por las versiones más recientes del ransomware ............ 11\nIlustración 7. Ayuda mostrada por la muestra Hive3.exe ................................................................ 11\nIlustración 8. Ayuda mostrada por la muestra Hive6.exe ................................................................ 11\nIlustración 9. Ayuda mostrada por la muestra Hive9.exe ................................................................ 11\nIlustración 10. Procesado de los parámetros aceptados por comando ........................................... 12\nIlustración 11. Función de inicialización de la configuración del proceso ........................................ 13\nIlustración 12. Fragmento de las instrucciones para el cifrado de la clave generada ..................... 14\nIlustración 13 . Fragmento de instrucciones para volcar la clave cifrada en disco .......................... 15\nIlustración 14. Conjunto de llamadas para la actividad principal del ransomware .......................... 16\nIlustración 15. Creación de hilos para cifrado .................................................................................. 16\nIlustración 16. Llamadas a funciones de renombrado y cifrado ....................................................... 17\nIlustración 17. Listado de opciones admitidas por la muestra del ransomware Hive ...................... 19\nIlustración 18. Listado de hilos de ejecución de Hive en ProcessHacker ........................................ 20\nIlustración 19. Generación de variables de descifrado de cadenas ................................................ 23\nIlustración 20. Descifrado de caracteres .......................................................................................... 23\nIlustración 21. Listado de servicios a detener descifrado ................................................................ 24\nIlustración 22. Descifrado de cadenas con dos buffers ................................................................... 24\nIlustración 23. Bucle de descifrado de cadenas en dos bufers ........................................................ 25\nIlustración 24. Cadena descifrada .................................................................................................... 25\nIlustración 25. Blog de filtraciones del ransomware Hive................................................................. 26\nIlustración 26. Empresa de ciberseguridad con estética considerablemente similar ...................... 26\n\n\n-----\n\nIlustración 27. Dimensiones de extorsión en grupos de ransomware. Fuente: Trend Micro ........... 27\nIlustración 28. Plataforma de extorsión con mensaje de cuenta suspendida .................................. 28\n\n#### ÍNDICE DE TABLAS\n\nTabla 1. Resumen de muestras de ransomware Hive obtenidas ...................................................... 8\nTabla 2. Conjunto de parámetros aceptados por las variantes del ransomware Hive .................... 12\nTabla 3. Conjunto de parámetros aceptados por las variantes del ransomware Hive .................... 17\nTabla 4. Parámetros admitidos por la muestra analizada ................................................................ 19\nTabla 5. Servicios detenidos por la muestra en su configuración por defecto ................................ 21\nTabla 6. Procesos detenidos por la muestra en su configuración por defecto ................................ 21\nTabla 7. Ficheros ignorados independientemente del parámetro aportado .................................... 22\nTabla 8. Indicadores hash y sus respectivos valores....................................................................... 30\nTabla 9. Comandos ejecutados ........................................................................................................ 32\nTabla 10. Servicios de transferencia de archivos utilizados ............................................................ 32\nTabla 11. URLs de sus portales ....................................................................................................... 32\nTabla 12. Resultado de las reglas de Yara ...................................................................................... 35\n\n\n-----\n\n### 1. Sobre este estudio\n\nEste estudio contiene los resultados del análisis conducido sobre distintas muestras en sus\ndistintas versiones del software de cifrado del grupo de ransomware referido como “Hive”,\nobtenidas de fuentes públicas o semipúblicas. El objetivo del estudio reside en reunir la\ninformación necesaria para poder identificar las características propias del código dañino\nde esta familia, así como su comportamiento.\n\nLas acciones realizadas para su elaboración comprenden un análisis estático y dinámico\ndentro de un entorno controlado, junto con una comparación de resultados entre las\nmuestras obtenidas. En cuanto a la metodología seguida, en primer lugar, para la\nrealización del análisis estático, se ha utilizado PEStudio y PEBear, de donde se ha podido\nextraer el lenguaje de programación o packer utilizado (dependiendo del caso), así como\ncadenas de texto con comandos de las muestras. Para desempaquetar las muestras se ha\nutilizado el mismo software de empaquetado, UPX. Tras esto, se ha procedido a un análisis\ndinámico en mayor profundidad, depurando el código paso a paso con IDA Pro en un\nentorno virtualizado, al que se le simula conectividad a Internet con una segunda máquina\nLinux, ejecutando INetSim y configurada como router y como servidor DNS, al tiempo que\nse monitoriza el sistema Windows en el que se ejecuta, mientras se depura y se monitoriza\nparalelamente mediante Sysmon, Procmon y ProcessHacker, los cuales permiten perfilar\ntodas las interacciones de la amenaza con el sistema.\n\n\n-----\n\n### 2. Organización del documento\n\nEste documento consta de una parte 3.- Introducción en la que se expone el tipo de\namenaza que representa el código dañino ransomware de Hive, mencionando su principal\nfinalidad, así como algunas características.\n\nA continuación, en el apartado 4.- Informe técnico se recogen los resultados de los análisis\ndinámicos y estáticos sobre las muestras obtenidas, así como las observaciones\ncomparativas. En el final de este mismo apartado se añade también información relevante\nsobre el grupo que opera tras este código dañino.\n\nFinalmente, el apartado 5.- Referencias aporta las referencias consultadas a lo largo del\nanálisis.\n\nAdicionalmente, el documento cuenta con dos anexos: en el Anexo 1: Indicadores de\ncompromiso (IOC) se recoge el indicador de compromiso (IOC), y el Anexo 2: Reglas de\ndetección consta de las reglas de Yara y Sigma para la detección en disco o en memoria\nde muestras desempaquetadas de esta familia.\n\n\n-----\n\n### 3. Introducción\n\nEl código dañino de Hive ransomware representa una amenaza para todos los usuarios,\nya que implementa las funcionalidades de cifrado de la información de un equipo infectado,\nimposibilitando la recuperación de los datos de forma sencilla. El grupo de individuos, que\noperan tras este código dañino, trata de llevar a cabo una extorsión para la recuperación\nde dicha información, exigiendo un pago y amenazando con publicar parte de la\ninformación robada en el blog que exponen a través de la red Tor, en el caso de no acceder\nal pago exigido.\n\nLas muestras de código dañino se encuentran empaquetadas mediante el software UPX y\nestán implementadas en el lenguaje de programación Golang. Gracias a este análisis se\nha podido confirmar que el grupo continúa desarrollando las funcionalidades del software\nde cifrado, el cual utiliza un algoritmo propio para su tarea principal. Asimismo, se ha podido\nestudiar y comparar el comportamiento de cada una de las versiones identificadas, siendo\ndiferenciadas en un total de tres versiones diferentes.\n\n\n-----\n\n### 4. Informe técnico\n\nA continuación, se detalla la información obtenida durante el análisis de las muestras.\n\n#### 4.1. Características generales\n\n###### Nombre de Aparición Sha256 referencia en\n VirusTotal\n```\n Hive.exe 26-06-2021 e1a7ddbf735d5c1cb9097d7614840c00e5c4d5107fa687c0ab\n                2a2ec8948ef84e\n Hive2.exe 18-07-2021 612e5ffd09ca30ca9488d802594efb5d41c360f7a439df4ae0\n                9b14bce45575ec\n Hive3.exe 25-06-2021 77a398c870ad4904d06d455c9249e7864ac92dda877e288e57\n                18b3c8d9fc6618\n Hive4.exe 22-07-2021 50ad0e6e9dc72d10579c20bb436f09eeaa7bfdbcb5747a2590\n                af667823e85609\n Hive5.exe 01-07-2021 88f7544a29a2ceb175a135d9fa221cbfd3e8c71f32dd6b0939\n                9717f85ea9afd1\n Hive6.exe 14-07-2021 1e21c8e27a97de1796ca47a9613477cf7aec335a783469c5ca\n                3a09d4f07db0ff\n Hive7.exe 02-09-2021 321d0c4f1bbb44c53cd02186107a18b7a44c840a9a5f0a78bd\n                ac06868136b72c\n Hive8.exe 02-08-2021 67ab2abe18b060275763e1d0c73d27c1e61b69097232ed9d04\n                8d41760a4533ef\n Hive9.exe 08-11-2021 b1bfc90de9dcea999dedf285c3d3d7e1901847d84ec297224a\n                0d82720d0ed501\n\n```\n**_Tabla 1. Resumen de muestras de ransomware Hive obtenidas_**\n\nLa primera muestra de Hive fue subida a VirusTotal el día 25 de junio de 2021 (Hive.exe),\nsiendo esta muestra la más antigua publicada de esta familia de ransomware, que se dio\na conocer en la primera mitad de ese mismo mes. Al respecto de las referencias temporales\npara cada muestra, cabe destacar que en ninguna de ellas aparece un valor en el campo\nde la cabecera relativo a la fecha de compilación, por lo que se ha empleado como\nreferencia temporal la fecha de publicación en la plataforma de VirusTotal.\n\nLas muestras del ransomware Hive están desarrolladas en el lenguaje de programación\nconocido como “Golang” o “Go”, y compiladas tanto para arquitecturas de 32-bit como de\n64-bit. Además, a excepción de la muestra pública más reciente que se ha obtenido\n(Hive9.exe), todas las versiones se encuentran comprimidas mediante el empaquetador de\nejecutables UPX. A pesar de su reciente aparición, se ha comprobado que el software de\ncifrado se encuentra en continuo desarrollo, ya que se han identificado ligeras variaciones\nentre las primeras muestras publicadas y las más recientes. Entre las distintas variaciones,\nse ha observado que la principal funcionalidad de las muestras permanece igual, situando\nlas principales diferencias en detalles sobre el comportamiento del cifrado, configurables a\ntravés de parámetros aportados en línea de comandos. Un ejemplo de esto es la posibilidad\n\n|Nombre de referencia|Aparición en VirusTotal|Sha256|\n|---|---|---|\n|Hive.exe|26-06-2021|e1a7ddbf735d5c1cb9097d7614840c00e5c4d5107fa687c0ab 2a2ec8948ef84e|\n|Hive2.exe|18-07-2021|612e5ffd09ca30ca9488d802594efb5d41c360f7a439df4ae0 9b14bce45575ec|\n|Hive3.exe|25-06-2021|77a398c870ad4904d06d455c9249e7864ac92dda877e288e57 18b3c8d9fc6618|\n|Hive4.exe|22-07-2021|50ad0e6e9dc72d10579c20bb436f09eeaa7bfdbcb5747a2590 af667823e85609|\n|Hive5.exe|01-07-2021|88f7544a29a2ceb175a135d9fa221cbfd3e8c71f32dd6b0939 9717f85ea9afd1|\n|Hive6.exe|14-07-2021|1e21c8e27a97de1796ca47a9613477cf7aec335a783469c5ca 3a09d4f07db0ff|\n|Hive7.exe|02-09-2021|321d0c4f1bbb44c53cd02186107a18b7a44c840a9a5f0a78bd ac06868136b72c|\n|Hive8.exe|02-08-2021|67ab2abe18b060275763e1d0c73d27c1e61b69097232ed9d04 8d41760a4533ef|\n|Hive9.exe|08-11-2021|b1bfc90de9dcea999dedf285c3d3d7e1901847d84ec297224a 0d82720d0ed501|\n\n\n-----\n\nde sobrescribir el espacio libre del equipo infectado o de ignorar ficheros con una\nantigüedad especificada.\n\nSi bien todas las muestras publicadas estaban compiladas para sistemas operativos\nWindows, hasta octubre de 2021 no se habían registrado muestras públicas para cifrado\nen Linux, pero sí se conocía desde el mes anterior que el grupo ya había implementado\nversiones de su software de cifrado para entornos Linux, según un informe publicado por\nNetskope.\n\n#### 4.2. Procedimiento de infección\n\nSegún la información publicada hasta la fecha sobre el grupo de operadores, la principal\nvía de entrada es obtenida mediante phishing o spear phishing, si bien es cierto que esta\nha podido variar en determinados casos. Tras el acceso inicial, se conoce que el grupo\nempleará una herramienta de control remoto, tomando como preferencia Cobalt Strike, y\nutilizando ConnectWise como segunda opción, en el caso de no conseguir ejecutar un\n_payload de Cobalt Strike. Después de haber establecido la persistencia mediante alguna_\nde las herramientas mencionadas, y haber conseguido los movimientos laterales deseados\npor el atacante, se utilizarán las mismas herramientas para lanzar a ejecución el software\nde cifrado del ransomware Hive.\n\n#### 4.3. Análisis detallado\n\nComo se ha mencionado, las muestras suelen encontrarse empaquetadas mediante la\nherramienta de código abierto UPX. Aunque las muestras de ransomware en sí mismas no\nimplementan capacidades de antianálisis, el empaquetado de las mismas mediante UPX\nse ha llevado acabo aplicando un parámetro que destruye algunos elementos de la\ncabecera del ejecutable, de tal forma que no es posible ejecutarlo en su forma\ndescomprimida. No obstante, para posibilitar la ejecución y, por tanto, el análisis dinámico\nde la muestra desempaquetada, se ha manipulado dicha cabecera, corrigiendo el único\n“fallo” provocado por UPX relevante para posibilitar su ejecución. Se ha observado que\notras cabeceras han sido modificadas, pero no afectan ni a la ejecución ni al resto de su\ncomportamiento, por lo que no se ha focalizado su estudio en este análisis.\n\n**_Ilustración 1. Arreglo de cabecera PE para análisis dinámico_**\n\nLas primeras versiones de la familia de ransomware vuelcan dos ficheros de scripting en\nel directorio en el que son ejecutadas. El fichero \"hive.bat\" implementa la sencilla tarea de\nintentar eliminar el ejecutable cada segundo, de tal forma que, mientras se encuentre en\nejecución, no será posible, y una vez finalice, podrá borrarlo del equipo infectado con éxito.\nEl otro fichero, \"shadow.bat\", se encarga de ejecutar el comando \"vssadmin.exe delete\n\n\n-----\n\nshadows /all /quiet\" para eliminar las shadow copies del equipo infectado, y autoeliminarse\ninmediatamente.\n\n**_Ilustración 2. Contenido del fichero hive.bat volcado en disco por la muestra Hive3.exe_**\n\n**_Ilustración 3. Contenido del fichero shadow.bat volcado en disco por la muestra Hive3.exe_**\n\n**_Ilustración 4. Árbol de procesos de la muestra Hive3.exe donde se muestra hive.bat en ejecución_**\n\nEn las muestras más actuales han tratado de evitar los volcados de estos ficheros,\nprescindiendo de la funcionalidad de borrado del ejecutable e integrando el borrado de las\n_shadow copies, que el binario realizará mediante llamadas directas a vssadmin.exe y el_\nuso de WMI. No obstante, existe también una versión intermedia (vista en agosto de 2021),\nque todavía pasa por volcar un fichero temporalmente, esta vez con un nombre aleatorio y\nconcentrando todo el conjunto de actividad inmediatamente previa al cifrado.\n\n**_Ilustración 5. Script de volcado en disco por Hive8.exe_**\n\n\n-----\n\nOtra diferencia respecto de las primeras variantes frente a las nuevas versiones detectadas\na partir de agosto de 2021, es el log del proceso, el cual se muestra en un terminal para\nlas nuevas variantes, mientras que en las primeras, por defecto no se muestra en pantalla\nningún tipo de log:\n\n**_Ilustración 6. Log en terminal mostrado por las versiones más recientes del ransomware_**\n\nNo obstante, la diferencia principal que se percibe a priori entre las diferentes versiones\nreside en los parámetros de configuración para el proceso de cifrado, a través de los cuales\nse especifica el comportamiento que ha de tener dicho proceso, acorde a las\nfuncionalidades implementadas. Algunos de los parámetros aceptados en distintas\nvariantes, así como sus valores por defecto, se muestran a continuación en supuesto orden\ncronológico, según la versión del ransomware Hive:\n\n**_Ilustración 7. Ayuda mostrada por la muestra Hive3.exe_**\n\n**_Ilustración 8. Ayuda mostrada por la muestra Hive6.exe_**\n\n**_Ilustración 9. Ayuda mostrada por la muestra Hive9.exe_**\n\n\n-----\n\n|Parámetro|Descripción|\n|---|---|\n|-kill|Listado de procesos a ser terminados por la muestra, procesado como expresión regular. Distinto por defecto según la versión.|\n|-skip|Listado de nombres de fichero a ser ignorados en el proceso de cifrado, también definidos como expresión regular. Por defecto ficheros con extensión “.lnk”.|\n|-skip-before|Fecha limite a partir de la cual no se cifrarán ficheros con fecha de creación más antigua. Por defecto 5 años antes que la fecha actual en el momento de la ejecución.|\n|-stop|Listado de servicios a ser detenidos por la muestra, procesado como expresión regular. Distinto por defecto según la versión.|\n|-t|Numero de hilos distinto para influir en el tiempo o recursos durante el proceso de cifrado. Por defecto 10 hilos.|\n|-no-wipe / -no-clean (según versión)|Opción para no sobrescribir el espacio libre del disco, tras terminar el cifrado de ficheros. Por defecto esta acción está habilitada y creará ficheros del mismo tamaño en el volumen principal hasta llenar el disco para evitar posibles recuperaciones de ficheros.|\n|-grant|Otorgar permisos a todos los ficheros|\n\n\n**_Tabla 2. Conjunto de parámetros aceptados por las variantes del ransomware Hive_**\n\nLa ayuda mostrada en el terminal, junto con los distintos parámetros configurables por línea\nde comandos, podría ser un indicio de que se trata de un servicio de ransomware operado\npor humanos.\n\nEn todos los casos existe un conjunto de instrucciones de preinicialización dentro de la\nfunción main, que recoge la configuración del proceso, teniendo en cuenta los parámetros\ncon los que se ha lanzado a ejecución o aplicando los parámetros por defecto.\n\n**_Ilustración 10. Procesado de los parámetros aceptados por comando_**\n\n\n-----\n\nTras esta preinicialización se llama a la función encryptor.NewApp(), que verdaderamente\niniciará la configuración y preparará el proceso para proceder al cifrado. En el interior de\nesta función se genera una clave aleatoria que será la que utilice para el cifrado de la\ninformación del equipo infectado.\n\n**_Ilustración 11. Función de inicialización de la configuración del proceso_**\n\nSi observamos la Ilustración 11, además de encontrar la llamada a la función responsable\nde generar la clave aleatoria, se aprecia cómo se carga en memoria el propio contenido de\nla nota de rescate, en la que se aporta un usuario y contraseña para su portal de\nnegociación de la extorsión. Esto es indicativo de que cada construcción de cada muestra\nlleva asociado a priori la información de acceso a dicho portal.\n\nUna vez se ha iniciado la configuración, el grueso del proceso comienza su actividad\nmediante la llamada a App.Run(), que a su vez llama en primer lugar a la función\nApp.ExportKey(), y que será la función encargada de cifrar la clave aleatoria generada.\n\n\n-----\n\n**_Ilustración 12. Fragmento de las instrucciones para el cifrado de la clave generada_**\n\nPara el cifrado de la clave generada se utiliza el cifrado RSA-OAEP con una clave pública\nembebida en el código. A continuación, esta clave cifrada se guardará en un fichero en la\nraíz del volumen principal (habitualmente C:\\) del equipo infectado, recibiendo como\nnombre de fichero el hash md5 de dicha clave ya cifrada, convertida a base64 utilizando\nun alfabeto especifico ([A-Z][a-z][0-9]_-), concatenado con las extensiones .key +\n.[extensión de cifrado].\n\n\n-----\n\n**_Ilustración 13 . Fragmento de instrucciones para volcar la clave cifrada en disco_**\n\nFinalmente, las llamadas consecuentes llevarán a cabo la actividad descrita al inicio del\nanálisis, cuyo contenido variará en función de la versión. En el caso de la muestra analizada\na fondo (Hive4.exe), por ejemplo, las funciones App.RemoveItself() y\nApp.RemoveShadowcopies() se encargarán de volcar en disco y ejecutar los ficheros .bat,\nque se encargarán tanto del borrado de las shadow copies como de la eliminación de la\npropia muestra de ransomware una vez terminada su ejecución.\n\n\n-----\n\n**_Ilustración 14. Conjunto de llamadas para la actividad principal del ransomware_**\n\nEn la llamada a la función App.EncryptFiles() no será donde realmente se cifre la\ninformación, sino que en el interior de esta función se realizarán las llamadas a los\ncorrespondientes hilos, aportando como parámetro la dirección de la función\nApp.encryptFilesGroup(), que ejecutarán los distintos hilos en paralelo para cifrar el equipo\ninfectado por bloques de ficheros (siendo 10 hilos el número por defecto para aquellas\nvariantes que admiten especificar este valor).\n\n**_Ilustración 15. Creación de hilos para cifrado_**\n\nEn el interior de esta función se llamará a otra más, App.EncryptFile(), dentro de la cual,\nprimero se renombrará el fichero que se va a cifrar, y después se llamará a la función que\nes realmente responsable de cifrar su contenido.\n\n\n-----\n\n**_Ilustración 16. Llamadas a funciones de renombrado y cifrado_**\n\nTal y como se muestra en la ilustración 16, la función final encargada del cifrado recibe el\nnombre de PrimaryKey.EvaluateSpottedFile() e implementa un algoritmo de cifrado de\ndesarrollo propio relativamente grande, que emplea la clave de 10MB previamente\ngenerada.\n\nPor último, resulta importante matizar que las propias muestras de ransomware no realizan\nningún tipo de contacto con un servidor de mando y control, al tratarse del eslabón final de\nun compromiso y posterior ataque de ransomware.\n\n#### 4.4. Actualizaciones en las muestras más recientes\n\nLa muestra más reciente conocida de este grupo es la siguiente:\n\n###### Muestra analizada Nombre de Fecha de Hash sha256 referencia  publicación \n```\n Hive9.exe 08-11-2021 b1bfc90de9dcea999dedf285c3d3d7e1901847d84ec297\n                  224a0d82720d0ed501\n\n```\n**_Tabla 3. Conjunto de parámetros aceptados por las variantes del ransomware Hive_**\n\n|Nombre de referencia|Fecha de publicación|Hash sha256|\n|---|---|---|\n|Hive9.exe|08-11-2021|b1bfc90de9dcea999dedf285c3d3d7e1901847d84ec297 224a0d82720d0ed501|\n\n\n-----\n\nSe ha llevado a cabo un análisis en mayor profundidad de esta muestra a fin de profundizar\nen el análisis y documentar las diferencias y novedades respecto de las muestras\npreviamente analizadas.\n\nEsta muestra supone una de las más recientes publicadas, por lo que podría tratarse de la\nversión más actualizada en el momento de su publicación el 8 de noviembre de 2021. No\nobstante, como todas las muestras encontradas, no contiene una fecha de compilación en\nlas cabeceras del fichero ejecutable que permita obtener conclusiones más concretas.\n\nA priori, uno de los cambios más notables reside en el hecho de que esta variante no se\nencuentra empaquetada con UPX. Las muestras anteriores, empaquetadas con UPX, no\neran ejecutables tras ser descomprimidas, a no ser que se aplicara una modificación en las\ncabeceras del fichero ejecutable. Dado que esta muestra fue subida a fuentes públicas en\nestado desempaquetado, y con las cabeceras aparentemente íntegras y funcionales, es\nprobable que los atacantes hayan dejado de utilizar UPX para empaquetar los binarios. El\nefecto inmediato que esto provoca es que al infectar un equipo con un binario\nempaquetado, el tamaño del mismo será considerablemente menor. El tamaño de las\nmuestras de Hive ransomware empaquetadas oscila entre los 700 y los 900KB, mientras\nque el tamaño de las muestras sin compresión (como la analizada en el presente informe)\nse sitúa entre los 2,5 y los 3,5MB. Por un lado, este hecho provoca que se puedan generar\nfirmas de detección de la amenaza más eficaces, pero por otra parte, debido al tamaño de\nlos binarios desarrollados en Golang, es probable que en algunos entornos la solución\nantivirus ignore ficheros de tamaños tan grandes para evitar generar problemas de\nrendimiento en los equipos, no siendo por esto capaz de detectar esta muestra.\n\nAdicionalmente, para dificultar el análisis de esta nueva variante se han cifrado todas las\ncadenas de texto embebidas en el binario. A pesar de esto, el comportamiento y el código\nque implementa la mayor parte de la actividad de la muestra no ha variado.\n\nUna de las primeras variaciones observables consiste en que, mientras que la mayoría de\nmuestras anteriores utilizaban la extensión “.hive” para los ficheros cifrados, esta muestra\nutiliza la extensión “.cggbt”.\n\nPor otra parte, al igual que en versiones anteriores de la familia de _ransomware, esta_\namenaza puede recibir por parámetro listados de servicios o procesos, que el ransomware\ndetendrá antes de cifrar, para asegurar que tiene acceso a todos los ficheros y que ningún\nfichero será recuperable.\n\nEstos listados de procesos o servicios los espera como una única cadena de texto que\nimplemente una única expresión regular; es decir, en el conjunto de servicios especificado,\npor ejemplo, se deberán separar los distintos valores mediante el uso del carácter “|”,\nsiguiendo la sintaxis habitual para expresiones regulares.\n\nDe igual modo, los ficheros que el ransomware debe ignorar durante el proceso de cifrado,\ntambién se especifican mediante una única expresión regular en la que se pueden separar\nlos distintos elementos utilizando el carácter “|”.\n\n\n-----\n\n**_Ilustración 17. Listado de opciones admitidas por la muestra del ransomware Hive_**\n\nLa t4 muestra el resumen de los parámetros admitidos por la muestra analizada:\n\n###### Parámetro  Descripción \n**-kill** Listado de procesos a ser terminados por la muestra, procesado como\nexpresión regular.\n**-skip** Listado de nombres de fichero a ser ignorados en el proceso de\ncifrado, también definidos como expresión regular.\n**-stop** Listado de servicios a ser detenidos por la muestra, procesado como\nexpresión regular.\n**-no-wipe** Opción para no sobrescribir el espacio libre del disco, tras\nterminar el cifrado de ficheros. Por defecto esta acción está\nhabilitada y creará ficheros del mismo tamaño en el volumen\nprincipal hasta llenar el disco para evitar posibles\nrecuperaciones de ficheros.\n**-grant** Otorgar permisos a todos los ficheros\n\n**_Tabla 4. Parámetros admitidos por la muestra analizada_**\n\nDestaca el hecho de que en esta muestra se ha eliminado la posibilidad de evitar el cifrado\nde ficheros creados con anterioridad a una fecha, opción que se encontraba disponible en\nlas muestras más antiguas con la utilización del modificador “-skip-before [fecha]”. También\nse ha eliminado el modificador “-t [int]” para controlar el número de hilos de ejecución\nencargados del cifrado de archivos. Durante la ejecución de la presente muestra se\ninstanciarán 10 hilos en total para llevar a cabo el cifrado de la información en el equipo\ninfectado. Para el resto de tareas se instanciarán otros 5 hilos más. Por otro lado, se ha\nañadido del modificador “-grant”, que intenta modificar los permisos de ficheros bloqueados\npor ACL para posibilitar su cifrado.\n\n|Parámetro|Descripción|\n|---|---|\n|-kill|Listado de procesos a ser terminados por la muestra, procesado como expresión regular.|\n|-skip|Listado de nombres de fichero a ser ignorados en el proceso de cifrado, también definidos como expresión regular.|\n|-stop|Listado de servicios a ser detenidos por la muestra, procesado como expresión regular.|\n|-no-wipe|Opción para no sobrescribir el espacio libre del disco, tras terminar el cifrado de ficheros. Por defecto esta acción está habilitada y creará ficheros del mismo tamaño en el volumen principal hasta llenar el disco para evitar posibles recuperaciones de ficheros.|\n|-grant|Otorgar permisos a todos los ficheros|\n\n\n-----\n\n**_Ilustración 18. Listado de hilos de ejecución de Hive en ProcessHacker_**\n\nComo novedad en sus características por defecto, en esta variable se incluyen el servicio\n_LanmanWorkstation dentro del listado de servicios que el proceso detendrá antes de_\ncomenzar el cifrado del equipo infectado. En la siguiente tabla se puede observar el listado\nde servicios que esta muestra intentará detener antes de cifrar por defecto:\n\n###### Conjunto total de servicios detenidos por defecto\n```\nacronis KAVFSGT postgres tomcat\n\n```\n|acronis|KAVFSGT|postgres|tomcat|\n|---|---|---|---|\n|AcrSch2Svc|kavfsslp|QBCFMonitorService|TrueKey|\n|Antivirus|klnagent|QBFCService|UI0Detect|\n|ARSM|LanmanWorkstation|QBIDPService|veeam|\n|AVP|macmnsvc|redis|vmware|\n|backup|masvc|report|vss|\n|bedbg|MBAMService|RESvc|W3Svc|\n|CAARCUpdateSvc|MBEndpointAgent|RTVscan|wbengine|\n|CASAD2DWebSvc|McAfee|sacsvr|WebClient|\n|ccEvtMgr|McShield|SamSs|wrapper|\n|ccSetMgr|McTaskManager|SAVAdminService|WRSVC|\n|Culserver|memtas|SavRoam|WSBExchange|\n|dbeng8|mepocs|SAVService|YooIT|\n|dbsrv12|mfefire|SDRSVC|zhudongfangyu|\n|DCAgent|mfemms|SepMasterService|Zoolz|\n|DefWatch|mfevtp|ShMonitor Smcinst SmcService SMTPSvc SNAC SntpService||\n|EhttpSrv|MMS|||\n|ekrn|MsDtsServer|||\n|Enterprise Client Service|MsDtsServer100|||\n|EPSecurityService|MsDtsServer110|||\n|EPUpdateService|msexchange|||\n\n\n-----\n\n|EraserSvc11710|msmdsrv|sophos sql SstpSvc stc_raw_agent ^svc swi_ Symantec TmCCSF tmlisten|\n|---|---|---|\n|EsgShKernel|MSOLAP||\n|ESHASRV|MVArmor||\n|FA_Scheduler|MVarmor64||\n|firebird|NetMsmqActivator||\n|IISAdmin|ntrtscan||\n|IMAP4Svc|oracle||\n|Intuit|PDVFSService||\n|KAVFS|POP3Svc||\n\n\n**_Tabla 5. Servicios detenidos por la muestra en su configuración por defecto_**\n\nEl listado de procesos también ha incrementado de tamaño respecto al resto de muestras,\nañadiendo nombres de la suite ofimática de Microsoft y nombres de los clientes de correo\nmás conocidos. En la siguiente tabla se puede encontrar el listado completo de patrones\nde nombre de proceso que intentará cerrar esta muestra antes de cifrar:\n\n###### Conjunto total de procesos detenidos por defecto\n```\n    agntsvc mspub sqbcoreservice\n    sql mydesktop steam\n    CNTAoSMgr Ntrtscan synctime\n    dbeng50 ocautoupds tbirdconfig\n    dbsnmp ocomm thebat\n    encsvc ocssd thunderbird\n    excel onenote tmlisten\n    firefoxconfig oracle visio\n    infopath outlook word\n    mbamtray PccNTMon xfssvccon\n    msaccess powerpnt zoolz\n\n```\n**_Tabla 6. Procesos detenidos por la muestra en su configuración por defecto_**\n\nPor otra parte, mantiene el modificador “-skip”, el cual recibe un listado de extensiones o\npalabras con las que crea una expresión regular, y los ficheros cuya ruta completa cumplan\nla expresión regular, son ignorados en el momento del cifrado. En este caso, la diferencia\ncon otras muestras radica en que no cuenta con la extensión por defecto “.lnk” en dicho\nparámetro, que si se podía observar en otras versiones de la amenaza. Sin embargo, la\namenaza cuenta con un listado interno de 88 palabras (la mayoría de ellas extensiones),\nque descifra durante su ejecución parar ignorar distintos ficheros, independientemente de\nlo que introduzca con este parámetro por línea de comandos.\n\n|agntsvc|mspub|sqbcoreservice|\n|---|---|---|\n|sql|mydesktop|steam|\n|CNTAoSMgr|Ntrtscan|synctime|\n|dbeng50|ocautoupds|tbirdconfig|\n|dbsnmp|ocomm|thebat|\n|encsvc|ocssd|thunderbird|\n|excel|onenote|tmlisten|\n|firefoxconfig|oracle|visio|\n|infopath|outlook|word|\n|mbamtray|PccNTMon|xfssvccon|\n|msaccess|powerpnt|zoolz|\n\n|Ficheros|ignorados|\n|---|---|\n|adv|scr|\n|Ani|shs|\n|bat|spl|\n|bin|sys|\n|cab|theme|\n|cmd|themepack|\n|com|url|\n|cpl|wpx|\n\n\n-----\n\n|cur|C:\\\\Windows|\n|---|---|\n|deskthemepack|:386|\n|diagcab|autorun.inf|\n|diagcfg|bootfont.bin|\n|diagpkg|boot.ini|\n|dll|bootsect.bak|\n|drv|desktop.ini|\n|exe|iconcache.db|\n|hlp|ntldr|\n|hrmlog|ntuser.dat|\n|hta|ntuser.dat.log|\n|icl|ntuser.ini|\n|icns|thumbs.db)$|\n|ico|$recycle.bin|\n|ics|$windows.~bt|\n|idx|$windows.~ws|\n|ini|All users|\n|key|appdata|\n|lnk|application data|\n|lock|boot|\n|log|google|\n|mod|intel|\n|mpa|Microsoft|\n|mp3|mozilla|\n|msc|Mozilla|\n|msi|Msbuild|\n|msp|msocache|\n|msstyles|perflogs|\n|msu|system volume information|\n|nls|tor browser|\n|nomedia|windows|\n|ocx|Windows nt|\n|prf|windows.old|\n|ps1|$\\\\Windows\\\\|\n|rom|\\\\ADMIN\\$|\n|rtp|\\\\IPC\\$|\n\n\n**_Tabla 7. Ficheros ignorados independientemente del parámetro aportado_**\n\nJunto con el hecho de abandonar el uso de UPX como empaquetador, uno de los cambios\nmás notables de esta muestra, con respecto a las muestras anteriores, es el cifrado de\ntodas sus cadenas utilizando dos algoritmos distintos que dependen de la extensión de la\ncadena. Para cadenas de larga extensión contiene un buffer del doble del tamaño de cada\ncadena, el cual divide _byte a_ _byte en una variable distinta, generando una función muy_\ngrande, que dificulta el análisis en herramientas como IDA Pro o Ghidra.\n\n\n-----\n\n**_Ilustración 19. Generación de variables de descifrado de cadenas_**\n\nUna vez generadas todas las variables, opera con grupos de dos de ellas, en unos casos\ncon una operación de “xor”, en otros realiza una resta, y en otros una suma, componiendo\nasí la cadena de texto descifrada con operaciones distintas para cada carácter:\n\n**_Ilustración 20. Descifrado de caracteres_**\n\nLa función retorna la cadena y entre sus parámetros devuelve la longitud final del mismo.\n\nEn el caso de la función del ejemplo, descifra el listado de servicios a detener antes de\ncifrar, pero se puede observar una función con una lógica parecida para el listado de\nprocesos a parar antes de cifrar.\n\n\n-----\n\n**_Ilustración 21. Listado de servicios a detener descifrado_**\n\nPara cadenas más cortas, como por ejemplo la definición de las funcionalidades de cada\ncomando, utiliza una técnica mucho más común en malware, que consiste en almacenar\nen la pila dos buffers del mismo tamaño:\n\n**_Ilustración 22. Descifrado de cadenas con dos buffers_**\n\nY posteriormente, realizar una misma operación aritmética con cada offset de ambos, en\neste caso una suma:\n\n\n-----\n\n**_Ilustración 23. Bucle de descifrado de cadenas en dos bufers_**\n\nDe esta manera, se compone una única cadena a partir de los dos bloques de contenido\nbinario.\n\nEn este caso, la función de ejemplo descifra la descripción del comando de parada de\nservicios, aunque se pueden encontrar funciones con el mismo algoritmo para el resto de\ncomandos del binario.\n\n**_Ilustración 24. Cadena descifrada_**\n\nDebido a las funciones extra de descifrado de cadenas, y de todas las comprobaciones de\nerror requeridas por la gestión de estas cadenas, el binario final tiene un aspecto diferente\nen varias de sus partes. Además, esto podría provocar la obsolescencia de muchas de las\nfirmas de detección generadas para muestras anteriores, por lo que se han generado\nnuevas reglas Yara, que se pueden encontrar en Anexo II: Reglas de detección del\npresente documento. De la misma forma, a partir de los procesos generados por esta\namenaza, se han generado cuatro reglas Sigma, que pueden ser traducidas a reglas de la\nmayoría de soluciones EDR recientes para la detección de la creación de estos procesos\nsospechosos.\n\nPor último, cabe destacar una última diferencia identificada en esta muestra respecto de la\nmayoría de las anteriores, y es que no realiza un vaciado de la papelera de reciclaje, por\nlo que al no cifrar su contenido los elementos situados en la papelera de reciclaje de\nWindows son recuperables.\n\n#### 4.5. Información sobre el grupo de amenaza\n\nEl primer incidente registrado data del 14 de junio de 2021, dirigido a una empresa\nconsultora inmobiliaria con sede en Canadá. Resultó finalmente en la publicación de la\ninformación exfiltrada en el blog del grupo de _ransomware específico para esto,_\nnormalmente incluido en la nota de rescate.\n\n\n-----\n\n**_Ilustración 25. Blog de filtraciones del ransomware Hive_**\n\nCuriosamente, existen similitudes apreciables en la estética “comercial” o “corporativa” del\ngrupo de ransomware con la de una empresa estadounidense, precisamente dedicada al\námbito de la ciberseguridad.\n\n**_Ilustración 26. Empresa de ciberseguridad con estética considerablemente similar_**\n\nA diferencia de otros muchos grupos de ransomware que claman no atacar hospitales, este\ngrupo parece haber causado especial impacto en este sector tras varios ataques a distintas\nentidades del mismo, llegando a filtrar incluso información personal de pacientes médicos.\n\n\n-----\n\nEn este sentido, mediante la publicación de la información robada o la amenaza de hacerlo,\nHive se sitúa en el marco de la doble extorsión para incentivar el pago del rescate.\n\n**_Ilustración 27. Dimensiones de extorsión en grupos de ransomware. Fuente: Trend Micro_**\n\nPara el proceso de negociación del rescate, tal y como se ha comentado, también se ofrece\nun portal al cual se accede mediante unas credenciales facilitadas en la nota de rescate\nvolcada en disco tras el cifrado. Además, los atacantes parecen llevar a cabo labores de\nmantenimiento y gestión de la plataforma para evitar el uso de las credenciales de un\nincidente por parte de la comunidad de investigadores y analistas, una vez la muestra de\nla campaña es publicada.\n\n\n-----\n\n**_Ilustración 28. Plataforma de extorsión con mensaje de cuenta suspendida_**\n\n\n-----\n\n### 5. Referencias\n\n [https://blogs.blackberry.com/en/2021/07/threat-thursday-hive-ransomware](https://blogs.blackberry.com/en/2021/07/threat-thursday-hive-ransomware)\n [https://www.sentinelone.com/labs/hive-attacks-analysis-of-the-human-operated-](https://www.sentinelone.com/labs/hive-attacks-analysis-of-the-human-operated-ransomware-targeting-healthcare/)\n\n[ransomware-targeting-healthcare/](https://www.sentinelone.com/labs/hive-attacks-analysis-of-the-human-operated-ransomware-targeting-healthcare/)\n [https://www.netskope.com/blog/hive-ransomware-actively-targeting-hospitals](https://www.netskope.com/blog/hive-ransomware-actively-targeting-hospitals)\n [https://www.ic3.gov/Media/News/2021/210825.pdf](https://www.ic3.gov/Media/News/2021/210825.pdf)\n [https://securityaffairs.co/wordpress/123931/malware/hive-ransomware-linux-](https://securityaffairs.co/wordpress/123931/malware/hive-ransomware-linux-freebsd.html)\n\n[freebsd.html](https://securityaffairs.co/wordpress/123931/malware/hive-ransomware-linux-freebsd.html)\n [https://upx.github.io/](https://upx.github.io/)\n [https://pkg.go.dev/](https://pkg.go.dev/)\n [https://cybernews.com/news/new-ransomware-group-hive-leaks-altus-group-sample-](https://cybernews.com/news/new-ransomware-group-hive-leaks-altus-group-sample-files/)\n\n[files/](https://cybernews.com/news/new-ransomware-group-hive-leaks-altus-group-sample-files/)\n\n\n-----\n\n### Anexo 1: Indicadores de compromiso (IOC)\n\n###### Indicador  Valor \n```\nSha256 612e5ffd09ca30ca9488d802594efb5d41c360f7a439df4ae09b14bce45575ec\nSha256 77a398c870ad4904d06d455c9249e7864ac92dda877e288e5718b3c8d9fc6618\nSha256 50ad0e6e9dc72d10579c20bb436f09eeaa7bfdbcb5747a2590af667823e85609\nSha256 cf80ffac9ddb379e041834b06c07fc99f8885948fbc6d5c0c5ee79680e2bbe0e\nSha256 88f7544a29a2ceb175a135d9fa221cbfd3e8c71f32dd6b09399717f85ea9afd1\nSha256 e1a7ddbf735d5c1cb9097d7614840c00e5c4d5107fa687c0ab2a2ec8948ef84e\nSha256 b1bfc90de9dcea999dedf285c3d3d7e1901847d84ec297224a0d82720d0ed501\nSha256 1e21c8e27a97de1796ca47a9613477cf7aec335a783469c5ca3a09d4f07db0ff\nSha256 321d0c4f1bbb44c53cd02186107a18b7a44c840a9a5f0a78bdac06868136b72c\nSha256 67ab2abe18b060275763e1d0c73d27c1e61b69097232ed9d048d41760a4533ef\nSha256 d158f9d53e7c37eadd3b5cc1b82d095f61484e47eda2c36d9d35f31c0b4d3ff8\nSha256 d2c217e9f3bc93d5f428524e80d0ef89a0b5b1f84add890ff7dc287ea460950b\nSha256 321d0c4f1bbb44c53cd02186107a18b7a44c840a9a5f0a78bdac06868136b72c\nMd5 bee9ba70f36ff250b31a6fdf7fa8afeb\nSha1 77d7614156607b68265b122fb35a1d408625cb96\nSha1 10bd0f1d3122d6575e882ba8f025eb11b0a95b61\nIPv4 176.123.8.228\n\n```\n**_Tabla 8. Indicadores hash y sus respectivos valores_**\n\n###### Comandos ejecutados (únicamente en versiones más recientes)\n```\nnet.exe stop \"NetMsmqActivator\" /y\nC:\\Windows\\system32\\net1 stop \"NetMsmqActivator\" /y\nnet.exe stop \"SamSs\" /y\nC:\\Windows\\system32\\net1 stop \"SamSs\" /y\nnet.exe stop \"SDRSVC\" /y\nC:\\Windows\\system32\\net1 stop \"SDRSVC\" /y\nnet.exe stop \"SstpSvc\" /y\nC:\\Windows\\system32\\net1 stop \"SstpSvc\" /y\nnet.exe stop \"UI0Detect\" /y\nC:\\Windows\\system32\\net1 stop \"UI0Detect\" /y\nnet.exe stop \"VSS\" /y\nC:\\Windows\\system32\\net1 stop \"VSS\" /y\nnet.exe stop \"wbengine\" /y\nC:\\Windows\\system32\\net1 stop \"wbengine\" /y\nnet.exe stop \"WebClient\" /y\nC:\\Windows\\system32\\net1 stop \"WebClient\" /y\nsc.exe config \"NetMsmqActivator\" start= disabled\nsc.exe config \"SamSs\" start= disabled\nsc.exe config \"SDRSVC\" start= disabled\nsc.exe config \"SstpSvc\" start= disabled\nsc.exe config \"UI0Detect\" start= disabled\nsc.exe config \"VSS\" start= disabled\nsc.exe config \"wbengine\" start= disabled\n\n```\n|Indicador|Valor|\n|---|---|\n|Sha256|612e5ffd09ca30ca9488d802594efb5d41c360f7a439df4ae09b14bce45575ec|\n|Sha256|77a398c870ad4904d06d455c9249e7864ac92dda877e288e5718b3c8d9fc6618|\n|Sha256|50ad0e6e9dc72d10579c20bb436f09eeaa7bfdbcb5747a2590af667823e85609|\n|Sha256|cf80ffac9ddb379e041834b06c07fc99f8885948fbc6d5c0c5ee79680e2bbe0e|\n|Sha256|88f7544a29a2ceb175a135d9fa221cbfd3e8c71f32dd6b09399717f85ea9afd1|\n|Sha256|e1a7ddbf735d5c1cb9097d7614840c00e5c4d5107fa687c0ab2a2ec8948ef84e|\n|Sha256|b1bfc90de9dcea999dedf285c3d3d7e1901847d84ec297224a0d82720d0ed501|\n|Sha256|1e21c8e27a97de1796ca47a9613477cf7aec335a783469c5ca3a09d4f07db0ff|\n|Sha256|321d0c4f1bbb44c53cd02186107a18b7a44c840a9a5f0a78bdac06868136b72c|\n|Sha256|67ab2abe18b060275763e1d0c73d27c1e61b69097232ed9d048d41760a4533ef|\n|Sha256|d158f9d53e7c37eadd3b5cc1b82d095f61484e47eda2c36d9d35f31c0b4d3ff8|\n|Sha256|d2c217e9f3bc93d5f428524e80d0ef89a0b5b1f84add890ff7dc287ea460950b|\n|Sha256|321d0c4f1bbb44c53cd02186107a18b7a44c840a9a5f0a78bdac06868136b72c|\n|Md5|bee9ba70f36ff250b31a6fdf7fa8afeb|\n|Sha1|77d7614156607b68265b122fb35a1d408625cb96|\n|Sha1|10bd0f1d3122d6575e882ba8f025eb11b0a95b61|\n|IPv4|176.123.8.228|\n\n\n-----\n\n```\nsc.exe config \"WebClient\" start= disabled\nreg.exe add \"HKLM\\System\\CurrentControlSet\\Services\\SecurityHealthService\" /v\n\"Start\" /t REG_DWORD /d \"4\" /f\nreg.exe delete \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\" /v\n\"DisableAntiSpyware\" /t REG_DWORD /d \"1\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\" /v\n\"DisableAntiVirus\" /t REG_DWORD /d \"1\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\MpEngine\" /v\n\"MpEnablePus\" /t REG_DWORD /d \"0\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\Real-Time\nProtection\" /v \"DisableBehaviorMonitoring\" /t REG_DWORD /d \"1\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\Real-Time\nProtection\" /v \"DisableIOAVProtection\" /t REG_DWORD /d \"1\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\Real-Time\nProtection\" /v \"DisableOnAccessProtection\" /t REG_DWORD /d \"1\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\Real-Time\nProtection\" /v \"DisableRealtimeMonitoring\" /t REG_DWORD /d \"1\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\Real-Time\nProtection\" /v \"DisableScanOnRealtimeEnable\" /t REG_DWORD /d \"1\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\Reporting\" /v\n\"DisableEnhancedNotifications\" /t REG_DWORD /d \"1\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\SpyNet\" /v\n\"DisableBlockAtFirstSeen\" /t REG_DWORD /d \"1\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\SpyNet\" /v\n\"SpynetReporting\" /t REG_DWORD /d \"0\" /f\nreg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\SpyNet\" /v\n\"SubmitSamplesConsent\" /t REG_DWORD /d \"0\" /f\nreg.exe add\n\"HKLM\\System\\CurrentControlSet\\Control\\WMI\\Autologger\\DefenderApiLogger\" /v\n\"Start\" /t REG_DWORD /d \"0\" /f\nreg.exe add\n\"HKLM\\System\\CurrentControlSet\\Control\\WMI\\Autologger\\DefenderAuditLogger\" /v\n\"Start\" /t REG_DWORD /d \"0\" /f\nschtasks.exe /Change /TN \"Microsoft\\Windows\\ExploitGuard\\ExploitGuard MDM\npolicy Refresh\" /Disable\nschtasks.exe /Change /TN \"Microsoft\\Windows\\Windows Defender\\Windows Defender\nCache Maintenance\" /Disable\nschtasks.exe /Change /TN \"Microsoft\\Windows\\Windows Defender\\Windows Defender\nCleanup\" /Disable\nschtasks.exe /Change /TN \"Microsoft\\Windows\\Windows Defender\\Windows Defender\nScheduled Scan\" /Disable\nschtasks.exe /Change /TN \"Microsoft\\Windows\\Windows Defender\\Windows Defender\nVerification\" /Disable\nreg.exe delete\n\"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\StartupApproved\\Run\"\n/v \"Windows Defender\" /f\nreg.exe delete \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /v\n\"Windows Defender\" /f\n\n```\n\n-----\n\n```\nreg.exe delete \"HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" /v\n\"WindowsDefender\" /f\nreg.exe delete \"HKCR\\*\\shellex\\ContextMenuHandlers\\EPP\" /f\nreg.exe delete \"HKCR\\Directory\\shellex\\ContextMenuHandlers\\EPP\" /f\nreg.exe delete \"HKCR\\Drive\\shellex\\ContextMenuHandlers\\EPP\" /f\nreg.exe add \"HKLM\\System\\CurrentControlSet\\Services\\WdBoot\" /v \"Start\" /t\nREG_DWORD /d \"4\" /f\nreg.exe add \"HKLM\\System\\CurrentControlSet\\Services\\WdFilter\" /v \"Start\" /t\nREG_DWORD /d \"4\" /f\nreg.exe add \"HKLM\\System\\CurrentControlSet\\Services\\WdNisDrv\" /v \"Start\" /t\nREG_DWORD /d \"4\" /f\nreg.exe add \"HKLM\\System\\CurrentControlSet\\Services\\WdNisSvc\" /v \"Start\" /t\nREG_DWORD /d \"4\" /f\nreg.exe add \"HKLM\\System\\CurrentControlSet\\Services\\WinDefend\" /v \"Start\" /t\nREG_DWORD /d \"4\" /f\nreg.exe add \"HKLM\\System\\CurrentControlSet\\Services\\SecurityHealthService\" /v\n\"Start\" /t REG_DWORD /d \"4\" /f\nvssadmin.exe delete shadows /all /quiet\nwevtutil.exe cl system\nwevtutil.exe cl security\nwevtutil.exe cl application\nwmic.exe SHADOWCOPY /nointeractive\nwmic.exe shadowcopy delete\nbcdedit.exe /set {default} bootstatuspolicy ignoreallfailures\nbcdedit.exe /set {default} recoveryenabled no\ncmd.exe /c \"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\" RemoveDefinitions -All\n\"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\" -RemoveDefinitions -All\ncmd.exe /c powershell Set-MpPreference -DisableIOAVProtection $true\npowershell Set-MpPreference -DisableIOAVProtection $true\ncmd.exe /c powershell Set-MpPreference -DisableRealtimeMonitoring $true\npowershell Set-MpPreference -DisableRealtimeMonitoring $true\n\n```\n**_Tabla 9. Comandos ejecutados_**\n\n###### Servicios de transferencia de ficheros empleados\n```\nhttps://anonfiles.com\nhttps://mega.nz\nhttps://send.exploit.in\nhttps://Ufile.io\nhttps://www.sendspace.com\n\n```\n**_Tabla 10. Servicios de transferencia de archivos utilizados_**\n\n###### URL de sus portales\n```\nhxxp[:]//hiveleakdbtnp76ulyhi52eag6c6tyc3xw7ez7iqy6wc34gd2nekazyd[.]onion/\nhxxp[:]//hivecust6vhekztbqgdnkks64ucehqacge3dij3gyrrpdp57zoq3ooqd[.]onion/\n\n```\n**_Tabla 11. URLs de sus portales_**\n\n\n-----\n\n### Anexo 2: Reglas de detección\n\n##### Reglas Yara\n\n```\nimport \"pe\"\nrule Mal_Ransom_Hive_2021_unpacked\n{\n  meta:\n    description = \"Detects unpacked Hive ransomware\"\n    author = \"Blackberry Threat Research team\"\n    date = \"2021-06-07\"\n  strings:\n    //google.com/encryptor.(*App).KillProcesses\n    $h = {676f6f676c652e636f6d2f656e63727970746f722e282a417070292e4b696c6c50726f636573736573}\n    //google.com/encryptor.(*App).StopServices\n    $h1 = {676f6f676c652e636f6d2f656e63727970746f722e282a417070292e53746f705365727669636573}\n    //google.com/encryptor.(*App).RemoveShadowCopies\n    $h2 =\n{676f6f676c652e636f6d2f656e63727970746f722e282a417070292e52656d6f7665536861646f77436f70696573}\n    //google.com/encryptor.(*App).EncryptFiles\n    $h3 = {676f6f676c652e636f6d2f656e63727970746f722e282a417070292e456e637279707446696c6573}\n    //google.com/encryptor.(*App).encryptFilesGroup\n    $h4 =\n{676f6f676c652e636f6d2f656e63727970746f722e282a417070292e656e637279707446696c657347726f7570}\n    //google.com/encryptor.(*App).ScanFiles\n    $h5 = {676f6f676c652e636f6d2f656e63727970746f722e282a417070292e5363616e46696c6573}\n    //google.com/encryptor.(*App).EraseKey\n    $h6 = {676f6f676c652e636f6d2f656e63727970746f722e282a417070292e45726173654b6579}\n    //google.com/encryptor.(*App).RemoveItself\n    $h7 = {676f6f676c652e636f6d2f656e63727970746f722e282a417070292e52656d6f7665497473656c66}\n    //http://hivecust6vhekztbqgdnkks64ucehqacge3dij3gyrrpdp57zoq3ooqd.onion/\n    $h8 =\n{687474703a2f2f6869766563757374367668656b7a74627167646e6b6b7336347563656871616367653364696a336779\n727270647035377a6f71336f6f71642e6f6e696f6e2f}\n    //http://hiveleakdbtnp76ulyhi52eag6c6tyc3xw7ez7iqy6wc34gd2nekazyd.onion/\n    $h9 =\n{687474703a2f2f686976656c65616b6462746e703736756c796869353265616736633674796333787737657a37697179\n36776333346764326e656b617a79642e6f6e696f6e2f}\n  condition:\n  uint16(0) == 0x5a4d and\n  all of ($h*)\n}\n\n```\n\n-----\n\n```\nrule Win32_Ransomware_Hive\n{\n   meta:\n      description = \"Detects unpacked 32-bit Hive Ransomware\"\n      author = \"Netskope Threat Labs\"\n   strings:\n      $go = \"GO build\" nocase\n      $str00 = \"EncryptFile\"\n      $str01 = \"EncryptFiles\"\n      $str02 = \"EraseKey\"\n      $str03 = \"ExportKey\"\n      $str04 = \"KillProcess\"\n      $str05 = \"Notify\"\n      $str06 = \"PreNotify\"\n      $str07 = \"RemoveItself\"\n      $str08 = \"RemoveShadowCopies\"\n      $str09 = \"ScanFiles\"\n      $str10 = \"StopServices\"\n   condition:\n      uint16(0) == 0x5a4d\n      and $go and 8 of ($str*)\n}\n\n```\n```\nrule HiveRansomware\n{\n meta:\n   description = \"Hive Ransomware code pattern\"\n strings:\n  $str_80 = {49 3B 66 10}\n  $str_8a = {48 83 EC 30 48 89 6C 24 28 48 8D 6C 24 28 44 0F 11 7C 24 18 66 90 48\n85 C9}\n  $str_a9 = {48 83 F9 01}\n  $str_af = {48 89 5C 24 40 48 85 C0}\n  $str_b9 = {48 83 F9 20}\n  $str_bf = {48 89 4C 24 48 48 89 C8 31 DB 31 C9 ?? ?? ?? ?? ?? 48 8B 4C 24 48 48\n8B 5C 24 40}\n  $str_da = {48 89 44 24 18 48 89 4C 24 20 ?? ?? ?? ?? ?? 48 8B 5C 24 20 48 8B 44\n24 18 48 8B 6C 24 28 48 83 C4 30 C3}\n  $str_fd = {0F B6 0B 48 8D 15 39 0C 31 00 48 8D 0C CA 48 89 4C 24 18 48 C7 44 24\n20 01 00 00 00 48 8B 44 24 18 BB 01 00 00 00 48 8B 6C 24 28 48 83 C4 30 C3}\n  $str_2d = {44 0F 11 7C 24 18 31 C0 31 DB 48 8B 6C 24 28 48 83 C4 30 C3}\n  $str_41 = {48 89 44 24 08 48 89 5C 24 10 48 89 4C 24 18 ?? ?? ?? ?? ??}\n condition:\n\n```\n\n-----\n\n|Resultados|de las reglas Yara|\n|---|---|\n|Nombre de la regla|Detecciones|\n|Mal_Ransom_Hive_2021_unpacked|Hive.exe (publicada ya desempaquetada)|\n||Hive2.exe (publicada ya desempaquetada)|\n||Hive3.exe desempaquetada|\n||Hive4.exe (publicada ya desempaquetada)|\n||Hive5.exe desempaquetada|\n|Win32_Ransomware_Hive|Hive.exe (publicada ya desempaquetada)|\n||Hive2.exe (publicada ya desempaquetada)|\n||Hive3.exe desempaquetada|\n||Hive4.exe (publicada ya desempaquetada)|\n||Hive5.exe desempaquetada|\n||Hive9.exe (no utiliza empaquetado)|\n|HiveRansomware_f|Hive9.exe (no utiliza empaquetado)|\n\n\n**_Tabla 12. Resultado de las reglas de Yara_**\n\n\n##### Reglas Sigma\n\n```\ntitle: hive_ransomware_DefenderStop\ndescription: 'Hive Ransomware Defender service stop with registry'\ndate: 2021-11-22\nlogsource:\n  product: windows\n  service: sysmon\ndetection:\n  selection:\n    EventID: '1'\n    CommandLine: 'reg.exe add \"HKLM\\Software\\Policies\\Microsoft\\Windows\nDefender\\Real-Time Protection\" /v \"DisableBehaviorMonitoring\" /t REG_DWORD /d \"1\"\n/f'\n  condition: selection\nfalsepositives:\n  - Unknown\nlevel: high\n\n```\n\n-----\n\n```\ntitle: hive_ransomware_vssadminCommand\ndescription: 'Hive Ransomware shadow copys delete'\ndate: 2021-11-22\nlogsource:\n  product: windows\n  service: sysmon\ndetection:\n  selection:\n    EventID: '1'\n    CommandLine: 'vssadmin.exe delete shadows /all /quiet'\n  condition: selection\nfalsepositives:\n  - Unknown\nlevel: high\n\n```\n```\ntitle: hive_ransomware_bcdeditCommand\ndescription: 'Hive Ransomware boot protection tamper'\ndate: 2021-11-22\nlogsource:\n  product: windows\n  service: sysmon\ndetection:\n  selection:\n    EventID: '1'\n    CommandLine: 'bcdedit.exe /set {default} bootstatuspolicy ignoreallfailures'\n  condition: selection\nfalsepositives:\n  - Unknown\nlevel: high\n\n```\n```\ntitle: hive_ransomware_VSSStop\ndescription: 'Hive Ransomware VSS service stop'\ndate: 2021-11-22\nlogsource:\n  product: windows\n  service: sysmon\ndetection:\n  selection:\n    EventID: '1'\n    CommandLine: 'sc.exe config \"VSS\" start= disabled'\n  condition: selection\nfalsepositives:\n  - Unknown\nlevel: high\n\n```\n\n-----\n\n-----",
    "language": "ES",
    "sources": [
        {
            "id": "bf5be533-fa31-4590-ae37-5761c97ffa34",
            "created_at": "2022-10-25T16:13:58.389257Z",
            "updated_at": "2022-10-25T16:13:58.389257Z",
            "deleted_at": null,
            "name": "Malpedia",
            "url": "https://malpedia.caad.fkie.fraunhofer.de",
            "description": "Malpedia is a free service offered by Fraunhofer FKIE",
            "reports": null
        }
    ],
    "references": [
        "https://www.incibe-cert.es/sites/default/files/contenidos/estudios/doc/incibe-cert_estudio_analisis_hive_2021_v1.pdf"
    ],
    "report_names": [
        "incibe-cert_estudio_analisis_hive_2021_v1.pdf"
    ],
    "threat_actors": [
        {
            "id": "610a7295-3139-4f34-8cec-b3da40add480",
            "created_at": "2023-01-06T13:46:38.608142Z",
            "updated_at": "2025-03-27T02:00:02.87217Z",
            "deleted_at": null,
            "main_name": "Cobalt",
            "aliases": [
                "Cobalt Gang",
                "GOLD KINGSWOOD",
                "COBALT SPIDER",
                "G0080",
                "Mule Libra",
                "Cobalt Group"
            ],
            "source_name": "MISPGALAXY:Cobalt",
            "tools": [],
            "source_id": "MISPGALAXY",
            "reports": null
        }
    ],
    "ts_created_at": 1666716497,
    "ts_updated_at": 1743041358,
    "ts_creation_date": 1639663167,
    "ts_modification_date": 1639664028,
    "files": {
        "pdf": "https://archive.orkl.eu/29ae5806090f4e3247d509cb94459d1201cd8031.pdf",
        "text": "https://archive.orkl.eu/29ae5806090f4e3247d509cb94459d1201cd8031.txt",
        "img": "https://archive.orkl.eu/29ae5806090f4e3247d509cb94459d1201cd8031.jpg"
    }
}