{
    "id": "df9571ba-b08a-4a36-9338-35f7ebc69810",
    "created_at": "2023-04-05T02:09:11.515943Z",
    "updated_at": "2025-03-27T02:08:40.881566Z",
    "deleted_at": null,
    "sha1_hash": "e803d4390b29ecdee55778b20980ce9b673d66d9",
    "title": "2023-03-09 - The Untold Story of the BlackLotus UEFI Bootkit",
    "authors": "",
    "file_creation_date": "2023-04-03T08:32:13Z",
    "file_modification_date": "2023-04-03T08:32:13Z",
    "file_size": 260898,
    "plain_text": "# The Untold Story of the BlackLotus UEFI Bootkit\n\n**[binarly.io/posts/The_Untold_Story_of_the_BlackLotus_UEFI_Bootkit/index.html](https://www.binarly.io/posts/The_Untold_Story_of_the_BlackLotus_UEFI_Bootkit/index.html)**\n\n\n-----\n\nMy experience with the analysis and detection of rootkits and bootkits goes back more than\n20 years. In the early 2000s, the main challenge was dealing with infected machines when\nrootkits and bootkits modified the operating system kernel to conceal malicious components.\nIt was such a fun time reverse engineering advanced threats in the good old days that I co[wrote \"Rootkits and Bootkits: Reversing Modern Malware and Next Generation Threats,\" a](https://binarly.io/posts/The_list_of_highest-rated_books_for_Malware_Analysts_features_Rootkits_and_Bootkits)\nbook full of the most interesting stories of our time going down the rabbit hole of advanced\nmalware.\n\nWhen the major operating systems moved to UEFI support and Secure Boot was widely\nimplemented, I really believed the golden age of bootkits had ended and the natural\nevolution would lead in the direction of firmware implants. I was wrong. Last week,\n[researchers at ESET published \"BlackLotus UEFI Bootkit: Myth Confirmed,\" confirming the](https://www.welivesecurity.com/2023/03/01/blacklotus-uefi-bootkit-myth-confirmed/)\nexistence of UEFI bootkits all over again. UEFI bootkits like BlackLotus are not new and\nhave been publicly seen since 2013 or even earlier. Modified or replaced bootloaders create\nvery visible and noisy Indicators of Compromise (IOCs) that attackers who are focused on\npersistence want to avoid.\n\nNevertheless, BlackLotus has been detected in-the-wild by the end of 2022, which is\nsurprising for a malware class that has been around for 10+ years.\n\n## Dive into (in)secure boot and the CVSS scoring problem\n\nThis story also has a supply chain twist. A critical aspect of the BlackLotus story lies in\nsupply chain problems relating to modern operating systems, their bootloaders, and UEFI\n[firmware. In order to bypass Secure Boot at scale, BlackLotus exploits CVE-2022-21894, a](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-21894)\nvulnerability patched by Microsoft in January 2022. A proof-of-concept exploit was released\nin August 2022, seven months after Microsoft’s public disclosure.\n\nThe CVE-2022-21894 vulnerability’s [CVSS score (4.4 medium) doesn't seem to indicate a](https://nvd.nist.gov/vuln/detail/CVE-2022-21894)\nserious vulnerability, does it?\n\nThe problem with most of the Secure Boot bypass vulnerabilities is that they require local or\nphysical access to the target. This significantly affects CVSS scoring in terms of the impact.\nSince Secure Boot bypass attacks cross security boundaries or allow the disabling of\nsecurity features, we need to treat them as privilege escalation vulnerabilities to more\naccurately reflect the CVSS impact score.\n\nAs the operating system bootloader becomes the middle layer between the firmware and\noperating system during the boot process, the bootloader provides a significant attack\nsurface that can impact a lot of security features like disk encryption and secure boot.\nCurrently, there is little documentation on attacks against bootloaders and a lot of\ninconsistency in the published existing knowledge. Here are some Microsoft advisories\nrelated to Secure Boot bypasses and other bootloader vulnerabilities.\n\n\n-----\n\n**Vulnerability** **CVSS Score** **Impact**\n\n[CVE-2023-21560](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2023-21560) 6.6 Medium BitLocker Encryption Bypass\n\n[CVE-2022-21894](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-21894) 4.4. Medium Secure Boot Security Bypass\n\n[BootHole (ADV200011)](https://msrc.microsoft.com/update-guide/vulnerability/ADV200011) 5.7 Medium Secure Boot Security Bypass\n\n[CVE-2020-0689](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-0689) 6.7 Medium Secure Boot Security Bypass\n\n[CVE-2019-1368](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2019-1368) 4.6 Medium Secure Boot Security Bypass\n\n[CVE-2019-1294](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2019-1294) 4.6 Medium Secure Boot Security Bypass\n\n[CVE-2016-7247](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2016/ms16-140?redirectedfrom=MSDN) 5.0 Medium Secure Boot Security Bypass\n\n[CVE-2016-3287](https://learn.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-094) 4.4 Medium Secure Boot Security Bypass\n\n[CVE-2016-3320](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2016/ms16-100?redirectedfrom=MSDN) 4.9 Medium Secure Boot Security Bypass\n\n[CVE-2015-6095](https://learn.microsoft.com/en-us/security-updates/securitybulletins/2015/ms15-122) 4.9 Medium BitLocker Encryption Bypass\n\nAs an aside, the navigation on the Microsoft Security Response Center (MSRC) website is a\ncomplete disaster from the perspective of tracking retrospective vulnerabilities and attacks.\nAccording to CVSS scores, all of these issues fall under ‘medium-severity’ impact. Despite\nthis, many of them allow bypassing Secure Boot and attacking the bootloader with serious\nconsequences.\n\n**Even after the vendor fixes the secure boot bypass vulnerabilities shown in the figure**\n**above, the vulnerabilities can present long-term, industry-wide supply chain impact.**\n**Using CVE-2022-21894 as an example shows how such vulnerabilities can be**\n**exploited in the wild after one year, even with a vendor fix available.**\n\nInterestingly, CVE-2022-21894 reminds me of previous findings MS16-094/CVE-2016-3287\n[and MS16-100/CVE-2016-3320 (also known as Golden Key vulnerabilities) discovered by](https://www.theregister.com/2016/08/10/microsoft_secure_boot_ms16_100/)\n[the same researcher Clark Zammis. The complexity of the modern Microsoft Windows Boot](https://github.com/Wack0)\nManager (bootmgfw) grows with every new release of Windows, simultaneously expanding\nthe attack surface. Modern UEFI-based Secure Boot schemes are extremely complicated to\nconfigure correctly and/or to reduce their attack surfaces meaningfully. That being said,\nbootloader attacks are not likely to disappear anytime soon.\n\n**A record number of** **[high-impact vulnerabilities (228) were disclosed by the Binarly](https://binarly.io/advisories)**\n**REsearch team in UEFI system firmware within one year. By design, most of these**\n**vulnerabilities bypass Secure Boot and allow attackers to persist at the firmware level.**\n\n\n-----\n\nThe example of BlackLotus shows how old tricks with less complicated malware can be used\nto gain persistence below the operating system via exploitation of a known secure boot\nbypass vulnerability. Still, it is quite difficult to mitigate the BlackLotus/CVE-2022-21894\nsecure boot bypass across the industry. The UEFI Forum is usually responsible for\ncoordinating and supporting the major vendor-independent mitigation of UEFI Revocation\nList Files (DBX). This list contains the hashes of signed bootloaders or firmware components\nthat were blacklisted.\n\nThe problem with every blacklist technology is that it will always miss known problems if it is\nnot updated or well maintained. In the history of UEFI Revocation List Files (DBX), Microsoft\npushed mandatory updates only a handful of times. Other than OS vendors, who else should\nbe responsible for these updates? Device vendors with firmware updates? As we all know,\nfirmware updates typically occur only a few times a year, so any blacklist will be near useless\nwith such minimal update frequency, but it is better than nothing.\n\nFigure1\n\nWe can see from the figure above that any compromised signed UEFI component can break\nsecure boot integrity and bypass it. My mind immediately goes to the Binarly REsearch\nteam's discovery of [BRLY-2021-003/CVE-2021-39297 (stack buffer overflow) vulnerability on](https://github.com/binarly-io/Vulnerability-REsearch/blob/main/HP/BRLY-2021-003.md)\nHP devices last year (almost 8 months under disclosure process). Based on the demo below,\nan attacker can execute arbitrary code over HP Hardware Diagnostics UEFI application.\n\nFigure2\n\nDuring its analysis of BlackLotus, the ESET research team discovered that the MokList\nNVRAM variable was modified. The MokList variable contains a list of authorized Machine\nOwner Keys (MOKs) and hashes (EFI_SIGNATURE_LIST according to the UEFI\nspecification). But it's another example of a supply chain issue with broad secure boot\nimplications in the field as the MokList variable can be modified in runtime. With the modified\nMokList variable, an attacker can easily load any self-signed shim bootloader, which is\nactually another vulnerability in the chain used to keep secure boot active.\n\nIn the modern secure boot, there are many inconsistencies due to many factors, including\nlegacy compatibility issues. The Binarly REsearch Team has discussed these weaknesses\nfor years at multiple public conferences, but the complexity of modern secure boot continues\nto increase.\n\n**Enterprise defenders and CISOs need to understand that threats below the operating**\n**system are clear and present dangers to their environments. Since this attack vector**\n**has significant benefits for the attacker, it is only going to get more sophisticated and**\n**complex. Vendor claims about security features can be completely opposite to the**\n\n\n-----\n\n**reality. Binarly s small research team was able to discover and disclose 228 high-impact**\nvulnerabilities across all major enterprise vendors in a year, which we believe only scratches\nthe surface. This research continues, on both sides of the fence (defense and offense).\n\n## A new name for old tricks\n\nAre there any new techniques in the BlackLotus bootkit? My opinion is that BlackLotus is a\n[good combination of well-known techniques. Proof of concept code for CVE-2022-21894](https://github.com/Wack0/CVE-2022-21894)\n(public since August 2022) was taken from the GitHub repository of the researcher who\nfound the vulnerability.\n\nBinarly REsearch discovered new interesting data points about the nature of the bootkit\ncode. It appears the author of the BlackLotus bootkit based their development on code from\nthe [Umap GitHub project (Windows UEFI bootkit that loads a generic driver manual mapper](https://github.com/btbd/umap)\nwithout using a UEFI runtime driver) or coincidently arrived at the same ideas. According to\nthe first commit, Umap was released in April 2020.\n\n[This picture shows a comparison of the logic of the main function from BlackLotus and](https://github.com/btbd/umap/blob/32c0b4062123a3f9f51fee571a2db9b9e17827ec/boot/main.c#L36)\nUmap. Both look very similar and contain exactly the same steps with a few minor changes.\n\nFigure3\n\nThe [routines responsible for installing the hook chain (start with](https://github.com/btbd/umap/blob/32c0b4062123a3f9f51fee571a2db9b9e17827ec/boot/main.c#L110)\n_ImgArchStartBootApplication) are very similar as shown in the figure._\n\nFigure4\n\nBlackLotus trampoline code modification logic to setup hooks is identical to Umap code on\nGitHub.\n\nFigure5\n\nWith these new data points, we can see how UEFI bootkit code reused from 2020 can be\ncombined with publicly available proofs of concept for CVE-2022-1894 to lead to the creation\nof the BlackLotus bootkit. This relatively new secure boot bypass vulnerability (which the\nvendor claims is low-impact) has led to widespread distribution of old malicious UEFI bootkit\ncode.\n\n## Zero-knowledge detection of new threats\n\nBinarly has been focused from the beginning on developing proactive technology based on\ndeep code inspection to detect unknown threats and vulnerabilities to help the industry\nrecover from repeatable failures. The Binarly Platform dashboard below shows code\n\n\n-----\n\nsimilarity proactive detection based on machine learning models guided by code-based\nembeddings.\n\nUsing the BlackLotus components, we simulated infection on one of the machines available\nin our lab. Binarly Platform was used to compare collected snapshots of the infected and\nclean EFI System Partitions (ESP). Based on function similarity, we detect the replacement\nof bootmgfw.efi with the shim.\n\nFigure6\n\nThe BlackLotus anomaly was proactively detected with zero knowledge about this threat,\nand the explained code similarity failures make it actionable for the security and incident\nresponse teams to conduct further investigation.\n\nLet's explore the code similarity detection in more detail. The figure below shows the detailed\noutput for the detected anomalies from the BlackLotus malicious components added to ESP\npartition.\n\nFigure7\n\nCode similarity detects anomalies based on code changes and integrity checking heuristics\nas shown in the figure below.\n\nFigure8\n\nHere is a visual explanation of the outlier (compromised ESP partition) and details of the\nalgorithm to detect anomaly:\n\nFigure9\n\nBinarly's Platform is able to analyze modules and executables based on semantic similarity.\nThe figure above shows a visualization of the program embeddings for bootmgfw and the\n[shim. For code function signatures, we used data clustering algorithm DBSCAN with a](https://en.wikipedia.org/wiki/DBSCAN)\nprecomputed Gower distance to detect anomalies. This is where we detect that additional\nsuspicious modules were added. Afterwards, we visualized the results using the T-SNE\nalgorithm.\n\n## What about detection based on FwHunt?\n\nWe continue to maintain the public FwHunt rules database and today we released a new\nsemantic-based rule to cover malicious bootloader components from the BlackLotus bootkit.\n\n[BlackLotus rule is included in FwHunt's GitHub repository. To use these rules you will need](https://github.com/binarly-io/FwHunt/tree/main/rules/Threats)\n[FwHunt Community Scanner (fwhunt-scan).](https://github.com/binarly-io/fwhunt-scan)\n\n\n-----\n\nFigure10\n\n**We need to increase the industry awareness to firmware related threats and build**\n**more effective threat hunting programs with cross-industry collaboration between the**\n**vendors to mutually benefit customers and provide better detection rates.**\n\n[Back to overview](http://10.10.1.0:9000/posts)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-03-09 - The Untold Story of the BlackLotus UEFI Bootkit.pdf"
    ],
    "report_names": [
        "2023-03-09 - The Untold Story of the BlackLotus UEFI Bootkit.pdf"
    ],
    "threat_actors": [
        {
            "id": "d90307b6-14a9-4d0b-9156-89e453d6eb13",
            "created_at": "2022-10-25T16:07:23.773944Z",
            "updated_at": "2025-03-27T02:02:09.974695Z",
            "deleted_at": null,
            "main_name": "Lead",
            "aliases": [
                "Casper",
                "TG-3279"
            ],
            "source_name": "ETDA:Lead",
            "tools": [
                "Agentemis",
                "BleDoor",
                "Cobalt Strike",
                "CobaltStrike",
                "RbDoor",
                "RibDoor",
                "Winnti",
                "cobeacon"
            ],
            "source_id": "ETDA",
            "reports": null
        }
    ],
    "ts_created_at": 1680660551,
    "ts_updated_at": 1743041320,
    "ts_creation_date": 1680510733,
    "ts_modification_date": 1680510733,
    "files": {
        "pdf": "https://archive.orkl.eu/e803d4390b29ecdee55778b20980ce9b673d66d9.pdf",
        "text": "https://archive.orkl.eu/e803d4390b29ecdee55778b20980ce9b673d66d9.txt",
        "img": "https://archive.orkl.eu/e803d4390b29ecdee55778b20980ce9b673d66d9.jpg"
    }
}