{
    "id": "31476ba9-e364-4f6f-9e4a-3a5dea7d665b",
    "created_at": "2023-01-12T14:59:01.289306Z",
    "updated_at": "2025-03-27T02:05:58.098524Z",
    "deleted_at": null,
    "sha1_hash": "7e4a877aed67e5e9fa64f2a6404a27291cb72c34",
    "title": "2013-12-23 - Mozi, Another Botnet Using DHT",
    "authors": "",
    "file_creation_date": "2022-05-29T00:54:49Z",
    "file_modification_date": "2022-05-29T00:54:49Z",
    "file_size": 2268734,
    "plain_text": "# Mozi, Another Botnet Using DHT\n\n**blog.netlab.360.com/mozi-another-botnet-using-dht/**\n\nAlex.Turing December 23, 2019\n\n23 December 2019 / [Botnet](https://blog.netlab.360.com/tag/botnet/)\n\n## Overview\n\nOn September 03, 2019, a suspicious file was tagged by our new threat monitoring system\nand a quick checking on VT shows most engines flagged it as Gafgyt. The sample does\nreuse part of the Gafgyt code, but it is not really Gafgyt.\n\nThe sample represents a brand new P2P botnet implemented based on the DHT protocol,\nthe last botnet which uses DHT is the Hajime, and we call it Mozi according to the\ncharacteristics of its propagation sample file name `Mozi.m, Mozi.a .`\n\nMozi Botnet relies on the DHT protocol to build a P2P network, and uses ECDSA384 and the\nxor algorithm to ensure the integrity and security of its components and P2P network. The\nsample spreads via Telnet with weak passwords and some known exploits (see the list\nbelow). In terms of functions, the execution of the instructions of each node in the Mozi\nbotnet is driven by a Payload called Config issued by the Botnet Master. The main\ninstructions include:\n\nDDoS attack\nCollecting Bot Information\nExecute the payload of the specified URL\nUpdate the sample from the specified URL\nExecute system or custom commands\n\n\n-----\n\nThe overall network structure is shown in the following figure:\n\n## Sample Spread\n\nMozi infects new devices through weak telnet passwords and exploits.The infection process\nis as follows:\n\nThe current Bot node randomly uses a local port to start the http service to provide\nsample downloads or receives the sample download address in the Config file issued\nby the Botnet Master.Provides a sample download address for future infected targets.\nThe current Bot node logs in to the target device with a weak password, writes the\ndownloader file in echo mode and runs it, and downloads the sample file from the\nsample download address provided by the current Bot node. Or use a vulnerability to\nexploit the target, and then obtain a sample file from the sample download address\nprovided by the current Bot node.\nRun the Mozi Bot sample on the infected target device, join the Mozi P2P network to\nbecome the new Mozi Bot node and continue to infect other new devices.\n\nThe vulnerabilities used by Mozi Botnet are shown in the following table:\n\n**Vulnerability** **Affected Aevice**\n\n\n-----\n\n**Vulnerability** **Affected Aevice**\n\n[Eir D1000 Wireless Router RCI](https://www.exploit-db.com/exploits/40740) Eir D1000 Router\n\n[Vacron NVR RCE](https://www.exploit-db.com/exploits/6864/) Vacron NVR devices\n\n[CVE-2014-8361](https://www.exploit-db.com/exploits/37169/) Devices using the Realtek\nSDK\n\n[Netgear cig-bin Command Injection](https://www.exploit-db.com/exploits/41598/) Netgear R7000 and R6400\n\n[Netgear setup.cgi unauthenticated RCE](https://www.exploit-db.com/exploits/43055) DGN1000 Netgear routers\n\n\nJAWS Webserver unauthenticated shell command\nexecution\n\n\nMVPower DVR\n\n\n[CVE-2017-17215](https://www.exploit-db.com/exploits/43414/) Huawei Router HG532\n\n[HNAP SoapAction-Header Command Execution](https://www.exploit-db.com/exploits/37171/) D-Link Devices\n\n[CVE-2018-10561, CVE-2018-10562](https://www.exploit-db.com/exploits/44576/) GPON Routers\n\n[UPnP SOAP TelnetD Command Execution](https://www.exploit-db.com/exploits/28333/) D-Link Devices\n\n[CCTV/DVR Remote Code Execution](https://www.exploit-db.com/exploits/39596/) CCTV DVR\n\nAt present, we do not know the exact scale of the Botnet, we do manage to become a node\nto join the DHT network and are tracking some baseline numbers, we will share more details\nprobably in another blog later on. And from other data we have collected, we can also see\n\n\n-----\n\nthe number of infection has been increasing.The picture below shows the Mozi bot infection\nbased on the log collected by our honeypot.\n\n## Sample Reverse Analysis\n\n\n-----\n\nThere are three versions of Mozi Botnet, which can be distinguished by their slightly different\ntelnet propagation methods.\n\nOur analysis is mainly focus on the latest version v2, and this blog will cover the key\nelements such as propagation method, Config structure and its DHT network.\n\n### Sample Information\n\nMD5:eda730498b3d0a97066807a2d98909f3\n\nELF 32-bit LSB executable, ARM, version 1 (ARM), statically linked, stripped\n\nPacker: NO\n\nLibrary:uclibc\n\nVersion: v2\n\nIt is worth mentioning that in the first version Mozi(sample md5:\n```\n849b165f28ae8b1cebe0c7430f44aff3 ) used upx packing. But instead of using the\n\n```\ncommon upx magic number to defeat unpacking, it used a novel method, to erase the value\nof p_filesize & p_blocksize to zero, with that change, researcher need to patch the upx\nsource code then unpacking is possible.\n\n### Common Functions\n\n\n-----\n\nMozi doesn t have much characteristics in the host behavior level. It reuses Gafgyt s code to\nimplements many common functions, such as single instance, process name modification,\nand ACL modification.\n\nSingle instance, by binding local port\n\nChange the process name to sshd or dropbear to confuse the victim\n\nACL modification, Open up the ports;block SSH, TELNET services to prevent Bot from\nbeing re-infected by other malicious actors.\n\n### Perform Specific Tasks\n\n\n-----\n\nAfter Mozi establishes the p2p network through the DHT protocol, the config file is\nsynchronized, and the corresponding tasks are started according to the instructions in the\nconfig file.In P2P networks, nodes are untrusted, and anyone can fake a Mozi node at a very\nlow cost.In order to ensure that the Mozi network is completely controllable and cannot be\nstolen by others, Mozi needs to perform signature verification on each synchronized config,\nand only if it can pass the signature verification can it be accepted and executed by the Mozi\nnode.\n\n**Document & Instruction Inspection**\n\nMozi uses the ECDSA384 algorithm to verify the legitimacy of files and instructions. Each\nsample integrates two xor-encrypted public keys, which are used to sign encrypted and\ndecrypted config files, respectively.\n```\n xor key:4E 66 5A 8F 80 C8 AC 23 8D AC 47 06 D5 4F 6F 7E\n-----------------------------------------------------------------xored publickey A \n     4C B3 8F 68 C1 26 70 EB 9D C1 68 4E D8 4B 7D 5F \n     69 5F 9D CA 8D E2 7D 63 FF AD 96 8D 18 8B 79 1B \n     38 31 9B 12 69 73 A9 2E B6 63 29 76 AC 2F 9E 94 A1\nafter decryption: \n     02 d5 d5 e7 41 ee dc c8 10 6d 2f 48 0d 04 12 21 \n     27 39 c7 45 0d 2a d1 40 72 01 d1 8b cd c4 16 65 \n     76 57 c1 9d e9 bb 05 0d 3b cf 6e 70 79 60 f1 ea ef\n------------------------------------------------------------------xored publickey B\n     4C A6 FB CC F8 9B 12 1F 49 64 4D 2F 3C 17 D0 B8 \n     E9 7D 24 24 F2 DD B1 47 E9 34 D2 C2 BF 07 AC 53 \n     22 5F D8 92 FE ED 5F A3 C9 5B 6A 16 BE 84 40 77 88\nafter decryption:\n     02 c0 a1 43 78 53 be 3c c4 c8 0a 29 e9 58 bf c6 \n     a7 1b 7e ab 72 15 1d 64 64 98 95 c4 6a 48 c3 2d \n     6c 39 82 1d 7e 25 f3 80 44 f7 2d 10 6b cb 2f 09 c6\n\n```\n\n-----\n\n**Config File**\n\nEach sample integrates an xor-encrypted initial config file with a length of 528 bytes. Its\nstructure is data (428 bytes), sign (96 bytes), flag (4 bytes). The sign field is a digital\nsignature and the flag field controls if the config file is updated or not.There are many control\nfields in the config file. After receiving the config, the Mozi node parses the field content and\nexecutes the corresponding subtasks.The original config file is as follows.\n\nThe decryption process is shown in the following figure, where the xor key is `4E 66 5A 8F`\n```\n80 C8 AC 23 8D AC 47 06 D5 4F 6F 7E\n\n```\n\n-----\n\nThe decrypted config is as follows.\n\nThe supported keywords are as follows, which can be divided into three categories:\ndeclaration, control, and subtask.\n```\n1：declaration\n[cpu] cpu arch or os\n[cpux] cpu arch or os\n[ss] bot role\n[ssx] bot role\n[nd]  new node info which help to join DHT\n2:control\n[ver] verify \n[sv] update Config\n[hp]  DHT id prefix\n[dip]  URL or ip:port list which can get Mozi sample\n3:subtask\n[atk] DDOS attack\n[ud]  update\n[dr]  exec payload from specific URL \n[rn]  exec system or customized cmds\n[idp] report bot info\n\n```\n**Bot Function**\n\n\n-----\n\nDDOS， `[atk] field trigger, reuse Gafgyt attack code, support HTTP, TCP, UDP and`\nother attacks.\n```\nCommand\n----------------------------------------S  \nT\nU\nKT\nHTTP\n\n```\nReport Bot information, [idp] field trigger, the content reported are Bot ID, IP, PORT,\nfile name (full path), gateway, cpu architecture.\n\n\n-----\n\nThe payload of the specified URL is executed, and the [dr] field is triggered.\n\nUpdate from the specified URL, the `[ud] field is triggered. Close the current node's`\nnetwork connection and related processes, download the new version from the\nspecified URL, save DHT node, ID and other data, and provide them as parameters for\nthe new version.\n\n\n-----\n\nExecute system or Bot custom command, [rn] field trigger.\n\nSystem command\n\nCustomize the GET command and send the Bot ID to the peer.\n\nCustomize the run command, execute the command issued by the peer, and\nreturn the result.\n\n### DHT\n\nMozi Botnet uses its own extended DHT protocol to build a P2P network. There are two\nbenefits to this. One is to use standard DHT to quickly establish a network, and the other is\nto use its own extension to hide the valid payload in the vast amount of normal DHT traffic so\ndetection is impossible without proper knowledge. Mozi uses 8 sets of public nodes and the\nnodes specified in the [nd] field of the Config file as bootstrap nodes, toguide new nodes to\njoin their DHT network.\n\nPublic node, sample embedded\n```\ndht.transmissionbt.com:6881\nrouter.bittorrent.com:6881\nrouter.utorrent.com:6881\nbttracker.debian.org:6881\n212.129.33.59:6881\n82.221.103.244:6881\n130.239.18.159:6881\n87.98.162.88:6881\n\n```\n\n-----\n\n[nd] Specified in the Config file\n\n**ID Generation**\n\nThe ID is 20 bytes and consists of the prefix `888888 embedded in the sample or the prefix`\nspecified by the config file [hp], plus a randomly generated string.\n\n\n-----\n\n**Node Recognition**\n\nIn order to distinguish regular traffic with its own traffic, Mozi uses 1:v4:flag(4\n```\nbytes) such an identifier to identify whether the traffic is sent by its node. The meaning of\n\n```\nthe flag byte is as follows.\n\nflag means is as follows\n```\nflag(4 bytes)\n---------------------------------------------offset:\n     0 -----random\n     1 ----- hard-code(0x42) or from [ver]\n  2 -----calc by algorithm\n  3 -----calc by algorithm\n\n```\n\n-----\n\nThe first byte is randomly generated. The second byte is hard-coded 0x42 or specified by the\n\n[ver] field in the config file.\n\nThe 3rd and 4th bytes are obtained by the algorithm.\n```\nver algorithm\n---------------------------------------------     int first,sec;\n     string ver=\"\\x31\\x3a\\x76\\x34\\x3a\\x00\\x00\"s;\n     cout << \"Please input the two number: (0x00-0xff)\" << endl;\n     cin.unsetf(ios::hex);\n     cin >> hex >> first >> sec;\n     ver[5] = char(first);\n     ver[6] = char(sec);\n     uint32_t va = 0;\n     for(int i = 0; i < 7; i++)\n     {\n          uint32_t tmp = int(ver[i]);\n          tmp = tmp << 8;\n          tmp ^= va;\n          int rnd = 8;\n     while (rnd--)\n     {\n          if ((tmp & 0xffff) > 0x8000)\n          {\n              tmp *= 2;\n              tmp ^= 0xffff8005;\n          }\n          else\n              tmp *= 2;\n     }\n     va = tmp&0xffff;\n     }\n     cout << hex << \"Final \" << va << endl;\n\n```\nPlease input the two number: (0x00-0xff)\n\n0x44 0x42\n\nFinal 1f71\n\nEnter 0x44 0x42, and get the `0x1f71 same result as in the packet.`\n\n**Network Request**\n\nThe network requests received by Mozi nodes can be divided into two categories, DHT\nrequests and non-DHT requests. According to the aforementioned node identification, DHT\nrequests are then again divided into Mozi-DHT requests and non-Mozi-DHT requests. Mozi\n\n\n-----\n\nsupports three types of them, including ping, find_node, and get_peers. For non-DHT\nrequests, there are two types based on whether the network packet length is greater than 99\nor not.\n\n\n-----\n\nFor Mozi, Different requests have different processing logic, see below\n\n\n-----\n\nNumber 2: ping, DHT request, reply to pong directly according to standard DHT\nprocess.\n\nNumber 3: find_node, DHT request.\n\n\n-----\n\nNumber 4: get_peers, DHT request.\nMozi combines `find_node and` `get_peers into one. If the request comes from the`\nMozi node, there is a certain probability to send its Config content to the other party; if\nthe request comes from a non-Mozi node, it is processed according to the standard\nDHT process。\n\n\n-----\n\n```\nraw data, first 128 bytes:\n00000000 64 31 3a 72 64 32 3a 69 64 32 30 3a 38 38 38 38 |d1:rd2:id20:8888|\n00000010 38 38 38 38 b7 96 a0 9e 66 e1 71 98 e5 4d 3e 69 |8888·. .fáq.åM>i|\n00000020 35 3a 6e 6f 64 65 73 36 32 34 3a 15 15 29 d2 f3 |5:nodes624:..)Òó|\n00000030 a3 f7 0c fe df 1a 5d bd 3f 32 46 76 5e 62 b7 b8 |£÷.þß.]½?2Fv^b·¸|\n00000040 f0 94 78 a2 c4 37 5b 8e 2c 00 0b 20 12 07 e7 f4 |ð.x¢Ä7[.,.. ..çô|\n00000050 bc dc 19 a2 83 2e 67 fb 7a 5e 50 22 07 75 e8 ef |¼Ü.¢..gûz^P\".uèï|\n00000060 f9 93 4a e9 91 75 36 e4 76 57 4b 7c 51 7c ff f5 |ù.Jé.u6ävWK|Q|ÿõ|\n00000070 f5 c4 57 f9 dc 62 35 b4 6a 5d 18 6b 54 3c ed e1 |õÄWùÜb5´j].kT<íá|\n00000080 a1 c8 56 a3 cf 28 6b fa 14 06 1a 3e 3b 01 a0 e3 |¡ÈV£Ï(kú...>;. ã|\nThe encrypted Config is located after \"5:nodes624:\", using xor key (4E 66 5A 8F 80 C8\nAC 23 8D AC 47 06 D5 4F 6F 7E), the content after decryption:\nraw data:\n00000000 64 31 3a 72 64 32 3a 69 64 32 30 3a 38 38 38 38 |d1:rd2:id20:8888|\n00000010 38 38 38 38 b7 96 a0 9e 66 e1 71 98 e5 4d 3e 69 |8888·. .fáq.åM>i|\n00000020 35 3a 6e 6f 64 65 73 36 32 34 3a \n|5:nodes624:\nconfiguration:\n00000000 5b 73 73 5d 73 6b 5b 2f 73 73 5d 5b 68 70 5d 38 |[ss]sk[/ss][hp]8|\n00000010 38 38 38 38 38 38 38 5b 2f 68 70 5d 5b 63 6f 75 |8888888[/hp][cou|\n00000020 6e 74 5d 68 74 74 70 3a 2f 2f 69 61 2e 35 31 2e |nt]http://ia.51.|\n00000030 6c 61 2f 67 6f 31 3f 69 64 3d 32 30 31 39 38 35 |la/go1?id=201985|\n00000040 32 37 26 70 75 3d 68 74 74 70 25 33 61 25 32 66 |27&pu=http%3a%2f|\n\n```\nNumber 5: `announce_peer not supported`\n\nNumber 6: Non-DHT request. The data packet length is less than 99 bytes. When the\nnode receives this request, it will send its config content to the requester.\n\n\n-----\n\nNumber 7: Non-DHT request, the data packet length is greater than 99 bytes. When\nthe node receives this request, it indicates that the received data is an encrypted\nConfig file. For the execution process, refer to the previous section.\n\n## Suggestions\n\nWe recommend that users update the patch in a timely manner, and determine whether they\nare infected by looking up the process and file name, and HTTP, DHT network connection\ncharacteristics created by Mozi Botnet.\n\n## Contact us\n\n[Readers are always welcomed to reach us on twitter, WeChat 360Netlab or email to netlab](https://twitter.com/360Netlab)\nat 360 dot cn.\n\n## IoC list\n\nSample MD5:\n```\neda730498b3d0a97066807a2d98909f3\n849b165f28ae8b1cebe0c7430f44aff3\n\n```\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2013/2013-12-23 - Mozi, Another Botnet Using DHT.pdf"
    ],
    "report_names": [
        "2013-12-23 - Mozi, Another Botnet Using DHT.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673535541,
    "ts_updated_at": 1743041158,
    "ts_creation_date": 1653785689,
    "ts_modification_date": 1653785689,
    "files": {
        "pdf": "https://archive.orkl.eu/7e4a877aed67e5e9fa64f2a6404a27291cb72c34.pdf",
        "text": "https://archive.orkl.eu/7e4a877aed67e5e9fa64f2a6404a27291cb72c34.txt",
        "img": "https://archive.orkl.eu/7e4a877aed67e5e9fa64f2a6404a27291cb72c34.jpg"
    }
}