{
    "id": "b442f59a-dc6d-4955-a55b-b69bfd782f7d",
    "created_at": "2023-03-03T02:05:36.67223Z",
    "updated_at": "2025-03-27T02:06:09.200871Z",
    "deleted_at": null,
    "sha1_hash": "4ce9266d09f5083d8f0e968cc116de7d9d27d078",
    "title": "2023-02-06 - Qakbot mechanizes distribution of malicious OneNote notebooks",
    "authors": "",
    "file_creation_date": "2023-03-01T09:14:47Z",
    "file_modification_date": "2023-03-01T09:14:47Z",
    "file_size": 1293590,
    "plain_text": "# Qakbot mechanizes distribution of malicious OneNote notebooks\n\n**[news.sophos.com/en-us/2023/02/06/qakbot-onenote-attacks/](https://news.sophos.com/en-us/2023/02/06/qakbot-onenote-attacks/)**\n\nAndrew Brandt February 6, 2023\n\nSince the beginning of the year, we’ve been tracking the growth of malware threat actors\ntaking advantage of a (previously) rarely abused Office file format – the .one files used by\n[the OneNote application. So have a few other](https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/trojanized-onenote-document-leads-to-formbook-malware/) [security](https://www.proofpoint.com/us/blog/threat-insight/onenote-documents-increasingly-used-to-deliver-malware) [companies.](https://blog.cyble.com/2023/02/01/qakbots-evolution-continues-with-new-strategies/)\n\n\n-----\n\nOur initial look at this threat vector revealed a number of small-scale malware attacks, but\nnow a more prominent malware group — Qakbot — has begun using the method in their\ncampaigns in a much more automated, streamlined fashion.\n\nThe malicious OneNote “notebook” is a single page document that looks like this\nIn [our previous research into Qakbot, we noted that the threat actors typically use email](https://news.sophos.com/en-us/2022/03/10/qakbot-decoded/)\nmessages as their initial attack vector. The botnet is capable of “injecting” a malicious email\ninto the middle of existing conversational threads, hijacking the email account(s) on\npreviously infected machines to reply to all parties in a message with either a malicious\nattachment or a link to a website hosting a malicious file.\n\n## How the attacks started\n\nQakbot began using OneNote .one documents (also called “Notebooks” by Microsoft) in their\nattacks on January 31. On Tuesday, we observed two parallel spam campaigns: In one, the\nmalicious emails embed a link, prompting the recipient to download a weaponized .one file.\nIn these versions of the malspam, the recipient’s last name is repeated on the subject line of\nthe message, but the messages are pretty impersonal otherwise.\n\n\n-----\n\nA Qakbot-transmitted\n\nmalspam with an embedded link to a OneNote document\nThe other involves so-called “message thread injections” where parties to an existing\ncommunication receive a reply-to-all (ostensibly from the user of the infected computer) with\nan attached, malicious OneNote notebook.\n\nSubject matter in these messages can be as varied as whatever happens to be in the\ninfected computer’s email inbox. But despite that, these were easy to find because all the\nattachments were named either ApplicationReject_#####(Jan31).one or\n**ComplaintCopy_#####(Feb01).one (where the ##### was a random, five-digit number).**\n\n\n-----\n\nA Qakbot-transmitted\n\nmalspam with a OneNote attachment\nIn tests, only browsers that transmit a Windows-computer’s User-Agent string in the query\nget the weaponized .one Notebook. All other User-Agent strings receive a 404 from the\nserver hosting the malicious .one file.\n\nWe tested by alternating the User-Agent strings between common Windows browsers\n(Chrome, Firefox, Edge) and User-Agents from browsers on other platforms (Mac/iOS, Linux,\nand Android). Only the requests sent with a Windows User-Agent string would work. Every\nrequest to the same URL delivered a unique sample.\n\n\n-----\n\nMalicious OneNote notebook files enclosed in Zip archives,\n\nas delivered by Qakbot payload servers\n\nSelected “ApplicationReject” malicious OneNote notebooks, delivered as email attachments.\nEmail vector aside, all the OneNote documents in this case contain a static image that\nprompts the user to click a button in response to text that says “This document contains\nattachments from the cloud, to receive them, double click ‘open.'” If a user hovers the mouse\n\n\n-----\n\npointer over the Open button, a tooltip appears that calls attention to the HTML application\nembedded in the document, named attachment.hta.\n\nThe malicious OneNote files contain an embedded .hta that’s made apparent when you\nhover your mouse pointer over the Open button\n\n## How to weaponize a notebook\n\nClicking the “Open” button embedded in the page executes the HTML Application\n(attachment.hta file) embedded in the OneNote file. The .hta file retrieves a sample of\nQakbot from a remote server and executes it.\n\nMost of the .hta files contained identical scripting language, with the main difference being\nthat some pointed to different URLs.\n\n\n-----\n\nA\n\ncomparison of two different application.hta files used in this attack\nThe first line of the script is a long, obfuscated line of code that other parts of the script\ndecode. It contains the instructions for the rest of the attack to follow:\n\nThe decoded script from the .hta that performs the payload download\nThis script code passes a hardcoded URL to the curl.exe application, which retrieves the file\nat the other end. The samples on the servers had image-format file suffixes, such as .png or\n.gif, but they were actually DLLs.\n\nThe script then copies the downloaded file to the C:\\ProgramData folder and then launches\nthe DLL using the function “Wind” in the command to execute it.\n\nOn this test system, the Qakbot malware payload injected itself into AtBroker.exe, the\nWindows Assistive Technology manager, a standard Windows application.\n\n\n-----\n\nQakbot injected itself into AtBroker.exe\nWe also noticed a unique characteristic in some of the malicious OneNote notebooks: If we\ntried to right-click and save the graphic elements in the notebook to the test system, the\ndialog box pre-populates with the filename that was assigned to the image when it was\nembedded in the document. In this case, the filename originally used when the “Open”\nbutton was created is Безымянный рисунок (bezymyanny risunok, Russian for “Anonymous\ndrawing”) — a curious detail.\n\n## Don’t open files, even if you know the sender?\n\nIt should come as no surprise that a threat actor would attempt to exploit a novel file format\nin order to spread an infection. If you’re not in the habit of working with OneNote or its\ndocument format, you might not be familiar with how these files can be abused.\n\nEmail administrators have, over the years, set up rules that either outright prevent, or throw\nsevere-sounding warnings, on any inbound messages originating from outside the\norganization with a variety of abusable file formats attached. It looks likely that OneNote .one\nnotebooks will be the next file format to end up on the email-attachment chopping block, but\nfor now, it remains a persistent risk.\n\nWe saw at least two warning dialog boxes appear, spawned by OneNote, upon opening the\ndocuments. One of these warnings issued sage advice we will repeat here: “Opening\nattachments could harm your computer and data. Don’t open it unless you trust the person\n\n\n-----\n\nwho created the file.\n\nOf course, the caveat to this advice is that the person who “sent” the file didn’t actually send\nit – it just appears to come from their account. When you’re unsure, and you see popups\nwarning of dire consequences if you proceed, take a moment and call or text the sender and\nmake sure they actually sent it to you before you open any OneNote document you might\nunexpectedly receive over email.\n\n## Sophos protection\n\nDespite the fact that this is a new tactic by the Qakbot authors, Sophos customers had\nproactive behavioral protection at several points in the attack chain:\n\nEvade_25a (T1218.011)\nEvade_7a (T1055.012, mem/qakbot-h)\nDiscovery_2b (T1018)\nPersist_3a (T1547.001)\n\nAdditionally, we’ve updated our static coverage with Mal/DrodZp-A (Zip containing OneNote\nnotebook), Troj/DocDl-AGVC (malicious OneNote notebook files), and Troj/HTMLDL-VS\n(malicious .hta file). Furthermore, context-based coverage for email with attached OneNote\nfiles with embedded HTA content has been added to our email protection feature as\nCXmail/OneNo-B.\n\n[Indicators of compromise relating to these files can be found on the SophosLabs Github.](https://github.com/sophoslabs/IoCs/blob/master/Qakbot-onenote-attacks.csv)\n\n## Acknowledgments\n\nSophos X-Ops acknowledges the contributions of Colin Cowie and Benjamin Sollman from\nSophos MDR, and Stephen Ormandy from SophosLabs.\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2023/2023-02-06 - Qakbot mechanizes distribution of malicious OneNote notebooks.pdf"
    ],
    "report_names": [
        "2023-02-06 - Qakbot mechanizes distribution of malicious OneNote notebooks.pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1677809136,
    "ts_updated_at": 1743041169,
    "ts_creation_date": 1677662087,
    "ts_modification_date": 1677662087,
    "files": {
        "pdf": "https://archive.orkl.eu/4ce9266d09f5083d8f0e968cc116de7d9d27d078.pdf",
        "text": "https://archive.orkl.eu/4ce9266d09f5083d8f0e968cc116de7d9d27d078.txt",
        "img": "https://archive.orkl.eu/4ce9266d09f5083d8f0e968cc116de7d9d27d078.jpg"
    }
}