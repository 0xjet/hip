{
    "id": "b04743ef-88e5-45cb-a739-369ded196159",
    "created_at": "2023-01-12T15:06:50.218761Z",
    "updated_at": "2025-03-27T02:05:47.040145Z",
    "deleted_at": null,
    "sha1_hash": "93eafe99975c99febb01ebd0b6f3aff977287085",
    "title": "2022-02-24 - Ukraine- Analysis Of The New Disk-Wiping Malware (HermeticWiper)",
    "authors": "",
    "file_creation_date": "2022-05-27T22:52:44Z",
    "file_modification_date": "2022-05-27T22:52:44Z",
    "file_size": 554321,
    "plain_text": "# Ukraine: Analysis of the new disk-wiping malware (HermeticWiper)\n\n**[cluster25.io/2022/02/24/ukraine-analysis-of-the-new-disk-wiping-malware/](https://cluster25.io/2022/02/24/ukraine-analysis-of-the-new-disk-wiping-malware/)**\n\nFebruary 24, 2022\n\n[APT Cluster25 todayFebruary 24, 2022](https://cluster25.io/category/general/apt/)\n\nVery recently a new type of destructive malware named by the security community\n“HermeticWiper” was used to attack organizations and entities in Ukraine shortly before\nRussia began military operations against the same country. HermeticWiper is an executable\nfile signed with a likely stolen certificate issued to Hermetica Digital Ltd. It has been\nreported by researchers at ESET on 2022/02/23\n\n## Insights\n\nWe analyzed the file identified by the following SHA256 hash :\n\n**1bc44eef75779e3ca1eefb8ff5a64807dbc942b1e4a2672d77b9f6928d292591**\n\n\n-----\n\nOn the basis of some evidences extracted from the analyzed samples, it is possible to\nhypothesize that the preparation and the development phases of this piece of malware (and\nmay be the military operation that soon followed its spread) had been going on for some\nmonths already.\n\nTechnically speaking the first actions carried out when executed are aimed at opening its\ncurrent process using the GetCurrentProcess API and at accessing the token with the\n**OpenProcessToken.**\n\nImmediately after it adjusts the token privileges using the AdjustTokenPrivileges to add the\n**SeShutdownPrivilege and SeBackupPrivilege.**\n\nIt proceeds by dynamically resolving Wow64DisableWow64FsRedirection,\n**Wow64RevertWow64FsRedirection, IsWow64Process from kernel32.dll library using the**\n**GetModuleHandle and the GetProcAddress API’s.**\n\nOS version is verified through IsWow64Process and VerifyVersionInfoW API’s. Based on\nthe OS version load 1 of the 4 resources as shown following:\n\nThe resources contain ms-compressed copies of the empntdrv.sys from EaseUS driver\nsuite used in the next subroutines to access physical drives and getting partition information.\n\nThis adds an obfuscation layer to the current wiper since a lot of functionality are accessed\nthrough the DeviceIoControl API (calling the specific IOCTLs).\n\nAfter that, the resource is loaded and decompressed. Next, the\n\n**SYSTEM\\CurrentControlSet\\Control\\CrashControl**\n\n\n-----\n\nregistry key is opened to disable the CrashDump feature (enabled by default in Windows).\n\nIn particular, the DWORD CrashDumpEnabled value is changed from 1 to 0.\n\nSubsequently, a new pipe called \\\\\\\\.\\\\EPMNTDRV\\\\ is created and the decompressed driver\nis saved in the\n\n**C:\\Windows\\System32\\drivers\\njdr.sys**\n\ndirectory (the filename is computed at runtime using randomness).\n\nTo ensure the driver execution the process token is modified again to add the\n**SeLoadDriverPrivilege permission and a new service is created using the CreateServiceW**\nAPI.\n\nInstead, if the service already exists, the ChangeServiceConfigW API is used to force the\nexecution of the service with the SERVICE_DEMAND_START flag. Finally, the\n**StartServiceW API is used to start the service pointing to the utility driver.**\n\nAfter some sleep, the reg key\n\n**SYSTEM\\\\CurrentControlSet\\\\services\\\\**\n\nand the driver file stored on the filesystem are deleted.\n\n\n-----\n\nSubsequently, the vss service (shadow copies service) is opened and the\n**ChangeServiceConfigW API is used to set the flags SERVICE_DISABLED and**\n**SERVICE_CONTROL_STOP.**\n\nAfterwards, the system physical drivers are enumerated multiple times with a counter from 1\nto 100.\n\nFor each found physical drive, the \\\\.\\EPMNTDRV\\ is called with the appropriate device\nnumber using the DeviceIoControl API.\n\nThen, for each driver found, the malware starts a bit swapping routine to corrupt the Master\n**Boot Record (MBR) for every physical drive.**\n\nThe corruption is a little different between FAT and NTFS partitions.\n\n\n-----\n\nFor the NTFS partitions, the malware parses the Master File Table (MFT) before calling the\nbit swapping routine.\n\nThe bit swapping routine is supported with the usage of cryptographic context API’s (like\n**CryptoAcquireContext), the generation of random bytes to corrupt the partition and the**\nusage of DeviceIoControl with the just-created service to access the physical\ndrives.\n\nFurther functionality refers also to the encryption of specific MFT fields ($bitmap and\n**$logfile) or NTFS streams like $DATA, $I30 or $INDEX_ALLOCATION with some**\nreferences to “ntuser”.\n\nAfter the corruption subroutines, the malware enumerates also common folders but currently\nstill not totally clear why as the wiping activities are already been operated. Anyway, the\nfolder are the following:\n\n1. My Documents\n2. Desktop\n3. AppData\n4. Windows Event Logs (C:\\\\Windows\\\\System32\\winevt\\\\Logs)\n\nAt the end this piece of malware waits for different sleeping treads and initialize a system\nshutdown destroying the victim system.\n\n## Conclusions\n\n\n-----\n\n**HermeticWiper is a new type of destructive malware, significantly different from**\n**WhisperGate, the previous wiper used against targets in Ukraine. Destructive attacks**\nperpetrated through pieces of malware of this type are focused on making essential services\nand critical infrastructures unavailable.\n\nIn this case, HermeticWiper probably works in support of Russian military operations.\n\n## Detection\n\nYARA 1\n\nrule UNC1222_HermeticWiper_23433_10001 {\n\nmeta:\n\ndate = “2022-02-23”\n\ndescription = “Detects HermeticWiper variants by internal strings”\n\nauthor = “Cluster25”\n\ntlp = “white”\n\nhash1 = “0385eeab00e946a302b24a91dea4187c1210597b8e17cd9e2230450f5ece21da”\n\nhash2 = “1bc44eef75779e3ca1eefb8ff5a64807dbc942b1e4a2672d77b9f6928d292591”\n\nstrings:\n\n$ = “tdrv.pdb” fullword ascii\n\n$ = “\\\\\\\\.\\\\EPMNTDRV\\\\%u” fullword wide\n$ = “PhysicalDrive%u” fullword wide\n\n$ = “Hermetica Digital Ltd”\n\ncondition:\n\n(uint16(0) == 0x5a4d and all of them)\n\n}\n\nYARA 2\n\nimport “pe”\nrule UNC1222_HermeticWiper_23433_10002 {\n\nmeta:\n\ndate = “2022-02-23”\n\ndescription = “Detects HermeticWiper variants by internal strings”\n\nhash1 = “0385eeab00e946a302b24a91dea4187c1210597b8e17cd9e2230450f5ece21da”\n\nhash2 = “1bc44eef75779e3ca1eefb8ff5a64807dbc942b1e4a2672d77b9f6928d292591”\n\ntlp = “white”\n\nstrings:\n\n$p1 = “$INDEX_ALLOCATION” wide\n\n$p2 = “$I30” wide\n\n$p3 = “$DATA” wide\n\n$p4 = “$logfile” wide\n\n$p5 = “$bitmap” wide\n\n\n-----\n\n$s1 = PhysicalDrive%u wide\n$s2 = “EPMNTDRV” wide\n$s3 = “SYSVOL” wide\n$s4 = “SYSTEM\\\\CurrentControlSet\\\\Control\\\\CrashControl” wide\n$s5 = “CrashDumpEnabled” wide\n$s6 = “NTFS” ascii\n$s7 = “FAT” ascii\n$s8 = “OpenSCManager” ascii\n$s9 = “SeBackupPrivilege” wide\n$s10 = “SeLoadDriverPrivilege” wide\n$s11 = “RCDATA” wide\n// LookupPrivilegeValueW routine\n$r1 = { 85 35 2C 50 40 00 C7 84 ?? ?? ?? ?? 77 00 6E 00 C7 84 ?? ?? ?? ?? 50 00 72 00\n8D 43 04 50 8D 44 24 44 50 6A 00 FF D6 8D 43 10 50 68 A8 55 40 00 6A 00 FF D6 6A 00\n6A 00 6A 00 53 C7 03 02 00 00 00 6A 00 }\n// AdjustTokenPrivileges routine\n$r2 = { C7 43 0C 02 00 00 00 C7 43 18 02 00 00 00 FF 74 24 24 FF 15 28 50 40 00 FF D7\n85 C0 75 0F }\n// OpenSCManagerW (DatabaseName: “ServicesActive”) routine\n$r3 = { 68 ?? 3f 00 0f 00 68 ?? 80 55 44 00 33 f6 56 ff 15 24 50 40 00 89 44 24 10 85 C0 75\n06 }\n// OpenServiceW (ServiceName: “vss”) routine\n$r4 = { 68 ?? 58 40 00 50 FF 15 20 50 40 00 8B D8 85 DB 75 0C }\n// ChangeServiceConfigW routine\n$r5 = { 6A 00 6A 00 6A 00 6A 00 6A 00 6A 00 6A 00 6A FF 6A 04 6A 10 53 FF 15 14 50 40\n00 85 C0 75 04 }\n// CreateThread/CreateEventW and InitializeShutdownW routine\n$r6 = { 8B 35 ?? ?? ?? ?? 8D 44 ?? ?? 6A 00 6A 00 50 68 ?? ?? 40 00 6A 00 6A 00 89 7C\n?? ?? FF D6 6A 00 6A 00 6A 01 6A 00 89 44 ?? ?? FF 15 ?? ?? ?? ?? 6A 00 6A 00 89 44 ??\n?? 8D 44 ?? ?? 50 68 D0 34 40 00 6A 00 6A 00 FF D6 8B 3D D4 ?? ?? ?? 6B D8 85 DB 74\n0A }\n\ncondition:\nuint16(0)==0x5a4d and pe.imports(“lz32.dll”) and filesize < 200KB and (2 of ($p*) and (all of\n($s*) or (6 of ($s*) and any of ($r*)) or 4 of ($r*)))\n}\nWritten by: [Cluster25](https://cluster25.io/author/cluster25/)\n\nTagged as: [HermeticWiper,](https://cluster25.io/tag/hermeticwiper/) [Wiper,](https://cluster25.io/tag/wiper/) [Ukraine,](https://cluster25.io/tag/ukraine/) [CyberWar,](https://cluster25.io/tag/cyberwar/) [Malware.](https://cluster25.io/tag/malware/)\n\n\n-----",
    "language": "EN",
    "sources": [
        {
            "id": "05d7b179-7656-44d8-a74c-9ab34d3df3a2",
            "created_at": "2023-01-12T14:38:44.599904Z",
            "updated_at": "2023-01-12T14:38:44.599904Z",
            "deleted_at": null,
            "name": "VXUG",
            "url": "https://www.vx-underground.org",
            "description": "vx-underground Papers",
            "reports": null
        }
    ],
    "references": [
        "https://papers.vx-underground.org/papers/Malware Defense/Malware Analysis 2022/2022-02-24 - Ukraine- Analysis Of The New Disk-Wiping Malware (HermeticWiper).pdf"
    ],
    "report_names": [
        "2022-02-24 - Ukraine- Analysis Of The New Disk-Wiping Malware (HermeticWiper).pdf"
    ],
    "threat_actors": [],
    "ts_created_at": 1673536010,
    "ts_updated_at": 1743041147,
    "ts_creation_date": 1653691964,
    "ts_modification_date": 1653691964,
    "files": {
        "pdf": "https://archive.orkl.eu/93eafe99975c99febb01ebd0b6f3aff977287085.pdf",
        "text": "https://archive.orkl.eu/93eafe99975c99febb01ebd0b6f3aff977287085.txt",
        "img": "https://archive.orkl.eu/93eafe99975c99febb01ebd0b6f3aff977287085.jpg"
    }
}